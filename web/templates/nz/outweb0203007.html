<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="nz">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript">
function PostCancel() {
//
// Prompt confirmation question if this booking if part of a series
//
  if(!validateMandatory(UpdateForm)) {
    return;
  }
  if(document.UpdateForm.isseries.value=="1" || 
     document.UpdateForm.isseries.value=="2") {
    if(!confirm("This booking is part of a series. Do you wish to continue?")){
      return;
    }
  }
//
  if(document.UpdateForm.isseries.value=="1") {
    if(confirm("Do you want to cancel all future bookings in the series?\n" +
               "Click OK to cancel future bookings in the series OR \n" +
               "Click CANCEL to cancel this appointment only")){
      document.UpdateForm.action="outweb08.pbl";
      document.UpdateForm.reportno.value="6";
      document.UpdateForm.updttype.value="4";
    } 
  }
//
  if(document.UpdateForm.isseries.value=="2") {
    if(confirm("This booking is a master booking for this series.\n" +
               "Click OK to cancel the entire series OR \n" +
               "Click CANCEL to cancel this appointment only")){
      document.UpdateForm.action="outweb08.pbl";
      document.UpdateForm.reportno.value="6";
      document.UpdateForm.updttype.value="3";
    } 
  }
//
  if(!confirm("Do you wish to continue with this cancellation?\n" +
              "Click OK to continue, CANCEL to exit")){
     return;
  } 
//
  if(!isWhitespace(UpdateForm.allrvisn.value)) {
    var Bookings=false;
    var serverURL = "../cgi-bin/allweb02.pbl?reportno=6&updatety=3" +
                    "&admissno=" + UpdateForm.allrvisn.value.replace(/ /g,"+") +
                    "&currvist=" + UpdateForm.d_currvist.value.replace(/ /g,"+")
    var returnValue = RSExecute(serverURL);
    ReturnValue=returnValue.return_value.split("|");
    if(returnValue.status==0) {
      if(ReturnValue[0] == 1) {    // OP Bookings exist for this referral
        Bookings=true;             // so don't prompt to close the referral
      }
    }
    if(Bookings==false) {
      if(confirm("Do you wish to Close the Referral?\n" +
                  "Click OK to continue, CANCEL to exit")){
//      Create cookie for close referral dframe redirect
        var closereferralstring = "";
        closereferralstring="allweb02.pbl?reportno=02&template=004" +
        "&urnumber=" + UpdateForm.urnumber.value.replace(/ /g,"+") +
        "&admissno=" + UpdateForm.allrvisn.value.substr(0,8).replace(/ /g,"+") +
        "&deptcode=" + UpdateForm.deptcode.value.replace(/ /g,"+");
          SetCookie("CloseReferralCookie",closereferralstring);
          SetCookie("RedirectCanApp","");
        UpdateForm.redirect.value = "allweb02.pbl?reportno=2&template=002" +
        "&urnumber=" + UpdateForm.urnumber.value.replace(/ /g,"+") +
        "&admissno=" + UpdateForm.allrvisn.value.substr(0,8).replace(/ /g,"+") +
        "&deptcode=" + UpdateForm.deptcode.value.replace(/ /g,"+");
      }
    }
  }
//
  if(document.UpdateForm.d_redirflg.value == "1") {
    document.UpdateForm.nextpage.value="0";
  }

  // No Linked Referral with attended OP visit OR active Group Contact session?
  if (document.UpdateForm.opvexist.value == "0") {
    if (document.UpdateForm.chkRetTW.checked) {
      document.UpdateForm.retreftw.value = "1";
    }
  }


  document.UpdateForm.submit();
}
function CheckRefLetter() {
  if (document.UpdateForm.otcnulet.value == "1" && 
      !isWhitespace(document.UpdateForm.otrlbsit.value)) {
    ShowCanLetter.innerHTML=ExtraLetter.innerHTML;
  } else {
    ShowCanLetter.innerHTML="";
  }
}
function MandCancel() {
  if(document.UpdateForm.canrefer.value=="Y") {
    document.UpdateForm.otrfl017.readOnly=false;
    document.UpdateForm.otrfl017.className="Mandatory";
    document.UpdateForm.otrfl018.disabled=false;
    document.UpdateForm.otrfl018.className="Mandatory";
    document.UpdateForm.letnumbr.disabled=false;
    document.UpdateForm.letnumbr.className="";
    document.UpdateForm.letprntr.disabled=false;
    document.UpdateForm.letprntr.className="";
  } else {
    document.UpdateForm.otrfl017.readOnly=true;
    document.UpdateForm.otrfl017.className="Readonly";
    document.UpdateForm.otrfl017.value="";
    document.UpdateForm.otrfl018.disabled=true;;
    document.UpdateForm.otrfl018.className="Readonly";
    document.UpdateForm.otrfl018.selectedIndex=0;
    document.UpdateForm.letnumbr.disabled=true;;
    document.UpdateForm.letnumbr.className="Readonly";
    document.UpdateForm.letnumbr.selectedIndex=0;
    document.UpdateForm.letprntr.disabled=true;;
    document.UpdateForm.letprntr.className="Readonly";
    document.UpdateForm.letprntr.selectedIndex=0;
  }
}
function SetLetterPrinter() {
 if (UpdateForm.letnumbr.selectedIndex == 0)
     UpdateForm.letprntr.className="SelectBig";
 else
     UpdateForm.letprntr.className="Mandatory SelectBig";
}
</script>
%START.OF.PAGE
<body onload="PageLoad(event);CheckRefLetter();">
<span class=DFrameTitleBar>
<img align="right" alt="Exit" class="MenuIcon"
 src="../images/ExitIcon.gif" onclick="DFrameExit();">
Cancel Appointment - %OUTWEB02.03.618.1 - %OUTWEB02.03.002
</span>
<p>
<div id=PageBodySection style="overflow: auto;">
<form name=UpdateForm action=outweb02.pbl method=post style="margin:0">
<input type=hidden name=reportno value="4">
<input type=hidden name=nextpage value="6">
<input type=hidden name=redirect 
    value="outweb02.pbl?reportno=3&template=015&urnumber=%OUTWEB02.03.003">
<input type=hidden name=updatety value="8">
<input type=hidden name=updttype value=" ">
<input type=hidden name=casekeys value="%OUTWEB02.03.366">
<input type=hidden name=isseries value="%OUTWEB02.03.618.2">
<input type=hidden name=otcnulet value="%STANDARD.01.025.031.174.1.1">
<input type=hidden name=otrlbsit value="%OUTWEB02.03.737.1">
<input type=hidden name=d_redirflg value="%OUTWEB02.03.636">
<input type=hidden name=opvexist value="%OUTWEB02.03.690">
<input type=hidden name=retreftw value="">
<input type=hidden name=urnumber value="%OUTWEB02.03.003">
<input type=hidden name=allrvisn value="%OUTWEB02.03.646">
<input type=hidden name=deptcode value="%OUTWEB02.03.648">
<input type=hidden name=d_currvist value="%OUTWEB02.03.081">

<table cellspacing=0 cellpadding=0 border=0 width=95% align=center>
<tr><td width=37% class=DataLabel>Cancellation Reason </td>
    <td> <select name=outbb053 class=Mandatory title="Cancellation Reason">
	 <option></option>
	 %STANDARD.01.007.CB
	 </select></td> </tr>

<tr><td>&nbsp;</td></tr>
    <tr><td width=20% valign=top class=DataLabel>Comments </td>
         <td colspan=6 align=left>
         <textarea wrap=hard name=cancommt rows=4 
           cols=60>%OUTWEB02.03.623</textarea></td></tr>
<tr><td>&nbsp;</td></tr>
</table>

<div id=divRTW></div>

<table cellspacing=0 cellpadding=0 border=0 width=95% align=center>
<tr><td width=37% class=DataLabel>Print Cancellation Letter</td>
    <td width=8%> <input type=checkbox checked value=1 name=letprt07></td>
    <td width=8% class=DataLabel>Printer</td>
    <td> <select name=letpsl07 class=SelectBig>
	 %STANDARD.01.001.OUTWEB03.02
	 </select></td></tr>
</table>

<div id=ShowCanLetter></div>

<table cellspacing=0 colspan=5 border=1 width=100%>
%OUTWEB02.03.387
</table>
<table cellspacing=0 cellpadding=0 border=0 width=95% align=center>
<tr><td colspan=2 align=center><br>
    <input type=button class="button" value="Ok"
     onclick="PostCancel();">
    <input type=button class="button" Value="Cancel"
     onclick="DFrameCloseRefresh();">
<tr><td colspan=2 align=center>&nbsp;</td>
    </tr>
</table>
</form>

<span id=spRTW style="display:none">
<table cellspacing=0 cellpadding=0 border=0 width=95% align=center>
<tr>
  <td width=37% class=DataLabel>Return Referral to Waiting</td>
  <td width=8%> <input type=checkbox value=1 name=chkRetTW></td>
  <td colspan=2></td>
</tr>
</table>
</span>

<form name=PatientLinks method=get style="margin:0">
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=urnumber value="%OUTWEB02.03.003">
<input type=hidden name=admissno value="%OUTWEB02.03.081">
<input type=hidden name=MenuType value="%OUTWEB02.03.088">
<input type=hidden name=casekeys value="%OUTWEB02.03.366">
</form>

<div id=ExtraLetter style="display: none">
<table cellspacing=0 cellpadding=1 border=0 width=95% align=center>
<tr><td align=center colspan="2"><hr></td></tr>
<tr><td align=center colspan="2" class=HeadingCell>Referral Letter</td></tr>

<tr><td width=37% class=DataLabel>&nbsp;</td>
    <td>&nbsp;</td>
    </tr>

<tr><td width=37% class=DataLabel>Cancel Referral</td>
    <td> <select name=canrefer class=Mandatory title="Cancel Referral"
          onchange="MandCancel();">
	 <option></option>
	 <option value="N">No</option>
	 <option value="Y">Yes</option>
	 </select></td></tr>

<tr><td>Referral Cancellation Date</td>
    <td><input name=otrfl017 type=text size=12 class="BackDate Readonly"
         title="Referral Cancellation Date" readonly id="otrfl017"
         value="" onblur="checkDate(this,this.title)">
        <img src=../images/DateTimeStamp.gif class="Icon"
         onclick="SetCurrentDateTime(UpdateForm.otrfl017,null);">
        <img src=../images/CalendarLookup.gif class="Icon"
         onclick="DateLookupFrame(UpdateForm.otrfl017);"></td></tr>

<tr><td class=DataLabel>Referral Cancellation Reason</td>
    <td><select name=otrfl018 class=Readonly disabled
         title="Referral Cancellation Reason">
         <option></option>
         %OUTWEB02.03.718.9.1.01.2.E
         </select></td></tr>
    
<tr><td class=DataLabel>Print Referral Letter</td>
    <td><select class="SelectBig" name=letnumbr title="Print Referral Letter"
         disabled onchange="SetLetterPrinter();">
          <option value="   "></option>
          %OUTWEB02.03.644
          </select>
        &nbsp;Printer&nbsp;
        <select class="SelectBig" name=letprntr disabled 
         title="Referral Printer">
          <option></option>
          %STANDARD.01.001.LETTRREF.01
          </select></td></tr>
   
<tr><td align=center colspan="4"><hr></td></tr>
</table>
</div>

<script type="text/javascript">
if (document.UpdateForm.d_redirflg.value == "1") {
  for (var i=0; i < document.UpdateForm.outbb053.length; i++) {
    if (document.UpdateForm.outbb053.options[i].value.substr(3,1)=="S"){
      document.UpdateForm.outbb053.selectedIndex=i;
    }
  }     
}        

// Does this OP visit have a Linked Referral with an OP visit that has
// already been attended OR there is an active Group Contact session for the
// Linked Referral ?
if (document.UpdateForm.opvexist.value == "0") {
  // no such OP visits or active Group Contact sessions;
  // so allow 'Return Referral To Waiting'
  document.getElementById('divRTW').innerHTML =
    document.getElementById('spRTW').innerHTML;
}
</script> 
