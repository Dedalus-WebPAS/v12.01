<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="bhs">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="../js/PatientHeader.js"></script>
<script type="text/javascript" src="../js/TableSort.js"> </script>
<script type="text/javascript" src="../js/patweb98.js"></script>
<script type="text/javascript">
function setReceiver() {
  if (window.addEventListener){
    addEventListener("message", receiveMessage, false);
  } else {
    attachEvent("onmessage", receiveMessage);
  }
};
function receiveMessage(e) {
  if (window.removeEventListener) {
    removeEventListener("message", receiveMessage, false);
  } else {
    detachEvent("onmessage", receiveMessage);
  }
  location.reload();
}
function LaunchMedchart(fn) {
// Function Name         Launch to
// patient               Patient Summary screen for requested patient
// prescribe             Patient Medication screen for requested patient
// administration        Medication administration chart for the requested patient
// review                Pharmacy review chart for the requested patient
// desktop               MedChart Desktop
// user                  Update user details without display anything in MedChart
// wardsummary           Administration ward overview screen
// managepatient         Edit details for the requested patient
// pharmacyreviewmonitor Pharmacy review monitor
// clinicalreviewmonitor Clinical review monitor
  wurl="MedchartServices.php?reportno=10"+
       "&urnumber=" + document.PatientLinks.urnumber.value.replace(/ /g,"") +
       "&admissno=" + document.PatientLinks.admissno.value.replace(/ /g,"") +
       "&function=" + fn +
       "&httprand=" + Math.random();
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", wurl, false);
  xmlHttp.send();
  if (xmlHttp.responseText.substr(0,5)=="ERROR"&&xmlHttp.status == 200) {
    alert(xmlHttp.responseText);
  } else {
    var el=document.getElementById("PatientHeading");
    var w=el.offsetWidth-40
    var l=(document.body.clientWidth-w)/2;
    setReceiver();
    DFrameLink(xmlHttp.responseText,0,l,w,800)
  }
}
function init() {
  PageLocation="?reportno=1&template=4" +
               "&urnumber=" + PatientURN.replace(/ /g,"+") +
               "&admissno=" + PatientVIS.replace(/ /g,"+")
  if(top.content.location.search.substring(1,23)!="reportno=1&template=16"&&
     top.content.location.search.substring(1,23)!="reportno=1&template=11"&&
     top.content.location.search.substring(1,23)!="reportno=1&template=17"){
    if (top.content.location.search!=this.location.search) {
      if (top.content.location.search!=PageLocation) {
      top.content.location.href="emrweb02.pbl" + PageLocation } }
  }
  if(document.PatientLinks.cauda1.value=="1") { // Not using alert audits
     DeletedButton.style.display="none";
     document.getElementById('DeletedButton').innerHTML="";
  } else {
     document.getElementById('DeletedButton').style.display="";
     document.getElementById('DeletedButton').innerHTML=
                   document.getElementById('DisplayDeleted').innerHTML;
  }
}
function AlrtFilt(SelectItem) {
  for (var i = 0; i < SelectItem.length; i++) {
    if (SelectItem.options[i].selected == true) {
      SelectOption=SelectItem.options[i].value 
    }   
  }
  SelectItem.selectedindex=SelectOption
  document.AddAlertForm.reportno.value="01";
  document.AddAlertForm.template.value="003";
  document.AddAlertForm.alrtfltr.value=SelectOption;
  document.AddAlertForm.action="patweb98.pbl";
  document.AddAlertForm.submit();
}
</script>
%START.OF.PAGE
<script type="text/javascript" src="%PATWEB98.01.001.patweb98.01.103"></script>
</head>
<body onload='LoadHead();PageLoad(event);InitTable();'>
<div id=HeadingSection>
<div id=PatientHeading></div>
<div id=PatientBannerEx1 class=PatientBannerEx></div>
<div id=PatientMenu></div>
<form name=AddAlertForm style="margin:0">
<input type=hidden name=reportno value="">
<input type=hidden name=template value="">
<input type=hidden name=urnumber value="%PATWEB98.01.003">
<input type=hidden name=admissno value="%PATWEB98.01.081">
<input type=hidden name=ptcnhdps id=ptcnhdps
 value="%STANDARD.01.025.080.250.1.1">
<table cellspacing=0 cellpadding=0 border=0 width=100% class=HeadingCell>
<tr><td width=5% align=left class=HeadingCell>
      <input type=button value="Alert History" class="button"
       onclick='PatientLinkTo("patweb98.pbl",1,94,0,0);'></td>
    <td width=5% align=left class=HeadingCell>
      <div id=DeletedButton></div>
    <td width=5% align=left class=HeadingCell>
      <input id=btnLaunchMedchart type=button class=button
       style='display:none;' value='Allergies'
       onclick='LaunchMedchart("patient");'>
    </td>
    <td width=70% align=center class=HeadingCell>Patient Alerts</td>
    <td nowrap align=right class=HeadingCell>View Alerts by
      <select class=PMenuSelectList name=alrtfltr onchange='AlrtFilt(this)'>
        <option></option>
        %PATWEB98.01.306.4
      </select></td>
    <!--<td width=15% nowrap align=right class=HeadingCell>Add Alert 
        <select class=PMenuSelectList name=alert001 onchange='AddAlert01(this)'>
        <option value=" "></option>
        PATWEB98.01.306.2 
        </select>
    </td>-->
</tr>
</table>
</table>
</form>
</div>

<div id=TableLocation></div>

<script type="text/javascript">
function InitTable() {
 document.title="%PATWEB98.01.002"
//
//--------------------------------------------------
// Columns : 0 - Link
//           1 - Alert Category Description (H1-H9)
//           2 - Alert Code Description
//           3 - Reaction Code Description
//           4 - Reaction Comments
//           5 - Name of web user
//           6 - Alert Date
//           7 - Security Level
//           8 - Review Date
//           9 - AlertIcon name 
//--------------------------------------------------
//
// Create New Table Object
// Border, Cellspacing, Cellpadding, Width, Align, Heading Height, Row Height
//
 t = new Table(1,0,1,"100%","center",35,30);
//
// Add Columns in Order Required
// Heading,Type,Display Column,Sort Column, Align, Icon, Link Column
//
 t.addColumn("Type","ImageText",1,1,"left","AlertIcon","0",80,9);
 t.addColumn("Description","String",2,2,"left","","",80);
 t.addColumn("Infection Status","String",3,3,"left","","",60);
 t.addColumn("Reaction Comment/Lab no","String",4,4,"left style='word-wrap:break-word;padding:0px 5px;'","","",110);
 if (document.getElementById('ptcnhdps').value=="6") {
   t.addColumn("Authorising Clinician","String",16,16,"left","","",80);
 } else {
   t.addColumn("Requested By HCP","String",16,16,"left","","",80);
 }
 t.addColumn("Created By","String",5,5,"left","","",80);
 t.addColumn("Updated By","String",15,15,"left","","",80);
 t.addColumn("Date Activated","Date",6,6,"center","","",50);
 t.addColumn("Inactive/Exp End Date","String",14,14,"center","","",60);
 t.addColumn("Level","Image",7,7,"center","AlertStatus","",30);
 t.addColumn("Document","String",10,10,"center","","",30);

//
// Add Rows to Table (Output from Web Server)
//
 %PATWEB98.01.306.1.cliweb01.01.003

 AddAllergies() 

 if (t.rows.length != 0 ) {
   OrderColumn=6; 
   AscDsc=2;
   lastOrderColumn=OrderColumn;
   TableOutput(OrderColumn,AscDsc);
 }
}
function AddAllergies() {
  if (medchartAvailable) {
    document.getElementById("btnLaunchMedchart").style.display="";
  }

  if (!jsonAllergies) return;

  if (!isWhitespace(sMedChartVer)) {
    if (parseInt(sMedChartVer) > 8) { bIsLegacyAllergy = false };
  }

  if (bIsLegacyAllergy) {  // LEGACY Allergies schema
    for (var Allergy in jsonAllergies) {
      var AllergyID=jsonAllergies[Allergy]['Id'];
      var Description=jsonAllergies[Allergy]['Description'];
      var StartDate=jsonAllergies[Allergy]['StartDate'];
      var DiagnosisDate=jsonAllergies[Allergy]['DiagnosisDate'];
      var CertaintyDescription=jsonAllergies[Allergy]['Certainty']['Description'];
      var StatusDescription=jsonAllergies[Allergy]['Status']['Description'];
      var StatusId=jsonAllergies[Allergy]['Status']['StatusId'];
      var TypeDescription=jsonAllergies[Allergy]['AllergyType']['Description'];
      var CreatedBy='';
      var ModifiedBy=jsonAllergies[Allergy]['ModifiedByName']['DisplayName'];

      var StatusComment=jsonAllergies[Allergy]['Comment'];
      if (StatusComment==undefined) StatusComment="";

      StartDate=netDate(StartDate,"datetime");
      DiagnosisDate=netDate(DiagnosisDate,"datetime");

      if (StatusId==1) {
        t.addRow("javascript:LaunchMedchart('patient')",TypeDescription,
                 Description,StatusDescription,StatusComment,CreatedBy,
                 DiagnosisDate,'','','1','','','','','',ModifiedBy,'');
      }
    }
  }
  else {  // NEW Allergies schema
    for (var Allergy in jsonAllergies['Allergies']) {
      var AllergyID=jsonAllergies['Allergies'][Allergy]['Id'];
      var Description=jsonAllergies['Allergies'][Allergy]['Description'];
      var StartDate=jsonAllergies['Allergies'][Allergy]['StartDate'];
      var DiagnosisDate=jsonAllergies['Allergies'][Allergy]['DiagnosisDate'];
      var CertaintyDescription=jsonAllergies['Allergies'][Allergy]['Certainty']['Description'];
      var StatusDescription=jsonAllergies['Allergies'][Allergy]['Status']['Description'];
      var StatusId=jsonAllergies['Allergies'][Allergy]['Status']['StatusId'];
      var TypeDescription=jsonAllergies['Allergies'][Allergy]['AllergyType']['Description'];
      var CreatedBy='';
      var ModifiedBy=jsonAllergies['Allergies'][Allergy]['ModifiedByName']['DisplayName'];
      var StatusComment=jsonAllergies['Allergies'][Allergy]['Comment'];
      if (StatusComment==undefined) StatusComment="";

      StartDate=netDate(StartDate,"datetime");
      DiagnosisDate=netDate(DiagnosisDate,"datetime");

      if (StatusId==1) {
        t.addRow("javascript:LaunchMedchart('patient')",TypeDescription,
                 Description,StatusDescription,StatusComment,CreatedBy,
                 DiagnosisDate,'','','1','','','','','',ModifiedBy,'');
      }
    }
  }
}
//
// Format .NET Date Return in JSON from MedChart
//
function netDate(el,format) {
  if (isWhitespace(el)) return "";
  var d = new Date(parseInt(el.replace(/\/+Date\(([\d+-]+)\)\/+/, '$1')));
  var ThisHrs=d.getHours();
  var ThisMin=d.getMinutes();
  var ThisDay=d.getDate();
  var ThisMth=parseInt(d.getMonth(),10) +1;
  var ThisYrs=d.getFullYear();
  if (ThisHrs < 10) ThisHrs="0" + ThisHrs
  if (ThisMin < 10) ThisMin="0" + ThisMin
  if (ThisDay < 10) ThisDay="0" + ThisDay
  if (ThisMth < 10) ThisMth="0" + ThisMth
  ThisHrs = ThisHrs.toString();
  ThisMin = ThisMin.toString();
  ThisMth = ThisMth.toString();
  ThisDay = ThisDay.toString();
  var monthname = new Array(12)
  monthname[0]="Jan"
  monthname[1]="Feb"
  monthname[2]="Mar"
  monthname[3]="Apr"
  monthname[4]="May"
  monthname[5]="Jun"
  monthname[6]="Jul"
  monthname[7]="Aug"
  monthname[8]="Sep"
  monthname[9]="Oct"
  monthname[10]="Nov"
  monthname[11]="Dec"
  var MonthName=monthname[d.getMonth()]; 
  if (format=="displaydate") return ThisDay+" "+MonthName+" "+ThisYrs
  if (format=="date") return ThisYrs+ThisMth+ThisDay
  if (format=="datetime") return ThisYrs+ThisMth+ThisDay+ThisHrs+ThisMin
}
</script>

<form name=PatientLinks method=get action="cliweb01.pbl">
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=urnumber value="%PATWEB98.01.003">
<input type=hidden name=admissno value="%PATWEB98.01.081">
<input type="hidden" name="MenuType" value="%PATWEB98.01.088">
<input type=hidden name=alert001 value="">
<input type=hidden name=alert002 value="">
<input type=hidden name=alert013 value="">
<input type=hidden name=emrgflag value="Y">
<input type=hidden name=nextpage value="4">
<input type=hidden name=cauda1 value="%STANDARD.01.025.010.250.1.1">
</form>

<span id="DisplayDeleted" style="display:none;">
  <input type=button value="Deleted Alerts" class="button"
   onclick='PatientLinkTo("patweb98.pbl",1,73,0,0);'>
</span>

<span id=WaitBoxDisplay class=WaitBox style="display:none">
<img class=WaitImage src="../images/wait.gif">
<p>Loading MedChart Allergies ...</p>
</span>

<div id=PageLayer class=DimmedLayer style="display:none"></div>
