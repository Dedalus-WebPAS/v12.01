Content-Type: text/html
Cache-Control: no-cache
%START.OF.PAGE
<!DOCTYPE HTML>
<head>
<!--"TemplateVersion"  : "V12.01.00"
    "TemplateHome"     : "mobile"-->
<title>Ward Patient List Community View</title>
<link   rel="stylesheet"        href="../html/ipad/ipad.css" type="text/css">
<style type=text/css>
.mapPointIcon {
  height:40px;
  padding-right:8px;
  display:inline-block;
  float:left;
  vertical-align:top;
}
.mapPointAddress {
  height:40px;
  vertical-align:top;
  display:inline-block;
  width:80%;
  font-size:12px;
}
.mapPoint {
  padding:5px;
  list-style:none;
}
.mapPoints {
  margin:0;
  padding:0;
}
.routeLegTotal {
  border-bottom:1px solid #efefef;
  text-align:right;
  padding:5px;
  list-style:none;
  display:none;
  font-style:bold;
  font-size:17px;
}
.legDistance {
  vertical-align:bottom;
  float:right;
  font-size:12px;
  color:#333;
  display:inline-block;
  padding-top:20px;
}
.legInstruction {
  height:40px;
  vertical-align:top;
  font-size:12px;
  display:inline-block;
  width:70%;
  padding-top:5px;
}
.legImage {
  vertical-align:top;
  float:left;
  font-size:12px;
  display:inline-block;
  font-weight:bold;
  padding-top:5px;
}
.instructionLeg {
  float:right;
  margin-top:-5px;
  background-color:#fff;
  width:80px;
  margin-right: -10px;
}
.instructionItem {
  font-size:12px;
  border-bottom:1px solid #efefef;
  list-style:none;
}
.dir-ds-icon {
  background-image: url('https://maps.gstatic.com/mapfiles/dir/tt2.png');
  background-repeat: no-repeat;
  width: 20px;
  height: 20px;
  display:inline-block;
  vertical-align:top;
}
.dir-tt-turn-right {
 background-position: 0 -503px;
}
.dir-tt-turn-slight-left {
 background-position: 0 0;
}
.dir-tt-merge {
 background-position: 0 -35px;
}
.dir-tt-turn-left {
 background-position: 0 -541px;
}
.dir-tt-ramp-left {
 background-position: 0 -484px;
}
.dir-tt-fork-left {
background-position: 0 -105px;
}
.dir-tt-roundabout-left {
 background-position: 0 -70px;
}
.dir-tt-none {
 background-position: 0 -1000px;
}
.map {
 width:100%;
 height:700px
}
.directions {
 font-size:12px;
 background-color:#fff;
}
</style>
</head>
<body onload="InitTable();">
<table border=1 padding=0 margin=0 width=100% style='background-color:white;'>
<tr style='vertical-align:top'><td width=25%>
<div id="direction_canvas"></div>
</td><td>
<div id="map_canvas" class=map></div>
</td></tr>
</table>
<div id=ListLocation></div>
<script type="text/javascript"  src="../html/ipad/ipad.js"> </script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&key=%STANDARD.01.044.124.161.050"></script>
<script type="text/javascript"> 
// Source Code:  ./ipad/patweb9301190.js
//
// Modification 
//
// Version   Date       Responsible/Changes Made
//------------------------------------------------------------------------------
// V10.03.02 06.08.2013 B.G.Ackland   CAR 289383
//                      Fixed to use createHttpObject() in place of XMLHttpRequest()
var points = new Array();
var route = new Route();
var mapPath = new Array();
var directionDisplay;
var directionsService = new google.maps.DirectionsService();
var map;
var currentLat = 0;
var currentLong = 0;
var geocoder;
var currentLocationAddress;
var waypoint_markers = [];
var PatientRecords = null;
var currentLocationSet = false;
var roundRobbin = 0;
var visited = new Array();
var infowindowArray  = [];

function startMap(arrayAddress,placeHolderId) {
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition( 
      function (position) {  
        currentLat = position.coords.latitude;
        currentLong = position.coords.longitude;
        geocoder = new google.maps.Geocoder();
        initialize(placeHolderId);
        codeLatLng(arrayAddress);
       },function (error){
          switch(error.code){
            case error.TIMEOUT:
              alert ('Timeout');
              break;
            case error.POSITION_UNAVAILABLE:
              alert ('Position unavailable');
              break;
            case error.PERMISSION_DENIED:
              alert ('Permission denied');
              break;
            case error.UNKNOWN_ERROR:
              alert ('Unknown error');
              break;
          }
        });
   }
} 
function setCurrentLocation(arrayLocations) {
   if(typeof currentLocationAddress != 'undefined') {
     arrayLocations.push(currentLocationAddress);
     currentLocationSet = true;
   }else {
     currentLocationSet = false;
   }
}
function getDistance(originArray) { 
  var service = new google.maps.DistanceMatrixService();
  var arrayLocations = new Array();
  if(startlocation == 0) {
    setCurrentLocation(arrayLocations);
  }else {

    var cookieLocation = getCookie('savedStartingLocation');

    if(cookieLocation.replace(/ /g,"").length != 0 ) {
      arrayLocations.push(getCookie('savedStartingLocation'));
      currentLocationSet = true;
    }else {
       setCurrentLocation(arrayLocations);
    }
  }
  for(var i = 0; i < originArray.length;i++) {
    arrayLocations.push(originArray[i]);
  }
  service.getDistanceMatrix( {
         origins: arrayLocations,
         destinations: arrayLocations,
         travelMode: google.maps.TravelMode.DRIVING,
         avoidHighways: false,
         avoidTolls: false
  },callback);
}
function Node() {
  this.name = "";
  this.duration = 0;
  this.distance = "";
  this.nodePath = "";
  this.id = "";
  this.pid = 0;
  this.neighbour = new Array();
  this.patientId = "";
  this.patientName = "";
}
function Route() {
  this.collectionOfNodes = new Array();
}
function callback(response,status) {
  if (status == google.maps.GeocoderStatus.OK) {
    for (var i =0 ; i < response.rows.length; i++) {
      var node = new Node();
      node.distance = 0;
      node.duration = 0;
      node.nodePath = "";
      node.id = i;
      node.pid = 0;
      if (currentLocationSet == true) {
        if (i == 0) {
           node.patientName = "Start Location";
        } else{
            node.patientId = t.rows[i-1][0];
            node.patientName = t.rows[i-1][3];
        }
      } else {
        node.patientId = t.rows[i][0];
        node.patientName = t.rows[i][3];
      }
      node.name = response.originAddresses[i];
      for (var j =0; j < response.rows[i].elements.length; j++) {
        var nNode = new Node();
        nNode.name = response.destinationAddresses[j];
        nNode.id = j;
        nNode.pid = i;
        nNode.nodePath = i+"->"+j;
        nNode.distance = response.rows[i].elements[j].distance.value;
        nNode.duration = response.rows[i].elements[j].duration.value;
        if (node.name != nNode.name) {
          node.neighbour.push(nNode); 
        }        
      }
      route.collectionOfNodes.push(node);
    }
    if (!userDefinedUsed) {
      shortestPath();
    } else {
      setUpUserDefinedPath();
    }
    displayPath();
  } else {
    alertify.alert("Failed to load google maps");
  }
}
function shortestPath() {
  var isInList = false;
  var index = 0;
  var nodeSave = route.collectionOfNodes.slice();
  var node = nodeSave[0];
  var count = nodeSave.length;
  var shortest;
  var num = 0;
  visited.push(node.id);
  while (count>0) {
    var index = 0;
    shortest = 9007199254740992;
    for ( var i = 0; i < node.neighbour.length; i++ ) {
      var cmpShortest = node.neighbour[i].duration;
      isInList = false;
      for (var k = 0; k < visited.length; k++) {
        if (parseInt(visited[k]) == parseInt(node.neighbour[i].id)) {
          isInList = true;
          break;
        }
      }
      if (!isInList) {
        if ( parseInt(shortest) > parseInt(cmpShortest)) {
          shortest = cmpShortest;
          index = i; 
        }  
      }
    }
    visited.push(node.neighbour[index].id);
    node = nodeSave[node.neighbour[index].id];
    count--;
  }
  var num = 0;
  if (roundRobbin == 1) {
    num = 0;
  } else {
    num = 1;
  }
  for (var j = 0; j < visited.length-num; j++ ){
    mapPath.push(route.collectionOfNodes[visited[j]]);
  }
}        
function setUpUserDefinedPath() {
  var nodeSave = route.collectionOfNodes.slice();	
  var num = 0;
  if (roundRobbin == 0) {
    num = 0;
  } else {
    num = 1;
  }
  var tmpUserDefinedPath = userDefinedRoute.substring(0,userDefinedRoute.length-1).split('|');
  mapPath.push(route.collectionOfNodes[0]);
  for (var i =0; i < tmpUserDefinedPath.length; i++) {
    mapPath.push(route.collectionOfNodes[parseInt(tmpUserDefinedPath[i])+1]);
  }
  if (num == 1) {
    mapPath.push(route.collectionOfNodes[0]);
  }
}
function sortPointsDuration(a,b) {
  return (parseInt(a.duration) - parseInt(b.duration));
}
function displayPath() {
  calcRoute(mapPath[0],mapPath[mapPath.length-1]);
}
function codeLatLng(a) {
  var nArray = new Array();
  var lat = parseFloat(currentLat);
  var lng = parseFloat(currentLong);
  var latlng = new google.maps.LatLng(lat, lng);
  geocoder.geocode({'latLng': latlng}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      if (results[1]) {
        currentLocationAddress = results[0].formatted_address;
        getDistance(a);
      }
    } else {
      alertify.alert("Geocoder failed due to: " + status);
    }
  });
}
function initialize(placeHolderId) {
  directionsDisplay = new google.maps.DirectionsRenderer();
  var currentLocation = new google.maps.LatLng(currentLat, currentLong);
  var myOptions = {
    zoom:12,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: currentLocation
  }
  map = new google.maps.Map(document.getElementById(placeHolderId), myOptions);
  directionsDisplay.setMap(map);
}
function calcRoute(a,b) {
  var start = a.name;
  var end = b.name;
  var waypts = [];
  for (var i = 1; i < mapPath.length; i++) {
    if (i>8) {
      alertify.alert("Google Licence Limit Set at 8 Way Points.");
      break;
    }
    waypts.push({
      location: mapPath[i].name,
      stopover:true
    });
  }
  var request = {
      origin: start,
      destination: end,
      waypoints: waypts,
      optimizeWaypoints: false,
      travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
      var OS="";
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
       	var route = response.routes[0];
        for (var i = 0; i < route.legs.length; i++) {
          var alpha = String.fromCharCode(65+i);
          OS+="<ul id=mapPoints"+i+" class=mapPoint switch=off onclick=\"showDir(this);\">" +
              "<li class=mapPoint>"+
              "<div class=mapPointIcon><img class=mapPointMarker "+
              " src='https://maps.gstatic.com/mapfiles/markers2/marker_green"+alpha+".png' /></div>"+
              "<div class=mapPointAddress>"+
              mapPath[i].patientName + "<br/>" +
              route.legs[i].start_address + "<br/>" 
              if ( i > 0 ) {
                OS+=route.legs[i-1].distance.text+" - about "+
                    route.legs[i-1].duration.text
              }
              OS+="</div></li>";
          for(var j = 0; j < route.legs[i].steps.length; j++) {
            if (route.legs[i].steps[j].maneuver) {
              imgClass = "<span class='dir-ds-icon dir-tt-"+route.legs[i].steps[j].maneuver+"'></span>";
            } else {
               imgClass = "<span class='dir-ds-icon dir-tt-none'></span>";
            }
            OS += "<li class=instructionItem style='display:none;'>" +
                  "<span class=legImage>"+imgClass+" "+(j+1)+". </span>"+ 
                  "<span class=legInstruction>"+route.legs[i].steps[j].instructions  + "</span>"+
                  "<span class=legDistance>"+ route.legs[i].steps[j].distance.text+"<span>"+
                  "</li>";
          }
          OS += "<li class=routeLegTotal>"+
                          route.legs[i].distance.text + "</li></ul>";

        }
        var summaryPanel = document.getElementById("direction_canvas");
        summaryPanel.innerHTML = OS;
    }
    watch_waypoints();

    directionsDisplay.setOptions({
       suppressMarkers: true 
    });

  });
}
function showDir(el) {
  if ((el.getAttribute("switch")) == "off") {
     for (var i =1; i < el.childNodes.length; i++) {
       el.childNodes[i].style.display = "";
     }
     el.setAttribute("switch","on");
  } else {
    for (var i =1; i < el.childNodes.length; i++) {
      el.childNodes[i].style.display = "none";
    }
    el.setAttribute("switch","off");
  }
}
function watch_waypoints() {
  clear_markers();
  var wpts = directionsDisplay.directions.routes[0].legs;
  var that = this;
  var arrPatient = PatientRecords.rows.slice();
  var patFound = 0;
  var secondMarker  = null;
  for (var i  = 0; i < wpts.length; i++ ) {
    var alpha = String.fromCharCode(65+i);
    that.marker = new google.maps.Marker({
      map: map,
      icon: 'https://maps.gstatic.com/mapfiles/markers2/marker_green'+alpha+'.png',
      position: wpts[i].start_location,
      title: i.toString(),
      draggable :false
    });
    if (i == 0) {
      waypoint_markers.push(that.marker);
      that.marker.metadata = {type: "point", id: patFound};
      var infowindow = new google.maps.InfoWindow({ content: "Starting location " });
      infowindowArray.push(infowindow);
      google.maps.event.addListener(that.marker, 'click', function() {
        infowindowArray[this.metadata.id].open(map,this);
      });
      patFound++;
      continue;
    }
    var count = 0;
    while (count < arrPatient.length) {
      if (mapPath[i].patientId.replace(/ /g,"") == arrPatient[count][0].replace(/ /g,"")) { 
        waypoint_markers.push(that.marker);
        that.marker.metadata = {type: "point", id: patFound};
        var infowindow = new google.maps.InfoWindow({ 
          content: "<span style='font-style:bold'>"+arrPatient[count][3] +"</span><br />"+
                   "<span>"+arrPatient[count][24] +"</span>"
          });
        infowindowArray.push(infowindow);
        google.maps.event.addListener(that.marker, 'click', function() {
          infowindowArray[this.metadata.id].open(map,this);
        });
        patFound++;
        break;
      }
      count++;
    }
  }
}
function clear_markers() {
  for(var i=0; i<waypoint_markers.length; i++){
    waypoint_markers[i].setMap(null);
  }
}
function InitTable() {
  setMapHeight();
  PatientRecords = new Table("patient-list","patient-item");
  t=PatientRecords;
  wardcode = getQueryString("wardcode");
  startlocation = getQueryString("startlocation");
  roundRobbin = parseInt(getQueryString("roundrobbin"),10);
  userDefinedUsed = parseInt(getQueryString("userdefinedused"),10);
  userDefinedRoute = getQueryString("userdefinedroute");
  sortBy = getQueryString("sortby");
  theURL="patweb93.php?reportno=3&wardcode="+wardcode;
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", theURL, false);
  xmlHttp.send();
   if (xmlHttp.responseText!=""&&xmlHttp.status == 200) {
    h = document.getElementsByTagName("head")[0];
    s = document.createElement("script");
    s.type="text/javascript";
    h.appendChild(s);
    s.text=xmlHttp.responseText;
  }
  AddRows();
  SortPatients(sortBy);
  var arrayAddress = [];
  for(var i = 0; i < PatientRecords.rows.length; i++ ) {
    arrayAddress.push(PatientRecords.rows[i][24]);
  };
  startMap(arrayAddress,'map_canvas');
}
function SortPatients(value) {
 SortOrderBy=value;
 PatientRecords.rows.sort(StringSort);
}
function setMapHeight() {
 if(navigator.userAgent.match(/Windows/i)|| navigator.userAgent.match(/Macintosh/i) ) {
   mapContentHeight()
   return;
 }
 var map = document.getElementById('map_canvas');
 map.style.height="700px"
}
function mapContentHeight() {
  var iframe=top.document.getElementById('iphone-frame')
  var map = document.getElementById('map_canvas');
  map.style.height=parseInt(iframe.style.height.replace(/px/,""),10)-61+"px";
}
</script>

</body>


