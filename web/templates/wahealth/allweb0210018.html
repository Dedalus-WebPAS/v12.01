<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="wahealth">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script language=javascript src="../js/allweb0210.js"></script>
<script type=text/javascript>
 function UpdateRef(){

   f=document.UpdateForm;

   if(f.pmrug005.value=="1"){
      if(chkDischarge(f)){
         return;
      }
   }
   if(f.superlev.value == "1"){
      if(f.pmrug024.selectedIndex != "0"){
         alert("Reason for Delete may not be entered for Update");
         f.pmrug024.className="";
         return false;
      }
   }

   if(!IsTimestampBetweenRange(f.admndate,f.admntime,f.discdate,f.disctime,f.savkey02,f.savkey03,false)){
      return false;
   }
   if(!IsTimestampBetweenRange(f.admndate,f.zerotime,f.discdate,f.zerotime,f.pmrug006,f.zerotime,true,false)){
      alert("Phase start/end date cannot be earlier than the admission date or later than the discharge date");
      return false;
   }
   if(!IsTimestampBetweenRange(f.admndate,f.zerotime,f.discdate,f.zerotime,f.pmrug007,f.zerotime,true,false)){
      alert("Phase start/end date cannot be earlier than the admission date or later than the discharge date");
      return false;
   }

   if(!CompareDateToNow(f.savkey02,f.savkey03)){
      return false;
   }
   if(!CompareDateToNow(f.pmrug006,f.zerotime)){
      return false;
   }
   if(!CompareDateToNow(f.pmrug007,f.zerotime)){
      return false;
   }
   if((!isWhitespace(f.pmrug007.value)) && 
      (SetDateYYYYMMDD(f.pmrug006.value)>SetDateYYYYMMDD(f.pmrug007.value))){
      alert("Phase End Date cannot be before Phase Start Date");
      return false;
   }
   if(!isValidPhaseSubmission()){
      return false;
   }
   if(f.pmrug005.value=="2"){
      for(i=4; i<8; i++){
        var alsasVar = eval("f.alsas00"+i);
        if(alsasVar.value==" 9"){
           alert(alsasVar.title + " is a required field.\nPlease enter it now.");
           return false;
        }
      }
   }
   if(validateMandatory(f)) {
      f.updatety.value="R";
      f.pmrug005.disabled=false;
      f.submit();
   }
 }
function DeleteRef() {

  f = document.UpdateForm;
  oldVal = SetDateYYYYMMDD(f.pmrug002.value) + f.pmrug003.value;

  // Check that previous and next phase types are different
  for(i=0; i<allAssessments.length; i++){
      if(oldVal==allAssessments[i].substr(16,16) && i>0 && i<allAssessments.length-1){
         if(allAssessments[i-1].substr(32,3)==allAssessments[i+1].substr(32,3)){
            alert("Delete not permitted. This would result in two adjacent and same phase types.");
            return false;
         }
      }
  }

  f.pmrug024.className="Mandatory";

  if((validateMandatory(UpdateForm))&&(confirm("Are you sure you want to Delete ?"))){
      UpdateForm.updatety.value="S";
      UpdateForm.submit();
  }
  else{
     UpdateForm.pmrug024.className="";
  }
}

function chkAssCde() {
   if(UpdateForm.pmrug005.value=="2") {
     UpdateForm.pmrug006.className="Mandatory Date";
     UpdateForm.pmrug008.className="Mandatory";
     UpdateForm.pmrug010.className="Mandatory";
     UpdateForm.pmrug011.className="Mandatory";
     UpdateForm.pmrug012.className="Mandatory";
     UpdateForm.pmrug013.className="Mandatory";
     UpdateForm.alsas004.className="Mandatory";
     UpdateForm.alsas005.className="Mandatory";
     UpdateForm.alsas006.className="Mandatory";
     UpdateForm.alsas007.className="Mandatory";
   } else {
     UpdateForm.pmrug006.className="Date";
     UpdateForm.pmrug008.className="";
     UpdateForm.pmrug010.className="";
     UpdateForm.pmrug011.className="";
     UpdateForm.pmrug012.className="";
     UpdateForm.pmrug013.className="";
     UpdateForm.alsas004.className="";
     UpdateForm.alsas005.className="";
     UpdateForm.alsas006.className="";
     UpdateForm.alsas007.className="";
   }
 }
</script>
</head>
%START.OF.PAGE
<body onload="PageLoad();chkAssCde();">
<span class=DFrameTitleBar>
  <img align="right" alt="Exit" class="MenuIcon"
       src="../images/ExitIcon.gif" onclick="DFrameExitRefresh();">
  <script type="text/javascript">
      document.write('Update Palliative Care Assessment');
  </script>
</span>

<div id=PageBodySection style="overflow: auto;">
 <form name=UpdateForm method=post action=allweb02.pbl style="margin:0">
  <input type=hidden name=reportno value="10">
  <input type=hidden name=template value="018">
  <input type=hidden name=updatety value=" ">
  <input type=hidden name=urnumber value="%ALLWEB02.10.003">
  <input type=hidden name=admissno value="%ALLWEB02.10.081">
  <input type=hidden name=pmrug001 value="%ALLWEB02.10.081">
  <input type=hidden name=ptvitype value="%ALLWEB02.10.801">
  <input type=hidden name=alsas001 value="%ALLWEB02.10.081">
  <input type=hidden name=alsas002 value="%ALLWEB02.10.809.002">
  <input type=hidden name=alsas003 value="%ALLWEB02.10.809.003">
  <input type=hidden name=prStrdte value="%ALLWEB02.10.815">
  <input type=hidden name=prEnddte value="%ALLWEB02.10.818.1">
  <input type=hidden name=over24hr value="%ALLWEB02.10.816">
  <input type=hidden name=superlev value="%ALLWEB02.10.811">
  <input type=hidden name=pmrug004 value="0">
  <input type=hidden name=admndate id=admndate value="%ALLWEB02.10.602">
  <input type=hidden name=admntime id=admntime value="%ALLWEB02.10.603">
  <input type=hidden name=discdate id=discdate value="%ALLWEB02.10.701">
  <input type=hidden name=disctime id=disctime value="%ALLWEB02.10.702">
  <input type=hidden name=zerotime value="00:00:00">
  <input type=hidden name=maxtime value="23:59:59">
  <input type=hidden name=prvkey40 value="">
  <input type=hidden name=nxtkey40 value="">

  <table align=center width=100% border=1 cellspacing=0 cellpadding=0>
   <tr><td class=DataLabel>Assessment Date</td>
       <td><input type=text name=savkey02 id=savkey02 
            value="%ALLWEB02.10.809.002"
            title="Assessment Date" class="Mandatory PastDate">
           <input type=hidden name=pmrug002 value="%ALLWEB02.10.809.002">
           <img src="../images/DateLookup.gif" class=Icon
             onclick="DateLookupFrame(UpdateForm.savkey02);">
           Time&nbsp;
           <input type=text size=6 title="Time" value="%ALLWEB02.10.809.003"
            class="Mandatory" name=savkey03 id=savkey03>
           <input type=hidden name=pmrug003 value="%ALLWEB02.10.809.003">
           <img src="../images/DateTimeStamp.gif" class=Icon
            onclick="SetCurrentDateTime(UpdateForm.savkey02,
                                        UpdateForm.savkey03);">
           <img src="../images/TimeLookup.gif" class=Icon time=time1
            onclick="TimeLookupFrame(UpdateForm.savkey03);">
           </td></tr>

   <tr><td class="DataLabel">Admission for Assessment Only</td>
       <td><select name=pmrug005 title="Admission for Assessment Only"
            class=Mandatory onchange="chkAssCde();">
            <option></option>
            <option value="1">Yes</option>
            <option value="2">No</option>
           </select></td></tr>

   <tr><td class=DataLabel>Phase Start Date</td>
       <td><input type=text name=pmrug006 id=pmrug006
         value="%ALLWEB02.10.809.006"
         title="Phase Start Date" class="Date" 
         onblur="checkDate(this,'Phase Start Date');">
           <img src="../images/DateLookup.gif" class=Icon
             onclick="DateLookupFrame(UpdateForm.pmrug006);"></td</tr>

   <tr><td class=DataLabel>Phase End Date</td>
       <td><input type=text name=pmrug007 id=pmrug007
                  value="%ALLWEB02.10.809.007"
                  title="Phase End Date" class="Date"
                  onchange="checkDate(this,'Phase End Date');">
             <img src="../images/DateLookup.gif" class=Icon
                  onclick="DateLookupFrame(UpdateForm.pmrug007);"></td</tr>

   <tr><td class="DataLabel">Phase Type</td>
       <td><select name="pmrug008" title="Phase Type">
            <option></option>
            %ALLWEB02.10.812.2
           </select></td></tr>

   <tr><td class="HeadingCell" align=center colspan="2">Update Palliative RUG-ADL Assessment</td></tr>

   <tr><td class=DataLabel align=center>Bed Mobility</td>
       <td align=center>
           <select name=pmrug010 title="Bed Mobility">
            <option></option>
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
           </select></td></tr>

   <tr><td class=DataLabel align=center>Toileting</td>
       <td align=center>
           <select name=pmrug011 title="Toileting">
            <option></option>
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
           </select></td></tr>

   <tr><td class=DataLabel align=center>Transfers</td>
       <td align=center>
           <select name=pmrug012 title="Transfers">
            <option></option>
            <option value="1">1</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select></td></tr>

   <tr><td class=DataLabel align=center>Eating</td>
       <td align=center>
           <select name=pmrug013 title="Eating">
            <option></option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
           </select></td></tr>

   <tr><td class="HeadingCell" align=center colspan=2>
           Palliative Care Problem Severity Scores</td></tr>

   <tr><td class=DataLabel align=center>Pain Sub-Scale</td>
       <td align=center>
           <select name=alsas004 title="Pain Sub-Scale">
            <option value=" 9"> </option>
            <option value=" 0">0</option>
            <option value=" 1">1</option>
            <option value=" 2">2</option>
            <option value=" 3">3</option>
           </select></td></tr>

   <tr><td class=DataLabel align=center>Other Symptoms Sub-Scale</td>
       <td align=center>
           <select name=alsas005 title="Other Symptoms Sub-Scale">
            <option value=" 9"> </option>
            <option value=" 0">0</option>
            <option value=" 1">1</option>
            <option value=" 2">2</option>
            <option value=" 3">3</option>
           </select></td></tr>

   <tr><td class=DataLabel align=center>Psychological Sub-Scale</td>
       <td align=center>
           <select name=alsas006 title="Psychological Sub-Scale">
            <option value=" 9"> </option>
            <option value=" 0">0</option>
            <option value=" 1">1</option>
            <option value=" 2">2</option>
            <option value=" 3">3</option>
           </select></td></tr>

   <tr><td class=DataLabel align=center>Family/Carer Sub-Scale</td>
       <td align=center>
           <select name=alsas007 title="Family/Carer Sub-Scale">
            <option value=" 9"> </option>
            <option value=" 0">0</option>
            <option value=" 1">1</option>
            <option value=" 2">2</option>
            <option value=" 3">3</option>
           </select></td></tr>

   <tr><td class="HeadingCell" align=center colspan=2>
           <div id="reasonHeading"></div></td></tr>

   <tr><td class=DataLabel><div id="reasonHead"></div></td>
       <td><div id="reasonCode"></div></td></tr>

   <tr><td colspan=2 align=center><br>
       <input type=button id=btnUpdate value="Update" class="button"
         onclick="tempDisable(this);UpdateRef();">
       <span id="deleteButton" style="display: none">
       <input type=button id=btnDelete value="Delete" class="button"
         onclick="tempDisable(this);DeleteRef();">
       </span>
       <input type=button value=Cancel class="button"
        onclick="DFrameCloseRefresh();"></td></tr>
  </table>
 </form>
</div>

<span id="reasonhdg" style="display:none">&nbsp;</span>
<span id="reasonhd" style="display:none">Reason For Delete</span>
<span id="reasoncd" style="display:none">
 <select name="pmrug024" title="Reason for Delete">
  <option></option>
   %ALLWEB02.10.809.024.2
 </select>
</span>

<script type=text/javascript>

 for (var i=0; i<UpdateForm.pmrug005.length; i++) {
   if (UpdateForm.pmrug005.options[i].value=="%ALLWEB02.10.809.005.1") {
     UpdateForm.pmrug005.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.pmrug008.length; i++) {
   if (UpdateForm.pmrug008.options[i].value=="%ALLWEB02.10.809.008") {
     UpdateForm.pmrug008.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.pmrug010.length; i++) {
   if (UpdateForm.pmrug010.options[i].value=="%ALLWEB02.10.809.010") {
     UpdateForm.pmrug010.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.pmrug011.length; i++) {
   if (UpdateForm.pmrug011.options[i].value=="%ALLWEB02.10.809.011") {
     UpdateForm.pmrug011.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.pmrug012.length; i++) {
   if (UpdateForm.pmrug012.options[i].value=="%ALLWEB02.10.809.012") {
     UpdateForm.pmrug012.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.pmrug013.length; i++) {
   if (UpdateForm.pmrug013.options[i].value=="%ALLWEB02.10.809.013") {
     UpdateForm.pmrug013.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.alsas004.length; i++) {
   if (UpdateForm.alsas004.options[i].value=="%ALLWEB02.10.504") {
     UpdateForm.alsas004.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.alsas005.length; i++) {
   if (UpdateForm.alsas005.options[i].value=="%ALLWEB02.10.505") {
     UpdateForm.alsas005.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.alsas006.length; i++) {
   if (UpdateForm.alsas006.options[i].value=="%ALLWEB02.10.506") {
     UpdateForm.alsas006.selectedIndex=i; }
 }
 for (var i=0; i<UpdateForm.alsas007.length; i++) {
   if (UpdateForm.alsas007.options[i].value=="%ALLWEB02.10.507") {
     UpdateForm.alsas007.selectedIndex=i; }
 }
 if (document.UpdateForm.superlev.value == "1") {
   reasonHeading.innerHTML=reasonhdg.innerHTML;
   reasonHead.innerHTML=reasonhd.innerHTML;
   reasonCode.innerHTML=reasoncd.innerHTML;
   deleteButton.style.display="";
 } 

  f = document.UpdateForm;

  HIDE_ERROR = true; //constant, do not change
  DONT_CONVERT_ARGS = true // Dates & Times coming through in raw format so no need to convert.
  months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  allAssessments = [%ALLWEB02.10.809.029];
  allAssessments.pop(); 
  allAssessments.sort();

  currentIndex = "";
  previousIndex = "";
  nextIndex = "";
  previousAssessmentForAdd = "";
  nextAssessmentForAdd = "";
  currentRow = f.pmrug002.value.substr(7,4) + GetMonthNumber(f.pmrug002.value.substr(3,3)) +
               f.pmrug002.value.substr(0,2) + f.pmrug003.value;

  for(i=0; i<allAssessments.length; i++){
      if(currentRow==allAssessments[i].substr(16,16)){
         currentIndex=i;
      }
  }

  if(currentIndex!=0){
     previousAssessmentForAdd = allAssessments[currentIndex-1];
     previousIndex = currentIndex-1;
  } 
  if(currentIndex!=allAssessments.length-1){
     nextAssessmentForAdd = allAssessments[currentIndex+1];
     nextIndex = currentIndex + 1;
  }
  previousPhaseStartDate = previousAssessmentForAdd.substr(0,8);
  previousPhaseEndDate = previousAssessmentForAdd.substr(8,8);
  previousPhaseType = previousAssessmentForAdd.substr(32,3);
  previousASSO = previousAssessmentForAdd.substr(35,1);
  previousRecordIndex = "" ;

  nextPhaseStartDate = nextAssessmentForAdd.substr(0,8);
  nextPhaseEndDate = nextAssessmentForAdd.substr(8,8);
  nextPhaseType = nextAssessmentForAdd.substr(32,3);
  nextASSO = nextAssessmentForAdd.substr(35,1);
  nextRecordIndex = "";

  if(previousASSO=="2"){
     f.pmrug005.selectedIndex=2;
     f.pmrug005.disabled=true;
     chkAssCde();
  }

  //Default this Phase start date to the admission date if no previous Phase exists
  if(isWhitespace(f.pmrug006.value)){
     if(previousPhaseEndDate==""){
        f.pmrug006.value = f.admndate.value;
     }
     //Default start date to today if previous Phase has no end date
     else if(previousPhaseEndDate=="99999999"){
        SetCurrentDateTime(f.pmrug006,null);
     }
     // Default to previous phase end date
     else{
        month = parseInt(previousPhaseEndDate.substr(4,2)) - 1;
        d = new Date(previousPhaseEndDate.substr(0,4),month,previousPhaseEndDate.substr(6,2),0,0,0,0);
        f.pmrug006.value = d.getDate() + " " + months[d.getMonth()] + " " + d.getFullYear();
        if(d.getDate()<10){
           f.pmrug006.value = "0" + f.pmrug006.value;
        }
     }
  }

//---------------------------------------------------------------------------------------//
  // Business requirement to default first phase timestamp to admission timestamp
  // If no first phase, then just proceed with standard clock icon functionality
  function SetToAdmissionTimestamp(){

    if((previousPhaseStartDate!="00000000")&&(previousPhaseStartDate!="")){
        SetCurrentDateTime(f.pmrug002,f.pmrug003);
    }
    else{
        f.pmrug002.value = f.admndate.value;
        f.pmrug003.value = f.admntime.value;
    }
  }

//---------------------------------------------------------------------------------------//
  // Check the rest of the mess
  function isValidPhaseSubmission(){

    previousRecordIndex = -1;
    nextRecordIndex = allAssessments.length;

    assTimestamp = SetDateYYYYMMDD(f.savkey02.value) + f.savkey03.value;
    oldVal = SetDateYYYYMMDD(f.pmrug002.value) + f.pmrug003.value;
    pmrug6 = SetDateYYYYMMDD(f.pmrug006.value);
    pmrug7 = SetDateYYYYMMDD(f.pmrug007.value);
    openEndedCount = 0;


    // Keep reading existing rows forward to see which is closest to user input
    for(i=0; i<allAssessments.length; i++){
        if((allAssessments[i].substr(8,8) < pmrug6)||
           (allAssessments[i].substr(0,8) < pmrug6)){
           if(oldVal!=allAssessments[i].substr(16,16)){
              previousRecordIndex=i;
           }
        }
        if((allAssessments[i].substr(0,8)==pmrug6)||(allAssessments[i].substr(8,8)==pmrug6)){
           if((assTimestamp > allAssessments[i].substr(16,16))&&(oldVal!=allAssessments[i].substr(16,16))){
               previousRecordIndex=i;
           }
        }
    }
    // Keep reading existing rows backward to see which is closest to user input
    for(i=allAssessments.length-1; i>=0; i--){
        if(((allAssessments[i].substr(0,8) > pmrug7)&&(!isWhitespace(pmrug7)))||
           ((allAssessments[i].substr(8,8) > pmrug7)&&(!isWhitespace(pmrug7)))){
           if(oldVal!=allAssessments[i].substr(16,16)){
              nextRecordIndex=i;
           }
        }
        if((allAssessments[i].substr(0,8)==pmrug7)||(allAssessments[i].substr(8,8)==pmrug7)){
           if((assTimestamp < allAssessments[i].substr(16,16))&&(oldVal!=allAssessments[i].substr(16,16))){
               nextRecordIndex=i;
           }
        }
        if((allAssessments[i].substr(8,8)=="99999999")&&(pmrug7<=allAssessments[i].substr(0,8))){
           if(oldVal!=allAssessments[i].substr(16,16)){
              if(!isWhitespace(pmrug7)){
                 nextRecordIndex=i;
              }
           }
        }
        if((isWhitespace(pmrug7))&&(pmrug6<allAssessments[i].substr(0,8))){
           if(oldVal!=allAssessments[i].substr(16,16)){
               nextRecordIndex=i;
           }
        }
    }

    if(allAssessments.length==1){
       if(f.pmrug006.value!=f.admndate.value){
          alert("First Phase Start Date must be equal to Admission Date");
          return false;
       }
    }
    if(previousRecordIndex!=-1){
       if(pmrug6 < allAssessments[previousRecordIndex].substr(0,8)){
          alert("The Phase Start Date must be on or after the previous Phase Start Date.");
          return false;
       }
    }
    if(nextRecordIndex!=allAssessments.length){
       if(pmrug7 > allAssessments[nextRecordIndex].substr(8,8)){
          alert("The Phase End Date must be on or before the previous Phase End Date.");
          return false;
       }
    }
    if(nextRecordIndex!=allAssessments.length || previousRecordIndex!=-1){
       if(nextRecordIndex-previousRecordIndex!=2){
          alert("Phase Start/End Dates overlap other Assessments. Please check these before proceeding");
          return false;
       }
    }
    if(nextRecordIndex==allAssessments.length && previousRecordIndex==-1){
       if(allAssessments.length>1){
          alert("Phase Start/End Dates overlap other Assessments. Please check these before proceeding");
          return false;
       }
    }
    if(previousRecordIndex==nextRecordIndex){
       alert("Phase Start/End Dates overlap other Assessments. Please check these before proceeding");
       return false;
    }    
    // Now we know that the phase date range insert is ok so lets check everything else
    if(previousRecordIndex!=-1){
       previousPhaseType = allAssessments[previousRecordIndex].substr(32,3);
       previousASSO = allAssessments[previousRecordIndex].substr(35,1);
    }
    if(nextRecordIndex!=allAssessments.length){
      nextPhaseType = allAssessments[nextRecordIndex].substr(32,3);
      nextASSO = allAssessments[nextRecordIndex].substr(35,1);
    }

    // If Previous Phase has a value of No for "Admission For Assessment Only"
    // then all future Phases must also have a value of No & it cant be changed.
    if((previousASSO=="2")&&(f.pmrug005.value!="2")){
       alert("Admission for Assessment Only must be 'No'");
       return false;
    }

    //Current Phase must not be the same as previous or next phases
    if((previousPhaseType==f.pmrug008.value.substr(0,3)) && 
       (!isWhitespace(previousPhaseType)) && (!isWhitespace(f.pmrug008.value))){
        alert("Phase Type cannot be the same as the previous Phase Type");
        return false;
    }
    if((nextPhaseType==f.pmrug008.value.substr(0,3)) && 
       (!isWhitespace(nextPhaseType)) && (!isWhitespace(f.pmrug008.value))){
        alert("Phase Type cannot be the same as the next Phase Type");
        return false;
    }

    if((pmrug7=="")&&(nextRecordIndex!=allAssessments.length)){
        alert("Only the most recent assessment can be open ended");
        return false;
    }

    // Generate Previous and Next Keys for Database Write
    if(previousRecordIndex!=-1){
       f.prvkey40.value = f.admissno.value + allAssessments[previousRecordIndex].substr(16,16)
                        + allAssessments[previousRecordIndex].substr(0,16);
    }
    if(nextRecordIndex!=allAssessments.length){
       f.nxtkey40.value = f.admissno.value + allAssessments[nextRecordIndex].substr(16,16)
                        + allAssessments[nextRecordIndex].substr(0,16);
    }

    return true;
  }

</script>

