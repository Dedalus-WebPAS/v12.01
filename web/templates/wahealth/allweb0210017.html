<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="wahealth">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script language=javascript src="../js/allweb0210.js"></script>
<script type=text/javascript>
function SubmitForm(){

   f = document.AddForm;
   DFrameClear();

   // If Admission for Assessment Only is Yes
   // Then check that stay is not over 24 hours
   if((f.pmrug005.value=="1") && (chkDischarge(f))){
       return;
   }
   // Ensure Assessment Timestamp is not outside Admission-Discharge Timestamp Range
   if(!IsTimestampBetweenRange(f.admndate,f.admntime,f.discdate,f.disctime,f.pmrug002,f.pmrug003,false)){
      return false;
   }
   if(!IsTimestampBetweenRange(f.admndate,f.zerotime,f.discdate,f.zerotime,f.pmrug006,f.zerotime,true,false)){
      alert("Phase start/end date cannot be earlier than the admission date or later than the discharge date");
      return false;
   }
   if(!IsTimestampBetweenRange(f.admndate,f.zerotime,f.discdate,f.zerotime,f.pmrug007,f.zerotime,true,false)){
      alert("Phase start/end date cannot be earlier than the admission date or later than the discharge date");
      return false;
   }
   // Ensure Assessment Timestamp is not in the future
   if(!CompareDateToNow(f.pmrug002,f.pmrug003)){
      return false;
   }
   if(!CompareDateToNow(f.pmrug006,f.zerotime)){
      return false;
   }
   if(!CompareDateToNow(f.pmrug007,f.zerotime)){
      return false;
   }
   if((!isWhitespace(f.pmrug007.value)) &&
      (SetDateYYYYMMDD(f.pmrug006.value)>SetDateYYYYMMDD(f.pmrug007.value))){
     alert("Phase End Date cannot be before Phase Start Date");
     return false;
   }
   if(!isValidPhaseSubmission()){
      return false;
   }
   if(f.pmrug005.value=="2"){
      for(i=4; i<8; i++){
        var alsasVar = eval("f.alsas00"+i);
        if(alsasVar.value==" 9"){
           alert(alsasVar.title + " is a required field.\nPlease enter it now.");
           return false;
        }
      }
   }
   if(validateMandatory(f)) {
      f.target="PopUpFrame";
      f.pmrug005.disabled=false;
      f.submit();
   }
}

function chkAssCde(){

  // If Admission For Assessment Only is "No"   
  if(AddForm.pmrug005.value=="2"){
     AddForm.pmrug006.className="Mandatory Date";
     AddForm.pmrug008.className="Mandatory";
     AddForm.pmrug010.className="Mandatory";
     AddForm.pmrug011.className="Mandatory";
     AddForm.pmrug012.className="Mandatory";
     AddForm.pmrug013.className="Mandatory";
     AddForm.alsas004.className="Mandatory";
     AddForm.alsas005.className="Mandatory";
     AddForm.alsas006.className="Mandatory";
     AddForm.alsas007.className="Mandatory";
  } 
  else{
     AddForm.pmrug006.className="Date";
     AddForm.pmrug008.className="";
     AddForm.pmrug010.className="";
     AddForm.pmrug011.className="";
     AddForm.pmrug012.className="";
     AddForm.pmrug013.className="";
     AddForm.alsas004.className="";
     AddForm.alsas005.className="";
     AddForm.alsas006.className="";
     AddForm.alsas007.className="";
  }
}
</script>
</head>
%START.OF.PAGE
<body onload="PageLoad();">
<span class=DFrameTitleBar>
  <img align="right" alt="Exit" class="MenuIcon" src="../images/ExitIcon.gif" 
    onclick="DFrameExitRefresh();">
  <script type="text/javascript">
    document.write('Palliative Care Assessment');
  </script>
</span>

<div id=PageBodySection style="overflow: auto;">
  <form name=AddForm method=post action=allweb02.pbl style="margin:0">
  <input type=hidden name=reportno value="10">
  <input type=hidden name=template value="017">
  <input type=hidden name=updatety value="Q">
  <input type=hidden name=urnumber value="%ALLWEB02.10.003">
  <input type=hidden name=admissno value="%ALLWEB02.10.081">
  <input type=hidden name=pmrug001 value="%ALLWEB02.10.081">
  <input type=hidden name=ptvitype value="%ALLWEB02.10.801">
  <input type=hidden name=prStrdte value="%ALLWEB02.10.815">
  <input type=hidden name=prEnddte value="%ALLWEB02.10.815">
  <input type=hidden name=over24hr value="%ALLWEB02.10.816">
  <input type=hidden name=pmrug004 value="0">
  <input type=hidden name=admndate value="%ALLWEB02.10.602">
  <input type=hidden name=admntime value="%ALLWEB02.10.603">
  <input type=hidden name=discdate value="%ALLWEB02.10.701">
  <input type=hidden name=disctime value="%ALLWEB02.10.702">
  <input type=hidden name=zerotime value="00:00:00">
  <input type=hidden name=maxtime  value="23:59:59">
  <input type=hidden name=prvkey40 value="">
  <input type=hidden name=nxtkey40 value="">

  <table align=center width=100% border=1 cellspacing=0 cellpadding=0>
    <tr>
      <td class=DataLabel>Assessment Date</td>
      <td>
        <input type=text name=pmrug002 id=pmrug002 value=""
         title="Assessment Date" class="PastDate Mandatory">
        <img src="../images/DateLookup.gif" class=Icon
          onclick="DateLookupFrame(AddForm.pmrug002);">
        Time&nbsp;
        <input type=text size=6 title="Time" value="        "
         class="Mandatory Time" name=pmrug003 id=pmrug003>
        <img src="../images/DateTimeStamp.gif" class=Icon
         onclick="SetToAdmissionTimestamp()">
        <img src="../images/TimeLookup.gif" class=Icon
         onclick="TimeLookupFrame(AddForm.pmrug003);">
      </td>
    </tr>

    <tr>
      <td class="DataLabel">Admission for Assessment Only</td>
      <td>
        <select name="pmrug005" title="Assessment Only" class="Mandatory"
          onchange="chkAssCde();">
          <option></option>
          <option value="1">Yes</option>
          <option value="2">No</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel>Phase Start Date</td>
      <td>
        <input type=text name=pmrug006 id=pmrug006 title="Phase Start Date"
         onblur="checkDate(this,'Phase Start Date');" class="Date">
        <img src="../images/DateLookup.gif" class=Icon
         onclick="DateLookupFrame(AddForm.pmrug006);">
      </td>
    </tr>

    <tr>
      <td class=DataLabel>Phase End Date</td>
      <td>
        <input type=text name=pmrug007 id=pmrug007
         title="Phase End Date" class="Date"
         onchange="checkDate(this,'Phase End Date');">
        <img src="../images/DateLookup.gif" class=Icon
         onclick="DateLookupFrame(AddForm.pmrug007);">
      </td>
    </tr>

    <tr>
      <td class="DataLabel">Phase Type</td>
      <td>
        <select name="pmrug008" title="Phase Type">
          <option></option>
          %ALLWEB02.10.812.2 
        </select>
      </td>
    </tr>

    <tr>
      <td class="HeadingCell" align=center colspan="2">
        Palliative RUG-ADL Assessment
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Bed Mobility</td>
      <td align=center>
        <select name=pmrug010 title="Bed Mobility">
          <option></option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Toileting</td>
      <td align=center>
        <select name=pmrug011 title="Toileting">
          <option></option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Transfers</td>
      <td align=center>
        <select name=pmrug012 title="Transfers">
          <option></option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Eating</td>
      <td align=center>
        <select name=pmrug013 title="Eating">
          <option></option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class="HeadingCell" align=center colspan=2>
        Palliative Care Problem Severity Scores
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Pain Sub-Scale</td>
      <td align=center>
        <select name=alsas004 title="Pain Sub-Scale">
          <option value=" 9"></option>
          <option value=" 0">0</option>
          <option value=" 1">1</option>
          <option value=" 2">2</option>
          <option value=" 3">3</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Other Symptoms Sub-Scale</td>
      <td align=center>
        <select name=alsas005 title="Other Symptoms Sub-Scale">
          <option value=" 9"></option>
          <option value=" 0">0</option>
          <option value=" 1">1</option>
          <option value=" 2">2</option>
          <option value=" 3">3</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Psychological Sub-Scale</td>
      <td align=center>
        <select name=alsas006 title="Psychological Sub-Scale">
          <option value=" 9"></option>
          <option value=" 0">0</option>
          <option value=" 1">1</option>
          <option value=" 2">2</option>
          <option value=" 3">3</option>
        </select>
      </td>
    </tr>

    <tr>
      <td class=DataLabel align=center>Family/Carer Sub-Scale</td>
      <td align=center>
        <select name=alsas007 title="Family/Carer Sub-Scale">
          <option value=" 9"></option>
          <option value=" 0">0</option>
          <option value=" 1">1</option>
          <option value=" 2">2</option>
          <option value=" 3">3</option>
        </select>
      </td>
    </tr>

    <tr>
      <td colspan=2 align=center><br>
        <input type=button id=btnAdd value="Add" class="button"
          onclick="tempDisable(this);SubmitForm();">
        <input type=button value=Cancel class="button"
          onclick="DFrameCloseRefresh();">
      </td>
    </tr>
  </table>
 </form>
</div>

<script type="text/javascript">

  f = document.AddForm;

  HIDE_ERROR = true; //constant, do not change
  DONT_CONVERT_ARGS = true // Dates & Times coming through in raw format so no need to convert.
  months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  previousAssessmentForAdd = "";
  previousPhaseStartDate = "";
  previousPhaseEndDate = "";
  nextAssessmentForAdd = "";
  currentIndex = -1;
  previousPhaseType = "";
  previousASSO = "";
  previousRecordIndex = "" ;

  allAssessments = [%ALLWEB02.10.809.029];
  allAssessments.pop(); 
  allAssessments.sort();

  if(allAssessments.length>0){
     previousAssessmentForAdd = allAssessments[allAssessments.length-1];
     previousPhaseStartDate = previousAssessmentForAdd.substr(8,8);
     previousPhaseEndDate = previousAssessmentForAdd.substr(0,8);
     previousASSO = previousAssessmentForAdd.substr(35,1); 
  }

  nextPhaseStartDate = "";
  nextPhaseEndDate = "";
  nextPhaseType = "";
  nextASSO = "";
  nextRecordIndex = "";

  f.pmrug008.options.selectedIndex=0;

  if(previousASSO=="2"){
     f.pmrug005.selectedIndex=2;
     f.pmrug005.disabled=true;
     chkAssCde();
  }
  //Default this Phase start date to the admission date if no previous Phase exists
  if(previousPhaseEndDate==""){
     f.pmrug006.value = f.admndate.value;
  }
  //Default start date to today if previous Phase has no end date
  else if(previousPhaseEndDate=="99999999"){
     SetCurrentDateTime(f.pmrug006,null);
  }
  // Default to previous phase end date
  else{
     monthInt = previousPhaseEndDate.substr(4,2);
     if (previousPhaseEndDate.substr(4,1) == '0') {
       monthInt = previousPhaseEndDate.substr(4,2).replace(/0/g," ");
     }
     month = parseInt(monthInt) - 1;
     d = new Date(previousPhaseEndDate.substr(0,4),month,previousPhaseEndDate.substr(6,2),0,0,0,0);
     f.pmrug006.value = d.getDate() + " " + months[d.getMonth()] + " " + d.getFullYear();
     if(d.getDate()<10){
        f.pmrug006.value = "0" + f.pmrug006.value;
     }
  }

//---------------------------------------------------------------------------------------//
  // Business requirement to default first phase timestamp to admission timestamp
  // If no first phase, then just proceed with standard clock icon functionality
  function SetToAdmissionTimestamp(){

    if((previousPhaseStartDate!="00000000")&&(previousPhaseStartDate!="")){
        SetCurrentDateTime(f.pmrug002,f.pmrug003);
    }
    else{
        f.pmrug002.value = f.admndate.value;
        f.pmrug003.value = f.admntime.value;
    }
  }

//---------------------------------------------------------------------------------------//
  // Check the rest of the mess
  function isValidPhaseSubmission(){

    previousRecordIndex = -1;
    nextRecordIndex = allAssessments.length;
    i = 0;

    var pmrug2 = SetDateYYYYMMDD(f.pmrug002.value);
    var pmrug3 = f.pmrug003.value;
    var assTimestamp = pmrug2 + pmrug3;
    var pmrug6 = SetDateYYYYMMDD(f.pmrug006.value);
    var pmrug7 = SetDateYYYYMMDD(f.pmrug007.value);
    var openEndedCount = 0;
    
    // Keep reading existing rows forward to see which is closest to user input
    for(i=0; i<allAssessments.length; i++){
        if((allAssessments[i].substr(8,8) < pmrug6)||
           (allAssessments[i].substr(0,8) < pmrug6)){
            previousRecordIndex=i;
        }
        if((allAssessments[i].substr(0,8)==pmrug6)||(allAssessments[i].substr(8,8)==pmrug6)){
           if(assTimestamp > allAssessments[i].substr(16,16)){
              previousRecordIndex=i;
           }
        }
    }
    // Keep reading existing rows backward to see which is closest to user input
    for(i=allAssessments.length-1; i>=0; i--){
        if(((allAssessments[i].substr(0,8) > pmrug7)&&(!isWhitespace(pmrug7)))||
           ((allAssessments[i].substr(8,8) > pmrug7)&&(!isWhitespace(pmrug7)))){
             nextRecordIndex=i;
        }
        if((allAssessments[i].substr(0,8)==pmrug7)||(allAssessments[i].substr(8,8)==pmrug7)){
            if(assTimestamp < allAssessments[i].substr(16,16)){
               nextRecordIndex=i;
            }
        }
        if((allAssessments[i].substr(8,8)=="99999999")&&(pmrug7<=allAssessments[i].substr(0,8))){
            if(!isWhitespace(pmrug7)){
               nextRecordIndex=i;
            }
        }
        if((isWhitespace(pmrug7))&&(pmrug6<allAssessments[i].substr(0,8))&&(allAssessments[i].substr(0,8)!="99999999")){
            nextRecordIndex=i;
        }
    }

    if(previousRecordIndex!=-1){
       if(pmrug6 < allAssessments[previousRecordIndex].substr(8,8)){
          if(allAssessments[previousRecordIndex].substr(8,8)!="99999999"){
             alert("The Phase Start/End Dates must be on or after the previous Start/End Dates.");
             return false;
          }
       }
    }
   if(nextRecordIndex!=allAssessments.length){
       if(pmrug7 > allAssessments[nextRecordIndex].substr(0,8)){
          alert("The Phase End Date must be on or before the previous Phase End Date.");
          return false;
       }
    }
    if(nextRecordIndex!=allAssessments.length || previousRecordIndex!=-1){
       if(nextRecordIndex-previousRecordIndex!=1){
          alert("Phase Start/End Dates overlap other Assessments. Please check these before proceeding");
          return false;
       }
    }
    if(nextRecordIndex==allAssessments.length && previousRecordIndex==-1){
       if(allAssessments.length>0){
          alert("Phase Start/End Dates overlap other Assessments. Please check these before proceeding");
          return false;
       }
    }

 // Now we know that the phase date range insert is ok so lets check everything else
    if(previousRecordIndex!=-1){
       previousPhaseType = allAssessments[previousRecordIndex].substr(32,3);
       previousASSO = allAssessments[previousRecordIndex].substr(35,1);
    }
    if(nextRecordIndex!=allAssessments.length){
       nextPhaseType = allAssessments[nextRecordIndex].substr(32,3);
       nextASSO = allAssessments[nextRecordIndex].substr(35,1);
    }

    // If Previous Phase has a value of No for "Admission For Assessment Only"
    // then all future Phases must also have a value of No & it cant be changed.
    if((previousASSO=="2")&&(f.pmrug005.value!="2")){
       alert("Previous Admission for Assessment Only must be 'No'");
       return false;
    }
    
    //Current Phase must not be the same as previous or next phases
    if((previousPhaseType==f.pmrug008.value.substr(0,3)) && 
       (!isWhitespace(previousPhaseType)) && (!isWhitespace(f.pmrug008.value))){
        alert("Phase Type cannot be the same as the previous Phase Type");
        return false;
    }
    if((nextPhaseType==f.pmrug008.value.substr(0,3)) && 
       (!isWhitespace(nextPhaseType)) && (!isWhitespace(f.pmrug008.value))){
        alert("Phase Type cannot be the same as the next Phase Type");
        return false;
    }

    if((pmrug7=="")&&(nextRecordIndex!=allAssessments.length)){
        alert("Only the most recent assessment can be open ended");
        return false;
    }
   
    // Generate Previous and Next Keys for Database Write 
    if(previousRecordIndex!=-1){
       f.prvkey40.value = f.admissno.value + allAssessments[previousRecordIndex].substr(16,16)
                        + allAssessments[previousRecordIndex].substr(0,16);
    }
    if(nextRecordIndex!=allAssessments.length){
       f.nxtkey40.value = f.admissno.value + allAssessments[nextRecordIndex].substr(16,16)
                        + allAssessments[nextRecordIndex].substr(0,16);
    }
    return true;
  }

</script>
