<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="crdhb">
<meta name="HelpFileName" content="NoContextSet.html">
<script type="text/javascript" src=../js/cliweb0101.js></script>
<!-- Merge from crdhb version 
<script type="text/javascript" src=../js/jquery-1.11.3.min.js></script>
<script type="text/javascript" src="../js/jquery-1.7.1.min.js"></script>
-->
<script type="text/javascript" src="../js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="../js/ctascustom.js"></script>
<script type="text/javascript">
  // constants for local alert check return values
  ALERT_INVALID = -1;
  ALERT_VALID = "0";
  ALERT_DUP_ALLOWED = "1";
  ALERT_NO_DUP = "2";
  ALERT_INACTIVE = "3";
  
  // check whether new local alert conflicts with existing alerts
  function checkLocalAlert() {
	var serverURL = "../cgi-bin/comweb80.pbl?reportno=51&remoteno=1" +
		"&valdcode="+AddForm.urnumber.value.replace(/ /g,"+")+
		"&valdcod2="+AddForm.alert001.value.substr(0,2).replace(/ /g,"+")+
		"&valdcod3="+AddForm.alert002.value.substr(0,3).replace(/ /g,"+")+
		"&valddate="+AddForm.alert003.value.replace(/ /g,"+");
	var returnValue = RSExecute(serverURL);
	
	// undefined error validating local alert
	if (returnValue.status != 0) {
		return ALERT_INVALID;
	}
	
	// return value matches an ALERT_* constant above
	retvalues = returnValue.return_value.split("|");
	return retvalues[0];
  }
  
  function submitAlert(){
    if(document.AddForm.admalert.value=="1"){
       document.AddForm.nextpage.value="6"
    }
	
	if (!validateMandatory(document.getElementById("AddForm"))) {
		return;
	}
	
	// standard submit if local alert only
	if (document.AddForm.nhimwscheck.checked == false) {
		if (checkAlertValid(AddForm))
			document.AddForm.submit();
			
	// otherwise submit both local and national alerts
	} else {
		if (validateMandatory(document.getElementById("AddNHIMWSForm"))) {
		
			// check if local alert already exists
			var localexists = checkLocalAlert();			
			var alertfield = document.AddForm.alert002;
			var alerttype = alertfield.options[alertfield.selectedIndex].text;
			
			switch (localexists) {
				// no issues
				case ALERT_VALID:
					// fix - 20160309 - start
					// document.AddForm.submit();
					submitAddForm();
					document.getElementById("AddNHIMWSForm").submit();
					// fix - 20160309 - end
					break;
				// duplicate local alert but duplicates allowed
				case ALERT_DUP_ALLOWED:
					if (confirm("Active local "+ alerttype +" alert exists.\n"+
						"Click OK to create new alert or Cancel to return.")) {
						// fix - 20160309 - start
						//document.AddForm.submit();
						submitAddForm();
						document.getElementById("AddNHIMWSForm").submit();
						// fix - 20160309 - end
					}
					break;
				// duplicate local alert - no duplicates allowed
				case ALERT_NO_DUP:
					if (confirm("Active local "+ alerttype +" alert exists.\n" +
						"Cannot create duplicate alerts of this type.\n" +
						"Click OK to create national alert or Cancel to return")) {
							document.getElementById("AddNHIMWSForm").submit();
						}
					break;
				// duplicate of inactive local alert - new alert allowed
				case ALERT_INACTIVE:
					if (confirm("Inactive local "+ alerttype +" alert exists.\n"+
						"Click OK to create new alert or Cancel to return.")) {
						// fix - 20160309 - start
						//document.AddForm.submit();
						submitAddForm();
						document.getElementById("AddNHIMWSForm").submit();
						// fix - 20160309 - end
					}				
					break;
				// something went wrong, dunno what
				default:
					alert("An error occurred.  Alert could not be created.");
					break;
			}
		}			
	}
  }

// set initiating hospital to user's current hospital
function setInitHospital() {
  LoginHosp=GetCookieData("IBAUserHosp")
  if(LoginHosp == "PNH") {
    HospitalNameStr="Palmerston North Hospital";
  } else if(LoginHosp == "WHN") {
    HospitalNameStr="Whanganui Hospital";
  } else if(LoginHosp == "HOR") {
    HospitalNameStr="Horowhenua Hospital";
  } else if(LoginHosp == "MHW") {
    HospitalNameStr="MH Hospital Whanganui";
  } else if(LoginHosp == "WRH") {
    HospitalNameStr="Wairarapa Hospital";	
  }
  
  document.AddForm.alert014.value = LoginHosp;
  document.AddForm.d_alert014.value = HospitalNameStr;
  
  document.AddForm.alert014.readOnly = true;
  document.AddForm.d_alert014.readOnly = true;
}

// retrieve alert category description from code
function getAlertCategory() {
	var catcode = document.AddForm.alert001.value;
	var serverURL = "../cgi-bin/patweb80.pbl?reportno=2&valdcode=" +
				  catcode.replace(/ /g,"+");
	var returnValue = RSExecute(serverURL);
	if (returnValue.status==0) {
		ReturnValue=returnValue.return_value.split("|");
		document.AddForm.catedesc.value=trim(ReturnValue[0]);
	}
}

// initialise custom field values
function setCustomInits() {
	setInitHospital();
	getAlertCategory();
}

// 01 : CTAS : show review date only if alert indicator 11 = Y
function showReviewDate() {
	
	if (document.AddForm.alert002.value.substr(13,1) == 'Y') {
		document.getElementById("nextreview").style.display = "";
	} else {
		document.getElementById("nextreview").style.display = "none";
	}
}
// end of change

// 01 : CTAS : show NHI/MWS details for submission
function showNHIMWS(){
  if (document.AddForm.nhimwscheck.checked == true)
	document.getElementById("NHIMWSdiv").style.display="";
  else
	document.getElementById("NHIMWSdiv").style.display="none";
}
// end of change

// 01 : CTAS : get HCP name to match code and update HCP name field
function getHCPName() {
	var hcpcode = document.AddForm.alert012.value;
	var hcpname = document.AddForm.genpname;
	if (!isWhitespace(hcpcode)) {
		var serverURL  = "../cgi-bin/patweb80.pbl?reportno=18" +
				   "&returnfm=2&valdtype=0" +
				   "&valdcode=" + hcpcode.replace(/ /g, "+");

		var returnValue = RSExecute(serverURL);
		if (returnValue.status==0) {
			ReturnValue=returnValue.return_value.split("|");
			hcpname.value=trim(ReturnValue[0]);	
		}
	} else {
		hcpname.value = "";
	}
}
// end of change

// 01 : CTAS : Auto-populate Warning Desc using Alert Desc
function setWarningDesc() {
document.AddNHIMWSForm.nhmws003.value=
document.AddForm.alert002.options[document.AddForm.alert002.selectedIndex].text;
}
// end of change
// 01 : CTAS : Reaction Comment is mandatory if Drug Reactions alert
function isDrugReactionAlert() {
	if(document.AddForm.alert001.value=='H1') {
		document.AddForm.alcommnt.className="Mandatory"
	} else {
		document.AddForm.alcommnt.className=""
	}
}
// end of change 
// 01 : CTAS : Submit AddForm separately
function submitAddForm() {
	var $form1 = $("#AddForm");
	$.post($form1.attr("action"), $form1.serialize(), function () {
		// alert('Form 1 submitted');
	});
}
// end of change

// 02 : DXC : add local alert only if indicator 10 = L
function localOnly() {

	if (document.AddForm.alert002.value.substr(12,1) == 'L') {
		document.getElementById("nhimwscheck").checked = false;
		document.getElementById("nhimwscheck").disabled = true;
		showNHIMWS();
// Merge from crdhb version	TAS 04 Local alert warning
	alert("The Alert will not be added to the\nNational Medical Warning System");
		
	} else {
	if (document.AddForm.alert002.value.substr(12,1) != 'L') {
		document.getElementById("nhimwscheck").checked = true;
		document.getElementById("nhimwscheck").disabled = false;
		showNHIMWS();
	}
	}	
}
// end of change

function checkComments() {
  if (document.getElementById('alert002').value.substr(11,1)==1) {
     document.getElementById('alcommnt').className="Readonly";
     document.getElementById('alcommnt').readOnly=true;
     document.getElementById('alcommnt').value="";
  } else {
     document.getElementById('alcommnt').className="";
     document.getElementById('alcommnt').readOnly=false;
  }
}
</script>

%START.OF.PAGE
</HEAD>
<body onload="PageLoad(event);
	      setCustomInits();isDrugReactionAlert();showNHIMWS();">

<span class=DFrameTitleBar>
  <img align="right" alt="Exit" class="MenuIcon" 
   src="../images/ExitIcon.gif" onclick="DFrameExit();">
  Add Alert
</span>

<div id="localalertdiv">

<form name=AddForm id=AddForm method=post action=cliweb01.pbl>
  <input type=hidden name=reportno value="1">
  <input type=hidden name=template value="002">
  <input type=hidden name=updttype value="A">
  <input type=hidden name=urnumber value="%CLIWEB01.01.003">
  <input type=hidden name=admissno value="%CLIWEB01.01.081">
  <input type=hidden name=alert001 value="%CLIWEB01.01.107">
  <input type=hidden name=nextpage value="5">
  <input type=hidden name=admalert value="%CLIWEB01.01.119">

  <table align=center cellspacing=0 cellpadding=1 width=95% border=0>
    <tr>
    <td class=DataLabel>Alert category</td>
    <td>
      <input type=text name=catedesc size=30 readonly>
    </td>
  </tr>  
<!-- 02 : DXC : added call to localOnly() -->  
  <tr>
    <td class=DataLabel>Alert</td>
    <td>
	   <select name=alert002 id=alert002 title="Alert Code" class=Mandatory
	   onchange="setWarningDesc(); localOnly();checkComments();">
        <option selected></option>
        %CLIWEB01.01.113  
      </select>
    </td>
  </tr>
<!-- end of change -->
<!-- CTAS removed pending decision about this clash with Responsible HCP
<tr><td class=DataLabel>Alert Requested By</td>
    <td colspan=4><input type=text name=alert012 id=alert012 size=10 maxlength=8
        title="Alert Requested By"
        onblur="ValidateHCP(18,12,alert012,d_alert012);">
       <input type=text size=35 name=d_alert012 id=d_alert012
        class=Readonly readonly>
    <img src=../images/SearchIcon.gif class=Icon
     onclick="HCPSearchFrame(alert012,d_alert012,7);">
    <img src="../images/ClearIcon.gif" class=Icon
     onclick="clrFields(alert012,d_alert012);">
    </td></tr>
-->
  <tr>
    <td class=DataLabel>Date Activated</td>
    <td>
      <input type=text name=alert003 size=12 maxlength=12 
       class="Mandatory PastDate"
       title="Date Activated">
      <img src=../images/DateTimeStamp.gif border=0 hspace=4
       align=absmiddle onclick="SetCurrentDateTime(AddForm.alert003,null);">
      <img src=../images/DateLookup.gif border=0 hspace=4
       align=absmiddle onclick="DateLookupFrame(AddForm.alert003);">
    </td>
  </tr>

  <tr id="nextreview" style="display:none">
    <td class=DataLabel>Next review date</td>
    <td>
      <input type=text name=alert008 size=12 maxlength=12
       title="Next review date" class="Date">
      <img src=../images/DateTimeStamp.gif border=0 hspace=4
       align=absmiddle onclick="SetCurrentDateTime(AddForm.alert008,null);">
      <img src=../images/DateLookup.gif border=0 hspace=4
       align=absmiddle onclick="DateLookupFrame(AddForm.alert008);">
    </td>
  </tr>	

  <tr>
    <td class=DataLabel>End Date</td>
    <td>
      <input type=text name=alert011 size=12 maxlength=12 title="End Date"
      class="PastDate">       
      <img src=../images/DateTimeStamp.gif border=0 hspace=4
       align=absmiddle onclick="SetCurrentDateTime(AddForm.alert011,null);">
      <img src=../images/DateLookup.gif border=0 hspace=4
       align=absmiddle onclick="DateLookupFrame(AddForm.alert011);">
    </td>
  </tr>

  <tr>
    <td class=DataLabel>%STANDARD.01.017.wn</td>
    <td>
      <select name=alert005>
        <option></option>
        %CLIWEB01.01.104.2
      </select>
    </td>
  </tr>

  <tr>
    <td class=DataLabel>Responsible HCP</td>
    <td>
      <input type=text name=alert012 size=10 
	  value="%CLIWEB01.01.123" maxlength=10 onblur="getHCPName();">
	  <input type=text size=25 notab readonly name=genpname value="">
        <img src="../images/SearchIcon.gif"
        onClick="HCPSearchFrame(alert012,genpname)">
        <img src="../images/erase.gif" align=absmiddle 
			onClick="clrFields(alert012,genpname);">
    </td>
  </tr>

  <tr valign=top>
    <td class=DataLabel>Initiating hospital</td>
    <td>
		<input type=text name=alert014 size=3 maxlength=3>
		<input type=text name=d_alert014 size=20 maxlength=20>
    </td>
  </tr>
  
    <tr valign=top>
    <td class=DataLabel>DHB responsible for reviewing alert</td>
    <td>
      <select name=alert007>	
		<option value=""></option>
		<option value="CCDHB">Capital &amp; Coast DHB</option>
		<option value="HBDHB">Hawke's Bay DHB</option>
		<option value="HVDHB">Hutt Valley DHB</option>		
		<option value="MCDHB">MidCentral DHB</option>
		<option value="YDHB">Wairarapa DHB</option>
		<option value="WDHB">Whanganui DHB</option>
      </select>
    </td>
  </tr>
<!-- 02 : DXC : Removed onclick="return false;" 
				Added call to showNHIMWS()-->  
	<tr id="id_ministry_tr"><td class=DataLabel>Make alert national</td>
        	<td><input type=checkbox name=nhimwscheck id=nhimwscheck 
 		checked onclick="showNHIMWS();"></td>
	</tr>
<!-- end of change -->
<!-- 04 : TAS : Add title to field for warning message -->
<!-- 05 : TAS : Limit Characters to 70 for comments field
  <tr>
         <td colspan=2 class=DataLabel>Reaction/comment/drug name</td>
  </tr>

  <tr>
    <td colspan=2 align=center>
												  
    <textarea wrap=hard name=alcommnt title="Reaction/comment/drug name" rows=4 cols=70>CLIWEB01.01.111</textarea>
							
    </td>
  </tr> -->
<tr>
        <td colspan=2><label for=alcommnt>Reaction/comment/drug name
      <br/><br/>&nbsp;&nbsp;
	  <span id="charsUsed"></span></label></td>
</tr>
  <tr>
    <td></td>
    <td>
    <textarea type="text" name=alcommnt id=alcommnt wrap=hard
                cols=70 rows=4 maxlength=70 tabindex=22
                title="Reaction/comment/drug name" class="Mandatory"
                onkeyup="NumCharsUsed(this, 70, document.getElementById('charsUsed'));">
        %CLIWEB01.01.111
        </textarea>
    </td>
        <td></td><td></td>
</tr>
<!-- End of Change -->
</table>
</form>
</div>

<div id=NHIMWSdiv style="display:none">
<span id="NHIMWSSpan">
  <table align=center cellspacing=2 cellpadding=1 width=100% border=0>
      <tr><td class=DFrameTitleBar align=center colspan=6 width=100%>
          Add to NHI/MWS Medical Warnings </td></tr>
  <form name=AddNHIMWSForm id=AddNHIMWSForm method=post action="nhiweb99.pbl">
    <input type=hidden name=reportno value="4">
    <input type=hidden name=template value="002">
    <input type=hidden name=updttype value="A">
    <input type=hidden name=nextpage value="1">
    <input type=hidden name=urnumber value="%CLIWEB01.01.003">
    <input type=hidden name=admissno value="%CLIWEB01.01.081">
  <table align=center cellspacing=2 cellpadding=1 width=100% border=0>
  <tr><td class=DataLabel>Severity</td>
      <td><select name=nhmws001 class="">
            <option value="W  ">Warning</option>
            </select>
      </td>

	  <tr><td class=DataLabel>Date of onset</td>
    <td><input type=text name=nhmws002 size=12 maxlength=12 class=Mandatory
		title="Date of onset"
        id=nhmws002 onblur="checkDate(this,'Alert Date');">
      <img src=../images/DateTimeStamp.gif border=0 hspace=4
       align=absmiddle onclick="SetCurrentDateTime(document.getElementById('nhmws002'),null);">
      <img src=../images/DateLookup.gif border=0 hspace=4
       align=absmiddle onclick="DateLookupFrame(document.getElementById('nhmws002'));">
    </td></tr>
<!-- 04 : TAS : Add title to field for warning message -->
<tr><td class=DataLabel>Warning description</td>
      <td><input type=text title="Warning description" size=70 maxlength=70 name=nhmws003 
           class=Mandatory>
</td></tr>

<tr><td class=DataLabel>Doctor code</td>
    <td><input type=text size=5 maxlength=5 name=nhmws004 >
    </td></tr>
</table>
  
  <table align=center cellspacing=2 cellpadding=1 width=100% border=0>
  <tr><td class=HeadingCell colspan=6 align=center>
                Adverse Reaction</td></tr>
  <tr><td class=DataLabel>Coding system</td>
      <td><select name=nhmws005>
          <option value="00">No Coding System</option>
          <option value="01">ICD-9</option>
          <option value="02">ICD-9-CM</option>
          <option value="03">RCC5 (Read)</option>
          <option value="04">ICPC</option>
          <option value="05">PAXUS AMR codes</option>
          <option value="06">ICD9-CM-A</option>
          <option value="10">ICD10 version 1</option>
          <option value="11">ICD10 version 2</option>
         </select></td>

      <td class=DataLabel>Code</td>
      <td><input type=text name=nhmws006 size=6 maxlength=20></td>
  </tr>
  </table>
  
  </form>
  </table>
</span>
</div>

<div id=buttonrow>
  <table align=center cellspacing=0 cellpadding=1 width=95% border=0>
  <tr>
    <td colspan=2 align=center>
      <br>
      <input type=button name=formactn value=Add class="button"
       onclick="submitAlert();">
      <input type=button value=Close class="button" onclick="DFrameClose()">
    </td>
  </tr>
</table>
</div>
</body>
