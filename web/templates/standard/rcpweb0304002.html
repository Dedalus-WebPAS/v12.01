<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="standard">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="../js/rcpweb03.js"></script>
<script type="text/javascript">

var eftLoopCount = 0;

function init() {
  if(isWhitespace(parent.AddForm.rcpbt023.value)) {
    alert("Error loading payment type. Please reselect the payment type.");
    ResetPayment();
    DFrameExit();    
  }
  AddForm.rcpbt023.value=parent.AddForm.rcpbt023.value;
  showPayments(AddForm);
  checkCard(AddForm);
}
function checkEFTType(ReturnCode,ReturnAmnt,Percent,TotPayment,Surchrg) {

  if (AddForm.rcpbt016[0].checked==1) {
    document.AddForm.rcpbt013.value="";
  }
          
  if ((AddForm.rcpbt016[1].checked==1) &&
      (!isWhitespace(ReturnCode.value)))
   {      
    var serverURL   = "../cgi-bin/rcpweb03.pbl?reportno=1" +
                   "&valdcode=" + ReturnCode.value.replace(/ /g,"+") +
                   "&tpayamnt=" + ReturnAmnt.value.replace(/ /g,"+")
                
    var returnValue = RSExecute(serverURL);

    if (returnValue.status==0) {
      ReturnValue=returnValue.return_value.split("|");
 
     if (ReturnValue[0]!=0) {
       if (AddForm.drwercrd.value==0) {

         if (SurchargeOption.innerHTML=="") {
           SurchargeOption.innerHTML=CreditSurcharge.innerHTML;
         }

         document.AddForm.rcpercent.value=ReturnValue[0];
         document.AddForm.crtotpay.value=ReturnValue[2];
         document.AddForm.crsurchr.value=ReturnValue[1];

         return;
       }
     }
   }
  }
  SurchargeOption.innerHTML="";
}

function valCrCard(ReturnCode,ReturnAmnt,Percent,TotPayment,Surchrg) {

 if (document.AddForm.rcpbt023.value.substr(3,1)==7) {
   var serverURL   = "../cgi-bin/rcpweb03.pbl?reportno=1"
                    + "&valdtype=1"
                    + "&valdcode=" + document.AddForm.rcpbt023.value.substr(0,3).replace(/ /g,"+")
                    + "&tpayamnt=" + ReturnAmnt.value.replace(/ /g,"+");
 } else {

  if (isWhitespace(ReturnCode.value)) {
    return;;
  }
  var serverURL   = "../cgi-bin/rcpweb03.pbl?reportno=1" +
                 "&valdcode=" + ReturnCode.value.replace(/ /g,"+") +
                 "&tpayamnt=" + ReturnAmnt.value.replace(/ /g,"+")
 }

  var returnValue = RSExecute(serverURL);
  if (returnValue.status==0) {
    ReturnValue=returnValue.return_value.split("|");
    document.AddForm.rcpercent.value=ReturnValue[0];
    document.AddForm.crtotpay.value=ReturnValue[2];
    document.AddForm.crsurchr.value=ReturnValue[1];
  }
}

function checkPayLength() {
  if (document.AddForm.rcpbt007.value.length>12) {
     alert("Payment Amount field length must be less than 12 characters long");
     document.AddForm.rcpbt007.select();
  }
}
function SubmitRec(thisForm) {
  if (validateMandatory(thisForm)) {
    thisForm.rcpbk001.value=parent.AddForm.rcpbk001.value;
    thisForm.rcpbk002.value=parent.AddForm.rcpbk002.value;
//    thisForm.rcpbk003.value=parent.AddForm.rcpbk003.value;
    thisForm.rcpbk004.value=parent.AddForm.rcpbk004.value;
    thisForm.rcpbk007.value=parent.AddForm.rcpbk007.value;
    thisForm.rcpbk008.value=parent.AddForm.rcpbk008.value;
    thisForm.rcpbk014.value=parent.AddForm.rcpbk014.value;
    thisForm.rcpde004.value=parent.AddForm.rcpde004.value;
    thisForm.rcpde005.value=parent.AddForm.rcpde005.value;
    thisForm.rcpde006.value=parent.AddForm.rcpde006.value;
    thisForm.rcpde007.value=parent.AddForm.rcpde007.value;
    thisForm.rcpde015.value=parent.AddForm.rcpde015.value;
    thisForm.rcpde018.value=parent.AddForm.rcpde018.value;
    thisForm.rcpde019.value=parent.AddForm.rcpde019.value;
    thisForm.visittyp.value=parent.AddForm.visittyp.value;
    thisForm.invoicen.value=parent.AddForm.invoicen.value;
    thisForm.admissno.value=parent.AddForm.admissno.value;
    thisForm.urnumber.value=parent.AddForm.urnumber.value;
    thisForm.printflg.value=parent.AddForm.printflg.value;
    thisForm.selprint.value=parent.AddForm.selprint.value;
    thisForm.nocopies.value=parent.AddForm.nocopies.value;

    RoundNumber(AddForm.rcpbt007,2);
    checkPayLength();

    if (typeof thisForm.eftposterminal != 'undefined' 
         && thisForm.eftposterminal.selectedIndex  > 0 ) {
       PaymentRequest();
    } else {
      thisForm.submit();
    }
  }
}
function ResetPayment() {
  parent.AddForm.rcpbt023.selectedIndex=0;
}
//------------------------------------------------------------
//  Function : Display appropriate fields for payment type
//------------------------------------------------------------
function showPayments(thisForm) { 
  if (thisForm.rcpbt023.value.substr(3,1)==1) {
    PaymentOption.innerHTML=CashPayment.innerHTML;
    document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (thisForm.rcpbt023.value.substr(3,1)==2) {
    PaymentOption.innerHTML=ChequePayment.innerHTML;
    document.AddForm.rcpbt010.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (thisForm.rcpbt023.value.substr(3,1)==3) {
    PaymentOption.innerHTML=CreditPayment.innerHTML;
    document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (thisForm.rcpbt023.value.substr(3,1)==4) {
    PaymentOption.innerHTML=DirDepositPayment.innerHTML;
    document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (thisForm.rcpbt023.value.substr(3,1)==5) {
    PaymentOption.innerHTML=MoneyOrderPayment.innerHTML;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (thisForm.rcpbt023.value.substr(3,1)==6) {
    PaymentOption.innerHTML=EFTPOSPayment.innerHTML;
    document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    return;
  }
  if (document.AddForm.rcpbt023.value.substr(3,1)==7) {
   PaymentOption.innerHTML="";
   PayerOption.innerHTML=CARDPayer.innerHTML;
    if (document.AddForm.rcpbt023.value.substr(3,1)==7) {
     if (document.AddForm.surchamt!=undefined) {
      if(document.AddForm.surchamt.value=="1"){
        document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
        document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
        SurchargeOption.innerHTML=CreditSurcharge.innerHTML;
        return;
      }
     }
    }
    document.AddForm.rcpbt008.value=document.AddForm.patntnam.value;
    document.AddForm.rcpbt007.value=document.AddForm.paymntam.value;
    SurchargeOption.innerHTML="";
    return;
  }
  else {
    PaymentOption.innerHTML="";
  }
}

function PaymentRequest(){

  var amnt;
  var mask;
  var af   = document.AddForm;
  var addr = "?addr=" + trim(af.eftposterminal.value.substring(3,43).replace(/ /g,''));
  var port = "&port=" + trim(af.eftposterminal.value.substring(43).replace(/ /g,''));
  var rand = "&httprand=" + Math.random();

  if(af.rcpbt016[1].checked == 1){  // if credit card
    amnt = "&amnt=" + trim(af.crtotpay.value.replace('.',''));
    mask = "001";   // chq=0,sav=0,cr=1
  }
  else {
    amnt = "&amnt=" + trim(af.rcpbt007.value.replace('.',''));
    mask = "110";   // chq=1,sav=1,cr=0
  }

  mask = "&mask=" + mask;
  url =  "../php/rcpweb0302002.php" + addr + port + amnt + mask + rand;
  document.getElementById('response').style.display = "block";

  xmlHttp = createHttpObject();
  xmlHttp.open("GET",url,false);
  xmlHttp.send(null);

  var fn = trim(xmlHttp.responseText);
  url = "../php/rcpweb0302002.php?f=" + fn;
  eftTimer = setInterval("showEftStatus(url)",800);

}
   
function showEftStatus(url)
{
    // getout in case we fail to get en ending Tx message
    if (eftLoopCount > 700) clearInterval(eftTimer);
    eftLoopCount += 1;

  url += '&httprand=' + Math.random();
  var resp = document.getElementById('response');
  xmlHttp.open("GET",url,false);
  xmlHttp.send(null);

  resp.innerHTML = xmlHttp.responseText;


  if (xmlHttp.responseText.substr(0,3) == "Tx ")
  {
    clearInterval(eftTimer); // stop re-reading the file
    if (xmlHttp.responseText.substr(3,8) == "APPROVED")
    {
      var authCode  = xmlHttp.responseText.substr(29,6);
      document.AddForm.rcpbt014.value = authCode;
      document.AddForm.sumbit();
    }
  }
}
  
</script>
<style type="text/css">
.eftresponse {
   height: 60px;
   max-height: 60px;
   width:  100%;
   color: red;
   background-color: white;
   border: 1px solid #666666;
   overflow-y: scroll;
   overflow-x: hidden;
   display: none;
}
</style>
 
</head>
%START.OF.PAGE
<body onload="PageLoad(event);">
 <form name=AddForm method=post action=rcpweb03.pbl>
 <input type=hidden name=reportno value="4">
 <input type=hidden name=template value="002">
 <input type=hidden name=updttype value="A">
 <input type=hidden name=nextpage value=4>
 <input type=hidden name=redirect value="rcpweb03.pbl?reportno=4&template=1">
 <input type=hidden name=accmtotl value="%RCPWEB03.04.306">
 <input type=hidden name=rcpbk001>   <!-- receipt number -->
 <input type=hidden name=rcpbk002>   <!-- payment date -->
 <input type=hidden name=rcpbk003>   <!-- total payment amount -->
 <input type=hidden name=rcpbk004 value="%RCPWEB03.04.301.0">   <!--Cashier-->
 <input type=hidden name=rcpbk007>   <!-- received from type -->
 <input type=hidden name=rcpbk008>   <!-- received from code -->
 <input type=hidden name=rcpbk014>   <!-- cheque account number -->
 <input type=hidden name=rcpbt023>   <!-- payment type -->
 <input type=hidden name=rcpde004>   <!-- register -->
 <input type=hidden name=rcpde005>   <!-- invoice number -->
 <input type=hidden name=rcpde006>   <!-- visit number -->
 <input type=hidden name=rcpde007>   <!-- UR number -->
 <input type=hidden name=rcpde014 value=1>   <!-- scanflag default=PMI -->
 <input type=hidden name=rcpde015>   <!-- reference -->
 <input type=hidden name=rcpde018>   <!-- amount -->
 <input type=hidden name=rcpde019>   <!-- discount -->
 <input type=hidden name=drwercrd value="%RCPWEB03.04.381">
 <input type=hidden name=surchamt value="%RCPWEB03.04.388">
 <input type=hidden name=visittyp>
 <input type=hidden name=invoicen>
 <input type=hidden name=admissno>
 <input type=hidden name=urnumber>
 <input type=hidden name=printflg>
 <input type=hidden name=selprint>
 <input type=hidden name=nocopies>
 <input type=hidden name=patntnam value="%RCPWEB03.04.366">
 <input type=hidden name=paymntam value="%RCPWEB03.04.334">
 <input type=hidden name=ptcnnhii value="%RCPWEB03.04.375">
<span class=DFrameTitleBar>
<img align="right" alt="Exit" class="MenuIcon" 
 src="../images/ExitIcon.gif" onclick="ResetPayment();DFrameExit();">
<script type="text/javascript">

  paydesc = "%RCPWEB03.04.387.0";
  if(!isWhitespace(paydesc)){
    document.write('Payment Type: %RCPWEB03.04.387.0');
  } else {
    document.write(self.document.title);
  }

</script>
</span>
<table align=center width=100% border=0 cellspacing=2 cellpadding=1>
<tr><td>
<table align=center width=95% border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Payment Amount</td>
    <td><input type=text name=rcpbt007 title="Payment Amount" size=15
               maxlength=15 class="Mandatory Number" max=999999999999.99
               id=rcpbt007 onblur="RoundNumber(this,2);checkPayLength();
               valCrCard(rcpbt013,rcpbt007,rcpercent,crtotpay,crsurchr);">
    </td></tr>
</table>

<span id=PaymentOption></span>
<span id=SurchargeOption></span>
<span id=PayerOption></span>

<table align=center width=95% border=0 cellspacing=2 cellpadding=1>
<tr><td colspan=2 align=center><br>
    <input type=button value="Add" class="button" onclick="tempDisable(this);SubmitRec(AddForm)">
    <input type=button value=Close class="button" 
           onclick="ResetPayment();DFrameClose();">
</td></tr>
</table>
</td></tr>
</table>
</form>

<span id=CashPayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Payer</td>
    <td><input type=text name=rcpbt008 class=Mandatory title="Payer"
         size=50 maxlength=50>
</td></tr>
</table>
</span>

<span id=ChequePayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Cheque Number</td>
    <td><input type=text name=rcpbt009 class=Mandatory title="Cheque Number"
         size=8 maxlength=8>
</td></tr>
<tr><td class=DataLabel>Drawer</td>
    <td><input type=text name=rcpbt010 class=Mandatory title="Drawer"
         size=50 maxlength=50>
</td></tr>
<tr><td class=DataLabel>Bank</td>
    <td><input type=text name=rcpbt011 class=Mandatory title="Bank"
         size=35 maxlength=30>
</td></tr>
<tr><td class=DataLabel>Branch</td>
    <td><input type=text name=rcpbt012 class=Mandatory title="Branch"
         size=35 maxlength=30>
</td></tr>
</table>
</span>

<span id=CreditPayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Card Type</td>
    <td><select name=rcpbt013 class=Mandatory title="Card Type">
        <option value=""></option>
        %RCPWEB03.04.307.9.1.02.0
        </select>
</td></tr>
<tr><td class=DataLabel>Payer</td>
    <td><input type=text name=rcpbt008 class=Mandatory title="Payer"
         size=50 maxlength=50>
</td></tr>
</table>
</span>

<span id=DirDepositPayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Payer</td>
    <td><input type=text name=rcpbt008 class=Mandatory title="Payer"
         size=50 maxlength=50>
</td></tr>
<tr><td class=DataLabel width=30%>Statement Reference</td>
    <td><input type=text name=rcpbt014 class=Mandatory 
               title="Statement Reference" size=40 maxlength=40>
</td></tr>
</table>
</span>

<span id=MoneyOrderPayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=30%>Money Order Number</td>
   <td><input type=text name=rcpbt009 class=Mandatory 
         title="Money Order Number" size=15 maxlength=12>
</td></tr>
</table>
</span>

<span id=EFTPOSPayment style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
  <tr>
    <td class=DataLabel width=30%>EFT Type</td>
    <td>Chq/Savings
      <input type=radio name=rcpbt016 value="1" notab tabindex=-1 checked
            id=rcpbt016 onclick="checkCard(AddForm);
                     checkEFTType(rcpbt013,rcpbt007,rcpercent,crtotpay,crsurchr);">
       &nbsp;&nbsp;&nbsp;Credit
      <input type=radio name=rcpbt016 value="2" notab tabindex=-1
       onclick="checkCard(AddForm);
                checkEFTType(rcpbt013,rcpbt007,rcpercent,crtotpay,crsurchr);"></td>
  </tr>   
  <tr>
    <td class=DataLabel>Card Type</td>
    <td><select id=rcpbt013 name=rcpbt013 class=Mandatory title="Card Type"
        onchange="checkEFTType(rcpbt013,rcpbt007,rcpercent,crtotpay,crsurchr);">
        <option value=""></option>
        %RCPWEB03.04.307.9.1.02.1.E
        </select></td>
  </tr>
  <tr id="eftposRow" style="display:none">
    <td class=DataLabel>EFTPOS Terminal</td>
    <td>
      <select id="et" style="width:165px" name="eftposterminal" class="Mandatory"
       title="EFTPOS Terminal">
        <option value="~" selected>Manual Entry</option>
        %RCPWEB03.04.385
      </select>
    </td>
  </tr>

  <tr>
    <td class=DataLabel>Payer</td>
    <td><input type=text name=rcpbt008 class=Mandatory title="Payer"
         size=50 maxlength=50 /></td>
  </tr>
  <tr>
     <td class=DataLabel>Reference</td>
     <td><input type=text name=rcpbt014 class=Mandatory 
               title="Reference" size=40 maxlength=40 /></td>
  </tr>
  <tr>
    <td colspan="2">
      <div id="response" class="eftresponse"></div>
    </td>
  </tr>
</table>
</span>

<span id=CreditSurcharge style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
<tr><td class=DataLabel width=50%>% Surcharge</td>
    <td><input type=text id=rcpercent name=rcpercent size=15
        class="Readonly JustifyRight" readonly
        title='Percentage Surcharge' tabindex=-1></td></tr>
<tr><td>Plus Surcharge</td>
    <td><input type=text name=crsurchr size=15 class=readonly readonly
         id=crsurchr title='Surcharge' tabindex=-1></td></tr>
<tr><td>Total Payment amount will be </td>
    <td><input type=text name=crtotpay size=15 class=readonly readonly
         id=crtotpay title='Total Payment Amount' tabindex=-1></td></tr>
</table>
</span>

<span id=EFTPOSPayer style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
  <tr>
    <td class=DataLabel>Payer</td>
    <td><input type=text name=rcpbt008 class=Mandatory title="Payer"
         size=50 maxlength=50 value="%RCPWEB03.04.265" /> </td>
  </tr>
  <tr>
    <td class=DataLabel>Reference</td>
    <td><input type=text name=rcpbt014
               title="Reference" size=40 maxlength=40 /> </td>
  </tr>
</table>
</span>

<span id=CARDPayer style="display:none">
<table width=95% align=center border=0 cellspacing=2 cellpadding=1>
  <tr>
    <td class=DataLabel width=30%>Payer</td>
    <td>
      <input type=text name=rcpbt008 class=Mandatory title="Payer"
       size=50 maxlength=50 value="%RCPWEB03.04.265">
    </td>
  </tr>
  <tr>
    <td class=DataLabel width=30%>Reference</td>
    <td>
      <input type=text name=rcpbt014 title="Reference" size=50 maxlength=40>
    </td>
  </tr>
</table>
</span>

<script type="text/javascript">
// Dont show TerminalID selection list if no active terminals exist
  if((document.getElementById("et").options.length)>1){
    document.getElementById("eftposRow").style.display = "table-row";
  }
</script>

