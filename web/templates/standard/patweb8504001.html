<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="standard">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="../js/patweb85.js"></script>
<script type="text/javascript" src="../js/MrtLocations.js"></script>
<script type="text/javascript" src="../js/MrtMultiLocations.js"></script>
<script type="text/javascript" src="../js/MrtHomeLocns.js"></script>
<script type="text/javascript" src="../js/MrtMultiHomeLocns.js"></script>
<script type="text/javascript">
function SetReq() {
  if (document.AddForm.requtype.value=="1") {
    RequestType.innerHTML=ReqFree.innerHTML;
  } else {
    RequestType.innerHTML=ReqSelect.innerHTML;
  }
  SetHospital(AddForm);
  SetDestination(AddForm);
  SetHomeHosp(AddForm);
  SetHomeLocn(AddForm);
}
function VisitNoChange() {
  f = document.AddForm;
  if (isWhitespace(f.visitnum.value)) {return;}
  if (!validateMandatory(f)) {
    f.visitnum.value = "";
    return;
  }

  var serverURL = "../cgi-bin/comweb81.pbl?reportno=42" +
                  "&valdcode=" + f.visitnum.value.replace(/ /g,"+");
  var returnValue = RSExecute(serverURL);
  if (returnValue.status!=0) {
    f.visitnum.value = "";
    return;
  }

  ReturnValue=returnValue.return_value.split("|");
  f.URNumber.value = ReturnValue[0]
  
  FormatURScan(f.URNumber);
  validateRecordID();
  setTimeout('document.AddForm.URNumber.focus()',100);
  f.visitnum.value = "";
}
function validateRecordID() {
  if (validateMandatory(AddForm)) {
    p=document.AddForm
    if (p.URNumber.value!="") {
      LenUR=p.URNumber.value.length
      if (LenUR < 9) {
        Count= 8 - LenUR ;
        Blanks="";
        for (i=0; i < Count;i++) { Blanks+=" ";}
        p.URNumber.value=Blanks + p.URNumber.value
      }
      validateCode(13,p.URNumber,p.d1)
    }
    if (p.d1.value!="") {
      OutputTable(AddForm.URNumber);
    }
  }
}
function OutputTable(ReturnCode) {
  if (ItemCnt>=99) {
    alert("Page Limit Reached");
    return;
  }
  if (isWhitespace(ReturnCode.value)) return;;

  var MrKeyRecord="";
  var PatientName="";
  var CurrentHosp="";
  var CurrentHosp="";
  var CurrentLoct="";
  var LastMovDate="";
  var Description="";
  var Flag=0;
//
//  Check for a Merged U/R
//
  p=document.AddForm

  var visitnop = "";
  if (VariableNameExists('MRTVisitNoonBulkRecRequest')) {
    if (MRTVisitNoonBulkRecRequest == true) {
      if (p.visitnum !=undefined) {
        visitnop = "&visitnum=" + p.visitnum.value.replace(/ /g,"+")
      }
    }
  }

  if (p.URNumber.value!="") {
    var patname=new Object();
    var Merged=new Object();
    var Mergedur=new Object();
    var mrrecord=new Object();

    validateCodeMerge(28,p.URNumber,patname,Merged,Mergedur,mrrecord)

    if (patname.value!="") {
      if (Merged.value=="1") {
        if (mrrecord.value!="1") {
          alert("Warning : This U/R Number is merged with " + Mergedur.value);
          if (p.wahealth == undefined ) {
            p.URNumber.value=Mergedur.value;
            OutputTable(p.URNumber) // Load U/R that this U/R is merged with!
          } else { p.URNumber.value = "" }
          return;
        } else {
          alert("Warning : This U/R Number is merged with " + Mergedur.value +
               "\nU/R - " + p.URNumber.value + " still has a medical record, " +
                "please merge all medical records for this UR!");
          p.URNumber.value="";
          return;
        }
      }
    }
  } else {
    var patname=new Object();
    var Merged=new Object();
    var Mergedur=new Object();
    var mrrecord=new Object();
    var mrtscanur=new Object();
    mrtscanur.value=ReturnCode.value.substring(0,8);
    validateCodeMerge(28,mrtscanur,patname,Merged,Mergedur,mrrecord);
    if (patname.value!="") {
      if (Merged.value=="1") {
        alert("Warning : This U/R Number is merged with " + Mergedur.value);
        ReturnCode.value="";
        return
      }
    }
  }
//
//  Validate Medical record
//
  var serverURL   = "../cgi-bin/mrtweb01.pbl?reportno=14" +
                    "&mrkeyarr=" + ReturnCode.value.replace(/ /g,"+") +
                    "&docmtype=" + AddForm.medrr001.value.replace(/ /g,"+") +
                    "&volumeno=" + AddForm.mrtme011.value.replace(/ /g,"+") +
                    "&homehosp=" + AddForm.medrr012.value.replace(/ /g,"+") +
                    "&location=" + AddForm.homelocn.value.replace(/ /g,"+") +
                    visitnop
  if(document.AddForm.fullflag=="1"){
    var serverURL = "../cgi-bin/mrtweb01.pbl?reportno=14" +
                  "&mrkeyarr=" + ReturnCode.value.replace(/ /g,"+") +
                  "&volumeno=" + AddForm.mrtme011.value.replace(/ /g,"+") +
                  visitnop
  }

  var returnValue = RSExecute(serverURL);
  ReturnValue=returnValue.return_value.split("|");

  if (returnValue.status==0) {
//
//  Check for an already entered U/R
//
    for (var i=0; i < document.AddForm.length; i++) {
      if (document.AddForm.elements[i].name.match(/mrkeyarr/)) {
        enterur=ReturnValue[0].substring(0,8);
        checkey=document.AddForm.elements[i].value.substring(0,8);
        if (enterur == checkey) {
          alert("Warning: U/R already entered!");
          document.AddForm.URNumber.value="";
          document.AddForm.URNumber.focus();
          break;
        }
      }
    }
//
    if(document.AddForm.wahealth!=undefined &&
       document.AddForm.superlev.value!="1") {
       vol_error=false;
       if(AddForm.medrr012.value.substr(0,3) !=
          ReturnValue[0].replace(/\+/g," ").substr(8,3)) {
          vol_error=true;
       }
       if(AddForm.medrr013.value.substr(0,4) !=
          ReturnValue[0].replace(/\+/g," ").substr(11,4)) {
          vol_error=true;
       }
       if(AddForm.medrr001.value.substr(0,3) !=
          ReturnValue[0].replace(/\+/g," ").substr(15,3)) {
          vol_error=true;
       }
       if(vol_error) {
         alert("Volume Not Found, UR - " +
                ReturnValue[0].replace(/\+/g," ").substring(0,8));
         return
       }
    }
//
    AddOutputArray(ReturnValue[0],ReturnValue[1],ReturnValue[2],
                   ReturnValue[3],ReturnValue[4],ReturnValue[5],
                   ReturnValue[6],ReturnValue[7],ReturnValue[30],
                   null,ReturnValue[32]);

    vols = ReturnValue[31].split(",");

    for (var i=0; i < vols.length; i++) {
      if (trim(vols[i]).length > 0) {
        AddOutputArray(ReturnValue[0],ReturnValue[1],ReturnValue[2],
                       ReturnValue[3],ReturnValue[4],ReturnValue[5],
                       ReturnValue[6],ReturnValue[7],ReturnValue[30],
                       trim(vols[i]),ReturnValue[32]);
      }
    }
    OutputDivision();
    ReturnCode.value="";
    ReturnCode.focus();
    if (!isWhitespace(document.AddForm.mrtme011.value)) {
      document.AddForm.mrtme011.value="";
    }
  } else {
    ReturnCode.focus();
    ReturnCode.value="";
    if (!isWhitespace(document.AddForm.mrtme011.value)) {
      document.AddForm.mrtme011.value="";
    }
    ReturnCode.select();
  }
}

function AddOutputArray(MKey,Name,Locn,Date,Desc,Vols,Indi,Epos,LinkVolm,vols,
                        StatusCol) {
  var dropList="";
  //Vols=Vols.substr(1,100);
  VolList=Vols.split(",");

  // Get Highest Volume Number
  var savol=0;

  if(vols == undefined) {
    for (i=VolList.length-2;i>=0;i--) {
      if (parseInt(VolList[i]) > savol) {
        savol=VolList[i];    // Set Highest Volume No.
      }
    }

    if(document.AddForm.fullflag!=undefined){
      j=MKey.replace(/\+/g," ").substr(18,2);
      savol=j;
    }

    // LinkVolm <> Spaces, when Visit number is entered, default volume to
    // the link visit volume
    if (!isWhitespace(LinkVolm)) {
      savol=LinkVolm;
    }
  } else {
    savol = vols; 
  }

  for (i=VolList.length-2;i>=0;i--) {
    a=savol
    b=VolList[i] ;
    justifyRight(a);
    justifyRight(b);
    if (trim(a) == trim(b)) {
      test="<option value='" + VolList[i] +
           "' selected>" + VolList[i] + "</option>"
    }
    else {
      test="<option value='" + VolList[i] + "'>" + VolList[i] + "</option>"
    }
    dropList=dropList + test
  }
  urnum=MKey.replace(/\+/g," ").substr(0,8);
  StatusCol=trim(StatusCol);
  if(StatusCol.length!==0){
    var descColVal="<td style='color:"+StatusCol+"' >" +
                    Desc + "&nbsp;</td>";
  }
  else{
    var descColVal="<td>" + Desc + "&nbsp;</td>";
  }
  OutputArray[OutputArray.length] = "<tr>" +
  "<td><img src=../images/DeleteIcon.gif class=Icon " +
  " onclick=RemoveRecord('" +  OutputArray.length + "');>" +
  MKey.replace(/\+/g," ").substr(0,8) + "</td>" +
  "<td align=center><select name=volumenu onChange=\"SetVolNum(this.value,'" +
  OutputArray.length + "','" + urnum + "');\">" +
  "<option value='99'>All</option>" +
      dropList + "</select></td>" +
      "<td>" + Epos + "</td>" +
      "<td>" + Name + "</td>" +
      "<td>" + Locn + "</td>" +
      "<td>" + Date + "</td>" +
      descColVal +                        
      "<input type=hidden name=mrkeyarr value='" +
      MKey + "'></tr>"
  ItemCnt++;
}

</script>
</head>
%START.OF.PAGE
<body onload="PageLoad(event);InitPageLayout();setTimeout('SetReq()',100);">

<div id=HeadingDivision>
  <table border=0 align=center width=100% cellpadding=0 cellspacing=0
   style="table-layout:fixed"> 
  <tr><td class=HeadingCell align=center>
  Record Bulk Request
  </td></tr>
  </table>
</div>

<div id=BodyDivision>
<form name=AddForm method=post action=patweb85.pbl style="margin:0">
<input type=hidden name=reportno value="4">
<input type=hidden name=template value="001">
<input type=hidden name=updatety value="A">
<input type=hidden name=redirect value="patweb85.pbl?reportno=4&template=1">
<input type=hidden name=nextpage value="5">
<input type=hidden name=urnumber value="%MRTWEB01.09.011">
<input type=hidden name=requtype value="%PATWEB85.04.019">
<input type=hidden name=tmotfrst value="10">
<input type=hidden name=tmotnext value="10">
<input type=hidden name=mrcnibap value="%STANDARD.01.025.097.165.0.1">
<input type=hidden name=fullflag>
<input type=hidden name=mrcnlzer value="%STANDARD.01.025.097.168.0.1">
<input type=hidden name=ibcnmhos value="%STANDARD.01.025.000.043.1.1">
<input type=hidden name=desthosp value="%PATWEB85.04.034.0">
<input type=hidden name=destlocn value="    ">
<input type=hidden name=homehosp value="%PATWEB85.04.034.0">
<input type=hidden name=homelocn value="%PATWEB85.04.034.1">
<input type=hidden name=superlev value="%PATWEB85.04.035">

<table border=0 align=center width=90% cellpadding=1 style="table-layout:fixed">
<tr><td>Document Type</td>     
    <td><select name=medrr001 id=medrr001 class=Mandatory title="Document Type">
    <option></option>
      %PATWEB85.04.006.2
    </select></td>

    <td>Requested By</td>
    <td><div id=RequestType></div></td>
    </tr>

<tr><td class=DataLabel>Date Required</td>
    <td><input type=text size=12 name=medrr004 id=medrr004
         class="Mandatory Date" title="Date Required" value="%STANDARD.01.015">
    <img notab src=../images/DateLookup.gif class="Icon"
         onclick="DateLookupFrame(medrr004);">
    </td>
    <td class=DataLabel>Time</td>
    <td><input class=Mandatory type=text name=medrr005 id=medrr005
        size=8 value="%STANDARD.01.016" title="Time">
    <img notab src=../images/DateTimeStamp.gif class=Icon
        onclick="SetCurrentDateTime(medrr004,medrr005);">
    <img notab src=../images/TimeLookup.gif class=Icon
        onclick="TimeLookupFrame(medrr005);">
    </td>
  </tr>

  <tr><td>Location Required</td>
      <td><select name=medrr006 id=medrr006 class="Mandatory"
           title="Location Required">
      <option></option>
      </select>
      </td> 

      <td class=DataLabel><div id=HospitalTitle></div></td>
      <td><div id=Hospital></div></td>
  </tr>

  <tr><td>Reason</td>
      <td><select name=medrr003 id=medrr003 title="Reason" class=Mandatory>
      <option></option>
      %PATWEB85.04.008.1
      </select>
      </td>
  <!--
      <td class=DataLabel>Urgency</td>
      <td><select name=medrr008 class=Mandatory title="Urgency">
      <option></option>
      PATWEB85.04.001.2
      </select></td>
  -->
  </tr>

  <tr><td class=DataLabel>Extension #</td>
      <td><input type=text name=medrr007 id=medrr007 size=15 maxlength=30
     title="Extension"></td>
      <td class=DataLabel>Pager #</td>
      <td><input type=text name=medrr011 id=medrr011 size=15 maxlength=30
     title="Pager Number"></td>

  <tr><td class=DataLabel>Request Comments</td>
      <td><input type=text name=medrr009 id=medrr009 size=55 maxlength=35
     title="Request Comments"></td>
  </tr>

  <tr><td colspan=4 align=center><hr></td></tr>

  <tr><td class=DataLabel><div id=HomeHospTitle></div></td>
      <td><div id=HomeHosp></div></td>

      <td>Home Location</td>
      <td><select name=medrr013 id=medrr013 class=Mandatory
       title="Home Location" onchange="ResetHomeLocn(AddForm);">
      <option></option>
      </select></td></tr>

  <tr><td>U/R Number</td>
      <td><input type=text name=URNumber id=URNumber title="UR"
       onkeyDown="SetUrEvent();">
      <input type=hidden name=d1 id=d1>
      <input type=hidden name=d2 id=d2>
      <input type=hidden name=mrtme011 id=mrtme011>
      <img src=../images/SearchIcon.gif class=Icon notab
       onclick="SearchPatient();">
  <!--
      Volume
      <input type=text name=mrtme011 size=2
      onblur=OutputTable(AddForm.URNumber); ></td>
  -->
      <td>Medical Record Scan</td>
      <td><input type=text name=RecordKey id=RecordKey maxlength=22 size=27
       onfocus="CheckMaxLength(this);"
       onkeyDown="SetMedEvent();" title="Record Key">
      </td></tr>

  <tr id=VistNumber><td>Visit Number</td>
      <td><input type=text name=visitnum id=visitnum
           title="Visit Number" maxlength=8
           onchange="VisitNoChange();">
      </td>
  </tr>

  </table>

  <div id=Results></div>

<table border=0 align=center width=100% cellspacing=1>
<tr><td colspan=2 align=center><br>
    <input type=button value="Request" name=ReqButton id=ReqButton
     class="button" onclick="tempDisable(this);AddMovRecord();">
    <input type=button value="Clear All" class="button"
     onclick="location.reload()">
</td></tr>
</table>

</form>
</div>

<span id=ReqFree style="display:none">
  <input type=text name=medrr002 id=medrr002 title="Requested By" 
   value="%PATWEB85.04.007" class=Mandatory maxlength=35>
</span>
<span id=ReqSelect style="display:none">
  <select name=medrr002 id=medrr002 title="Requested By">
    <option></option>
    %PATWEB85.04.020
  </select>
</span>

<span id=ShowHospitalTitle style="display:none">
   Hospital
</span>

<span id=ShowHospital style="display:none">
  <select name=medrr010 id=medrr010 title="Hospital" class="Mandatory"
   onchange="SetDestination(AddForm);">
   %PATWEB85.04.004
  </select>
</span>

<span id=ShowNoHospital style="display:none">
   <input type=hidden name=medrr010 id=medrr010 value="    ">
</span>

<span id=ShowHomeHospTitle style="display:none">
  Home Hospital
</span>
    
<span id=ShowHomeHosp style="display:none">
  <select name=medrr012 id=medrr012 title="Home Hospital" class="Mandatory"
   onchange="SetHomeLocn(AddForm);">
   %PATWEB85.04.043
  </select>
</span>

<span id=ShowNoHomeHosp style="display:none">
   <input type=hidden name=medrr012 id=medrr012 value="    ">
</span>

<script type="text/javascript">
if (VariableNameExists('MRTVisitNoonBulkRecRequest')) {
  if (MRTVisitNoonBulkRecRequest == true) {
    document.getElementById('VistNumber').style.display = "";
  }
  else {
    document.getElementById('VistNumber').style.display = "none";
  }
}
</script>

