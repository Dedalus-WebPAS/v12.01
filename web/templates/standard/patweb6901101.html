<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome"    content="standard">
<meta name="HelpFileName"    content="NoContextSet.html">
<script type="text/javascript" src="../js/patweb90.js"></script>
<script type="text/javascript" src="../js/patweb69.js"></script>
<script type="text/javascript">
function updateParent(URN,Name) {
  p=document.Allocate;

  if (p.d_posted.value=="1") {  // Patient already clicked
    return;
  }
  p.d_posted.value="1";
  setTimeout('document.Allocate.d_posted.value="";',5000);

  if (p.ibcnmhos.value=="1") {
    validateCodeM(13,URN,p.dummy,p.dummy,p.dummy,p.dummy,p.dummy,
                  p.dummy,p.dummy,p.dummy,p.dummy,p.dummy,p.dummy,
                  p.dummy,p.dummy,p.dummy,p.ihos,p.uhos);

    if (p.ihos.value != p.uhos.value) {
      if (!confirm("Warning : UR not created by this hospital")) {
        p.d_posted.value="";
        return;
      } 
    }
  }
//
  if (!CheckEmrVisit(URN)) {
    p.d_posted.value="";
    return;
  }
//
  p.dummy_ur.value=URN;
  if (validateCode(8,p.dummy_ur,p.dummy,p.dummy,p.dummy,p.dummy1)) {
   if (p.dummy1.value == "1") {
      alert("Patient Deceased");
      p.d_posted.value="";
      return;
    }
  }
//
  ans=confirm("Allocate to Emergency Visit" +
              "\nU/R   " + URN + 
              "\nName  " + Name )
  if (ans) {
    p.urnumber.value=URN;
    p.admissno.value=top.content.PatientLinks.admissno.value;
    p.emvis147.value=top.content.PatientLinks.emvis147.value;
    p.updateky.value=top.content.UpdateForm.updateky.value;
    p.redirect.value="emrweb02.pbl?reportno=01&template=001" +
                     "&admissno=" + p.admissno.value.replace(/ /g,"+") +
                     "&regiflag=1";

    var PopUpFrameDoc  = ibaGetIframeDoc('PopUpFrame');

    if (top.menu.EmergencyFrameLink) {
      if (top.TogglePanel != undefined &&
          PopUpFrameDoc.getElementById('confmpin') != null) {
        SetCookie("sjogdontredirect","1");
        p.target=top.content.name;
        p.submit();
        return;
      }
      p.submit();
    } 
    else {
      p.target=top.content.name;
      p.submit();
    }
  } 
  else {
    p.d_posted.value="";
  }
}

function validateCodeM(OptionNumber,ReturnCode,ReturnName) {
  ReturnFunction="";
  ReturnName.value="";

  for (var i=3; i < validateCodeM.arguments.length; i++) {
    if (typeof(validateCodeM.arguments[i]) == 'function') {
      ReturnFunction=validateCodeM.arguments[i];
    }
    else {
      validateCodeM.arguments[i].value="";
    }
  }

  if (isWhitespace(ReturnCode))
    return;

  var serverURL   = "../cgi-bin/patweb80.pbl?reportno=" + OptionNumber +
                    "&valdcode=" + ReturnCode.replace(/ /g,"+") +
                    "&returnfm=1";
  var returnValue = RSExecute(serverURL);
  if (returnValue.status==0) {
    ReturnValue=returnValue.return_value.split("|");
    ReturnName.value=trim(ReturnValue[0]);
    j=0;
    for (var i=3; i < validateCodeM.arguments.length; i++) {
      if (typeof(validateCodeM.arguments[i]) != 'function') {
        j++;
        validateCodeM.arguments[i].value=ReturnValue[j];
      }
    }
    if (typeof(ReturnFunction) == 'function') {
      ReturnFunction(); 
    }
    return true;
  }
  else {
    return false;
  }
}

function init() {
  setDefault();
}

function CheckBirthDate() {
  if (checkDate(document.search.srchpdob,'Date of Birth')) {
    setBirth(this);
  }
  else {
    document.search.srchpdob.value="          ";
    document.search.srchpdob.focus();
  }
}

function DisableEnterKey(e)
{
  var key = (window.event) ? window.event.keyCode : e.which;
  return (key != 13);
}

function submitOnEnter(e)
{
  var key = (window.event) ? window.event.keyCode : e.which;

  if (key == 13 && 
      checkDate(document.search.srchpdob,'Date of Birth') && 
      ProcessSubmit()) {
    document.search.submit();
  }
  return true;
}

function ProcessSubmit() {
  var p = document.search;

  if (!validateMandatory(p))
    return false;

  p.srchsnam.value.replace(/\'/g,"~")

  setBirth(p.srchpdob);

/*
  if (p.d_quickreg.checked) {
    p.quickreg.value = "1";
  }
*/

  if (CheckFields()) {
    // check our LHD connection before proceeding with search
    if (HasConnection()) {
      return true;
    }
  }

  return false;
}

function ShowRegisterBtn(Visible) {
  var spRegBtn = document.getElementById('spRegBtn');
  var spNewReg = document.getElementById('spNewReg');

  if (Visible) {
    spRegBtn.innerHTML = spNewReg.innerHTML;
  }
  else {
    spRegBtn.innerHTML = "";
  }
}

function Cancel() {
  var sURL = document.search.redirect.value +
             "&srchsnam=" + document.search.srchsnam.value +
             "&srchgnam=" + document.search.srchgnam.value + "+" +
                            document.search.srchmnam.value +
             "&srchpsex=" + document.search.srchpsex.value +
             "&srchpdob=" + document.search.srchpdob.value;

  if (!isWhitespace(document.search.srchmedi.value)) {
    sURL += "&srchmedi=" + document.search.srchmedi.value + "&srchtype=5";
  }

  location.href = sURL;
}

function NewReg() {
  document.Registration.srchsnam.value=document.search.srchsnam.value;
  document.Registration.srchgnam.value=document.search.srchgnam.value;
  document.Registration.srchmnam.value=document.search.srchmnam.value;
  document.Registration.srchpdob.value=document.search.srchpdob.value;
  document.Registration.srchpsex.value=document.search.srchpsex.value;
  document.Registration.srchmedi.value=document.search.srchmedi.value;
  document.Registration.submit();
}

function RegisterNewUPI(UPI, PersonID) {
  document.Registration.upinumbr.value = UPI;  // create UPI as Alternate ID
  document.Registration.upinspid.value = PersonID;  // NSLHD Person ID

  document.Registration.submit();
}

function ParentSelect(UR,Name) {
  updateParent(UR,Name);
}

function ShowDiff(UR, UPI, PersonID) {
  // redirect to patweb8901002 with UPI (to pop up Data Fields differences)
  document.linkForm.action = "patweb89.pbl";
  document.linkForm.reportno.value = "01";
  document.linkForm.template.value = "002";
  document.linkForm.urnumber.value = UR;
  document.linkForm.admissno.value = "";
  document.linkForm.upinumbr.value = UPI;
  document.linkForm.upinspid.value = PersonID;

  SetUPIDataUpdateFlag();  // set flag to allow update DFrame popup

  document.linkForm.submit();
}

function PatientSelect(UR, UPI, PersonID) {
  var sResultStr = "";
  var arrNewPat;
  var sPatName = "";

  if (!isWhitespace(UR) && URExists(UR)) {  // UR exists
    var datArr = GetURData(UR);
    if (datArr != undefined) {
      sPatName = datArr[0] + " " + datArr[2] + " " + datArr[3] + " " +datArr[1];
      ParentSelect(UR,sPatName);  // select existing patient
    }
  }
  else if (AltIdExists(UPI)) {  // check UPI exists as Alternate ID ?
    var arrPat = AlternateIdDataStr.split("|");  // returned from AltIdExists()
    var sAssocUR = arrPat[0];  // associated UR
    var sSurname = trim(arrPat[1]);
    var sFirstName = trim(arrPat[2]);
    var sTitle = trim(arrPat[3]);

    sPatName =  sTitle + " " + sFirstName + " " + sSurname;
    ParentSelect(sAssocUR,sPatName);  // select existing patient
  }
  else {
    // UR or UPI does NOT exist in our system;
    // Register new patient with default data and create a new Alternate ID
    // with the UPI.
    RegisterNewUPI(UPI,PersonID);
  }

  return;
}

function Next() {
  var p = document.search;
  if (ProcessSubmit()) {
    p.srchnext.value = "1";  // set the next batch search flag
    p.submit();
  }
}

function DFrameExitRefresh()
{
  if (window.name=="search") {
    top.TogglePanel();       // Emergency Map Bay of Plenty
  }
  else {
    DFrameExit();
  }
}

function setMedicare(MedicareNo) {
  if (!isWhitespace(MedicareNo.value)) {
    CheckMedicareScan(MedicareNo);
  }
}
</script>
</head>
%START.OF.PAGE
<body onload="PageLoad(event);">

<span class=DFrameTitleBar>
<img border=0 align=right src="../images/ExitIcon.gif"
 onclick="DFrameExitRefresh();">
<script type="text/javascript">document.write(self.document.title);</script>
</span>

<form name=search id=search method=get action=patweb69.pbl style="margin:0"
 onsubmit='return ProcessSubmit();' onkeydown='return DisableEnterKey(event);'
 onkeyup='return submitOnEnter(event);' >
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=101>
<input type=hidden name=redirect value="%PATWEB69.01.017">
<input type=hidden name=ptcnhdps value="%STANDARD.01.025.080.250.1.1">
<input type=hidden name=ptcnuepm value="%STANDARD.01.025.125.155.0.1">
<input type=hidden name=srchtype value="1">
<input type=hidden name=quickreg value="">
<input type=hidden name=srchnext value="">

<table align="center" width=100% border=1 cellpadding=0 cellspacing=0 
 bgcolor=#CCCCCC>
<tr><td>

<table width=100% height=100% border=0 cellpadding=2 cellspacing=2
 bgcolor=#F3E2A9>
<tr valign=top><td class=DataLabel>Surname<br>
      <input type=text name=srchsnam id=srchsnam onblur="UpCaseSearch(this)" 
       size=15 tabindex=1 title="Surname" value="%PATWEB69.01.003"
       onchange="HideNextBtn();">
    </td>
    <td class=DataLabel>First Given Name<br>
      <input type=text name=srchgnam id=srchgnam onblur="UpCaseSearch(this)"
       size=15 tabindex=2 title="First Given Name" value="%PATWEB69.01.004"
       onchange="HideNextBtn();">
    </td>
    <td class=DataLabel nowrap>Second Given Name<br>
      <input type=text name=srchmnam id=srchmnam onblur="UpCaseSearch(this)"
       size=15 tabindex=3 title="Second Given Name" value="%PATWEB69.01.005"
       onchange="HideNextBtn();">
    </td>
    <td class=DataLabel>Gender<br>
      <select name=srchpsex id=srchpsex tabindex=4 title="Gender"
       onchange="HideNextBtn();">
        <option value=" "></option>
        <option value="M">Male</option>
        <option value="F">Female</option>
        <option value="U">Unknown</option>
        <option value="I">Indeterminate</option>
      </select>
    </td>
    <td class=DataLabel>Date of Birth<br>
       <input type="text" size="12" name=srchpdob id=srchpdob tabindex=5
        title="Date of Birth" value="%PATWEB69.01.007" 
        onchange="CheckBirthDate();HideNextBtn();">
    </td>
    <td class=DataLabel>Medicare No.<br>
       <input type="text" size="14" maxlength=11 name=srchmedi id=srchmedi
        tabindex=6 title="Medicare No." value="%PATWEB69.01.008"
        onblur="setMedicare(this);" onchange="HideNextBtn();">
    </td>
    <td class=DataLabel nowrap><br>
<!--
      <input type=checkbox name=d_quickreg id=d_quickreg tabindex=7 value="1"
       onclick='ToggleMandatory(this);'>
      <font color=red>Quick Registration</font>
//-->
    </td>
    <td width=40%>
      <table width=100% border=0 cellpadding=2 cellspacing=2>
      <tr><td valign=middle align=right>
      <input type=submit value="LHD Search" class="button" tabindex=10><br>
      <input type=button value="Cancel" class="button" tabindex=11
       onclick='Cancel();'>
      </td></tr>
      </table>
    </td>
</tr>
</table>

%PATWEB69.01.011.010.1.patweb98.01.001

<table width=100% border=1 cellspacing=0 cellpadding=0 align=center>
<tr>
  <td>
    <table width=100% bgcolor=#CCCCCC border=0>
    <tr>
      <td width=45%>&nbsp;
<!--
        <input type=button value="<< Previous" class="button"
         onclick="location.href='PATWEB69.01.002';">
//-->
      </td>
      <td width=30%><span id=spRegBtn></span></td>
      <td>
        <span id=spNextBtn>
          <input type=button class="button" value="Next >>" onclick="Next();">
        </span>
      </td>
    </tr>
    </table>
  </td>
</tr>
</table>

</td></tr>
</table>
<input type=hidden name=srchcont value="%PATWEB69.01.009">
</form>

<span id=spNewReg style="display:none">
  <input type=button value="New Registration" class="Bigbutton"
   onclick="NewReg();">
</span>


<form name=Allocate method=get action=emrweb02.pbl style="margin:0">
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=1>
<input type=hidden name=formactn value="EX">
<input type=hidden name=updttype value="ALLEX">
<input type=hidden name=urnumber value="">
<input type=hidden name=admissno value="">
<input type=hidden name=updateky value="">
<input type=hidden name=nextpage value="2">
<input type=hidden name=redirect value="emrweb02.pbl?reportno=01&template=001">
<input type=hidden name=emvis147>
<input type=hidden name=ihos>
<input type=hidden name=uhos>
<input type=hidden name=dummy>
<input type=hidden name=dummy1>
<input type=hidden name=dummy_ur>
<input type=hidden name=ibcnmhos value="%STANDARD.01.025.000.043.1.1">
<input type=hidden name=d_posted  value="">
</form>


<form name=Registration method=get action=patweb89.pbl>
<input type=hidden name=reportno value=05>
<input type=hidden name=template value=3>
<input type=hidden name=admissno value="">
<input type=hidden name=srchsnam value="">
<input type=hidden name=srchgnam value="">
<input type=hidden name=srchmnam value="">
<input type=hidden name=srchpdob value="">
<input type=hidden name=srchpsex value="">
<input type=hidden name=srchmedi value="">
<input type=hidden name=upinumbr value="">
<input type=hidden name=upinspid value="">
</form>

<form name=linkForm action=patweb98.pbl method=get>
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=101>
<input type=hidden name=urnumber value="">
<input type=hidden name=admissno value="">
<input type=hidden name=nodetail value="%PATWEB69.01.020">
<input type=hidden name=upinumbr value="">
<input type=hidden name=upinspid value="">
</form>

<script type="text/javascript">
function setDefault() {
  if (document.all.BodyDivision != undefined) {
     BodyDivision.style.height = document.body.clientHeight - 51 -
                                  BodyDivision.offsetTop + "px";
  }

  AddGender();
  for (var i =0 ; i < document.search.srchpsex.length; i++) {
    if (document.search.srchpsex.options[i].value=="%PATWEB69.01.006") {
      document.search.srchpsex.selectedIndex=i;
    }
  };

/*
  if ("%PATWEB69.01.014" == "1") {
    var chkBox = document.search.d_quickreg;
    chkBox.checked = true;
    ToggleMandatory(chkBox);
  }
*/

  if (isWhitespace(document.search.srchcont.value)) {
    document.getElementById('spNextBtn').style.display = "none";
    ShowRegisterBtn(true);
  }
}
</script>
