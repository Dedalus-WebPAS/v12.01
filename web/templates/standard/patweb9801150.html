<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome"    content="standard">
<meta name="HelpFileName"    content="NoContextSet.html">
<meta name="CrossBrowser"    content="true">
<script type="text/javascript" src="../js/ReportStandard.js"></script>
<script type="text/javascript">
function init() {
 if(document.HiddenFields.ptcnsmsn.value != "1") {
   alert("SMS Notifications not activated");
   DFrameExit();
   return;
 }
 if(document.HiddenFields.d_ptmxosms.value == "1") {
   alert("Patient has opted out");
   DFrameExit();
   return;
 }
 p=document.HiddenFields;
 validateCode(12,p.admissno,p.dummy,p.dummy,p.dummy,p.dummy,p.urnumber,
              p.dummy,p.d_pvidate,p.d_pvitype,p.dummy,p.dummy,
              p.dummy,p.dummy,p.dummy,p.dummy,p.dummy,p.dummy,p.casekeys);
 if(trim(document.HiddenFields.d_pvitype.value) == "Inpatient") {         //IP
   document.getElementById("InpatientVisit").style.display="";
   document.getElementById("ipvisittype").innerHTML=p.d_pvitype.value +
   " - " +  p.d_pvidate.value;
 } else if(trim(document.HiddenFields.d_pvitype.value) == "Outpatient") { //OP
   document.getElementById("OutpatientVisit").style.display="";
   document.getElementById("opvisittype").innerHTML=p.d_pvitype.value +
   " - " +  p.d_pvidate.value;
   document.UpdateForm.casekeys.value=p.casekeys.value;
 } else if(trim(document.HiddenFields.d_pvitype.value) == "Booking") { // Booking
   document.getElementById("BookingVisit").style.display="";
   document.getElementById("boknvisittype").innerHTML=p.d_pvitype.value +
   " - " +  p.d_pvidate.value;
 } else {
   if(getTop().content.location.href.search('watweb01') != -1 &&
      getTop().content.location.href.search('casekeys') != -1) {
      alert("Use Waiting List letter functionality for " +
            "adhoc Waiting List SMS notifications");
   }
   alert("Invalid visit for SMS notifications.");
   DFrameExit();
 }
}
function SubmitFormOP() {
  var p = document.UpdateForm;
  var allRevNumbers = []

  if (validateMandatory(p)) {
    if (ValidPhoneNum(allRevNumbers)) {
      p.submit();
    }
  }
}
function SubmitFormBK() {
  var p = document.BookingForm;
  var allRevNumbers = [];

  if (ValidPhoneNum(allRevNumbers)) {
    SubmitReport(p);
  }
}
function SendSMS() {
  var p = document.ReportForm;
  var allRevNumbers = [];

  if (!ValidPhoneNum(allRevNumbers)) return;

  // If patient does not have a mobile number but there are other contacts...
  if (isWhitespace(document.ReportForm.d_mobile.value) &&
      document.ReportForm.contlist.options.length > 1) {
    if (!document.ReportForm.contall.checked) {  // Not sending to all contacts
      allRevNumbers.push(trim(document.ReportForm.contlist.value));
    }
    executeSendSMS(allRevNumbers);
  }
  else {  // Just send to the patient's mobile
    SubmitReport(p);
  }
}

function executeSendSMS(allRevNumbers) {
  if (validateMandatory(document.ReportForm)) {
    if (allRevNumbers.length > 0) {  // sending to Contact List
      document.ReportForm.keystr01.value = "7";  // use program option 7

      var mobNumbers="";
      for (var i = 0; i < allRevNumbers.length; i++) {
        mobNumbers += allRevNumbers[i];
        if (i < allRevNumbers.length-1) mobNumbers += ",";
      }

      document.ReportForm.keystr05.value = mobNumbers;  // comma separated list
    }

    var xmlHttp = createHttpObject();
    var theURL = document.ReportForm.action;
    var postStr = AJAXPostString(document.ReportForm);
    xmlHttp.open("POST", theURL, false);
    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xmlHttp.send( encodeURI(postStr) );
    DFrameExitRefresh();
  } else {
    return false;
  }
}

function ValidPhoneNum(allRevNumbers) {
  var conMobEl = document.getElementById("contlist");
  var mobile = trim(document.ReportForm.d_mobile.value);
  var contactMobile = [];

  // No mobile number stored?
  if (isWhitespace(mobile)) {
    if (conMobEl.length == 1) {
      alert("Cannot send SMS. No associated mobile number recorded for this person.");
      return false;
    } else if (conMobEl.length > 1) {
      if (conMobEl.selectedIndex !== 0) {
        contactMobile = [trim(conMobEl.value), conMobEl[conMobEl.selectedIndex].text];
      }
    }
  }

  //
  // Check mobile number pattern...
  //
  // Only contain numbers and spaces. 
  // Can (optionally) start with a + followed by country code (up to 3 digits).
  // Number without country code can be up to 13 digits long.
//var regex = new RegExp('^(?:\\+[0-9]{1,3})?(?:[0-9]\\s*){10,13}$');
  var regex = new RegExp('^(?:\\+[0-9]{1,3})?((?:[0-9]\\s*){10,13}|(?:[0-9]\\s*){9,13})$');
  var alertMsg;
  var allErrNumbers = [];

  if (contactMobile.length == 2) {
    if (!regex.test(contactMobile[0])) {
      alertMsg = "Cannot send message to chosen contact - invalid mobile numbe"+
                 "r:\n"+contactMobile[0]+" ("+contactMobile[1]+")";
      alert(alertMsg);
      return false;
    }
  } else if (conMobEl.length > 1 && isWhitespace(mobile)) {
    for (var i = 1; i < conMobEl.length; i++) {
      if (isWhitespace(conMobEl.options[i].value)) continue;  // skip if blank

      if (regex.test(trim(conMobEl.options[i].value))) {
        allRevNumbers.push(trim(conMobEl.options[i].value));
      } else {
        allErrNumbers.push([trim(conMobEl.options[i].value), conMobEl.options[i].text]);
      }
    }
    if (allRevNumbers.length == 0) {
      alertMsg="Found no valid phone numbers within these patient contacts:\n"
      for (var j = 0; j < allErrNumbers.length; j++) {
        alertMsg+= allErrNumbers[j][0]+" - ("+allErrNumbers[j][1]+")\n";
      }
      alert(alertMsg);
      return false;
    }
  } else if (!regex.test(mobile)) {
    alert("Cannot send message - patient has an invalid mobile number: " + mobile);
    return false;
  }

  return true;
}

function toggleContact(checkStatus) {
  if (checkStatus.checked == false) {
    document.getElementById("contlist").disabled = false;
    document.getElementById("contlist").className="Mandatory";
  } else {
    document.getElementById("contlist").disabled = true;
    document.getElementById("contlist").selectedIndex=0;
    document.getElementById("contlist").className="";
  } 
}
</script>
</head>
%START.OF.PAGE
<body onload="PageLoad(event);">
<span class=DFrameTitleBar>
<img align="right" alt="Exit" class="MenuIcon" 
 src="../images/ExitIcon.gif" onclick="DFrameExit();">
<script type="text/javascript">
document.write("Send SMS - %PATWEB98.01.002");</script>
</span>
<div id="InpatientVisit" style="display:none">
<form name=ReportForm action="rshweb02.pbl" method=post style="margin:0">
<input type=hidden name=reportno value=4>
<input type=hidden name=template value=001>
<input type=hidden name=updttype value="A">
<input type=hidden name=sbwindow value=1>
<input type=hidden name=setdfprg value="IBAPMS89">
<input type=hidden name=setdfrep value="01">
<input type=hidden name=schdpgid value="IBAPMS89">
<input type=hidden name=schddesc value="Send Inpatient SMS">
<input type=hidden name=schdrdat value="">
<input type=hidden name=schddate value="%STANDARD.01.015">
<input type=hidden name=schdtime value="%STANDARD.01.016">
<input type=hidden name=schdprnt value="%STANDARD.01.025.124.105.0.6">
<input type=hidden name=schdtype value="3">
<input type=hidden name=d_mobile value="%PATWEB98.01.543">

<table align=center cellspacing=0 cellpadding=3 border=0 width=95%>
<tr><td class=DataLabel>Visit Type</td>
    <td class=DataLabel id="ipvisittype"></td>
    </tr>

<input type=hidden name=keystr01 value="4">
<input type=hidden name=keystr02 value="%PATWEB98.01.081">

<tr><td class=DataLabel>SMS Message</td>
    <td><select name=keystr03 id=keystr03 title='SMS Message' class=Mandatory>
        <option></option>
         %PATWEB98.01.390
        </select>
    </td></tr>
    <input type=hidden name=docodflt value="%STANDARD.01.033.IBAPMS89.01">
    <input type=hidden name=keystr04  title="Schedule Date" value="%STANDARD.01.015">
    <input type=hidden name=keystr05  title="Mobile Numbers" value="">

<tr id=contlistrow><td class=DataLabel>Contact List</td>
    <td><select name=contlist id=contlist title="Contact List" disabled>
        <option></option>
        %PATWEB98.01.654 
        </select>
        <input type=checkbox name=contall id=contall onclick="toggleContact(this)">
        <label for=contall>Send to all contacts?</label>
    </td>
</tr>

<tr><td colspan=2 align=center><br>
    <input type=button id=btnSendSMSIP value="Send SMS"
     class="button" onclick="tempDisable(this);SendSMS();">
    <input type=button Value="Cancel" class="button" onclick="DFrameExit();">
    </td></tr>
</table>
</form>
</div>

<div id="OutpatientVisit" style="display:none">
<form action=outweb02.pbl method=post name=UpdateForm style="margin:0">
<input type=hidden name=reportno value="4">
<input type=hidden name=updatety value="6">
<input type=hidden name=casekeys value="">
<input type=hidden name=letprt11 value="1">
<input type=hidden name=letpsl11 value="%STANDARD.01.025.124.105.0.6">

<table align=center cellspacing=0 cellpadding=3 border=0 width=95%>
<tr><td class=DataLabel>Visit Type</td>
    <td class=DataLabel id="opvisittype"></td>

<tr><td class=DataLabel>SMS Message</td>
    <td><select name=lettyp11 title='SMS Message' class=Mandatory>
        <option></option>
         %PATWEB98.01.392
        </select>
    </td></tr>

<tr><td colspan=2 align=center><br>
    <input type=button id=btnSendSMSOP value="Send SMS"
     class="button" onclick="tempDisable(this);SubmitFormOP();">
    <input type=button Value="Cancel" class="button" onclick="DFrameExit();">
    </td></tr>
</table>
</form>
</div>

<div id="BookingVisit" style="display:none">
<form action=rshweb02.pbl method=post name=BookingForm style="margin:0">
<input type=hidden name=reportno value="4">
<input type=hidden name=template value=001>
<input type=hidden name=updttype value="A">
<input type=hidden name=setdfprg value="IBABOK30">
<input type=hidden name=setdfrep value="01">
<input type=hidden name=schdpgid value="IBABOK30">
<input type=hidden name=schddesc value="Send Booking SMS">
<input type=hidden name=schdrdat value="">
<input type=hidden name=schddate value="%STANDARD.01.015">
<input type=hidden name=schdtime value="%STANDARD.01.016">
<input type=hidden name=schdprnt value="%STANDARD.01.025.124.105.0.6">
<input type=hidden name=schdtype value="3">
<input type=hidden name=d_mobile value="%PATWEB98.01.543"> 

<table align=center cellspacing=0 cellpadding=3 border=0 width=95%>
<tr><td class=DataLabel>Visit Type</td>
    <td class=DataLabel id="boknvisittype"></td>

<input type=hidden name=keystr01 value="4">
<input type=hidden name=keystr02 value="%PATWEB98.01.081">

<tr><td class=DataLabel>SMS Message</td>
    <td><select name=keystr03 title='SMS Message' class=Mandatory>
        <option></option>
         %PATWEB98.01.399.028
        </select>
    </td></tr>
    <input type=hidden name=docodflt value="%STANDARD.01.033.IBAPMS89.01"> 
    

<tr><td colspan=2 align=center><br>
    <input type=button id=btnSendSMSBK value="Send SMS"
     class="button" onclick="tempDisable(this);SubmitFormBK();">
    <input type=button Value="Cancel" class="button" onclick="DFrameExit();">
    </td></tr>
</table>
</form>
</div>

<form name=HiddenFields>
<input type="hidden" name="ptcnsmsn" value="%STANDARD.01.025.120.243.0.1">
<input type="hidden" name="d_ptmxosms" value="%PATWEB98.01.391">
<input type="hidden" name="urnumber" value="%PATWEB98.01.003">
<input type="hidden" name="admissno" value="%PATWEB98.01.081">
<input type="hidden" name="d_pvitype" value="">
<input type="hidden" name="d_pvidate" value="">
<input type="hidden" name="casekeys" value="">
<input type="hidden" name="dummy" value="">
<input type=hidden name="ptcnsmso" id="ptcnsmso"
 value="%STANDARD.01.025.128.106.0.1">
</form>

<script type="text/javascript">
if (document.getElementById("ptcnsmso").value=="1") {
  sortSelectionList(document.UpdateForm.lettyp11);
  sortSelectionList(document.ReportForm.keystr03);
}

if (!isWhitespace(document.ReportForm.d_mobile.value)) {
  document.getElementById("contlistrow").style.display = "none";
}

if (document.getElementById("contlist").length > 1) {
  document.getElementById("contall").checked = true;
}
else {
  document.getElementById("contall").disabled = true;
}
</script>
