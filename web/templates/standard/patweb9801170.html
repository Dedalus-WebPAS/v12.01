<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="standard">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript">
//------------------------------------------------------------
// patweb9801170 - Medication Summary View
// Modifications :
//----------------------------------------------------------------------
function setReceiver() {
  if (window.addEventListener){
    addEventListener("onmessage", receiveMessage, false);
  } else {
    attachEvent("onmessage", receiveMessage);
  }
};
function receiveMessage(e) {
  if (window.removeEventListener) {
    removeEventListener("onmessage", receiveMessage, false);
  } else {
    detachEvent("onmessage", receiveMessage);
  }
  location.reload();
}
var jsonMedications;
function LaunchMedchart(fn) {
// Function Name         Launch to
// patient               Patient Summary screen for requested patient
// prescribe             Patient Medication screen for requested patient
// administration        Medication administration chart for the requested patient
// review                Pharmacy review chart for the requested patient
// desktop               MedChart Desktop
// user                  Update user details without display anything in MedChart
// wardsummary           Administration ward overview screen
// managepatient         Edit details for the requested patient
// pharmacyreviewmonitor Pharmacy review monitor
// clinicalreviewmonitor Clinical review monitor
  wurl="MedchartServices.php?reportno=10"+
       "&urnumber=" + document.PatientLinks.urnumber.value.replace(/ /g,"") +
       "&admissno=" + document.PatientLinks.admissno.value.replace(/ /g,"") +
       "&function=" + fn +
       "&httprand=" + Math.random();
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", wurl, false);
  xmlHttp.send();
  if (xmlHttp.responseText.substr(0,5)=="ERROR"&&xmlHttp.status == 200) {
    alert(xmlHttp.responseText);
  } else {
    var el=document.getElementById("PatientHeading");
    var w=el.offsetWidth-40
    var l=(document.body.clientWidth-w)/2;
    setReceiver();
    DFrameLink(xmlHttp.responseText,0,l,w,800)
  }
}
function init() {
  wurl="MedchartServices.php?reportno=1"+
       "&urnumber=" + document.PatientLinks.urnumber.value.replace(/ /g,"") +
       "&admissno=" + document.PatientLinks.admissno.value.replace(/ /g,"") +
       "&httprand=" + Math.random();
  var h = document.getElementsByTagName("head")[0];
  var s = document.createElement("script");
  var xmlHttp = createHttpObject();
  xmlHttp.open("GET", wurl, false);
  xmlHttp.send();
  if (xmlHttp.responseText.substr(0,5)=="ERROR"&&xmlHttp.status == 200) {
    alert(xmlHttp.responseText);
  } else {
    if (xmlHttp.responseText!=""&&xmlHttp.status == 200) {
      jsonMedications = eval("("+xmlHttp.responseText+")"); //convert text to javascript object
      ShowMedications();
    } else {
      alert("Medication Web Service Not available MedchartServices.php");
    }
  } 
}
//called with every property and it's value
function process(key,value) {
    OS+=key + " : "+value+"<br>";
}

function traverse(o,func) {
    for (var i in o) {
        if (o[i] !== null && typeof(o[i])=="object") {
            //going on step down in the object tree!!
            func.apply(this,[i,'']);  
            traverse(o[i],func);
        } else {
          func.apply(this,[i,o[i]]);  
        }
    }
}
function ShowMedicationsXX() {
 OS='';
 traverse(jsonMedications,process);
   ListLocation = document.getElementById("TableLocation");
   ListLocation.innerHTML = OS;
}
function ShowMedications() {
 var rowCount=0;
 var MedName="";
 var Form="";
 var PrescribedBy="";
 var Dosages="";
 var Schedule="";
 var FreqType="";
 var StartOn="";

 t = new Table(1,0,2,"100%","center",30,40);
 t.addColumn("Date","Date",7,7,"left","","",120);
 t.addColumn("Medication","String",1,1,"left","","",250);
 t.addColumn("Dose","String",6,6,"left","","",250);
 t.addColumn("Prescribed","String",5,5,"left","","",150);
 t.addColumn("Review","String",3,3,"left","","",100);
 t.addColumn("Type","String",8,0,"left","","",100);

 for (var ErrorMessage in jsonMedications) {
   var ErrorCode=jsonMedications[ErrorMessage]['ErrorCode'];
   var ErrorMessage=jsonMedications[ErrorMessage]['Message'];
   if (!isWhitespace(ErrorCode)) {
     alert("MEDCHART RETURNED ERROR\n "+ErrorCode+"  =   "+ErrorMessage);
   }
 }
 for (var Medication in jsonMedications['SimpleMedications']) {
   MedName=     (jsonMedications['SimpleMedications'][Medication]['Description'])?
          jsonMedications['SimpleMedications'][Medication]['Description']:"N/A";
   Form=        (jsonMedications['SimpleMedications'][Medication]['Form'])?
          jsonMedications['SimpleMedications'][Medication]['Form']:"N/A";
   LineStatus=  (jsonMedications['SimpleMedications'][Medication]['Status'])?
          jsonMedications['SimpleMedications'][Medication]['Status'].split(","):"N/A";
   PrescribedBy=(jsonMedications['SimpleMedications'][Medication]['PrescribedBy']['DisplayName'])?
          jsonMedications['SimpleMedications'][Medication]['PrescribedBy']['DisplayName']:"N/A";
   Dosages="DOSE:<b>";
   for (var Dose in jsonMedications['SimpleMedications'][Medication]['Dosages']) {
     x=(jsonMedications['SimpleMedications'][Medication]['Dosages'][Dose]['Description'])?
        jsonMedications['SimpleMedications'][Medication]['Dosages'][Dose]['Description']:"N/A";
     Dosages+=x+" ";
   }
   Dosages+="</b>";
   Scheduled=   (jsonMedications['SimpleMedications'][Medication]['Schedule']['Description'])?
          jsonMedications['SimpleMedications'][Medication]['Schedule']['Description']:"N/A";
   FreqType=    (jsonMedications['SimpleMedications'][Medication]['Schedule']['FrequencyType'])?
          jsonMedications['SimpleMedications'][Medication]['Schedule']['FrequencyType']:"N/A";
   StartOn=     (jsonMedications['SimpleMedications'][Medication]['Schedule']['StartsOn'])?
          jsonMedications['SimpleMedications'][Medication]['Schedule']['StartsOn']:"N/A";
   StartDate=netDate(StartOn,"datetime");
   MedStat=LineStatus[0];
   RevStat=LineStatus[1];
   BlockStat=LineStatus[2];
   MedTypeCD='0';
   MedType='Scheduled';
   if (FreqType.match(/PRN/)) { MedTypeCD='1';MedType="PRN"; }
   if (Form.match(/Infusion/)) { MedTypeCD='2';MedType="Infusion" }
   if (MedStat.match(/current/)) {
     t.addRow(MedTypeCD+MedName,MedName,MedStat,RevStat,
              BlockStat,PrescribedBy,Dosages+'<br>'+Scheduled,StartDate,MedType);
   }
 }
 TableOutput(1,1);    // Order Column,Asc Dsc
}
//
// Format .NET Date Return in JSON from MedChart
//
function netDate(el,format) {
  if (isWhitespace(el)) return "";
  var d = new Date(parseInt(el.replace(/\/+Date\(([\d+-]+)\)\/+/, '$1')));
  var ThisHrs=d.getHours();
  var ThisMin=d.getMinutes();
  var ThisDay=d.getDate();
  var ThisMth=parseInt(d.getMonth(),10) +1;
  var ThisYrs=d.getFullYear();
  if (ThisHrs < 10) ThisHrs="0" + ThisHrs
  if (ThisMin < 10) ThisMin="0" + ThisMin
  if (ThisDay < 10) ThisDay="0" + ThisDay
  if (ThisMth < 10) ThisMth="0" + ThisMth
  ThisHrs = ThisHrs.toString();
  ThisMin = ThisMin.toString();
  ThisMth = ThisMth.toString();
  ThisDay = ThisDay.toString();
  var monthname = new Array('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec');
  var MonthName=monthname[d.getMonth()];
  if (format=="displaydate") return ThisDay+" "+MonthName+" "+ThisYrs
  if (format=="date") return ThisYrs+ThisMth+ThisDay
  if (format=="datetime") return ThisYrs+ThisMth+ThisDay+ThisHrs+ThisMin
}
</script>
<style type=text/css>
.TableRowOdd {
  line-height:14px !important;
}
.TableRowEven {
  line-height:14px !important;
}
</style>
%START.OF.PAGE
<script type="text/javascript" src=../js/patweb98.js></script>
<script type="text/javascript" src=../js/TableSort.js></script>
<script type="text/javascript" src=../js/PatientHeader.js></script>
<script type="text/javascript" src="%PATWEB98.01.001.patweb98.01.103"></script>
</head>
<body onload="LoadHead();PageLoad();">
<div id=PatientHeading></div>
<div id=PatientBannerEx1 class=PatientBannerEx></div>
<div id=PatientMenu>
<input type=button class=button value='Chart' onclick='LaunchMedchart("patient");'>
</div>
<div id=PageBodySection>
<div id=TableLocation></div>
<form name=PatientLinks method=get action="cliweb01.pbl">
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=urnumber value="%PATWEB98.01.003">
<input type=hidden name=admissno value="%PATWEB98.01.081">
<input type=hidden name=MenuType value="%PATWEB98.01.088">
<input type=hidden name=alert001 value="">
<input type=hidden name=alert002 value="">
</form>
</div>
</body>
