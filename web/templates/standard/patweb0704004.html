<meta name="TemplateVersion" content="V12.01.00">
<meta name="TemplateHome" content="standard">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="../js/TableSort.js"></script>
<script type="text/javascript" src="../js/patweb07.js"></script>
<script type="text/javascript">
function AddConcessCard() {
  f = document.UpdateForm;
  f.pmccd002.value=f.d_pmccd002.value;
  ind1 = f.pmccd002.value.charAt(3);
  ind5 = f.pmccd002.value.charAt(7);
  switch (ind1) {
    case "4": {
      // Pension card
      if (ind5 !="V") {
        if (!pensionNumberValidation(f.pmccd003.value)) {
          return;
        }
      }
      break;
    }
    case "7": {

     //Checks if NDIS number matches requirements
     if (!validateNDISNumber(f.pmccd003,
                             f.ptcnhdps.value)){
        return;
     }
    }
  }
  SubmitHiddenNew(f);
}
function UpdateCCard1(urnumber,ctyp,ctypdc,exdate) {
//alert(urnumber+" "+ctyp+" "+ctypdc+" "+exdate);
  linkurl="../cgi-bin/patweb07.pbl?reportno=4&template=5" +
          "&urnumber="+urnumber +
          "&pmccd004="+exdate   +
          "&pmccd002="+ctyp     +
          "&ctypindc="+ctypdc;
   Left=(document.body.clientWidth-500)/2
   DFrameLink(linkurl,0,Left,500,260)
}

function DeleteConcessCard(urnumber,exdate,ctyp) {
//alert(urnumber+" "+exdate+" "+ctyp);
  if(confirm("Are you sure you want to delete?")) {
     linkurl="patweb07.pbl?reportno=4&template=8" +
             "&urnumber="+urnumber+
             "&pmccd004="+exdate  +
             "&pmccd002="+ctyp;
     Left=(document.body.clientWidth-300)/2
     DFrameLink(linkurl,60,Left,450,100);
  }
}

function errorMessage(errorMsg){
  alert("Error Message\n" + errorMsg);
}

function isChecksumValid(pensionNum) {
  var checksumStart = 512;
  var checksumString = 'XVTSLKJHCBA';
  var checksumTotal = 0;
  var j = 1;
  for (var i = 0; i < pensionNum.length-1; i++) {
    if (i == 0) {
      if (pensionNum[0] === 0 || pensionNum[0] >= 8 || 
          isNaN(pensionNum[0])) {
        errorMessage("Invalid first digit of the Pension Number, the first " + 
                     "digit must be in the range of 1-7.");
        return false;
      }
    } 
    checksumTotal += pensionNum[i] * (checksumStart / j);
    j = j*2;
  }
  remainderNum = checksumTotal % 11
  if (checksumString[remainderNum] !== pensionNum[pensionNum.length-1]) {
    errorMessage("The Pension Number checksum failed, please re-enter a " +
                 "valid card combination");
    return false;
  }
  return true;
}

function pensionNumberValidation(pensionNum) {
  if (pensionNum.length != 10) {
    errorMessage("Invalid Pension Number length. The Pension Number must be 1" +
                 "0 characters and the last digit must be an alpha character.");
    return false;
  }
  if (!isChecksumValid(pensionNum)) {
    return false;
  }
  return true;
}

function DefaultDate(ctyp,cdate) {
  if(ctyp.value.substr(3,1)=="2") {
     document.UpdateForm.pmccd004.value=("31 Dec " + cdate.value.substr(0,4));
  }
}

function ValidateCardType() {
  p=document.UpdateForm
  var cardType     = document.getElementById('d_pmccd002');
  var index        = cardType.selectedIndex;
  var flag         = 0;
  if(cardType[index].value.substr(3,1) == "3") {
    var cardnumber=trim(document.UpdateForm.pmccd003.value);
    if(cardnumber && (cardnumber.substr(1,1)==" "))
    {
      flag=1;
      var dData=p.pmccd003.value.replace(/ /g,"");
      p.pmccd003.value=[dData.slice(0, 1), " ", dData.slice(1)].join('');
    }
  }
  if(flag==0){
    p.pmccd003.value=p.pmccd003.value.replace(/ /g,"");
  }
  UpCase(p.pmccd003);
  p.ccardno.value=p.pmccd003.value.replace(/\+/g,"@");
  p.ccardno.value=p.ccardno.value.replace(/\%/g,"@");
  var serverURL = "../cgi-bin/comweb80.pbl?reportno=76" +
                  "&valdcode="+p.d_pmccd002.value.replace(/ /g,"+") +
                  "&valdcod2="+p.ccardno.value.replace(/&/g,"@")
  var returnValue = RSExecute(serverURL);
  if (returnValue.status!=0){
     p.pmccd003.select();
     p.pmccd003.focus();
     return false;
  }
}

function ChooseType() {
  if (document.UpdateForm.d_pmccd002.value == "") {
    document.UpdateForm.pmccd003.className = "Readonly";
    document.UpdateForm.pmccd004.className = "Readonly";
    document.UpdateForm.pmccd003.readOnly = true;
    document.UpdateForm.pmccd004.readOnly = true;
    document.UpdateForm.pmccd003.value = "";
    document.UpdateForm.pmccd004.value = "";
  } else {
    document.UpdateForm.pmccd003.className = "Mandatory";
//  document.UpdateForm.pmccd004.className = "Mandatory FutureDate";
    document.UpdateForm.pmccd003.readOnly = false;
    document.UpdateForm.pmccd004.readOnly = false;
    document.UpdateForm.pmccd003.value = "";
    document.UpdateForm.pmccd004.value = "";
  }
}

function isDVA() {
  var cTitlePanel  = document.getElementById('DVAColorTitlePanel');
  var cTitle       = document.getElementById('DVAColorTitle');
  var cSelectPanel = document.getElementById('DVAColorSelectPanel');
  var cSelect      = document.getElementById('DVAColorSelect');

  var expireDate   = document.getElementById("pmccd004");
  var colorDefault = document.getElementById("pmccd005");

  var cardType     = document.getElementById('d_pmccd002');
  var index        = cardType.selectedIndex;
  var expiryIndicator = cardType[index].value.substring(6,7); 
                            //expire not mandatory if ind 4 = 1

  
  if(typeof cTitlePanel  != 'undefined' && 
     typeof cTitle       != 'undefined' &&
     typeof cSelect      != 'undefined' &&
     typeof cSelectPanel != 'undefined') {

     if(cardType[index].value.substr(3,1) == "3") {     
       cSelectPanel.innerHTML = cSelect.innerHTML;
       cTitlePanel.innerHTML = cTitle.innerHTML;
       isExpireDateMandatory(expiryIndicator,expireDate);
     }else {
       cSelectPanel.innerHTML = "";
       cTitlePanel.innerHTML = "";
       isExpireDateMandatory(expiryIndicator,expireDate);
       ChooseType();
     }
  }
}

function isExpireDateMandatory(value,obj) {
       if(value == 1){
           obj.className = "FutureDate"
       }else {
           obj.className = "Mandatory FutureDate";
       }
}
function ConcCardHistory() {
    serverURL   = "../cgi-bin/patweb07.pbl?reportno=4&template=9" 
     +"&urnumber="+document.UpdateForm.urnumber.value.replace(/ /g,"+")
     +"&pmccd002="+document.UpdateForm.pmccd002.value
     +"&pmccd004="+document.UpdateForm.pmccd004.value;
    location.href=serverURL
}

function AddDeleteConCards() {
  if (document.getElementById("d_chkdltcc").checked==false) {
      document.UpdateForm.chkdltcc.value="0";
  } else {
      document.UpdateForm.chkdltcc.value="1";
  }
  Redraw();
}

</script>
</head>
%START.OF.PAGE
<body onLoad="PageLoad(event);self.focus();pmccd005.selectedIndex=0;
              ChooseType();InitTable();">
<div id=HeadingSection>
<div id=PatientHeading></div>
<script type="text/javascript">
PatientURN="%PATWEB07.04.003";
PatientVIS="%PATWEB07.04.081";
PatientNAM="%PATWEB07.04.002";
PatientSTA="%PATWEB07.04.086.078";
PatientALT="%PATWEB07.04.084";
PatientSEX="%PATWEB07.04.019";
PatientDOB="%PATWEB07.04.020";
PatientAGE="%PATWEB07.04.021";
PatientLOC="%PATWEB07.04.083";
PatientPRI="%PATWEB07.04.086.066.1";
PatientUNT="%PATWEB07.04.066.0";
DoctorCOD="%PATWEB07.04.082.003";
DoctorNAM="%PATWEB07.04.082.002";
PatientAID="%PATWEB07.04.086.090";
PatientIND="%PATWEB07.04.086.091";
PatientCUR="%PATWEB07.04.086.092";
PatientCLC="%PATWEB07.04.086.093.1";
PatientCLH="%STANDARD.01.017.CL";
PatientHFT="%PATWEB07.04.086.094";
PatientCDM="%PATWEB07.04.086.095";
PatientVDH="%PATWEB07.04.086.099.015";
InsertPatientHeader()
</script>

<div id=PatientMenu></div>
<form name=UpdateForm action="patweb07.pbl" method=post style="margin:0">
<input type=hidden name=reportno value="4">
<input type=hidden name=template value=2>
<input type=hidden name=updttype value="A">
<input type=hidden name=nextpage value="5">
<input type=hidden name=pmccd002>
<input type=hidden name=ccardno>
<input type=hidden name=ctypindc>
<input type=hidden name=chkdltcc>
<input type=hidden name=urnumber value="%PATWEB07.04.003">
<input type=hidden name=currdate value="%STANDARD.01.013">
<input type=hidden name=ptcnhdps value="%PATWEB07.04.243">

<table width=100% border=0 cellpadding=1 cellspacing=1 bgcolor=#cccccc>
  <tr><td width=100% colspan=8 class=HeadingCell align=center>
       Add Concession Cards</td></tr>

  <tr><td class=DataLabel> Card Type </td>
     <td><select name=d_pmccd002 id=d_pmccd002 class=Mandatory title="Card Type"
          onchange='ChooseType();DefaultDate(d_pmccd002,currdate);isDVA();'>
         <option></option>
          %STANDARD.01.007.ct
         </select></td>
      <td class=DataLabel> Card Number </td>
      <td><input type=text name=pmccd003 size=25 maxlength=20 
           class="Mandatory" title="Card Number"
           onblur='ValidateCardType();'></td>

      <td><span id="DVAColorTitlePanel"></span></td>
      <td><span id="DVAColorSelectPanel"></span></td>

      <td class=DataLabel> Card Expiry Date </td>
      <td><input type=text name=pmccd004 id=pmccd004 size=12 maxlength=11
           class="Mandatory FutureDate" title="Card Expiry Date">
          <img notab src="../images/DateLookup.gif" class="Icon"
           alt="Show Calendar" date="UpdateForm.pmccd004"></td>
  </tr>

  <tr><td colspan=8 align=center>
      <input type=button id="pat07add" class="button" value="Add" 
       onclick='tempDisable(this);AddConcessCard();'>
      <span id=InsertCancelButton style="display: none">
      <input type=button class="button NoAutoFocus" value="Cancel"
       title="Cancel - Return to update demographics"
       onclick='PatientLinkTo("patweb89.pbl","1","2",0,0,0);'>
      </span>
      </td>
  </tr>
</table>

<table width=100% border=0 bgcolor=#cccccc>
  <tr><td class=HeadingCell align=left>
      <input type=button class=LargeButton value="Concession Card History"
       title="Concession Card History" onclick="ConcCardHistory();">
      <input type=checkbox name=d_chkdltcc value="0" id="d_chkdltcc"
       title="Include Deleted Concession Cards" 
       onclick="AddDeleteConCards();">Include Deleted Concession Cards
      </td>  
  </tr>
</table>
</form>
</div>

<span id="DVAColorTitle" style="display:none">DVA Card Colour</span>
<span id="DVAColorSelect" style="display:none">
      <select name=pmccd005 id=pmccd005 maxlength=20 class="Mandatory" 
       title="DVA Card Colour">
      <option></option>
       %PATWEB07.04.106.2
      </select>
</span>

<div id="TableLocation"></div>
<script type="text/javascript">
function InitTable() {
 document.title="Concession Cards - %PATWEB07.04.114";
 t = new Table(1,0,2,"100%","center",25,35);
//--------------------------------------------------------------
 t.addColumn("Card Type","String",0,0,"left","","",75)
 t.addColumn("Card Number","String",1,1,"left","","",75)
 t.addColumn("Card Expiry Date","String",2,3,"left","","",75)
 t.addColumn("Card Colour","String",4,4,"left","","",75)
 t.addColumn("Deleted","String",5,5,"left","","",75)
 t.addColumn("  ","String",6,6,"center","","",75)

// Add Rows to Table (Output from Web Server)
 AddTableRows()
 OrderColumn=4;
 AscDsc=1;
 lastOrderColumn=OrderColumn;
 TableOutput(OrderColumn,AscDsc);
}

function AddTableRows() {
      %PATWEB07.04.116
  if (document.UpdateForm.chkdltcc.value=="1") {
      %PATWEB07.04.115
  }
}

function Redraw() {
 InitTable();
}
</script>

<form name=PatientLinks method=get style="margin:0">
<input type=hidden name=reportno value=1>
<input type=hidden name=template value=004>
<input type=hidden name=regexstm value=102>
<input type=hidden name=newstand value=1>
<input type=hidden name=urnumber value="%PATWEB07.04.003">
<input type=hidden name=admissno value="%PATWEB07.04.081">
<input type=hidden name=MenuType value="%PATWEB07.04.088">
<input type=hidden name=cpmiskey value="%PATWEB07.04.210">
</form>

<script type=text/javascript>
  InsertCancelButton.style.display="";
  ExpireCookiePath("ConcessionCardCookie");
</script>
