<meta name="TemplateVersion" content="V12.01.01">
<meta name="TemplateHome" content="standard">
<meta name="HelpFileName" content="NoContextSet.html">
<meta name="CrossBrowser" content="true">
<script type="text/javascript" src="../js/allweb0202004.js"></script>
<script>
function PageLoadExtended(event)
{
PageLoad(event);
checkIfSACClosure();
checkIfPCRMandatory();
checkStatusOfReferral();
checkVINAHMandatoryClosure();
checkPriority();
}

function checkIfPCRMandatory() {
if ((document.UpdateForm.ptcnhdps.value == "3") ||
    (document.UpdateForm.ptcnhdps.value == "1")) {
  document.UpdateForm.alref072.className="Mandatory";
}
}

function checkIfSACClosure()
{
var alreuyn4 = document.getElementById("sacs_master");
var alref006 = document.getElementById("alref006");
var placeHolder = document.getElementById("reasonForClosurePlaceHolder");

if (document.UpdateForm.ptcnhdps.value!="3") {  // Not Victoria
  alref006.className ="Mandatory";
  return;
}
if (alreuyn4.value.replace(/ /g,"") == "Yes")
{
  placeHolder.style.display="none";
  if (alref006)
    alref006.className = "";
}
else
{
  placeHolder.style.display="";

  if (alref006) {
      alref006.className ="Mandatory";
  }
}
}
function getCookieRedirectCanApp() {
if (GetCookieData("RedirectCanApp")!="unknown") {
  document.getElementById('rdcnapck').value='1';
  ExpireCookiePath("RedirectCanApp");
}
}
function CancelButtonRefresh() {
var Template = "";
if(getTop().content) {
  if(getTop().content.TemplateFile) {
     Template=getTop().content.TemplateFile.content.substr(0,13);
   }
}
if(Template.substr(0,6) == "outweb") {
  DFrameCloseRefresh();
} else {
  DFrameClose();
}
}
function FilterCodes() {
var p = document.UpdateForm;

var indc3 = p.deptcode.value.substr(5,1);
var indc4 = p.deptcode.value.substr(6,1);
 
var bIsMH = (indc3 == "A" && indc4 == "M") ? true : false;

if (bIsMH) {  // Mental Health Referral
  // Remove General codes
  filterCatCodeList(p.alref006,"2","G","1");  // Reason For Closure
  filterCatCodeList(p.alref072,"2","G","1");  // Referral To
}
else if (indc3 == "A") {  // General Referral
  // Remove Mental Health codes
  filterCatCodeList(p.alref006,"2","M","1");  // Reason For Closure
  filterCatCodeList(p.alref072,"2","M","1");  // Referral To
}
}
</script>
<script type="text/javascript" >
REFERRALTRANSITIONDATES="%ALLWEB02.02.818";
</script>
</head>
%START.OF.PAGE
<body onload="PageLoadExtended(event);getCookieRedirectCanApp();FilterCodes();">
<span class=DFrameTitleBar>
<img align=right alt="Exit" class="MenuIcon" 
 src="../images/ExitIcon.gif" onclick="DFrameExit()">
Close a Referral    
</span>
<form name=UpdateForm action="allweb02.pbl" method=post style="margin:0"
 id=UpdateForm onsubmit='return validateMandatory(this);'>
<input type=hidden name=reportno value="2">
<input type=hidden name=updatety value="C">
<input type=hidden name=urnumber value="%ALLWEB02.02.003">
<input type=hidden name=admissno value="%ALLWEB02.02.081">
<input type=hidden name=MenuType value="%ALLWEB02.02.088">
<input type=hidden name=deptcode value="%ALLWEB02.02.125.3">
<input type=hidden name=alref036 value="">
<input type=hidden name=alref080 value="">
<input type=hidden name=alref081 value="">
<input type=hidden name=alref082 value="">
<input type=hidden name=alref083 value="">
<input type=hidden name=alref134 value="">
<input type=hidden name=alref138 value="">
<input type=hidden name=alref147 value="">
<input type=hidden name=alref148 value="">
<input type=hidden name=alref149 value="">
<input type=hidden name=dummy value="">
<input type=hidden name=checkappt value="0">
<input type=hidden id=sacs_master name=sacs_master value="%ALLWEB02.02.144">
<input type=hidden name=d_alref164 value="%ALLWEB02.02.199.039">
<input type=hidden name=ptcnhdps value="%STANDARD.01.025.080.250.1.1">
<input type=hidden name=d_alref049 value="%ALLWEB02.02.140.10.1">
<input type=hidden name=fapbookd value="%ALLWEB02.02.199.034">
<input type=hidden name=fapnotfd value="%ALLWEB02.02.199.036">
<input type=hidden name=d_alref075 value="%ALLWEB02.02.140.36.1">
<input type=hidden name=d_alref077 value="%ALLWEB02.02.140.38.1">
<input type=hidden name=d_alref078 value="%ALLWEB02.02.140.39.1">
<input type=hidden name=d_alref094 value="%ALLWEB02.02.155">
<input type=hidden name=d_alref090 value="%ALLWEB02.02.151">
<input type=hidden name=d_alref132 value="%ALLWEB02.02.199.003">
<input type=hidden name=firstenc value="%ALLWEB02.02.244">
<input type=hidden name=linkedop value="%ALLWEB02.02.516">
<input type=hidden name=encountr value="%ALLWEB02.02.230">
<input type=hidden name=reflstat value="%ALLWEB02.02.532">
<input type=hidden name=rdcnapck id=rdcnapck value="">
<input type=hidden name=nextpage id=nextpage value="">
<input type=hidden name=redirect id=redirect value="">
<input type=hidden name=activenc value="%ALLWEB02.02.251">
<input type=hidden name=autocprf id=autocprf value="2">
<input type=hidden name=d_alref027_code value="%ALLWEB02.02.127.3">
<input type=hidden name=d_alref027_desc value="%ALLWEB02.02.127.0"> 

<table align=center cellspacing=0 cellpadding=2 border=0 width=95%>
<tr><td class=DataLabel width=20%>Department</td>
  <td><input readonly type=text value="%ALLWEB02.02.125.0" 
       class=Readonly></td>
    <td class=DataLabel>Entered by</td>
    <td><input readonly type=text class=Readonly  
         value="%ALLWEB02.02.163">
        <input type=hidden name="d_wbsehosp" value="%STANDARD.01.032">
    </td>
</tr>
<tr><td class=DataLabel>Date Closed</td>
 <td class=DataLabel><input type=text name=alref007 value="%ALLWEB02.02.107" 
     title="Date Closed" class="PastDate Mandatory" id=alref007>
    <img src=../images/DateLookup.gif class=Icon date=date1
     align=absmiddle onclick="DateLookupFrame(alref007);">
     Time<input type=text size=6 title="Time" value="%ALLWEB02.02.108" 
        class="Mandatory Time" name=alref008 id=alref008>
    <img src="../images/DateTimeStamp.gif" class=Icon 
      onclick="SetCurrentDateTime(alref007,alref008);">
    <img src="../images/TimeLookup.gif" class=Icon time=time1
      onclick="TimeLookupFrame(alref008);">
    </td>
</tr>
</table>
    
<div id="reasonForClosurePlaceHolder">
<table align=center cellspacing=0 cellpadding=2 border=0 width=95%>
<tr>
    <td class=DataLabel width=20%>%STANDARD.01.017.LL</td>
    <td>
      <select name=alref006 id=alref006 title="%STANDARD.01.017.LL">
        <option></option>
         %ALLWEB02.02.106.2
        </select>
    </td>
</tr>
</table>
</div>

<table  align=center cellspacing=0 cellpadding=2 border=0 width=95%>
<tr><td class=DataLabel>Comment</td>
    <td class=DataLabel>
       <input type=text id="commenty" value="%ALLWEB02.02.233"
       name=commenty size=51 maxlength=50>
    </td>
</tr>

<tr><td class=DataLabel width=20%>%STANDARD.01.017.lG</td>
    <td><select name=alref072 title="%STANDARD.01.017.lG" />
        <option></option>
         %ALLWEB02.02.140.33.2
        </select></td>
</tr>

<tr><td class=DataLabel>Date of Next Review</td>
 <td class=DataLabel><input type=text size=12 name=alref037 
     value="%ALLWEB02.02.137" id=alref037
     title="Date of Next Review" >
    <img src=../images/DateLookup.gif class=Icon date=date1
     align=absmiddle onclick="DateLookupFrame(alref037);">
    <img src="../images/DateTimeStamp.gif" class=Icon
      onclick="SetCurrentDateTime(alref037);">
    </td>
</tr>
</table>

<div id=InsertSACS></div>

<table align=center cellspacing=0 cellpadding=2 border=0 width=95%>
<tr><td colspan=4 align=center><br>
    <input type=button value="Ok" id=btnAdd name=okbutton class="button"
     onclick="tempDisable(this); CloseReferral();" id=okbutton>
    <input type=button Value="Cancel" class="button" 
     onclick="if (document.getElementById('rdcnapck') != null &&
                  document.getElementById('rdcnapck').value == '1') {
                redirectURL = 'outweb02.pbl?reportno=3&template=015' +
                          '&urnumber=' +
                          document.UpdateForm.urnumber.value.replace(/ /g,'+') +
                          '&admissno=' +
                          document.UpdateForm.admissno.value.replace(/ /g,'+');
                redirectTopContent(redirectURL);
              } else {
                CancelButtonRefresh();
              }">
    </td>
</tr>
</table>
</form>
<div id="ShowSACSFields" style="display:none;">
<table align=center cellspacing=0 cellpadding=2 border=0 width=95%>
<tr>
 <td class=DataLabel width=20%>Case End Date</td>
 <td class=DataLabel><input type=text name=alref136 value="%ALLWEB02.02.199.007"
     title="Case End Date" class="Mandatory PastDate">
    <img src=../images/DateLookup.gif class=Icon date=date1
     align=absmiddle onclick="DateLookupFrame(alref136);">
     Time &nbsp;<input type=text size=6 title="Time" value="%ALLWEB02.02.199.008"
        class="Mandatory Time" id=alref137 name=alref137>
    <img src="../images/DateTimeStamp.gif" class=Icon
      onclick="SetCurrentDateTime(alref136,alref137);">
    <img src="../images/TimeLookup.gif" class=Icon time=time1
      onclick="TimeLookupFrame(alref137);">
    </td>
</tr>
</table>
</div>

<script type="text/javascript">
function checkStatusOfReferral() {
 p=document.UpdateForm
//
 var InsertSACS = document.getElementById('InsertSACS');

 InsertSACS.innerHTML="";

 var BulkBill = "%ALLWEB02.02.136";
 if ( BulkBill == "Yes") {
   document.UpdateForm.alref036.value=1;
 }

 ALREUserDefYN1="%ALLWEB02.02.141";
 if ( ALREUserDefYN1 == "Yes") {
   document.UpdateForm.alref080.value=1;
 } else {
   document.UpdateForm.alref080.value=0;
 }
 ALREUserDefYN2="%ALLWEB02.02.142";
 if ( ALREUserDefYN2 == "Yes") {
   document.UpdateForm.alref081.value=1;
 } else {
   document.UpdateForm.alref081.value=0;
 }
 ALREUserDefYN3="%ALLWEB02.02.143";
 if ( ALREUserDefYN3 == "Yes") {
   document.UpdateForm.alref082.value=1;
 } else {
   document.UpdateForm.alref082.value=0;
 }

 var SACSRef="%ALLWEB02.02.144";
 if ( SACSRef == "Yes" ) {
   if (document.UpdateForm.ptcnhdps.value == "3") {  // only Victoria
     InsertSACS.innerHTML = document.getElementById('ShowSACSFields').innerHTML;
   }
   document.UpdateForm.alref083.value = 1;
  } else {
   document.UpdateForm.alref083.value = 0;
  }

 ALREUserDefYN5="%ALLWEB02.02.199.005";
 if ( ALREUserDefYN5 == "Yes") {
   document.UpdateForm.alref134.value=1
 } else {
   document.UpdateForm.alref134.value=0;
 }
 ALREUserDefYN6="%ALLWEB02.02.199.009";
 if ( ALREUserDefYN6 == "Yes") {
   document.UpdateForm.alref138.value=1;
 } else {
   document.UpdateForm.alref138.value=0;
 }
 ALREUserDefYN7="%ALLWEB02.02.199.019";
 if ( ALREUserDefYN7 == "Yes") {
   document.UpdateForm.alref147.value=1;
 } else {
   document.UpdateForm.alref147.value=0;
 }
 ALREUserDefYN8="%ALLWEB02.02.199.020";
 if ( ALREUserDefYN8 == "Yes") {
   document.UpdateForm.alref148.value=1;
 } else {
   document.UpdateForm.alref148.value=0;
 }
 ALREUserDefYN9="%ALLWEB02.02.199.021";
 if ( ALREUserDefYN9 == "Yes") {
   document.UpdateForm.alref149.value=1;
 } else {
   document.UpdateForm.alref149.value=0;
 }
 
 var comment = document.getElementById("commenty");
 Status="%ALLWEB02.02.103"

 if (Status=="Closed    "){
    if (comment)
    {
     comment.readOnly = true;
     comment.className = "Readonly";
    }
    document.UpdateForm.okbutton.disabled = true;
 } else {
    if (comment)
        comment.value = ""; //blank comment if new close
    document.UpdateForm.alref007.value = "%STANDARD.01.015";
    document.UpdateForm.alref008.value = "%STANDARD.01.016";
 }

 // Do not add 'var' to the variables below as they need to stay global.
 VINAH_Ref = (document.UpdateForm.deptcode.value.substr(10,1));
 Parameter_Mand_Main_Health = (document.UpdateForm.deptcode.value.substr(39,1));
 Parameter_Mand_OFAH = (document.UpdateForm.deptcode.value.substr(89,1));
 CloseMaster = "%ALLWEB02.02.520";

 HealthConditionHDPS="%ALLWEB02.02.824";
 HCArray=HealthConditionHDPS.split("|");
 V15CodeSet=false;
 V16CodeSet=false;
 for (var i=0; i < HCArray.length; i++) {
   if(isWhitespace(HCArray[i]) || HCArray[i] == "3000") {
      continue;
   }
   HCArray[i] = HCArray[i] - 0; // Change to a number
   if(!isFinite(HCArray[i])) {
      V15CodeSet=true;
      continue;
   }

   if(parseInt(HCArray[i],10) >= 5000 && parseInt(HCArray[i],10) < 6000) {
      V16CodeSet=true;
   } else {
      V15CodeSet=true;
   }
 }
 SOPPreJuly2021="0";  // SOP Pre July 2021 episode start date - No
 if(VINAH_Ref == "O" && !isWhitespace(document.UpdateForm.d_alref090.value)) {
   if(SetDateYYYYMMDD(document.UpdateForm.d_alref090.value) < 20210701) {
     SOPPreJuly2021="1";  // SOP Pre July 2021 episode start date - Yes
   }
 }
 
 if(!isWhitespace(VINAH_Ref) &&
   (VINAH_Ref!="E" && VINAH_Ref!="L" && VINAH_Ref!="D" && VINAH_Ref!="M") &&
    document.UpdateForm.alref083.value!="1" &&
    document.UpdateForm.activenc.value != "1") {
    alert("Error closing " + MasterReferralDescription +
          " referral - Please Reject/Cancel as no linked contacts exist");
          document.UpdateForm.okbutton.disabled = true;
    return;
 }

 AttendedOPBooking = "%ALLWEB02.02.290";
 if((VINAH_Ref == "H" || VINAH_Ref == "S" || VINAH_Ref == "E" ||
     VINAH_Ref == "L" || VINAH_Ref == "D" || VINAH_Ref == "V" 
     || Parameter_Mand_Main_Health == "1") 
     && document.UpdateForm.alref083.value!="1"
     && document.UpdateForm.ptcnhdps.value=="3"
     && SOPPreJuly2021!="1"){
     mainHealthRecord = "%ALLWEB02.02.808";
     if(mainHealthRecord != 1){
       if(AttendedOPBooking == "1") {
          alert("Outpatient booking has been atteneded\n" + 
                "One main health condition is mandatory prior to closing" +
                " this referral\nPlease add via the update referral page");
       } else {
          alert("The main health condition is mandatory prior to closing" +
                 " this referral\n Please add via the update referral page");
       }
       document.UpdateForm.okbutton.disabled = true;
     }
 }
///////

 if(Parameter_Mand_OFAH == "1" && 
    document.UpdateForm.alref083.value!="1" && 
    document.UpdateForm.ptcnhdps.value=="3") {
    OtherFactorsAffectingHealthRecord = "%ALLWEB02.02.810";
    if(OtherFactorsAffectingHealthRecord != 1){
      alert("The Other Factors Affecting Health field is mandatory prior to " +
            "closing this referral\n Please add via the update referral page");
       document.UpdateForm.okbutton.disabled = true;
    }
 }

//////

 if((VINAH_Ref == "H" || VINAH_Ref == "S" || VINAH_Ref == "E" ||
     VINAH_Ref == "L" || VINAH_Ref == "D" || VINAH_Ref == "V"
     || Parameter_Mand_Main_Health == "1") 
     && document.UpdateForm.alref083.value!="1"
     && document.UpdateForm.ptcnhdps.value=="3"){
     mainHealthRecord = "%ALLWEB02.02.808";
     if(!isWhitespace(document.UpdateForm.d_alref090.value) &&
        mainHealthRecord == 1) {
       if(SetDateYYYYMMDD(document.UpdateForm.d_alref090.value) >= 20210701) {
         if(V15CodeSet==true ) {
           alert("Warning - Possible invalid VINAH 16 main health condition");
         }
       } 
       if(SetDateYYYYMMDD(document.UpdateForm.d_alref090.value) < 20210701) {
         if(V16CodeSet==true ) {
           alert("Warning - Possible invalid VINAH 15 main health condition");
         }
       } 
     }
 }
 if (VINAH_Ref == "P" && document.UpdateForm.alref083.value!="1" &&
     isWhitespace(document.UpdateForm.d_alref049.value)) {
     alert("The death place is mandatory " +
           "prior to closing this referral\n"  +
           "Please add via the update referral page");
     document.UpdateForm.okbutton.disabled = true;
 }
 if ((VINAH_Ref == "S"  || VINAH_Ref == "H" || VINAH_Ref == "O"
     || VINAH_Ref == "P" || VINAH_Ref == "R" || VINAH_Ref == "A" ||
     VINAH_Ref == "E" || VINAH_Ref == "L" || VINAH_Ref == "D" 
     || VINAH_Ref == "V") &&
      document.UpdateForm.alref083.value!="1" ) {
   referralDestination = "%ALLWEB02.02.813"
   if (referralDestination != 1) {
      alert("Warning no referral out details have been " +
            "captured for this referral");
   }
 }
// if (VINAH_Ref == "O" && document.UpdateForm.alref083.value=="1" ) {
//   if (isWhitespace(document.UpdateForm.d_alref094.value)) {
//        alert("The Referral In Clinical Referral Date is a mandatory " +
//              "field prior to closing this referral\n"  +
//              "Please update via the update referral page");
//        document.UpdateForm.okbutton.disabled = true;
//     }
// }
  if ((VINAH_Ref == "O") && document.UpdateForm.alref083.value!="1" ) {
    if(document.UpdateForm.fapbookd.value==""||
       document.UpdateForm.fapnotfd.value==""){
      if(!(Status=="Waiting   " && document.UpdateForm.linkedop.value=="0" &&
         document.UpdateForm.encountr.value!="1")) {
        alert("The First Appointment Booked and Notified of First \n" +
              "Appointment is mandatory prior to closing this referral. \n" +
              "Please add via the update referral page");
        document.UpdateForm.okbutton.disabled = true;
      }
    }
  }
  if (VINAH_Ref == "T" && document.UpdateForm.alref083.value!="1" &&
      REFERRALTRANSITIONDATES == 0) {
     alert("The Transition Date is mandatory prior"+
           " to closing this referral. Please add "+
           "via the update referral page");
     document.UpdateForm.okbutton.disabled = true;
  }
  if (VINAH_Ref == "T" && document.UpdateForm.alref083.value!="0" &&
     document.UpdateForm.firstenc.value == "1") {
     if (isWhitespace(document.UpdateForm.d_alref078.value)) {
        alert("The Accommodation Type is a mandatory field prior to closing" +
              " this referral\n"  +
              "Please update via the update referral page");
        document.UpdateForm.okbutton.disabled = true;
     }
     if (isWhitespace(document.UpdateForm.d_alref132.value)) {
        alert("The Date of Referral Receipt Acknowledgement is a mandatory " +
              "field prior to closing this referral\n"  +
              "Please update via the update referral page");
        document.UpdateForm.okbutton.disabled = true;
     }
  }
  if(!isWhitespace(VINAH_Ref) && (VINAH_Ref == "A"  || VINAH_Ref == "H" ||
      VINAH_Ref == "I" || VINAH_Ref == "O" || VINAH_Ref == "P" ||
      VINAH_Ref == "R" || VINAH_Ref == "S" || VINAH_Ref == "T" ||
      VINAH_Ref == "V" || VINAH_Ref == "C" || VINAH_Ref == "F") &&
      Status=="Waiting   " && document.UpdateForm.activenc.value == "1" &&
      document.UpdateForm.alref083.value!="1"){
       alert("The Referral Status must be 'Active' prior to closing this " +
             "refrerral.\n" +
             "Please update Referral Status.");
               document.UpdateForm.okbutton.disabled = true;
               return;
  }
  if(!isWhitespace(VINAH_Ref) && (VINAH_Ref == "D" ||
      VINAH_Ref == "E" || VINAH_Ref == "L" || VINAH_Ref == "M") &&
      document.UpdateForm.ptcnhdps.value == "3" &&
      Status=="Waiting   " && document.UpdateForm.alref083.value!="1"){
       alert("The Referral Status must be 'Active' prior to closing this " +
             "refrerral.\n" +
             "Please update Referral Status.");
               document.UpdateForm.okbutton.disabled = true;
               return;
  }
}
function checkPriority() {
var p = document.UpdateForm;

var indc3 = p.deptcode.value.substr(5,1);
var indc4 = p.deptcode.value.substr(6,1);

var bIsMH = (indc3 == "A" && indc4 == "M") ? true : false;

var rejGenRef = ( p.d_alref027_code.value.substr(13,1) == "G") ? true : false; 
var rejMenHlt = ( p.d_alref027_code.value.substr(13,1) == "M") ? true : false; 
var rejGenMen = ( p.d_alref027_code.value.substr(13,1) == "A") ? true : false; 

if (rejMenHlt && bIsMH) {  // Mental Health Referral
  // Remove Mental Health codes
 alert("Referral Priority Code = " +  trim(p.d_alref027_desc.value) + 
            "\nPlease change priority before closing the referral");
 document.UpdateForm.okbutton.disabled = true;
    }
else if (rejGenRef && !bIsMH) {  // General Referral
  // Remove General codes
 alert("Referral Priority Code = " +  trim(p.d_alref027_desc.value) + 
            "\nPlease change priority before closing the referral");
 document.UpdateForm.okbutton.disabled = true;
  }
else if (rejGenMen) {  // General or Mental 
  // Remove Mental Health OR General codes
 alert("Referral Priority Code = " +  trim(p.d_alref027_desc.value) + 
            "\nPlease change priority before closing the referral");
 document.UpdateForm.okbutton.disabled = true;
  }
}
</script>
