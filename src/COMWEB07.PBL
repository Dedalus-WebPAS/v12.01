.----------------------------------------------------------------------
. Program       : COMWEB07
.
. Function      : DHS Medicare Polling Server
.
. Modifications :
.
.----------------------------------------------------------------------
. V11.04.01   30/11/2023  Peter Vela       TSK 0935874
.             Recompiled for PMSIHEFD - Added indexes 4,5,6 and added Exception
.             Description
. V11.03.02   17/10/2023  Peter Vela       TSK 0935874
.             Added parameter check for pmsihiaf
. V11.03.01   10/10/2023  Peter Vela    TSK 0935874
.             Recompiled for PMSIHIFD - Fixed IO calls
. V11.02.01   09/02/2022  Thanh T       TSK 0905641
.             Recompiled as OUTHEDFD changes
. V10.04.01   23/02/2014  Ebon Clements    CAR 291974
.             Added lookup HPI-I and HPI-O
. V10.04.00   13/02/2014  Ebon Clements    CAR 291974
.             Created program
.----------------------------------------------------------------------
.
          INC       IBAWEBDF
.
          INC       OUTCLIFD/INC
          INC       OUTHEDFD/INC
          INC       OUTSITFD/INC
          INC       PATCONFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PMSAIDFD/INC
          INC       PMSCCDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSIERFD/INC
          INC       PMSIHEFD/INC
          INC       PMSIHPFD/INC
          INC       PMSIHUFD/INC
          INC       PMSIHIFD/INC
          INC       PMSIPLFD/INC
          INC       PMSIRQFD/INC
          INC       PMSIRSFD/INC
          INC       PMSPX2FD/INC
          INC       TFILEVAR/INC
.
PARMFILE  FILE      ASCII, FIXED=256
PARMNAME  DIM       26
PARMVALU  DIM       127
.
TAGNUMBR  FORM      2                  * Tag number for branch
NUMBVARS  FORM      "37"               * Number of Tags
RESNAM01  INIT      "ResponseType             :"
RESNAM02  INIT      "ResponseID               :"
RESNAM03  INIT      "ResponseSurname          :"
RESNAM04  INIT      "ResponseGiven1           :" 
RESNAM05  INIT      "ResponseGiven2           :"
RESNAM06  INIT      "ResponseDOB              :"
RESNAM07  INIT      "ResponseGender           :"
RESNAM08  INIT      "ResponseMedicareNumber   :"
RESNAM09  INIT      "ResponseMedicareReference:"
RESNAM10  INIT      "ResponseMedicareExpiry   :"
RESNAM11  INIT      "ResponseDVA              :"
RESNAM12  INIT      "ResponseIHI              :"
RESNAM13  INIT      "ResponseAddress1         :"
RESNAM14  INIT      "ResponseAddress2         :"
RESNAM15  INIT      "ResponseAddress3         :"
RESNAM16  INIT      "ResponseAddress4         :"
RESNAM17  INIT      "ResponsePostCode         :"
RESNAM18  INIT      "ResponseHPII             :"
RESNAM19  INIT      "ResponseSurgeryAddress1  :"
RESNAM20  INIT      "ResponseSurgeryAddress2  :"
RESNAM21  INIT      "ResponseSurgeryAddress3  :"
RESNAM22  INIT      "ResponseSurgeryAddress4  :"
RESNAM23  INIT      "ResponseSurgeryPostCode  :"
RESNAM24  INIT      "ResponseOrganisationName :"
RESNAM25  INIT      "ResponseServiceType      :"
RESNAM26  INIT      "ResponseProviderType     :"
RESNAM27  INIT      "ResponseHPIO             :"
RESNAM28  INIT      "ResponseOrganisationUnit :"
RESNAM29  INIT      "ResponseIHIStatus        :"
RESNAM30  INIT      "ResponseIHIRecStatus     :"
RESNAM31  INIT      "ResponseStatusCode       :"
RESNAM32  INIT      "ResponseStatusDesc       :"
RESNAM33  INIT      "ResponseSystemVersion    :"
RESNAM34  INIT      "ResponseSystemName       :"
RESNAM35  INIT      "ResponseSystemVendor     :"
RESNAM36  INIT      "ResponseSystemOrg        :"
RESNAM37  INIT      "ResponseUID              :"
.
RESVAL01  DIM       2                  * Response Type
RESVAL02  DIM       10                 * Response ID  
RESVAL03  DIM       20                 * Response Surname
RESVAL04  DIM       40                 * Reposnse Given Name 1
RESVAL05  DIM       40                 * Reposnse Given Name 2
RESVAL06  DIM       8                  * Reposnse DOB
RESVAL07  DIM       1                  * Reposnse Gender
RESVAL08  DIM       10                 * Response Medicare Number
RESVAL09  DIM       2                  * Reponse Medicre Reference
RESVAL10  DIM       8                  * Reposnse Medicare Expiry
RESVAL11  DIM       20                 * Reposnse DVA
RESVAL12  DIM       20                 * Response IHI
RESVAL13  DIM       35                 * Response Address 1
RESVAL14  DIM       35                 * Response Address 2
RESVAL15  DIM       35                 * Response Address 3
RESVAL16  DIM       35                 * Responce Address 4
RESVAL17  DIM       8                  * Response Post Code
RESVAL18  DIM       20                 * Response HPI-I     
RESVAL19  DIM       35                 * Response Surgery Address 1
RESVAL20  DIM       35                 * Response Surgery Address 2
RESVAL21  DIM       35                 * Response Surgery Address 3
RESVAL22  DIM       35                 * Response Surgery Address 4
RESVAL23  DIM       8                  * Response SurgeryPost Code 
RESVAL24  DIM       40                 * Response Organisation Name
RESVAL25  DIM       10                 * Response Service Type
RESVAL26  DIM       10                 * Response Provider Type
RESVAL27  DIM       20                 * Response HPI-O
RESVAL28  DIM       20                 * Response Organisation Unit
RESVAL29  DIM       1                  * Response Activation Status
RESVAL30  DIM       1                  * Response Verification Status
RESVAL31  DIM       4                  * Response Status Code
RESVAL32  DIM       127                * Response Status Code Description
RESVAL33  DIM       10                 * Response System Version
RESVAL34  DIM       2                  * Response System Name 1 = HI
RESVAL35  DIM       20                 * Response System Vendor 
RESVAL36  DIM       20                 * Response System Organisation 
RESVAL37  DIM       127                * Response UID 
.
. ----- Program Variables -----
CMDLINE   DIM       127
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
DIM20     DIM       20
DVANUMBR  DIM       20                 * DVA Card Number
IHINUMBR  DIM       20                 * IHI Number
IHICATAI  DIM       3                  * Cat AI Code for an IHI Number
.
.
.----------------------------------------------------------------------
PRGID     INIT      "COMWEB07"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "DHS Medicare Polling Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
.
          CALL      INIT0000       * Open Files
.
MAIN0000  COMMIT                   * Match BEGIN in WEBINT00 for Transactions
.
          BEGIN
.
          DISPLAY   *W10
.
          MATCH     "0",PTCNUNET
          GOTO      MAIN0000 IF EQUAL
.
          PACK      KEY10,SP70
          CALL      RSPMIPL1
MAIN1000  CALL      RKPMIPL1
          BRANCH    OVRCD,MAIN0000
.
          MOVE      PMILUNIQ,KEY10
          CALL      RLPMIPL1
          BRANCH    OVRCD,MAIN0000,MAIN1000
.
          PACK      KEY10,PMILUSID,SP70     * Read request user id
          CALL      RDWBSE1
          BRANCH    OVRCD,MAIN9000
.
          MOVE      PMILRTYP,F2
          BRANCH    F2,MAIN1100:            * IHI lookup
                       MAIN1200:            * HPI-I lookup - HCP
                       MAIN1300:            * HPI-O lookup - Hospital
                       MAIN1400:            * HPI-O lookup - Practice
                       MAIN1500:            * HPI-O lookup - Hospital Unit
                       MAIN1600             * HPI-O lookup - OP Clinic
          GOTO      MAIN9000
.
MAIN1100  CALL      LIHI0000                * Lookup IHI
          GOTO      MAIN9000
.
MAIN1200  CALL      LHPI0000                * Lookup HPI-I
          GOTO      MAIN9000
.
MAIN1300  CALL      LHOS0000                * Lookup HPI-O - Hospital
          GOTO      MAIN9000
.
MAIN1400  CALL      LPRA0000                * Lookup HPI-O - Practice
          GOTO      MAIN9000
.
MAIN1500  CALL      LUNT0000                * Lookup HPI-O - Hospital Unit
          GOTO      MAIN9000
.
MAIN1600  CALL      LOUT0000                * Lookup HPI-O - OP Clinic
          GOTO      MAIN9000
.
MAIN9000  MOVE      PMILUNIQ,KEY10
          CALL      DEPMIPL1
.
          PACK      KEY10,SP70
          CALL      RSPMIPL1
.
          COMMIT
.
          BEGIN
.
          GOTO      MAIN1000
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATCODE1,"patcodes"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSAIDA2,"pmsaidaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSIERA1,"pmsieraf"
          OPEN      PMSIHEA1,"pmsiheaf"
          OPEN      PMSIRQA1,"pmsirqaf"
          OPEN      PMSIRSA1,"pmsirsaf"
          OPEN      PMSIHPA1,"pmsihpaf"
          OPEN      PMSIHUA1,"pmsihuaf"
          OPEN      PMSIPLA1,"pmsiplaf"
          OPEN      PMSPX2A1,"pmspx2af"
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      "out",CFILEPRE       * Save Current File Prefix
          CALL      OPNOUT00
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND20;*158,PTCNUNET
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"
          ENDIF
.
          CALL      TFILENAM                * Get parameter temp file name
          MOVE      TFILNAME,FILENAME
.
INIT9999  RETURN
+
.------------------------------------------------------------
. OPEN outpatient files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME
.
OPNOUT99  RETURN
+
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  RETURN
.------------------------------------------------------------
. Process Fields
.------------------------------------------------------------
PROFLD00  RETURN
.------------------------------------------------------------
. Lookup IHI Number
.------------------------------------------------------------
LIHI0000  CALL      CREA0000           * Create parameter file
.
          CALL      WIHI0000           * Write IHI request to paramters file
          BRANCH    EXIT,LIHI9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LIHI9000
.
LIHI1000  CALL      RRES0000           * Read response vars
          CALL      PIHI0000           * Process IHI reposnse
.
LIHI9000  CALL      KILL0000           * Delete parameter file
.
LIHI9999  RETURN
.
.----------------------------------------------------------------------
. Create parameter file     
.----------------------------------------------------------------------
CREA0000  CLOSE     PARMFILE,DELETE      * Delete parameter file
          PREP      PARMFILE,FILENAME    * Create parameter file
.
CREA9999  RETURN
.
.----------------------------------------------------------------------
. Write IHI Request to parameters file
.----------------------------------------------------------------------
WIHI0000  PACK      KEY8,PMILCODE,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WIHI9000
.
          PACK      KEY8,PURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,WIHI9000
.
          MOVE      SP70,DVANUMBR
.
          PACK      KEY19,PURNO,SP70         * DVA
          CALL      RSPMCCD1
WIHI1000  CALL      RKPMCCD1
          BRANCH    OVRCD,WIHI2000
.
          MATCH     PURNO,PMCDURNO
          GOTO      WIHI2000 IF NOT EQUAL
.
          MOVE      "ct",DIM2
          PACK      KEY5,DIM2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WIHI1000
.
          MATCH     "3",TCINDC1
          GOTO      WIHI1000 IF NOT EQUAL
.
          MOVE      PMCDCNUM,DVANUMBR           * DVA Card Number
.
WIHI2000  MOVE      SP70,IHINUMBR
.
          PACK      KEY31,PURNO,SP70         * IHI
          CALL      RSPMAID1
WIHI2100  CALL      RKPMAID1
          BRANCH    OVRCD,WIHI3000
.
          MATCH     PURNO,PMAIURNO
          GOTO      WIHI3000 IF NOT EQUAL
.
          MOVE      "AI",DIM2
          PACK      KEY5,DIM2,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WIHI2100
.
          MATCH     "I",TCINDC2
          GOTO      WIHI2100 IF NOT EQUAL
.
          MOVE      PMAIALID,IHINUMBR            * IHI Number
          SQUEEZE   IHINUMBR

WIHI3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",PMILCODE
          WRITE     PARMFILE,SEQ;"RequestSurname           :",PTMASNAM
          WRITE     PARMFILE,SEQ;"RequestGiven1            :",PMPXFNAM
          WRITE     PARMFILE,SEQ;"RequestGiven2            :",PMPXSNAM
          WRITE     PARMFILE,SEQ;"RequestDOB               :",PBDATE
          WRITE     PARMFILE,SEQ;"RequestGender            :",PSEX
          WRITE     PARMFILE,SEQ;"RequestMedicareNumber    :",PMEDI
          WRITE     PARMFILE,SEQ;"RequestMedicareReference :",PTMXMCCD
          WRITE     PARMFILE,SEQ;"RequestMedicareExpiry    :",PMPXMEDC
          WRITE     PARMFILE,SEQ;"RequestDVA               :",DVANUMBR
          WRITE     PARMFILE,SEQ;"RequestIHI               :",IHINUMBR
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PADD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PADD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PSUBRB
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PADD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PPOST
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PTMASNAM,PMIQSURN        * Request Surname
          MOVE      PMPXFNAM,PMIQFNAM        * Request First Name
          MOVE      PMPXSNAM,PMIQSNAM        * Request Second Name
          MOVE      PBDATE,PMIQBDAT          * Request Date of Birth
          MOVE      PSEX,PMIQPSEX            * Request Sex 
          MOVE      PMEDI,PMIQMEDI           * Request Medicare Number
          MOVE      PTMXMCCD,PMIQMCCD        * Request Medicare Code
          MOVE      PMPXMEDC,PMIQMEDV        * Request Medicare Valid To Date
          MOVE      DVANUMBR,PMIQDVAN        * Request DVA Number
          MOVE      IHINUMBR,PMIQIDEN        * Request Identifier
          MOVE      PADD1,PMIQADD1           * Request Address Line 1
          MOVE      PADD2,PMIQADD2           * Request Address Line 2
          MOVE      PSUBRB,PMIQADD3          * Request Address Line 3
          MOVE      PADD4,PMIQADD4           * Request Address Line 4
          MOVE      PPOST,PMIQPOST           * Request Post Code
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WIHI9999
.
WIHI9000  MOVE      ONE,EXIT   
          GOTO      WIHI9999
.
WIHI9999  RETURN
.
.----------------------------------------------------------------------
. Process IHI Response
.----------------------------------------------------------------------
PIHI0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4        
.
          COMPARE   ZERO,F4
          GOTO      PIHI9000 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 01 - IHI Request
          GOTO      PIHI9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * U/R Number
          GOTO      PIHI9999 IF NOT EQUAL
.
          PACK      KEY8,PMILCODE,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PIHI9999
.
          PACK      KEY8,PURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PIHI9999
.
          CALL      CIHI0000                     * Check IHI edits
          BRANCH    EXIT,PIHI9999
.
          CALL      CLPMSIHI           * Clear PMSIHIFD vars
.
          MOVE      PURNO,PMIHURNO     * U/R Number
          MOVE      RESVAL12,PMIHIHIN  * IHI Number
          MOVE      PMAIVSTA,PMIHVSTA  * IHI Verification Status
          MOVE      PMAIASTA,PMIHASTA  * IHI Activation Status
.
          PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,SP70
          CALL      RDPMIHI1           * Re load current details
.
          MOVE      PMAIADAT,PMIHADAT  * Date of Assignment (CCYYMMDD)
          MOVE      PMAIATIM,PMIHATIM  * Time of Assignment (HH:MM:SS)
          MOVE      SP70,PMIHSTAT      * Status
          MOVE      SP70,PMIHOURN      * Old U/R Number
          MOVE      RESVAL34,PMIHIHIS  * IHI Source
          MOVE      RESVAL33,PMIHHISV  * HI Service Version Number
          MOVE      RESVAL37,PMIHMESI  * HI Service Message ID
          MOVE      SP70,PMIHBATI      * Batch ID
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,PMIHINTB      * Request Initiated By
          ELSE
            MOVE      SP70,PMIHINTB          * Request Initiated By
          ENDIF
.
          MOVE      SP70,PMIHNUID      * HPI-I User
          MOVE      SP70,PMIHSPAR      * Spare
          CALL      IBACLOCK
.
          PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,SP70
          CALL      RAPMIHI1
          IF        OVRCD=1
            PACK      PMIHCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMIHCDAT            * Created Date (CCYYMMDD)
            MOVE      CTIMEIS,PMIHCTIM  * Created Time (HH:MM:SS)
            MOVE      WBSEUID,PMIHCUID  * Created By (websecaf)
            CALL      WRPMIHI1
          ELSE
            PACK      PMIHUDAT,CCC,CYY,CMM,CDD    * Updated date (CCYYMMDD)
            REP       " 0",PMIHUDAT
            MOVE      CTIMEIS,PMIHUTIM  * Updated Time (HH:MM:SS)
            MOVE      WBSEUID,PMIHUUID  * Updated By (websecaf)
            CALL      UPPMIHI1
          ENDIF
.
          GOTO      PIHI9999
.
. Write error message  
.
PIHI9000  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,RESVAL02,SP70   * U/R Number
          PACK      PMIRINUM,RESVAL12,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PIHI9999  RETURN
.
.----------------------------------------------------------------------
. Find the IHI cat AI code and see if U/R already has an active IHI
.----------------------------------------------------------------------
CIHI0000  PACK      KEY5,ANSA,ANSI,SP70
          CALL      RDSCODE1
CIHI1000  CALL      RDKCODE1
          BRANCH    OVRCD,CIHI9000
.
          MATCH     "AI",TCODE              * Cat AI - Alternate id
          GOTO      CIHI9000 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV           * Skip inactive codes
          GOTO      CIHI1000 IF EQUAL
.
          MATCH     ANSI,TCINDC2            * IHI Code
          GOTO      CIHI1000 IF NOT EQUAL
.
          MOVE      ACODE,IHICATAI          * Save cat AI code for an IHI number
.
. Check if U/R already has an active IHI
.
CIHI2000  PACK      KEY31,PURNO,IHICATAI,SP70
          CALL      RSPMAID1
CIHI2100  CALL      RKPMAID1
          BRANCH    OVRCD,CIHI3000
.
          MATCH     PURNO,PMAIURNO          * Same U/R
          GOTO      CIHI3000 IF NOT EQUAL
.
          MATCH     IHICATAI,PMAITYPE       * Alternate Id
          GOTO      CIHI3000 IF NOT EQUAL
.
          MATCH     "1",PMAIASTA            * IHI Activation Status
          GOTO      CIHI2100 IF NOT EQUAL
.
          MOVE      RESVAL12,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI2100 IF EQUAL
.
          GOTO      CIHI8000                * Error already has an active IHI
.
. Check if IHI is used by another U/R
.
CIHI3000  MOVE      RESVAL12,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
.
          PACK      KEY31,DIM20,SP70
          CALL      RSPMAID2
CIHI3100  CALL      RKPMAID2
          BRANCH    OVRCD,CIHI4000
.
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI4000 IF NOT EQUAL
.
          MATCH     PURNO,PMAIURNO          * Skip if U/R Number matches
          GOTO      CIHI3100 IF EQUAL
.
          MATCH     "1",PMAIASTA            * IHI Activation Status
          GOTO      CIHI3100 IF NOT EQUAL
.
          GOTO      CIHI8100                * Error IHI used by another U/R
.
CIHI4000  COMPARE   ONE,PCEASE              * Deceased
          GOTO      CIHI5000 IF NOT EQUAL
.
. Check the activation status has not changed for a deceased U/R
. 
          PACK      KEY31,PURNO,IHICATAI,SP70
          CALL      RSPMAID1
CIHI4100  CALL      RKPMAID1
          BRANCH    OVRCD,CIHI5000
.
          MATCH     PURNO,PMAIURNO          * Same U/R
          GOTO      CIHI5000 IF NOT EQUAL
.
          MATCH     IHICATAI,PMAITYPE       * Alternate Id
          GOTO      CIHI5000 IF NOT EQUAL
.
          MOVE      RESVAL12,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
          MATCH     PMAIALID,DIM20          * IHI Number matches
          GOTO      CIHI4100 IF NOT EQUAL
.
          MATCH     RESVAL29,PMAIASTA       * Activation status has not
          GOTO      CIHI5000 IF EQUAL       * changed
.
          MATCH     "1",RESVAL29            * Write error deceased patient
          GOTO      CIHI8200 IF EQUAL       * had an active IHI returned
.
          MATCH     "2",RESVAL29            * Deceased so proceed with   
          GOTO      CIHI8200 IF EQUAL       * update
.
          MATCH     "3",RESVAL29            * Retired, update IHI number
          GOTO      CIHI5000 IF EQUAL
.
          MATCH     "4",RESVAL29            * Write error deceased patient
          GOTO      CIHI8300 IF EQUAL       * had a retired IHI returned
.
. Save or Update the IHI number in the alternate id table
.
CIHI5000  MOVE      PURNO,PMAIURNO     * UR Number
          MOVE      IHICATAI,PMAITYPE  * Alternate ID Type (Cat AI)
          MOVE      RESVAL12,DIM20          * Right justify IHI
          RJUSTIFY  DIM20
          MOVE      DIM20,PMAIALID     * Alternate ID
          MOVE      ZERO,PMAIDISU      * Display instead of UR 1=Yes
          MOVE      SP70,PMAIHOSP  * Hospital Code
          MOVE      SP70,PMAIRDAT  * Registration date (ccyymmdd)
.
          CALL      IBACLOCK
.
          MOVE      RESVAL30,PMAIVSTA  * IHI Verification Status
          MOVE      RESVAL29,PMAIASTA  * IHI Activation Status
.
          PACK      PMAIADAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIADAT   * IHI Date of Assignment (CCYYMMDD)
          MOVE      CTIMEIS,PMAIATIM  * IHI Time of Assignment (HH:MM:SS)
          MOVE      RESVAL03,PMAISURN  * IHI Surname
          MOVE      RESVAL04,PMAIGIVN  * Given Name
          MOVE      SP70,PMAISPAR      * Spare
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD=1
            PACK      PMAICRDT,CCC,CYY,CMM,CDD
            REP       " 0",PMAICRDT      * Date Created
            MOVE      CTIMEIS,PMAICRTM   * Time Created
            MOVE      PMILUSID,PMAICRUD  * User ID Created
            CALL      WRPMAID1         * Write new IHI Number to alternate ID
          ELSE
            PACK      PMAIUPDT,CCC,CYY,CMM,CDD
            REP       " 0",PMAIUPDT      * Date Updated
            MOVE      CTIMEIS,PMAIUPTM   * Time Updated
            MOVE      PMILUSID,PMAIUPUD  * User ID Updated
            CALL      UPPMAID1         * Update IHI Number in alternate ID
          ENDIF
.
          IF        PCEASE=1
            MATCH     "3",RESVAL29            * Write error deceased patient
            GOTO      CIHI8400 IF EQUAL       * returned a retired IHI
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CIHI9999
.
. Write error U/R Already has an active IHI
.
CIHI8000  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,RESVAL12,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "U/R Already has an active IHI",PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
.   *** Write error IHI number already used by another U/R
.
CIHI8100  MOVE      PURNO,PMIEURNO      * U/R Number
          MOVE      RESVAL12,PMIEIHIN   * IHI Number
          MOVE      PMAIURNO,PMIEOTUR   * Other U/R IHI Number Combination
          MOVE      PMAIADAT,PMIEADAT   * Date of Assignment (CCYYMMDD)
          MOVE      PMAIATIM,PMIEATIM   * Time of Assignment (HH:MM:SS)
          MOVE      PMAIVSTA,PMIEVSTA   * IHI Verification Status
          MOVE      PMAIASTA,PMIEASTA   * IHI Activation Status
          MOVE      RESVAL34,PMIEIHIS   * IHI Source
          MOVE      RESVAL33,PMIEHISV   * HI Service Version Number
          MOVE      RESVAL37,PMIEMESI   * HI Service Message ID
          CALL      IBACLOCK
          PACK      PMIECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIECDAT            * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIECTIM   * Created Time (HH:MM:SS)
          MOVE      WBSEUID,PMIECUID   * Created By (websecaf)
          PACK      PMIEUDAT,CCC,CYY,CMM,CDD    * Updated date (CCYYMMDD)
          REP       " 0",PMIEUDAT
          MOVE      CTIMEIS,PMIEUTIM   * Updated Time (HH:MM:SS)
          MOVE      WBSEUID,PMIEUUID   * Updated By (websecaf)
          MOVE      SP70,PMIESPAR       * Spare
.
          PACK      KEY72,PMIEURNO,PMIEIHIN,PMIEOTUR,PMIEADAT,PMIEATIM,SP70
          CALL      RAPMIHE1
          IF        OVRCD=1
            CALL      WRPMIHE1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had an active IHI returned
.
CIHI8200  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,RESVAL12,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had an active IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had a expired IHI returned
.
CIHI8300  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,RESVAL12,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had a expired IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
. Write error deceased patient had a retired IHI returned
.
CIHI8400  MOVE      "01",PMIRRTYP            * IHI Request
          PACK      PMIRCODE,PURNO,SP70      * U/R Number
          PACK      PMIRINUM,RESVAL12,SP70   * IHI Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD             * Error Code
          MOVE      "Deceased patient had a retired IHI returned",PMIREMES
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
          GOTO      CIHI9000
.
CIHI9000  MOVE      ONE,EXIT
          GOTO      CIHI9999
.
CIHI9999  RETURN
.
.----------------------------------------------------------------------
. Delete parameter file
.----------------------------------------------------------------------
KILL0000  CLOSE     PARMFILE,DELETE      * Delete parameter file
.
KILL9999  RETURN
.
.----------------------------------------------------------------------
. Execute comweb07.us1 
.----------------------------------------------------------------------
XCMD0000  CLEAR     CMDLINE
          APPEND    "comweb07.us1 ",CMDLINE
          APPEND    FILENAME,CMDLINE
          APPEND    ".txt",CMDLINE
          APPEND    SP1,CMDLINE
          RESET     CMDLINE
.
. Execute command line DHS Medicare identifier lookup
.
          EXECUTE   CMDLINE,TASKID   * comweb07.us1 filename.txt
          MATCH     "0",TASKID
          GOTO      XCMD9000 IF NOT EQUAL
.
. Read file to collect response details
.
          TRAP      OVERCOND IF IO
          OPEN      PARMFILE,FILENAME            * open response file
          TRAPCLR   IO
          BRANCH    OVRCD,XCMD9000
.
          MOVE      ZERO,EXIT
          GOTO      XCMD9999
.
XCMD9000  MOVE      ONE,EXIT
          GOTO      XCMD9999
.
XCMD9999  RETURN
.----------------------------------------------------------------------
. Read response var values
.----------------------------------------------------------------------
RRES0000  CALL      CRES0000          * Clear response vars
.
          OPEN      PARMFILE,FILENAME * Reposition to start of file
.
RRES1000  READ      PARMFILE,SEQ;PARMNAME,PARMVALU    * Loop response file
          GOTO      RRES9000 IF OVER      
.
          MATCH     "Response",PARMNAME               * Look for first 
          GOTO      RRES1000 IF NOT EQUAL             * response variable
.
          PACK      PARMVALU,PARMVALU,SP70,SP70
.
          MOVE      ZERO,TAGNUMBR
          SEARCH    PARMNAME,RESNAM01,NUMBVARS,TAGNUMBR
.
          STORE     PARMVALU,TAGNUMBR,RESVAL01,RESVAL02,RESVAL03,RESVAL04:
                    RESVAL05,RESVAL06,RESVAL07,RESVAL08,RESVAL09,RESVAL10:
                    RESVAL11,RESVAL12,RESVAL13,RESVAL14,RESVAL15,RESVAL16:
                    RESVAL17,RESVAL18,RESVAL19,RESVAL20,RESVAL21,RESVAL22:
                    RESVAL23,RESVAL24,RESVAL25,RESVAL26,RESVAL27,RESVAL28:
                    RESVAL29,RESVAL30,RESVAL31,RESVAL32,RESVAL33,RESVAL34:
                    RESVAL35,RESVAL36,RESVAL37
.
. Format any response variables
.
          IF        TAGNUMBR=29
            MATCH     "Active",PARMVALU
            IF        @EQUAL
              MOVE      "1",RESVAL29        * Activation status
            ENDIF
.
            MATCH     "Deceased",PARMVALU
            IF        @EQUAL
              MOVE      "2",RESVAL29        * Activation status
            ENDIF
.
            MATCH     "Retired",PARMVALU
            IF        @EQUAL
              MOVE      "3",RESVAL29        * Activation status
            ENDIF
.
            MATCH     "Expired",PARMVALU
            IF        @EQUAL
              MOVE      "4",RESVAL29        * Activation status
            ENDIF
.
            MATCH     "Resolved",PARMVALU
            IF        @EQUAL
              MOVE      "5",RESVAL29        * Activation status
            ENDIF

          ENDIF
.
          IF        TAGNUMBR=30
            MATCH     "Verified",PARMVALU
            IF        @EQUAL
              MOVE      "1",RESVAL30        * Verification status
            ENDIF
          ENDIF
.
          IF        TAGNUMBR=34
            MATCH     "HI",PARMVALU
            IF        @EQUAL
              MOVE      "1",RESVAL34
            ENDIF
          ENDIF
          GOTO      RRES1000 
.
. Save request response values to request response file
.
RRES9000  MOVE      RESVAL01,PMISRTYP     * Request Type
          MOVE      RESVAL02,PMISCODE     * Request Code
.
          CALL      IBACLOCK
          PACK      PMISRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMISRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMISRTIM         * Request Time (HH:MM:SS)_
.
          MOVE      PMILUSID,PMISRUID     * Request User Id (websecaf)
          MOVE      RESVAL03,PMISSURN     * Patient Surname
          MOVE      RESVAL04,PMISFNAM     * Patient First Name
          MOVE      RESVAL05,PMISSNAM     * Patient Second Name
          MOVE      RESVAL06,PMISBDAT     * Date of Birth (CCYYMMDD)
          MOVE      RESVAL07,PMISPSEX     * Patients Sex
          MOVE      RESVAL08,PMISMEDI     * Medicare Number
          MOVE      RESVAL09,PMISMCCD     * Medicare Code
          MOVE      RESVAL10,PMISMEDV     * Medicare Valid To Date (CCYYMMDD)
          MOVE      RESVAL11,PMISDVAN     * DVA Number
          MOVE      RESVAL12,PMISIHIN     * DHS Identifier
          MOVE      RESVAL13,PMISADD1     * Address Line 1
          MOVE      RESVAL14,PMISADD2     * Address Line 2
          MOVE      RESVAL15,PMISADD3     * Address Line 3
          MOVE      RESVAL16,PMISADD4     * Address Line 4
          MOVE      RESVAL17,PMISPOST     * Post Code
          MOVE      RESVAL18,PMISHPII     * HPI-I
          MOVE      RESVAL19,PMISSAD1     * Surgery Address Line 1
          MOVE      RESVAL20,PMISSAD2     * Surgery Address Line 2
          MOVE      RESVAL21,PMISSAD3     * Surgery Address Line 3
          MOVE      RESVAL22,PMISSAD4     * Surgery Address Line 4
          MOVE      RESVAL23,PMISSPST     * Surgery Post Code
          MOVE      RESVAL26,PMISPTYP     * Provider Type
          MOVE      RESVAL24,PMISNAME     * Organisation Name
          MOVE      RESVAL27,PMISHPIO     * HPI-O
          MOVE      RESVAL25,PMISSTYP     * Service Type
          MOVE      RESVAL28,PMISUNIT     * Organisation Unit
          MOVE      RESVAL30,PMISVSTA     * Verification Status
          MOVE      RESVAL29,PMISASTA     * Activation Status
          MOVE      RESVAL31,PMISRSCD     * Response Status Code
          MOVE      RESVAL32,PMISRSDE     * Response Status Description
          MOVE      RESVAL33,PMISRVER     * System Version
          PACK      PMISSPAR,SP70,SP70    * Spare
.
          PACK      KEY68,PMISRTYP,PMISCODE,PMISRDAT,PMISRTIM,SP70
          CALL      RAPMIRS1
          IF        OVRCD=1
            CALL      WRPMIRS1
          ENDIF
.
RRES9999  RETURN
.
.----------------------------------------------------------------------
. Clear response vars
.----------------------------------------------------------------------
CRES0000  MOVE      SP70,RESVAL01
          MOVE      SP70,RESVAL02
          MOVE      SP70,RESVAL03
          MOVE      SP70,RESVAL04
          MOVE      SP70,RESVAL05
          MOVE      SP70,RESVAL06
          MOVE      SP70,RESVAL07
          MOVE      SP70,RESVAL08
          MOVE      SP70,RESVAL09
          MOVE      SP70,RESVAL10
          MOVE      SP70,RESVAL11
          MOVE      SP70,RESVAL12
          MOVE      SP70,RESVAL13
          MOVE      SP70,RESVAL14
          MOVE      SP70,RESVAL15
          MOVE      SP70,RESVAL16
          MOVE      SP70,RESVAL17
          MOVE      SP70,RESVAL18
          MOVE      SP70,RESVAL19
          MOVE      SP70,RESVAL20
          MOVE      SP70,RESVAL21
          MOVE      SP70,RESVAL22
          MOVE      SP70,RESVAL23
          MOVE      SP70,RESVAL24
          MOVE      SP70,RESVAL25
          MOVE      SP70,RESVAL26
          MOVE      SP70,RESVAL27
          MOVE      SP70,RESVAL28
          MOVE      SP70,RESVAL29
          MOVE      SP70,RESVAL30
          MOVE      SP70,RESVAL31
          MOVE      SP70,RESVAL32
          MOVE      SP70,RESVAL33
          MOVE      SP70,RESVAL34
          MOVE      SP70,RESVAL35
          MOVE      SP70,RESVAL36
          PACK      RESVAL37,SP70,SP70
.
CRES9999  RETURN
.
.------------------------------------------------------------
. Lookup HPI-I Number
.------------------------------------------------------------
LHPI0000  CALL      CREA0000           * Create parameter file
.
          CALL      WHPI0000           * Write HPI-I request to paramters file
          BRANCH    EXIT,LHPI9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LHPI9000
.
LHPI1000  CALL      RRES0000           * Read response vars
          CALL      PHPI0000           * Process HPII response
.
LHPI9000  CALL      KILL0000           * Delete parameter file
.
LHPI9999  RETURN
.
.----------------------------------------------------------------------
. Write HPI-I Request to parameters file
.----------------------------------------------------------------------
WHPI0000  PACK      KEY10,PMILCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,WHPI9000
.
WHPI3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",PMILCODE
          WRITE     PARMFILE,SEQ;"RequestSurname           :",PMHCSNAM
          WRITE     PARMFILE,SEQ;"RequestGiven1            :",PMHCGNAM
          WRITE     PARMFILE,SEQ;"RequestGender            :",PMHCGNDR
          WRITE     PARMFILE,SEQ;"RequestHPII              :",PMHCNHTA
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PMHCHAD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PMHCHAD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PMHCHAD3
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PMHCHAD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PMHCHPCD
          WRITE     PARMFILE,SEQ;"RequestSurgeryAddress1   :",PMHCADR1
          WRITE     PARMFILE,SEQ;"RequestSurgeryAddress2   :",PMHCADR2
          WRITE     PARMFILE,SEQ;"RequestSurgeryAddress3   :",PMHCADR3
          WRITE     PARMFILE,SEQ;"RequestSurgeryAddress4   :",PMHCADR4
          WRITE     PARMFILE,SEQ;"RequestSurgeryPostCode   :",PMHCPOST
          WRITE     PARMFILE,SEQ;"RequestProviderType      :",SP1
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PMHCSNAM,PMIQSURN        * Request Surname
          MOVE      PMHCGNAM,PMIQFNAM        * Request First Name
          MOVE      PMHCGNDR,PMIQPSEX        * Request Sex
          MOVE      PMHCNHTA,PMIQIDEN        * Request Identifier
          MOVE      PMHCHAD1,PMIQADD1        * Request Address Line 1
          MOVE      PMHCHAD2,PMIQADD2        * Request Address Line 2
          MOVE      PMHCHAD3,PMIQADD3        * Request Address Line 3
          MOVE      PMHCHAD4,PMIQADD4        * Request Address Line 4
          MOVE      PMHCHPCD,PMIQPOST        * Request Post Code
          MOVE      PMHCADR1,PMIQSAD1        * Surgery Address Line 1
          MOVE      PMHCADR2,PMIQSAD2        * Surgery Address Line 2
          MOVE      PMHCADR3,PMIQSAD3        * Surgery Address Line 3
          MOVE      PMHCADR4,PMIQSAD4        * Surgery Address Line 4
          MOVE      PMHCPOST,PMIQSPST        * Surgery Post Code
          MOVE      SP1,PMIQPTYP             * Provider Type
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WHPI9999
.
WHPI9000  MOVE      ONE,EXIT
          GOTO      WHPI9999
.
WHPI9999  RETURN
.
.----------------------------------------------------------------------
. Process HPII Response
.----------------------------------------------------------------------
PHPI0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4
.
          COMPARE   ZERO,F4
          GOTO      PHPI9100 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 02 - PHI-I Request
          GOTO      PHPI9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * HCP Code
          GOTO      PHPI9999 IF NOT EQUAL
.
          PACK      KEY10,PMILCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,PHPI9999
.
          PACK      KEY32,PMHCHCPC,SP70
          CALL      RSPMIHP1
PHPI1000  CALL      RKPMIHP1
          BRANCH    OVRCD,PHPI2000
.
          MATCH     PMIPHCPC,PMHCHCPC            * Same HCP Code
          GOTO      PHPI2000 IF NOT EQUAL
.
          MATCH     "1",PMIPASTA                 * Activation status - Active
          GOTO      PHPI9000 IF EQUAL
.
PHPI2000  MOVE      PMHCHCPC,PMIPHCPC      * HCP Code
          MOVE      RESVAL18,PMIPHPII      * HPI-I Number
.
          CALL      IBACLOCK
.
          PACK      PMIPADAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIPADAT          * Date of Assignment (CCYYMMDD)
          MOVE      CTIMEIS,PMIPATIM       * Time of Assignment (HH:MM:SS)
          MOVE      RESVAL30,PMIPVSTA      * HPI-I Verification Status
          MOVE      RESVAL29,PMIPASTA      * HPI-I Activation Status
.
          PACK      PMIPCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIPCDAT      * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIPCTIM   * Created Time (HH:MM:SS)
          MOVE      WBSEUID,PMIPCUID  * Created By (websecaf)
          MOVE      SP70,PMIPUDAT      * Updated Date (CCYYMMDD)
          MOVE      SP70,PMIPUTIM      * Updated Time (HH:MM:SS)
          MOVE      SP70,PMIPUUID      * Updated By (websecaf)
          MOVE      SP70,PMIPSPAR      * Spare
.
          PACK      KEY32,PMIPHCPC,PMIPHPII,PMIPVSTA,PMIPASTA,SP70
          CALL      RAPMIHP1
          IF        OVRCD=1
            CALL      WRPMIHP1
          ENDIF
          GOTO      PHPI9999
.
PHPI9000  *** WRITE ERROR HCP already has an active HPI-I
.
          MOVE      "02",PMIRRTYP            * HPII Request
          PACK      PMIRCODE,PMHCHCPC,SP70   * HCP Code 
          PACK      PMIRINUM,RESVAL18,SP70  * HPII Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
          MOVE      SP70,PMIRECOD            * Error Code
          MOVE      "HCP Already has an active HPI-I",PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PHPI9100  MOVE      "02",PMIRRTYP            * HPII Request
          PACK      PMIRCODE,RESVAL02,SP70   * HCP Codeer
          PACK      PMIRINUM,RESVAL18,SP70  * HPII Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PHPI9999  RETURN
.
.------------------------------------------------------------
. Lookup HPI-O Hospital number
.------------------------------------------------------------
LHOS0000  CALL      CREA0000           * Create parameter file
.
          CALL      WHOS0000           * Write HPI-O request to paramters file
          BRANCH    EXIT,LHOS9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LHOS9000
.
LHOS1000  CALL      RRES0000           * Read response vars
          CALL      PHOS0000           * Process HPIO response
.
LHOS9000  CALL      KILL0000           * Delete parameter file
.
LHOS9999  RETURN
.
.----------------------------------------------------------------------
. Write HPI-O - Hospital request to parameters file
.----------------------------------------------------------------------
WHOS0000  PACK      KEY3,PMILCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,WHOS9000
.
WHOS3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",PMILCODE
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PTHSADD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PTHSADD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PTHSADD3
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PTHSADD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PTHSPCOD
          WRITE     PARMFILE,SEQ;"RequestOrganisationName  :",PTHSNAME
          WRITE     PARMFILE,SEQ;"RequestHPIO              :",PTHSHPIO
          WRITE     PARMFILE,SEQ;"RequestServiceType       :",SP1
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PTHSADD1,PMIQADD1        * Request Address Line 1
          MOVE      PTHSADD2,PMIQADD2        * Request Address Line 2
          MOVE      PTHSADD3,PMIQADD3        * Request Address Line 3
          MOVE      PTHSADD4,PMIQADD4        * Request Address Line 4
          MOVE      PTHSPCOD,PMIQPOST        * Request Post Code
          MOVE      PTHSNAME,PMIQNAME        * Organisation Name
          MOVE      PTHSHPIO,PMIQIDEN        * Request Identifier
          MOVE      SP1,PMIQSTYP             * Service Type
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WHOS9999
.
WHOS9000  MOVE      ONE,EXIT
          GOTO      WHOS9999
.
WHOS9999  RETURN
.
.----------------------------------------------------------------------
. Process HPIO Hospital Response
.----------------------------------------------------------------------
PHOS0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4
.
          COMPARE   ZERO,F4
          GOTO      PHOS9000 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 03 - PHI-O Request
          GOTO      PHOS9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * HCP Code
          GOTO      PHOS9999 IF NOT EQUAL
.
          PACK      KEY3,PMILCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,PHOS9999
.
          PACK      PTHSHPIO,RESVAL27,SP70   * Save HPI-O  
.
          CALL      UPPTHSP1
          GOTO      PHOS9999
.
PHOS9000  MOVE      "03",PMIRRTYP            * HPIO Request
          PACK      PMIRCODE,RESVAL02,SP70   * Hospital Code
          PACK      PMIRINUM,RESVAL27,SP70   * HPIO Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PHOS9999  RETURN
.
.------------------------------------------------------------
. Lookup HPI-O Practice
.------------------------------------------------------------
LPRA0000  CALL      CREA0000           * Create parameter file
.
          CALL      WPRA0000           * Write HPI-O request to paramters file
          BRANCH    EXIT,LPRA9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LPRA9000
.
LPRA1000  CALL      RRES0000           * Read response vars
          CALL      PPRA0000           * Process HPIO response
.
LPRA9000  CALL      KILL0000           * Delete parameter file
.
LPRA9999  RETURN
.
.----------------------------------------------------------------------
. Write HPI-O - Practice request to parameters file
.----------------------------------------------------------------------
WPRA0000  PACK      KEY12,PMILCODE,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,WPRA9000
.
WPRA3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",PMILCODE
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PMHGADD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PMHGADD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PMHGADD3
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PMHGADD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PMHGPOST
          WRITE     PARMFILE,SEQ;"RequestOrganisationName  :",PMHGPNAM
          WRITE     PARMFILE,SEQ;"RequestHPIO              :",PMHGHPIO
          WRITE     PARMFILE,SEQ;"RequestServiceType       :",SP1
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PMHGADD1,PMIQADD1        * Request Address Line 1
          MOVE      PMHGADD2,PMIQADD2        * Request Address Line 2
          MOVE      PMHGADD3,PMIQADD3        * Request Address Line 3
          MOVE      PMHGADD4,PMIQADD4        * Request Address Line 4
          MOVE      PMHGPOST,PMIQPOST        * Request Post Code
          MOVE      PMHGPNAM,PMIQNAME        * Organisation Name
          MOVE      PMHGHPIO,PMIQIDEN        * Request Identifier
          MOVE      SP1,PMIQSTYP             * Service Type
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WPRA9999
.
WPRA9000  MOVE      ONE,EXIT
          GOTO      WPRA9999
.
WPRA9999  RETURN
.
.----------------------------------------------------------------------
. Process HPIO Practice Response
.----------------------------------------------------------------------
PPRA0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4
.
          COMPARE   ZERO,F4
          GOTO      PPRA9000 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 04 - PHI-O Request
          GOTO      PPRA9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * Practice code and count
          GOTO      PPRA9999 IF NOT EQUAL
.
          PACK      KEY12,PMILCODE,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,PPRA9999
.
          PACK      PMHGHPIO,RESVAL27,SP70   * Save HPI-O
.
          CALL      UPPTHSP1
          GOTO      PPRA9999
.
PPRA9000  MOVE      "04",PMIRRTYP            * HPIO Request
          PACK      PMIRCODE,RESVAL02,SP70   * Practice code and count
          PACK      PMIRINUM,RESVAL27,SP70   * HPIO Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PPRA9999  RETURN
.
.------------------------------------------------------------
. Lookup HPI-O Hospital Unit   
.------------------------------------------------------------
LUNT0000  CALL      CREA0000           * Create parameter file
.
          CALL      WUNT0000           * Write HPI-O request to paramters file
          BRANCH    EXIT,LUNT9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LUNT9000
.
LUNT1000  CALL      RRES0000           * Read response vars
          CALL      PUNT0000           * Process HPIO response
.
LUNT9000  CALL      KILL0000           * Delete parameter file
.
LUNT9999  RETURN
.
.----------------------------------------------------------------------
. Write HPI-O - Hospital Unit request to parameters file
.----------------------------------------------------------------------
WUNT0000  PACK      KEY3,PMILCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,WUNT9000
.
          PACK      KEY26,PMILCODE,SP70
          CALL      RDPMIHU1
          IF        OVRCD=1
            MOVE      SP70,PMIUHPIO
          ENDIF
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSA,ANSC,PMIUUNIT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMIUUNIT,TDESC
          ENDIF
.
WUNT3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",KEY26
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PTHSADD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PTHSADD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PTHSADD3
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PTHSADD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PTHSPCOD
          WRITE     PARMFILE,SEQ;"RequestOrganisationName  :",PTHSNAME
          WRITE     PARMFILE,SEQ;"RequestOrganisationUnit  :",TDESC
          WRITE     PARMFILE,SEQ;"RequestHPIO              :",PMIUHPIO
          WRITE     PARMFILE,SEQ;"RequestServiceType       :",SP1
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PTHSADD1,PMIQADD1        * Request Address Line 1
          MOVE      PTHSADD2,PMIQADD2        * Request Address Line 2
          MOVE      PTHSADD3,PMIQADD3        * Request Address Line 3
          MOVE      PTHSADD4,PMIQADD4        * Request Address Line 4
          MOVE      PTHSPCOD,PMIQPOST        * Request Post Code
          MOVE      PTHSNAME,PMIQNAME        * Organisation Name
          MOVE      TDESC,PMIQUNIT           * Organisation Unit (Cat AC)
          MOVE      PMIUHPIO,PMIQIDEN        * Request Identifier
          MOVE      SP1,PMIQSTYP             * Service Type
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WUNT9999
.
WUNT9000  MOVE      ONE,EXIT
          GOTO      WUNT9999
.
WUNT9999  RETURN
.
.----------------------------------------------------------------------
. Process HPIO Unit Response
.----------------------------------------------------------------------
PUNT0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4
.
          COMPARE   ZERO,F4
          GOTO      PUNT9000 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 05 - PHI-O Request
          GOTO      PUNT9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * Practice code and count
          GOTO      PUNT9999 IF NOT EQUAL
.
          UNPACK    PMILCODE,PMIUHOSP,PMIUUNIT,PMIUHPIO
.
          MATCH     SP70,PMIUHPIO
          IF        @EQUAL
            PACK      PMIUHPIO,RESVAL27,SP70   * Save HPI-O
          ENDIF
.
          PACK      KEY3,PMIUHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,PUNT9999
.
          PACK      KEY5,ANSA,ANSC,PMIUUNIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PUNT9999
.
          CALL      IBACLOCK
.
          PACK      KEY26,PMIUHOSP,PMIUUNIT,PMIUHPIO,SP70
          CALL      RDPMIHU1
          IF        OVRCD=1 
            PACK      PMIUCDAT,CCC,CYY,CMM,CDD    * Created date (CCYYMMDD)
            REP       " 0",PMIUCDAT 
            MOVE      CTIMEIS,PMIUCTIM            * Created time
            MOVE      WBSEUID,PMIUCUID           * Created by
            MOVE      SP70,PMIUUDAT               * Update date
            MOVE      SP70,PMIUUTIM               * Upate time
            MOVE      SP70,PMIUUUID               * Update user
            MOVE      SP70,PMIUSPAR
.
            CALL      WRPMIHU1
          ELSE
            PACK      PMIUUDAT,CCC,CYY,CMM,CDD    * Updated date (CCYYMMDD)
            REP       " 0",PMIUUDAT
            MOVE      CTIMEIS,PMIUUTIM            * Update time
            MOVE      WBSEUID,PMIUUUID           * Created by
.
            CALL      UPPMIHU1
          ENDIF
          GOTO      PUNT9999
.
PUNT9000  MOVE      "05",PMIRRTYP            * HPIO Request
          PACK      PMIRCODE,RESVAL02,SP70   * Hospital, unit and HPIO          
          PACK      PMIRINUM,RESVAL27,SP70   * HPIO Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
PUNT9999  RETURN
.
.------------------------------------------------------------
. Lookup HPI-O OP clinic
.------------------------------------------------------------
LOUT0000  CALL      CREA0000           * Create parameter file
.
          CALL      WOUT0000           * Write HPI-O request to paramters file
          BRANCH    EXIT,LOUT9000
.
          CALL      XCMD0000           * Execute comweb07.us1 script
          BRANCH    EXIT,LOUT9000
.
LOUT1000  CALL      RRES0000           * Read response vars
          CALL      POUT0000           * Process HPIO response
.
LOUT9000  CALL      KILL0000           * Delete parameter file
.
LOUT9999  RETURN
.
.----------------------------------------------------------------------
. Write HPI-O - OP clinic request to parameters file
.----------------------------------------------------------------------
WOUT0000  PACK      KEY6,PMILCODE,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,WOUT9000
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
          PACK      KEY28,PMILCODE,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,WOUT9000
.
          IF        IBCNMHOS=1
            PACK      KEY3,OTHEHOSP,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,WOUT9000
          ELSE
            CALL      CLPATHSP
            MOVE      CHPOST,PTHSPCOD
            MOVE      CHADD1,PTHSADD1
            MOVE      CHADD2,PTHSADD2
          ENDIF
.
          PACK      KEY20,OTHESITE,OTHECLIN,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,WOUT9999
.
          MATCH     OTHESITE,OCASITE
          GOTO      WOUT9999 IF NOT EQUAL
.
          MATCH     OTHECLIN,OCACLIN
          GOTO      WOUT9999 IF NOT EQUAL
.
WOUT3000  WRITE     PARMFILE,SEQ;"RequestType              :",PMILRTYP
          WRITE     PARMFILE,SEQ;"RequestID                :",KEY28
          WRITE     PARMFILE,SEQ;"RequestAddress1          :",PTHSADD1
          WRITE     PARMFILE,SEQ;"RequestAddress2          :",PTHSADD2
          WRITE     PARMFILE,SEQ;"RequestAddress3          :",PTHSADD3
          WRITE     PARMFILE,SEQ;"RequestAddress4          :",PTHSADD4
          WRITE     PARMFILE,SEQ;"RequestPostCode          :",PTHSPCOD
          WRITE     PARMFILE,SEQ;"RequestOrganisationName  :",OCADESC
          WRITE     PARMFILE,SEQ;"RequestHPIO              :",OTHEHPIO
          WRITE     PARMFILE,SEQ;"RequestServiceType       :",SP1
.
. Write search values to request details file
.
          CALL      CLPMSIRQ                 * Clear request details file
.
          MOVE      PMILRTYP,PMIQRTYP        * Request Type
          MOVE      PMILCODE,PMIQCODE        * Request Code
          CALL      IBACLOCK
          PACK      PMIQRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIQRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIQRTIM         * Request Time
          MOVE      PMILUSID,PMIQRTIM        * Request User Id
.
          MOVE      PTHSADD1,PMIQADD1        * Request Address Line 1
          MOVE      PTHSADD2,PMIQADD2        * Request Address Line 2
          MOVE      PTHSADD3,PMIQADD3        * Request Address Line 3
          MOVE      PTHSADD4,PMIQADD4        * Request Address Line 4
          MOVE      PTHSPCOD,PMIQPOST        * Request Post Code
          MOVE      OCADESC,PMIQNAME         * Organisation Name
          MOVE      PMIUHPIO,PMIQIDEN        * Request Identifier
          MOVE      SP1,PMIQSTYP             * Service Type
.
          PACK      KEY68,PMIQRTYP,PMIQCODE,PMIQRDAT,PMIQRTIM,SP70
          CALL      RAPMIRQ1
          IF        OVRCD=1
            CALL      WRPMIRQ1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WOUT9999
.
WOUT9000  MOVE      ONE,EXIT
          GOTO      WOUT9999
.
WOUT9999  RETURN
.
.----------------------------------------------------------------------
. Process HPIO Outpatient Response
.----------------------------------------------------------------------
POUT0000  MOVE      ZERO,F4                      * Check response status code
          MOVE      RESVAL31,F4
.
          COMPARE   ZERO,F4
          GOTO      POUT9000 IF LESS             * Write error record
.
          MATCH     PMILRTYP,RESVAL01            * 06 - PHI-O Request
          GOTO      POUT9999 IF NOT EQUAL
.
          MATCH     PMILCODE,RESVAL02            * OP Site, clinic, date, start
          GOTO      POUT9999 IF NOT EQUAL        * schdule number and schedule  
.                                                * date
          PACK      KEY28,PMILCODE,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,POUT9999
.
          PACK      OTHEHPIO,RESVAL27,SP70   * Save HPI-O
.
          CALL      UPOTHED1
          GOTO      POUT9999
.
POUT9000  MOVE      "06",PMIRRTYP            * HPIO Request
          PACK      PMIRCODE,RESVAL02,SP70   * Practice code and count
          PACK      PMIRINUM,RESVAL27,SP70   * HPIO Number
.
          CALL      IBACLOCK
          PACK      PMIRRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIRRDAT            * Request Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIRRTIM         * Request Time (HH:MM:SS)
          MOVE      PMILUSID,PMIRRUID        * Request User Id (websecaf)
.
          MOVE      RESVAL31,PMIRECOD             * Error Code
          MOVE      RESVAL32,PMIREMES  * Error Message
          MOVE      SP70,PMIRSPAR  * Spare
.
          PACK      KEY88,PMIRRTYP,PMIRCODE,PMIRINUM,PMIRRDAT,PMIRRTIM,SP70
          CALL      RAPMIER1
          IF        OVRCD=1
            CALL      WRPMIER1
          ENDIF
.
POUT9999  RETURN
.
.----------------------------------------------------------------------
          INC       IBAWEBCD
          INC       TFILENAM
          INC       CLPATHSP
          INC       CLPMSIHI
          INC       CLPMSIRQ
          INC       CLPMSIRS
.
          INC       OUTCLIIO/INC
          INC       OUTHEDIO/INC
          INC       OUTSITIO/INC
          INC       PATMA1IO/INC
          INC       PATHSPIO/INC
          INC       PMSAIDIO/INC
          INC       PMSCCDIO/INC
          INC       PMSIERIO/INC
          INC       PMSIHEIO/INC
          INC       PMSIHUIO/INC
          INC       PMSIHIIO/INC
          INC       PMSIHPIO/INC
          INC       PMSIPLIO/INC
          INC       PMSIRQIO/INC
          INC       PMSIRSIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSPX2IO/INC
