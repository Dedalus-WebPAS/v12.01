.----------------------------------------------------------------------
. Program       : PATWEB10
.
. Function      : Patient calendar views server. This server will display a    
.                 calendar view of outpatient appointments, theatre bookings 
.                 and inpatient admissions.
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.01 15.05.2025  DA Sarkies     TSK 0955096
.           Updated for Alpha-Numeric Visit Number
. V11.05.05 12/03/2025  Ebon Clements  TSK 0958207
.           Fixed theatre diary infinite loop - PTHE1000
. V11.05.04 10.02.2025 Sunny           TSK 0948003
.           Changed check for (dispwkno=1) in PLIN0000
.           11/02/2025  Peter Vela     TSK 0953169
.           Recompiled for FHROUTCD - Fixed Practitioner id display on
.           Appointment id includes
. V11.05.03 20.01.2025 Sunny           TSK 0948003
.           Added Week Cycle to Theatre Diary Views (dispwkno=1)
. V11.05.02 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.01 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.04.03 30/09/2024  Peter Vela     Outpatient FHIR API 0953169
.           Added Outpatient FHIR API
. V11.04.02 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.01 30/11/2023  Ebon Clements  TSK 0925492
.           Recompile for BEDBDPRO - Multiple theatre bookings per admission
. V11.03.08 01/08/2023  Peter Vela     TSK 0927262
.           Recompiled for FHRDATCD
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
. V11.03.07 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes 
. V11.03.06 06/06/2023  Thanh T       TSK 0930577
.           Added THET1400 for New Theatre Diary Day View By Description  
. V11.03.05 30/05/2023  Peter Vela    TSK 0927262
.           ClinicalAide FHIR api
.           Added Subject include FHRSUBIN functionality
.           Added Participant include FHRPARIN functionality
.           Added Location include FHRLOCIN functionality
.           Fixed pack of CASEKEYS in THEAPP00
.           Increased FHRAPPID to DIM 26
.           Increased CASEKEYS to DIM 26
. V11.03.04 23/05/2023  Davin         TSK 0932921
.           Always read patdsc for HL7 A08 - ward/bed request (GHTD0000)
. V11.03.03 17/05/2023  Ebon Clements TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.02 20/04/2023  Davin         TSK 0931806
.           Read patmi1 for inpatient HL7 A08 - ward/bed request (GHTD0000)
. V11.03.01 07/03/2023  Don Nguyen    TSK 0909393
.           Theatre index changes to incorporate the hospital
. V11.02.04 31/10/2022  Bella Turco   TSK 0921957
.           Added PTCNNRTD & NOMORE00 to maintenance lists
. V11.02.03 09/09/2022  Peter Vela    
.           Recompiled for FHROUTCD - Added comma validation in FHROCD00
. V11.02.02 15/02/2022  Ebon Clements   TSK 0916005
.           Clear cancel bed request link if cancel not available
.           HTAB0000 - HTMLLNK3
. V11.02.01 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes
. V11.01.05 13/09/2021  Ebon Clements  TSK 0910279
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op Ward 
. V11.01.04 27/08/2021  Ebon Clements  TSK 0910383
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op / Expected Ward
. V11.01.03 22/07/2021  Ebon Clements  TSK 0909330
.           Recompiled for BEDBDPRO - Post op ward
. V11.01.02 02/07/2021  Thanh T        TSK 0905755
.           Recompiled as BEDBDPRO changes
. V11.01.01 18/05/2021  Thanh T        TSK 0873184
.           Added GTAG2900 to return emviuc27 field 
. V11.00.05 03/02/2021  Ebon Clements  TSK 0902257
.           Recompiled for PMSBRQTM - Bed request default ED Diagnosis
. V11.00.04 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.03 24/08/2020  Don Nguyen      TSK 0893418
.           Fixed Theatre Diary View table output (TABT0000) for cross-browser
. V11.00.02 09/06/2020  Thanh T           TSK 0892536
.           Recompiled for PMSBRQTM changes
. V11.00.01 07/05/2020  Thanh T         TSK 0876574
.           Recompiled for PMSCEXTM/PMSCEXTD changes
. V10.15.03 23/01/2020  Davin          TSK 0856646
.           Trigger HL7 A08 message if request status is unchanged (PBED2600)
. V10.15.02 17/01/2020  Thanh T        TSK 0856646
.           Changed SPCFEA00 to append 2 &nbsp characters instead of 2 SPACE
. V10.15.01 22/10/2019  Ebon Clements     TSK 0308709
.           Recompiled for OUTBOATM - Clinic type linked visit types
.           11/10/2010  Thanh T         TSK 0856646
.           Added GTAG2800, HTAG0110, PRWRDS00 and SPCFEA00        
.----------------------------------------------------------------------
. V10.14.07 26/09/2019  Sunny             TSK 0846427
.           1)Fixed TDCMC000 to make the button display red if more
.             than 1 line exists.
.           2)Fixed TDCML999 to display Day Comments from the hospital user is
.             logged in.
. V10.14.06 26/09/2019  Peter Vela        TSK 0852291
.           Added bed validation in GETB0000
. V10.14.05 10/09/2019  Peter Vela        TSK 0852291
.           Added query validation in GETB0000
. V10.14.04 03/09/2019  Thanh T         TSK 0834846
.           Changed HTAB0000 and added HTAG0100 to get diagnosis
.           description for WAHEALTH
. V10.14.03 16/07/2019  Tracey Nguyen   TSK 0846427
.           1)New CGI variables to display current date theatre
.             comments - DISPDAYC,DAYCMCNT
.           2)New tags THET1100, THET1200, THET1300
. V10.14.02 21/05/2019  Jill Parkinson TSK 0874935
.           Fixed branch when checking to send ZBR on ward bed request delete
. V10.14.01 21/03/2019  Tracey Nguyen  TSK 0838668
.           Added CHARTREV for OUTBOATM
.----------------------------------------------------------------------
. V10.13.01 02/08/2018  Ebon Clements    TSK 0853101
.           Added hospital to theatre comments key - oprcomaf
.           02/08/2018  Davin            TSK 0854259
.           Trigger A08 EMR messages for Bed Request if PTVITYPE = 1 (dgclicec)
. V10.12.02 19/06/2018  Steve Armstrong  TSK 0854259
.           Added HL7 triggers for A08 messages for Bed Request
.           (HL7TRGID=1,2,3 & 4)
. V10.12.01 15/02/2018  Peter Vela       TSK 0849919
.           Added Completed Bed Request validation in GETB0000
.----------------------------------------------------------------------
. V10.11.12 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.11 02/11/2017  J.Tan           TSK 0847165
.           Mod Ward/Bed request to display full Ward/Bed description
. V10.11.10 31.10.2017  B.G.Ackland    TSK 0835482
.           Add FHIR Resources for Appointments by Practitioner by Date Range
.           (FAPP0000)
. V10.11.09 11/09/2017  Thanh T.       TSK 0821710
.           Recompiled for OUTBOATM
. V10.11.05 31/08/2017  Thanh T.       TSK 0821710
.           Recompiled OUTBOATM.
. V10.11.04 08/08/2017  Thanh T.       TSK 0821710
.           Recompiled OUTBOATM.
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.           17/07/2017  Richa Phogat   TSK 0834684
.           Replaced table VISCMTFD by VISUCMFD to Add/Update/Delete Transport
.           comments
.----------------------------------------------------------------------
. V10.10.02 26/06/2017  Ebon Clements  TSK 0835144
.           Don't display transport records after the date of death - HTRN0000
. V10.10.01 20/03/2017  Ebon Clements  TSK 0815831
.           Added unique comment id to appointment requests
. V10.09.02 13/12/2016  Ebon Clements  TSK 0828494
.           Added keep alive to hospital transport list - HTRN0000
. V10.09.01 02/12/2016  J.Tan          TSK 0814743
.           Added Admitting Team to Ward Bed Request
. V10.08.05 21/11/2016  Ebon Clements  TSK 0828138
.           Fixed over write of patient name - FILL0000
. V10.08.04 05/09/2016  Ebon Clements  TSK 0825431
.           Fixed read of appointment request for OP transport - BKTM0000
. V10.08.03 09/08/2016  Peter Vela     TSK 0312590
.           Added overseas contact tags from pmscexaf - GOSC0000
. V10.08.02 26/06/2016  Jill Parkinson TSK 0296775
.           Removed 10.08.01 changes 
. V10.08.01 09/06/2016  Jill Parkinson TSK 0296775
.           Recompiled for changes to BEDBDVCD - use bed ready date time for 
.           bed requests changing to expected patient table
. V10.07.02 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
. V10.07.01 28/10/2015  Ebon Clements  CAR 268970
.           Changed COPN0000 to use OUTCLIFD index 6
. V10.06.05 11/08/2015  Peter Vela     CAR 319532
.           Recompiled for OUTBOATM - Added slot template location to APPTAB00
. V10.06.04 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.03 02/07/2015  Peter Vela     CAR 318465
.           Added read for outartaf in PTRN0000
. V10.06.02 30/04/2015  Don Nguyen     CAR 314266
.           Recompiled for OUTBOATM - Modified OBOA3300 with test on indicator 1
. V10.06.01 08/04/2015  Don Nguyen     CAR 300002
.           Modified LDAY0000 and LHCP0000 to also display Day Of Week value
. V10.05.07 24/02/2015  Don Nguyen     CAR 303885
.           Recompiled for OUTBOATM - Modified APPTAB00 to output PTHSNAME.
. V10.05.06 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.05 16/10/2014  Ebon Clements  CAR 291413
.           Write record for polling server for AH referral expiry
.           date recalulation on attendance - POLX0000
. V10.05.04 30/09/2014  Don Nguyen     CAR 297774
.           Recompiled for changes to PMSBRQTM - modified CPMBRQ00
. V10.05.03 22/08/2014  Peter Vela     CAR 301338
.           Added DELHCP00 to PBED2000
. V10.05.02 13/08/2014  Peter Vela     CAR 304860
.           Recompiled for PMSVX1TM
. V10.05.01 11/08/2014  Don Nguyen     CAR 297774
.           Modified HTAB0000 to display PMBRRDAT & PMBRRTIM for allocated 
.           Bed Requests.
.           Recompiled for changes to PMSBRQFD/IO and PMSBRQTM
. V10.04.04 07/04/2014  Peter Vela     CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland    CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00 routine
. V10.04.02 18/03/2014  Ania P         CAR 267773
.           Added SETHCP00 and DELHCP00
. V10.04.01 17/01/2014  Don Nguyen     CAR 286273
.           Added GTAG2500 - User Defined Doctor (EMVIUR01)
.----------------------------------------------------------------------
. V10.03.18 11/10/2013  Peter Vela     CAR 278234
.           Increased size of DISPLDAY from 650 to 2000
. V10.03.17 04/10/2013  Patrick Adair  CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.16 27/08/2013  Ebon Clements  CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.15 03/05/2013  J.Tan          CAR 257211
.           Fixed highlight Adjust Time session for Theatre Diary View (Overlap)
. V10.03.14 03/05/2013  Ebon Clements  CAR 261630
.           Removed port number from temp file name
. V10.03.13 29/03/2013  J.Tan          CAR 257211
.           Mods to highlight Adjust Time session for Theatre Diary View
. V10.03.12 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.11 17/01/2013  Ebon Clements   CAR 262292
.           Recompiled for PMSVX1TM - Interpreter tag
. V10.03.10 18/12/2012  Peter Vela      CAR 278033
.           Dont display dead people in Transport List HTRN0000
. V10.03.09 27/11/2012  Saroeun Soeur   CAR 270106
.           TABT0000 - added div id diary_view for new template
. V10.03.08 08/06/2012  Ebon Clements   CAR 262857
.           Fixed clinic doctor test on HCP calendar view - COPN0000
. V10.03.07 10/05/2012  Peter Vela     CAR 232137
.           Recompiled for BEDBDVCD
. V10.03.06 11/04/2012  Ebon Clements   CAR 263351
.           Increased size of DISPLDAY from 350 to 650
. V10.03.05 06/03/2012  Davin           CAR 261243
.           Recompiled for PMSCEXTM - oseas country desc
. V10.03.04 07/02/2012  Ebon Clements   CAR 258391
.           Added OP booking update redirect flag - opupdate
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 23/11/2011  Ebon Clements   CAR 255738
.           Show ward beds in short description order 
. V10.03.01 10/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
. V10.02.09 25/10/2011  Ebon Clements    CAR 253833
.           Fixed patient folder display on transport list - HTRN0000
. V10.02.08 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.07 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.06 03/08/2011  Ebon Clements     CAR 247287
.           Added display of funding source to transport 
. V10.02.05 25/07/2011  Ebon Clements     CAR 242809
.           Added visit claim code display to transport list - HTRN0000
. V10.02.04 22/07/2011  Ebon Clements     CAR 242062
.           Added hospital display to transport list - HTRN0000
. V10.02.03 13/07/2011  Ebon Clements     CAR 242246
.           Recompiled for OUTBOATM - Display hospital on cancelled appt list
. V10.02.02 21/06/2011  Peter McMullen CAR 240725
.           Change ward selection list to sort by name, not code                
. V10.02.01 21/06/2011  Ebon Clements  CAR 242062
.           Added clinic fields to hospital level transport list - HTRN0000
. V10.01.01 11/01/2011  Ebon Clements  CAR 215701
.           Recompiled for BEDBDVCD -  H/F stepdown
. V10.00.11 27/10/2010  Peter Vela     CAR 232438
.           Added tag for EMCNNWBR
. V10.00.10 20/10/2010  Peter Vela     CAR 232059
.           Save key and re-read PMSBRQ @ GTAG1800
. V10.00.09 06/10/2010  Ebon Clements  CAR 231396
.           Recompiled for BEDBDVCD - Post op records expected ward/bed
. V10.00.08 27/08/2010  Peter Vela     CAR 216620
.           Added tag for EMCNDEDI
. V10.00.07 05/08/2010  Ebon Clements  CAR 220126
.           Recompiled for PMSBRQTM
. V10.00.06 17/06/2010  Peter Vela     CAR 216620
.           Added tags for Initial Bed Request and Primary Diagnosis Free Format
.           Description
. V10.00.05 03/06/2010  Ebon Clements  CAR 208220
.           Recompiled for OUTBOATM -  Added comment icon link to APPTSU00
. V10.00.04 21/04/2010  Ebon Clements  CAR 220434
.           Added icons with links to sessions on the HCP calendar view TABH0000
. V10.00.03 14/04/2010 Steve Armstrong   CAR 219933
.           Recompiled for changes to EMRVCDFD
. V10.00.02 12/04/2010  Ebon Clements  CAR 219130
.           Added visit/request status edits to add/update ward bed requests
. V10.00.01 15/03/2010  Ebon Clements  CAR
.           Goto next bed request if invalid visit or pmi record - HTAB0000
.----------------------------------------------------------------------
. V9.12.15  18/02/2010  Ebon Clements  CAR 214121
.           Fixed series booking transport return date    
. V9.12.14  12/02/2010  Ebon Clements  CAR 214121
.           Added series booking transport functionality
. V9.12.13  08/02/2010  Ebon Clements  CAR 215599
.           Recompiled for PMSBRQTM - ED diagnosis default
. V9.12.12  15/01/2010  Ebon Clements  CAR 214121
.           Read booking extn file to transport defaults
. V9.12.11  03/12/2009  Ebon Clements  CAR 204362
.           Recompiled for BEDBDPRO - Clear post op ward
. V9.12.10  01/12/2009  Peter McMullen CAR 210130
.           Format all Dr names using DOCNM000 routine       
. V9.12.09  24/09/2009  Ebon Clements  CAR 202769
.           Added alternate address functionality (pmscexaf)
. V9.12.08  04/09/2009  Peter Vela     CAR 197140
.           Added MISF0000 to PROFLD80
. V9.12.07  26/08/2009  Peter McMullen CAR 171901
.                       remove MAPCAT00 call
. V9.12.06  16/07/2009  Ebon Clements  CAR 201090
.           Added showhosp
. V9.12.05  15/07/2009  Ebon Clements  CAR 201090
.           Added filthosp to NEXT0000 and PREV0000
. V9.12.04  09/07/2009  Ebon Clements  CAR 187136
.           Added onmouseover event to PLIN0000
. V9.12.03  24/06/2009  Ebon Clements  CAR 199232
.           Recompiled for BEDBDVCD
. V9.12.02  03/06/2009  Ebon Clements  CAR 197329
.           Changed GETB0000 to read the visit and populate the urnumber cgi
. V9.12.01  02/06/2009  Ebon Clements  CAR 197329
.           Recompiled for PMSBRQTM
. V9.11.05  12/03/2009  Ebon Clements  CAR 188073
.           Changed hospital level theatre diary to display a max of
.           3 overlaps for a theatre - TABT0000
. V9.11.04  12/01/2009  Ebon Clements  CAR 174080
.           Fixed ward bed requests for ward only wards
. V9.11.03  18/12/2008  Ebon Clements  CAR 174080
.           Added FILTWARD to NEXT0000 and PREV0000
. V9.11.02  08/12/2008  Ebon Clements  CAR 174080
.           Added requesting ward and hospital to ward/bed requests
. V9.11.01  24/10/2008  Ebon Clements  CAR 174069
.           Added expected patient updates to ward/bed requests
. V9.10.01  21/08/2008  Ebon Clements  CAR 176471
.           Added default of FILTTLOC from WBSEDGSI if WBSEDGSI(cat YD) is a
.           valid category Y1 code
. V9.09.05  05/03/2008  Ebon Clements  CAR 149922
.           Changed calendar views to dispay a max of 5 patients in a time slot
. V9.09.04  07/01/2008  Peter McMullen CAR 158001
.           Add location fileter (FILTTLOC) on theatre diary.   
. V9.09.03  20/12/2007  Ebon Clements  CAR 158014
.           Added ward/bed description to ward bed request list
. V9.09.02  08/11/2007  Ebon Clements  CAR 151894
.           Added report 8, 9 and 10 - Ward/Bed request functionality
.           08/11/2007  Peter McMullen CAR 151202
.           Fix error in theatre booking time display            
. V9.09.01  20/07/2007  Ebon Clements  CAR 145544
.           Allow theatres with no hospital to be used by all hospitals/users
.           Don't do multi hospital test on theatre list if act
. V9.08.04  06/03/2007  Ebon Clements  CAR 130805
.           Display unavailable time in theatre diary view
. V9.08.03  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.02  12.01.2007  Ebon Clements  CAR 130805
.           Added report 7 - Theatre diary
. V9.08.01  12.10.2006  Ebon Clements  CAR 121292 121386
.           Added series booking functionality to add/update transport
.           Fixed transport comment type should have been 007 not 006 
. V9.07.02  17.08.2006  Ebon Clements  CAR 110245
.           Recompiled for changes to tranport file
. V9.07.01  03.07.2006  Ebon Clements  CAR 107945
.           Fixed Transport contractor filter
. V9.06.02  14.06.2006  Ramesh VK      CAR 107945
.           Added Transport contractor filter
. V9.06.01  07/06/2006  Manjunath.N CAR 106890
.           Defaulted patients's Appointment Date/Time through to Transort Date 
. V9.05.02  06/04/2006  Ebon Clements CAR 89302
.           Added report 4,5 and 6 - Patient transport
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.04  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.03  05/10/2005  Jill Habasque CAR 75952
.           Added report option 3 - patient suspensions
. V9.04.02  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.01  23/11/2004  Ebon Clements            CAR 55235
.           Added HCP Calendar view report 2
. V9.04.00  29/10/2004  Ebon Clements            CAR 55235
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       ALLLNKFD/INC
          INC       ALLCONFD/INC
          INC       EMRICDFD/INC
          INC       EMRVCDFD/INC
          INC       EMRVISFD/INC
          INC       MEHLERFD/INC
          INC       PATDO1FD/INC   * Doctor File
          INC       PATICDFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATTRNFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSVX1TD/INC
          INC       PATCONFD/INC
          INC       EMRCONFD/INC
          INC       PATHSPFD/INC
          INC       PATALRFD/INC
          INC       OUTARTFD/INC
          INC       OUTARTTD/INC
          INC       OUTRCMFD/INC        * Appointment Request Comments
          INC       OUTSITFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATNIDFD/INC
          INC       PATPR1FD/INC
          INC       PMSPX2FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       MLTSECFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PATONLFD/INC
          INC       PATSUSFD/INC
          INC       PATWVEFD/INC
          INC       PATWC1FD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSBRQFD/INC
          INC       PMSBRQTD/INC
          INC       PMSCEXTD/INC
          INC       PMSCEXFD/INC
          INC       PMSEVTFD/INC
          INC       PMSEXTFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSEPBFD/INC
          INC       PMSBBDFD/INC
          INC       PMSTSPFD/INC
          INC       PMSTSPTD/INC
          INC       PMSHCPTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATDSCFD/INC
          INC       PATWMAFD/INC
          INC       PMSTAAFD/INC
          INC       PMSTEMFD/INC
          INC       PMSTMDFD/INC
          INC       OPROPRFD/INC
          INC       OUTCANFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTCVTFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       OUTLKBFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       OPRDEAFD/INC
          INC       OPRCLIFD/INC
          INC       OPRCONFD/INC
          INC       OPRCOMFD/INC
          INC       OPRSESFD/INC
          INC       OPRUAVFD/INC
          INC       TFILEVAR/INC
          INC       WATESNFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATSUSFD/INC
          INC       WATESEFD/INC
          INC       VISCMTFD/INC
          INC       VISUCMFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       OUTDIAFD/INC
          INC       OUTBOCFD/INC
          INC       OUTXSCFD/INC
          INC       OUTSIPFD/INC
          INC       OUTXWPFD/INC
          INC       OUTMA1FD/INC
          INC       OUTCONFD/INC
          INC       OUTCTYFD/INC
          INC       OUTRSHFD/INC
          INC       PATMISTD/INC
          INC       PATICOFD/INC
          INC       OPRMBSFD/INC
          INC       OPRWCNFD/INC
          INC       FHRDATDF    
.
.----------------------------------------------------------------------
. CGI Variables
.
PMTAA001  DIM       3     * Facility (Cat fa)
PMTAA002  DIM       35    * Address Line 1
PMTAA003  DIM       35    * Address Line 2
PMTAA004  DIM       35    * Address Line 3
PMTAA005  DIM       35    * Address Line 4
PMTAA006  DIM       8     * Post Code
PMTAA007  DIM       35    * Telephone Private
PMTAA008  DIM       35    * Telephone Business
PMTAA009  DIM       35    * Telephone Mobile
PMTAA010  DIM       80    * Email
PMTAA011  DIM       20    * Melway Ref
.
PTSUS001  DIM       8     * From Date
PTSUS002  DIM       8     * To Date
PTSUS003  DIM       3     * RFC Status
PTSUS004  DIM       3     * RFC Reason
PTSUS005  DIM       100   * Comment line 1
PTSUS006  DIM       100   * Comment line 2
PTSUS007  DIM       3     * WL RFC Status
PTSUS008  DIM       3     * WL RFC Reason
REMOTENO  FORM      1
UPDATEKY  DIM       16
VALDCODE  DIM       3
VALIDBED  DIM       3
VALIDWRD  DIM       3
VALDINDC  DIM       1
.
. Program Variables
.
ADJUSFLG  FORM      1
ADMIDATE  DATE      8
BEDRWARD  INIT      "~~B"
CALDAYS   FORM      4
CANSDESC  DIM       20
CANCFLAG  FORM      1
CASEKEYS  DIM       26
CASEKEY2  DIM       28
CENDTME   DIM       5
CHGFDAT   FORM      1
CHGTDAT   FORM      1
CLAMNUMB  DIM       20
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
CNTSLOTS  FORM      3
COUNT     FORM      2
.
COMFILNM  DIM       8
COMFILAF  FILE      ASCII, FIXED=128        * Transport and bed req comments
.
COMFILNB  DIM       8
COMFILBF  FILE      ASCII, FIXED=128        * Transport return comments
.
COMTFLAG  FORM      1
CURRDATE  DIM       8       * Current Date
DFLTWARD  DIM       3
DATE1     FORM      8
DATE2     FORM      8
DATE3     FORM      8
DATE4     FORM      8
DATE5     FORM      8
DDAYFLAG  FORM      1        * Display day flag 1=mon,2=Tue,3=wed..7=Sun
DIAGDESC  DIM       70
DIM3      DIM       3
DIM6      DIM       6
DIM8      DIM       8
DIM11     DIM       11
DIM13A    DIM       13
DIM13B    DIM       13
DIM16     DIM       16
DIM40     DIM       40
DIM50     DIM       50
DIM60     DIM       60
DIM60A    DIM       60
DIM60B    DIM       60
DIM70     DIM       70
DIM100    DIM       100
DISPHCPC  DIM       10 
DISPHOSC  DIM       3
DISPHOSN  DIM       50
DISPINTR  DIM       70
DISPCLAS  DIM       17
DISPCLSA  DIM       17
DISPCLSB  DIM       17
DISPCLSC  DIM       17
DISPLAYO  FORM      1
FDISCLAS  FORM      1
FDISCLSA  FORM      1
FDISCLSB  FORM      1
FDISCLSC  FORM      1
FLDRTYPE  DIM       3
FILTSTAT  DIM       1
FILTUNIT  DIM       3
FILTTLOC  DIM       3         * Filter on theatre Location (cat Y1)
FILTHOSP  DIM       3
FILTWARD  DIM       3
DEFTVIEW  FORM      1
DISPLCNA  FORM      2         * Display count
DISPLCNB  FORM      2         * Display count
DISPLCNC  FORM      2         * Display count
DISPLDAY  DIM       2000[23][7] * Display day array 1=mon,2=Tue,3=wed..7=Sun
DISPLOCN  DIM       20
DISPCLID  DIM       6
DISPTDAY  DIM       100[28][3] * Display theatre array, 1=Normal,2&3 = overlap
DISPFACL  DIM       20
DISPBOOK  DIM       3
DISPBOKR  DIM       3
DISPDATE  DIM       11
DISPTRNS  DIM       20
DISPMOBL  DIM       20
DISPAIDS  DIM       20
DISPMENT  DIM       20
DISPSPEC  DIM       20
DISPCLAM  DIM       20
DISPVCLD  DIM       20
DISPDAYC  FORM      1           *Display Todays theatre comments     *T0846427
DAYCMCNT  FORM      3           *Current date comment line count     *T0846427
DISPWKNO  FORM      1           *Display week number on theatre lists
DOCTCODE  DIM       8
DTHEATRE  INIT      "Theatre"
DURATION  FORM      4
ENDTIME   DIM       5
F3A       FORM      3
FORM3     FORM      3 
FORM8     FORM      8 
FROMDATE  DIM       12
FILTBOOK  DIM       1
FILTCONT  DIM       3
FILLCLAS  FORM      1    * Class filler
FILLDESC  DIM       250  * Filler description
FILLDETL  DIM       100  * Filler description
HTMLLNK2  DIM       127
HTMLLNK3  DIM       127
HOUR      FORM      2   * Hour Variable
HOVERKEY  DIM       19
HOVERSES  DIM       500
INSUNAME  DIM       30
LCOUNT    FORM      2
LINKVTYP  FORM      1
LSTDSCFL  DIM       1 
LOOPCNTR  FORM      4
MBSDESC   DIM       70
MIN       DIM       2   * Minutes Variable
MINTIME   FORM      2   * Set minutes to a form after computation
MINUTES   FORM      3   * Minutes Variable
NBRDAYS   FORM      4
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NMPNUMB   DIM       20
NOSESFLG  FORM      1
NOTEFLAG  FORM      1
PARNTBOK  DIM       8
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10

PSAGETYP  DIM       3
PSAGECON  DIM       3
REASDESC  DIM       25
REQSTATS  DIM       10
RFCSDESC  DIM       25
SAVKEY14  DIM       14
SAVKEY17  DIM       17
SAVKEY24  DIM       24
SAVETHET  DIM       6
SAVWDAYF  FORM      1
SAVECLIN  DIM       6
SAVEEVAL  DIM       20
SAVEFDAT  DIM       8
SAVERSTA  DIM       1
SAVESITE  DIM       6
SAVETDAT  DIM       8
SAVSKEYS  DIM       19
SAVSKEYA  DIM       19
SAVSKEYB  DIM       19
SAVSKEYC  DIM       19
SAVFCLAS  FORM      1    * Class filler
SHOWFLAG  DIM       1
SHOWHOSP  DIM       1
SHOWHOSC  FORM      1
CASESCNT  FORM      2
SESSKEYS  DIM       19
SESSKEYA  DIM       19
SESSKEYB  DIM       19
SESSKEYC  DIM       19
SJOGFLAG  DIM       1
SURFNAME  DIM       50
TODATE    DIM       8
TRNSFLAG  FORM      1       * 0=Not from booking, 1=From Booking, 2=Series Book
STARTKEY  DIM       10      * Starting Key
STRTTIME  DIM       5
THETFLAG  FORM      1
TIME      FORM      3   * Allows for negative Symbol
TIMEARRY  DIM       5[23]    * Time array to set appointment time classes
TTIMARRY  DIM       5[28]    * Time array to set appointment time classes
TRNFLAG   FORM      1
RETFLAG   FORM      1
TRNWEND   FORM      3
RETWEND   FORM      3
UPDTTYPE  DIM       1       * Update Type
VISTDATE  DIM       8
VISTTIME  DIM       8
WORKDATE  DATE      8
ENDLDATE  DATE      8       * End Date
EXPDDATE  DATE      8       * Admission expected discharge date
WORKDAYF  FORM      1
NEWSLOTK  DIM       28
F12P2     FORM     12.2
VISTFLAG  FORM      1
LINK2PRT  FORM      1
ENDATE    DIM       8
DIDATE    DIM       11
TMPDATE   DIM       8
TEMPTIME  DIM       5
TYPEDESC  DIM       20
INPSPCDS  DIM       20
PRFWRDDS  DIM       20
SPCFEADS  DIM      140
SLOTTIME  DIM       5
SITECODE  DIM       6
OUTCDESC  DIM       25
OPUPDATE  DIM       1
OSESLINK  DIM       110
TSESLINK  DIM       115
OVERFLAG  FORM      1
OVERLAPF  FORM      1
OVERLAP1  FORM      1
OVERLAP2  FORM      1
OVERLAPS  FORM      1
UNITDESC  DIM       20
VTYPDESC  DIM       70
CHARTREV  FORM      1        * Chart Review               * T0838668
CLILDESC  DIM       25
OVERBOOK  FORM      1
DIM5      DIM       5
DIM30     DIM       30 
VISTCLAM  DIM       3
VISCMFLG  FORM      1
WAITFLAG  FORM      1
WAHLFLAG  FORM      1        * WAHEALTH flag
.
ENDDWEEK  DATE      8
ROTATION  FORM      2
STRTWEEK  DATE      8
WEEKCYCL  DIM       10
WEEKNUMB  FORM      3
.
. Constants
.
CATCZ     INIT      "cz"
CATCT     INIT      "CT"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATFA     INIT      "fa"
CATOB     INIT      "OB"
CATPN     INIT      "pn"
CATPO     INIT      "po"
CATPP     INIT      "pp"
CATSA     INIT      "SA"
CATCL     INIT      "CL"
CATTC     INIT      "tc"
DASH      INIT      " - "
DELETERC  INIT      "DELETE"
.
FHIROST0  INIT      "proposed"
FHIROST1  INIT      "booked"
FHIROST2  INIT      "cancelled"
FHIROST3  INIT      "proposed"
FHIROST4  INIT      "arrived"
FHIROST5  INIT      "noshow"
FHIROST6  INIT      "cancelled"
FHIROST7  INIT      "entered-in-error"
FHIROST9  INIT      "pending"
.
LOADCLS1  INIT      "class=HeadingCell"
LOADCLS2  INIT      "class=InpCell"
LOADCLS3  INIT      "class=OutCell"
LOADCLS4  INIT      "class=TheCell"
.
THECLAS1  INIT      "class=NormalSess"
THECLAS2  INIT      "class=ExtraSess"
THECLAS3  INIT      "class=Unavail"
THECLAS4  INIT      "class=OverlapSess"
THECLAS5  INIT      "class=AdjustTime"
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
SURGNAME  DIM       40
ANAENAME  DIM       40
OADESC    DIM       40
STDESC    DIM       40
CVDESC    DIM       40
CTDESC    DIM       40
CLDESC    DIM       40
SRDESC    DIM       40
FHRAPPID  DIM       26
FHRSUBIN  FORM      1      * _include=Appointment:subject
FHRLOCIN  FORM      1      * _include=Appointment:location
FHRPARIN  FORM      1      * _include=Appointment:participant
FHIRREMB  DIM       1
FHIRAPPT  DIM       50
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
FHRINOUT  FORM      1
FHRINTHE  FORM      1
.
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB10"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Patient Calendar Views"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CALV0000        * U/R Calendar View
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      HCPV0000        * HCP Calendar View
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      PSUS0000        * Patient Suspension
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      PTRN0000        * Patient Transport
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      HOST0000        * Hospital Transport Lists
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      FACAD000        * Transport Facility Address   
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      THEV0000        * Theatre Diary/Calendar view
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      PBED0000        * Patient Level Bed Requests
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      HBED0000        * Hospital Level Bed Requests
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      REMBED00        * Bed Request Remote Scripts
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSBRQA1,"pmsbrqaf"
          OPEN      PMSBRQA2,"pmsbrqaf"
          OPEN      PMSBRQA3,"pmsbrqaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCLIA2,"oprcliaf"
          OPEN      OPRUAVA1,"opruavaf"
          OPEN      OPRCOMA1,"oprcomaf"
          OPEN      OPRCOMA2,"oprcomaf"
          OPEN      OUTARTA1,"outartaf"
          OPEN      OUTRCMA1,"outrcmaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATSUSA1,"patsusaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSEPBA1,"pmsepbaf"
          OPEN      PMSEPBA2,"pmsepbaf"
          OPEN      PMSBBDA1,"pmsbbdaf"
          OPEN      PMSBBDA2,"pmsbbdaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSTSPA1,"pmstspaf"
          OPEN      PMSTSPA2,"pmstspaf"
          OPEN      PMSTAAA1,"pmstaaaf"
          OPEN      PMSTEMA1,"pmstemaf"
          OPEN      PMSTMDA1,"pmstmdaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPROPRA2,"opropraf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA4,"oprsesaf"
          OPEN      OPRSESA7,"oprsesaf"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      WATESEA1,"wateseaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISUCMA1,"visucmaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATIN1A1,"patin1af"
          OPEN      OPRMBSA1,"oprmbsaf"
          OPEN      OPRWCNA2,"oprwcnaf"
.
          CALL      OPICD1                  * Open ICD Disease files
          CALL      OPICO1                  * Open ICD Disease files
.
          READ      CONTROLF,FORTY;*111,OPCNCLSU
          READ      CONTROLF,FORTY2;*241,OPCNSCOM
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,EIGHTY9;*232,EMCNDEDI,*234,EMCNNWBR
          READ      CONTROLF,HUND12;*104,PTCNWBDS
          READ      CONTROLF,HUND16;*215,PTCNAADR,*222,PTCNXCOM
          READ      CONTROLF,TEN3;*188,CMABINS,*194,CVETINS
          READ      CONTROLF,HUND22;*1,EMCNDADR
          READ      CONTROLF,HUND24;*217,PTCNSZBR
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          OPEN      OUTSIPA1,"outsipaf"
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNB
          CALL      GETTZ000
.
INIT9999  RETURN
.
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
GETTZ999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      ZERO,FHRINOUT
          MOVE      ZERO,FHRINTHE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,DISPHCPC
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      Z70,UPDATEKY
          MOVE      SP70,FILTBOOK
          MOVE      SP70,FILTCONT
          MOVE      ZERO,REMOTENO
          MOVE      SP70,VALDCODE
          MOVE      SP70,VALDINDC
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      ZERO,COMTFLAG
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTUNIT
          MOVE      SP70,FILTTLOC
          MOVE      SP70,VALIDBED
          MOVE      SP70,VALIDWRD
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTWARD
          MOVE      SP70,SHOWFLAG
          MOVE      SP70,SHOWHOSP
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,OPUPDATE
          MOVE      SP70,SJOGFLAG
.
          CALL      CARR0000
          CALL      CTAR0000
          CALL      SETT0000
          CALL      STTT0000
          CALL      CPPMTS00
          CALL      CPPMBR00
          CALL      CPVXTF00
.
          MOVE      Z70,PTSUS001
          MOVE      Z70,PTSUS002
          MOVE      Z70,PTSUS003
          MOVE      Z70,PTSUS004
          MOVE      Z70,PTSUS005
          MOVE      Z70,PTSUS006
          MOVE      Z70,PTSUS007
          MOVE      Z70,PTSUS008
.
          MOVE      SP70,PMTAA001
          MOVE      SP70,PMTAA002
          MOVE      SP70,PMTAA003
          MOVE      SP70,PMTAA004
          MOVE      SP70,PMTAA005
          MOVE      SP70,PMTAA006
          MOVE      SP70,PMTAA007
          MOVE      SP70,PMTAA008
          MOVE      SP70,PMTAA009
          MOVE      SP70,PMTAA010
          MOVE      SP70,PMTAA011
          MOVE      ZERO,TRNSFLAG
          MOVE      ZERO,WAITFLAG

          MOVE      ZERO,DISPDAYC                *T0846427
          MOVE      ZERO,DAYCMCNT                *T0846427
.
          MOVE      ZERO,DISPWKNO
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
.
          MOVE      SP70,CASEKEY2
.
          MOVE      SP70,FHIRREMB
.
          CALL      CLOUTART
.
CLRPAR99  RETURN
.
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updateky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtbook=",QRYNAME
          IF        @EQUAL
            PACK      FILTBOOK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          iF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtunit=",QRYNAME
          IF        @EQUAL
            PACK      FILTUNIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtward=",QRYNAME
          IF        @EQUAL
            PACK      FILTWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttloc=",QRYNAME
          IF        @EQUAL
            PACK      FILTTLOC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtcont=",QRYNAME
          IF        @EQUAL
            PACK      FILTCONT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            PACK      URNUMBER,URNUMBER,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrinout=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRINOUT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrinthe=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRINTHE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disphcpc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPHCPC
            PACK      DISPHCPC,DISPHCPC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptsus",QRYNAME
          IF        @EQUAL
            CALL      PTSUSSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmtsp",QRYNAME
          IF        @EQUAL
            CALL      SPPMT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transcom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00           * Get cancellation comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedrqcom",QRYNAME
          IF        @EQUAL
            MOVE      ONE,COMTFLAG
            CALL      GETEXT00           * Get bed request comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rettscom",QRYNAME
          IF        @EQUAL
            CALL      GETRET00           * Get transport return comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmtaa",QRYNAME
          IF        @EQUAL
            CALL      SPTAA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmbrq",QRYNAME
          IF        @EQUAL
            CALL      SPBRQ000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "validbed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALIDBED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "validwrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALIDWRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx",QRYNAME
          IF        @EQUAL
            CALL      SPVXTF00
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "opupdate=",QRYNAME
          IF        @EQUAL
            PACK      OPUPDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispdayc=",QRYNAME                    *T0846427
          IF        @EQUAL
            MOVE      QRYDATA,DISPDAYC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sjogflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SJOGFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekey2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEY2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirremb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRREMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispwkno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPWKNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Set patsusaf Input Variables
.------------------------------------------------------------
PTSUSSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          BRANCH    F3,SPTSS010,SPTSS020,SPTSS030,SPTSS040,SPTSS050:
                       SPTSS060,SPTSS070,SPTSS080
.
SPTSS010  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTSUS001,CCENT,CYEAR,CMON,CDAY
          GOTO      SPTSS999
.
SPTSS020  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTSUS002,CCENT,CYEAR,CMON,CDAY
          GOTO      SPTSS999
.
SPTSS030  PACK      PTSUS003,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS040  PACK      PTSUS004,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS050  PACK      PTSUS005,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS060  PACK      PTSUS006,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS070  PACK      PTSUS007,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS080  PACK      PTSUS008,QRYDATA,SP70
          GOTO      SPTSS999
.
SPTSS999  RETURN
.
.------------------------------------------------------------
. Calendar view
.------------------------------------------------------------
CALV0000  MATCH     SP70,UPDTTYPE
          GOTO      CALV7000 IF EQUAL
.
..          MATCH     "U",UPDTTYPE    * XXXXXXXXXXXXXXXX
..          GOTO      CALV1000 IF EQUAL
.
          GOTO      CALV9000
.
CALV7000  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CALV9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "Calendar View",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CALV9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CALV9999
.
CALV9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CALV9999
.
CALV9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CALV9999
.
CALV9999  RETURN
.
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      LIST0000    * Calendar list views
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD22  CALL      LIST0000    * Calendar list views
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD32  CALL      SUSF0000    * Suspension fields
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45:
                             PROFLD46,PROFLD47,PROFLD48
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD42  CALL      PMTS0000    * Transport fields
          GOTO      PROFLD99
.
PROFLD43  CALL      GTAG0000    * General tags
          GOTO      PROFLD99
.
PROFLD44  CALL      OBOA0000    * Outpatient booking file
          GOTO      PROFLD99
.
PROFLD45  CALL      PMCE0000    * Extra contact 
          GOTO      PROFLD99
.
PROFLD46  CALL      PMCE0000    * Extra contact 
          GOTO      PROFLD99
.
PROFLD47  CALL      VXTF0000    * Visit Extn file tags
          GOTO      PROFLD99
.
PROFLD48  CALL      GOSC0000    * Overseas contact tags from pmscexaf
          GOTO      PROFLD99  
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99
.
PROFLD51  CALL      GTAG0000    * General tags
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61
          GOTO      PROFLD99
.
PROFLD61  CALL      PMTA0000    * Facility address details
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71
          GOTO      PROFLD99
.
PROFLD71  CALL      THET0000                * Theatre diary/calendar view tags
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD82  CALL      PMBR0000    * Bed request fields
          GOTO      PROFLD99
.
PROFLD83  CALL      MISF0000    * Pre Admission / Admission fields
          GOTO      PROFLD99
.
PROFLD84  CALL      GTAG0000    * General tags
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91
          GOTO      PROFLD99
.
PROFLD91  CALL      HTAG0000    * Hospital level bed request tags
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. List views and general tags
.------------------------------------------------------------
LIST0000  BRANCH    FLDITMNO,LIST0100,LIST0200,LIST0300,LIST0400,LIST0500:
                             LIST0600,LIST0700,LIST0800,LIST0900,LIST1000:
                             LIST1100,LIST1200,LIST1300,LIST1400,LIST1500
          GOTO      LIST9999
.
LIST0100  CALL      NEXT0000
          GOTO      LIST9999
.
LIST0200  CALL      PREV0000
          GOTO      LIST9999
.
LIST0300  CALL      SELV0000
          GOTO      LIST9999
.
LIST0400  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      LIST9999
.
LIST0500  CALL      TABU0000                * Output appointments by ur
          GOTO      LIST9999
.
LIST0600  MATCH     SP70,DISPHCPC
          GOTO      LIST9999 IF EQUAL
.
          CALL      TABH0000                * Output appointments by HCP
          GOTO      LIST9999
.
LIST0700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,DISPHCPC
          GOTO      LIST9999 IF EQUAL
.
          BRANCH    F1,LIST0710
.
          PACK      KEY10,DISPHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,LIST9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      LIST9999
.
LIST0710  WRITE     HTMLFILE;DISPHCPC;
          GOTO      LIST9999
.
LIST0800  MATCH     SP70,URNUMBER
          GOTO      LIST9999 IF EQUAL
.
          WRITE     HTMLFILE;URNUMBER;
          GOTO      LIST9999
.
LIST0900  MATCH     SP70,URNUMBER
          GOTO      LIST9999 IF EQUAL
. 
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,LIST9999
.
          CALL      PATNAA00
          WRITE     HTMLFILE;PATFNAME;
.
          GOTO      LIST9999
.
LIST1000  MATCH     SP70,URNUMBER
          GOTO      LIST9999 IF EQUAL
. 
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,LIST9999
.
          CALL      PATNAA00
.
          WRITE     HTMLFILE;"<td class=InpCell align=left width=9%>":
                             "Admission</td>":
                             "<td class=TheCell align=left width=9%>":
                             "Theatre Session</td>":
                             "<td class=OutCell align=left width=9%>":
                             "Scheduled Appts</td>":
                             "<td class=HeadingCell align=center>":
                             PATFNAME," Calendar View</td>";
.
          GOTO      LIST9999
.
LIST1100  MATCH     SP70,URNUMBER
          GOTO      LIST9999 IF EQUAL
.
          CALL      CARR0000                * Clear array                     
          CALL      TABU0000                * Output appointments by ur
          GOTO      LIST9999
.
LIST1200  CALL      FAPP0000                * FHIR Outpatient Appointments by HCP by Day
          GOTO      LIST9999
.
LIST1300  CALL      OUTFHR00                * FHIR Outpatient Appointments by Logic ID
          GOTO      LIST9999
.
LIST1400  CALL      ATTFHR00                * FHIR Outpatient Attendance by Logic ID
          GOTO      LIST9999
.
LIST1500  CALL      DISFHR00                * FHIR Outpatient Discharge by Logic ID
          GOTO      LIST9999
.
LIST9999  RETURN
.------------------------------------------------------------
. FHIR Appointment List by HCP
.------------------------------------------------------------
APPLST00  
          CALL      OUTAPP00                          * Load HCP outpatient
          CALL      THEAPP00                          * Load HCP theatre
.
APPLST99  RETURN
.------------------------------------------------------------
. Suspension tags
.------------------------------------------------------------
SUSF0000  BRANCH    FLDITMNO,SUSF0100,SUSF0200,SUSF0300,SUSF0400,SUSF0500:
                             SUSF0600,SUSF0700,SUSF0800,SUSF0900,SUSF1000:
                             SUSF1100,SUSF1200,SUSF1300,SUSF1400,SUSF1500:
                             SUSF1600
          GOTO      SUSF9999
.
SUSF0100  MATCH     SP70,PTSSFDAT
          GOTO      SUSF9999 IF EQUAL
          GOTO      SUSF9999 IF EOS
          UNPACK    PTSSFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      SUSF9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUSF9999
.
SUSF0200  MATCH     SP70,PTSSTDAT
          GOTO      SUSF9999 IF EQUAL
          GOTO      SUSF9999 IF EOS
          UNPACK    PTSSTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      SUSF9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUSF9999
.
SUSF0300  MOVE      "FC",CATEGORY
          MOVE      PTSSRFCS,CODE
          CALL      CODITM00
          GOTO      SUSF9999
.
SUSF0400  MOVE      "FD",CATEGORY
          MOVE      PTSSREAS,CODE
          CALL      CODITM00
          GOTO      SUSF9999
.
SUSF0500  WRITE     HTMLFILE;PTSSCOM1
          GOTO      SUSF9999
.
SUSF0600  WRITE     HTMLFILE;PTSSCOM2
          GOTO      SUSF9999
.
SUSF0700  MATCH     SP70,PTSSWEBC
          GOTO      SUSF9999 IF EQUAL
          PACK      KEY10,PTSSWEBC
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTSSWEBC,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      SUSF9999
.
SUSF0800  MATCH     PTSSDATC,SP70
          GOTO      SUSF9999 IF EQUAL
          UNPACK    PTSSDATC,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUSF9999
.
SUSF0900  WRITE     HTMLFILE;PTSSTIMC;
          GOTO      SUSF9999
.
SUSF1000  MATCH     SP70,PTSSWEBU
          GOTO      SUSF9999 IF EQUAL
          PACK      KEY10,PTSSWEBU
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTSSWEBU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      SUSF9999
.
SUSF1100  MATCH     PTSSDATU,SP70
          GOTO      SUSF9999 IF EQUAL
          UNPACK    PTSSDATU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUSF9999
.
SUSF1200  WRITE     HTMLFILE;PTSSTIMU;
          GOTO      SUSF9999
.
SUSF1300  CALL      SUSL0000        * List suspesions
          GOTO      SUSF9999
.
SUSF1400  WRITE     HTMLFILE;URNUMBER,PTSSFDAT;
          GOTO      SUSF9999
.
SUSF1500  PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
SUSF1550  CALL      RDKTREA1
          BRANCH    OVRCD,SUSF9999
          MATCH     URNUMBER,WMURNO
          GOTO      SUSF9999 IF NOT EQUAL
.
          MATCH     "1",DWMSTAT
          GOTO      SUSF1550 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      SUSF9999
.
SUSF1600  MOVE      "VL",CATEGORY      * RFC Status Selection List for
          MOVE      SP70,CODE          * suspensions all values are NOT RFC
          CALL      SLSTAT00
          GOTO      SUSF9999
.
SUSF9999  RETURN
+
.---------------------------------------------------------------------
. SLSTAT00 - Selection list for cat VL where TCINDC1 is not equal to R
.---------------------------------------------------------------------
SLSTAT00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
SLSTAT10  CALL      RDKCODE2
          BRANCH    OVRCD,SLSTAT99
          MATCH     CATEGORY,TCODE
          GOTO      SLSTAT99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      SLSTAT10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SLSTAT10 IF EQUAL
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY20," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     ANSR,TCINDC1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<option value=",KEY20,">",TDESC,"</option>"
            ENDIF
          ENDIF
          GOTO      SLSTAT10
SLSTAT99  RETURN
.
.*******************************************************************************
. List suspension records
.*******************************************************************************
SUSL0000  PACK      KEY16,URNUMBER,SP70
          CALL      RSPTSUS1
SUSL1000  CALL      RKPTSUS1
          BRANCH    OVRCD,SUSL9999
.
          MATCH     URNUMBER,PTSSURNO
          GOTO      SUSL9999 IF NOT EQUAL
.
          MOVE      SP70,RFCSDESC
          PACK      KEY5,ANSF,ANSC,PTSSRFCS,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      RFCSDESC,TDESC,SP70
          ENDIF
          MOVE      SP70,REASDESC
          PACK      KEY5,ANSF,ANSD,PTSSREAS,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      REASDESC,TDESC,SP70
          ENDIF
          UNPACK    PTSSFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FROMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY10,PTSSWEBC
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTSSWEBC,WBSENAM
          ENDIF
          CLEAR     HTMLLINK
          APPEND    "javascript:updateSuspension('",HTMLLINK
          APPEND    PTSSURNO,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    FROMDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PTSSFDAT,"#",":
                             "#"",PTSSTDAT,"#",":
                             "#"",RFCSDESC,"#",":
                             "#"",REASDESC,"#",":
                             "#"",WBSENAM,"#");";
          GOTO      SUSL1000
.
SUSL9999  RETURN
+
.*******************************************************************************
. Clear display array
.*******************************************************************************
CARR0000 MOVE      ONE,COUNT
          WHILE     COUNT <= 23
            PACK      DISPLDAY[COUNT][1],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][2],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][3],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][4],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][5],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][6],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            PACK      DISPLDAY[COUNT][7],SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70:
                                         SP70,SP70,SP70,SP70,SP70
            ADD       ONE,COUNT
          DO
.
CARR9999  RETURN
.
.*******************************************************************************
.                          Next Day, Week, Month
.*******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTBOOK
          REP       " +",FILTCONT
          REP       " +",FILTUNIT
          REP       " +",FILTTLOC
          REP       " +",FILTSTAT
          REP       " +",FILTWARD
          REP       " +",DISPHCPC
          REP       " +",SHOWFLAG
          REP       " +",SHOWHOSP
          REP       " +",FILTHOSP
          REP       " +",SJOGFLAG
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb10.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&admissno=",ADMISSNO:
                             "&disphcpc=",DISPHCPC:
                             "&urnumber=",URNUMBER:
                             "&filtbook=",FILTBOOK:
                             "&filtcont=",FILTCONT:
                             "&filtunit=",FILTUNIT:
                             "&filttloc=",FILTTLOC:
                             "&filtstat=",FILTSTAT:
                             "&filtward=",FILTWARD:
                             "&showflag=",SHOWFLAG:
                             "&showhosp=",SHOWHOSP:
                             "&filthosp=",FILTHOSP:
                             "&deftview=",DEFTVIEW:
                             "&sjogflag=",SJOGFLAG:
                             "&dispwkno=",DISPWKNO;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",FILTBOOK
          REP       "+ ",FILTCONT
          REP       "+ ",FILTUNIT
          REP       "+ ",FILTTLOC
          REP       "+ ",FILTSTAT
          REP       "+ ",FILTWARD
          REP       "+ ",DISPHCPC
          REP       "+ ",SHOWFLAG
          REP       "+ ",SHOWHOSP
          REP       "+ ",FILTHOSP
          REP       "+ ",SJOGFLAG
.
NEXT9999  RETURN
.*******************************************************************************
.                          Previous Day, Week, Month
.*******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTBOOK
          REP       " +",FILTCONT
          REP       " +",FILTUNIT
          REP       " +",FILTTLOC
          REP       " +",FILTSTAT
          REP       " +",FILTWARD
          REP       " +",DISPHCPC
          REP       " +",SHOWFLAG
          REP       " +",SHOWHOSP
          REP       " +",FILTHOSP
          REP       " +",SJOGFLAG
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb10.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&admissno=",ADMISSNO:
                             "&disphcpc=",DISPHCPC:
                             "&urnumber=",URNUMBER:
                             "&filtbook=",FILTBOOK:
                             "&filtcont=",FILTCONT:
                             "&filtunit=",FILTUNIT:
                             "&filttloc=",FILTTLOC:
                             "&filtstat=",FILTSTAT:
                             "&filtward=",FILTWARD:
                             "&showflag=",SHOWFLAG:
                             "&showhosp=",SHOWHOSP:
                             "&filthosp=",FILTHOSP:
                             "&deftview=",DEFTVIEW:
                             "&sjogflag=",SJOGFLAG:
                             "&dispwkno=",DISPWKNO;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",FILTBOOK
          REP       "+ ",FILTCONT
          REP       "+ ",FILTUNIT
          REP       "+ ",FILTTLOC
          REP       "+ ",FILTSTAT
          REP       "+ ",FILTWARD
          REP       "+ ",DISPHCPC
          REP       "+ ",SHOWFLAG
          REP       "+ ",SHOWHOSP
          REP       "+ ",FILTHOSP
          REP       "+ ",SJOGFLAG
.
PREV9999  RETURN
.
.*******************************************************************************
.  Display appointments by day for a urnumber
.*******************************************************************************
TABU0000  WRITE     HTMLFILE;"<tr height=26>";
.
          CALL      LDAY0000                           * Load daily appointments
.
          CALL      DTIM0000                           * Display times
.
          MOVE      ZERO,DDAYFLAG                      * Start on Monday
TABU8000  ADD       ONE,DDAYFLAG
.
          MATCH     FRSTDATE,LASTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>"
          ELSE
            WRITE     HTMLFILE;"<td width=13%>"
          ENDIF
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr height=26>";
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 23
.
            MOVE      SP1,DISPCLAS
            UNPACK    DISPLDAY[COUNT][DDAYFLAG],D1:
                      DISPLDAY[COUNT][DDAYFLAG]
            MOVE      ZERO,F1
            MOVE      D1,F1
            LOAD      DISPCLAS,F1,LOADCLS1,LOADCLS2,LOADCLS3,LOADCLS4
.
            IF        COUNT=1
              WRITE     HTMLFILE;"<tr height=26><td nowrap ",DISPCLAS," ":
                                 "align=center>":
                                 DISPLDAY[COUNT][DDAYFLAG]:
                                 "&nbsp;</td></tr>";
            ELSE
              WRITE     HTMLFILE;"<tr height=26><td nowrap ",DISPCLAS,">":
                                 DISPLDAY[COUNT][DDAYFLAG]:
                                 "&nbsp;</td></tr>";
            ENDIF
            ADD       ONE,COUNT
          DO
.
          WRITE     HTMLFILE;"</tr></table></td>";
.
          COMPARE   SEVEN,DDAYFLAG                    * Last day of week
          GOTO      TABU9500 IF EQUAL
.
          MATCH     "0",VIEWTYPE                      * Day or week display
          GOTO      TABU8000 IF NOT EQUAL
.
TABU9500  WRITE     HTMLFILE;"</tr>";
.
TABU9999  RETURN
.
.*******************************************************************************
. Display appointment times col
.*******************************************************************************
DTIM0000  WRITE     HTMLFILE;"<td width=8%>":
                    "<table cellspacing=0 cellpadding=1 border=1 ":
                    "width=100% align=center ><tr height=26>":
                    "<tr height=26><td class=HeadingCell align=center nowrap>":
                    "Date/Time</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "Before&nbsp8:00</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "8:00</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "8:30</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "9:00</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "9:30</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[7],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[8],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[9],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[10],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[11],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[12],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[13],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[14],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[15],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[16],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[17],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[18],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[19],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[20],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[21],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TIMEARRY[22],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "After&nbsp;",TIMEARRY[23],"</td></tr>":
                    "</tr></table></td>";
.
DTIM9999  RETURN
.
.*******************************************************************************
. Load daily appointments array for a u/r monday to sunday 
.*******************************************************************************
LDAY0000  MOVE      ONE,WORKDAYF
          MOVE      FRSTDATE,WORKDATE
.
LDAY1000  UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          PACK      DISPLDAY[ONE][WORKDAYF],ONE,DAYNAM,SP1:
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          CALL      LINP0000                          * Load inpatient
          CALL      LOUT0000                          * Load outpatient
          CALL      LOPR0000                          * Load theatre
.
          COMPARE   SEVEN,WORKDAYF                    * Last day of week
          GOTO      LDAY9999 IF EQUAL
.
          MATCH     "0",VIEWTYPE                      * Day display so exit
          GOTO      LDAY9999 IF EQUAL
.
          ADD       ONE,WORKDATE
          ADD       ONE,WORKDAYF                      * Add one day array 
          GOTO      LDAY1000
.
LDAY9999  RETURN
.
.*******************************************************************************
. Load daily inpatient admissions
.*******************************************************************************
LINP0000  MATCH     WORKDATE,FRSTDATE
          GOTO      LINP0500 IF NOT EQUAL 
.
          CALL      CHKL0000                * Check last admission for overlap
.
LINP0500  PACK      KEY24,URNUMBER,WORKDATE,SP70
          CALL      RDSVISA2
LINP1000  CALL      RDKVISA2
          BRANCH    OVRCD,LINP9999
.
          MATCH     URNUMBER,PVIURNO
          GOTO      LINP9999 IF NOT EQUAL
.
          MATCH     WORKDATE,PVIDATE
          GOTO      LINP9999 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE           * Match For Visit Type Inpatient
          GOTO      LINP1000 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,LINP9999
.
          CALL      DRAN0000               * Work out admission date range
.
          CLEAR     DOCFNAME
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,LINP2000
.
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          STRIP     DOCFNAME
.
LINP2000  PACK      KEY50,DOCFNAME,DASH,PTMIXWRD,SP70
.
LINP5000  MOVE      TWO,FILLCLAS
          PACK      FILLDESC,KEY50,SP70,SP70,SP70,SP70
.
          CALL      FILL0000
.
          MATCH     ADMIDATE,EXPDDATE       * Only display one day adate = ddate
          GOTO      LINP9999 IF EQUAL
.
          COMPARE   SEVEN,WORKDAYF          * End of week display
          GOTO      LINP9999 IF EQUAL
.
          MOVE      WORKDAYF,SAVWDAYF
LINP6000  ADD       ONE,ADMIDATE            * Fill until expected disc date
          ADD       ONE,WORKDAYF
.
          MOVE      "00:01",STRTTIME
          MOVE      "23:59",ENDTIME
          PACK      FILLDESC,SP70,SP70,SP70,SP70
          CALL      FILL0000
.       
          COMPARE   SEVEN,WORKDAYF
          IF        @EQUAL
            MOVE      SAVWDAYF,WORKDAYF
            GOTO      LINP9999
          ENDIF
.
          MATCH     ADMIDATE,EXPDDATE       * Exit if equal to exp discharge
          IF        @EQUAL
            MOVE      SAVWDAYF,WORKDAYF
            GOTO      LINP9999
          ENDIF
.
          MATCH     ADMIDATE,LASTDATE       * Exit if end of display
          GOTO      LINP6000 IF NOT EQUAL
.
          MOVE      SAVWDAYF,WORKDAYF
          GOTO      LINP9999
.
LINP9999  RETURN
.
.
.*******************************************************************************
. Load daily outpatient appointments
.*******************************************************************************
LOUT0000  PACK      KEY36,URNUMBER,WORKDATE,SP70
          CALL      RDSBOKA3
LOUT1000  CALL      RDKBOKA3
          BRANCH    OVRCD,LOUT9999
.
          MATCH     OBAURNO,URNUMBER
          GOTO      LOUT9999 IF NOT EQUAL
.
          MATCH     OBADATE,WORKDATE
          GOTO      LOUT9999 IF NOT EQUAL
.
          BRANCH    OBASTAT,LOUT1500,LOUT1000,LOUT1000,LOUT1500,LOUT1500:
                            LOUT1500
          GOTO      LOUT1000 
.
LOUT1500  CALL      GETO0000                * Get slot count and end time
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1             * Clinic Table
          IF        OVRCD=0
            GOTO      LOUT2000
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,LOUT1000
.
          MATCH     OBASITE,OCASITE
          GOTO      LOUT1000 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      LOUT1000 IF NOT EQUAL
.
LOUT2000  MOVE      THREE,FILLCLAS
          MOVE      OBATIME,STRTTIME
          PACK      FILLDESC,OCADESC,SP70,SP70,SP70,SP70
          CALL      FILL0000
          GOTO      LOUT1000
.
LOUT9999  RETURN
.
.------------------------------------------------------------
. Fill time arrays with booking type class, and description
. If the time already has a patient append a comma and the
. additional patient name.
. FILLCLAS - 1 class=HeadingCell
.            2 class=InpCell
.            3 class=OutCell
.            4 class=TheCell
. STRTTIME - Time start for booking
. ENDTIME  - Time end for booking
.------------------------------------------------------------
FILL0000  MOVE      TWENTY4,LCOUNT
.
FILL2500  SUB       ONE,LCOUNT
.
          COMPARE   ONE,LCOUNT
          GOTO      FILL9999 IF EQUAL
.
          IF        LCOUNT=23
            MATCH     TIMEARRY[LCOUNT],STRTTIME        * booking  => 18:00
            IF        !@LESS
              MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
              IF        @EQUAL
                PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,FILLDESC,SP70:
                          SP70,SP70,SP70
              ELSE
                STRIP     DISPLDAY[LCOUNT][WORKDAYF]
                ENDSET    DISPLDAY[LCOUNT][WORKDAYF]
                MOVELPTR  DISPLDAY[LCOUNT][WORKDAYF],F4
                IF        F4>1
                  APPEND    COMMA,DISPLDAY[LCOUNT][WORKDAYF]
                  APPEND    SP1,DISPLDAY[LCOUNT][WORKDAYF]
                ENDIF
                APPEND    FILLDESC,DISPLDAY[LCOUNT][WORKDAYF]
                RESET     DISPLDAY[LCOUNT][WORKDAYF]
              ENDIF
              GOTO      FILL9999
            ENDIF
            MATCH     TIMEARRY[LCOUNT],ENDTIME        * booking end => 18:00
            IF        !@LESS
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,SP70
            ENDIF
          ENDIF
.
          IF        LCOUNT=2
            MATCH     TIMEARRY[LCOUNT],STRTTIME        * booking  <= 8:00
            IF        @LESS
              MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
              IF        @EQUAL
                PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,FILLDESC,SP70:
                          SP70,SP70,SP70
              ELSE
                STRIP     DISPLDAY[LCOUNT][WORKDAYF]
                ENDSET    DISPLDAY[LCOUNT][WORKDAYF]
                MOVELPTR  DISPLDAY[LCOUNT][WORKDAYF],F4
                IF        F4>1
                  APPEND    COMMA,DISPLDAY[LCOUNT][WORKDAYF]
                  APPEND    SP1,DISPLDAY[LCOUNT][WORKDAYF]
                ENDIF
                APPEND    FILLDESC,DISPLDAY[LCOUNT][WORKDAYF]
                RESET     DISPLDAY[LCOUNT][WORKDAYF]
              ENDIF
              GOTO      FILL9999
            ENDIF
            MATCH     TIMEARRY[LCOUNT],ENDTIME        * booking end <= 8:00
            IF        @LESS
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,SP70
            ENDIF
          ENDIF
.
          MATCH     STRTTIME,TIMEARRY[LCOUNT]         * booking = array time
          IF        @EQUAL
            MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
            IF        @EQUAL
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,FILLDESC,SP70:
                        SP70,SP70,SP70
            ELSE
              STRIP     DISPLDAY[LCOUNT][WORKDAYF]
              ENDSET    DISPLDAY[LCOUNT][WORKDAYF]
              MOVELPTR  DISPLDAY[LCOUNT][WORKDAYF],F4
              IF        F4>1
                APPEND    COMMA,DISPLDAY[LCOUNT][WORKDAYF]
                APPEND    SP1,DISPLDAY[LCOUNT][WORKDAYF]
              ENDIF
              APPEND    FILLDESC,DISPLDAY[LCOUNT][WORKDAYF]
              RESET     DISPLDAY[LCOUNT][WORKDAYF]
            ENDIF
            GOTO      FILL9999
          ENDIF
.
          MATCH     STRTTIME,TIMEARRY[LCOUNT]        * array < booking time
          IF        @LESS
            MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
            IF        @EQUAL
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,FILLDESC,SP70:
                        SP70,SP70,SP70
            ELSE
              STRIP     DISPLDAY[LCOUNT][WORKDAYF]
              ENDSET    DISPLDAY[LCOUNT][WORKDAYF]
              MOVELPTR  DISPLDAY[LCOUNT][WORKDAYF],F4
              IF        F4>1
                APPEND    COMMA,DISPLDAY[LCOUNT][WORKDAYF]
                APPEND    SP1,DISPLDAY[LCOUNT][WORKDAYF]
              ENDIF
              APPEND    FILLDESC,DISPLDAY[LCOUNT][WORKDAYF]
              RESET     DISPLDAY[LCOUNT][WORKDAYF]
            ENDIF
            GOTO      FILL9999
          ENDIF
.
          MATCH     ENDTIME,TIMEARRY[LCOUNT]         * booking end = array time
          IF        @EQUAL
            MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
            IF        @EQUAL
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,SP70
            ENDIF
          ENDIF
.
          MATCH     ENDTIME,TIMEARRY[LCOUNT]        * array < booking end
          IF        @LESS
            MATCH     SP70,DISPLDAY[LCOUNT][WORKDAYF]
            IF        @EQUAL
              PACK      DISPLDAY[LCOUNT][WORKDAYF],FILLCLAS,SP70
            ENDIF
          ENDIF
.
          GOTO      FILL2500
.
FILL9999  RETURN
.
.------------------------------------------------------------
. Get Slot Count and estimate booking end time 
.------------------------------------------------------------
GETO0000  MOVE      ONE,CNTSLOTS
          MOVE      OBATIME,ENDTIME
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GETO9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT:
                          OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GETO9999
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GETO9999
.
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,CNTSLOTS
.
GETO2000  UNPACK    ENDTIME,KEY2,KEY1,MIN   * HH:MM
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       OTHEDURN,MINUTES        * Add 1 slot duration
.
          IF        CNTSLOTS=1
            SUB       ONE,MINUTES           * Sub one minute from endtime
          ENDIF
.
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            MOVE      TIME,MINTIME
            MOVE      MINTIME,MIN
            ADD       ONE,HOUR
          ELSE
            MOVE      MINUTES,MINTIME
            MOVE      MINTIME,MIN
          ENDIF
.
          PACK      ENDTIME,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REPLACE   " 0",ENDTIME            * replace spaces with zero
.
          SUB       ONE,CNTSLOTS
.
          MATCH     TIMEARRY[23],ENDTIME        * If end time >= 18:00 exit
          GOTO      GETO9999 IF NOT LESS
.
          COMPARE   ZERO,CNTSLOTS
          GOTO      GETO2000 IF NOT EQUAL
.
GETO9999  RETURN
.
.----------------------------------------------------------------------------
. Get booking start time and estimate booking end time from expected duration
.----------------------------------------------------------------------------
GETT0000  MOVE      STRTTIME,ENDTIME
.
          MATCH     TIMEARRY[23],ENDTIME    * If end time >= 18:00 exit
          GOTO      GETT9999 IF NOT LESS
.
          COMPARE   ZERO,OPDAEXPD
          IF        @EQUAL
            MOVE      ONE,OPDAEXPD          * Defalut duration to 1 minute
          ENDIF
.
          CALL      CENDTM00                * Calculate end time
.
          MOVE      CENDTME,ENDTIME
.
GETT9999  RETURN
.
.
.***********************************************************************
.*  CENDTM00  :  Calculate an end time given a start time and duration *
.*        Para's  : STRTTIME      the start time                       *
.*                  DURATION      the duration                         *
.*        Returns : CENDTME       the end time                         *
.***********************************************************************
CENDTM00  UNPACK    STRTTIME,CHOUR,ANS,CMIN
          REP       " 0",CHOUR
          REP       " 0",CMIN
          MOVE      CHOUR,CCOL1             * the hours
          MOVE      CMIN,FORM2              * the minutes
          MOVE      OPDAEXPD,DURATION
.
          ASSIGN    (CCOL1*60+FORM2),FORM4  * total minutes
          ADD       DURATION,FORM4          * take of duration
.
. if duration -ve then means gone before 00:00
.
          IF        FORM4<0
            ASSIGN    (1440+DURATION),FORM4
          ENDIF
.
          ASSIGN    (FORM4/60),CCOL1        * total hours
          ASSIGN    (FORM4-(CCOL1*60)),CCOL2    * total minutes
.
.         check hours aren't over 23
.
CENDTM50  COMPARE   "24",CCOL1
          GOTO      CENDTM70 IF LESS        * hours not over 24
.
          SUB       "24",CCOL1
          GOTO      CENDTM50
.
CENDTM70  MOVE      CCOL2,FORM2             * the minutes
          PACK      CENDTME,CCOL1,COLON,FORM2
          REP       " 0",CENDTME
.
CENDTM99  RETURN
.
.*******************************************************************************
. Load daily theatre bookings
.*******************************************************************************
LOPR0000  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6                * Reading For the Visit No.
LOPR1000  CALL      RKBKREC6                * Reading From Booking Table
          BRANCH    OVRCD,LOPR9999
.
          MATCH     URNUMBER,BKREURNO
          GOTO      LOPR9999 IF NOT EQUAL
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
LOPR1100  CALL      RKOPDEA2                * Reading Through Operation Detail
          BRANCH    OVRCD,LOPR1000
.
          MOVE      BKREBOOK,KEY8
          MATCH     KEY8,OPDAADMN
          GOTO      LOPR1000 IF NOT EQUAL
.
          MATCH     OPDADATE,WORKDATE       * Correct day
          GOTO      LOPR1000 IF NOT EQUAL
.
          MOVE      SP70,KEY50
          COMPARE   ZERO,OPCNCLSU
          GOTO      LOPR2000 IF NOT EQUAL   * Checking For The CLinic Status
.
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,LOPR5000
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY50        * For Displaying Clinic Descrition
            GOTO      LOPR5000
          ENDIF
.
LOPR2000  PACK      KEY6,OPDACLIN,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,LOPR5000
.
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY50
.
LOPR5000  MOVE      OPDATIME,STRTTIME
.
          MATCH     SP70,OPDAEXPS
          IF        !@EQUAL
            MOVE      OPDAEXPS,STRTTIME
          ENDIF
.
          CALL      GETT0000                * Calculate booking end time
.
          MOVE      FOUR,FILLCLAS
          PACK      FILLDESC,KEY50,SP70,SP70,SP70,SP70
          CALL      FILL0000
          GOTO      LOPR1000
.
LOPR9999  RETURN
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA1 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA6  * Get the name of the CLIA6 file
          CLOSE     OUTCLIA6
          OPEN      OUTCLIA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.     
          PACK      CFNAME,CFILEPRE,FILDIAG1  * Get the name of the DIAG1 file
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXSCA1  * Get the name of the XSCA1 file
          CLOSE     OUTXSCA1
          OPEN      OUTXSCA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXWPA1  * Get the name of the XWPA1 file
          CLOSE     OUTXWPA1
          OPEN      OUTXWPA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A2
          CLOSE     OUTMA1A2
          CALL      OPOTMA12                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CLIA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRSHA1
          CLOSE     OUTRSHA1
          OPEN      OUTRSHA1,CFNAME          * Open the rescheduling file
.
          PACK      CFNAME,CFILEPRE,FILLKBA1
          CLOSE     OUTLKBA1
          OPEN      OUTLKBA1,CFNAME          * Open the linked booking file
.
          PACK      CFNAME,CFILEPRE,FILLKBA2
          CLOSE     OUTLKBA2
          OPEN      OUTLKBA2,CFNAME          * Open the linked booking file
.
          PACK      CFNAME,CFILEPRE,FILCVTA1  * Get the name of the CVTA1 file
          CLOSE     OUTCVTA1
          OPEN      OUTCVTA1,CFNAME           * Open the file
.
OPNOUT99  RETURN
.
.------------------------------------------------------------
. Set time array fields for appointment time classes
.------------------------------------------------------------
SETT0000  MOVE      "",TIMEARRY[1]
          MOVE      "08:00",TIMEARRY[2]
          MOVE      "08:00",TIMEARRY[3]
          MOVE      "08:30",TIMEARRY[4]
          MOVE      "09:00",TIMEARRY[5]
          MOVE      "09:30",TIMEARRY[6]
          MOVE      "10:00",TIMEARRY[7]
          MOVE      "10:30",TIMEARRY[8]
          MOVE      "11:00",TIMEARRY[9]
          MOVE      "11:30",TIMEARRY[10]
          MOVE      "12:00",TIMEARRY[11]
          MOVE      "12:30",TIMEARRY[12]
          MOVE      "13:00",TIMEARRY[13]
          MOVE      "13:30",TIMEARRY[14]
          MOVE      "14:00",TIMEARRY[15]
          MOVE      "14:30",TIMEARRY[16]
          MOVE      "15:00",TIMEARRY[17]
          MOVE      "15:30",TIMEARRY[18]
          MOVE      "16:00",TIMEARRY[19]
          MOVE      "16:30",TIMEARRY[20]
          MOVE      "17:00",TIMEARRY[21]
          MOVE      "17:30",TIMEARRY[22]
          MOVE      "18:00",TIMEARRY[23]
.
SETT9999  RETURN
.
.*******************************************************************************
. Check admission before workdate to see if the admission date range overlaps
.*******************************************************************************
CHKL0000  PACK      KEY24,URNUMBER,WORKDATE,SP70
          CALL      RDSVISA2
CHKL1000  CALL      RDPVISA2
          BRANCH    OVRCD,CHKL9999
.
          MATCH     URNUMBER,PVIURNO
          GOTO      CHKL9999 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE           * Match For Visit Type Inpatient
          GOTO      CHKL1000 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKL9999
.
          CALL      DRAN0000               * Work out admission date range
.
          MATCH     WORKDATE,ADMIDATE      * Prev admission before start date
          GOTO      CHKL9999 IF NOT LESS
.
          MATCH     EXPDDATE,WORKDATE      * Expected disc after start date
          GOTO      CHKL4000 IF EQUAL
.
          MATCH     EXPDDATE,WORKDATE      * Expected disc after start date
          GOTO      CHKL9999 IF NOT LESS
.
CHKL4000  MOVE      "00:01",STRTTIME       * Set start date to work date
          MOVE      WORKDATE,ADMIDATE      * for fill
.
CHKL5000  MOVE      TWO,FILLCLAS
          PACK      FILLDESC,SP70,SP70,SP70,SP70
.
          CALL      FILL0000
.
          MATCH     ADMIDATE,EXPDDATE       * Only display one day adate = ddate
          GOTO      CHKL9999 IF EQUAL
.
          COMPARE   SEVEN,WORKDAYF          * End of week display
          GOTO      CHKL9999 IF EQUAL
.
          MOVE      WORKDAYF,SAVWDAYF
CHKL6000  ADD       ONE,ADMIDATE            * Fill until expected disc date
          ADD       ONE,WORKDAYF
.
          MOVE      "00:01",STRTTIME
          MOVE      "23:59",ENDTIME
          PACK      FILLDESC,SP70,SP70,SP70,SP70
          CALL      FILL0000
.
          COMPARE   SEVEN,WORKDAYF
          IF        @EQUAL
            MOVE      SAVWDAYF,WORKDAYF
            GOTO      CHKL9999
          ENDIF
.
          MATCH     ADMIDATE,EXPDDATE       * Exit if equal to exp discharge
          IF        @EQUAL
            MOVE      SAVWDAYF,WORKDAYF
            GOTO      CHKL9999
          ENDIF
.
          MATCH     ADMIDATE,LASTDATE       * Exit if end of display
          GOTO      CHKL6000 IF NOT EQUAL
.
          MOVE      SAVWDAYF,WORKDAYF
.
CHKL9999  RETURN
.
.*******************************************************************************
. Work out admission and discharge date range according to expected LOS
.*******************************************************************************
DRAN0000  MOVE      ADATE,ADMIDATE
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,DRAN4000
.
          MOVE      DDATE,EXPDDATE
          GOTO      DRAN4500
.
DRAN4000  MOVE      ADATE,EXPDDATE
          ADD       ASTAY,EXPDDATE
.
DRAN4500  MOVE      ATIME,STRTTIME
          MOVE      "23:59",ENDTIME
.
DRAN9999  RETURN
.
.------------------------------------------------------------
. HCP Calendar view
.------------------------------------------------------------
HCPV0000  MATCH     SP70,UPDTTYPE
          GOTO      HCPV7000 IF EQUAL
.
..          MATCH     "U",UPDTTYPE    * XXXXXXXXXXXXXXXX
..          GOTO      HCPV1000 IF EQUAL
.
          GOTO      HCPV9000
.
HCPV7000  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "HCP Calendar View",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,HCPV9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      HCPV9999
.
HCPV9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      HCPV9999
.
HCPV9999  RETURN
.
.
.*******************************************************************************
.  Display appointments by day for a HCP
.*******************************************************************************
TABH0000  WRITE     HTMLFILE;"<tr height=26>";
.
          CALL      LHCP0000                     * Load daily HCP appointments
.
          CALL      DTIM0000                           * Display times
.
          MOVE      ZERO,DDAYFLAG                      * Start on Monday
TABH8000  ADD       ONE,DDAYFLAG
.
          MATCH     FRSTDATE,LASTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>"
          ELSE
            WRITE     HTMLFILE;"<td width=13%>"
          ENDIF
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr height=26>";
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 23
.
            MOVE      SP1,DISPCLAS
            UNPACK    DISPLDAY[COUNT][DDAYFLAG],D1:
                      DISPLDAY[COUNT][DDAYFLAG]
            MOVE      ZERO,F1
            MOVE      D1,F1
            LOAD      DISPCLAS,F1,LOADCLS1,LOADCLS2,LOADCLS3,LOADCLS4
.
            IF        COUNT=1
              WRITE     HTMLFILE;"<tr height=26><td nowrap ",DISPCLAS,"  ":
                                 "align=center>":
                                 DISPLDAY[COUNT][DDAYFLAG]:
                                 "&nbsp;</td></tr>";
            ELSE
              WRITE     HTMLFILE;"<tr height=26><td nowrap ",DISPCLAS,">":
                                 DISPLDAY[COUNT][DDAYFLAG]:
                                 "&nbsp;</td></tr>";
            ENDIF
            ADD       ONE,COUNT
          DO
.
          WRITE     HTMLFILE;"</tr></table></td>";
.
          COMPARE   SEVEN,DDAYFLAG                    * Last day of week
          GOTO      TABH9500 IF EQUAL
.
          MATCH     "0",VIEWTYPE                      * Day or week display
          GOTO      TABH8000 IF NOT EQUAL
.
TABH9500  WRITE     HTMLFILE;"</tr>";
.
TABH9999  RETURN
.
.
.*******************************************************************************
. Load daily appointments array for a HCP monday to sunday
.*******************************************************************************
LHCP0000  MATCH     SP70,DISPHCPC           * Exit of not HCP selected
          GOTO      LHCP9999 IF EQUAL
.
          MOVE      ONE,WORKDAYF
          MOVE      FRSTDATE,WORKDATE
.
LHCP1000  UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          PACK      DISPLDAY[ONE][WORKDAYF],ONE,DAYNAM,SP1:
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          CALL      COPN0000                          * Load HCP outpatient
          CALL      CTHE0000                          * Load HCP theatre
.
          COMPARE   SEVEN,WORKDAYF                    * Last day of week
          GOTO      LHCP9999 IF EQUAL
.
          MATCH     "0",VIEWTYPE                      * Day display so exit
          GOTO      LHCP9999 IF EQUAL
.
          ADD       ONE,WORKDATE
          ADD       ONE,WORKDAYF                      * Add one day array
          GOTO      LHCP1000
.
LHCP9999  RETURN
.
.*******************************************************************************
. Check for open sessions for a HCP on a given date
.*******************************************************************************
COPN0000  MOVE      SP70,SAVECLIN
          MOVE      SP70,SAVESITE
.
          MOVE      DISPHCPC,DIM6
          PACK      KEY26,DIM6,Z70
          CALL      RDSCLIA6
COPN1000  CALL      RDPCLIA6
          BRANCH    OVRCD,COPN9999
.
          MATCH     OCADOCT,DIM6
          GOTO      COPN9999 IF NOT EQUAL
.
          MATCH     SAVECLIN,OCACLIN        * Only display clinic 1 time for
          GOTO      COPN1000 IF EQUAL       * multiple effective dates
.
          MOVE      OCASITE,SAVESITE
          MOVE      OCACLIN,SAVECLIN
.
          PACK      KEY25,SAVESITE,SAVECLIN,WORKDATE,SP70
          CALL      RDSSESA1
COPN2000  CALL      RDKSESA1
          BRANCH    OVRCD,COPN1000
.
          MATCH     SAVESITE,OSESITE
          GOTO      COPN1000 IF NOT EQUAL
.
          MATCH     SAVECLIN,OSECLIN
          GOTO      COPN1000 IF NOT EQUAL
.
          MATCH     OSEDATE,WORKDATE
          GOTO      COPN1000 IF NOT EQUAL
.
. Check the session date with the clinic setup to see if the clinic
. is still being run by the this doctor
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1                   * Read Clinic Record
            CALL      RDPCLIA1                   * Read Clinic Record
            BRANCH    OVRCD,COPN1000
.
            MATCH     OSESITE,OCASITE
            GOTO      COPN1000 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      COPN1000 IF NOT EQUAL
          ENDIF
.
          MATCH     OCADOCT,DIM6            * clinic run by same doctor
          GOTO      COPN1000 IF NOT EQUAL
.
          PACK      KEY25,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
.
          CLEAR     OSESLINK
          APPEND    "<a><img src=../images/OPSessionIconSm.gif ",OSESLINK
          APPEND    "class=ListIcon onclick=#"ClnLink(#'",OSESLINK
          APPEND    KEY25,OSESLINK
          APPEND    "#');#"></a>",OSESLINK
          RESET     OSESLINK
.
          CALL      LHOT0000
.
          GOTO      COPN2000
.
COPN9999  RETURN
.
.*******************************************************************************
. Load daily outpatient appointments for a HCP
.*******************************************************************************
LHOT0000  PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
LHOT1000  CALL      RDKBOKA1
          BRANCH    OVRCD,LHOT9999
.
          MATCH     OBASITE,OSESITE
          GOTO      LHOT9999 IF NOT EQUAL
.
          MATCH     OBACLIN,OSECLIN
          GOTO      LHOT9999 IF NOT EQUAL
.
          MATCH     OBADATE,OSEDATE
          GOTO      LHOT9999 IF NOT EQUAL
.
          MATCH     OBASTRT,OSESTRT
          GOTO      LHOT9999 IF NOT EQUAL
.
          BRANCH    OBASTAT,LHOT1500,LHOT1000,LHOT1000,LHOT1500,LHOT1500:
                            LHOT1500
          GOTO      LHOT1000
.
LHOT1500  CALL      GETO0000                * Get slot count and end time
.
LHOT2000  PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LHOT1000
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          MOVE      THREE,FILLCLAS
          MOVE      OBATIME,STRTTIME
          PACK      FILLDESC,OSESLINK,PACFNAME,SP70,SP70,SP70,SP70
          CALL      FILL0000
          GOTO      LHOT1000
.
LHOT9999  RETURN
.
.*******************************************************************************
. Load daily theatre bookings for a HCP
.*******************************************************************************
CTHE0000  PACK      KEY22,WORKDATE,SP70
          CALL      RSOPSES7
CTHE1000  CALL      RKOPSES7
          BRANCH    OVRCD,CTHE9999
.
          MATCH     OPSEDATE,WORKDATE
          GOTO      CTHE9999 IF NOT EQUAL
.
          CALL      CHKDOC00
          BRANCH    EXIT,CTHE1000
.
          PACK      KEY22,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
          CLEAR     TSESLINK
          APPEND    "<a><img src=../images/OPSessionIconSm.gif ",TSESLINK
          APPEND    "class=ListIcon onclick=#"TheLink(#'",TSESLINK
          APPEND    KEY22,TSESLINK
          APPEND    "#');#"></a>",TSESLINK
          RESET     TSESLINK
.
          CALL      LHOP0000               * Load session appointments
          GOTO      CTHE1000
.
CTHE9999  RETURN
.
.*******************************************************************************
. Check to see if the theatre session is for the correct HCP
.*******************************************************************************
CHKDOC00  IF        OPCNCLSU=1
            MATCH     DISPHCPC,OPSECLIN
            GOTO      CHKDOC90 IF EQUAL
          ENDIF
          MATCH     DISPHCPC,OPSEANAE
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSECORD
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC1
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC2
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC3
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC4
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC5
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC6
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC7
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEDCC8
          GOTO      CHKDOC90 IF EQUAL
.
          MATCH     DISPHCPC,OPSEXDOC
          GOTO      CHKDOC90 IF EQUAL
.
          MOVE      OPSECLIN,KEY6
          CALL      RDOPCLI1
          BRANCH    OVRCD,CHKDOC80
.
          MATCH     DISPHCPC,OPCLDOCT
          GOTO      CHKDOC90 IF EQUAL
.
CHKDOC80  MOVE      ONE,EXIT
          GOTO      CHKDOC99
.
CHKDOC90  MOVE      ZERO,EXIT
CHKDOC99  RETURN
.
.*******************************************************************************
. Load daily theatre bookings
.*******************************************************************************
LHOP0000  PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
LHOP1000  CALL      RKOPDEA1                * Reading Through Operation Detail
          BRANCH    OVRCD,LHOP9999
.
          MATCH     OPDAHOSP,OPSEHOSP       * Correct hospital
          GOTO      LHOP9999 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE       * Correct day
          GOTO      LHOP9999 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSETIME       * Correct time
          GOTO      LHOP9999 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSECLIN       * Correct clinic
          GOTO      LHOP9999 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT          * Skip cancelled
          GOTO      LHOP1000 IF EQUAL
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,LHOP1000
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LHOP1000
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
LHOP5000  MOVE      OPDATIME,STRTTIME
.
          MATCH     SP70,OPDAEXPS
          IF        !@EQUAL
            MOVE      OPDAEXPS,STRTTIME
          ENDIF
.
          CALL      GETT0000                * Calculate booking end time
.
          MOVE      FOUR,FILLCLAS
          PACK      FILLDESC,TSESLINK,PACFNAME,SP70,SP70,SP70,SP70
          CALL      FILL0000
          GOTO      LHOP1000
.
LHOP9999  RETURN
.
.------------------------------------------------------------
. Patient Suspension Details
.------------------------------------------------------------
PSUS0000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PSUS9500
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      PSUS5000 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      PSUS1000 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      PSUS2000 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      PSUS3000 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      PSUS9999
.
PSUS1000  CALL      ADDSUS00
          BRANCH    EXIT,PSUS9999
          PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
PSUS1100  CALL      RDKTREA1
          BRANCH    OVRCD,PSUS9999
          MATCH     URNUMBER,WMURNO
          GOTO      PSUS9999 IF NOT EQUAL
.
          MATCH     "1",DWMSTAT
          GOTO      PSUS1100 IF NOT EQUAL
          PACK      CASEKEYS,WMURNO,WMCODE,DWMCNT,SP70
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,PSUS1100
          CALL      WLSUS000
          GOTO      PSUS1100
.
PSUS2000  CALL      UPDSUS00
          GOTO      PSUS9999
.
PSUS3000  CALL      DELSUS00
          GOTO      PSUS9999
.
PSUS5000  CALL      CLRPTS00
          MATCH     Z70,PTSUS001
          IF        !@EQUAL
            PACK      KEY16,URNUMBER,PTSUS001,SP70
            CALL      RDPTSUS1
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " - Suspension Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PSUS9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PSUS9999
.
PSUS9500  MOVE      "Invalid Patient",WEBTITLE
          CALL      WINALT00
          GOTO      PSUS9999
.
PSUS9999  RETURN
.
CLRPTS00  MOVE      SP70,PTSSURNO
          MOVE      SP70,PTSSFDAT
          MOVE      SP70,PTSSTDAT
          MOVE      SP70,PTSSRFCS
          MOVE      SP70,PTSSREAS
          MOVE      SP70,PTSSWEBC
          MOVE      SP70,PTSSDATC
          MOVE      SP70,PTSSTIMC
          MOVE      SP70,PTSSWEBU
          MOVE      SP70,PTSSDATU
          MOVE      SP70,PTSSTIMU
          PACK      PTSSCOM1,SP70,SP70
          PACK      PTSSCOM2,SP70,SP70
          PACK      PTSSSPAR,SP70
.
CLRWTS99  RETURN
.----------------------------------------------------------------------
.      Suspend a Patient 
.----------------------------------------------------------------------
ADDSUS00  CALL      CLRPTS00
.
          CALL      MVSUS000                * Move Cgi Variables To File
          MOVE      PTSSFDAT,DATE1          * Move FromDate to Date1
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * current date
          REP       " 0",CURRDATE
          MATCH     SP70,PTSSTDAT
          IF        @EQUAL
            MOVE      CURRDATE,DATE2
          ELSE
            MOVE      PTSSTDAT,DATE2          * Move ToDate to Date2
          ENDIF
.
.---------loop through the patsusaf and check the patient is already ------
.---------suspended or not-------------------------------------------------
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTSUS1
ADDSUS10  CALL      RKPTSUS1
          BRANCH    OVRCD,ADDSUS20
.
          MATCH     URNUMBER,PTSSURNO
          GOTO      ADDSUS20 IF NOT EQUAL       * Exit if URNo does'nt match
.
          MOVE      ZERO,DATE3
          MOVE      ZERO,DATE4
          MOVE      PTSSFDAT,DATE3
          MOVE      PTSSTDAT,DATE4
.
.--------case when the ToDate is not entered ------------------------
.
          COMPARE   ZERO,DATE2
          IF        @EQUAL
            IF        DATE1 >= DATE3 & DATE1 <= DATE4
              GOTO      ADDSUS90
            ENDIF
            IF        DATE1 >= DATE3 & DATE4 = 0
              GOTO      ADDSUS90
            ENDIF
            IF        DATE1 <= DATE3 & DATE4 = 0
              GOTO      ADDSUS90
            ENDIF
          GOTO      ADDSUS10
          ENDIF
.
.--------case when the Fromdate and Todate are Entered----------------
.
ADDSUS11  IF        DATE3 <= DATE1 & DATE4 >= DATE1 & DATE4 <> 0
            GOTO      ADDSUS90
          ENDIF
          IF        DATE3 <= DATE2 & DATE4 >= DATE2 & DATE4 <> 0
            GOTO      ADDSUS90
          ENDIF
          IF        DATE1 < DATE3 & DATE2 > DATE4 & DATE4 <> 0
            GOTO      ADDSUS90
          ENDIF
          IF        DATE1 >= DATE3 & DATE4 = 0
            GOTO      ADDSUS90
          ENDIF
          GOTO        ADDSUS10
.
ADDSUS20  CALL      MVSUS000
.
          PACK      KEY16,PTSSURNO,PTSSFDAT,SP70
          CALL      RAPTSUS1
          IF        OVRCD=1
            PACK      PTSSWEBC,WBSEUID
            CALL      IBACLOCK
            PACK      PTSSDATC,CCC,CYY,CMM,CDD     * current date
            REP       " 0",PTSSDATC
            MOVE      CTIMEIS,PTSSTIMC
            CALL      CHKVIS00                     * check for visits
            BRANCH    EXIT,ADDSUS91,ADDSUS92,ADDSUS93
            CALL      WRPTSUS1
          ELSE
            GOTO      ADDSUS90
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ADDSUS99
.
ADDSUS90  MOVE      "Attempt to Suspend an already Suspended Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS91  CLEAR     WEBTITLE
          APPEND    "Unable to add suspension ",WEBTITLE
          APPEND    " - Patient has a preadmission in this period",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS92  CLEAR     WEBTITLE
          APPEND    "Unable to add suspension ",WEBTITLE
          APPEND    " - Patient has a booking in this period",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS93  CLEAR     WEBTITLE
          APPEND    "Unable to add suspension - ",WEBTITLE
          APPEND    "Patient has an outpatient booking in this period",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS99  RETURN
.------------------------------------------------------------
. Update Suspension
.------------------------------------------------------------
UPDSUS00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDSUS91
.
          PACK      KEY16,UPDATEKY,SP70
          CALL      RDPTSUS1
          BRANCH    OVRCD,UPDSUS90
          MOVE      PTSSFDAT,SAVEFDAT
          MOVE      PTSSTDAT,SAVETDAT
.
          CALL      MVSUS000                * Move cgi values to File Variables
.
          MOVE      PTSSFDAT,DATE1
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * current date
          REP       " 0",CURRDATE
          MATCH     SP70,PTSSTDAT
          IF        !@EQUAL
            MOVE      PTSSTDAT,DATE2
          ELSE
            MOVE      CURRDATE,DATE2
          ENDIF
.
.---------loop through the patsusaf and check the patient is already ------
.---------suspended or not-------------------------------------------------
.
UPDSUS05  PACK      KEY16,PTSSURNO,SP70
          CALL      RSPTSUS1
UPDSUS10  CALL      RKPTSUS1
          BRANCH    OVRCD,UPDSUS20
          MATCH     URNUMBER,PTSSURNO
          GOTO      UPDSUS20 IF NOT EQUAL       * Exit if URNo does'nt match
          MATCH     SAVEFDAT,PTSSFDAT
          GOTO      UPDSUS10 IF EQUAL
          MOVE      ZERO,DATE3
          MOVE      ZERO,DATE4
          MOVE      PTSSFDAT,DATE3
          MOVE      PTSSTDAT,DATE4
.
.--------case when the ToDate is not entered ------------------------
.
          COMPARE   ZERO,DATE2
          IF        @EQUAL
            IF        DATE1 >= DATE3 & DATE1 <= DATE4
              GOTO      UPDSUS92
            ENDIF
            IF        DATE1 >= DATE3 & DATE4 = 0
              GOTO      UPDSUS92
            ENDIF
            IF        DATE1 <= DATE3 & DATE4 = 0
              GOTO      UPDSUS92
            ENDIF
          GOTO      UPDSUS10
          ENDIF
.
.--------case when the Fromdate and Todate are Entered----------------
.
UPDSUS11  IF        DATE3 <= DATE1 & DATE4 >= DATE1 & DATE4 <> 0
           GOTO      UPDSUS92
          ENDIF
          IF        DATE3 <= DATE2 & DATE4 >= DATE2 & DATE4 <> 0
            GOTO      UPDSUS92
          ENDIF
          IF        DATE1 < DATE3 & DATE2 > DATE4 & DATE4 <> 0
            GOTO      UPDSUS92
          ENDIF
          IF        DATE1 >= DATE3 & DATE4 = 0
            GOTO      UPDSUS92
          ENDIF
          GOTO        UPDSUS10
.-------------------------------------------------------------------------
UPDSUS20  PACK      KEY16,UPDATEKY,SP70
          CALL      RDPTSUS1
          BRANCH    OVRCD,UPDSUS90
          CALL      MVSUS000
          PACK      PTSSWEBU,WBSEUID
          CALL      IBACLOCK
          PACK      PTSSDATU,CCC,CYY,CMM,CDD     * current date
          REP       " 0",PTSSDATU
          MOVE      CTIMEIS,PTSSTIMU
          CALL      UPPTSUS1
.
          MOVE      ZERO,EXIT
          GOTO      UPDSUS99
.
UPDSUS90  MOVE      "Invalid Suspension Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDSUS99
.
UPDSUS91  MOVE      "Invalid UR Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDSUS99
.
UPDSUS92  MOVE      "Patient is Already Suspended.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDSUS99
.
UPDSUS99  RETURN
.------------------------------------------------------------
. Delete Suspension
.------------------------------------------------------------
DELSUS00  PACK      KEY16,UPDATEKY,SP70
          CALL      RDPTSUS1
          BRANCH    OVRCD,DELSUS90
.
          CALL      DEPTSUS1
.
          MOVE      ZERO,EXIT
          GOTO      DELSUS99
.
DELSUS90  MOVE      "Invalid Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
DELSUS99  RETURN
+
.------------------------------------------------------------
. Check for visits/bookings within the suspension
.------------------------------------------------------------
CHKVIS00  MOVE      ZERO,EXIT
          PACK      KEY17,URNUMBER,ONE,SP70
          CALL      RSPTMI18
CHKVIS05  CALL      RKPTMI18
          BRANCH    OVRCD,CHKVIS10
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKVIS10 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      CHKVIS10 IF NOT EQUAL
.
          MATCH     PTSSFDAT,ADATE
          GOTO      CHKVIS05 IF LESS
.
          MATCH     SP70,PTSSTDAT
          IF        !@EQUAL
            MATCH     ADATE,PTSSTDAT
            GOTO      CHKVIS10 IF LESS
          ENDIF
.
          MOVE      ONE,EXIT
          GOTO      CHKVIS99
.
CHKVIS10  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
CHKVIS15  CALL      RKBKREC6
          BRANCH    OVRCD,CHKVIS20
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CHKVIS20 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      CHKVIS15 IF EQUAL
.
          MATCH     PTSSFDAT,BKREEDAT
          GOTO      CHKVIS15 IF LESS
.
          MATCH     SP70,PTSSTDAT
          IF        !@EQUAL
            MATCH     BKREEDAT,PTSSTDAT
            GOTO      CHKVIS20 IF LESS
          ENDIF
.
          MOVE      TWO,EXIT
          GOTO      CHKVIS99
.
CHKVIS20  PACK      KEY36,URNUMBER,PTSSFDAT,SP70
          CALL      RDSBOKA3
          CALL      RDKBOKA3
          BRANCH    OVRCD,CHKVIS99
.
          MATCH     URNUMBER,OBAURNO
          GOTO      CHKVIS99 IF NOT EQUAL
.
          MATCH     PTSSFDAT,OBADATE
          GOTO      CHKVIS99 IF LESS
.
          MATCH     SP70,PTSSTDAT
          IF        !@EQUAL
            MATCH     OBADATE,PTSSTDAT
            GOTO      CHKVIS99 IF LESS
          ENDIF
.
          MOVE      THREE,EXIT
          GOTO      CHKVIS99
.
CHKVIS99  RETURN
+
.------------------------------------------------------------
. Move in Suspension Details
.------------------------------------------------------------
MVSUS000  PACK      PTSSURNO,URNUMBER,SP70
          MATCH     Z70,PTSUS001
          IF        !@EQUAL
            PACK      PTSSFDAT,PTSUS001,SP70
          ENDIF
          MATCH     Z70,PTSUS002
          IF        !@EQUAL
            PACK      PTSSTDAT,PTSUS002,SP70
          ENDIF
.
          MATCH     Z70,PTSUS003
          IF        !@EQUAL
            MOVE       PTSUS003,PTSSRFCS
          ENDIF
.
          MATCH     Z70,PTSUS004
          IF        !@EQUAL
            MOVE       PTSUS004,PTSSREAS
          ENDIF
.
          MATCH     Z70,PTSUS005
          IF        !@EQUAL
            MOVE       PTSUS005,PTSSCOM1
          ENDIF
.
          MATCH     Z70,PTSUS006
          IF        !@EQUAL
            MOVE       PTSUS006,PTSSCOM2
          ENDIF
.
          RETURN
+
CLRWTS00  MOVE      SP70,WTSUFDAT
          MOVE      SP70,WTSUTDAT
          MOVE      SP70,WTSUREAS
          MOVE      SP70,WTSULSTS
.
          RETURN
.------------------------------------------------------------
. Move in Waiting List Details
.------------------------------------------------------------
MWLSUS00  MATCH     Z70,PTSUS001
          IF        !@EQUAL
            PACK      WTSUFDAT,PTSUS001
          ENDIF
          MATCH     Z70,PTSUS002
          IF        !@EQUAL
            PACK      WTSUTDAT,PTSUS002
          ENDIF

          MATCH     Z70,PTSUS007
          IF        !@EQUAL
            MOVE       PTSUS007,WTSULSTS
          ENDIF

          MATCH     Z70,PTSUS008
          IF        !@EQUAL
            MOVE       PTSUS008,WTSUREAS
          ENDIF

          MOVE       ONE,WTSUAUTO
          MOVE       WBSEUID,WTSUUSER
.
          RETURN
.----------------------------------------------------------------------
.      Suspend a Waiting List Entry --- ADDSUS00 -- ADD Suspension
.----------------------------------------------------------------------
WLSUS000  CALL      CLRWTS00
.
          MATCH     SP70,PTSUS007
          GOTO      WLSUS999 IF EQUAL
.
          CALL      MWLSUS00                * Move Cgi Variables To File
          MOVE      WTSUFDAT,DATE1          * Move FromDate to Date1
          MOVE      WMDATE1,DATE2           * Move DateOnList to Date2
          IF        DATE1 < DATE2
            GOTO      WLSUS999              * If suspension date < date on List
          ENDIF
          MOVE      ZERO,DATE2              * Clear Date2 Variable
          MOVE      WTSUTDAT,DATE2          * Move FromDate to Date2
.
.---------loop through the watsusaf and check the patient is already ------
.---------suspended or not-------------------------------------------------
.
          UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          CALL      RSWTSUS1
WLSUS010  CALL      RKWTSUS1
          BRANCH    OVRCD,WLSUS020
.
          MATCH     WMURNO,WTSUURNO
          GOTO      WLSUS020 IF NOT EQUAL       * Exit if URNo does'nt match
.
          MATCH     WMCODE,WTSUCODE
          GOTO      WLSUS020 IF NOT EQUAL       * Exit Proc-code Does'nt match
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      WLSUS020 IF NOT EQUAL       * Exit proc-count does'nt match
.
          MOVE      ZERO,DATE3
          MOVE      ZERO,DATE4
          MOVE      WTSUFDAT,DATE3
          MOVE      WTSUTDAT,DATE4
.
.--------case when the ToDate is not entered ------------------------
.
          COMPARE   ZERO,DATE2
          IF        @EQUAL
            IF        DATE1 >= DATE3 & DATE1 <= DATE4
              GOTO      WLSUS999
            ENDIF
            IF        DATE1 >= DATE3 & DATE4 = 0
              GOTO      WLSUS999
            ENDIF
            IF        DATE1 <= DATE3 & DATE4 = 0
              GOTO      WLSUS999
            ENDIF
          GOTO      WLSUS010
          ENDIF
.
.--------case when the Fromdate and Todate are Entered----------------
.
WLSUS011  IF        DATE3 <= DATE1 & DATE4 >= DATE1 & DATE4 <> 0
            GOTO      WLSUS999
          ENDIF
          IF        DATE3 <= DATE2 & DATE4 >= DATE2 & DATE4 <> 0
            GOTO      WLSUS999
          ENDIF
          IF        DATE1 < DATE3 & DATE2 > DATE4 & DATE4 <> 0
            GOTO      WLSUS999
          ENDIF
          IF        DATE1 >= DATE3 & DATE4 = 0
            GOTO      WLSUS999
          ENDIF
          GOTO        WLSUS010
.-------------------------------------------------------------------------
.------case when patient is unscheduled & proposed adm date greater than todate
.                                          * Hps Code Ends Here
WLSUS020  UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          MOVE      ZERO,WTSUSCNT
          MOVE      ZERO,F2
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,Z70
          CALL      RSWTSUS1
WLSUS030  CALL      RPWTSUS1
          BRANCH    OVRCD,WLSUS040
.
          MATCH     WMURNO,WTSUURNO
          GOTO      WLSUS040 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      WLSUS040 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      WLSUS040 IF NOT EQUAL
          MOVE      WTSUSCNT,F2
.
WLSUS040  CALL      MWLSUS00
          ADD       ONE,F2
          MOVE      F2,WTSUSCNT
          UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
.                                            * Hps Code starts Here
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          CALL      RAWTSUS1
          IF        OVRCD=1
            CALL      CLRWTS00
            CALL      MWLSUS00
            CALL      WRWTSUS1
          ELSE
            GOTO      WLSUS999
          ENDIF
.
.         MOVE      WTSULSTS,WMUDEF4          * Commented as per specs
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,WLSUS050
.
          REP       " 0",XCDATE
          MOVE      XCDATE,WTTXLUPD       * Current Date
          CLOCK     TIME,WTTXLUPT         * Current Time
          MOVE      USERID,WTTXWEBU       * WEB User Id rec.
          PACK      CURRDATE,CCC,CYY,CMM,CDD      * HPSI
          REP       " 0",CURRDATE
          MOVE      CURRDATE,DATE1
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,DATE3
          IF        DATE1>=DATE2 & DATE1<=DATE3
            MOVE      WTSULSTS,WTTXPLST
          ENDIF
          CALL      UPWTTX11                * Write a Record in wattx1af
.
WLSUS050  MATCH     "1",DWMSTAT
          GOTO      WLSUS060 IF NOT EQUAL
.
          PACK      KEY5,ANSV,ANSL,PTSUS007,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WLSUS060
.
          MATCH     ANSR,TCINDC1
          GOTO      WLSUS060 IF EQUAL
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          IF        OVRCD=0
            MOVE      WMDATE3,DATE5
            IF        DATE5 < DATE2
              MOVE      SP70,WMDATE3
              CALL      UPTREA1
              PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
              CALL      RDWTTX11
              IF        OVRCD=0
                MOVE      SP70,WTTXPATM
                CALL      UPWTTX11     * Write a Record in wattx1af
              ENDIF
            ENDIF
          ENDIF
.
          CALL      WESUS000
.
WLSUS060  MOVE      ZERO,EXIT
          GOTO      WLSUS999
.
WLSUS999  RETURN
.------------------------------------------------------------
. Write ESIS Suspension details
.------------------------------------------------------------
WESUS000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      WESUS999 IF NOT EQUAL   * Not in Victoria
.
          MOVE      ZERO,CHGFDAT
          MOVE      ZERO,CHGTDAT
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     Z70,UPDATEKY             * updating
          IF        !@EQUAL
            MATCH     WTSUFDAT,SAVEFDAT       * no change to from date
            IF        @EQUAL
              GOTO      WESUS100
            ELSE
              MOVE      ONE,CHGFDAT
              CALL      CHNSUS00
              MOVE      ZERO,CHGFDAT
              GOTO      WESUS100
            ENDIF
          ENDIF
.
          MATCH     WTSUFDAT,CURRDATE
          GOTO      WESUS999 IF LESS
.
          MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          CALL      WRRED000
.
WESUS100  MATCH     SP70,WTSUTDAT
          GOTO      WESUS999 IF EQUAL
.
          MATCH     Z70,UPDATEKY             * updating
          IF        !@EQUAL
            MATCH     WTSUTDAT,SAVETDAT       * no change to to date
            IF        @EQUAL
              GOTO      WESUS999
            ELSE
              MOVE      ONE,CHGTDAT
              CALL      CHNSUS00
              MOVE      ZERO,CHGTDAT
              GOTO      WESUS500
            ENDIF
          ENDIF
.
          MATCH     WTSUTDAT,CURRDATE
          GOTO      WESUS999 IF LESS
.
          PACK      KEY5,ANSV,ANSL,SP70
          CALL      RDSCODE1
WESUS500  CALL      RDKCODE1
          BRANCH    OVRCD,WESUS999
.
          MATCH     "VL",TCODE
          GOTO      WESUS999 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV           * Only want active codes
          GOTO      WESUS500 IF NOT EQUAL
.
          MATCH     "R",TCINDC1            * Must have indicator 1 = "R"
          GOTO      WESUS500 IF NOT EQUAL
.
          MOVE      WTSUTDAT,WTENEVDT
          MOVE      ACODE,WTENEVAL
          CALL      WRRED000
.
WESUS999  RETURN
.------------------------------------------------------------
. Write  Suspension
.------------------------------------------------------------
WRRED000  PACK      WTENUNIQ,WTWMECNT,SP70 
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            PACK      WTENWEBU,WBSEUID
            PACK      WTENUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTENUDAT
            CLOCK     TIME,WTENUTIM
            REP       " 0",WTENUTIM
            CALL      UPWTESN1
          ENDIF
.
WRRED999  RETURN
.------------------------------------------------------------
. Change ESIS Suspension
.------------------------------------------------------------
CHNSUS00  PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
.
          IF        CHGFDAT=0
            GOTO      CHNSUS20
          ENDIF
.
. ---- check if new record already exists ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTSUFDAT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=0
            GOTO      CHNSUS20
          ENDIF
.
. ----  check if old record is unsent, if so update with new date ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,SAVEFDAT,WTENEDAT,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,CHNSUS10
.
          PACK      WTENWEBU,WBSEUID
          MOVE      WTSUFDAT,WTENEVDT
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
          GOTO      CHNSUS20
.
.
. ----  check if old record is sent, if so delete and write new date ----
.
CHNSUS10  PACK      KEY36,WTWMECNT,ANSR,SAVEFDAT,SP70
          CALL      RSWTESN1
          CALL      RKWTESN1
          BRANCH    OVRCD,CHNSUS20
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      CHNSUS20 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP
          GOTO      CHNSUS20 IF NOT EQUAL
.
          MATCH     SAVEFDAT,WTENEVDT
          GOTO      CHNSUS20 IF NOT EQUAL
.
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
.
. ---- write delete record ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
. ---- write correct record ----
.
          MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
CHNSUS20  IF        CHGTDAT=0
            GOTO      CHNSUS99
          ENDIF
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
.
. ---- check if new record already exists ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTSUTDAT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=0
            GOTO      CHNSUS99
          ENDIF
.
. ----  check if old record is unsent, if so update with new date ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,SAVETDAT,WTENEDAT,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,CHNSUS30
.
          MOVE      WTSUTDAT,WTENEVDT
          PACK      WTENWEBU,WBSEUID
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
          GOTO      CHNSUS99
.
. ----  check if old record is sent, if so delete and write new date ----
.
CHNSUS30  PACK      KEY36,WTWMECNT,ANSR,SAVETDAT,SP70
          CALL      RSWTESN1
          CALL      RKWTESN1
          BRANCH    OVRCD,CHNSUS99
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      CHNSUS99 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP
          GOTO      CHNSUS99 IF NOT EQUAL
.
          MATCH     SAVETDAT,WTENEVDT
          GOTO      CHNSUS99 IF NOT EQUAL
.
          MOVE      WTENEVAL,SAVEEVAL
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
.
. ---- write delete record ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
. ---- write correct record ----
.
          MOVE      WTSUTDAT,WTENEVDT
          MOVE      SAVEEVAL,WTENEVAL
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
CHNSUS99  RETURN
.
.------------------------------------------------------------
. Patient Transport Details
.------------------------------------------------------------
PTRN0000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      PTRN8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Add
          GOTO      PTRN1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      PTRN2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      PTRN3000 IF EQUAL
.
          MATCH     "S",UPDTTYPE       * Add series booking
          GOTO      PTRN4000 IF EQUAL
.
          MATCH     "T",UPDTTYPE       * Update entire series booking
          GOTO      PTRN5000 IF EQUAL
.
          MATCH     "F",UPDTTYPE       * Update future series bookings
          GOTO      PTRN6000 IF EQUAL
.
          MATCH     "E",UPDTTYPE       * Delete entire series booking
          GOTO      PTRN7000 IF EQUAL
.
          MATCH     "B",UPDTTYPE       * Delete future series bookings
          GOTO      PTRN7000 IF EQUAL
.
          GOTO      PTRN9000
.
.  Add transport
.
PTRN1000  MOVE      ONE,F3
          PACK      KEY19,PMTSP001,PMTSP002,Z70
          CALL      RSPMTSP1
          CALL      RPPMTSP1                     * Get next unique number
          BRANCH    OVRCD,PTRN1500
.
          MATCH     PMTSP001,PMTSURNO
          GOTO      PTRN1500 IF NOT EQUAL
.
          MATCH     PMTSP002,PMTSVISN
          GOTO      PTRN1500 IF NOT EQUAL
.
          SQUEEZE   PMTSUNIQ
          MOVE      PMTSUNIQ,F3
          ADD       ONE,F3
.
PTRN1500  MOVE      F3,PMTSP003
          CALL      CLPMSTSP
          PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          COMPARE   ZERO,OVRCD
          GOTO      PTRN1000 IF EQUAL
.
          CALL      MVPMTS00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMTSCDAT                * System date
          CLOCK     TIME,PMTSCTIM                * System time
          MOVE      USERID,PMTSCUID              * web user id
.
          CALL      WRPMTSP1                     * Write transport record
.
          CALL      UPCOM000                     * Write Comments
          CALL      UPRET000                     * Write Return Comments
.
          MOVE      ZERO,EXIT 
          GOTO      PTRN9999
.
.  Update transport
.
PTRN2000  PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70 
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN9100
.
          CALL      MVPMTS00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMTSUDAT                * System date
          CLOCK     TIME,PMTSUTIM                * System time
          MOVE      USERID,PMTSUUID              * web user id
.
          CALL      UPPMTSP1                     * Update transport record
. 
          CALL      UPCOM000                     * Write Comments
          CALL      UPRET000                     * Write Return Comments
.
          MOVE      ZERO,EXIT
          GOTO      PTRN9999
.
.  Delete tranpsport
.
PTRN3000  PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN9100
.
          CALL      DECOM000                     * Delete Comments
          CALL      DERET000                     * Delete Return Comments
.
          CALL      DEPMTSP1                     * Delete transport record
.
          MOVE      ZERO,EXIT
          GOTO      PTRN9999
.
.  Add transport for a series
.
PTRN4000  MOVE      ONE,F3
          MOVE      F3,PMTSP003
          CALL      CLPMSTSP
          PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          COMPARE   ZERO,OVRCD                   * Exit if transport exixts
          GOTO      PTRN4100 IF EQUAL
.
          CALL      BKTM0000                     * Default booking date/time
.
          PACK      PMTSP004,OBADATE,COLON,ZERO,ZERO   * Set transport dates to
          PACK      PMTSP005,OBATIME,COLON,ZERO,ZERO   * app date
          PACK      PMTSP054,OBADATE,COLON,ZERO,ZERO
          PACK      PMTSP055,OBATIME,COLON,ZERO,ZERO  
.
          CALL      MVPMTS00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMTSCDAT                * System date
          CLOCK     TIME,PMTSCTIM                * System time
          MOVE      USERID,PMTSCUID              * web user id
.
          CALL      WRPMTSP1                     * Write transport record
.
          CALL      UPCOM000                     * Write Comments
          CALL      UPRET000                     * Write Return Comments
.
PTRN4100  PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RSOTLKB1
PTRN4500  CALL      RKOTLKB1                     * Write transport for all
          BRANCH    OVRCD,PTRN4900               * bookings in the series
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      PTRN4900 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTLKOBOK
          GOTO      PTRN4900 IF NOT EQUAL
.
          MOVE      ONE,F3
          MOVE      F3,PMTSP003
          PACK      KEY19,URNUMBER,ADMISSNO,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN4900
.
          MOVE      OTLKLBOK,PMTSVISN
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      RAPMTSP1
          COMPARE   ZERO,OVRCD
          GOTO      PTRN4500 IF EQUAL
.
          CALL      SRTM0000                     * Default booking date/time
          PACK      PMTSTDAT,OBADATE,COLON,ZERO,ZERO   * Set transport dates to
          PACK      PMTSTTIM,OBATIME,COLON,ZERO,ZERO   * app date
          PACK      PMTSRTDT,OBADATE,COLON,ZERO,ZERO
          PACK      PMTSRTTM,OBATIME,COLON,ZERO,ZERO  
.
          CALL      WRPMTSP1                     * Write transport record
.
          CALL      CPCOM000                   * Copy Comments for series
          CALL      CPRET000                   * Copy Return Comments for series
.
          GOTO      PTRN4500
.
PTRN4900  MOVE      ZERO,EXIT 
          GOTO      PTRN9999
.
.  Update entire series from master booking
.
PTRN5000  PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN9100
.
          CALL      MVPMTS00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMTSUDAT                * System date
          CLOCK     TIME,PMTSUTIM                * System time
          MOVE      USERID,PMTSUUID              * web user id
.
          CALL      UPPMTSP1                     * Update transport record
.
          CALL      UPCOM000                     * Write Comments
          CALL      UPRET000                     * Write Return Comments
.
PTRN5100  PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RSOTLKB1
PTRN5500  CALL      RKOTLKB1                     * Update transport for all
          BRANCH    OVRCD,PTRN5900               * bookings in the series
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      PTRN5900 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTLKOBOK
          GOTO      PTRN5900 IF NOT EQUAL
.
          MOVE      ONE,F3
          MOVE      F3,PMTSP003
          PACK      KEY19,URNUMBER,ADMISSNO,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN5900
.
          MOVE      OTLKLBOK,PMTSVISN
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      RAPMTSP1
          COMPARE   ZERO,OVRCD
          GOTO      PTRN5500 IF NOT EQUAL
.
          CALL      SRTM0000                     * Default booking date/time
          PACK      PMTSTDAT,OBADATE,COLON,ZERO,ZERO   * Set transport dates to
          PACK      PMTSTTIM,OBATIME,COLON,ZERO,ZERO   * app date
          PACK      PMTSRTDT,OBADATE,COLON,ZERO,ZERO
          PACK      PMTSRTTM,OBATIME,COLON,ZERO,ZERO  
.
          CALL      UPPMTSP1                     * Update transport record
.
          CALL      DECOM000                     * Delete Comments
          CALL      DERET000                     * Delete Return Comments
.
          CALL      CPCOM000                   * Copy Comments for series
          CALL      CPRET000                   * Copy Return Comments for series
.
          GOTO      PTRN5500
.
PTRN5900  MOVE      ZERO,EXIT 
          GOTO      PTRN9999
.
.  Update future bookings in a series
.
PTRN6000  PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN9100
.
          CALL      MVPMTS00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMTSUDAT                * System date
          CLOCK     TIME,PMTSUTIM                * System time
          MOVE      USERID,PMTSUUID              * web user id
.
          CALL      UPPMTSP1                     * Update transport record
.
          CALL      UPCOM000                     * Write Comments
          CALL      UPRET000                     * Write Return Comments
.
          PACK      DIM13A,PMTSTDAT,PMTSTTIM,SP70   * Save first transport date
.
          PACK      KEY24,PMTSP001,PMTSP002,SP70
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,PTRN6900
.         
          MATCH     OTLKURNO,PMTSP001       * Same U/R
          GOTO      PTRN6900 IF NOT EQUAL   
.         
          MATCH     OTLKLBOK,PMTSP002       * Same child booking for
          GOTO      PTRN6900 IF NOT EQUAL   * this series
.         
          MOVE      OTLKOBOK,PARNTBOK       * Save master series booking
.
PTRN6100  PACK      KEY24,URNUMBER,PARNTBOK,SP70
          CALL      RSOTLKB1
PTRN6500  CALL      RKOTLKB1                     * Update transport for all
          BRANCH    OVRCD,PTRN6900               * bookings in the series
.         
          MATCH     URNUMBER,OTLKURNO
          GOTO      PTRN6900 IF NOT EQUAL
.
          MATCH     PARNTBOK,OTLKOBOK
          GOTO      PTRN6900 IF NOT EQUAL
.
          MATCH     PMTSP002,OTLKLBOK
          GOTO      PTRN6500 IF EQUAL
.
          MOVE      ONE,F3
          MOVE      F3,PMTSP003
          PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN6900
.
          MOVE      OTLKLBOK,PMTSVISN
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      RAPMTSP1
          COMPARE   ZERO,OVRCD
          GOTO      PTRN6500 IF NOT EQUAL
.
          CALL      SRTM0000                     * Default booking date/time
          PACK      PMTSTDAT,OBADATE,COLON,ZERO,ZERO   * Set transport dates to
          PACK      PMTSTTIM,OBATIME,COLON,ZERO,ZERO   * app date
          PACK      PMTSRTDT,OBADATE,COLON,ZERO,ZERO
          PACK      PMTSRTTM,OBATIME,COLON,ZERO,ZERO  
.
          PACK      DIM13B,PMTSTDAT,PMTSTTIM,SP70
.
          MATCH     DIM13A,DIM13B           * Check if this master booking is a
          GOTO      PTRN6500 IF LESS        * future booking by date/time in the
.                                           * series
          CALL      UPPMTSP1                * Update transport record
.
          CALL      DECOM000                * Delete Comments
          CALL      DERET000                * Delete Return Comments
.
          CALL      FTCOM000                * Copy Comments for future series
          CALL      FTRET000                * Copy Return Comments for future
.                                           * series
          GOTO      PTRN6500
.
PTRN6900  MOVE      ZERO,EXIT 
          GOTO      PTRN9999
.
.  Delete transport for an entire series or future bookings in a series
.
PTRN7000  PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN9100
.
          CALL      DECOM000                     * Delete Comments
          CALL      DERET000                     * Delete Return Comments
.
          MATCH     "B",UPDTTYPE                 * Delete future series bookings
          IF        @EQUAL
            PACK      DIM13A,PMTSTDAT,PMTSTTIM,SP70  * Save first transport date
          ENDIF
.
          CALL      DEPMTSP1                     * Delete transport record
.
          MATCH     "E",UPDTTYPE       * Delete entire series bookings
          IF        @EQUAL
            MOVE      PMTSP002,PARNTBOK
            GOTO      PTRN7100
          ENDIF
.
          PACK      KEY24,PMTSP001,PMTSP002,SP70
          CALL      RSOTLKB2 
          CALL      RKOTLKB2
          BRANCH    OVRCD,PTRN7900
.         
          MATCH     OTLKURNO,PMTSP001       * Same U/R
          GOTO      PTRN7900 IF NOT EQUAL
.         
          MATCH     OTLKLBOK,PMTSP002       * Same child booking for
          GOTO      PTRN7900 IF NOT EQUAL   * this series
.         
          MOVE      OTLKOBOK,PARNTBOK       * Save master series booking
.
PTRN7100  PACK      KEY24,PMTSP001,PARNTBOK,SP70
          CALL      RSOTLKB1
PTRN7200  CALL      RKOTLKB1                     * Delete transport for all
          BRANCH    OVRCD,PTRN7900               * bookings in the series
.
          MATCH     PMTSP001,OTLKURNO
          GOTO      PTRN7900 IF NOT EQUAL
.
          MATCH     PARNTBOK,OTLKOBOK
          GOTO      PTRN7900 IF NOT EQUAL
.
          MOVE      ONE,F3
          MOVE      F3,PMTSP003
          PACK      KEY19,PMTSP001,OTLKLBOK,PMTSP003,SP70
          CALL      RDPMTSP1
          BRANCH    OVRCD,PTRN7200
.
          MATCH     "B",UPDTTYPE       * Delete future series bookings
          IF        @EQUAL
            PACK      DIM13B,PMTSTDAT,PMTSTTIM,SP70
.
            MATCH     DIM13A,DIM13B         * Check if this master booking is a
            GOTO      PTRN7200 IF LESS      * future booking by date/time in the
          ENDIF                             * series
.      
          CALL      DECOM000                     * Delete Comments
          CALL      DERET000                     * Delete Return Comments
.
          CALL      DEPMTSP1                     * Delete transport record
          GOTO      PTRN7200
.
PTRN7900  MOVE      ZERO,EXIT
          GOTO      PTRN9999
.
PTRN8000  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PTRN9200
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      BKTM0000                  * Get the appointment time
.
          PACK      KEY19,PMTSP001,PMTSP002,PMTSP003,SP70
          CALL      RDPMTSP1                      * Read transport table
          IF        OVRCD=1
            CALL      CLPMSTSP                    * Clear all the file variables
          ENDIF
. 
          CALL      CLPMSCEX                      * Clear extra contact details
          MATCH     SP70,PTCNAADR
          IF        !@EQUAL
            MATCH     "000",PTCNAADR
            IF        !@EQUAL
              CALL      GALT0000                  * Read alternate address
            ENDIF
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CLEAR     WEBTITLE 
          MOVE      "Patient Transport",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PTRN9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PTRN9999
.
PTRN9000  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTRN9999
.
PTRN9100  MOVE      "Invalid Transport Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTRN9999
.
PTRN9200  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTRN9999
.
PTRN9999  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          RETURN
.
.------------------------------------------------------------
. Get first active alternate address
.------------------------------------------------------------
GALT0000  PACK      KEY14,URNUMBER,PTCNAADR,SP70
          CALL      RSPMCEX1
GALT1000  CALL      RKPMCEX1
          BRANCH    OVRCD,GALT9000
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      GALT9000 IF NOT EQUAL
.
          MATCH     PTCNAADR,PMCETYPE
          GOTO      GALT9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          GOTO      GALT1000 IF EQUAL
.
          GOTO      GALT9999
.
GALT9000  CALL      CLPMSCEX
          GOTO      GALT9999
.
GALT9999  RETURN
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0100,GTAG0200,GTAG0300,GTAG0400,GTAG0500:
                             GTAG0600,GTAG0700,GTAG0800,GTAG0900,GTAG1000:
                             GTAG1100,GTAG1200,GTAG1300,GTAG1400,GTAG1500:
                             GTAG1600,GTAG1700,GTAG1800,GTAG1900,GTAG2000:
                             GTAG2100,GTAG2200,GTAG2300,GTAG2400,GTAG2500:
                             GTAG2600,GTAG2700,GTAG2800,GTAG2900
          GOTO      GTAG9999 
.         
GTAG0100  CALL      UTRN0000                * Transport list By UR
          GOTO      GTAG9999
.
GTAG0200  CALL      RDCM0000                * Transport Comments
          GOTO      GTAG9999
.
GTAG0300  CALL      HTRN0000                * Transport list By Hospital
          GOTO      GTAG9999
.
GTAG0400  CALL      SELV0000
          GOTO      GTAG9999
.
GTAG0500  CALL      NEXT0000
          GOTO      GTAG9999
.
GTAG0600  CALL      PREV0000
          GOTO      GTAG9999
.
GTAG0700  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      GTAG9999
.
GTAG0800  MATCH     "1",FILTBOOK
          IF        @EQUAL
            WRITE      HTMLFILE;"<option value=1 selected>Not Booked</option>";
          ELSE
            WRITE      HTMLFILE;"<option value=1>Not Booked</option>";
          ENDIF

          MATCH     "2",FILTBOOK
          IF        @EQUAL
            WRITE      HTMLFILE;"<option value=2 selected>Booked</option>";
          ELSE
            WRITE      HTMLFILE;"<option value=2>Booked</option>";
          ENDIF
          GOTO      GTAG9999
.
GTAG0900  MOVE      "OB",CATEGORY
          MOVE      FILTCONT,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG1000  WRITE     HTMLFILE;TRNSFLAG;
          GOTO      GTAG9999
.
GTAG1100  WRITE     HTMLFILE;WAITFLAG;
          GOTO      GTAG9999
.
GTAG1200  CALL      HTMS0000            * Is this booking part of a series
          GOTO      GTAG9999
.
GTAG1300  CALL      RTCM0000            * Return Transport Comments
          GOTO      GTAG9999
.
GTAG1400  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      GTAG9999
.
GTAG1500  WRITE     HTMLFILE;PTVITYPE;
          GOTO      GTAG9999
.
GTAG1600  WRITE     HTMLFILE;EMVISTAT;
          GOTO      GTAG9999
.
GTAG1700  WRITE     HTMLFILE;ASTAT;
          GOTO      GTAG9999
.
GTAG1800  PACK      SAVKEY24,PMBRVISN,PMBRREQD,PMBRREQT,SP70
.
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMBRQ1
          CALL      RKPMBRQ1
          BRANCH    OVRCD,GTAG1850
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      GTAG1850 IF NOT EQUAL
.
          MOVE      SAVKEY24,KEY24
          CALL      RDPMBRQ1
          IF        OVRCD=1
            CALL     CPMBRQ00
          ENDIF
.
          WRITE     HTMLFILE;ZERO;
          GOTO      GTAG9999
.
GTAG1850  MOVE      SAVKEY24,KEY24
          CALL      RDPMBRQ1
          IF        OVRCD=1
            CALL     CPMBRQ00   
          ENDIF
.
          WRITE     HTMLFILE;ONE;
          GOTO      GTAG9999
.
GTAG1900  PACK      KEY14,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
GTAG1910  CALL      RKEMVCD1
          BRANCH    OVRCD,GTAG9999 
.
          MATCH     ADMISSNO,EMVCVIST
          GOTO      GTAG9999 IF NOT EQUAL
.         
          MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
          GOTO      GTAG9999 IF NOT EQUAL
.         
          MATCH     "000",EMVCSEQU          * Primary diagnosis
          GOTO      GTAG1910 IF NOT EQUAL
.
          WRITE     HTMLFILE;EMVCFTXT;
          GOTO      GTAG9999
.
GTAG2000  PACK      KEY14,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
GTAG2010  CALL      RKEMVCD1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     ADMISSNO,EMVCVIST
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     "000",EMVCSEQU          * Primary diagnosis
          GOTO      GTAG2010 IF NOT EQUAL
.
          WRITE     HTMLFILE;EMVCMNCD;
          GOTO      GTAG9999
.
GTAG2100  WRITE     HTMLFILE;EMCNDEDI;
          GOTO      GTAG9999
.
GTAG2200  WRITE     HTMLFILE;EMCNNWBR;
          GOTO      GTAG9999
.
GTAG2300  MOVE      "CT",CATEGORY       * Location Type
          MOVE      OTHELTYP,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG2400  WRITE     HTMLFILE;OPUPDATE;
          GOTO      GTAG9999
.
GTAG2500  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,F1
          MOVE      DIM1,F1
          BRANCH    F1,GTAG2501
.
          WRITE     HTMLFILE;EMVIUR01;
          GOTO      GTAG9999
.
GTAG2501  PACK      KEY6,EMVIUR01,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,GTAG9999
.
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY50
          WRITE     HTMLFILE;KEY50;
          GOTO      GTAG9999
.
GTAG2600  MOVE      "OB",CATEGORY
          MOVE      OTARTRRQ,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG2700  MOVE      "SA",CATEGORY
          MOVE      OTARSARR,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG2800  WRITE     HTMLFILE;PVITYPE;
          GOTO      GTAG9999
.
GTAG2900  MOVE      "es",CATEGORY
          MOVE      EMVIUC27,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG9999  RETURN
.
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
FLHS0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
FLHS0100  CALL      RKPTHSP1
          BRANCH    OVRCD,FLHS9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,FLHS0100
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",PTHSHOSP,"#"";
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",PTHSNAME,"</option>"
          GOTO      FLHS0100
.
FLHS9999  RETURN
.
.**********************************************************************
.*  HTMS0000  - Output tag to indicate if this booking is part of a   *
.*              series or not. 2=Master,1=Yes and 0=NO                *
.**********************************************************************
HTMS0000  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY24,URNUMBER,ADMISSNO,SP70 * Is this a master record
          CALL      RDOTLKB1
          BRANCH    OVRCD,HTMS1000
.
          GOTO      HTMS8600
.
HTMS1000  PACK      KEY24,URNUMBER,ADMISSNO,SP70 * Check non master records
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,HTMS8500
.
          MATCH     URNUMBER,OTLKURNO
          GOTO      HTMS8500 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTLKLBOK
          GOTO      HTMS8500 IF NOT EQUAL
.
HTMS8000  IF        F1=1
            WRITE     HTMLFILE;"Series";       * Yes this is part of a series
          ELSE
            WRITE     HTMLFILE;ONE;            * Yes this is part of a series
          ENDIF
          GOTO      HTMS9999
.
HTMS8500  IF        F1=1
            WRITE     HTMLFILE;" ";           * No this is not part of a series
          ELSE
            WRITE     HTMLFILE;ZERO;          * No this is not part of a series
          ENDIF
          GOTO      HTMS9999
.
HTMS8600  IF        F1=2
            WRITE     HTMLFILE;TWO;           * Yes this is a master series book
            GOTO      HTMS9999
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;" Master Series";  * Yes this is part of a series
          ELSE
            WRITE     HTMLFILE;ONE;            * Yes this is part of a series
          ENDIF
.
HTMS9999  RETURN
.         
.*******************************************************************************
. List transport records by UR
.*******************************************************************************
UTRN0000  PACK      KEY19,URNUMBER,SP70
          CALL      RSPMTSP1
UTRN1000  CALL      RKPMTSP1
          BRANCH    OVRCD,UTRN9999
.         
          MATCH     URNUMBER,PMTSURNO
          GOTO      UTRN9999 IF NOT EQUAL
.           
          MOVE      SP70,VISTDATE
          MOVE      SP70,VISTTIME
          PACK      KEY8,PMTSVISN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,UTRN1200
.
          BRANCH    PVITYPE,UTRN1500,UTRN2000,UTRN2500
.
          MATCH     " 9",PTVITYPE
          GOTO      UTRN3000 IF EQUAL
.
          MATCH     "10",PTVITYPE
          IF        @EQUAL
            MOVE      PVIDATE,VISTDATE
            MOVE      SP70,VISTTIME
            GOTO      UTRN5000
          ENDIF
.
          GOTO      UTRN5000
.
UTRN1200  MOVE      PMTSVISN,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      PMTSURNO,PVIURNO
            MOVE      OBADATE,PVIDATE
            MOVE      PMTSVISN,PVIBILL
            GOTO      UTRN2000
.
          ENDIF
          GOTO      UTRN5000
.
UTRN1500  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,VISTDATE
            MOVE      EMVITIME,VISTTIME
          ENDIF
          GOTO      UTRN5000
.
UTRN2000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
UTRN2100  CALL      RDKBOKA3 
          BRANCH    OVRCD,UTRN5000
.
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      UTRN5000 IF NOT EQUAL
.           
          MATCH     OBADATE,PVIDATE
          GOTO      UTRN5000 IF NOT EQUAL
.         
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      UTRN2100 IF NOT EQUAL
.
          MOVE      OBADATE,VISTDATE
          MOVE      OBATIME,VISTTIME
.
          GOTO      UTRN5000
.
UTRN2500  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ADATE,VISTDATE
            MOVE      ATIME,VISTTIME
          ENDIF
          GOTO      UTRN5000
.
UTRN3000  MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          IF        OVRCD=0
            MOVE      PMEVADTE,VISTDATE
            MOVE      PMEVATIM,VISTTIME
          ENDIF
          GOTO      UTRN5000
.
UTRN5000  MOVE      SP70,DISPFACL
          MATCH     SP70,PMTSFACL
          IF        !@EQUAL
            PACK      KEY5,CATFA,PMTSFACL,SP70
            CALL      RDCODE1
            IF        OVRCD=1  
              MOVE      PMTSFACL,DISPFACL
            ELSE
              MOVE      TDESC,DISPFACL
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPTRNS
          MATCH     SP70,PMTSTRNS
          IF        !@EQUAL
            PACK      KEY5,CATOB,PMTSTRNS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSTRNS,DISPTRNS
            ELSE
              MOVE      TDESC,DISPTRNS
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPMOBL
          MATCH     SP70,PMTSMOBL
          IF        !@EQUAL
            PACK      KEY5,CATPN,PMTSMOBL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSMOBL,DISPMOBL
            ELSE       
              MOVE      TDESC,DISPMOBL
            ENDIF      
          ENDIF        
.
          MOVE      SP70,DISPAIDS
          MATCH     SP70,PMTSAIDS
          IF        !@EQUAL
            PACK      KEY5,CATPO,PMTSAIDS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSAIDS,DISPAIDS
            ELSE       
              MOVE      TDESC,DISPAIDS
            ENDIF      
          ENDIF        
.
          MOVE      SP70,DISPMENT
          MATCH     SP70,PMTSMENT
          IF        !@EQUAL
            PACK      KEY5,CATPP,PMTSMENT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSMENT,DISPMENT
            ELSE       
              MOVE      TDESC,DISPMENT
            ENDIF      
          ENDIF        
. 
          MOVE      SP70,DISPSPEC
          MATCH     SP70,PMTSSPEC
          IF        !@EQUAL
            PACK      KEY5,CATSA,PMTSSPEC,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSSPEC,DISPSPEC
            ELSE       
              MOVE      TDESC,DISPSPEC
            ENDIF      
          ENDIF        
.
          MOVE      SP70,DISPCLAM
          MATCH     SP70,PMTSCLAM
          IF        !@EQUAL
            PACK      KEY5,CATCL,PMTSCLAM,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSCLAM,DISPCLAM
            ELSE       
              MOVE      TDESC,DISPCLAM
            ENDIF      
          ENDIF        
.
          MATCH     "1",PMTSBOOK
          IF        @EQUAL
            MOVE      DYES,DISPBOOK
          ELSE
            MOVE      DNO,DISPBOOK
          ENDIF
.
          MATCH     "1",PMTSRTBK
          IF        @EQUAL
            MOVE      DYES,DISPBOKR
          ELSE
            MOVE      DNO,DISPBOKR
          ENDIF
.
          MOVE      SP70,DIM60A
          MOVE      SP70,DIM60B
          PACK      KEY17,PMTSVISN,ZERO,ZERO,SEVEN,PMTSUNIQ,SP1,SP1,ONE,SP70
          CALL      RDVSUCM1
          IF        OVRCD=0
            MOVE      VSUCLINE,DIM60A
          ENDIF
.
          PACK      KEY17,PMTSVISN,ZERO,ZERO,SEVEN,PMTSUNIQ,SP1,SP1,TWO,SP70
          CALL      RDVSUCM1
          IF        OVRCD=0
            MOVE      VSUCLINE,DIM60B
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateTransport('",HTMLLINK
          APPEND    PMTSURNO,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMTSVISN,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMTSUNIQ,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                       "#"",PMTSTDAT,PMTSTTIM,"#",":            * 1
                       "#"",PMTSPAD1,PMTSPAD2,PMTSPAD3,PMTSPAD4,PMTSPPOS,"#",":
                       "#"",PMTSPTLP,"#",":                     * 3
                       "#"",PMTSPTLB,"#",":                     * 4
                       "#"",PMTSPTLM,"#",":                     * 5
                       "#"",PMTSPEML,"#",":                     * 6
                       "#"",PMTSPMEL,"#",":                     * 7
                       "#"",PMTSRAD1,PMTSRAD2,PMTSRAD3,PMTSRAD4,PMTSRPOS,"#",":
                       "#"",PMTSRTLP,"#",":                     * 9
                       "#"",PMTSRTLB,"#",":                     * 10
                       "#"",PMTSRTLM,"#",":                     * 11
                       "#"",PMTSREML,"#",":                     * 12
                       "#"",PMTSRMEL,"#",":                     * 13
                       "#"",PMTSDAD1,PMTSDAD2,PMTSDAD3,PMTSDAD4,PMTSDPOS,"#",":
                       "#"",PMTSDTLP,"#",":                     * 15
                       "#"",PMTSDTLB,"#",":                     * 16
                       "#"",PMTSDTLM,"#",":                     * 17
                       "#"",PMTSDEML,"#",":                     * 18
                       "#"",PMTSDMEL,"#",":                     * 19
                       "#"",DISPFACL,"#",":                     * 20
                       "#"",DISPTRNS,"#",":                     * 21
                       "#"",DISPMOBL,"#",":                     * 22
                       "#"",DISPAIDS,"#",":                     * 23
                       "#"",DISPMENT,"#",":                     * 24
                       "#"",DISPSPEC,"#",":                     * 25
                       "#"",DISPCLAM,"#",":                     * 26
                       "#"",PMTSCCEN,"#",":                     * 27
                       "#"",DISPBOOK,"#",":                     * 28
                       "#"",PMTSAMBN,"#",":                     * 29
                       "#"",PMTSM40N,"#",":                     * 30
                       "#"",PMTSM40E,"#",":                     * 31
                       "#"",VISTDATE,VISTTIME,"#",":            * 32
                       "#"",PMTSVISN,"#",":                     * 33
                       "#"",DIM60A,DIM60B,"#",":                * 34
                       "#"",DISPBOKR,"#");";                    * 35
.
          GOTO      UTRN1000
.
UTRN9999  RETURN
.
.
.*******************************************************************************
. List transport records - Hopital Level
.*******************************************************************************
HTRN0000  MOVE      ZERO,LOOPCNTR
.
          PACK      KEY35,FRSTDATE,SP70
          CALL      RSPMTSP2
HTRN1000  CALL      RKPMTSP2
          BRANCH    OVRCD,HTRN9999
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.------------------------------------------------------
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 250)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          MATCH     PMTSTDAT,LASTDATE 
          GOTO      HTRN9999 IF LESS
.
          MATCH     SP70,FILTBOOK
          GOTO      HTRN1050 IF EQUAL
.
          MATCH     "2",FILTBOOK
          IF        @EQUAL
            MATCH     "1",PMTSBOOK               * Only select booked
            GOTO      HTRN1000 IF NOT EQUAL 
          ELSE
            MATCH     "1",PMTSBOOK               * Skip if booked
            GOTO      HTRN1000 IF EQUAL 
          ENDIF
.
HTRN1050  MATCH     SP70,FILTCONT
          GOTO      HTRN1100 IF EQUAL
.
          MATCH     FILTCONT,PMTSTRNS            * transport contractor
          GOTO      HTRN1000 IF NOT EQUAL
. 
HTRN1100  MOVE      PMTSURNO,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,HTRN1000
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
              REP       " 0",AGEDATE
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
.
            MATCH     PMTSTDAT,AGEDATE      * Skip record if greater
            GOTO      HTRN1000 IF LESS      * than deceased date
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            REP       " 0",AGEDATE
          ENDIF
.
          CALL      CALCAGE
.
          CALL      PATLN000
          CALL      PATFLD00
          MOVE      KEY3,FLDRTYPE
.
          MOVE      SP70,VISTDATE
          MOVE      SP70,VISTTIME
          MOVE      SP70,VISTCLAM
          MOVE      SP70,DISPCLID
          MOVE      SP70,DISPLOCN
          MOVE      SP70,DISPHOSC
          MOVE      SP70,DISPHOSN
          MOVE      SP70,DISPVCLD
          MOVE      SP70,DISPINTR
.
          PACK      KEY8,PMTSVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1            
            CALL      CLPMSVX1
          ENDIF
          MOVE      PMVXMHOS,DISPHOSC
.
          MATCH     "1",PMVXINTR
          IF        @EQUAL
            MATCH     SP70,PMPXLNG1
            IF        !@EQUAL
              PACK      KEY5,ANSL,ANSA,PMPXLNG1,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                CLEAR     DISPINTR
                APPEND    "<img src='../images/InterpretorIcon.gif'",DISPINTR
                APPEND    " alt='",DISPINTR
                APPEND    TDESC,DISPINTR
                APPEND    "'>",DISPINTR
                RESET     DISPINTR
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,PMTSVISN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,HTRN1200
.
          BRANCH    PVITYPE,HTRN1500,HTRN2000,HTRN2500
.
          MATCH     " 9",PTVITYPE
          GOTO      HTRN3000 IF EQUAL
.
          MATCH     "10",PTVITYPE
          IF        @EQUAL
            MOVE      PVIDATE,VISTDATE
            MOVE      SP70,VISTTIME
.
            IF        IBCNMHOS=1
              MATCH     PMVXMHOS,WBSEHOSP          * Display my hospital only
              GOTO      HTRN1000 IF NOT EQUAL
            ENDIF
.
            GOTO      HTRN5000
          ENDIF
.
          GOTO      HTRN5000
.
HTRN1200  MOVE      PMTSVISN,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      PMTSURNO,PVIURNO
            MOVE      OBADATE,PVIDATE
            MOVE      PMTSVISN,PVIBILL
            MOVE      OBACOMP,VISTCLAM
            GOTO      HTRN2000
          ENDIF
          MOVE      PMTSVISN,KEY8
          CALL      RDOTCAN1
          IF        OVRCD=0
            MATCH     WBSESIT,OPCNSITE      * Filter by users outpatient site
            GOTO      HTRN1000 IF NOT EQUAL
            MOVE      OPCNCOMP,VISTCLAM
.
            MOVE      OPCNCLIN,DISPCLID
.
            PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
            CALL      RDSESA1
            BRANCH    OVRCD,HTRN5000
.
            PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                            OSESSDAT,SP70
            CALL      RDOTHED1
            BRANCH    OVRCD,HTRN5000
.
            MOVE      SP70,DISPLOCN
            MATCH     SP70,OTHELTYP
            IF        !@EQUAL
              PACK      KEY5,CATCT,OTHELTYP,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      OTHELTYP,DISPLOCN
              ELSE
                MOVE      TDESC,DISPLOCN
              ENDIF
            ENDIF
            MOVE      OTHEHOSP,DISPHOSC
.
            GOTO      HTRN5000
          ENDIF
          GOTO      HTRN1000
.
HTRN1500  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,VISTDATE
            MOVE      EMVITIME,VISTTIME
            MOVE      EMVICOMP,VISTCLAM
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP          * Display my hospital only
            GOTO      HTRN1000 IF NOT EQUAL
          ENDIF
.
          GOTO      HTRN5000
.
HTRN2000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
HTRN2100  CALL      RDKBOKA3
          BRANCH    OVRCD,HTRN1000
.
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      HTRN1000 IF NOT EQUAL
.
          MATCH     OBADATE,PVIDATE
          GOTO      HTRN1000 IF NOT EQUAL
.
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      HTRN2100 IF NOT EQUAL
.
          MATCH     WBSESIT,OBASITE      * Filter by users outpatient site
          GOTO      HTRN1000 IF NOT EQUAL
.
          MOVE      OBADATE,VISTDATE
          MOVE      OBATIME,VISTTIME
          MOVE      OBACOMP,VISTCLAM
.
          MOVE      OBACLIN,DISPCLID
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,HTRN5000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,HTRN5000
.
          MOVE      SP70,DISPLOCN
          MATCH     SP70,OTHELTYP
          IF        !@EQUAL
            PACK      KEY5,CATCT,OTHELTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      OTHELTYP,DISPLOCN
            ELSE
              MOVE      TDESC,DISPLOCN
            ENDIF
          ENDIF
.
          GOTO      HTRN5000
.
HTRN2500  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ADATE,VISTDATE
            MOVE      ATIME,VISTTIME
            MOVE      ACLAIM,VISTCLAM
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP          * Display my hospital only
            GOTO      HTRN1000 IF NOT EQUAL
          ENDIF
.
          GOTO      HTRN5000
.
HTRN3000  MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          IF        OVRCD=0
            MOVE      PMEVADTE,VISTDATE
            MOVE      PMEVATIM,VISTTIME
            MOVE      PMEVCCOD,VISTCLAM
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,WBSEHOSP          * Display my hospital only
            GOTO      HTRN1000 IF NOT EQUAL
          ENDIF
.
          GOTO      HTRN5000
.
HTRN5000  MOVE      SP70,DISPFACL
          MATCH     SP70,PMTSFACL
          IF        !@EQUAL
            PACK      KEY5,CATFA,PMTSFACL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSFACL,DISPFACL
            ELSE
              MOVE      TDESC,DISPFACL
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPTRNS
          MATCH     SP70,PMTSTRNS
          IF        !@EQUAL
            PACK      KEY5,CATOB,PMTSTRNS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSTRNS,DISPTRNS
            ELSE
              MOVE      TDESC,DISPTRNS
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPMOBL
          MATCH     SP70,PMTSMOBL
          IF        !@EQUAL
            PACK      KEY5,CATPN,PMTSMOBL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSMOBL,DISPMOBL
            ELSE
              MOVE      TDESC,DISPMOBL
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPAIDS
          MATCH     SP70,PMTSAIDS
          IF        !@EQUAL
            PACK      KEY5,CATPO,PMTSAIDS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSAIDS,DISPAIDS
            ELSE
              MOVE      TDESC,DISPAIDS
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPMENT
          MATCH     SP70,PMTSMENT
          IF        !@EQUAL
            PACK      KEY5,CATPP,PMTSMENT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSMENT,DISPMENT
            ELSE
              MOVE      TDESC,DISPMENT
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPSPEC
          MATCH     SP70,PMTSSPEC
          IF        !@EQUAL
            PACK      KEY5,CATSA,PMTSSPEC,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSSPEC,DISPSPEC
            ELSE
              MOVE      TDESC,DISPSPEC
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPCLAM
          MATCH     SP70,PMTSCLAM
          IF        !@EQUAL
            PACK      KEY5,CATCL,PMTSCLAM,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMTSCLAM,DISPCLAM
            ELSE
              MOVE      TDESC,DISPCLAM
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPVCLD
          MATCH     SP70,VISTCLAM
          IF        !@EQUAL
            PACK      KEY5,CATCL,VISTCLAM,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      VISTCLAM,TDESC
            ENDIF
            MOVE      TDESC,DISPVCLD
          ENDIF
.
          CALL      GCLM0000                * Get claim number/insurance 
.
          MATCH     "1",PMTSBOOK
          IF        @EQUAL
            MOVE      DYES,DISPBOOK
          ELSE
            MOVE      DNO,DISPBOOK
          ENDIF
.
          MATCH     "1",PMTSRTBK
          IF        @EQUAL
            MOVE      DYES,DISPBOKR
          ELSE
            MOVE      DNO,DISPBOKR
          ENDIF
.
          MOVE      SP70,DIM60A
          MOVE      SP70,DIM60B
          PACK      KEY17,PMTSVISN,ZERO,ZERO,SEVEN,PMTSUNIQ,SP1,SP1,ONE,SP70
          CALL      RDVSUCM1
          IF        OVRCD=0
            MOVE      VSUCLINE,DIM60A
          ENDIF
.
          PACK      KEY17,PMTSVISN,ZERO,ZERO,SEVEN,PMTSUNIQ,SP1,SP1,TWO,SP70
          CALL      RDVSUCM1
          IF        OVRCD=0
            MOVE      VSUCLINE,DIM60B
          ENDIF
.
          MATCH     SP70,DISPHOSC
          IF        !@EQUAL
            PACK      KEY3,DISPHOSC,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      DISPHOSC,PTHSNAME
            ENDIF
            MOVE    PTHSNAME,DISPHOSN
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateTransport('",HTMLLINK
          APPEND    PMTSURNO,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMTSVISN,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PMTSUNIQ,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ListTransport('",HTMLLNK2
          APPEND    PMTSURNO,HTMLLNK2
          APPEND    "'",HTMLLNK2
          APPEND    COMMA,HTMLLNK2
          APPEND    "'",HTMLLNK2
          APPEND    PMTSVISN,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                       "#"",PMTSTDAT,PMTSTTIM,"#",":            * 1
                       "#"",PMTSPAD1,PMTSPAD2,PMTSPAD3,PMTSPAD4,PMTSPPOS,"#",":
                       "#"",PMTSPTLP,"#",":                     * 3
                       "#"",PMTSPTLB,"#",":                     * 4
                       "#"",PMTSPTLM,"#",":                     * 5
                       "#"",PMTSPEML,"#",":                     * 6
                       "#"",PMTSPMEL,"#",":                     * 7
                       "#"",PMTSRAD1,PMTSRAD2,PMTSRAD3,PMTSRAD4,PMTSRPOS,"#",":
                       "#"",PMTSRTLP,"#",":                     * 9
                       "#"",PMTSRTLB,"#",":                     * 10
                       "#"",PMTSRTLM,"#",":                     * 11
                       "#"",PMTSREML,"#",":                     * 12
                       "#"",PMTSRMEL,"#",":                     * 13
                       "#"",PMTSDAD1,PMTSDAD2,PMTSDAD3,PMTSDAD4,PMTSDPOS,"#",":
                       "#"",PMTSDTLP,"#",":                     * 15
                       "#"",PMTSDTLB,"#",":                     * 16
                       "#"",PMTSDTLM,"#",":                     * 17
                       "#"",PMTSDEML,"#",":                     * 18
                       "#"",PMTSDMEL,"#",":                     * 19
                       "#"",DISPFACL,"#",":                     * 20
                       "#"",DISPTRNS,"#",":                     * 21
                       "#"",DISPMOBL,"#",":                     * 22
                       "#"",DISPAIDS,"#",":                     * 23
                       "#"",DISPMENT,"#",":                     * 24
                       "#"",DISPSPEC,"#",":                     * 25
                       "#"",DISPCLAM,"#",":                     * 26
                       "#"",PMTSCCEN,"#",":                     * 27
                       "#"",DISPBOOK,"#",":                     * 28
                       "#"",PMTSAMBN,"#",":                     * 29
                       "#"",PMTSM40N,"#",":                     * 30
                       "#"",PMTSM40E,"#",":                     * 31
                       "#"",VISTDATE,VISTTIME,"#",":            * 32
                       "#"",PMTSVISN,"#",":                     * 33
                       "#"",DIM60A,DIM60B,"#",":                * 34
                       "#"",FORMATNM,"#",":                     * 35
                       "#"",FLDRTYPE,"#",":                     * 36
                       "#"",HTMLLNK2,"#",":                     * 37
                       "#"",CLAMNUMB,INSUNAME,"#",":            * 38
                       "#"",DISPBOKR,"#",":                     * 39
                       "#"",DISPCLID,"#",":                     * 40
                       "#"",DISPLOCN,"#",":                     * 41
                       "#"",PMTSAIDS,"#",":                     * 42
                       "#"",DISPHOSC,"#",":                     * 43
                       "#"",DISPHOSN,"#",":                     * 44
                       "#"",DISPVCLD,"#",":                     * 45
                       "#"",VISTCLAM,"#",":                     * 46
                       "#"",FORMATNM,DISPINTR,"#");"            * 47
.
          MOVE      ZERO,LOOPCNTR
.
          GOTO      HTRN1000
.
HTRN9999  RETURN
.
.*******************************************************************************
.                          Get Text Comments
.*******************************************************************************
GETEXT00  PREP      COMFILAF,COMFILNM
          MOVE      ZERO,TRNFLAG
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETEXT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETEXT90  MOVE      F3,TRNWEND
          OPEN      COMFILAF,COMFILNM
GETEXT99  RETURN
.
.
.*******************************************************************************
.         Get transport return comments          
.*******************************************************************************
GETRET00  PREP      COMFILBF,COMFILNB
          MOVE      ZERO,TRNFLAG
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETRET10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETRET90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETRET80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETRET10
.
GETRET80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETRET90  MOVE      F3,RETWEND
          OPEN      COMFILBF,COMFILNB
GETRET99  RETURN
.
.*******************************************************************************
.<*0834684*>  Visit based transport comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPCOM000  MOVE      "007",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
UPCOM400  CALL      RKVSUCM1
          BRANCH    OVRCD,UPCOM500          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      UPCOM500 IF NOT EQUAL
.
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      DEVSUCM1
          GOTO      UPCOM400
.
.         now write the new comments back
.
UPCOM500  MOVE      PMTSVISN,VSUCVISN          * set Admission Number
          MOVE      KEY3,VSUCCTYP              * set Comment Type
          MOVE      PMTSUNIQ,VSUCUCNT          * set Unique Count number
.
          MATCH     "A",UPDTTYPE
          GOTO      UPCOM510 IF EQUAL
.
          MATCH     "S",UPDTTYPE
          GOTO      UPCOM510 IF EQUAL
.
          MOVE      PMTSUDAT,VSUCUDAT      * set Record Updated Date
          MOVE      PMTSUTIM,VSUCUTIM      * set Record Updated Time
          MOVE      PMTSUUID,VSUCUUID      * set Record Updated by User ID
          MOVE      ZERO,F3
          GOTO      UPCOM520
.
UPCOM510  MOVE      PMTSCDAT,VSUCCDAT      * set Record Created Date
          MOVE      PMTSCTIM,VSUCCTIM      * set Record Created Time
          MOVE      PMTSCUID,VSUCCUID      * set Record Created by User ID
          MOVE      ZERO,F3
.
UPCOM520  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSUCLINE
.
          MATCH     SP70,VSUCLINE
          IF        @EQUAL
            IF        F3>=TRNWEND
              GOTO      UPCOM999
            ELSE
              GOTO      UPCOM520
            ENDIF
          ENDIF
.
          MOVE      F3,VSUCLNUM
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ELSE
            CALL      UPVSUCM1
          ENDIF
.              
          IF        F3>=TRNWEND
            GOTO      UPCOM999
          ENDIF
          GOTO      UPCOM520
.
UPCOM999  MOVE      ONE,TRNFLAG
          RETURN
.
.*******************************************************************************
. <0834684>  Visit based transport return comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPRET000  MOVE      ZERO,OVRCD 
          TRAP      OVERCOND IF IO          
          OPEN      COMFILBF,COMFILNB
          TRAPCLR   IO
          BRANCH    OVRCD,UPRET999
.
          MOVE      "011",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
UPRET400  CALL      RKVSUCM1
          BRANCH    OVRCD,UPRET500          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      UPRET500 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      UPRET500 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      UPRET500 IF NOT EQUAL
.
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      DEVSUCM1
.
.         now write the new comments back
.
UPRET500  MOVE      PMTSVISN,VSUCVISN          * set Admission Number
          MOVE      KEY3,VSUCCTYP              * set Comment Type
          MOVE      PMTSUNIQ,VSUCUCNT          * set Unique Count number
.
          MATCH     "A",UPDTTYPE
          GOTO      UPRET510 IF EQUAL
.
          MATCH     "S",UPDTTYPE
          GOTO      UPRET510 IF EQUAL
.
          MOVE      PMTSUDAT,VSUCUDAT      * set Record Updated Date
          MOVE      PMTSUTIM,VSUCUTIM      * set Record Updated Time
          MOVE      PMTSUUID,VSUCUUID      * set Record Updated by User ID
          MOVE      ZERO,F3
          GOTO      UPRET520
.
UPRET510  MOVE      PMTSCDAT,VSUCCDAT      * set Record Created Date
          MOVE      PMTSCTIM,VSUCCTIM      * set Record Created Time
          MOVE      PMTSCUID,VSUCCUID      * set Record Created by User ID
          MOVE      ZERO,F3
.
UPRET520  ADD       ONE,F3
          READ      COMFILBF,SEQ;VSUCLINE
.
          MATCH     SP70,VSUCLINE
          IF        @EQUAL
            IF        F3>=RETWEND
              GOTO      UPRET999
            ELSE
              GOTO      UPRET520
            ENDIF
          ENDIF
.
          MOVE      F3,VSUCLNUM
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ELSE
            CALL      UPVSUCM1
          ENDIF
.
          IF        F3>=RETWEND
            GOTO      UPRET999
          ENDIF
          GOTO      UPRET520
.
UPRET999  MOVE      ONE,RETFLAG
          RETURN
.
.*******************************************************************************
. Delete Visit based transport comments
.*******************************************************************************
DECOM000  MOVE      "007",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
DECOM400  CALL      RKVSUCM1
          BRANCH    OVRCD,DECOM999          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      DECOM999 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      DECOM999 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      DECOM999 IF NOT EQUAL
.         
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      DEVSUCM1
          GOTO      DECOM400
.         
DECOM999  RETURN
.
.
.*******************************************************************************
. Delete Visit based transport return comments
.*******************************************************************************
DERET000  MOVE      "011",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
DERET400  CALL      RKVSUCM1
          BRANCH    OVRCD,DERET999          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      DERET999 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      DERET999 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      DERET999 IF NOT EQUAL
.
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      DEVSUCM1
          GOTO      DERET400
.
DERET999  RETURN
.
.*******************************************************************************
.                    Read/Display Transport Comments
.*******************************************************************************
RDCM0000  MOVE      "007",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
RDCM1000  CALL      RKVSUCM1
          BRANCH    OVRCD,RDCM9999          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      RDCM9999 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      RDCM9999 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      RDCM9999 IF NOT EQUAL
.
          UNPACK    VSUCLINE,DIM60,DIM40    * only use first 60 chars
          WRITE     HTMLFILE;DIM60
          GOTO      RDCM1000
.
RDCM9999  RETURN
.
.
.*******************************************************************************
.                    Read/Display Return Transport Comments
.*******************************************************************************
RTCM0000  MOVE      "011",KEY3
          PACK      KEY17,PMTSVISN,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
RTCM1000  CALL      RKVSUCM1
          BRANCH    OVRCD,RTCM9999          * end of file
          MATCH     VSUCVISN,PMTSVISN       * same Admission Number?
          GOTO      RTCM9999 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      RTCM9999 IF NOT EQUAL
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      RTCM9999 IF NOT EQUAL
.
          UNPACK    VSUCLINE,DIM60,DIM40    * only use first 60 chars
          WRITE     HTMLFILE;DIM60
          GOTO      RTCM1000
.
RTCM9999  RETURN
.
.------------------------------------------------------------
. Hospital Transport Details
.------------------------------------------------------------
HOST0000  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "Transport Lists",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,HOST9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      HOST9999
.
HOST9999  RETURN
.
.------------------------------------------------------------
. Facility Address Maintenance
.------------------------------------------------------------
FACAD000  CALL      CLRADD00
          MATCH     SP70,UPDTTYPE
          GOTO      FACAD500 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add new Address
          GOTO      FACAD100 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Delete Address
          GOTO      FACAD150 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete Address
          GOTO      FACAD200 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote Address
          GOTO      FACAD210 IF EQUAL
.
          GOTO      FACAD900
.
FACAD100  CALL      ADDAD000        * Add new Address
          GOTO      FACAD999
.
FACAD150  CALL      UPDAD000        * Update Address
          GOTO      FACAD999
.
FACAD200  CALL      DELAD000        * Delete Address
          GOTO      FACAD999
.
FACAD210  CALL      REMOTE00        * Remote Script for address
          MOVE      ONE,EXIT
          GOTO      FACAD999
.
FACAD500  MATCH     SP70,PMTAA001
          GOTO      FACAD510 IF EQUAL
.
          MOVE      PMTAA001,KEY3   * Read File
          CALL      RDPMTAA1
          BRANCH    OVRCD,FACAD910
.
FACAD510  CLEAR     WEBTITLE
          MOVE      "Facility Address Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,FACAD999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      FACAD999
.
FACAD900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FACAD999
.
FACAD910  MOVE      "Missing Facility Address Record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FACAD999
.
FACAD999  RETURN
.
.------------------------------------------------------------
. Clear Facility Address Maintenance
.------------------------------------------------------------
CLRADD00  MOVE      SP70,PMTAFACL
          MOVE      SP70,PMTAADD1
          MOVE      SP70,PMTAADD2
          MOVE      SP70,PMTAADD3
          MOVE      SP70,PMTAADD4
          MOVE      SP70,PMTAPOST
          MOVE      SP70,PMTATELP
          MOVE      SP70,PMTATELB
          MOVE      SP70,PMTATELM
          MOVE      SP70,PMTAEMAI
          MOVE      SP70,PMTAMELW
          MOVE      SP70,PMTASPAR
.
CLRADD99  RETURN
.
.------------------------------------------------------------
. ADDAD000 - Write a new facility address record
.---------------------------------------------------------------------
ADDAD000  PACK      PMTAFACL,PMTAA001,SP70
          PACK      PMTAADD1,PMTAA002,SP70
          PACK      PMTAADD2,PMTAA003,SP70
          PACK      PMTAADD3,PMTAA004,SP70
          PACK      PMTAADD4,PMTAA005,SP70
          PACK      PMTAPOST,PMTAA006,SP70
          PACK      PMTATELP,PMTAA007,SP70
          PACK      PMTATELB,PMTAA008,SP70
          PACK      PMTATELM,PMTAA009,SP70
          PACK      PMTAEMAI,PMTAA010,SP70
          PACK      PMTAMELW,PMTAA011,SP70
.
          PACK      KEY3,PMTAFACL,SP70
          CALL      RAPMTAA1
          IF        OVRCD<>1
            GOTO      ADDAD999
          ENDIF
.
          CALL      WRPMTAA1
.
ADDAD999  RETURN
.
.------------------------------------------------------------
. UPDAD000 - Update a facility address record
.---------------------------------------------------------------------
UPDAD000  PACK      PMTAFACL,PMTAA001,SP70
          PACK      PMTAADD1,PMTAA002,SP70
          PACK      PMTAADD2,PMTAA003,SP70
          PACK      PMTAADD3,PMTAA004,SP70
          PACK      PMTAADD4,PMTAA005,SP70
          PACK      PMTAPOST,PMTAA006,SP70
          PACK      PMTATELP,PMTAA007,SP70
          PACK      PMTATELB,PMTAA008,SP70
          PACK      PMTATELM,PMTAA009,SP70
          PACK      PMTAEMAI,PMTAA010,SP70
          PACK      PMTAMELW,PMTAA011,SP70
.
          PACK      KEY3,PMTAFACL,SP70
          CALL      RAPMTAA1
          BRANCH    OVRCD,UPDAD900
.
          CALL      UPPMTAA1
          GOTO      UPDAD999
.
UPDAD900  MOVE      "Missing Address Record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDAD999
.
UPDAD999  RETURN
.
.------------------------------------------------------------
. DELAD000 - Delete a facility Address record
.---------------------------------------------------------------------
DELAD000  PACK      PMTAFACL,PMTAA001,SP70
.
          PACK      KEY3,PMTAFACL,SP70
          CALL      RDPMTAA1
          IF        OVRCD<>1
            CALL      DEPMTAA1
          ENDIF
.
DELAD999  RETURN
.
.------------------------------------------------------------
. Set pmstaaaf Input Variables
.------------------------------------------------------------
SPTAA000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
.
          BRANCH    F3,SPTAA010,SPTAA020,SPTAA030,SPTAA040,SPTAA050:
                       SPTAA060,SPTAA070,SPTAA080,SPTAA090,SPTAA100:
                       SPTAA110
.
SPTAA010  MOVE      QRYDATA,PMTAA001
          GOTO      SPTAA999
.
SPTAA020  MOVE      QRYDATA,PMTAA002
          GOTO      SPTAA999
.
SPTAA030  MOVE      QRYDATA,PMTAA003
          GOTO      SPTAA999
.
SPTAA040  MOVE      QRYDATA,PMTAA004
          GOTO      SPTAA999
.
SPTAA050  MOVE      QRYDATA,PMTAA005
          GOTO      SPTAA999
.
SPTAA060  MOVE      QRYDATA,PMTAA006
          GOTO      SPTAA999
.
SPTAA070  MOVE      QRYDATA,PMTAA007
          GOTO      SPTAA999
.
SPTAA080  MOVE      QRYDATA,PMTAA008
          GOTO      SPTAA999
.
SPTAA090  MOVE      QRYDATA,PMTAA009
          GOTO      SPTAA999
.
SPTAA100  MOVE      QRYDATA,PMTAA010
          GOTO      SPTAA999
.
SPTAA110  MOVE      QRYDATA,PMTAA011
          GOTO      SPTAA999
.
SPTAA999  RETURN
.
.------------------------------------------------------------------------------
. Remote Scripting for default address
.------------------------------------------------------------------------------
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
          BRANCH    REMOTENO,REMOTE10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      GETD0000
          GOTO      REMOTE90
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
.
.-----------------------------------------------------------
. Get the default address for the facility
.-----------------------------------------------------------
GETD0000  PACK      KEY3,VALDCODE,SP70
          CALL      RDPMTAA1
          BRANCH    OVRCD,GETD9000
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMTAADD1,"|":
                    PMTAADD2,"|":
                    PMTAADD3,"|":
                    PMTAADD4,"|":
                    PMTAPOST,"|":
                    PMTATELP,"|":
                    PMTATELB,"|":
                    PMTATELM,"|":
                    PMTAEMAI,"|":
                    PMTAMELW,"|":
                    "</RETURN_VALUE>"
          GOTO      GETD9999
.
GETD9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    "</RETURN_VALUE>"
GETD9999  RETURN
.
.------------------------------------------------------------
. Facility address  tags
.------------------------------------------------------------
PMTA0000  BRANCH    FLDITMNO,PMTA0100,PMTA0200,PMTA0300,PMTA0400,PMTA0500:
                             PMTA0600,PMTA0700,PMTA0800,PMTA0900,PMTA1000:
                             PMTA1100,PMTA1200,PMTA1300,PMTA1400
          GOTO      PMTA9999
.
PMTA0100  MOVE      "fa",CATEGORY
          MOVE      PMTAFACL,CODE
          CALL      CODITM00
          GOTO      PMTA9999
.
PMTA0200  WRITE     HTMLFILE;PMTAADD1;
          GOTO      PMTA9999
.
PMTA0300  WRITE     HTMLFILE;PMTAADD2;
          GOTO      PMTA9999
.
PMTA0400  WRITE     HTMLFILE;PMTAADD3;
          GOTO      PMTA9999
.
PMTA0500  WRITE     HTMLFILE;PMTAADD4;
          GOTO      PMTA9999
.
PMTA0600  WRITE     HTMLFILE;PMTAPOST;
          GOTO      PMTA9999
.
PMTA0700  WRITE     HTMLFILE;PMTATELP;
          GOTO      PMTA9999
.
PMTA0800  WRITE     HTMLFILE;PMTATELB;
          GOTO      PMTA9999
.
PMTA0900  WRITE     HTMLFILE;PMTATELM;
          GOTO      PMTA9999
.
PMTA1000  WRITE     HTMLFILE;PMTAEMAI;
          GOTO      PMTA9999
.
PMTA1100  WRITE     HTMLFILE;PMTAMELW;
          GOTO      PMTA9999
.
PMTA1200  CALL      FACTB000                * List facility address
          GOTO      PMTA9999
.
PMTA1300  CALL      NEXTAD00                * Next set of facility address
          GOTO      PMTA9999
.
PMTA1400  CALL      PREVAD00                * Prev set of facility address
          GOTO      PMTA9999
.
PMTA9999  RETURN
.
.------------------------------------------------------------
. Table of facility Address Details
.------------------------------------------------------------
FACTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      FCHED000              * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY3,STARTKEY,SP70
          CALL      RDPMTAA1
          IF        OVRCD=0
            CALL      RPPMTAA1
          ENDIF
FACTB100  CALL      RKPMTAA1
          BRANCH    OVRCD,FACTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FACTB100
          ENDIF
.
          CALL      FCROW000      * Address Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      FACTB100 IF NOT EQUAL
          GOTO      FACTB999
.
FACTB900  CALL      NOMORE00      * Display No More Records Message
.
FACTB999  RETURN
.------------------------------------------------------------
. Address Table Details (TABLE HEADING)
.------------------------------------------------------------
FCHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=40%>":
                               "<b>Facility</b></td>":
                               "<td class=HeadingCell width=60%>":
                               "<b>Address</b></td>":
                             "</tr>"
.
FCHED999  RETURN
.------------------------------------------------------------
. Address File Table (TABLE ROW)
.------------------------------------------------------------
FCROW000  PACK      KEY5,CATFA,PMTAFACL,SP70
          CALL      RDCODE1
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&pmtaa001=",PMTAFACL,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             TDESC,"</td>":
                             "<td>",PMTAADD1,"<br>":
                             PMTAADD2,"<br>":
                             PMTAADD3,"<br>":
                             PMTAADD4,"<br>":
                             PMTAPOST,"</td>":
                             "</tr>"
.
FCROW999 RETURN
.
.-----------------------------------------------------------
. Link to Next Group of Addresses
.-----------------------------------------------------------
NEXTAD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMTAFACL
.
          WRITE     HTMLFILE;"patweb10.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pmtaa001=",PMTAFACL:
                                 "&startkey=",STARTKEY;
          REP       "+ ",PMTAFACL
.
NEXTAD99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of Address
.-------------------------------------------------------------
PREVAD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMTAFACL
.
          WRITE     HTMLFILE;"patweb10.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pmtaa001=",PMTAFACL:
                                 "&startkey=",STARTKEY;
          REP       "+ ",PMTAFACL
.
PREVAD99  RETURN
.
.*************************************************
.*                BKTM00                         *           
.*        Get the Appointment details            *
.*************************************************
BKTM0000  PACK      KEY36,ADMISSNO,SP70                                
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,BKTM9000
.
          MATCH     DOBAOUTN,ADMISSNO
          GOTO      BKTM9000 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBOKB1
          IF        OVRCD=1
            CALL      CLOUTBB1
          ENDIF
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD<>1
            PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT:
                            OSESSHNO,OSESSDAT,SP70
            CALL      RDOTHED1
            IF        OVRCD=1
              CALL      CLOUTHED
            ENDIF
          ELSE
            CALL     CLOUTHED
          ENDIF
.
          CALL      CLOUTART
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          IF        OVRCD=0
            MATCH     ADMISSNO,ALLNLNKV
            IF        @EQUAL
              PACK      KEY32,URNUMBER,ALLNVISN,Z70
              CALL      RSOTART1
BKTM5000      CALL      RPOTART1
              BRANCH    OVRCD,BKTM9500
.
              MATCH     URNUMBER,OTARURNO
              GOTO      BKTM9500 IF NOT EQUAL
.
              MATCH     ALLNVISN,OTARREFN
              GOTO      BKTM9500 IF NOT EQUAL
.
              MATCH     ADMISSNO,OTARBKNO
              GOTO      BKTM5000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      BKTM9999
.
BKTM9000  CALL      CLOUTBOA
          CALL      CLOUTBB1
          CALL      CLOUTHED
.
BKTM9500  CALL      CLOUTART
.
BKTM9999  RETURN
.
.*************************************************
.*                SRTM00                         *
.*        Get the Appointment time for series    *
.*************************************************
SRTM0000  PACK      KEY36,PMTSVISN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SRTM9000
.
          MATCH     DOBAOUTN,PMTSVISN
          GOTO      SRTM9999 IF EQUAL
.
SRTM9000  CALL      CLOUTBOA
.
SRTM9999  RETURN
.
.*******************************************************************************
.  Copy Visit based transport comments for series
.*******************************************************************************
CPCOM000  MOVE      "007",KEY3
          PACK      KEY17,ADMISSNO,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
CPCOM100  CALL      RKVSUCM1
          BRANCH    OVRCD,CPCOM999          * end of file
.
          MATCH     VSUCVISN,ADMISSNO       * same Admission Number?
          GOTO      CPCOM999 IF NOT EQUAL
.
          MATCH     VSUCCTYP,KEY3
          GOTO      CPCOM999 IF NOT EQUAL
.
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      CPCOM999 IF NOT EQUAL
.
          PACK      SAVKEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM,SP70
.
          MOVE      PMTSVISN,VSUCVISN
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ENDIF
.
          MOVE      SAVKEY17,KEY17
          CALL      RDVSUCM1                * re position on correct record
          GOTO      CPCOM100
.
CPCOM999  RETURN
.
.
.*******************************************************************************
.  Copy Visit based transportr return comments for series
.*******************************************************************************
CPRET000  MOVE      "011",KEY3
          PACK      KEY17,ADMISSNO,KEY3,PMTSUNIQ,SP70
          CALL      RSVSUCM1
CPRET100  CALL      RKVSUCM1
          BRANCH    OVRCD,CPRET999          * end of file
.
          MATCH     VSUCVISN,ADMISSNO       * same Admission Number?
          GOTO      CPRET999 IF NOT EQUAL
.
          MATCH     VSUCCTYP,KEY3
          GOTO      CPRET999 IF NOT EQUAL
.
          MATCH     VSUCUCNT,PMTSUNIQ
          GOTO      CPCOM999 IF NOT EQUAL
.
          PACK      SAVKEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM,SP70
.
          MOVE      PMTSVISN,VSUCVISN
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ENDIF
.
          MOVE      SAVKEY17,KEY17
          CALL      RDVSUCM1                * re position on correct record
          GOTO      CPRET100
.
CPRET999  RETURN
.
.*******************************************************************************
.  Copy Visit based transport comments for future series bookings
.*******************************************************************************
FTCOM000  MOVE      "007",KEY3
          PACK      KEY17,PMTSP002,KEY3,PMTSP003,SP70
          CALL      RSVSUCM1
FTCOM100  CALL      RKVSUCM1
          BRANCH    OVRCD,FTCOM999          * end of file
.
          MATCH     VSUCVISN,PMTSP002       * same Admission Number?
          GOTO      FTCOM999 IF NOT EQUAL
.
          MATCH     VSUCCTYP,KEY3
          GOTO      FTCOM999 IF NOT EQUAL
.
          MATCH     VSUCUCNT,KEY3
          GOTO      FTCOM999 IF NOT EQUAL
.
          PACK      SAVKEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM,SP70
.
          MOVE      PMTSVISN,VSUCVISN
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ENDIF
.
          MOVE      SAVKEY17,KEY17
          CALL      RDVSUCM1                * re position on correct record
          GOTO      FTCOM100
.
FTCOM999  RETURN
.
.
.*******************************************************************************
.  Copy Visit based transport return comments for future series bookings
.*******************************************************************************
FTRET000  MOVE      "011",KEY3
          PACK      KEY17,PMTSP002,KEY3,PMTSP003,SP70
          CALL      RSVSUCM1
FTRET100  CALL      RKVSUCM1
          BRANCH    OVRCD,FTRET999          * end of file
.
          MATCH     VSUCVISN,PMTSP002       * same Admission Number?
          GOTO      FTRET999 IF NOT EQUAL
.
          MATCH     VSUCCTYP,KEY3
          GOTO      FTRET999 IF NOT EQUAL
.
          MATCH     VSUCUCNT,KEY3
          GOTO      FTRET999 IF NOT EQUAL
.
          PACK      SAVKEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM,SP70
.
          MOVE      PMTSVISN,VSUCVISN
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ENDIF
.
          MOVE      SAVKEY17,KEY17
          CALL      RDVSUCM1                * re position on correct record
          GOTO      FTRET100
.
FTRET999  RETURN
.
.------------------------------------------------------------
. Theatre Diary/Calendar view
.------------------------------------------------------------
THEV0000  MATCH     SP70,UPDTTYPE
          GOTO      THEV7000 IF EQUAL
.
..          MATCH     "U",UPDTTYPE    * XXXXXXXXXXXXXXXX
..          GOTO      THEV1000 IF EQUAL
.
          GOTO      THEV9000
.
THEV7000  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "Theatre Diary",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,THEV9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      THEV9999
.
THEV9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THEV9999
.
THEV9999  RETURN
.
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
THET0000  BRANCH    FLDITMNO,THET0100,THET0200,THET0300,THET0400,THET0500:
                             THET0600,THET0700,THET0800,THET0900,THET1000:
                             THET1100,THET1200,THET1300,THET1400,THET1500
          GOTO      THET9999
.
THET0100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      THET9999
.
THET0200  CALL      NEXT0000
          GOTO      THET9999
.
THET0300  CALL      PREV0000
          GOTO      THET9999
.
THET0400  CALL      SELV0000
          GOTO      THET9999
.
THET0500  MOVE      "0",LSTDSCFL
          CALL      TABT0000                * Theatre diary/calendar
          GOTO      THET9999
.
THET0600  CALL      PREVTH00
          GOTO      THET9999
.
THET0700  CALL      NEXTTH00
          GOTO      THET9999
.
THET0800  MATCH     SP70,FILTTLOC
          IF        @EQUAL
            PACK      KEY5,ANSY,ONE,WBSEDGSI,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      WBSEDGSI,FILTTLOC
            ENDIF
.
            WRITE     HTMLFILE;FILTTLOC;
          ELSE
            WRITE     HTMLFILE;FILTTLOC;
          ENDIF
          GOTO      THET9999
.
THET0900  
          GOTO      THET9999
.
THET1000  
          GOTO      THET9999
.
THET1100  CALL      TDCML000               *Output current date      *T0846427
          GOTO      THET9999               *comment line1
.
THET1200  WRITE     HTMLFILE;DISPDAYC;     *Display Day comments     *T0846427
          GOTO      THET9999               *flag
.
THET1300  CALL      TDCMC000               *Current date comment     *T0846427
          GOTO      THET9999               *lines count
.
THET1400  MOVE      "1",LSTDSCFL              
          CALL      TABT0000               * Theatre diary Day View By Desc
          GOTO      THET9999
.
THET1500  WRITE     HTMLFILE;DISPWKNO;     
          GOTO      THET9999
.
THET9999  RETURN
.
.------------------------------------------------------------------------------
. List current date theatre comments for line 1                      *T0846427
.------------------------------------------------------------------------------
TDCML000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCML999 IF NOT EQUAL    *No, exit
.
          MOVE      SP70,OPCMTEXT
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY25,CURRDATE,SP70
          CALL      RSOPCOM1
TDCML100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCML999
.
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital
          GOTO      TDCML100 IF NOT EQUAL          
.
          MATCH     CURRDATE,OPCMDATE        * same date
          GOTO      TDCML999 IF NOT EQUAL
.
          COMPARE   ONE,OPCMLINE             *First line?
          GOTO      TDCML999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPCMTEXT;       *Output first line
          GOTO      TDCML999
.
TDCML999  RETURN
.
.------------------------------------------------------------------------------
. Count current date theatre comments                                *T0846427
.------------------------------------------------------------------------------
TDCMC000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCMC999 IF NOT EQUAL    *No, exit
.
          MOVE      ZERO,DAYCMCNT            *Current date comment line count
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY25,CURRDATE,SP70
          CALL      RSOPCOM1
TDCMC100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCMC300
.
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital
          GOTO      TDCMC100 IF NOT EQUAL          
.
          MATCH     CURRDATE,OPCMDATE        * same date 
          GOTO      TDCMC300 IF NOT EQUAL
.
          ADD       ONE,DAYCMCNT
          GOTO      TDCMC100
.
TDCMC300  WRITE     HTMLFILE;DAYCMCNT;       *Output line count
          GOTO      TDCMC999
.
TDCMC999  RETURN
.
.*******************************************************************************
.  Display theatre diary/calendar view   
.*******************************************************************************
TABT0000  WRITE     HTMLFILE;"<tr>"
.
          CALL      TTIM0000                          * Display times
.
          MOVE      FRSTDATE,WORKDATE                 * Start date
.
          WRITE     HTMLFILE;"<td><table width=100%><tr>"
TABT8000  MATCH     WORKDATE,LASTDATE
          GOTO      TABT9500 IF LESS
.
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          WRITE     HTMLFILE;"<td>"
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center >"
          WRITE     HTMLFILE;"<tr height=26><td align=center >":
                              DAYNAM3,DASH,DISPDATE
          WRITE     HTMLFILE;"</td></tr></table>"
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=0 border=0 ":
                             "width=100% align=center >"
          WRITE     HTMLFILE;"<tr>"
.         
          CALL      PTHE0000                          * Print theatre details
.
          IF        NOSESFLG=1
            CALL      BFIL0000                        * Blank filler
          ENDIF
.
          WRITE     HTMLFILE;"</tr></table></td>"
.
          MATCH     "0",VIEWTYPE                      * Day or week display
          IF        !@EQUAL
            ADD       ONE,WORKDATE 
            GOTO      TABT8000
          ENDIF
.
TABT9500  WRITE     HTMLFILE;"</tr></table></td></tr>"
.         
TABT9999  RETURN
.
.------------------------------------------------------------
. Print theatre details on theatre
.------------------------------------------------------------
PTHE0000  MOVE      ONE,NOSESFLG                 * Set no session flag to yes
          MOVE      Z70,SAVETHET
          MOVE      ZERO,ADJUSFLG
.
          MATCH     "0",VIEWTYPE                 * Day
          IF        @EQUAL
            IF        NORECORD=0
              MOVE      "7",NORECORD       * Set Default No Records to Display
            ENDIF
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
          ENDIF
.
.***************************************************************************
.* step 1. Look for booked sessions without an assigned theatre
.*         and list these first.
.***************************************************************************
          PACK      KEY28,WBSEHOSP,WORKDATE,SP70
          CALL      RSOPSES4
PTHE0250  CALL      RKOPSES4                     * Display black sessions
          BRANCH    OVRCD,PTHE0300
.         
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      PTHE0300 IF NOT EQUAL
.
          MATCH     OPSEDATE,WORKDATE
          GOTO      PTHE0300 IF NOT EQUAL
.
          MATCH     SP70,OPSETHET
          GOTO      PTHE0300 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT                * Cancelled
          GOTO      PTHE0250 IF EQUAL
.
          COMPARE   ONE,OPSESTAT
          IF        @EQUAL
            MOVE      TWO,FILLCLAS               * Normal session
          ENDIF
.
          COMPARE   TWO,OPSESTAT
          IF        @EQUAL
            MOVE      THREE,FILLCLAS             * Extra session
          ENDIF
.
          MATCH     "0",VIEWTYPE                 * Day 
          IF        @EQUAL
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PTHE0250
            ENDIF
          ENDIF
.
          MOVE      OPSETIME,STRTTIME
          MOVE      OPSEENDT,ENDTIME
          MOVE      SP70,OPRMROOM
          MOVE      SP70,OPRMDESC
.
          CALL      CTAR0000                     * Clear display array
.          
          PACK      SESSKEYS,OPSEDATE,OPSETIME,OPSECLIN,SP70
          MOVE      SESSKEYS,FILLDETL
. 
          CALL      TFIL0000                     * Fill time array
          CALL      DTHE0000                     * Display session
.
          MATCH     "0",VIEWTYPE                 * Day 
          IF        @EQUAL
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      PTHE0250 IF NOT EQUAL
            GOTO      PTHE9999
          ELSE
            GOTO      PTHE0250
          ENDIF
. 
.***************************************************************************
.* step 2. Loop through the theatres that are active and possibly 
.*         matching the user defined theatre filter (OPRMUSR1 = Category Y1)
.***************************************************************************
PTHE0300  MATCH     "1",LSTDSCFL
          IF        @EQUAL  
            PACK      KEY46,SP70 
            CALL      RSOPOPR2
          ELSE
            PACK      KEY6,SP70
            CALL      RSOPOPR1
          ENDIF
PTHE0500  MATCH     "1",LSTDSCFL
          IF        @EQUAL    
            CALL      RKOPOPR2
          ELSE
            CALL      RKOPOPR1
          ENDIF   
          BRANCH    OVRCD,PTHE9999
.
          BRANCH    OPRMSTAT,PTHE0500            * Skip inactive
.         
          IF        IBCNMHOS=1
            MATCH     SP70,OPRMHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,OPRMHOSP        * Multi hospital test
              GOTO      PTHE0500 IF NOT EQUAL
            ELSE
              GOTO      PTHE0500
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTTLOC                * Is location filter set?
          IF        !@EQUAL
            MATCH     "zzz",FILTTLOC
            IF        !@EQUAL
              MATCH     FILTTLOC,OPRMUSR1        * Location is in user fld 1
              GOTO      PTHE0500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "0",VIEWTYPE                 * Day
          IF        @EQUAL
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PTHE0500
            ENDIF
          ENDIF
.
          CALL      CTAR0000                     * Clear display array
.
          PACK      KEY28,WBSEHOSP,WORKDATE,OPRMROOM,SP70
          CALL      RSOPSES4
PTHE1000  CALL      RKOPSES4
          BRANCH    OVRCD,PTHE3000
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      PTHE3000 IF NOT EQUAL
.
          MATCH     OPSEDATE,WORKDATE
          GOTO      PTHE3000 IF NOT EQUAL
.
          MATCH     OPSETHET,OPRMROOM
          GOTO      PTHE3000 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT                * Cancelled
          GOTO      PTHE1000 IF EQUAL
.         
          COMPARE   ONE,OPSESTAT
          IF        @EQUAL
            MOVE      TWO,FILLCLAS               * Normal session
          ENDIF
.
          COMPARE   TWO,OPSESTAT
          IF        @EQUAL
            MOVE      THREE,FILLCLAS             * Extra session
          ENDIF
.
          PACK      SESSKEYS,OPSEDATE,OPSETIME,OPSECLIN,SP70
          MOVE      SESSKEYS,FILLDETL
.
          MOVE      OPSETIME,STRTTIME
          MOVE      OPSEENDT,ENDTIME
          CALL      TFIL0000                          * Fill time array
.
          GOTO      PTHE1000
.
PTHE3000  PACK      KEY19,OPRMROOM,WORKDATE,SP70
          CALL      RSOPUAV1
PTHE4000  CALL      RKOPUAV1
          BRANCH    OVRCD,PTHE5000
.
          MATCH     OPRMROOM,OPUATHET
          GOTO      PTHE5000 IF NOT EQUAL
.
          MATCH     WORKDATE,OPUADATE
          GOTO      PTHE5000 IF NOT EQUAL
.
          MOVE      FOUR,FILLCLAS
          PACK      FILLDETL,OPUASTIM,SP1,DASH,SP1,OPUAETIM        
          MOVE      OPUASTIM,STRTTIME
          MOVE      OPUAETIM,ENDTIME
          CALL      TFIL0000                          * Fill time array
          GOTO      PTHE4000
.
PTHE5000  CALL      DTHE0000                          * Display theatre
.
          MATCH     "0",VIEWTYPE                 * Day
          IF        @EQUAL
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      PTHE0500 IF NOT EQUAL
          ELSE
            GOTO      PTHE0500
          ENDIF
.
PTHE9999  RETURN
.
.------------------------------------------------------------
. Display theatre details
.------------------------------------------------------------
DTHE0000  MOVE      ZERO,NOSESFLG
.
          CALL      COVR0000                     * Check for any overlaps
.
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     "1",LSTDSCFL
          IF        @EQUAL
            PACK      DISPTDAY[ONE][ONE],ONE,SP10,SP9,OPRMDESC,SP70
          ELSE
            PACK      DISPTDAY[ONE][ONE],ONE,SP10,SP9,OPRMROOM,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<td width=13%>"
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=0 border=1 ":
                             "width=100% align=center >"
.
          MOVE      ONE,COUNT
          MOVE      SP70,SAVSKEYA
          MOVE      SP70,SAVSKEYB
          MOVE      SP70,SAVSKEYC
          MOVE      ZERO,DISPLCNA
          MOVE      ZERO,DISPLCNB
          MOVE      ZERO,DISPLCNC
.
          WHILE     COUNT <= 28
.
            MOVE      ZERO,ADJUSFLG
            MOVE      SP70,DISPCLSA
            UNPACK    DISPTDAY[COUNT][ONE],D1,SESSKEYA:
                      DISPTDAY[COUNT][ONE]
            MOVE      ZERO,FDISCLSA
            MOVE      D1,FDISCLSA
            LOAD      DISPCLSA,FDISCLSA,LOADCLS1,THECLAS1,THECLAS2,THECLAS3:
                                  THECLAS4
.
            MOVE      SP70,DISPCLSB
            UNPACK    DISPTDAY[COUNT][TWO],D1,SESSKEYB:
                      DISPTDAY[COUNT][TWO]
            MOVE      ZERO,FDISCLSB
            MOVE      D1,FDISCLSB
            LOAD      DISPCLSB,FDISCLSB,LOADCLS1,THECLAS1,THECLAS2,THECLAS3:
                                  THECLAS4
.
            MOVE      SP70,DISPCLSC
            UNPACK    DISPTDAY[COUNT][THREE],D1,SESSKEYC:
                      DISPTDAY[COUNT][THREE]
            MOVE      ZERO,FDISCLSC
            MOVE      D1,FDISCLSC
            LOAD      DISPCLSC,FDISCLSC,LOADCLS1,THECLAS1,THECLAS2,THECLAS3:
                                  THECLAS4
.
            MATCH     SAVSKEYA,SESSKEYA
            IF        !@EQUAL
              MOVE      SESSKEYA,SAVSKEYA
              MOVE      ONE,DISPLCNA
            ELSE
              ADD       ONE,DISPLCNA
            ENDIF
.
            MATCH     SAVSKEYB,SESSKEYB
            IF        !@EQUAL
              MOVE      SESSKEYB,SAVSKEYB
              MOVE      ONE,DISPLCNB
            ELSE
              ADD       ONE,DISPLCNB
            ENDIF
.
            MATCH     SAVSKEYC,SESSKEYC
            IF        !@EQUAL
              MOVE      SESSKEYC,SAVSKEYC
              MOVE      ONE,DISPLCNC
            ELSE
              ADD       ONE,DISPLCNC
            ENDIF
.
            IF        COUNT=1
              WRITE     HTMLFILE;"<tr height=26><td nowrap ",DISPCLSA,"  ":
                                 "align=center colspan=3>":
                                 DISPTDAY[COUNT][ONE]:
                                 "&nbsp;</td></tr>"
            ELSE
              MOVE      ZERO,OVERLAPF
              CALL      ADJUST00                     * Check Adjust Time
              IF        DISPLCNA=3 & ADJUSFLG=1
                MOVE      THECLAS5,DISPCLSA
              ENDIF
.
              MATCH   "0",VIEWTYPE
              IF      @EQUAL
                WRITE     HTMLFILE;"<tr class='diary_cell1' height=26>":
                                   "<td nowrap ",DISPCLSA,">";
              ELSE
                WRITE     HTMLFILE;"<tr class='diary_cell2' height=26>":
                                   "<td nowrap ",DISPCLSA,">";
              ENDIF
              MOVE      ZERO,OVERLAPF
              CALL      PLIN0000            * Print details
              WRITE     HTMLFILE;"&nbsp;</td>";
.
              IF        OVERLAP1=1
                MOVE      ONE,OVERLAPF
                CALL      ADJUST00
                IF        DISPLCNB=3 & ADJUSFLG=1
                  MOVE      THECLAS5,DISPCLSB
                ENDIF
                WRITE     HTMLFILE;"<td nowrap ",DISPCLSB,">";
                CALL      PLIN0000            * Print details
                WRITE     HTMLFILE;"&nbsp;</td>";
              ENDIF
.
              IF        OVERLAP2=1
                MOVE      TWO,OVERLAPF
                CALL      ADJUST00
                IF        DISPLCNC=3 & ADJUSFLG=1
                  MOVE      THECLAS5,DISPCLSC
                ENDIF
                WRITE     HTMLFILE;"<td nowrap ",DISPCLSC,">";
                CALL      PLIN0000            * Print details
                WRITE     HTMLFILE;"&nbsp;</td>";
              ENDIF
              WRITE     HTMLFILE;"</tr>"
            ENDIF
            ADD       ONE,COUNT
          DO
.
          WRITE     HTMLFILE;"</table></td>"
.
DTHE9999  RETURN
.
.------------------------------------------------------------
. Check if there are any overlaps for this theatre.
. A max of 
.------------------------------------------------------------
COVR0000  MOVE      ZERO,OVERLAP1
          MOVE      ZERO,OVERLAP2
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 28
            MATCH     SP70,DISPTDAY[COUNT][TWO]
            IF        !@EQUAL
              MOVE      ONE,OVERLAP1
            ENDIF
            MATCH     SP70,DISPTDAY[COUNT][THREE]
            IF        !@EQUAL
              MOVE      ONE,OVERLAP2
            ENDIF
            ADD       ONE,COUNT
          DO
.
COVR9999  RETURN
.------------------------------------------------------------
. Print line details using sesskeys if there is appropriate space
.------------------------------------------------------------
PLIN0000  IF        OVERLAPF=0
            MATCH     SP70,SESSKEYA
            GOTO      PLIN9999 IF EQUAL
            COMPARE   FOUR,FDISCLSA           * Unavailable
            GOTO      PLIN1900 IF EQUAL
.
            PACK      KEY19,SESSKEYA,SP70
          ENDIF
.
          IF        OVERLAPF=1
            MATCH     SP70,SESSKEYB
            GOTO      PLIN9999 IF EQUAL
            COMPARE   FOUR,FDISCLSB           * Unavailable
            GOTO      PLIN1900 IF EQUAL
.
            PACK      KEY19,SESSKEYB,SP70
          ENDIF
.
          IF        OVERLAPF=2
            MATCH     SP70,SESSKEYC
            GOTO      PLIN9999 IF EQUAL
            COMPARE   FOUR,FDISCLSC           * Unavailable
            GOTO      PLIN1900 IF EQUAL
.
            PACK      KEY19,SESSKEYC,SP70
          ENDIF
.
          PACK      KEY22,WBSEHOSP,KEY19,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,PLIN9999
.
          MATCH     "0",VIEWTYPE            * Day view
          IF        !@EQUAL
            IF        OVERLAPF=0
              COMPARE   ONE,DISPLCNA
              GOTO      PLIN9999 IF NOT EQUAL
            ENDIF
            IF        OVERLAPF=1
              COMPARE   ONE,DISPLCNB
              GOTO      PLIN9999 IF NOT EQUAL
            ENDIF
            IF        OVERLAPF=2
              COMPARE   ONE,DISPLCNC
              GOTO      PLIN9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,WEEKCYCL
          IF        DISPWKNO=1
            CALL      WKCN0000                        * Week cycle number
          ENDIF
.
          IF        OVERLAPF=0
            BRANCH    DISPLCNA,PLIN1000,PLIN1100,PLIN1200,PLIN1300,PLIN1400:
                               PLIN1500,PLIN1600,PLIN1700,PLIN1800
          ENDIF
          IF        OVERLAPF=1 
            BRANCH    DISPLCNB,PLIN1000,PLIN1100,PLIN1200,PLIN1300,PLIN1400:
                               PLIN1500,PLIN1600,PLIN1700,PLIN1800
          ENDIF
          IF        OVERLAPF=2
            BRANCH    DISPLCNC,PLIN1000,PLIN1100,PLIN1200,PLIN1300,PLIN1400:
                               PLIN1500,PLIN1600,PLIN1700,PLIN1800
          ENDIF
          GOTO      PLIN9999
.
PLIN1000  IF        OVERLAPF=0
            MOVE      SESSKEYA,HOVERKEY
            CALL      HOVR0000
            WRITE     HTMLFILE;"<img src=../images/TheatreSessionIcon.gif ":
                               "onmouseover='show_it(#"",HOVERSES,"#");'":
                               " onmouseout='hide_it();'":
                               " onclick=#"ViewSession(#'":
                               OPSEHOSP,SESSKEYA,"#');#">";
          ENDIF
.
          IF        OVERLAPF=1
            MOVE      SESSKEYB,HOVERKEY
            CALL      HOVR0000
            WRITE     HTMLFILE;"<img src=../images/TheatreSessionIcon.gif ":
                               "onmouseover='show_it(#"",HOVERSES,"#");'":
                               " onmouseout='hide_it();'":
                               " onclick=#"ViewSession(#'":
                               OPSEHOSP,SESSKEYB,"#');#">";
          ENDIF
.
          IF        OVERLAPF=2
            MOVE      SESSKEYC,HOVERKEY
            CALL      HOVR0000
            WRITE     HTMLFILE;"<img src=../images/TheatreSessionIcon.gif ":
                               "onmouseover='show_it(#"",HOVERSES,"#");'":
                               " onmouseout='hide_it();'":
                               " onclick=#"ViewSession(#'":
                               OPSEHOSP,SESSKEYC,"#');#">";
          ENDIF
.
          MATCH     "0",VIEWTYPE
          GOTO      PLIN9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPSECLIN;
          WRITE     HTMLFILE;SP1,WEEKCYCL;
.
          MATCH     SP70,OPSEFIND
          IF        !@EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=dummyfin":
                               " disabled checked title=Finalised>"
          ENDIF
.
          MATCH     SP70,OPSESPI1
          GOTO      PLIN1090 IF NOT EQUAL
.
          MATCH     SP70,OPSESPI2
          GOTO      PLIN1090 IF NOT EQUAL
.
          PACK      KEY25,OPSEHOSP,OPSEDATE,SP70
          CALL      RSOPCOM2
          CALL      RKOPCOM2
          BRANCH    OVRCD,PLIN1050
.
          MATCH     OPSEHOSP,OPCMHOSP
          GOTO      PLIN1050 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE
          GOTO      PLIN1050 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME 
          GOTO      PLIN1050 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN 
          GOTO      PLIN1050 IF NOT EQUAL
.
          GOTO      PLIN1090
.
PLIN1050  PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM1
          CALL      RKOPCOM1
          BRANCH    OVRCD,PLIN9999
.
          MATCH     OPSEDATE,OPCMDATE
          GOTO      PLIN9999 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME
          GOTO      PLIN9999 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN
          GOTO      PLIN9999 IF NOT EQUAL
.
PLIN1090  WRITE     HTMLFILE;"<img src=../images/CommentIconR.gif ":
                             "title='Special Instructions/Comments'>"
          GOTO      PLIN9999
.
PLIN1100  COMPARE   ZERO,OPCNCLSU
          GOTO      PLIN1110 IF NOT EQUAL   * Checking For The Clinic Status
.
          MOVE      SP70,KEY50 
          PACK      KEY6,OPSECLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,PLIN1120
.
          MOVE      OPCLDESC,KEY50        * For Displaying Clinic Descrition
          GOTO      PLIN1120
.
PLIN1110  PACK      KEY6,OPSECLIN,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,PLIN1120
.
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY50
.
PLIN1120  WRITE     HTMLFILE;KEY50
          GOTO      PLIN9999
.
PLIN1200  MOVE      "&nbsp;",SURFNAME
          IF        OPCNCLSU=1
            MOVE      OPSECLIN,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              CLEAR     DISPNAME
              MOVE      DSNAME,NAME35
              CALL      NAMSTR00
              APPEND    COMMA,DISPNAME
              MOVE      DGNAME,ANS
              APPEND    ANS,DISPNAME
              RESET     DISPNAME
              PACK      SURFNAME,DISPNAME,SP70
            ENDIF
          ELSE
            MOVE      OPSECLIN,KEY6
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDESC,SURFNAME
            ENDIF
            MATCH     SP70,OPCLDOCT
            IF        !@EQUAL
              MOVE      OPCLDOCT,KEY6
              CALL      RDDOCT1
              IF        OVRCD=0
                CLEAR     DISPNAME
                MOVE      DSNAME,NAME35
                CALL      NAMSTR00
                APPEND    COMMA,DISPNAME
                MOVE      DGNAME,ANS
                APPEND    ANS,DISPNAME
                RESET     DISPNAME
                PACK      SURFNAME,DISPNAME,SP70
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"Surgeon : ",SURFNAME
          GOTO      PLIN9999
.
PLIN1300  MOVE      SP70,DOCFNAME
          MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"Anaesth : ",DOCFNAME
          GOTO      PLIN9999
.
PLIN1400  WRITE     HTMLFILE;"Start : ",OPSETIME
          GOTO      PLIN9999
.
PLIN1500  WRITE     HTMLFILE;"Finish : ",OPSEENDT
          GOTO      PLIN9999
.
PLIN1600  WRITE     HTMLFILE;"Avail Mins : ",OPSEDURA
          GOTO      PLIN9999
.
PLIN1700  WRITE     HTMLFILE;"Bkd Mins : ",OPSETIMB
          GOTO      PLIN9999
.
PLIN1800  CALL      SESCNT00  * Count Patients in Session 
          WRITE     HTMLFILE;"Cases : ",CASESCNT
          GOTO      PLIN9999
.
PLIN1900  MATCH     "0",VIEWTYPE            * Day view
          GOTO       PLIN9999 IF NOT EQUAL
.
          IF        OVERLAPF=0
            IF        DISPLCNA=1
              WRITE     HTMLFILE;"Unavailable: ",SESSKEYA
            ENDIF
          ENDIF
          IF        OVERLAPF=1
            IF        DISPLCNB=1
              WRITE     HTMLFILE;"Unavailable: ",SESSKEYB
            ENDIF
          ENDIF
          IF        OVERLAPF=2
            IF        DISPLCNC=1
              WRITE     HTMLFILE;"Unavailable: ",SESSKEYC
            ENDIF
          ENDIF
          GOTO      PLIN9999
.
PLIN9999  RETURN
.
.------------------------------------------------------------
. Get HOVERKEY session details for onmouseover session icon
.------------------------------------------------------------
HOVR0000  CLEAR     HOVERSES
.
          APPEND    OPSECLIN,HOVERSES
.         
          MATCH     SP70,OPSEFIND
          IF        !@EQUAL
            APPEND    "<input type=checkbox name=dummyfin",HOVERSES
            APPEND    " disabled checked title=Finalised><br>",HOVERSES
          ENDIF
.         
          MATCH     SP70,OPSESPI1
          GOTO      HOVR1090 IF NOT EQUAL
.         
          MATCH     SP70,OPSESPI2
          GOTO      HOVR1090 IF NOT EQUAL
.
          PACK      KEY25,OPSEHOSP,OPSEDATE,SP70
          CALL      RSOPCOM2
          CALL      RKOPCOM2
          BRANCH    OVRCD,HOVR1050
.
          MATCH     OPSEHOSP,OPCMHOSP
          GOTO      HOVR1050 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE
          GOTO      HOVR1050 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME
          GOTO      HOVR1050 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN
          GOTO      HOVR1050 IF NOT EQUAL
.
          GOTO      HOVR1090
.
HOVR1050  PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM1
          CALL      RKOPCOM1
          BRANCH    OVRCD,HOVR1100
.
          MATCH     OPSEDATE,OPCMDATE
          GOTO      HOVR1100 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME
          GOTO      HOVR1100 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN
          GOTO      HOVR1100 IF NOT EQUAL
.
HOVR1090  APPEND   "<img src=../images/CommentIconR.gif>",HOVERSES
.
HOVR1100  COMPARE   ZERO,OPCNCLSU
          GOTO      HOVR1110 IF NOT EQUAL   * Checking For The Clinic Status
.
          MOVE      SP70,KEY50
          PACK      KEY6,OPSECLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,HOVR1120
.
          MOVE      OPCLDESC,KEY50        * For Displaying Clinic Descrition
          GOTO      HOVR1120
.
HOVR1110  PACK      KEY6,OPSECLIN,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,HOVR1120
.
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY50
.
HOVR1120  APPEND    "<br>",HOVERSES
          REP       "'`@ * / : \ $ % & # ",KEY50
          APPEND    KEY50,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1200  MOVE      "&nbsp;",SURFNAME
          IF        OPCNCLSU=1
            MOVE      OPSECLIN,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              CLEAR     DISPNAME
              MOVE      DSNAME,NAME35
              CALL      NAMSTR00
              APPEND    COMMA,DISPNAME
              MOVE      DGNAME,ANS
              APPEND    ANS,DISPNAME
              RESET     DISPNAME
              PACK      SURFNAME,DISPNAME,SP70
            ENDIF
          ELSE
            MOVE      OPSECLIN,KEY6
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDESC,SURFNAME
            ENDIF
            MATCH     SP70,OPCLDOCT
            IF        !@EQUAL
              MOVE      OPCLDOCT,KEY6
              CALL      RDDOCT1
              IF        OVRCD=0
                CLEAR     DISPNAME
                MOVE      DSNAME,NAME35
                CALL      NAMSTR00
                APPEND    COMMA,DISPNAME
                MOVE      DGNAME,ANS
                APPEND    ANS,DISPNAME
                RESET     DISPNAME
                PACK      SURFNAME,DISPNAME,SP70
              ENDIF
            ENDIF
          ENDIF
.
          APPEND    "Surgeon : ",HOVERSES
          REP       "'`@ * / : \ $ % & # ",SURFNAME
          APPEND    SURFNAME,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1300  MOVE      SP70,DOCFNAME
          MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          APPEND    "Anaesth : ",HOVERSES
          REP       "'`@ * / : \ $ % & # ",DOCFNAME
          APPEND    DOCFNAME,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1400  APPEND    "Start : ",HOVERSES
          APPEND    OPSETIME,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1500  APPEND    "Finish : ",HOVERSES
          APPEND    OPSEENDT,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1600  APPEND    "Avail Mins : ",HOVERSES
          APPEND    OPSEDURA,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1700  APPEND    "Bkd Mins : ",HOVERSES
          APPEND    OPSETIMB,HOVERSES
          APPEND    "<br>",HOVERSES
.
HOVR1800  CALL      SESCNT00  * Count Patients in Session
          APPEND    "Cases : ",HOVERSES
          APPEND    CASESCNT,HOVERSES
.
          RESET    HOVERSES
.
HOVR9999  RETURN
.------------------------------------------------------------
. Fill time array DISPTDAY with session type class. 
. DISPTDAY  DIM  100[28][3] * Display theatre array, 1=Normal,2 & 3 = overlaps
. If the session has an overlap pupulate either the first or second overlap
. dimension of the array with the session details
. FILLCLAS - 1 class=Heading Cell
.            2 class=Normal session
.            3 class=Extra session
.            4 class=Unavailable
.            5 class=OverlapSess
.
. STRTTIME - Time start for booking
. ENDTIME  - Time end for booking
.------------------------------------------------------------
TFIL0000  CALL      TOVR0000                * Check for overlaps
.
          MOVE      TWENTY9,LCOUNT
          MOVE      FILLCLAS,SAVFCLAS
.             
TFIL2500  SUB       ONE,LCOUNT
.           
          COMPARE   ONE,LCOUNT
          GOTO      TFIL9999 IF EQUAL
.
          MOVE      SAVFCLAS,FILLCLAS
.
          MATCH     "1",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      FIVE,FILLCLAS
          ENDIF
.
          MATCH     "2",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      FIVE,FILLCLAS
          ENDIF
.
          MATCH     "3",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      FIVE,FILLCLAS
          ENDIF
.
          IF        DISPLAYO>1
            MATCH     "5",DISPTDAY[LCOUNT][ONE]    
            IF        @EQUAL
              MOVE      FIVE,FILLCLAS
            ENDIF
            MATCH     "5",DISPTDAY[LCOUNT][TWO]    
            IF        @EQUAL
              MOVE      FIVE,FILLCLAS
            ENDIF
          ENDIF
.
          IF        LCOUNT=28
            MATCH     TTIMARRY[LCOUNT],STRTTIME        * booking  => 18:00
            IF        !@LESS
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
              GOTO      TFIL9999
            ENDIF
            MATCH     TTIMARRY[LCOUNT],ENDTIME        * booking end => 19:00
            IF        !@LESS
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
            ENDIF
          ENDIF
.
          IF        LCOUNT=2
            MATCH     TTIMARRY[LCOUNT],STRTTIME        * booking  <= 7:00
            IF        @LESS
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
              GOTO      TFIL9999
            ENDIF
            MATCH     TTIMARRY[LCOUNT],ENDTIME        * booking end <= 7:00
            IF        @LESS
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
            ENDIF
          ENDIF
.
          MATCH     STRTTIME,TTIMARRY[LCOUNT]         * booking = array time
          IF        @EQUAL
            PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
            GOTO      TFIL9999
          ENDIF
.
          MATCH     STRTTIME,TTIMARRY[LCOUNT]        * array < booking time
          IF        @LESS
            PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
            GOTO      TFIL9999
          ENDIF
.
          MATCH     ENDTIME,TTIMARRY[LCOUNT]         * booking end = array time
          IF        @EQUAL
            PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
          ENDIF
.
          MATCH     ENDTIME,TTIMARRY[LCOUNT]        * array < booking end
          IF        @LESS
            PACK      DISPTDAY[LCOUNT][DISPLAYO],FILLCLAS,FILLDETL,SP70
          ENDIF
.
          GOTO      TFIL2500
.
TFIL9999  RETURN
.
.*******************************************************************************
. Check for overlaps and return the array dimension to populate - DISPLAYO
.*******************************************************************************
TOVR0000  MOVE      ONE,DISPLAYO
.
TOVR1000  MOVE      ZERO,OVERLAPS
          MOVE      TWENTY9,LCOUNT
.
TOVR2500  SUB       ONE,LCOUNT
.
          COMPARE   ONE,LCOUNT
          GOTO      TOVR9000 IF EQUAL
.
          MOVE      ZERO,OVERFLAG
          MATCH     "1",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      ONE,OVERFLAG
          ENDIF
.
          MATCH     "2",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      ONE,OVERFLAG
          ENDIF
.
          MATCH     "3",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      ONE,OVERFLAG
          ENDIF
.
          MATCH     "5",DISPTDAY[LCOUNT][DISPLAYO]
          IF        @EQUAL
            MOVE      ONE,OVERFLAG
          ENDIF
.
TOVR3000  IF        LCOUNT=28
            MATCH     TTIMARRY[LCOUNT],STRTTIME        * booking  => 18:00
            IF        !@LESS
              IF        OVERFLAG=1
                UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
                PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
                MOVE      ONE,OVERLAPS
              ENDIF
              GOTO      TOVR9000
            ENDIF
            MATCH     TTIMARRY[LCOUNT],ENDTIME        * booking end => 19:00
            IF        !@LESS
              IF        OVERFLAG=1
                UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
                PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
                MOVE      ONE,OVERLAPS
              ENDIF
            ENDIF
          ENDIF
.
          IF        LCOUNT=2
            MATCH     TTIMARRY[LCOUNT],STRTTIME        * booking  <= 7:00
            IF        @LESS
              IF        OVERFLAG=1
                UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
                PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
                MOVE      ONE,OVERLAPS
              ENDIF
              GOTO      TOVR9000
            ENDIF
            MATCH     TTIMARRY[LCOUNT],ENDTIME        * booking end <= 7:00
            IF        @LESS
              IF        OVERFLAG=1
                UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
                PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
                MOVE      ONE,OVERLAPS
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     STRTTIME,TTIMARRY[LCOUNT]         * booking = array time
          IF        @EQUAL
            IF        OVERFLAG=1
              UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
              MOVE      ONE,OVERLAPS
            ENDIF
            GOTO      TOVR9000
          ENDIF
.
          MATCH     STRTTIME,TTIMARRY[LCOUNT]        * array < booking time
          IF        @LESS
            IF        OVERFLAG=1
              UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
              MOVE      ONE,OVERLAPS
            ENDIF
            GOTO      TOVR9000
          ENDIF
.
          MATCH     ENDTIME,TTIMARRY[LCOUNT]         * booking end = array time
          IF        @EQUAL
            IF        OVERFLAG=1
              UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
              MOVE      ONE,OVERLAPS
            ENDIF
          ENDIF
.
          MATCH     ENDTIME,TTIMARRY[LCOUNT]        * array < booking end
          IF        @LESS
            IF        OVERFLAG=1
              UNPACK    DISPTDAY[LCOUNT][DISPLAYO],D1,DIM100
              PACK      DISPTDAY[LCOUNT][DISPLAYO],FIVE,DIM100,SP70
              MOVE      ONE,OVERLAPS
            ENDIF
          ENDIF
.
          GOTO      TOVR2500
.
TOVR9000  IF        OVERLAPS=1
             ADD       ONE,DISPLAYO
             COMPARE   THREE,DISPLAYO
             GOTO      TOVR1000 IF LESS
          ENDIF
.
TOVR9999  RETURN
.
.*******************************************************************************
. Display appointment times col for theatre diary
.*******************************************************************************
TTIM0000  WRITE     HTMLFILE;"<td width=5%>":
                    "<table cellspacing=0 cellpadding=1 border=1 ":
                    "width=100% align=center>":
.
                    "<tr height=26><td align=center nowrap>":
                    "Date</td></tr>":
.
                    "</table>":
                    "<table cellspacing=0 cellpadding=1 border=1 ":
                    "width=100% align=center >":
.
                    "<tr height=26><td class=HeadingCell width=5% align=center":
                    " nowrap>":
                    "Theatre</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    "<&nbsp",TTIMARRY[2],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[3],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[4],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[5],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[6],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[7],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[8],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[9],"</td></tr>":


                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[10],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[11],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[12],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[13],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[14],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[15],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[16],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[17],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[18],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[19],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[20],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[21],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[22],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[23],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[24],"</td></tr>":
                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[25],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[26],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    TTIMARRY[27],"</td></tr>":

                    "<tr height=26><td align=center class=HeadingCell nowrap>":
                    ">&nbsp;",TTIMARRY[28],"</td></tr>":
                    "</tr></table></td>"
.
TTIM9999  RETURN
.
.*******************************************************************************
. Display filer if the date has no open sessions     
.*******************************************************************************
BFIL0000  WRITE     HTMLFILE;"<td width=8%>":
                    "<table cellspacing=0 cellpadding=1 border=1 ":
                    "width=100% align=center ><tr height=26>":
                    "<tr height=26><td class=HeadingCell align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "<tr height=26><td align=center nowrap>":
                    "&nbsp;</td></tr>":
                    "</tr></table></td>"
.
BFIL9999  RETURN
.
.*******************************************************************************
. Clear display array for theatre diary
.*******************************************************************************
CTAR0000 MOVE      ONE,COUNT
          WHILE     COUNT <= 28
            PACK      DISPTDAY[COUNT][ONE],SP70,SP70
            PACK      DISPTDAY[COUNT][TWO],SP70,SP70
            PACK      DISPTDAY[COUNT][THREE],SP70,SP70
            ADD       ONE,COUNT
          DO
.
CTAR9999  RETURN
.
.------------------------------------------------------------
. Set time array fields for theatre diary time classes
.------------------------------------------------------------
STTT0000  MOVE      "",TTIMARRY[1]
          MOVE      "07:00",TTIMARRY[2]
          MOVE      "07:00",TTIMARRY[3]
          MOVE      "07:30",TTIMARRY[4]
          MOVE      "08:00",TTIMARRY[5]
          MOVE      "08:30",TTIMARRY[6]
          MOVE      "09:00",TTIMARRY[7]
          MOVE      "09:30",TTIMARRY[8]
          MOVE      "10:00",TTIMARRY[9]
          MOVE      "10:30",TTIMARRY[10]
          MOVE      "11:00",TTIMARRY[11]
          MOVE      "11:30",TTIMARRY[12]
          MOVE      "12:00",TTIMARRY[13]
          MOVE      "12:30",TTIMARRY[14]
          MOVE      "13:00",TTIMARRY[15]
          MOVE      "13:30",TTIMARRY[16]
          MOVE      "14:00",TTIMARRY[17]
          MOVE      "14:30",TTIMARRY[18]
          MOVE      "15:00",TTIMARRY[19]
          MOVE      "15:30",TTIMARRY[20]
          MOVE      "16:00",TTIMARRY[21]
          MOVE      "16:30",TTIMARRY[22]
          MOVE      "17:00",TTIMARRY[23]
          MOVE      "17:30",TTIMARRY[24]
          MOVE      "18:00",TTIMARRY[25]
          MOVE      "18:30",TTIMARRY[26]
          MOVE      "19:00",TTIMARRY[27]
          MOVE      "19:00",TTIMARRY[28]
.
STTT9999  RETURN
.
.------------------------------------------------------------
. Count number of cases in a session
.------------------------------------------------------------
SESCNT00  MOVE      ZERO,CASESCNT              * HPS Code Starts Here
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,ZERO,SP70
          CALL      RSOPDEA1                * Calculate No of Patients
SESCNT10  CALL      RKOPDEA1
          BRANCH    OVRCD,SESCNT99
.
          MATCH     OPDAHOSP,OPSEHOSP
          GOTO      SESCNT99 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE
          GOTO      SESCNT99 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSETIME
          GOTO      SESCNT99 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSECLIN
          GOTO      SESCNT99 IF NOT EQUAL
.
          COMPARE   "3",OPDASTAT
          GOTO      SESCNT10 IF EQUAL
          ADD       ONE,CASESCNT
          GOTO      SESCNT10                  * HPS Code Ends Here
SESCNT99  RETURN
.
.------------------------------------------------------------
. Check if there is adjustment time for a session
.------------------------------------------------------------
ADJUST00  MOVE      ZERO,ADJUSFLG
          IF        OVERLAPF=0
            MATCH     SP70,SESSKEYA
            GOTO      ADJUST99 IF EQUAL
            COMPARE   FOUR,FDISCLSA           * Unavailable
            GOTO      ADJUST99 IF EQUAL
.
            PACK      KEY19,SESSKEYA,SP70
          ENDIF
.
          IF        OVERLAPF=1
            MATCH     SP70,SESSKEYB
            GOTO      ADJUST99 IF EQUAL
            COMPARE   FOUR,FDISCLSB           * Unavailable
            GOTO      ADJUST99 IF EQUAL
.
            PACK      KEY19,SESSKEYB,SP70
          ENDIF
.
          IF        OVERLAPF=2
            MATCH     SP70,SESSKEYC
            GOTO      ADJUST99 IF EQUAL
            COMPARE   FOUR,FDISCLSC           * Unavailable
            GOTO      ADJUST99 IF EQUAL
.
            PACK      KEY19,SESSKEYC,SP70
          ENDIF
.
          PACK      KEY22,WBSEHOSP,KEY19,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,ADJUST99
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,ZERO,SP70
          CALL      RSOPDEA1                * Calculate No of Patients
ADJUST10  CALL      RKOPDEA1
          BRANCH    OVRCD,ADJUST99
.
          MATCH     OPDAHOSP,OPSEHOSP
          GOTO      ADJUST99 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE
          GOTO      ADJUST99 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSETIME
          GOTO      ADJUST99 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSECLIN
          GOTO      ADJUST99 IF NOT EQUAL
.
          COMPARE   "3",OPDASTAT
          GOTO      ADJUST10 IF EQUAL
.
          MATCH     "  1",OPDACASE
          GOTO      ADJUST10 IF NOT EQUAL     * Not a first case
.
          MATCH     OPDATIME,OPDAEXPS
          IF        !@EQUAL
            MOVE      ONE,ADJUSFLG          * Adjustment flag
          ENDIF
ADJUST99  RETURN
+
.-----------------------------------------------------------
. Link to Next Group of Addresses
.-----------------------------------------------------------
NEXTTH00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMTAFACL
          REP       " +",FILTTLOC
.
          WRITE     HTMLFILE;"patweb10.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&viewtype=",VIEWTYPE:
                                 "&lastdate=",LASTDATE:
                                 "&filttloc=",FILTTLOC:
                                 "&dispwkno=",DISPWKNO;
.
NEXTTH99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of Address
.-------------------------------------------------------------
PREVTH00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMTAFACL
          REP       " +",FILTTLOC
.
          WRITE     HTMLFILE;"patweb10.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&viewtype=",VIEWTYPE:
                                 "&lastdate=",LASTDATE:
                                 "&filttloc=",FILTTLOC:
                                 "&dispwkno=",DISPWKNO;
.
PREVTH99  RETURN
.
.------------------------------------------------------------
. Patient Bed Request Display
.------------------------------------------------------------
PBED0000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      PBED7000 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Add
          GOTO      PBED1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      PBED2000 IF EQUAL
.
          MATCH     "C",UPDTTYPE       * Update - Cancel Request
          GOTO      PBED2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      PBED3000 IF EQUAL
.
          GOTO      PBED9000
.
PBED1000  PACK      KEY24,PMBRQ001,PMBRQ002,PMBRQ003,SP70
          CALL      RDPMBRQ1                     * Read bed request
          COMPARE   ZERO,OVRCD
          GOTO      PBED9300 IF EQUAL
.
          CALL      CVIS0000                * Check visit status
          BRANCH    EXIT,PBED9700
.
          PACK      KEY25,PMBRQ001,SP70
          CALL      RSPMBRQ2
          CALL      RKPMBRQ2
          BRANCH    OVRCD,PBED1100
.
          MATCH     PMBRQ001,PMBRVISN
          GOTO      PBED1100 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      PMBRRSTA,F1
          BRANCH    F1,PBED9500,PBED9500,PBED1100,PBED1100
.
PBED1100  CALL      CPMBRQ00                     * Clear all the file variables
          CALL      MVPMBR00                     * Move cgi to file vars
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMBRCDAT                * Created date
          CLOCK     TIME,PMBRCTIM                * Created time
          MOVE      USERID,PMBRCUID              * Created by
.
          PACK      KEY24,PMBRVISN,PMBRREQD,PMBRREQT,SP70
          CALL      WRPMBRQ1
.
          IF        COMTFLAG=1
            CALL      RQCOM000                   * Write Comments
          ENDIF
.
          CALL      SETHCP00
          CALL      EXBR0000                     * Added to expected patients
.
.         Send an A08 message after adding a Bed Request if "Send ZBR segment"
.         parameter is turned on
.
          MATCH     "1",PTCNSZBR                 * sending ZBR ?
          GOTO      PBED1900 IF NOT EQUAL        * no
.
          CALL      GHTD0000                     * get HL7 holding table data
          BRANCH    EXIT,PBED1900                * error - don't send message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PROC      DGCLICEC                   * trigger A08 EMR message
          ELSE
            PROC      DGCLICAC                   * trigger A08 INP message
          ENDIF
.
PBED1900  MOVE      ZERO,EXIT
          GOTO      PBED9999

PBED2000  PACK      KEY24,PMBRQ001,PMBRQ002,PMBRQ003,SP70
          CALL      RDPMBRQ1                     * Read bed request
          BRANCH    OVRCD,PBED9100   
.
          MOVE      PMBRRSTA,SAVERSTA            * save current status
.
          MATCH     "3",PMBRRSTA                 * Completed
          GOTO      PBED9800 IF EQUAL
.
          MATCH     "4",PMBRRSTA                 * Cancelled
          GOTO      PBED9800 IF EQUAL
.
          MATCH     Z70,PMBRQ009                 * Check expected ward cgi
          GOTO      PBED2500 IF EQUAL
.
          MATCH     PMBRQ009,PMBREWRD            * No change in ward
          GOTO      PBED2500 IF EQUAL
.
          MATCH     SP70,PMBRQ009
          IF        @EQUAL
            MOVE      ONE,PMBRRSTA               * Status to requested if 
            MOVE      SP70,PMBRADAT              * no expected ward
            MOVE      SP70,PMBRATIM
            MOVE      SP70,PMBRAUID
            CALL      EXCL0000                   * Clear expected patient
            CALL      EXBR0000                   * Added to expected patients
            GOTO      PBED2500
          ELSE
            MOVE      TWO,PMBRRSTA               * Status to allocated if
            PACK      KEY8,CCC,CYY,CMM,CDD       * allocating a ward
            REP       " 0",KEY8
            MOVE      KEY8,PMBRADAT              * Allocated date
            CLOCK     TIME,PMBRATIM              * Allocated time
            MOVE      USERID,PMBRAUID            * Allocated by
            CALL      EXCL0000                   * Clear expected patient
            CALL      EXAL0000              * Allocate ward to expected patients
          ENDIF
.
PBED2500  MATCH     ANSC,UPDTTYPE                * Cancel request
          IF        @EQUAL
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            MOVE      KEY8,PMBRCAND              * Cancel date
            CLOCK     TIME,PMBRCANT              * Cancel time
            MOVE      USERID,PMBRCANU            * Cancel by
.
            CALL      EXCL0000                   * Clear expected patient
.
          ENDIF
.
          CALL      MVPMBR00                     * Move cgi to file vars
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMBRUDAT                * Updated date
          CLOCK     TIME,PMBRUTIM                * Updated time
          MOVE      USERID,PMBRUUID              * Updated by
.
          CALL      UPPMBRQ1
.
          IF        COMTFLAG=1
            CALL      RQCOM000                   * Write Comments
          ENDIF
.
          CALL      SETHCP00
.
          MATCH     ANSC,UPDTTYPE                * Cancel request
          IF        @EQUAL
            CALL      DELHCP00
          ENDIF
.
          MATCH     ANSU,UPDTTYPE                * Update request
          IF        @EQUAL
            MATCH     SP70,PMBREWRD
            IF        @EQUAL
              CALL      EXCL0000                 * Clear expected patient
              CALL      EXBR0000                 * Added to expected patients
            ELSE
              CALL      EXCL0000                 * Clear expected patient
              CALL      EXAL0000            * Allocate ward to expected patients
            ENDIF
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD<>1
            MATCH     " 3",PTVITYPE               * Inp
            IF        @EQUAL
              PROC      BBUP0000                  * Bed Board
            ENDIF
          ENDIF     
.
.         Send an A08 message after cancelling or updating a Bed Request if
.         "Send ZBR segment" parameter is turned on
.
PBED2600  MATCH     "1",PTCNSZBR                 * sending ZBR ?
          GOTO      PBED2900 IF NOT EQUAL        * no
.
          MATCH     ANSU,UPDTTYPE                * Update request ?
          IF        @EQUAL
.0856646    MATCH     SAVERSTA,PMBRRSTA          * yes - same status still ?
.0856646    GOTO      PBED2900 IF EQUAL          * yes - don't trigger message
          ENDIF
.
          CALL      GHTD0000                     * get HL7 holding table data
          BRANCH    EXIT,PBED2900                * error - don't send message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PROC      DGCLICEC                   * trigger A08 EMR message
          ELSE
            PROC      DGCLICAC                   * trigger A08 INP message
          ENDIF
.
PBED2900  MOVE      ZERO,EXIT
          GOTO      PBED9999
.
PBED3000  PACK      KEY24,PMBRQ001,PMBRQ002,PMBRQ003,SP70
          CALL      RDPMBRQ1                     * Read bed request
          BRANCH    OVRCD,PBED9100
.
.         Send an A08 message after deleting a Bed Request if "Send ZBR segment"
.         parameter is turned on
.
          MATCH     "1",PTCNSZBR                 * sending ZBR ?
          GOTO      PBED3800 IF NOT EQUAL        * no
.
          CALL      GHTD0000                     * get HL7 holding table data
          BRANCH    EXIT,PBED3800                * error - don't send message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PROC      DGCLICEC                   * trigger A08 EMR message
          ELSE
            PROC      DGCLICAC                   * trigger A08 INP message
          ENDIF
.
PBED3800  CALL      DEPMBRQ1                     * Delete bed request
          CALL      RQDCM000                     * Delete request comments
          CALL      DELHCP00                     * Delete user defined HCP
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD<>1
            MATCH     " 3",PTVITYPE              * Inp
            IF        @EQUAL
              PROC      BBUP0000                 * Bed Board
            ENDIF
          ENDIF
.
PBED3900  MOVE      ZERO,EXIT
          GOTO      PBED9999
.
PBED7000  CALL      CLEMRVIS
          CALL      CLPATMIS
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,PBED9400
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            BRANCH    OVRCD,PBED9400
.
            GOTO      PBED7100
          ENDIF
.
          MATCH     " 3",PTVITYPE                * INP
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPTMIS1
            BRANCH    OVRCD,PBED9400
.
            GOTO      PBED7100
          ENDIF
.
          GOTO      PBED9600
.
PBED7100  PACK      KEY8,URNUMBER,SP70           * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PBED9200
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PBED9200
.
          PACK      KEY24,PMBRQ001,PMBRQ002,PMBRQ003,SP70
          CALL      RDPMBRQ1                      * Read bed request
          IF        OVRCD=1
            CALL     CPMBRQ00                     * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Ward/Bed Requests",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PBED9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9000  MOVE      "Invalid update type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9100  MOVE      "Invalid Ward/bed request record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9200  MOVE      "Can't find patient master details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9300  MOVE      "Ward/bed request exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9400  CLEAR     WEBTITLE
          APPEND    "Invalid visit details for ",WEBTITLE
          APPEND    "processing ward/bed requests",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9500  CLEAR     WEBTITLE
          APPEND    "Outstanding ward/bed requests ",WEBTITLE
          APPEND    "exists for this visit",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9600  MOVE      "Invalid visit type for ward/bed requests ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9700  MOVE      "Invalid visit status for ward/bed requests ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9800  MOVE      "Invalid ward/bed requests status for update",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PBED9999
.
PBED9999  CLOSE     COMFILAF,DELETE
          RETURN
+
.*****************************************************************************
.*                              GHTD0000           Called by: PBED0000       *
.*              Get holding table data ready for population                  *
.* Requires: PVIURNO - U/R number                                            *
.*           PVIBILL - Visit Number                                          *
.* Returns:  EXIT  0 = Ok to continue                                        *
.*                 1 = Error occurred                                        *
.*****************************************************************************
.
GHTD0000  MOVE      PVIURNO,KEY8
          CALL      RDMAST1                      * PMI details
          BRANCH    OVRCD,GHTD9100
.
          MOVE      PVIURNO,KEY8
          CALL      RDPMPX21                     * PMI ext2 details
          BRANCH    OVRCD,GHTD9100
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTRES1                     * PRA details
          IF        OVRCD = 1
            CALL      CLPATRE1
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1                      * discharge details
          IF        OVRCD = 1
            CALL      CLPATDSC
          ENDIF
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            MOVE      PVIBILL,KEY8
            CALL      RDEMVIS1                   * emr visit details
            BRANCH    OVRCD,GHTD9100
.
            MOVE      PVIBILL,KEY8
            CALL      RDPMVX11                   * pmsvx1 read for EMR
            BRANCH    OVRCD,GHTD9100
.
            CALL      CLPATTRN                   * no pattranf for EMR
          ELSE
            MOVE      PVIBILL,KEY8
            CALL      RDPTMIS1                   * patmi1/pmsvx1 read for INP
            BRANCH    OVRCD,GHTD9100
.
            PACK      KEY30,PVIBILL,TILDA30
            CALL      RDSTRAN2
            CALL      RDPTRAN2                   * transfer details
            BRANCH    OVRCD,GHTD9100
.
            MATCH     PVIBILL,TADMN              * same admission still ?
            GOTO      GHTD9100 IF NOT EQUAL      * no - finish
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GHTD9999
.
GHTD9100  MOVE      ONE,EXIT
.
GHTD9999  RETURN
+
.------------------------------------------------------------
. Check to see if the IP or ED visit is current before
. allowing bed request additions
.------------------------------------------------------------
CVIS0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,CVIS9000
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            BRANCH    OVRCD,CVIS9000
.
            COMPARE   ONE,EMVISTAT              * Current
            GOTO      CVIS9000 IF NOT EQUAL
          ENDIF
.
          MATCH     " 3",PTVITYPE                * INP
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPTMIS1
            BRANCH    OVRCD,CVIS9000
.
            COMPARE   THREE,ASTAT                * Discharged
            GOTO      CVIS9000 IF EQUAL
.
            COMPARE   FIVE,ASTAT                 * Cancelled
            GOTO      CVIS9000 IF EQUAL
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CVIS9999
.
CVIS9000  MOVE      ONE,EXIT
          GOTO      CVIS9999
.
CVIS9999  RETURN
.*******************************************************************************
.  Visit based bed request comments in vismdtaf using VSMDDATE and VSMDTIME
. to make notes unique to the bed request
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
RQCOM000  MOVE      "009",KEY3
          PACK      KEY17,PMBRVISN,KEY3,SP70
          CALL      RSVSMDT1
RQCOM100  CALL      RKVSMDT1
          BRANCH    OVRCD,RQCOM500
.
          MATCH     VSMDVISN,PMBRVISN       * same Admission Number?
          GOTO      RQCOM500 IF NOT EQUAL   
.         
          MATCH     VSMDTYPE,KEY3
          GOTO      RQCOM500 IF NOT EQUAL
.         
          MATCH     VSMDDATE,PMBRREQD
          GOTO      RQCOM100 IF NOT EQUAL
.         
          MATCH     VSMDTIME,PMBRREQT
          GOTO      RQCOM100 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
RQCOM400  CALL      RKVSMTX1
          BRANCH    OVRCD,RQCOM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      RQCOM100 IF NOT EQUAL
.         
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      RQCOM100 IF NOT EQUAL
.         
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      RQCOM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      RQCOM400
.
.         now write the new comments back
.
RQCOM500  MOVE      ZERO,F6
.
          PACK      KEY17,PMBRVISN,KEY3,Z70
          CALL      RSVSMDT1
          CALL      RPVSMDT1                * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,VSMDNOTE           * Note Number
          ELSE
            MATCH     PMBRVISN,VSMDVISN     * Same visit
            IF        @EQUAL
              MATCH     KEY3,VSMDTYPE       * Same note type
              IF        @EQUAL
                MOVE      VSMDNOTE,F6
                ADD       ONE,F6
                MOVE      F6,VSMDNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,VSMDNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,VSMDNOTE         * Note Number
            ENDIF
          ENDIF
          MOVE      PMBRVISN,VSMDVISN       * Visit number
          MOVE      KEY3,VSMDTYPE           * Notes Type
.
          MOVE      PMBRREQD,VSMDDATE       * Request date
          MOVE      PMBRREQT,VSMDTIME       * Request time
          MOVE      USERID,VSMDUSER         * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,RQCOM999
.
          MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          MOVE      "0",VSMDDELT            * Delete Indicator
          MOVE      SP70,VSMDDDAT           * Delete Date
          MOVE      SP70,VSMDDTIM           * Delete Time
          MOVE      SP70,VSMDDUSE           * Delete User
          MOVE      SP70,VSMDDOCC           * Delete User Occupation group

          PACK      VSMDSPAR,SP70,SP70      * Spare
.
.         now write the visit notes
.         
          MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      ZERO,F3
.
RQCOM510  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSMTCMNT
.
          MATCH     SP70,VSMTCMNT
          IF        @EQUAL
            IF        F3>=TRNWEND
              GOTO      RQCOM999
            ELSE
              GOTO      RQCOM510
            ENDIF
          ENDIF
.
          MOVE      F3,VSMTUNIQ
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      RAVSMTX1
          IF        OVRCD=1
            CALL      WRVSMTX1
          ENDIF
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      WRVSMDT1              * Write Record
          ENDIF
.
          IF        F3>=TRNWEND
            GOTO      RQCOM999
          ENDIF
          GOTO      RQCOM510
.
RQCOM999  MOVE      ONE,TRNFLAG
          RETURN
.
.*******************************************************************************
. Delete Visit based bed request comments
.*******************************************************************************
RQDCM000  MOVE      "009",KEY3
          PACK      KEY17,PMBRVISN,KEY3,SP70
          CALL      RSVSMDT1
RQDCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,RQDCM999
.         
          MATCH     VSMDVISN,PMBRVISN       * same Admission Number?
          GOTO      RQDCM999 IF NOT EQUAL
.         
          MATCH     VSMDTYPE,KEY3
          GOTO      RQDCM999 IF NOT EQUAL
.         
          MATCH     VSMDDATE,PMBRREQD
          GOTO      RQDCM100 IF NOT EQUAL
.         
          MATCH     VSMDTIME,PMBRREQT
          GOTO      RQDCM100 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
RQDCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,RQDCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      RQDCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      RQDCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      RQDCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      RQDCM400
.
RQDCM999  RETURN
.
.------------------------------------------------------------
. Hospital Level Bed Request Display
.------------------------------------------------------------
HBED0000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      HBED7000 IF EQUAL
.
          GOTO      HBED9000
.
HBED7000  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "Patient Ward/Bed Requests",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,HBED9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      HBED9999
.
HBED9000  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      HBED9999
.
HBED9999  RETURN
.
.------------------------------------------------------------
. Hospital level tags for bed requests
.------------------------------------------------------------
HTAG0000  BRANCH    FLDITMNO,HTAG0010,HTAG0020,HTAG0030,HTAG0040,HTAG0050:
                             HTAG0060,HTAG0070,HTAG0080,HTAG0090,HTAG0100:
                             HTAG0110
.                            
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      HTAG9999
.         
HTAG0010  MOVE      ZERO,WAHLFLAG           * WAHEALTH FLAG
          CALL      HTAB0000                * List bed requests hospital level
          GOTO      HTAG9999
.
HTAG0020  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      HTAG9999
.
HTAG0030  CALL      NEXT0000 
          GOTO      HTAG9999
.
HTAG0040  CALL      PREV0000
          GOTO      HTAG9999
.
HTAG0050  CALL      SELV0000
          GOTO      HTAG9999
.
HTAG0060  MOVE      "AC",CATEGORY
          MOVE      FILTUNIT,CODE
          CALL      CODITM00
          GOTO      HTAG9999
.
HTAG0070  WRITE     HTMLFILE;FILTSTAT;
          GOTO      HTAG9999
.
HTAG0080  MATCH     SP70,SHOWFLAG
          IF        @EQUAL
            MATCH     SP70,FILTWARD
            IF        @EQUAL
              MOVE      WBSEWRD,FILTWARD
            ENDIF
          ENDIF
          MOVE      FILTWARD,DFLTWARD
          CALL      WSEL0000
          GOTO      HTAG9999
.
HTAG0090  MATCH     SP70,SHOWHOSP
          IF        @EQUAL
            MATCH     SP70,FILTHOSP
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
          CALL      FLHS0000
          GOTO      HTAG9999
.         
HTAG0100  MOVE      ONE,WAHLFLAG            * WAHEALTH FLAG
          CALL      HTAB0000                * List bed requests hospital level
          GOTO      HTAG9999
.
HTAG0110  WRITE     HTMLFILE;SJOGFLAG;
          GOTO      HTAG9999
.
HTAG9999  RETURN
.
.------------------------------------------------------------
. Table of visit bed requests at hospital level
.------------------------------------------------------------
HTAB0000  PACK      KEY24,FRSTDATE,SP70
          CALL      RSPMBRQ3
HTAB1000  CALL      RKPMBRQ3
          BRANCH    OVRCD,HTAB9999
.
          MATCH     PMBRREQD,LASTDATE
          GOTO      HTAB9999 IF LESS          
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMBRHOSP
              GOTO      HTAB1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTWARD
          IF        !@EQUAL
            MATCH     FILTWARD,PMBRRWRD
            GOTO      HTAB1100 IF EQUAL
.
            MATCH     FILTWARD,PMBREWRD
            GOTO      HTAB1100 IF EQUAL
.
            GOTO      HTAB1000
          ENDIF
.
HTAB1100  MATCH     SP70,FILTUNIT
          IF        !@EQUAL
            MATCH     FILTUNIT,PMBRUNIT
            GOTO      HTAB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,PMBRRSTA
            GOTO      HTAB1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,HTAB1000
.
          PACK      KEY8,PVIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,HTAB1000
.
          PACK      KEY8,PVIURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,HTAB1000
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FLDRTYPE
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,PMBRUNIT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,PMBRUNIT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRUNIT,TDESC
            ENDIF
            MOVE    TDESC,UNITDESC
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMBRRHCP
          IF        !@EQUAL
            PACK      KEY10,PMBRRHCP,SP70
            CALL      RDPMHCP1
            IF        OVRCD=1
              MOVE      PMBRRHCP,DOCFNAME
            ELSE
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          MOVE      SP70,TYPEDESC
          MATCH     SP70,PMBRTYPE
          IF        !@EQUAL
            PACK      KEY5,ANSR,ANST,PMBRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRTYPE,TDESC
            ENDIF
            MOVE    TDESC,TYPEDESC
          ENDIF
.
          MOVE      SP70,INPSPCDS
          MATCH     SP70,PMBRSBED
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,PMBRSBED,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMBRSBED,TDESC
            ENDIF
            MOVE    TDESC,INPSPCDS
          ENDIF
.
          CALL      PRWRDS00
          CALL      SPCFEA00
.
          MOVE      "Requested",REQSTATS
          MOVE      ONE,CANCFLAG
.
          MATCH     "4",PMBRRSTA
          IF        @EQUAL
            MOVE      "Cancelled",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF
.
          MATCH     "3",PMBRRSTA
          IF        @EQUAL
            MOVE      "Completed",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF
.
          MATCH     "2",PMBRRSTA
          IF        @EQUAL
            MOVE      "Allocated",REQSTATS
            MOVE      ZERO,CANCFLAG
          ENDIF
.
          CALL      DIAGDS00  
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,PMBRAUID
          IF        !@EQUAL
            PACK      KEY10,PMBRAUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PMBRAUID,WBSENAM
            ENDIF
          ENDIF
.
          MOVE      ZERO,NOTEFLAG
          MOVE      "009",KEY3
          PACK      KEY17,PMBRVISN,KEY3,SP70
          CALL      RSVSMDT1
HTAB1500  CALL      RKVSMDT1
          BRANCH    OVRCD,HTAB2000          * end of file
.
          MATCH     VSMDVISN,PMBRVISN       * same Admission Number?
          GOTO      HTAB2000 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      HTAB2000 IF NOT EQUAL
.
          MATCH     VSMDDATE,PMBRREQD
          GOTO      HTAB1500 IF NOT EQUAL
.
          MATCH     VSMDTIME,PMBRREQT
          GOTO      HTAB1500 IF NOT EQUAL
.
          MOVE      ONE,NOTEFLAG
.
HTAB2000  MOVE      SP70,DIM11
          MATCH     SP70,PMBRREQD
          IF        !@EQUAL
            UNPACK    PMBRREQD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          MOVE      SP70,WBDESC
          MOVE      SP70,KEY41
          MATCH     SP70,PMBREWRD
          IF        !@EQUAL
            PACK      KEY6,PMBREWRD,SP70              * Ward description
            CALL      RDWARD1
            IF        OVRCD=0
              MOVE      WBDESC,KEY20                  * save ward description
              PACK      KEY41,WBDESC,SP70
              MATCH     SP70,PMBREBED
              IF        !@EQUAL
                PACK      KEY41,WBDESC,SLASH,PMBREBED,SP70
                PACK      KEY6,PMBREWRD,PMBREBED,SP70 * Bed description
                CALL      RDWARD1
                IF        OVRCD=1
                  PACK      WBDESC,KEY20,SLASH,PMBREBED,SP70
                ELSE
                  PACK      KEY41,KEY20,SLASH,WBDESC,SP70
                ENDIF
              ENDIF
            ELSE
              PACK      KEY41,PMBREWRD,SP70
            ENDIF
          ENDIF
.
          MOVE      KEY41,DIM100
          MATCH     "2",PMBRRSTA            * Allocated?
          IF        @EQUAL
             ENDSET    DIM100
.
             MATCH     SP70,PMBRRDAT
             IF        !@EQUAL
               APPEND    "<br>",DIM100
               APPEND    "<br>",DIM100
               UNPACK    PMBRRDAT,CCENT,CYEAR,CMON,CDAY
               MOVE      CMON,F2
               LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
               PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
               APPEND    DISPDATE,DIM100
               
               MATCH     SP70,PMBRRTIM
               IF        !@EQUAL
                 APPEND    "&nbsp;at&nbsp;",DIM100
                 APPEND    PMBRRTIM,DIM100
               ENDIF
             ENDIF
.
             RESET     DIM100
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateRequest('",HTMLLINK
          APPEND    PMBRVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DIM11,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMBRREQT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIURNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ViewNotes('",HTMLLNK2
          APPEND    PMBRVISN,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    DIM11,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    PMBRREQT,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    PVIURNO,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          IF        CANCFLAG=0
            MOVE      SP70,HTMLLNK3
          ELSE
            CLEAR     HTMLLNK3
            APPEND    "javascript:CancelRequest('",HTMLLNK3
            APPEND    PMBRVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    DIM11,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PMBRREQT,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PVIURNO,HTMLLNK3
            APPEND    "')",HTMLLNK3
            RESET     HTMLLNK3
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",PMBRREQD,PMBRREQT,"#",":           * 1
                             "#"",PMBRUNIT,"#",":                    * 2
                             "#"",UNITDESC,"#",":                    * 3
                             "#"",DOCFNAME,"#",":                    * 4
                             "#"",PMBRTYPE,"#",":                    * 5
                             "#"",TYPEDESC,"#",":                    * 6
                             "#"",REQSTATS,"#",":                    * 7
                             "#"",PMBRDIAG,"#",":                    * 8
                             "#"",DIAGDESC,"#",":                    * 9
                             "#"",PMBRCANR,"#",":                    * 10
                             "#"",DIM100,"#",":                      * 11
                             "#"",PMBRADAT,PMBRATIM,"#",":           * 12
                             "#"",CANCFLAG,"#",":                    * 13
                             "#"",WBSENAM,"#",":                     * 14
                             "#"",NOTEFLAG,"#",":                    * 15
                             "#"",HTMLLNK2,"#",":                    * 16
                             "#"",HTMLLNK3,"#",":                    * 17
                             "#"",PVIURNO,"#",":                     * 18
                             "#"",PMBRVISN,"#",":                    * 19
                             "#"",FLDRTYPE,"#",":                    * 20
                             "#"",FORMATNM,"#",";                    * 21
.
          MATCH     SP70,PMBREWRD
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",PMBREWRD,"/",PMBREBED,"#",";    * 22
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                      * 22
          ENDIF
.
          MOVE      SP70,PMTMDESC
          MATCH     SP70,PMBRTEAM
          IF        !@EQUAL
            PACK      KEY5,PMBRTEAM
            CALL      RDPMTEM1
          ENDIF
          WRITE     HTMLFILE;"#"",DOCFNAME,"/",UNITDESC,"/",PMTMDESC:
                             "#",";                                 * 23
          WRITE     HTMLFILE;"#"",INPSPCDS,"#",":                   * 24
                             "#"",PRFWRDDS,"#",":                   * 25
                             "#"",SPCFEADS,"#");"                   * 26
.
          GOTO      HTAB1000
.
HTAB9999  RETURN
.
.--------------------------------------------------------------------------
. Setup preferred ward description
. Return: PRFWRDDS 
.--------------------------------------------------------------------------
PRWRDS00  MOVE      SP70,PRFWRDDS
          MATCH     SP70,PMBRPWRD
          IF        !@EQUAL
            PACK      KEY6,PMBRPWRD,SP70
            CALL      RDWARD1
            IF        OVRCD = 1
              MOVE      PMBRPWRD,WBDESC
            ENDIF
            MOVE      WBDESC,PRFWRDDS
          ENDIF
.
PRWRDS99  RETURN
.
.--------------------------------------------------------------------------
. Setup special feature codes
. Return: SPCFEADS
.--------------------------------------------------------------------------
SPCFEA00  PACK      SPCFEADS,SP70,SP70
          CLEAR     SPCFEADS
.
          MATCH     "1",PMBRSFFR
          IF        @EQUAL
            APPEND    "F",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFEP
          IF        @EQUAL
            APPEND    "P",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFCI
          IF        @EQUAL
            APPEND    "CI",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFCO
          IF        @EQUAL
            APPEND    "Com",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFIS
          IF        @EQUAL
            APPEND    "I",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFTE
          IF        @EQUAL
            APPEND    "T",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFRC
          IF        @EQUAL
            APPEND    "RC",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFOT
          IF        @EQUAL
            APPEND    "O",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFNR
          IF        @EQUAL
            APPEND    "None",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          MATCH     "1",PMBRSFMA
          IF        @EQUAL
            APPEND    "MA",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
            APPEND    "&nbsp",SPCFEADS
          ENDIF
.
          RESET     SPCFEADS 
.
SPCFEA99  RETURN
.
.------------------------------------------------------------------------------
. Remote scripting for patient bed requests
.------------------------------------------------------------------------------
REMBED00  CALL      XMLHED00
          BRANCH    EXIT,REMBED99
.
          BRANCH    REMOTENO,REMBED10
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMBED90
.
REMBED10  CALL      GETB0000
          GOTO      REMBED90
.
REMBED90  CALL      XMLEND00
.
REMBED99  RETURN
.
.------------------------------------------------------------------------------
. Check for an outstanding bed request for this admission. Update the status
. to completed and prompt with a warning if a ward/bed mismatch
.------------------------------------------------------------------------------
GETB0000  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPMBRQ2
GETB1000  CALL      RKPMBRQ2
          BRANCH    OVRCD,GETB9000
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      GETB9000 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA
          GOTO      GETB2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      GETB2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      GETB2000 IF EQUAL
.
          GOTO      GETB1000
.
GETB2000  
.         PACK      KEY8,ADMISSNO,SP70
.         CALL      RDPTMIS1
.         BRANCH    OVRCD,GETB3000
.
          MATCH     SP70,VALIDWRD
          IF        !@EQUAL
            PACK      KEY6,VALIDWRD,SP70
            CALL      RDWARD1
            IF        OVRCD=0
.
              IF        WINPUT=0
                MATCH     SP70,VALIDBED
                GOTO      GETB7000 IF EQUAL
                GOTO      GETB7000 IF EOS
              ENDIF
.
              MATCH     SP70,WRTYPE
              IF        !@EQUAL
                MOVE      "RT",CATEGORY
                MOVE      WRTYPE,CODE
                CALL      GETCOD00
                MATCH     "N",TCINDC6
                GOTO      GETB1000 IF EQUAL
                MATCH     "R",TCINDC6
                IF        @EQUAL
                  MATCH     "1",VALDINDC
                  GOTO      GETB1000 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
GETB3000  MOVE      "3",PMBRRSTA            * Update status to completed
          CALL      UPPMBRQ2
.
          CALL      SETHCP00
. 
          PACK      KEY8,ADMISSNO,SP70      * Get U/R from visit to populate
          CALL      RDVISA1                 * urnumber cgi var
          IF        OVRCD<>1
            MOVE      PVIURNO,URNUMBER
          ENDIF
.
          CALL      EXCL0000                * Clear expected patient
.
.         Send an A08 message after completing a Bed Request if
.         "Send ZBR segment" parameter is turned on
.
          MATCH     "1",PTCNSZBR                 * sending ZBR ?
          GOTO      GETB4000 IF NOT EQUAL        * no
.
          CALL      GHTD0000                     * get HL7 holding table data
          BRANCH    EXIT,GETB4000                * error - don't send message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
.
          MATCH     " 1",PTVITYPE                * EMR
          IF        @EQUAL
            PROC      DGCLICEC                   * trigger A08 EMR message
          ELSE
            PROC      DGCLICAC                   * trigger A08 INP message
          ENDIF
.
GETB4000  MATCH     SP70,PMBREWRD           * Check for an expected ward
          GOTO      GETB9000 IF EQUAL
.
          MATCH     VALIDWRD,PMBREWRD
          GOTO      GETB8000 IF NOT EQUAL
.         
          MATCH     SP70,PMBREBED           * Check for an expected bed
          GOTO      GETB9000 IF EQUAL
.
          MATCH     VALIDBED,PMBREBED
          GOTO      GETB8000 IF NOT EQUAL
.
          GOTO      GETB9000
.
GETB7000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              TWO,"|":
                             "</RETURN_VALUE>"
          GOTO      GETB9999
.         
GETB8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ONE,"|":
                             "</RETURN_VALUE>"
          GOTO      GETB9999
.
GETB9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ZERO,"|":
                             "</RETURN_VALUE>"
          GOTO      GETB9999
.
GETB9999  RETURN
.
.------------------------------------------------------------
. Move Admitting Doctor to User Defined HCP (EMVIUR01)
.------------------------------------------------------------
SETHCP00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=0
            MATCH     "1",EMCNDADR
            IF        @EQUAL
              MATCH     "1",DEMVISTA
              IF        @EQUAL
                PACK      KEY10,PMBRQ005,SP70
                CALL      RDPMHCP1
                GOTO      SETHCP90 IF OVER
                MOVE      PMHCLDOC,EMVIUR01
                CALL      UPEMVIS1
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      SETHCP99
.
SETHCP90  PACK      EMVIUR01,SP70
.
SETHCP99  RETURN
.
.------------------------------------------------------------
. Remove Admitting Doctor from User Defined HCP (EMVIUR01)
.------------------------------------------------------------
DELHCP00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=0
            MATCH     "1",EMCNDADR
            IF        @EQUAL
              MATCH     "1",DEMVISTA
              IF        @EQUAL
                MOVE      SP70,EMVIUR01
                CALL      UPEMVIS1
              ENDIF
            ENDIF
          ENDIF
.
DELHCP99  RETURN
.
.------------------------------------------------------------
. Get claim details from the original visit
.------------------------------------------------------------
GCLM0000  MOVE      SP70,CLAMNUMB
          MOVE      SP70,INSUNAME
.
          MATCH     SP70,VISTCLAM           * Visits claim code
          GOTO      GCLM9999 IF EQUAL
.
          MATCH     "1",PTCNXCOM  
          GOTO      GCLM2000 IF NOT EQUAL   * Not using extra compensable
.
          PACK      KEY11,PVIBILL,VISTCLAM,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,GCLM9999
.
          MOVE      PMEXCLMN,CLAMNUMB
.
          PACK      KEY6,PMEXICOD,SP70
          CALL      RDINSR1
          BRANCH    OVRCD,GCLM9999
.
          MOVE      INAME,INSUNAME
.
          GOTO      GCLM9999
          
.         
.         Set the claim type indicator if this is a claim
.         
GCLM2000  PACK      KEY5 WITH ANSC,ANSL,VISTCLAM
          CALL      RDCODE1
          BRANCH    OVRCD OF GCLM9999
.         
.         Check the indicators for a W, M, or V (these are the claims)
.         
          MOVE      ZERO,FORM2
GCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      GCLM9999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      GCLM4000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      GCLM5000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      GCLM6000 IF EQUAL
          GOTO      GCLM3000
.
GCLM4000  OPEN      PATWC1A1,"patwc1af"
          MOVE      PVIBILL,KEY8
          CALL      RDWCOM1            * read previous Workers Comp details
          BRANCH    OVRCD,GCLM9999
.
          MOVE      WCCLMNO,CLAMNUMB
.
          MOVE      WCICODE,KEY6
          CALL      RDINSR1
          IF        OVRCD<>1
            MOVE      INAME,INSUNAME
          ENDIF
.
          GOTO      GCLM9999
.
GCLM5000  MOVE      PVIBILL,KEY8
          CALL      RDWMAB1            * read previous TAC details
          BRANCH    OVRCD,GCLM9999
.
          MOVE      MREFNO,CLAMNUMB
.
          MOVE      CMABINS,KEY6
          CALL      RDINSR1
          IF        OVRCD<>1
            MOVE      INAME,INSUNAME
          ENDIF
          GOTO      GCLM9999
.
GCLM6000  MOVE      PVIBILL,KEY8
          CALL      RDWVET1
          BRANCH    OVRCD,GCLM9999
.
          MOVE      VCLMNO,CLAMNUMB
.
          MOVE      CVETINS,KEY6
          CALL      RDINSR1
          IF        OVRCD<>1
            MOVE      INAME,INSUNAME
          ENDIF
          GOTO      GCLM9999
.
GCLM9999  RETURN
.------------------------------------------------------------
. Get overseas contact tags from pmscexaf
.------------------------------------------------------------
GOSC0000  PACK      SAVKEY14,PMCEURNO,PMCETYPE,PMCECNTR,SP70
.
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
GOSC1000  CALL      RKPMCEX1
          BRANCH    OVRCD,GOSC5000
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      GOSC5000 IF NOT EQUAL
.
          MOVE      "tc",CATEGORY
          MOVE      PMCETYPE,CODE
          CALL      GETCOD00 
.
          MATCH     "7",TCINDC1
          GOTO      GOSC1000 IF NOT EQUAL
          GOTO      GOSC6000
.
GOSC5000  CALL      CLPMSCEX
          GOTO      GOSC6000
.
GOSC6000  CALL      PMCE0000
.
          PACK      KEY14,SAVKEY14,SP70
          CALL      RDPMCEX1
.
GOSC9999  RETURN
.*******************************************************************************
. FHIR Appointments by Practitioner by Date Range
.*******************************************************************************
FAPP0000  MATCH     SP70,DISPHCPC           * Exit of not HCP selected
          GOTO      FAPP9999 IF EQUAL
          MATCH     SP70,LASTDATE
          IF        @EQUAL
            MOVE      FRSTDATE,LASTDATE
          ENDIF
.
          MOVE      FRSTDATE,WORKDATE
          MOVE      LASTDATE,ENDLDATE
          MOVE      ZERO,DISNUMB
.
FAPP1000  IF        FHRINOUT=1
            CALL      OUTAPP00                          * Load HCP outpatient
          ENDIF
          IF        FHRINTHE=1
            CALL      THEAPP00                          * Load HCP theatre
          ENDIF
.
          MATCH     LASTDATE,WORKDATE
          GOTO      FAPP9999 IF EQUAL
          ADD       ONE,WORKDATE
.
          IF        DISNUMB<100
            GOTO      FAPP1000
          ENDIF
.
FAPP9999  RETURN
.
.*******************************************************************************
. Check for open sessions for a HCP on a given date
.*******************************************************************************
OUTAPP00  MOVE      SP70,SAVECLIN
          MOVE      SP70,SAVESITE
.
          MOVE      DISPHCPC,DIM6
          PACK      KEY26,DIM6,Z70
          CALL      RDSCLIA6
OUTAPP10  CALL      RDPCLIA6
          BRANCH    OVRCD,OUTAPP99
          MATCH     OCADOCT,DIM6
          GOTO      OUTAPP99 IF NOT EQUAL
.
          MATCH     SAVECLIN,OCACLIN        * Only display clinic 1 time for
          GOTO      OUTAPP10 IF EQUAL       * multiple effective dates
          MOVE      OCASITE,SAVESITE
          MOVE      OCACLIN,SAVECLIN
.
          PACK      KEY25,SAVESITE,SAVECLIN,WORKDATE,SP70
          CALL      RDSSESA1
OUTAPP20  CALL      RDKSESA1
          BRANCH    OVRCD,OUTAPP10
          MATCH     SAVESITE,OSESITE
          GOTO      OUTAPP10 IF NOT EQUAL
.
          MATCH     SAVECLIN,OSECLIN
          GOTO      OUTAPP10 IF NOT EQUAL
.
          MATCH     OSEDATE,WORKDATE
          GOTO      OUTAPP10 IF NOT EQUAL
.
. Check the session date with the clinic setup to see if the clinic
. is still being run by the this doctor
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1                   * Read Clinic Record
            CALL      RDPCLIA1                   * Read Clinic Record
            BRANCH    OVRCD,OUTAPP10
.
            MATCH     OSESITE,OCASITE
            GOTO      OUTAPP10 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      OUTAPP10 IF NOT EQUAL
          ENDIF
          MATCH     OCADOCT,DIM6            * clinic run by same doctor
          GOTO      OUTAPP10 IF NOT EQUAL
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
OUTAPP30  CALL      RDKBOKA1
          BRANCH    OVRCD,OUTAPP20
          MATCH     OBASITE,OSESITE
          GOTO      OUTAPP20 IF NOT EQUAL
          MATCH     OBACLIN,OSECLIN
          GOTO      OUTAPP20 IF NOT EQUAL
          MATCH     OBADATE,OSEDATE
          GOTO      OUTAPP20 IF NOT EQUAL
          MATCH     OBASTRT,OSESTRT
          GOTO      OUTAPP20 IF NOT EQUAL
          BRANCH    OBASTAT,OUTAPP40,OUTAPP30,OUTAPP30,OUTAPP40,OUTAPP40:
                            OUTAPP40
          GOTO      OUTAPP30
.
OUTAPP40  CALL      GETO0000                * Get slot count and end time
          PACK      URNUMBER,OBAURNO,SP70
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,OUTAPP30
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      PATNAA00
          MOVE      PURNO,URNUMBER
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CALL      FHROUT00
          ADD       ONE,DISNUMB
.
          GOTO      OUTAPP30
.
OUTAPP99  RETURN
.*******************************************************************************
. Load daily theatre bookings for a HCP
.*******************************************************************************
THEAPP00  PACK      KEY22,WORKDATE,SP70
          CALL      RSOPSES7
THEAPP10  CALL      RKOPSES7
          BRANCH    OVRCD,THEAPP99
.
          MATCH     OPSEDATE,WORKDATE
          GOTO      THEAPP99 IF NOT EQUAL
.
          CALL      CHKDOC00
          BRANCH    EXIT,THEAPP10
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
THEAPP20  CALL      RKOPDEA1                * Reading Through Operation Detail
          BRANCH    OVRCD,THEAPP10
.
          MATCH     OPDAHOSP,OPSEHOSP       * Correct hospital
          GOTO      THEAPP10 IF NOT EQUAL
.
          MATCH     OPDADATE,OPSEDATE       * Correct day
          GOTO      THEAPP10 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSETIME       * Correct time
          GOTO      THEAPP10 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSECLIN       * Correct clinic
          GOTO      THEAPP10 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT          * Skip cancelled
          GOTO      THEAPP20 IF EQUAL
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,THEAPP20
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,THEAPP20
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PATNAA00
.
          MOVE      OPDATIME,STRTTIME
.
          MATCH     SP70,OPDAEXPS
          IF        !@EQUAL
            MOVE      OPDAEXPS,STRTTIME
          ENDIF
.
          CALL      GETT0000                * Calculate booking end time
          CALL      SETC0000
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
          MOVE      PURNO,URNUMBER
          CALL      FHRAPP00
.
          ADD       ONE,DISNUMB
          GOTO      THEAPP20
.
THEAPP99  RETURN
.
.---------------------------------------------------------
. Get Anaethestist Name return as ANAENAME
.---------------------------------------------------------
GETAN000  MOVE      SP70,ANAENAME
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ELSE
            PACK      KEY6,OPSEANAE,SP70
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,ANAENAME
            ENDIF
          ENDIF
          STRIP     ANAENAME
          RETURN
.
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
SETC0000  COMPARE   ZERO,OPCNCLSU
          GOTO      SETC0100 IF NOT EQUAL   * Checking For The CLinic Status
.
          MOVE      SP70,KEY30
          MOVE      SP70,SURGNAME
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,SETC0200
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY30        * For Displaying Clinic Descrition
            MOVE      OPCLDESC,SURGNAME     * For Displaying Clinic Descrition
            GOTO      SETC0200
          ELSE
            PACK        KEY6,OPCLDOCT,SP70
            GOTO        SETC0110
          ENDIF
.
SETC0100  PACK      KEY6,OPDACLIN,SP70
SETC0110  CALL      RDDOCT1
          BRANCH    OVRCD,SETC0200
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME
.
SETC0200  MOVE      SP70,DIM30
.
          COMPARE   "0",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Booked",DIM30
          ENDIF
.
          COMPARE   "1",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Pre-Admitted",DIM30
          ENDIF
.
          COMPARE   "2",OPDASTAT
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
            MOVE      "Admitted",DIM30
          ENDIF
.
          COMPARE   "3",OPDASTAT
          IF        @EQUAL
            MOVE      "cancelled",FHRSTAT
            MOVE      "SC",CATEGORY
            MOVE      OPDACANC,CODE
            CALL      GETCOD00
            MATCH     ANST,TCINDC3
            IF        @EQUAL
              MOVE      "Transferred",DIM30
            ELSE
              MOVE      "Cancelled",DIM30
            ENDIF
          ENDIF
.
          COMPARE   "4",OPDASTAT
          IF        @EQUAL
            MOVE      "fulfilled",FHRSTAT
          ENDIF
.
          PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
          RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
.
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.******************************************************************************
. FHIR Location Resource Theatre
.******************************************************************************
RESLOC00  STRIP     OPRMDESC
          CLEAR     KEY16
          APPEND    "Theatre-",KEY16
          APPEND    OPRMROOM,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": #"",OPRMDESC,"#"":
                    " } "
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      DSADD1,PRACNAME       * use hcp details
          MOVE      DSADD2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      DSADD3,PRACADD3
          MOVE      DSADD4,PRACADD4
          MOVE      DSPOST,PRACPOST
          MOVE      PTDOSEML,PRACPEML
          MOVE      DTELES,PRACPTEL
          MOVE      PTDOFAXN,PRACPFAX
          MOVE      DPROV,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,DRTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",DCODE,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",DCODE,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",DTITL,"#" ],":
                    "  #"given#": [ #"",DGNAME,"#" ],":
                    "  #"family#": #"",DSNAME,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PTDOMOBL,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.******************************************************************************
. FHIR Location Resource Outpatient
.******************************************************************************
RESLCO00  STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"Clinic-",OTHELTYP,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"Clinic-",OTHELTYP,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": #"",CTDESC,"#"":
                    " } "
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Appointment FHIR API Logical ID
.------------------------------------------------------------------------------------
OUTFHR00  COMPARE   ONE,FHIRTYPE
          GOTO      OUTFHR91 IF NOT EQUAL
.
          MOVE      "Appointment/OUT-",DIM16
          PACK      FHIRAPPT,DIM16,CASEKEY2,SP70
          REP       " -",FHIRAPPT
.
          MATCH     SP70,CASEKEY2
          GOTO      OUTFHR92 IF EQUAL
          GOTO      OUTFHR92 IF EOS
.
          MOVE      ZERO,DISNUMB
.
          PACK      KEY28,CASEKEY2,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,OUTFHR92
.
          BRANCH    OBASTAT,OUTFHR10,OUTFHR99,OUTFHR99,OUTFHR10,OUTFHR10:
                            OUTFHR10
          GOTO      OUTFHR94
.
OUTFHR10  CALL      GETO0000                * Get slot count and end time
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1                   * Read Clinic Record
            CALL      RDPCLIA1                   * Read Clinic Record
            BRANCH    OVRCD,OUTFHR95
.
            MATCH     OBASITE,OCASITE
            GOTO      OUTFHR95 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      OUTFHR95 IF NOT EQUAL
          ENDIF
.
          PACK      URNUMBER,OBAURNO,SP70
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,OUTFHR93
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      PATNAA00
          MOVE      PURNO,URNUMBER
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CALL      FHROUT00
          GOTO      OUTFHR99
.
.          WRITE     HTMLFILE;"PATWEB10.OUTFHR00";
.
OUTFHR91  MOVE      "INVALID FHIRTYPE",DIM50
          CALL      FHIRER00
          GOTO      OUTFHR99
.
OUTFHR92  MOVE      "INVALID CASE KEY",DIM50
          CALL      FHIRER00
          GOTO      OUTFHR99
.
OUTFHR93  MOVE      "INVALID PATIENT MASTER RECORD",DIM50
          CALL      FHIRER00
          GOTO      OUTFHR99
.
OUTFHR94  MOVE      "INVALID BOOKING STATUS",DIM50
          CALL      FHIRER00
          GOTO      OUTFHR99
.
OUTFHR95  MOVE      "OUTPATIENT CLINIC RECORD NOT FOUND",DIM50
          CALL      FHIRER00
          GOTO      OUTFHR99
.
OUTFHR99  RETURN
+
.------------------------------------------------------------------------------
.         FHIR API Error
.------------------------------------------------------------------------------
FHIRER00    STRIP     DIM50
.            WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
.                               " Cache-Control: no-cache",012:
.                               " Location: %BASEURL/",FHIRAPPT,012,012;
.
            WRITE     HTMLFILE;*+," { #"resourceType#": #"OperationOutcome#",":
                               "  #"id#": #"error#", ":
                               "  #"text#": { ":
                               "    #"status#": #"additional#", ":
                               "    #"div#": #"<div>Error</div>#" ":
                               "  }, ":
                               "  #"issue#": [ ":
                               "    { ":
                               "      #"severity#": #"error#", ":
                               "      #"code#": #"error#", ":
                               "      #"details#": { ":
                               "        #"text#": #"",DIM50,"#"":
                               "  } } ] }"
FHIRER99    RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Attendance FHIR API Logical ID
.------------------------------------------------------------------------------------
ATTFHR00  COMPARE   ONE,FHIRTYPE
          GOTO      ATTFHR91 IF NOT EQUAL
.
          MOVE      "Appointment/ATT-",DIM16
          PACK      FHIRAPPT,DIM16,CASEKEY2,SP70
          REP       " -",FHIRAPPT
.
          MATCH     SP70,CASEKEY2
          GOTO      ATTFHR92 IF EQUAL
          GOTO      ATTFHR92 IF EOS
.
          MOVE      ZERO,DISNUMB
.
          PACK      KEY28,CASEKEY2,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,ATTFHR92
.
.          PACK      KEY8,OBAOUTNO,SP70
.          CALL      RDBOKB1
.          BRANCH    OVRCD,ATTFHR95
.
          BRANCH    OBASTAT,ATTFHR10,ATTFHR99,ATTFHR99,ATTFHR10,ATTFHR10:
                            ATTFHR10
          GOTO      ATTFHR94
.
ATTFHR10  CALL      GETO0000                * Get slot count and end time
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1                   * Read Clinic Record
            CALL      RDPCLIA1                   * Read Clinic Record
            BRANCH    OVRCD,OUTFHR95
.
            MATCH     OBASITE,OCASITE
            GOTO      OUTFHR95 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      OUTFHR95 IF NOT EQUAL
          ENDIF
.
          PACK      URNUMBER,OBAURNO,SP70
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ATTFHR93
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      PATNAA00
          MOVE      PURNO,URNUMBER
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CALL      FHRATT00
          GOTO      ATTFHR99
.
.          WRITE     HTMLFILE;"PATWEB10.ATTFHR00";
.
ATTFHR91  MOVE      "INVALID FHIRTYPE",DIM50
          CALL      FHIRER00
          GOTO      ATTFHR99
.
ATTFHR92  MOVE      "INVALID CASE KEY",DIM50
          CALL      FHIRER00
          GOTO      ATTFHR99
.
ATTFHR93  MOVE      "INVALID PATIENT MASTER RECORD",DIM50
          CALL      FHIRER00
          GOTO      ATTFHR99
.
ATTFHR94  MOVE      "INVALID BOOKING STATUS",DIM50
          CALL      FHIRER00
          GOTO      ATTFHR99
.
ATTFHR95  MOVE      "OUTBB1 RECORD NOT FOUND",DIM50
          CALL      FHIRER00
          GOTO      ATTFHR99
.
ATTFHR99  RETURN
+
.------------------------------------------------------------------------------------
. Outpatient Clinic Discharge FHIR API Logical ID
.------------------------------------------------------------------------------------
DISFHR00  COMPARE   ONE,FHIRTYPE
          GOTO      DISFHR91 IF NOT EQUAL
.
          MOVE      "Appointment/ATT-",DIM16
          PACK      FHIRAPPT,DIM16,CASEKEY2,SP70
          REP       " -",FHIRAPPT
.
          MATCH     SP70,CASEKEY2
          GOTO      DISFHR92 IF EQUAL
          GOTO      DISFHR92 IF EOS
.
          MOVE      ZERO,DISNUMB
.
          PACK      KEY28,CASEKEY2,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,DISFHR92
.
.          PACK      KEY8,OBAOUTNO,SP70
.          CALL      RDBOKB1
.          BRANCH    OVRCD,DISFHR95
.
          BRANCH    OBASTAT,DISFHR10,DISFHR99,DISFHR99,DISFHR10,DISFHR10:
                            DISFHR10
          GOTO      DISFHR94
.
DISFHR10  CALL      GETO0000                * Get slot count and end time
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1                   * Read Clinic Record
            CALL      RDPCLIA1                   * Read Clinic Record
            BRANCH    OVRCD,OUTFHR95
.
            MATCH     OBASITE,OCASITE
            GOTO      OUTFHR95 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      OUTFHR95 IF NOT EQUAL
          ENDIF
.
          PACK      URNUMBER,OBAURNO,SP70
          PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DISFHR93
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      PATNAA00
          MOVE      PURNO,URNUMBER
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          CALL      FHRDIS00
          GOTO      DISFHR99
.
.          WRITE     HTMLFILE;"PATWEB10.DISFHR00";
.
DISFHR91  MOVE      "INVALID FHIRTYPE",DIM50
          CALL      FHIRER00
          GOTO      DISFHR99
.
DISFHR92  MOVE      "INVALID CASE KEY",DIM50
          CALL      FHIRER00
          GOTO      DISFHR99
.
DISFHR93  MOVE      "INVALID PATIENT MASTER RECORD",DIM50
          CALL      FHIRER00
          GOTO      DISFHR99
.
DISFHR94  MOVE      "INVALID BOOKING STATUS",DIM50
          CALL      FHIRER00
          GOTO      DISFHR99
.
DISFHR95  MOVE      "OUTBB1 RECORD NOT FOUND",DIM50
          CALL      FHIRER00
          GOTO      DISFHR99
.
DISFHR99  RETURN
+
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
.
          INC       ALLLNKIO/INC
          INC       EMRICDIO/INC
          INC       EMRVCDIO/INC
          INC       EMRVISIO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATNIDIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATALRIO/INC
          INC       PATHSPIO/INC
          INC       OUTSITIO/INC
          INC       OUTARTIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATICDIO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       PATSUSIO/INC
          INC       PMSBRQIO/INC
          INC       PMSCEXIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       PATDSCIO/INC
          INC       PATWVEIO/INC
          INC       PATWMAIO/INC
          INC       PATWC1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSEPBIO/INC
          INC       PMSEXTIO/INC
          INC       PMSBBDIO/INC
          INC       PMSEVTIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PMSTSPIO/INC
          INC       PMSTAAIO/INC
          INC       PMSTEMIO/INC
          INC       PMSTMDIO/INC
          INC       OPROPRIO/INC
          INC       MLTSECIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCANIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCVTIO/INC
          INC       OUTRCMIO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       OPRDEAIO/INC
          INC       OPRCLIIO/INC
          INC       OPRCOMIO/INC
          INC       OPRSESIO/INC
          INC       OPRUAVIO/INC
          INC       WATESNIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATSUSIO/INC
          INC       WATESEIO/INC
          INC       VISCMTIO/INC
          INC       VISUCMIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       OUTCTYIO/INC
          INC       OUTLKBIO/INC
          INC       OUTMA1IO/INC
          INC       OUTRSHIO/INC
          INC       OUTSIPIO/INC
          INC       OUTXWPIO/INC
          INC       PATICOIO/INC
          INC       OPRMBSIO/INC
          INC       OUTDIAIO/INC
          INC       OPRWCNIO/INC
.
          INC       OPRWCNWK 
          INC       BEDBDVCD
          INC       BEDBDPRO
          INC       CLBOKRX1
          INC       CLEMRVIS
          INC       CLPATDSC
          INC       CLPATRE1
          INC       CLPATTRN
          INC       CLPMSCEX
          INC       CLPMSVX1
          INC       CLOUTBB1
          INC       CLOUTHED
          INC       DGCLICAC
          INC       DGCLICEC
          INC       PMSCEXTM
          INC       OUTARTTM
          INC       CLOPRSES
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPMSPX2
          INC       CLPMSTSP
          INC       NHOSPDAY
          INC       PATMASTM
          INC       PATDOCTM
          INC       PMIGTNID
          INC       PMSBRQTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSTSPTM
          INC       PMSVX1TM	
          INC       PATDSCTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATDOCCD
          INC       TFILENAM
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       PATNAMCD
          INC       OUTBOATM 
          INC       FHROUTCD 
          INC       FHROPRCD 
          INC       FHRDATCD
