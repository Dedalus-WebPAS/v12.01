.***************************************************************************
.* System    :   Broadcast API Messages                                    *
.* Program   :   DGCLRQUE                                                  *
.* Desc      :   Program for clearing broadcast message holding tables     *
.***************************************************************************
.* Date      :   06/12/2001                                                *
.* Author    :   Steve Armstrong                                           *
.* Function  :   This program will be executed by a script which will pass *
.*               a number of hours.  Using the hours passed, the program   *
.*               calculate the date/time for record deletion, ie all       *
.*               records on or before this date will be deleted.           *
.*                                                                         *
.* Mods      :                                                             *
.*                                                                         *
.***************************************************************************
.*  V11.04.03  28/03/2024 Thanh T                TSK 0935314               *
.*             Recompiled for PMSQDRFD changes                             *
.*  V11.04.02  09/01/2024 Thanh T                TSK 0936263               *
.*             Added OPEN PMSQPXA1 index                                   *
.*  V11.04.01  11/12/2023 Thanh T                TSK 0935728               *    
.*             Recompiled for OPRQUEFD changes                             *
.*  V10.15.01  13/11/2019  Davin            TSK 0861253                    *
.*             Added OUTTHIFD for O/P telehealth fields                    *
.***************************************************************************
.*  V11.02.01  09/02/2022  Thanh T       TSK 0905641                       *
.*             Recompiled as OUTMA1FD/WATTR1FD changes                     *
.*  V10.06.02  25/06/2015  Steve Armstrong   CAR 318558                    *
.*             Recompiled for changes to BOKQUEFD & BOKQUEIO               *
.*  V10.06.01  12/03/2015  Steve Armstrong   CAR 314108                    *
.*             Removed reference to PATCGPFD as PATCGPFD is no longer in   *
.*             use                                                         *
.***************************************************************************
.*  V10.03.03  18/05/2013  Steve Armstrong   CAR 268961                    *
.*             Recompiled for changes to PMSQVIFD                          *
.*  V10.03.02  20/12/2012  Steve Armstrong   CAR 278463                    *
.*             Changes to include recently added queue tables - oprqueaf,  *
.*             outqmaaf, outqtyaf & outrquaf.                              *
.*  V10.03.01  15/02/2012  Davin             CAR 256006                    *
.*             Recompiled for changes to WATQUEFD.                         *
.***************************************************************************
.*  V10.02.01  21/09/2011  Steve Armstrong   CAR 251515                    *
.*             Recompiled for changes to WATQUEFD.                         *
.***************************************************************************
.*  V9.08.01 :   31/01/2007  Peter Vela     CAR 127930                     *
.*               Recompiled for MRTMASFD                                   *
.***************************************************************************
.*  V9.05.01 :   03/03/2006  Steve Armstrong  CAR 81335                    *
.*               Mods to include clearing of pmsqdraf                      *
.*  V9.05.B01:   03/03/2006  Steve Armstrong  CAR 88829                    *
.*               Recompiled for changes to OUTQUEFD                        *
.***************************************************************************
.*  V9.04.02 :   26/10/2005  Davin            CAR 64087                    *
.*               Mods to delete hl7cisaf records                           *
.*  V9.04.01 :   16/09/2004  Steve Armstrong  CAR 34707                    *
.*               Mods to delete pmsqccaf records (Concession Card)         *
.***************************************************************************
.*  V9.03.01 :   21/08/2003  Steve Armstrong  CAR 37356                    *
.*               Recompiled for changes to ALLQUEFD                        *
.***************************************************************************
.*  V9.02.02 :   11/01/2002  Davin                                         *
.*               Add logic to clear 'CAE' 'CEC' and 'CCE' messages from    *
.*               holding file 'emrqueaf'.                                  *
.*  V9.02.01 :   14/12/2001 Mike Laming                                    *
.*               Add logic to clear 'CRM' 'CEA' and 'CED' messages from    *
.*               files holding 'mrtqueaf' and 'allqueaf'.                  *
.***************************************************************************
.
          INC       STD002FD
.
. FILE DESCRIPTION INCLUDES
. -------------------------
          INC       ALLQUEFD/INC                                       *I-90201
          INC       ALLAEFFD/INC
          INC       ALLENCFD/INC                                       *I-90201
          INC       ALLERCFD/INC
          INC       ALLREFFD/INC                                       *I-90201
          INC       BOKQUEFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       EMRQUEFD/INC
          INC       EMRVISFD/INC
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       MEHLERFD/INC
          INC       MRTQUEFD/INC                                       *I-90201
          INC       MRTHISFD/INC                                       *I-90201
          INC       MRTMASFD/INC                                       *I-90201
          INC       NHIMASFD/INC
          INC       OPRDEAFD/INC
          INC       OPRQUEFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTMA1FD/INC
          INC       OUTCANFD/INC
          INC       OUTCTYFD/INC
          INC       OUTQMAFD/INC
          INC       OUTQTYFD/INC
          INC       OUTRF1FD/INC
          INC       OUTRQUFD/INC
          INC       OUTRSHFD/INC
          INC       OUTQUEFD/INC
          INC       OUTTHIFD/INC
          INC       PATCONFD/INC
          INC       PATDSCFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PMSBRQFD/INC
          INC       PMSPX2FD/INC
          INC       PMSCCDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSQCCFD/INC
          INC       PMSQDRFD/INC
          INC       PMSQPTFD/INC
          INC       PMSQVIFD/INC
          INC       PMSVX1FD/INC
          INC       WATQUEFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
.
. LOCAL VARIABLE DEFINITION
. -------------------------
DIM2A     DIM       2
DIM2B     DIM       2
DIM5      DIM       5
HOURVALU  FORM      2
MESSAGID  FORM      20
MINTVALU  FORM      2
PASSTIME  FORM      3.1           * time passed from Unix script (hours)
SAVTXWRD  DIM       1
STRTDTTM  DIM       16            * full date/time (ccyymmddhh:mm:ss)
TOTLMINS  FORM      5
WORKDATE  DIM       8
WORKTIME  FORM      4
.
.
. PROGRAM CONSTANTS
. -----------------
DAYMINS   FORM      "1440"        * minutes in a day
SP16      INIT      "                "
.
.
PRGID     INIT      "DGCLRQUE"
PRGNAM    INIT      "Clear Broadcast Message Holding Tables"
VERSION   INIT      "V12.01.00"
+
.**************************************************************************
.*                              ML0000                                    *
.*                      Controlling Logic (Mainline code)                 *
.**************************************************************************
.
ML0000    CALL      SETX0000                * Setup common variables
          CALL      INIT0000                * initialisation and open files
          BRANCH    EXIT,ML9999             * invalid time
.
          CALL      GDTM0000                * Calculate starting date/time
.
          CALL      LOOP0000                * Delete appropriate records
.
ML9999    STOP                              * chain back to program
+
.****************************************************************************
.*                                INIT0000             Called by: ML0000    *
.*                             initialisation                               *
.*  The initialisation routine is used to display headings and open files.  *
.* Returns:  PASSTIME  (time passed from the Unix script - hours to 1       *
.*                      decimal place)                                      *
.*           EXIT      0 = valid passtime                                   *
.*                     1 = invalid passtime                                 *
.****************************************************************************
.
INIT0000  CALL      DISPHEAD                  * display heading
.
          DISPLAY   *P56:24,*EL,"Opening ":
                    *P64:24,"hl7inbaf";
          OPEN      HL7INB01,"hl7inbaf"
          OPEN      HL7INB03,"hl7inbaf"
.
          DISPLAY   *P64:24,"hl7cisaf";
          OPEN      HL7CISA1,"hl7cisaf"
          OPEN      HL7CISA3,"hl7cisaf"
.
          DISPLAY   *P64:24,"allqueaf";                                *I-90201
          OPEN      ALLQUEA1,"allqueaf"                                *I-90201
.
          DISPLAY   *P64:24,"bokqueaf";
          OPEN      BOKQUEA1,"bokqueaf"
.
          DISPLAY   *P64:24,"emrqueaf";
          OPEN      EMRQUEA1,"emrqueaf"
.
          DISPLAY   *P64:24,"mrtqueaf";                                *I-90201
          OPEN      MRTQUEA1,"mrtqueaf"                                *I-90201
.
          DISPLAY   *P64:24,"oprqueaf";
          OPEN      OPRQUEA1,"oprqueaf"
.
          DISPLAY   *P64:24,"outqueaf";
          OPEN      OUTQUEA1,"outqueaf"
.
          DISPLAY   *P64:24,"outqmaaf";
          OPEN      OUTQMAA1,"outqmaaf"
.
          DISPLAY   *P64:24,"outqtyaf";
          OPEN      OUTQTYA1,"outqtyaf"
.
          DISPLAY   *P64:24,"outrquaf";
          OPEN      OUTRQUA1,"outrquaf"
.
          DISPLAY   *P64:24,"pmsqccaf";
          OPEN      PMSQCCA1,"pmsqccaf"
.
          DISPLAY   *P64:24,"pmsqdraf";
          OPEN      PMSQDRA1,"pmsqdraf"
.
          DISPLAY   *P64:24,"pmsqptaf";
          OPEN      PMSQPTA1,"pmsqptaf"
          OPEN      PMSQPXA1,"pmsqpxaf"
.
          DISPLAY   *P64:24,"pmsqviaf";
          OPEN      PMSQVIA1,"pmsqviaf"
.
          DISPLAY   *P64:24,"watqueaf";
          OPEN      WATQUEA1,"watqueaf"
.
          KEYIN     *P1:6,*EL,"Number of hours ? ",PASSTIME
.
          COMPARE   PASSTIME,ZERO
          GOTO      INIT9000 IF LESS
.
          MOVE      ONE,EXIT
.
INIT9000  MOVE      ZERO,EXIT
.
INIT9999  RETURN
+
.**************************************************************************
.*                               GDTM0000              Called by: ML0000  *
.*             Calculate the starting date and time                       *
.* Requires: PASSTIME  (time passed from the Unix script - hours to 1     *
.*                      decimal place)                                    *
.* Returns:  STRTDTTM  (starting date and time for deletion of prior      *
.*                      records)                                          *
.**************************************************************************
.
.         Get the current date and time
.
GDTM0000  CALL      IBACLOCK
          PACK      WORKDATE,CCC,CYY,CMM,CDD
          REP       " 0",WORKDATE
          REP       " 0",CTIMEIS
.
          ASSIGN    (PASSTIME*60),TOTLMINS      * convert passed time to minutes
.
.         If passed minutes is more than 1 day (1440 mins), then keep
.         subtracting 1 day (1440 mins) from the total minutes passed until
.         this is < 1440.  For each 1440 minutes subtracted, subtract one from
.         the working date.
.
          WHILE     TOTLMINS >= DAYMINS
            SUB       DAYMINS,TOTLMINS
            UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CCENT,CC
            MOVE      CYEAR,YY
            MOVE      CMON,MM
            MOVE      CDAY,DD
            CALL      DMYCON
            SUB       ONE,JULDAY
            MOVE      JULDAY,JWKDAY
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON
            PACK      WORKDATE,CC,YY,MM,DD
            REP       " 0",WORKDATE
          DO
.
.         If there is zero minutes left, then the passed time was a multiple
.         of days, so set the full value for date/time
.
          COMPARE   ZERO,TOTLMINS
          IF        @EQUAL
            UNPACK    CTIMEIS,DIM2A,ANS,DIM2B,ANS,ANS,ANS
            PACK      DIM5,DIM2A,COLON,DIM2B
            PACK      STRTDTTM,WORKDATE,DIM5,COLON,SIXTY
            GOTO      GDTM9999
          ENDIF
.
.         The remaining minutes need to be subtracted
.
          UNPACK    CTIMEIS,DIM2A,ANS,DIM2B,ANS,ANS,ANS
          MOVE      DIM2A,HOURVALU               * load current hour
          MOVE      DIM2B,MINTVALU               * load current minute
.
.         Calculate the number of minutes passed 00:00 for the current time
.
          ASSIGN    ((HOURVALU*60)+MINTVALU),WORKTIME
.
.         If the total minutes left is more than the current time in minutes,
.         then we need to subtract another day
.
          IF        TOTLMINS > WORKTIME
            UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CCENT,CC
            MOVE      CYEAR,YY
            MOVE      CMON,MM
            MOVE      CDAY,DD
            CALL      DMYCON
            SUB       ONE,JULDAY
            MOVE      JULDAY,JWKDAY
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON
            PACK      WORKDATE,CC,YY,MM,DD
            REP       " 0",WORKDATE
            SUB       WORKTIME,TOTLMINS          * calculate mins for prev. day
            ASSIGN    (DAYMINS-TOTLMINS),TOTLMINS
          ELSE
            ASSIGN    (WORKTIME-TOTLMINS),TOTLMINS * calc. mins for current day
          ENDIF
.
          ASSIGN    (TOTLMINS/60),HOURVALU       * calculate time of day
          ASSIGN    (TOTLMINS%60),MINTVALU
          PACK      DIM5,HOURVALU,COLON,MINTVALU
          REP       " 0",DIM5
          PACK      STRTDTTM,WORKDATE,DIM5,COLON,SIXTY
.
GDTM9999  RETURN
+
.**************************************************************************
.*                               INBH0000                                 *
.*           Loop through hl7inbaf for valid message ids to be deleted    *
.**************************************************************************
.         Position in hl7inbaf according to the calculated date/time
.
INBH0000  PACK      KEY37,ANSD,STRTDTTM,SP70
          CALL      RSH7INB3                     * position in file
INBH1000  CALL      RPH7INB3                     * read previous record
          BRANCH    OVRCD,INBH9500               * eof - finish
.
.         The delivery date should always be populated for a "D" record,
.         but check just in case.
.
          MATCH     SP16,H7INDDAT                * delivery date blank ?
          GOTO      INBH9500 IF EQUAL            * yes - finish
.
          MOVE      H7INMESI,MESSAGID
          MOVE      H7INMESI,KEY20
          CALL      RDH7INB1                     * record found using index 1 ?
          BRANCH    OVRCD,INBH1000               * no  - check next record
.
          CALL      DEH7INB1                     * delete record
.
          CALL      H7CI0000                     * check for hl7cisaf record
          BRANCH    EXIT,INBH0000                * can't delete child records
.
INBH9000  MOVE      ZERO,EXIT                    * ok to delete child records
          GOTO      INBH9999
.
INBH9500  MOVE      ONE,EXIT                     * no more hl7inbaf records
INBH9999  RETURN
+
.**************************************************************************
.*                               H7CI0000                                 *
.*           Check hl7cisaf for valid message id to be deleted            *
.**************************************************************************
H7CI0000  MOVE      H7INMESI,KEY20
          CALL      RDH7CIS1                     * record found using index 1 ?
          BRANCH    OVRCD,H7CI9000               * no - finished
.
          MATCH     "D",H7CISTAT                 * delivered ?
          GOTO      H7IN9500 IF NOT EQUAL        * no - finished
.
          MATCH     SP16,H7CIDDAT                * delivery date blank ?
          GOTO      H7CI9500 IF EQUAL            * yes - finished
.
          MATCH     STRTDTTM,H7CIDDAT            * delivery date < start date ?
          GOTO      H7CI9500 IF NOT LESS         * no - finished
.
          CALL      DEH7CIS1                     * delete header record
.
H7CI9000  MOVE      ZERO,EXIT                    * ok to delete child records
          GOTO      H7CI9999
.
H7CI9500  MOVE      ONE,EXIT                     * don't delete child records
H7CI9999  RETURN
+
.**************************************************************************
.*                               CISH0000                                 *
.*           Loop through hl7cisaf for valid message ids to be deleted    *
.**************************************************************************
.         Position in hl7cisaf according to the calculated date/time
.
CISH0000  PACK      KEY37,ANSD,STRTDTTM,SP70
          CALL      RSH7CIS3                     * position in file
CISH1000  CALL      RPH7CIS3                     * read previous record
          BRANCH    OVRCD,CISH9500               * eof - finish
.
.         The delivery date should always be populated for a "D" record,
.         but check just in case.
.
          MATCH     SP16,H7CIDDAT                * delivery date blank ?
          GOTO      CISH9500 IF EQUAL            * yes - finish
.
          MOVE      H7CIMESI,MESSAGID
          MOVE      H7CIMESI,KEY20
          CALL      RDH7CIS1                     * record found using index 1 ?
          BRANCH    OVRCD,CISH1000               * no  - check next record
.
          CALL      DEH7CIS1                     * delete record
.
          CALL      H7IN0000                     * check for hl7inbaf record
          BRANCH    EXIT,CISH0000                * can't delete child records
.
CISH9000  MOVE      ZERO,EXIT                    * ok to delete child records
          GOTO      CISH9999
.
CISH9500  MOVE      ONE,EXIT                     * no more hl7inbaf records
CISH9999  RETURN
+
.**************************************************************************
.*                               H7IN0000                                 *
.*           Check hl7inbaf for valid message id to be deleted            *
.**************************************************************************
H7IN0000  MOVE      H7CIMESI,KEY20
          CALL      RDH7INB1                     * record found using index 1 ?
          BRANCH    OVRCD,H7IN9000               * no - finished
.
          MATCH     "D",H7INSTAT                 * delivered ?
          GOTO      H7IN9500 IF NOT EQUAL        * no - finished
.
          MATCH     SP16,H7INDDAT                * delivery date blank ?
          GOTO      H7IN9500 IF EQUAL            * yes - finished
.
          MATCH     STRTDTTM,H7INDDAT            * delivery date < start date ?
          GOTO      H7IN9500 IF NOT LESS         * no - finished
.
          CALL      DEH7INB1                     * delete header record
.
H7IN9000  MOVE      ZERO,EXIT                    * ok to delete child records
          GOTO      H7IN9999
.
H7IN9500  MOVE      ONE,EXIT                     * don't delete child records
H7IN9999  RETURN
+
.**************************************************************************
.*                               LOOP0000              Called by: ML0000  *
.*           Loop backwards through file(s) from starting date/time       *
.*           and delete all delievered message records                    *
.**************************************************************************
LOOP0000  CALL      INBH0000                     * check for hl7inbaf records
          BRANCH    EXIT,LOOP1000                * finished checking hl7inbaf
.
          CALL      PROC0000                     * delete holding table records
          GOTO      LOOP0000
.
LOOP1000  CALL      CISH0000                     * check for hl7cisaf records
          BRANCH    EXIT,LOOP9999                * finished checking hl7cisaf
.
          CALL      PROC0000                     * delete holding table records
          GOTO      LOOP1000
.
LOOP9999  RETURN
+
.**************************************************************************
.*                               PROC0000                                 *
.*           Check holding files for child records & delete them          *
.**************************************************************************
.
.         Check for child bokqueaf records
.
PROC0000  MOVE      MESSAGID,KEY20
          CALL      RDBKQUE1                     * bokqueaf record on file ?
          BRANCH    OVRCD,PROC0100               * no  - check next file
.
          CALL      DEBKQUE1                     * delete record
.
.         Check for child outqueaf records
.
PROC0100  MOVE      MESSAGID,KEY20
          CALL      RDOTQUE1                     * outqueaf record on file ?
          BRANCH    OVRCD,PROC0200               * no  - check next file
.
          CALL      DEOTQUE1                     * delete record
.
.         Check for child pmsqptaf records
.
PROC0200  MOVE      MESSAGID,KEY20
          CALL      RDPMQPT1                     * pmsqptaf record on file ?
          BRANCH    OVRCD,PROC0300               * no  - check next file
.
          CALL      DEPMQPT1                     * delete record
.
.         Check for child pmsqviaf records
.
PROC0300  PACK      KEY22,MESSAGID,SP30
          CALL      RSPMQVI1                     * position in file
          CALL      RKPMQVI1                     * read next record
          BRANCH    OVRCD,PROC0400               * eof  - check next file
.
          COMPARE   MESSAGID,PMQVMESI            * message id still same ?
          GOTO      PROC0400 IF NOT EQUAL        * no - check next file
.
          PACK      KEY22,PMQVMESI,PMQVTRAN
          CALL      DEPMQVI1                     * delete record
          GOTO      PROC0300
.
.         Check for child watqueaf records
.
PROC0400  MOVE      MESSAGID,KEY20
          CALL      RDWTQUE1                     * watqueaf record on file ?
          BRANCH    OVRCD,PROC0500               * no  - check next file
.
          CALL      DEWTQUE1                     * delete record
.
.         Check for child mrtqueaf records
.
PROC0500  MOVE      MESSAGID,KEY20
          CALL      RDMRQUE1                     * mrtqueaf record on file ?
          BRANCH    OVRCD,PROC0600               * no  - check next file
.
          CALL      DEMRQUE1                     * delete record
.
.         Check for child allqueaf records
.
PROC0600  MOVE      MESSAGID,KEY20
          CALL      RDALQUE1                     * allqueaf record on file ?
          BRANCH    OVRCD,PROC0700               * no  - check next file
.
          CALL      DEALQUE1                     * delete record
.
.         Check for child emrqueaf records
.
PROC0700  MOVE      MESSAGID,KEY20
          CALL      RDEMQUE1                     * emrqueaf record on file ?
          BRANCH    OVRCD,PROC0800               * no  - check next file
.
          CALL      DEEMQUE1                     * delete record
.
.         Check for child pmsqccaf records
.
PROC0800  MOVE      MESSAGID,KEY20
          CALL      RDPMQCC1                     * pmsqccaf record on file ?
          BRANCH    OVRCD,PROC0900               * no  - check next file
.
          CALL      DEPMQCC1                     * delete record
.
.         Check for child pmsqdraf records
.
PROC0900  MOVE      MESSAGID,KEY20
          CALL      RDPMQDR1                     * pmsqdraf record on file ?
          BRANCH    OVRCD,PROC1000               * no  - check next file
.
          CALL      DEPMQDR1                     * delete record
.
.         Check for child oprqueaf records
.
PROC1000  MOVE      MESSAGID,KEY20
          CALL      RDOPQUE1                     * oprqueaf record on file ?
          BRANCH    OVRCD,PROC1100               * no  - check next file
.
          CALL      DEOPQUE1                     * delete record
.
.         Check for child outrquaf records
.
PROC1100  MOVE      MESSAGID,KEY20
          CALL      RDOTRQU1                     * outrquaf record on file ?
          BRANCH    OVRCD,PROC1200               * no  - check next file
.
          CALL      DEOTRQU1                     * delete record
.
.         Check for child outqmaaf records
.
PROC1200  MOVE      MESSAGID,KEY20
          CALL      RDOTQMA1                     * outqmaaf record on file ?
          BRANCH    OVRCD,PROC1300               * no  - check next file
.
          CALL      DEOTQMA1                     * delete record
.
.         Check for child outqtyaf records
.
PROC1300  MOVE      MESSAGID,KEY20
          CALL      RDOTQTY1                     * outqtyaf record on file ?
          BRANCH    OVRCD,PROC9999               * no  - check next file
.
          CALL      DEOTQTY1                     * delete record
.
PROC9999  RETURN
+
. =========================================================================
.         I/O Includes
. =========================================================================
.
          INC       STD002IO
.
          INC       CLPMSQPX
.
          INC       ALLQUEIO/INC                                       *I-90201
          INC       BOKQUEIO/INC
          INC       EMRQUEIO/INC
          INC       EMRVISIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       MRTQUEIO/INC                                       *I-90201
          INC       OPRQUEIO/INC
          INC       OUTQMAIO/INC
          INC       OUTQTYIO/INC
          INC       OUTQUEIO/INC
          INC       OUTRQUIO/INC
          INC       PMSQCCIO/INC
          INC       PMSQDRIO/INC
          INC       PMSQPTIO/INC
          INC       PMSQVIIO/INC
          INC       WATQUEIO/INC
