.----------------------------------------------------------------------
. Program       : PATWEB85
.
. Function      : Medical Records Request Server
.
. Modifications : 
.----------------------------------------------------------------------
. V12.01.01 05/02/2026  Zumin Yu       TSK 0972419
.           Updated PTCNMRPN to read from the new location
. V12.00.02 18/09/2025  Nikitha B      TSK 0966346
.           Modified at PLOC1000 to check for user logged in hospitals only.
. V12.00.01 08/07/2025  Bella Turco    TSK 0962544
.           Refactored TBLMRT00 to fix I*C error
. V11.04.03 07/08/2024  Alina Bhari    TSK 0922829
.           Added Status (Category RS) in Bulk Request Reservation Filled List
.           displayed MRT status description as per the configured hex value
.           color in Cat RS -BKRES100,RECSTATD,FILTB310,TBLMRT50         
. V11.04.02 17/06/2024  Ebon Clements  TSK 0947946
.           Fixed U/R receive medical record list reads - TBLMRT10
. V11.04.01 08/05/2024  Jacob Jackson  TSK 0942647
.           Adjust layout of table for single hospital configuration
. V11.03.02 15/11/2023  Jacob Jackson  TSK 0926282
.           Modify list code to allow for remote calls for live-
.           filtering of values
. V11.03.01 15/09/2023  Jacob Jackson  TSK 0926282
.           Add new tag for table list of Medical Records that are
.           in Transit
. V11.02.02 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD changes
. V11.02.01 21/01/2022  Jacob Jackson  TSK 0864505
.           Add preferred name option fields -
.           MRPRN716, MRPRN717, MRPRN718, MRPRN719, MRPRN720
. V11.00.05 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.04 17/11/2020  Thanh T        TSK 0878747
.           Added MRPRN715 for multiple birth details 
. V11.00.03 18/08/2020  Davin          TSK 0892763
.           Added ids to checkbox output at BKRES400/FILTB700 (crossbrowser)
. V11.00.02 15/05/2020  Sunny          TSK 0887996
.           Modified UPDFIL10 so that if the filled checkbox is
.           clicked by mistake it can be undone
. V11.00.01 03/04/2020  Thanh T        TSK 0879163                    
.           Changed MRPRN510 for Sex category.
.           Added MRPRN714 for sex long description 
.----------------------------------------------------------------------
. V10.14.01 08/05/2019  Tracey Nguyen  TSK 0872732
.           Added SHOWCDTR and GETC0000 to show the current date/time
.           required for the request in FILTB000
. V10.13.01 30/10/2018  Ebon Clements  TSK 0863993
.           Added hospital filter to bulk transfer unfilled requests - BTRN0000
. V10.12.01 01/06/2018  Ebon Clements  TSK 0858120
.           Added default all destinations to bulk requwst list - ALLDFLAG
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 04/10/2017  Peter Vela        TSK 0845219
.           Fixed validation in RCRQ3408
. V10.11.04 15/08/2017  Ebon Clements  TSK 9843616
.           Increased RECORDKY key array from 100 to 200
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 18/07/2017  Richa Phogat   TSK 0840683
.           Fixed dropdown issue by adding new tag RCRQ3408
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.01 07/07/2017  Richa Phogat      TSK 0840683
.           Fixed dropdown filter for field 'Destination'
. V10.08.02 19/10/2016  Ebon Clements     TSK 0822444
.           Fixed bulk request current location display - BKRES200
. V10.08.01 14/07/2016  Davin             TSK 0315393
.           Added remote scripts for record retention (vret0000/vsta0000)
.           Added stationery var 78 (MRPRN712) - PMPXRPER Retention Period
.           Added stationery var 79 (MRPRN713) - PMPXRDAT Retention Date
. V10.07.01 17/02/2016  Ebon Clements     CAR 0809739
.           Added MRCNREQC Copy Request Comments to Movement Comments
. V10.06.03 14/06/2015  Peter Vela        CAR 320990
.           Added validation for Cancelled request in GUREQ000
. V10.06.02 19/06/2015  Don Nguyen        CAR 309339
.           Added SHOWOREQ and routines to output count of outstanding requests
. V10.06.01 27/04/2015  Ebon Clements     CAR 313175
.           Only write over movement comment if populated mvmtcomm - RARR0000
. V10.05.04 31/12/2014  Nicole Torrisi    CAR 310253
.           Replaced apostrophe with backtick in HoverData() in MRRQCOMM and
.           MRRQPERS to prevent javascript error
. V10.05.03 03/12/2014  Ebon Clements     CAR 308804
.           Fixed destination filter loop for future requests FILTB000
. V10.05.02 28/11/2014  Ebon Clements     CAR 308804
.           Fixed destination filter filtlocn for non multi hospital - FILTB000
. V10.05.01 24/11/2014  Peter Vela        CAR 308964
.           Replaced apostrophe with backtick in HoverData() display to prevent
.           javascript error
. V10.04.06 06/05/2014  Ebon Clements     CAR 298233
.           If bulk req printer blank don't default single req printer SETB0000
.           Don't print request if printer is blank - MRPRN000
. V10.04.05 07/04/2014  Peter Vela        CAR 286258
.           Recompiled for PATMASTM
. V10.04.04 02/04/2014  Peter Vela        CAR 292589
.           Added FILTHOSP validation before All Hospital Access in MASTB000
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 22/01/2014  Ebon Clements     CAR 293155
.           Changed "Date Requested" to "Date Required" in popup (FILTHD00)
. V10.04.01 08/01/2014  Patrick Adair     CAR 293155
.           Changed "Date Required" to "Date Requested" in popup (FILTHD00)
.----------------------------------------------------------------------
. V10.03.28 29/11/2013  Ebon Clements     CAR 292029
.           Fixed population of current location in DELHIS00
. V10.03.27 16/09/2013  Peter Vela        CAR 287469
.           Populate TRAKHOSP before call to TRKALT00 in FILTB000 and BKRES000
. V10.03.26 24/07/2013  Ebon Clements     CAR 288172
.           Recompiled for PATCODTM - GETCOD00 clear long description
. V10.03.25 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.24 10/07/2013  Ania P           CAR 288258
.           Fixed overwrite of MRRDFUID before Update/Write
. V10.03.23 26/06/2013  Ebon Clements    CAR 286810
.           Added LOOPCNTR to request filled list to keep apache listening 
. V10.03.22 14/06/2013  Ebon Clements    CAR 276047
.           Populate MEDRR001 cgi when using default - RCRQ0600
. V10.03.21 12/06/2013  Ebon Clements    CAR 285347
.           Fixed move one to exit on bulk request web errors 
. V10.03.20 03/06/2013  Ania P           CAR 216497
.           Moved userid into new var MRRDFUID
. V10.03.19 31/05/2013  Ebon Clements    CAR 285540
.           Added home hospital to mrt request key on bulk requests - BKRES000
. V10.03.18 08/04/2013  Don Nguyen       CAR 256589
.           Added MRPRN709-711 (Record Status)
. V10.03.17 22/03/2013  Ania P           CAR 281663
.           Added MRPRN705-708
. V10.03.16 01/02/2013  Ebon Clements    CAR 277797
.           Fixed user id hospital test in mrt request list - MASTB000
. V10.03.15 01/02/2013  Peter Vela       CAR 271557
.           Changed Current Location filter to Home Hospital @ SETAR800
. V10.03.14 01/02/2013  Peter Vela       CAR 271557
.           Added Current Location filter to SETAR800
.           10/12/2012  Jill Parkinson   CAR 277241
.           Changed to only write to mrthisaf if ovrcd=1(not if ovrc<>0)
.           07/11/2012  Jill Parkinson   CAR        
.           Added match WBSEDTYP to MRMADTYP in MASTB000
. V10.03.13 19/07/2012  Ebon Clements    CAR 269089
.           Return each patient on a new line - BKRES000
. V10.03.12 17/07/2012  Ebon Clements    CAR 266290
.           Added display in transit functionality
. V10.03.11 08/06/2012  Ebon Clements    CAR 266875
.           Added sector lock when getting next MR request number -  MRWRT000
. V10.03.10 27/03/2012  Patrick Adair    CAR 261961
.           Added Comments to Receive Medical Records
. V10.03.09 20/02/2012  Ebon Clements     CAR 237452 
.           Added document type filter to bulk requests - CHKRQD00
. V10.03.08 08/02/2012  Ebon Clements     CAR 259654 
.           Fixed destination and current location display - BULKR450
. V10.03.07 30/01/2012  Mike Laming       CAR 259106
.           Mods to use PTHSRCTY instead of MRCNRCTY in "Red" Hospital fields.
. V10.03.06 08/12/2011  Mike Laming       CAR 248696
.           More mods to Red or Black Hospital Id (Added Cat TY test)
. V10.03.05 23/11/2011  Ebon Clements     CAR 252358
.           Changed origination hospitals filters to home hospital filters
. V10.03.04 23/11/2011  Mike Laming       CAR 254569
.           More mods to Hospital Id (with colours)            
. V10.03.03 18/11/2011  Peter McMullen    CAR 254569
.           Extend location display field to avoid truncation
. V10.03.02 15/11/2011  Ebon Clements     CAR 252758
.           Fixed population of FILTHHOS if default was used - RCRQ3900
. V10.03.01 15/11/2011  Ebon Clements     CAR 253688
.           Added all requesting hospitals to bulk requests - BULKR000
. V10.02.24 26/10/2011  Ebon Clements     CAR 253074 
.           Added receive direct flag to VTRN000 
. V10.02.23 13/10/2011  Mike Laming       CAR 252360 
.           Mods to RCRQ0400, added RCRQ4200 to correct "MR Bulk Request"
. V10.02.22 10/10/2011  Mike Laming       CAR 251750 
.           Mods to FILTB000 for new fields Recd Status & Doc Type for WA Health
. V10.02.21 29/09/2011  Ebon Clements     CAR 250177 
.           Receive records that are not in transit - RARR0000
. V10.02.20 29/09/2011  Ebon Clements     CAR 251315 
.           Changed hospital filter to default to all - RCRQ4000
. V10.02.19 26/09/2011  Ebon Clements     CAR 248672 
.           Added document type to request filled lists - FILTB000 & BKRES000
. V10.02.18 26/09/2011  Ebon Clements     CAR 251315
.           Added all option to requesting hospital (filthosp) - FILTB000
. V10.02.17 15/09/2011  Mike Laming       CAR 248696
.           Mods to (hos) fields where Home Hospital is not Current Hospital
. V10.02.16 14/09/2011  Mike Laming       CAR 240724
.           Added "linkhosp" to pass selected Hospital for MR Request (MASTB000)
. V10.02.15 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.14 09/09/2011  Mike Laming       CAR 243582
.           Mods to HSEL0000 to handle different Home Hospital for non-superlev
. V10.02.13 31/08/2011  Mike Laming       CAR 248335
.           Mod to RCRQ3900/4000 to display Request Filled List on first pass  
.           also mod to set default Location to "All"
. V10.02.12 30/08/2011  Mike Laming       CAR 248172
.           Added Originating Hosp Filter in MASTB000 (see ORIGFLAG)      
. V10.02.11 26/08/2011  Mike Laming       CAR 248664
.           Added Location Filter in RCRQ0000 MR Request Details
. V10.02.10 18/08/2011  Peter Vela        CAR 248185
.           Added Req Hosp column in FILTB000
. V10.02.09 16/08/2011  Ebon Clements     CAR 248168
.           List MR for logged in hospital home HR hospital - MASTB000
. V10.02.08 28/07/2011  Ebon Clements     CAR 243582
.           Added Report 8 - Tracking receipt functionality
. V10.02.07 21/07/2011  Mike Laming       CAR 240724
.           Mods to FILTB000 & BULKR000 to only use KEY30 for MRTRQHaf
. V10.02.06 13/07/2011  Mike Laming       CAR 240724
.           Added MRTREXFD/IO for Research Extract and tags for Hospital Id
. V10.02.04 16/06/2011  Mike Laming       CAR 240724
.           Mods to MRTMASFD, MRTLOSFD & MRTHISFD added fields, changed KEYs
.           Added "superlev", removed MRCNCROS, changed "showflag" to "superlev"
. V10.02.03 17/05/2011  Mike Laming       CAR 240716
.           Mods to MRT Tracking sort order - created include MRTRKSEQ, see
.           CALLs GTSRTIND & MRSRTORD. Var SORTORDR replaces TERMDIGT
. V10.02.02 09/05/2011  Mike Laming   CAR 240707
.           Extend MRRQCOMM (Request Comments) to DIM 50 (also MEDRR009)
.           Added Hover Comments on "MR Request Filled List" template
. V10.02.01 21/03/2011 Jill Parkinson CAR 239574
.           Increased printer variables
. V10.00.05 30.08.2010 Ebon Clements CAR 229027
.           Recompiled for TRKALTCD - Added test for departed OP appointments
. V10.00.04 30/08/2010 Sandra Barcham      CAR 228707
.           Clear last location
. V10.00.03 05/07/2010   Ebon Clements     CAR 225302
.           Fixed write of request header audit time -  MRRQAUDT
. V10.00.02 20/04/2010   Ebon Clements     CAR 59880
.           Added medical record tracking alerts to request list
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.03  08/01/2010  Ebon Clements  CAR 208208
.           Added hospital security test to location selection list - RCRQ3200
.           Added showflag test to HSEL0000
. V9.12.02  22/05/2009  Saroeun Soeur  CAR 184450
.           commented out OPNPRINT in MRPRN000 and place it outside sub routine
. V9.12.01  19/05/2009  Peter Vela     CAR 182949
.           Added MRHILOC to MRPRN000 Print Medical Record request
. V9.11.02  06/03/2009  Ebon Clements  CAR 191020
.           Added report 7 check for new medical record requests - REMCHK00
. V9.11.01  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.01  30/07/2008  Peter Vela     CAR 174555
.           Fixed stationery template variables type 4 in MRPRN00 Reason,
.           Requested By, Location Request Required
. V9.09.05  03/02/2008  Ebon Clements  CAR 162697
.           Added user id document type default to RCRQ0600
. V9.09.04  18/02/2008  Ebon Clements  CAR 161653
.           Added user id home location default to RCRQ1600
. V9.09.03  18/01/2008  Peter McMullen CAR 145136
.           Filter MRT requests by hospital
. V9.09.02  28/08/2007  Peter Vela     CAR 148631
.           Modified Terminal Digit view for CABRINI Health @ FILTB000,
.           BRRES000, BKLAB000
. V9.09.01  17/08/2007  Ebon Clements  CAR 143024
.           Added bulk transfer unfilled request to today option to MRTLST00
. V9.08.18  01/04/2007  Janet George   CAR 138464
.           Mods to use stationary code from the medical record location
.           file if it exists,and use system parameter PTCNUCOD otherwise
.           30/04/2007  Neelkamal Pyla CAR 137604
.           Replaced SETPRT00 with SETB0000 in RQBULK00 to set up Bulk Request
.           Printer 
. V9.08.17  05/03/2007  Ebon Clements  CAR 122553 127601
.           Added status filter to bulk mr request list. CHKRQD00
. V9.08.16  19/02/2007  Neelkamal Pyla CAR 129493
.           Added code to RQBULK20 to delete requests from header file when no
.           more records exists in detail file
. V9.08.15  24/01/2007  Peter Vela    CAR 127930
.           Added columns Date Record Created and Triage Cat to FILTB000
.           Medical Record Request list.
. V9.08.14  22/01/2007  Janet George  CAR 124839
.           Fixed the program to move the record to Filled if
.           process and filled is checked
. V9.08.13  18/01/2007  Ebon Clements CAR 130202
.           Fixed savkey in FILTB000 to stop infinite loop after audit read
. V9.08.12  18/01/2007  Janet George  CAR 124839
.           Fixed the program to move the record to Filled if
.           process and filled is checked
. V9.08.11  13/12/2006  J.Tan         CAR 127625
.           Mods to JH Alternate id
. V9.08.10  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.09  16/11/2006  Steve Armstrong   CAR 124160
.           Added Singapore HRN for stationery templating (69)
. V9.08.08  13/11/2006  Peter Vela    CAR 123691
.           Added check for spaces at MRPRN663 MRPRN664
. V9.08.07  09/11/2006  Peter Vela    CAR 121947
.           Commented out direct read of websecaf @ BKLAB100
. V9.08.06  06/11/2006  Peter Vela    CAR 121947
.           Added read of websecaf @ BLKRES40
. V9.08.05  02/11/2006  Peter Vela    CAR 114966
.           Added functionality to display same Destination and Current
.           Locations in blue font (patweb8502001.html patweb8505001.html)
. V9.08.04  02/11/2006  Peter Vela    CAR 114195
.           Added functionality to restrict table display by Security ID Home
.           Location (patweb8502001.html stv) @ FILTB000
. V9.08.03  23/10/2006  Peter Vela    CAR 120583
.           Added Urgency column to Record Request Filled List
. V9.08.02  16/10/2006  Peter Vela    CAR 120583
.           Added Urgency to Record Request Filled List
. V9.08.01  11/10/2006  Peter Vela    CAR 120583
.           Added tags MRRQURGY with select value
. V9.07.04  13/09/2006  Mike Laming   CAR 101489
.           Fix write of MRRQUSUP to Audit File at MRTLST20
. V9.07.03  04/08/2006  Peter Vela    CAR 114196
.           Modified FILTB000 to display UR Number in the first column of
.           patweb8502001 stv.
. V9.07.02  01/08/2006  Peter Vela    CAR 109631
.           Added UR number display/return to FILTB000
. V9.07.01  05/07/2006  Jill Habasque CAR 99902
.           Added new report option for Bulk Record Request Label printing
. V9.06.01  02/05/2006  Jill Habasque CAR 84263
.           Mods to output in red if a priority location in request lists
. V9.05.03  27/03/2006  Peter Vela    CAR 61299
.           Increased field no size from DIM3 to DIM5          
. V9.05.02  17/03/2006  Ebon Clements CAR 89155
.           Mods for multi hospital medical record locations
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B03 22/02/2006  Ebon Clements CAR 60884
.           Mods to medical record request functionality
. V9.05.B02 03/02/2006  Ebon Clements CAR 80520
.           Added last 10 incomplete episode visit numbers and dates
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.11  07/11/2005  Peter Vela    CAR 80363
.           Added ERLST200 to fix alert display and screen refresh
. V9.04.10  14/09/2005  Peter Vela    CAR 74616
.           Added new tag for MRT Locations dropdown selection list RCRQ0300
. V9.04.09  15/08/2005  Peter Vela    CAR 71973
.           Implemented MRCNPBLK Print Parameter for Bulk Record Request
.           Commented out call to WINALT00 in RQBULK00
.           Returned display of alert in PREDIR00
. V9.04.08  11/07/2005  Peter Vela    CAR 58924
.           Allowed Bulk Record Request to print MRWRT000
. V9.04.07  28/06/2005  Peter Vela    CAR 51730
.           Modified Medical Record Request Form variable
.           - Last Incomplete Episode visit Date (Admission Date to Discharge
.             Date)
. V9.04.06  16/06/2005  Jill Habasque CAR 63280
.           Added output of reason description in BKRES000
. V9.04.05  18/05/2005  Jill Habasque CAR 59013
.           Added home location to Medical Record Request
. V9.04.04  12/05/2005  Peter Vela    CAR 51730
.           Added variables to Medical Record Request form
.           - Last Incomplete Episode Visit Number (Volume)
.           - Last Incomplete Episode Visit Date (Volume)
. V9.04.03  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.02  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.01  12/08/2004  Guomin Fu     CAR 51445
.           - Added to write Pager No. and Ext. No into movement history file
.             once request is filled
. V9.03.11  16/06/2004  Pat Dirito    CAR 51730                       
.           - Added end tag after call to routine SEXDSC00 in MRPRN000
. V9.03.10  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.09  11/06/2004 Pat Dirito                CAR 42437
.           Changes for MRCNINCP - Checking Volume only Visits for Incompletes
. V9.03.08  07/06/2004 Peter Vela                CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.07  30/03/2004 Ebon Clemtnts             CAR 48433
.           Fixed allocation of MRHISTAT
. V9.03.06  26/03/2004 Peter Vela                CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.05  04/03/2004  Davin                    CAR 34825
.           Write user id associated with MRT security number to mrthis (kids)
. V9.03.04  09/02/2004 Ebon Clements             CAR 45634
.           Added tag for MRRQCOMM to MFIL0000 - Request comments
.           03/02/2004 Pat Dirito                CAR 45718
.           Added patient details tag to RCRQ0000 
. V9.03.03  23/12/2003 Peter Vela                CAR 46303
.           Initialised Held By / Requested by field in BKRES000
.           18/12/2003 Peter Vela                CAR 43134
.           Recompiled for MRTCONFD
. V9.03.02  05/11/2003 Pat Dirito                CAR 44627
.           Checking against Active indicator for Movement Reasons
.           Routine - MOVREA00
. V9.03.01  12/09/2003 Pat Dirito                CAR 43132
.           Added PTCNRQCF - Free Format for Requested By
.----------------------------------------------------------------------
. V9.02.43  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
. V9.02.42  10/02/2003 Pat Dirito                CAR 36153
.           Modified SAVHIS00 as was not writing to mrtmasaf correctly.
. V9.02.41  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.40  12/12/2002 Pat Dirito                SRF 34349
.           Removed checking of MRCNSTAT against medical records
. V9.02.39  09/10/2002  Peter Vela               SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.38  04/09/2002  Pat Dirito               SRF 19040
.           Now validating medical record in routine CHKRQD00
. V9.02.37  23/07/2002  J.Tan
.           Recompiled for PATMISTM - added patasfaf file
. V9.02.36  29/06/2002  Ebon Clements            SRF 19105
.           Recompiled for sigpipe trap   
. V9.02.35  21/06/2002  Pat Dirito               SRF 18927
.           Removed Multi-hospital branch from SETPRT00.                  
. V9.02.34  18/06/2002  Pat Dirito               SRF 18688
.           SAVHIS00 now writing to History file with full time in secs.
. V9.02.33  13/06/2002  Pat Dirito               SRF 18258
.           Removed control-M chracters being printed after label was printed.
.           Routine MRPRN000.
. V9.02.32  31/05/2002  Ebon Clements 
.           Added trap if sigpipe
. V9.02.31  14/05/2002  J.Tan
.           Recompiled for PATMISTM - added casemix code
. V9.02.30  09/05/2002 Pat Dirito
.           Routine MRPRN000 was being called without the correct reads being 
.           done. MRPRN000 was also calculating the codding complete 
.           incorrectly, added routine INCOMP00. Defect:3688 
. V9.02.29  30/04/2002 Pat Dirito
.           Modified routine MDRCRQ00 not to output message "Request Complete"
.           as was causing internal server errors. Defect No:3586
. V9.02.28  26/04/2002 Pat Dirito
.           Added boundry so that cannot add more than 99 records to ERRORLST
. V9.02.27  11/04/2002 Pat Dirito  
.           Modified MASTB000 to only output Current Location from mrtmasaf.
. V9.02.26  13/03/2002 Pat Dirito  
.           Added boundary to MRKEYARR as not to over fill past 100 records
. V9.02.25  18/02/2002 Bronko Sosic
.           Cleared the Requested by field before a read on the history file
. V9.02.24  11/02/2002 Bronko Sosic
.           Changed Printing of requests. If bulk request dont print
. V9.02.23  02/02/2002 Bronko Sosic
.           Changed SETPRT00 So that it will print out on
.           the printer in MRTLOCFD
. V9.02.22  23/01/2002 Pat Dirito
.           Fixed calls to IBACLOCK now not need as called in WEBRED00 
.           11/01/2002 Bronko Sosic                            
.           Changed the read on MRTMASFD in MASTB000 to index 3               
.           Changed SETAR00 for the bulk movement to use index 3 as well 
. V9.02.21  03/01/2002 Pat Dirito                              
.           Added tag for outputting extracted UR's & Extract ID & Extract ID
. V9.02.20  06/12/2001 Bronko Sosic                            
.           MASTB000 now defaulting to current record
.           and Ticking selected Volume    
. V9.02.19  06/12/2001 Bronko Sosic                            
.           Changed Bulk request list                  
. V9.02.18  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.17  18/11/2001 Bronko Sosic
.           Added Requestor Pager and Extention number to print
. V9.02.16  13/11/2001 Pat Dirito
.           Change for Bulk Request Headers
. V9.02.15  09/11/2001 Bronko sosic
.           Fixed Defect 2067                       
. V9.02.14  01/11/2001 Bronko sosic
.           Added Variables to MRT Request Printing
. V9.02.13  30/10/2001 B.G.Ackland
.           Stop Print Looping
. V9.02.12  26/10/2001 Ebon Clements 
.           Removed hard coded record type for request report
. V9.02.11  22/10/2001 Pat Dirito    
.           MASTB000 now only Ticking selected Volume    
. V9.02.10  18/10/2001 Bronko Sosic  
.           Added new print variables to medical requests
. V9.02.09  17/10/2001 Ebon Clements 
.           Recompiled for PATCODFD 
. V9.02.08  16/10/2001 Ebon Clements 
.           Added patient name to request filled list output
. V9.02.07  12/10/2001 Ebon Clements 
.           Fixed selection list for filled status
. V9.02.06  08/10/2001  Bronko Sosic
.           Fixed Record Request Templating                              
. V9.02.05  27/09/2001  Bronko Sosic
.           Fixed For Defect 3258 Request Filled List                    
. V9.02.04  18/09/2001  J.Tan
.           Changed heading on M/R Master from "Episode to" to "Comments"
. V9.02.03  14/09/2001  Mike Laming    RCH/SVHM
.           Activate Datagate API (see below V9.02.01)             
. V9.02.02  07/09/2001  J.Tan
.           Default thick the current volume on single M/R Request
. V9.02.01  30/08/2001  Mike Laming    RCH/SVHM
.           Add Datagate API Medical Records Movement (DGCLICRM)
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B10 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B09 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B08 28/05/2001 Ebon Clements 
.           Update current location when requests are filled
. V9.00.B07 28/05/2001 Ebon Clements 
.           Fixed Duplicate record in SAVHIS00 for remote script
. V9.00.B06 28/05/2001 Ebon Clements 
.           Added new sort seq to request report               
. V9.00.B05 17/05/2001  Bronko Sosic  
.           Bug Fixes                                          
. V9.00.B04 17/04/2001  Glenn Saunders
.           Remove all reference to PTCNSNDX parameter.        
. V9.00.B03 01/03/2001  Bronko sosic
.           Added Print function to request                    
. V9.00.B02 28/02/2001  Bronko sosic
.           Record Filled List Rebounds                        
.----------------------------------------------------------------------
.                 V5.09.04 09/02/2001  Bronko sosic
.                          Fixed display of drop down list for location       
.                 V5.09.03 15/01/2001  Bronko sosic
.                          Recompile for PATMASTM & MRTRQDFD                  
.----------------------------------------------------------------------
.                 V5.08.04 11/09/2000  Bronko sosic
.                          Mods to combine Record Request and Reservation
.                 V5.08.03 05/09/2000  Tonii
.                          Mods to accept Unknown and Indeterminate as valid
.                          patient sex description
.                 V5.08.02 16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.01 07/06/2000 Bronko Sosic  
.                          Recompiled for PATMASTM 
.---------------------------------------------------------------------- 
.                 V5.07.03 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.02 29.12.1999 B.G.Ackland
.                          Recompiled for IBAWEBDF/IBAWEBCD
.                 V5.07.01 20.12.1999 K.C.Nelson  
.                          Recompiled for IBAWEBDF/IBAWEBCD
.                 V5.07.00 28.10.1999 K.C.Nelson  
.                          Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       BOKRC1FD/INC
          INC       CHKDIGVR/INC
          INC       EMRVISFD/INC
          INC       MRTVISFD/INC 
          INC       APSMASFD/INC
          INC       PATVADFD/INC
          INC       PATDADFD/INC
          INC       PATDSCFD/INC
          INC       MRTCONFD/INC
          INC       IBALPCFD/INC
          INC       IBATMDFD/INC
          INC       MLTSECFD/INC
          INC       MRTREQFD/INC
          INC       MRTBRHFD/INC
          INC       MRTREDFD/INC
          INC       MRTREXFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCTYFD/INC
          INC       OUTHEDFD/INC
          INC       OUTSESFD/INC
          INC       PATCALAG/INC
          INC       PATCMCFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PATDHEAD/INC
          INC       PATDGWFD/INC
          INC       PATFN1FD/INC
          INC       PATHSPFD/INC
          INC       PATIN1FD/INC
          INC       PATITMFD/INC
          INC       PATPR1FD/INC
          INC       PATASFFD/INC
          INC       PATMA1FD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSVX1FD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATMI1FD/INC
          INC       PATRE1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       MRTMOVFD/INC
          INC       MRTLOCFD/INC
          INC       MRTSTFFD/INC
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
          INC       MRTHISFD/INC 
          INC       MRTRQHFD/INC 
          INC       MRTRQDFD/INC 
          INC       OUTSITFD/INC
          INC       RESLNKFD/INC
          INC       PATALRFD/INC
          INC       PATVISFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
.
ALLDFLAG  FORM      1                 * Default destinatino to all
ALRTMESS  DIM       127               * Tracking alert message
ALRTCLAS  DIM       10                * Tracking alert class
ALLLOCN   FORM      1
BULKFLAG  DIM       1
CFILEPRE  DIM       3
CURRDATE  DIM       8                 * Current Date
DESTDESC  DIM       30                * Destination Location Description
DFLTHLOC  DIM       4                 * Dummy Variable for Default Home Locatio
DIM8      DIM       8
DIM10     DIM       10
DISPDATE  DIM       11
ENDDDATE  DATE      8
EXTRCTID  DIM       4                 * Extract ID
RECCNT    FORM      4
RECDIREC  FORM      1
RECVDATE  DIM       8
RECVHOSP  DIM       3
RECVLOCN  DIM       4
RECVREAS  DIM       4
DOCMTYPE  DIM       3
DOCTYPRM  DIM       3
DOCTDESC  DIM       20
RECVTIME  DIM       8
DRECCNT   DIM       4
DFLTHOSP  DIM       3
DFLTHHOS  DIM       3
ERRORCNT  FORM      3
ERRORLST  DIM       50[99]
FILTHHOS  DIM       3                       * Home Hospital
FILTHOSP  DIM       3
FILTLOCN  DIM       4
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
RECORDKY  DIM       12[200]
REQUESTN  DIM       10
COUNT     FORM      3                 * Count for Volume No
DOCTYFLG  DIM       1
VISCOUNT  FORM      2
MRCOUNT   FORM      3                 * Count of MR Keys
SAVCOUNT  FORM      3                 * Count of MR Keys
SELHOSP   DIM       3
SVHOSLOC  DIM       7  
SAVKEY23  DIM       23
SAVKEY27  DIM       27
SAVKEY30  DIM       30
SHOWFLAG  DIM       1
SUPERLEV  DIM       1                                                 *C-240724
THISLOCN  DIM       4
MRKEYCNT  FORM      3                 * Count of MR Keys
MRKEYARR  DIM       20[100]           * Array of MR Keys
PRIORLOC  DIM       1
PRV2DATE  DATE      8

..DATE      DIM       12                * Date Current  
DISPLAYR  DIM       50                * Display requested by
NEWRFLAG  DIM       1
NODEFHOS  DIM       1
NUM       FORM      2 
FORM8     FORM      8
CURRROW   FORM      3
DIM3      DIM       3
DIM4      DIM       4
DIM5      DIM       5
DIM6      DIM       6
DIM20     DIM       20
DIM20A    DIM       20
DIM40     DIM       40
DIM80     DIM       80
DIM500    DIM       500
DOCTCODE  DIM       6
FORM3     FORM      3
FORM5     FORM      5
MRVVCHOS  DIM       35                      * Current Hospital Id (work area)
MRVVRHOS  DIM       35                      * Required Hospital Id (work area)
LOCDESC1  DIM       70
LOCDESC2  DIM       70
LOOPCNTR  FORM      4
HLOCDSC1  DIM       70
HLOCDSC2  DIM       96
HOMEHOSP  DIM       3
HOMELOCN  DIM       4
HOMLOCRM  DIM       4
HOMEFLAG  DIM       1
INCVISIT  DIM       8[10]
INCOMDAT  DIM       11[10]
INTRANST  DIM       26
KEY1A     DIM       1
KEY1B     DIM       1
KEY10A    DIM       10
KEYHOS    DIM       3                                                 *I-240724
SAMLFLAG  DIM       1
LINKHOSP  DIM       3
LABELTYP  DIM       10
LABPRT01  DIM       1       * Print Indicator - Booking Label
LABPRT02  DIM       1       * Print Indicator - Appt Mailing Label
LABPRT03  DIM       1       * Print Indicator - PMI Mailing Label
LABPRT04  DIM       1       * Print Indicator - GP Mailing Label
LABPNO01  DIM       3       * Number of Labels for Booking Label
LABPNO02  DIM       3       * Number of Labels for Appt Mailing Label
LABPNO03  DIM       3       * Number of Labels for PMI Mailing Label
LABPNO04  DIM       3       * Number of Labels for GP Mailing Label
LABPSL01  DIM       6       * Printer Selected - Booking Label
LABPSL02  DIM       6       * Printer Selected - Appt Mailing Label
LABPSL03  DIM       6       * Printer Selected - PMI Mailing Label
LABPSL04  DIM       6       * Printer Selected - GP Mailing Label
LASTROW   FORM      3
LOADFLAG  FORM      1                 * Loaded incomplete details
ORIGFLAG  DIM       1
SHOWCHEK  DIM       10                * Used as a flag for a checkbox
SAVDOCTY  DIM       3                 * Document Type
MEDRR001  DIM       3                 * Document Type
MEDRR002  DIM       35                * Requested By
MEDRR003  DIM       4                 * Reason of Request
MEDRR004  DIM       12                * Date Required 
MEDRR005  DIM       8                 * time Required
MEDRR006  DIM       4                 * Destination Department / Location
MEDRR007  DIM       20                * Extention
MEDRR008  DIM       3                 * Urgency
MEDRR009  DIM       50                * Comments                      *C-240707
MEDRR010  DIM       3                 * Hospital ID
MEDRR011  DIM       20                * Pager No  
MEDRR012  DIM       3                 * Home Hospital Id              *I-240724
MEDRR013  DIM       4                 * Home Location                 *I-240724
.
MRTPT001  DIM       10                * Request Number
MRTPT002  DIM       10                * Medical Record Key 
.
MRTSECID  DIM       10                * MRT security number User ID
MRTSECNO  DIM       8                 * MRT security number
.
MBIRURNO  DIM       8
MBIRTYOR  DIM       24
.
HOMELOCT  DIM       4                 * Home Location
HOMEDESC  DIM       30                * Home Location Description
HTMLLNK2  DIM       127
DOCUTYPE  DIM       3                 * Document Type
VOLUMENO  DIM       2                 * Volume No
VOLUMENU  FORM      2[99]             * Volume No
MRVOLCNT  FORM      3                 * Count of MR Keys
LOCATION  DIM       4                 * Location For Table Output 
TRAKHOSP  DIM       3                 * Tracking alert hospital       *I-240724
TRAKLOCN  DIM       4                 * Tracking alert location
URGENCYR  DIM       3                 * Urgency for Table Output
URGEDESC  DIM       20                * Urgency Desc column
MRTRECKY  DIM       20                * Key for Medical Requests Details File
ORIGDATE  DIM       8
ORIGTIME  DIM       8
SEQUENCE  FORM      1                 * Flag on update of filled list 
CHECKBOX  FORM      1                 * Flag on checkbox              
FILLEDRC  DIM       1                 * Record Filled for Table Output
MBSDESC   DIM       40
PRNTSTRT  FORM      3
UPDATETY  DIM       1
NEXTPAGE  DIM       1                 * Nextpage parameter CGI parameter
VARIABLE  DIM       127                   
VALDDATE  DIM       8
VALDTIME  DIM       5
RECDSTAT  DIM       3
RECSTATD  DIM       10      * User Defined field 3 color for record status
RQSTREAS  DIM       15
SCANDATE  DATE      8                 * Scan visits from date.
SCHDPRNT  DIM       6                 * Printer
SCHDCOPY  FORM      3                 * No of Copies
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVREPTN  FORM      2
SAVPRGID  DIM       8
STATNCOD  DIM       6       * Stationary Code Coded Field
STATCODE  DIM       6       * Stationary Code Field
STATDESC  DIM       20      * Status Description
SUBSYSKY  DIM       50
SORTORDN  DIM       1                       * MR Tracking sort order indicator
SORTORDR  DIM       8                       * MR Tracking sort order value
T1A       DIM       1
T2A       DIM       2
T2B       DIM       2
T3A       DIM       3
T4A       DIM       4
T5A       DIM       5
STAFFKEY  DIM       6
WORKDATE  DATE      8
MVMTCOMM  DIM       50                * Movement Comments  C-261931
SHOWOREQ  FORM      1        * Show outstanding Medical Record Requests
SHOWCDTR  DIM       1        * Show Current Date/Time Required request  
REQNUMBR  DIM       10
REQNFCNT  FORM      3        * Count of outstanding MR Requests
ALTHOHOS  DIM       3
ORIGHOSP  DIM       20
HMLODESC  DIM       30
COUNTER1  FORM      4
MRTBLREM  FORM      1
.
PACKLINK  DIM       70      * Test
SQUOTE    INIT       "'"
CATAP     INIT      "ap"
CATTY     INIT      "TY"
OBB       INIT      "("
CBB       INIT      ")"
OBR       INIT      "<font color=red>("
CBR       INIT      ")</font>"
CODETY    INIT      "TY"
CODERS    INIT      "RS"
CODER     INIT      "R "   
CODEM     INIT      "M "
LABELPMI  INIT      "LABELPMI"
LABELADD  INIT      "LABELADD"
STATY     INIT      "Filled"
STATP     INIT      "Processed"
STATN     INIT      "New   "
STATC     INIT      "Cancelled"
STTRED    INIT      "<font color=red>"
STTBLUE   INIT      "<font color=blue>"
ENDFONT   INIT      "</font>"

.--------------------------------------------------------------------------
PRGID     INIT      "PATWEB85"
VERSION   INIT      "V12.01.01"
PRGNAM    INIT      "Medical Records Request Server"
.--------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          CALL      GTSRTIND       * get MRT Tracking sort order indicator
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MDRCRQ00               * Medical Record request.
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      MRTLST00               * Medical Record request Fill List.
          BRANCH    EXIT,MAIN1000
          MOVE      "Request Printed",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      UPDFIL00               * Update Filled List Remote scripting
          GOTO      MAIN1000
.
MAIN1400  CALL      RQBULK00               * Medical Record Bulk request.
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      BLKRES00               * Bulk Request Reservations List
          BRANCH    EXIT,MAIN1000
          MOVE      "Request Printed",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      PRTGPL00   * Schedule Group Label Printing 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      REMCHK00               * Check for new medical record       
          GOTO      MAIN1000               * requests remote script
.
MAIN1800  CALL      RECV0000               * Receive Medical Records
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      REMREC00               * Remote Scripts for Receive         
          GOTO      MAIN1000               * Medical Records
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WARLST00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTVISA2,"mrtvisaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTMASA3,"mrtmasaf"
          OPEN      MRTMASA4,"mrtmasaf"
          OPEN      MRTRQHR1,"mrtrqhaf"
          OPEN      MRTRQHR5,"mrtrqhaf"
          OPEN      MRTAUDRQ,"mrtaudrq"
          OPEN      MRTRQHR2,"mrtrqhaf"
          OPEN      MRTRQHR3,"mrtrqhaf"
          OPEN      MRTRQDR1,"mrtrqdaf"
          OPEN      MRTRQDR2,"mrtrqdaf"
          OPEN      MRTBRHA1,"mrtbrhaf"
          OPEN      MRTBRHA2,"mrtbrhaf"
          OPEN      MRTBRHA3,"mrtbrhaf"
          OPEN      MRTREDA3,"mrtredaf"
          OPEN      MRTREXA1,"mrtrexaf"
          OPEN      MRTSTFA1,"mrtstfaf"
.
.
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATITEM1,"patitemn"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTLOCA3,"mrtlocaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,FIFTY9;*6,CLUNTNO,*34,CTYPEUR,*35,CTYPLAB:
                                  *37,CTYPCHG,CRESIDT,*41,CNONRES,*44,CYRSRES:
                                  *64,CUSENOTE,*79,CYRESMAN,CBIRTHCN:
                                 *86,CDETENTE,*92,CDETPATH,*129,CCHGCMN,CADDLAB:
                                 *132,CALRDESC,CPIDCOD,*171,PTCNSTAU,PTCNNUMM:
                                 *174,PTCNNDAT,*182,PTCNORNO,*192,PTCNURCF:
                                 *193,PTCNRQCF,*194,PTCNDPCF,*195,PTCNRLAY:
                                 *196,PTCNUCOD:
                                 *208,PTWRDLAB,PTCNDAYF,*216,PTPRVALS:
                                 *220,PTCNUADT,*226,CCARECL,CADMCAT:
                                 *231,PTCNRGNS:
                                 *233,PTCNADOC,PTCNNMPI,PTCNPREG
.
          READ      CONTROLF,SIXTY;*84,MRCNHLOC,*105,MRCNHMTY,*88,MRCNRCTY:
                                   *108,MRCNSTAT,*149,MRCNBCHI:       *C-240724
                                   *156,MRCNREQC
          READ      CONTROLF,NINTY7;*157,MRCNINCP,*162,MRCNPBLK:
                                    *170,MRCNTDAY,*176,MRCNTREC
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND30;*180,PTCNMRPN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,SAVCOUNT
          MOVE      SP70,EXTRCTID
          MOVE      SP70,SAVDOCTY
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,UPDATETY
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,LOCATION 
          MOVE      SP70,URGENCYR
          MOVE      SP70,FILLEDRC 
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,SHOWCHEK
          MOVE      SP70,REQUESTN
          MOVE      SP70,HOMEFLAG
          MOVE      SP70,ORIGFLAG
          MOVE      SP70,FILTHHOS
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTLOCN
          MOVE      SP70,VALDDATE
          MOVE      SP70,VALDTIME
          MOVE      SP70,BULKFLAG
          MOVE      SP70,SHOWFLAG
          MOVE      SP70,SUPERLEV                                     *I-240724
          MOVE      SP70,DOCTYFLG
          MOVE      SP70,RECDSTAT
          MOVE      SP70,RECVDATE
          MOVE      SP70,RECVTIME
          MOVE      SP70,RECVHOSP
          MOVE      SP70,RECVLOCN
          MOVE      SP70,RECVREAS
          MOVE      SP70,HOMEHOSP
          MOVE      SP70,DOCMTYPE
          MOVE      SP70,HOMELOCN
          MOVE      SP70,LINKHOSP
.
          MOVE      SP70,MEDRR001
          MOVE      SP70,MEDRR002
          MOVE      SP70,MEDRR003
          MOVE      SP70,MEDRR004
          MOVE      SP70,MEDRR005
          MOVE      SP70,MEDRR006
          MOVE      SP70,MEDRR007
          MOVE      SP70,MEDRR008
          MOVE      SP70,MEDRR009
          MOVE      SP70,MEDRR010
          MOVE      SP70,MEDRR011
          MOVE      SP70,MEDRR012
          MOVE      SP70,MEDRR013
          MOVE      SP70,HOMELOCT
          MOVE      SP70,DOCUTYPE 
          MOVE      SP70,VOLUMENO  
          MOVE      SP70,MRTRECKY  
          MOVE      SP70,SEQUENCE  
          MOVE      SP70,CHECKBOX  
          MOVE      SP70,MVMTCOMM                * C-261931       
          MOVE      SP70,HOMLOCRM
          MOVE      SP70,DOCTYPRM
.
          MOVE      SP70,MRLOBPRN
.
          MOVE      SP70,MRTSECID
          MOVE      SP70,MRTSECNO
.
          MOVE      SP70,MRTPT001
          MOVE      SP70,MRTPT002
.
          MOVE      ZERO,MRKEYCNT 
          MOVE      ZERO,MRVOLCNT 
          MOVE      ZERO,ALLDFLAG
.
          MOVE      ONE,COUNT                                                  
          WHILE     COUNT <= 198
            MOVE      SP70,RECORDKY[COUNT]
            ADD       ONE,COUNT
          DO
          MOVE      ZERO,COUNT
          MOVE      Z70,LABPRT01
          MOVE      Z70,LABPRT02
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04
          MOVE      Z70,LABPNO01
          MOVE      Z70,LABPNO02
          MOVE      Z70,LABPNO03
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPSL01
          MOVE      Z70,LABPSL02
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04
          MOVE      ZERO,SHOWOREQ
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrctid=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,EXTRCTID
            PACK      EXTRCTID,EXTRCTID,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQUESTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr002",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            MOVE      QRYDATA,MEDRR002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr003",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr004",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP30
            UNPACK    QRYDATA,KEY8,KEY3 
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,MEDRR004 *Do not change date format = (CCYYMMDD)
            ELSE
              MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
              PACK      KEY11,KEY11,SP70
              MATCH     SP70,KEY11
              IF        !@EQUAL
                UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
                CALL      SETMTH00
                PACK      MEDRR004,CCENT,CYEAR,CMON,CDAY
                REP       " 0",MEDRR004
              ENDIF
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr005",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr006",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr007",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR007
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr008",QRYNAME
          IF        @EQUAL
            PACK      MEDRR008,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr009",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR009
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr010",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR010
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr011",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR011
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr012",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR012
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrr013",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRR013
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtpt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtpt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homeloct",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOMELOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docutype",QRYNAME                      
          IF        @EQUAL                                  
            MOVE      QRYDATA,DOCUTYPE                      
            GOTO      SETPAR99                              
          ENDIF                                             
.                                     
          MATCH     "volumeno",QRYNAME                      
          IF        @EQUAL                                  
            MOVE      QRYDATA,VOLUMENO                      
            GOTO      SETPAR99                              
          ENDIF                                             
.                                     
          MATCH     "showchek",QRYNAME                      
          IF        @EQUAL                                  
            MOVE      QRYDATA,SHOWCHEK                      
            GOTO      SETPAR99                              
          ENDIF                                             
.                                     
          MATCH     "recordky",QRYNAME
          IF        @EQUAL
            COMPARE   "99",MRKEYCNT
            GOTO      SETPAR99 IF EQUAL 
            ADD       ONE,MRKEYCNT
            UNPACK    QRYDATA,KEY10
            PACK      RECORDKY[MRKEYCNT],KEY10,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "volumenu",QRYNAME
          IF        @EQUAL
            COMPARE   "99",MRVOLCNT
            GOTO      SETPAR99 IF EQUAL 
            ADD       ONE,MRVOLCNT
            MOVE      QRYDATA,VOLUMENU[MRVOLCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrkeyarr=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",MRKEYCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,MRKEYCNT
            PACK      MRKEYARR[MRKEYCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "location",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LOCATION
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urgencyr",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URGENCYR
            GOTO      SETPAR99
          ENDIF

          MATCH     "filledrc",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILLEDRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtrecky",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTRECKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sequence",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SEQUENCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checkbox",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHECKBOX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtsecid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtsecno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "labpno",QRYNAME
          IF        @EQUAL
            CALL     STPNO000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpsl",QRYNAME
          IF        @EQUAL
            CALL     STLSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labprt",QRYNAME
          IF        @EQUAL
            CALL     STLAB000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "filthhos",QRYNAME
          IF        @EQUAL
            PACK      FILTHHOS,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtlocn",QRYNAME
          IF        @EQUAL
            PACK      FILTLOCN,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtime",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bulkflag",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BULKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag",QRYNAME
          IF        @EQUAL
            PACK      SHOWFLAG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME                               *I-240724
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "origflag=",QRYNAME                               *I-248172
          IF        @EQUAL
            PACK      ORIGFLAG,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctyflg=",QRYNAME                               *I-248172
          IF        @EQUAL
            PACK      DOCTYFLG,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recdstat=",QRYNAME    
          IF        @EQUAL
            PACK      RECDSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recvdate=",QRYNAME    
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      RECVDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recvtime=",QRYNAME    
          IF        @EQUAL
            PACK      RECVTIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recvhosp=",QRYNAME    
          IF        @EQUAL
            PACK      RECVHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recvlocn=",QRYNAME    
          IF        @EQUAL
            PACK      RECVLOCN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homehosp=",QRYNAME    
          IF        @EQUAL
            PACK      HOMEHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homelocn=",QRYNAME    
          IF        @EQUAL
            PACK      HOMELOCN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docmtype=",QRYNAME    
          IF        @EQUAL
            PACK      DOCMTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkhosp=",QRYNAME    
          IF        @EQUAL
            PACK      LINKHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recvreas=",QRYNAME    
          IF        @EQUAL
            PACK      RECVREAS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.                                                *C-261931
          MATCH     "mvmtcomm=",QRYNAME    
          IF        @EQUAL
            PACK      MVMTCOMM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alldflag=",QRYNAME    
          IF        @EQUAL
            MOVE      QRYDATA,ALLDFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homlocrm=",QRYNAME
          IF        @EQUAL
            PACK      HOMLOCRM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctyprm=",QRYNAME
          IF        @EQUAL
            PACK      DOCTYPRM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.*******************************************************************************
.                        SET LABPRT PARAMETERS
.*******************************************************************************
STLAB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLAB001,STLAB002,STLAB003,STLAB004
.
          MOVE      ONE,EXIT
          GOTO      STLAB999
.
STLAB001  MOVE      QRYDATA,LABPRT01
          GOTO      STLAB999
.
STLAB002  MOVE      QRYDATA,LABPRT02
          GOTO      STLAB999
.
STLAB003  MOVE      QRYDATA,LABPRT03
          GOTO      STLAB999
.
STLAB004  MOVE      QRYDATA,LABPRT04
          GOTO      STLAB999
.
STLAB999  RETURN
.
.*******************************************************************************
.                      SET LABPN PARAMETERS
.*******************************************************************************
.
STPNO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPNO001,STPNO002,STPNO003,STPNO004
.
          MOVE      ONE,EXIT
          GOTO      STPNO999
.
STPNO001  MOVE      QRYDATA,LABPNO01
          GOTO      STPNO999
.
STPNO002  MOVE      QRYDATA,LABPNO02
          GOTO      STPNO999
.
STPNO003  MOVE      QRYDATA,LABPNO03
          GOTO      STPNO999
.
STPNO004  MOVE      QRYDATA,LABPNO04
          GOTO      STPNO999
.
STPNO999  RETURN
.
.******************************************************************************
.                           SET LABPSL PARAMETERS
.******************************************************************************
.
STLSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLSL001,STLSL002,STLSL003,STLSL004
.
          MOVE      ONE,EXIT
          GOTO      STLSL999
.
STLSL001  MOVE      QRYDATA,LABPSL01
          GOTO      STLSL999
.
STLSL002  MOVE      QRYDATA,LABPSL02
          GOTO      STLSL999
.
STLSL003  MOVE      QRYDATA,LABPSL03
          GOTO      STLSL999
.
STLSL004  MOVE      QRYDATA,LABPSL04
          GOTO      STLSL999
.
STLSL999  RETURN
.------------------------------------------------------------
. Medical Record Bulk Request.
.------------------------------------------------------------
RQBULK00  RESET     UPDATETY
          MATCH     SP1,UPDATETY
          GOTO      RQBULK50 IF EQUAL

          MATCH     "A",UPDATETY    * Request formaction 
          GOTO      RQBULK10 IF EQUAL
.
          MATCH     "D",UPDATETY    * Delete formaction
          GOTO      RQBULK20 IF EQUAL
.
          GOTO      RQBULK90
.
.        *********** REQUEST FORMACTION ***********
.
RQBULK10  COMPARE   ZERO,MRKEYCNT
          GOTO      RQBULK92 IF EQUAL
.
          CALL      MRCLR000            * Clear/Init working variables 
          CALL      CHKCOD00            * Check Stationary Code
          BRANCH    EXIT,RQBULK99
.
          CALL      SETB0000            * Set up Bulk Request Printer
          BRANCH    EXIT,RQBULK99
.
          CALL      SETAR000            * Sets up array of records
          CALL      MRWRT000            * Loop through UR's and save Requests
          CALL      MRBKRH00            * Write to Bulk Request Header Table
.
.         COMPARE   ZERO,ERRORCNT       
.         IF        !@EQUAL
.           CALL      ERRLST00          * Display Error in javascript alert
            BRANCH    EXIT,RQBULK91
.         ENDIF
.
.         MOVE      ZERO,EXIT
          GOTO      RQBULK91
.
.        ************ DELETE FORMACTION **********
.
RQBULK20  PACK      KEY20,MRTRECKY,SP70
          CALL      RDMRRQD1
          BRANCH    OVRCD,RQBULK93
.
          CALL      DEMRRQD1
.
          MOVE      MRTRECKY,DIM10
          PACK      KEY20,DIM10,SP70
          CALL      RSMRRQD1
          CALL      RKMRRQD1
          IF        OVRCD=0
            MATCH     DIM10,MRRDRQNO
            GOTO      RQBULK25 IF EQUAL
          ENDIF
.
          PACK      KEY10,DIM10,SP70
          CALL      RDMRRQH1
          IF        OVRCD=0
            CALL      DEMRRQH1
          ENDIF
.
RQBULK25  MOVE      ZERO,EXIT
          GOTO      RQBULK99
.   
. *************** Display **********************
.
RQBULK50  PACK      KEY20,MRTRECKY,SP70
          CALL      RDMRRQD1
.
          PACK      KEY10,MRRDRQNO,SP70
          CALL      RDMRRQH1
.
          APPEND    "Medical Record Bulk Request",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,RQBULK99
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      RQBULK99
.
RQBULK90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RQBULK99
.
RQBULK91  MOVE      "Request Complete",WEBTITLE
          CALL      ERLST200
          MOVE      ONE,EXIT
.         CALL      WINALT00
          GOTO      RQBULK99
.
RQBULK92  MOVE      "No Record Selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RQBULK99
.
RQBULK93  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RQBULK99
.
RQBULK99  RETURN
.-----------------------------------------------------------
. Sets up array for bulk requests
.-----------------------------------------------------------
SETAR000  MOVE      ZERO,MRCOUNT
          MOVE      ZERO,COUNT
.
SETAR100  ADD       ONE,MRCOUNT
          ADD       ONE,COUNT
          IF        MRCOUNT>MRKEYCNT
            SUB        ONE,COUNT 
            GOTO       SETAR999
          ENDIF
.
          PACK      RECORDKY[COUNT],SP70          * Clear
          MATCH     SP70,MRKEYARR[MRCOUNT]  
          GOTO      SETAR100 IF EQUAL
.
          REP       "+ ",MRKEYARR[MRCOUNT]
.
          UNPACK    SP70,KEYHOS,KEY8,KEY4,KEY3,KEY2
          UNPACK    MRKEYARR[MRCOUNT],KEY8,KEYHOS,KEY4,KEY3,KEY2      *C-240724
.
. "99" is a flag set from BSP that indicates that ALL medical Records for  
. that patient                                               
.
          COMPARE   "99",VOLUMENU[MRCOUNT]
          GOTO      SETAR900 IF NOT EQUAL

          SUB       ONE,COUNT
          PACK      KEY20,KEY8,Z70
          CALL      RSMRMAS3
SETAR800  CALL      RPMRMAS3
          BRANCH    OVRCD,SETAR100 
.
          MATCH     KEY8,MRMAURNO         * Matches on UR No
          GOTO      SETAR100 IF NOT EQUAL 
.
          MATCH     KEY3,MRMADOTY         * Matches on document type
          GOTO      SETAR800 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,MRMAHHOS
            GOTO      SETAR800 IF NOT EQUAL
          ENDIF          
.
          ADD       ONE,COUNT 
.
..          MATCH     MRCNSTAT,MRMASTAT     * Only active records
..          GOTO      SETAR800 IF NOT EQUAL
.
          PACK      RECORDKY[COUNT],MRMAKEY,SP70   
          GOTO      SETAR800       
.
SETAR900  PACK      KEY20,KEY8,KEYHOS,KEY4,KEY3,VOLUMENU[MRCOUNT]     *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,SETAR100
          PACK      RECORDKY[COUNT],MRMAKEY,SP70  * Key to Medical Record 
          GOTO      SETAR100
.
SETAR999  MOVE      COUNT,MRKEYCNT
          RETURN 
.------------------------------------------------------------
. Medical Record Request.
.------------------------------------------------------------
MDRCRQ00  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MDRCRQ90
.
          MOVE      PURNO,KEY8      * Read PMI Extension Table
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "R",UPDATETY
          GOTO      MDRCRQ10 IF EQUAL
.
          GOTO      MDRCRQ30
.   
. ************* Medical Request **************
.
MDRCRQ10  COMPARE   ZERO,MRKEYCNT
          GOTO      MDRCRQ91 IF EQUAL
.
          CALL      MRCLR000            * Clear/Init working variables 
          CALL      CHKCOD00            * Check Stationary Code
          BRANCH    EXIT,MDRCRQ99
.
          CALL      SETPRT00            * Set up Printer
          BRANCH    EXIT,MDRCRQ99
.
          CALL      MRWRT000            * Loop through UR's and save Requests
.
          COMPARE   ZERO,ERRORCNT       
          IF        !@EQUAL
            CALL      ERRLST00          * Display Error in javascript alert
            BRANCH    EXIT,MDRCRQ99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MDRCRQ99
.   
. *************** Display **********************
.
MDRCRQ30  CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    "(Medical Record Request Form)",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,MDRCRQ99
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      MDRCRQ99
.
MDRCRQ90  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MDRCRQ99
.
MDRCRQ91  MOVE      "No Record Selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MDRCRQ99
.
MDRCRQ99  RETURN  
.------------------------------------------------------------
. READFIL0   used to read files for printing                            
.------------------------------------------------------------
READFIL0  PACK      KEY10,MRRDRKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,READFIL9
.
          PACK      KEY26,MRRDRKEY,Z70
          CALL      RSMRHIS1  
          CALL      RPMRHIS1
          BRANCH    OVRCD,READFIL9
.
          MATCH     MRHIKEY,MRRDRKEY
          IF        !@EQUAL
            CALL      CLMRTHIS              * clear MRT History record
          ENDIF
.
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,READFIL9
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
READFIL9  RETURN
.------------------------------------------------------------
. MRCLR000  (from MECRECRQ)                            
. Clear all input variables            
.------------------------------------------------------------
MRCLR000  MOVE      SP70,MRRQRQNO
          MOVE      SP70,MRRQDTRQ
          MOVE      SP70,MRRQTMRQ
          MOVE      SP70,MRRQLOCR
          MOVE      SP70,MRRQPERS
          MOVE      SP70,MRRQMOVR
          MOVE      SP70,MRRQURGY
          MOVE      SP70,MRRQEXTN
          MOVE      SP70,MRRQCOMM
          MOVE      SP70,MRRQHOSC
          MOVE      SP70,MRRQDAYE
          MOVE      SP70,MRRQTIYM
          MOVE      SP70,MRRQUSID
          MOVE      SP70,MRRQDTUP
          MOVE      SP70,MRRQTMUP
          MOVE      SP70,MRRQUSUP
          MOVE      SP70,MRRQEXTN
          MOVE      SP70,MRRQPAGE
          MOVE      SP70,MRRQTRIG
          MOVE      SP70,MRRQSPAE
.
          MOVE      SP70,MRRDRQNO
          MOVE      SP70,MRRDRKEY
          MOVE      SP70,MRRDFILL
          MOVE      SP70,MRRDFUID
.
MRCLR999  RETURN
.------------------------------------------------------------
. Check Stationary Code
.------------------------------------------------------------
CHKCOD00  MOVE      ZERO,EXIT                     * initialize exit flag
.
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70                       *C-240724
          CALL      RDMRLOC1                   * Read locations file
          BRANCH    OVRCD,CHKCOD10
.
.         Check if stationary code exists for that location
.
          MATCH     SP70,MRLOSTCD
          IF        !@EQUAL
            MOVE      MRLOSTCD,STATCODE
            GOTO      CHKCOD20
          ENDIF
.
.         Use system parameter if stationary code
.         does not exist for that location
.
CHKCOD10  MOVE      PTCNUCOD,STATCODE
.
CHKCOD20  MOVE      STATCODE,KEY6
          CALL      RDIBTH1
          COMPARE   ONE,OVRCD
          GOTO      CHKCOD99 IF NOT EQUAL         * On file ?
.
          MOVE      "Stationery Code not on File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                      * Stat. code not on file
.
CHKCOD99  RETURN
.
.------------------------------------------------------------
. Set up Printer
.------------------------------------------------------------
SETPRT00  PACK      KEY7,MEDRR010,MEDRR006,SP70                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,SETPRT90
.
          MOVE      MRLOPRNT,SELPRINT        * Location Printer for Med Rec
          GOTO      SETPRT99
.
SETPRT90  MOVE      PTCNMRPN,SELPRINT        * Defualt Printer 
.
SETPRT99  RETURN
.
.------------------------------------------------------------
. Set up printer from the request location
.------------------------------------------------------------
SETP0000  PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,SETP9000
.
          MOVE      MRLOPRNT,SELPRINT        * Location Printer for Med Rec
          GOTO      SETP9999
.
SETP9000  MOVE      PTCNMRPN,SELPRINT        * Defualt Printer
.
SETP9999  RETURN
.
.------------------------------------------------------------
. Set up Bulk Request Printer
.------------------------------------------------------------
SETB0000  PACK      KEY7,MEDRR010,MEDRR006,SP70                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,SETB9000
.
          MOVE      MRLOBPRN,SELPRINT        * Bulk Request Printer
          GOTO      SETB9999
.
SETB9000  MOVE      PTCNMRPN,SELPRINT        * Default Printer
.
SETB9999  RETURN
.
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD80
.
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      RCRQ0000                * Record Request Details
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      RCRQ0000                * Record Request Details
          GOTO      PROFLD99
.
PROFLD23  CALL      MFIL0000                * Request Filled List
          GOTO      PROFLD99
.
PROFLD30  GOTO      PROFLD99 
.
PROFLD40  CALL      RCRQ0000                * Record Request Details
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53
.
PROFLD51  CALL      BKRS0000                * Bulk Requests Reservations
          GOTO      PROFLD99
.
PROFLD52  CALL      RCRQ0000                * Record Request Details
          GOTO      PROFLD99
.
PROFLD53  CALL      MFIL0000                * Request Filled List
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
.
PROFLD81  CALL      RTAG0000                * Receive Records Tags
          GOTO      PROFLD99
.
PROFLD82  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
.  Bulk Record Request Reservations
.------------------------------------------------------------
BKRS0000  BRANCH    FLDITMNO,BKRS0100,BKRS0200,BKRS0300,BKRS0400,BKRS0500:
                             BKRS0600,BKRS0700,BKRS0800,BKRS0900,BKRS1000:
                             BKRS1100,BKRS1200
          GOTO      BKRS9999
.
BKRS0100  WRITE     HTMLFILE;MRBRRQNM;   * Request No
          GOTO      BKRS9999
.
BKRS0200  UNPACK    MRBRDTRI,CCENT,CYEAR,CMON,CDAY   * Required Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11; 
          GOTO      BKRS9999
.
BKRS0300  WRITE     HTMLFILE;MRBRTMRI;   * Required Time
          GOTO      BKRS9999
.
BKRS0400  UNPACK    MRBRDTRE,CCENT,CYEAR,CMON,CDAY   * Requested Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11; 
          GOTO      BKRS9999
.
BKRS0500  WRITE     HTMLFILE;MRBRTMRE;   * Requested Time
          GOTO      BKRS9999
.
BKRS0600  PACK      KEY7,MRBRRHOS,MRBRLOCA,SP70   * Location required *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,BKRS9999
          WRITE     HTMLFILE;MRLODESC
          GOTO      BKRS9999
.
BKRS0700  WRITE     HTMLFILE;MRBRNUMR;   * No. Records Requested
          GOTO      BKRS9999
.
BKRS0800  WRITE     HTMLFILE;MRBRREQS;   * Person Requesting Record
          GOTO      BKRS9999
.
BKRS0900  WRITE     HTMLFILE;MRBRPHON;   * Requestor Phone
          GOTO      BKRS9999
.
BKRS1000  WRITE     HTMLFILE;MRBRPAGR;   * Requestor Pager No
          GOTO      BKRS9999
.
BKRS1100  CALL      BKRES000  * Bulk Requests Reservation Filled List
          GOTO      BKRS9999
.
BKRS1200  CALL      BKLAB000  * Bulk Requests label print
          GOTO      BKRS9999
.
BKRS9999  RETURN
.------------------------------------------------------------
.  Record Request Details
.------------------------------------------------------------
RCRQ0000  BRANCH    FLDITMNO,RCRQ0100,RCRQ0200,RCRQ0300,RCRQ0400,RCRQ0500:
                             RCRQ0600,RCRQ0700,RCRQ0800,RCRQ0900,RCRQ1000:
                             RCRQ1100,RCRQ1200,RCRQ1300,RCRQ1400,RCRQ1500:
                             RCRQ1600,RCRQ1700,RCRQ1800,RCRQ1900,RCRQ2000:
                             RCRQ2100,RCRQ2200,RCRQ2300,RCRQ2400,RCRQ2500:
                             RCRQ2600,RCRQ2700,RCRQ2800,RCRQ2900,RCRQ3000:
                             RCRQ3100,RCRQ3200,RCRQ3300,RCRQ3400,RCRQ3500:
                             RCRQ3600,RCRQ3700,RCRQ3800,RCRQ3900,RCRQ4000:
                             RCRQ4100,RCRQ4200,RCRQ4300,RCRQ4400
          GOTO      RCRQ9999
.
RCRQ0100  MOVE      "QU",CATEGORY
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ0200  MOVE      "QR",CATEGORY
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ0300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,RCRQ0350
.
          PACK      KEY7,SP70                                         *C-240724
          CALL      RDMRLOC1
RCRQ0310  CALL      RKMRLOC1
          BRANCH    OVRCD,RCRQ9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ0310
          ENDIF
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,LOCATION
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ0310 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ0310
.
RCRQ0350  PACK      KEY37,SP70                                        *C-240724
          CALL      RDMRLOC3
RCRQ0360  CALL      RKMRLOC3
          BRANCH    OVRCD,RCRQ9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ0360
          ENDIF
          PACK      KEY15,QUOTE,MRLOCODE,QUOTE
          MATCH     MRLOCODE,LOCATION
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15,"selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ0360 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ0360
.
RCRQ0400  MOVE      WBSEHOSP,SELHOSP        * Hospital selection list
          CALL      HSEL0000
          GOTO      RCRQ9999
.
RCRQ0500  CALL      STCOD000                * Stationary Code's
          GOTO      RCRQ9999
.
RCRQ0600  RESET     MEDRR001
          MATCH     SP70,MEDRR001
          IF        @EQUAL
            MOVE      "TY",CATEGORY           * Selection List of Documents
            MOVE      MRCNRCTY,CODE           * System Parameter default type
.
            MATCH     SP70,WBSEDTYP
            IF        !@EQUAL
              MOVE      WBSEDTYP,CODE
            ELSE
              IF        IBCNMHOS=1
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSRCTY
                  IF        !@EQUAL
                    MOVE      PTHSRCTY,CODE
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            MOVE      CODE,MEDRR001           * populate cgi with default
.
            CALL      CODITM00
          ELSE
            MOVE      "TY",CATEGORY           * Selection List of Documents
            MOVE      MEDRR001,CODE
            CALL      CODITM00
          ENDIF
          GOTO      RCRQ9999
.
RCRQ0700  WRITE     HTMLFILE;WBSENAM;       * User Name        
          GOTO      RCRQ9999
.
RCRQ0800  CALL      MOVREA00                * Selection List of Reasons
          GOTO      RCRQ9999
.
RCRQ0900  CALL      MASTB000                * Table of Locations
          GOTO      RCRQ9999
.
RCRQ1000  UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY   * Request Date 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY12;
          GOTO      RCRQ9999
.
RCRQ1100  WRITE     HTMLFILE;MRRQTMRQ;      * Request Time
          GOTO      RCRQ9999
.
RCRQ1200  PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70  * Request Location   *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,RCRQ9999
          WRITE     HTMLFILE;MRLODESC;
          GOTO      RCRQ9999
.
RCRQ1300  MATCH     "Y",MRRDFILL
          IF        @EQUAL
            WRITE     HTMLFILE;"Filled";
          ELSE
            MATCH     "N",MRRDFILL
            IF        @EQUAL
              WRITE     HTMLFILE;"Not Filled";
            ELSE
              MATCH     "C",MRRDFILL
              IF        @EQUAL
                WRITE     HTMLFILE;"Cancelled";
              ELSE
                WRITE     HTMLFILE;"Processing";
              ENDIF
            ENDIF
          ENDIF
          GOTO      RCRQ9999
.            
RCRQ1400  MOVE      SP70,MRMODESC
          MOVE      MRRQMOVR,KEY4
          CALL      RDMRMOV1
          WRITE     HTMLFILE;MRMODESC;
          GOTO      RCRQ9999
.
RCRQ1500  PACK      KEY20,MRRDRQNO,MRRDRKEY,SP70
          WRITE     HTMLFILE;KEY20;
          GOTO      RCRQ9999
.
RCRQ1600  MOVE      MRCNHLOC,DFLTHLOC            *  Move Control File
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHLOC,DFLTHLOC
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,RCRQ1609
.
              MATCH     SP70,PTHSHLOC
              IF        !@EQUAL
                MOVE      PTHSHLOC,DFLTHLOC
              ENDIF
            ENDIF
          ENDIF
.
RCRQ1609  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
          CALL      RDMRLOC1
RCRQ1610  CALL      RKMRLOC1
          BRANCH    OVRCD,RCRQ9999
.
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ1610
          ENDIF
.
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      RCRQ1610 IF NOT EQUAL
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,DFLTHLOC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ1610 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ1610
.
RCRQ1700  CALL      EXTURS00                * Output extracted UR's 
          GOTO      RCRQ9999
.
RCRQ1800  WRITE     HTMLFILE;EXTRCTID;      * Extract ID          
          GOTO      RCRQ9999
.
RCRQ1900  WRITE     HTMLFILE;PTCNRQCF;      * Free Format for Requested Para
          GOTO      RCRQ9999
.
RCRQ2000  MOVE      SP70,STAFFKEY           * Set Staff Key
          CALL      STFLST00                * Selection List of Mrt Staff
          GOTO      RCRQ9999
.
RCRQ2100  CALL      PTDETA00           * Output Patient Details   
          GOTO      RCRQ9999
.
RCRQ2200  PACK      KEY7,SP70      * Displays list of Home Locations  *C-240724
          CALL      RDMRLOC1
RCRQ2210  CALL      RKMRLOC1
          BRANCH    OVRCD,RCRQ9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ2210
          ENDIF
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      RCRQ2210 IF NOT EQUAL
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,HOMELOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ2210 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ2210
.
RCRQ2300  RESET     DOCUTYPE
          MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      DOCUTYPE,CODE
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ2400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,RCRQ2450
.
          PACK      KEY7,SP70                                         *C-240724
          CALL      RDMRLOC1
RCRQ2410  CALL      RKMRLOC1
          BRANCH    OVRCD,RCRQ9999
.
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ2410
          ENDIF
.
          PACK      KEY15,QUOTE,MRLOCODE,SP5,QUOTE
          MATCH     MRLOCODE,MRRQLOCR
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15," selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ2410 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ2410
.
RCRQ2450  PACK      KEY34,SP70
          CALL      RDMRLOC3
RCRQ2460  CALL      RKMRLOC3
          BRANCH    OVRCD,RCRQ9999
          COMPARE   MRLOSTAT,ONE
          IF        @EQUAL
            GOTO      RCRQ2460
          ENDIF
          PACK      KEY15,QUOTE,MRLOCODE,QUOTE
          MATCH     MRLOCODE,MRRQLOCR
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY15,"selected>":
                               MRLODESC,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      RCRQ2460 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY15,">",MRLODESC,"</option>"
          ENDIF
          GOTO      RCRQ2460
.
RCRQ2500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1   * Bulk Reasons Flag
.
          PACK      KEY4,SP70               * Selection List of Resions
          CALL      RSMRMOV1
RCRQ2510  CALL      RKMRMOV1
          BRANCH    OVRCD,RCRQ9999
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      RCRQ2510 IF EQUAL
.
          IF        F1 = ONE
            COMPARE   TWO,MRMOUSAG
            GOTO      RCRQ2510 IF NOT EQUAL
          ENDIF
.
          PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          MATCH     MRRQMOVR,MRMOREAS
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected >":
                               MRMODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          ENDIF
          GOTO      RCRQ2510
.
RCRQ2600  CALL      REQTB000                * Table of Locations
          GOTO      RCRQ9999
.
RCRQ2700  MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      MEDRR001,CODE
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ2800  MOVE      "TY",CATEGORY           * Selection List of Documents
          UNPACK    MRTRECKY,KEY10A,KEY10 
          CALL      RDMRMAS2                * to get UR
          IF        OVRCD=0
            MOVE      MRMADOTY,CODE
          ELSE
            MOVE      MEDRR001,CODE
          ENDIF
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ2900  MOVE      "QU",CATEGORY
          MOVE      MRRQURGY,CODE
          CALL      CODITM00
          GOTO      RCRQ9999
.
RCRQ3000  MOVE      "QU",CATEGORY
          MOVE      URGENCYR,CODE
          CALL      CODITM00
          GOTO      RCRQ9999
.
.
RCRQ3100  MOVE      FILTHOSP,SELHOSP        * Hospital ID's with filter
          CALL      HSEL0000              
          GOTO      RCRQ9999
.
.....                      this should now be obsolete                *?-240724
RCRQ3200  PACK      KEY37,SP70              * location list (relies on FILTHOSP)
          CALL      RDMRLOC3
RCRQ3210  CALL      RKMRLOC3
          BRANCH    OVRCD,RCRQ9999
.
          COMPARE   MRLOSTAT,ONE
          GOTO      RCRQ3210 IF EQUAL
.
          IF        IBCNMHOS=1    
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,MRLOHOSP
              GOTO      RCRQ3210 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70            * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD = 1
                PACK      KEY13,USERID,MRLOHOSP,SP70 * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,RCRQ3210
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#"";
          MATCH     MRLOCODE,LOCATION
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",MRLODESC,"</option>"
          GOTO      RCRQ3210
.
RCRQ3300  PACK      STAFFKEY,WBSEUID,SP70
          CALL      STFLST00
          GOTO      RCRQ9999
.
.                                                    * new routine    *I-240724
RCRQ3400  UNPACK    SP30,DFLTHOSP,DFLTHHOS  * set Defaults for single Hos.Locn.
          MOVE      MRCNHLOC,DFLTHLOC   
.         
.         Check if the user has Home Hospital &/or Location, if so, set Defaults
.         Otherwise, check if Multi Hospital exists then Read Hospital file
.         and use Home Hospital and Home Location.
.         
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHHOS,DFLTHOSP
            MOVE      WBSEHLOC,DFLTHLOC
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,RCRQ3405
.
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DFLTHOSP
                MOVE      PTHSHLOC,DFLTHLOC
              ENDIF
            ENDIF
          ENDIF
.                                           * set memory for Filter Hosp & Locn
          MATCH     SP3,FILTHHOS
          IF        !@EQUAL
            MOVE      FILTHHOS,DFLTHHOS
          ENDIF
          MATCH     SP3,FILTHOSP
          IF        !@EQUAL
            MOVE      FILTHOSP,DFLTHOSP
          ENDIF
          MATCH     SP4,FILTLOCN
          IF        !@EQUAL
            MOVE      FILTLOCN,DFLTHLOC
          ENDIF
.
RCRQ3405  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RCRQ3406,RCRQ3407,RCRQ3408
          WRITE     HTMLFILE;DFLTHOSP;      * Home Hospital Id Code
          GOTO      RCRQ9999
RCRQ3406  WRITE     HTMLFILE;DFLTHLOC;      * Home Location Code
          GOTO      RCRQ9999
RCRQ3407  WRITE     HTMLFILE;DFLTHHOS;      * Home Hospital Code
          GOTO      RCRQ9999
RCRQ3408  MATCH     "1",SHOWFLAG
          IF        @EQUAL
.           MATCH     SP70,WBSEHLOC
.           IF        !@EQUAL
              MOVE      FILTLOCN,DFLTHLOC
.           ENDIF
          ENDIF,
.
          IF        ALLDFLAG=1
            MOVE     SP70,DFLTHLOC          * Detailt to all from menu option
          ENDIF
.
          WRITE     HTMLFILE;DFLTHLOC;      * Home Location Code
          GOTO      RCRQ9999
.
RCRQ3500  WRITE     HTMLFILE;SUPERLEV;      * Supervisor flag         *I-240724
          GOTO      RCRQ9999
.
RCRQ3600  UNPACK    DIM127,D1,KEY1,DIM127                             *I-240724
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        F1 = 0
            WRITE     HTMLFILE;MRRQHOSC;    * Destination Hospital Code
          ELSE
            WRITE     HTMLFILE;MRRQLOCR;    * Destination Location Code
          ENDIF
          GOTO      RCRQ9999
.
RCRQ3700  MOVE      MRRQHOSC,SELHOSP        * Hospital Pull-down with selection
          CALL      HSEL0000              
          GOTO      RCRQ9999
.
.                                           * Research Extract Hospital
RCRQ3800  UNPACK    DIM127,D1,KEY1,DIM127                             *I-240724
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          UNPACK    SP70,MRRXHOSP,MRRXEXID
          PACK      KEY4,EXTRCTID,SP10
          CALL      RDMRREX1                * read Extract record
.
          BRANCH    F1,RCRQ3810,RCRQ3820
.
          WRITE     HTMLFILE;MRRXHOSP;      * select Researched Hospital Id
          GOTO      RCRQ9999
.
RCRQ3810  UNPACK    SP70,PTHSHLOC           * using ".1"
          PACK      KEY3,MRRXHOSP
          CALL      RDPTHSP1
          WRITE     HTMLFILE;PTHSHLOC;      * default location
          GOTO      RCRQ9999
.
RCRQ3820  MOVE      MRRXHOSP,SELHOSP        * Hospital Pull-down with selection
          CALL      HSEL0000              
          GOTO      RCRQ9999
.
RCRQ3900  MATCH     SP3,FILTHHOS            * List hospitals
          IF        @EQUAL
            MOVE      DFLTHHOS,FILTHHOS     * prime for first time
          ENDIF
          MOVE      FILTHHOS,SELHOSP
          CALL      HSEL0000
.
          MATCH     SP70,FILTHHOS
          IF        @EQUAL
            PACK      FILTHHOS,SELHOSP,SP70 * Populate if default was used
          ENDIF
          GOTO      RCRQ9999
.
RCRQ4000 
....      MATCH     "1",SHOWFLAG
....      IF        @EQUAL
            MOVE      ONE,NODEFHOS           * Default hospital if blank
....      ELSE
....        MOVE      ZERO,NODEFHOS           * Default hospital if blank
....        MATCH     SP3,FILTHOSP            * List All hosp.
....        IF        @EQUAL
....          MOVE      DFLTHOSP,FILTHOSP     * prime for first time
....        ENDIF
....      ENDIF
.
          MOVE      FILTHOSP,SELHOSP
          CALL      HSAL0000
          GOTO      RCRQ9999
.
RCRQ4100  WRITE     HTMLFILE;FILTLOCN;      * Set Filter Location
          GOTO      RCRQ9999
.
RCRQ4200  WRITE     HTMLFILE;DOCTYFLG;      * Document Type Flag
          GOTO      RCRQ9999
.
RCRQ4300  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          MOVE      PTHSHHOS,SELHOSP        * 
          CALL      HSEL0000
          GOTO      RCRQ9999
.
RCRQ4400  WRITE     HTMLFILE;FILTHHOS;
          GOTO      RCRQ9999
.
RCRQ9999  RETURN 
.----------------------------------------------------------------
. Output Patient Details
.----------------------------------------------------------------
PTDETA00  PACK      KEY10,MRRDRKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,PTDETA99
.
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PTDETA99
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAA00
          WRITE     HTMLFILE;PURNO,SP1,"-",SP1,PATFNAME;
.
PTDETA99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of MRT Staff
.                   ******** STFLST00 ********
.----------------------------------------------------------------
STFLST00  PACK      KEY6,SP70
.         PACK      KEY6,STAFFKEY,SP70
          CALL      RSMRSTF1
STFLST10  CALL      RKMRSTF1
          BRANCH    OVRCD,STFLST99
.
          COMPARE   MRSTSTAT,ONE    * Checks for Active Staff only
          IF        @EQUAL
            GOTO      STFLST10
          ENDIF
.
          PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
.
          MATCH     STAFFKEY,MRSTCODE    * Default Staff Code
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#" selected>":
                                 KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#">":
                                 KEY50,"</option>"
          ENDIF
.
          GOTO    STFLST10
.
STFLST99  RETURN
.------------------------------------------------------------------
.  Output Extracted UR's
.------------------------------------------------------------------
EXTURS00  MOVE      SP70,SORTORDR 
.
          PACK      KEY20,EXTRCTID,SP70
          CALL      RSMRED3
EXTURS10  CALL      RKMRED3
          BRANCH    OVRCD,EXTURS99
.
          MATCH     EXTRCTID,MREDEID      * Check Extract ID?
          GOTO      EXTURS99 IF NOT EQUAL
.
          MATCH     "1",MREDDEL   a       * Flagged as deleted
          GOTO      EXTURS10 IF EQUAL   
.
          MATCH     MREDTDIG,SORTORDR     * UR already output read next!
          GOTO      EXTURS10 IF EQUAL 
.
          WRITE     HTMLFILE;MREDURNO,",";
.
          MOVE      MREDTDIG,SORTORDR 
          GOTO      EXTURS10
.
EXTURS99  RETURN
.------------------------------------------------------------------
.            Selection List of Movment Reasons
. Parameters .1=Bulk Request Reasons
.------------------------------------------------------------------
MOVREA00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1   * Bulk Reasons Flag
.
          PACK      KEY4,SP70               * Selection List of Resions
          CALL      RSMRMOV1
MOVREA10  CALL      RKMRMOV1
          BRANCH    OVRCD,MOVREA99
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      MOVREA10 IF EQUAL
.
          IF        F1 = ONE
            COMPARE   TWO,MRMOUSAG   
            GOTO      MOVREA10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          GOTO      MOVREA10
.
MOVREA99  RETURN
.------------------------------------------------------------
. Hospital Selection                the best way
.------------------------------------------------------------
HSEL0000  COMPARE   ONE,IBCNMHOS
          GOTO      HSEL9999 IF NOT EQUAL
.
          MOVE      SP10,WBSEHOSP   
          PACK      KEY10,USERID,SP10
          CALL      RDWBSE1                 * get User's Hospital (default)
.
          MATCH     "1",SHOWFLAG
          IF        !@EQUAL
            MATCH     SP3,SELHOSP
            IF        @EQUAL
              MOVE      WBSEHOSP,SELHOSP    * set default hospital
            ENDIF
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999   
.
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            PACK      KEY13,USERID,SP70     * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD = 1
              PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
              CALL      RDMLSEC1
              IF        OVRCD = 1
                MATCH     SELHOSP,PTHSHOSP    * Default Hospital
                GOTO      HSEL0150 IF EQUAL
                GOTO      HSEL0100
              ENDIF
            ENDIF
          ELSE                                * ordinary User selections
            MATCH     SELHOSP,PTHSHOSP
            GOTO      HSEL0150 IF EQUAL
            MATCH     WBSEHOSP,PTHSHOSP
            GOTO      HSEL0150 IF EQUAL
            GOTO      HSEL0100
          ENDIF
.
HSEL0150  MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
.
HSEL9999  RETURN
.------------------------------------------------------------
. Hospital Selection of All Hospitals with User default
.------------------------------------------------------------
HSAL0000  COMPARE   ONE,IBCNMHOS
          GOTO      HSAL9999 IF NOT EQUAL
.
          MOVE      SP10,WBSEHOSP
          PACK      KEY10,USERID,SP10
          CALL      RDWBSE1                 * get User's Hospital (default)
.
          MATCH     "1",NODEFHOS
          IF        !@EQUAL
            MATCH     SP3,SELHOSP
            IF        @EQUAL
              MOVE      WBSEHOSP,SELHOSP
            ENDIF
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSAL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSAL9999
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSAL0100
.
HSAL9999  RETURN
.------------------------------------------------------------
. Stationary Code's
.------------------------------------------------------------
STCOD000  MOVE      ZERO,KEY6
          CALL      RSIBTH1      
STCOD010  CALL      RKIBTH1
          BRANCH    OVRCD,STCOD999
.
          MATCH     "  4",IBTHSTYP           * Stationary Type 4 is med rec req.
          GOTO      STCOD010 IF NOT EQUAL  
.
          MATCH     PTCNUCOD,IBTHSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#" selected>":
                               IBTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">",IBTHDESC:
                               "</option>"
          ENDIF 
          GOTO      STCOD010
.
STCOD999  RETURN 
.------------------------------------------------------------
. Medical Records Request Lists by Date
.------------------------------------------------------------
MRTLST00  CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.          
          RESET     UPDATETY
          MATCH     SP1,UPDATETY
          GOTO      MRTLST50 IF EQUAL
.
          MATCH     "P",UPDATETY            * Print Request  
          GOTO      MRTLST10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Request  
          GOTO      MRTLST20 IF EQUAL
.
          MATCH     "F",UPDATETY            * Update Request and Fill
          GOTO      MRTLST30 IF EQUAL
.
          MATCH     "T",UPDATETY            * Bulk transfer requests to today
          GOTO      MRTLST40 IF EQUAL
.
          GOTO      MRTLST93
.
.         ************* PRINT FORMACTION ***********
.
MRTLST10  CALL      MRCLR000          * Clears all variables in requests
.
          PACK      KEY10,MRTPT001,SP70            * Request Header File
          CALL      RDMRRQH1
          BRANCH    OVRCD,MRTLST94
. 
          PACK      KEY20,MRTPT001,MRTPT002,SP70   * Request Detail File
          CALL      RDMRRQD1
          BRANCH    OVRCD,MRTLST94
.
          PACK      KEY8,URNUMBER,SP70             * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MRTLST95
.
          MOVE      PURNO,KEY8      * Read PMI Extension Table
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CHKCOD00
          BRANCH    EXIT,MRTLST99
.
          CALL      SETP0000
.
          MOVE      MRTPT002,MRRDRKEY   * Set Medical Record Key for READFIL0
          CALL      READFIL0            * Read files for print routine.  
.
          CALL      OPNPRINT            * open print
          CALL      MRPRN000            * Print Request Details
          CALL      CLSPRINT            * close print
.
          MOVE      ZERO,EXIT
          GOTO      MRTLST99
.
.         ************* Update FORMACTION ***********
.
MRTLST20  PACK      KEY10,MRTPT001,SP70     * Request Header File
          CALL      RDMRRQH1
          BRANCH    OVRCD,MRTLST94
.
          MOVE      USERID,MRRQUSUP                                   *I-101489
          PACK      MRRQAUDD,CCC,CYY,CMM,CDD
          REP       " 0",MRRQAUDD
          CLOCK     TIME,MRRQAUDT
          MOVE      ANSB,MRRQAUDR
          CALL      ARMRRQH                 * Write change audit history record
.
          MATCH     SP70,MEDRR004
          IF        !@EQUAL
            MOVE      MEDRR004,MRRQDTRQ     * Date Required is Mandatory
          ENDIF
.
          MATCH     SP70,MEDRR005
          IF        !@EQUAL
            MOVE      MEDRR005,MRRQTMRQ     * Time Required is Mandatory
          ENDIF
.
          MATCH     SP70,MEDRR008
          IF        !@EQUAL
            MOVE      MEDRR008,MRRQURGY     * Urgency
          ENDIF
.
          MATCH     SP70,MEDRR009
          IF        !@EQUAL
            MOVE      MEDRR009,MRRQCOMM     * Request Comment
          ENDIF
.
          CLOCK     TIME,MRRQTMUP
          PACK      MRRQDTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          CALL      UPMRRQH1
.
          PACK      KEY10,MRTPT001,SP70  * Bulk Header File
          CALL      RDMRBRH1 
          BRANCH    OVRCD,MRTLST25
.
          MATCH     SP70,MEDRR004
          IF        !@EQUAL
            MOVE      MEDRR004,MRBRDTRI  * Date Required is Mandatory
          ENDIF
.
          MATCH     SP70,MEDRR005
          IF        !@EQUAL
            MOVE      MEDRR005,MRBRTMRI  * Time Required is Mandatory
          ENDIF
.
          CALL      UPMRBRH1
.
MRTLST25  MOVE      ZERO,EXIT
          GOTO      MRTLST99
.
.         ************* Update and Fill Formaction ***********
.
MRTLST30  PACK      KEY10,MRTPT001,SP70            * Request Header File
          CALL      RDMRRQH1
          BRANCH    OVRCD,MRTLST94
.
          MOVE      MEDRR002,MRRQPERS
          MOVE      MEDRR003,MRRQMOVR
          MOVE      MEDRR006,MRRQLOCR
          MOVE      MEDRR007,MRRQEXTN
          MOVE      MEDRR008,MRRQURGY
          MOVE      MEDRR009,MRRQCOMM
          MOVE      MEDRR010,MRRQHOSC
          MOVE      MEDRR011,MRRQPAGE
          MOVE      MEDRR012,HOMEHOSP                                 *I-240724
          MOVE      MEDRR013,HOMELOCN                                 *I-240724
.
          CLOCK     TIME,MRRQTMUP
          PACK      MRRQDTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          CALL      UPMRRQH1
.
          MATCH     "1",MRCNREQC     * Copy request comments to movement
          IF        @EQUAL
            MATCH     SP70,MVMTCOMM
            IF        @EQUAL
              MOVE      MRRQCOMM,MVMTCOMM
            ENDIF
          ENDIF
.
          CALL      MRFIL000            * Loop through mr and save Requests
.
          COMPARE   ZERO,ERRORCNT
          IF        !@EQUAL
            CALL      ERRLST00          * Display Error in javascript alert
            BRANCH    EXIT,MRTLST99
          ENDIF
.
MRTLST35  MOVE      ZERO,EXIT
          GOTO      MRTLST99
.
.         ************ Bulk Transfer Requests to Today FORMACTION **********
.
MRTLST40  CALL      BTRN0000                * Transfer requests to doday
.
          MOVE      ZERO,EXIT
          GOTO      MRTLST99
.
.         ************ DISPLAY FORMACTION **********
.
MRTLST50  PACK      KEY10,MRTRECKY,SP70
          CALL      RDMRRQH1
.
          PACK      KEY20,MRTRECKY,SP70
          CALL      RDMRRQD1
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     " ",FILLEDRC
          IF        @EQUAL
            MOVE      "N",FILLEDRC
          ENDIF
.
          MOVE      "Medical Records Request Filled List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MRTLST99
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      MRTLST99
.
MRTLST93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLST99
.
MRTLST94  MOVE      "Invalid Request Information",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLST99
.
MRTLST95  MOVE      "Patient Master Details dont exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTLST99
.
MRTLST99  RETURN
.------------------------------------------------------------
. Bulk transfer all unfilled requests to today
.------------------------------------------------------------
BTRN0000  PACK      KEY23,LASTDATE,SP70            * Request Header By Date
          CALL      RSMRRQH2
BTRN1000  CALL      RKMRRQH2
          BRANCH    OVRCD,BTRN9999
.
          MATCH     MRRQDTRQ,LASTDATE
          GOTO      BTRN9999 IF LESS
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP           * Requesting hospital
            IF        !@EQUAL
              MATCH     FILTHOSP,MRRQHOSC
              GOTO      BTRN1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY20,MRRQRQNO,SP70
          CALL      RSMRRQD1
BTRN2000  CALL      RKMRRQD1
          BRANCH    OVRCD,BTRN1000
.
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      BTRN1000 IF NOT EQUAL
.
          MATCH     ANSN,MRRDFILL                * Skip if status is not new
          GOTO      BTRN2000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            PACK      KEY10,MRRDRKEY,SP70
            CALL      RDMRMAS2
            BRANCH    OVRCD,BTRN2000
.
            MATCH     SP3,FILTHHOS               * Home hospital
            IF        !@EQUAL
              MATCH     FILTHHOS,MRMAHHOS
              GOTO      BTRN2000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      SAVKEY23,MRRQDTRQ,MRRQTMRQ,MRRQRQNO,SP70
.
          MOVE      USERID,MRRQUSUP 
          PACK      MRRQAUDD,CCC,CYY,CMM,CDD
          REP       " 0",MRRQAUDD
          CLOCK     TIME,MRRQAUDT
          MOVE      ANSB,MRRQAUDR
          CALL      ARMRRQH              * Write change audit history record
.
          PACK      MRRQDTRQ,CCC,CYY,CMM,CDD    * Set request date to today
          REP       " 0",MRRQDTRQ
.
          CLOCK     TIME,MRRQTMUP
          PACK      MRRQDTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          CALL      UPMRRQH2
.
          PACK      KEY10,MRRQRQNO,SP70  * Bulk Header File
          CALL      RDMRBRH1
          IF        OVRCD=0
            MOVE      MRRQDTRQ,MRBRDTRI    * Set Date to today
            CALL      UPMRBRH1
          ENDIF
.
          MOVE      SAVKEY23,KEY23
          CALL      RSMRRQH2             * Re Position after change of date
.
          GOTO      BTRN1000
.
BTRN9999  RETURN
.------------------------------------------------------------
. Medical Records Bulk Request Summary Lists by Date
.------------------------------------------------------------
BLKRES00  RESET     UPDATETY
          MATCH     SP1,UPDATETY
          GOTO      BLKRES40 IF EQUAL
.
          MATCH     "P",UPDATETY    * Print Request  
          GOTO      BLKRES10 IF EQUAL
.
          GOTO      BLKRES90
.
.         ************* PRINT FORMACTION ***********
.
BLKRES10  CALL      MRCLR000          * Clears all variables in requests
          PACK      KEY10,MRTPT001,SP70 
          CALL      RDMRRQH1
          BRANCH    OVRCD,BLKRES91
. 
          PACK      KEY20,MRTPT001,MRTPT002,SP70
          CALL      RDMRRQD1
          BRANCH    OVRCD,BLKRES91
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BLKRES92
.
          MOVE      PURNO,KEY8      * Read PMI Extension Table
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CHKCOD00
          BRANCH    EXIT,BLKRES99
.
          CALL      SETP0000
.
          MOVE      MRTPT002,MRRDRKEY   * Set Medical Record Key for READFIL0
          CALL      READFIL0            * Read files for print routine. 
.
          CALL      OPNPRINT            * open print 
          CALL      MRPRN000            * Print Request Details
          CALL      CLSPRINT            * close print
.
          MOVE      ZERO,EXIT
          GOTO      BLKRES99
.
.         ************ DISPLAY FORMACTION **********
.
BLKRES40  PACK      KEY10,REQUESTN,SP70   * Read Bulk Request Header File
          CALL      RDMRBRH1
          BRANCH    OVRCD,BLKRES91
.
          PACK      KEY20,MRTRECKY,SP70
          CALL      RDMRRQD1
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
.
          MATCH     " ",FILLEDRC
          IF        @EQUAL
            MOVE      "N",FILLEDRC
          ENDIF
.
          MOVE      "Medical Records Bulk Request Reservation List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,BLKRES99
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      BLKRES99
.
BLKRES90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKRES99
.
BLKRES91  MOVE      "Invalid Bulk Request No. not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKRES99
.
BLKRES92  MOVE      "Patient Master Details dont exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKRES99
.
BLKRES99  RETURN
.------------------------------------------------------------
. Update Medical Record Filled Status
.------------------------------------------------------------
UPDFIL00  CALL      XMLHED00
          BRANCH    EXIT,UPDFIL99
.
          PACK      KEY20,MRTRECKY,SP70
          CALL      RDMRRQD1
          BRANCH    OVRCD,UPDFIL90
.
          PACK      KEY10,MRRDRQNO,SP70
          CALL      RDMRRQH1
          BRANCH    OVRCD,UPDFIL90
. 
          CLOCK     TIME,MRRQTMUP
          PACK      MRRQDTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          MATCH     "1",MRCNREQC     * Copy request comments to movement
          IF        @EQUAL
            MATCH     SP70,MVMTCOMM
            IF        @EQUAL
              MOVE      MRRQCOMM,MVMTCOMM
            ENDIF
          ENDIF
.
          BRANCH    SEQUENCE,UPDFIL10,UPDFIL20,UPDFIL30

UPDFIL10  COMPARE   CHECKBOX,ONE       * Filled Checkbox
          IF        @EQUAL
            PACK      MRRDFUID,USERID,SP70
            MOVE      "Y",MRRDFILL     * Update to Filled
            CALL      UPMRRQD1
            CALL      SAVHIS00         * Writes History record for a movement
            BRANCH    EXIT,UPDFIL90 
            GOTO      UPDFIL80
          ELSE
            MATCH     "Y",MRRDFILL
            IF        @EQUAL
              CALL      DELHIS00
            ENDIF
            PACK      MRRDFUID,SP70
            MOVE      "N",MRRDFILL     * Undo Filled
            CALL      UPMRRQD1
            GOTO      UPDFIL80
          ENDIF
.
UPDFIL20  COMPARE   CHECKBOX,ONE       * Cancel Checkbox
          IF        @EQUAL
            MATCH     "Y",MRRDFILL        
            IF        @EQUAL
              CALL      DELHIS00
            ENDIF
            PACK      MRRDFUID,USERID,SP70
            MOVE      "C",MRRDFILL     * Update to Cancelled
            CALL      UPMRRQD1
            GOTO      UPDFIL80
          ELSE
            PACK      MRRDFUID,SP70
            MOVE      "N",MRRDFILL     * Undo Cancell
            CALL      UPMRRQD1
            GOTO      UPDFIL80
          ENDIF
.
UPDFIL30  COMPARE   CHECKBOX,ONE       * Process Checkbox
          IF        @EQUAL
            MATCH     "Y",MRRDFILL        
            IF        @EQUAL
              CALL      DELHIS00
            ENDIF
            PACK      MRRDFUID,USERID,SP70
            MOVE      "P",MRRDFILL     * Update to In Progress
            CALL      UPMRRQD1
            GOTO      UPDFIL80
          ELSE
            PACK      MRRDFUID,SP70
            MOVE      "N",MRRDFILL     * Undo In Progress
            CALL      UPMRRQD1
            GOTO      UPDFIL80
          ENDIF
.
UPDFIL80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Update Complete":
                             "</RETURN_VALUE>"
          GOTO      UPDFIL95
.
UPDFIL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Record":
                             "</RETURN_VALUE>"
UPDFIL95  CALL      XMLEND00
UPDFIL99  RETURN
.------------------------------------------------------------
. Save Routine for MRTHISFD
.------------------------------------------------------------
SAVHIS00  MOVE      ZERO,EXIT
. 
          PACK      KEY10,MRRDRKEY,SP70    * Read Medical Rec  Master for HL7
          CALL      RDMRMAS2
          BRANCH    OVRCD,SAVHIS90
.            
          CALL      CLMRTHIS               * clear MRT History record
.
          MOVE      MRRDRKEY,MRHIKEY       * Medical Record Key
          MOVE      MRRQDTUP,MRHIDATE      * Date of Movement
          CLOCK     TIME,MRHITIME          * Time of Movement
          MOVE      MRRQHOSC,MRHIDHOS      * Destination Hospital     *I-240724
          MOVE      MRRQLOCR,MRHILOC       * Destination Location
          MOVE      MRRQMOVR,MRHIREAS      * Reason
...       MOVE      SP70,MRHIOPER          * Operator
.
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          BRANCH    OVRCD,SAVHIS99
.
          MOVE      CURRDATE,WORKDATE
          ADD       MRMOPERD,WORKDATE       * add Loan Period (Days)
          MOVE      WORKDATE,MRHIDDUE       * set "Due Date"
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP70                        *C-240724
          CALL      RDMRLOC1
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT     * external
          ELSE
            MOVE      TWO,MRHISTAT    * internal
          ENDIF
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          COMPARE   ONE,PTCNRQCF       * Requested by Free Format?
          IF        @EQUAL
...         MOVE      SP70,MRHIRECV          * Reciever of Rec
            MOVE      MRRQPERS,MRHIREQB  * Requested By Free Format
          ELSE
...         MOVE      SP70,MRHIREQB          * Reciever of Rec
            MOVE      MRRQPERS,MRHIRECV  * Requested By (Using Staff Code)
          ENDIF
.
          MATCH     SP70,MRTSECNO
          IF        !@EQUAL
            MOVE      MRTSECID,MRHIUSID   * MRT Security number User ID
          ELSE
            MOVE      WBSEUID,MRHIUSID    * Web User ID
          ENDIF
          MOVE      SP70,MRHILOCK
.
          MOVE      MRRQEXTN,MRHIEXTN
          MOVE      MRRQPAGE,MRHIPAGE
          MOVE      SP70,MRHICOMM
.
          MOVE      MVMTCOMM,MRHICOMM            * C-261931
.                                                           
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1   
          IF        OVRCD = 1
            CALL      WRMRHIS1              * Write a new record
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICRM              * DG API Med.Rec.Movement  *I-90201
          ELSE
            CALL      UPMRHIS1              * Update if record exists
          ENDIF
.
.    * Update master record with new location
.
          PACK      KEY10,MRRDRKEY,SP70 
          CALL      RDMRMAS2
          BRANCH    OVRCD,SAVHIS90
.
          MOVE      MRHILOC,MRMACLOC
          MOVE      MRHIDHOS,MRMACHOS                                 *C-240724
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
          GOTO      SAVHIS99
.
SAVHIS90  MOVE      ONE,EXIT 
.
SAVHIS99  RETURN
.------------------------------------------------------------
. Delete Routine for MRTHISFD
.------------------------------------------------------------
DELHIS00  PACK      KEY26,MRRDRKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,DELHIS99
.
          MATCH     MRRDRKEY,MRHIKEY
          IF        @EQUAL          
            PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
            CALL      DEMRHIS1
          ENDIF
.
          PACK      KEY10,MRHIKEY      * Update master record with new location
          CALL      RDMRMAS2
          BRANCH    OVRCD,DELHIS99
.
          PACK      KEY26,MRRDRKEY,Z70 * Restore the current locaton from
          CALL      RSMRHIS1           * the last history
          CALL      RPMRHIS1
          BRANCH    OVRCD,DELHIS60
.
DELHIS50  MATCH     MRRDRKEY,MRHIKEY
          IF        @EQUAL
            MOVE       MRHIDHOS,MRMACHOS                              *C-240724
            MOVE       MRHILOC,MRMACLOC
          ELSE
            MOVE       MRMAHHOS,MRMACHOS
            MOVE       MRMAHLOC,MRMACLOC
          ENDIF
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
          GOTO      DELHIS99
.
DELHIS60  MOVE      MRMAHHOS,MRMACHOS
          MOVE      MRMAHLOC,MRMACLOC
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
DELHIS99  RETURN
.------------------------------------------------------------
. List by Date Range
.------------------------------------------------------------
MFIL0000  BRANCH    FLDITMNO,MFIL0100,MFIL0200,MFIL0300,MFIL0400,MFIL0500:
                             MFIL0600,MFIL0700,MFIL0800,MFIL0900,MFIL1000:
                             MFIL1100,MFIL1200,MFIL1300,MFIL1400,MFIL1500:
                             MFIL1600,MFIL1700,MFIL1800,MFIL1900,MFIL2000:
                             MFIL2100,MFIL2200,MFIL2300,MFIL2400,MFIL2500:
                             MFIL2600,MFIL2700,MFIL2800,MFIL2900,MFIL3000:
                             MFIL3100,MFIL3200
.
          WRITE     HTMLFILE;"Invalid IBA Tag - MFIL";
.
          GOTO      MFIL9999
.
MFIL0100  CALL      NEXT0000
          GOTO      MFIL9999
.
MFIL0200  CALL      PREV0000
          GOTO      MFIL9999
.
MFIL0300  CALL      CURSTD00
          GOTO      MFIL9999
.
MFIL0400  CALL      CUREND00
          GOTO      MFIL9999
.
MFIL0500  CALL      CURYR000
          GOTO      MFIL9999
.
MFIL0600  CALL      CURMON00
          GOTO      MFIL9999
.
MFIL0700  CALL      SELV0000
          GOTO      MFIL9999
.
MFIL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      MFIL9999
.
MFIL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      MFIL9999
.
MFIL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MFIL9999
.
MFIL1100  CALL      FILTB000
          GOTO      MFIL9999
.
MFIL1200  WRITE     HTMLFILE;MRRQRQNO;     * Record No
          GOTO      MFIL9999
.
MFIL1300  UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY   * To Date in (DD MON CCYY)
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY12;
          GOTO      MFIL9999
.
MFIL1400  WRITE     HTMLFILE;MRRQTMRQ;     * Time Request Required
          GOTO      MFIL9999
.
MFIL1500  PACK      KEY4,MRRQMOVR          * Movement Reasion
          CALL      RDMRMOV1
          WRITE     HTMLFILE;MRMODESC;
          GOTO      MFIL9999
.
MFIL1600  PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10  * Location required  *C-240724
          CALL      RDMRLOC1
          WRITE     HTMLFILE;MRLODESC 
          GOTO      MFIL9999
.
MFIL1700  MOVE      SP70,KEY50      * Clear requested by field before read
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRRQPERS,KEY50      * Requested By Free Format
          ELSE
            UNPACK    MRRQPERS,KEY6   * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF 
          WRITE     HTMLFILE;KEY50;     * Person Requesting Record
          GOTO      MFIL9999
.
MFIL1800  WRITE     HTMLFILE;MRRQEXTN;     * Extention Number
          GOTO      MFIL9999
.
MFIL1900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MFIL1910
          MATCH     "Y",MRRDFILL
          IF        @EQUAL
            MOVE      "Filled",KEY11
            WRITE     HTMLFILE;KEY11;       * Status
          ELSE
            MATCH     "N",MRRDFILL
            IF        @EQUAL
              MOVE      "New",KEY11
              WRITE     HTMLFILE;KEY11;       
            ELSE
              MATCH      "C",MRRDFILL
              IF         @EQUAL
                MOVE      "Cancelled",KEY11
                WRITE     HTMLFILE;KEY11;      
              ELSE
                MOVE      "Processing",KEY11
                WRITE     HTMLFILE;KEY11;      
              ENDIF
            ENDIF
          ENDIF  
          GOTO      MFIL9999
.
MFIL1910  WRITE     HTMLFILE;MRRDFILL;
          GOTO      MFIL9999
.
MFIL2000  CALL      FILLST00                * filled selection list
          GOTO      MFIL9999
.
MFIL2100  WRITE     HTMLFILE;MRRQPAGE;
          GOTO      MFIL9999
.
MFIL2200  WRITE     HTMLFILE;MRRDRKEY;      * Medical Record Key
          GOTO      MFIL9999
.
MFIL2300  WRITE     HTMLFILE;URNUMBER;      * U/R Number        
          GOTO      MFIL9999
.
MFIL2400  MOVE      ZERO,SHOWOREQ           * Don't show outstanding requests
          CALL      BULKR000                * Table of Bulk Requests
          GOTO      MFIL9999
.
MFIL2500  WRITE     HTMLFILE;VYEARMTH;             
          GOTO      MFIL9999
.
MFIL2600  WRITE     HTMLFILE;LASTDATE;             
          GOTO      MFIL9999
.
MFIL2700  WRITE     HTMLFILE;MRRQCOMM;
          GOTO      MFIL9999
.
MFIL2800  CALL      HIST0000                 * Table of request change history
          GOTO      MFIL9999
.
MFIL2900  WRITE     HTMLFILE;MRTRECKY;
          GOTO      MFIL9999
.
MFIL3000  MOVE      MRRQPERS,STAFFKEY       * Set Staff Key
          CALL      STFLST00                * Selection List of Mrt Staff
          GOTO      MFIL9999
.
MFIL3100  MOVE      "QU",CATEGORY           * Request Urgency
          MOVE      MRRQURGY,CODE
          CALL      CODITM00
          GOTO      MFIL9999
.
MFIL3200  MOVE      ONE,SHOWOREQ            * Show outstanding requests
          CALL      BULKR000                * Table of Bulk Requests
          GOTO      MFIL9999
.
MFIL9999  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,NEXT0100,NEXT0200
          WRITE     HTMLFILE;"SelectNextDay();";
          GOTO      NEXT9999
NEXT0100  WRITE     HTMLFILE;"SelectNextWeek();";
          GOTO      NEXT9999
NEXT0200  WRITE     HTMLFILE;"SelectNextMonth();";
          GOTO      NEXT9999
NEXT9999  RETURN
.------------------------------------------------------------
. Last Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,PREV0100,PREV0200
          WRITE     HTMLFILE;"SelectLastDay();";
          GOTO      PREV9999
PREV0100  WRITE     HTMLFILE;"SelectLastWeek();";
          GOTO      PREV9999
PREV0200  WRITE     HTMLFILE;"SelectLastMonth();";
          GOTO      PREV9999
PREV9999  RETURN
.------------------------------------------------------------
. Table of Request Filled List                 
.------------------------------------------------------------
FILTB000  UNPACK    SP20,KEY1A,KEY1B,SHOWCDTR
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1A,DIM127
          UNPACK    DIM127,D1,KEY1B,DIM127
          UNPACK    DIM127,D1,SHOWCDTR,DIM127
          MOVE      ZERO,RECCNT
          MOVE      ZERO,LOOPCNTR
.
          MOVE      FILTLOCN,THISLOCN                      * start    *C-240724
          MOVE      ZERO,ALLLOCN
          MATCH     SP4,FILTLOCN
          IF        @EQUAL
            MOVE      "1",ALLLOCN
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        @EQUAL
            PACK      KEY23,FRSTDATE,SP70
          ELSE
            PACK      KEY30,FILTHOSP,FILTLOCN,FRSTDATE,SP70
          ENDIF
FILTB050  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            CALL      RSMRRQH2
          ELSE
            CALL      RSMRRQH3
          ENDIF
.
FILTB100  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            CALL      RKMRRQH2
            BRANCH    OVRCD,FILTB999
.
            MATCH     MRRQDTRQ,LASTDATE
            GOTO      FILTB999 IF LESS
.  
.  Write record number in a comment to keep apache listening if no matching
.  records are found per 2,000 records
.
            ADD       ONE,LOOPCNTR
            IF        (LOOPCNTR = 2000)
              WRITE     HTMLFILE;"// ",LOOPCNTR
              MOVE      ZERO,LOOPCNTR
            ENDIF
.
            MATCH     SP70,FILTLOCN
            IF        !@EQUAL
              MATCH     FILTLOCN,MRRQLOCR
              GOTO      FILTB100 IF NOT EQUAL
            ENDIF
.                                      * Save key for re position GETO0000
            PACK      SAVKEY23,MRRQDTRQ,MRRQTMRQ,MRRQRQNO,SP70
          ELSE
            CALL      RKMRRQH3
            BRANCH    OVRCD,FILTB999
.
            MATCH     FILTHOSP,MRRQHOSC
            GOTO      FILTB999 IF NOT EQUAL
.
.  Write record number in a comment to keep apache listening if no matching
.  records are found per 2,000 records
.
            ADD       ONE,LOOPCNTR
            IF        (LOOPCNTR = 2000)
              WRITE     HTMLFILE;"// ",LOOPCNTR
              MOVE      ZERO,LOOPCNTR
            ENDIF
.
            MATCH     THISLOCN,MRRQLOCR
            IF        !@EQUAL
              IF        ALLLOCN = 1
                MOVE      MRRQLOCR,THISLOCN
                PACK      KEY30,FILTHOSP,MRRQLOCR,FRSTDATE,SP70
                GOTO      FILTB050
              ENDIF
              GOTO      FILTB999
            ENDIF
.
            MATCH     FRSTDATE,MRRQDTRQ
            GOTO      FILTB100 IF LESS                       * end    *C-240724
.
            MATCH     MRRQDTRQ,LASTDATE
            IF        @LESS
              PACK      KEY30,FILTHOSP,MRRQLOCR,Z70
              GOTO      FILTB050
            ENDIF
.
            PACK      SAVKEY30,MRRQHOSC,MRRQLOCR,MRRQDTRQ,MRRQTMRQ,MRRQRQNO,SP70
          ENDIF
.
.
          MATCH     SP70,URGENCYR
          IF        !@EQUAL
            MATCH     URGENCYR,MRRQURGY
            GOTO      FILTB100 IF NOT EQUAL
          ENDIF
.
          MOVE      "&nbsp;",URGEDESC
          MATCH     SP70,MRRQURGY
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSQ,ANSU,MRRQURGY,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,URGEDESC
              MATCH     "2",KEY1A                * is this WAHealth ?
              IF        @EQUAL
                MOVE      MRRQURGY,URGEDESC
              ENDIF
            ENDIF
          ENDIF
.
.  Do not display Bulk Requests
.
          PACK      KEY10,MRRQRQNO,SP70  
          CALL      RDMRBRH1         * Read Bulk Requests File
          IF        OVRCD=0
            GOTO      FILTB100
          ENDIF
.
          PACK      KEY20,MRRQRQNO,SP70
          CALL      RSMRRQD1 
FILTB200  CALL      RKMRRQD1
          BRANCH    OVRCD,FILTB100
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      FILTB100 IF NOT EQUAL
.
.  Write record number in a comment to keep apache listening if no matching
.  records are found per 2,000 records
.
          ADD       ONE,LOOPCNTR
          IF        (LOOPCNTR = 2000)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          MATCH     FILLEDRC,ANSA
          IF        !@EQUAL
            MATCH     FILLEDRC,MRRDFILL
            GOTO      FILTB200 IF NOT EQUAL
          ENDIF
.
          MOVE      MRRDRKEY,KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,FILTB200
.
          MATCH     SP3,FILTHHOS                                      *I-240724
          IF        !@EQUAL
            MATCH     FILTHHOS,MRMAHHOS
            GOTO      FILTB100 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",KEY1B
          IF        @EQUAL
            MATCH     WBSEHLOC,MRMAHLOC
            GOTO      FILTB200 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HOMELOCT
          IF        !@EQUAL
            MATCH     HOMELOCT,MRMAHLOC
            GOTO      FILTB200 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCUTYPE                * Document Type Filter
          IF        !@EQUAL
            MATCH     DOCUTYPE,MRMADOTY
            GOTO      FILTB200 IF NOT EQUAL
          ENDIF
.                                                * Document Type "Cat.TY"
          MOVE      SP70,DOCTDESC,TDESC
          MOVE      MRMADOTY,DOCTDESC            * set code as default
          PACK      KEY5,ANST,ANSY,MRMADOTY,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,DOCTDESC
            MATCH     "2",KEY1A                * is this WAHealth?
            IF        @EQUAL
              MOVE      MRMADOTY,DOCTDESC
              MATCH     "1",DOCTYFLG           * Menu override
              IF        !@EQUAL
                MATCH     "D",TCINDC2          * WAHealth, check Ind.2 for "D"
                IF        !@EQUAL
                  MOVE      "&nbsp;",DOCTDESC
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
FILTB205  MOVE      ZERO,PRIORLOC           * Destination or Location Required
          UNPACK    SP70,MRLODESC
          UNPACK    SP70,MRVVRHOS
          UNPACK    SP70,LOCDESC1
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,LOCDESC1
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      MRVVRHOS,OBB,MRRQHOSC,CBB  * set default to black
            MATCH     MRMAHHOS,MRRQHOSC
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRRQHOSC
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      MRVVRHOS,OBR,MRRQHOSC,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      MRVVRHOS,OBR,MRRQHOSC,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF  
            RESET     MRVVRHOS                   * format "(HOS)"
          ENDIF
.
          MOVE      MRLOPRLC,PRIORLOC
.
          UNPACK    SP70,MRHIKEY,MRLODESC
          PACK      KEY26,MRRDRKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          MATCH     MRHIKEY,MRRDRKEY
          IF        @EQUAL
            PACK      KEY7,MRHIDHOS,MRHILOC,SP10                      *C-240724
          ELSE
            PACK      KEY7,MRMACHOS,MRMACLOC,SP10                     *C-240724
          ENDIF
.
          CALL      ITRN0000                * Check if in transit 
.
FILTB310  MOVE      SP70,MRLODESC           * Current Location 
          MOVE      SP70,MRLOTYPE
          MOVE      SP70,MRVVCHOS           * current Hospital 
          CALL      RDMRLOC1
          MOVE      MRLODESC,LOCDESC2
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      MRVVCHOS,OBB,MRLOHOSP,CBB  * set default to black
            MATCH     MRMAHHOS,MRLOHOSP
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRLOHOSP
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      MRVVCHOS,OBR,MRLOHOSP,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      MRVVCHOS,OBR,MRLOHOSP,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            RESET     MRVVCHOS
          ENDIF
.
          MOVE      ZERO,SAMLFLAG
          MATCH     MRRQLOCR,MRLOCODE
          IF        @EQUAL
            MOVE      ONE,SAMLFLAG
          ENDIF
.
.
          MOVE      MRMAURNO,URNUMBER 
          MOVE      MRLOCODE,TRAKLOCN
          MOVE      MRLOHOSP,TRAKHOSP
          PROC      TRKALT00           * Check for tracking alerts
.
          MOVE      SP70,MRMODESC      * Reason For Movement 
          PACK      KEY4,MRRQMOVR  
          CALL      RDMRMOV1
.
          MOVE      "&nbsp;",FORMATNM
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,FILTB400
.
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,FILTB400
          
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000      * Format Patient Name with System Parameter
          CALL      PATFLD00      * Returns KEY3 for folder colour code
.
.                                                * Record Status "Cat.RS"
          MOVE      SP70,STATDESC,TDESC          
          MOVE      SP70,RECSTATD          
          MOVE      MRMASTAT,STATDESC            * set code as default
          PACK      KEY5,ANSR,ANSS,MRMASTAT,SP70 
          CALL      RDCODE1
          IF        OVRCD <> 1
            MOVE      TDESC,STATDESC
            MATCH     "2",KEY1A                  * is this WAHealth?
            IF        @EQUAL
              MATCH     "D",TCINDC2              * WAHealth, check Ind.2 for "D"
              IF        !@EQUAL
                MOVE      "&nbsp;",STATDESC
              ENDIF
            ENDIF
          ENDIF
          MOVE      PTCDUDF3,RECSTATD 
.
FILTB400  MATCH     "1",SHOWCDTR     * Show current req date/time?
          IF        @EQUAL
            CALL      GETC0000        * Yes,show current req date/time
            BRANCH    EXIT,FILTB100
          ELSE
            CALL      GETO0000        * No,check for the original req date/time
            BRANCH    EXIT,FILTB100
          ENDIF
.
          MOVE      MRMAURNO,SORTORDR       *                         *I-240716
          CALL      MRSRTORD                * create sort order from SORTORDR
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateHeader('",HTMLLINK
          APPEND    MRRDRQNO,HTMLLINK
          APPEND    MRRDRKEY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMAURNO,HTMLLINK
          APPEND    "');",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "patweb98.pbl?reportno=01",HTMLLNK2
          APPEND    "&template=001",HTMLLNK2
          APPEND    "&urnumber=",HTMLLNK2
          APPEND    MRMAURNO,HTMLLNK2
          RESET     HTMLLNK2
.
FILTB600  MOVE      ZERO,F1
          MOVE      KEY1A,F1
          BRANCH    F1,FILTB601,FILTB602
.
FILTB603  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                    "#"",MRRQRQNO,"#",":                        * 1
                    "#"<b>",MRMAURNO,"</b>#",";                 * 2
          GOTO      FILTB609
.
FILTB601  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                    "#"<b>",MRMAURNO,"</b>#",":                 * 1
                    "#"",MRRQRQNO,"#",";                        * 2
          GOTO      FILTB609
.
FILTB602  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0   wahealth
                    "#"",SP1,"#",":                             * 1
                    "#"<b>",MRMAURNO,"</b>#",";                 * 2
          GOTO      FILTB609
.
FILTB609  WRITE     HTMLFILE;"#"",MRRQDTRQ,MRRQTMRQ,"#",":      * 3
                    "#"",MRMODESC,"#",";                        * 4
.                                            
.                                                               * 5
FILTB700  MOVE      LOCDESC2,MRLODESC            * set Location colours (default
          MATCH     "1",SAMLFLAG
          IF        @EQUAL
            PACK      LOCDESC2,STTBLUE,MRLODESC,ENDFONT
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     SP70,INTRANST                * Set by ITRN0000
            IF        !@EQUAL 
              WRITE     HTMLFILE;"#"",INTRANST,MRVVCHOS,LOCDESC2,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",MRVVCHOS,LOCDESC2,"#",";
            ENDIF
          ELSE
            MATCH     SP70,INTRANST                * Set by ITRN0000
            IF        !@EQUAL 
              WRITE     HTMLFILE;"#"",INTRANST,LOCDESC2,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",LOCDESC2,"#",";
            ENDIF
          ENDIF
.
.                                                               *6
          MOVE      LOCDESC1,MRLODESC            * set Location colours (default
          MATCH     "1",PRIORLOC
          IF        @EQUAL
            PACK      LOCDESC1,STTRED,MRLODESC,ENDFONT
          ELSE
            MATCH     "1",SAMLFLAG
            IF        @EQUAL
              PACK      LOCDESC1,STTBLUE,MRLODESC,ENDFONT
            ENDIF
          ENDIF
          IF        IBCNMHOS = 1
            WRITE     HTMLFILE;"#"",MRVVRHOS,LOCDESC1,"#",";
          ELSE
            WRITE     HTMLFILE;"#"",LOCDESC1,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",MRMAVOLN,"#",":               * 7
                    "#"",SORTORDR,"#",";                        * 8    
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          MATCH     "P",MRRDFILL                                * 9
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                      " id=prc",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateProgrs(this);' checked>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                      " id=prc",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateProgrs(this);'>":
                      "#",";
          ENDIF

          MATCH     "Y",MRRDFILL                                * 10
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=fil",DRECCNT:
                      " id=fil",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY,MRMAURNO:
                      "' onclick='UpdateFilled(this);' checked>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=fil",DRECCNT:
                      " id=fil",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY,MRMAURNO:
                      "' onclick='UpdateFilled(this);'>":
                      "#",";
          ENDIF
.
          MOVE      SP70,RQSTREAS        * Get Movement Reason
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          IF        OVRCD=0
            PACK      RQSTREAS,MRMODESC,SP70
          ENDIF
.
          MATCH     "C",MRRDFILL                                * 11
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=can",DRECCNT:
                      " id=can",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateCancel(this);' checked>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=can",DRECCNT:
                      " id=can",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateCancel(this);'>":
                      "#",";
          ENDIF
.
          WRITE      HTMLFILE;"#"",MRRQMOVR,"#",":              * 12
                              "#"",FORMATNM,"#",":              * 13
                              "#"",RQSTREAS,"#",":              * 14
                              "#"",KEY3,"#",":                  * 15
                              "#"",HTMLLNK2,"#",":              * 16
                              "#"",URGEDESC,"#",":              * 17
                              "#"",MRMADTCR,"#",":              * 18
                              "#"",MRRQTRIG,"#",":              * 19
                              "#"",ALRTMESS,"#",":              * 20
                              "#"",ALRTCLAS,"#",";              * 21
.
.                                           * format data for Hover display
          CALL      FILTHD00
          WRITE     HTMLFILE;DIM500;            * hover display * 22 & 23
. 
          WRITE     HTMLFILE;"#"",DOCTDESC,"#",":               * 24
                             "#"","<span style=color:",RECSTATD,">":
                             STATDESC,"</span>","#",":         * 25
                             "#"",MRRQCOMM,"#");"               * 26
.
          MOVE      ZERO,LOOPCNTR
          GOTO      FILTB200
.
FILTB999  RETURN
.------------------------------------------------------------
. Hover Display for FILTB000              
.------------------------------------------------------------
.                                           * format data for Hover display
FILTHD00  STRIP     PGNAME
          STRIP     PSNAME
          PACK      DIM80,PGNAME,SP1,PSNAME
          REP       "'`",DIM80
.
          CLEAR     DIM500
          APPEND    "#"javascript:HoverData('",DIM500
          APPEND    "Request Details for ",DIM500
          APPEND    DIM80,DIM500
          APPEND    "','Request Number: ",DIM500
          APPEND    MRRQRQNO,DIM500
          APPEND    "','Date Required: ",DIM500
          MATCH     MRRQDTRQ,SP70
          IF        !@EQUAL
            UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      " @ ",KEY3
            PACK      KEY19,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,KEY3,MRRQTMRQ
            APPEND    KEY19,DIM500
          ENDIF
.
          APPEND    "','Reason: ",DIM500
          APPEND    MRMODESC,DIM500
          APPEND    "','Destination : ",DIM500
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP70                       *C-240724
          CALL      RDMRLOC1
          APPEND    MRLODESC,DIM500
          APPEND    "','Requested by : ",DIM500
          MOVE      MRRQPERS,KEY35
          REP       "'`",KEY35                                         * CAR 310253
          APPEND    KEY35,DIM500
          APPEND    "','Pager Number : ",DIM500
          APPEND    MRRQPAGE,DIM500
          APPEND    "','Extension No. : ",DIM500
          APPEND    MRRQEXTN,DIM500
          APPEND    "','Status : ",DIM500
          MOVE      MRRDFILL,KEY1
          REP       "Y1P2N3C4",KEY1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          LOAD      KEY9,F1,STATY,STATP,STATN,STATC
          APPEND    KEY9,DIM500
          APPEND    "','Comments : ','",DIM500
          MOVE      MRRQCOMM,KEY50
          REP       "'`",KEY50                                        * CAR 310253
          APPEND    KEY50,DIM500
          APPEND    "');#"",DIM500
.
          RESET     DIM500
          REP       " +",DIM500
          ENDSET    DIM500
.                                                * unknown extra bit
.                                                 *  (Originating Hospital?)
          MATCH     MRMAOHOS,MRRQHOSC
          IF        !@EQUAL
            APPEND    ",#"<font color=red>",DIM500
            APPEND    MRRQHOSC,DIM500
            APPEND    "</font>",DIM500
          ELSE
            APPEND    ",#"",DIM500
.           APPEND    ",#"<font color=red>",DIM500
.           APPEND    MRRQHOSC,DIM500
.           APPEND    "</font>",DIM500
          ENDIF
.
          APPEND    "#",",DIM500
          RESET     DIM500
.         REP       " +",DIM500
.
FILTHD99  RETURN
.------------------------------------------------------------
. Table of Bulk Requests                  
.------------------------------------------------------------
BULKR000  MOVE      FILTLOCN,THISLOCN
          MOVE      ZERO,ALLLOCN
          MATCH     SP4,FILTLOCN
          IF        @EQUAL
            MOVE      "1",ALLLOCN
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        @EQUAL
            PACK      KEY23,FRSTDATE,SP70
          ELSE
            PACK      KEY30,FILTHOSP,FILTLOCN,FRSTDATE,SP70
          ENDIF
.
BULKR050  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            CALL      RSMRBRH2
          ELSE
            CALL      RSMRBRH3
          ENDIF
.
BULKR100  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            CALL      RKMRBRH2
            BRANCH    OVRCD,BULKR999
.
            MATCH     MRBRDTRI,LASTDATE     * Match Date Required to Lastdate
            GOTO      BULKR999 IF LESS
          ELSE
            CALL      RKMRBRH3
            BRANCH    OVRCD,BULKR999
.
            MATCH     FILTHOSP,MRBRRHOS
            GOTO      BULKR999 IF NOT EQUAL
.
            MATCH     THISLOCN,MRBRLOCA
            IF        !@EQUAL
              IF        ALLLOCN = 1
                MOVE      MRBRLOCA,THISLOCN
                PACK      KEY30,FILTHOSP,MRBRLOCA,FRSTDATE,SP70
                GOTO      BULKR050
              ENDIF
              GOTO      BULKR999
            ENDIF
.
            MATCH     FRSTDATE,MRBRDTRI
            GOTO      BULKR100 IF LESS
.
            MATCH     MRBRDTRI,LASTDATE     * Match Date Required to Lastdate
            GOTO      BULKR999 IF LESS
          ENDIF
.
. Check if any records for this request match the status selection criteria.
.
          CALL      CHKRQD00              * Check Request Detail File
          BRANCH    EXIT,BULKR100
.
          MOVE      SP70,ORIGDATE
          MOVE      SP70,ORIGTIME
.
          PACK      KEY27,MRBRRQNM,SP70
          CALL      ASMRRQH
BULKR400  CALL      AKMRRQH
          BRANCH    OVRCD,BULKR450
.         
          MATCH     MRRQRQNO,MRBRRQNM
          GOTO      BULKR450 IF NOT EQUAL
.         
          MOVE      MRRQDTRQ,ORIGDATE
          MOVE      MRRQTMRQ,ORIGTIME
.
BULKR450  PACK      KEY10,MRBRRQNM,SP70
          CALL      RDMRRQH1
          BRANCH    OVRCD,BULKR100
.
          MATCH     SP70,ORIGDATE      
          IF        !@EQUAL
            MOVE      ORIGDATE,MRBRDTRI   
          ENDIF
.           
          MATCH     SP70,ORIGTIME
          IF        !@EQUAL
            MOVE      ORIGTIME,MRBRTMRI
          ENDIF
.
          UNPACK    SP70,MRVVRHOS
          UNPACK    SP70,LOCDESC1
          PACK      KEY7,MRBRRHOS,MRBRLOCA,SP70                       *C-240724
          CALL      RDMRLOC1
          IF        OVRCD=1
            MOVE      SP70,MRLODESC       * Current Location 
            MOVE      ZERO,MRLOPRLC
          ENDIF
          PACK      LOCDESC1,MRLODESC,SP70
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      MRVVRHOS,OBB,MRRQHOSC,CBB  * set default to black
            MATCH     MRMAHHOS,MRRQHOSC
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRRQHOSC
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      MRVVRHOS,OBR,MRRQHOSC,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      MRVVRHOS,OBR,MRRQHOSC,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            RESET     MRVVRHOS
          ENDIF     
.
          MOVE      SP70,DISPLAYR      * Clear requested by field before read
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRBRREQS,DISPLAYR   * Requested By Free Format
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRBRREQS,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      DISPLAYR,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ReservFill('",HTMLLINK
          APPEND    MRBRRQNM,HTMLLINK
          APPEND    "');",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":                  * 0
                    "#"",MRBRRQNM,"#",":                                    * 1
                    "#"",DISPLAYR,"#",";                                    * 2
          MATCH     "1",MRLOPRLC
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",MRVVRHOS,STTRED,LOCDESC1,ENDFONT,"#","; * 3
          ELSE
            WRITE     HTMLFILE;"#"",MRVVRHOS,LOCDESC1,"#",";                * 3
          ENDIF
.
          WRITE     HTMLFILE;"#"",MRBRPHON,"#",":                           * 4
                    "#"",MRBRPAGR,"#",":                                    * 5
                    "#"",MRBRNUMR,"#",":                                    * 6
                    "#"",MRBRDTRI,MRBRTMRI,"#",":                           * 7
                    "#"",MRBRDTRE,MRBRTMRE,"#",":                           * 8
                    "#"",MRRQCOMM,"#"";                                     * 9
.
          MOVE      MRBRRQNM,REQNUMBR
          CALL      GUREQ000           * Get number of un-filled requests
          COMPARE   ONE,SHOWOREQ
          IF        @EQUAL
            WRITE     HTMLFILE;",#"",REQNFCNT,"#");"                        *10
          ELSE
            WRITE     HTMLFILE;");"                                         *10
          ENDIF
.
          GOTO      BULKR100      * Read next record
.
BULKR999  RETURN
+
.--------------------------------------------------------------------------
.         Counts the number of reqests NOT filled; i.e. NOT with a 'Y' for
.         the 'Request Filled' status in 'mrtrqdaf'.
.         
.         PARAMETERS :   
.           REQNUMBR - Request Number
.
.         RETURN :
.           REQNFCNT - Number of requests NOT filled (not 'Y')
.--------------------------------------------------------------------------
GUREQ000  MOVE      ZERO,REQNFCNT
.
          PACK      KEY20,REQNUMBR,SP70
          CALL      RSMRRQD1
GUREQ100  CALL      RKMRRQD1
          BRANCH    OVRCD,GUREQ999
.
          MATCH     REQNUMBR,MRRDRQNO
          GOTO      GUREQ999 IF NOT EQUAL
.
          MATCH     "Y",MRRDFILL
          IF        !@EQUAL
            MATCH     "C",MRRDFILL
            IF        !@EQUAL
              ADD       ONE,REQNFCNT
            ENDIF
          ENDIF
          GOTO      GUREQ100
.
GUREQ999  RETURN
+
.--------------------------------------------------------------------------
. Check if a Records for this Request No matches the status/hospital
. selection criteria if it does display the request.
. RETURNS : EXIT
.--------------------------------------------------------------------------
CHKRQD00  MOVE      ZERO,EXIT
.
          MATCH     ANSA,FILLEDRC                * Status All
          IF        @EQUAL
            MATCH     SP70,FILTHHOS              * All home hospitals
            IF        @EQUAL
              MATCH     SP70,FILTLOCN            * Validate MR Required Location
              IF        @EQUAL
	        MATCH     SP70,DOCUTYPE          * Document type
                GOTO      CHKRQD99 IF EQUAL
	      ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY20,MRBRRQNM,SP70
          CALL      RSMRRQD1
CHKRQD10  CALL      RKMRRQD1
          BRANCH    OVRCD,CHKRQD90
.
          MATCH     MRBRRQNM,MRRDRQNO           * Request No
          GOTO      CHKRQD90 IF NOT EQUAL
.
          MOVE      MRRDRKEY,KEY10              * Validate Medical Record
          CALL      RDMRMAS2
          BRANCH    OVRCD,CHKRQD10
.
          MATCH     FILLEDRC,ANSA
          IF        !@EQUAL
            MATCH     FILLEDRC,MRRDFILL
            GOTO      CHKRQD10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHHOS               * Validate MR Home Hospital id
          IF        !@EQUAL
            MATCH     FILTHHOS,MRMAHHOS
            GOTO      CHKRQD10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTLOCN               * Validate MR Required Location
          IF        !@EQUAL
            MATCH     FILTLOCN,MRBRLOCA 
            GOTO      CHKRQD10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCUTYPE
          IF        !@EQUAL
            MATCH     DOCUTYPE,MRMADOTY
            GOTO      CHKRQD10 IF NOT EQUAL
          ENDIF
.
          GOTO      CHKRQD99
.
CHKRQD90  MOVE      ONE,EXIT
          GOTO      CHKRQD99
.
CHKRQD99  RETURN
.
.------------------------------------------------------------
. Table of Reservations for a Bulk Request No. 
.------------------------------------------------------------
BKRES000  MOVE      ZERO,RECCNT
.
          PACK      KEY10,REQUESTN,SP70
          CALL      RDMRRQH1
          BRANCH    OVRCD,BKRES999
.
          PACK      KEY20,MRRQRQNO,SP70
          CALL      RSMRRQD1 
BKRES100  CALL      RKMRRQD1
          BRANCH    OVRCD,BKRES999
.
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      BKRES999 IF NOT EQUAL
.
          MATCH     FILLEDRC,ANSA
          IF        !@EQUAL
            MATCH     FILLEDRC,MRRDFILL
            GOTO      BKRES100 IF NOT EQUAL
          ENDIF
.
          MOVE      MRRDRKEY,KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,BKRES100
.
          MOVE      SP70,DOCTDESC
          PACK      KEY5,ANST,ANSY,MRMADOTY,SP70     * Document Type
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      MRMADOTY,TDESC
          ENDIF
          MOVE      TDESC,DOCTDESC
.
          MOVE      SP70,STATDESC,TDESC     * Record Status "Cat.RS"
          MOVE      SP70,RECSTATD
          MOVE      MRMASTAT,STATDESC
          PACK      KEY5,ANSR,ANSS,MRMASTAT,SP70
          CALL      RDCODE1
          IF        OVRCD <> 1
            MOVE      TDESC,STATDESC
          ENDIF
          MOVE      PTCDUDF3,RECSTATD
.
.
          MOVE      SP70,MRVVRHOS           * required Hospital (work area)
          MOVE      SP70,LOCDESC1
          MOVE      SP70,MRLODESC           * Required Location
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,LOCDESC1
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      MRVVRHOS,OBB,MRRQHOSC,CBB  * set default toblack
            MATCH     MRMAHHOS,MRRQHOSC
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRRQHOSC
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      MRVVRHOS,OBR,MRRQHOSC,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1
                IF        !@EQUAL
                  PACK      MRVVRHOS,OBR,MRRQHOSC,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPLAYR      * Clear requested by field before read 
          PACK      KEY26,MRRDRKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,BKRES200
.
          MATCH     MRHIKEY,MRRDRKEY
          GOTO      BKRES200 IF NOT EQUAL
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP10                        *C-240724
.
          CALL      ITRN0000                * Check if in transit 
.
          PACK      KEY10,MRHIUSID,SP70     * Find out who holds the record now!
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE    SP70,WBSENAM
          ENDIF
.
          MOVE      SP70,DISPLAYR         
          COMPARE   ONE,PTCNRQCF            * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,DISPLAYR     * Requested By Free Format
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRHIRECV,SP70    * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      DISPLAYR,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.
          GOTO      BKRES300
.
BKRES200  PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
.
BKRES300  MOVE      SP70,MRVVCHOS
          MOVE      SP70,LOCDESC2
          MOVE      SP70,MRLODESC      * Current Location 
          CALL      RDMRLOC1
          MOVE      MRLODESC,LOCDESC2
.
          IF        IBCNMHOS = 1
            PACK      MRVVCHOS,OBB,MRLOHOSP,CBB  * set fault to black
            MATCH     MRMAHHOS,MRLOHOSP          * set Hospital colour
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRLOHOSP
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      MRVVCHOS,OBR,MRLOHOSP,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1
                IF        !@EQUAL
                  PACK      MRVVCHOS,OBR,MRLOHOSP,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,SAMLFLAG
          MATCH     MRRQLOCR,MRLOCODE     
          IF        @EQUAL
            MOVE      ONE,SAMLFLAG
          ENDIF 
.
          MOVE      MRMAURNO,URNUMBER
          MOVE      MRLOCODE,TRAKLOCN
          MOVE      MRLOHOSP,TRAKHOSP
          PROC      TRKALT00           * Check for tracking alerts
.
          MOVE      SP70,MRMODESC      *Reason For Movement 
          PACK      KEY4,MRRQMOVR  
          CALL      RDMRMOV1
.
          MOVE      "&nbsp;",FORMATNM
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BKRES400
.
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,BKRES400
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF     
          REP       " 0",AGEDATE
          CALL      CALCAGE
.         
          CALL      PATLN000      * Format Patient Name with System Parameter
          CALL      PATFLD00      * Returns KEY3 for folder colour code
.
.
BKRES400  MOVE      MRMAURNO,SORTORDR       *                         *I-240716
          CALL      MRSRTORD                * create sort order from SORTORDR
.
          CLEAR     HTMLLNK2
          APPEND    "patweb98.pbl?reportno=01",HTMLLNK2
          APPEND    "&template=001",HTMLLNK2
          APPEND    "&urnumber=",HTMLLNK2
          APPEND    MRMAURNO,HTMLLNK2
          RESET     HTMLLNK2
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateHeader('",HTMLLINK
          APPEND    MRRDRQNO,HTMLLINK
          APPEND    MRRDRKEY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMAURNO,HTMLLINK
          APPEND    "');",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                    "#"",MRRQRQNO,"#",":
                    "#"",MRMAURNO,"#",":
                    "#"",MRRQDTRQ,MRRQTMRQ,"#",":
                    "#"",MRMODESC,"#",";
.
            MATCH     "1",SAMLFLAG                              * 5
            IF        @EQUAL
              MOVE      LOCDESC2,MRLODESC
              PACK      LOCDESC2,STTBLUE,MRLODESC,ENDFONT
.
              MATCH     SP70,INTRANST                * Set by ITRN0000
              IF        !@EQUAL 
                WRITE     HTMLFILE;"#"",INTRANST,MRVVCHOS,LOCDESC2,"#",";
              ELSE
                WRITE     HTMLFILE;"#"",MRVVCHOS,LOCDESC2,"#",";
              ENDIF
            ELSE
              MATCH     SP70,INTRANST                * Set by ITRN0000
              IF        !@EQUAL 
                WRITE     HTMLFILE;"#"",INTRANST,MRVVCHOS,LOCDESC2,"#",";
              ELSE
                WRITE     HTMLFILE;"#"",MRVVCHOS,LOCDESC2,"#",";
              ENDIF
            ENDIF
.
            MATCH     "1",SAMLFLAG                              * 6
            IF        @EQUAL
              MOVE      LOCDESC1,MRLODESC
              PACK      LOCDESC1,STTBLUE,MRLODESC,ENDFONT
              WRITE     HTMLFILE;"#"",MRVVRHOS,LOCDESC1,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",MRVVRHOS,LOCDESC1,"#",";
            ENDIF
.
          WRITE     HTMLFILE;"#"",MRMAVOLN,"#",":
                    "#"",SORTORDR,"#",":
                    "#"",DISPLAYR,"#",";
..                    "#"",WBSENAM,"#",";
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          MATCH     "P",MRRDFILL
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                      " id=prc",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateProgrs(this);' checked>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                      " id=prc",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateProgrs(this);'>":
                      "#",";
          ENDIF
.
          MATCH     "Y",MRRDFILL
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=fil",DRECCNT:
                      " id=fil",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateFilled(this);' checked>":
                      "<input type=hidden name=req",DRECCNT:
                      " id=req",DRECCNT:
                   " value='",MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,DMRMAVOL,"'>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=fil",DRECCNT:
                      " id=fil",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateFilled(this);'>":
                      "<input type=hidden name=req",DRECCNT:
                      " id=req",DRECCNT:
                   " value='",MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,DMRMAVOL,"'>":
                      "#",";
          ENDIF
          MOVE      SP70,RQSTREAS        * Get Movement Reason
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          IF        OVRCD=0
            PACK      RQSTREAS,MRMODESC,SP70
          ENDIF
.
          MATCH     "C",MRRDFILL
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=can",DRECCNT:
                      " id=can",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateCancel(this);' checked>":
                      "#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=can",DRECCNT:
                      " id=can",DRECCNT:
                      " value='",MRRDRQNO,MRRDRKEY:
                      "' onclick='UpdateCancel(this);'>":
                      "#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",MRRQMOVR,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",RQSTREAS,"#",":
                             "#"",KEY3,"#",":
                             "#"",HTMLLNK2,"#",":
                             "#"",ALRTMESS,"#",":
                             "#"",ALRTCLAS,"#",":
                             "#"",DOCTDESC,"#",":
                             "#"","<span style=color:",RECSTATD,">":
                             STATDESC,"</span>","#");"
.
          GOTO      BKRES100
.
BKRES999  RETURN
.------------------------------------------------------------
. Table to print labels for Reservations for a Bulk Request No.
.------------------------------------------------------------
BKLAB000  MOVE      ZERO,RECCNT
.
          PACK      KEY10,REQUESTN,SP70
          CALL      RDMRRQH1
          BRANCH    OVRCD,BKLAB999
.
          PACK      KEY20,MRRQRQNO,SP70
          CALL      RSMRRQD1
BKLAB100  CALL      RKMRRQD1
          BRANCH    OVRCD,BKLAB999
.
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      BKLAB999 IF NOT EQUAL
.
          MOVE      MRRDRKEY,KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,BKLAB100
.
          MOVE      SP70,MRLODESC      *Location Required
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,KEY20
.
          MOVE      SP70,DISPLAYR      * Clear requested by field before read
          PACK      KEY26,MRRDRKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,BKLAB200
.
          MATCH     MRHIKEY,MRRDRKEY
          GOTO      BKLAB200 IF NOT EQUAL
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP10                        *C-240724
.
...       PACK      KEY10,MRHIUSID,SP70  * Find out who holds the record now!
...       CALL      RDWBSE1
...       IF        OVRCD=1
...         MOVE    SP70,WBSENAM
...       ENDIF
.
          MOVE      SP70,DISPLAYR         * I CAR 46303
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,DISPLAYR   * Requested By Free Format
          ELSE
            CLEAR     KEY50
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      DISPLAYR,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.
          GOTO      BKLAB300
.
BKLAB200  PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
.
BKLAB300  MOVE      SP70,MRLODESC      *Current Location
          CALL      RDMRLOC1
.
          MOVE      SP70,MRMODESC      *Reason For Movement
          PACK      KEY4,MRRQMOVR
          CALL      RDMRMOV1
.
          MOVE      "&nbsp;",FORMATNM
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BKLAB400
.
          PACK      KEY8,MRMAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,BKLAB400
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000      * Format Patient Name with System Parameter
          CALL      PATFLD00      * Returns KEY3 for folder colour code
.
.
BKLAB400  MOVE      MRMAURNO,SORTORDR       *                         *I-240716
          CALL      MRSRTORD                * create sort order from SORTORDR
.
          CLEAR     HTMLLNK2
          APPEND    "patweb98.pbl?reportno=01",HTMLLNK2
          APPEND    "&template=001",HTMLLNK2
          APPEND    "&urnumber=",HTMLLNK2
          APPEND    MRMAURNO,HTMLLNK2
          RESET     HTMLLNK2
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateHeader('",HTMLLINK
          APPEND    MRRDRQNO,HTMLLINK
          APPEND    MRRDRKEY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMAURNO,HTMLLINK
          APPEND    "');",HTMLLINK
          RESET     HTMLLINK
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          MOVE      SP70,RQSTREAS        * Get Movement Reason
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          IF        OVRCD=0
            PACK      RQSTREAS,MRMODESC,SP70
          ENDIF
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          MOVE      SP70,MRLODESC      *Current Location
          CALL      RDMRLOC1
.
.
          WRITE     HTMLFILE;"<tr><td>",FORMATNM,"</td>":
                             "<td>",RQSTREAS,"</td>":
                             "<td>",MRLODESC,"</td>":
                             "<td>",DISPLAYR,"</td>":
                             "<td>",MRMODESC,"</td>":
                             "<td>",MRMAVOLN,"</td>":
                             "<td><input type=checkbox name=mrkeyarr":
                             " value='",MRRDRKEY:
                             "' checked></td></tr>"
          GOTO      BKLAB100
.
BKLAB999  RETURN
.
.------------------------------------------------------------
. Table of Medical Record Master Maintenance
.------------------------------------------------------------
MASTB000  MOVE      ZERO,COUNT 
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,HOMEFLAG,DIM127
          UNPACK    DIM127,D1,ORIGFLAG,DIM127
.
          CALL      MASHD000      * Output Table Heading
          MOVE      ZERO,NUM

          RESET     MEDRR001
          MATCH     "All",MEDRR001
          IF        !@EQUAL
            MATCH     SP70,MEDRR001
            IF        !@EQUAL
              MOVE      MEDRR001,SAVDOCTY
            ELSE
              MOVE      MRCNRCTY,SAVDOCTY
            ENDIF
          ELSE
            MOVE     Z70,SAVDOCTY   
          ENDIF
.
          PACK      KEY20,URNUMBER,SAVDOCTY,Z70
          CALL      RSMRMAS4
MASTB100  CALL      RPMRMAS4
          BRANCH    OVRCD,MASTB999
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      MASTB999 IF NOT EQUAL
.                                           * check User security for MultiHosp
          IF        IBCNMHOS = 1
           MOVE      SP10,WBSEHOSP         * refresh WBESHOSP from user id and
            PACK      KEY10,USERID,SP10    * re read the hospital file
            CALL      RDWBSE1
.
            MATCH     SP10,LINKHOSP
            IF        !@EQUAL
              MOVE      LINKHOSP,WBSEHOSP
            ENDIF
.
            MOVE      SP70,PTHSHHOS         * Logged into hospital MR home
            PACK      KEY3,WBSEHOSP,SP70    * hospital
            CALL      RDPTHSP1

            MATCH     "1",SUPERLEV                                    *I-240724
            IF        !@EQUAL
              MATCH     WBSEHOSP,MRMACHOS              * User's Hospital only
              IF        !@EQUAL
                MATCH     PTHSHHOS,MRMAHHOS            * User's Hospital only
                GOTO      MASTB100 IF NOT EQUAL
              ENDIF
            ELSE
              MATCH     SP70,FILTHOSP
              IF        !@EQUAL & !@EOS 
                PACK      KEY13,USERID,SP70              * All hospital access?
                CALL      RDMLSEC1              
                IF        OVRCD = 1
                  PACK      KEY13,USERID,MRMAHHOS,SP70   * This hospital access?
                  CALL      RDMLSEC1
                  IF        OVRCD = 1
                    PACK      KEY13,USERID,MRMACHOS,SP70
                    CALL      RDMLSEC1
                    BRANCH    OVRCD,MASTB100
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF                                                * end  *I-240724
.
          MATCH     SP3,FILTHOSP                                      *I-248172
          IF        !@EQUAL
            MATCH     FILTHOSP,MRMAHHOS
            GOTO      MASTB100 IF NOT EQUAL
          ENDIF
.
          RESET     MEDRR001
          MATCH     "All",MEDRR001
          IF        !@EQUAL
            MATCH     SP70,MEDRR001
            IF        !@EQUAL
              MATCH     MRMADOTY,MEDRR001
              IF        !@EQUAL
                GOTO      MASTB100
              ENDIF
            ELSE
              MATCH     SP70,WBSEDTYP
              IF        !@EQUAL
                MATCH     MRMADOTY,WBSEDTYP
                IF        !@EQUAL
                  GOTO      MASTB100
                ENDIF
              ELSE
                MATCH     MRMADOTY,MRCNRCTY
                IF        !@EQUAL
                  GOTO      MASTB100
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,MRLOHOSP,MRLODESC            * clear for Home Location
          MOVE      SP70,HLOCDSC1
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            PACK      KEY30,OBB,MRLOHOSP,CBB
            CLEAR     KEY70
            APPEND    KEY30,KEY70
            APPEND    MRLODESC,KEY70
....        MATCH     MRMAOHOS,MRLOHOSP
....        IF        !@EQUAL
....          PACK      KEY30,OBR,MRMAOHOS,CBR,SP20
....          APPEND    KEY30,KEY70
....        ENDIF
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end    *I-240724
.
          UNPACK    SP70,MRLOHOSP,MRLODESC            * clear Current Location
          PACK      HLOCDSC2,SP70,SP70
.
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      KEY70,OBB,MRLOHOSP,CBB     * set default to black
            MATCH     MRMAHHOS,MRLOHOSP
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRLOHOSP
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      KEY70,OBR,MRLOHOSP,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY70,OBR,MRLOHOSP,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70             * dormat "(HOS)Location"
            RESET     KEY70
          ENDIF
.
          CALL      ITRN0000                     * Check if in transit
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      HLOCDSC2,INTRANST,KEY70
          ELSE
            MOVE      KEY70,HLOCDSC2
          ENDIF
.
          MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
.
          ADD       ONE,NUM
          PACK      KEY12,MRMAKEY,NUM
.
          MATCH     MRMAKEY,SHOWCHEK
          GOTO      MASTB500 IF EQUAL 
.
          ADD       ONE,COUNT
          COMPARE   "99",COUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=5><font size=3>":
                               "Limit of 99 records reached!</td></tr>";
            GOTO      MASTB999
          ENDIF
.
          MATCH     SP70,SHOWCHEK
          IF        @EQUAL
            BRANCH    NUM,MASTB500       * Tick the last volume
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td align=centre>";
.
          MATCH     "1",ORIGFLAG            * show Originating Hospital
          IF        @EQUAL
            UNPACK    SP70,PTHSSNAM,PTHSNAME
            PACK      KEY3,MRMAOHOS,SP10
            CALL      RDPTHSP1
            WRITE     HTMLFILE;PTHSNAME,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;KEY20,"</td><td>":
                             MRMAVOLN,"</td><td>":
                             MRMACOMM,"</td><td>":
                             HLOCDSC2,"</td><td>";
          MATCH     "1",HOMEFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;HLOCDSC1,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;"<span style=color:",PTCDUDF3,">":
                             TDESC,"</span></td><td>":
                             "<input type=checkbox name=recordky":
                             " value='",KEY12,"'>":
                             "</td></tr>"
.
          GOTO      MASTB100

MASTB500  WRITE     HTMLFILE;"<tr><td align=centre>";
.
          MATCH     "1",ORIGFLAG            * show Originating Hospital
          IF        @EQUAL
            UNPACK    SP70,PTHSSNAM,PTHSNAME
            PACK      KEY3,MRMAOHOS,SP10
            CALL      RDPTHSP1
            WRITE     HTMLFILE;PTHSNAME,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;KEY20,"</td><td>":
                             MRMAVOLN,"</td><td>":
                             MRMACOMM,"</td><td>";
.
          MATCH     "1",HOMEFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;HLOCDSC1,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;HLOCDSC2,"</td><td>":
                             "<span style=color:",PTCDUDF3,">":
                             TDESC,"</span></td><td>":
                             "<input type=checkbox name=recordky":
                             " value='",KEY12,"'checked>":
                             "</td></tr>"
.
          GOTO      MASTB100
.
MASTB999  RETURN
.------------------------------------------------------------
. Location Maintenance Table Details (TABLE HEADING)
.------------------------------------------------------------
MASHD000  WRITE     HTMLFILE;"<tr>";
.
          MATCH     "1",ORIGFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>":
                               "Originating Hospital</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>":
                             "Document Type</td>":
                             "<td class=HeadingCell>":
                             "Volume</td>":
                             "<td class=HeadingCell>":
                             "Comments</td>";
.
          MATCH     "1",HOMEFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>":
                               "Home Location</td>";
          ENDIF
.
.
          WRITE     HTMLFILE;"<td class=HeadingCell>":
                               "Current Location</td>":
                               "<td class=HeadingCell>":
                               "Status</td>":
                               "<td class=HeadingCell>":
                               "Required</td>":
                             "</tr>"
.
MASHD999  RETURN
.------------------------------------------------------------
. Loop through UR numbers and save Requests
.------------------------------------------------------------
MRWRT000  MOVE      ZERO,MRCOUNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,SAVCOUNT
.
          MOVE      " 59",PRXCODE   * System Lock Sector 59
          CALL      GETSLK00        * Get System Lock of Sector 59
.
          READ      CONTROLF,FIFTY9;*182,PTCNORNO
          ADD       ONE,PTCNORNO
          WRITAB    CONTROLF,FIFTY9;*182,PTCNORNO
.
          CALL      RELSLK00        * Release System Lock of Sector 59
.
          MOVE      PTCNORNO,KEY10
          CALL      RDMRRQH1 
          COMPARE   ZERO,OVRCD
          GOTO      MRWRT000 IF EQUAL
.
          MOVE      PTCNORNO,MRRQRQNO
          MOVE      MEDRR004,MRRQDTRQ
          MOVE      MEDRR005,MRRQTMRQ
          MOVE      MEDRR006,MRRQLOCR
          MOVE      MEDRR002,MRRQPERS
          MOVE      MEDRR003,MRRQMOVR
          MOVE      MEDRR008,MRRQURGY
          MOVE      MEDRR007,MRRQEXTN
          MOVE      MEDRR009,MRRQCOMM
          MOVE      MEDRR010,MRRQHOSC
          MOVE      MEDRR011,MRRQPAGE
          MOVE      MEDRR012,HOMEHOSP                                 *I-240724
          MOVE      MEDRR013,HOMELOCN                                 *I-240724
.
          CLOCK     TIME,MRRQTIYM
          PACK      MRRQDAYE,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDAYE
          MOVE      WBSEUID,MRRQUSID
.
          MOVE      SP70,MRRQTRIG
.
          MOVE      MRRQRQNO,KEY10
          CALL      WRMRRQH1      * write to the medical record request Header
          CALL      OPNPRINT      * open print      
.
MRWRT010  ADD       ONE,MRCOUNT
          IF        MRCOUNT>MRKEYCNT
            GOTO       MRWRT999
          ENDIF
.
          MATCH     RECORDKY[MRCOUNT],SP70
          GOTO      MRWRT010 IF EQUAL
.
          MOVE      RECORDKY[MRCOUNT],KEY10      * key to History file
          CALL      RDMRMAS2
          BRANCH    OVRCD,MRWRT091
.
          MOVE      "N",MRRDFILL
          PACK      MRRDFUID,SP70
          MOVE      SP70,MRRDSPAR
          ADD       ONE,SAVCOUNT

          PACK      KEY20,MRRQRQNO,MRMAKEY,SP70
          UNPACK    KEY20,MRRDRQNO,MRRDRKEY
          CALL      RAMRRQD1
          IF        OVRCD=0
            PACK      MRRDFUID,SP70
            CALL      UPMRRQD1
          ELSE 
            PACK      MRRDFUID,SP70
            CALL      WRMRRQD1     * write to the medical record request Details
          ENDIF
.
          MATCH     "1",MRCNPBLK
          IF        !@EQUAL
            COMPARE   REPORTNO,FOUR
            GOTO      MRWRT010 IF EQUAL
          ENDIF
.
          CALL      READFIL0
          CALL      MRPRN000               * Print Request Details
          GOTO      MRWRT010
.
MRWRT090  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      MRWRT010                                
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "Invalid U/R - ",ERRORLST[ERRORCNT]
          APPEND    KEY8,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      MRWRT010                                
.
MRWRT091  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      MRWRT010                                
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "Invalid MR Key - ",ERRORLST[ERRORCNT]
          APPEND    KEY10,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      MRWRT010                                
.
MRWRT092  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      MRWRT010                                
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "No Record for UR - ",ERRORLST[ERRORCNT]
          APPEND    URNUMBER,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      MRWRT010                                
. 
MRWRT999  CALL CLSPRINT                       *close print                                   
          RETURN
.------------------------------------------------------------
. Write to Bulk Request Header Table
.------------------------------------------------------------
MRBKRH00  MOVE      PTCNORNO,KEY10
          CALL      RDMRBRH1 
          COMPARE   OVRCD,ZERO         * Only write new Records
          GOTO      MRBKRH99 IF EQUAL 
.
          MOVE      PTCNORNO,MRBRRQNM  * Request Number
          MOVE      MEDRR004,MRBRDTRI  * Date Required
          MOVE      MEDRR005,MRBRTMRI  * Time Required
          PACK      MRBRDTRE,CCC,CYY,CMM,CDD
          REP       " 0",MRBRDTRE      * Current Date/Date Requested
          CLOCK     TIME,MRBRTMRE      * Current Time/Time Requested
          MOVE      MEDRR006,MRBRLOCA  * Location Required
          MOVE      SAVCOUNT,MRBRNUMR   * No of Records Requested
..          MOVE      MRKEYCNT,MRBRNUMR   * No of Records Requested
          MOVE      MEDRR002,MRBRREQS  * Person Requesting Record 
          MOVE      MEDRR007,MRBRPHON  * Phone No/Extension No
          MOVE      MEDRR011,MRBRPAGR  * Request Pager No
          MOVE      MEDRR010,MRBRRHOS  * Requesting Hospital          *I-248696
          MOVE      SP70,MRBRSPAR      * Spare
.
          MOVE      MRBRRQNM,KEY10
          CALL      WRMRBRH1      * Write to the medical record request Header
          MATCH     "1",NEXTPAGE
          IF        @EQUAL
            REP       " +",MRBRRQNM
            ENDSET    REDIRECT
            APPEND    MRBRRQNM,REDIRECT
            RESET     REDIRECT
            REP       "+ ",MRBRRQNM
          ENDIF
.
MRBKRH99  RETURN
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script language=#"JavaScript#"> {"
.
          MOVE      ZERO,F3
ERRLST10  ADD       ONE,F3
          IF        F3>ERRORCNT | F3>99
            GOTO      ERRLST20
          ENDIF
          WRITE     HTMLFILE;"    alert(#"",ERRORLST[F3],"/n#");"
          GOTO      ERRLST10

ERRLST20  WRITE     HTMLFILE;"    alert(#"All Other Records Processed/n#");"
          WRITE     HTMLFILE;"    if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             "    else {":
                             "    history.go(-1)}":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      ERRLST99
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST99  RETURN
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERLST200  CALL      OPENHTML
          BRANCH    EXIT,ERLST295
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ";
          COMPARE   ZERO,ERRORCNT
          GOTO      ERLST220 IF EQUAL
.
          MOVE      ONE,F2
ERLST210  WRITE     HTMLFILE;"    alert(#"",ERRORLST[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,ERRORCNT
          GOTO      ERLST220 IF LESS
          GOTO      ERLST210
.
ERLST220  WRITE     HTMLFILE;" alert(#"",WEBTITLE,"#");":
                             " if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame(#"",REDIRECT,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  parent.location.href=#"",REDIRECT,"#";":
                             "  } ":
                             "</script>"
          CALL      CLOSHTML
          GOTO      ERLST298
.
ERLST295  DISPLAY   "*** Fifo Not Found ***"
.
ERLST298  MOVE      ZERO,ERRORCNT
ERLST299  RETURN
.------------------------------------------------------------
. MRPRN000                           
. Routine to print the medical record request form       
. Routine from MEDRECRQ       
.------------------------------------------------------------
MRPRN000  MATCH     SP70,SELPRINT              * Skip printing if no printer
          GOTO      MRPRN999 IF EQUAL
.
.         CALL      OPNPRINT                   * open the spool file
          MOVE      ZERO,LOADFLAG              * Incomplete detail not loaded
.
          PRINT     *N;
          MOVE      ONE,CURRROW
.
.         Use stationary code from location file if one exists for
.         the location,else use the system parameter
.
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10                       *C-240724
          CALL      RDMRLOC1                   * Read locations file     
          BRANCH    OVRCD,MRPRN005
.
.         Check if stationary code exists for that location
.
          MATCH     SP70,MRLOSTCD                  
          IF        !@EQUAL
            MOVE      MRLOSTCD,STATCODE
            GOTO      MRPRN010
          ENDIF 
. 
.         Use system parameter if stationary code
.         does not exist for that location  
.
MRPRN005  MOVE      PTCNUCOD,STATCODE   
.
MRPRN010  PACK      KEY12,STATCODE,SP70
          CALL      RSIBDET1                   * position on the details file
          CALL      RKIBDET1
          BRANCH    OVRCD,MRPRN990
.
          MATCH     STATCODE,IBDTSCOD           * match stationary codes
          GOTO      MRPRN990 IF NOT EQUAL
.
          MOVE      IBDTROW,LASTROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
.------ print new-lines until current row equals the one read in ------
.
MRPRN050  PRINT     *N;
          ADD       ONE,CURRROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
          GOTO      MRPRN050
.
.------ read through the details file ------
.
MRPRN100  CALL      RKIBDET1
          BRANCH    OVRCD,MRPRN900
.
          MATCH     STATCODE,IBDTSCOD           * match stationary codes
          GOTO      MRPRN900 IF NOT EQUAL
.
          MOVE      IBDTROW,LASTROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
.------ print new-lines until current row equals the one read in ------
.
MRPRN110  PRINT     *N;
          ADD       ONE,CURRROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
          GOTO      MRPRN110
.
.------ branch on the field type ------
.
MRPRN200  BRANCH    IBDTINDC,MRPRN300,MRPRN400
.
.------ the field is a text field ------
.
MRPRN300  RESET     IBDTTXFL,IBDTPLEN
          LENSET    IBDTTXFL
          RESET     IBDTTXFL
          PRINT     *IBDTCOL,*+,IBDTTXFL;
          GOTO      MRPRN100
.
.------ the field is a data field ------
.
MRPRN400  MOVE      IBDTTXFL,DIM5
          MOVE      DIM5,FORM5
.
          BRANCH    FORM5,MRPRN410,MRPRN420,MRPRN430,MRPRN440,MRPRN450: * 5
                          MRPRN460,MRPRN470,MRPRN480,MRPRN490,MRPRN500: * 10
                          MRPRN510,MRPRN520,MRPRN530,MRPRN540,MRPRN550: * 15
                          MRPRN560,MRPRN570,MRPRN580,MRPRN590,MRPRN600: * 20
                          MRPRN610,MRPRN620,MRPRN630,MRPRN640,MRPRN650: * 25
                          MRPRN660,MRPRN661,MRPRN662,MRPRN663,MRPRN664: * 30 
                          MRPRN665,MRPRN666,MRPRN667,MRPRN668,MRPRN669: * 35 
                          MRPRN670,MRPRN671,MRPRN672,MRPRN673,MRPRN674: * 40
                          MRPRN675,MRPRN676,MRPRN677,MRPRN678,MRPRN679: * 45
                          MRPRN680,MRPRN681,MRPRN682,MRPRN683,MRPRN684: * 50
                          MRPRN685,MRPRN686,MRPRN687,MRPRN688,MRPRN689: * 55
                          MRPRN690,MRPRN691,MRPRN692,MRPRN693,MRPRN694: * 60
                          MRPRN695,MRPRN696,MRPRN697,MRPRN698,MRPRN699: * 65
                          MRPRN700,MRPRN701,MRPRN702,MRPRN703,MRPRN704: * 70
                          MRPRN705,MRPRN706,MRPRN707,MRPRN708,MRPRN709: * 75
                          MRPRN710,MRPRN711,MRPRN712,MRPRN713,MRPRN714: * 80
                          MRPRN715,MRPRN716,MRPRN717,MRPRN718,MRPRN719: * 85
                          MRPRN720
.                                                                     
.------ format the Request number ------
.
MRPRN410  MOVE      MRRQRQNO,VARIABLE
          MOVE      TEN,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN750
.
.------ format the U/R number ------
.
MRPRN420  MOVE      PURNO,VARIABLE
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN750
.
.------ format the patients name ------
.
MRPRN430  MOVE      TWO,PACFRMT
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          CALL      PACNAME                      * pack the patients name
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients surname ------
.
MRPRN440  MOVE      PSNAME,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients given name ------
.
MRPRN450  MOVE      PGNAME,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients title ------
.
MRPRN460  MOVE      PTITL,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients address line 1 ------
.
MRPRN470  MOVE      PADD1,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients address line 2 ------
.
MRPRN480  MOVE      PADD2,VARIABLE
          GOTO      MRPRN740
.
.------ format the suburb ------
.
MRPRN490  MOVE      PSUBRB,VARIABLE
          GOTO      MRPRN740
.
.------ format the post code ------
.
MRPRN500  MOVE      PPOST,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients sex description ------
.
MRPRN510  MOVE      SP70,VARIABLE
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00
          MOVE      DSEXASC1,VARIABLE
          GOTO      MRPRN740
.
MRPRN520  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN740
.
.------ format the patients age ------
.
MRPRN530  MOVE      PSAGE,VARIABLE
          MOVE      THREE,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN750
.
.------ format urgency (Free Format) ------
.
MRPRN540  
.         COMPARE   ZERO,PTCNURCF
.         GOTO      MRPRN100 IF EQUAL
.
          PACK      VARIABLE,MRRQMOVR,SP30,SP30,SP30
          GOTO      MRPRN740
.
.------ format urgency description ------
.
MRPRN550  MATCH     SP70,MRRQMOVR
          GOTO      MRPRN100 IF EQUAL
          GOTO      MRPRN100 IF EOS
          PACK      KEY4,MRRQMOVR,SP70
          CALL      RDMRMOV1
          BRANCH    OVRCD,MRPRN100
          MOVE      MRMODESC,VARIABLE
          GOTO      MRPRN740
.
.------ format requested by (Free Format) ------
.
MRPRN560  PACK      VARIABLE,MRRQPERS,SP70
          GOTO      MRPRN740
.
.------ format requested by description ------
.
.MRPRN570  MATCH     SP70,MRRQPERS
.          GOTO      MRPRN100 IF EQUAL
.          GOTO      MRPRN100 IF EOS
.          PACK      KEY5,ANSQ,ANSR,MRRQPERS
.          CALL      RDCODE1
.          BRANCH    OVRCD,MRPRN100
.          MOVE      TDESC,VARIABLE
.          GOTO      MRPRN740
.
MRPRN570  MATCH     SP70,MRRQPERS
          GOTO      MRPRN100 IF EQUAL
          GOTO      MRPRN100 IF EOS
          PACK      KEY6,MRRQPERS,SP70
          CALL      RDMRSTF1
          BRANCH    OVRCD,MRPRN100
          MOVE      MRSTGNAM,DIM1
          PACK      VARIABLE,DIM1,DOT,SP1,MRSTSNAM,SP70
          GOTO      MRPRN740
.
.------ format department (Free Format) ------
.
MRPRN580  
.         COMPARE   ZERO,PTCNDPCF
.         GOTO      MRPRN100 IF EQUAL
.
          PACK      VARIABLE,MRRQLOCR,SP30,SP30,SP30
          GOTO      MRPRN740
.
.------ format department description ------
.
MRPRN590  MATCH     SP70,MRRQLOCR
          GOTO      MRPRN100 IF EQUAL
          GOTO      MRPRN100 IF EOS
          PACK      KEY7,MRRQHOSC,MRRQLOCR,SP10   * Request Location  *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRPRN100
          MOVE      MRLODESC,VARIABLE
          GOTO      MRPRN740
.
.------ format date requested ------
.
MRPRN600  UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN740
.
.------ format time requested ------
.
MRPRN610  MOVE      MRRQTMRQ,DIM5
          MOVE      DIM5,VARIABLE
          GOTO      MRPRN740
.
.------ format National Id  ------
.
MRPRN620  PROC      MEDRQNAT            * get the national id
          MOVE      TWENTY,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN750
.
.------ format NOK Address 4------
.
MRPRN630  PACK      VARIABLE,SP70,SP70
          MOVE      PNKADD4,VARIABLE
          GOTO      MRPRN740
.
.------ format PMI Address 4------                                              
.
MRPRN640  PACK      VARIABLE,SP70,SP70
          MOVE      PADD4,VARIABLE
          GOTO      MRPRN740
.
.------ format PRA Address 4------                                              
.
MRPRN650  PACK      VARIABLE,SP70,SP70
          MOVE      PKADD4,VARIABLE
          GOTO      MRPRN740
.
.------ format Emergency Contact Address 4 ------ 
.
MRPRN660  PACK      VARIABLE,SP70,SP70
          MOVE      PTMXECA4,VARIABLE
          GOTO      MRPRN740
.
.------ Current Volume ------ 
.
MRPRN661  PACK      VARIABLE,SP70,SP70
          MOVE      DMRMAVOL,VARIABLE
          GOTO      MRPRN740
.
.------ format Current Location ------
.
MRPRN662  MATCH     SP4,MRMACLOC
          GOTO      MRPRN100 IF EQUAL
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10   * Current Location  *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRPRN100
          MOVE      MRLODESC,VARIABLE
          GOTO      MRPRN740
.
.------ format Date sent to Location ------
.
MRPRN663  MOVE      SP70,VARIABLE
          MOVE      SP70,CPCDATE
          MATCH     SP70,MRHIDATE
          GOTO      MRPRN100 IF EQUAL
          GOTO      MRPRN100 IF EOS
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN740
.
.------ format Time sent to Location ------
.
MRPRN664  MOVE      SP70,VARIABLE
          MOVE      SP70,DIM5
          MATCH     SP70,MRHITIME
          GOTO      MRPRN100 IF EQUAL
          GOTO      MRPRN100 IF EOS
          MOVE      MRHITIME,DIM5
          MOVE      DIM5,VARIABLE
          GOTO      MRPRN740
.
.------ format Micro Film Location ------
.
MRPRN665  MOVE      MRMAFILM,VARIABLE
          GOTO      MRPRN740
.
.------ format Religion ------
.
MRPRN666  MOVE      CODER,CATEGORY
          MOVE      PREG,CODE
          CALL      GETCOD00
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN740
.
.------ format the business telephone number ------
.
MRPRN667  MOVE      PTELEB,VARIABLE
          GOTO      MRPRN740
.
.------ format the marital status description ------
.
MRPRN668  MOVE      CODEM,TCODE
          PACK      ACODE,PMSTAT,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN740
.
.------ Incomplete Discharge? ------
.
MRPRN669  CALL      INCOMP00    * Check for Incomplete Coding 
          GOTO      MRPRN740
.
.------ format Date of Last Change to PMI ------
.
MRPRN670  UNPACK    PCHGDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN740
.
.------ format Episode Number (Visit Number) ------
.
MRPRN671  PACK      KEY18,MRMAKEY,Z70
          CALL      RSMRVS2
          CALL      RPMRVS2
          BRANCH    OVRCD,MRPRN100
.
          MATCH     MRMAKEY,MRVSMKEY
          IF        @EQUAL
            MOVE      MRVSVSNO,VARIABLE
          ELSE
            GOTO      MRPRN100
          ENDIF
          GOTO      MRPRN740
.
.------ format Episode date  (Visit Number) ------
.
MRPRN672  PACK      VARIABLE,SP70
          PACK      KEY18,MRMAKEY,Z70
          CALL      RSMRVS2
          CALL      RPMRVS2
          BRANCH    OVRCD,MRPRN100
.
          MATCH     MRMAKEY,MRVSMKEY
          IF        @EQUAL
            PACK      KEY8,MRVSVSNO,SP70
            CALL      RDPTVIS1         
            BRANCH    OVRCD,MRPRN100
.
            UNPACK    SPVIDATE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
            PACK      VARIABLE,CPCDATE,SP70
          ELSE
            GOTO      MRPRN100
          ENDIF
          GOTO      MRPRN740
.
.------ format Home Phone ------
.
MRPRN673  MOVE      PTELEP,VARIABLE          * Private telephone
          GOTO      MRPRN740
.
.------ format the Death ------
.
MRPRN674  COMPARE   "1",PCEASE
          IF        @EQUAL
            MOVE      "YES",VARIABLE
          ELSE
            MOVE      "NO ",VARIABLE
          ENDIF
          GOTO      MRPRN740
.
.------ format Date of Death ------
.
MRPRN675  PACK      VARIABLE,SP70
          MATCH     SP70,PDECDTE
          GOTO      MRPRN100 IF EQUAL
          UNPACK    PDECDTE,CCENT,CYEAR,CMON,CDAY 
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN740
.
.------ format Comments ------
.
MRPRN676  PACK      VARIABLE,SP70
          MOVE      MRRQCOMM,VARIABLE       
          GOTO      MRPRN740
.
.------ format Type of Patient ------
.
MRPRN677  PACK      VARIABLE,SP70
          PACK      KEY18,MRMAKEY,Z70
          CALL      RSMRVS2
          CALL      RPMRVS2
          BRANCH    OVRCD,MRPRN100
.
          MATCH     MRMAKEY,MRVSMKEY
          IF        @EQUAL
            PACK      KEY8,MRVSVSNO,SP70
            CALL      RDPTVIS1
            BRANCH    OVRCD,MRPRN100
.
            COMPARE   "1",PVITYPE
            IF        @EQUAL
              MOVE      "A & E           ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "2",PVITYPE
            IF        @EQUAL
              MOVE      "OUTPATIENT      ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "3",PVITYPE
            IF        @EQUAL
              MOVE      "INPATIENT       ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "4",PVITYPE
            IF        @EQUAL
              MOVE      "OTHER FINANCIAL ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "5",PVITYPE
            IF        @EQUAL
              MOVE      "DAY CENTRE      ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "6",PVITYPE
            IF        @EQUAL
              MOVE      "COMMUNITY HEALTH",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "7",PVITYPE
            IF        @EQUAL
              MOVE      "WARD ATTENDERS  ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "8",PVITYPE
            IF        @EQUAL
              MOVE      "AD-HOC ATTENDEES",VARIABLE
              GOTO      MRPRN740
            ENDIF
            COMPARE   "9",PVITYPE
            IF        @EQUAL
              MOVE      "Other           ",VARIABLE
              GOTO      MRPRN740
            ENDIF
            GOTO      MRPRN100
          ENDIF
.
MRPRN678  MOVE      SP70,VARIABLE
          MOVE      MRRQEXTN,VARIABLE     * Extention Number
          GOTO      MRPRN740
.
MRPRN679  MOVE      SP70,VARIABLE
          MOVE      MRRQPAGE,VARIABLE     * Pager Number 
          GOTO      MRPRN740
.
MRPRN680  MOVE      SP70,VARIABLE
          MOVE      MRHIREQB,VARIABLE     * Requested By
          GOTO      MRPRN740
.
MRPRN681  MOVE      ZERO,FORM1                                         *I-51730
          CALL      INCEPI00              * Last incomplete episode vis number
          GOTO      MRPRN740              * (volume)
.
MRPRN682  MOVE      ONE,FORM1                                          *I-51730 
          CALL      INCEPI00              * Last incomplete episode vis date
          GOTO      MRPRN740              * (volume)
.
MRPRN683  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[ONE],VARIABLE   * 1st incomplete episode vis num
          GOTO      MRPRN740                 * (earliest date)
.
MRPRN684  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[ONE],VARIABLE   * 1st incomplete episode vis date
          GOTO      MRPRN740                 * (earliest date)
.
MRPRN685  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[TWO],VARIABLE   * 2nd incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN686  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[TWO],VARIABLE   * 2nd incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN687  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[THREE],VARIABLE * 3rd incomplete episode vis num
          GOTO      MRPRN740 
.
MRPRN688  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[THREE],VARIABLE * 3rd incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN689  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[FOUR],VARIABLE  * 4th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN690  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[FOUR],VARIABLE  * 4th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN691  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[FIVE],VARIABLE  * 5th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN692  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[FIVE],VARIABLE  * 5th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN693  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[SIX],VARIABLE   * 6th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN694  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[SIX],VARIABLE   * 6th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN695  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[SEVEN],VARIABLE * 7th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN696  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[SEVEN],VARIABLE * 7th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN697  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[EIGHT],VARIABLE * 8th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN698  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[EIGHT],VARIABLE * 8th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN699  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[NINE],VARIABLE  * 9th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN700  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[NINE],VARIABLE  * 9th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN701  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCVISIT[TEN],VARIABLE   * 10th incomplete episode vis num
          GOTO      MRPRN740
.
MRPRN702  CALL      FINCEP00                 * Load incomplete visits
          MOVE      INCOMDAT[TEN],VARIABLE   * 10th incomplete episode vis date
          GOTO      MRPRN740
.
MRPRN703  PROC      GETALTID
          GOTO      MRPRN740
.
MRPRN704  MATCH     SP4,MRHILOC
          GOTO      MRPRN100 IF EQUAL
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP10                        *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRPRN100
.
          MOVE      MRLODESC,VARIABLE
          GOTO      MRPRN740
.
MRPRN705  MOVE      MRRQURGY,VARIABLE        * Urgency Code
          GOTO      MRPRN750
.
MRPRN706  MOVE      "QU",CATEGORY            * Urgency LONG Description
          MOVE      MRRQURGY,CODE
          CALL      GETCOD00
          MOVE      PTCDLDES,VARIABLE
          GOTO      MRPRN740
.
MRPRN707  MOVE      MRRQMOVR,VARIABLE        * Reason Code
          GOTO      MRPRN740
.
MRPRN708  MATCH     "1",MRHIRCST             * 'In-Transit' Receipt Status?
          IF        @EQUAL
            MOVE      "T",VARIABLE
          ELSE      
            MOVE      SP1,VARIABLE
          ENDIF
          GOTO      MRPRN740
.
MRPRN709  MOVE      SP70,VARIABLE
          MOVE      MRMASTAT,VARIABLE        * Status (Cat RS)
          GOTO      MRPRN740
.
MRPRN710  MOVE      SP70,VARIABLE
          MATCH     SP70,MRMASTAT
          GOTO      MRPRN740 IF EQUAL
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VARIABLE           * Status - short desc
          GOTO      MRPRN740
.
MRPRN711  MOVE      SP70,VARIABLE
          MATCH     SP70,MRMASTAT
          GOTO      MRPRN740 IF EQUAL
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      PTCDLDES,VARIABLE        * Status - long desc
          GOTO      MRPRN740
.
.------ PMPXRPER Record Retention Period Description (Cat rt) ------
.
MRPRN712  PACK      VARIABLE,SP70,SP70
.
          MATCH     SP70,PMPXRPER
          GOTO      MRPRN740 IF EQUAL
.
          PACK      KEY5,ANSR,ANST,SP70
          REP       LOWUPP,KEY5
          STRIP     KEY5
          ENDSET    KEY5
          APPEND    PMPXRPER,KEY5
          APPEND    SP70,KEY5
          RESET     KEY5
          CALL      RDCODE1
          BRANCH    OVRCD,MRPRN740
.
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN740
.
.------ PMPXRDAT Record Retention Date ------
.
MRPRN713  PACK      VARIABLE,SP70,SP70
.
          MATCH     SP70,PMPXRDAT
          GOTO      MRPRN740 IF EQUAL
.
          UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PACK      VARIABLE,CPCDATE,SP70
.
          GOTO      MRPRN740
.
.----- format patient sex long description ------
.
MRPRN714  MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00
          MOVE      DSEXLDES,VARIABLE        * Get sex long description
          GOTO      MRPRN740
.
MRPRN715  MOVE      PURNO,MBIRURNO
          CALL      MULBIR00                 * Get multlple birth details
          MOVE      MBIRTYOR,VARIABLE
          GOTO      MRPRN740
.
MRPRN716  PACK      VARIABLE,PMPXPFSN,SP70   * Preferred Surname
          GOTO      MRPRN740
.
MRPRN717  PACK      VARIABLE,PMPXPFGN,SP70   * Preferred Given Name
          GOTO      MRPRN740
.
MRPRN718  PACK      VARIABLE,PSNAME,SP70     * Pref Surname instead of Actual SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN740
.
MRPRN719  PACK      VARIABLE,PGNAME,SP70     * Pref GN instead of Actual GN
          MATCH     "1",PTCNPFGN
          IF        @EQUAL
            MATCH     SP70,PMPXPFGN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFGN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN740
.
MRPRN720  PACK      VARIABLE,PTMASNAM,SP70   * Pref Surname instead of 40char SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN740
.
MRPRN740  RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
          PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      MRPRN100
.
.------ formatting for Form fields and right justified variables ------
.
MRPRN750  COMPARE   ZERO,PRNTSTRT          * don't bump if printing full length
          GOTO      MRPRN760 IF EQUAL
.
          BUMP      VARIABLE,PRNTSTRT      * bump to starting position
.
.------ print the variable ------
.
MRPRN760  PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      MRPRN100
.
.------ end of medical record request form reached ------
.
MRPRN900  MOVE      FALSE,EXIT
.
.------ print new-lines until the end of page is reached ------
.
MRPRN910  PRINT     *N;
          ADD       ONE,LASTROW
.
          COMPARE   LASTROW,IBTHLENG          * test page length
          GOTO      MRPRN999 IF EQUAL
.
          GOTO      MRPRN910
.
.------ no details on file ------
.
MRPRN990  MOVE      TRUE,EXIT
.
MRPRN999  
.         CALL      CLSPRINT                  * close the spool file
          RETURN
.---------------------------------------------------------------------------
. INCOMP00 - Find Incomplete Codding checking all Inpatient Visits for U/R
.------------------------------------------------------------------------ --
INCOMP00  COMPARE   ONE,MRCNINCP
          IF        @EQUAL
            CALL      INCCMP00    * Checking Volume only Visits for UR
            GOTO      INCOMP99
          ENDIF
.
          MOVE      "NO ",VARIABLE
.          
          PACK      KEY24,PURNO,SP70
          CALL      RDSVISA2                   * Read Visit File
INCOMP10  CALL      RDKVISA2
          BRANCH    OVRCD,INCOMP99
.
          MATCH     PURNO,PVIURNO              * Check UR
          GOTO      INCOMP99 IF NOT EQUAL
.
          MATCH     "00000000",PVIDATE         * Bad debt
          GOTO      INCOMP10 IF EQUAL
.
          COMPARE   "3",PVITYPE                * Inpatients only
          GOTO      INCOMP10 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70          * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,INCOMP10 
.
          COMPARE   "3",ASTAT                  * Discharged only
          GOTO      INCOMP10 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            MOVE      "YES",VARIABLE           * Incomplete Codding Found
            GOTO      INCOMP99
          ENDIF
.
          GOTO      INCOMP10                   * Read Next Visit

INCOMP99  RETURN
.---------------------------------------------------------------------
. INCCMP00 - Find Incomplete Codding for Volume requested
.   We have already read MRTMAS so now read MRTVIS and check to see if 
.   this Volume has Incomplete Visits
.--------------------------------------------------------------------
INCCMP00  MOVE      "NO ",VARIABLE
.
          PACK      KEY18,MRMAKEY,SP70
          CALL      RSMRVS2
INCCMP10  CALL      RKMRVS2
          BRANCH    OVRCD,INCCMP99
.
          MATCH     MRMAKEY,MRVSMKEY          * Still same Record Unique Key? 
          GOTO      INCCMP99 IF NOT EQUAL
.
          PACK      KEY8,MRVSVSNO,SP70
          CALL      RDVISA1                   * Read Visit File
          BRANCH    OVRCD,INCCMP10
.
          MATCH     "00000000",PVIDATE        * Bad debt
          GOTO      INCCMP10 IF EQUAL
.
          COMPARE   "3",PVITYPE               * Inpatients only
          GOTO      INCCMP10 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70         * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,INCCMP10 
.
          COMPARE   "3",ASTAT                 * Discharged only
          GOTO      INCCMP10 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            MOVE      "YES",VARIABLE          * Incomplete Codding Found
            GOTO      INCCMP99
          ENDIF
.
          GOTO      INCCMP10                  * Read Next Visit
.
INCCMP99  RETURN
.---------------------------------------------------------------------
. GTCOD000 - Get a codes file record 
.---------------------------------------------------------------------
GTCOD000  MOVE      SP20,TDESC               * Initialise description
          UNPACK    SP20,THCSCOD,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      ZERO,TCFORM6
.
.         Is the code blank ?
.
          MATCH     SP3,ACODE
          GOTO      GTCOD999 IF EQUAL
.
.         Get the code file record
.
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1
.
GTCOD999  RETURN
.------------------------------------------------------------
.------------------------------------------------------------
. Procedure MEDRQNAT - Get the national id for the current U/R number        
. This procedure is from MEDRECRQ.PBL.
.------------------------------------------------------------
          DEFPROC   MEDRQNAT
.
          INC       PATNIDFD/INC
          INC       NHIMASFD/INC
.
PTCNNXUR  FORM      1
PTCNNUMH  FORM      1
PTCNNMPI  FORM      1
PTCNNHII  FORM      1
.
DFNP0000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,FIFTY9;*234,PTCNNMPI
          READ      CONTROLF,EIGHTY;*138,PTCNNZUR,PTCNNUMH
.
          COMPARE   ONE,PTCNNZUR
          GOTO      DFNP0100 IF NOT EQUAL   * not storing NMPI in U/R
.
.         we are storing NMPI number as the Local U/R Number
.
          PACK      VARIABLE,SP30,SP30,SP30,SP30,SP30
.
          COMPARE   ZERO,PTCNNUMH
          GOTO      DFNP0100 IF EQUAL       * get NMPI from patnmpaf
.
.         we are running as multi hospital/control files so hard code the
.         NMPI number to the U/R Number
.
          PACK      VARIABLE,SP10,SP2,PURNO  * set NMPI number to UR number
          GOTO      DFNP9999
.
. -----------------------------------------------------------------
. ------- get the national number for the patient from file -------
. -----------------------------------------------------------------
.
. ------- get national number from patnidaf or nhimasaf -------
.
DFNP0100  COMPARE   ONE,PTCNNMPI            * Yes. U/R Number
          GOTO      DFNP3000 IF NOT EQUAL   * using patnidfd
          COMPARE   ONE,PTCNNHII            * Yes. U/R Number
          GOTO      DFNP3000 IF NOT EQUAL   * using patnidfd
.
.         using NHIMASFD
.
          OPEN      NHIMASA2,"nhimasaf"
          PACK      KEY8,PURNO
          CALL      RDNHMAS2
          IF        OVRCD = 0
            PACK      VARIABLE,SP10,SP3,NHMANMPI
          ENDIF
          CLOSE     NHIMASA2
          GOTO      DFNP9999
.
.         using PATNIDFD
.
DFNP3000  OPEN      PATNIDA1,"patnidaf"
          PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          IF        OVRCD = 0
            PACK      VARIABLE,PTNINMPI
          ENDIF
          CLOSE     PATNIDA1
          GOTO      DFNP9999
.
          INC       PATNIDIO/INC
          INC       NHIMASIO/INC
          INC       IBAOVRIO/INC
.
DFNP9999  ENDPROC
.------------------------------------------------------------
. filled selection list
.------------------------------------------------------------
FILLST00  MATCH     "N",FILLEDRC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"N#" selected> New </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"N#"> New </option>"
          ENDIF
.
          MATCH     "A",FILLEDRC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"A#" selected> All </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"A#"> All </option>"
          ENDIF
.
          MATCH     "Y",FILLEDRC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"Y#" selected> Filled </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"Y#"> Filled </option>"
          ENDIF
.
          MATCH     "C",FILLEDRC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"C#" selected> Cancelled </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"C#"> Cancelled </option>"
          ENDIF
.
          MATCH     "P",FILLEDRC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"P#" selected> Process </option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"P#"> Process </option>"
          ENDIF
.

FILLST99  RETURN 
.------------------------------------------------------------
. INCEPI00 - Find last incomplete episode for medical record vol.      *I-51730
. Parameters - FORM1 0-display visit number 1-display visit date
.------------------------------------------------------------
INCEPI00  PACK     VARIABLE,SP70
.
          PACK     KEY18,MRMAKEY,Z70
          CALL     RSMRVS2
INCEPI10  CALL     RPMRVS2
          BRANCH   OVRCD,INCEPI99
.
          MATCH    MRMAKEY,MRVSMKEY
          GOTO     INCEPI99 IF NOT EQUAL
.
          PACK     KEY8,MRVSVSNO,SP70
          CALL     RDVISA1
          BRANCH   OVRCD,INCEPI10
.
          MATCH    "00000000",PVIDATE
          GOTO     INCEPI10 IF EQUAL
.
          COMPARE  "3",PVITYPE
          GOTO     INCEPI10 IF NOT EQUAL
.
          PACK     KEY8,PVIBILL,SP70
          CALL     RDMISS1
          BRANCH   OVRCD,INCEPI10
.
          COMPARE  "3",ASTAT
          GOTO     INCEPI10 IF NOT EQUAL
.
          MATCH    SP70,ACODDTE
          IF       @EQUAL
            IF       FORM1=ZERO
              MOVE     DAADMNO,VARIABLE
              GOTO     INCEPI99
            ELSE
              PACK     KEY8,PVIBILL,SP70
              CALL     RDDSCH1
              IF       OVRCD=0
                MATCH    SP70,DDATE
                IF       !@EQUAL & !@EOS
                  UNPACK   DDATE,CCENT,CYEAR,CMON,CDAY
                  CALL     PACDATE
                  PACK     VARIABLE,CPCDATE,SP70
                ENDIF
              ENDIF
              GOTO     INCEPI99
            ENDIF
          ENDIF
.
          GOTO     INCEPI10
.
INCEPI99  RETURN
.
.------------------------------------------------------------
. FINCEP00 - Find first 10 incomplete episodes this U/R
.------------------------------------------------------------
FINCEP00  BRANCH    LOADFLAG,FINCEP99            * Incompleted details loaded
.
          MOVE      ONE,LOADFLAG
          MOVE      ONE,VISCOUNT
          WHILE     VISCOUNT <= 10
            MOVE      SP70,INCVISIT[VISCOUNT]
            MOVE      SP70,INCOMDAT[VISCOUNT]
            ADD       ONE,VISCOUNT
          DO
          MOVE      ZERO,VISCOUNT
.
          PACK      SCANDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCANDATE                * Scan one years visits
          MOVE      365,F3
          SUB       F3,SCANDATE
.
          PACK      KEY24,PURNO,SCANDATE,SP70
          CALL      RSPTVIS2
FINCEP10  CALL      RKPTVIS2
          BRANCH    OVRCD,FINCEP99
.
          MATCH     PURNO,PVIURNO
          GOTO      FINCEP99 IF NOT EQUAL
.
          COMPARE   "3",PVITYPE
          GOTO      FINCEP10 IF NOT EQUAL
.
          MATCH     "00000000",PVIDATE
          GOTO      FINCEP10 IF EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,FINCEP10
.
          COMPARE   "3",ASTAT
          GOTO      FINCEP10 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            ADD       ONE,VISCOUNT
            MOVE      DAADMNO,INCVISIT[VISCOUNT]
            PACK      KEY8,PVIBILL,SP70
            CALL      RDDSCH1
            IF        OVRCD=0
              MATCH     SP70,DDATE
              IF        !@EQUAL & !@EOS
                UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
                CALL      PACDATE
                MOVE      CPCDATE,INCOMDAT[VISCOUNT]
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   TEN,VISCOUNT            * Found first 10 so exit
          GOTO      FINCEP99 IF EQUAL
.
          GOTO      FINCEP10
.
FINCEP99  RETURN
.------------------------------------------------------------
. Table of Request change history
.------------------------------------------------------------
HIST0000  PACK      KEY27,MRTRECKY,SP70
          CALL      ASMRRQH
HIST1000  CALL      AKMRRQH
          BRANCH    OVRCD,HIST9999
.
          MATCH     MRTRECKY,MRRQRQNO
          GOTO      HIST9999 IF NOT EQUAL
.
          UNPACK    MRRQDTRQ,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY10,MRRQUSUP,SP70  * Find out who holds the record now!
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE    MRRQUSUP,WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",MRRQRQNO,"</td>":
                             "<td>",KEY11," at ",MRRQTMRQ,"</td>":
                             "<td>",WBSENAM,"</td>":
                             "</tr>"
.
          GOTO        HIST1000
.
HIST9999  RETURN
.
.------------------------------------------------------------
. Display the original request date and time for this request
. if it has been changed.
.------------------------------------------------------------
GETO0000  MOVE      SP70,ORIGDATE
          MOVE      SP70,ORIGTIME
          PACK      KEY27,MRRQRQNO,SP70
          CALL      ASMRRQH
GETO1000  CALL      AKMRRQH
          BRANCH    OVRCD,GETO4500
.
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      GETO4500 IF NOT EQUAL
.
          MOVE      MRRQDTRQ,ORIGDATE
          MOVE      MRRQTMRQ,ORIGTIME
.
.                                           * re position after reading audit
GETO4500  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            MOVE      SAVKEY23,KEY23        * set in FILTB100
            CALL      RDMRRQH2
            BRANCH    OVRCD,GETO9000
          ELSE
            MOVE      SAVKEY30,KEY30        * set in FILTB100         *C-240724
            CALL      RDMRRQH3
            BRANCH    OVRCD,GETO9000
          ENDIF
.
          MATCH     SP70,ORIGDATE
          IF        !@EQUAL
            MOVE      ORIGDATE,MRRQDTRQ
          ENDIF
.
          MATCH     SP70,ORIGTIME
          IF        !@EQUAL
            MOVE      ORIGTIME,MRRQTMRQ
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GETO9999
.
GETO9000  MOVE      ONE,EXIT
          GOTO      GETO9999
.
GETO9999  RETURN
.
.------------------------------------------------------------
. Display the current request date and time for this request
.------------------------------------------------------------
GETC0000  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            MOVE      SAVKEY23,KEY23        * set in FILTB100
            CALL      RDMRRQH2
            BRANCH    OVRCD,GETC9000
          ELSE
            MOVE      SAVKEY30,KEY30        * set in FILTB100
            CALL      RDMRRQH3
            BRANCH    OVRCD,GETC9000
          ENDIF

          MOVE      ZERO,EXIT
          GOTO      GETC9999
.
GETC9000  MOVE      ONE,EXIT
          GOTO      GETC9999
.
GETC9999  RETURN
.
.------------------------------------------------------------
. Table of medical records for a patient - fill request update
.------------------------------------------------------------
REQTB000  MOVE      ZERO,COUNT
.
          CALL      MASHD000                * Output Table Heading
          MOVE      ZERO,NUM
.
          PACK      KEY20,MRTRECKY,SP70     * Read Request Detail
          CALL      RDMRRQD1
          BRANCH    OVRCD,REQTB999     
.           
          PACK      KEY10,MRRDRQNO,SP70     * Read Request header
          CALL      RDMRRQH1
          BRANCH    OVRCD,REQTB999
.
          MOVE      MRRDRKEY,KEY10          * Read Medical Record
          CALL      RDMRMAS2                * to get UR
          BRANCH    OVRCD,REQTB999
.
          MOVE      MRMAURNO,URNUMBER       
.
          RESET     MEDRR001
          MATCH     "All",MEDRR001
          IF        !@EQUAL
            MATCH     SP70,MEDRR001
            IF        !@EQUAL
              MOVE      MEDRR001,SAVDOCTY
            ELSE
              MOVE      Z70,SAVDOCTY
            ENDIF
          ELSE
            MOVE     Z70,SAVDOCTY
          ENDIF
.
          PACK      KEY20,URNUMBER,SAVDOCTY,Z70
          CALL      RSMRMAS4
REQTB100  CALL      RPMRMAS4
          BRANCH    OVRCD,REQTB999
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      REQTB999 IF NOT EQUAL
.
          RESET     MEDRR001
          MATCH     "All",MEDRR001
          IF        !@EQUAL
            MATCH     SP70,MEDRR001
            IF        !@EQUAL
              MATCH     MRMADOTY,MEDRR001
              IF        !@EQUAL
                GOTO      REQTB100
              ENDIF
            ENDIF
          ENDIF
. 
          UNPACK    SP70,MRLODESC,HLOCDSC1
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
....        MATCH     MRMAOHOS,MRMAHHOS
....        IF        !@EQUAL
....          PACK      KEY30,OBR,MRMAOHOS,CBR,SP20
....          APPEND    KEY30,KEY70
....        ENDIF
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
          MOVE      SP70,MRLODESC            
          PACK      HLOCDSC2,SP70,SP70
.
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
.
          IF        IBCNMHOS = 1
            CLEAR     KEY70                      * set Hospital colours
            PACK      KEY70,OBB,MRMACHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRMACHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRMACHOS
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      KEY70,OBR,MRMACHOS,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY70,OBR,MRMACHOS,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70             * format "(HOS)Location"
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC2                          * end     *I-240724
.
          MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20
.
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
.
          ADD       ONE,NUM
          PACK      KEY12,MRMAKEY,NUM
.
          PACK      KEY20,MRRQRQNO,MRMAKEY,SP70     * Read Request Detail
          CALL      RDMRRQD1
          IF        OVRCD=0
            MATCH     ANSN,MRRDFILL         * Check if this medical record
            GOTO      REQTB500 IF EQUAL      * has been requested
            MATCH     ANSP,MRRDFILL         * Check if this medical record
            GOTO      REQTB500 IF EQUAL      * has been requested
          ENDIF
.
          ADD       ONE,COUNT
          COMPARE   "99",COUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=5><font size=3>":
                               "Limit of 99 records reached!</td></tr>";
            GOTO      REQTB999
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td align=centre>":
                             DIM20,"</td><td>":
                             MRMAVOLN,"</td><td>":
                             MRMACOMM,"</td><td>":
                             HLOCDSC2,"</td><td>";
          MATCH     "1",HOMEFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;HLOCDSC1,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;TDESC,"</td><td>":
                             "<input type=checkbox name=recordky":
                             " onclick=WarnRecord(this) ":
                             " value='",KEY12,"'>":
                             "</td></tr>"
.
          GOTO      REQTB100
.
REQTB500  WRITE     HTMLFILE;"<tr><td align=centre>":
                             DIM20,"</td><td>":
                             MRMAVOLN,"</td><td>":
                             MRMACOMM,"</td><td>";
.
          MATCH     "1",HOMEFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;HLOCDSC1,"</td><td>";
          ENDIF
.
          WRITE     HTMLFILE;HLOCDSC2,"</td><td>":
                             TDESC,"</td><td>":
                             "<input type=checkbox name=recordky":
                             " value='",KEY12,"'checked>":
                             "</td></tr>"
.
          GOTO      REQTB100
.
REQTB999  RETURN
.
.------------------------------------------------------------
. Loop through UR numbers and save Requests
.------------------------------------------------------------
MRFIL000  MOVE      ZERO,MRCOUNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,SAVCOUNT
.
MRFIL010  ADD       ONE,MRCOUNT
          IF        MRCOUNT>MRKEYCNT
            GOTO       MRFIL999
          ENDIF
.
          MATCH     RECORDKY[MRCOUNT],SP70
          GOTO      MRFIL010 IF EQUAL
.
          MOVE      RECORDKY[MRCOUNT],KEY10
          CALL      RDMRMAS2
          BRANCH    OVRCD,MRFIL090
.
          PACK      KEY20,MRRQRQNO,MRMAKEY,SP70
          UNPACK    KEY20,MRRDRQNO,MRRDRKEY
          CALL      RDMRRQD1
          IF        OVRCD=0
            MOVE      "Y",MRRDFILL     * Update to Filled
            PACK      MRRDFUID,USERID,SP70
            CALL      UPMRRQD1
          ELSE
            MOVE      "Y",MRRDFILL     * Update to Filled
            PACK      MRRDFUID,USERID,SP70
            CALL      WRMRRQD1     * write to the medical record request Details
          ENDIF
.
          CALL      SAVHIS00         * Writes History record for a movement
          BRANCH    EXIT,UPDFIL90
.
          GOTO      MRFIL010
.
MRFIL090  ADD       ONE,ERRORCNT
          IF        ERRORCNT > 99
            GOTO      MRFIL010
          ENDIF
          CLEAR     ERRORLST[ERRORCNT]
          APPEND    "Invalid MR Key - ",ERRORLST[ERRORCNT]
          APPEND    KEY10,ERRORLST[ERRORCNT]
          RESET     ERRORLST[ERRORCNT]
          GOTO      MRFIL010
.
MRFIL999  RETURN
+
.------------------------------------------------------------------------------
. Schedule Group Label Printing 
.------------------------------------------------------------------------------
PRTGPL00  MATCH     SP70,UPDATETY
          GOTO      PRTGPL70 IF EQUAL
.
          MATCH     "1",UPDATETY
          GOTO      PRTGPL20 IF EQUAL
.
          GOTO      PRTGPL90
.
.         ************ Schedule Print Labels **********
.
PRTGPL20  CALL      SGPL0000                * Schedule group label printing
          GOTO      PRTGPL99
.
.         ************ DISPLAY FORMACTION **********
.
PRTGPL70  CLEAR     WEBTITLE
          MOVE      "Group Label Printing",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRTGPL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL99  RETURN
+
.------------------------------------------------------------------------------
. Schedule Group Label Printing  
.------------------------------------------------------------------------------
SGPL0000  MOVE      ZERO,MRCOUNT
          MOVE      ZERO,COUNT
.         
SGPL0100  ADD       ONE,MRCOUNT
          ADD       ONE,COUNT
          IF        MRCOUNT>MRKEYCNT
            GOTO       SGPL9999
          ENDIF
.
          MATCH     SP70,MRKEYARR[MRCOUNT]
          GOTO      SGPL0100 IF EQUAL
.
          CALL      PRNT0000
.
          GOTO      SGPL0100
.
SGPL9999  RETURN
+
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  CALL      CLRPRT00 
          PACK      KEY10,MRKEYARR[MRCOUNT],SP70
          CALL      RDMRMAS2
          IF        OVRCD=1
            MOVE      "Invalid medical record ",WEBTITLE
            GOTO      PRNT9000
          ENDIF
.
          MOVE      MRMAURNO,URNUMBER
          MOVE      ZERO,ADMISSNO
          MOVE      SP70,SUBSYSKY
          MOVE      SP70,STATNCOD
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
.
          MATCH     "1",LABPRT01
          GOTO      PRNT0010 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          PACK      LABELTYP,LABELADD,ZERO,ONE,SP70
.
          MOVE      LABELADD,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0010  MATCH     "1",LABPRT02
          GOTO      PRNT0700 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          PACK      LABELTYP,LABELPMI,ZERO,ONE,SP70
.
          MOVE      LABELPMI,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0700  MOVE      ZERO,EXIT
          GOTO      PRNT9999
.
PRNT9000  CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRNT9999
.
PRNT9999  RETURN
+
.*******************************************************************************
.                 Clear Variables for Printing Control Table
.*******************************************************************************
CLRPRT00  MOVE      Z70,IBLPSCHE
          MOVE      Z70,IBLPURNO
          MOVE      Z70,IBLPVISN
          MOVE      Z70,IBLPSKEY
          MOVE      Z70,IBLPPRNT
          MOVE      ZERO,IBLPCOPY
          MOVE      Z70,IBLPSTAT
          MOVE      Z70,IBLPLAPR
          MOVE      Z70,IBLPLASC
          MOVE      Z70,IBLPFRE1
          MOVE      Z70,IBLPFRE2
          MOVE      Z70,IBLPFRE3
          MOVE      Z70,IBLPFRE4
          MOVE      Z70,IBLPFRE5
          MOVE      Z70,IBLPFRE6
          MOVE      Z70,IBLPFRE7
          MOVE      Z70,IBLPRUID
          MOVE      Z70,IBLPRDAT
          MOVE      Z70,IBLPRTIM
.
CLRPRT99  RETURN
.                          
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
.
.------------------------------------------------------------
. Remote script to check for new medical record requests
. after a given date/time 
.------------------------------------------------------------
REMCHK00  CALL      XMLHED00
          BRANCH    EXIT,REMCHK99
.
          MOVE      ZERO,NEWRFLAG                * New requests flag
.
          PACK      KEY23,VALDDATE,VALDTIME,SP70
          CALL      RSMRRQH5
REMCHK10  CALL      RKMRRQH5
          BRANCH    OVRCD,REMCHK80
.
          MATCH     VALDDATE,MRRQDTRQ            * Request for today
          GOTO      REMCHK10 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,MRRQHOSC
              GOTO      REMCHK10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70                * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD = 1
                PACK      KEY13,USERID,MRRQHOSC,SP70     * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,REMCHK10
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTLOCN
          IF        !@EQUAL
            MATCH     FILTLOCN,MRRQLOCR
            GOTO      REMCHK10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,URGENCYR
          IF        !@EQUAL
            MATCH     URGENCYR,MRRQURGY
            GOTO      REMCHK10 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",BULKFLAG      
          IF        @EQUAL
            PACK      KEY10,MRRQRQNO,SP70
            CALL      RDMRBRH1                   * New bulk request
            BRANCH    OVRCD,REMCHK10
          ELSE
            PACK      KEY10,MRRQRQNO,SP70
            CALL      RDMRBRH1                   * New single request
            IF        OVRCD=0
              GOTO      REMCHK10
            ENDIF
          ENDIF
.
          PACK      KEY20,MRRQRQNO,SP70
          CALL      RSMRRQD1
REMCHK20  CALL      RKMRRQD1
          BRANCH    OVRCD,REMCHK10
.
          MATCH     MRRQRQNO,MRRDRQNO
          GOTO      REMCHK10 IF NOT EQUAL
.
          MATCH     ANSN,MRRDFILL
          GOTO      REMCHK20 IF NOT EQUAL
.
          MOVE      ONE,NEWRFLAG
.
REMCHK80  PACK      KEY8,CCC,CYY,CMM,CDD,SP70    * Return Current Date
          REP       " 0",KEY8
          WRITE     HTMLFILE;KEY8;
.
          CLOCK     TIME,VALDTIME                * Return Current Time
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NEWRFLAG,"|",VALDDATE,"|",VALDTIME:
                             "</RETURN_VALUE>"
          GOTO      REMCHK95
.
REMCHK95  CALL      XMLEND00
REMCHK99  RETURN
.
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
OPNOUT99 RETURN
.
.------------------------------------------------------------
. Receive Medical Records
.------------------------------------------------------------
RECV0000  RESET     UPDATETY
          MATCH     SP1,UPDATETY
          GOTO      RECV5000 IF EQUAL

          MATCH     "A",UPDATETY            * Receive formaction
          GOTO      RECV1000 IF EQUAL
.
          GOTO      RECV9000
.
.        *********** RECEIVE FORMACTION ***********
.
RECV1000  CALL      RARR0000                * Loop array and receive records
          BRANCH    EXIT,RECV9999
.
          MOVE      ZERO,EXIT
          GOTO      RECV9999
.
. *************** Display **********************
.
RECV5000  MATCH     "002",TEMPLATE
          GOTO      RECV5010 IF NOT EQUAL
.
          CALL      ITURAD00
.
RECV5010  MOVE      "Receive Medical Records",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,RECV9999
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      RECV9999
.
RECV9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECV9999
.
RECV9999  RETURN
.
.-----------------------------------------------------------
. Loop array and receive medical records
.-----------------------------------------------------------
RARR0000  COMPARE   ZERO,MRKEYCNT
          GOTO      RARR9000 IF EQUAL
.
RARR0100  MOVE      ZERO,MRCOUNT
          MOVE      ZERO,ERRORCNT
.
RARR1000  ADD       ONE,MRCOUNT
          IF        MRCOUNT>MRKEYCNT
            GOTO       RARR9999
          ENDIF
.
          REP       "+ ",MRKEYARR[MRCOUNT]            * Remove + padding
.
          MATCH     SP70,MRKEYARR[MRCOUNT]
          GOTO      RARR1000 IF EQUAL
.
          PACK      KEY20,MRKEYARR[MRCOUNT],SP70
          CALL      RDMRMAS1                          * Read MR master
          BRANCH    OVRCD,RARR9100
.           
RARR1100  PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                          * Read histiory to get
          BRANCH    OVRCD,RARR6000                    * In transit record
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      RARR6000 IF NOT EQUAL
.
          MATCH     "1",MRHIRCST                      * In transit
          GOTO      RARR6000 IF NOT EQUAL
.
          MOVE      "2",MRHIRCST            * Received
          MOVE      RECVDATE,MRHIRCDT       * Received Date
          MOVE      RECVTIME,MRHIRCTM       * Received Time
          MOVE      USERID,MRHIRCUI         * received By
.
          MATCH     MRHIDHOS,RECVHOSP
          GOTO      RARR5000 IF NOT EQUAL
.
          MATCH     MRHILOC,RECVLOCN    
          GOTO      RARR5000 IF NOT EQUAL                        
.
          MATCH     SP70,MVMTCOMM
          IF        !@EQUAL
            MOVE      MVMTCOMM,MRHICOMM            * C-261931
          ENDIF
.
          CALL      UPMRHIS1
          GOTO      RARR7000                    * Fill any oustanding requests
.
. Track MR to the receiving location if it was in transit to another location 
.
RARR5000  PACK      MRHIDHOS,RECVHOSP,SP70      * Update history record location
          PACK      MRHILOC,RECVLOCN,SP70
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP70
          CALL      RDMRLOC1
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT     * external
          ELSE
            MOVE      TWO,MRHISTAT     * internal
          ENDIF
.
          MATCH     SP70,MVMTCOMM
          IF        !@EQUAL
            MOVE      MVMTCOMM,MRHICOMM            * C-261931
          ENDIF
.
          CALL      UPMRHIS1
.
          PACK      MRMACHOS,RECVHOSP,SP70       * Update MR Current location
          PACK      MRMACLOC,RECVLOCN,SP70
.
          CALL      UPMRMAS1
.
          GOTO      RARR7000
.
. Track MR to the receiving location as it was not in transit and fill any
. oustanding requests for the same location 
.
RARR6000  CALL      CLMRTHIS                    * Clear MRT History record
.
          MOVE      MRMAKEY,MRHIKEY             * Medical Record Key
          MOVE      RECVDATE,MRHIDATE           * Date of Movement received date
          MOVE      RECVTIME,MRHITIME           * Time of Movement received time
          MOVE      "3",MRHIRCST                * Sent Direct
          MOVE      RECVDATE,MRHIRCDT           * Received Date
          MOVE      RECVTIME,MRHIRCTM           * Received Time
          MOVE      USERID,MRHIRCUI             * Received By
          MOVE      RECVREAS,MRHIREAS           * Reason
.
          PACK      MRHIDHOS,RECVHOSP,SP70      * Update history record location
          PACK      MRHILOC,RECVLOCN,SP70
.
          PACK      KEY4,MRHIREAS,SP70
          CALL      RDMRMOV1
          BRANCH    OVRCD,RARR6500
.
          MOVE      CURRDATE,WORKDATE
          ADD       MRMOPERD,WORKDATE       * add Loan Period (Days)
          MOVE      WORKDATE,MRHIDDUE       * set "Due Date"
.
RARR6500  PACK      KEY7,MRHIDHOS,MRHILOC,SP70                        *C-240724
          CALL      RDMRLOC1
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT     * external
          ELSE
            MOVE      TWO,MRHISTAT    * internal
          ENDIF
.
          MOVE      WBSEUID,MRHIUSID    * Web User ID
.
          MATCH     SP70,MVMTCOMM
          IF        !@EQUAL
            MOVE      MVMTCOMM,MRHICOMM            * C-261931
          ENDIF
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD = 0
            CALL      UPMRHIS1              * Update if record exists
          ELSE
            CALL      WRMRHIS1              * Write a new record
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICRM              * DG API Med.Rec.Movement
          ENDIF
.
          PACK      MRMACHOS,RECVHOSP,SP70       * Update MR Current location
          PACK      MRMACLOC,RECVLOCN,SP70
.
          CALL      UPMRMAS1
.
RARR7000  PACK      PRV2DATE,RECVDATE            * Requests within 2 days
          SUB       TWO,PRV2DATE
.
          PACK      KEY20,MRMAKEY,SP70
          CALL      RSMRRQD2
RARR7100  CALL      RKMRRQD2
          BRANCH    OVRCD,RARR1000
.
          MATCH     MRMAKEY,MRRDRKEY             * Request for this MR
          GOTO      RARR1000 IF NOT EQUAL
.
          MATCH     ANSN,MRRDFILL                * New
          GOTO      RARR7100 IF NOT EQUAL
.
          PACK      KEY10,MRRDRQNO
          CALL      RDMRRQH1
          BRANCH    OVRCD,RARR7100
.
          MATCH     PRV2DATE,MRRQDTRQ            * Requests in the last 2 days
          GOTO      RARR7100 IF LESS
.         
          MATCH     MRRQDTRQ,RECVDATE            * Skip future requests
          GOTO      RARR7100 IF LESS
.
          MATCH     MRRQDTRQ,RECVDATE            * Not future time
          IF        @EQUAL
            MATCH     MRRQTMRQ,RECVTIME
            GOTO      RARR7100 IF LESS
          ENDIF
.
          MATCH     RECVHOSP,MRRQHOSC            * Same requested hospital
          GOTO      RARR7100 IF NOT EQUAL
.
          MATCH     RECVLOCN,MRRQLOCR            * Same required hospital
          GOTO      RARR7100 IF NOT EQUAL
.
          MOVE      "Y",MRRDFILL                 * Update to Filled
          PACK      MRRDFUID,USERID,SP70
          CALL      UPMRRQD2
.
          GOTO      RARR1000
.
RARR9000  MOVE      "No Medical Records Selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RARR9999
.
RARR9100  ADD       ONE,ERRORCNT
          IF        ERRORCNT <=99
            CLEAR     ERRORLST[ERRORCNT]
            APPEND    "Invalid Medical Record - ",ERRORLST[ERRORCNT]
            APPEND    KEY20,ERRORLST[ERRORCNT]
            RESET     ERRORLST[ERRORCNT]
          ENDIF
          GOTO      RARR1000
.
RARR9999  RETURN
.
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Receive Medical Records
.----------------------------------------------------------------------
WARLST00  CALL      OPENHTML
          BRANCH    EXIT,WARLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ";
          COMPARE   ZERO,ERRORCNT
          GOTO      WARLST20 IF EQUAL
.
          MOVE      ONE,F2
WARLST10  WRITE     HTMLFILE;"    alert(#"",ERRORLST[F2],"#");",012
          ADD       ONE,F2
          COMPARE   F2,ERRORCNT
          GOTO      WARLST20 IF LESS
          GOTO      WARLST10
.
WARLST20  WRITE     HTMLFILE;" if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  location.href=#"",REDIRECT,"#";":
                             "  } ":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WARLST98
.
WARLST95  DISPLAY   "*** Fifo Not Found ***"
.
WARLST98  MOVE      ZERO,ERRORCNT
WARLST99  RETURN
.
.------------------------------------------------------------
. Receive Record tags 
.------------------------------------------------------------
RTAG0000  BRANCH    FLDITMNO,RTAG0100,RTAG0200,RTAG0300,RTAG0400,RTAG0500:
                             RTAG0600,RTAG0700
          GOTO      RTAG9999
.
RTAG0100  WRITE     HTMLFILE;SUPERLEV;      * Supervisor level
          GOTO      RTAG9999
.
RTAG0200  MOVE      WBSEUTLH,SELHOSP        * Usual tracking location hospital
          CALL      HSEL0000
          GOTO      RTAG9999
.
RTAG0300  WRITE     HTMLFILE;WBSEUTLC;      * Usual tracking location code
          GOTO      RTAG9999
.
RTAG0400  MOVE      SP3,DFLTHOSP            * Home Hospital and Location
          MOVE      MRCNHLOC,DFLTHLOC
.
.         Check if the user has Home Hospital &/or Location, if so, set Defaults
.         Otherwise, check if Multi Hospital exists then Read Hospital file
.         and use Home Hospital and Home Location.
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHHOS,DFLTHOSP
            MOVE      WBSEHLOC,DFLTHLOC
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,RTAG0405
.
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DFLTHOSP
                MOVE      PTHSHLOC,DFLTHLOC
              ENDIF
            ENDIF
          ENDIF
.                                           * set memory for Filter Hosp & Locn
RTAG0405  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RTAG0406
.
          MOVE      DFLTHOSP,SELHOSP        * Home Hospital Id Code
          CALL      HSEL0000
          GOTO      RTAG9999
.
RTAG0406  WRITE     HTMLFILE;DFLTHLOC;      * Home Location Code
          GOTO      RTAG9999
.
RTAG0500  MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      MRCNRCTY,CODE           * System Parameter default type
.
          MATCH     SP70,WBSEDTYP
          IF        !@EQUAL
            MOVE      WBSEDTYP,CODE
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SP70,PTHSRCTY
                IF        !@EQUAL
                  MOVE      PTHSRCTY,CODE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      CODITM00
          GOTO      RTAG9999
.
RTAG0600  CALL      MOVREA00                * Selection List of Reasons
          GOTO      RTAG9999
.
RTAG0700  CALL      TBLMRT00                * Table of Movements
          GOTO      RTAG9999
.
RTAG9999  RETURN
.
.------------------------------------------------------------
. Remote scripts for receive medical records
.------------------------------------------------------------
REMREC00  CALL      XMLHED00
          BRANCH    EXIT,REMREC99
.
          MATCH     "V",UPDATETY            * Validate record is in transit
          GOTO      REMREC10 IF EQUAL       * to this location
.
          MATCH     "R",UPDATETY            * Validate record retention details
          GOTO      REMREC20 IF EQUAL
.
          MATCH     "S",UPDATETY            * Validate record status
          GOTO      REMREC30 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      REMREC40 IF EQUAL
.
          MATCH     "M",UPDATETY            * Regenerate table of received MR based
          GOTO      REMREC50 IF EQUAL       * on Home Location/Doc Type
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMREC90
.
REMREC10  CALL      VTRN0000                * Validate record in transit
          GOTO      REMREC90 
.
REMREC20  CALL      VRET0000                * Validate record retention details
          GOTO      REMREC90 
.
REMREC30  CALL      VSTA0000                * Validate record status
          GOTO      REMREC90 
.
REMREC40  CALL      PLOC0000
          GOTO      REMREC90
.
REMREC50  MOVE      ONE,MRTBLREM
          CALL      TBLMRT00
          MOVE      ZERO,MRTBLREM
          GOTO      REMREC90
.
REMREC90  CALL      XMLEND00
.
REMREC99  RETURN
.
.---------------------------------------------------------------------------
.
.---------------------------------------------------------------------------
ITURAD00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ITURAD95
          CALL      RDPMPX21
          BRANCH    OVRCD,ITURAD95
          GOTO      ITURAD99
.
ITURAD95  MOVE      "Patient Master Details dont exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ITURAD99

ITURAD99  RETURN
.
.---------------------------------------------------------------------------
. Validate medical record is in transit to this location
.---------------------------------------------------------------------------
VTRN0000  PACK      KEY20,MRKEYARR[ONE],SP70
          CALL      RDMRMAS1                          * Read MR master
          BRANCH    OVRCD,VTRN9000
.
          MOVE      SP70,DOCTDESC
          PACK      KEY5,ANST,ANSY,MRMADOTY,SP70     * Document Type
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      MRMADOTY,TDESC
          ENDIF
          MOVE      TDESC,DOCTDESC
.
          MOVE      SP70,PTHSNAME
          PACK      KEY3,MRMAHHOS,SP70                * Home Hospital
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      MRMAHHOS,PTHSNAME
          ENDIF
.
          MOVE      SP70,DESTDESC
          MOVE      SP70,HOMEDESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP70       * Home Location
          CALL      RDMRLOC1
          IF        OVRCD=1
            PACK      MRLODESC,MRMAHHOS,MRMAHLOC,SP70
          ENDIF
          MOVE      MRLODESC,HOMEDESC
.
          MOVE      ONE,RECDIREC                      * Receive Direct - Yes
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                          * Read histiory to get
          BRANCH    OVRCD,VTRN8000                    * In transit record
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      VTRN8000 IF NOT EQUAL
.
          MATCH     "1",MRHIRCST                      * In transit
          GOTO      VTRN8000 IF NOT EQUAL
.
          MOVE      ZERO,RECDIREC                    * Receive direct - No
.
          MOVE      SP70,DESTDESC
          PACK      KEY7,MRHIDHOS,MRHILOC,SP70       * Destination Location
          CALL      RDMRLOC1
          IF        OVRCD=1
            PACK      MRLODESC,MRHIDHOS,MRHILOC,SP70
          ENDIF
          MOVE      MRLODESC,DESTDESC
.
          MATCH     MRHIDHOS,RECVHOSP                 * Check Location Hospital
          GOTO      VTRN9200 IF NOT EQUAL
.
          MATCH     MRHILOC,RECVLOCN                  * Check Location
          GOTO      VTRN9200 IF NOT EQUAL
.
VTRN8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    MRMAURNO,"|",PTHSNAME,"|",HOMEDESC,"|",DOCTDESC:
                    "|",DESTDESC,"|",RECDIREC:
                    "</RETURN_VALUE>"
.
          GOTO      VTRN9999
.
VTRN9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Medical Record - ",KEY20:
                    "</RETURN_VALUE>"
          GOTO      VTRN9999
.
VTRN9200  STRIP     PTHSNAME
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>"
          WRITE     HTMLFILE;"Medical Record : ",MRMAURNO
          WRITE     HTMLFILE;*+,"Home Location : ",PTHSNAME,SP1,HOMEDESC
          WRITE     HTMLFILE;"Document Type : ",DOCTDESC
          WRITE     HTMLFILE;"Volume : ",MRMAVOLN
          WRITE     HTMLFILE;" "
          WRITE     HTMLFILE;"In transit to destination : ",DESTDESC
          WRITE     HTMLFILE;"OK to track record to receiving location, ":
                             "Cancel to Abort"
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          RESET     PTHSNAME
          GOTO      VTRN9999
.
VTRN9999  RETURN
.
.---------------------------------------------------------------------------
. List all medical record movements
.---------------------------------------------------------------------------
TBLMRT00  IF        MRTBLREM=1
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,TBLMRT05
            CALL      RDPMPX21
            BRANCH    OVRCD,TBLMRT05
            GOTO      TBLMRT07
TBLMRT05    WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        " Patient Master Details Do Not Exist ":
                        "</RETURN_VALUE>"
            GOTO      TBLMRT99
TBLMRT07    WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          ENDIF
          MOVE      ZERO,COUNT
.
          MOVE      SP10,WBSEHOSP                                     
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
            MOVE      SP3,PTHSHHOS
            PACK      KEY3,WBSEHOSP
            CALL      RDPTHSP1
            MOVE      PTHSHHOS,ALTHOHOS
          ENDIF
.
          PACK      KEY20,URNUMBER,Z70
          CALL      RSMRMAS3
TBLMRT10  CALL      RPMRMAS3
          BRANCH    OVRCD,TBLMRT99
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      TBLMRT99 IF NOT EQUAL
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1
          BRANCH    OVRCD,TBLMRT10
.
          MATCH     "1",MRHIRCST                 * In Transit
          GOTO      TBLMRT10 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            IF        !@EQUAL
              MATCH     WBSEHOSP,MRMAHHOS   * is Users Hosp = MR Home Hosp
              GOTO      TBLMRT15 IF EQUAL
              MATCH     WBSEHOSP,MRMAOHOS   * is User Hosp = Originating Hosp
              GOTO      TBLMRT15 IF EQUAL
              MATCH     ALTHOHOS,MRMAHHOS   * is Alt Home Hosp = MR Home Hosp
              GOTO      TBLMRT15 IF EQUAL
              GOTO      TBLMRT10
            ENDIF
          ENDIF
.                                                                     
TBLMRT15  MOVE      SP70,MRLODESC           * Home Location
          MOVE      SP70,HMLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC                            
          CALL      RDMRLOC1
.
          MATCH     SP70,HOMLOCRM           * Check for home location filter
          IF        !@EQUAL                             
            MATCH     MRLOCODE,HOMLOCRM
            IF        !@EQUAL
	      GOTO      TBLMRT10
            ENDIF
          ENDIF
.
          PACK      KEY70,MRLODESC,SP70                   
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
            RESET     KEY70
          ENDIF
          MOVE      KEY70,HLOCDSC1                  
.
TBLMRT40  MOVE      SP70,MRLODESC           * Current Location
          PACK      KEY7,MRMACHOS,MRMACLOC                            
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRMACHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRMACHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRMACHOS            * current hosp
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS        * same as the home hospital?
              IF        !@EQUAL
                PACK      KEY30,OBR,MRMACHOS,CBR     * red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         
                CALL      RDCODE1
                MATCH     "B",TCINDC1
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRMACHOS,CBR   * red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
            RESET     KEY70
          ENDIF
.
          CALL      ITRN0000                     * Check if in transit
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      HLOCDSC2,INTRANST,KEY70
          ELSE
            MOVE      KEY70,HLOCDSC2
	  ENDIF               
.
          MATCH     SP70,MRMAOHOS
          IF        !@EQUAL
            MOVE      SP70,ORIGHOSP
            PACK      KEY3,MRMAOHOS
            CALL      RDPTHSP1
            MOVE      PTHSNAME,ORIGHOSP
          ENDIF
.
          MATCH     SP70,DOCTYPRM              * Check for document type filter
          IF        !@EQUAL                    
            MATCH     MRMADOTY,DOCTYPRM
            IF        !@EQUAL
              GOTO      TBLMRT10
            ENDIF
          ENDIF
          MOVE      CODETY,CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20A                                      
.
          MOVE      CODERS,CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        @EQUAL
            MOVE      "&nbsp;",TDESC
          ENDIF
.
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,DMRMAVOL
.
TBLMRT50  WRITE     HTMLFILE;"<tr>"
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td>",ORIGHOSP,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DIM20A,"</td>":
                         "<td align='center'>",MRMAVOLN,"</td>":
                         "<td>",MRMACOMM,"</td>":
                         "<td>",HLOCDSC2,"</td>":
                         "<td><span style=color:",PTCDUDF3,">":
                         TDESC,"</span></td>":
                         "<td>","<input type=checkbox name=mrkeyarr":
                         " value='",KEY20,"'></td></tr>"
.
.           WRITE     HTMLFILE;"t.addRow(#"",ORIGHOSP,"#",":             * 0
.                              "#"",DIM20A,"#",":                        * 1
.                              "#"",MRMAVOLN,"#",":                      * 2
.                              "#"",MRMACOMM,"#",":                      * 3
.                              "#"",HLOCDSC2,"#",":                      * 4
.                              "#"",TDESC,"#",":                         * 5
.                              "#"<input type=checkbox name=mrkeyarr value='":
.                                 KEY20,"'>":
.                                 "#");"                                 * 6
.
          ADD       ONE,COUNT
          COMPARE   "99",COUNT

          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=6><font size=3>":
                               "Limit of 99 records reached!</td></tr>";
            GOTO      TBLMRT99
          ENDIF
          GOTO      TBLMRT10
.
TBLMRT99  IF        MRTBLREM=1
            WRITE     HTMLFILE;"</RETURN_VALUE>";
          ENDIF
          RETURN
.
.---------------------------------------------------------------------------
. Validate medical record retention details
.---------------------------------------------------------------------------
VRET0000  MOVE      MRKEYARR[ONE],KEY8
          CALL      RDPMPX21                          * read retention fields
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     CURRDATE,PMPXRDAT
          GOTO      VRET8000 IF EQUAL
          GOTO      VRET8000 IF LESS
.
          PACK      KEY7,RECVHOSP,RECVLOCN,SP70      * Destination Location
          CALL      RDMRLOC1
          BRANCH    OVRCD,VRET8000
.
          PACK      KEY5,ANSL,ANST,MRLOTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VRET8000
.
          CMATCH    "D",TCINDC1
          GOTO      VRET8000 IF NOT EQUAL
.
          STRIP     MRLODESC
          UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>"
          WRITE     HTMLFILE;"U/R Number has a Retention Date ",CPCDATE,"."
          WRITE     HTMLFILE;"Do you want to continue to move it to this ":
                             "location (",*+,MRLODESC,") which is ":
                             "flagged as 'Destroyed'? "
          WRITE     HTMLFILE;" "
          WRITE     HTMLFILE;"Ok or Cancel to Abort"
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VRET9999
.
VRET8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMPXURNO:
                    "</RETURN_VALUE>"
          GOTO      VRET9999
.
VRET9999  RETURN
+
.---------------------------------------------------------------------------
. Validate medical record status
.---------------------------------------------------------------------------
VSTA0000  MOVE      MRKEYARR[ONE],KEY8
          CALL      RDPMPX21                          * read retention fields
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     CURRDATE,PMPXRDAT
          GOTO      VSTA8000 IF EQUAL
          GOTO      VSTA8000 IF LESS
.
          PACK      KEY5,ANSR,ANSS,RECDSTAT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VSTA8000
.
          CMATCH    "D",TCINDC2
          GOTO      VSTA8000 IF NOT EQUAL
.
          STRIP     TDESC
          UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>"
          WRITE     HTMLFILE;"U/R Number has a Retention Date ",CPCDATE,"."
          WRITE     HTMLFILE;"Do you want to change it to this status ":
                             "(",*+,TDESC,") which is ":
                             "flagged as 'Destroyed'? "
          WRITE     HTMLFILE;" "
          WRITE     HTMLFILE;"Ok or Cancel to Abort"
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VSTA9999
.
VSTA8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMPXURNO:
                    "</RETURN_VALUE>"
          GOTO      VSTA9999
.
VSTA9999  RETURN
+
.---------------------------------------------------------------------------
. Return all relevant location code and their status
.---------------------------------------------------------------------------
PLOC0000  MOVE      SP10,WBSEHOSP
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
          ENDIF
.
          MOVE     ZERO,COUNTER1
          WRITE    HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK     KEY7,WBSEHOSP,SP70
          CALL     RSMRLOC1
PLOC1000  CALL     RKMRLOC1
          BRANCH   OVRCD,PLOC9000
.
          MATCH    WBSEHOSP,MRLOHOSP               * Logged into Hospital ID
          GOTO     PLOC9000 IF NOT EQUAL
.
          IF       COUNTER1<>0
            WRITE    HTMLFILE;"|";
          ENDIF
          WRITE    HTMLFILE;"",MRLOCODE,",",MRLOTREC;
          ADD      ONE,COUNTER1
          GOTO     PLOC1000
.
PLOC9000  WRITE    HTMLFILE;"</RETURN_VALUE>"
.
PLOC9999  RETURN
+
.---------------------------------------------------------------------------
. Check if this MR is in transit to the current location
.---------------------------------------------------------------------------
ITRN0000  MOVE      SP70,INTRANST                * Clear in transit display
.
          MATCH     "1",MRCNTREC                 * System Using Tracking Receipt
          GOTO      ITRN9999 IF NOT EQUAL
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                     * Read last history record
          BRANCH    OVRCD,ITRN9999
.
          MATCH     MRMAKEY,MRHIKEY              * Correct MR history record
          GOTO      ITRN9999 IF NOT EQUAL
.
          MATCH     MRMACHOS,MRHIDHOS            * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current hospital
.
          MATCH     MRMACLOC,MRHILOC             * Check last history record matches 
          GOTO      ITRN9999 IF NOT EQUAL        * the current location
.
          MATCH     "1",MRHIRCST                 * In Transit
          GOTO      ITRN9999 IF NOT EQUAL
.
          MOVE      "<font color=red>(T)</font>",INTRANST
.
ITRN9999  RETURN
.
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       IBALPCCD
          INC       PATDOCCD
          INC       PATMASTM
          INC       CLPATMAS                * Clear master file variables
          INC       CLPMSPX2
          INC       CLMRTHIS                * clear MRT History record   
          INC       DGCLICRM                * DG API Med.Rec.Movement  *I-90201
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATMSXTM
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC
          INC       EMRVISIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCTYIO/INC
          INC       OUTHEDIO/INC
          INC       OUTSESIO/INC
          INC       PATVADIO/INC
          INC       PATDADIO/INC
          INC       IBALPCIO/INC
          INC       IBATMDIO/INC
          INC       MRTREQIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCMCIO/INC
          INC       PATDGWIO/INC
          INC       PATDSCIO/INC
          INC       PATHSPIO/INC
          INC       PATFN1IO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PATMI1IO/INC
          INC       PATRE1IO/INC
          INC       PATWR1IO/INC
          INC       PATDO1IO/INC
          INC       MLTSECIO/INC
          INC       MRTMASIO/INC
          INC       MRTLOCIO/INC
.
          INC       PATATRIO/INC
          INC       MULBIR00
.
          INC       MRTRQHIO/INC
          INC       MRTRQDIO/INC
          INC       MRTBRHIO/INC
          INC       MRTREDIO/INC
          INC       MRTREXIO/INC
          INC       MRTSTFIO/INC
          INC       PATPR1IO/INC
          INC       PATASFIO/INC
          INC       PATALRIO/INC
          INC       PATVISIO/INC
          INC       RESLNKIO/INC
          INC       OUTSITIO/INC
          INC       MRTMOVIO/INC
          INC       MRTHISIO/INC
          INC       MRTVISIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       PATDOCTM
          INC       PATNAMCD
          INC       DAYOFWEK
          INC       WEBDATCD
          INC       GETALTID
          INC       TRKALTCD
          INC       MRTRKSEQ
.
