.***************************************************************************
.* System    :   OUTPATIENTS                                               *
.* Program   :   IBAOUT06                                                  *
.* Desc      :   Multi Therapist View Extract                              *
.***************************************************************************
.* Date      :   17/11/2008                                                *
.* Author    :   Peter Vela                                                *
.* Function  :   This program extracts the outpatient clinic schedule      *
.*               according to the Group Session HCP in outsesaf            *
.* Mods      :                                                             *
.***************************************************************************
.* V12.00.01 28/05/2025  PJ Le Febour     TSK 0955096 AlphaNum visitinum   *
.*           replace COMPARE   ZERO,OBAOUTNO with MATCH ZEROVISN,OBAOUTNO  *
.* V11.02.01 09/02/2022  Thanh T          TSK 0905641                      *
.*           Recompiled as OUTHEDFD/OUTMA1FD changes                       *
.* V10.04.01 23/06/2014 J.Tan           CAR 261630                         *
.*           Removed port number from temp file name                       *
.* V10.03.01 27/02/2012 Peter McMullen    259857                           *
.*           remove reference to file patyear1                             *
.*                V9.12.01  26/08/2009  Peter McMullen CAR 171901          *
.*                         remove MAPCAT00 call                            *
.*               V9.11.04  09/12/2008 Peter Vela CAR 185002                *
.*                         Added comments to unavailable slots             *
.*                         Added UR number to patient display              *
.*               V9.11.03  09/12/2008 Peter Vela CAR 185002                *
.*                         Added default values to empty time range        *
.*                         parameters OTCNMTVS OTCNMTVE                    *
.*               V9.11.02  26/11/2008 Peter Vela CAR 181690                *
.*                         Increased to 20 people per timeslot.            *
.*                         Decreased number of clinics to 43.              *
.*               V9.11.01  17/11/2008 Peter Vela CAR 181690                *
.*                         Created extract program                         *
.***************************************************************************
.
          INC       STD001FD
          INC       IBASEQFD/INC            * Sequential Numbers File
          INC       TFILEVAR/INC            * Generate Temp File Name
          INC       WEBERRFD/INC            * Web Server Error Logging
.
.
          INC       IBACONFD/INC
          INC       OUTBOAFD/INC       * Clinic booking file
          INC       OUTBOXFD/INC        * Unavailable slot comments
          INC       OUTBB1FD/INC       * Clinic booking file
          INC       OUTCLIFD/INC       * Clinic ID file
          INC       OUTCONFD/INC       * Control file
          INC       OUTCSLFD/INC       * Cancelled session log file
          INC       OUTCTYFD/INC       * Clinic type file
          INC       OUTHEDFD/INC        * Template Header
          INC       OUTMA1FD/INC       * Clinic Master file
          INC       OUTMABFD/INC       * Clinic Master file
          INC       OUTMSPFD/INC
          INC       OUTSESFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       PATCONFD/INC
          INC       PATCODFD/INC       * codes file
          INC       PATDO1FD/INC       * Doctor file
          INC       PATHSPFD/INC       * site master
          INC       PATMA1FD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PATPR1FD/INC
          INC       WEBCONFD/INC
.
. ------- program variables -------
.
AVALTIME  DIM       5   * Slot Time in Format: (HH:MM)
CATEGORY  DIM       2
FORMATNM  DIM       23
BJDAY     FORM      3
CJDAY     FORM      3
.
CODE      DIM       3
CNTCCLIN  FORM      4         * counter of cancelled clinics
CRETURN   INIT      015
CSVEXT    INIT      ".csv"
DAYWEEK   FORM      1         * day of the week for entered value
DESCTYP1  DIM       30        * store start clinic type description
DESCTYP2  DIM       30        * store end clinic type description
DOWNCASE  INIT      "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz"
DIM5      DIM       5
.
EXTPATH   DIM       127
EXTRCDIR  INIT      "extracts/"
ENDCTYP   DIM       6         * end clinic type
.
FIELDSTR  DIM       100
FNGNAME   DIM       30
FNFNAME   DIM       30
FNSNAME   DIM       30
FORM3     FORM      3
FMTSNAME  DIM       35
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FRSTDATE  DIM       8
FULLSTOP  INIT      "."
DISPNAME  DIM       60
DIM12     DIM       12
DIM20     DIM       20
DIM23     DIM       23
DIM50     DIM       50
DIM60     DIM       60
DIM92     DIM       92
DIM460    DIM       460
DOCFNAME  DIM       50
SLOTTIME  DIM        5
.
HOUR      FORM      2       * Hour Variable
HORIZTAB  INIT      011
HOSPNAME  DIM       50
HOSP      DIM       3
.
KEY5A     DIM       5
KEY5B     DIM       5
.
MIN       DIM       2       * Minutes Variable
MINUTES   FORM      6       * Minutes Variable
MINTIME   FORM      2   * Set minutes to a form after computation
MOREBOOK  FORM      1
NAME35    DIM       35
.
FORM2A    FORM      2
REG       DIM       3         * "REG" if omareg = Y, else "   "
SAVCTYP   DIM       6
SAVCLIN   DIM       6
SAVEDATE  DIM       8
SRCHCLTY  DIM       6
SRCHCLID  DIM       6
STRCTYP   DIM       6         * starting clinic type
STRDATE   DIM       8
TABLE     FORM      1         * which table to print
TIME      FORM      3       * Allows for negative Symbol
CMDLINE   DIM       100
FNAME     DIM       8
TEMPFILE  DIM       8
TIMEARRY  DIM       11[48]     * Time array 30 minute slots
WORKARRY  DIM       460[49][43]
WORKARR2  DIM       460[43]
WORKAR2C  FORM      3
TMARRCNT  FORM      3
ROLLFILE  FILE      ASCII, FIXED=256
XCOUNT    FORM      3
YCOUNT    FORM      3
SAVXCT    FORM      3
XCOUN2    FORM      3
.
. ------- program constants -------
.
ACTCLIN   INIT      "- Active Clinics"
CATCB     INIT      "CB"      * reason for cancellation
DASH      INIT      "-"
PIPE      INIT      "|"
SP350     INIT      "                                   ":
                    "                                   ":
                    "                                   ":
                    "                                   ":
                    "                                   "
.
PRGID     INIT      "IBAOUT06"
PRGNAM    INIT      "Multi Therapist View Extract"
VERSION   INIT      "V12.01.00"
+
.------------------------------------------------------------------------------
.         Start of program
.------------------------------------------------------------------------------
.
          CALL      INIT0000                 * Open data files
          CALL      OPEN0000
          BRANCH    EXIT,ENDIT
.
START     DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Execute Multi Therapist View Extract"
.
REPEAT    KEYIN     *P1:7,*EL,"Please Select : ",*V2LON,OPTION
.
          COMPARE   ZERO,OPTION
          GOTO      ENDIT IF EQUAL
          BRANCH    OPTION TO GETCLIN
          BEEP
          GOTO      REPEAT
.
.         continue with the report, get the clinic types
.
GETCLIN   DISPLAY   *P1:9,*EF,"Clinic Type       :"
.
          IF        IBCNMHOS = 1
            DISPLAY   *P1:10,*EF,"Hospital          :"
          ENDIF
.
          DISPLAY   *P1:11,"Date              :"
.
.------------------------------------------------------------------------------
.         Enter Starting clinic type
.         Returns : STRCTYP
.------------------------------------------------------------------------------
.
GETCL100  KEYIN     *P21:9,*EL,*V2LON,STRCTYP
.
          ENDSET    STRCTYP
          APPEND    SP6,STRCTYP
          RESET     STRCTYP
.
          MATCH     SP6,STRCTYP
          GOTO      GETCL110 IF NOT EQUAL
.
          MOVE      SP6,ENDCTYP             * nothing entered, display Start
          DISPLAY   *P21:9,*EL,*V2LON,"All    "
          GOTO      GETCL200                * enter end code
.
GETCL110  PACK      KEY12,IDDD,STRCTYP
          CALL      RDCTYA1
          BRANCH    OVRCD TO GETCL120
          MOVE      OCTDESC,DESCTYP1
          GOTO      GETCL130
.
GETCL120  DISPLAY   *P30:24,*B,*V2LON,"*** Invalid Clinic Type ***",*W2:
                    *P1:24,*EL
          GOTO      GETCL100
.
GETCL130  DISPLAY   *P21:9,*EL,*V2LON,STRCTYP,*P30:9,DESCTYP1
.
.------------------------------------------------------------------------------
.         Enter Hospital          
.------------------------------------------------------------------------------
.
GETCL200   IF        ONE=IBCNMHOS
             CALL      KHOS0000
             BRANCH    EXIT,GETCL300
           ENDIF
.
.          KEYIN     *P21:10,*EL,*V2LON,ENDCTYP
.
.          ENDSET    ENDCTYP
.          APPEND    SP6,ENDCTYP
.          RESET     ENDCTYP
.
.          MATCH     SP6,ENDCTYP
.          GOTO      GETCL210 IF NOT EQUAL
.
.          MOVE      "zzzzzz",ENDCTYP        * nothing entered, display Finish
.          DISPLAY   *P21:10,*EL,*V2LON,"Finish "
.          GOTO      GETCL300
.
.GETCL210  PACK      KEY12,IDDD,ENDCTYP
.          CALL      RDCTYA1
.          BRANCH    OVRCD TO GETCL220
.
.          MOVE      OCTDESC,DESCTYP2
.          GOTO      GETCL230
.
.GETCL220  DISPLAY   *P30:24,*B,*V2LON,"*** Invalid Clinic Type ***",*W2:
.                    *P1:24,*EL
.          GOTO      GETCL200
.
.GETCL230  DISPLAY   *P21:10,*EL,*V2LON,ENDCTYP,*P30:10,DESCTYP2
.
.------------------------------------------------------------------------------
.         Enter date
.------------------------------------------------------------------------------
.
GETCL300  MOVE      TWENTY1,CCOL
          MOVE      TEN1,CVERT
          UNPACK    CDATE,CDAY,ANS,CMON,ANS,CCENT,CYEAR
.
          CALL      KEYDATE
          BRANCH    CQUEST,GETCL300
          BRANCH    OVRCD,GETCL300
.
          PACK      STRDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRDATE
.
          MOVE      ZERO,FSTDAY              * Clear 1st day variable
          PACK      KEY4,CCENT,CYEAR
          CALL      DOFYR000                 * Get 1st day of year
          COMPARE   ZERO,EXIT                * Does record exist ?
          GOTO      GETCL310 IF EQUAL        * Yes - calculate current day
.
          DISPLAY   *P1:24,*EL,*B,*V2LON,"*** ",*BLINKON,"patyears",*HOFF:
                    *V2LON," record missing for ",*BLINKON,KEY4,*HOFF:
                    *V2LON," ***  ",*HOFF,"Please call IBA ... ";
          KEYIN     ANS;
          GOTO      START                    * Start again
.
GETCL310  MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON                   * Convert required date to julian
.
          MOVE      JULDAY,FORM3             * Calculate day of week for
          DIV       SEVEN,FORM3              * required date
          MULT      SEVEN,FORM3
          ADD       ONE,FORM3
.
          SUB       FORM3,JULDAY
          ADD       FSTDAY,JULDAY
.
GETCL320  COMPARE   EIGHT,JULDAY             * Day in week range ?
          GOTO      GETCL390 IF LESS         * Yes - found day
.
          SUB       SEVEN,JULDAY             * Otherwise subtract another week
          GOTO      GETCL320                 * added this dont know if correct
.
GETCL390  MOVE      JULDAY,DAYWEEK           * set up day of the week
.
.------------------------------------------------------------------------------
.         Confirm parameters
.------------------------------------------------------------------------------
.
GETCL400  KEYIN     *P1:24,*EL,"Ok to proceed (":
                    *V2LON,*DV,ANSY,*HOFF,*DV,SLASH:
                    *V2LON,*DV,ANSN,*HOFF,*DV,SLASH:
                    *V2LON,*DV,ANSC,*HOFF:
                    ") ? ",*V2LON,ANS;
          REP       UPPLOW,ANS
          CMATCH    ANSY,ANS
          GOTO      GETCL490 IF EQUAL
          CMATCH    ANSN,ANS
          GOTO      GETCLIN IF EQUAL
          CMATCH    ANSC,ANS
          GOTO      START IF EQUAL
.
          BEEP
          GOTO      GETCL400
.
.------------------------------------------------------------------------------
.         Start processing data
.------------------------------------------------------------------------------
.
GETCL490  
.          DISPLAY   *P1:14,"Clinic Type :":
.                    *P1:15,"Clinic ID   :":
.                    *P1:16,"Date        :":
.                    *P1:17,"Start Time  :";
.
.          MOVE      SP20,CPHDROPT           * clear option
.          LOAD      CPHDROPT,OTCNCS54,ACTCLIN    * use subheading if para. on
.          MOVE      ZERO,TABLE              * print active table
.
.          UNPACK    SP30,SAVCLIN,SAVCTYP    * Initialise save variables
.          MOVE      "80",CLNO               * So that page head printed first
.          MOVE      ZERO,CPAGENO            * No pages printed yet
.
.          PACK      KEY24,IDDD,STRCTYP,SP20
.          CALL      RDSMASA2
.
.NXTMASA   CALL      RDKMASA2                 * Read in clinic type sequence
.          BRANCH    OVRCD,GETCL900           * No more records - exit
.
.          MATCH     OMASITE,IDDD             * Different site ?
.          GOTO      GETCL900 IF NOT EQUAL    * Yes - exit
.
.          MATCH     OMATYP,ENDCTYP           * Past end of range ?
.          GOTO      GETCL900 IF LESS         * Yes - exit
.
.          COMPARE   OMADAY,DAYWEEK           * Correct day of week ?
.          GOTO      NXTMASA IF NOT EQUAL     * No - get next clinic
.
.         Read bookings file to make sure that the clinic exists for this date
.
.          PACK      KEY28,OMASITE,OMACLIN,STRDATE,OMASTART,SP3
.          CALL      RDSBOKA1
.
.NXTBOKA   CALL      RDKBOKA1
.          BRANCH    OVRCD,NXTMASA            * Record nonexistent - get next cln
.
.          MATCH     OMASITE,OBASITE          * Different site ?
.          GOTO      NXTMASA IF NOT EQUAL     * Yes - get next clinic
.
.          MATCH     OMACLIN,OBACLIN          * Different clinic id ?
.          GOTO      NXTMASA IF NOT EQUAL     * Yes - get next clinic
.
.          MATCH     STRDATE,OBADATE          * Different date ?
.          GOTO      NXTMASA IF NOT EQUAL     * Yes - get next clinic
.
.          MATCH     OMASTART,OBASTRT         * Different start time ?
.          GOTO      NXTMASA IF NOT EQUAL     * Yes - get next clinic
.
.          MATCH     OMATYP,OBACTYP           * Different clinic type ?
.          GOTO      NXTBOKA IF NOT EQUAL     * Yes - get next booking record
.
.          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
.          DISPLAY   *P15:14,*V2LON,OMATYP,*P15:15,OMACLIN:
.                    *P15:16,CPCDATE:
.                    *P15:17,OMASTART
.
.          MOVE      OBADATE,SAVEDATE
.          CALL      PRLINE                   * Print record
.          GOTO      NXTMASA                  * Get next clinic
.
.         end of active clinics report, check if to do cancelled clinics
.
.GETCL900  CALL      CANC0000                 * process cancelled clinics
.
          CALL       MTAR0000
          CALL       MTTB0000
.
          CALL       PRMT0000
.
GETCL900  CALL      TRAN0000
          PRINT     *N,"*** Extract Generated ***"
          DISPLAY   *P1:24,*EL,*P40:24,*V2LON,"*** Generation Completed *** ";
          GOTO      ENDIT
+
.
.------------------------------------------------------------------------------
.         PRINTING SUBROUTINES
.------------------------------------------------------------------------------
.                   PRHEAD
.         Page Header
.------------------------------------------------------------------------------
.
.PRHEAD    CLOCK     TIME,CTIMEIS
.          CALL      HEAD132                 * will print underline at prev page
.          PRINT     *45,"Start Clinic : ";
.
.          MATCH     SP6,STRCTYP
.          GOTO      PRHEAD1 IF NOT EQUAL
.
.          PRINT     "Start",*N,*45,"End   Clinic : ";
.          GOTO      PRHEAD2
.
.PRHEAD1   PRINT     STRCTYP,SP2,DESCTYP1,*N,*45,"End   Clinic : ";
.
.PRHEAD2   MATCH     "zzzzzz",ENDCTYP
.          GOTO      PRHEAD3 IF NOT EQUAL
.
.          PRINT     "Finish"
.          GOTO      PRHEAD4
.
.PRHEAD3   PRINT     ENDCTYP,SP2,DESCTYP2
.
.PRHEAD4   UNPACK    STRDATE,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
.          PRINT     *45,"Date         : ",CPCDATE,*N
.
.          CALL      PAGEND
.
.         print the table heading according to the report type
.
.          BRANCH    TABLE,PRHEAD5           * print cancelled table
.
.         table for active clinics
.
.          PRINT     *1,"|",*3,"Clinic Type ",*48,"|",*50,"Clinic ID ":
.                    *90,"|",*92,"Registrar",*103,"|",*105,"Time ",*132,"|"
.          CALL      PAGEND
.          MOVE      TEN1,CLNO
.          RETURN
.
.         table for cancelled clinics
.
.PRHEAD5   PRINT     *1,"| Clinic Type",*48,"| Clinic ID",*90,"|     Time":
.                    *106,"| Reason for Cancellation |"
.          CALL      PAGEND
.          MOVE      TEN1,CLNO
.          RETURN
+
.------------------------------------------------------------------------------
.                   PRLINE
.         Print a line
.------------------------------------------------------------------------------
.
.PRLINE    COMPARE   "60",CLNO                * Gone past end of page ?
.          GOTO      PRLIN100 IF LESS         * No - skip page header print
.
.          CALL      PRHEAD                   * Print next page heading
.
.         print the line according to report type
.
.PRLIN100  BRANCH    TABLE,PRLIN500           * printing cancelled clinics
.
.         printing active clinics
.
.          PRINT     *1,"|";                  * Print first field separator
.
.          MATCH     OMATYP,SAVCTYP           * Same clinic type as before ?
.          GOTO      PRLIN200 IF EQUAL        * Yes - do not print again
.
.          PACK      OCTDESC,SP30             * Clear clinic type description
.          PACK      KEY12,IDDD,OMATYP        * Get clinic type description
.          CALL      RDCTYA1                  * Read record
.
.          PRINT     *3,OMATYP,*17,OCTDESC;   * Print clinic type
.          MOVE      OMATYP,SAVCTYP           * Save printed clinic type
.          MOVE      SP6,SAVCLIN              * Force print of clinic id
.
.PRLIN200  PRINT     *48,"|";                 * Print next field separator
.
.          MATCH     OMACLIN,SAVCLIN          * Same clinic id as before ?
.          GOTO      PRLIN300 IF EQUAL        * Yes - do not print again
.
.          PACK      KEY20,IDDD,OMACLIN,SAVEDATE
.          CALL      RDCLIA1
.          IF        OVRCD = 1
.            CALL      RDPCLIA1
.            IF        OVRCD = 0
.              MATCH     IDDD,OCASITE
.              IF        !@EQUAL
.                MOVE      ONE,OVRCD
.              ELSE
.                MATCH     OMACLIN,OCACLIN
.                IF        !@EQUAL
.                  MOVE      ONE,OVRCD
.                ENDIF
.              ENDIF
.            ENDIF
.          ENDIF
.          IF        OVRCD = 1
.            MOVE      "Unknown clinic",OCADESC
.            PACK      OCADESC,OCADESC,SP30
.            GOTO      PRLIN210
.          ENDIF
.
.          MATCH     SP6,OCADOCT              * Using doctor code ?
.          GOTO      PRLIN210 IF EQUAL        * No - use OCADESC
.
.          PACK      KEY6,OCADOCT             * Yes - read doctor's file
.          CALL      RDDOCT1                  * Read record
.          BRANCH    OVRCD,PRLIN210           * Record does not exist
.          MOVE      DSNAME,FNSNAME
.          MOVE      DGNAME,FNGNAME
.          CALL      FORMNAME                 * Format doctor's name
.          MOVE      FNFNAME,OCADESC          * Move into print variable
.
.PRLIN210  PRINT     *50,OMACLIN,*58,OCADESC; * Print clinic id
.          MOVE      OMACLIN,SAVCLIN          * Save printed clinic id
.
.PRLIN300  MOVE      SP3,REG                  * Clear registrar variable
.          CMATCH    ANSY,OMAREG              * Registrar's clinic ?
.          GOTO      PRLIN310 IF NOT EQUAL    * No - reg var blank
.          MOVE      "REG",REG                * Yes - reg var contains "REG"
.
.PRLIN310  PRINT     *90,"|",*95,REG,*103,"|",*105,OMASTART:
.                    *111,DASH,*113,OMAFIN,*132,"|":
.                    *N,"|",*48,"|",*90,"|",*103,"|",*132,"|"
.          ADD       ONE,CLNO
.          RETURN
.
.         print a line for cancellation report
.
.PRLIN500  PRINT     *1,"| ",OTCSCTYP,*17,OCTDESC,*48,"| ",OTCSCLIN,SP2,OCADESC:
.                    *90,"| ",OTCSSTRT," - ",OMAEND," | ",OTCSREAS,SP1,TDESC,"|"
.          ADD       ONE,CLNO
.          RETURN
+
.------------------------------------------------------------------------------
.                   PAGEND
.         Page Border
.------------------------------------------------------------------------------
.
.PAGEND    PRINT     "*---------------------------------------------------":
.                    "--------------------------------------------------------":
.                    "-----------------------*"
.          ADD       ONE,CLNO
.          RETURN
+
.******************************************************************************
.                   FORMNAME
.         Format a name string in the form SURNAME, INITIAL1. INITIAL2. etc
.         Requires : IBACOMM.PBL
.                    Surname in FNSNAME
.                    Given name in FNGNAME
.         Output   : Formatted name in FNFNAME
.------------------------------------------------------------------------------
.
.FORMNAME  MOVE      SP30,FNFNAME         * Clear destination string
.          RESET     FNSNAME              * Reset all strings
.          RESET     FNGNAME
.          RESET     FNFNAME
.          MOVE      FNSNAME,FNFNAME      * Surname 1st part of string
.          RESET     FNFNAME,30           * Set form pointer to the end
.FNSLOOP   CMATCH    SP1,FNFNAME          * Check if space
.          GOTO      FNSEND IF NOT EQUAL  * No, reached last char of surname
.          BUMP      FNFNAME,-1           * Yes, bump form pointer back
.          GOTO      FNSLOOP              * Repeat test
.
.FNSEND    APPEND    COMMA,FNFNAME        * Stick "," after surname
.          MOVE      ZERO,OVRCD
.          RESET     FNGNAME,0            * Set given name FP to before 1st char
.FNGLOOP   BUMP      FNGNAME              * Bump FP
.          GOTO      FNEXIT IF EOS        * If end of string then exit
.          MOVE      FNGNAME,ANS          * Isolate current character
.          CMATCH    SP1,ANS              * Space ?
.          GOTO      FNGUNSET IF EQUAL    * Yes, unset flag
.          BRANCH    OVRCD TO FNGLOOP     * No, but flag set, so keep on reading
.          MOVE      ONE,OVRCD            * Flag not set, so set flag and ...
.          APPEND    SP1,FNFNAME          * Space between initials
.          APPEND    ANS,FNFNAME          * Add initial to string
.          APPEND    DOT,FNFNAME          * Dot after initial
.          GOTO      FNGLOOP              * Read next character
.FNGUNSET  MOVE      ZERO,OVRCD           * Unset flag
.          GOTO      FNGLOOP              * Read next character
.
.FNEXIT    RESET     FNFNAME              * The end ...
.          MOVE      ZERO,OVRCD           * Clean up ...
.          RETURN
+
.******************************************************************************
.         The end ...
.------------------------------------------------------------------------------
.
ENDIT     WEOF       ROLLFILE,SEQ
          CLOSE      ROLLFILE
          CHAIN      PGM
+
.******************************************************************************
.                   INIT0000
.         Open data files
.******************************************************************************
INIT0000  CALL      DISPHEAD
          DISPLAY   *P56:24,"Opening";
.
          PACK      CFNAME WITH UID,FILBOKA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTBOKA1,CFNAME
.
          PACK      CFNAME WITH UID,FILCTYA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCTYA1,CFNAME
.
          PACK      CFNAME WITH UID,FILCLIA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA1,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA2
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA2,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA3
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA3,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA4
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA4,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA5
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA5,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA6
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA6,CFNAME
.
          PACK      CFNAME,UID,FILBOXA1  * Get the name of the BOXA1 file
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTBOXA1,CFNAME           * Open the file
.
          PACK      CFNAME WITH UID,FILHEDA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME WITH UID,FILMA1A1
          DISPLAY   *P64:24,CFNAME;
          CALL       OPOTMA11
.
          PACK      CFNAME WITH UID,FILMA1A2
          DISPLAY   *P64:24,CFNAME;
          CALL       OPOTMA12
.
          PACK      CFNAME WITH UID,FILMA1A3
          DISPLAY   *P64:24,CFNAME;
          CALL       OPOTMA13
.
          PACK      CFNAME WITH UID,FILMSPA1
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTMSPA1,CFNAME
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P58:24,"pathspaf";      * hospital code
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,NINTY1;*179,CWEBROOT   * HTML Root directory
          READ      CONTROLF,HUND04;RSCNEXT  * Ouput Extract directory
.
          READ      CONTROLF,THIRTY2;*108,OTCNCREV,OTCNCSUM,*111,OTCNAUPD:
                                     *115,OTCNRSST,*122,OTCNMTVS,*124,OTCNMTVE
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
.
          READ      CONTROLF,THIRTY1;*151,OTCNCS54
.
          MOVE      ZERO,CNOUNDLN           * underlines at EOP
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFILE
.
INIT9999  RETURN
+
.*********************************************************************
.*                  CANC0000                    Called by : GETCL999 *
.*        Print the report for cancelled clinics                     *
.*********************************************************************
.CANC0000  COMPARE   ONE,OTCNCS54
.          GOTO      CANC9900 IF NOT EQUAL   * not printing cancelled clinics
.
.          MOVE      "- Cancelled Clinics",CPHDROPT
.          MOVE      ONE,TABLE               * print cancelled table
.          MOVE      ZERO,CNTCCLIN           * counter of cancelled clinics
.          MOVE      "80",CLNO               * So that page head printed first
.          PACK      CFNAME,UID,FILCSLA2     * site dep. file name
.          OPEN      OUTCSLA2,CFNAME         * cancelled session file
.          PACK      CFNAME,UID,FILMA1A1
.          CALL       OPOTMA11
.          OPEN      PATCODE1,"patcodes"     * codes file
.
.         loop through the OUTCSLFD
.
.          PACK      KEY27,IDDD,STRDATE,SP20
.          CALL      RSOTCSL2                * position at site and date
.
.CANC1000  CALL      RKOTCSL2                * next read
.          BRANCH    OVRCD,CANC9000          * finished file
.
.          MATCH     OTCSSITE,IDDD
.          GOTO      CANC9000 IF NOT EQUAL   * different site
.
.          MATCH     OTCSDATE,STRDATE
.          GOTO      CANC9000 IF NOT EQUAL   * different date
.
.         obtain the required descriptions
.
.          UNPACK    OTCSDATE,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
.          DISPLAY   *P15:14,*V2LON,OTCSCTYP,*P15:15,OTCSCLIN:
.                    *P15:16,CPCDATE:
.                    *P15:17,OTCSSTRT
.
.          MOVE      "Invalid Clinic Type",OCTDESC     * clinic type description
.          PACK      KEY12,OTCSSITE,OTCSCTYP
.          CALL      RDCTYA1                 * read clinic type file
.         
.
.          PACK      KEY20,OTCSSITE,OTCSCLIN,OTCSDATE
.          CALL      RDCLIA1
.          IF        OVRCD = 1
.            CALL      RDPCLIA1
.            IF        OVRCD = 0
.              MATCH     OTCSSITE,OCASITE
.              IF        !@EQUAL
.                MOVE      ONE,OVRCD
.              ELSE
.                MATCH     OTCSCLIN,OCACLIN
.                IF        !@EQUAL
.                  MOVE      ONE,OVRCD
.                ENDIF
.              ENDIF
.            ENDIF
.          ENDIF
.          IF        OVRCD = 1
.            MOVE      "Unknown clinic",OCADESC
.            PACK      OCADESC,OCADESC,SP30
.            GOTO      CANC1500
.          ENDIF
.
.          MATCH     SP6,OCADOCT
.          GOTO      CANC1500 IF EQUAL       * no doctor code
.
.          MOVE      OCADOCT,KEY6            * doctor code is the key
.          CALL      RDDOCT1
.          BRANCH    OVRCD,CANC1500          * invalid code
.
.          MOVE      DSNAME,PACSNAME         * clinic id is a doctor name
.          MOVE      DGNAME,PACGNAME
.          MOVE      DTITL,PACTITLE
.          MOVE      TWO,PACFRMT
.          CALL      PACNAME
.          MOVE      PACFNAME,OCADESC
.
.CANC1500  MOVE      "??:??",OMAEND          * get session end time
.          PACK      KEY18,OTCSSITE,OTCSCLIN,DAYWEEK,OTCSSTRT
.          CALL      RDMASA1
.
.          MOVE      "Invalid Reason",TDESC  * get cancellation reason desc
.          PACK      KEY5,CATCB,OTCSREAS
.          CALL      RDCODE1
.
.          MOVE      OTCSDATE,SAVEDATE
.          CALL      PRLINE                  * print line
.          ADD       ONE,CNTCCLIN            * increment counter
.          GOTO      CANC1000 
.
.         end of cancellation data
.
.CANC9000  COMPARE   ZERO,CNTCCLIN
.          GOTO      CANC9100 IF EQUAL       * no clinics printed dont need line
.  
.          CALL      PAGEND                  * print underline
.          GOTO      CANC9200                * print summary
.
.CANC9100  CALL      PRHEAD                  * print heading anyway
.
.CANC9200  PRINT     *1,"Total number of cancelled sessions = ",CNTCCLIN
.          GOTO      CANC9999
.
.         not printing cancelled reports, finish off other report
.
.CANC9900  CALL      PAGEND                  * finish off the active report
.
.CANC9999  RETURN
+
.------------------------------------------------------------
. Set time array fields for appointment time classes
.------------------------------------------------------------
MTAR0000  MOVE      "Time       ",WORKARRY[1][1]
          MOVE      "00:00-00:29",WORKARRY[2][1]
          MOVE      "00:30-00:59",WORKARRY[3][1]
          MOVE      "01:00-01:59",WORKARRY[4][1]
          MOVE      "01:30-01:59",WORKARRY[5][1]
          MOVE      "02:00-02:29",WORKARRY[6][1]
          MOVE      "02:30-02:59",WORKARRY[7][1]
          MOVE      "03:00-03:29",WORKARRY[8][1]
          MOVE      "03:30-03:59",WORKARRY[9][1]
          MOVE      "04:00-04:29",WORKARRY[10][1]
          MOVE      "04:30-04:59",WORKARRY[11][1]
          MOVE      "05:00-05:29",WORKARRY[12][1]
          MOVE      "05:30-05:59",WORKARRY[13][1]
          MOVE      "06:00-06:29",WORKARRY[14][1]
          MOVE      "06:30-06:59",WORKARRY[15][1]
          MOVE      "07:00-07:29",WORKARRY[16][1]
          MOVE      "07:30-07:59",WORKARRY[17][1]
          MOVE      "08:00-08:29",WORKARRY[18][1]
          MOVE      "08:30-08:59",WORKARRY[19][1]
          MOVE      "09:00-09:29",WORKARRY[20][1]
          MOVE      "09:30-09:59",WORKARRY[21][1]
          MOVE      "10:00-10:29",WORKARRY[22][1]
          MOVE      "10:30-10:59",WORKARRY[23][1]
          MOVE      "11:00-11:29",WORKARRY[24][1]
          MOVE      "11:30-11:59",WORKARRY[25][1]
          MOVE      "12:00-12:29",WORKARRY[26][1]
          MOVE      "12:30-12:59",WORKARRY[27][1]
          MOVE      "13:00-13:29",WORKARRY[28][1]
          MOVE      "13:30-13:59",WORKARRY[29][1]
          MOVE      "14:00-14:29",WORKARRY[30][1]
          MOVE      "14:30-14:59",WORKARRY[31][1]
          MOVE      "15:00-15:29",WORKARRY[32][1]
          MOVE      "15:30-15:59",WORKARRY[33][1]
          MOVE      "16:00-16:29",WORKARRY[34][1]
          MOVE      "16:30-16:59",WORKARRY[35][1]
          MOVE      "17:00-17:29",WORKARRY[36][1]
          MOVE      "17:30-17:59",WORKARRY[37][1]
          MOVE      "18:00-18:29",WORKARRY[38][1]
          MOVE      "18:30-18:59",WORKARRY[39][1]
          MOVE      "19:00-19:29",WORKARRY[40][1]
          MOVE      "19:30-19:59",WORKARRY[41][1]
          MOVE      "20:00-20:29",WORKARRY[42][1]
          MOVE      "20:30-20:59",WORKARRY[43][1]
          MOVE      "21:00-21:29",WORKARRY[44][1]
          MOVE      "21:30-21:59",WORKARRY[45][1]
          MOVE      "22:00-22:29",WORKARRY[46][1]
          MOVE      "22:30-22:59",WORKARRY[47][1]
          MOVE      "23:00-23:29",WORKARRY[48][1]
          MOVE      "23:30-23:59",WORKARRY[49][1]
.
MTAR9999  RETURN
.
.------------------------------------------------------------
. Print Multi Therapist View Extract                 
.------------------------------------------------------------
PRMT0000  SQUEEZE   OTCNMTVS
          MATCH     SP70,OTCNMTVS
          IF        @EQUAL|@EOS
            MOVE      ZERO,FORM2A
          ELSE
            MOVE      OTCNMTVS,FORM2A
          ENDIF
          ADD       ONE,FORM2A
          MOVE      ZERO,YCOUNT
          MOVE      ZERO,XCOUNT
.
          IF        SAVXCT=ZERO
            ADD       ONE,SAVXCT
          ENDIF
.
PRMT1000  ADD       ONE,YCOUNT 
.
          CALL      CLRWA200
.
PRMT2000  ADD       ONE,XCOUNT
.
.******************************************************************
.
          IF        YCOUNT=ONE
            COMPARE   XCOUNT,SAVXCT
            IF        @LESS
              MOVE      ZERO,XCOUNT
              GOTO      PRMT9000
            ELSE
.             RESET     WORKARRY[YCOUNT][XCOUNT]
.             UNPACK    WORKARRY[YCOUNT][XCOUNT],DIM23,DIM460
.             MOVE      DIM460,WORKARR2[XCOUNT]
.             WRITE     ROLLFILE,SEQ;DIM23,HORIZTAB;
              RESET     WORKARRY[YCOUNT][XCOUNT]
              UNPACK    WORKARRY[YCOUNT][XCOUNT],DIM50
              WRITE     ROLLFILE,SEQ;DIM50,HORIZTAB;
            ENDIF
          ELSE
            COMPARE   FORM2A,YCOUNT
            IF        !@LESS
              COMPARE   XCOUNT,SAVXCT
              IF        @LESS
                MOVE      ZERO,XCOUNT
                GOTO      PRMT9000
              ELSE
                IF        XCOUNT=ONE
                  UNPACK    WORKARRY[YCOUNT][XCOUNT],DIM5 
                  MOVE      DIM5,WORKARR2[XCOUNT]
                  WRITE     ROLLFILE,SEQ;DIM5,HORIZTAB;
                ELSE
                  RESET     WORKARRY[YCOUNT][XCOUNT]
                  UNPACK    WORKARRY[YCOUNT][XCOUNT],DIM23,DIM460
                  MOVE      DIM460,WORKARR2[XCOUNT]
                  WRITE     ROLLFILE,SEQ;DIM23,HORIZTAB;
                ENDIF
              ENDIF
            ELSE
              MOVE      ZERO,XCOUNT
              GOTO      PRMT1000
            ENDIF
          ENDIF
.
.******************************************************************
.
          COMPARE   FORTY3,XCOUNT
          GOTO      PRMT2000 IF LESS
.
          MOVE      ZERO,XCOUNT
.
PRMT9000  WRITE     ROLLFILE,SEQ;CRETURN
.
          IF        YCOUNT<>1
            CALL      EXTROW00
            IF        EXIT=0
              CALL      EXTRWS00 
              GOTO      PRMT9000
            ENDIF
          ENDIF
.
          SQUEEZE   OTCNMTVE
          MATCH     SP70,OTCNMTVE
          IF        @EQUAL|@EOS
            MOVE      FORTY7,FORM2
          ELSE
            MOVE      OTCNMTVE,FORM2
          ENDIF
          ADD       ONE,FORM2
          COMPARE   FORM2,YCOUNT
          GOTO      PRMT1000 IF LESS 
.
PRMT9999  RETURN
.
.------------------------------------------------------------
. Clear Multi Therapist View Extract
.------------------------------------------------------------
CLAR0000  MOVE      ZERO,YCOUNT
          MOVE      ZERO,XCOUNT
.
CLAR1000  ADD       ONE,YCOUNT
.
CLAR2000  ADD       ONE,XCOUNT
.
.************************************************************
.
          PACK      WORKARRY[YCOUNT][XCOUNT],SP70
.
.************************************************************
.
          COMPARE   FORTY3,XCOUNT
          GOTO      CLAR2000 IF LESS
.
          MOVE      ZERO,XCOUNT
.
          WRITE     ROLLFILE,SEQ;CRETURN;
.
          COMPARE   FORTY9,YCOUNT
          GOTO      CLAR1000 IF LESS
.
CLAR9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table
.------------------------------------------------------------
MTTB0000  MOVE      ONE,XCOUNT
          PACK      KEY25,SP70
          CALL      RDSSESA6
MTTB0010  CALL      RDKSESA6
          BRANCH    OVRCD,MTTB9999
.
.         MATCH     UID,OSESITE
.         GOTO      MTTB9999 IF NOT EQUAL
.
          MATCH     OSEDATE,STRDATE
          GOTO      MTTB0010 IF NOT EQUAL
.
.         MATCH     SP70,SRCHCLID
.         IF        !@EQUAL
.           MATCH     OSECLIN,SRCHCLID
.           GOTO      MTTB0010 IF NOT EQUAL
.         ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,MTTB0010
          BRANCH    OMASTAT,MTTB0010
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,MTTB0010
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSP
            IF        !@EQUAL
              MATCH     HOSP,OTHEHOSP
              GOTO      MTTB0010 IF NOT EQUAL
            ENDIF
          ENDIF
.
.         MATCH     SP70,SRCHCIND           * filter on clinic indicator
.         IF        !@EQUAL
.           MATCH     SRCHCIND,OTHECIND
.           GOTO      MTTB0010 IF NOT EQUAL
.         ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      MTTB0010 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      MTTB0010 IF LESS
          ENDIF
.
.         MATCH     SP70,SRCHLTYP
.         IF        !@EQUAL
.           MATCH     OTHELTYP,SRCHLTYP
.           GOTO      MTTB0010 IF NOT EQUAL
.         ENDIF
.
          MATCH     SP70,STRCTYP
          IF        !@EQUAL
            MATCH     OTHECTYP,STRCTYP
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
.
          CALL      CHKSUS00
          BRANCH    EXIT,MTTB0010
.
.         CALL      CHKAPP00          * Check slot visit type and status
          BRANCH    EXIT,MTTB0010
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,MTTB0010
.
            MATCH     OSESITE,OCASITE
            GOTO      MTTB0010 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      MTTB0010 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,XCOUNT
          MOVE      XCOUNT,SAVXCT
          MOVE      ONE,YCOUNT
.
          CALL      MTRW0000
.
          COMPARE   FORTY3,XCOUNT
          GOTO      MTTB9999 IF EQUAL
.
          GOTO      MTTB0010
.
MTTB9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table Row
.------------------------------------------------------------
MTRW0000  SQUEEZE   OTCNMTVS
          MATCH     SP70,OTCNMTVS
          IF        @EQUAL|@EOS
            MOVE      ONE,YCOUNT
          ELSE
            MOVE      OTCNMTVS,YCOUNT
          ENDIF
          SUB       ONE,YCOUNT
.
          CALL      MTHD0000                          * Display Row Header
.
MTRW1000  ADD       ONE,YCOUNT
.
          MOVE      ZERO,MOREBOOK
.
          UNPACK    WORKARRY[YCOUNT][1],KEY5B,DIM1,KEY5A
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          CALL      RDSBOKA1
MTRW1500  CALL      RDKBOKA1
          BRANCH    OVRCD,MTRW2300
.
          IF        MOREBOOK=ONE
.
            MATCH     OSESITE,OBASITE
            GOTO      MTRW1800 IF NOT EQUAL
.
            MATCH     OSECLIN,OBACLIN
            GOTO      MTRW1800 IF NOT EQUAL
.
            MATCH     OSEDATE,OBADATE
            GOTO      MTRW1800 IF NOT EQUAL
.
          ELSE
.
            MATCH     OSESITE,OBASITE
            GOTO      MTRW2300 IF NOT EQUAL
.
            MATCH     OSECLIN,OBACLIN
            GOTO      MTRW2300 IF NOT EQUAL
.
            MATCH     OSEDATE,OBADATE
            GOTO      MTRW2300 IF NOT EQUAL
.
          ENDIF
.
          MATCH     ZEROVISN,OBAOUTNO
          IF        @EQUAL
            MATCH     "7",DOBASTAT
            GOTO      MTRW1500 IF NOT EQUAL
          ENDIF
.
.         MATCH     KEY5B,OBASTRT
.         IF        @LESS
.           GOTO      MTRW1500
.         ENDIF
.
          MATCH     KEY5A,OBASTRT
          IF        !@EQUAL & !@LESS
            GOTO      MTRW1500
          ENDIF
.
          MATCH     KEY5B,OBATIME
          IF        @LESS
            GOTO      MTRW1900
          ENDIF
.
          MATCH     KEY5A,OBATIME
          IF        !@EQUAL & !@LESS
            GOTO      MTRW1500
          ENDIF
.
.         IF        MOREBOOK=ONE
.           APPEND    " +",WORKARRY[YCOUNT][XCOUNT]
.           GOTO      MTRW1800
.         ELSE
            CALL    MTPD0000
            GOTO    MTRW1500
.         ENDIF
.
MTRW1800  
.         WRITE     HTMLFILE;"</td></tr>";
          GOTO      MTRW2500
.
MTRW1900  MOVE      OBATIME,AVALTIME
          CALL      STDUR000
.
          MATCH     KEY5B,AVALTIME
          GOTO      MTRW1500 IF LESS
.
.         MATCH     AVALTIME,KEY5A
.         GOTO      MTRW1500 IF LESS
.
          CALL      MTPD0000
.
          GOTO      MTRW1500
.
.MTRW2000  PACK      SAVKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
.          PACK      SAVKEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
.          CALL      RDKBOKA1
.          BRANCH    OVRCD,MTRW2200
.
.          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
.          MATCH     SAVKEY25,KEY25
.          GOTO      MTRW2200 IF NOT EQUAL
.
.          MATCH     KEY5B,OBATIME
.          GOTO      MTRW2200 IF EQUAL
.          GOTO      MTRW2200 IF LESS
.
.          MATCH     OBATIME,KEY5A
.          IF        !@EQUAL & !@LESS
.            GOTO      MTRW2200
.          ENDIF
.
.          PACK      KEY28,SAVKEY28,SP70
.          CALL      RDBOKA1
.          BRANCH    OVRCD,MTRW2300
.
.          WRITE     HTMLFILE;"<tr>":
.                             "<td height=40>",OBATIME," ",DOBAOUTN;
.
.          GOTO      MTRW2500
.
.MTRW2200  PACK      KEY28,SAVKEY28,SP70
.          CALL      RDBOKA1
.          BRANCH    OVRCD,MTRW2300
.
.          GOTO      MTRW1500
.
MTRW2300   APPEND    " ",WORKARRY[YCOUNT][XCOUNT]
.          WRITE     HTMLFILE;"<tr>":
.                             "<td height=40>&nbsp;</td>":
.                             "</tr>";
.
MTRW2500  SQUEEZE   OTCNMTVE
          MATCH     SP70,OTCNMTVE
          IF        @EQUAL|@EOS
            MOVE      FORTY8,FORM2
          ELSE
            MOVE      OTCNMTVE,FORM2
          ENDIF
          COMPARE   FORM2,YCOUNT
          GOTO      MTRW1000 IF LESS
          GOTO      MTRW1000 IF EQUAL
.
MTRW3000  
.         WRITE     HTMLFILE;"</table></td>";
.
MTRW9999  RETURN
.
.------------------------------------------------------------
. Display Multi Therapist Table Row Header
.------------------------------------------------------------
MTHD0000  
.          WRITE     HTMLFILE;"<td><table cellspacing=0 cellpadding=1 border=1":
.                             " width=100%>":
.                             "<tr>":
.                             "<td height=40 bgcolor=#CCCCCC>";
.
.         MOVE      SP70,SESSKEYS
.         PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
.         REP       " +",SESSKEYS
.
.          WRITE     HTMLFILE;"<a href='":
.                             "outweb02.pbl?reportno=02&template=004&sesskeys=":
.                             SESSKEYS,"' onclick='SetMulTherCookie();'>";
.
          MATCH     SP70,OSESGHCP
          GOTO      MTHD0600 IF EQUAL
          GOTO      MTHD0600 IF EOS
.
          MOVE      SP70,DOCFNAME
.
          PACK      KEY10,OSESGHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    OSESGHCP,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          APPEND    DOCFNAME,WORKARRY[1][XCOUNT]
          APPEND    SP1,WORKARRY[1][XCOUNT]
          GOTO      MTHD0600
.
MTHD0500  APPEND    OSESGHCP,WORKARRY[1][XCOUNT]
.
MTHD0600  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          BRANCH    OVRCD,MTHD0700
.
          APPEND    OCADESC,WORKARRY[1][XCOUNT]
.         APPEND    " - ",WORKARRY[1][XCOUNT]
.         APPEND    OSESTRT,WORKARRY[1][XCOUNT]
          GOTO      MTHD9999
.
MTHD0700  PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,MTHD0800
.
          MATCH     OSESITE,OCASITE
          GOTO      MTHD0800 IF NOT EQUAL
.
          MATCH     OSECLIN,OCACLIN
          GOTO      MTHD0800 IF NOT EQUAL
.
          APPEND    OCADESC,WORKARRY[1][XCOUNT]
.         APPEND    " - ",WORKARRY[1][XCOUNT]
.         APPEND    OSESTRT,WORKARRY[1][XCOUNT]
          GOTO      MTHD9999
.
MTHD0800  APPEND    OCACLIN,WORKARRY[1][XCOUNT]
          APPEND    " - ",WORKARRY[1][XCOUNT]
          APPEND    OSESTRT,WORKARRY[1][XCOUNT]
.
MTHD9999  RETURN
.------------------------------------------------------------
. Get Code Description
.------------------------------------------------------------
GETCOD00  MOVE      SP70,TDESC
          MOVE      SP70,ACODE
          UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                                TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                                TCINDC11
          MATCH     SP70,CODE
          GOTO      GETCOD99 IF EQUAL
.
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                           TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                           TCINDC11
          ENDIF
GETCOD99  RETURN
.
.-------------------------------------------------
. Format Doctors Given Name
.-------------------------------------------------
DOCGIV00  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV00 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
.         Check for any more names
.
          SETLPTR   NAME35,35              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME35,CCITEM          * reset to this point
          PACK      KEY35,NAME35,SP70      * reset form pointer
          MOVE      KEY35,NAME35

DOCGIV10  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV10 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this Initial
.
          UNPACK    NAME35,KEY1,KEY50
          APPEND    KEY1,DISPNAME
          APPEND    SP1,DISPNAME
.
          GOTO      DOCGIV99
.
.         Rest of the string is one name
.
DOCGIV20  UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
DOCGIV99  RETURN
.
.------------------------------------------------------------
. Check for Master Suspension
.------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
CHKSUS10  CALL      RPOTMSP1
          BRANCH    OVRCD,CHKSUS99
          MATCH     OSESITE,OTMSSITE
          GOTO      CHKSUS99 IF NOT EQUAL
          MATCH     OSECLIN,OTMSCLIN
          GOTO      CHKSUS99 IF NOT EQUAL
          MOVE      OSEDAY,KEY1
          MATCH     KEY1,OTMSDOWK
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     OSESTRT,OTMSSTIM             * Same session start time
          GOTO      CHKSUS10 IF NOT EQUAL
.
.         MATCH     SP70,OTMSTDAT
.         IF        !@EQUAL
.           MATCH     OTMSTDAT,OSEDATE           * ????????????
.           GOTO      CHKSUS10 IF LESS
.         ENDIF
.
          MATCH     OTMSFDAT,OSEDATE
          GOTO      CHKSUS10 IF LESS
          GOTO      CHKSUS20 IF EQUAL
.
          MATCH     OSEDATE,OTMSTDAT
          GOTO      CHKSUS10 IF LESS
.
CHKSUS20  MOVE      ONE,EXIT
.
CHKSUS99  RETURN
.
.------------------------------------------------------------
.                             STDUR000
.              Calculate end time of slot
.------------------------------------------------------------
STDUR000  UNPACK    AVALTIME,KEY2,KEY1,MIN  * HH:MM
          MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       OTHEDURN,MINUTES   * Add Duration time to minutes
          SUB       ONE,MINUTES
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            IF        TIME >= 60
              MOVE      TIME,MINUTES
              ASSIGN    MINUTES-SIXTY,TIME
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       TWO,HOUR                 * Add Two Hours
            ELSE
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       ONE,HOUR                 * Add One Hour
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIME            * No Hour Change
            MOVE      MINTIME,MIN
          ENDIF
.
          PACK      AVALTIME,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REPLACE   " 0",AVALTIME            * replace spaces with zero
.
          UNPACK    AVALTIME,KEY2,KEY1,MIN
          PACK      KEY4,KEY2,MIN
          MOVE      KEY4,SLOTTIME  * pack time Form variable (Loop Control)
.
STDUR999  RETURN
.
.---------------------------------------------------------------
.                             MTPD0000
.              Display Patient Details for Multi Therapist view
.---------------------------------------------------------------
MTPD0000  MATCH     "7",DOBASTAT
          IF        @EQUAL
.
            MOVE      SP70,FORMATNM
            MOVE      "CV",CATEGORY
            MOVE      OBAVISIT,CODE
            CALL      GETCOD00
            PACK      FORMATNM,TDESC,SP70
.
            MATCH     ANSU,TCINDC6           * Get slot comment if unavailable
            IF        @EQUAL
              PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
              CALL      RDOTBOX1
              IF        OVRCD=0
                MATCH     SP70,OTBXCOMM
                IF        !@EQUAL
                  PACK      FORMATNM,OTBXCOMM,SP70
                ENDIF
              ENDIF
            ENDIF
            APPEND  FORMATNM,WORKARRY[YCOUNT][XCOUNT]
.
          ELSE
.
            CALL      CASDET00
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
.
.         CALL      PATLN000
.         CALL      PATFLD00
.         PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.         REP       " +",CASEKEYS
.                            
.         PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
.         CALL      RDCODE1  
.         BRANCH    OVRCD,MTPD1000 
.                            
.         MATCH     "N",TCINDC1
.         IF        @EQUAL
.           WRITE     HTMLFILE;"<tr><td height=40 bgcolor=pink>";
.           GOTO      MTPD2000
.         ENDIF
.
.         MATCH     "S",TCINDC1
.         IF        @EQUAL
.           WRITE     HTMLFILE;"<tr><td height=40 bgcolor=yellow>";
.           GOTO      MTPD2000
.         ENDIF
.
.MTPD1000  WRITE     HTMLFILE;"<tr><td height=40>";
.
.MTPD2000  WRITE     HTMLFILE;"<a href=#"",LINKPRG,".pbl?reportno=",LINKREP:
.                             "&template=",LINKTEM:
.                             "&casekeys=",CASEKEYS,"#">":
.                             "<img src=../images/PatientFolder",KEY3,".gif":
..                             " class=Icon></a>":
.                             "<img src=../images/EditIcon.gif":
.                             " class=Icon":
.                             " onclick=#"";
.
.         REP       "+ ",CASEKEYS
.
.         WRITE     HTMLFILE;"document.PatientLinks.casekeys.value='",CASEKEYS,"';":
.                   " PatientLinkTo(#'outweb02.pbl#',3,5,1,700,400);#">&nbsp;":
.                            fORMATNM;
.
            UNPACK  PGNAME,DIM1
            STRIP   PSNAME
            PACK    DIM12,PSNAME,SP70
            STRIP   DIM12
            PACK    FORMATNM,DIM12,SP1,DIM1,SP1,PURNO,SP70
            APPEND  FORMATNM,WORKARRY[YCOUNT][XCOUNT]
.
          ENDIF
.
          MOVE    ONE,MOREBOOK
.
MTPD9999  RETURN
.*******************************************************************************
.                         Get Case Details
.*******************************************************************************
CASDET00  CALL      CLPATMAS
          MATCH     "       0",OBAURNO
          IF        @EQUAL
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPRAM1
            BRANCH    OVRCD,CASDET99          * invalid UR number
          ELSE
            PACK      KEY8,OBAURNO,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,CASDET99          * invalid UR number
.
            PACK      KEY8,OBAURNO,SP70
            CALL      RDPMPX21                * read 2nd master file extension
            BRANCH    OVRCD,CASDET99          * invalid UR number
          ENDIF
.
CASDET99  RETURN
.
.******************************************************************************
.*                              KHOS0000                  Called by: KPAR0000 *
.*                      Hospital Parameter Keyin                              *
.******************************************************************************
KHOS0000  MOVE      SP3,CKYIDEF3
          MOVE      ONE,CKYIMAND
          MOVE      "21",ECOL
          MOVE      "10",EVERT
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS0000,KHOS9000
          DISPLAY   *PECOL:EVERT,*V2LON,PTHSHOSP,*HOFF,SP2,PTHSNAME
.
          PACK      HOSP,PTHSHOSP,SP3
          PACK      HOSPNAME,PTHSNAME,SP20,SP20,SP20
          GOTO      KHOS9999
.
KHOS9000  MOVE      ONE,EXIT                 * exitchar entered
.
KHOS9999  RETURN
+
.******************************************************************************
.*                              CLRWA200                                      *
.*                      Clear work array 2                                    *
.******************************************************************************
CLRWA200  MOVE      ZERO,WORKAR2C
.
CLRWA210  ADD       ONE,WORKAR2C
          COMPARE   FORTY4,WORKAR2C
          GOTO      CLRWA299 IF NOT LESS
.
          PACK      WORKARR2[WORKAR2C],SP350,SP350
.
          GOTO      CLRWA210
.
CLRWA299  RETURN
.*****************************************************************************
.
.*****************************************************************************
.
SPCHR000  MOVE      WORKARRY[YCOUNT][1],WORKARR2[1]
          MOVE      WORKARRY[YCOUNT][XCOUNT],FIELDSTR
          STRIP     FIELDSTR                     * remove trailing spaces
          MOVELPTR  FIELDSTR,FORM3               * get string length
          COMPARE   ZERO,FORM3                   * string length zero ?
          GOTO      SPCHR999 IF EQUAL            * yes - ignore
.         
SCHR0500  MOVE      FIELDSTR,ANS                 * load the next character
.
.         Check if character is a pipe
.
          MATCH     PIPE,ANS                     * is character "|" ?
          IF        @EQUAL
            BUMP      FIELDSTR
            MOVE      FIELDSTR,WORKARR2[XCOUNT] 
            RESET     WORKARR2[XCOUNT]
            GOTO      SPCHR999 
          ENDIF
.
SPCHR100  BUMP      FIELDSTR                     * position on next character
          GOTO      SPCHR999 IF EOS              * eos - finished
          GOTO      SCHR0500
.
SPCHR999  RETURN
+
.*****************************************************************************
.
.*****************************************************************************
EXTROW00  MOVE      ZERO,EXIT
          MOVE      ONE,XCOUN2
.
EXTROW50  ADD       ONE,XCOUN2
          COMPARE   FORTY4,XCOUN2
          GOTO      EXTROW90 IF NOT LESS
.
.         RESET     WORKARR2[XCOUN2]
          MATCH     SP70,WORKARR2[XCOUN2]
          IF        !@EQUAL & !@EOS
            GOTO      EXTROW99
          ENDIF
.
          GOTO      EXTROW50
.
EXTROW90  MOVE      ONE,EXIT
.
EXTROW99  RETURN
.*****************************************************************************
.
.*****************************************************************************
EXTRWS00  MOVE      ZERO,XCOUN2
.
EXTRWS50  ADD       ONE,XCOUN2
          COMPARE   FORTY4,XCOUN2
          GOTO      EXTRWS99 IF NOT LESS
.         
          RESET     WORKARR2[XCOUN2]
          IF        XCOUN2=ONE
            UNPACK    WORKARR2[XCOUN2],DIM5
            WRITE     ROLLFILE,SEQ;DIM5,HORIZTAB; 
          ELSE
            UNPACK    WORKARR2[XCOUN2],DIM23,DIM460
            PACK      DIM460,DIM460,SP350,SP350
            MOVE      DIM460,WORKARR2[XCOUN2]
            WRITE     ROLLFILE,SEQ;DIM23,HORIZTAB;
          ENDIF
.         
          GOTO      EXTRWS50
.
EXTRWS99  RETURN
.------------------------------------------------------------
. Open/Create Downlaod File
.------------------------------------------------------------
OPEN0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ROLLFILE,TEMPFILE            * Check dpath
          TRAPCLR   IO
.
          COMPARE   ZERO,OVRCD
          GOTO      OPEN0100 IF EQUAL
.
          GOTO      OPEN1000
.
OPEN0100  CLOSE     ROLLFILE,DELETE
.
OPEN1000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          PREP      ROLLFILE,TEMPFILE
          TRAPCLR   IO
          BRANCH    OVRCD,OPEN9100
          MOVE      ZERO,EXIT
          GOTO      OPEN9999
.
OPEN9100  BEEP
          MOVE      "Unable to Create Export File - ",DISPMSG
          CALL      MESSAGE1
          MOVE      ONE,EXIT
          GOTO      OPEN9999
.
OPEN9999  RETURN
.--------------------------------------------------------------------------
. Execute us1 Script
.--------------------------------------------------------------------------
TRAN0000  STRIP     TEMPFILE
.
          CLEAR     CMDLINE
          APPEND    "ibaout06.us1 ",CMDLINE
          APPEND    TEMPFILE,CMDLINE
          APPEND    ".txt",CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    TEMPFILE,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID   * ibaccc51.us1 fullpathname filename
.
TRAN9999  RETURN
.------------------------------------------------------------------------------
.         I/O includes
.------------------------------------------------------------------------------
.
          INC       STD001IO
          INC       TFILENAM                * Generate Temp File Name
          INC       IBASEQIO/INC            * Sequential Numbers File
          INC       WEBERRIO/INC            * Web Server Error Logging
.
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       CLPATMAS
          INC       CALCAGE
          INC       PATHSPKY
          INC       PATCODIO/INC       * codes file
          INC       PATDO1IO/INC
          INC       PATHSPIO/INC       * hospital file
          INC       PATMA1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTBOXIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCSLIO/INC       * Cancelled session log file
          INC       OUTCTYIO/INC
          INC       OUTHEDIO/INC
          INC       OUTMA1IO/INC
          INC       OUTMSPIO/INC
          INC       OUTSESIO/INC
          INC       PATPR1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC 
+
