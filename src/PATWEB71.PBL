.---------------------------------------------------------------------- 
. Program      : PATWEB71 
.  
. Function     : Patient Invoice Print Server 
.  
. Modifications  :
.----------------------------------------------------------------------------
. V12.01.03 14/01/2025  Bella Turco    TSK 0951679
.           Fixed LOS calculation to use CURRDATE not DDATE when discharged
.           Fixed HITH calculation MCHG6800/MCHG6900
. V12.01.02 11/11/2025  Bella Turco    TSK 0951679
.           New tags MCHG6800-MCHG7000 for LOS and HITH calculations
.           New routine CHKUDF00 to update admission/discharge UDF
.           New routine CHCKBT00 to check if site has a Bed Type with Ind1=H
. V12.01.01 21/11/2025  J.Tan          TSK 0946593
.           Recompiled for CMXMATRX -Sort Casepayment Theatre fee items
. V12.00.13 10/10/2025  J.Tan          TSK 0946593
.           Recompiled for PATCATBI-Sort Casepayment Theatre fee items
. V12.00.12 06/10/2025  J.Tan          TSK 0966784
.           Recompiled for PATCATAI - Fixed printing ICD10 on reprint
. V12.00.11 30/09/2025  Thanh T        TSK 0937505
.           Recompiled for PATINVHL changes
. V12.00.10 24/09/2025  J.Tan          TSK 0966921
.           Recompiled for ISBINVS - remove tempfiles (KT2P0000)
. V12.00.09 17/09/2025  Bella Turco    TSK 0966761
.           Only write to patatraf when Casepayment/Casemix Code/Verification
.           fields are changed CVERIF00
. V12.00.08 13/08/2025  J.Tan          TSK 0964813
.           Recompiled for ABFPTINV - Mod for ICD10 Ed13
. V12.00.07 17/07/2025  J.Tan          TSK 0961277
.           Recompiled for PATCATBI - Check if Accom.has been incl.in Pat.inv.
.           22/07/2025  J.Tan          TSK 0963587
.           Recompiled for PINCATBI - Check if patient is discharged & invoiced
. V12.00.06 30/06/2025  J.Tan          TSK 0951405
.           Checking NZ Item against NOT performed procedures
. V12.00.05 23/06/2025  J.Tan          TSK 0961589
.           Recompiled for PATCATBI - Fixed invoice rebate with zero MV hours
.           01/07/2025  J.Tan          TSK 0960457
.           Recompiled for PATCATBI-print inv.on first date of Findate
. V12.00.04 19/06/2025  J.Tan          TSK 0961277
.           Recompiled for PINCATBI - NOT to print item with zero patient amount
. V12.00.03 16/06/2025 J.Tan             TSK 0961932
.           Recompiled for WEBINVS - Moved back SAVEND to FORM3
. V12.00.02 23/05/2025  J.Tan          TSK 0955096
.           Added Alphanumeric visit number changes
. V12.00.01 15/05/2025 J.Tan    TSK 0960457
.           Recompiled for PATINVS - Mod to set PTDTEFFD for Accommodation
. V11.05.14 22/04/2025 J.Tan           TSK 0951578
.           Recompiled for ABFPTINV - fixed LOS without ICU=0
. V11.05.13 17/04/2025 J.Tan           TSK 0946490
.           Recompiled for PATCATBI - Fixed MV CWO Payment model
. V11.05.12 03/04/2025  J.Tan          TSK 0958935
.           Fixed Hold invoice from HL7 receiver
. V11.05.11 20/03/2025 Bella Turco     TSK 0946534
.           Fixed table read for displaying 'Updated By' Casemix Payment info
.           CCVF0300
. V11.05.10 25/02/2025 J.Tan           TSK 0956519
.           Recompiled for PATCATBI - check Inv.pending after Patient only Inv.
.           04/03/2025 Bella Turco     TSK 0946534
.           Casemix Code Verification for patatraf CVERIF00
. V11.05.09 04/02/2025 J.Tan           TSK 0952533
.           Recompiled for PATCATBI - changes for MV using Ventilation file
.           14/02/2025 J.Tan           TSK 0946490
.           Recompiled for PATCATBI - changes for MV CWO Payment model
.           14/02/2025 J.Tan           TSK 0955356
.           Recompiled for PATCALF - writting to Financial Summary details file
. V11.05.08 20/01/2025 J.Tan           TSK 0951578
.           Recompiled for ABFPTINV - fixed ICU hours < 24 hours
. V11.05.07 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.06 17.12.2024 DA Sarkies       TSK 0951086
.           Increased size of variables associated with ADYHOSP from 3 to 4
. V11.05.05 10.12.2024 DA Sarkies       TSK 0951086
.           Increased size of variables associated with ADYHOSP from 3 to 4
.           10/12/2024  J.Tan          TSK 0954876
.           Recompiled for ABFPTINV - Fixed Covid adjustmnet
. V11.05.04 05.12.2024 DA Sarkies       TSK 0951086
.           Increased size of PTMI3BDY to 4
. V11.05.03 03/12/2024 J.Tan            TSK 0953674
.           Recompilef for PATCATBI - added tag for total Patient invoice amt
. V11.05.02 29/11/2024  Thanh T         TSK 0939466
.           Added Distance in kms field
. V11.05.01 26/11/2024  Ebon Clements   TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.04.34 07/11/2024 Thanh T          TSK 0946085
.           Added RCCNSTRF field - Display Statement Reference
. V11.04.33 23/10/2024 J.Tan             TSK 0951578
.           Recompiled for ABFPTINV - Added Minutes to round up ICU Hours (ABF)
. V11.04.32 22/10/2024 J.Tan             TSK 0951821
.           Recompiled for PATCATBI - Fixed printing Items with zero amount
. V11.04.31 04/10/2024  J.Tan          TSK 0951441
.           Recompiled for PATCATBI - Charging AddOn for NoPayDay
. V11.04.30 23/09/2024  J.Tan          TSK 0949848
.           Recompiled for ABFPTINV - DRG List used in for COVID Adjustor
. V11.04.29 20/09/2024 J.Tan           TSK 0950577
.           Fixed issue with Hold Invoice audit
. V11.04.28 11/09/2024  J.Tan          TSK 0947315
.           Recompiled for ABFPTINV - fixed Total Unqualified
. V11.04.27 23/08/2024 J.Tan           TSK 0939432
.           Recompiled for ISBCATBI - Independence billing
. V11.04.26 07/08/2024  J.Tan            TSK 0939432
.           Mod Item quantity for Independence billing (PTCNISBZ)
. V11.04.25 31/07/2024  J.Tan          TSK 0947804
.           Recompiled for ABFMHINV - Changes for Disc.after 1/7/2023(CALCFLAG=1
. V11.04.24 30/07/2024  J.Tan          TSK 0948860
.           Recompiled for CMXMATRX-display C/P Incomplete with Prov.Casemixcode
. V11.04.23 15/07/2024  J.Tan          TSK 0947315
.           Recompiled for ABFPTINV (LOS ICU adjusted & unqualified Newborn)
. V11.04.22 11/06/2024  J.Tan          TSK 0946701
.           Recompiled for PATCATBI - calculating items(amt x quantity)>FORM6P2
. V11.04.21 30/04/2024  J.Tan          TSK 0945175
.           Recompiled for PATINVTL PATINHL for printing Disc.Billing statement
. V11.04.20 05/05/2024  J.Tan          TSK 0927259 
.           Recompiled for PRTINVBD - Printing Claim details and ICD Diag/Proc
. V11.04.19 02/04/2024  J.Tan          TSK 0931613
.           Recompiled for ABFPTINV (Contract Effective date)
. V11.04.18 27/03/2024  J.Tan          TSK 0931613
.           Recompiled for ABFSAINV - set up PRDSDATE for Rehab.
. V11.04.17 26/03/2024  Bella Turco    TSK 0914658
.           Added new include MVITCONF
.           Added tag MCHG6600 for returning visit type/status
. V11.04.16 19/03/2024  J.Tan          TSK 0943949
.           Recompiled for NZPCATBI - Checking for FFW with Win/Loss
. V11.04.15 13/03/2024 J.Tan           TSK 0910994
.           Recompiled for CMXMATRX-Added Att.Doctor,Concession card & Disc.UDF
.           13/03/2024  J.Tan          TSK 0919335
.           Mod checking for HF history (set Service date - TSRVDATE)
. V11.04.14 12/03/2024  J.Tan          TSK 0931613
.           Recompiled for ABFSADET (display AN-SNAP for Rehab patient)
. V11.04.13 05/03/2024  J.Tan          TSK 0943130
.           Mod checking for Matrix template
. V11.04.12 04/03/2024  Jacob Jackson  TSK 0914658
.           Add new tag MCHG6500 for accessing PMCHREAS
. V11.04.11 21/02/2024  Bella Turco    TSK 0914658
.           Changed blank COMPCLAM to ACLAIM in INVD6500
. V11.04.10 21/02/2024  J.Tan          TSK 0942976
.           Recompiled for NZPCATBI - Fixed Co-payment
. V11.04.09 30/01/2024  Jacob Jackson  TSK 0919335
.           Remove local variable
. V11.04.08 20/02/2024  J.Tan          TSK 0942477
.           Recompiled for PRTINVBD -  Cabrini Accom. print additional desc.
.           20/02/2024  J.Tan          TSK 0939019
.           Recompiled for ABFPTINV - Checking for ICD10 Edition
.           12/02/2024  J.Tan          TSK 0936664
.           Mod CPMN0000 to check for Journal to print on Disc.Billing statement
. V11.04.07 29/01/2024  Jacob Jackson  TSK 0919335
.           Add HF History includes
. V11.04.06 29/01/2024  Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
. V11.04.05 18/01/2024  J.Tan          TSK 0941108
.           Recompiled for NZPCATBI - fixed W/L amount
. V11.04.04 08/01/2024  J.Tan          TSK 0939019
.           Recompiled for ABFPTINV - Checking for ICD10 Edition
.           12/01/2024  J.Tan          TSK 0941779
.           Recompiled for ABFPTINV - private patients (APPSAMNT)
. V11.04.03 08/01/2023  J.Tan          TSK 0936664
.           Recompiled for PATINVHL PATINVTL - print Disc.billing with Details
. V11.04.02 20/12/2023  J.Tan          TSK 0936664
.           Recompiled for PATCATAI - fixed printing GST journals for Disc.Bill.
. V11.04.01 04/12/2023  J.Tan          TSK 0940149
.           Recompiled for PATCATBI - Adm.type of Lumpsum for NoPayday(patfinsf)
. V11.03.26 17/11/2023  J.Tan          TSK 0940089
.           Recompiled for ABFPTINV - checking for blank Disc.DRG
. V11.03.25 16/11/2023  J.Tan          TSK 0939498
.           Recompiled for NZPCATBI - include Adjustment to Win/Loss value
. V11.03.24 13/11/2023  J.Tan          TSK 0939019
.           Recompiled for ABFPTINV - HAC ICD10 Edition 12
. V11.03.23 08.11.2023  DA Sarkies     TSK 0936664
.           Recompiled for PATCATAI
. V11.03.22 06/11/2023  Jacob Jackson  TSK 0914658
.           Add new tags MCHG6200-MCHG6400 for helping with validate MV claims
.           and with redirect values for PMEXT049
. V11.03.21 31/10/2023  J.Tan          TSK 0937852
.           Mod routine creating Future action when printing Patient Only Inv.
. V11.03.20 04/10/2023  Nikitha B      TSK 0927699
.           Adedd CAPPRVNO and PTCNHABN to read at RDCNT000.
. V11.03.19 03/10/2023  J.Tan          TSK 0938056
.           Recompiled for PATINVTL PATINVHL - BPAY ref.no for Disc.Billing
. V11.03.18 21/09/2023  J.Tan          TSK 0931613
.           Mod for ABF Sub-Acute Palliative phase of Care
. V11.03.17 20/09/2023  J.Tan          TSK 0916870
.           Recompiled for ABFPTINV - Default NEP value with blank code set/ind.
. V11.03.16 15/09/2023  Alina Bhari    TSK 0936086
.           Recompiled for CMXMATRX - Wrap table row with bold text     
. V11.03.15 12/09/2023  J.Tan          TSK 0935891
.           Recompiled for PATCATBI - increased var displaying bed fees desc.
. V11.03.14 12/09/2023  Alina Bhari    TSK 0936086
.           Recompiled for PATINVS - closed the bold text                
. V11.03.13 28/08/2023  J.Tan          TSK 0916870
.           Recompiled for ABFPTINV - Claim code Cat CL Multiple NEP value
. V11.03.12 13/07/2023  J.Tan          TSK 0923703
.           Recompiled for ABF - checking for private patient
. V11.03.11 07/07/2023  J.Tan          TSK 0923703
.           Recompiled for ABF - hospital remoteness
. V11.03.10 15/06/2023  Bella Turco    TSK 0931756
.           Recompiled for PRTINVBD             
. V11.03.09 25/05/2023  J.Tan          TSK 0923703
.           Recompiled for ABF new calculations
.           14/06/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Re-worked code to round up ICU & NCU hrs
. V11.03.08 17/05/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Rounded up ICU & NCU hrs for VIC
. V11.03.07 09/05/2023 J.Tan           TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.06 17/04/2023 Bella Turco     TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.05 14/04/2023  J.Tan          TSK 0900145
.           Recompiled for NZPCATBI - Win/Loss for each procedure
. V11.03.04 12/01/2023  J.Tan          TSK 0900145
.           Recompiled for NZPCATBI - Win/Loss for each procedure
. V11.03.03 10/03/2023  J.Tan          TSK 0924587
.           Recompiled for PATCATBI - not to print zero line of Patient Inv.
.           07/02/2023  Davin          TSK 0922254
.           Added check for CodeFocus InvoiceOnHold reason (CZER0000/CHLD0000)
. V11.03.02 14/12/2022  Thanh T         TSK 0926561
.           Changed MCHG2010 to show 'N/A' when there is no theatre history
. V11.03.01 24/11/2022  J.Tan                0906597
.           Recompiled for ABFSAINV - checking Contract close off date
. V11.02.15 17/10/2022  Peter Vela           0924401
.           Fixed I*C for oprsrgaf in CHKT0000
. V11.02.14 10/10/2022  Peter Vela           0925622                 
.           Recompiled for PATINVS - Removed old Eclipse IHC from    
.           Inpatient Invoicing                                      
.           04/10/2022 Jill Parkinson Task 0924401
.           Mods to look for abandoned case before marking as theatre incomplete
.           CHKT0000
. V11.02.13 29/08/2022 J.Tan           TSK 0906597
.           Mod for Sub-Acute NWAU Calculations
.           12/09/2022 Thanh T         TSK 0908346
.           Called CHKCLDCP to check if the clinical document is setup for 
.           the claim type clininal document mapping table. This will determine
.           the disabled status of the Invoice button
. V11.02.12 20/07/2022 J.Tan           TSK 0922228
.           Mod Checking for Patient Hold invoice
. V11.02.11 14/07/2022  J.Tan           TSK 0922228
.           Mod Invoice pending list to check for Hold invoice status
. V11.02.10 29/06/2022  J.Tan           TSK 0914045
.           Recompiled for NZPCATBI - check for next available Contract Funding
. V11.02.09 29/06/2022 J.Tan           TSK 0920712
.           Recompiled for ABFAECCL - I*D on emrvcdaf file
. V11.02.08 09/06/2022  Alina Bhari    TSK 0920585
.           Changed the word "Days Of Hospitalisation" tag to
.           "Prior Days Hospitalisation"
. V11.02.07 26/05/2022  J.Tan          TSK 0906596
.           Mod for NWAU Calculations details
. V11.02.06 04/05/2022  Jacob Jackson  TSK 0864505
.           Recompiled for PATINVHL/PATINVTL
.           Add PTCNPFSN/PTCNPFGN
. V11.02.05 28/03/2022  J.Tan          TSK 0814566
.           Recompiled for PATCATBI - Added Hospital & Eff.date to patfn2af
. V11.02.04 24/03/2022  J.Tan           TSK 0916593
.           Recompiled for PATCATBI - displaying Patient rate for PTCNPPIN=1
. V11.02.03 16/03/2022  J.Tan           TSK 0902652
.           Recompiled for AAECATBI/OUTCATBI - New Patient Invoice
. V11.02.02 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 31/01/2022 Peter Vela      TSK 0902857
.           Recompiled for PATINVS - Changed WebServices parameter validation
.           to switch exclusively between WebServices and SA
. V11.01.26 14/12/2021 Peter Vela      TSK 0902857
.           Recompiled for PATINVS - Added extra keystrokes to SWEBX000
. V11.01.25 08/11/2021 J.Tan           TSK 0880410
.           Recompiled for PATIPERH - added Hospital and System
. V11.01.24 12/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFPTINV - checking blank Set code for Multiple NEP
. V11.01.23 28/10/2021 J.Tan           TSK 0913056
.           Recompiled for ABFAECCL-ADMFLAG and CCAR0000(Clinical Care)
. V11.01.22 13/10/2021 J.Tan           TSK 0905305
.           Recompiled for ABFAECCL - Adjustment type 068 & 069
. V11.01.21 27/09/2021 J.Tan           TSK 0901515
.           Recompiled for CMXMATRX - Added for Primary ICD Procedures
. V11.01.20 14/09/2021  J.Tan          TSK 0906222
.           Recompiled for ABFPTINV - Mod for Multiple NEP Values
. V11.01.19 14/09/2021  Davin          TSK 0911277
.           Recompiled for PRTINVBD
. V11.01.18 10/09/2021  Davin          TSK 0911277
.           Recompiled for PATINVTL - Changed field 20 length to 12.2
. V11.01.17 31/08/2021  J.Tan          TSK 0910799
.           Recompiled for PRTINVBD - printing Referring ADF
.           30/08/2021  J.Tan           TSK 0905305
.           Recompiled for AAECATBI - AE Care class (ABFAECCL)
. V11.01.16 25/08/2021  J.Tan           TSK 0903454
.           Recompiled for PATCATBI - Added claim code to LS/Daily for CACCFEE=4
.           24/08/2021  Davin           TSK 0897318
.           Recompiled for PATINVTL - added field 57 Adjustment Total
. V11.01.15 25/08/2021  Ebon Clements   TSK 0910608
.           Fixed invoice pending coding date all filter IPND2600
. V11.01.14 03/08/2021  J.Tan           TSK 0909724
.           Recompiled for PRTINVBD - SJOG invoice
. V11.01.13 07/07/2021  J.Tan           TSK 0908588
.           Recompiled for PATCATBI - Exclude Unqualified days for Casepayment
. V11.01.12 25/06/2021  J.Tan           TSK 0908224
.           Fixed displaying HF group for Inv.pending sort
. V11.01.11 17/06/2021  J.Tan           TSK 0907752
.           Mod IPND3500 checking for blank health fund
. V11.01.10 16/06/2021  Peter Vela      TSK 0907637
.           Recompiled for PATINVS - Added Web Services parameter check
.           before executing IBAWEB04
. V11.01.09 26/05/2021  J.Tan           TSK 0863287
.           Recompiled for PATCATBI - displaying the Rate for Items
. V11.01.08 19/05/2021  J.Tan           TSK 0902344
.           Fixed updating NZ item with PMMIITYP=3 
. V11.01.07 06/05/2021  J.Tan           TSK 0863287
.           Recompiled for PATINVS - auto reassign debt for Patient invoice
. V11.01.06 05/05/2021  Don Nguyen      TSK 0904865
.           Corrected code in LSTPAY00 (List Expected Payor Details) to fix 
.           <form> and </form> tag order.
. V11.01.05 03/05/2021  J.Tan           TSK 0863287
.           Fixed Discharge Billing Statement for PTCNPPIN=1
. V11.01.04 28/04/2021  Thanh T        TSK 0895165                          
.           Recompiled for OPRARDFD changes                                  
.           22/04/2021  Sunny          TSK 0832601
.           Added PLST2200,IPND3500 - Health Fund Group filter
.           Added PLST2300 - Coded Only filter (Inpatients)
. V11.01.03 01/04/2021  Peter Vela     TSK 0902857
.           Recompiled for WEBIHCFD - Added Index 8
.           07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.02 23/03/2021  Peter Vela     TSK 0902857
.           Recompiled for PATINVS - WebServices IHCW
.           09/03/2021  J.Tan           TSK 0863287
.           Mod for Patient Invoice new functionality
.           Added Auto reassign pat.debt to Pat Only Invoice
.           11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
. V11.01.01 17/02/2021  J.Tan           TSK 0888639
.           Changed Counter PATMMBFD OPRPMBFD to DIM 3
.           22/02/2021  Peter Vela     TSK 0902857
.           Recompiled for PATINVS - WebServices IHCW
. V11.00.31 25/01/2021  J.Tan          TSK 0901244
.           Fixed CSPY0000 to clear DIM127 if Contract is blank
. V11.00.30 19/01/2021  J.Tan          TSK 0883075
.           Recompiled for PRTINVBD - mod to print ADF address on invoice
. V11.00.29 11/01/2020  J.Tan          TSK 0900412
.           Fixed NZ Misc.Item froup when Updating 'No validating' Misc.itm code
. V11.00.28 09/12/2020  Thanh T        TSK 0872840
.           Recompiled as PMSPX2TM changes
. V11.00.27 19/11/2020  J.Tan           TSK 0895375
.           Added MDATE0000 for NZ Favourite item
. V11.00.26 10/11/2020  J.Tan           TSK 0899562
.           Recompiled for CMXMATRX - setup date for reading MBS item
. V11.00.25 09/11/2020  J.Tan           TSK 0882820
.           Mod to availibity of Raise button for Patient Only invoice
. V11.00.24 22/10/2020  J.Tan           TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.23 14/10/2020  J.Tan          TSK 0894879
.           Recompiled for PRTINVBD - Print 30 item desc.for RCH Invoice
. V11.00.22 14/10/2020  J.Tan          TSK 0897475
.           Recompiled for CMXMATRX - Fixed displaying Discharge destination
. V11.00.21 29/09/2020  J.Tan          TSK 0896829
.           Recompiled for CMXMATRX - use National(PTPGNDRG)instead of State DRG
. V11.00.20 22/09/2020  J.Tan           TSK 0895330
.           Recompiled for CMXMATRX - reposition read of Matrix table
. V11.00.19 25/08/2020  J.Tan          TSK 0895840
.           Recompiled for NZPCATBI - Fixed Keyin amount (Inc.to Contract)item
. V11.00.18 25/08/2020  J.Tan          TSK 0896164
.           Recompiled for NZPCATBI - multiple Contract procedures issue
. V11.00.17 03/08/2020 J.Tan      TSK 0886178
.           Recompiled for ABFPTDET - fixed displaying ABF calculation
.           Recompiled for ABFPTDET - fixed displaying Invoiced DRG
. V11.00.16 14/07/2020 J.Tan      TSK 0892319
.           Recompiled for ABFPTINV - Additional NEP and Psych.Adjus.
.           17/07/2020 J.Tan      TSK 0888634
.           Fixed PMMICNTR for updating SX Item
. V11.00.15 14/07/2020  J.Tan          TSK 0892902
.           Recompiled for PATCATBI - Mod to initialise CASMXKEY
. V11.00.14 08/07/2020 J.Tan           TSK 0886178
.           Recompiled for ABFPTDET - mod to ABF details
. V11.00.13 01/07/2020  J.Tan           TSK 0892765
.           Recompiled for PATCATBI-Low outlier exc. unqualified days
.           05/07/2020  J.Tan           TSK 0892746
.           Recompiled for ABFPTINV - CALCAGE as at Admission date
. V11.00.12 29/06/2020  J.Tan           TSK 0893767
.           Recompiled for ABFPTINV - Changes CALCFLAG to 01/01/2021
. V11.00.11 22/06/2020  J.Tan            TSK 0892746
.           Recompiled for ABFOTINV - to use Disc.date for CALCAGE
. V11.00.10 07/05/2020  J.Tan            TSK 0891341
.           Recompiled for ABFPTINV - added TRAP to write pmsabfaf
. V11.00.09 29/04/2020  J.Tan          TSK 0838262
.           Recompiled for PATCATBI - MBS theatre fees
. V11.00.08 23/03/2020  Jill Parkinson  Task 0292638
.           Added code to store an invoice against a patient as a clinical
.           document
. V11.00.07 20/04/2020 J.Tan           TSK 0890733
.           Recompiled for ABFPTINV - ABF new 2020 calculation
. V11.00.06 08/04/2020 J.Tan           TSK 0868813
.           Recompiled for PATINVHL
. V11.00.05 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.04 12/03/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
.           Removed PATITMVD
. V11.00.03 27/02/2020  Ebon Clements    Task 0816715
.           Added created and updated by fields to future actions
. V11.00.02 26/02/2019  J.Tan           TSK 0888580
.           Mod NOT to write future action for Claim code Assc.7=X
. V11.00.01 17/02/2020  J.Tan           TSK 0888245
.           Recompiled for PATCATBI - setup TTYPE for Accommodation record
. V10.15.08 19/02/2020  J.Tan          TSK 0884937
.           Mod FNZI0000 to set NZMCKPRI for PMMIITYP=3 (items from HL7)
. V10.15.07 30/01/2020  J.Tan          TSK 0883777
.           Recompiled for PATCATBI - MV with Days of Hospitalisation
. V10.15.06 02/01./2020 J.Tan            TSK 0886176
.           Added ABF details to invoiced screen
. V10.15.05 29/11/2019  J.Tan            TSK 0878732
.           Mod FNZI1000 - restore Contract for Funder Contribution
.           29/11/2019  J.Tan            TSK 0857392
.           Recompiled for PATINVS - updating ABF DRG
. V10.15.04 01/11/2019  J.Tan            TSK 0882906
.           Recompiled for ABFPTINV - Calculating ICU Hours
. V10.15.03 11/10/2019  Peter Vela       TSK 0882906
.           Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF
. V10.15.02 07/10/2019  J.Tan            TSK 0882545
.           Mod ABF - Disabled Raise invoice button for undischarged patient
.           Mod to recalculate ABF charges prior displaying ABF details
. V10.15.01 09/10/2019  Thanh T          TSK 0860841
.           Get MRCNROUN for CALCCODE
.----------------------------------------------------------------------------
. V10.14.18 30/09/2019  J.Tan            TSK 0872482
.           Recompiled PATCATBI - MV with on Leave and Return on same day
. V10.14.17 30/09/2019  J.Tan            TSK 0881867
.           Mod ABF to remove inv.pending for items with zero amount
. V10.14.16 20/09/2019  J.Tan            TSK 0881867
.           Mod ABF to remove inv.pending for items with zero amount
.           Recompiled for ABFPTDET - fixed displaying discharges fields
. V10.14.15 19/09/2019  J.Tan            TSK 0857392
.           Fixed displaying invoice number on ABF detail screen
. V10.14.14 13/09/2019  J.Tan            TSK 0872482/0874475
.           Recompiled for PATCATBI/PATCMSTP - MV issues
. V10.14.13 06/09/2019  J.Tan            TSK 0857392
.           Recompiled for PATINVS - ABF Invoice
. V10.14.12 28/08/2019  J.Tan            TSK 0879743
.           Mods CHKNZ000 checking for Primary/Performed/Duration before Inv.
. V10.14.11 29/07/2019  J.Tan            TSK 0875639
.           Recompiled for PATDBTYP
. V10.14.10 16/07/2019  J.Tan            TSK 0867131
.           Recompiled for NZPCATBI - PMMIITYP (not to validate Misc.charge)
. V10.14.09 05/07/2019  Peter Vela      TSK 0857392
.           Mods for ABF Patient Level Enquiry Screen
.           21/05/2019  J.Tan           TSK 0857392
.           Mod for ABF Admitted invoice
. V10.14.08 05/06/2019  J.Tan            TSK 0867131
.           Recompiled for NZPCATBI - PMMIITYP (not to validate Misc.charge)
. V10.14.07 06/06/2019  J.Tan           TSK 0876097
.           Fixed RECTRNNO to DIM 5
. V10.14.06 07/05/2019  J.Tan           TSK 0857392
.           Mod NOT to write future action for Claim code Exclude from Eclipse
. V10.14.05 07/05/2019  Ania P          TSK 0873100
.           Added BCMN6000
. V10.14.04 18/04/2019  Peter Vela     TSK 0873407
.           Recompiled for CMXMATRX
. V10.14.03 12/03/2019  J.Tan          TSK 0867553
.           Recompiled for PATCATBI - allocating MV to ICU Adm.type
.           20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.02 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.01 27/02/2019  Ken Bell       TSK 0869548
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
. V10.13.08 22/01/2019  Peter Vela     TSK 0867807
.           Added validation for ECLIUEBB in GETPAT10
.           11/01/2019  Peter Vela     TSK 0867807
.           Recompiled for OUTCATBI
. V10.13.07 03/01/2019  J.Tan          TSK 0868413
.           Recompiled for GETEFDRG - Using Effective DRG
.           07/01/2019  J.Tan          TSK 0868242
.           Recompiled for DBSCATBI - Type of Certificate
. V10.13.06 26/10/2018  Thanh T        TSK 0859743                    
.           Added BULKBILL field and removed OUTHEDFD/OUTHEDIO,       
.           OUTSESFD/OUTSESIO for OUTCATBI changes                    
. V10.13.05 19/10/2018  J.Tan          TSK 0854372
.           Added tag for pmvxud15 - Anaesthetic type
.           23/10/2018  Tracey Nguyen  TSK 0859743
.           Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
.           24/10/2018  Thanh T        TSK 0859743
.           Added OUTHEDFD/OUTHEDIO, OUTSESFD/OUTSESIO for OUTCATBI changes
. V10.13.04 18/09/2018  J.Tan          TSK 0861312
.           Recompiled for PATDBTYP - NPD bdays for btype from Oper.
.           19/09/2018  J.Tan          TSK 0863727
.           Added Restrictive Override code
. V10.13.03 12/09/2018  J.Tan          TSK 0859233
.           Recompiled for PATCATBI - printing patient invoices
. V10.13.02 03/09/2018  J.Tan          TSK 0859911
.           Recompiled for PATCATBI - No Payday Add on charge
. V10.13.01 21/08/2017  J.Tan        TSK 0859742
.           Added ECLIPSE new fields from pmsmtiaf (Store & Forward details)
. V10.12.07 18/07/2018  J.Tan          TSK 0859911
.           Recompiled for PATCATBI - Fixed No Payday Add on charge
. V10.12.06 18/06/2018  Ebon Clements  TSK 0846868
.           Added exclude claim type from eclipse - ECLIND00
.           Recompiled for PATINVS
. V10.12.05 18/05/2018  Thanh T.       TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.04 26/04/2018  J.Tan          TSK 0825826
.           Recompiled for CMXMATRX - message for Contract id with no rule
. V10.12.03 20/04/2018  J.Tan          TSK 0855102
.           Recompiled for PATCATBI - Patient Only invoice
. V10.12.02 28/02/2018  J.Tan          TSK 0852351
.           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)
. V10.12.01 15/01/2018  J.Tan   TSK 0848146
.           Recompiled for PATCATBI - CACCFEE=5
. V10.11.11 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.10 23/11/2017  Davin          TSK 0846231
.           Recompiled for OPRPMBFD - added oppmrefn
. V10.11.09 23/10/2017  Peter Vela    TSK 0846918
.           Added date sorting for CODECOMP
. V10.11.08 02/10/2017  Steve Armstrong  TSK 0816814
.           Recompiled for changes to ACCDIAFD
. V10.11.07 11/09/2017  Thanh T.      TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.06 21/08/2017  J.Tan         TSK 0836172
.           Recompiled for PATDBTYP - Fixed for No payday (PCENDDTE)
.           24/08/2017  J.Tan         TSK 0843471
.           Recompiled for PATCATBI - PTDTEPSD for Daycase
.           31/08/2017  J.Tan         TSK 0837479
.           Added PMMICTYP - Consumption Type
. V10.11.05 09/08/2017  Peter Vela     TSK 0837619
.           Added IHC Adjustments functionality
. V10.11.04 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 27/07/2017  J.Tan          TSK 0842559
.           Recompiled for PATCATBI - CHKACCM0 to check for inv.number
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------------
.        V10.10.06  23/06/2017  J.Tan             TSK 0840395
.                   Fixed DSRT0000 - Sameday Casepayment daily fees on Stepdown
.        V10.10.05  13/06/2017  J.Tan             TSK 0839991
.                   Recompiled for PATDBTYP- Checking for blank Non-Accum.Inlier
.        V10.10.04  17/05/2017  J.Tan             TSK 0297904
.                   Recompiled for PATCATBI-Non-Accumulative inlier ICU/CCU rule
.        V10.10.03  19/04/2017  J.Tan          TSK 0832810
.                   Fixed displaying discount on stepdown screen
.        V10.10.02  25/01/2017  J.Tan          TSK 0832407
.                   Recompiled for PATCATBI- multi bed trans on sameday for MV
.        V10.10.01  21/02/2017  J.Tan          TSK 0829089
.                   Mod CZER0000 to check for Prosthetics complete
.        V10.09.05  28/12/2016  J.Tan          TSK 0829362
.                   Recompiled for PATCATBI - Changing Bed type on No payday
.                   29/12/2016  J.Tan          TSK 0827950
.                   Mods CZER0000 to update Inv.pending - Hold invoice
.        V10.09.04  23/12/2016  J.Tan          TSK 0827950
.                   Checking on hold invoice for Raise invoice availability
.        V10.09.03  20/12/2016  J.Tan          TSK 0323541
.                   Recompiled for PATCATBI - set PMMIAMTT for printing inv.
.        V10.09.02  13/12/2016  Jill Parkinson TSK 0822329
.                   Added definition of ACCPORD
.        V10.09.01  17/11/2016  J.Tan          TSK 0317714
.                   Recompiled for PATCATBI - fixed MV Daycse (ptdtepsd)
.                   28/11/2016  J.Tan         TSK 0827591
.                   Recompiled for PATCATBI - Fixed Next invoice (Nopayday=2)
.        V10.08.29  07/11/2016  Ebon Clements  TSK 0827937
.                   Recompiled for PATINVHL - Hospital approval number
.        V10.08.28  20/10/2016  J.Tan          TSK 0827903
.                   Mods DELG2000 - chk refund deposit for released receipt only
.        V10.08.27  05/10/2016  J.Tan          TSK 0826826
.                   Mods DELG2000 - checking for refund deposit
.        V10.08.26  05/10/2016 J.Tan          TSK 0826824
.                   Recompiled for CALCMVHR - MV Hours calculation
.        V10.08.25  21/09/2016  J.Tan         TSK 0826370
.                   Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3
.        V10.08.24  15/09/2016  J.Tan         TSK 0298257
.                   Mods to include Misc.from Eligibility to Disc.billing
.        V10.08.23  15/09/2016  J.Tan         TSK 0825673
.                   Fixed DELG000 (Dis.Billing Stat) to display Sameday excess 
.        V10.08.22  09/09/2016  J.Tan         TSK 0825673
.                   Mods DELG000 (Dis.Billing Stat) to display Sameday excess 
.                   for patient admitted today and Expected LOS is zero
.        V10.08.21  08/09/2016  J.Tan         TSK 0825719
.                   Recompiled for PATCATBI - fixed No payday Oper.date=Adate
.        V10.08.20  07/09/2016  J.Tan         TSK 0823259
.                   Recompiled for NZPCATBI - fixed theatre fees for sub.proc.
.        V10.08.19  26/08/2016  Don Nguyen    TSK 0312570
.                   Recompiled for CMXMATRX - Added check for PTCNDGED=1
.                   Added PMSEDGFD/IO and GETEFDRG
.        V10.08.18  24/08/2016  J.Tan         TSK 0321532
.                   Recompiled for GETBFEES
.        V10.08.17  17/08/2016  J.Tan         TSK 0808745
.                   Recompiled for PATCATBI - for NPDAYFLG=1
.        V10.08.16  17/08/2016  J.Tan         TSK 0823517
.                   Mods printing invoice to check for Patient Only Invoice
.        V10.08.15  16/08/2016  J.Tan         TSK 0823517
.                   Recompiled for PATCATBI for Patient Only Invoice(IPATFLAG)
.        V10.08.14  15/08/2016  J.Tan         TSK 0808852
.                   Added Go button on Invoice Pending List
.                   15/08/2016  J.Tan         TSK 0823517
.                   Mods CZER000 to check for Patient Only Invoice(IPATFLAG)
.        V10.08.13  20/07/2016  J.Tan         TSK 0819914
.                   Recompiled for PATCATBI - Non ICU MV Hours
.        V10.08.12  10/07/2016  J.Tan         TSK 0822042
.                   Mods checking CFEETYP before opening pmsmteaf
.        V10.08.11  15/07/2016  J.Tan         TSK 0819914
.                   Recompiled for PATCATBI - Calculating non ICU MV hours
.        V10.08.10  29/06/2016  J.Tan         TSK 0821701
.                   Fixed GLSM0000 - lumpsum amt on Casmix Override for Undisc.
.        V10.08.09  22/06/2016  J.Tan         TSK 0819815
.                   Added use of DSTAT in SUMM0000 for sites not using DDEST
.        V10.08.08  22/06/2016  J.Tan         TSK 0821226
.                   Fixed 'Address diff to PMI' for patient with no PRFA record
.        V10.08.07  20/06/2016  J.Tan         TSK 0820816
.                   Recompiled for PATCATBI - Fixed No payday for Daycase
.        V10.08.06  09/06/2016  J.Tan         TSK 0816651
.                   Changed Current Contract for Override screen to check for 
.                   Casemix Code from Matrix 
.        V10.08.05  02/06/2016  J.Tan         TSK 0816651
.                   Recompiled for PATCATBI - Continuous Bill.to chk for Matrix
.        V10.08.04  07/06/2016  J.Tan         TSK 0820201
.                   Mods to display 'Address diff.to PMI' for no prfa details
.        V10.08.03  12/05/2016  J.Tan         TSK 0817613
.                   Recompiled for PATCATBI - Checking Min/Max prior NoPayday
.        V10.08.02  29/04/2016  J.Tan         TSK 0817527
.                   Recompiled for PATCATBI - Fixed No Pay Day
.        V10.08.01  29/03/2016  J.Tan         CAR 0290448
.                   Recompiled for PATCATBI - Fixed Addon with No Pay Day
.        V10.07.11  10/03/2016  J.Tan         CAR 0322614
.                   Recompiled for DBSCATBI - Lumpsum description
.        V10.07.10  09/03/2016  J.Tan         CAR 0319403
.                   Fixed overnight/daycase excess on Disc.billing Stat
.        V10.07.09  04/03/2016  Peter Vela    CAR 0807988
.                   Fixed validation for excess in DELG1800
.                   04/03/2016  J.Tan         CAR 0814361
.                   Recompiled for DBSCATBI - Changed bed days variables
.                   04/03/2016  J.Tan         CAR 290448
.                   Recompiled for PATCATBI - Mods for Addon with No Pay DAy
.        V10.07.08 16/02/2016  J.Tan         CAR 0310703
.                   Mods Public Hosp to check to be invoiced amnt (CINVPEND)
.        V10.07.07  15/02/2016 J.Tan  CAR 0812936
.                   Recompiled for NZPCATBI - initialised TOTDAYS
.        V10.07.06  15/01/2016  J.Tan           CAR 0303942
.                   Recompiled for PRTINVBD - Mods to payment type
.        V10.07.05  31/12/2015  Peter Vela      CAR 0807988
.                   Recompiled for PRTELIGI
.        V10.07.04  31/12/2015  Peter Vela      CAR 0808530
.                   Added validation for excess in DELG1800
.        V10.07.03  03/12/2015  J.Tan           CAR 324233
.                   Added tag MSCHAMNT for Braemar Input Misc.item amount
.        V10.07.02  21/10/2015  J.Tan          CAR 315453
.                   Recompiled for PATCATBI - 'Make Primary based on MBS Fee'
.                   20/10/2015  J.Tan           CAR 321345
.                   Recompiled for CMXMATRX - mods to days for Max/Min daystay
.                   22/10/2015  J.Tan           CAR 321345
.                   Recompiled for PATCATBI - fixed bedfees desc.for daycase
.                   26/10/2015  J.Tan           CAR 317554
.                   Recompiled for CALCCODE-Calcultes Daycase ICU/CCU/NCU times
.        V10.07.01  19/10/2015  Don Nguyen      CAR 316625
.                   Added ALLCASFD/IO and opened file
.                   13/10/2015  J.Tan           CAR 322435
.                   Recompiled for PATCATBI - invoice desc. for bdays >999
.        V10.06.20  11/09/2015  J.Tan           CAR 317216
.                   Added SINVT000 and SINVH0000
.        V10.06.19  27/08/2015  J.Tan           CAR 317714
.                   Recompiled for PATCATBI- MV days greater than Beddays
.        V10.06.18  24/08/2015  Peter Vela      CAR 320734
.                   Added default printer to PRTINV70
.        V10.06.17  19/08/2015  J.Tan           CAR 317714
.                   Recompiled for PATCATBI- MV days greater than Beddays
.        V10.06.16  14/08/2015  J.Tan           CAR 320073
.                   Recompiled for PATCATAI- reprint invoice for unreleased cash
.        V10.06.15  13/08/2015  Don Nguyen     CAR 308621 
.                   Recompiled for PATVISTM - Added VISS6100
.        V10.06.14  07/08/2015  Davin          CAR 317002
.                   Recompiled for PRTINVBD - Print pmexname for ADF MO
.        V10.06.13  15/07/2015  J.Tan          CAR 319342
.                   Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'
.        V10.06.12  14/07/2015  J.Tan          CAR 317921
.                   Recompiled for PMSEXTTM - checking for inactive Insur.code
.        V10.06.11  14/07/2015  Peter Vela     CAR 319413
.                   Recompiled for PRBILCMN - Validate for deleted VISMDT
.                   record
.        V10.06.10  29/06/2015  J.Tan          CAR 308502
.                   Added Adm.source and Disc.Destination to Invoice header
.        V10.06.09  23/06/2015  J.Tan          CAR 318039
.                   Recompiled for PRBILCMN - printing billing comments for EMR
.        V10.06.08  09/06/2015  J.Tan          CAR 317346
.                   Fixed NZ Private (CFEETYPE) updating Invoice Pending
.                   10/06/2015  J.Tan          CAR 306795
.                   Added PRFA to Invoice header
.        V10.06.07  15/05/2015  Davin         CAR 310155
.                   Recompiled for PATGBCRN - added MOD10V05 for BPAY
.        V10.06.06  15/05/2015  J.Tan          CAR 294739                     
.                   Added option 19 to print Billing statement in bulk
.        V10.06.05  07/04/2015  J.Tan          CAR 244314                     
.                   Added 'Dr Billing Complete' to EMR Invoice pending list
.        V10.06.04  02/04/2015  Ania P         CAR 313236                     
.                   Recompiled for PRTINVBD                                   
.        V10.06.03  26/03/2015  J.Tan            CAR 297718
.                   Added SUMCOPAY and MAXCOPAY
.        V10.06.02  19/03/2015  Don Nguyen     CAR 300414
.                   Recompiled for CALCCODE - Added check for PTCNICUT
.        V10.06.01  10/03/2014  J.Tan          CAR 313385
.                   Mods to calc.Patient Balance Payable as invoice displayed
.        V10.05.30  04/03/2015  J.Tan          CAR 285468
.                   Mods Inv.Pending list Theatre Complete to check Thea.visit
.        V10.05.29  03/03/2015  Jill Parkinson CAR 313385
.                   Recompiled for PATCATBI - output of hidden invoice_total
.        V10.05.28  23/02/2015  J.Tan          CAR 311738
.                   Recompiled for PATCATBI - checking Keyin Misc.item amount
.        V10.05.27  19/02/2015 J.Tan      CAR 311352
.                   Mods Public Hosp.to check if only Daycase bed fees setup
.        V10.05.26  10/02/2015 J.Tan      CAR 311717
.                   Recompiled for PATINVHL
.        V10.05.25  10/02/2015 J.Tan      CAR 307472
.                   Fixed LOOPCNTR for Inv.Pending Sort table only
.        V10.05.24  12/01/2014  Peter Vela     CAR 310738
.                   Recompiled for PRTINVBD
.        V10.05.23  18/12/2014 J.Tan      CAR 309655
.                   Recompiled for CALCCODE - fixed ICU hours
.        V10.05.22  17/12/2014 J.Tan      CAR 310092
.                   Fixed printing Co-payment required for CCU,ICU,SCN,HDU
.        V10.05.21  10/12/2014 Peter Vela CAR 309840
.                   Recompiled for PATINVS
.        V10.05.20  20/11/2014 J.Tan      CAR 308855
.                   Fixed checking for DATE only for SCR Sort Inv.pending list
.        V10.05.19  18/11/2014 J.Tan      CAR 307472
.                   Added LOOPCNTR and select date to SCR Invoice pending list
.        V10.05.18  06/11/2014  Don Nguyen  CAR 304059
.                   Recompiled for changes to OPRSESIO - added Default Team 
.                   Completed fields.
.        V10.05.17  30/10/2014 J.Tan     CAR 307170
.                   Mods to display message on Item enquiry from Inv.screen
.        V10.05.16  29/10/2014 J.Tan     CAR 307268
.                   Recompiled for PATCATBI - disp.date for Mech.Ventilation
.        V10.05.15  28/10/2014 J.Tan     CAR 304455
.                   Recompiled for PATINVHL - fixed Doctor Name and Provider no
.        V10.05.14  24/10/2014 J.Tan      CAR 307539
.                   Recompiled for PATCATBI - Displaying SX Deposit
.        V10.05.13  23/10/2014 Peter Vela CAR 306906
.                   Changed DietIcon to EditIcon in LPRC0000
.        V10.05.12  20/10/2014  J.Tan            CAR 307177
.                   Added tag for checking Next invoice billing comment-vismdta
.        V10.05.11  08/10/2014  Davin            CAR 300056
.                   Added Coding Delay Reason to invoice pending list
.                   (codeinco/ipnd0000)
.        V10.05.10  29/09/2014 J.Tan  CAR 305654
.                   Recompiled for NZPCATBI - Fixed availability of Raise button
.        V10.05.09  26/09/2014 J.Tan  CAR 291619
.                   Recompiled for PATCATBI/PRTINVBD - MV NOT to print Quantity
.                   25/09/2014 J.Tan  CAR 301281
.                   Recompiled for PATCATBI - MV to be HF Portion
.        V10.05.08  25/09/2014 J.Tan  CAR 306416
.                   Recompiled for GETCNEFF - checking NZPrivate bed fees
.        V10.05.07  22/09/2014 J.Tan  CAR 253233
.                   Added Access Same day and Co-payment CCU,ICU,SCN and HDU 
.                   to Disc.billing statement
.        V10.05.06  19/09/2014 J.Tan  CAR 299241
.                   Recompiled for CALCCODE - minutes in ICU
.        V10.05.05  19/09/2014 J.Tan  CAR 305963
.                   Recompiled for NZPCATBI-clear PATDTR prior raising FFS Inv.
.        V10.05.04  05/08/2014 Peter Vela      CAR 302164
.                   Added PMMIRBRS - Rebate Reason CAT Rr
.        V10.05.03  31/07/2014 J.Tan           CAR 303625
.                   Recompiled for PATCATBI - stepdown before end of Contract
.        V10.05.02  25/07/2014 Ebon Clements   CAR 301870
.                   Fixed test for ICD coding exists - INVD9500
.        V10.05.01  23/07/2014 J.Tan           CAR 303861
.                   Mods Deleting item to check Inv.pending for Public hosp.
.        V10.04.27  03/07/2014 J.Tan           CAR 268860
.                   Recompiled for PATCATBI - ICD10 Suggested Classification
.        V10.04.26  26/06/2014 J.Tan           CAR 268860
.                   Fixed Invoice with ICD10 Suggested Classification
.        V10.04.25  19/06/2014 J.Tan           CAR 302452
.                   Recompiled for WEBDINVS - Changed MCHGARR/MCHGAMT
.        V10.04.24  16/06/2014 Jill Parkinson CAR 301639
.                   Fixed GOTO GBFE9999 to GOTO GBFE9998                
.                   Fixed GOTO GNBF9999 to GOTO GNBF9998                
.                   Fixed GOTO GDAY9999 to GOTO GDAY9998                
.                   Fixed GOTO GADD9999 to GOTO GADD9998                
.                   Fixed GOTO PAYB9999 to GOTO PAYB9998                
.        V10.04.23  10/06/2014 Jill Parkinson CAR 301639
.                   Recompiled to remove debugging display statements
.        V10.04.22  06/06/2014 Jill Parkinson CAR 301639
.                   Recompiled for patcatbi - Added CLEZ0000 and CLEY0000 to 
.                   clear tempfiles in case iserase failed
.        V10.04.21  05/06/2014 Jill Parkinson CAR 301639
.                   Moved calls to TFILENAM into INIT000 
.                   (from patcatbi-CMRV0000,PT2P0000 and PTMP0000)
.        V10.04.20  23/05/2014 J.Tan  CAR 300784
.                   Recompiled for STEPDOWN-ignore force stepdown prior invoice
.                   Fromdate for interim invoice
.                   26/05/2014 J.Tan  CAR 295319
.                   Added Balance payable
.         V10.04.19 17/05/2014 J.Tan  CAR 300260
.                   Recompiled for NZPCATBI-Check prev record after Inactive itm
.         V10.04.18 16/04/2014  J.Tan            CAR 261630
.                   Removed pataub patauc pataui pataum patauf audit files
.         V10.04.17 22/04/2014 J.Tan  CAR 300260
.                   Recompiled for NZPCATBI - Checking Active/Inactive Items
.         V10.04.16 16/04/2014  J.Tan            CAR 261630
.                   Removed port number from temp files
.         V10.04.15 11/04/2014  J.Tan           CAR 292653
.                   Added Invoice Comments to Raise invoice screen
.         V10.04.14 07/04/2014  Peter Vela      CAR 286258
.                   Recompiled for PATMASTM
.         V10.04.13 01/04/2014 J.Tan  CAR 299227
.                   Recompiled for NZPCATBI - Misc.item with blank Effec.todate
.         V10.04.12 31.03.2014  B.G.Ackland  CAR 299363
.                   Replace META Tag Redirect with Javascript in Common RDIREC00
.                   Routine
.         V10.04.11 12/03/2014 J.Tan  CAR 298449
.                   Recompiled for NZPCATBI - Checking quantity for Packed item
.         V10.04.10 26/02/2014  J.Tan           CAR 275810
.                   Recompiled for PMSEXTTM - added DAN & PMIKeys No.
.                   Recompiled for PATCATBI - to print Defence Force details
.         V10.04.09 25/02/2014 J.Tan  CAR 297463
.                   Recompiled for NZPCATBI - save nzspcprc prior NZMS0000
.         V10.04.08 19/02/2014 J.Tan  CAR 297372
.                   Recompiled for NZPCATBI - Checking items on Procedure Matrix
.         V10.04.07 13/02/2014 J.Tan  CAR 273713
.                   Recompiled for PRTINVBD - print Payment types on invoice
.         V10.04.06 24/01/2014 J.Tan  CAR 296422
.                   Recompiled for NZPCATBI - TCLAIM=2
.         V10.04.05 03/02/2014  J.Tan        CAR 265430
.                   Mods to display Pat.total(Disc.Billing amount) on inv.header
.         V10.04.04 21/01/2014 J.Tan         CAR 285293
.                   Added tag for PMMISUNQ - Theatre Banding
.         V10.04.03 17/01/2014  J.Tan        CAR 295008 
.                   Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.                   20/01/2014  J.Tan        CAR 249828
.                   Added PMMIPMBS - Patient MBS Team and Counter
.         V10.04.02 19/12/2013 J.Tan  CAR 285293
.                   Added buttons for ICD Coding and Theatre Items on Inv.banner
.                   19/12/2013 J.Tan  CAR 291082
.                   Added Contract/Role in Invoice banner
.         V10.04.01 16/07/2013 J.Tan  CAR 293928
.                   Recompiled for NZPCATBI - items from Secondary procedure
.---------------------------------------------------------------------- 
.         V10.03.97 13/12/2013  J.Tan          CAR 294609 
.                   Recompiled for CMXMATRX - mods for Default Grouper Version
.         V10.03.96 12/12/2013 J.Tan  CAR 292415
.                   Recompiled for PATINVS - updating correct index of rcpdteaf
.         V10.03.95 12/12/2013 J.Tan  CAR 295078
.                   Fixed Community billing for Default Misc.(Non Multi Hosp.)
.         V10.03.94 09/12/2013 Ania P CAR 294740
.                   Added DBILFLAG
.         V10.03.93 18/11/2013 J.Tan  CAR 294151
.                   Fixed Invoice total(field 45)invoice tail for Disc.Billing
.         V10.03.92 13/11/2013 J.Tan  CAR 283618
.                   Mods for Independence Services billing
.         V10.03.91 25/09/2013 J.Tan  CAR 283618
.                   Mods for Independence Services billing
.                   Fixed FVAR3000 - not to use ACLAIM(bedfees stepdown screen)
.                   10/10/2013 J.Tan  CAR 289811
.                   Changed bed fees column from FORM1 to FORM2
.         V10.03.90 11/10/2013 J.Tan  CAR 251004
.                   Recompiled for STEPDOWN - Check Disc. writing to pattranf
.         V10.03.89 02/10/2013 J.Tan  CAR 291588
.                   Recompiled for PATCATBI - fixed Stepdown Return from Leave
.         V10.03.88 25/09/2013 J.Tan  CAR 281515
.                   Recompiled for DBSCATBI - exclude items for Disc.Billing
.         V10.03.87 17/09/2013 J.Tan  CAR 259879
.                   Recompiled for NZPCATBI - Check Eff.date for SX inactive Itm
.         V10.03.86 13/09/2013 J.Tan  CAR 287793
.                   Recompiled for NZPCATBI - WRTM0000 checking claim indc7
.         V10.03.85 12/09/2013 Peter Vela      CAR 271911
.                   Recompiled for PATINVTL
.         V10.03.84 10/09/2013 Steve Armstrong CAR 291089
.                   Recompiled for changes to PMSQVIIO
.         V10.03.83 19/08/2013 Peter Vela      CAR 289732
.                   Took out changes in VALC0000 
.         V10.03.82 16/08/2013 Peter Vela      CAR 289732
.                   Fixed Department of Defence validation in VALC0000
.         V10.03.81 14/08/2013 J.Tan           CAR 289809
.                   Recompiled for PATCATBI -Mods to include Days of Hosp.
.         V10.03.80 12/08/2013 J.Tan           CAR 290044
.                   Recompiled for PATCMSTP -fixed writing trans.rec after disc.
.         V10.03.79 07/08/2013 J.Tan           CAR 288416
.                   Recompiled for CMXMATRX - Discharge Billing statement
.         V10.03.78 05/08/2013  J.Tan          CAR 288060 
.                   Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary
.         V10.03.77 18/07/2013  Steve Armstrong  CAR 268961
.                   Recompiled for changes to PMSQVIFD.
.         V10.03.76 25/06/2013 J.Tan           CAR 287218
.                   Recompiled for PATCATBI - default MBS quantity to one
.         V10.03.75 20/06/2013  Davin         CAR 287161
.                   Recompiled for PATGBCRN - right justify ptcnhbpi
.         V10.03.74 19/06/2013 J.Tan  CAR 286676
.                   Recompiled for NZPCATBI - fixed printing SX Pack item
.         V10.03.73 30/05/2012 J.Tan  CAR 281611
.                   Added CKHOSPID - for SX Enquiry/Raise invoice
.         V10.03.72 13/05/2013  J.Tan             CAR 282824
.                   Added Transfer Trim Point to Casemix funding
.         V10.03.71 10/05/2012 J.Tan  CAR 284175
.                   Recompiled for NZCATBI - fixed Acccomodation description
.         V10.03.70 08/05/2013  J.Tan          CAR 284289
.                   Added Record status to Invoice pending list for STV
.         V10.03.69 06/05/2013  J.Tan          CAR 284902
.                   Recompiled for STEPDOWN - force stepdown prior Inv.Fromdate
.         V10.03.68 17/04/2013  Don Nguyen     CAR 282342
.                   Recompiled for PATINVHL, PATINVTL
.         V10.03.67 10/04/2013  J.Tan    CAR 283743
.                   Recompiled for PATCATBI -  reset PTTRESPD for New Stepdown
.         V10.03.66 09/04/2013  Don Nguyen     CAR 282342
.                   Recompiled for PATGBCRN, PATINVHL, PATINVTL
.         V10.03.65 26/03/2013  Don Nguyen     CAR 282342
.                   Recompiled for PATGBCRN
.         V10.03.64 25/03/2013  J.Tan          CAR 283006
.                   Fixed WA Changing Financial Election
.         V10.03.63 08/03/2013  J.Tan          CAR 282313
.                   Recompiled for PATCATBI - Fixed force stepdown for perdiem
.         V10.03.62 05/03/2013  Patrick Adair CAR 281898
.                   Recompiled for PATCATBI PATCATAI
.         V10.03.61 04/03/2013  J.Tan          CAR 282129
.                   Recompiled for PATCATBI - Fixed Contract ID for Interim inv.
.         V10.03.60 26/02/2013  J.Tan          CAR 278330
.                   Recompiled for PATCATBI - searching for valid Multi Proc.
.         V10.03.59 08/02/2013  Peter Vela     CAR 267297
.                   Added tags for Past Medical History, Working Diagnosis and
.                   Clinical Notes
.         V10.03.58 18/12/2012  J.Tan          CAR 274769
.                   Recompiled for PATINVS - fixed PINVTYP for split invoice
.         V10.03.57 06/12/2012  J.Tan          CAR 237130
.                   Recompiled for DBSCATBI - Total of PHX & PHXP (Disc.Billing)
.         V10.03.56 15/11/2012  J.Tan          CAR 262673
.                   Recompiled for PATCATBI - Casepayment perdiem rate
.                   04/12/2012  J.Tan          CAR 271474
.                   Recompiled for CMXMATRX - using index 5 of patcmtaf
.         V10.03.55 02/11/2012 J.Tan  CAR 275383
.                   Fixed changing quantity on SX Update/Delete Misc.item
.         V10.03.54 23/10/2012  Mike Laming    CAR 267261
.                   Recompiled for PMSEXTTM - Added OSeas Country List
.                   25/10/2012 J.Tan  CAR 274721
.                   Mods to extend NZP Item description on Update item screen
.         V10.03.53 16/10/2012  J.Tan          CAR 274111
.                   Recompiled for PRTINVBD - fixed printing West Wimmera layout
.         V10.03.52 12/10/2012  J.Tan          CAR 274381
.                   Recompiled for PRTINVBD - printing accommodation desc.
.         V10.03.51 12/10/2012  Patrick Adair  CAR 273294
.                   Recompiled for PATCLMTM
.                   12/10/2102  J.Tan          CAR 272702
.                   Fixed changing SX items with Keyin price
.         V10.03.50 08/10/2012  J.Tan          CAR 261643
.                   Fixed printing extra lines on Discharge Billing statement
.         V10.03.49 02/10/2012  J.Tan          CAR 273452
.                   Recompiled for PATCATBI - Mechanical Ventilations issue
.         V10.03.48 02/10/2012  J.Tan          CAR 267784
.                   Mods to disabled Raise/Print invoice for Undisc. with
.                   Contract for 'Discharged from'
.         V10.03.47 05/09/2012  J.Tan          CAR 267784
.                   Mods Checking for TCINDC19 Claim Code
.                   14/09/2012  J.Tan          CAR 273115
.                   Fixed validating HF Adjustment Code
.         V10.03.46 28/08/2012  J.Tan          CAR 269748
.                   Fixed Stepdown for 'As at Effective date' Contract ID
.         V10.03.45 24/08/2012  J.Tan          CAR 271924
.                   Recompiled for PATCATBI - Fixed 'As At Date' Contract ID
.         V10.03.44 22/08/2012  J.Tan          CAR 270626
.                   Fixed WA Insurance code selection for Visit screen
.         V10.03.43 09/08/2012  J.Tan          CAR 269134
.                   Fixed to include ADYHOSP for a change of new Contract
.         V10.03.42 07/08/2012  J.Tan          CAR 268874
.                   Fixed printing West Wimmera Invoice layout
.         V10.03.41 06/08/2012  J.Tan          CAR 270631
.                   Recompiled for PATCATBI - Fixed Contract Effective Date
.         V10.03.40 03/08/2012  J.Tan          CAR 270580
.                   Recompiled for PATCAGTBI - Fixed Discharge billing statement
.         V10.03.39 30/07/2012  J.Tan          CAR 268318
.                   Mods for Emergency Procedure fee information
.         V10.03.38 30/07/2012  J.Tan          CAR 269748
.                   Fixed Stepdown for 'As at Effective date' Contract ID
.         V10.03.37 25/07/2012  J.Tan          CAR 266612
.                   Recompiled for PRTINVBD - printing Cabrini item rates
.         V10.03.36 25/07/2012  J.Tan          CAR 263251
.                   Fixed Next and Previous to pass ShowHead for Invoice Pending
.         V10.03.35 24/07/2012  J.Tan          CAR 269748
.                   Recompiled for PATCATBI - Fixed 'As at Effec.date' Contracts
.         V10.03.34 23/07/2012 J.Tan  CAR 257771
.                   Mods to display Time in Recovery on NZprivate Invoice
.         V10.03.33 19/07/2012  J.Tan          CAR 267037
.                   Recompiled for PATCATBI - Fixed 'As at Effec.date' Contracts
.                   18/07/2012  Don Nguyen     CAR 264561
.                   Recompiled for PATGBCRN
.         V10.03.32 26/06/2012  J.Tan          CAR 267037
.                   Recompiled for PATCATBI - interim inv.with multiple Contract
.         V10.03.31 19/06/2012  J.Tan          CAR 265241
.                   Fixed manual stepdown
.         V10.03.30 13/06/2012  J.Tan          CAR 267037
.                   Recompiled for STEPDOWN -Bed Fees Accom. (As at Date)
.         V10.03.29 13/06/2012  J.Tan          CAR 267037
.                   Recompiled for PATCATBI -Theatre Fee Contract Eff.As At Date
.         V10.03.28 05/06/2012  J.Tan          CAR 255708
.                   Mods to display full free text of Reason for hold invoice
.         V10.03.27 05/06/2012 J.Tan  CAR 246586
.                   Recompiled for NZPCATBI - set Session of Theatre charges
.         V10.03.26 17/05/2012  J.Tan          CAR 263251
.                   Added Showhead to Report 8 (Invoice pending list)
.         V10.03.25 17/05/2012  J.Tan          CAR 265293
.                   Recompiled for PATCATAI - Disch.Billing Statement
.         V10.03.24 11/05/2012 J.Tan  CAR 250477
.                   Fixed SX Pack items
.         V10.03.23 07/05/2012  J.Tan          CAR 264075
.                   Recompiled for NZPCATBI - Stepdown for Patient Contract
.                   07/05/2012  J.Tan          CAR 263916
.                   Fixed NZ Private Keyin amount item
.         V10.03.22 30/04/2012  Saroeun Soeur  CAR 263106
.                   Recompiled for PATCATBI
.         V10.03.21 11/04/2012  J.Tan          CAR 263363
.                   Recompiled for PATCATBI - fixed No Pay Day
.         V10.03.20 30/03/2012  J.Tan          CAR 262863
.                   Recompiled for PATCATBI - fixed MV Stepdown
.         V10.03.19 27/03/2012  J.Tan          CAR 262517
.                   Recompiled for PRTINVBD - SJOG layout to print item rate
.         V10.03.18 20/03/2012  J.Tan          CAR 259567
.                   Recomp.PATCATBI - BF desc.manual stepdown on daycase rate
.         V10.03.17 20/03/2012  J.Tan          CAR 262073
.                   Recompiled for PATINVS - not to remove pending for Pat.inv.
.         V10.03.16 14/03/2012 Peter Vela CAR 261166
.                   Recompiled for PATINVS
.         V10.03.15 07/03/2012 J.Tan  CAR 250477
.                   Mods for Pack items
.         V10.03.14 28/02/2012  J.Tan          CAR 260975
.                   Mods to display Casemix invoice if prov.casemix is not blank
.         V10.03.13 24/02/2012  J.Tan          CAR 260758
.                   Recompiled for CMXMATRX - checking for Days stay
.         V10.03.12 20/02/2012  J.Tan          CAR 260351
.                   Recompiled for PATCMSTP -save SAVTDATE for Add.chrg stepdown
.         V10.03.11 17/02/2012  J.Tan          CAR 259567
.                   Mods Stepdown to display perdiem if PMMICMXP=N(Matrix found)
.         V10.03.10 06/02/2012 J.Tan  CAR 259172
.                   Recompiled for NZPCATBI - Fixed I*I on nzprdtaf file
.         V10.03.09 31/01/2012  J.Tan          CAR 259256
.                   Recompiled for PATCATBI - Fixed Prosthetic Required display
.         V10.03.08 16/01/2012  Sandra Barcham  CAR 256563
.                   Recompiled for PATMASTM
.         V10.03.07 11/01/2012 J.Tan           CAR 257142
.                   Recompiled for PRTINVBD - Hospital provider number
.         V10.03.06 11/01/2012 J.Tan           CAR 257389
.                   Recompiled for PATCATBI - initialised MBSCONTR
.         V10.03.05 10/01/2012 J.Tan           CAR 257682
.                   Recompiled for PATCATBI - bedfee desc.for Manual Stepdown
.         V10.03.04 16/11/2011 J.Tan           CAR 237245
.                   Recompiled for PATCATBI - JH inv.printing negative rounding
.         V10.03.03 14/11/2011  J.Tan CAR 235425
.                   Recompiled for NZPCATBI - SX invoice layout
.         V10.03.02 09/11/2011 J.Tan           CAR 255042
.                   Recompiled for GETTFEES-reset overnight HF type if no daycas
.         V10.03.01 07/11/2011  J.Tan CAR 254871  
.                   Recompiled for CALCCODE - calculating ICU for daycase
.         V10.02.39 04/11/2011 J.Tan           CAR 237245
.                   Recompiled for PATCATBI - JH inv.to print rounding amount
.         V10.02.38 28/10/2011 J.Tan  CAR 254208
.                   Fixed updating Continues billing event
.         V10.02.37 27/10/2011  Steve Armstrong CAR 251323
.                   Recompiled for PMSQVIFD changes
.         V10.02.36 14/10/2011 J.Tan  CAR 235378
.                   Mods for SX Misc.item update changes
.         V10.02.35 13/10/2011 J.Tan  CAR 253041
.                   Fixed displaying rates not setup from status adjustment
.         V10.02.34 12/10/2011 J.Tan  CAR 235370
.                   Recompiled for PATINVHL - NHI names for SX
.         V10.02.33 11/10/2011 J.Tan  CAR 252911
.                   Mods to set exit on status adjustment
.         V10.02.32 11/10/2011  Mark Coupland    CAR 252429
.                   Recompiled for PMSPX2TM and PATMASTM
.         V10.02.31 04/10/2011 J.Tan  CAR 252508
.                   Recompiled for PRTINVBD - printing deposit on raised invoice
.         V10.02.30 29/09/2011 J.Tan  CAR 252227
.                   Recompiled for PRTINVBD - fixed printing items
.                   27/09/2011 J.Tan  CAR 251945
.                   Recompiled for PATINVHL - printing Primary doctor
.         V10.02.29 28/09/2011 J.Tan  CAR 252125
.                   Recompiled for PATCATBI - printing claim for SJOG invoice
.         V10.02.28 17/09/2011 J.Tan  CAR 251291
.                   Fixed changing bed type from Stepdown
.         V10.02.27 15/09/2011 J.Tan  CAR 251292
.                   Recompiled for PATCATBI - fixed printing lumpsum desc.
.         V10.02.26 13/09/2011 Jill Parkinson  CAR 248652
.                   Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
.         V10.02.25 12/09/2011 J.Tan  CAR 249478
.                   Recompiled for NZPCATBI - SX invoice
.         V10.02.24 30/08/2011  Peter Vela      CAR 248636
.                   Add Insurance Company dropdown tag for
.                   Other Compensable Details screen (patweb8901341.html)
.         V10.02.23 29/08/2011  J.Tan          CAR 248632
.                   Added tag for Australian defence Service 
.         V10.02.22 26/08/2011  J.Tan          CAR 248301
.                   Fixed Repatriation no and Card colour for DVA
.         V10.02.21 23/08/2011  J.Tan          CAR 249025
.                   Recompiled for CALCCODE - not to use TRANDATE TRANTIME
.         V10.02.20 22/08/2011 J.Tan          CAR 235765
.                   Recompiled for PATINVHL - free text field for SX Insurer
.         V10.02.19 18/08/2011  J.Tan          CAR 248772
.                   Fixed selection of insurance code for workers comp.
.         V10.02.18 05/08/2011  J.Tan          CAR 244159
.                   Fixed displaying Cash
.         V10.02.16 03/08/2011 J.Tan          CAR 239592
.                   Mods Extra Comp. - Selection of Insurance for a claim code
.         V10.02.15 26/07/2011 J.Tan          CAR 239592
.                   Fixed clearing Extra compensable fields
.         V10.02.14 13/07/2011 Jill Parkinson CAR 246408
.                   Mods to check if all bookings are cancelled in CHKNZ000
.         V10.02.13 17/06/2011 Jill Parkinson CAR 229414
.                   Mods to leave patmmbsf records if DEFRTHAL is not set
.         V10.02.12 17/06/2011 Jill Parkinson CAR 241548
.                   Recompiled for CMXMATRX - Clear of PTHFBCAT
.                   16/06/2011 J.Tan      CAR 237245
.                   Recompiled for PRTIPROV - print Insurance prov.for JHS
.         V10.02.11 10/06/2011 Jill Parkinson CAR 241548
.                   Recompiled for CMXMATRX - Clear of HFNAME
.                   and added move of 1 to WEBFLAG in INIT0000
.         V10.02.10 27/05/2011  J.Tan         CAR 239592
.                   Mods for capturing extra compensable details
.                   03/06/2011  J.Tan         CAR 233202
.                   Mods to the warning message of Coding incomplete
.         V10.02.09 25/05/2011  J.Tan         CAR 243446
.                   Recompiled for STEPDOWN - bed fees with no effective date
.         V10.02.08 04/05/2011 J.Tan          CAR 238819/239526
.                   Recompiled for NZPCATBI - adjustment fees & inv.breakdown
.         V10.02.07 18/04/2011  J.Tan         CAR 237245
.                   Recompiled for PATCATBI - Mods for Johns Hopkins invoice
.         V10.02.06 19/04/2011 J.Tan          CAR 233698
.                   Recompiled for CMXMATRX - excluded tertiary MBS 
.         V10.02.05 19/04/2011  J.Tan          CAR 233154
.                   Mods for Continuous billing
.         V10.02.04 12/04/2011  J.Tan          CAR 233154
.                   Mods for Continuous billing
.         V10.02.03 11/04/2011  J.Tan          CAR 233195
.                   Recompiled for PATCATBI - removed isadd to tempfile
.         V10.02.02 31/03/2011  J.Tan          CAR 233195
.                   Mods for Mechanical Ventilation
.         V10.02.01 04/04/2011 Jill Parkinson CAR 239574
.                   Removed open of ibaprntf
.         V10.01.16 09.03.2011 Jill Parkinson CAR 233154
.                   Added move of ptmis081 to ptmiconb
.                   22/03/2011  J.Tan          CAR 233267
.                   Mods Display financial details
.         V10.01.15 28/02/2011 Peter Vela     CAR 233270
.                   Recompiled for PATINVS - Added Raise and Claim functionality
.                   08/03/2011 J.Tan          CAR 233154
.                   Recompiled for PATCMSTP - Checking for Continuous bill event
.         V10.01.14 17/02/2011 Davin          CAR 236283
.                   Treat LOS as 1 when calculating hosp.copayment for sameday
.                   patients (delg0000)
.         V10.01.13 08/02/2011 Jill Parkinson CAR 222655
.                   Fixed CHKNZ000 validation
.                   11/02/2011 J.Tan          CAR 233034/233043
.                   Recompiled for PATCATBI - Bed fees to use HF table type
.         V10.01.12 02/02/2011 J.Tan          CAR 235602
.                   Recompiled for NZPCATBI - checking procedures for funder
.         V10.01.11 27/01/2011 Jill Parkinson CAR 222655
.                   Added CHKNZ000 - NZ Private invoice validation
.         V10.01.10 01/02/2011  J.Tan             CAR 233202
.                   Mods to dislay fields on invoice header
.         V10.01.09 13/01/2011  Ebon Clements     CAR 236087
.                   Recompiled for PATCLMTM - Defence force
.         V10.01.08 22/12/2010 Peter Vela     CAR 230716
.                   Recompiled for PATCATBI - Added C record validation
.                   in CHKTR000
.         V10.01.07 06/12/2010  Ebon Clements     CAR 233927
.                   Added reason for hold update to invoice pending
.                   08/12/2010 J.Tan          CAR 229956
.                   Recompiled for NZPCATBI - printing item group for mult.page
.                   08/12/2010 J.Tan          CAR 231058
.                   Recompiled for NZPCATBI - fixed writing admission to nzpivb
.                   09/12/2010 J.Tan   CAR 233034
.                   Mods bed fees file to use health fund table type
.         V10.01.06 03/12/2010 Mike Laming    CAR 233046
.                   Mods to Misc.Charges PATMCHFD - incl. new routine PATMCHRD 
.         V10.01.05 30/11/2010 Peter Vela     CAR 233148
.                   Initialised PTTRUCID and PTTRUUID  before write to pattranf
.                   and update to pattranf
.         V10.01.04 29/10/2010 J.Tan          CAR 230716
.                   Recompiled for PATCATBI - initialise Matrix cutoff fields
.         V10.01.03 25/11/2010 Ebon Clements  CAR 233198
.                   Added reason for hold to invoice pending
.         V10.01.02 23/11/2010 Ebon Clements  CAR 233196
.                   Added showhead cgi and certificates tag
.         V10.01.01 04/11/2010 Jill Parkinson CAR 232595
.                   Added reads of pmspx2af after all master file reads
.         V10.01.01 28/10/2010 J.Tan          CAR 230716
.                   Recompiled for PATCATBI - display/print No Pay Day
.         V10.00.39 25/10/2010 J.Tan          CAR 232210
.                   Recompiled for PATCATBI - NOT to recalculate exploding items
.                   25/10/2010 Davin          CAR 231481
.                   Recompiled for PATINV25 - added ward provider number (hea)
.         V10.00.38 11/10/2010 J.Tan          CAR 229937
.                   Recompiled for PATCATBI - Cabrini invoice layout
.                   15/10/2010 J.Tan          CAR 231326
.                   Recompiled for NZPCATBI - displaying adjustment fees
.         V10.00.37 12/10/2010 J.Tan          CAR 231667
.                   Recompiled for PATCATBI - balance payable on invoice tail
.         V10.00.36 11/10/2010 J.Tan          CAR 229937
.                   Recompiled for PATCATBI - Cabrini invoice layout
.         V10.00.35 30/09/2010 J.Tan          CAR 230735
.                   Recompiled for NZPCATBI
.         V10.00.34 27/09/2010 J.Tan             CAR 230664
.                   Recompiled for PATCATBI - HEC invoice layout
.         V10.00.33 24/09/2010 Peter Vela        CAR 229414
.                   Added Delete from Theatre Also indicator
.         V10.00.32 20/09/2010 J.Tan             CAR 217548
.                   Mods to recalculate ICU/NCU/CCU after stepdown
.         V10.00.31 09/09/2010 J.Tan             CAR 229951
.                   Recompiled for PATINVS - problem with claim code with indc=P
.         V10.00.30 25/08/2010 J.Tan             CAR 228192
.                   Mods not to add Service Number to the item desc.(FDESC000)
.         V10.00.29 18/08/2010  J.Tan             CAR 222031
.                   Mods to set PMMIDUPD and PMMITUPD
.                   18/08/2010  J.Tan             CAR 228912
.                   Recompiled for PATCATBI - to display ICU/CCU/NNU in red
.         V10.00.28 18/08/2010  Davin             CAR 223805
.                   Recompiled for PATVISTM
.         V10.00.27 17/08/2010 J.Tan         CAR 227873
.                   Recompiled for CMXMATRX - getting the grouper version
.         V10.00.26 11/08/2010 J.Tan         CAR 227873
.                   Recompiled for CMXMATRX - searching for next rules of matrix
.         V10.00.25 09/08/2010 J.Tan         CAR 227904
.                   Fixed I*C on rcpbnkaf
.         V10.00.24 05/08/2010 J.Tan         CAR 227717
.                   Recompiled for PATCATBI - Balance payable on invoice tail
.         V10.00.23 04/08/2010 J.Tan         CAR 227685
.                   Fixed Resolving Unknown GST
.         V10.00.22 30/07/2010 J.Tan         CAR 227319
.                   Recompiled for PATCATBI - Mechanical ventilation
.         V10.00.21 19/07/2010 J.Tan         CAR 226158
.                   Recompiled for STEPDOWN - Bed fees update
.         V10.00.20 16/07/2010 J.Tan         CAR 226322
.                   Recompiled for CMXMATRX - search for next rule if Contract
.                   is not valid
.         V10.00.19 15/07/2010  J.Tan         CAR 226158
.                   Recompiled for STEPDOWN - Bed fee update
.         V10.00.18 12/07/2010  J.Tan         CAR 225932
.                   Recompiled for PATCATBI - set TDATE to IDATET for per-diem
.         V10.00.17 29/06/2010  J.Tan         CAR 224869
.                   Recompiled for PATCATBI - Printing Disc.Billing for
.                   Casepayment not discharged
.         V10.00.16 23/06/2010  J.Tan         CAR 224446
.                   Recompiled for PATCATBI - Fixed lumpsum amt in patdtraf
.                   for patient changed ward/bed on admission date
.         V10.00.15 11/06/2010  J.Tan         CAR 223824
.                   Recompiled for PATCATBI - Accom.desc.after bed fees update
.         V10.00.14 07/06/2010  Mike Laming   CAR 212864
.                   Recompiled for PATCATBI - mods at GCDE6500 
.         V10.00.13 27/05/2010  J.Tan         CAR 219471
.                   Recompiled for PATCATBI - Mechanical Ventilation record
.         V10.00.12 25/05/2010  J.Tan         CAR 218425
.                   Mods changing Casemix code to update Expecting LOS (astay)
.         V10.00.11 18/05/2010 J.Tan         CAR  183677
.                   Recompiled for NZPCATBI-Fixed Effective date for accom.des
.         V10.00.10 22/04/2010  J.Tan
.                   Recompiled for NZPCATBI CAR 218766 - SX print total paymnts
.                   Recompiled for NZPCATBI CAR 221434 - Invoice of items only
.         V10.00.09 30/04/2010  J.Tan         CAR 220887
.                   Mods checking for Active/Inactive of Misc.charge
.         V10.00.08 03/05/2010  Mike Laming   CAR 207386
.                   Added test for Theatre Unique Id. in GETMBS00            
.         V10.00.07 29/04/2010  Mike Laming   CAR 207386
.                   Mods to DELE0000 & DOPR0000 for MBS Items link to Theatre
.         V10.00.06 22/04/2010  J.Tan         CAR 220338
.                   Mods printing invoice to check pmsmtiaf file for Unknown GST
.         V10.00.05 20/04/2010  J.Tan         CAR 220073
.                   Recompiled for PATCATBI - Include Hospitalisation for LOWFLG
.                   21/04/2010  J.Tan         CAR 188985
.                   Recompiled for PATCATBI - Fixed bed fees accomm.description
.         V10.00.04 19/04/2010  J.Tan         CAR 219792
.                   Recompiled for NZPCATBI - checking primary funder invoice
.         V10.00.03 19/04/2010  J.Tan        CAR 219670
.                   Mods to set date/time updated to rcpdteaf file
.         V10.00.02 14/04/2010 Steve Armstrong   CAR 219933
.                   Recompiled for changes to EMRVCDFD
.         V10.00.01 30/03/2010  J.Tan         CAR 174079
.                   Added a new field to patfactaf for Act.Plan Inv.number
.                   19/03/2010  Steve Armstrong   CAR 135505
.                   Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
.         V9.12.60  11/03/2010  J.Tan         CAR 216044
.                   Mods to include Leave days in stepdown count for TAC
.         V9.12.59  16/02/2010  Peter Vela    CAR 215485
.                   Recompiled for PATCATBI - Ignore leave if less than a day
.         V9.12.58  05/02/2010  Peter Vela    CAR 215485
.                   Recompiled for PATCATBI - Ignore leave if less than a day
.         V9.12.57  03/02/2010  Jill Parkinson CAR 212162
.                   Added use of indicator 10 in CHCOD000
.         V9.12.56  02/02/2010  Peter Vela    CAR 215234
.                   Recompiled for CMXMATRX
.         V9.12.55  27/01/2010  J.Tan          CAR 214877
.                   Recompiled for CMXMATRX - Checking for range of MBS item No.
.         V9.12.54  19/01/2010  J.Tan          CAR 212934
.                   Recompiled for CMXMATRX - Fixed I*C on htmlfile 
.                   27/01/2010  J.Tan          CAR 214548
.                   Recompiled for STEPDOWN - Stepdown after bed fees update
.         V9.12.53  19/01/2010  J.Tan          CAR 166439
.                   Recompiled for PATCMSTP - fixed C/P addition.charge stepdown
.         V9.12.52  19/01/2010  Jill Parkinson CAR 212117
.                   Mods to NZCTRT00
.                   19/01/2010  Jill Parkinson CAR 214238
.                   Mods to output name using PATNAM00
.         V9.12.51  18/01/2010  Jill Parkinson CAR 214238
.                   Changed SRTFNAME to be surname, given name, title
.         V9.12.50  18/01/2010  Jill Parkinson CAR 212117
.                   Changed to use nzpcfnaf in NZCLRT00
.         V9.12.49  11/01/2010  Mike Laming    CAR 206410
.                   Fix typo at MCHG1800
.         V9.12.48  08/01/2009  J.Tan         CAR 202277
.                   Recompiled for PATCATBI - printing SJOG invoice with claim
.         V9.12.47  23/12/2009  Mike Laming    CAR 206410
.                   Mods for MBS Start/End Times in GETPAT00
.         V9.12.46  18/12/2009  Peter McMullen CAR 210130
.                   Convert to newer Dr name format routine DOCNM000
.         V9.12.45  10/12/2009  J.Tan         CAR 211762
.                   Recompiled for PATCATBI - printing SJOG accom.with GST
.         V9.12.44  04/12/2009  Peter Vela    CAR 202333
.                   Recompiled for PATINVHL - Changed variable 88 to 
.                   surname only 
.         V9.12.43  01/12/2009  J.Tan         CAR 174079
.                   Added Action Plan
.         V9.12.42  24/11/2009  J.Tan         CAR 207781
.                   Recompiled for PATCATBI- fixed casemix daycase rate of DTR
.         V9.12.41  19/11/2009  J.Tan         CAR 209615
.                   Fixed to init.Inv.no/date for print Disc.Billing Statement
.         V9.12.40  13/11/2009  Peter Vela    CAR 186000
.                   Changed reads of mltcf1af to mltcfnaf
.         V9.12.39  04/11/2009  J.Tan         CAR 174079
.                   Added Action Plan
.         V9.12.38  28/10/2009  J.Tan         CAR 206791
.                   Fixed printing Deposit payments for Discharge Billing Stat
.         V9.12.37  27/10/2009  J.Tan         CAR 204261
.                   Fixed Casepayment stepdown to use Casemix code from matrix
.                   instead of Provisional.
.         V9.12.36  19/10/2009  J.Tan         CAR 207359                      
.                   Fixed for PTTREPSD=2 
.         V9.12.35  12/10/2009  J.Tan         CAR 188108
.                   Recompiled for CHKCMXPT - I*C on patcmxaf file
.                   Recompiled for PATCATBI - display/print zero lumpsum amount
.         V9.12.34  07/10/2009  J.Tan         CAR 203934
.                   Recompiled for PATCATBI - display ICD10 Suggested Class.
.         V9.12.33  05/10/2009  J.Tan         CAR 191624
.                   Recompiled for PATINVS -set Dep.Applied date to Current date
.         V9.12.32  01/10/2009 J.Tan          CAR  204960
.                   Recompiled for NZPCATBI - Fixed Contract adm. bill to Pat.
.                   02/10/2009  J.Tan         CAR 207105
.                   Recompiled for PATCATBI - Mechanical Vent.
.         V9.12.31  01/10/2009  Mike Laming   CAR 196169
.                   Modify Inv.Pending sort List to sort on Surname in IPND5000
.         V9.12.30  29/09/2009  J.Tan         CAR 202803
.                   Recompiled for NZPCATBI - Fixed FI Co-payment
.         V9.12.29  08/09/2009  J.Tan         CAR 200712
.                   Fixed Disc.Billing statement balance total
.         V9.12.28  07/09/2009  J.Tan         CAR 205303
.                   Added Contract ID to Casemix files
.         V9.12.27  31/08/2009  Peter Vela    CAR 186000
.                   Added new tag for Invoice Pending nzprivate
.         V9.12.26  27/08/2009  J.Tan         CAR 202277
.                   Recompiled for PATINVT9 - printing claim for SJOG
.         V9.12.25  19/08/2009  J.Tan         CAR 187486
.                   Recompiled for PATCATBI - printing Payer for SX invoice
.         V9.12.24  13/08/2009  J.Tan         CAR 200712
.                   Fixed Printing Discharged billing statement to read patelgaf
.         V9.12.23  06/08/2009  J.Tan         CAR 202869
.                   Recompiled for STEPDOWN - for PTTREPSD=2 (Bed Fee Update)
.         V9.12.22  30/07/2009  J.Tan         CAR 200712
.                   Fixed Cabrini Discharged billing statement
.                   Disabled Raise Invoice button for C/P with Prov.but No Matrx
.         V9.12.21  28/07/2009  J.Tan         CAR 183323
.                   Recompiled for NZPCATBI -to generate Primary procedure first
.         V9.12.20  24/07/2009  J.Tan         CAR 201132 & 202168
.                   Recompiled for CMXMATRX - checking for zero MBS amount 
.         V9.12.19  17/07/2009  J.Tan             CAR 199603
.                   Recompiled for PATCATBI - Mods to print Theatre banding
.         V9.12.18  21/07/2009  Peter Vela    CAR 186000
.                   Added new tag for nzprivate Category CL Contract Type
.                   with new filters
.                   Added new tag for nzprivate Contract Selection List
.                   with new filters
.         V9.12.17  20/07/2009  Mike Laming   CAR 187485
.                   Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
.         V9.12.16  16/07/2009  J.Tan             CAR 200712
.                   Fixed printing Cabrini Disc.Billing statement
.         V9.12.15  14/07/2009  J.Tan             CAR 199759
.                   Recompiled for PATINVT9 - printing non-banked deposits
.         V9.12.14  09/07/2009  J.Tan             CAR 200387
.                   Recompiled for PATCATBI - printing Casepayment with NoPayday
.         V9.12.13  07/07/2009  J.Tan             CAR 200387
.                   Recompiled for PATCATBI - setup NPDAYFLG
.         V9.12.12  03/07/2009  Peter Vela    CAR 199927
.                   Recompiled for EMROPOCK - Check if PMMIAMTT = 0 GPRC4000
.         V9.12.11  26/06/2009  Ebon Clements CAR 198387
.                   Changed DELG0000 to only use one co payment upto field
.         V9.12.10  12/06/2009  J.Tan         CAR 198713
.                   Recompiled for NZPCATBI - cash payments
.         V9.12.09  17/06/2009  Jill Habasque CAR 196898
.                   Mods to check for cat CL indicator 5=1 or 2 instead of
.                   ignoring 3's for hold invoice until coding complete
.         V9.12.08  16/06/2009  J.Tan         CAR 194815
.                   Recompiled for PATINVHL - JH Billing Date
.         V9.12.07  10/06/2009  J.Tan         CAR 197956 198611
.                   Recompiled for PATINVS
.         V9.12.06  05/06/2009  J.Tan         CAR 196010 
.                   Recompiled for CMXMATRX - ICD10 Secondary/Tertiary 
.         V9.12.05  27/05/2009  J.Tan         CAR 197652
.                   Fixed checking for Theatre Completed (for adm.or disch.only)
.         V9.12.04  22/05/2009  J.Tan         CAR 188108
.                   Added Reason for Lumpsum removal
.                   Added Invoice Comments
.         V9.12.03  15/05/2009  WeeLee Koo    CAR 196722
.                   Recompiled for PATINVS
.         V9.12.02  12/05/2009  J.Tan         CAR 194815
.                   Recompiled for PATINVHL - JH Billing Date
.         V9.12.01  11/05/2009  J.Tan         CAR 125842
.                   Recompiled for PATCATBI - recalculate zero amt of misc.items
.         V9.11.30  15/04/2009  Steve Armstrong  CAR 194544
.                   Recompiled for PATINVS
.         V9.11.29  02/04/2009  J.Tan         CAR 188076
.                   Added Reason Theatre Incomplete
.         V9.11.28  01/04/2009  J.Tan         CAR 192704
.                   Recompiled for PATCATBI - Fixed field PTDTCCU
.         V9.11.27  01/04/2009  J.Tan         CAR 192772
.                   Recompiled for PATCATAI - Mods to Johns Hopkins invoice
.         V9.11.26  23/03/2009  Davin         CAR 178015
.                   Recompiled for PATINVHL - Changed BPAY CRN to use inv. no.
.         V9.11.25  18/03/2008  J.Tan         CAR 188110
.                   Mods for ICD10 Suggested Classification
.         V9.11.24  16/03/2008  J.Tan         CAR 188102
.                   Recompiled for PATCATBI - Patient Only Invoice
.         V9.11.23  25/02/2009  J.Tan   CAR 190860
.                   Recompiled for PATCATBI - initalise GST amount
.         V9.11.22  24/02/2009  J.Tan   CAR 190567
.                   Mods for Cabrini Discharge Billing Statement
.                   25/02/2009  J.Tan   CAR 188205
.                   Mods printing Non-banked
.                   25/02/2009  J.Tan   CAR 181844 and 188731
.                   Fixed printing Cabrini invoices
.         V9.11.21  12/02/2009  J.Tan         CAR 183138
.                   Recompiled for NZPCATBI - printing Funder Contr.for Pat Inv.
.         V9.11.20  28/01/2009  J.Tan  CAR 188348
.                   Recompiled for CMXMATRX - Admission Casepayment
.         V9.11.19  21/01/2009  J.Tan  CAR 181844
.                   Recompiled for PATCATBI - printing Cabrini's cash payment
.         V9.11.18  20/01/2009  J.Tan   CAR 187842
.                   Recompiled for printing NZ Private invoice
.                   20/01/2009  J.Tan   CAR 187856
.                   Mods to initialise co-payment fields for fees estimates
.         V9.11.17  14/01/2009  J.Tan   CAR 187463
.                   Recompiled for PATINVHL - SX Vendor ID & Ref
.         V9.11.16  07/01/2009  J.Tan   CAR 186328
.                   Recompiled for PATCATBI - Casepayment invoice
.         V9.11.15  22/12/2008  Steve Armstrong   CAR 183976
.                   Recompiled for changes to PATINVS.
.         V9.11.14  12/12/2008  Steve Armstrong   CAR 181373
.                   Recompiled for changes to PROSTRAK
.         V9.11.13  03/12/2008  J.Tan   CAR 181844
.                   Fixed printing deposit for Cabrini invoice
.         V9.11.12  01/12/2008  J.Tan         CAR 125842
.                   Recompiled for PATCATBI - RCH recalc.zero amt Misc.Charges
.         V9.11.11  28/11/2008  J.Tan         CAR 184638
.                   Recompiled for NZPCATBI - fixed funder invoice stepdown
.                   after invoice raised (GPFE7000)
.         V9.11.10  20/11/2008  Steve Armstrong   CAR 181373
.                   Recompiled for changes to PATCATBI - prosthetic tracking
.                   Recompiled for changes to PMSPTDFD, PROSTRAK & CLPMSPTD.
.                   25/11/2008  J.Tan         CAR 184292
.                   Recompiled for PATINVS - doctor name on invoice header
.         V9.11.09  25/11/2008  J.Tan         CAR 183242
.                   Recompiled for PATINVS - doctor name on invoice header
.         V9.11.08  12/08/2008  J.Tan         CAR 183242
.                   Recompiled for NZPCATBI - Fixed FFS
.         V9.11.07  07/11/2008  Steve Armstrong  CAR 183001
.                   Recompiled for changes to DGCLIITM.
.         V9.11.06  06/11/2008  Peter McMullen CAR 174725
.                   convert internal javascript to W3C standards
.         V9.11.05  30/10/2008 J.Tan      CAR 181263
.                   Mods for printing Discharge Billing Statement
.         V9.11.04  24/10/2008  Ebon Clements CAR 154581
.                   Recompiled for PMSOSDTM - Added trap
.         V9.11.03  17/10/2008  J.Tan         CAR 181090
.                   Recompiled for STEPDOWN - Include days of Hosp. for Inpat
.         V9.11.02  14/10/2008  Peter Vela    CAR 159227
.                   Recompiled for PATINVHL - Added Emergency Invoice
.                   Arrival Date and Time.
.         V9.11.01  08/10/2008  J.Tan         CAR 180188
.                   Recompiled for PATCATBI - setup CASMXKEY
.---------------------------------------------------------------------- 
.         V9.10.20  25/09/2008  J.Tan         CAR 178209
.                   Recompiled for PATCATBI - Fixed checking for Doct.chg rec.
.                   25/09/2008  J.Tan         CAR 179009
.                   Recompiled for STEPDOWN - Check 'Exclude Days of Hosp."
.         V9.10.19  05/09/2008  J.Tan         CAR 177126
.                   Recompiled for PATCATBI - Checking matrix parameter
.         V9.10.18  01/09/2008  Peter Vela    CAR 175546
.                   Fixed validation for PTCNHITC in IPND0000
.         V9.10.17  20/08/2008  Ebon Clements CAR 175667
.                   Added table sort option to IPND0000
.         V9.10.16  18/08/2008  Peter Vela    CAR 175546
.                   Added function call to SetInvPndCookies() in IPND0000
.         V9.10.15  12/08/2008  J.Tan         CAR 175967
.                   Recompiled for PATCATBI - not printing Anaes.codes/time 
.                   for Cabrini
.         V9.10.14  06/08/2008  J.Tan         CAR 175613
.                   Mods to read Discharge file prior CALCTBI
.         V9.10.13  06/08/2008  J.Tan         CAR 175079
.                   Recompiled for NZPCATBI - 'Extra to Contract' items
.         V9.10.12  31/07/2008  J.Tan         CAR 163654
.                   Recompiled for NZPCATBI - Generating bed fees with discounts
.         V9.10.11  23/07/2008  J.Tan         CAR 174476
.                   Recompiled for PATCATBI - Cabrini Theatre amount
.         V9.10.10  14/07/2008  J.Tan         CAR 163654
.                   Recompiled for NZPCATBI - Generating bed fees
.         V9.10.09  11/07/2008  J.Tan         CAR 168769
.                   Recompiled for NZPCATBI - Fixed calculating Win/Loss amount
.         V9.10.08  08/07/2008 Sandra Barcham CAR 173135
.                   Recompiled for PATCATBI - Remove close of PATDGWA1
.         V9.10.07  27/06/2008  Ebon Clements CAR 171757
.                   Recompiled for PATMISTM - Admission comments tag
.         V9.10.06  16/06/2008  Jill Habasque CAR 169710
.                   Added write to patchxaf
.         V9.10.05  21/05/2008  J.Tan         CAR 167702
.                   Recompiled for PATCATBI - Cabrini invoice layout
.         V9.10.04  13/05/2008  Ebon Clements CAR 166566
.                   Recompiled for PATINVHL
.                   09/05/2008  J.Tan         CAR 167702
.                   Recompiled for PATCATBI - SJOG invoice layout
.         V9.10.03  13/05/2008 J.Tan          CAR 162313
.                   Added Deposit status to comdepaf
.         V9.10.02  06/06/2008  J.Tan         CAR 166229
.                   Mods Delete item opt to delete Inv.Pending if neccessary
.         V9.10.01  02/05/2008 J.Tan          CAR 167579
.                   Recompiled for AAECATBI- Removed checking for facility fees
.---------------------------------------------------------------------- 
.         V9.09.50  21/04/2008  J.Tan         CAR 166600
.                   Recompiled for PATCATBI - mods to Invoice pending file
.         V9.09.49  10/04/2008  J.Tan         CAR 166096 163760
.                   Recomp.for PATCMSTP - Transfer bedtype with same bedtype
.                   Recomp.for NZPCATBI - Initialise PTDTBTCH
.         V9.09.48  08/04/2008  J.Tan         CAR 164844
.                   Recomp.for NZPCATBI - Fixed printing inv.with Inv.Breakdown
.         V9.09.47  04/04/2008  J.Tan         CAR 164844
.                   Recompiled for NZPCATBI - Rev.breakdown for Pat Invoice
.                   with Fixed fees amount
.         V9.09.46  26/03/2008  J.Tan         CAR 164169
.                   Recompiled for PATCATBI - Checking for Keyin Reb.(Pub.Hosp)
.         V9.09.45  04/03/2008 J.Tan          CAR 157583
.                   Recompiled for AAECATBI - Invoice total with 'Out of Pocket'
.         V9.09.44  29/02/2008  J.Tan         CAR 162893 & 162609
.                   Recompiled for PATCATBI - Inv.breakdown and Lumpsum amt 
.         V9.09.43  27/02/2008  Ebon Clements CAR 162564
.                   Recompiled for NZPCATBI - Provider invoice processing
.         V9.09.42  27/02/2008  Steve Armstrong  CAR 160815
.                   Recompiled for changes to PMSQITFD.
.         V9.09.41  21/02/2008  Peter Vela    CAR 161535
.                   Added tag for CERTINDC
.         V9.09.40  20/02/2008  Peter Vela    CAR 161535
.                   Recompiled for PATCATBI 
.         V9.09.39  19/02/2008  J.Tan         CAR 162069
.                   Recompiled for CMXMATRX - Matrix not found for Daycase 
.         V9.09.38  01/02/2008  Peter Vela    CAR 155334
.                   Initialised new pmsmtiaf variable
.                   Added Prosthetic Tracking functionality for edit misc items
.                   08/02/2008  J.Tan         CAR 160638
.                   Recompiled for NZPCATBI - Deposit for Pat.invoice only
.         V9.09.37  31/01/2008  Jill Habasque CAR 159893
.                   Mods to check if patient has been to theatre in CHCMB000
.         V9.09.36  23/01/2008  J.Tan         CAR 159848
.                   Recompiled for NZPCATBI - updating nzpspraf
.         V9.09.35  03/01/2008  J.Tan         CAR 136785
.                   Recompiled for STEPDOWN
.         V9.09.34  27/12/2007  Peter Vela    CAR 155907
.                   Recompiled for PATINVTL
.         V9.09.33  14/12/2007  Steve Armstrong   CAR 155887
.                   Added HL7 trigger (DGCLIITM)
.         V9.09.32  28/11/2007  J.Tan         CAR 155292
.                   Recompiled for NZPCATBI - Print Theatre charge for Primary
.                   28/11/2007  J.Tan         CAR 155969
.                   Recompiled for PATCATBI - Credit note for Lumpsum
.         V9.09.31  19/11/2007  Steve Armstrong   CAR 155206
.                   Recompiled for changes to PATCATBI
.         V9.09.30  16/11/2007 Peter Vela     CAR 110766
.                   Recompiled for PATINVHL
.         V9.09.29  12/11/2007 J.Tan          CAR 151803
.                   Recompiled for AAECATBI - Cabrini ED Billing
.         V9.09.28  09/11/2007 Jill Habasque  CAR 154329
.                   Recompiled for NZPCATBI
.                   26/10/2007 J.Tan          CAR 153442
.                   Recompiled for NZPCATBI - fixed invoiced flag for No Funders
.         V9.09.27  23/10/2007 J.Tan          CAR 152586                      
.                   Recompiled for NZPCATBI - No Win/Loss if no contract proc.
.         V9.09.26  08/10/2007  J.Tan         CAR 151472
.                   Recompiled for NZPCATBI - Fixed Keyin Itm (FFS for Win/loss)
.         V9.09.25  03/10/2007  J.Tan         CAR 151472
.                   Recompiled for NZPCATBI - Fixed FFS amt for Win/loss
.         V9.09.24  28/09/2007  J.Tan         CAR 151225
.                   Recompiled for NZPCATBI - printing SX invoice
.         V9.09.23  24/09/2007  Jill Habasque CAR 150322
.                   Added CHCOD000 - Check if coding complete is required
.                   Added CHCMB000 - Check if theatre complete is required
.                   25/09/2007  Jill Habasque CAR 150448
.                   Recompiled for PATINVHL
.         V9.09.22  21/09/2007  J.Tan         CAR 149966
.                   Recompiled for NZPCATBI - mods to printing Summary invoice
.         V9.09.21  21/09/2007  J.Tan         CAR 140282
.                   Recompiled for NZPCATBI - NZ Private FFS Win/Loss
.         V9.09.20  18/09/2007  J.Tan         CAR 147803
.                   Mods to allow change casemix code if Accom.not charged yet
.         V9.09.19  14/09/2007  J.Tan         CAR 144656
.                   Recompiled for PATCATBI - for Multiple procedure billing
.         V9.09.18  11/09/2007  J.Tan         CAR 146723
.                   Fixed displaying Transfer details for NZ Priv.Stepdown
.         V9.09.17  11/09/2007  J.Tan         CAR 147032
.                   Recompiled for NZPCATBI - Funder contribution % stepdown
.         V9.09.16  24/08/2007  Peter Vela    CAR 146143
.                   Recompiled for PATCATBI
.                   04/09/2007  J.Tan         CAR 148353
.                   Recompiled for PATCMSTP
.         V9.09.15  20/08/2007 J.Tan          CAR 144656
.                   Recompiled for PATCATBI - for Multiple Procedures Billing
.         V9.09.14  10/08/2007 Peter Vela     CAR 146143
.                   Recompiled for PATCATAI
.         V9.09.13  02/08/2007  J.Tan         CAR 146663
.                   Mods Invoice pending to include Emergency events
.         V9.09.12  25/07/2007  Peter Vela    CAR 144787
.                   Recompiled for PATCATAI
.                   25/07/2007 J.Tan          CAR 140282
.                   Recompiled for NZPCATBI - SX G/L Extract
.         V9.09.11  16/07/2007  J.Tan         CAR 145276
.                   Mods forcing stepdown to check for the Last Time changed
.                   20/07/2007  Mike Laming   CAR 141218
.                   Change STPD0000 to correct Bed Type in Tran record
.         V9.09.10  11/07/2007  Jill Habasque CAR 144946
.                   Recompiled for NZPCATBI - nz miscellaneous item groups
.         V9.09.09  11/07/2007  J.Tan         CAR 143630
.                   Recompiled for PATCATBI - Setup invoice date
.         V9.09.08  06/07/2007  Mike Laming   CAR 142179
.                   Add NZPRBRFD/NZPRBRIO - re-compiled for PATCLMTM & PMSHCPTM
.         ........  02/07/2007 Pete  Vela     CAR 142173
.                   Recompiled for PATCATAI
.         V9.09.07  29/06/2007 Peter Vela     CAR 142173
.                   Recompiled for PATCATAI 
.                   29/06/2007  J.Tan
.                   Mods checking for force stepdown date for tmove<>A or D
.         V9.09.06  29/06/2007  Jill Habasque CAR 143182
.                   Recompiled for PATCATBI - Fixed AGST0000 if PINVDTE is blank
.         V9.09.05  28/06/2007  Jill Habasque CAR 143182
.                   Recompiled for NZPCATBI - Added check for NZMCKPRI 
.                   in GSXM3200
.         V9.09.04  22/06/2007  J.Tan     CAR 143507
.                   Recompiled for PATCMSTP - Chg of adm type
.                   22/06/2007  J.Tan     CAR 143630
.                   Recompiled for PATCATBI - Use invoice date as GST eff.date
.         V9.09.03  26/06/2007 Ebon Clements  CAR 143622
.                   Added multi hospital test to IPND0000
.                   25/06/2007 Peter Vela     CAR 142173
.                   Recompiled for PATCATAI  
.         V9.09.02  22/06/2007  Peter Vela CAR 142173
.                   Added delete from emrvcdaf at DELE0000
.         V9.09.01  21/06/2007  J.Tan     CAR 138887
.                   Recompiled for STEPDOWN - Global Update bed fee 
.---------------------------------------------------------------------- 
.         V9.08.45  20/06/2007  Mike Laming   CAR 131641
.                   Recompiled for PATCATBI - Change to PTCNINVL=15 for STV
.         V9.08.44  13/06/2007  Mike Laming   CAR 119158
.                   Changes to fix RDMCHG1 for Misc.Charges Effective Date
.                   11/06/2007  J.Tan         CAR 142173
.                   Mods for Emergency event
.         V9.08.43  31/05/07 J.Tan     CAR 141297
.                   Recompiled for PATCATBI - GST Revenue breakdown 
.         V9.08.42  31/05/07 Steve Armstrong  CAR 141969
.                   Added OPEN's for compensable claim files where missing.
.                   23/05/07 J.Tan    CAR 141409
.                   Recompiled for PATCATBI - Pendlebury (PTCNINVL=16) lumpsum
.         V9.08.41  07/05/2007 Peter Vela CAR SJOG ED Billing
.                   Initialised new pmsmtiaf variables
.         V9.08.40  16/05/2007  J.Tan     CAR 140865
.                   Recomp.for PATINV25 - printing for multi pages of invoice
.         V9.08.39  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.                   Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
.         V9.08.38  08/05/2007  J.Tan     CAR 140240
.                   Recomp.for PTDRCHRG - doctor charge on first date of period
.         V9.08.37  01/05/2007  Peter Vela CAR 139496
.                   Changed error messages in VALC0000 for compensable patients
.         V9.08.36  01/05/2007  J.Tan     CAR 139655
.                   Fixed stepdown to set new bed type
.         V9.08.35  24/04/2007  J.Tan     CAR 138966
.                   Mods Stepdown from Adm.screen to set pttrepsd if col bedfee
.                   changed.
.         V9.08.34  16/04/2007  J.Tan     CAR 138026
.                   Recompiled for PATCATBI - Check if disc.day charged for JH
.         V9.08.33  28/03/2007  J.Tan     CAR 137169
.                   Recompiled for PTDRCHRG - change doctor on same day
.         V9.08.32  26/03/2007  J.Tan     CAR 136953
.                   Recompiled for PATCATBI for JH invoice first day of period
.         V9.08.31  20/03/2007  J.Tan     CAR 120014
.                   Recompiled for NZPCATBI for checking eff.date of NZ Bed fees
.         V9.08.30  14/03/2007  J.Tan            CAR 135853
.                   Recompiled for PATCATBI for inv.raised on 1st day of period
.         V9.08.29  08/03/2007  J.Tan            CAR 130462
.                   Recompiled for PATCATBI - JH GST
.         V9.08.28  06/03/2007 Peter Vela CAR 135241
.                   Added DIM16 recompiled for PATCATBI - St. John of God
.                   invoice layout
.         V9.08.27  01/03/07 J.Tan    CAR 120009
.                   Recompiled for NZPCATBI - search for contract funding
.*        V9.08.26  12/02/2007  Peter Vela    CAR sjog-vic
.*                  Added OPRARDFD. Recompiled for PATCATBI sjog-vic invoice
.*                  layout
.         V9.08.25  22/02/2007 Mike Laming   CAR 119436               
.                   Add PMSOSDTM (PROC FLAGDEBT) for Outstanding Debt Alert ind.
.         V9.08.24  08/02/07 J.Tan    CAR 120001
.                   Mods for NZ Billing
.*        V9.08.23  08/02/2007  Mike Laming   CAR 130473
.*                  Added WORKDATE (DATE) - re-compiled for PTDRCHRG 
.*        ........  07/02/2007  Mike Laming   CAR 130096
.*                  Recompile for PATCATBI - Correct NOFEE check at DLNE5900
.*        V9.08.22  31/01/2007  Peter Vela    CAR 127930
.*                  Recompiled for EMRSITFD
.*        V9.08.21  23/01/2007  Mike Laming   CAR 128643
.*                  Recompile for OUTDTRFD - Change OTSERVS to FORM 5
.*        V9.08.20  20/12/2006 J.Tan          CAR 128578
.*                  Fixed JH Discount
.*        V9.08.19  18/12/2006 J.Tan          CAR 128578
.*                  Recompiled for OUTCATBI - GST amount for O/P Next invoice
.*        V9.08.18  13/12/2006  J.Tan  CAR 127625
.*                  Mods to JH HRN 
.*        V9.08.17  12/12/2006  J.Tan             CAR 127726
.*                  Added function to remove doctor charges
.*        V9.08.16  12/12/2006  J.Tan             CAR 127726
.*                  Added function to remove doctor charges
.*        V9.08.15  11/12/2006  J.Tan             CAR 127646
.*                  Recompiled for modifications to JH invoices
.*        V9.08.14  05/12/2006  J.Tan             CAR 127092
.*                  Mods SELF PRFA for JH Invoice
.*        V9.08.13  01/12/2006  J.Tan             CAR 126728
.*                  Recompiled for PATCATBI - Invoice date for JH Backdated inv
.*                  Fixed adding adm.expected payor
.*        V9.08.12  27/11/2006  Steve Armstrong   CAR 126039
.*                  Recompiled for changes to SGCHKDIG
.*        V9.08.11  27/11/2006  J.Tan             CAR 125987
.*                  Fixed default discount date
.*        V9.08.10  06/11/2006  Mike Laming   CAR 103368
.*                  Add MediSave Account holder routines for JHS
.*                  Add PATEDTFD/IO and re-compile cor CCPS changes to PATINVS
.*        V9.08.09  17/11/2006  Peter Vela        CAR 124538
.*                  Recompiled for PATCATBI
.*        V9.08.08  16/11/2006  Steve Armstrong   CAR 124160
.*                  Recompiled for PATINVHL (Singapore HRN)
.*                  Recompiled for PATINVTL (Singapore HRN)
.*        V9.08.07  14/11/2006  Peter Vela    CAR 124547
.*                  Added reads for PTCNDEES PTCNDDES
.*        V9.08.06  10/11/2006  J.Tan         CAR 121178
.*                  Recompiled for PATCATBI - Fixed partial days description
.*                  CAR 124083 - Recomp for PTDRCHRG- Doc.charge for Inv.Est.
.*        V9.08.05  26/10/2006  J.Tan         CAR 122541
.*                  Recompiled for PATCATBI - Use Alternate Item group for JH
.*        V9.08.04  12/10/2006  J.Tan         CAR 121326
.*                  Mods to allow backdate for JH invoice
.*                  16/10/2006  J.Tan         CAR 121629/121630
.*                  Fixed Discount from receipts/printing in bold for Items JH
.*                  18/10/2006  J.Tan         CAR 120502
.*                  Recompiled for PATCATBI - Ignore Doctor Change record
.*        V9.08.03  11/10/2006  J.Tan         CAR 121178
.*                  Recompiled for PATCATBI - Acc.desc for halfday charge on Dsc
.*        V9.08.02  05/10/2006  J.Tan         CAR 120654
.*                  Recompiled for PATCATBI - Split invoices
.*        V9.08.01  29/09/2006  Peter Vela    CAR 120319
.*                  Recompiled for PATINVHL
.---------------------------------------------------------------------- 
.*        V9.07.11  25/09/2006  Peter Vela    CAR 118940
.*                  Recompiled for PATCATBI
.*        V9.07.10  20/09/2006 J.Tan         CAR 119336 
.*                  Added claim code to Suggested classification file
.*        V9.07.09  15/09/2006  J.Tan         CAR 118964
.*                  Recompiled for PATCATBI - fixed </td> for accommodation
.*        V9.07.08  11/09/2006  Peter Vela    CAR 118226
.*                  Recompiled for PATCLMTM
.*        V9.07.07  07/09/20006 Jill Habasque CAR 109852
.*                  Added check for PTCNDAUR- Display Alternate ID instead of UR
.*        V9.07.06  18/08/2006  J.Tan         CAR 115853
.*                  Recompiled for PATINVS - Print claim for Pendlebury
.*        V9.07.05  02/08/2006  Peter Vela    CAR 113658
.*                  Recompiled for PATINV21 - Fixed Date and Cash Payment
.*                  display
.*        V9.07.04  31/07/2006 J.Tan      CAR 103365
.*                  Mods for Johns hopkins invoice
.*        V9.07.03  25/07/2006  Peter Vela    CAR 113658
.*                  Recompiled for PATCATAI - Fixed "Journal Total" display
.*        V9.07.02  19/07/2006  J.Tan         CAR 113222
.*                  Recompiled for STEPDOWN - Initialise TDEPT
.*        V9.07.01  11/07/2006  Ebon Clements CAR 103365
.*                  Added report 10 admission based expected payors
.*        V9.06.04  16/05/2006  Peter Vela    CAR 104103
.*                  Recompiled for PATCATBI - PTCNINVL=12
.*        V9.06.03  31/05/2006  J.Tan         CAR 105669
.*                  Recompiled for PATCATBI - STV Invoice
.*        V9.06.02  18/05/2006  J.Tan         CAR 105345
.*                  Fixed checking for GST unknown file when deleting item
.*        V9.06.01  24/04/2006  J.Tan         CAR 102287
.*                  Recompiled for PATINVHL - Added fields for multi hosp det
.*        V9.05.05  24/04/2006  J.Tan         CAR 102287
.*                  Recompiled for PATINVHL - Added fields for multi hosp det
.*        V9.05.04  31/03/2006  J.Tan         CAR 98229
.*                  Mods packing key with spaces prior writing rec.to pattranf
.*        V9.05.03  17/03/2006  Peter Vela    CAR 95780
.*                  Recompiled for PATINVHL - Added emg mobile contact numbers
.*        V9.05.02  27/03/2006  Peter Vela    CAR 61299
.*                  Increased field no size from DIM3 to DIM5   
.*        V9.05.01  09/03/2006  Ebon Clements CAR 78533
.*                  Mods for PATCODTM - Hospital specific category codes
.*        V9.05.B07 30/01/2006  Ebon Clements CAR 93186
.*                  Mods for REDIRECT length change. Recompiled for IBAWEBDF
.*        V9.05.B06 23/01/2006  J.Tan             CAR 84567
.*                  Mods generating bed fees for stepdown
.*        V9.05.B05 06/01/2006  J.Tan             CAR 84567
.*                  Recompiled for PATCATBI - accom.desc.for manual stepdown 
.*        V9.05.B04 20/12/2005  J.Tan         CAR 89226
.*                  Recompiled for PATCATBI - recalculate theatre fees
.*        V9.05.B03 12/12/2005  J.Tan         CAR 59381
.*                  Recompiled for PATCATBI - Split invoice
.*        V9.05.B02 01/12/2005  Peter Vela    CAR 84255
.*                  Added Replace "+ " for urnumber and admissno in PRTINV00
.*        V9.04.64  05/12/2005  Ebon Clements CAR 85827
.*                  Added coding complete date to IPND0000
.*        V9.04.63  24/11/2005  J.Tan         CAR 85773
.*                  Fixed I*D on pattranf
.*        V9.04.62  21/11/2005  Peter Vela    CAR 68675
.*                  Recompiled for PATDSCTM
.*        V9.04.61  17/11/2005  Peter Vela    CAR 84547
.*                  Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1
.*        V9.04.60  09/11/2005  J.Tan             CAR 76442 
.*                  Recompiled for PATCATBI - recalculate misc.charge on nxt inv
.*        V9.04.59  07/11/2005  J.Tan             CAR 62083 
.*                  Recompiled for PATCATBI -fixed acc.description for Daycase
.*        V9.04.58  02/11/2005  Peter Vela        CAR 81394
.*                  Recompiled for PATCATBI
.*        V9.04.57  31/10/05 J.Tan   CAR 81484
.*                  Recompiled for PATCATBI - fix deleting items
.*        V9.04.56  25/10/05 Sandra Barcham CAR 81362
.*                  Recompiled for PATCATBI - fix fincode for accommodation
.*        V9.04.55  25/10/05 Ebon Clements CAR 81174 81176
.*                  Recompiled for PATCATBI - Using pabx billing
.*        V9.04.54  20/10/05 J.Tan    CAR 80871
.*                  Added new template to add items/comments only for an invoice
.*        V9.04.53  27/09/05 J.Tan    CAR 77671 
.*                  Recompiled for PATCATAI - GROSSTOT overlapping            
.*        V9.04.52  16/09/05 J.Tan    CAR 52714 
.*                  Recompiled for PATCATBI - C/P desc after return from leave
.*        V9.04.51  05/09/2005  J.Tan         CAR 74860
.*                  Recompiled for CMXMATRX - Matrix button
.*        V9.04.50  31/08/2005  J.Tan         CAR 74153
.*                  Recompiled for CMXMATRX - checking for exclusive
.*        V9.04.49  04/08/2005  J.Tan        CAR 62750 
.*                  Mods not to use the redefined amount variables
.*        V9.04.48  03/08/2005  Peter Vela    CAR 68675
.*                  Recompiled for PATDSCTM
.*        V9.04.47  14/07/2005  Peter Vela    CAR 62172
.*                  Recompiled for PATINVTL
.*        V9.03.46  13/07/2005  J.Tan         CAR 61400
.*                  Mods CZER0000 to if an invoice have already printed  
.*        V9.03.45  11/07/2005  J.Tan         CAR 61508
.*                  Fixed total amount of item for pmsmtiaf file
.*        V9.04.44  21/06/2005  J.Tan         CAR 61641
.*                  Recompiled for PATINV23 - Nettot RHS Ballarat invoice
.*        V9.04.43  16/06/2005  Mike Laming   CAR 61746 
.*                  Recompiled for CLPATDTR - add clear PTDTTIME & PTDTCRST 
.*        V9.04.42  14/06/2005  Jill Habasque  CAR 61761 
.*                  Recompiled for IBAWEBCD
.*        V9.04.41  06/06/2005  J.Tan          CAR 61641 
.*                  Fixed print Ballarat invoice with claim 
.*        V9.04.40  31/05/2005  J.Tan          CAR 61641
.*                  Fixed print invoice with deposit
.*        V9.04.39  27/05/2005  J.Tan          CAR 61641
.*                  Added page number to invoice tail
.*        V9.04.38  26/05/2005  J.Tan          CAR 61641
.*                  Mods for Ballarat invoice
.*        V9.04.37  19/05/2005  J.Tan          CAR 61845
.*                  Fixed checking stepdown date
.*        V9.04.36  12/05/2005  J.Tan          CAR 61488
.*                  Mods for Ballarat invoice (layout 19)
.*        V9.04.35  10/05/2005  J.Tan          CAR 61488
.*                  Mods for Ballarat invoice (layout 19)
.*        V9.04.34  15/04/2005  Jill Habassque CAR 60087
.*                  Recompiled for CMXMATRX - added new index for pmscmtaf
.*        V9.04.33  05/04/2005  Jill Habassque CAR 60087
.*                  Added move of ONE to EXIT after WEBERR00 calls
.*        V9.04.32  04/04/2005  Mike Laming   CAR 59989
.*                  Re-compile for PATCATBI - Fix Rebate over-print
.*        V9.04.31  30/03/2005  Jill Habasque CAR 59768
.*                 Removed the checking for template 007 before reading patma1af
.*        V9.04.30  08/03/2005  J.Tan         CAR 55961
.*                  Mods to print zero total invoice with transaction
.*        V9.04.29  07/03/2005  Peter Vela    CAR 57547
.*                  Recompiled for PATVADFD and PATVADIO
.*                  04/03/2005  J.Tan         CAR 57321
.*                  Recompiled for PATCATAI - SVHM Reprint invoice with Adjust.
.*        V9.04.28  25/02/2005  J.Habasque    CAR 58762
.*                  Changed aadmno to admissno in DELE0000 and removed move of
.*                  aadmno to admissno in WARN0000
.*        V9.04.27  24/02/2005  J.Tan         CAR 58263
.*                  Recompiled for PATCATAI - printing item description
.*        V9.04.26  17/02/2005  Mike Laming   CAR 56030
.*                  Re-compile for PATINV25 - fix screen painted tail printing
.*        V9.04.25  13/01/2005  J.Tan         CAR 56548
.*                  Mods to read parameter - for printing MBS Code on invoice
.*        V9.04.24  10/01/2005  J.Tan         CAR 51688
.*                  Recompiled for PATCATBI - print second line desc.
.*        V9.04.23  30/12/2004  J.Tan         CAR 55988
.*                  Recompiled for PATCATBI - print mis.item for pendlebury inv.
.*        V9.04.22  17/12/2004  J.Tan  CAR 55944
.*                  Recompiled for PATCATBI - Calvary invoice for public
.*        V9.04.21  16/12/2004  J.Tan  CAR 55944
.*                  Recompiled for PATCATBI - Calvary invoice for public
.*        V9.04.20  09/12/2004  J.Tan         CAR 55635
.*                  Recompiled for PATCATBI - amount for item with quantity
.*                  Recompiled for PATINVTL - Receipt amount on invoice tail
.*        V9.04.19  06/12/2004  J.Tan   CAR 55599                             *
.*                  Re-compiled for PATINV25 - Setup invoice tail template    *
.*        V9.04.18  29/11/2004  Mike Laming   CAR 54534                       *
.*                  Re-comple for PATCMSTP - fix Addit.Charge Description     *
.*        V9.04.17  22/11/2004 J.Tan       CAR 52708 
.*                  Added warning for theatre system after deleting MBS
.*        V9.04.16  17/11/2004 Guomin Fu   CAR 54768
.*                  Recompiled for PATCATBI - Pendlebury Invoice layout
.*                  16/11/2004 J.Tan       CAR 52538 
.*                  Added option to change Accommodation GST 
.*        V9.04.15  15/11/2004 J.Tan       CAR 54768 
.*                  Mods for Pendlebury invoice layout (PTCNINVL=16)
.*        V9.04.14  11/11/2004  J.Tan      CAR 55071
.*                  Recompiled for PATCATBI - fixed SVHM 
.*        V9.04.13  11/11/2004  J.Tan      CAR 55071
.*                  Recompiled for PATCATBI - fixed SVHM 
.*        V9.04.12  09/11/2004  Peter Vela CAR 53371
.*                  Recompiled for PATVISTM
.*        V9.04.11  29/10/2004  J.Tan      CAR 54347
.*                  Recompiled for PATCATBI - init patient portion of item amt
.*        V9.04.10  27/10/2004  J.Tan      CAR 54648
.*                  Recompiled for PATCATBI - Display Backdated invoice    
.*        V9.04.09  22/10/2004  J.Tan      CAR 54529
.*                  Fixed I*D when doing stepdown                  
.*        V9.04.08  12/10/2004  J.Tan      CAR 54242
.*                  Added parameter to print ward/bed on invoices
.*        V9.04.07  05/10/2004 - J.Tan   CAR 53895
.*                  Recompiled for PATINV20 - Holy Sprit layout (non-banked dep)
.*                  04/10/2004 - Peter Vela CAR 52906
.*                  Recompiled for PATWEB71
.*                  01/10/2004 - Lina Vo  CAR 53798
.*                  Changed program to use PTHSDCLM for Multi Hospital 
.*                  instead of PTCNDCLM.
.*                  29/09/2004  J.Tan  CAR 53292    
.*                  Recompiled for PATINVTL - I*C pmsvx1af
.*                  21/09/2004 - Lina Vo  CAR 53660
.*                  Changed SADJ0000 to use PTHSTFEE for Multi Hospital 
.*                  instead of PTCNTFEE.
.*                  14/09/2004  J.Tan  CAR 52687    
.*                  Fixed czer0000 not to calculate outstanding amount   
.*        V9.04.06  08/09/2004  J.Tan    CAR 53292
.*                  Recompiled for STEPDOWN - bed fees not setup
.*                  08/09/2004  Ebon Clements  CAR 53280
.*                  Recompiled for PATINVL "- " in SEP variable
.*        V9.04.05  06/09/2004  Lina Vo  CAR 52998
.*                  Initialise Page Number for PRTINVHL.
.*        V9.04.04  30/08/2004  J.Tan    CAR 53073
.*                  Mods to display Hospital ID on invoice heading
.*        V9.04.03  27/08/2004  J.Tan    CAR 52835
.*                  Recompiled for PATCATBI - Multi hospital
.*        V9.04.02  27/08/2004  J.Tan    CAR 52891
.*                  Recompiled for PATCATAI - printing journals over payments 
.*        V9.04.01  20/08/2004 J.Tan CAR 52835
.*                  Recompiled for PATFINFD - Multi hospitals           
.*        V9.03.61  13/08/2004 J.Tan CAR 52504
.*                  Recompiled for PATCATAI - non-banked deposit        
.*        V9.03.60  09/08/2004 J.Tan CAR 50558
.*                  New report for Invoice pending list                 
.*        V9.03.59  03/08/2004 J.Tan CAR 52224
.*                  Mods stepdown transfer listing                      
.*        V9.03.58  02/08/2004 J.Tan CAR 52033
.*                  Recompiled for PATCATBI - displaying item unit price
.*        V9.03.57  26/07/2004 J.Tan CAR 51805
.*                  Recompiled for PATCATBI - pre op cut off for C/P.
.*        V9.03.56  22/07/2004 J.Tan CAR 51963
.*                  Fixed deleting/updating items screen.
.*        V9.03.55  20/07/2004 J.Tan CAR 50220
.*                  Recompiled for CMXMATRX 
.*        V9.03.54  19/07/2004 J.Tan CAR 51688
.*                  Recompiled for PATINVHL - I*C on patfund file          
.*        V9.03.53  16/07/2004 J.Tan CAR 51688
.*                  Recompiled for PATCATBI - printing accommodation desc.
.*        V9.03.52  06/07/2004 J.Tan CAR 50781
.*                  Recompiled for PATINVHL - claim code description      
.*        V9.03.51  28/06/2004 J.Tan CAR 51112
.*                  Recompiled for PATCATBI - Unrelease non-banked deposit
.*                  Mods to always display invoice number after printing invoice
.*                  Mods to check for refund deposit (51266)
.*        V9.03.50  24/06/2004 J.Tan CAR 47851
.*                  Recompiled for PATCATBI - Daycase moiety
.*        V9.03.49  22/06/2004 J.Tan CAR 42846
.*                  Mods to include days of hospitalisation for C/P
.*                  22/06/2004  Lina Vo  CAR 50811                            
.*                  Removed use of RCPDEPFD & IO - now obselete.              
.*        V9.03.48  17/06/2004 Peter Vela CAR 49016
.*                  2004 Stat Changes PRS/2
.*                  Recompiled for PMSPX2TM
.*                  24/05/2004 J.Tan  CAR 49644
.*                  Recompiled for PATCMSTP - fixed up C/P manual stepdown 
.*        V9.03.47  08/06/2004 J.Tan  CAR 42846
.*                  Recompiled for PATCATBI - Mechanical ventilation
.*        V9.03.46  07/06/2004 J.Tan  CAR 50019
.*                  Recomp.for PATCATBI -West wimmera invoice layout PTCNINVL=19
.*        V9.03.45  01/06/2004 J.Tan  CAR 50335
.*                  Recompiled for CMXMATRX - I*C
.*                  Fixed displaying invoice number after printing
.*        V9.03.44  27/05/2004 J.Tan  CAR 50108
.*                  Recompiled for PATCATBI - Deposit date
.*        V9.03.43  26/05/2004 Jill Habasque   CAR 50196
.*                  Made admissno mandatory for report number 1               
.*                  25/05/2004 J.Tan  CAR 50116
.*                  Recompiled for PATINV23 - print RCH invoice with payment
.*        V9.03.42  13/05/2004 J.Tan  CAR 49827
.*                  Recompiled for PATINVS - Mods to get non-banked deposit
.*        V9.03.41  30/04/2004 Lina Vo CAR 42846
.*                  Added extra tags to STDW0000       
.*                  Recompiled for PATINVS - Refund deposit CAR 49519
.*                  CAR 49531 - Fixed I*C on cash file, backdate invoice
.*                  CAR 47920 - Fixed disable print invoice option
.*        V9.03.40  29/04/2004 J.Tan  CAR 36504
.*                  Mods for Invoice estimate
.*                  Mods error message for invoice range
.*        V9.03.39  23/04/2004 J.Tan  CAR 45547                               *
.*                  Mods for printing backdated invoice                       *
.*        V9.03.38  22/04/2004  Mike Laming   CAR 46224                       *
.*                  Re-compile for PATCATBI & PATINVS - Theatre DTR sequences *
.*        V9.03.37  20/04/2004 J.Tan  CAR 45547                               *
.*                  Mods for printing backdated invoice                       *
.*        V9.03.36  16/04/2004 J.Tan  CAR 47922                               *
.*                  Mods to display invoice number after printing invoice     *
.*        V9.03.35  15/05/2004 Ebon Clements  CAR 48713                       *
.*                  Added billing update civil tort details                   *
.*        V9.03.34  06/04/2004 Peter Vela CAR 48227                           *
.*                  Added VARGBCRN and PATGBCRN - BPAY Reference Number       *
.*        V9.03.33  08/04/2004 J.Tan  CAR 48918                               *
.*                  Mods to remove allowance
.*        V9.03.32  26/03/2004 Peter Vela CAR 13038                           *
.*                  Recompiled for PATDOCCD - Doctor Name format Parameter    *
.*                  16/03/2004  Steve Armstrong  HosClaims Phase 1 (48280)    *
.*                  Recompiled for PATINVS                                    *
.*        V9.03.31  27/02/2004  J.Tan    CAR 44109                            *
.*                  Fixed problem recalculating amount after changing quantity*
.*        V9.03.30  12/02/2004  Henry Son        CAR 47385                    *
.*                  Added PTCNMBSF for checking if we allow more than         *
.*                  Six MBS Items.                                            *
.*        V9.03.29  23/02/2004  Mike Laming   CAR 47440                       *
.*                  Re-compile for PATCATBI - initialise TPATAMTP             *
.*        V9.03.28  16/02/2004  J.Tan             
.*                  Fixed front end deductable                                *
.*        V9.03.27  11/02/2004  J.Tan  CAR 36504
.*                  Added facility to change desc.and amount of item tobe inv.*
.*        V9.03.26  04/02/2004  J.Tan  CAR 46269
.*                  Mods for cancelling items from the next invoice screen    *
.*        V9.03.25  03/02/2004  J.Tan  CAR 45047                              *
.*                  Recompiled for PATCATAI - Non-banked Cash                 *
.*        V9.03.24  19/12/2003 J.Tan   CAR 44093                              *
.*                  Replaced patcashf with comdepaf                           *
.*        V9.03.23  11/12/2003  J.Tan                                         *
.*                  Fixed validating compensation claim                       *
.*        V9.03.22  13/11/2003  J.Tan   CAR 44160/44161                       *
.*                  Recompiled for PATCATAI                                   *
.*        ........  18/11/2003  Henry Son   CAR 39291                         *
.*                  Allow more than 7 Theatre stepdown fees.                  *
.*        V9.03.21  07/11/2003  Peter Vela   CAR 44849                        *
.*                  Recompiled for PATINVTL                                   *
.*                  07/11/2003  J.Tan        CAR 44160                        *
.*                  Recompiled for PATCALFN
.*        V9.03.20  03/11/2003  Mike Laming  CAR 43911                        *
.*                  Recompile for PATCATBI - correct GROSSTOT & ACCMTOT       *
.*        V9.03.19  03/11/2003  Peter Vela CAR 44757
.*                  Recompiled for PATINVTL
.*        V9.03.18  17/10/2003  J.Tan  CAR 44176
.*                  Recompiled for PATCATBI - Misc.theatre item file .   
.*        V9.03.17  13/10/2003  Davin         CAR 39038
.*                  Recompiled for change to viscmtfd
.*        V9.03.16  13/10/2003  J.Tan   CAR 36507
.*                  Mods stepdown for casepayment
.*        V9.03.15  07/10/2003  Lina Vo CAR 36520
.*                  Added update of print flag in pmsbiiaf when printing 
.*                  single invoice from bulk list.
.*        V9.03.14  01/10/2003  J.Tan  CAR 36507
.*                  Added Stepdown for bed fees file                          *
.*        V9.03.13  05/09/2003  J.Tan  CAR 36507
.*                  Added Front End Deductible option                         *
.*                  Added Casemix code option                                 *
.*                  16/09/2003  J.Tan        CAR 36504                        *
.*                  Recompiled for CHNADMTP                                   *
.*        V9.03.12  01/09/2003  Lina Vo   CAR 40497                           *
.*                  Recompiled for PATMCHFD & IO and PATINVS. Added KEY26A    *
.*                  for PATINVS.                                              *
.*        V9.03.11  28/08/2003  CAR 41880   Mike Laming                       *
.*                  Re-compile for PATCATBI - Correct calc. of CRITDAYS       *
.*        V9.03.10  27/08/2003  J.Tan                                         *
.*                  Added Resolving Unknown GST Code for Accommodation/Items  *
.*        V9.03.09  22/08/2003  J.Tan                                         *
.*                  Recompiled for PATCATBI - fixed key for patdgwaf          *
.*        V9.03.08  12/08/2003  CAR 41072   Mike Laming                       *
.*                  Recompile for PATCATBI to correct Lump Sums in BIL19      *
.*        V9.03.07  04/08/2003  CAR 34330/41952   Mike Laming                 *
.*                  Recompiled for PATCATBI & PATDINVS - Add second temp      *
.*                  file for Misc.Items to change sequence to Date/DTR seq.   *
.*        V9.03.06  31/07/2003 J.Tan  CAR 40786
.*                  Recompiled for CMXMATRX
.*                  30/07/2003 J.Tan  
.*                  Mods to print 2 lines of description on invoice
.*        V9.03.05  27/06/2003 J.Tan  
.*                  Mods to check if any invoice to be printed
.*        V9.03.04  02/07/2003 Jill Habasque CAR 40660
.*                  Recompiled for PATDSCTM
.*        V9.03.03  19/06/2003 J.Tan  CAR 39832
.*                  Mods for Billing Comments 
.*        V9.03.02  16/06/2003 J.Tan  CAR 39832
.*                  Added Compensable and PRFA screens
.*        V9.03.01  13/05/2003 J.Tan  CAR 36505
.*                  Recompiled for PATCATBI - Estimate rebate
.*        V9.02.25  08/04/2003 J.Tan
.*                  Added invoice pending list 
.*        V9.02.24  11/03/2003 J.Tan
.*                  Recompiled for PATMISTM - admitting point
.*        V9.02.23  13/02/2003  Dean Cramer  CAR 22238                        *
.*                  Recompiled for rcptrn                                     *
.         V9.02.22  07/02/2003 Tonii CAR 35992
.                   Recompiled for PATMISTM - inactive codes in patfundf
.         V9.02.21  05/12/2002  Lina Vo              
.                   Added OPNOUT00 to open outpatient files.
.*        V9.02.20  12/11/2002  J.Tan                                         *
.*                  Recompiled for KYPTBANK                                   *
.*        V9.02.19  30/10/2002  J.Tan                                         *
.*                  Recompiled for CMXMATRX                                   *
.         V9.02.18  09/10/2002  Peter Vela SRF 17693
.                   Recompiled for PATMISTM - Admitting Point
.*        V9.02.17  19/09/2002  J.Tan                                         *
.*                  Recompiled for PATCATBI                                   *
.         V9.02.16  09/09/2002  J.Tan      SRF 20791
.                   Recompiled for PATCATBI
.         V9.02.15  23/07/2002  J.Tan
.                   Recompiled for PATMISTM - added patasfaf file
.         V9.02.14  03/06/2002  J.Tan 
.                   Recompiled for CMXMATRX - fixed reading controlf
.         V9.02.13  21/05/2002  J.Tan
.                   Recompiled for PATDSBFE
.         V9.02.12  14/05/2002  J.Tan
.                   Recompiled for PATMISTM - added casemix code
.         V9.02.11  06/05/2002  J.Tan
.                   Recompiled for PATCATBI - changes from 6.09
.         V9.02.10  06/04/2002  J.Tan
.                   Recompiled for PATINVS - Suggested classification
.         V9.02.09  28/03/2002  J.Tan
.                   Recompiled for PATCATBI - STV invoice layout
.         V9.02.08  22/01/2002  Steve Downing  SRF 14240
.                   Recompiled for PATCATBI - changes to modbury layout
.         V9.02.07  17/01/2002  J.Tan
.                   Recompiled for PATINVS - default GST applicable
.         V9.02.06  07/12/2001  Tonii                                          
.                   Recompiled for PATCATBI - Casemix changes                  
.         V9.02.05  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.                   Recompiled for NHI tags added to PATMASTM
.         V9.02.04  29/11/2001  J.Tan 
.                   Recompiled for PATCATBI - fixed displaying invoice
.         V9.02.03  17/10/2001  Greg Horvat      SRF 13654
.                   Recompiled for PATCATBI - Changed to display the patient's
.                   admission number when a casemix error occurs
.                   16/10/2001  Greg Horvat      SRF 13636
.                   Recompield for PATCATBI - Changed to use AADMNO rather
.                   than TADMN when reading pattranf for the 1st time when
.                   calculating the amount to be invoiced
. V9.02.02  06/10/2001  J.Tan  
.           Recompiled for CMXMATRX
. V9.02.01  22.09.2001 Tonii  SRF 13075
.           Recompiled for PATDINVS
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B03 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 26/02/2001  J.Tan        
.           Recompiled for PATWMAFD
.----------------------------------------------------------------------
.         V5.09.02  15/01/2001 Bronko Sosic  
.                   Recompiled for PATMASTM 
.         V5.09.01 04/01/2001  Jill Habasque
.                   Casemix mods - recompiled for PATCATBI                    
.         V5.08.13  22/11/2000  Greg Horvat
.                   Recompiled for PATCATAI PATCATBI & PATINVS - Commented out
.                   any code to do with Hong Kong or Mt Alvernia
.         V5.08.12  09/11/2000  Ebon Clements SRF 6891                         
.                   Recompiled for PATINVS read patmchgf with key26            
.         V5.08.11  24/10/2000  Dean Cramer   SRF 6710                        
.                   Recomplied for PATINVS & PATMSCDS                        
.                   Changed for health fund table code size increase to      
.                   8 characters                                             
.         V5.08.10  16/10/2000  Steve Downing
.                   Recompiled for PATINVS
.         V5.08.09  29/09/2000  Jill Habasque SRF 3060
.                   Recompiled for PATINVHL        
.         V5.08.08  28/09/2000 Bronko Sosic  
.                   Recompiled for PATMASTM / PATMISTM
.         V5.08.07  14/09/2000 Caleb Sharman         
.                   Health fund change mods         
.         V5.08.06  16/08/2000  Caleb Sharman                             
.                   Changed Health Fund variables to be 8 chars            
.         V5.08.05  29/06/2000  B.G.Ackland
.                   Recompiled for MPGEFLAG
.         V5.08.04  29/06/2000  Steve Armstrong                               
.                   Recompiled for PATCATBI & PATCATAI                        
.         V5.08.03  07/06/2000  Bronko Sosic
.                   Recompiled for PATMASTM                       
.         V5.08.02  01/05/2000  Greg Horvat
.                   Changed to open patmx1af when opening patma1af
.               V5.08.B02 26/04/2000 Davin
.                         Recompiled for invoice templating
.               V5.08.B01 11/04/2000 J.Tan
.                         Mods for GST
.
.                V5.07.02 20.01.1998 B.G.Ackland
.                         Recompile for Standard Includes
.
.                V6.04.03 23.03.1998 B.G.Ackland
.                         New Template Body Processing   
.
.                V6.04.04 25.03.1998 B.G.Ackland
.                         New Link option 70 in PATMASTM
.
.                V6.04.04 15.06.1998 Katie Nelson
.                         Modified/Completed INVD0000 
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       STDHLPDF
.
          INC       IBAPOLFD/INC
          INC       TFILEVAR/INC
          INC       NZPSPRTD/INC
          INC       NZPEXTFD/INC
          INC       CHKDIGVR/INC
          INC       PABXVARS/INC
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRICDFD/INC    * AE Diagnosis Codes
          INC       EMRVISFD/INC
          INC       EMRVCDFD/INC
          INC       IBATMDFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
          INC       PATCOMM/INC
          INC       MRTMASFD/INC
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATRDEFD/INC
          INC       PMSFOCFD/INC
          INC       PMSABFFD/INC
          INC       PATABFFD/INC
          INC       PMSADJFD/INC
          INC       PMSTLEFD/INC
          INC       PMSPWAFD/INC
          INC       PMSHATFD/INC
          INC       PATDDHFD/INC
.
          INC       APSMASFD/INC
          INC       AAEDTRFD/INC
          INC       AAEDE1FD/INC
          INC       ACCRFPFD/INC
          INC       ACCDIAFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       COMDEPFD/INC
          INC       NHIMASFD/INC
          INC       PATCHCFD/INC
          INC       PATAFEFD/INC
          INC       PATASDFD/INC
          INC       PATBFEFD/INC
          INC       NZPBFEFD/INC
          INC       NZPTFEFD/INC
          INC       NZPCFNFD/INC
          INC       MLTCFNFD/INC
          INC       MLTCF1FD/INC
          INC       NZPCMTFD/INC
          INC       NZPIBRFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRVBFD/INC
          INC       NZPPFEFD/INC
          INC       NZPSPRFD/INC
          INC       NZPPICFD/INC
          INC       NZPRDTFD/INC
          INC       PATCFAFD/INC
          INC       PATCMCFD/INC
          INC       PATCMXFD/INC
          INC       PATCONFD/INC
          INC       MRTCONFD/INC
          INC       PATCRAFD/INC
          INC       PATCURFD/INC
          INC       PATALRFD/INC
          INC       PATALWFD/INC
          INC       PATACHFD/INC
          INC       PATCALAG/INC
          INC       PMSCCDFD/INC
          INC       PMSRESFD/INC
          INC       PATCERFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCTFFD/INC
          INC       PMSCIDFD/INC
          INC       PATELGFD/INC
          INC       PATDO1FD/INC
          INC       PATDGWFD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATECHFD/INC
          INC       PATECOFD/INC
          INC       PATEDSFD/INC
          INC       PATEDTFD/INC
          INC       PATEORFD/INC
          INC       PATFN2FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATGTUFD/INC
          INC       PATHDFFD/INC
          INC       PATHSPFD/INC
          INC       PATHLFFD/INC
          INC       PATHTRFD/INC
          INC       EMRHTRFD/INC
          INC       OUTHTRFD/INC
          INC       PATIPRFD/INC
          INC       PATIBLFD/INC
          INC       PATICUFD/INC
          INC       PATICDFD/INC
          INC       PATIN1FD/INC
          INC       PATINMFD/INC
          INC       PATINLFD/INC
          INC       PATINPFD/INC
          INC       PATIPEFD/INC
          INC       PATONHFD/INC
          INC       PATINVFD/INC
          INC       PATIOVFD/INC
          INC       PATIRNFD/INC
          INC       NZPIRNFD/INC
          INC       PATITMFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PATFACFD/INC
          INC       PATFEEFD/INC
          INC       PATFIGFD/INC
          INC       NZPFIGFD/INC
          INC       PATFINFD/INC
          INC       NZPFINFD/INC
          INC       PATFMOFD/INC
          INC       PATFN1FD/INC
          INC       PATNIDFD/INC
          INC       PMSBRQFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEXTTD/INC
          INC       PMSCNOFD/INC
          INC       PMSFCIFD/INC
          INC       PMSECTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSBBIFD/INC
          INC       PMSBIIFD/INC
          INC       PMSCTCFD/INC
          INC       PMSPRGFD/INC
          INC       PMSWX1FD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PATCHXFD/INC
          INC       PATMA1FD/INC
          INC       PATONLFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATMCHFD/INC
          INC       NZPMCHFD/INC
          INC       PMSPTDFD/INC
          INC       NZPMXCFD/INC
          INC       OBSPCOFD/INC
          INC       OBSPCTFD/INC
          INC       PATMI1FD/INC
          INC       PATMMBFD/INC
          INC       PATNHHFD/INC
          INC       PATNZRFD/INC
          INC       PATOVBFD/INC
          INC       PATPARFD/INC
          INC       PATPR1FD/INC
          INC       PATPGRFD/INC
          INC       PATASFFD/INC
          INC       PATRATFD/INC
          INC       PATRBLFD/INC
          INC       PATRE1FD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       NZPRFNFD/INC
          INC       PATSCFFD/INC 
          INC       PATSGCFD/INC
          INC       PATSRBFD/INC
          INC       PATTFEFD/INC
          INC       PATRCAUD/INC
          INC       PATREMFD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATDADFD/INC
          INC       PATJRNFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWVEFD/INC
          INC       PMSSINFD/INC
          INC       PMSCMTFD/INC
          INC       PATCMTFD/INC
          INC       PMSVX1FD/INC
          INC       NHIETHFD/INC
          INC       OPRCONFD/INC
          INC       OPRARDFD/INC
          INC       OPRPMBFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDECFD/INC
          INC       OPRSESFD/INC
          INC       OPRSRGFD/INC
          INC       OUTDTRFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTSITFD/INC
          INC       OUTCTYFD/INC
.         INC       RCPCONFD/INC
          INC       RCPBNKFD/INC
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC
          INC       RCPCRSFD/INC
          INC       RESLNKFD/INC
          INC       MAMMASFD/INC
          INC       VISCMTFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PRIITMFD/INC
          INC       PATSTAFD/INC
          INC       PATAA1FD/INC
          INC       PMSSGAFD/INC
          INC       PMSICMFD/INC
          INC       PATFAPFD/INC
          INC       PATPFAFD/INC
          INC       PATRGMFD/INC
.
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       VARGBCRN/INC     * I-48227
          INC       VARWIS11/INC          * Variables for PATWIS11
          INC       VISPAYFD/INC
          INC       VISPAYTD/INC
          INC       VISPMAFD/INC
          INC       VISPMATD/INC
          INC       PMSMTIFD/INC
          INC       PMSMTEFD/INC
          INC       PMSMPRFD/INC
          INC       PMSPYRTD/INC
          INC       PMSPYRFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIVBFD/INC
          INC       PMSIDEFD/INC
          INC       PMSREGFD/INC
          INC       ALLCASFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PMSCHAFD/INC
          INC       PATVENFD/INC
.
          INC       WEBIHCFD/INC
          INC       WEBPARFD/INC
          INC       WEBDINVS/INC     * ---- substitue include for PATDINVS ----
          INC       RSHWEBDF
          INC       PATMISTD/INC
          INC       PATHGPFD/INC 
          INC       CHKCLDCD/INC
.
MPGEFLAG  FORM      1
MTIFLAG   FORM      1
.
.   Work Variables
.
ACCPORDN  DIM       20
ADD       DIM       2
AMM       DIM       2
AYY       DIM       2
ACC       DIM       2
ACTION    DIM       1
ACCMGST   DIM       8
ADMNTYPE  DIM       3
ATYDESC   DIM       20
ACCDTE    DIM       10
AADMNOX   DIM       6
ADIAG     DIM       50
ATTDOCT   DIM       31
ATTPROV   DIM       10
ACTNCODE  DIM       3
ACTNPLAN  DIM       1
.
BPRNT     DIM       1[999]
BADMN     DIM       8[999]

BFECONTR  DIM       6
BOOKFLAG  FORM      1
BFEESKEY  DIM       35
BFAMT     FORM      8.2
BEDTRKEY  DIM       30 
CORRESID  FORM      4
CORSP001  DIM       30
CORSP002  DIM       8
CORSP003  DIM       3
CORSP004  DIM       8
CORSFILE  DIM       20
CORSPPRT  INIT      ".pdf"
CURRDATE  DIM       8
CMDMOVE   INIT      "mv "
CMDFCHK   INIT      "cliweb08.us1 "
DASH      INIT      "-"
SAVVISIT  DIM       8
TEMPNAME  DIM       8
TEMPFILE  FILE      ASCII,FIXED=127
.
DISPSTEP  DIM       1
DISCTYPE  DIM       1         * Type 1=Dollars Discount ,2=Percentage Discount
DISCDESC  DIM       25
DOLLAR    INIT      "$"
DAYENDD   FORM      4[99]
DISPDATE  DIM       12
DISPDAT1  DIM       12
ADDENDD   FORM      4[99]
CKHOSPID  DIM       1
COLNO     FORM      2
CASEPAY   DIM       3
CLAIMTYP  DIM       3
CODED     DIM       3
CLMDESC   DIM       20
CHGFLAG   FORM      1
CHECKBOX  DIM       1
CALDAYS   FORM      4
CERTINDC  FORM      1
CFILEPRE  DIM       3
BULKBILL  DIM       1
.CDYSDAYS  FORM      6
.CDYSFDTE  DIM       8
.CDYSTDTE  DIM       8
.CDYSYEAR  FORM      2
CMBSFEE   FORM      1
CMDLINE   DIM       180
TBSPOOL   INIT      "TBSPOOL"
CURSESS   DIM       18
CURDATE8  DIM       8
CODESTAT  DIM       1
COMPDATE  DIM       8
COMPCLAM  DIM       3
CASEPAYM  DIM       1
CREDFLAG  FORM      1
NSPRUNIQ  DIM       3
NZITFLAG  DIM       1    * NZ Private Item with NOT performed procedures
NZPEFLAG  DIM       1    * NZ Private error flag
PLANFLAG  DIM       1    * NZ Planned procedure flag
PRESFLAG  DIM       1    * Person responsible flag 1=not entered
PRINTPDF  DIM       1
ZEROFLAG  DIM       1    * Zero duration exists
FOUNDPRM  DIM       1
COUNTITM  FORM      3
.
BFECOLNO  FORM      2
ADDCOLNO  FORM      2
BFEEAMNT  FORM      12.2
ADDFAMNT  FORM      12.2
.DBILFLAG  DIM       1
DEFFEES   DIM       1
DEFCOLNO  FORM      2
DEFCOLAD  FORM      2
PADDAMNT  FORM      12.2
PPORAMNT  FORM      12.2
RADDAMNT  FORM      12.2
RPORAMNT  FORM      12.2
RTDAYS    FORM      4
DISCAMNT  FORM      12.2
CPAYADJM  FORM      12.2
ALLWAMNT  FORM      12.2
TOTALFEE  FORM      12.2
TOTALCHR  FORM      12.2
TOTALMAX  FORM      12.2
TFFSAMNT  FORM      12.2
EDAYRANG  FORM      3
ADAYRANG  FORM      3
ENDDAY    FORM      4
ERRORDES  DIM       50
CCVERIFI  DIM       1
REASONCH  DIM       3
UDFADMIS  DIM       3
UDFDISCH  DIM       3
ATRTYPE   DIM       3
.
.
DAYCOL    FORM      4
DAYFORMT  DIM       4
DDRGCODE  DIM       4
DEFRTHAL  DIM       1
DOCTCODE  DIM       6
DSCHFLAG  FORM      1
DIM1A     DIM       1
DIM2A     DIM       2
DIM3      DIM       3
DIM3A     DIM       3
DIM3B     DIM       3
DIM4      DIM       4
DIM9      DIM       9
DIM12A    DIM       12
DIM14     DIM       14
DIM18     DIM       18
DIM18A    DIM       18
DIM24A    DIM       24
DIM26A    DIM       26
DIM28     DIM       28
DIM30     DIM       30
DIM30A    DIM       30
DIM40     DIM       40
DNAME     DIM       20
DOCLINE1  DIM       62
DOCLINE2  DIM       62
DOCTNAM   DIM       36
.
.CODECOMP  DIM       11
CODECOMD  DIM       8
CODECOMP  DIM       20
CODEINCO  DIM       20
ECLIUEBB  DIM       1
EMRFLAG   FORM      1
ENDDAT    DIM       6
ENDNAM    DIM       6
ENDSEC    FORM      5
.
FUTRACTN  DIM       3         * Health Fund Future action code
FILTVTYP  FORM      1
FILTCODD  DIM       1
FILTHFND  DIM       6
FILTHFGP  DIM       6
FILTHOLD  DIM       3
FILTCLAM  DIM       3
FILTOPTN  FORM      1
FAILCNT   FORM      8
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FORM3A    FORM      3
FORM32    FORM      3.2
FORM5     FORM      5
FORM52    FORM      5.2
FORM8     FORM      8
FORM10    FORM      10
FORM122   FORM      12.2
FORMG     FORM      8
FOUNDMBS  FORM      1
.
FGSTFLAG  FORM      1
FIRSTADM  DIM       8                  * This CGI contains the parent admission
.                                        number for multiple HCP bookings
.
GOSUBFLG  FORM      1
GROUPCOD  DIM       3         * Occupational Group
GRNDTOT   FORM      9.2
GRNDNET   FORM      9.2
HOUR      DIM       2
HOURTM    DIM       2
HJNL      DIM       2         * Journal type for discount
HEALTHFN  DIM       6
HFNDESC   DIM       20
HOLDDESC  DIM       20
HDUDAY1   FORM      3                       * High Dependency
HDUDAY2   FORM      3
HL7ITMFL  DIM       1
.
ITEMCODE  DIM       9
INVIACTV  DIM       1
INVDATE   DIM       8
INVOICNO  DIM       8
INVOICEN  FORM      8
ITMNGST   DIM       8
...ITCODE    DIM       12
ITEMFLAG  FORM      1                       * Input items flag
INVTODAT  DIM       8
INITDATE  DIM       8
.
JOURFLAG  FORM      1
JOURTOT   FORM      6.2
JYEAR     FORM      2
.
KEYINPRC  DIM       1
KEY13A    DIM       13
KEY12A    DIM       12
KEY21A    DIM       21                      * required for PATINVS
KEY26A    DIM       26                      * required for PATINVS
KEY29A    DIM       29                      * required for PATINVS
KEYFLAG   FORM      1
.
LOOPCNTR  FORM      8
LASTSEQN  FORM      2
LDEPT     DIM       3
LNO       FORM      2
LWCHG     FORM      6.2                     * Labour Ward Fee
LWDT      DIM       8
LOSDAYS   FORM      6
.
MDATE000  DIM       8
MAXCNTR   FORM      3
MXBIL     FORM      12.2[999]
MXDAY     FORM      12.2[999]
IVAMT     FORM      12.2[999]
ITMCD     DIM       9[999]
RGMCD     DIM       10[999]
MIN       DIM       2
MINTIME   DIM       2
MANCHNGE  DIM       1
MANSAMNT  FORM      12.2
MODECODE  DIM       3
MBSDESC   DIM       40
MBSLOP    FORM      2
MBSFLAG   FORM      1
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MINOWE    FORM      6.2
MULTAMT   FORM      6.2
MULTNUM   FORM      3
MULTHOSP  DIM       3
MINFLD    FORM      2
MAXDAY    FORM      1
MAXADD    FORM      1
MAXSCRN   FORM      2
MAXIBILL  FORM      12.2
MAXIDAYB  FORM      12.2
MVITTYPE  DIM       1
MVITSTAT  DIM       1
LINENUMB  FORM      2
MTHNAM3A  DIM       3
MVMEDREC  DIM       1
NEWBTYPE  DIM       3
NEWDHOSP  FORM      4
NMPNUMB   DIM       20
OPAYFLAG  FORM      1
OLDCASEM  DIM       9
NZPVFLAG  FORM      1
RACLINDC  DIM       1
REBTAMNT  FORM      12.2
RATEFLG   FORM      1
RECEIPTN  DIM       12
RECTRNNO  DIM       5
REFRLVIS  DIM       8
PREVTRID  DIM       24
.
RCCNSTRF  DIM       1        * Display Statement Reference
.
MATRIXFL  FORM      1
SDOWNFLG  FORM      1
SAVEINCT  DIM       1
SAVKEY19  DIM       19
SERIFLAG  DIM       1        * Outpatient series booking flag
SNZBFKEY  DIM       40
SBFEEKEY  DIM       38
PDIEMKEY  DIM       312
SBFEND1   DIM       3
SBFEND2   DIM       3
SBFEND3   DIM       3
SBFEND4   DIM       3
SBFEND5   DIM       3
SBFEND6   DIM       3
SEQUENCE  FORM      2
SEQCOUNT  FORM      2
SHOWFLAG  FORM      1
SHOWPAYR  FORM      1
SHOWHEAD  FORM      1
SAVAMNT   FORM      12.2
SAVIND6   DIM       1
SORTFLAG  FORM      1
SRTFNAME  DIM       60
SYSTEM    DIM       3
SYSCOD    DIM       3
STARTKEY  DIM       8                       * Starting Key
TRANFLAG  DIM       1
TOTPD     FORM      12.2
TOTJR     FORM      12.2
TOTINV    FORM      12.2
TOTBAL    FORM      12.2
TOTCR     FORM      12.2
TRANSCNO  DIM       6
.CHNGDATE  DIM       8
CHNGTIME  DIM       8
CHNGDESC  DIM       1
CHNGAMNT  DIM       1
CASEKEYS  DIM       30
TODAY     DIM       8
.
MOVESEQN  DIM       2
MOVTOSEQ  DIM       2
.
MSCHG001  DIM       12
MSCHG002  DIM       9
MSCHG003  DIM       30
MSCHG004  DIM       5
MSCHG005  DIM       12
MSCHG006  DIM       15
MSCHG007  DIM       15
MSCHG008  DIM       8 
MSCHG009  DIM       8 
MSCHG010  DIM       1
MSCHG011  DIM       3
MSCHG012  DIM       65
MSCHG013  DIM       15
MSCHG014  DIM       1
MSCHG015  DIM       1
MSCHG016  DIM       50
MSCHG017  DIM       6
MSCHG018  DIM       1
MSCHG019  DIM       2
MSCHG020  DIM       3
MSCHG021  DIM       3
MSCHG022  DIM       3
MSCHAMNT  FORM      5
.
IPESTAT1  INIT      "Admission"
IPESTAT2  INIT      "Un-Disch."
IPESTAT3  INIT      "Chg.Ddate"
IPESTAT4  INIT      "Upd.Disch"
IPESTAT5  INIT      "Upd.BFee "
IPESTAT6  INIT      "Cred.Note"
IPESTAT7  INIT      "Add Item "
IPESTAT8  INIT      "Chg.Adate"
IPESTAT9  INIT      "Canc.Move"
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
NEXTVKEY  DIM       26
.
ONAME     DIM       30
OPOCFLAG  FORM      1
OPERCODE  DIM       4
OPRDATE   DIM       8
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OTCNFTYP  FORM      1
OTCNCFEE  FORM      1
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8           * Other Items
OTDT2     DIM       8
.
PAYMDAYS  FORM      3           * No of days for payment
PTGTU001  DIM       1
PTGTU002  DIM       6
PTMIS063  DIM       3           * User Defined Field 8 (Cat U8) (ptmsusr8)
PTMIS073  DIM       9           * Casemix Code (ptmxpcmx)
PTMIS075  DIM       1           * Case Payment (ptmscmxp)
PTMIS081  DIM       1           * Continuous Billing Event
PTRGM001  DIM       10          * Regime code
.
PREVVKEY  DIM       26
PRNTFLAG  DIM       1
PTSTATUS  DIM       1
PCENFLG   FORM      1
PSTROL    FILE      ASCII, FIXED=256
PSAGETYP  DIM       6
PSAGECON  DIM       3
PATAMOUN  FORM      12.2
REBAMOUN  FORM      12.2
.
REFDOCT   DIM       29
REGIST8   DIM       2
RETURNCD  DIM       3              * Return template program code
.
SCHCODE   DIM       3
SCHDATE   DIM       8
SAVAEND   FORM      4
SAVEXTRA  FORM      6.2
SBWINDOW  FORM      1
SCDJULDY  FORM      4
SCDJULYR  FORM      2
SAVCENT   DIM       2
SAVBEND   FORM      3
SAVKEY18  DIM       18 
SAVKEY20  DIM       20
SAVKEY22  DIM       22
SAVALLW   FORM      6.2
SAVDISC   FORM      6.2
SELECTID  DIM       4
SMCHARGE  DIM       9
SMITMTYP  FORM      1
SMMSCGRP  DIM       3
SAVFLAG   FORM      1
SAVADM    DIM       8
SAVDAY    DIM       2
SAVESEQN  DIM       2
SAVMON    DIM       2
SAVYEAR   DIM       2
SDATE     DIM       8
SEC       FORM      5
SNETTOT   FORM      8.2
SPECCODE  FORM      1
SPLING    FORM      2
STRTDAT   DIM       6
STRTNAM   DIM       6
SUPERLEV  DIM       1
SERVDOCT  DIM       10
.
EXCLMISC  DIM       1
TABLNA    DIM       25
TEMP1     FILE      ASCII,FIXED=70
.TMPFILE   DIM       8
TEMPAMT   FORM      6.2
TFEEIND   FORM      1
THCFLG    FORM      2
THDUDT1   DIM       8
THDUDT2   DIM       8
THEACHG   FORM      6.2                     * Theatre Fee
THEADTE   DIM       8
TEMPADT   DIM       3
TRANSNUM  DIM       6
TRANDATE  DIM       8                       * HPS Code Starts Here  
TRANTIME  DIM       8                       * HPS Code Ends Here
TRNTOWRD  DIM       3 
TRNTOBED  DIM       3 
.
UNIQUE    FORM      8
UNIQUEX   DIM       8
UPDATETY  FORM      1
UPDTTYPE  DIM       1         * Update Type
UPADMTYP  DIM       1
ITEMREGM  DIM       10        * Item code
.
WARNINGL  DIM       20
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FILE      ASCII, FIXED=256
WORKDATE  DATE      8
WAITFLAG  FORM      1
.
XDATTIME  DIM       14     * Date/Time (ccyymmddhhmmss)
XDESC     DIM       30
XXCENT    DIM       2
XXADM     DIM       6
XXDAY     DIM       2
XXMON     DIM       2
XXMULT    FORM      3
XXNAM     DIM       22
XXYEAR    DIM       2
...XAMT      FORM      4.2
XMBS      FORM      5
XAMTX     DIM       7
XMBSX     DIM       5
.
ZEROINVC  DIM       1
ZERO6     INIT      "000000"
.
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU8     INIT      "U8"
CATU9     INIT      "U9"
CATV1     INIT      "V1"
CATV2     INIT      "V2"
.
. ----- Variables for automatic admission type change / exploding charges -----
.
ADMTYP    DIM       3                       * Admission type
ADMTYPFG  FORM      1                       * Auto admission type flag
DTRDATE   DIM       8                       * DTR date (ccyymmdd)
EFTADMIN  DIM       8                       * Effective admission number
EFTATYPE  DIM       3                       * Effective admission type
EFTDATE   DIM       8                       * Effective date (ccyymmdd)
EFTTIME   DIM       8                       * Effective time
EXPCHCNT  FORM      2                       * Exploding MBS charge counter
FORM42    FORM      4.2
MBSCOUNT  FORM      2                       * MBS item counter
MBSDATE   DIM       8[15]                   * MBS date (ccyymmdd)
MBSITEM   DIM       9[15]                   * MBS items
NOATYPUP  FORM      1                       * No admission type updated flag
...SAVKEY8   DIM       8
SAVKEY9   DIM       9
SAVKEY12  DIM       12
SAVKEY14  DIM       14
SAVKEY34  DIM       34
SAVKEY38  DIM       38
.
ROW1      DIM       11[99]
ROW2      DIM       15[99]
ROW3      DIM       15[99]
ROW4      DIM       15[99]
ROW5      DIM       4[99]
.
ROW2A     DIM       17[99]
ROW3A     DIM       17[99]
ROW4A     DIM       17[99]
.
EMCNGINV  DIM       1
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
AECNCHRS  FORM      1
AECNFTYP  FORM      1        200      Type of A & E charging
AECNAEIH  DIM       6         40      AAE Invoice Header Code (templated)
AECNAEIT  DIM       6         46      AAE Invoice Tail Code (templated)
HSTANDM   FORM      1        132      Which A&E being used
HINVDES   DIM       30       133      Description on top of inv. Epw only
HESYST    FORM      1
.
.   Constants
.
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATRL     INIT      "RL"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CATCR     INIT      "cr"
CATdr     INIT      "dr"
CODECL    INIT      "CL"
CODEFA    INIT      "FA"
CODEDP    INIT      "DP"
CODEPY    INIT      "Py"
CATRH     INIT      "rh"
AT        INIT      "at"
RHINA     INIT      "Patient Hold"
RHINU     INIT      "Updated"
RHIND     INIT      "Deleted"
RHINC     INIT      "Claim Code Hold"
RHINF     INIT      "Health Fund Hold"
RHINR     INIT      "HL7 Receiver Hold"
ATYPE029  INIT      "029"
.
FIRST     FORM      "0"
.
HDUFLG    FORM      "0"
.
LWCODE    INIT      "LW"
.
MBSNUM    FORM      "0"
.
SP14      INIT      "              "
SP22      INIT      "                      "
SP27      INIT      "                           "
SURGFLG   FORM      "0"
SUMDAYS   FORM      4
.
OTCODE    INIT      "OT"
OTFLG     FORM      "0"
OPNFLAG   FORM      "0"                     * Used in stepdown
.
ZERO4     INIT      "0000"                  * needed by CMGETTHR
ZERO8     INIT      "0000    "              * needed by PATINVS
ZEIGHT    INIT      "00000000"              * needed by PATREBAT
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.------------------------------------------------------------------------------
PRGID     INIT      "PATWEB71"
PRGNAM    INIT      "Patient Invoice Print Server"      
VERSION   INIT      "V12.01.03"
.------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      GETPAT00
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  MOVE      ONE,BDTEFLAG
          MOVE      CHNGDATE,BACKDATE
          MOVE      ZERO,DBSFLAG
.
          CALL      PRTINV00 
          BRANCH    EXIT,MAIN1000
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Complete. Invoice Number:",WEBTITLE
          APPEND    CNEXTINV,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      UPDGST00          * Update GST
          BRANCH    EXIT,MAIN1000
          MATCH     "1",NEXTPAGE
          IF        @EQUAL
            CALL      WINCLS00
          ENDIF
          GOTO      MAIN1000
.
MAIN1400  CALL      SADJ0000           * Processing Patient status adjustment
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  IF        CFEETYP=5
            CALL      GNBF0000         * Get NZ Private bed fees 
          ELSE
            CALL      GBFE0000         * Get bed fees for a selected column no
          ENDIF
          GOTO      MAIN1000
.
MAIN1600  CALL      GDAY0000           * Get casemix daily charge for a col no
          GOTO      MAIN1000
.
MAIN1700  CALL      GADD0000           * Get casemix additional charge
          GOTO      MAIN1000
.
MAIN1800  
.         CALL      DITM0000           * Delete item from Next invoice screen
          CALL      LIST0000           * Patients list
          GOTO      MAIN1000
.
MAIN1900  CALL      CKTR0000           * Check change date/time
          GOTO      MAIN1000
.
MAIN2000  CALL      EXPPAY00           *Admission Expected Payor Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  MOVE      ONE,BDTEFLAG
          MOVE      CHNGDATE,BACKDATE
.
          CALL      ESTINV00           * Print Estimate Invoice
          BRANCH    EXIT,MAIN1000
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Invoice Estimate Complete.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      EXPPMA00           *Admission Expected Payer Account Maint.
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  MOVE      ONE,BDTEFLAG
          MOVE      CHNGDATE,BACKDATE
          MOVE      ONE,DBSFLAG
.
          CALL      PRTINV00 
          BRANCH    EXIT,MAIN1000
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Discharge Statement Complete.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      FLRECP00                * Remote script to flag receipt
          GOTO      MAIN1000
.
MAIN2500  CALL      ICDCLS00                * Remote script to ICD10 Sugg.Class
          GOTO      MAIN1000
.
MAIN2600  CALL      ASAP0000                * Assign Action Plan
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      PAYB0000                * Remote script for Inv.breakdown
          GOTO      MAIN1000
.
MAIN2800  CALL      UIVB0000                * Invoice Breakdown
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  MOVE      ONE,BDTEFLAG
          PACK      BACKDATE,CCC,CYY,CMM,CDD
          REP       " 0",BACKDATE
          MOVE      ONE,DBSFLAG
          CALL      BSTA0000                * Print Billing Statement in bulk
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Discharge Statement Complete.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      RDIRCT00      * Alert WEBTITLE and redirect
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect URL
.------------------------------------------------------------------------------
RDIRCT00  CALL      OPENHTML
          BRANCH    EXIT,RDIRCT90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                              " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      RDIRCT99
.
RDIRCT90  DISPLAY   "*** Fifo Not Found ***"
.
RDIRCT99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
+
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPOLA1,"ibapolaf"
.
          OPEN      NHIMASA2,"nhimasaf"
.
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      PATAFEA1,"patafeaf"
          OPEN      PATASDA1,"patasdaf"
          OPEN      PATBFEE1,"patbfeef"
          OPEN      NZPBFEA1,"nzpbfeaf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCERA1,"patceraf" 
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATCODE2,"patcodes" 
          OPEN      PATCMCA1,"patcmcaf" 
          OPEN      PATCMXA1,"patcmxaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATGTUA1,"patgtuaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATLDFA1,"patldfaf"
          OPEN      PATLSDA1,"patlsdaf"
          OPEN      PATTRAN1,"pattranf"        
          OPEN      PATTRAN2,"pattranf"        
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATHTRA1,"pathtraf"
          OPEN      EMRHTRA1,"emrhtraf"
          OPEN      OUTHTRA1,"outhtraf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      PATDTRA3,"patdtraf"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMCHG4,"patmchgf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR5,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATFEEP1,"patfeepf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATTFEE1,"pattfeef"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRDETC1,"oprdetcf"
          OPEN      PATCTFA1,"patctfaf"
          OPEN      PATHLFA1,"pathlfaf"
          OPEN      PATHDFA1,"pathdfaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATATRA3,"patatraf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATFIGA1,"patfigaf"
          OPEN      PATFINS1,"patfinsf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATONHA1,"patonhaf"
          OPEN      PATIRNG1,"patirnge"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PMSPX2A1,"pmspx2af"
.         OPEN      SCRMASA1,"scrmasaf"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PMSBBIA1,"pmsbbiaf"
          OPEN      PMSBIIA1,"pmsbiiaf"
          OPEN      PMSRESA1,"pmsresaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PATWVET1,"patwvetf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      VISPMAA1,"vispmaaf"
          OPEN      PMSCTCA1,"pmsctcaf"
          OPEN      COMDEPA1,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      PMSSGAA1,"pmssgaaf"
          OPEN      PATFACT1,"patfactf"
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATFAPA1,"patfapaf"
          OPEN      PATPARA1,"patparaf"
          OPEN      PATPFAA1,"patpfaaf"
          OPEN      PMSCIDA1,"pmscidaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PMSICMA1,"pmsicmaf"  
.
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSREGA4,"pmsregaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PATELGA1,"patelgaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PATABFA1,"patabfaf"
          OPEN      PATRDEA1,"patrdeaf"
          OPEN      PMSFOCA1,"pmsfocaf"
          OPEN      PATCHCO2,"patchcof"
.
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      PATHGRP1,"pathgrpf" 
          OPEN      PMSCHAA1,"pmschaaf"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRVISA1,"emrvisaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRVCDA1,"emrvcdaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files 
.
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDTRE1,"aaedtref"
.
          CALL      RDCNT000                       *Read control file
          IF        CFEETYP=9
            OPEN      PMSMTEA1,"pmsmteaf"
            OPEN      PMSMTEA4,"pmsmteaf"
          ENDIF
.
...  used in ABFAECCL
          CALL      TFILENAM                * Get file name calculating Exponent
          MOVE      TFILNAME,FNAMEN
.
...  used in PATCATBI CRMV0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEX
.
...  used in PATCATBI PTMP0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEZ
.
...  used in PATCATBI PT2P0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEY
.
...  used in NZPCATBI CRWL0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEQ
.
...  used in PABXBILL
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAME
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAM2
.
          MOVE      ONE,WEBFLAG
          RETURN
.------------------------------------------------------------
.   Open outpatient files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1
          OPEN      OUTBOKA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          RETURN 
.------------------------------------------------------------
.   Read the control file
.------------------------------------------------------------
RDCNT000  READ      CONTROLF,ZERO;*85,IBCNUGST
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*32,PTCNUBRD,*66,CINVLAY:
                                 *73,DD,MM,YY,*79,CAPPRVNO,*94,CAGECOFF:
                                 *104,PTCNMBSF,*166,CMEMB:             *C-47385
                                *183,CVIEWIP,*188,CCHKRAT,*192,CACCFEE:
                                *217,CAUDQ
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2,CHPPOST:
                                  CHTELEB,*154,CUSEMBS,*163,BEDTYP:
                             *211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN5;*189,CTHETR:
                                  *247,CSTDOWN
          READ      CONTROLF,TEN9;*212,CFEETYP,*216,CINVRIP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM:
                                    *198,PTCNPIOP,PTCNBCUT,PTCNBDOM:
                                    *211,PTCNCNDY,*239,PTCNMXCH
          READ      CONTROLF,TWENTY1;*44,PTCNIDES:
                                    *51,PTCNINVL,*60,PTCNCCRR,PTCNCLOR:
                                    *120,PTCNADDC,*136,PTCNMITM,*138,PTCNNHII:
                                    *174,PTCNDONR,*178,PTCNMPTR:
                                    *190,PTCNPCON,*200,PTCNICRA,*235,PTCNDPL8:
                                    *237,PTCNPAOF
          READ      CONTROLF,THIRTY;*132,HSTANDM,HINVDES
          READ      CONTROLF,TWENTY;*164,PTRESDAY
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,FIFTY9;*1,CDLSTEP,*23,CFUTINV,*25,CFUTCOM:
                                   *66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,SEVENTY7;*214,PTCNBTNM:
                                      *240,PTCNAXEU
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR,*250,PTCNHDPS
          READ      CONTROLF,EIGHTY8;*248,PTCNISBZ
          READ      CONTROLF,NINTY7;*246,MRCNROUN
          READ      CONTROLF,NINTY8;*127,PTCNPMIS:
                                    *130,PTCNAGST:
                                    *136,PTCNPAIH,*142,PTCNPAIT:
                                    *148,PTCNINVB
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN:
                                    *220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*71,PTCNCMAU,*73,PTCNCMDU:
                                    *99,PTCNNWCM:     * using matrix
                                    *130,PTCNAUAT:    * auto update adm.type
                                         PTCNWSPC:    * Warning for sub-seq item
                                    *177,PTCNTFEE:    * Using theatre fees
                                    *190,PTSGCOPT:    * Using suggested class.
                                    *195,PTCNLASR:
                                    *215,PTCNBINV:
                                    *226,PTCNPRWD:    * Print wrd/bed on inv.
                                    *235,PTCNQCCT:
                                    *247,PTCNCDIS
          READ      CONTROLF,HUND09;*238,PTCNPRIN     * Display zero invoice
          READ      CONTROLF,HUND10;*115,PTCNUEDI
          READ      CONTROLF,HUND12;*102,PTCNHITC,*103,PTCNHICC,*113,PTCNXCHS:
                                    *118,PTCNTRPR
          READ      CONTROLF,HUND13;*50,OPCNCONS
          READ      CONTROLF,HUND14;*153,PTCNECLO,*249,PTCNDFUP
          READ      CONTROLF,HUND16;*209,PTCNADEP:
                                    *210,PTCNICLS:
                                    *219,PTCNCLEV:
                                    *222,PTCNXCOM,*226,PTCNGPHR

          READ      CONTROLF,HUND18;*165,PTCNPPRC,*166,PTCNPITM
          READ      CONTROLF,HUND24;*123,PTCNEMDB
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND29;*1,PTCNWSDR,*61,PTCNWSIN,*88,PTCNIHCW:
                                    *89,PTCNPPIN,*90,PTCNADEB
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          MATCH     "1",PTCNTRPR
          IF        @EQUAL
            OPEN      PMSPTDA1,"pmsptdaf"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTCFN11,"mltcf1af"
            OPEN      MLTCFNA1,"mltcfnaf"
            IF        PTCNNHII=ONE
              OPEN      NZPCFNA1,"nzpcfnaf"
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            OPEN      WEBPARA1,"webparaf"
          ENDIF
.
RDCNT999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,SUPERLEV
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,IVDETAIL
          MOVE      SP70,INVOICNO
          MOVE      ZERO,INVOICEN
          MOVE      SP70,TRANSCNO
          MOVE      SP70,SBFEEKEY
          MOVE      SP70,PDIEMKEY
          MOVE      SP70,SNZBFKEY
          MOVE      SP70,CLAIMTYP
          MOVE      SP70,ADMNTYPE
          MOVE      SP70,HEALTHFN
          MOVE      SP70,NSPRUNIQ
          MOVE      SP70,STARTKEY
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,PTSTATUS
          MOVE      SP70,CODESTAT
          MOVE      SP70,CASEPAYM
          MOVE      SP70,ZEROINVC
          MOVE      SP70,NZITFLAG
          MOVE      SP70,NZPEFLAG
          MOVE      SP70,PRESFLAG
          MOVE      SP70,PLANFLAG
          MOVE      SP70,ZEROFLAG
          MOVE      SP70,PRINTPDF
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,NEXTVKEY
          MOVE      SP70,PREVVKEY
          MOVE      ZERO,UPDATETY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,TRANSNUM
          MOVE      SP70,TRNTOWRD
          MOVE      SP70,TRNTOBED
          MOVE      ZERO,FILTVTYP
          MOVE      SP70,FILTCODD
          MOVE      SP70,FILTHFND
          MOVE      SP70,FILTHFGP
          MOVE      SP70,FILTCLAM
          MOVE      ZERO,FILTOPTN
          MOVE      SP70,UPADMTYP
          MOVE      ZERO,SHOWHEAD
          MOVE      ZERO,SHOWPAYR
          MOVE      SP70,FILTHOLD
          MOVE      ZERO,GOSUBFLG
          MOVE      ZERO,EXCLMISC
.
          MOVE      SP70,PTGTU001
          MOVE      SP70,PTGTU002
          MOVE      SP70,PTMIS063
          MOVE      SP70,PTMIS073
          MOVE      SP70,PTMIS075
          MOVE      SP70,PTMIS081
          MOVE      SP70,ITEMCODE
          MOVE      ZERO,REBTAMNT
          MOVE      SP70,TRANDATE
          MOVE      SP70,TRANTIME
          MOVE      SP70,INVTODAT
          MOVE      SP70,INITDATE
          MOVE      SP70,ACTNPLAN
          MOVE      SP70,ACTNCODE
          MOVE      SP70,CHNGDATE
          MOVE      SP70,CHNGTIME
          MOVE      SP70,CHNGDESC
          MOVE      SP70,CHNGAMNT
          MOVE      ZERO,PATAMOUN
          MOVE      ZERO,REBAMOUN
          MOVE      ZERO,BFECOLNO
          MOVE      ZERO,ADDCOLNO
          MOVE      ZERO,DEFCOLNO
          MOVE      ZERO,DEFCOLAD
          MOVE      Z70,DEFRTHAL
          MOVE      ZERO,TOTALFEE
          MOVE      ZERO,BFEEAMNT
          MOVE      ZERO,ADDFAMNT
          MOVE      ZERO,PADDAMNT
          MOVE      ZERO,RADDAMNT
          MOVE      ZERO,PPORAMNT
          MOVE      ZERO,RPORAMNT
          MOVE      ZERO,DISCAMNT
          MOVE      ZERO,CPAYADJM
          MOVE      ZERO,ALLWAMNT
          MOVE      ZERO,EDAYRANG
          MOVE      ZERO,ADAYRANG
          MOVE      "9999",NEWDHOSP
          MOVE      SP70,NEWBTYPE
          MOVE      SP70,PRNTFLAG
          MOVE      SP70,SELECTID
          MOVE      ZERO,CRDNFLAG
          MOVE      ZERO,JHFLAG  
          MOVE      ZERO,DBSFLAG
          MOVE      "0",TRANFLAG
          MOVE      SP70,MULTHOSP
          MOVE      SP70,EXPPAYER
          IF        CFEETYP=5
            MOVE      "ALL   ",EXPPAYER
          ENDIF
.
          MOVE      Z70,MSCHG001
          MOVE      Z70,MSCHG002
          MOVE      Z70,MSCHG003
          MOVE      Z70,MSCHG004
          MOVE      Z70,MSCHG005
          MOVE      Z70,MSCHG006
          MOVE      Z70,MSCHG007
          MOVE      Z70,MSCHG008
          MOVE      Z70,MSCHG009
          MOVE      Z70,MSCHG010
          MOVE      Z70,MSCHG011
          MOVE      Z70,MSCHG012
          MOVE      Z70,MSCHG013
          MOVE      Z70,MSCHG014
          MOVE      Z70,MSCHG015
          MOVE      Z70,MSCHG016
          MOVE      Z70,MSCHG017
          MOVE      Z70,MSCHG018
          MOVE      Z70,MSCHG019
          MOVE      Z70,MSCHG020
          MOVE      Z70,MSCHG021
          MOVE      Z70,MSCHG022
.
          MOVE      ZERO,MSCHAMNT
.
          MOVE      SP70,MVMEDREC
          MOVE      SP70,RETURNCD
          MOVE      ZERO,MATRIXFL
          MOVE      SP70,MOVESEQN
          MOVE      SP70,MOVTOSEQ
.
          CALL      CPVSPA00
          CALL      CPVSPM00
          CALL      CPPMEX00
          CALL      CPPMPY00
.
          MOVE      SP70,DISCTYPE
          MOVE      SP70,DISCDESC
          MOVE      SP70,DISPSTEP
.
          MOVE      ZERO,CERTINDC
          MOVE      ZERO,IPATFLAG
          MOVE      ZERO,NCHACCOM
          MOVE      SP70,RECEIPTN
          MOVE      SP70,RECTRNNO
          MOVE      SP70,CHECKBOX
          MOVE      SP70,MODECODE
          MOVE      SP70,MANCHNGE
          MOVE      SP70,RACLINDC
          MOVE      ZERO,MANSAMNT
          MOVE      SP70,CKHOSPID
          MOVE      SP70,ITEMREGM
          MOVE      ZERO,MAXIBILL
          MOVE      ZERO,MAXIDAYB
          MOVE      ZERO,LINENUMB
          MOVE      SP70,PTRGM001
          MOVE      ZERO,ISBLFLAG
          MOVE      SP70,DBILFLAG
          MOVE      SP70,BFECONTR
          MOVE      ZERO,SDOWNFLG
          MOVE      SP70,PREVTRID
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      ZERO,MXBIL[F3]
            MOVE      ZERO,MXDAY[F3]
            MOVE      ZERO,IVAMT[F3]
            MOVE      SP70,ITMCD[F3]
            MOVE      SP70,RGMCD[F3]
            MOVE      SP70,BFENDARY[F3]
            MOVE      SP70,BPRNT[F3]
            MOVE      SP70,BADMN[F3]
            ADD       ONE,F3
          DO
.
          MOVE      SP70,ECLIUEBB
          MOVE      SP70,MDATE000
          MOVE      ZERO,NWAUFLAG
.
          MOVE      SP70,PRDSDATE
          MOVE      SP70,PRDEDATE
          MOVE      SP70,PRDEPSOD
          MOVE      SP70,PRDCCLSS
          MOVE      SP70,CCVERIFI
          MOVE      SP70,REASONCH
          MOVE      Z70,UDFADMIS
          MOVE      Z70,UDFDISCH
          MOVE      ZERO,ABFFLAG
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPERLEV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVOICNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ivdetail=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IVDETAIL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exppayer=",QRYNAME
          IF        @EQUAL
            PACK      EXPPAYER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transcno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSCNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntobed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOBED
            PACK      TRNTOBED,TRNTOBED,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntowrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOWRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printpdf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTPDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "snzbfkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SNZBFKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbfeekey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SBFEEKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pdiemkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PDIEMKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admntype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMNTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nspruniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NSPRUNIQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "healthfn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HEALTHFN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbwindow=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SBWINDOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtvtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTVTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtcodd=",QRYNAME
          IF        @EQUAL
            PACK      FILTCODD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthfgp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHFGP
            PACK      FILTHFGP,FILTHFGP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthfnd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHFND
            PACK      FILTHFND,FILTHFND,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTCLAM
            PACK      FILTCLAM,FILTCLAM,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtoptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTOPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptstatus=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTSTATUS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "codestat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CODESTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casepaym=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEPAYM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "zeroinvc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ZEROINVC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptgtu002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTGTU002
            PACK      PTGTU002,PTGTU002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis063=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS063
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis073=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS073
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis075=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS075
            REP       " 0",PTMIS075
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis081=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS081
            REP       " 0",PTMIS081
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ITEMCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rebtamnt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REBTAMNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME     *  this is for selection list  
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "invtodat=",QRYNAME     *  this is for selection list  
          IF        @EQUAL
            CALL      SCHDAT00             
            PACK      INVTODAT,KEY8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "initdate=",QRYNAME
          IF        @EQUAL
            CALL      SCHDAT00             
            PACK      INITDATE,KEY8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actnplan=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNPLAN
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "actncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCODE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "chngdate=",QRYNAME     *  this is for selection list  
          IF        @EQUAL
            CALL      SCHDAT00             
            PACK      CHNGDATE,KEY8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGTIME
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "chngdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGDESC
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "chngamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "patamoun=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PATAMOUN
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "rebamoun=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REBAMOUN
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "bfecolno=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,BFECOLNO
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "addcolno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDCOLNO
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "defcolno=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,DEFCOLNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bfeeamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BFEEAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "totalfee=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TOTALFEE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "addfamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDFAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "pporamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PPORAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "rporamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RPORAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "discamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "cpayadjm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPAYADJM
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "allwamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLWAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "paddamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PADDAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "raddamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RADDAMNT
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "edayrang=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EDAYRANG
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "adayrang=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADAYRANG
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "newdhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWDHOSP
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "newbtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBTYPE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "prntflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRNTFLAG
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "selectid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELECTID
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "mschamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MSCHAMNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mschg",QRYNAME     *  this is for selection list  
          IF        @EQUAL
            CALL      MISCH000            
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvmedrec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MVMEDREC
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "returncd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "multhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vspay",QRYNAME     *  this is for selection list  
          IF        @EQUAL
            CALL      SPVSP000            
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vspma",QRYNAME     *  this is for account selection list  
          IF        @EQUAL
            CALL      SPVSPM00            
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "moveseqn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVESEQN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "movtoseq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVTOSEQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disctype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCTYPE
            GOTO      SETPAR99
          ENDIF     
.           
          MATCH     "dispstep=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPSTEP
            GOTO      SETPAR99
          ENDIF     
.           
          MATCH     "discdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCDESC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "receiptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECEIPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rectrnno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECTRNNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checkbox",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHECKBOX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "modecode",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MODECODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upadmtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPADMTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defrthal=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFRTHAL
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "showhead=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWHEAD
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "showpayr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWPAYR
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "filthold=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOLD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "raclindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "isblflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ISBLFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmext",QRYNAME
          IF        @EQUAL
            CALL      SPPME000
            BRANCH    EXIT,SETPAR99
          ENDIF
.
          MATCH     "ckhospid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CKHOSPID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTRGM001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpyr",QRYNAME
          IF        @EQUAL
            CALL      SPPMPY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mxbil",QRYNAME
          IF        @EQUAL
            CALL      STAMAX00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mxday",QRYNAME
          IF        @EQUAL
            CALL      STADAY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ivamt",QRYNAME
          IF        @EQUAL
            CALL      STIAMT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itmcd",QRYNAME
          IF        @EQUAL
            CALL      STITMC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemregm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ITEMREGM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "maxibill=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAXIBILL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "maxidayb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAXIDAYB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linenumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINENUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dbilflag",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DBILFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bfecontr",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BFECONTR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prt00",QRYNAME
          IF        @EQUAL
            CALL      STPRT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adm00",QRYNAME
          IF        @EQUAL
            CALL      STADM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gosubflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,GOSUBFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclmisc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXCLMISC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevtrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecliuebb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECLIUEBB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdate000=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11
            REP       "+ ",KEY11
            UNPACK    KEY11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      MDATE000,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdsdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDSDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdedate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDEDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdepsod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDEPSOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdcclss=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDCCLSS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ccverifi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CCVERIFI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasonch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASONCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "udfadmis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UDFADMIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "udfdisch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UDFDISCH
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN        
+
.------------------------------------------------------------
. Set parameters for print billing statement
.------------------------------------------------------------
STPRT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPRT999 IF EQUAL
          MOVE      QRYDATA,BPRNT[F3]
STPRT999  RETURN
+
.----------------------------------------------------------------
. Set parameters for admission no for printing billing statement
.----------------------------------------------------------------
STADM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STADM999 IF EQUAL
          MOVE      QRYDATA,BADMN[F3]
STADM999  RETURN
+
.------------------------------------------------------------
. Set parameters for Maximum Billing item amount
.------------------------------------------------------------
STAMAX00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STAMAX99 IF EQUAL
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,MXBIL[F3]
STAMAX99  RETURN
+
.------------------------------------------------------------
. Set parameters for Per day item amount
.------------------------------------------------------------
STADAY00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STADAY99 IF EQUAL
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,MXDAY[F3]
STADAY99  RETURN
+
.------------------------------------------------------------
. Set parameters for item code
.------------------------------------------------------------
STITMC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STITMC99 IF EQUAL
          MOVE      QRYDATA,ITMCD[F3]
STITMC99  RETURN
+
.------------------------------------------------------------
. Set parameters for Per day item amount
.------------------------------------------------------------
STIAMT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STIAMT99 IF EQUAL
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,IVAMT[F3]
STIAMT99  RETURN
+
.------------------------------------------------------------
. SCDAT000 - Setup change date for stepdown
.------------------------------------------------------------
SCHDAT00  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
          ELSE
            MOVE      QRYDATA,KEY8     
          ENDIF
SCHDAT99  RETURN
+
.------------------------------------------------------------
.     Miscellaneou charge items
.------------------------------------------------------------
MISCH000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,MISCH010,MISCH020,MISCH030,MISCH040,MISCH050:
                       MISCH060,MISCH070,MISCH080,MISCH090,MISCH100:
                       MISCH110,MISCH120,MISCH130,MISCH140,MISCH150:
                       MISCH160,MISCH170,MISCH180,MISCH190,MISCH200:
                       MISCH210,MISCH220
          GOTO      MISCH9999
.
MISCH010  MOVE      QRYDATA,MSCHG001
          GOTO      MISCH9999
.
MISCH020  MOVE      QRYDATA,MSCHG002
          GOTO      MISCH9999
.
MISCH030  MOVE      QRYDATA,MSCHG003
          GOTO      MISCH9999
.
MISCH040  MOVE      QRYDATA,MSCHG004
          GOTO      MISCH9999
.
MISCH050  MOVE      QRYDATA,MSCHG005
          GOTO      MISCH9999
.
MISCH060  MOVE      QRYDATA,MSCHG006
          GOTO      MISCH9999
.
MISCH070  MOVE      QRYDATA,MSCHG007
          GOTO      MISCH9999
.
MISCH080  MOVE      QRYDATA,MSCHG008
          GOTO      MISCH9999
.
MISCH090  MOVE      QRYDATA,MSCHG009
          GOTO      MISCH9999
.
MISCH100  MOVE      QRYDATA,MSCHG010
          GOTO      MISCH9999
.
MISCH110  MOVE      QRYDATA,MSCHG011
          GOTO      MISCH9999
.
MISCH120  MOVE      QRYDATA,MSCHG012
          GOTO      MISCH9999
.
MISCH130  MOVE      QRYDATA,MSCHG013
          GOTO      MISCH9999
.
MISCH140  MOVE      QRYDATA,MSCHG014
          GOTO      MISCH9999
.
MISCH150  MOVE      QRYDATA,MSCHG015
          GOTO      MISCH9999
.
MISCH160  MOVE      QRYDATA,MSCHG016
          GOTO      MISCH9999
.
MISCH170  MOVE      QRYDATA,MSCHG017
          GOTO      MISCH9999
.
MISCH180  MOVE      QRYDATA,MSCHG018
          GOTO      MISCH9999
.
MISCH190  MOVE      QRYDATA,MSCHG019
          GOTO      MISCH9999
.
MISCH200  MOVE      QRYDATA,MSCHG020
          GOTO      MISCH9999
.
MISCH210  MOVE      QRYDATA,MSCHG021
          GOTO      MISCH9999
.
MISCH220  MOVE      QRYDATA,MSCHG022
          GOTO      MISCH9999
.
MISCH999  RETURN
+
.------------------------------------------------------------
. Output Patient Enquiry Page
.------------------------------------------------------------
GETPAT00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      GETPAT50 IF EQUAL
          MATCH     "X",UPDTTYPE          * First time displaying Invoice Est.
          GOTO      GETPAT50 IF EQUAL
.
          MATCH     "D",UPDTTYPE          * Check for deleting item
          GOTO      GETPAT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE          * Check for updating item
          GOTO      GETPAT20 IF EQUAL
.
          MATCH     "F",UPDTTYPE          * Check for upd.item Storage/Forward
          GOTO      GETPAT20 IF EQUAL
.
          MATCH     "S",UPDTTYPE          * Add discount
          GOTO      GETPAT30 IF EQUAL
.
          MATCH     "J",UPDTTYPE          * Fixed Fee/Funder Contr.Adjustment
          GOTO      GETPAT32 IF EQUAL
.
          MATCH     "C",UPDTTYPE          * Calculate doctor charge
          GOTO      GETPAT40 IF EQUAL
.
          MATCH     "R",UPDTTYPE          * Remove doctor charge
          GOTO      GETPAT44 IF EQUAL
.
          MATCH     "E",UPDTTYPE          * Deleting item from Estimation Inv.
          GOTO      GETPAT12 IF EQUAL
.
          MATCH     "T",UPDTTYPE          * Deleting records from Est.Inv.
          GOTO      GETPAT14 IF EQUAL
.
          MATCH     "B",UPDTTYPE          * Payer breakdown
          GOTO      GETPAT50 IF EQUAL
.
          MATCH     "I",UPDTTYPE          * Add items for Ind.Services billing
          GOTO      GETPAT46 IF EQUAL
.
          GOTO      GETPAT90
.
.        Cancelling item 
.
GETPAT10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,GETPAT98
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ELSE
            IF        IBCNMHOS=1
              MOVE      SP10,PTHSDCLM
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
            ENDIF
          ENDIF
.
          IF        PVITYPE=3
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1               * Read the admission file
            BRANCH    OVRCD,GETPAT98
          ENDIF
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GETPAT98
          CALL      RDPMPX21
          BRANCH    OVRCD,GETPAT98
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,GETPAT98
.
          CALL      DELE0000                * Delete MBS/Misc. Item
.
.                                                                     *C-207386
          MATCH     "1",ECLIUEBB
          IF        !@EQUAL
            IF        CTHETR=1 & MBSFLAG=1 & FOUNDMBS = 0
              CALL      WARN0000
              GOTO      GETPAT98
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
.         Delete item from Estimate Invoice
.
GETPAT12  COMPARE   NINE,CFEETYP
          GOTO      GETPAT99 IF NOT EQUAL   * Not using Johns Hopkins bed fees
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTE1
          BRANCH    OVRCD,GETPAT98
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RDPMMTE1
          IF        OVRCD=0
            CALL      DEPMMTE1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT14  CALL      DEREC000                * Delete any existing records
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
.         Updating item
.
GETPAT20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,GETPAT98
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ELSE
            IF        IBCNMHOS=1
              MOVE      SP10,PTHSDCLM
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
            ENDIF
          ENDIF
.
          IF        PVITYPE=3
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1               * Read the admission file
            BRANCH    OVRCD,GETPAT98
          ENDIF   
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          BRANCH    OVRCD,GETPAT98
.
          MATCH     "F",UPDTTYPE            * Check for upd.item Storage/Forward
          IF        @EQUAL
            CALL      UPSTF000              * Updating Storage & Forward details
            GOTO      GETPAT28
          ENDIF
.
          CALL      GETMBS00                * read matching MBS item in patmmbsf
.
          MATCH     Z70,MSCHG001            * check if date has changed
          IF        !@EQUAL
            UNPACK    MSCHG001,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      PMMITDAT,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PMMITDAT
          ENDIF
.
          MATCH     Z70,MSCHG003            * check if description has changed
          IF        !@EQUAL
            MOVE      MSCHG003,PMMIDESC
          ENDIF
.
          MATCH     Z70,MSCHG004
          IF        !@EQUAL
.           IF        CFEETYP<>9
.             CALL      FDESC000                * Fix description
.           ENDIF
            SQUEEZE   MSCHG004
            MOVE      MSCHG004,PMMISERV
          ELSE
            IF        MSCHAMNT<>0
              MOVE      MSCHAMNT,PMMISERV
            ENDIF
          ENDIF
.
          MATCH     Z70,MSCHG006
          IF        !@EQUAL
            MOVE      MSCHG006,PMMIAMTP
            IF        PMMISERV<>1
              DIV       PMMISERV,PMMIAMTP   * amount for one unit
            ENDIF
            MATCH     "7",PMMIRTYP        * Discount?
            IF        @EQUAL
              MOVE      MSCHG006,PMMIAMTP
              MULT      "-1",PMMIAMTP
            ENDIF
          ENDIF
.
          MATCH     Z70,MSCHG007
          IF        !@EQUAL
            MOVE      MSCHG007,PMMIRBAT
            IF        PMMISERV<>1
              DIV       PMMISERV,PMMIRBAT   * amount for one unit
            ENDIF
          ENDIF
.
          MATCH     Z70,MSCHG005
          IF        !@EQUAL
            MOVE      MSCHG005,PMMIREFN
          ENDIF
.
          IF        CFEETYP=5
            CALL      FNZI0000                * Set NZ private billing fields
          ELSE
            MOVE      PMMIAMTP,PMMIAMTT
            ADD       PMMIRBAT,PMMIAMTT
            IF        PMMISERV<>0
              MULT      PMMISERV,PMMIAMTT
            ENDIF
          ENDIF
.
          MATCH     PMMIVISN,DMMADMN                          * start *I-206410
          IF        @EQUAL
            MATCH     Z70,MSCHG008
            IF        !@EQUAL
              PACK      PMMISVTM,MSCHG008,SP8
              MATCH     SP8,PMMISVTM
              IF        @EQUAL
                MOVE      "00:00",MMSTIM
                MOVE      "00:00",MMETIM
              ELSE
                MOVE      PMMISVTM,MMSTIM
                MATCH     Z70,MSCHG009
                IF        !@EQUAL
                  UNPACK    MSCHG009,KEY5,KEY3  * truncate End Time
                  MOVE      KEY5,MMETIM
                ENDIF
              ENDIF
              CALL      UPMMBS1             * update patmmbsf
            ENDIF
          ENDIF
.
GETPAT28  CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          MOVE      CURRDATE,PMMIDUPD
          CALL      UPPMMTI1
.
          IF        PVITYPE=THREE
            MOVE      "C",DIM1
            MOVE      PMMIITEM,MCHARGE
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            CALL      PROTRK00
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT30  CALL      ADISC000                * Add discount - JH
          GOTO      GETPAT99
.
GETPAT32  CALL      FADJ0000                * Fixed amount adjustment
          GOTO      GETPAT99
.
GETPAT40  MOVE      ZERO,PROGFLAG
          IF        CFEETYP=9
            CALL      PTDRCHRG              * Calculate doctor attendance fees
          ENDIF
          GOTO      GETPAT99
.
GETPAT44  CALL      RDOC0000                * Remove doctor attendance fees
          GOTO      GETPAT99
.
GETPAT46  CALL      AREG0000                * Add items of the Regime
          CALL      UAPY0000                * Update Invoice breakdown
          GOTO      GETPAT99
.
GETPAT50  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      ZERO,RESPFLAG
          MOVE      ZERO,DSCHFLAG
          MOVE      SP70,DOCTCODE
          MOVE      ZERO,PREBFLAG
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
          CALL      RDPMPX21
.
          IF        MASTFLAG=1
            MOVE      "Can't find Patient Master details",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT98
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          MATCH     SP70,KEY8
          IF        @EQUAL
            MOVE      "Invalid Visit number",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT98
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          MOVE      OVRCD,MISSFLAG
          CALL      RDPMVX11
          MOVE      OVRCD,MISSFLAG
.
          MATCH     "B",UPDTTYPE
          GOTO      GETPAT65 IF EQUAL       * Payer breakdown
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            MOVE      ZERO,PTELPPRI
            MOVE      ZERO,PTELPPUT
            MOVE      ZERO,PTELPSHA
            MOVE      ZERO,PTELPSUT
            MOVE      ZERO,PTELPSDY
            MOVE      ZERO,PTELPCCU
            MOVE      ZERO,PTELPSDU
            MOVE      ZERO,PTELPHSP
            MOVE      ZERO,PTELPHSU
            MOVE      ZERO,PTELPTHE
            MOVE      ZERO,PTELPTUT
            MOVE      ZERO,PTELXCSS
            MOVE      ZERO,PTELXCSD
          ENDIF
.
          MATCH     "001",TEMPLATE          * inpatient next invoice
          GOTO      GETPAT52 IF EQUAL
          MATCH     "019",TEMPLATE          * patient Only next invoice
          GOTO      GETPAT52 IF EQUAL
          MATCH     "025",TEMPLATE          * NWAU Calculations 
          GOTO      GETPAT52 IF EQUAL
          MATCH     "052",TEMPLATE          * Sub-Acute NWAU Calculations 
          GOTO      GETPAT52 IF EQUAL
          MATCH     "050",TEMPLATE          * independence Service Billing
          GOTO      GETPAT52 IF EQUAL
          MATCH     "036",TEMPLATE
          GOTO      GETPAT52 IF EQUAL
          MATCH     "012",TEMPLATE
          GOTO      GETPAT52 IF EQUAL       * NWAU     
          MATCH     "027",TEMPLATE
          GOTO      GETPAT52 IF EQUAL       * NWAU     
          MATCH     "026",TEMPLATE
          GOTO      GETPAT52 IF EQUAL       * NWAU     
          MATCH     "011",TEMPLATE
          GOTO      GETPAT52 IF EQUAL       * Matrix template
.
          MATCH     "031",TEMPLATE          * JH/SX inpatient next invoice
          GOTO      GETPAT52 IF EQUAL
          MATCH     "032",TEMPLATE          * JH/SX inpatient next invoice
          GOTO      GETPAT52 IF EQUAL
          MATCH     "034",TEMPLATE          * JH inpatient Estimate next invoice
          GOTO      GETPAT54 IF NOT EQUAL
.
GETPAT52  CALL      RDMISS1
          IF        OVRCD=1
            MOVE      "Invalid Visit number",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT98
          ENDIF
.
.        if the Raise Invoice button should be inactive
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      ACLAIM,INDMCLAM
          MOVE      "I",INDMSYST
          MOVE      ACARE,INDMCTYP
          MOVE      PMVXIDUS,INDMILOS
.
          MOVE      URNUMBER,INDMURNO
          MOVE      ADMISSNO,INDMADNO
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
.         Check if we need to check Hospital id
.
          MATCH     "1",CKHOSPID
          IF        @EQUAL
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      GETPA97A IF NOT EQUAL
            ENDIF
          ENDIF
.
GETPAT54  COMPARE   ONE,MISSFLAG
          IF        @EQUAL
            MOVE      "Invalid Visit number",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT98
          ENDIF
.
.         COMPARE   "01",REPORTNO
.         GOTO      GETPAT80 IF NOT EQUAL
          MATCH     "002",TEMPLATE
          GOTO      GETPAT70 IF EQUAL
          MATCH     "003",TEMPLATE
          GOTO      GETPAT70 IF EQUAL
          MATCH     "004",TEMPLATE
          GOTO      GETPAT70 IF EQUAL
          MATCH     "010",TEMPLATE
          GOTO      GETPAT70 IF EQUAL
          MATCH     "029",TEMPLATE
          GOTO      GETPAT56 IF EQUAL          * Emergency Procedure item
          MATCH     "039",TEMPLATE
          GOTO      GETPAT70 IF EQUAL          * Defence force
          MATCH     "048",TEMPLATE
          GOTO      GETPAT56 IF EQUAL          * Emergency Item
          MATCH     "049",TEMPLATE
          GOTO      GETPAT80 IF EQUAL          * Visit based comments
          MATCH     "04",TEMPLATE
          GOTO      GETPAT70 IF EQUAL          * Extra compensable
.
          MATCH     "001",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * display invoice
          MATCH     "019",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * display patient invoice only
          MATCH     "050",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * Independence Billing service
          MATCH     "051",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * Independence Billing service
          MATCH     "036",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * display invoice for Disc.Bill.
          MATCH     "021",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * display invoice
          MATCH     "031",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * JH display invoice
          MATCH     "032",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * JH display invoice
          MATCH     "033",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * JH/SX inv.Estimate Billing Date
          MATCH     "034",TEMPLATE
          GOTO      GETPAT65 IF EQUAL          * JH/SX display invoice Estimate 
....
          MATCH     "015",TEMPLATE
          GOTO      GETPAT80 IF EQUAL          * invoice estimate
          MATCH     "024",TEMPLATE
          GOTO      GETPAT56 IF EQUAL          * SX Pack item
          MATCH     "009",TEMPLATE
          GOTO      GETPAT56 IF EQUAL          * Update Item
          MATCH     "018",TEMPLATE
          GOTO      GETPAT56 IF EQUAL
.
          MATCH     "022",TEMPLATE             * Fixed Funder Contribution adj.?
          GOTO      GETPAT55 IF EQUAL
.
          MATCH     "023",TEMPLATE             * Fixed fee adjustment?
          GOTO      GETPAT80 IF NOT EQUAL
.
GETPAT55  PACK      KEY11,ADMISSNO,NSPRUNIQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,GETPAT97
          GOTO      GETPAT88
.
GETPAT56  MATCH     SP70,TRANSNUM
          GOTO      GETPAT88 IF EQUAL
.
          PACK      KEY14,ADMISSNO,TRANSNUM,SP70
          CALL      RDPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      GETPAT60 IF EQUAL
.
.         Check Rebate portion item
.
          MATCH     "1",PTCNPPIN
          GOTO      GETPAT91 IF NOT EQUAL  * Not using New Pat Inv.functionality
.
          MOVE      PVITYPE,PINVSYS
          IF        PVITYPE=9
            MOVE      ONE,PINVSYS          * for patient events, set system =1
          ENDIF
          MOVE      SP70,PTHTTREF
          PACK      KEY22,ADMISSNO,PTHTTREF,TRANSNUM,SP70
          CALL      RDHT1000
          BRANCH    OVRCD,GETPAT91
.
          MOVE      ONE,PREBFLAG
          MOVE      PTHTRECT,PMMIRTYP
          MOVE      PTHTITEM,PMMIITEM
          PACK      PMMITDAT,PTHTFCEN,PTHTFYER,PTHTFMON,PTHTFDAY
          REP       " 0",PMMITDAT
          MOVE      PTHTUNIQ,PMMIUNIQ
          MOVE      SP70,PMMISVTM
.
          MOVE      PTHTDESC,PMMIDESC
          MOVE      PTHTRBAT,PMMIRBAT
          MOVE      PTHTAMTP,PMMIAMTP
          MOVE      PTHTSERV,PMMISERV
          MOVE      PTHTRCPT,PMMIREFN
          MOVE      SP70,PMMISUNQ
.
GETPAT60  CALL      CLNZSP00            * Clear SX Procedure details
          MATCH     SP70,PMMISUNQ
          IF        !@EQUAL
            PACK      KEY11,ADMISSNO,PMMISUNQ,SP70
            CALL      RDNZSPR1
          ENDIF
.               
          CALL      GETMBS00                * read matching MBS item in patmmbsf
.
          GOTO      GETPAT88
.
.         Validating backdated invoice
.
GETPAT65  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETPAT98
.
          MATCH     SP10,CHNGDATE          * Check for backdated invoice date
          GOTO      GETPAT67 IF EQUAL
.
          REP       " 0",CHNGDATE
          MATCH     ADATE,CHNGDATE
          GOTO      GETPAT94 IF LESS
.
          REP       " 0",ALACDTE
          MATCH     ALACDTE,CHNGDATE
          GOTO      GETPAT95 IF LESS
          COMPARE   THREE,ASTAT
          GOTO      GETPAT80 IF NOT EQUAL
.
          MOVE      SP10,DDATE
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
.
          MATCH     CHNGDATE,DDATE
          GOTO      GETPAT96 IF LESS
          GOTO      GETPAT80
.
GETPAT67  MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          PACK      CHNGDATE,CCENT,CYEAR,CMON,CDAY
          IF        ASTAT=3
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,CHNGDATE
            ENDIF
          ENDIF
          REP       " 0",CHNGDATE
          GOTO      GETPAT80
.
GETPAT70  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MATCH     Z70,PMEXT002
            IF        !@EQUAL
              PACK      KEY11,ADMISSNO,PMEXT002,SP70
              CALL      RDPMEXT1
              IF        OVRCD=1
                CALL      CLPMSEXT         * Clear fields
              ENDIF
              GOTO      GETPAT80
            ENDIF
          ENDIF
.
          CALL      VALC0000              * Validate claim code
          BRANCH    EXIT,GETPAT98
.
GETPAT80  
          MOVE      SP70,DDATE
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
.
          MATCH     "033",TEMPLATE
          IF        @EQUAL
            MATCH     "X",UPDTTYPE          * First time displaying Invoice Est.
            IF        @EQUAL
              CALL      ESCHR000            * Get Estimate doctor charges 
              MOVE      ZERO,EXIT
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          MOVE      OVRCD,RESPFLAG
          IF        OVRCD=1
            CALL      CLRRES00             * PERSON RESP FOR A/C NAME
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,GETPAT86
.
          PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          IF        OVRCD=1
            CALL      CLPMSPYR
          ENDIF
.
          MATCH     "050",TEMPLATE        * Independence Services billing
          GOTO      GETPAT84 IF EQUAL
.
          MATCH     "B",UPDTTYPE
          GOTO      GETPAT86 IF NOT EQUAL
.
          CALL      CISB0000            * Validation for Independence Services
          BRANCH    EXIT,GETPAT98
.
GETPAT84
          MATCH     "Y",PTMICMXP        * No casepayment for Independence Serv
          GOTO      GETPA97B IF EQUAL
          MATCH     SP70,PTMIPCMX
          GOTO      GETPA97B IF NOT EQUAL
.
          MOVE      ONE,ISBLFLAG
          CALL      AREG0000                * Add items of the Regime
          PACK      SAVKEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      UAPY0000            * Update Invoice breakdown
.
          UNPACK    SAVKEY19,PMPYR001,PMPYR003,PMPYR018
          MOVE      SAVKEY19,KEY19      * Reposition
          CALL      RDPMPYR1
          IF        OVRCD=1
            CALL      CLPMSPYR
          ELSE
            MOVE      "  0",PMPBICNT           * zero for Accommodation
            PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,PMPBICNT,SP70
            CALL      RDPMPBR1
            IF        OVRCD=1
              CALL      CLPMSPYR
            ENDIF
          ENDIF
.
GETPAT86  CALL      ITMN0000      * Get number of items
          CALL      PATNAM00
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
GETPAT88  CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GETPAT98
.
          CALL      WEBBOD00   * Output Templated Body of HTML 
          CALL      WEBEND00   * Output End of Web Page
          GOTO      GETPAT98
.
GETPAT90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT91  MOVE      "Invalid Misc.Item.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT92  MOVE      "Patient was admitted today.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT93  MOVE      "Patient does not have an Invoice Pending.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT94  MOVE      "Patient was admitted after this date.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT95  MOVE      "Patient has already been invoiced for this date.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT96  MOVE      "Patient has already discharged for this date.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT97  MOVE      "Invalid Procedure.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPA97A  MOVE      "Visit Not for Current Hospital.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPA97B  MOVE      "Patient must be Per-diem.",WEBTITLE
          CALL      WEBERR00
          GOTO      GETPAT98
.
GETPAT98  MOVE      ONE,EXIT
GETPAT99  RETURN
+
.------------------------------------------------------------
.         Updating Storage and Forward details
.------------------------------------------------------------
UPSTF000  MATCH     Z70,MSCHG014
          IF        !@EQUAL
            MOVE      MSCHG014,PMMIACOI      * After care override indicator
          ENDIF
.
          MATCH     Z70,MSCHG015
          IF        !@EQUAL
            MOVE      MSCHG015,PMMIDSOV      * Duplicate Service Override
          ENDIF
.
          MATCH     Z70,MSCHG016
          IF        !@EQUAL
            PACK      PMMISTXT,MSCHG016,SP70  * Service Text
          ENDIF
.
          MATCH     Z70,MSCHG017
          IF        !@EQUAL
            PACK      PMMILSPN,MSCHG017,SP70  * LSPN
          ENDIF
.
          MATCH     Z70,MSCHG018
          IF        !@EQUAL
            MOVE      MSCHG018,PMMIMPOV      * Multi Procedure Override
          ENDIF
.
          MATCH     Z70,MSCHG019
          IF        !@EQUAL
            PACK      PMMINMPT,MSCHG019,SP70  * Number of Patients
          ENDIF
.
          MATCH     Z70,MSCHG020
          IF        !@EQUAL
            PACK      PMMISDCD,MSCHG020,SP70  * Self Deem Code (Cat Sd)
          ENDIF
.
          MATCH     Z70,MSCHG021
          IF        !@EQUAL
            PACK      PMMITDUR,MSCHG021,SP70  * Time Duration
          ENDIF
.
          MATCH     Z70,MSCHG022
          IF        !@EQUAL
            PACK      PMMIROVR,MSCHG022,SP70  * Restrictive Override code
          ENDIF
.
UPSTF999  RETURN
+
.------------------------------------------------------------
.         Validation for Independence Services billing
.------------------------------------------------------------
CISB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,CISB9000
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,CISB9000
.
          PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,CISB8000
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CISB8000
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CISB8100
.
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
          PACK      KEY30,AADMNO,SP20         * Position read on the admission
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CISB8100
          MATCH     AADMNO,TADMN
          GOTO      CISB8100 IF NOT EQUAL
          CMATCH    ANSA,TMOVE
          GOTO      CISB8100 IF NOT EQUAL     * First record must be "A"
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1                       * Get description again
          BRANCH    OVRCD,CISB8100
.
          MOVE      ONE,TOTDAY
          CALL      GTBF0000             * Get bed fees
          BRANCH    NOFEE,CISB8200       * Rates not setup
          COMPARE   "0",BFENDDY
          GOTO      CISB1000 IF EQUAL
          COMPARE   "999",BFENDDY
          GOTO      CISB8200 IF NOT EQUAL
.
CISB1000  MOVE      ZERO,EXIT
          GOTO      CISB9999
.
CISB8000  MOVE      "Invalid Payer record.",WEBTITLE
          CALL      WEBERR00
          GOTO      CISB9000
.
CISB8100  MOVE      "Invalid Bed Fees Setup for Independence Billing.",WEBTITLE
          CALL      WEBERR00
          GOTO      CISB9000
.
CISB8200  MOVE      "Bed Fees NOT Setup for Independence Billing.",WEBTITLE
          CALL      WEBERR00
          GOTO      CISB9000
.
CISB9000  MOVE      ONE,EXIT
CISB9999  RETURN
+
.-----------------------------------------------------------------------
.  Add items of the Regime for Independent Service Billing
.-----------------------------------------------------------------------
AREG0000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,AREG9999
.
          MOVE      ALACDTE,FROMDATE
          MOVE      CHNGDATE,TODATE
          REP       " 0",TODATE
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,AREG9999
            MOVE      DDATE,TODATE
          ENDIF
          MOVE      ZERO,NBRDAYS
.
.         Check for Add Misc.Charges item with Quantity of zero
.
          MATCH     "1",PTCNISBZ
          IF        !@EQUAL
            DAYSEP    FROMDATE,TODATE,NBRDAYS * LOS include leaves
            COMPARE   ZERO,NBRDAYS
            GOTO      AREG9999 IF EQUAL
          ENDIF
.
.         Write all items of Regime with correct quantity
.
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSREGA1,"pmsregaf"
          PACK      KEY10,ADMISSNO,SP70   * get regime code
          CALL      RSPTRGM1
          CALL      RKPTRGM1
          BRANCH    OVRCD,AREG9999
          MATCH     ADMISSNO,PTRGADMN
          GOTO      AREG9999 IF NOT EQUAL
.
          CALL      DCLM0000              * get default claim code
.
          PACK      KEY13,PTRGREGM,SP70
          CALL      RSPMREG1
AREG2000  CALL      RKPMREG1
          BRANCH    OVRCD,AREG8000
.
          MATCH     PTRGREGM,PMREREGM
          GOTO      AREG8000 IF NOT EQUAL      * different regime
          MATCH     "1",PMREITYP
          GOTO      AREG2000 IF NOT EQUAL
.
          CALL      DITM0000                   * Delete/Add item
          GOTO      AREG2000                   * next item
.
AREG8000  MOVE      ZERO,EXIT
AREG9999  RETURN
+
.------------------------------------------------------------
.         Delete/Add item
.------------------------------------------------------------
DITM0000  MOVE      "3",PMMIRTYP
          PACK      KEY15,ADMISSNO,PMMIRTYP,SP70
          CALL      RSPMMTI2
DITM1000  CALL      RKPMMTI2
          BRANCH    OVRCD,DITM8000
.
          MATCH     ADMISSNO,PMMIVISN       * Same visit number?
          GOTO      DITM8000 IF NOT EQUAL
          MATCH     "3",PMMIRTYP
          GOTO      DITM8000 IF NOT EQUAL
.
          MATCH     PMMIITEM,PMREITMN
          GOTO      DITM1000 IF NOT EQUAL   * try next record
          MATCH     "1",PMMIINCT
          GOTO      DITM1000 IF NOT EQUAL   * Item not from Regime
.
.         Item is already in the tobe invoiced,
.         if 'Add Item with zero quantity' is set to Yes - Do not delete item.
.         if it's set to No - Delete item and Add item with Quatity equal to the
.         Current LOS
.
          MATCH     "1",PTCNISBZ
          GOTO      DITM8200 IF EQUAL    * parameter Add item with Zero Quantity
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
.
DITM8000  CALL      AITM0000                   * Add item with updated quantity
          GOTO      DITM9999
.
DITM8200  MOVE      ALACDTE,PMMITDAT
          CALL      UPPMMTI2
.
DITM9999  RETURN
+
.------------------------------------------------------------
.         Add item with quantity equals to curent LOS
.------------------------------------------------------------
AITM0000  MOVE      ZERO,EXIT
.
          MOVE      ALACDTE,PMMITDAT      *  Use the ALACDTE as Item date
          REP       " 0",PMMITDAT
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMREITMN,PMMIITEM
          MOVE      PMMIITEM,MCHARGE
          MOVE      MISCDATE,CURRDATE   * set Current date to Item date
          CALL      GETMSC00            * Get the new misc. charge
          PACK      CURRDATE,CCC,CYY,CMM,CDD    * restore back to actual date
          REP       " 0",CURRDATE
          BRANCH    EXIT,AITM9999
.
          MOVE      ADMISSNO,KEY8
AITM4000  CALL      TRVISA1               * Get the next transaction number
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      AITM4000 IF EQUAL
.
          MOVE      ADMISSNO,PMMIVISN
          MOVE      URNUMBER,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      THREE,PMMIRTYP
          MOVE      NBRDAYS,PMMISERV
.
          MOVE      ZERO,PMMIGSTM
          UNPACK    SP70,PMMIDESC,PMMIDES2
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
.
          MOVE      PTMCGSTA,PMMIGSTA
          MOVE      PTMCGSTC,PMMIGSTC
          MOVE      MDESC,PMMIDESC
          MOVE      MITMTYP,PMMIRTYP
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MPATPOR,PMMIAMTP
          MOVE      MHFPOR,PMMIRBAT
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
          MOVE      ONE,PMMIINVN
.
          UNPACK    SP70,PMMIBTCH,PMMIMVBR,PMMIUNIQ,PMMICNTR,PMMISUNQ:
                         PMMITDOC,PMMIODOC
          UNPACK    SP70,PMMIINCT,PMMISUBN,PMMIEDAD,PMMISVTM,PMMICCON
          UNPACK    SP70,PMMIITYP,PMMIREFN,PMMISESS
          MOVE      "1",PMMIINCT          * flag Item from Regime
.
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR        * User id
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      WRPMMTI1
.
          MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          MOVE      PVITRAN,ATRANNO      * next transaction number
          PACK      PTMIWEBU,WBSEUID,SP70
          CALL      UPLMISS1
.
AITM9999  RETURN
+
.------------------------------------------------------------
.         Fix NZ private billing item fields
.------------------------------------------------------------
FNZI0000  MATCH     Z70,MSCHG003
          IF        !@EQUAL
            MOVE      MSCHG003,PMMIDESC     * Item Inclusion type
          ENDIF
.
          MATCH     Z70,MSCHG012
          IF        !@EQUAL
            UNPACK    MSCHG012,PMMIDESC,PMMIDES2     * Item Description
          ENDIF
.
          MOVE      PMMIINCT,SAVEINCT       * Save old Item inclusion type
          MATCH     Z70,MSCHG010
          IF        !@EQUAL
            MOVE      MSCHG010,PMMIINCT     * Item Inclusion type
          ENDIF
.
          MATCH     Z70,MSCHG011
          IF        !@EQUAL
            MOVE      MSCHG011,PMMISUNQ     * Uniq.number for SX procedure
          ENDIF
.
.
.         If Item type =3 (Not validating Mis.code) - items from HL7, set field
.         for 'Keyin Price' to 'Y"
.
          MATCH     "3",PMMIITYP
          IF        @EQUAL
            MOVE      ZERO,NZMCCHGT          * not an exploding item
            MOVE      "Y",NZMCKPRI
            MATCH     "0",SAVEINCT
            IF        @EQUAL
              MOVE      PMMIAMTG,FORM12P2    * Keyin price for 'Inc.in Contract'
              MATCH     Z70,MSCHG013
              IF        !@EQUAL
                MOVE      MSCHG013,FORM12P2
              ENDIF
            ELSE
              MOVE      PMMIAMTT,FORM12P2    * Total price
              IF        PMMISERV<>0
                DIV       PMMISERV,FORM12P2
              ENDIF
            ENDIF
            PACK      MSCHG013,FORM12P2,SP70   * save keyin price
          ELSE
            CALL      GETNZM00                 * Get NZ private Misc.Charge
            BRANCH    EXIT,FNZI8000
            MOVE      NZMCCGRP,PMMIMGRP
          ENDIF
.
          PACK      KEY11,ADMISSNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,FNZI8000
.
          MOVE      SP70,PMMICNTR
.
          COMPARE   ONE,NZMCCHGT
          GOTO      FNZI1000 IF EQUAL        * Exploding item
          MATCH     "Y",NZMCKPRI
          GOTO      FNZI1000 IF EQUAL        * Keyin amount
.
          MOVE      NZMCPATP,PMMIAMTP
          MOVE      NZMCREBP,PMMIRBAT
.
FNZI1000  MATCH     SP70,NZSPCPRC
          GOTO      FNZI6000 IF EQUAL        * no contract - Normal charge
.
          MATCH     "1",PMMIINCT
          GOTO      FNZI1200 IF EQUAL        * Bill to patient
.
.         Set up Funder
.
.         If this is not extra to contract and
.         there is a max.contr. misc.item charge goes to patient invoice
.
          MATCH     "2",PMMIINCT
          IF        !@EQUAL
            MATCH     "1",NZSPCONT
            GOTO      FNZI1200 IF EQUAL
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "P",TCINDC7
            GOTO      FNZI1200 IF EQUAL     * item goes to patient invoice
          ENDIF
          PACK      PMMICNTR,NZSPCNTR,SP70
.
FNZI1200  MATCH     "1",NZSPCONT
          GOTO      FNZI6000 IF EQUAL        * max contr.- Normal charge
.
.  PMMIINCT: 0=Use Contract Rule 1=Bill to Patient 2=Extra to Contract
.
          MATCH     "0",PMMIINCT
          GOTO      FNZI2000 IF NOT EQUAL    * Override Contract rule
.
          COMPARE   ONE,NZMCCHGT
          GOTO      FNZI1220 IF EQUAL        * Exploding item
          MATCH     "Y",NZMCKPRI
          GOTO      FNZI1600 IF NOT EQUAL
.
          MATCH     Z70,MSCHG013
          GOTO      FNZI1400 IF NOT EQUAL
.
FNZI1220  MATCH     "1",SAVEINCT
          IF        @EQUAL
            MOVE      PMMIAMTP,PMMIAMTG
          ELSE
            MATCH     "2",SAVEINCT
            IF        @EQUAL
              MOVE      PMMIRBAT,PMMIAMTG
            ENDIF
          ENDIF
          GOTO        FNZI1600
.
FNZI1400  MOVE      MSCHG013,PMMIAMTG      * Save the keyin amount
.
FNZI1600  MOVE      PMMIITEM,TITEMNO
          MOVE      PMMIAMTP,TPATAMTP
          MOVE      PMMIAMTG,TPATAMTG
          MOVE      PMMIRBAT,TREBATE
          MOVE      PMMISERV,TSERVS
.
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MOVE      TPATAMTT,PMMIAMTT
.
          CALL      CHKAMT00                 * Check for Contract rule
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
.
          GOTO      FNZI9000
.
FNZI2000  MATCH     "1",PMMIINCT
          GOTO      FNZI3000 IF NOT EQUAL
.
.         Change to 1 - Bill to Patient
.
          COMPARE   ONE,NZMCCHGT
          GOTO      FNZI2200 IF EQUAL        * Exploding item
          MATCH     "Y",NZMCKPRI
          GOTO      FNZI2800 IF NOT EQUAL
.
          MATCH     Z70,MSCHG013
          IF        !@EQUAL
            MOVE      MSCHG013,PMMIAMTG      * Keyin amount
          ENDIF
.
FNZI2200  MATCH     "0",SAVEINCT
          IF        @EQUAL
            MOVE      PMMIAMTG,PMMIAMTP
          ELSE
            MATCH     "2",SAVEINCT
            IF        @EQUAL
              MOVE      PMMIRBAT,PMMIAMTP
            ENDIF
          ENDIF
.
FNZI2800  MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIRBAT          * zero rebate
          MOVE      PMMIAMTP,PMMIAMTT
          GOTO      FNZI3800
.
.         Change to 2 - Extra to Contact
.
FNZI3000  MATCH     "2",PMMIINCT
          GOTO      FNZI9000 IF NOT EQUAL
.
          COMPARE   ONE,NZMCCHGT
          GOTO      FNZI3200 IF EQUAL        * Exploding item
.
          MATCH     "Y",NZMCKPRI
          GOTO      FNZI3400 IF NOT EQUAL
.
          MATCH     Z70,MSCHG013
          IF        !@EQUAL
            MOVE      MSCHG013,PMMIAMTG      * Keyin amount
          ENDIF
.
FNZI3200  MATCH     "0",SAVEINCT
          IF        @EQUAL
            MOVE      PMMIAMTG,PMMIRBAT
          ELSE
            MATCH     "1",SAVEINCT
            IF        @EQUAL
              MOVE      PMMIAMTP,PMMIRBAT
            ENDIF
          ENDIF
.
FNZI3400  MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTP
          MOVE      PMMIRBAT,PMMIAMTT
.
.         If this is not extra to contract and
.         there is a max.contr. misc.item charge goes to patient invoice
.
FNZI3800  MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      ZERO,PMMIRBAT           * zero rebate
            MOVE      PMMIAMTP,PMMIAMTT
          ENDIF
          GOTO      FNZI9000
.
.-------------------------------------------------------------------------------
.         Normal charge
.-------------------------------------------------------------------------------
FNZI6000  MATCH     "0",PMMIINCT
          GOTO      FNZI6200 IF NOT EQUAL    * Not Include to Contract
.
          MOVE      PMMIAMTP,PMMIAMTG
          MATCH     Z70,MSCHG013
          IF        !@EQUAL
            MOVE      MSCHG013,PMMIAMTG
            MOVE      PMMIAMTG,PMMIAMTP
          ENDIF
          MOVE      ZERO,PMMIRBAT
          GOTO      FNZI8000
.
FNZI6200  MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIRBAT
.
FNZI8000  MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
FNZI9000  IF        PMMISERV<>0
            MULT      PMMISERV,PMMIAMTT
          ENDIF
.
FNZI9999  RETURN
+
.------------------------------------------------------------
.         Fix misc.description
.------------------------------------------------------------
FDESC000  MATCH     Z70,MSCHG004
          GOTO      FDESC999 IF EQUAL      * No change to unit
.
          ENDSET    PMMIDESC
FDESC100  CMATCH    "X",PMMIDESC
          GOTO      FDESC200 IF EQUAL
.
FDESC120  BUMP      PMMIDESC,-1
          GOTO      FDESC300 IF EOS
          GOTO      FDESC100
.
FDESC200  BUMP      PMMIDESC,-1
          CMATCH    SP1,PMMIDESC
          GOTO      FDESC120 IF NOT EQUAL
          GOTO      FDESC400
.
.         No unit on desc, just add the unit at the end of desc.
.
FDESC300  ENDSET    PMMIDESC
FDESC310  CMATCH    SP1,PMMIDESC
          GOTO      FDESC320 IF NOT EQUAL
.
          BUMP      PMMIDESC,-1
          GOTO      FDESC310 IF NOT EOS
.
FDESC320  APPEND    SP1,PMMIDESC
FDESC400  APPEND    "X",PMMIDESC
          APPEND    MSCHG004,PMMIDESC
          APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
.
FDESC999  RETURN
+
.------------------------------------------------------------
. Remove Doctor Charges
.------------------------------------------------------------
RDOC0000  OPEN      PMSMTIA2,"pmsmtiaf"
.
RDOC1000  MOVE      "4",PMMIRTYP
          PACK      KEY15,ADMISSNO,PMMIRTYP,SP70
          CALL      RSPMMTI2
          CALL      RKPMMTI2
          BRANCH    OVRCD,RDOC9999
.
          MATCH     ADMISSNO,PMMIVISN       * Same visit number?
          GOTO      RDOC9999 IF NOT EQUAL
          MATCH     "4",PMMIRTYP
          GOTO      RDOC9999 IF NOT EQUAL
.
          PACK      KEY15,PMMIVISN,PMMIRTYP,PMMITRAN,SP70
          CALL      DEPMMTI2
          GOTO      RDOC1000
.
RDOC9999  RETURN
+
.------------------------------------------------------------
. Estimate Doctor charges
.------------------------------------------------------------
ESCHR000  COMPARE   NINE,CFEETYP
          GOTO      ESCHR999 IF NOT EQUAL     * Not Johns Hopkins
.
          CALL      DEREC000                  * Delete any existing records
          CALL      CCHRG000                  * Copy existing item charges
.
          MOVE      ONE,PROGFLAG              * Estimate invoice
          CALL      PTDRCHRG                  * doctor charges to tempfile
          MOVE      ZERO,PROGFLAG
.
ESCHR999  RETURN
+
.------------------------------------------------------------
. Copy any current misc. charges to tempfile
.------------------------------------------------------------
CCHRG000  MOVE      ONE,FORM8
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
CCHRG100  CALL      RKPMMTI1
          BRANCH    OVRCD,CCHRG400
          MATCH     ADMISSNO,PMMIVISN        * Same visit number?
          GOTO      CCHRG400 IF NOT EQUAL
.
          MATCH     "4",PMMIRTYP
          GOTO      CCHRG100 IF EQUAL        * doctor charge
          MATCH     "7",PMMIRTYP
          GOTO      CCHRG100 IF EQUAL        * discount
.
CCHRG200  PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTE1
          IF        OVRCD=0
            MOVE      PMMITRAN,FORM6
            ADD       ONE,FORM6
            MOVE      FORM6,PMMITRAN
            MOVE      FORM6,FORM8           * Save transaction number
            GOTO      CCHRG200
          ENDIF
          MOVE      WBSEUID,PMMIWUSR        * WEB User ID
          CALL      WRPMMTE1                * Write to tempfile
          GOTO      CCHRG100
.
.         Save billing date with record type = 0
.
CCHRG400  MOVE      ADMISSNO,PMMIVISN
          MOVE      FORM8,FORM6
          MOVE      FORM6,PMMITRAN
          MOVE      "0",PMMIRTYP            * Header
          MOVE      CHNGDATE,PMMITDAT       * Billing Date
          MOVE      URNUMBER,PMMIURNO       * U/R number
          MOVE      " 3",PMMISYST
          UNPACK    SP70,PMMIITEM,PMMIDESC,PMMIDES2
          UNPACK    SP70,PMMIREFN,PMMITDOC,PMMIODOC,PMMISESS,PMMIMGRP
          UNPACK    SP70,PMMIBTCH,PMMIGSTC,PMMIMVBR,PMMIUNIQ,PMMISPAR
          MOVE      SP70,PMMIDKSM           * Distance in kms
          MOVE      ZERO,PMMIAMTT
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      ZERO,PMMIAMTP
          MOVE      ZERO,PMMIRBAT
          MOVE      ZERO,PMMIINVN
          MOVE      ZERO,PMMIGSTA
          MOVE      ZERO,PMMIGSTM
.
CCHRG600  PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTE1
          IF        OVRCD=0
            MOVE      PMMITRAN,FORM6
            ADD       ONE,FORM6
            MOVE      FORM6,PMMITRAN
            MOVE      FORM6,FORM8           * Save transaction number
            GOTO      CCHRG600
          ENDIF
          MOVE      WBSEUID,PMMIWUSR        * WEB User ID
          CALL      WRPMMTE1                * Write to tempfile
.
CCHRG999  RETURN
+
.------------------------------------------------------------
. Delete records in tempfile
.------------------------------------------------------------
DEREC000  PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTE1
DEREC100  CALL      RKPMMTE1
          BRANCH    OVRCD,DEREC999
          MATCH     ADMISSNO,PMMIVISN
          GOTO      DEREC999 IF NOT EQUAL
          MATCH     WBSEUID,PMMIWUSR        * Same user?
          GOTO      DEREC100 IF NOT EQUAL
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTE1
          GOTO      DEREC100
.
DEREC999  RETURN
+
.------------------------------------------------------------
. Add Discount
.------------------------------------------------------------
ADISC000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,ADISC999
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,ADISC999
.
          MATCH     "1",DISCTYPE
          GOTO      ADISC500 IF EQUAL         * Fixed amount
.
          MOVE      ONE,WEBFLAG
          MOVE      ONE,PROGFLAG
          COMPARE   THREE,PVITYPE
          GOTO      ADISC300 IF EQUAL         * Inpatient
          COMPARE   TWO,PVITYPE
          GOTO      ADISC999 IF NOT EQUAL
.
          MOVE      PVIBILL,OBAOUTNO
          MOVE      PVIBILL,KEY8
          MOVE      SP3,OSTSYST    
          MOVE      "out",OSTFILE  
          MOVE      PVISITE,KEY6   
          CALL      RDSITA1        
          PACK      CFNAME,OSTFILE,FILBB1A1   * Set up physical filename
          CALL      OPOTBB11       
          CALL      RDBOKB1        
          BRANCH    OVRCD,ADISC999 
.
          MOVE      PVISITE,OBASITE
          MOVE      PVIBILL,OBAOUTNO
          MOVE      PVIURNO,OBAURNO
.
          CALL      OUTTBI                    * Outpatient
          GOTO      ADISC400
.
ADISC300  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,ADISC999
.
          CALL      CALCTBI                   * Inpatient
.
ADISC400  COMPARE   ZERO,GROSSTOT
          GOTO      ADISC999 IF EQUAL         * no outstanding amount
          MOVE      DISCAMNT,FORM12P2
          DIV       "100",FORM12P2
          MULT      FORM12P2,GROSSTOT
          MOVE      GROSSTOT,PMMIAMTP
          GOTO      ADISC700
.
ADISC500  MOVE      DISCAMNT,PMMIAMTP
.
ADISC700  MULT      "-1",PMMIAMTP
          MOVE      PMMIAMTP,PMMIAMTT
          MOVE      "DISCOUNT - ",KEY11
          CLEAR     PMMIDESC
          APPEND    KEY11,PMMIDESC
          APPEND    DISCDESC,PMMIDESC
          APPEND    SP70,PMMIDESC
          RESET     PMMIDESC
.
          CALL      DSDT0000                     * get default discount date
          MOVE      DIM8,PMMITDAT
          MOVE      "7",PMMIRTYP
.
          MOVE      SP70,PMMIGSTC
          MOVE      ZERO,PMMIGSTA
          MOVE      ZERO,PMMIGSTM
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      PTCNAGST,PMMIGSTC     * Use accommodation GST
            MOVE      ONE,PMMIGSTA
            CALL      DGST0000              * Discount GST
          ENDIF
.
          MOVE      PTCNCDIS,PMMIMGRP       * Category for Discount
          MOVE      PTVITYPE,PMMISYST
          CALL      CEVT0000                * Check for Events
          MATCH     SP70,KEY1
          IF        !@EQUAL
            PACK      PMMISYST,SP1,KEY1,SP70
          ENDIF
.
          MOVE      PVIURNO,PMMIURNO
          MOVE      SP70,PMMIITEM
          MOVE      SP70,PMMIDES2
          UNPACK    SP70,PMMIREFN,PMMITDOC,PMMIODOC,PMMISESS
          UNPACK    SP70,PMMIBTCH,PMMIMVBR,PMMIUNIQ
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      ZERO,PMMIRBAT
          MOVE      ZERO,PMMISERV
          MOVE      ZERO,PMMIINVN
          UNPACK    SP70,PMMICNTR,PMMISUNQ
          MOVE      SP70,PMMIDKSM       * Distance in kms
          MOVE      SP70,PMMISPAR
.
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
.
.        Get the next transactions number
.
ADISC800  CALL      TRVISA1
.
          MOVE      PVIBILL,PMMIVISN
          MOVE      PVITRAN,PMMITRAN
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      ADISC800 IF EQUAL
.         
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      WRPMMTI1
.
ADISC999  RETURN
+
.------------------------------------------------------------
. Fixed fees/Co-payment Adjustment
.------------------------------------------------------------
FADJ0000  PACK      KEY11,ADMISSNO,NSPRUNIQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,FADJ9999
.
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            MOVE      ZERO,NZSPFADJ
            MOVE      DISCAMNT,NZSPHADJ       * Funder contr.Adjustment amount
.
            MULT      "-1",DISCAMNT
            MOVE      DISCAMNT,NZSPCADJ
          ELSE
            MOVE      DISCAMNT,NZSPFADJ       * Fixed fees/Total Adjustment
            MOVE      DISCAMNT,NZSPHADJ
            SUB       CPAYADJM,NZSPHADJ       * Funder Adjustment amount
            MOVE      CPAYADJM,NZSPCADJ       * Co-payment Adjustment amount
          ENDIF
          CALL      UPNZSPR1
FADJ9999  RETURN
+
.------------------------------------------------------------
. Calculate Discount GST
.------------------------------------------------------------
DGST0000  OPEN      IBAGEDA1,"ibagedaf"
          MOVE      ZERO,IBGEAMNT           * zero GST percentage
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY14,PTCNAGST,KEY8
          CALL      RDIBGE1
          COMPARE   ZERO,OVRCD
          GOTO      DGST4000 IF EQUAL       * found GST amount for current date
.
          CALL      RPIBGE1                 * read previous record
          BRANCH    OVRCD,DGST2000
.
          MATCH     PTCNAGST,IBGECODE       * Same code ?
          GOTO      DGST4000 IF EQUAL
.
DGST2000  MOVE      ZERO,IBGEAMNT
.
DGST4000  MOVE      PMMIAMTT,PMMIGSTM
          MULT      IBGEAMNT,PMMIGSTM       * Item GST Amount
          DIV       "100.00",PMMIGSTM
DGST9999  RETURN
+
.------------------------------------------------------------
. Get number of items charged - Only for Johns Hopkins & SX
.------------------------------------------------------------
ITMN0000  MOVE      ZERO,TOTCHRG
          COMPARE   FIVE,CFEETYP
          GOTO      ITMN1000 IF EQUAL        * SX
          COMPARE   NINE,CFEETYP
          GOTO      ITMN9999 IF NOT EQUAL
.
ITMN1000  PACK      KEY15,ADMISSNO,TWO,SP70
          CALL      RSPMMTI2
ITMN3000  CALL      RKPMMTI2
          BRANCH    OVRCD,ITMN8000
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      ITMN8000 IF NOT EQUAL    * Not same admission
.
          UNPACK    PMMIRTYP,KEY1
          REP       "2X3X",KEY1
          MATCH     "X",KEY1
          GOTO      ITMN3000 IF NOT EQUAL
.
          COMPARE   NINE,CFEETYP
          GOTO      ITMN7000 IF EQUAL        * JH
.
          MATCH     "ALL   ",EXPPAYER
          GOTO      ITMN7000 IF EQUAL        * for all
.
          MATCH     "PRFA  ",EXPPAYER
          IF        @EQUAL
            MATCH     SP70,PMMICNTR
            GOTO      ITMN3000 IF NOT EQUAL
          ELSE
            MATCH     EXPPAYER,PMMICNTR 
            GOTO      ITMN3000 IF NOT EQUAL
          ENDIF
.
ITMN7000  ADD       ONE,TOTCHRG              * increase number of items
          GOTO      ITMN3000
.
.         Get details of Expected payer
.
ITMN8000  MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          IF        OVRCD=1
            PACK      PKNAME,SP70,SP10
            UNPACK    SP70,PKADD1
            UNPACK    SP70,PKADD2,PKSUBR
            UNPACK    SP70,PKADD4,PKPOST
          ENDIF
.
          MATCH     SP70,EXPPAYER
          IF        @EQUAL
            CALL      GPAY0000            * Get default payer
            MOVE      VSPAPAYC,EXPPAYER
          ENDIF
.
          MATCH     "PRFA",EXPPAYER
          GOTO      ITMN9999 IF EQUAL
.
          PACK      KEY14,EXPPAYER,ZERO8,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            PACK      PKNAME,HFNAME,SP70
            PACK      PKADD1,HFADD1,SP70
            PACK      PKADD2,HFADD2,SP70
            PACK      PKSUBR,HFADD3,SP70
            PACK      PKADD4,HFADD4,SP70
            PACK      PKPOST,HFPCODE,SP70
          ENDIF
.
ITMN9999  RETURN
+
.-----------------------------------------------------------
.         Warning message for theatre system
.-----------------------------------------------------------
WARN0000  CALL      OPENHTML
          BRANCH    EXIT,WARN9000
.
          MOVE      "Warning: Theatre might need to be adjusted.",WEBTITLE
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             "    alert(#"",WEBTITLE,"#");",012
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          IF        CFEETYP=9
            APPEND    "patweb71.pbl?reportno=01&template=032&urnumber=",REDIRECT
          ELSE
            APPEND    "patweb71.pbl?reportno=01&template=001&urnumber=",REDIRECT
          ENDIF
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&nextpage=1",REDIRECT
          APPEND    SP70,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WARN9999
.
WARN9000  DISPLAY   "*** Fifo Not Found ***"
WARN9999  RETURN
+
.-----------------------------------------------------------
.        Delete record from misc.item file
.-----------------------------------------------------------
DELE0000  MOVE      ZERO,MBSFLAG
          MOVE      ZERO,FOUNDMBS
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      RDPMMTI1
          BRANCH    OVRCD,DELE8000
.
          MATCH     "2",PMMIRTYP
          IF        @EQUAL
            MOVE      ONE,MBSFLAG         * flag for MBS item
.
.           This item is being deleted, so send an appropriate HL7 message.
.
            CALL      PMIGTNID            * get national id for HL7 write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      ANSD,HL7ITMFL       * set flag for delete record
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIITM            * send HL7 message
.                                                            * start  *I-206410
            CALL      GETMBS00            * read matching MBS item in patmmbsf
            MATCH     PMMIVISN,DMMADMN
            IF        @EQUAL
              PACK      KEY11,DMMADMN,MMRECN * pack key with original record
.             item exists - delete the item from the theatre files
              MATCH     Z70,DEFRTHAL
              IF        @EQUAL
                CALL      DEMMBS1         * delete matching "patmmbsf" item
              ELSE
                MATCH     "1",DEFRTHAL
                IF        @EQUAL
                  CALL      DEMMBS1         * delete matching "patmmbsf" item
                ENDIF
              ENDIF
              PACK      KEY22,MMCODE,PTMMOPID,PTMMTMNO,SP20
              CALL      DOPR0000          * delete matching theatre record
            ENDIF
          ENDIF                                            * end    *I-206410
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTI1
.
          IF        PVITYPE=THREE
            MOVE      "D",DIM1
            MOVE      PMMIITEM,MCHARGE
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            CALL      PROTRK00
          ENDIF
.
          CALL      DVCD0000
.         
DELE8000  COMPARE   ZERO,PTCNIPEN
          GOTO      DELE9000 IF NOT EQUAL
.
.         Check if accommodation charged had been raised for Inpatient
.
          COMPARE   THREE,PVITYPE
          GOTO      DELE8200 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,DELE9000
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "7",PTIPRSTA
            MOVE      TRANDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
            GOTO      DELE9000
          ENDIF
.
          COMPARE   THREE,ASTAT
          GOTO      DELE9000 IF NOT EQUAL
          COMPARE   ZERO,AINVPRT               * do not delete if patient has
          GOTO      DELE9000 IF EQUAL          * not been invoiced
.
.         Check if Accommodation had been invoiced up to discharged date
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,DELE9000
.
          MATCH     DDATE,ALACDTE
          GOTO      DELE9000 IF LESS
.
.         Check if there is any item to be invoiced
.
DELE8200  PACK      KEY14,PVIBILL,SP20
          CALL      RSPMMTI1
DELE8300  CALL      RKPMMTI1
          BRANCH    OVRCD,DELE8400
          MATCH     PMMIVISN,DPVIBILL
          GOTO      DELE8400 IF NOT EQUAL   
.
          MATCH     "1",PTCNUABF             * check if using ABF
          GOTO      DELE9000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,DELE9000
.
          MATCH     "A",TCINDC2
          GOTO      DELE9000 IF NOT EQUAL    * not ABF Funding
.
.         ABF Invoice - Delete invoice pending if item has zero amt 
.
          COMPARE   ZERO,PMMIAMTT
          GOTO      DELE8300 IF EQUAL       * item with zero charge
.
          GOTO      DELE9000
.
DELE8400  MOVE      PVIBILL,KEY8            * remove invoice pending record
          CALL      DEIPEN1
.
DELE9000  CALL      DGTU0000                * Check unknown gst file
DELE9999  RETURN
+
.******************************************************************************
.*                                  GETMBS00                                  *
.*                Get an MBS Item (patmmbs) matching PMSMTIaf item  *I-206410 *
.******************************************************************************
GETMBS00  MOVE      ZERO,EXIT
.
          MATCH     "2",PMMIRTYP
          GOTO      GETMBS90 IF NOT EQUAL
.
          COMPARE   ZERO,CUSEMBS            * "0" = Not used
          GOTO      GETMBS90 IF EQUAL
.
          MOVE      ADMISSNO,MMADMN
          PACK      KEY11,ADMISSNO,Z70
          CALL      RDSMMBS1
GETMBS10  CALL      RDPMMBS1
          BRANCH    OVRCD,GETMBS90
.
          MATCH     DMMADMN,ADMISSNO        * check if same adm. no.'s
          GOTO      GETMBS90 IF NOT EQUAL
.
          MATCH     PMMIITEM,MMCODE         * if not same Item Code then
          GOTO      GETMBS10 IF NOT EQUAL   * loop for next record
.
          MATCH     PMMITDAT,MMDATE         * if not same date then
          GOTO      GETMBS10 IF NOT EQUAL   * loop for next record
          MATCH     SP8,PMMISVTM
          IF        !@EQUAL
            UNPACK    PMMISVTM,KEY5,KEY3
            MATCH     KEY5,MMSTIM           * is it the same start time
            GOTO      GETMBS10 IF NOT EQUAL * loop for next record
          ENDIF
.
.                                                           * start   *I-207386
          MATCH     PMMIUNIQ,PTMMOPID       * same Theatre Unique Id. ?
          GOTO      GETMBS10 IF NOT EQUAL   * loop for next record
.                                                           * end     *I-207386
.                                           * found an Item
          GOTO      GETMBS99
.
.                                           * none found - clear PATMMBS Item
GETMBS90  UNPACK    SP70,MMCODE,DMMADMN,DMMRECN,MMDATE,MMSTIM,MMETIM
          UNPACK    SP70,PTMMDESC
          UNPACK    SP70,PTMMOPID,PTMMTMNO
          MOVE      ZEROVISN,MMADMN
          MOVE      ZERO,MMRECN
.
GETMBS99  RETURN
+
.*********************************************************************
.*                  DGTU0000                                         *
.*   Check if there is anymore Unknown GST item code in patdtraf file*
.*********************************************************************
DGTU0000  MOVE      ADMISSNO,DPTGTADM
          CALL      CDTR0000
          BRANCH    EXIT,DGTU2000          * Found other unknown GST item code
.
.         No item without GST code found. Should not have record in patgtuaf
.         ( or field for unknown MBS/Item GST - PTGTGSTM should be zero)
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTGTU1
          BRANCH    OVRCD,DGTU9999
.
.         No item without GST Code
.
          IF        PTGTGSTA=1
            MOVE      ZERO,PTGTGSTM         * Set "No" to Unknown Item GST
            CALL      UPPTGTU1
          ELSE
            CALL      DEPTGTU1
          ENDIF
          GOTO      DGTU9999
.
.         Found unknown gst item, should have a record in patgtuaf file
.
DGTU2000  MOVE      ADMISSNO,KEY8
          CALL      RDPTGTU1
          BRANCH    OVRCD,DGTU2200
.
          MOVE      ONE,PTGTGSTM           * Set 'Yes' to Unknown Item GST
          CALL      UPPTGTU1
          GOTO      DGTU9999
.
DGTU2200  MOVE      ADMISSNO,PTGTADMN
          MOVE      ZERO,PTGTGSTA           * Set 'No' to Unknown Accom.GST
          MOVE      ONE,PTGTGSTM           * Set 'Yes' to Unknown Item GST
          PACK      PTGTSPAR,SP70
          CALL      WRPTGTU1
DGTU9999  RETURN
+
.******************************************************************************
.*                  DOPR0000                                        *C-207386 *
.*        Delete  any MBS items in theatre (serverly modified)      *C-207386 *
.******************************************************************************
DOPR0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FOUNDMBS
.
          COMPARE   ONE,CTHETR
          GOTO      DOPR9999 IF NOT EQUAL   * not using theatre
.
          MATCH     SP9,PTMMOPID            * check Theatre Unique Id. exists
          GOTO      DOPR9999 IF EQUAL
.
          OPEN      OPRPMBA1,"oprpmbaf"
          OPEN      OPRPMBA2,"oprpmbaf"
.
.         see if the item code matches an entered theatre MBS code
.
          PACK      KEY23,MMCODE,PTMMOPID,PTMMTMNO,SP20
          CALL      RSOPPMB2
.
DOPR4000  CALL      RKOPPMB2
          BRANCH    OVRCD,DOPR9999          * no more usage details
.
          MATCH     MMCODE,OPPMCMBS         * match MBS Item code
          GOTO      DOPR9999 IF NOT EQUAL
.
          MATCH     PTMMOPID,OPPMUNID       * match theatre unique Id.
          GOTO      DOPR9999 IF NOT EQUAL
.
          MATCH     PTMMTMNO,OPPMTMNO       * match theatre team
          GOTO      DOPR9999 IF NOT EQUAL
.
.         item exists - delete the item from the theatre files
.
          MATCH     "1",DEFRTHAL
          GOTO      DOPR5000 IF NOT EQUAL   * "Delete from Theatre" un-checked
.
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR
          CALL      DEOPPMB1
DOPR5000  MOVE      ONE,FOUNDMBS
.
.
DOPR9999  RETURN
+
.-----------------------------------------------------------
.  GST 
.-----------------------------------------------------------
UPDGST00  MATCH     SP10,URNUMBER
          GOTO      UPDGST80 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
          CALL      RDPMPX21
          IF        MASTFLAG=1
            MOVE      "Can't find Patient Master details",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      UPDGST99
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          MOVE      OVRCD,MISSFLAG
          IF        MISSFLAG=1
            MOVE      "Missing Admission record",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      UPDGST99
          ENDIF
.
          MATCH     SP70,TRANSCNO
          GOTO      UPDGST02 IF EQUAL
.
          PACK      KEY14,ADMISSNO,TRANSCNO
          CALL      RDPMMTI1
          BRANCH    OVRCD,UPDGST70
.
UPDGST02  BRANCH    UPDATETY,UPDGST10,UPDGST20
          GOTO      UPDGST80
.
.         Update GST Code for Accommodation
.
UPDGST10  MOVE      PTGTU001,PTMIGSTA       * set up admission GST field
          CALL      UPMISS1
.
          MOVE      "0",KEY1
          MOVE      PTGTU001,KEY1
          MATCH     "U",KEY1
          GOTO      UPDGST12 IF EQUAL       * Unknown GST
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTGTU1
          BRANCH    OVRCD,UPDGST99
          GOTO      UPDGST18
.
.         Unknown GST should have record in patgtuaf file
.
UPDGST12  MOVE      ADMISSNO,KEY8
          CALL      RDPTGTU1
          COMPARE   ZERO,OVRCD
          GOTO      UPDGST99 IF EQUAL       * already exist
.
          MOVE      ADMISSNO,PTGTADMN
	  MOVE      ONE,PTGTGSTA            * Set 'Yes' to Unknown Accom.GST
          MOVE      ZERO,PTGTGSTM           * Set 'No' to Unknown Item GST
          PACK      PTGTSPAR,SP70
          CALL      WRPTGTU1
          GOTO      UPDGST99
.
UPDGST18  REP       "Y1y1N1n1",KEY1
          MATCH     "1",KEY1
          IF        @EQUAL
            MOVE      ZERO,PTGTGSTA         * Set "No" to Unknown GST
            IF        PTGTGSTM=0
              CALL      DEPTGTU1
              GOTO      UPDGST99
            ELSE
              CALL      UPPTGTU1                * update file
            ENDIF
          ENDIF
          GOTO      UPDGST99
.
.         Update GST code for MBS/Misc.items
.
UPDGST20  MATCH     "Y",PTGTU001           * If GST applicable
          IF        @EQUAL
            MATCH     SP10,PTGTU002
            GOTO      UPDGST72 IF EQUAL    * GST Code must not be blank
          ENDIF
.
          MOVE      PTGTU001,KEY1
          REP       "U2N0Y1",KEY1
          MOVE      KEY1,PMMIGSTA
          MOVE      PTGTU002,PMMIGSTC
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
.
.         Check if there is anymore Unknown GST item code in patdtraf file
.
          MOVE      ADMISSNO,DPTGTADM
          CALL      CDTR0000
          BRANCH    EXIT,UPDGST60          * Found other unknown GST item code
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTGTU1
          BRANCH    OVRCD,UPDGST60
.
          MOVE      "0",KEY1
          MOVE      PTGTU001,KEY1
          REP       "Y1y1N1n1",KEY1
          MATCH     "1",KEY1
          IF        @EQUAL
            MOVE      ZERO,PTGTGSTM         * Set "No" to Unknown GST
            IF        PTGTGSTA=0
              CALL      DEPTGTU1
              GOTO      UPDGST60
            ELSE
              CALL      UPPTGTU1                * update file
            ENDIF
          ENDIF
          GOTO      UPDGST60
.
UPDGST60  MOVE      SP1,KEY1
          MOVE      PTGTU001,KEY1
          REP       "U1u1N1n1",KEY1
          MATCH     "1",KEY1               * If GST applicable?
          IF        @EQUAL
            MATCH     SP10,PTGTU002
            GOTO      UPDGST62 IF NOT EQUAL * GST not appl,but Code is not blank
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      UPDGST99
.
UPDGST62  PACK      WEBTITLE,SP70
          APPEND    "Warning: GST is Unknown or NOT applicable, ",WEBTITLE
          APPEND    "but GST Code is not blank.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDGST99
.
UPDGST70  MOVE      "Missing Debtor Transaction record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDGST99
.
UPDGST72  MOVE      "If GST Applicable, GST Code must not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDGST99
.
UPDGST80  CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,UPDGST99
.
          CALL      WEBBOD00   * Output Templated Body of HTML 
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
UPDGST99  RETURN
+
.
.-----------------------------------------------------------
.  Billing Patient Status Adjustment
.-----------------------------------------------------------
SADJ0000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,SADJ9100
          CALL      RDPMPX21
          BRANCH    OVRCD,SADJ9100
          MOVE      SP70,OLDCASEM
.
          IF        IBCNMHOS=1
            MOVE      SP10,PMVXMHOS
            PACK      KEY8,ADMISSNO,SP10
            CALL      RDPMVX11
            MOVE      SP10,PTHSDCLM
            MOVE      SP10,PTHSTFEE
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1               * get Hospital Using Theatre Fee
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,SADJ9200
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
.
          MATCH     "1",DISPSTEP
          GOTO      SADJ0310 IF EQUAL       * Bed Fees stepdown from Inv.screen
.
          MATCH     CHNGDATE,ALACDTE
          GOTO      SADJ0020 IF NOT EQUAL
.
          MATCH     ALACDTE,ADATE
          IF        @EQUAL
            MOVE      ATIME,TTIME
            MATCH     ATIME,CHNGTIME
            GOTO      SADJ9530 IF LESS
          ELSE
            CALL      CHKTIM00                 * Check /time 
            BRANCH    EXIT,SADJ9530
          ENDIF
.
SADJ0020  BRANCH    ASTAT,SADJ9310,SADJ0100,SADJ0100,SADJ9320,SADJ9330
          GOTO      SADJ9200
.
SADJ0100  MOVE      ZERO,DCFLAG         * Default to Not a daycase
          MOVE      SP10,DDATE
          MOVE      SP10,DTIME
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,SADJ9300      * Missing discharge record
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,DCFLAG       * Set flag to daycase
            ENDIF
          ENDIF
.
          BRANCH    UPDATETY,SADJ1000,SADJ2000,SADJ3000,SADJ4000,SADJ4000:
                             SADJ5000
.
          MATCH     "010",TEMPLATE
          GOTO      SADJ0180 IF EQUAL       * Change Reason for Lumpsum removal
          MATCH     "002",TEMPLATE
          GOTO      SADJ0200 IF NOT EQUAL   * not changing casemix code option
.
          CALL      CCATTR00                * read Patient Attributes 
.
SADJ0180  MATCH     ALACDTE,ADATE
          GOTO      SADJ9500 IF NOT EQUAL   * Accommodation already raised
.
          CALL      CHKACCM0                * Check if accom.has been charged
          BRANCH    EXIT,SADJ9500           * Found accommodation record
          GOTO      SADJ8000
.
SADJ0200  MATCH     "004",TEMPLATE
          GOTO      SADJ0300 IF EQUAL       * bed fee stepdown template
          MATCH     "005",TEMPLATE
          GOTO      SADJ0300 IF EQUAL       * Casepayment stepdown
          MATCH     "014",TEMPLATE
          GOTO      SADJ0300 IF EQUAL       * bed fee bed transfer template
          MATCH     "015",TEMPLATE
          GOTO      SADJ0300 IF EQUAL       * Casepayment bed transfer
.
          MATCH     "006",TEMPLATE
          GOTO      SADJ0400 IF EQUAL       * bed fee for admission
          MATCH     "013",TEMPLATE
          GOTO      SADJ0400 IF EQUAL       * Setup bedfees for admission
          MATCH     "007",TEMPLATE          * bed fee for 'Return' record
          GOTO      SADJ0400 IF EQUAL
          MATCH     "008",TEMPLATE
          GOTO      SADJ0400 IF EQUAL       * Casepayment for admission
          MATCH     "009",TEMPLATE
          GOTO      SADJ0400 IF EQUAL       * Casepayment for "Return' record
.
          GOTO      SADJ8000
.
SADJ0300  CALL      CINV0000                * check if invoice printed for date
          BRANCH    EXIT,SADJ9999
.
          MOVE      ZERO,CMIXFLAG
          MATCH     "005",TEMPLATE
          GOTO      SADJ0304 IF EQUAL
          MATCH     "015",TEMPLATE
          GOTO      SADJ0306 IF NOT EQUAL
.
SADJ0304  MOVE      ONE,CMIXFLAG
          MOVE      ONE,PROGFLAG
          MOVE      ONE,MSGFLAG
          CALL      CPAT0000                * check if patient admitted as C/P
          PACK      SAVBTYP,SAVBTYP,SP70
          PACK      PTMIPCMX,CMCODE,SP70
          PACK      SBFEEKEY,ADMISSNO,SAVBTYP,CMCODE,CONTRCID,SP70
          MOVE      CMXFLAG,CMIXFLAG
.
SADJ0306  MOVE      ADYHOSP,NEWDHOSP
          CALL      CRAT0000                * Get the current rate of date/time
.
          COMPARE   ZERO,CMIXFLAG
          GOTO      SADJ0420 IF EQUAL       * bed fees template
.
          CALL      VCMX0000                * Low or high outliers
          GOTO      SADJ0415                * casepayment template
.
.         Stepdown template from Next Invoice
.
SADJ0310  MOVE      ZERO,DCFLAG         * Default to Not a daycase
          MOVE      SP10,DDATE
          MOVE      SP10,DTIME
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,SADJ9300      * Missing discharge record
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,DCFLAG       * Set flag to daycase
            ENDIF
          ENDIF
          CALL      CPAT0000                * check if patient admitted as C/P
.
.         No pay day to show Casemix rates
.
.         COMPARE   ONE,CMIXFLAG
.         GOTO      SADJ0320 IF NOT EQUAL
.         COMPARE   ZERO,NPDAYFLG           * check for No Payday
.         GOTO      SADJ0320 IF EQUAL
.
.         MATCH     CMSTRTDT,CHNGDATE
.         GOTO      SADJ0320 IF NOT LESS
.         MOVE      ZERO,CMIXFLAG
.
SADJ0320  MOVE      "99:99:99",CHNGTIME
          MOVE      ADYHOSP,NEWDHOSP
          MOVE      ONE,SDOWNFLG         * flag for Stepdown screen
          CALL      STIV0000             * Show stepdown fees
.
          BRANCH    EXIT,SADJ9600,SADJ9620
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "5",PTIPRSTA
            MOVE      CHNGDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
          ENDIF
.
          GOTO      SADJ8000
.
.         - read backward to make sure only Admission/Leave record exists
.
SADJ0400  PACK      KEY30,AADMNO,Z70         * Position read on the admission
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,SADJ9510           * Must be outstanding debt pat
.
          MATCH     AADMNO,TADMN
          GOTO      SADJ9510 IF NOT EQUAL
.
          MATCH     "007",TEMPLATE      * Setup bedfees for 'Return' record
          GOTO      SADJ0405 IF EQUAL
          MATCH     "009",TEMPLATE      * Setup casemix fees for 'Return' record
          GOTO      SADJ0405 IF EQUAL
          MATCH     "006",TEMPLATE
          GOTO      SADJ0410 IF EQUAL   * Setup bedfees for admission
          MATCH     "013",TEMPLATE
          GOTO      SADJ0410 IF EQUAL   * Setup bedfees for admission
          MATCH     "008",TEMPLATE
          GOTO      SADJ0410 IF EQUAL   * Setup casemix fees for admission
.
SADJ0405  CMATCH    ANSR,TMOVE
          GOTO      SADJ9520 IF NOT EQUAL     * last record must be "R"
          GOTO      SADJ0412
.
SADJ0410  CMATCH    ANSA,TMOVE
          GOTO      SADJ9520 IF NOT EQUAL     * First record must be "A"
.
SADJ0412  MOVE      TATYPE,SAVATYP          * Save original adm.type
          MOVE      TRBTYP,SAVBTYP          * Save original bed.type
.         MOVE      TDATE,CHNGDATE
.         MOVE      TTIME,CHNGTIME
.
          MOVE      TDATE,CHNGDATE
          REP       " 0",CHNGDATE
          MOVE      TTIME,CHNGTIME
.         CALL      IBACLOCK
.         MOVE      CTIMEIS,CHNGTIME
.
          MOVE      TWARD,LWARD
          MOVE      TBED,LBED
          MOVE      TATYPE,LATYPE
          MOVE      TRBTYP,LRBTYP
          MOVE      ZERO,NOHOSP
.
.         Update fees for 'Admission' and 'Return' from leave trans record
.
          CALL      CPAT0000                * check if patient admitted as C/P
          IF        NEWDHOSP=9999
            MOVE      ADYHOSP,NEWDHOSP
          ENDIF
          CALL      CRAT0000                * Get the current rate of date/time
          COMPARE   ONE,CMIXFLAG
          GOTO      SADJ0420 IF NOT EQUAL   * not casepayment
          PACK      SBFEEKEY,ADMISSNO,SAVBTYP,CMCODE,CONTRCID,SP70
.
.         Casepayment template
.
SADJ0415  MOVE      ZERO,MAXDAY
          MOVE      ZERO,MAXADD
          CALL      CPVAR0000             * Clear variables
          CALL      CPAT0000
.
          MOVE      "0",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get daily Casepayment rate
.         BRANCH    NOFEE,SADJ9700
          MOVE      "1",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get additional Casepayment rate
.         BRANCH    NOFEE,SADJ9800
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
          GOTO      SADJ8000
.
.         Bed fees template
.
SADJ0420  IF        CFEETYP=5
            CALL      NZRT0000                * Get NZ bed fees
          ELSE
            CALL      GTRT0000              * Get max col of bed fees
          ENDIF
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "5",PTIPRSTA
            MOVE      CHNGDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
          ENDIF
.
          GOTO      SADJ8000
.
.         Display stepdown for new admission
.         Front End Deductible
.
SADJ1000  PACK      ITEMCODE,ITEMCODE,SP70
          MATCH     SP10,ITEMCODE
          GOTO      SADJ8000 IF EQUAL
.
          CALL      VALDT000            * Validate Date
          BRANCH    EXIT,SADJ9999
.
          CALL      VMSC0000
          BRANCH    EXIT,SADJ9999       * Invalid misc.item
.
          CALL      UPDFED00            * Update 
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "5",PTIPRSTA
            MOVE      TRANDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SADJ9999
.
.         Change Casemix Code
.
SADJ2000  
          MOVE      PTMICMXP,KEY1           * save original casepayment indic
          MOVE      PTMIPCMX,KEY9           * save original casemix code 
          MOVE      PTMIPCMX,OLDCASEM
.
          MATCH     SP70,PTMIS073
          IF        !@EQUAL
            PACK      PTMIPCMX,PTMIS073,SP70 * Casemix code
          ENDIF
.
          MATCH     SP70,PTMIS075
          IF        !@EQUAL
            MOVE      PTMIS075,PTMICMXP      * casepayment yes/no
          ENDIF
.
          MATCH     SP70,PTMIS081
          IF        !@EQUAL
            MOVE      PTMIS081,PTMICONB      * continuous billing
          ENDIF
.
.         Check if casemix payment indicator or casemix code had been changed
.
          MATCH     KEY1,PTMICMXP
          GOTO      SADJ2010 IF NOT EQUAL  * Casepayment changed
.
          MATCH     KEY9,PTMIPCMX
          GOTO      SADJ2010 IF NOT EQUAL  * Casemix Code changed
.
          MATCH     SP70,CCVERIFI
          GOTO      SADJ2080 IF NOT EQUAL  * Casemix Code Verification changed
.
          GOTO      SADJ2090               * nothing changed
.
SADJ2010  PACK      KEY9,PTMIPCMX,SP70
          CALL      RDPTCMC1
          IF        OVRCD=0
            MOVE      PTCAELOS,ASTAY        * Expected Length of stay
          ENDIF
.
.         PACK      KEY9,ACLAIM,AFUNDH
.         CALL      GETCNEFF               * Get Contract Effective From
.         BRANCH    EXIT,SADJ9360
.         PACK      KEY18,ACLAIM,AFUNDH,PTMIPCMX
.         CALL      VALCMXFN                * Validate casemix code
.         BRANCH    EXIT,SADJ9350
.
          CALL      VCMX0000                * Get cut off days
          MOVE      PTMIPCMX,CMDRG
          MOVE      PTMIPCMX,CMCODE
          PACK      PTMIPCMX,CMCODE,SP70
.     
          CALL      UPDCMX00                * Update casemix code
SADJ2080  CALL      CVERIF00              * Casemix verification audit patatraf
.
SADJ2090  CALL      CHKUDF00                * Update Admission/Discharge UDF
          MOVE      ZERO,EXIT
          GOTO      SADJ9999
.
.
.         Stepdown - after entering change of date and time
.
SADJ3000  CALL      STPD0000               * Stepdown - write to trans record
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "5",PTIPRSTA
            MOVE      CHNGDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      SADJ9999
.
.         Stepdown - for admission                          
.
SADJ4000  CALL      STUD0000               * Stepdown - update trans record
          BRANCH    EXIT,SADJ9600,SADJ9510,SADJ9520
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      "5",PTIPRSTA
            MOVE      CHNGDATE,PENDSDAT             * as at date
            CALL      CINVP000                      * Check for tobe invoiced
          ENDIF
          GOTO      SADJ9999
.
.         Reason to Lumpsum removal
.
SADJ5000  MATCH     SP70,PTMIS063
          IF        !@EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,SADJ9999
            PACK      PTMIUSR8,PTMIS063,SP70 * Admission User Def field U8
            CALL      UPMISS1
          ENDIF
.
          MATCH     SP70,PTMIS081
          IF        !@EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,SADJ9999
            PACK      PTMICONB,PTMIS081,SP70 * Admission User Def field U8
            CALL      UPMISS1
          ENDIF
          GOTO      SADJ9999
.
SADJ8000  CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SADJ9999
.
          CALL      WEBBOD00   * Output Templated Body of HTML 
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9100  MOVE      "Missing Master record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9200  MOVE      "Missing Admission record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9300  MOVE      "Missing Discharge record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9310  MOVE      "Patient is only Pre Admitted.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9320  MOVE      "Patient is currently on Leave.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9330  MOVE      "Pre Admission has been Cancelled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9340  MOVE      "Patient will be funded by Casepayment.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9350  MOVE      "Patient will not be funded by Casepayment.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9360  MOVE      "Contract Effective Detail Not Set Up.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9400  CLEAR     WEBTITLE
          APPEND    "Warning: Record has partially been updated.",WEBTITLE
          APPEND    "Rates/Item Fees might not be set up !! ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9500  MOVE      "Invoice has been printed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9510  MOVE      "Transfer record missing.",WEBTITLE
          MOVE      ZERO,EXIT                     * warning message
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9520  MOVE      "Transfer record has already been changed.",WEBTITLE
          MOVE      ZERO,EXIT                     * warning message
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9530  CLEAR     WEBTITLE
          APPEND    "Change Time must be after ",WEBTITLE
          APPEND    TTIME,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          MOVE      ZERO,EXIT                     * warning message
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9600  CLEAR     WEBTITLE
          APPEND    ERRORDES,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          MOVE      ZERO,EXIT
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9620  MOVE      "Patient On Leave !! ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9680  MOVE      "No Casemix Funding !! ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9700  MOVE      "No Daily Charge, Default not set up yet !! ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9800  MOVE      "No Additional Charge, Default not set up yet !! ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SADJ9999
.
SADJ9999  RETURN
+
.---------------------------------------------------------------------
.         Read Patient Attributes Table patatraf
.---------------------------------------------------------------------
CCATTR00  PACK      KEY35,URNUMBER,ADMISSNO,ATYPE029,Z70
          CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,CCATTR10
.
          MATCH     URNUMBER,PTARURNO
          GOTO      CCATTR10 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      CCATTR10 IF NOT EQUAL
.
          MATCH     ATYPE029,PTARTYPE          * Is attribute type="029"?
          GOTO      CCATTR10 IF NOT EQUAL      * No, clear fields
          GOTO      CCATTR99 IF EQUAL
.
CCATTR10  CALL      CLPATATR
.
CCATTR99  RETURN
+
.---------------------------------------------------------------------
.         Write Casemix Code Verification to audit patatraf
.---------------------------------------------------------------------
CVERIF00  MATCH     SP70,CCVERIFI
          IF        @EQUAL
            MATCH     KEY1,PTMICMXP
            GOTO      CVERIF10 IF NOT EQUAL  * Casepayment changed
            MATCH     KEY9,PTMIPCMX
            GOTO      CVERIF10 IF NOT EQUAL  * Casemix Code changed
            GOTO      CVERIF99
          ENDIF
.
CVERIF10  CALL      CLPATATR
          MOVE      "029",ATRTYPE
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          MOVE      ATRTYPE,PTARTYPE
          MOVE      CCVERIFI,PTARVAL1
          MOVE      REASONCH,PTARCOD1
          MOVE      PTMIPCMX,PTARTXT1
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          MOVE      PTARCDTE,PTARDATE
          CLOCK     TIME,PTARCTME
          MOVE      PTARCTME,PTARTIME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,URNUMBER,ADMISSNO,ATRTYPE,PTARDATE,PTARTIME,SP70
          CALL      WRPTATR3
.
CVERIF99  RETURN
+
.---------------------------------------------------------------------
.         Display Fees from Stepdown
.---------------------------------------------------------------------
STIV0000  MOVE      ZERO,MANCHNGE
          MOVE      SP70,ERRORDES
          PACK      KEY30,AADMNO,CHNGDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,STIV9000
          MATCH     TADMN,AADMNO
          GOTO      STIV9000 IF NOT EQUAL
          MOVE      TATYPE,SAVATYP
          MOVE      TRBTYP,SAVBTYP
          MOVE      TDISC,SDISC
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,STIV9000
.
          MOVE      ZERO,NBRDAYS
          DAYSEP    ADATE,CHNGDATE,NBRDAYS
.
          MATCH     TDATE,CHNGDATE
          GOTO      STIV1000 IF NOT EQUAL   * must be a stepdown record
          MATCH     "L",TMOVE
          GOTO      STIV9800 IF EQUAL       * on leave
.
          BRANCH    PTTREPSD,STIV3000              * Manual/Bed fees stepdown
.
.         No transaction date for the date, it must be a Stepdown
.
STIV1000  MOVE      ADYHOSP,NEWDHOSP
          CALL      CRAT0000                * Get the current rate of date/time
.
          MOVE      ZERO,BFECOLNO
          CALL      GRAT0000               * generate rate
          BRANCH    NOFEE,STIV9000
          MOVE      DEFCOLNO,BFECOLNO
          MOVE      DEFCOLAD,ADDCOLNO
.
          COMPARE   ONE,CMIXFLAG
          GOTO      STIV2000 IF NOT EQUAL   * per-diem
.
	  CALL      VCMX0000                * Low or high outliers
          MOVE      ZERO,MAXDAY
          MOVE      ZERO,MAXADD
          CALL      CPVAR0000             * Clear variables
.
          MOVE      "0",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get daily Casepayment rate
.         BRANCH    NOFEE,STIV9000
          MOVE      "1",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get additional Casepayment rate
.         BRANCH    NOFEE,STIV9000
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          GOTO      STIV8000
.
.         per-diem
.
STIV2000  IF        CHOSTYP=1
            MATCH     SP70,CONTRCID
            IF        @EQUAL
              MOVE      BFECONTR,CONTRCID   * Use contract from Next Inv.screen
            ENDIF
          ENDIF
          CALL      GTRT0000              * Get max col of bed fees
          GOTO      STIV8000
.
.         Manual bed fees stepdown
.
STIV3000  MOVE      "1",MANCHNGE
          MOVE      TRBEND,TOTDAY
          BRANCH    CMIXFLAG,STIV4000      * Casemix fees
          MOVE      TRATEF,MANSAMNT        * Manual stepdown amount
          ADD       TRATEH,MANSAMNT
.
          MOVE      CHNGDATE,CEFFDATE
          CALL      GTBF0000               * Get bed fees and Contract ID
          BRANCH    NOFEE,STIV9000         * Rates not setup
          MOVE      COUNT,BFECOLNO
          CALL      GTRT0000              * Get max col of bed fees
          BRANCH    NOFEE,STIV9000
          GOTO      STIV8000
.
.         Casemix fees
.
STIV4000  MOVE      ZERO,ADMFLAG           * Not admission program
          MOVE      ONE,MSGFLAG            * no display error message
          MOVE      TATYPE,SAVATYP
.
          MOVE      ADATE,FROMDATE
          CALL      GTDY0000               * get totday
.
          MOVE      TRBEND,BDAYS           * Set up bed days
          PROC      PATGNCMX               * To generate casemix funding
          IF        NOFEE=1
            PACK      ERRORDES,DSCITEM,SP70
            GOTO      STIV9000
          ENDIF
.
          MOVE      ZERO,EXIT
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            MOVE      LUMPAT,PTTRLSPT
            MOVE      LUMHF,PTTRLSRB
          ENDIF
          MOVE      DAYPAT,TRATEF
          MOVE      ADDPAT,PTTRADPT
          MOVE      DAYHF,TRATEH
          MOVE      ADDHF,PTTRADRB
          MOVE      ADDEND,PTTRAEND
          MOVE      DAYEND,TRBEND
          MOVE      DAYEND,EDAYRANG
          MOVE      ADDEND,ADAYRANG
.
          MOVE      DAYCOL,DEFCOLNO      * default colum for daily charge
          MOVE      ADDCOL,DEFCOLAD      * default colum for additional charge
          MOVE      DAYCOL,BFECOLNO
          MOVE      ADDCOL,ADDCOLNO
.
          MOVE      ZERO,MAXDAY
          MOVE      ZERO,MAXADD
          CALL      CPVAR0000             * Clear variables
.
          MOVE      "0",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get daily Casepayment rate
.         BRANCH    NOFEE,STIV9000
          MOVE      "1",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get additional Casepayment rate
.         BRANCH    NOFEE,STIV9000
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          GOTO      STIV9999
.
STIV8000  MOVE      ZERO,EXIT
          GOTO      STIV9999
.
STIV9000  MOVE      ONE,EXIT
          GOTO      STIV9999
.
STIV9800  MOVE      TWO,EXIT
STIV9999  RETURN
.---------------------------------------------------------------------
.         Change date/time must be greater than the last change record
.         of the day
.---------------------------------------------------------------------
CHKTIM00  MOVE      ZERO,EXIT
          PACK      KEY30,AADMNO,CHNGDATE,Z70 * Position read 
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKTIM99
          MATCH     CHNGDATE,TDATE
          GOTO      CHKTIM99 IF NOT EQUAL
          MATCH     TTIME,CHNGTIME
          GOTO      CHKTIM99 IF NOT LESS
CHKTIM90  MOVE      ONE,EXIT
CHKTIM99  RETURN
.-----------------------------------------------------------
.   Checking change date/time
.-----------------------------------------------------------
CKTR0000  CALL      XMLHED00
          BRANCH    EXIT,CKTR9999
          PACK      KEY30,AADMNO,CHNGDATE,CHNGTIME,Z70 * Position read 
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CKTR7000           * Must be outstanding debt pat
          MATCH     AADMNO,TADMN
          GOTO      CKTR7000 IF NOT EQUAL
.
          MATCH     CHNGDATE,TDATE
          GOTO      CKTR6000 IF NOT EQUAL
          MATCH     CHNGTIME,TTIME
          GOTO      CKTR8000 IF EQUAL
.
.         Check if the changed date/time is during leave period
.
CKTR6000  CMATCH    "L",TMOVE
          GOTO      CKTR7000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                            "Patient was On-Leave on this date.":
                            "</RETURN_VALUE>"
          GOTO      CKTR9000
.
CKTR7000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             TDATE,"|",TTIME:
                             "</RETURN_VALUE>"
          GOTO      CKTR9000
.
CKTR8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                         "Change Date & Time already exists in Transfer file.":
                         "</RETURN_VALUE>"
.
CKTR9000  CALL      XMLEND00
CKTR9999  RETURN
+
.-----------------------------------------------------------
.   Get bed fees
.   Calculating the fee for the keyin column number
.-----------------------------------------------------------
GBFE0000  CALL      XMLHED00
          BRANCH    EXIT,GBFE9999
.
          OPEN      PATBFEE1,"patbfeef"
.
          UNPACK    SBFEEKEY,KEY8,SAVATYP,SAVBTYP,SBFEND1,SBFEND2,SBFEND3:
                             SBFEND4,SBFEND5,SBFEND6,CONTRCID
          CALL      RDMISS1
          BRANCH    OVRCD,GBFE9998
.
          MOVE      SBFEND1,BFEND1
          MOVE      SBFEND2,BFEND2
          MOVE      SBFEND3,BFEND3
          MOVE      SBFEND4,BFEND4
          MOVE      SBFEND5,BFEND5
          MOVE      SBFEND6,BFEND6
.
          IF        CFEETYP=0
            CALL      UPKEY000            * Unpack into an array variable
            MOVE      ZERO,SAVEND
            IF        BFECOLNO<>0
              MOVE      BFENDARY[BFECOLNO],SAVEND
            ENDIF
          ELSE
            LOAD      SAVEND WITH BFECOLNO OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
          ENDIF
.
          MOVE      ZERO,FORM1
          PACK      KEY23 WITH ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP
.
          COMPARE   NINE,CFEETYP
          GOTO      GBFE1200 IF EQUAL      * Johns Hopkins bed fees
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,AFUNDH,AFNDTB
          CALL      RDFUND1
          PACK      KEY18 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP
.
GBFE1000  PACK      KEY27 WITH KEY18,CONTRCID,SAVEND
          CALL      RDBFEE1
          BRANCH    OVRCD,GBFE1800
          GOTO      GBFE9000
.
GBFE1200  OPEN      JHSBFEA1,"jhsbfeaf"
          PACK      KEY26 WITH KEY23,SAVEND
          CALL      RDJHBFE1
          BRANCH    OVRCD,GBFE1800
          GOTO      GBFE9000
.
GBFE1800  ADD       ONE,FORM1
          BRANCH    FORM1,GBFE2000,GBFE3000
          MOVE      ONE,OVRCD
          GOTO      GBFE9998
.
GBFE2000  PACK      KEY18,ACLAIM,SP6,SP3,SAVATYP,SAVBTYP
          PACK      KEY23 WITH ACLAIM,SP6,SP8,SAVATYP,SAVBTYP
          GOTO      GBFE1000
.
GBFE3000  IF        IBCNMHOS=1
            MOVE      MULTHOSP,KEY3
            CALL      RDPTHSP1
            BRANCH    OVRCD,GBFE9100
            MOVE      PTHSDCLM,PTCNDCLM
          ENDIF
          PACK      KEY18,PTCNDCLM,SP6,SP3,SAVATYP,SAVBTYP
          PACK      KEY23 WITH PTCNDCLM,SP6,SP8,SAVATYP,SAVBTYP
          GOTO      GBFE1000
.
GBFE9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             BFPAT,"|",BFHF,"|",BFENDDY:
                             "</RETURN_VALUE>"
          GOTO      GBFE9998
.
GBFE9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find Bed Fee ",KEY23:
                             "</RETURN_VALUE>"
          GOTO      GBFE9998

GBFE9998  CALL      XMLEND00
GBFE9999  RETURN
.
.-----------------------------------------------------------
.         Unpack per diem key into an array variable
.-----------------------------------------------------------
UPKEY000  MOVE      ZERO,F3
          UNPACK    PDIEMKEY,KEY20,KEY3,PDIEMKEY
.
UPKEY100  PACK      KEY3,KEY3,SP70
          MATCH     SP70,KEY3
          GOTO      UPKEY999 IF EQUAL
.
          ADD       ONE,F3
          MOVE      KEY3,BFENDARY[F3]
.
          COMPARE   "100",F3
          GOTO      UPKEY999 IF NOT LESS
.
          UNPACK    PDIEMKEY,KEY3,PDIEMKEY
          GOTO      UPKEY100
.
UPKEY999  RETURN
+
.-----------------------------------------------------------
.   Get NZ Private bed fees
.   Calculating the fee for the keyin column number
.-----------------------------------------------------------
GNBF0000  CALL      XMLHED00
          BRANCH    EXIT,GNBF9999
.
          UNPACK    SNZBFKEY,DIM8,KEY8,SAVATYP,SAVBTYP:
                             SBFEND1,SBFEND2,SBFEND3:
                             SBFEND4,SBFEND5,SBFEND6
          MOVE      SBFEND1,BFEND1
          MOVE      SBFEND2,BFEND2
          MOVE      SBFEND3,BFEND3
          MOVE      SBFEND4,BFEND4
          MOVE      SBFEND5,BFEND5
          MOVE      SBFEND6,BFEND6
.
          LOAD      SAVEND WITH BFECOLNO OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
          CALL      RDMISS1
          BRANCH    OVRCD,GNBF9998
.
          MOVE      ZERO,FORM1
GNBF1000  PACK      KEY34 WITH PMVXMHOS,ACLAIM,AFUNDH,AFNDTB:
                               SAVATYP,SAVBTYP,DIM8,SP70
          PACK      KEY37 WITH KEY34,SAVEND,SP70
          OPEN      NZPBFEA1,"nzpbfeaf"
          CALL      RDNZBFE1
          COMPARE   ZERO,OVRCD
          GOTO      GNBF9000 IF EQUAL
.
          ADD       ONE,FORM1
          BRANCH    FORM1,GNBF2000,GNBF3000
          MOVE      ONE,OVRCD
          GOTO      GNBF9998
.
GNBF2000  UNPACK    SP70,AFUNDH,AFNDTB
          GOTO      GNBF1000
.
GNBF3000  IF        IBCNMHOS=1
            MOVE      MULTHOSP,KEY3
            CALL      RDPTHSP1
            BRANCH    OVRCD,GNBF9100
            MOVE      PTHSDCLM,ACLAIM
          ELSE
            MOVE      PTCNDCLM,ACLAIM
          ENDIF
          GOTO      GNBF1000
.
GNBF9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NZBFRATE,"|",NZBFREBA,"|",NZBFEDAY:
                             "</RETURN_VALUE>"
          GOTO      GNBF9998
.
GNBF9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find Bed Fee ",KEY23:
                             "</RETURN_VALUE>"
          GOTO      GNBF9998

GNBF9998  CALL      XMLEND00
GNBF9999  RETURN
.
.-----------------------------------------------------------
.   Get Daily rate for casepayment
.   Calculating the fee for the keyin column number
.-----------------------------------------------------------
GDAY0000  CALL      XMLHED00
          BRANCH    EXIT,GDAY9999
.
          UNPACK    SBFEEKEY,KEY8,SAVBTYP,CMCODE,CONTRCID
          MATCH     SP70,CMCODE
          GOTO      GDAY9998 IF EQUAL
.
          CALL      RDMISS1
          BRANCH    OVRCD,GDAY9998
          IF        ASTAT=3
            CALL      RDDSCH1
          ENDIF
.
          MOVE      "0",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get daily Casepayment rate
.
          MOVE      SP10,PTHFBCAT
          MATCH     SP10,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
          ENDIF
.
          MOVE      SP10,KEY4
          MOVE      DAYENDD[BFECOLNO],KEY4
.
GDAY1000  BRANCH    LOWFLAG,GDAY5000
.
.         Get High outlier charges
.
          PACK      KEY31,SDIM27,KEY4
          CALL      RDPTHDF1
          BRANCH    OVRCD,GDAY9100
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTHDDPAT,"|",PTHDDREB,"|",PTHDEDAY:
                             "</RETURN_VALUE>"
          GOTO      GDAY9998
.
.
.         Get outlier charges
.
GDAY5000  PACK      KEY31,SDIM27,KEY4
          CALL      RDPTLDF1
          BRANCH    OVRCD,GDAY9100
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTLDDPAT,"|",PTLDDREB,"|",PTLDEDAY:
                             "</RETURN_VALUE>"
          GOTO      GDAY9998
.
GDAY9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find Daily rate for casepayment ",KEY31:
                             " Contract: ",CONTRCID:
                             "</RETURN_VALUE>"
          GOTO      GDAY9998
.
GDAY9998  CALL      XMLEND00
GDAY9999  RETURN
+
.-----------------------------------------------------------
.   Get Additional charge for casepayment
.   Calculating the fee for the keyin column number
.-----------------------------------------------------------
GADD0000  CALL      XMLHED00
          BRANCH    EXIT,GADD9999
.
          UNPACK    SBFEEKEY,KEY8,SAVBTYP,CMCODE,CONTRCID
          MATCH     SP70,NEWBTYPE
          IF        !@EQUAL
            MOVE      NEWBTYPE,SAVBTYP
          ENDIF
          MATCH     SP70,CMCODE
          GOTO      GADD9998 IF EQUAL
.
          CALL      RDMISS1
          BRANCH    OVRCD,GADD9998
          IF        ASTAT=3
            CALL      RDDSCH1
          ENDIF
.
          MOVE      "1",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get additional Casepayment rate
.
          MOVE      SP10,PTHFBCAT
          MATCH     SP10,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
          ENDIF
.
          MOVE      SP10,KEY4
          MOVE      ADDENDD[ADDCOLNO],KEY4
.
GADD1000  MOVE      SDIM30,KEY30
.         PACK      KEY30 WITH CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,PTMIPCMX,SAVBTYP
          PACK      KEY34 WITH KEY30,KEY4  
          CALL      RDPTAFE1               * Additional rates
          BRANCH    OVRCD,GADD9100
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTFEDPAT,"|",PTFEDREB,"|",PTFEEDAY:
                             "</RETURN_VALUE>"
          GOTO      GADD9998
.
GADD9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find Additional charge for casepayment ":
                             KEY28:
                             "</RETURN_VALUE>"
          GOTO      GADD9998
.
GADD9998  CALL      XMLEND00
GADD9999  RETURN
.
.-----------------------------------------------------------
.   Check if invoice printed for the date and time
.-----------------------------------------------------------
CINV0000  MOVE      ZERO,EXIT
          REP       " 0",ALACDTE
          MATCH     ADATE,DDATE
          GOTO      CINV1000 IF NOT EQUAL     * Not a daycase
.
          CALL      CHKACCM0                  * Check if accom.has been charged
          BRANCH    EXIT,CINV1200             * Found accommodation record
          GOTO      CINV2000
.
CINV1000  MATCH     ALACDTE,CHNGDATE
          GOTO      CINV2000 IF NOT LESS
.
CINV1200  MOVE      "Invoice printed for this date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CINV9999
.
.         Check for any current force stepdown
.
CINV2000  CALL      GFST0000                  * Get any current force stepdown
          MATCH     SP70,KEY8
          GOTO      CINV9000 IF EQUAL         * no existing force stepdown
.
          MATCH     CHNGDATE,KEY8
          GOTO      CINV9000 IF LESS          * date is after the last stepdown
          GOTO      CINV4000 IF NOT EQUAL
.
          MATCH     CHNGTIME,DIM8
          GOTO      CINV9000 IF LESS
.
CINV4000  UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          CLEAR     WEBTITLE
          APPEND    "Date must be after the Last Force Stepdown Date:",WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " - ",WEBTITLE
          APPEND    TTIME,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CINV9999
.
CINV9000  MOVE      ZERO,EXIT
CINV9999  RETURN
.
.-----------------------------------------------------------
.   Get any current force stepdown date
.-----------------------------------------------------------
GFST0000  MOVE      SP70,KEY8
          MOVE      SP70,DIM8
          PACK      KEY30,AADMNO,Z70          * Position read on the admission
          CALL      RDSTRAN2
GFST1000  CALL      RDPTRAN2
          BRANCH    OVRCD,GFST9999
.
          MATCH     TADMN,AADMNO
          GOTO      GFST9999 IF NOT EQUAL
          MATCH     ANSD,TMOVE
          GOTO      GFST1000 IF EQUAL
          MATCH     ANSA,TMOVE
          GOTO      GFST1000 IF EQUAL
.
          COMPARE   ONE,PTTREPSD
          GOTO      GFST1000 IF NOT EQUAL     * Not a force stepdown record
.
          MOVE      TDATE,KEY8                * found the last stepdown date
          REP       " 0",KEY8
          MOVE      TTIME,DIM8
GFST9999  RETURN
+
.-----------------------------------------------------------
.   Check if patient admitted as casemix
.-----------------------------------------------------------
CPAT0000  MOVE      ZERO,CMIXFLAG
          MOVE      SP70,DEFFEES
.
.         Check if patient admitted as casemix
.
          PACK      KEY30,AADMNO,SP20         * Position read on the admission
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CPAT9999            * Must be outstanding debt pat
          MATCH     AADMNO,TADMN
          GOTO      CPAT9999 IF NOT EQUAL
          CMATCH    ANSA,TMOVE
          GOTO      CPAT9999 IF NOT EQUAL     * First record must be "A"
          MOVE      TATYPE,SAVATYP          * Save original adm.type
.
          CALL      CCPY0000                * Check for casepayment
          COMPARE   ONE,CMXFLAG
          GOTO      CPAT9999 IF NOT EQUAL
.
          MOVE      ZERO,DCFLAG
          MOVE      ONE,CMIXFLAG
.
.         Low or high outliers ? (not discharge,use highoutliers)
.
          CALL      VCMX0000            * Validate casemix code
.
CPAT9999  RETURN
+
.-----------------------------------------------------------
.         Check for Casepayment patient
.-----------------------------------------------------------
CCPY0000  MOVE      ZERO,CMXFLAG
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CCPY9999
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CCPY9999
.
CCPY2000  MATCH     ANSY,PTMICMXP
          GOTO      CCPY8000 IF NOT EQUAL  * No C/P
.
          MOVE      ZERO,LOWFLAG            * initialise low outliers
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
          BRANCH    EXIT,CCPY9999
.
          COMPARE   THREE,ASTAT
          GOTO      CCPY3000 IF NOT EQUAL
.
          MOVE      TWO,PROGFLAG
          MOVE      ONE,MSGFLAG
          CALL      CMXMATRX                * Check for matrix
          MATCH     SP70,CMCODE
          IF        !@EQUAL
            MOVE      CMCODE,PTMIPCMX
            GOTO      CCPY4000
          ENDIF
.
          MATCH     "1",PTMICONB            * Continuous billing?
          GOTO      CCPY4200 IF NOT EQUAL
.
          MATCH     SP70,PTMIPCMX
          GOTO      CCPY4200 IF EQUAL
.
.         If Continous billing is set to Yes and Casemix code is entered
.         charge the daily charge of Casepayment with no Lumpsum
.
          PACK      KEY18,ACLAIM,AFUNDH,PTMIPCMX,SP70
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,CCPY4200
.
          MOVE      ONE,CMXFLAG           * set to casepayment
          MOVE      ZERO,PCFLAG
          MOVE      ANSY,PTMICMXP
          GOTO      CCPY9999
.
CCPY3000  MATCH     SP10,PTMIPCMX           * Casemix code entered?
          GOTO      CCPY5000 IF NOT EQUAL
          MOVE      TWO,PROGFLAG
          MOVE      ONE,MSGFLAG
          CALL      CMXMATRX                * Check for matrix
.
CCPY4000  MOVE      ONE,PROGFLAG
          CALL      CTDY0000                * Check the cut off
          MOVE      TWO,PROGFLAG
.
.         current patient and no matrix found, use provisional code if entered
.
CCPY4200  COMPARE   ONE,CMXFLAG
          GOTO      CCPY8000 IF NOT EQUAL   * if current patient,check prov.code
          MATCH     SP70,CONTRCID
          GOTO      CCPY8000 IF EQUAL
.
          PACK      PTMIPCMX,CMCODE,SP70
          PACK      CASMXKEY,CONTRCID,ACLAIM,PRIMFUND,SAVGCOD,SP70
          CALL      OVRA0000                * Check overnight rate
.
          GOTO      CCPY6000
.
CCPY5000  PACK      KEY18,ACLAIM,AFUNDH,PTMIPCMX,SP70
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,CCPY9999
          MOVE      PTMIPCMX,CMCODE
.
          UNPACK    SP20,PTHFBCAT      * convert "H/F Table" to "Table Type"
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,AFNDTB,SP20
            CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
          ENDIF
.
          PACK      CASMXKEY,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,SP70
          CALL      OVRA0000                * Check overnight rate
.
CCPY6000  CALL      CHKCMXPT
          GOTO      CCPY9999
.
CCPY8000  MOVE      ZERO,CMXFLAG
CCPY9999  RETURN
+
.-----------------------------------------------------------
.         Check Casepayment overnight rate
.-----------------------------------------------------------
OVRA0000
          UNPACK    CASMXKEY,KEY6,KEY3,DIM6,DIM3
          PACK      KEY27,KEY6,KEY3,DIM6,DIM3,CMCODE
          CALL      RDPTHLF1
          IF        OVRCD = 1
            PACK      KEY27,KEY6,KEY3,SP6,SP3,CMCODE
            CALL      RDPTHLF1
            IF        OVRCD = 1
             OPEN      CONTROLF,"controlf"
             READ      CONTROLF,TWENTY;*193,PTCNDCLM
             CALL      DCLM0000
             PACK      KEY27,KEY6,PTCNDCLM,SP6,SP3,CMCODE
             CALL      RDPTHLF1
            ENDIF
          ENDIF
          MOVE      KEY27,CASMXKEY
OVRA9999  RETURN
+
.-----------------------------------------------------------
.       Determine the current rate of the keyin date/time 
.-----------------------------------------------------------
CRAT0000  MOVE      SP3,LATYPE
          MOVE      ZERO,DEFCOLNO
          MOVE      ZERO,DEFCOLAD
          MOVE      ZERO,ADDCOLNO
          MOVE      ADATE,FROMDATE
          MOVE      ZERO,EXIT
.
          PACK      KEY30 WITH AADMNO,SP30
          CALL      RDSTRAN2
CRAT2000  CALL      RDKTRAN2
          BRANCH    OVRCD OF CRAT2400
.
          MATCH     TADMN,AADMNO
          GOTO      CRAT2400 IF NOT EQUAL
.
          MATCH     TDATE,CHNGDATE
          GOTO      CRAT2400 IF LESS
          GOTO      CRAT2200 IF NOT EQUAL
.
          MATCH     TTIME,CHNGTIME
          GOTO      CRAT2400 IF LESS
.
.       Save this rate info as it is < change date/time
.
CRAT2200  BRANCH    CMIXFLAG,CRAT2300
          MATCH     TATYPE,LATYPE
          GOTO      CRAT2300 IF EQUAL
.
          BRANCH    PTCNCNDY,CRAT2300     * don't reset day count
          MOVE      TDATE,FROMDATE
.
CRAT2300  MOVE      TDISC,SDISC           * Default discount
          MOVE      TALLW,SALLW
          MOVE      TRATEF,PATFEE
          MOVE      TRATEH,HFFEE
.
          MOVE      TWARD,LWARD
          MOVE      TBED,LBED
          MOVE      TATYPE,LATYPE
          MOVE      TRBTYP,LRBTYP
          MOVE      TRBTYP,SAVBTYP
          GOTO      CRAT2000
.
CRAT2400  MOVE      LATYPE,SAVATYP
.
          MATCH     SP3,SAVBTYP
          GOTO      CRAT8000 IF NOT EQUAL
.
          PACK      KEY6 WITH LWARD,LBED
          CALL      RDWARD1
          MOVE      WEFRBT,SAVBTYP
.
CRAT8000  MATCH     SP10,NEWBTYPE
          IF        !@EQUAL
            MOVE      NEWBTYPE,SAVBTYP     * use the new bed type
          ENDIF
.
          COMPARE   ONE,CMIXFLAG
          GOTO      CRAT9000 IF NOT EQUAL  * Not casepayment - no Unqualified
.
          MATCH     "1",DISPSTEP
          GOTO      CRAT9000 IF NOT EQUAL  * Not from Next invoice screen
.
          PACK      KEY5,ANSA,SP1,SAVATYP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "U",TCINDC12
            IF         @EQUAL
              MOVE       ZERO,CMIXFLAG
            ENDIF
          ENDIF
.
CRAT9000  PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CRAT9999
          MOVE      ZERO,BFECOLNO
          CALL      GRAT0000               * generate rate
          MOVE      DEFCOLNO,BFECOLNO
          MOVE      DEFCOLAD,ADDCOLNO
.
CRAT9999  RETURN
+
.-----------------------------------------------------------
.  Generate rate for the bed type
.-----------------------------------------------------------
GRAT0000  MOVE     ADATE,FROMDATE
.
          BRANCH   CMIXFLAG,GRAT1000    * Casemix
          IF       PTCNCNDY<>1
            MOVE     CHNGDATE,STODATE
            CALL     PTRN0000           * Get last date the adm.type changed
          ENDIF
.
GRAT1000  CALL      GTDY0000            * get totday
.
          COMPARE   ONE,CMIXFLAG 
          GOTO      GRAT5000 IF NOT EQUAL       * Not Casepayment
.
          MOVE      PTMIPCMX,CMDRG
          MOVE      TOTDAY,BDAYS
.         ADD       ONE,BDAYS
          MOVE      ZERO,ADMFLAG       * Not admission progam
          MOVE      ONE,MSGFLAG        * no display error message
          PROC      PATGNCMX           * Generate casemix funding 
          IF        NOFEE=1
            PACK      ERRORDES,DSCITEM,SP70
            GOTO      GRAT9999
          ENDIF
.
          MOVE      DAYEND,SAVEND      * save new rates informations
          MOVE      ADDEND,SAVAEND
          MOVE      DAYEND,EDAYRANG
          MOVE      ADDEND,ADAYRANG
          MOVE      DAYPAT,PATFEE
          ADD       ADDPAT,PATFEE
          MOVE      DAYHF,HFFEE
          ADD       ADDHF,HFFEE
          MOVE      DAYCOL,DEFCOLNO      * default colum for daily charge
          MOVE      ADDCOL,DEFCOLAD      * default colum for additional charge
.

          MOVE      DAYPAT,BFEEAMNT
          ADD       ADDPAT,BFEEAMNT
          MOVE      SP2,AALLOW
          MOVE      SDISC,DISCAMNT
          MOVE      SALLW,ALLWAMNT
.
          MOVE      DAYPAT,PPORAMNT
          MOVE      DAYHF,RPORAMNT
          MOVE      ADDPAT,PADDAMNT
          MOVE      ADDHF,RADDAMNT
          BRANCH    EXIT,GRAT9999
          GOTO      GRAT9999             * ok to post
.
.
.       Save the computer generate rate before bed type changed
.
GRAT5000  MOVE      SAVATYP,TATYPE
          MOVE      SAVBTYP,TRBTYP
.
          COMPARE   ZERO,CFEETYP
          GOTO      GRAT7000 IF EQUAL         * using bed fees file
          COMPARE   FIVE,CFEETYP
          GOTO      GRAT9999 IF NOT EQUAL
.
GRAT6000  CALL      NZBF0000                  * Get NZ Private bed fees
          GOTO      GRAT8000
.
GRAT7000  MOVE      CHNGDATE,DATFIELD
          MOVE      DATFIELD,CEFFDATE
          CALL      GTBF0000                  * Get bed fees
.
GRAT8000  BRANCH    NOFEE,GRAT9999            * Rates not setup
.
          MOVE      COUNT,DEFCOLNO
          MOVE      SBFPAT,RCGPAT
          MOVE      SBFHF,RCGHF
          MOVE      SBFENDDY,SAVEND
          MOVE      SBFENDDY,REDAYS
          SUB       TOTDAY,REDAYS
          ADD       ONE,REDAYS
.
          MOVE      SBFPAT,BFEEAMNT
          ADD       SBFHF,BFEEAMNT
          MOVE      SP2,AALLOW
          MOVE      SDISC,DISCAMNT
          MOVE      SALLW,ALLWAMNT
.
          MOVE      SBFPAT,PPORAMNT
          MOVE      SBFHF,RPORAMNT
          MOVE      SBFENDDY,EDAYRANG
GRAT9999  RETURN
+
.-----------------------------------------------------------
.         Get totday 
.-----------------------------------------------------------
GTDY0000
          MOVE      ZERO,TOTDAY
          MATCH     ADATE,DDATE
          GOTO      GTDY3000 IF EQUAL
.
          MOVE      CHNGDATE,TODATE
          MOVE      LWARD,TWARD
          MOVE      LBED,TBED
          MOVE      SAVBTYP,KEY3
          CALL      SPBD0000            * Check for speciality bed type
          BRANCH    EXIT,GTDY1200
.
          MOVE      ZERO,NBRDAYS
          CALL      NHOSPDAY              * get the length of stay
.
          COMPARE   ONE,CMIXFLAG
          GOTO      GTDY0800 IF NOT EQUAL
.
          MATCH     "1",DISPSTEP
          IF        @EQUAL
            MOVE      ADATE,FROMDATE
            MOVE      SP70,SAVIND12
            PROC      PATDATYP            * Get LOS excluding Unqualified days
            GOTO      GTDY2000
          ENDIF
.
GTDY0800  MATCH     ACLAIM,PTCNCLEV
          GOTO      GTDY2000 IF NOT EQUAL   * not a TAC Claim
.
.         Include Leave days for bedfees stepdown
.
          MOVE      ZERO,NBRDAYS
          DAYSEP    FROMDATE,TODATE,NBRDAYS
          GOTO      GTDY2000
.
GTDY1200  MOVE      TCINDC6,SAVIND6   * get no of days in specialty bed
          PROC      PATSBTYP
.
GTDY2000  MOVE      NBRDAYS,TOTDAY
          ADD       ONE,TOTDAY
.
          MATCH     ADATE,FROMDATE
          GOTO      GTDY4000 IF NOT EQUAL
.
GTDY3000  ADD       NEWDHOSP,TOTDAY      * include hospitalisation
.
GTDY4000  MOVE      ZERO,NOHOSP
          MATCH     ADATE,DDATE
          IF        !@EQUAL
            COMPARE   ZERO,TOTDAY
            GOTO      GTDY9999 IF EQUAL
.
            MOVE      TOTDAY,FORM3
            SUB       ONE,FORM3
            MOVE      FORM3,NOHOSP
          ENDIF
.
GTDY9999  RETURN
+
.-----------------------------------------------------------
.  Stepdown
.-----------------------------------------------------------
STPD0000  MOVE      ZERO,EXIT
.
.         If this is coming from Bed transfer, add one second to the change time
.
          MATCH     "1",TRANFLAG
          IF        @EQUAL
            UNPACK    CHNGTIME,HOUR,D1,MIN,D1,KEY2
            PACK      XDATTIME,CHNGDATE,HOUR,MIN,KEY2,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
.                                                  * to stop duplicate key
            UNPACK    XDATTIME,CHNGDATE,HOUR,MIN,KEY2
            PACK      CHNGTIME,HOUR,COLON,MIN,COLON,KEY2
          ENDIF
          CALL      CPAT0000                * check if patient admitted as C/P
.
          PACK      KEY30 WITH AADMNO,SP30
          CALL      RDSTRAN2
STPD1000  CALL      RDKTRAN2
          BRANCH    OVRCD OF STPD3000
.
          MATCH     TADMN,AADMNO
          GOTO      STPD3000 IF NOT EQUAL
.
          MATCH     TDATE,CHNGDATE
          GOTO      STPD3000 IF LESS
          GOTO      STPD2000 IF NOT EQUAL
.
          MATCH     TTIME,CHNGTIME
          GOTO      STPD3000 IF LESS
.
STPD2000  MOVE      TWARD,LWARD
          MOVE      TBED,LBED
          MOVE      TRBTYP,LRBTYP
          MOVE      TATYPE,LATYPE
          MOVE      TADOCT,LADOCT
          MOVE      TDEPT,LDEPT
          MOVE      PTTREPSD,SPTTREPS
          GOTO      STPD1000
.
STPD3000  MATCH     "1",TRANFLAG
          GOTO      STPD3800 IF NOT EQUAL
          MATCH     NEWBTYPE,TRBTYP
          GOTO      STPD3800 IF NOT EQUAL  * change of bed type
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,STPD9999
          CALL      GRAT0000               * generate rate
.
          COMPARE   DEFCOLNO,BFECOLNO
          GOTO      STPD3800 IF NOT EQUAL  * Bed fee column has changed
.
          MATCH     "015",TEMPLATE
          IF        @EQUAL
            COMPARE   ADDCOLNO,DEFCOLAD
            GOTO      STPD5000 IF EQUAL
          ENDIF
.
STPD3800  MOVE      LWARD,TWARD
          MOVE      LBED,TBED
          MOVE      NEWBTYPE,TRBTYP                * was SAVBTYP      *C-141218
          MOVE      LATYPE,TATYPE
          MOVE      LADOCT,TADOCT
          MOVE      LDEPT,TDEPT
          MOVE      "C",TMOVE
          MOVE      AURNO,TURNO
          MOVE      AADMNO,TADMN
          MOVE      CHNGDATE,TDATE
          MOVE      CHNGTIME,TTIME
          MOVE      PPORAMNT,TRATEF
          MOVE      RPORAMNT,TRATEH
          MOVE      DISCAMNT,TDISC
          MOVE      ALLWAMNT,TALLW
          MOVE      EDAYRANG,TRBEND
          MOVE      SP3,TCHSTAT
          MOVE      ZERO,TEXTRA
          MOVE      ZERO,PTTRLSPT       * Lumpsum
          MOVE      ZERO,PTTRLSRB
          IF        CMIXFLAG<>1
            MOVE      ONE,PTTREPSD          * flag for force stepdown
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MOVE      PADDAMNT,PTTRADPT
            MOVE      RADDAMNT,PTTRADRB
            MOVE      ADAYRANG,PTTRAEND
          ELSE
            MOVE      ZERO,PTTRAEND        * ending day
            MOVE      ZERO,PTTRADRB        * additional rate
            MOVE      ZERO,PTTRADPT
          ENDIF
.
.         PERFORM   PTCNADDC,XTRA0000   * get the extra charge
.
          MOVE      SP3,PTTRLTYP            * clear type of leave value
          MOVE      PASSCODE,PTTROPER       * operator Id
          PACK      PTTRSPAR,SP20,SP20,SP20
.
          PACK      KEY30 WITH TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            MOVE      ACLAIM,PTTRCLTY
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      WBSEUID,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN2               * Write to the trans file
          ELSE
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ENDIF
.
.         Update the bed fee rate from this point
.
          PACK      KEY30 WITH AADMNO,CHNGDATE,CHNGTIME,SP30
          CALL      RDSTRAN2
STPD4000  CALL      RDKTRAN2
          BRANCH    OVRCD OF STPD9999
.
          MATCH     AADMNO,TADMN
          GOTO      STPD9999 IF NOT EQUAL
.
          MOVE      PPORAMNT,TRATEF
          MOVE      RPORAMNT,TRATEH
          MOVE      EDAYRANG,TRBEND
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MOVE      PADDAMNT,PTTRADPT
            MOVE      RADDAMNT,PTTRADRB
            MOVE      ADAYRANG,PTTRAEND
          ENDIF
.
          MOVE      ZERO,TEXTRA
.         MOVE      NEWBTYPE,TRBTYP
.
.         The rest of records after the keyin date/time, will not be 
.         a force stepdown 
.
          MATCH     TDATE,CHNGDATE
          IF        !@EQUAL
            MOVE      ZERO,PTTREPSD     * not a force stepdown
          ENDIF
.
.         PERFORM   PTCNADDC,XTRA0000   * get the extra charge
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          PACK      DIM30 WITH TADMN,TDATE,TTIME,SP8
.
.         Write  to change rate file
.
          BRANCH    CAUDQ,STPD5000           * added for V5.01.15 - SRF 105195
.
STPD4200  OPEN      PATRCAUD,"patrcaud"
          MOVE      "PUR",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
          CALL      RDSRCA
.
          COMPARE   ZERO TO RSTATUS
          GOTO      STPD4400 IF EQUAL
.
          CALL      RELSLK00        * Release System Lock Audits
          CLOSE     PATRCAUD
.         KEYIN     *P1:24,*EL,*B,"Rate Change Audit in use please wait ":
.                   "until free then hit",*V2LON," <RETURN> ",ANS:
.                   *P1:24,*EL;
.         GOTO      STPD4200
          GOTO      STPD5000
.
STPD4400  CALL      WRIRCA
          CALL      RELSLK00        * Release System Lock Audits
          MOVE      AADMNO,RADMNO
          MOVE      PGNAME,ANS
          PACK      RNAME WITH ANS,DOT,PSNAME
          MOVE      ACLAIM,RCLAIM
          MOVE      AFUNDH,RFUND
          MOVE      AFNDTB,RHFTAB
          MOVE      SAVBTYP,RBTYPE
.
          MOVE      ZERO,RNPAT        * New rate = rate - disc - allow
          MOVE      PPORAMNT,RNPAT
          SUB       DISCAMNT,RNPAT
          SUB       ALLWAMNT,RNPAT
          MOVE      RPORAMNT,RNFUND     * from  PATDSBFE
          MOVE      TDATE,RDATE
          MOVE      TATYPE,RATYPE
          MOVE      ZERO,ROPAT
          MOVE      SP3,RCLSS
          MOVE      SP3,RCHST
          MOVE      PASSCODE,ROPER       * Operator code
.
          CALL      WRRCA
          CLOSE     PATRCAUD
.
.         Reposition to the previous trans record
.
STPD5000  MOVE      DIM30,KEY30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          GOTO      STPD4000
.
STPD9999  RETURN
.-----------------------------------------------------------
.  Stepdown - update admission record
.-----------------------------------------------------------
STUD0000  CALL      CPAT0000                * check if patient admitted as C/P
          CALL      CRAT0000                * Get the current rate of date/time
          BRANCH    EXIT,STUD9999
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,STUD9900
.
          MATCH     TADMN,AADMNO
          GOTO      STUD9900 IF NOT EQUAL
.
          MATCH     "007",TEMPLATE      * Setup bedfees for 'Return' record
          GOTO      STUD0400 IF EQUAL
          MATCH     "009",TEMPLATE      * Setup casemix fees for 'Return' record
          GOTO      STUD0400 IF EQUAL
.
          MATCH     "006",TEMPLATE
          GOTO      STUD0600 IF EQUAL   * Setup bedfees for admission
          MATCH     "013",TEMPLATE
          GOTO      STUD0600 IF EQUAL   * Setup bedfees for admission
          MATCH     "008",TEMPLATE
          GOTO      STUD0600 IF EQUAL   * Setup casemix fees for admission
.
STUD0400  MATCH     "R",TMOVE
          GOTO      STUD9910 IF NOT EQUAL
          GOTO      STUD0800
.
STUD0600  MATCH     "A",TMOVE
          GOTO      STUD9910 IF NOT EQUAL
.
STUD0800  MATCH     SAVBTYP,TRBTYP
          GOTO      STUD1000 IF NOT EQUAL    * bed type has been changed
.
          MATCH     "013",TEMPLATE
          GOTO      STUD4000 IF EQUAL        * change bed type after Admission
.
.         If this comes from Admission screen, only set pttrepsd to one if
.         bed fee column number has been changed
.
          MATCH     "006",TEMPLATE
          GOTO      STUD0820 IF EQUAL
          MATCH     "007",TEMPLATE
          GOTO      STUD0900 IF NOT EQUAL
.
STUD0820  COMPARE   DEFCOLNO,BFECOLNO
          GOTO      STUD4000 IF EQUAL      * Bed fee column hasn't changed
          GOTO      STUD1000
.
STUD0900  IF        CMXFLAG=1
            COMPARE   ADAYRANG,PTTRAEND
            GOTO      STUD1000 IF NOT EQUAL
            COMPARE   EDAYRANG,TRBEND
            GOTO      STUD4000 IF EQUAL
          ELSE
            COMPARE   EDAYRANG,TRBEND
            GOTO      STUD4000 IF EQUAL
          ENDIF
.
STUD1000  IF        CMXFLAG=1
            MOVE      PADDAMNT,PTTRADPT
            MOVE      RADDAMNT,PTTRADRB
          ELSE
            MOVE      ONE,PTTREPSD
          ENDIF
          MOVE      PPORAMNT,TRATEF
          MOVE      RPORAMNT,TRATEH
.
STUD2000  MOVE      SAVBTYP,TRBTYP
          MOVE      DISCAMNT,TDISC
          MOVE      ALLWAMNT,TALLW
          MOVE      EDAYRANG,TRBEND
          IF        CMXFLAG=1
            MOVE      ADAYRANG,PTTRAEND
          ENDIF
.
STUD3000  UNPACK    TTIME,HOUR,D1,MIN,D1,KEY2
          PACK      XDATTIME,TDATE,HOUR,MIN,KEY2,SP70
          CALL      ASEC0000                     * add 1 sec to date/time
.                                                * to stop duplicate key
          UNPACK    XDATTIME,TDATE,HOUR,MIN,KEY2
          PACK      TTIME,HOUR,COLON,MIN,COLON,KEY2
.
          PACK      KEY30 WITH TADMN,TDATE,TTIME,TWARD,TBED
          CALL      RDATRAN2
          COMPARE   ZERO,OVRCD
          GOTO      STUD3000 IF EQUAL
.
          MOVE      "C",TMOVE
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      WRTRAN2             * Write to the trans file
.
STUD4000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            IF        NEWDHOSP<>9999
              MOVE      NEWDHOSP,ADYHOSP  * Update new hospitalisation days
            ENDIF
          ENDIF
          GOTO      STUD9999
.
STUD9900  MOVE      TWO,EXIT
          GOTO      STUD9999
.
STUD9910  MOVE      THREE,EXIT
          GOTO      STUD9999
.
STUD9999  RETURN
+
.***************************************************************************
.*                                   XTRA0000                              *
.*           Do all the required processing for additional charging        *
.***************************************************************************
XTRA0000  
.         OPEN      PATACHA1,"patachaf"
.         OPEN      PATNHHA1,"patnhhaf"
.         PACK      KEY6,ACLAIM,TATYPE
.         CALL      RDPTNH1                 * read the NHH additional charging
.         BRANCH    OVRCD,XTRA9900            file
.
.         PACK      KEY16,AADMNO,TDATE
.         CALL      RDPTAH1                 * read additional charging history
.         IF        OVRCD = 1
.           CALL      RPPTAH1               * get previous additional charging
.           BRANCH    OVRCD,XTRA9900          history record
.
.           COMPARE   AADMNO,PTAHADMN       * compare admission numbers
.           GOTO      XTRA9900 IF NOT EQUAL
.         ELSE
.           CALL      DEPTAH1               * delete the current record from
.                                             the additional charging history
.         ENDIF
.
.         MOVE      ZERO,TEXTRA
.         ASSIGN    TRATEF + TRATEH - TDISC - TALLW,MINICH
.         ASSIGN    (PTAHANNI * PTNHPERC)/36500.00,DAILYCH
.         IF        DAILYCH > PTNHMAXD
.           MOVE      PTNHMAXD,DAILYCH
.           ASSIGN    DAILYCH - MINICH,TEXTRA
.         ELSE
.           IF        DAILYCH < MINICH
.             MOVE      MINICH,DAILYCH
.             MOVE      ZERO,TEXTRA
.           ELSE
.             ASSIGN    DAILYCH - MINICH,TEXTRA
.           ENDIF
.         ENDIF
.
.------ write to the additional charging history file ------
.
XTRA1000
.         MOVE      TDATE,PTAHDATE
.         REP       " 0",PTAHDATE
.         PACK      KEY16,AADMNO,PTAHDATE
.         MOVE      DAILYCH,PTAHTOTL
.         PACK      PTAHSPAR,SP20,SP20,SP10
.
.         CALL      WRPTAH1                 * write to additional charging
.                                             history file
.------ delete subsequent records from the additional charging history ------
.------ file ------
.
XTRA2000 
.         CALL      RSPTAH1
.         CALL      RKPTAH1
.         BRANCH    OVRCD,XTRA9900
.
.         COMPARE   PTAHADMN,AADMNO         * compare admission numbers
.         GOTO      XTRA9900 IF NOT EQUAL
.
.         PACK      KEY16,PTAHADMN,PTAHDATE
.         CALL      DEPTAH1                 * delete from the additional 
.                                             charging history file
.         GOTO      XTRA2000
.
.------ close the files ------
.
XTRA9900  
.         CLOSE     PATACHA1
.         CLOSE     PATNHHA1
.
XTRA9999  RETURN
+
.-----------------------------------------------------------
.  Validate miscellaneous charge item
.-----------------------------------------------------------
VMSC0000  MOVE       ZERO,EXIT
          MOVE       ZERO,FORM1
.
          UNPACK    SP20,PTHFBCAT      * convert "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
.
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,ITEMCODE,TRANDATE,SP10
          CALL      PATMCHRD                * find Miscellaneous Charge Item
          IF        EXIT = 1
            PACK      KEY29,ACLAIM,SP6,SP3,ITEMCODE,TRANDATE,SP10
            CALL      PATMCHRD              * find Miscellaneous Charge Item
            IF        EXIT = 1
              CALL      DCLM0000
              PACK      KEY29,PTCNDCLM,SP6,SP3,ITEMCODE,TRANDATE,SP10
              CALL      PATMCHRD            * find Miscellaneous Charge Item
              BRANCH    EXIT,VMSC9100       * not found or invalid
            ENDIF
          ENDIF
.
.        Check if this item is H.F. Adjustment code
.
VMSC5000 COMPARE    THREE,MITMTYP
         GOTO       VMSC9100 IF NOT EQUAL
.
         MOVE       MPATPOR,FORM62
         ADD        MHFPOR,FORM62
.
.        The sum of HF and patient portion has to be zero, but at least one
.        of them is not zero.
.
          COMPARE    ZERO,FORM62
          GOTO       VMSC9100 IF NOT EQUAL
          COMPARE    ZERO,MPATPOR
          GOTO       VMSC9100 IF EQUAL
.
.         Valid code
.
.         Check if the amount keyin is greater than the actual rebate amount
.
          COMPARE    REBTAMNT,REBTOT
          GOTO       VMSC9200 IF LESS
.
          MOVE       REBTAMNT,TPATAMTP
          MOVE       TPATAMTP,TREBATE
          MULT       "-1",TREBATE
          GOTO       VMSC9999
.
VMSC9100  MOVE       "Invalid Misc.Health Fund Adjustment Code.",WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VMSC9999
.
VMSC9200  CLEAR      WEBTITLE
          APPEND     "The amount must be less than $ ",WEBTITLE
          APPEND     REBTOT,WEBTITLE
          APPEND     SP70,WEBTITLE
          RESET      WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VMSC9999
.
VMSC9999  RETURN
+
.-----------------------------------------------------------
.  Update - Front end deductibles option
.-----------------------------------------------------------
UPDFED00  MOVE      AADMNO,KEY8
          CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,AADMNO,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      UPDFED00 IF EQUAL
.
          MOVE      AADMNO,PMMIVISN
          MOVE      PVITRAN,PMMITRAN
          PACK      TDCODE,PMMIURNO
          MOVE      " 3",PMMISYST
.
          MOVE      MCHARGE,PMMIITEM
          MOVE      MDESC,PMMIDESC
          PACK      PMMIDES2,SP20,SP20
          REP       " 0",TRANDATE
          MOVE      TRANDATE,PMMITDAT
          MOVE      MITMTYP,PMMIRTYP
.
          MOVE      SP2,PMMISESS
          MOVE      SP10,PMMIREFN
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MNINV,PMMIINVN
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
          MOVE      SP6,PMMITDOC
          MOVE      ZERO,PMMISERV
          MOVE      SP6,PMMIODOC
          MOVE      "FRONTEND",PMMIBTCH
          MOVE      ZERO,PMMIGSTA           * GST Applicable
          MOVE      SP6,PMMIGSTC            * GST Code
          MOVE      ZERO,PMMIGSTM           * GST Amount
          MOVE      WBSEUID,PMMIWUSR        * User id
          UNPACK    SP70,PMMICNTR,PMMISUNQ 
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
.
          CALL      WRPMMTI1
.
          MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          MOVE      TTRANSN1,ATRANNO
          CALL      UPLMISS1
.
UPDFED99  RETURN
+
.-----------------------------------------------------------
.  Validate casemix code
.-----------------------------------------------------------
VCMX0000  MOVE      ZERO,EXIT
          MOVE      ZERO,LOWFLAG            * initialise low outliers
          IF        DCFLAG = 0 & ASTAT = 3
            CALL      OUTL0000              * Check for low or high outliers
          ENDIF
VCMX9999  RETURN
+
.******************************************************************************
.             Check the LOS with the cutoff day
.******************************************************************************
OUTL0000  MOVE      ZERO,LOWFLAG          * default to high outliers
          MOVE      ADATE,FROMDATE
          PACK      TODATE,CCC,CYY,CDD,CMM  * Default to current date
          REP       " 0",TODATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE
          ENDIF
          CALL      NHOSPDAY              * get the length of stay
          ADD       ONE,NBRDAYS
.
          CALL      VLUM0000              * read overnight lumpsum file
          BRANCH    NOFEE,OUTL9999        * to get the cutoff day
.
          IF        NBRDAYS <= PTHLCOFF
            MOVE      ONE,LOWFLAG         * set flag to low outliers
          ENDIF
          GOTO      OUTL9999
OUTL9999  RETURN
+
.-----------------------------------------------------------
.  Update Admission/Discharge UDF
.-----------------------------------------------------------
CHKUDF00  COMPARE   ZERO,PTCNCMAU
          GOTO      CHKUDF50 IF EQUAL
.
          MATCH     Z70,UDFADMIS
          GOTO      CHKUDF50 IF EQUAL
.
          MOVE      SP70,KEY3
          LOAD      KEY3,PTCNCMAU,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                         AUSR7,PTMIUSR8,PTMIUSR9,PTMIUSR0
.
          MATCH     KEY3,UDFADMIS               * Matrix Admission UDF changed
          GOTO      CHKUDF50 IF EQUAL
.
          STORE     UDFADMIS,PTCNCMAU,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                         AUSR7,PTMIUSR8,PTMIUSR9,PTMIUSR0
.
          CALL      UPMISS1                     * Update admission
.
CHKUDF50  COMPARE   THREE,ASTAT                 * patient discharged
          GOTO      CHKUDF99 IF NOT EQUAL
.
          COMPARE   ZERO,PTCNCMDU
          GOTO      CHKUDF99 IF EQUAL
.
          MATCH     Z70,UDFDISCH
          GOTO      CHKUDF99 IF EQUAL
.
          MOVE      SP70,KEY3
          LOAD      KEY3,PTCNCMDU,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
.
          MATCH     KEY3,UDFDISCH               * Matrix Discharge UDF changed
          GOTO      CHKUDF99 IF EQUAL
.
          STORE     UDFDISCH,PTCNCMDU,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
.
          CALL      UPDSCH1                     * Update discharge
.
CHKUDF99  RETURN
+
.-----------------------------------------------------------
.  Update Casemix Code
.-----------------------------------------------------------
UPDCMX00  MOVE      ZERO,NOFEE
.
.         If casemix code has changed, but casepayment indicator is still 'No'
.         we do not need to recalculate trans or items 
.
          MATCH     "N",PTMICMXP
          IF        @EQUAL
            MATCH     KEY1,PTMICMXP
            GOTO      UPDCMX20 IF EQUAL     * just update the casemix code
          ENDIF
.
          MOVE      ZERO,CMIXFLAG
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MOVE      ONE,CMIXFLAG          * casemix 
          ENDIF
.
          MOVE      ADATE,NDATE             * set date to use admission date
          MOVE      ATIME,TTIME2            * use admission time
          CALL      CTRN0000                * Check for valid rates on each trns
          CALL      FTHR0000                * fix theatre/misc.charge
.
UPDCMX20  IF        ASTAT = 3 
            MATCH     SP4,PTDSDDRG
            IF        !@EQUAL
              UNPACK    SP10,KEY4,KEY5
              UNPACK    PTMIPCMX,KEY4,KEY5
              MATCH     SP5,KEY5
              IF        @EQUAL
.               PACK      PTDSDDRG,PTMIPCMX,SP20    * Use discharge DRG code
                CALL      UPDSCH1
              ENDIF
            ENDIF
          ENDIF
          CALL      UPMISS1             * Update casemix code
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATCHXA1,"patchxaf"
          TRAPCLR   IO
.
          BRANCH    OVRCD,UPDCMX99
          CALL      IBACLOCK
          PACK      PTCHDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTCHDATE
          CLOCK     TIME,PTCHTIME
          MOVE      AADMNO,PTCHADMN
          PACK      KEY24,AADMNO,PTCHDATE,PTCHTIME,SP70
          CALL      RAPTCHX1
          IF        OVRCD<>1
            GOTO      UPDCMX99
          ENDIF
          PACK      PTCHCODE,OLDCASEM,SP70
          CALL      WRPTCHX1
.
UPDCMX99  RETURN
+
.******************************************************************************
.         Check transfer record 
.******************************************************************************
CTRN0000  PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF                  * Get Contract Effective From
.
          PACK      KEY30,AADMNO,ADATE,SP20
          CALL      RDSTRAN2
CTRN1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CTRN9999
.
          MATCH     AADMNO,TADMN
          GOTO      CTRN9999 IF NOT EQUAL
.
          MOVE      TRBTYP,SAVBTYP
.
.         Change from casemix to normal fees, check each trans record 
.
.         If we are changing to casemix funding or normal bed fee, we need to
.         find the length of stay
.
CTRN2000  MOVE      ZERO,TOTDAY              * initialise bed days
.
          IF        ASTAT = 3
            MATCH     DDATE,ADATE
            IF        @EQUAL
              MOVE      ONE,TOTDAY             * daycase
              GOTO      CTRN2500
            ENDIF
          ENDIF
.
.         IF        CHOSTYP = 0 & CMIXFLAG <> 1
            MOVE      ADYHOSP,TOTDAY         * Include days of hospitalisation
.         ENDIF
          MOVE      ADATE,FROMDATE
          MOVE      TDATE,TODATE
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      TRBTYP,KEY3
          CALL      SPBD0000            * Check for speciality bed type
          IF        EXIT=1
            MOVE      TCINDC6,SAVIND6   * get no of days in specialty bed
            PROC      PATSBTYP
            GOTO      CTRN2200
          ENDIF
.
          IF        CMXFLAG<>1
            MOVE     TDATE,STODATE
            CALL     PTRN0000           * Get last date the adm.type changed
          ENDIF
          CALL      NHOSPDAY
.
CTRN2200  ADD       NBRDAYS,TOTDAY
          ADD       ONE,TOTDAY
.
          MOVE      DIM30,KEY30
          CALL      RDTRAN2                * Reposition
.
CTRN2500  BRANCH    CMIXFLAG,CTRN3000      * Check for casemix funding rates
.
.         Check if bed fees setup 
.
          MOVE      TATYPE,ATYPE
          IF        CFEETYP=5
            CALL      NZBF0000             * Get NZ Private bed fees
          ELSE
            MOVE      TDATE,CEFFDATE
            CALL      GTBF0000             * Get bed fees
          ENDIF
          BRANCH    NOFEE,CTRN3200       * Rates not setup
.
          MOVE      SBFENDDY,TRBEND
          MOVE      SBFPAT,TRATEF          * new bed fee
          MOVE      SBFHF,TRATEH
          MOVE      ZERO,PTTRLSPT          * zero lumpsums
          MOVE      ZERO,PTTRLSRB
          MOVE      ZERO,PTTRADPT          * zero additional rates
          MOVE      ZERO,PTTRADRB
          GOTO      CTRN4000
.
.         Check if Casemix funding rates setup
.
CTRN3000  MOVE      ZERO,ADMFLAG           * Not admission program
          MOVE      ONE,MSGFLAG            * no display error message
          MOVE      TATYPE,SAVATYP
          MOVE      TOTDAY,BDAYS           * Set up bed days
          PROC      PATGNCMX               * To generate casemix funding
          IF        NOFEE=1
            PACK      ERRORDES,DSCITEM,SP70
            GOTO      CTRN3200
          ENDIF
.
          MOVE      ZERO,EXIT
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            MOVE      LUMPAT,PTTRLSPT
            MOVE      LUMHF,PTTRLSRB
          ENDIF
          MOVE      DAYPAT,TRATEF
          MOVE      ADDPAT,PTTRADPT
          MOVE      DAYHF,TRATEH
          MOVE      ADDHF,PTTRADRB
          MOVE      ADDEND,PTTRAEND
          MOVE      DAYEND,TRBEND
          GOTO      CTRN4000
.
CTRN3200  MOVE      ZERO,TRATEF
          MOVE      ZERO,PTTRADPT
          MOVE      ZERO,TRATEH
          MOVE      ZERO,PTTRADRB
          MOVE      ZERO,PTTRAEND
          MOVE      ZERO,TRBEND
          MOVE      ZERO,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.
CTRN4000  IF        PTTREPSD<>2
            MOVE      ZERO,PTTREPSD * Reset manual stepdown
          ENDIF
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      CTRN1000        * check the next rates
.
CTRN9999  RETURN
+
.============================================================================== 
.         Get the last date change of admission type 
.==============================================================================
GTRN0000  MOVE      ADATE,FROMDATE
          MOVE      ADATE,DIM8
          PACK      KEY30 WITH AADMNO,ZED30
          CALL      RDSTRAN2
GTRN1000  CALL      RDPTRAN2
          BRANCH    OVRCD OF GTRN9999
.
          MATCH     TADMN,AADMNO            * same admission number ?
          GOTO      GTRN9999 IF NOT EQUAL   * no
.
          MATCH     ATYPE,TATYPE            * check if adm type changed ?
          GOTO      GTRN2000 IF EQUAL       * no
          MOVE      DIM8,FROMDATE          * date adm type changed ?
          GOTO      GTRN9999
.
GTRN2000  MOVE      TDATE,DIM8
          GOTO      GTRN1000
.
GTRN9999  RETURN
+
.==============================================================================
.         Get the last date change of admission type prior the STODATE
.==============================================================================
PTRN0000  MOVE      ADATE,FROMDATE
          MOVE      ADATE,DIM8
          MOVE      ATYPE,DIM3              * Default to Admission ATYPE
.
          PACK      KEY30 WITH AADMNO,STODATE,ZED30
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD=0
            MATCH     TADMN,AADMNO
            IF        @EQUAL
              MOVE      TATYPE,DIM3         * Current ATYPE as at STODATE
            ENDIF
          ENDIF
.
          PACK      KEY30 WITH AADMNO,STODATE,ZED30
          CALL      RDSTRAN2
PTRN1000  CALL      RDPTRAN2
          BRANCH    OVRCD OF PTRN9999
.
          MATCH     TADMN,AADMNO            * same admission number ?
          GOTO      PTRN9999 IF NOT EQUAL   * no
.
          MATCH     DIM3,TATYPE            * check if adm type changed ?
          GOTO      PTRN2000 IF EQUAL      * no
          MOVE      DIM8,FROMDATE          * date adm type changed ?
          GOTO      PTRN9999
.
PTRN2000  MOVE      TDATE,DIM8
          GOTO      PTRN1000
.
PTRN9999  RETURN
+
.==============================================================================
.         SPBD0000 - Check for speciality bed type
.==============================================================================
SPBD0000  MOVE      ZERO,EXIT
          BRANCH    CMIXFLAG,SPBD9999            * ignore casemix
.         PACK      KEY6,TWARD,TBED
.         CALL      RDWARD1
.         BRANCH    OVRCD,SPBD9999
.
          MOVE      KEY3,WEFRBT
          MATCH     SP3,WEFRBT
          GOTO      SPBD9999 IF EQUAL            * blank bed type
          PACK      KEY5,ANSB,ANST,WEFRBT
          CALL      RDCODE1
          BRANCH    OVRCD,SPBD9999               * invalid bed type
.
          REP       " 0",TCINDC6
          MOVE      ZERO,FORM1
          MOVE      TCINDC6,FORM1                * check for specialty bedtype
          COMPARE   ZERO,FORM1
          GOTO      SPBD9999 IF EQUAL            * normal bed type
          MOVE      ONE,EXIT
.
SPBD9999  RETURN
+
.******************************************************************************
.        Routine to get the bed fee rate
.******************************************************************************
GTBF0000  MOVE      ZERO,COUNT
          MOVE      ZERO,FORM2
          MOVE      ZERO,NOFEE
.
.         Display the Bed Fee for the above codes
.
          COMPARE   NINE,CFEETYP
          GOTO      GTBF2000 IF EQUAL        * Johns Hopkins bed fees
.
          COMPARE   THREE,CNTRCEFR
          GOTO      GTBF4000 IF EQUAL        * Invalid Contract Effective detail
.
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
          BRANCH    EXIT,GTBF5000
.
GTBF2000  MOVE      TOTDAY,TOTDAYS
          PACK      KEY27 WITH ACLAIM,AFUNDH,AFNDTB,TATYPE,TRBTYP,SP70
          CALL      GETBFEES
          COMPARE   ZERO,EXIT
          GOTO      GTBF9999 IF EQUAL
.
          IF        CHOSTYP=1
            IF        SDOWNFLG=1
              IF        EXIT=2
                MATCH     SP70,BFECONTR
                GOTO      GTBF9999 IF NOT EQUAL    * Inv.screen found a Contract
              ENDIF
            ENDIF
          ENDIF
.
          CLEAR     ERRORDES
          APPEND    "Bed Fee Not Set Up - ",ERRORDES
          APPEND    KEY18,ERRORDES
          APPEND    CONTRCID,ERRORDES
          RESET     ERRORDES
          GOTO      GTBF9000
.
GTBF4000  CLEAR     ERRORDES
          APPEND    "Contract Effective Detail not found.",ERRORDES
          APPEND    SP70,ERRORDES
          RESET     ERRORDES
          GOTO      GTBF9000
.
GTBF5000  CLEAR     ERRORDES
          APPEND    "Contract Effective - ",ERRORDES
          APPEND    "Patient must be discharged.",ERRORDES
          APPEND    SP70,ERRORDES
          RESET     ERRORDES
          GOTO      GTBF9000
.
GTBF9000  MOVE      ONE,EXIT
          MOVE      ONE,NOFEE
          GOTO      GTBF9999
GTBF9999  RETURN
.
.******************************************************************************
.        Routine to get the NZ Private bed fee rate
.******************************************************************************
NZBF0000  OPEN      NZPBFEA1,"nzpbfeaf"
          MOVE      ZERO,COUNT
          MOVE      ZERO,FORM2
          MOVE      ZERO,NOFEE
.
.         Display the Bed Fee for the above codes
.
          PACK      KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,SP8,TATYPE,TRBTYP
.
NZBF1000  CALL      EFDT0000                  * Get last effective date
          MATCH     SP70,EFTDATE
          GOTO      NZBF5000 IF EQUAL         * No record found
.
.       Get the bed fee for the above parameters
.
          PACK      KEY37 WITH KEY26,EFTDATE,SP70
          CALL      RSNZBFE1
NZBF2000  CALL      RKNZBFE1
          BRANCH    OVRCD OF NZBF5000
.
          PACK      DIM26A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,SP70
          MATCH     KEY26,DIM26A
          GOTO      NZBF5000 IF NOT EQUAL
          MATCH     EFTDATE,NZBFEFDT         * Same effective date?
          GOTO      NZBF5000 IF NOT EQUAL
          ADD       ONE,COUNT
.
          COMPARE   THREE,ASTAT
          GOTO      NZBF2200 IF NOT EQUAL
.
.         For a day case patient, BFENDDY should be zero
.
          MATCH     ADATE,DDATE
          GOTO      NZBF2200 IF NOT EQUAL
.
          MATCH     "  0",NZBFEDAY
          GOTO      NZBF4000 IF NOT EQUAL
          GOTO      NZBF3200
.
NZBF2200  COMPARE   ZERO,TOTDAY
          GOTO      NZBF3000 IF NOT EQUAL
.
.        If ADYHOSP is zero, the bed fee should be the first column after
.        a day case fee
.
          MATCH     "  0",NZBFEDAY
          GOTO      NZBF4000 IF EQUAL
          GOTO      NZBF3200
.
NZBF3000  MOVE      NZBFEDAY,FORM3
          COMPARE   TOTDAY,FORM3
          GOTO      NZBF4000 IF LESS
.
NZBF3200  MOVE      NZBFRATE,SBFPAT
          MOVE      NZBFREBA,SBFHF
          MOVE      NZBFEDAY,SBFENDDY
          GOTO      NZBF9999
.
.             Save the bed fee
.
NZBF4000  MOVE      NZBFRATE,SBFPAT
          MOVE      NZBFREBA,SBFHF
          MOVE      NZBFEDAY,SBFENDDY
          GOTO      NZBF2000
.
.             Use default bed fee if hospitalization day not in range
.
NZBF5000  COMPARE   ZERO,COUNT
          GOTO      NZBF9999 IF NOT EQUAL
.
          ADD       ONE,FORM2
          BRANCH    FORM2 OF NZBF5200,NZBF5400
          MOVE      ONE,NOFEE
.         DISPLAY   *P1:23,*EL,*P1:23,*V2LON,*B:
.                   " Default not set up yet !!     ",*HOFF:
.                   "KEY:[",*V2LON,DIM23,*HOFF,"] ",*W2;
          GOTO      NZBF9999
.
NZBF5200  PACK      KEY26 WITH PMVXMHOS,ACLAIM,SP10,SP4,TATYPE,TRBTYP
          GOTO      NZBF1000
.
NZBF5400  IF        IBCNMHOS=1
            MOVE      MULTHOSP,KEY3
            CALL      RDPTHSP1
            PACK      KEY26,PMVXMHOS,PTHSDCLM,SP10,SP4,TATYPE,TRBTYP
          ELSE
            PACK      KEY26,PMVXMHOS,PTCNDCLM,SP10,SP4,TATYPE,TRBTYP
          ENDIF
          GOTO      NZBF1000
.
NZBF9999  RETURN
.
.==============================================================================
.        Subroutine to recalculate the fees for any theatre fees
.==============================================================================
FTHR0000  OPEN      PATITEM1,"patitemn"
          MOVE      SP20,CURSESS
.
          PACK      KEY14,AADMNO,SP20
          CALL      RSPMMTI1
FTHR1000  CALL      RKPMMTI1
          BRANCH    OVRCD OF FTHR9999
.
          MATCH     PMMIVISN,DAADMNO
          GOTO      FTHR9999 IF NOT EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      PMMIRTYP,FORM1
          BRANCH    FORM1,FTHR1000,FTHR3000,FTHR2000
          GOTO      FTHR1000
.
.         Fixing miscellaneous record
.
FTHR2000  MOVE      PMMIITEM,DIM9
.
          UNPACK    SP20,PTHFBCAT      * convert "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
.
          MOVE      PMVXMHOS,WKMCMHOS       * required for Multi Hospital
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,PMMIITEM,PMMITDAT,SP10
          CALL      PATMCHRD                * find Miscellaneous Charge Item
          IF        EXIT = 1
            PACK      KEY29,ACLAIM,SP6,SP3,PMMIITEM,PMMITDAT,SP10
            CALL      PATMCHRD              * find Miscellaneous Charge Item
            IF        EXIT = 1
              CALL      DCLM0000
              PACK      KEY29,PTCNDCLM,SP6,SP3,PMMIITEM,PMMITDAT,SP10
              CALL      PATMCHRD            * find Miscellaneous Charge Item
              BRANCH    EXIT,FTHR1000       * not found or invalid
            ENDIF
          ENDIF
.
          MOVE      ZERO,FORM62
          MOVE      MPATPOR,FORM62
          ADD       MHFPOR,FORM62
.
          COMPARE   ZERO,FORM62
          GOTO      FTHR1000 IF EQUAL     * Ignore zero amount misc. charges
.
          MOVE      MPATPOR,PMMIAMTP
          MOVE      MHFPOR,PMMIRBAT
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          IF        PMMISERV<>0
            MULT      PMMISERV,PMMIAMTT
          ENDIF
.
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          GOTO      FTHR1000
.
.         Fixing theatre record 
.
FTHR3000  MOVE      PMMIITEM,DIM9
          MATCH     ANSY,PTMICMXP
          GOTO      FTHR3200 IF EQUAL
.
.         Get the MBS item record for this theatre fee
.
          PACK      KEY9,DIM9,SP5
          PACK      KEY17,KEY9,PMMITDAT,SP70
          CALL      PATITMRD
          COMPARE   ZERO,OVRCD
          GOTO      FTHR3200 IF EQUAL
.
          PACK      DIM9,PMMIREFN,SP9
.
FTHR3200  PACK      KEY9 WITH DIM9,SP5
          PACK      KEY17,KEY9,PMMITDAT,SP70
          CALL      PATITMRD
          IF        OVRCD = 1
.
.          If this is casemix, check for valid DRG
.
            MATCH     ANSY,PTMICMXP
            IF        @EQUAL
              PACK      KEY4,PMMIITEM,SP5
              PACK      KEY7,KEY4,SP10                                *I-137125
              CALL      RSPTDGW1
              CALL      RKPTDGW1
              BRANCH    OVRCD,FTHR1000
              MATCH     PTDWDRGC,KEY4       * same DRG code ?         *I-137125
              GOTO      FTHR1000 IF NOT EQUAL                         *I-137125
              GOTO      FTHR3300
            ENDIF
            GOTO      FTHR1000
          ENDIF
.
.        Check for multiple items in the same session
.
FTHR3300  PACK      DIM18 WITH PMMIVISN,PMMISESS,PMMITDAT
          REP       " 0",DIM18
.
          MATCH     DIM18,CURSESS
          GOTO      FTHR3500 IF EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      DIM18,CURSESS
.
FTHR3500  MOVE      PMMIITEM,TITEMNO
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      FTHR4000 IF EQUAL
          ELSE
            BRANCH    PTCNTFEE,FTHR4000     * using theatre fees file
          ENDIF
.
.         Check claim code, if MBS Amount is used for charging
.
          MOVE      ZERO,PMMIAMTP      * MBS Amount
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "2",TCINDC1
            IF        @EQUAL
              PACK      KEY9,PMMIITEM,SP5
              PACK      KEY17,KEY9,PMMITDAT,SP70
              CALL      PATITMRD
              BRANCH    OVRCD,FTHR1000        * invalid MBS Item
              MOVE      ZERO,PMMIRBAT
              MOVE      QIAMT,PMMIAMTP      * MBS Amount
            ENDIF
          ENDIF
          GOTO      FTHR8000
.
FTHR4000  MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            ADD       ONE,FORM1
            MOVE      FORM1,FORM2         * Set item sequence
            CALL      GCTH0000            * get theatre casemix funding
            GOTO      FTHR1000
          ENDIF
.
          CALL      GTFE0000
          IF        OVRCD=1
            MOVE      ZERO,PMMIRBAT
            MOVE      ZERO,PMMIAMTP
            GOTO      FTHR8000
          ENDIF
.
          ADD       ONE,FORM1
          PACK      KEY9,PMMIITEM,SP5
          PACK      KEY17,KEY9,PMMITDAT,SP70
          CALL      PATITMRD
          COMPARE   ZERO,OVRCD
          GOTO      FTHR4200 IF EQUAL
.
.         Fix price item, just adjust rebate portion
.
          LOAD      PMMIRBAT USING FORM1 OF TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
.
          COMPARE   PMMIRBAT,PMMIAMTT
          GOTO      FTHR4100 IF NOT LESS
.
          MOVE      PMMIAMTT,PMMIRBAT
.
FTHR4100  MOVE      PMMIAMTT,PMMIAMTP
          SUB       PMMIRBAT,PMMIAMTP
          IF        PMMISERV<>0
            MULT      PMMISERV,PMMIAMTT
          ENDIF
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          GOTO      FTHR1000
.
.        Normal theatre fee
.
FTHR4200  LOAD      PMMIRBAT USING FORM1 OF TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
          LOAD      PMMIAMTP USING FORM1 OF TFPAT1,TFPAT2,TFPAT3,TFPAT4:
                                           TFPAT5,TFPAT6
.
.         if there are more that 6 theatre fees then use the 6th fee   *I-39291
.              Also check parameter. Default is yes.                   *I-47385
.
          IF        FORM1 > 6
            IF        PTCNMBSF = 0
              MOVE      TFHF6,PMMIRBAT      *Rebate portion            *I-47385
              MOVE      TFPAT6,PMMIAMTP     *Patient portion           *I-39291
            ENDIF                                                      *I-47385
          ENDIF                                                        *I-39291
.
FTHR8000  MOVE      PMMIRBAT,PMMIAMTT
          ADD       PMMIAMTP,PMMIAMTT
          IF        PMMISERV<>0
            MULT      PMMISERV,PMMIAMTT
          ENDIF
.
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
          GOTO      FTHR1000
.
FTHR9999  RETURN
.
.---------------------------------------------------------------------
.        Subroutine to get the theatre charge record for a theatre fee
.---------------------------------------------------------------------
GTFE0000  MOVE      ZERO,NOFEE
.
.         Set up the daycase rate indicator
.
          MOVE      SP1,DIM1A
          MATCH     ADATE,DDATE
          GOTO      GTFE1000 IF NOT EQUAL
.
          MOVE      "D",DIM1A
.
GTFE1000  PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF                * Get Contract Effective details
          BRANCH    EXIT,GTFE9000          
.         
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
.
          MOVE      PMMITDAT,TSRVDATE       * Service date
          PACK      KEY18 WITH ACLAIM,AFUNDH,AFNDTB,DIM1A
          CALL      GETTFEES
          BRANCH    EXIT,GTFE9000
          MOVE      ZERO,OVRCD
          GOTO      GTFE9999
.
GTFE9000  MOVE      ONE,OVRCD
          MOVE      ONE,NOFEE
GTFE9999  RETURN
+
.---------------------------------------------------------------------
.         Casemix theatre fee
.---------------------------------------------------------------------
GCTH0000  MOVE      ZERO,PTCTDCAS           * default to non daycase
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,PTCTDCAS        * Daycase
            ENDIF
          ENDIF
          MOVE      FORM2,PTCTITMS          * Item sequence
.
.         Check if this is a valid DRG Code
.
          MOVE      ONE,MBSFLAG             * default to MBS Item
          MOVE      SP10,KEY4,KEY5
          UNPACK    PMMIITEM,KEY4,KEY5
          MATCH     SP5,KEY5
          GOTO      GCTH1000 IF NOT EQUAL
.
          PACK      KEY4,PMMIITEM,SP5
          PACK      KEY7,KEY4,SP10                                    *I-137125
          CALL      RSPTDGW1
          CALL      RKPTDGW1
          IF        OVRCD = 0
            MATCH     PTDWDRGC,KEY4         * same DRG code ?         *I-137125
            GOTO      GCTH1000 IF NOT EQUAL                           *I-137125
            MOVE      ZERO,MBSFLAG
            MOVE      PMMIITEM,MCHARGE
          ENDIF
.
GCTH1000  MOVE      ONE,USEDEF              * to use default
          MOVE      PMMIITEM,TITEMNO
          MOVE      PMMITDAT,TSRVDATE       * Service date
          CALL      CMGETTHR                * Get casemix theatre
          IF        OVRCD=1
.           CALL      NOCM0000              * no casemix rec so display warning
            MOVE      ONE,NOFEE
            MOVE      ZERO,PTCTDPAT        * Patient portion
            MOVE      ZERO,PTCTDREB         * Rebate portion
          ENDIF
.
          MOVE      PTCTDPAT,PMMIAMTP       * Patient portion
          MOVE      PTCTDREB,PMMIRBAT       * Rebate portion
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
.
          IF        PMMISERV<>0
            MULT      PMMISERV,PMMIAMTT
          ENDIF
          PACK      PMMIDUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDUPD
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITUPD
          MOVE      WBSEUID,PMMIWUSR
          CALL      UPPMMTI1
.
GCTH9999  RETURN
+
.-----------------------------------------------------------
.  Clear person responsible for account details
.-----------------------------------------------------------
CLRRES00  PACK       PKNAME,SP70,SP10   *  PERSON RESP FOR A/C NAME
          MOVE       SP70,PKADD1    *      P.R.A ADDRESS LINE 1
          MOVE       SP70,PKADD2    *      P.R.A ADDRESS LINE 2
          MOVE       SP70,PKSUBR    *      P.R.A SUBURB
          MOVE       SP70,PKADD4    *      P.R.A ADDRESS LINE 2
          MOVE       SP70,PKPOST    *      P.R.A POSTCODE
          MOVE       SP70,PKTELEP   *      P.R.A PRIVATE TELEPHONE 
          MOVE       SP70,PKTELEB   *      P.R.A BUSINESS TELEPHONE 
          MOVE       SP70,PKRELP    *      P.R.A RELATIONSHIP
          RETURN
+
.------------------------------------------------------------------------------
.         Subroutine to check for the compensation claim 
.------------------------------------------------------------------------------
VALC0000  CALL      CLRCLM00          * Clear all claim code fields
.
          MOVE      ADMISSNO,KEY8
          MATCH     SP70,KEY8
          GOTO      VALC9000 IF EQUAL
.
          CALL      GCLM0000          * Get patient's claim code
          BRANCH    EXIT,VALC9000
.
          MATCH     "1",PTCNXCOM
          GOTO      VALC0800 IF NOT EQUAL    * Not using Extra Compensation
.
          COMPARE   SIX,PTCNHDPS      * wahealth MV template access
          IF        @EQUAL
            MATCH     "042",TEMPLATE
            IF        @EQUAL
              GOTO      VALC3000
            ENDIF
          ENDIF
.
          CMATCH    "A",TCINDC1
          GOTO      VALC6100 IF EQUAL        * Australian Defence Force
          CMATCH    "O",TCINDC1
          GOTO      VALC6200 IF EQUAL        * Other Compensable
          CMATCH    "F",TCINDC1
          GOTO      VALC6400 IF EQUAL        * Foreign Defence
          CMATCH    "S",TCINDC1
          GOTO      VALC6500 IF EQUAL        * Shipping
          CMATCH    "H",TCINDC1
          GOTO      VALC6600 IF EQUAL        * Private
.
          CMATCH    "W",TCINDC1
          GOTO      VALC2000 IF EQUAL        * Workers Comp.
          CMATCH    "M",TCINDC1
          GOTO      VALC3000 IF EQUAL        * Motor Vehicle
          CMATCH    "V",TCINDC1
          GOTO      VALC4000 IF EQUAL        * Veterans Affairs
          GOTO      VALC9000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
VALC0800  MOVE      ZERO,FORM2
VALC1000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      VALC9000 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      VALC2000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      VALC3000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      VALC4000 IF EQUAL
          CMATCH    "C",ANS
          GOTO      VALC5000 IF EQUAL
          CMATCH    "D",ANS
          GOTO      VALC6000 IF EQUAL        * Defence Force
.
          GOTO      VALC1000
.
VALC2000  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MATCH     "047",TEMPLATE
            GOTO      VALC8000 IF EQUAL
          ELSE
            MATCH     "002",TEMPLATE
            GOTO      VALC2200 IF EQUAL
          ENDIF
          MOVE      "This Patient is a Workers Comp. Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
.         Read workers comp.details
.
VALC2200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWX11                * read workers compensation ext file
          OPEN      PATWC1A1,"patwc1af"
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          GOTO      VALC9999
.
VALC3000  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MATCH     "042",TEMPLATE
            GOTO      VALC8000 IF EQUAL
          ELSE
            MATCH     "003",TEMPLATE
            GOTO      VALC3200 IF EQUAL
          ENDIF
.
          MOVE      "This Patient is a TAC/Motor Vehicle Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC3200  OPEN      PATWMAB1,"patwmabf"
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWMAB1
          GOTO      VALC9999
.
VALC4000  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MATCH     "046",TEMPLATE
            GOTO      VALC8000 IF EQUAL
          ELSE
            MATCH     "004",TEMPLATE
            GOTO      VALC4200 IF EQUAL
          ENDIF
.
          MOVE      "This Patient is a Veteran Affairs Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC4200  OPEN      PATWVET1,"patwvetf"
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWVET1
          GOTO      VALC9999
.
VALC5000  MATCH     "010",TEMPLATE
          GOTO      VALC5200 IF EQUAL
          MOVE      "This Patient is a Civil Tort Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC5200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMCTC1
          GOTO      VALC9999
.
VALC6000  MATCH     "039",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE      "This Patient is a Defence Force Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC6100  MATCH     "040",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE    "This Patient is an Australian Defence Force Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC6200  MATCH     "041",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE      "This Patient is an Other Compensable Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
.
VALC6400  MATCH     "043",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE      "This Patient is a Foreign Defence Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC6500  MATCH     "045",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE      "This Patient is a Shipping Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC6600  MATCH     "044",TEMPLATE
          GOTO      VALC8000 IF EQUAL
          MOVE      "This Patient is a Private Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALC9999
.
VALC8000  PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RDPMEXT1
          IF        OVRCD=1
            CALL      CLPMSEXT         * Clear fields
          ENDIF
          GOTO      VALC9999
.
VALC9000  MOVE      "Not a Compensable Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
VALC9999  RETURN
+
.------------------------------------------------------------------------------
.         Subroutine to get claim code
.------------------------------------------------------------------------------
GCLM0000  MOVE      ZERO,EXIT
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          COMPARE   ZERO,OVRCD
          GOTO      GCLM0100 IF EQUAL
.
          CALL      RDPMVX11
          BRANCH    OVRCD,GCLM9000
          GOTO      GCLM2000
.
GCLM0100  BRANCH    PVITYPE,GCLM1000,GCLM2000,GCLM3000
          GOTO      GCLM9000
.
GCLM1000  CALL      RDEMVIS1
          BRANCH    OVRCD,GCLM9000
          MOVE      EMVICOMP,ACLAIM        * Emergency claim code
          MOVE      EMVICOMP,COMPCLAM
          MOVE      EMVIDATE,COMPDATE
          GOTO      GCLM6000
.
GCLM2000  MOVE      SP3,OSTSYST
          MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          CALL      OPOTBB11
          CALL      RDBOKB1
          BRANCH    OVRCD,GCLM9000
          MOVE      OBACOMP,ACLAIM       * Outpatient claim code
          MOVE      OBACOMP,COMPCLAM
          MOVE      OBADATE,COMPDATE
          GOTO      GCLM6000
.
GCLM3000  CALL      RDMISS1
          BRANCH    OVRCD,GCLM9000
          MOVE      ACLAIM,COMPCLAM
          MOVE      ADATE,COMPDATE
.
GCLM6000  MOVE      ZERO,EXIT
          PACK      KEY5 WITH CODECL,ACLAIM
          CALL      RDCODE1
          COMPARE   ZERO,OVRCD
          GOTO      GCLM9999 IF EQUAL
.
GCLM9000  MOVE      ONE,EXIT
GCLM9999  RETURN
+
.------------------------------------------------------------------------------
.         Subroutine to locate outpatient record given the Visit file details
.------------------------------------------------------------------------------
GETB0000  MOVE      ZERO,OVRCD               * Clear error flag
          MOVE      PVISITE,OBASITE          * Site code
          MOVE      PVIURNO,OBAURNO          * U/R number
.
          MOVE      PVISITE,KEY6             * For this site ...
          CALL      RDSITA1                  * Get file prefix
          BRANCH    OVRCD,OVERCOND           * No site record - error
.
          PACK      CFNAME,OSTFILE,FILBB1A2  * Set up physical filename
          CALL      OPOTBB12
          PACK      KEY16,PVIDATE,PVIBILL    * Key is date & outpatient no.
          CALL      RDBOKB2                  * Read record
          CLOSE     OUTBB1A2                 * Close logical file
          BRANCH    OVRCD,OVERCOND           * No record - error
.
          CLOSE     OUTDTRO1                 * Close currently open dtran file
          PACK      CFNAME,OSTFILE,FILDTRO1  * Set up physical filename
          OPEN      OUTDTRO1,CFNAME          * Open new dtran file
GETB9999  RETURN
+
.------------------------------------------------------------------------------
.         Patients List 
.------------------------------------------------------------------------------
LIST0000  MOVE      "Invoice Pending List",WEBTITLE
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LIST9999
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
LIST9999  RETURN
+
.------------------------------------------------------------
. Update Invoice Breakdown
.------------------------------------------------------------
UIVB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA3,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA4,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UIVB9999
.
          PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,UIVB9999
.
          BRANCH    UPDATETY,UIVB1000
          GOTO      UIVB9000
.
UIVB1000  CALL      VPYR0000              * either Accomm.or one item per payer
          BRANCH    EXIT,UIVB9000
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UIVB99999
.
          CALL      UPBR0000              * Update Max Billing and per Day Bill
          CALL      UPIV0000              * Update Invoice billing period
          MOVE      ZERO,EXIT
          GOTO      UIVB9999
.
UIVB9000  CLEAR     WEBTITLE
          APPEND    "A payer can pay either ",WEBTITLE
          APPEND    "Accommodation or One item only.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UIVB9999

UIVB9999  RETURN
+
.------------------------------------------------------------
.         Only accommodation or one item for each payer
.------------------------------------------------------------
VPYR0000  MOVE      ZERO,FORM3A
          MOVE      ZERO,F1
.
VPYR1000  COMPARE   "99",FORM3A
          GOTO      VPYR8000 IF NOT LESS
.
          ADD       ONE,FORM3A
          COMPARE   ZERO,MXBIL[FORM3A]
          GOTO      VPYR1000 IF EQUAL
.
          BRANCH    F1,VPYR9000
          MOVE      ONE,F1
.
          GOTO      VPYR1000
.
VPYR8000  MOVE      ZERO,EXIT
          GOTO      VPYR9999

VPYR9000  MOVE      ONE,EXIT
VPYR9999  RETURN
+
.------------------------------------------------------------
.        Update Max Billing and per day billing
.------------------------------------------------------------
UPBR0000  MOVE      ZERO,FORM3A
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,SP70
          CALL      RSPMPBR1
UPBR1000  CALL      RKPMPBR1
          BRANCH    OVRCD,UPBR9999
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      UPBR9999 IF NOT EQUAL
.
          ADD       ONE,FORM3A
          MOVE      MXBIL[FORM3A],PMPBMAXB
          MOVE      MXDAY[FORM3A],PMPBMAXD
          CALL      UPPMPBR1
.
          GOTO      UPBR1000
.
UPBR9999 RETURN
+
.------------------------------------------------------------
.        Update invoice breakdown for all payers of admission
.------------------------------------------------------------
UAPY0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA3,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA4,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UAPY9999
.
          MOVE      SP70,PENDCLAM
          PACK      KEY22,ADMISSNO,SP70
          CALL      RSPMPBR1
UAPY1000  CALL      RKPMPBR1
          BRANCH    OVRCD,UAPY9999
.
          MATCH     ADMISSNO,PMPBADMN
          GOTO      UAPY9999 IF NOT EQUAL
.
          PACK      KEY19,URNUMBER,PMPBCLTY,PMPBEFDT,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,UAPY1000
.
          MATCH     SP70,PENDCLAM
          GOTO      UAPY2000 IF EQUAL
.
          MATCH     PMPBCLTY,PENDCLAM
          GOTO      UAPY3000 IF EQUAL
.
UAPY2000  MOVE      PMPBCLTY,PENDCLAM
          MOVE      PMPBCLTY,KEY3
          CALL      DEBR0000           * Remove payer existing breakdown
.
UAPY3000  COMPARE   ZERO,PMPBMAXB
          GOTO      UAPY1000 IF EQUAL     * zero maximum amount
.
          MOVE      PMPBCLTY,PMPYR003      * Claim type
          MOVE      PMPBEFDT,PMPYR018
.
          MATCH     "  0",PMPBICNT
          GOTO      UAPY4000 IF EQUAL     * accommodation record
.
          PACK      KEY9,PMPBITEM,SP70
          MOVE      PMPBMAXD,MAXIDAYB
          MOVE      PMPBMAXB,MAXIBILL
          CALL      ITMI0000                 * Check if item has been entered
          IF        EXIT=0
            MOVE      "3",SRECTYPE            * Item record
            MOVE      ZERO,PRTIFLAG
            CALL      WTID0000
          ENDIF
          GOTO      UAPY1000
.
UAPY4000  MOVE      CHNGDATE,BACKDATE
          CALL      FACM0000                 * Accom.start date for this payer
          MOVE      "  0",PMPBICNT           * zero for Accommodation
          PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,PMPBICNT,SP70
          CALL      RDPMPBR1
          IF        OVRCD=0
            MOVE      ONE,ISBLFLAG
            MOVE      PMPBMAXD,MAXIDAYB
            MOVE      PMPBMAXB,MAXIBILL
            MOVE      SEVEN,PROGFLAG         * work out accommodation charge
            CALL      ISAC0000               * Get accommodation for a payer
          ENDIF
          GOTO      UAPY1000
.
UAPY9999  RETURN
+
.------------------------------------------------------------
.        Update Invoice billing period
.------------------------------------------------------------
UPIV0000  MOVE      PMPYR003,KEY3
          CALL      DABR0000              * Remove Accom.existing breakdown
.
          CALL      FACM0000               * Accom.start date for this payer
          MOVE      "  0",PMPBICNT         * Item counter zero for Accomm.
          PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,PMPBICNT,SP70
          CALL      RDPMPBR1
          BRANCH    OVRCD,UPIV9999
.
          COMPARE   ZERO,PMPBMAXB
          GOTO      UPIV1000 IF EQUAL      * No maximum billing for Accom.
          MOVE      ONE,ISBLFLAG
.
          MOVE      SEVEN,PROGFLAG         * Update this invoice accom.charge
          CALL      ISAC0000
          GOTO      UPIV9999
.
.         Updating Items for the payer
.
UPIV1000  MOVE      ZERO,FORM3A
UPIV4000  ADD       ONE,FORM3A
          MATCH     SP70,ITMCD[FORM3A]
          GOTO      UPIV9999 IF EQUAL
.
          COMPARE   ZERO,IVAMT[FORM3A]        * Invoice amount
          GOTO      UPIV4000 IF EQUAL
.
.         Check if item in tobe invoiced
.
          MOVE      "3",PMMIRTYP
          PACK      KEY15,ADMISSNO,PMMIRTYP,SP70
          CALL      RSPMMTI2
UPIV5000  CALL      RKPMMTI2
          BRANCH    OVRCD,UPIV4000
.
          MATCH     ADMISSNO,PMMIVISN         * Same visit number?
          GOTO      UPIV4000 IF NOT EQUAL
          MATCH     "3",PMMIRTYP
          GOTO      UPIV4000 IF NOT EQUAL
.
          MATCH     PMMIITEM,ITMCD[FORM3A]
          GOTO      UPIV5000 IF NOT EQUAL
.
          MATCH     "1",PMMIINCT
          GOTO      UPIV5000 IF NOT EQUAL     * Not from Community Billing
.
.         Check if record already exists
.
          MOVE      ITMCD[FORM3A],KEY9
          MOVE      SP70,PMIDINVN
          PACK      KEY34,ADMISSNO,PMPYR003,PMIDINVN,KEY9,SP70
          CALL      RSPMIDE4
          CALL      RKPMIDE4
          BRANCH    OVRCD,UPIV8000
.
          PACK      KEY28,PMIDADMN,PMIDCLTY,PMIDINVN,PMIDITEM,SP70
          MATCH     KEY28,KEY34
          GOTO      UPIV8000 IF NOT EQUAL
.
          MOVE      "3",PMIDRTYP              * Item record
          MOVE      ITMCD[FORM3A],PMIDITEM    * Item code
          MOVE      PTRGM001,PMIDREGM         * Regime code
          MOVE      IVAMT[FORM3A],PMIDAMNT    * Invoice amount
.
          PACK      PMIDDESC,PMMIDESC,SP70
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      PMMIGSTA,PTDTGSTA
            MOVE      PMMIGSTC,PTDTGSTC
            CALL      IGST0000
            MOVE      PMIDAMNT,PMIDGSTM
            MULT      IBGEAMNT,PMIDGSTM
            DIV       "100.00",PMIDGSTM
          ENDIF
          PACK      PMIDITDT,CHNGDATE,SP70
.
          MOVE      PMMITDAT,PMIDFDAT
          REP       " 0",PMIDFDAT
          MOVE      PMIDFDAT,ISBLDATE
          ADD       PMIDNDAY,ISBLDATE
          MOVE      ISBLDATE,PMIDTDAT
          PACK      PMIDUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIDUDAT           * date Updated
          CLOCK     TIME,PMIDUTIM           * time Updated
          MOVE      USERID,PMIDUUID         * web user id
          CALL      UPPMIDE4
          GOTO      UPIV4000
.
UPIV8000  CALL      WTIR0000
          GOTO      UPIV4000
.
UPIV9999 RETURN
+
.-------------------------------------------------------------------------------
.        Delete Accommodation record from temporary Invoice payer details
.        incase of bed transfer changes since last time file being updated
.-------------------------------------------------------------------------------
DABR0000  MOVE      ZERO,FORM3A
          MOVE      SP70,KEY8              * Not invoiced
.
DABR1000  PACK      KEY25,DAADMNO,KEY3,KEY8,SP70
          CALL      RSPMIDE1
DABR2000  CALL      RKPMIDE1
          BRANCH    OVRCD,DABR9999
.
          PACK      KEY19,PMIDADMN,PMIDCLTY,PMIDINVN,SP70
          MATCH     KEY19,KEY25
          GOTO      DABR9999 IF NOT EQUAL
.
          MATCH     "1",PMIDRTYP
          GOTO      DABR2000 IF NOT EQUAL  * not accommodation record
.
          PACK      KEY25,PMIDADMN,PMIDCLTY,PMIDINVN,PMIDTRNO,SP70
          CALL      DEPMIDE1
          GOTO      DABR2000
.
DABR9999  RETURN
+
.---------------------------------------------------------------------
.        Write Item record to Invoice payer details
.---------------------------------------------------------------------
WTIR0000  MOVE      ONE,F6
          PACK      KEY25,ADMISSNO,PMPYR003,PMPYR018,Z70
          CALL      RSPMIDE1
          CALL      RPPMIDE1
          BRANCH    OVRCD,WTIR2000
.
          PACK      KEY19,PMIDADMN,PMIDCLTY,PMIDINVN,SP70
          MATCH     KEY19,KEY25
          GOTO      WTIR2000 IF NOT EQUAL
.
WTIR1000  ADD       ONE,F6
.
WTIR2000  MOVE      F6,PMIDTRNO
          MOVE      SP70,PMIDINVN
          PACK      KEY25,ADMISSNO,PMPYR003,PMIDINVN,PMIDTRNO,SP70
          CALL      RAPMIDE1
          COMPARE   ZERO,OVRCD
          GOTO      WTIR1000 IF EQUAL
.
          CALL      CLPMSIDE                   * Clear variable
.
          UNPACK    KEY25,PMIDADMN,PMIDCLTY
          MOVE      SP70,PMIDINVN
          MOVE      F6,PMIDTRNO
          MOVE      "3",PMIDRTYP              * Item record
.
          MOVE      ITMCD[FORM3A],PMIDITEM    * Item code
          MOVE      PTRGM001,PMIDREGM         * Regime code
          MOVE      IVAMT[FORM3A],PMIDAMNT    * Invoice amount
          MOVE      PMMISERV,PMIDNDAY         * quantity of item
.
          MOVE      MXBIL[FORM3A],FORM12P2    * Quantity=Max.Bill/Max.perday
          DIV       MXDAY[FORM3A],FORM12P2
          MOVE      FORM12P2,FORM6            * No of items for max pay
          IF        FORM6<PMMISERV
            MOVE      FORM6,PMIDNDAY
          ENDIF
          IF        PMIDNDAY=0
            MOVE       ONE,PMIDNDAY
          ENDIF
.
          PACK      PMIDDESC,PMMIDESC,SP70
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      PMMIGSTA,PTDTGSTA
            MOVE      PMMIGSTC,PTDTGSTC
            CALL      IGST0000
            MOVE      PMIDAMNT,PMIDGSTM
            MULT      IBGEAMNT,PMIDGSTM
            DIV       "100.00",PMIDGSTM
          ENDIF
.
          MOVE      PMMITDAT,PMIDFDAT
          REP       " 0",PMIDFDAT
          MOVE      PMIDFDAT,ISBLDATE
          ADD       PMIDNDAY,ISBLDATE
          MOVE      ISBLDATE,PMIDTDAT
          PACK      PMIDITDT,CHNGDATE,SP70
.
          PACK      PMIDCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIDCDAT           * date created
          CLOCK     TIME,PMIDCTIM           * time created
          MOVE      USERID,PMIDCUID         * web user id
          UNPACK    SP70,PMIDUUID,PMIDUDAT,PMIDUTIM
.
          CALL      WRPMIDE1
.
WTIR9999  RETURN
+
.------------------------------------------------------------
. Process Fields in Body of HTML Template
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40,PROFLD99:
                             PROFLD99,PROFLD99,PROFLD80,PROFLD99,PROFL200:
                             PROFLD99,PROFL200
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFLD20
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD14  CALL      INVD0000         * Patient Invoices
          GOTO      PROFLD99
.
PROFLD15  CALL      CLMF0000
          GOTO      PROFLD99
.
PROFLD16  CALL      PMIX0000         * PMI extension file
          GOTO      PROFLD99
.
PROFLD17  CALL      BCMN0000         * Billing comments
          GOTO      PROFLD99
.
PROFLD18  CALL      MCHG0000         * Misc.Item pending
          GOTO      PROFLD99
.
PROFLD19  CALL      SUMM0000         * Summary billing
          GOTO      PROFLD99
.
PROFLD20  CALL      NZSP0000         * Subsequence Procedure file (NZ Private)
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD33  CALL      SGST0000         * Unknown Accommodation/Item GST
          GOTO      PROFLD99
.
PROFLD34  CALL      MGST0000         * Allocating GST Code
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45:
                             PROFLD46,PROFLD47,PROFLD48,PROFLD49
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD43  CALL      ADMT0000          * bed/transfer fields
          GOTO      PROFLD99
.
PROFLD44  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD45  CALL      STDW0000          * Stepdown
          GOTO      PROFLD99
.
PROFLD46  CALL      VISF0000          
          GOTO      PROFLD99
.
PROFLD47  CALL      NZST0000          * NZ Stepdown
          GOTO      PROFLD99
.
PROFLD48  CALL      CCVF0000          * Casemix Code Verification
          GOTO      PROFLD99
.
PROFLD49  CALL      PTAR0000          * Patient Attributes
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD82  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD83  CALL      PLST0000          * Patient list
          GOTO      PROFLD99
.
PROFL200  BRANCH    FLDSETNO,PROFL210,PROFL220,PROFL230,PROFL240
          GOTO      PROFLD99
.
PROFL210  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL220  CALL      VSPA0000          * Visit based expected payors
          GOTO      PROFLD99
.
PROFL230  CALL      PLST0000          * Patient list
          GOTO      PROFLD99
.
PROFL240  CALL      VSPM0000          * Visit based payers Account info
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
.   Casemix Code Verification
.------------------------------------------------------------
CCVF0000  BRANCH    FLDITMNO,CCVF0100,CCVF0200,CCVF0300,CCVF0400,CCVF0500
          GOTO      CCVF9999
.
CCVF0100  MOVE      "RV",CATEGORY                  * Reason for Change
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      CCVF9999 
.
CCVF0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      CLPATATR
          PACK      KEY35,URNUMBER,ADMISSNO,ATYPE029,SP70
          CALL      RSPTATR3
          CALL      RKPTATR3
          BRANCH    OVRCD,CCVF9999
.
          MATCH     URNUMBER,PTARURNO
          GOTO      CCVF9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      CCVF9999 IF NOT EQUAL
.
          MATCH     ATYPE029,PTARTYPE          * Is attribute type="029"?
          GOTO      CCVF9999 IF NOT EQUAL     
.
          BRANCH    F1,CCVF0201,CCVF0202,CCVF0203
          GOTO      CCVF9999
.
CCVF0201  MATCH     PTARCUSR,SP70
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE     SP70,WBSENAM
            ENDIF
          ELSE
            PACK     WBSENAM,SP70
          ENDIF 
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CCVF9999
.
CCVF0202  MATCH     SP70,PTARCDTE
          GOTO      CCVF9999 IF EQUAL
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,AT,SP1,PTARCTME;
          GOTO      PTAR9999
.
CCVF0203  WRITE     HTMLFILE;PTARTXT1;
          GOTO      CCVF9999
.
CCVF0300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      CLPATATR
          PACK      KEY35,URNUMBER,ADMISSNO,ATYPE029,Z70
          CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,CCVF9999
.
          MATCH     URNUMBER,PTARURNO
          GOTO      CCVF9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      CCVF9999 IF NOT EQUAL
.
          MATCH     ATYPE029,PTARTYPE          * Is attribute type="029"?
          GOTO      CCVF9999 IF NOT EQUAL
.
          CALL      RPPTATR3
          BRANCH    OVRCD,CCVF9999
          MATCH     URNUMBER,PTARURNO
          GOTO      CCVF9999 IF NOT EQUAL
          MATCH     ADMISSNO,PTARVISN
          GOTO      CCVF9999 IF NOT EQUAL
          MATCH     ATYPE029,PTARTYPE          * Is attribute type="029"?
          GOTO      CCVF9999 IF NOT EQUAL
          CALL      RKPTATR3
.
          BRANCH    F1,CCVF0301,CCVF0302,CCVF0303,CCVF0304,CCVF0305
          GOTO      CCVF9999
.
CCVF0301  MATCH     PTARCUSR,SP70
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE     SP70,WBSENAM
            ENDIF
          ELSE
            PACK     WBSENAM,SP70
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CCVF9999
.
CCVF0302  MATCH     SP70,PTARCDTE
          GOTO      CCVF9999 IF EQUAL
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,AT,SP1,PTARCTME;
          GOTO      PTAR9999
.
CCVF0303  WRITE     HTMLFILE;PTARTXT1;
          GOTO      CCVF9999
.
CCVF0304  MATCH     PTARCOD1,SP70
          GOTO      CCVF9999 IF EQUAL
          PACK      KEY5,ANSR,ANSV,PTARCOD1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CCVF9999
          WRITE     HTMLFILE;TDESC;
          GOTO      CCVF9999
.
CCVF0305  MATCH     PTARCOD1,SP70
          GOTO      CCVF9999 IF EQUAL
          PACK      KEY5,ANSR,ANSV,PTARCOD1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CCVF9999
          WRITE     HTMLFILE;PTCDLDES;
          GOTO      CCVF9999
.
CCVF0400  UNPACK    DIM127,ANS,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          COMPARE   ZERO,PTCNCMAU           * Which Adm UDF for Casemix Matrix
          GOTO      CCVF9999 IF EQUAL
.
          BRANCH    F1,CCVF0410
.
          WRITE     HTMLFILE;PTCNCMAU;      * Which Adm UDF for Casemix Matrix
          GOTO      CCVF9999
.
CCVF0410  LOAD      CATEGORY,PTCNCMAU,CATU1,CATU2,CATU3,CATU4,CATU5,CATU6:
                            CATU7,CATU8,CATU9,CATV1,CATV2
          LOAD      CODE,PTCNCMAU,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                             AUSR7,PTMIUSR8,PTMIUSR9,PTMIUSR0
          CALL      CODITM00
          GOTO      CCVF9999
.
CCVF0500  UNPACK    DIM127,ANS,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          COMPARE   ZERO,PTCNCMDU           * Which Adm UDF for Casemix Matrix
          GOTO      CCVF9999 IF EQUAL
.
          BRANCH    F1,CCVF0510
.
          WRITE     HTMLFILE;PTCNCMDU;      * Which Dis UDF for Casemix Matrix
          GOTO      CCVF9999
.
CCVF0510  LOAD      CATEGORY,PTCNCMDU,CATD1,CATD2,CATD3,CATD4,CATD5
          LOAD      CODE,PTCNCMDU,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
          CALL      CODITM00
          GOTO      CCVF9999
.
CCVF9999  RETURN
.
.------------------------------------------------------------
.   Patient list
.------------------------------------------------------------
PLST0000  BRANCH    FLDITMNO,PLST0100,PLST0200,PLST0300,PLST0400,PLST0500:
                             PLST0600,PLST0700,PLST0800,PLST0900,PLST1000:
                             PLST1100,PLST1200,PLST1300,PLST1400,PLST1500:
                             PLST1600,PLST1700,PLST1800,PLST1900,PLST2000:
                             PLST2100,PLST2200,PLST2300
          GOTO      PLST9999
.
PLST0100  MOVE      ZERO,SORTFLAG   * Next and Prev
          MOVE      ZERO,NZPVFLAG   * Default to discharge only
          CALL      IPND0000        * Table of invoice pending
          GOTO      PLST9999
.
PLST0200  CALL      PREVGR00        * Show Previous group of records
          GOTO      PLST9999
.
PLST0300  CALL      NEXTGR00        * Show Next group of records
          GOTO      PLST9999
.
PLST0400  WRITE     HTMLFILE;FILTVTYP;       * Visit Type Filter
          GOTO      PLST9999
.
PLST0500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PLST0510,PLST0520
          WRITE     HTMLFILE;FILTHFND;
          GOTO      PLST9999
.
PLST0510  PACK      KEY14,FILTHFND,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;FILTHFND;
          ENDIF
          GOTO      PLST9999
.
.   Display Selection List for health fund
.
PLST0520  PACK      KEY14,SP70
          CALL      RDSFUND1
PLST0525  CALL      RDKFUND1
          BRANCH    OVRCD,PLST9999
          MATCH     "0000    ",HFTABL
          GOTO      PLST0525 IF NOT EQUAL     * skip table record
.
          BRANCH    PHFTACT,PLST0525   * if code is inactive,ignore
.
          MATCH     HCODE,FILTHFND
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
                               HCODE,": ",HFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
                               HCODE,": ",HFNAME,"</option>"
          ENDIF
          GOTO      PLST0525
.
PLST0600  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          CALL      CODITM00
          GOTO      PLST9999
.
PLST0700  WRITE     HTMLFILE;FILTOPTN;       * Option
          GOTO      PLST9999
.
PLST0800  WRITE     HTMLFILE;CHNGDATE;       * Invoice date
          GOTO      PLST9999
.
PLST0900  CALL      LSTPAY00                 * List expected payors
          GOTO      PLST9999
.
PLST1000  CALL      LSTPMA00                 * List payer Medisave accounts
          GOTO      PLST9999
.
PLST1100  MOVE      ONE,SORTFLAG             * Tablesort
          MOVE      ZERO,NZPVFLAG           * Default to discharge only
          CALL      IPND0000                 * Table of invoice pending
          GOTO      PLST9999
.
PLST1200  CALL      NZCTCL00                 * NZ Private Contract Type
          GOTO      PLST9999                 * Selection List
.
PLST1300  CALL      NZCTRT00                 * NZ Private Contract
          GOTO      PLST9999                 * Selection List
.
PLST1400  MOVE      ONE,SORTFLAG            * Next and Prev
          MOVE      ONE,NZPVFLAG             * Default to discharge only
          CALL      IPND0000                 * Table of invoice pending
          GOTO      PLST9999
.
PLST1500  MOVE      "rh",CATEGORY
          MOVE      FILTHOLD,CODE
.
          MATCH     Z70,FILTHOLD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"~~~#" selected >":
                               "Not on Hold</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"~~~#">Not on Hold</option>"
          ENDIF
.
          CALL      CODITM00
          GOTO      PLST9999
.
PLST1600  WRITE     HTMLFILE;SHOWHEAD;     * Show invoice header
          GOTO      PLST9999
.
PLST1700  CALL      SELV0000
          GOTO      PLST9999
.
PLST1800  CALL      PREV0000
          GOTO      INVD9999
.
PLST1900  CALL      NEXT0000
          GOTO      INVD9999
.
PLST2000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      INVD9999
.
PLST2100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      INVD9999
.
PLST2200  PACK      KEY6,SP70
          CALL      RSPAHGP1
PLST2210  CALL      RKPAHGP1
          BRANCH    OVRCD,PLST2299
          MATCH     FILTHFGP,PTHGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PTHGCODE,"#" selected> ":
                               PTHGCODE,": ",PTHGDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PTHGCODE,"#"> ":
                               PTHGCODE,": ",PTHGDESC,"</option>"
          ENDIF
          GOTO      PLST2210
.
PLST2299  RETURN
.
PLST2300  WRITE     HTMLFILE;FILTCODD;       * Coded only filter
          GOTO      PLST9999
.
PLST9999  RETURN
.
.------------------------------------------------------------
.   Invoice Pending List according to visit type
.------------------------------------------------------------
IPND0000  MOVE      ZERO,LOOPCNTR
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ONE,SHOWFLAG            * Show no more message
.
          IF        SORTFLAG<>1
            IF        NORECORD=0
              MOVE    "10",NORECORD           * Numb of records=0 Default to 10
            ENDIF
            MOVE      ZERO,RECNUMB            * Init Number of records Read
            MOVE      ZERO,DISNUMB            * Init number of records output
          ENDIF
.
          IF        SORTFLAG<>1
            PACK      KEY5,ANSC,ANSL,SP70
            CALL      RDCODE1
.
            WRITE     HTMLFILE;"<tr><td class=HeadingCell width=9%>":
                               "Visit No.</td>":
                               "<td class=HeadingCell width=9%>U/R No.</td>":
                               "<td class=HeadingCell width=8%>Visit Type</td>":
                               "<td class=HeadingCell width=18%>Name</td>":
                               "<td class=HeadingCell width=9%>Visit Date</td>":
                               "<td class=HeadingCell width=9%>Disch.Date</td>":
                               "<td class=HeadingCell width=9%>",TDESC,"</td>":
                               "<td class=HeadingCell width=6%>Coding Complete":
                               "</td>";
            ENDIF
.
          MATCH     "1",PTCNHITC
          IF        @EQUAL
            IF        SORTFLAG<>1
              WRITE     HTMLFILE;"<td class=HeadingCell width=6%>":
                                 "Theatre Complete</td>";
            ENDIF
          ENDIF
.
          COMPARE   ONE,PTCNHDPS
          IF        @EQUAL
            IF        SORTFLAG<>1
              WRITE     HTMLFILE;"<td class=HeadingCell width=8%>Contract</td>";
            ENDIF
          ELSE
            IF        SORTFLAG<>1
              WRITE     HTMLFILE;"<td class=HeadingCell width=8%>Health Fund":
                                 "</td>";
            ENDIF
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"<td class=HeadingCell width=8%>Patient Class":
                               "</td>":
                               "<td class=HeadingCell width=8%>Reason for Hold":
                               "</td>";
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"</tr>"
          ELSE
            COMPARE   ZERO,GOSUBFLG
            GOTO      IPND9999 IF EQUAL
          ENDIF
.
          MOVE      SP70,KEY8
          CALL      RDSIPEN1
IPND1000  CALL      RDKIPEN1
          BRANCH    OVRCD,IPND9500
.
          MOVE      IPADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,IPND1000           * missing visit record
.
          MOVE      IPADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,IPND1000           * missing visit extn record
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      IPND1000 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,LOOPCNTR
.
.  Write record number in a comment to keep apache listening if no matching
.  record are found per 500 records
.
          IF        SORTFLAG=1
            IF        (LOOPCNTR = 500)
              WRITE     HTMLFILE;"// ",LOOPCNTR
              MOVE      ZERO,LOOPCNTR
            ENDIF
          ENDIF
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,IPND1000
          CALL      RDPMPX21
          BRANCH    OVRCD,IPND1000
.
          IF        NZPVFLAG=1
            UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
            CALL      IBACLOCK
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
          ELSE
            CALL      PATNAM00              * Patient name (Surname+) *I-196169
            MOVE      PATFNAME,SRTFNAME                               *I-196169
            PACK      SRTFNAME,PSNAME,SP1,PGNAME,SP1,PTITL
          ENDIF
.
.         1 = A&E, 2 = O/P, 3 = Inp
.
          COMPARE   ZERO,FILTVTYP
          GOTO      IPND2000 IF EQUAL        * all visit type
.
          COMPARE   FILTVTYP,IPSYSTM
          GOTO      IPND1000 IF NOT EQUAL    * different visit type
.
IPND2000  MOVE      SP10,DDATE
          MOVE      SP10,SYSCOD
          MOVE      SP70,CODECOMD
          MOVE      SP70,CODECOMP
          MOVE      SP70,CODEINCO
          IF        SORTFLAG<>1
            MOVE      "&nbsp;",CODECOMP
            MOVE      "&nbsp;",CODEINCO
          ENDIF
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,PENDHOSP    * Hospital ID
          ENDIF
.
          BRANCH    IPSYSTM,IPND2200,IPND2400,IPND2600
          GOTO      IPND1000
.
.         Check for Emergency event
.
IPND2200  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            IF        EMVIYN09=1 | EMVIYN09=2
              MOVE      "Dr Billing Complete ",CODECOMP
            ENDIF
          ENDIF
.
          MOVE      " 1",PENDSYST            * Emergency
          MOVE      SP70,PENDDDAT
          IF        EMVISTAT=2 | EMVISTAT=3
            MOVE      EMVIDDAT,PENDDDAT      * discharged date
          ENDIF
.
          COMPARE   NINE,PVITYPE
          GOTO      IPND2300 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      IPND2300 IF NOT EQUAL        * Not Emergency event
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,IPND2300
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,IPND2300
          MATCH     ANSE,TCINDC1
          GOTO      IPND2300 IF NOT EQUAL        * Emergency event
.
          MOVE      PMEVADTE,ADATE
          MOVE      PMEVCCOD,ACLAIM
          MOVE      PMEVADMT,ATYPE
          UNPACK    SP70,AFUNDH,AFNDTB,ACODDTE,PTMICMXP
          MOVE      "AAE",SYSCOD
          MOVE      PMEVDDTE,DDATE
          MOVE      ZERO,ASTAT
          GOTO      IPND3000
.
IPND2300  MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD OF IPND1000
.
          UNPACK    ADADATE,ADATE
          MOVE      ADACOMP,ACLAIM
          MOVE      ADACLASS,ATYPE
          MOVE      AEDAFUND,AFUNDH
          MOVE      AEDATBLE,AFNDTB
          MOVE      "EMR",SYSCOD
          MOVE      ZERO,ASTAT
          GOTO      IPND3000
.
IPND2400  CALL      GETB0000
          BRANCH    OVRCD,IPND1000
.
          MOVE      " 2",PENDSYST            * Outpatient
          MOVE      OBADATE,PENDDDAT         * as discharged date
.
          MOVE      OBADATE,ADATE
          MOVE      OBACOMP,ACLAIM
          MOVE      OBACLASS,ATYPE
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          MOVE      "OUT",SYSCOD
          MOVE      ZERO,ASTAT
          GOTO      IPND3000
.
IPND2600  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,IPND1000
          MOVE      "INP",SYSCOD
.
.
          MATCH     SP70,FILTCODD                 * coded only filter
          IF        !@EQUAL 
            MATCH     SP70,ACODDTE 
            GOTO      IPND1000 IF EQUAL   
          ENDIF
.
          MATCH     SP70,ACODDTE
          IF        @EQUAL
            MATCH     SP70,PMVXUDF5
            IF        !@EQUAL
              PACK      KEY5,CATdr,PMVXUDF5,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,CODEINCO           * coding delay reason
              ENDIF
            ENDIF
          ELSE
            UNPACK    ACODDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      CODECOMP,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            MOVE      ACODDTE,CODECOMD
          ENDIF
.
          MOVE      " 3",PENDSYST                 * Inpatient
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
.
IPND3000  MATCH     SP70,FILTCLAM
          GOTO      IPND3500 IF EQUAL
          MATCH     "All",FILTCLAM
          GOTO      IPND3500 IF EQUAL
          MATCH     FILTCLAM,ACLAIM
          GOTO      IPND1000 IF NOT EQUAL
.
IPND3500  IF        SORTFLAG=1 & NZPVFLAG=0
            MOVE      SP70,PTHFHGRP
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO4,SP20
              CALL      RDFUND1         * to get health fund group code 
            ENDIF
.
            MATCH     SP70,FILTHFGP
            GOTO      IPND4000 IF EQUAL
            MATCH     "All",FILTHFGP
            GOTO      IPND4000 IF EQUAL
.
            MATCH     SP70,AFUNDH
            GOTO      IPND1000 IF EQUAL
.
            MATCH     FILTHFGP,PTHFHGRP
            GOTO      IPND1000 IF NOT EQUAL 
          ENDIF
.
IPND4000  MATCH     SP70,FILTHFND
          GOTO      IPND5000 IF EQUAL
          MATCH     "All",FILTHFND
          GOTO      IPND5000 IF EQUAL
          MATCH     FILTHFND,AFUNDH
          GOTO      IPND1000 IF NOT EQUAL
.
.
IPND5000  CALL      CHLD0000           Check current status of hold invoice
.
          MATCH     SP70,FILTHOLD                * All
          GOTO      IPND6000 IF EQUAL
.
          MATCH     Z70,FILTHOLD                 * Not on hold (Blank reason)
          IF        @EQUAL
            MATCH     SP70,PTIPRHLD
            GOTO      IPND1000 IF NOT EQUAL
            GOTO      IPND6000
          ENDIF
.
          MATCH     FILTHOLD,PTIPRHLD            * On hold filter
          GOTO      IPND1000 IF NOT EQUAL
.
IPND6000  IF        NZPVFLAG=1
            IF        FILTOPTN=0
              COMPARE   THREE,ASTAT
              GOTO      IPND1000 IF NOT EQUAL     * discharged patients only
            ENDIF
            IF        ASTAT=3
              MATCH     FRSTDATE,DDATE
              GOTO      IPND1000 IF LESS
              MATCH     DDATE,LASTDATE
              GOTO      IPND1000 IF LESS
            ENDIF
          ELSE
            IF        FILTOPTN=1
              COMPARE   THREE,ASTAT
              GOTO      IPND1000 IF NOT EQUAL     * discharged patients only
            ENDIF
          ENDIF
.
          IF        SORTFLAG<>1
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      IPND1000            * If < than strt Rec then Read Next
            ENDIF
          ENDIF
.
          IF         SORTFLAG<>1
            IF        (DISNUMB%2) = 0
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY12
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"<img src=../images/EditIcon.gif":
                               " class=ListIcon ":
                               " onclick='SetInvPndCookies();linkPatient(#"":
                                 PVIBILL,"#",#"":
                                 PVIURNO,"#",#"":
                                 PVITYPE,"#");'>":
                                 PVIBILL,"</td>";
          ELSE
              CLEAR     HTMLLINK
              APPEND    "javascript:SetInvPndCookies();linkPatient('",HTMLLINK
              APPEND    PVIBILL,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    PVIURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    PVITYPE,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    PVIBILL,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
              WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                             "#"",PVIBILL,"#",";                     * 1
          ENDIF
.
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MATCH     SP70,KEY20
            IF        !@EQUAL
              IF        SORTFLAG<>1
                WRITE     HTMLFILE;"<td>",KEY20,"</td>";
              ELSE
                WRITE     HTMLFILE;"#"",KEY20,"#",";                 * 2
              ENDIF
            ELSE
              IF        SORTFLAG<>1
                WRITE     HTMLFILE;"<td>",PVIURNO,"</td>";
              ELSE
                WRITE     HTMLFILE;"#"",PVIURNO,"#",";               * 2
              ENDIF
            ENDIF
          ELSE
            IF        SORTFLAG<>1
              WRITE     HTMLFILE;"<td>",PVIURNO,"</td>";
            ELSE
              WRITE     HTMLFILE;"#"",PVIURNO,"#",";                 * 2
            ENDIF
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"<td>",SYSCOD,"</td>":
                               "<td>",PATFNAME,"</td>":
                               "<td>",KEY12,"</td>";
          ELSE
              IF        NZPVFLAG=1
                WRITE     HTMLFILE;"#"",SYSCOD,"#",":                  * 3
                                   "#"",FORMATNM,"#",":                * 4
                                   "#"",ADATE,"#",";                   * 5
              ELSE
                WRITE     HTMLFILE;"#"",SYSCOD,"#",":                  * 3
                                   "#"",PATFNAME,"#",":                * 4
                                   "#"",ADATE,"#",";                   * 5
              ENDIF
          ENDIF
.
          IF        SORTFLAG<>1
            MATCH     SP10,DDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp</td>";
            ELSE
              MOVE      SP70,KEY12
              UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                   NOV,DEC
              PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;"<td>",KEY12,"</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",DDATE,"#",";                     * 6
          ENDIF
.
          MOVE      SP20,DANS1
          PACK      KEY5 WITH ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DANS1
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"<td>",DANS1,"</td>";
          ELSE
            WRITE     HTMLFILE;"#"",DANS1,"#",";                     * 7
          ENDIF
.
          MOVE      SP20,DANS2
          PACK      KEY5 WITH ANSA,SP1,ATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DANS2
          ENDIF
.
          IF        SORTFLAG<>1
            MATCH     "&nbsp;",CODECOMP
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>",CODEINCO,"</td>";  * coding delay reason
            ELSE
              WRITE     HTMLFILE;"<td>",CODECOMP,"</td>";
            ENDIF
          ELSE
            MATCH     SP70,CODECOMP
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",CODEINCO,"#",";                  * 8
            ELSE
              WRITE     HTMLFILE;"#"<input type='hidden' value='",CODECOMD,"'>":
                                 CODECOMP,"#",";                  * 8
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNHITC
          IF        @EQUAL
            CALL      CHKT0000                 * Check if there is theatre
            IF        EXIT=0
              MATCH     "1",PMVXATCP
              IF        @EQUAL
                IF        SORTFLAG<>1
                  WRITE     HTMLFILE;"<td>Yes</td>";
                ELSE
                  WRITE     HTMLFILE;"#"",DYES,"#",";                  * 9
                ENDIF
              ELSE
                MOVE      SP70,KEY22
                MATCH     SP70,PMVXTICM
                IF        !@EQUAL
                  MOVE      "Rt",KEY2
                  PACK      KEY5,KEY2,PMVXTICM     * Reason Theatre Incomplete
                  CALL      RDCODE1
                  IF        OVRCD=0
                    MOVE      " (",KEY2
                    MOVE      ")",KEY1
                    PACK      KEY22,KEY2,TDESC,KEY1,SP70
                  ENDIF
                ENDIF
                IF        SORTFLAG<>1
                  WRITE     HTMLFILE;"<td>No",KEY22,"</td>";
                ELSE
                  WRITE     HTMLFILE;"#"",DNO,KEY22,"#",";             * 9
                ENDIF
              ENDIF
            ELSE
              IF        SORTFLAG<>1
                WRITE     HTMLFILE;"<td>N/A</td>";
              ELSE
                WRITE     HTMLFILE;"#"","N/A","#",";                   * 9
              ENDIF
            ENDIF
          ELSE
            IF        SORTFLAG=1
              WRITE     HTMLFILE;"#"",SP1,"#",";                       * 9
            ENDIF
          ENDIF
.
          IF        SORTFLAG<>1
            MATCH     SP10,AFUNDH
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",AFUNDH,"/",AFNDTB,"</td>";
            ENDIF
          ELSE
            MATCH     SP10,AFUNDH
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",SP1,"#",";                       * 10
            ELSE
              IF        NZPVFLAG=1
                WRITE     HTMLFILE;"#"",AFUNDH,"&nbsp#;",AFNDTB,"#",";   * 10
              ELSE
                WRITE     HTMLFILE;"#"",AFUNDH,"/",AFNDTB,"#",";         * 10
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,HOLDDESC                * Reason for hold
          MATCH     SP70,PTIPRHLD
          IF        !@EQUAL
            PACK      KEY5,CATRH,PTIPRHLD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTIPRHLD,TDESC
            ENDIF
            MOVE      TDESC,HOLDDESC
          ENDIF
.
          IF        SORTFLAG<>1
            WRITE     HTMLFILE;"<td>",DANS2,"&nbsp;</td>":
                               "<td>",HOLDDESC,"&nbsp;</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"#"",DANS2,"#",";                        * 11
          ENDIF
.                                                                     *I-196169
          MOVE      ZERO,F1
          MOVE      PTIPRSTA,F1
          MOVE      SP70,KEY10
          LOAD      KEY10,F1,IPESTAT1,IPESTAT2,IPESTAT3,IPESTAT4,IPESTAT5:
                             IPESTAT6,IPESTAT7,IPESTAT8,IPESTAT9
          IF        SORTFLAG=1
            WRITE     HTMLFILE;"#"",SRTFNAME,"#",":                     * 12
                               "#"",HOLDDESC,"#",":                     * 13
                               "#"",KEY10,"#"";                        * 14
          ENDIF
.
          IF        SORTFLAG=1 & NZPVFLAG=0    
            MATCH     SP70,PTHFHGRP
            IF        !@EQUAL
              PACK      KEY6,PTHFHGRP,SP70
              CALL      RDPAHGP1             * health fund group
              IF        OVRCD=0
                WRITE     HTMLFILE;",#"",PTHGDESC,"#"";                    * 15
                GOTO      IPND8000
              ENDIF
            ENDIF
            WRITE     HTMLFILE;",#"",SP1,"#"";                         * 15
          ENDIF                    
.
IPND8000  IF        SORTFLAG=1
            WRITE     HTMLFILE;");"           * closing bracket
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
.
          IF        SORTFLAG<>1
            ADD       ONE,DISNUMB
            COMPARE   NORECORD,DISNUMB
            GOTO      IPND1000 IF NOT EQUAL
            MOVE      ZERO,SHOWFLAG
          ELSE
            GOTO      IPND1000
          ENDIF
.
IPND9500  IF          SORTFLAG<>1
            CALL      NOMORE00                * Show no more visit message
          ENDIF
.
IPND9999  RETURN
+
.------------------------------------------------------------
.         Check current status of hold invoice
.------------------------------------------------------------
CHLD0000  MATCH     SP70,PTIPRHLD
          GOTO      CHLD0200 IF EQUAL      * not on hold
.
.         Invoice already on hold, check for Patient hold invoice
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,CHLD0200
.
          MATCH     "P",TCINDC2
          GOTO      CHLD9999 IF EQUAL             * Patient hold invoice
.
          MATCH     "C",TCINDC4
          GOTO      CHLD9999 IF EQUAL             * CodeFocus hold invoice
.
CHLD0200  MOVE      ADATE,PENDSDAT               * as at date
          MOVE      ADATE,PENDADAT               * visit date
          MOVE      AFUNDH,PENDFUND
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
          CALL      UPIPEN1                      * Update Hold invoice status
CHLD9999  RETURN
+
.------------------------------------------------------------
.         Check if there is theatre
.------------------------------------------------------------
CHKT0000  PACK      KEY31,IPADMNO,SP70
          CALL      RSOPDEA2
CHKT1000  CALL      RKOPDEA2
          BRANCH    OVRCD,CHKT9000
.
          MATCH     DIPADMNO,OPDAADMN
          GOTO      CHKT9000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CHKT1000 IF EQUAL       * cancelled
.
          PACK      KEY11,OPDAUNIQ,SP70   * reading surgical table
          CALL      RSOPSRG1              * to find if case abandoned
CHKT2000  CALL      RKOPSRG1
          BRANCH    OVRCD,CHKT3000
.
          MATCH     OPSGUNID,OPDAUNIQ
          GOTO      CHKT3000 IF NOT EQUAL
.
          MATCH     "1",OPSGUY05           * ignore if case was abandoned
          GOTO      CHKT1000 IF EQUAL     
.
CHKT3000  MOVE      ZERO,EXIT               * found a theatre visit
          GOTO      CHKT9999
.
CHKT9000  MOVE      ONE,EXIT                * No theatre
CHKT9999  RETURN
+
.------------------------------------------------------------
. NOMORE00 - Display "No more record" 
.------------------------------------------------------------
NOMORE00  COMPARE    ONE,SHOWFLAG
          GOTO       NOMORE99 IF NOT EQUAL
          WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                              "<td colspan=12 align=center>":
                              "No more records</td>"
NOMORE99  RETURN
.
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
          REP       " +",FILTHOLD
.
          WRITE     HTMLFILE;"patweb71.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&filtvtyp=",FILTVTYP:
                                 "&filthfnd=",FILTHFND:
                                 "&filtclam=",FILTCLAM:
                                 "&filthold=",FILTHOLD:
                                 "&filtoptn=",FILTOPTN:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&showhead=",SHOWHEAD;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",PREVVKEY
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
          REP       "+ ",FILTHOLD
.
PREVGR99  RETURN
.
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
          REP       " +",FILTHOLD
.
          WRITE     HTMLFILE;"patweb71.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&filtvtyp=",FILTVTYP:
                                 "&filthfnd=",FILTHFND:
                                 "&filtclam=",FILTCLAM:
                                 "&filthold=",FILTHOLD:
                                 "&filtoptn=",FILTOPTN:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&showhead=",SHOWHEAD;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
          REP       "+ ",FILTHOLD
.
NEXTGR99  RETURN
.
.------------------------------------------------------------
.   Verify Patient Invoice
.------------------------------------------------------------
INVD0000  BRANCH    FLDITMNO,INVD0100,INVD0200,INVD0300,INVD0400,INVD0500:
                             INVD0600,INVD0700,INVD0800,INVD0900,INVD1000:
                             INVD1100,INVD1200,INVD1300,INVD1400,INVD1500:
                             INVD1600,INVD1700,INVD1800,INVD1900,INVD2000:
                             INVD2100,INVD2200,INVD2300,INVD2400,INVD2500:
                             INVD2600,INVD2700,INVD2800,INVD2900,INVD3000:
                             INVD3100,INVD3200,INVD3300,INVD3400,INVD3500:
                             INVD3600,INVD3700,INVD3800,INVD3900,INVD4000:
                             INVD4100,INVD4200,INVD4300,INVD4400,INVD4500:
                             INVD4600,INVD4700,INVD4800,INVD4900,INVD5000:
                             INVD5100,INVD5200,INVD5300,INVD5400,INVD5500:
                             INVD5600,INVD5700,INVD5800,INVD5900,INVD6000:
                             INVD6100,INVD6200,INVD6300,INVD6400,INVD6500:
                             INVD6600,INVD6700,INVD6800,INVD6900,INVD7000:
                             INVD7100,INVD7200,INVD7300,INVD7400,INVD7500:
                             INVD7600,INVD7700,INVD7800,INVD7900,INVD8000:
                             INVD8100,INVD8200,INVD8300,INVD8400,INVD8500:
                             INVD8600,INVD8700,INVD8800,INVD8900,INVD9000:
                             INVD9100,INVD9200,INVD9300,INVD9400,INVD9500:
                             INVD9600,INVD9700,INVD9800,INVD9900
          GOTO      INVD9999
.
INVD0100  CALL      SELPRT00
          GOTO      INVD9999
.
INVD0200  CALL      FRMDAT00
          GOTO      INVD9999
.
INVD0300  CALL      TODATE00 
          GOTO      INVD9999
.
INVD0400  MOVE      ZERO,BDTEFLAG    * set backdating invoice flag
          MOVE      SP70,BACKDATE
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,DBSFLAG
          CALL      DINV0000         * Display to patient invoice
          GOTO      INVD9999
.
INVD0500  CALL      PEND0000         * Invoice pending List
          GOTO      INVD9999
.
INVD0600  CALL      PREVPR00
          GOTO      INVD9999
.
INVD0700  CALL      NEXTPR00
          GOTO      INVD9999
.
INVD0800  CALL      NEXT0000
          GOTO      INVD9999
.
INVD0900  CALL      PREV0000
          GOTO      INVD9999
.
INVD1000  CALL      SELV0000
          GOTO      INVD9999
.
INVD1100  CALL      HFND0000                * Health fund selection
          GOTO      INVD9999
.
INVD1200  WRITE     HTMLFILE;TEMPLATE;
          GOTO      INVD9999
.
INVD1300  WRITE     HTMLFILE;REPORTNO;
          GOTO      INVD9999
.
INVD1400  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      INVD9999
.
INVD1500  MOVE      "CL",CATEGORY           * Selection List of Claimcode
          MOVE      CLAIMTYP,CODE
          CALL      CODITM00
          GOTO      INVD9999
.
INVD1600  MOVE      "A ",CATEGORY           * Selection List of admission type
          MOVE      ADMNTYPE,CODE
          CALL      CODITM00
          GOTO      INVD9999
.
INVD1700  CALL      PSOP0000                * Selection list of patient status
          GOTO      INVD9999
.
INVD1800  CALL      CDOP0000                * Selection coded (all/yes/no)
          GOTO      INVD9999
.
INVD1900  CALL      CPOP0000                * Selection casepayment (all/yes/no)
          GOTO      INVD9999
.
INVD2000  CALL      IVOP0000                * Selection for zero invoice
          GOTO      INVD9999
.
INVD2100  WRITE     HTMLFILE;SELECTID;      * used by bulk invoice print
          GOTO      INVD9999
.
INVD2200  WRITE     HTMLFILE;PRNTFLAG;      * used by bulk invoice print
          GOTO      INVD9999
.
INVD2300  WRITE     HTMLFILE;TRANSNUM;
          GOTO      INVD9999
.
INVD2400  MOVE      ZERO,BDTEFLAG           * set 'No' to backdating invoice flg
          MOVE      SP70,BACKDATE
          CALL      CZER0000                * check for zero invoice
          WRITE     HTMLFILE;FORM1;         * used by availability of print inv.
          GOTO      INVD9999
.
INVD2500  MOVE      ZERO,FORM1
          MATCH     SP10,CHNGDATE
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      ONE,FORM1
          WRITE     HTMLFILE;FORM1;        * availability of print backdate inv.
          GOTO      INVD9999
.
INVD2600  MATCH     SP10,CHNGDATE
          GOTO      INVD9999 IF EQUAL
.
          MOVE      ZERO,ISBLFLAG
          MOVE      SP70,KEY1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        F1=1
            MOVE      ONE,ISBLFLAG          * Independence services billing
            CALL      AREG0000              * Add items of the Regime
          ENDIF
.
          MOVE      ZERO,PPAYABLE           * Patient Balance payable
          MOVE      ZERO,CPAYPRIV           * Co-payment for private
          MOVE      ZERO,CPAYSHRD           * Co-payment for shared
          MOVE      ZERO,CPAYCCUH           * Co-payment for CCU/ICU/SCN/HDU
          MOVE      ZERO,DISPROG
          MOVE      ONE,NUMINVS
          MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,DBSFLAG
          CALL      DINV0000                * Display backdated invoice
          GOTO      INVD9999
.
INVD2700  REP       " 0",CHNGDATE
          UNPACK    CHNGDATE INTO CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD2800  MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          CALL      CZER0000                * check for zero invoice
          WRITE     HTMLFILE;FORM1;         * used by availability of print inv.
          GOTO      INVD9999
.
INVD2900  WRITE     HTMLFILE;CHNGDATE;
          GOTO      INVD9999
.
INVD3000  MOVE      "CL",CATEGORY           * Selection List of Claimcode
          MOVE      ACLAIM,CODE
          CALL      CODITM00
.
INVD3100  WRITE     HTMLFILE;PTCNBINV;
          GOTO      INVD9999
.
INVD3200  MOVE      ONE,PROGFLAG
          MOVE      ONE,MSGFLAG             * check if matrix button be avail.
          CALL      CMXMATRX                * Check for matrix
          WRITE     HTMLFILE;CBFLAG;
          GOTO      INVD9999
.
INVD3300  MOVE      ONE,PROGFLAG
          MOVE      TWO,MSGFLAG           * set flag to display matrix
          CALL      CMXMATRX
          GOTO      INVD9999
.
INVD3400  COMPARE   ONE,IBCNMHOS
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTHSNAME;
            ENDIF
          ENDIF
          GOTO      INVD9999
.
INVD3500  MOVE      ZERO,FORM1
          MATCH     "Y",PTMICMXP
          GOTO      INVD3520 IF NOT EQUAL
          MOVE      ONE,FORM1           * matrix button available
INVD3520  WRITE     HTMLFILE;FORM1; 
          GOTO      INVD9999
.
INVD3600  MATCH     SP10,CHNGDATE
          GOTO      INVD9999 IF EQUAL
.
          MOVE      ONE,NUMINVS
          MOVE      ONE,BDTEFLAG    * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ONE,JHFLAG
          MOVE      ZERO,DBSFLAG
          MOVE      ZERO,CSTDOWN     * No stepdown
          CALL      DINV0000         * Display to patient invoice
          MOVE      ZERO,JHFLAG
          GOTO      INVD9999
.
INVD3700  MATCH     SP70,EXPPAYER
          IF        @EQUAL
            IF        CFEETYP=5
              CALL      DPRA0000         * default to PRFA for NZ Private
            ELSE
              CALL      DPAY0000         * Use default expected payer
            ENDIF
          ELSE
            IF        CFEETYP=5
              CALL      SPAY0000         * Funders List for NZ Private
            ELSE
              CALL      EPAY0000         * Expected payers/Funders List
            ENDIF
          ENDIF
          GOTO      INVD9999
.
INVD3800  WRITE     HTMLFILE;TOTCHRG; 
          GOTO      INVD9999
.
INVD3900  CALL      GPAY0000         * Get the default next expected payer
          WRITE     HTMLFILE;VSPAPAYC;
          GOTO      INVD9999
.
INVD4000  WRITE     HTMLFILE;PKADD1;
          GOTO      INVD9999
.
INVD4100  WRITE     HTMLFILE;PKADD2;
          GOTO      INVD9999
.
INVD4200  WRITE     HTMLFILE;PKSUBR;
          GOTO      INVD9999
.
INVD4300  WRITE     HTMLFILE;PKADD4;
          GOTO      INVD9999
.
INVD4400  WRITE     HTMLFILE;PKPOST;
          GOTO      INVD9999
.
INVD4500  WRITE     HTMLFILE;EXPPAYER;
          GOTO      INVD9999
.
INVD4600  MATCH     SP10,CHNGDATE
          GOTO      INVD9999 IF EQUAL
.
          MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      ONE,JHFLAG
          MOVE      ZERO,DBSFLAG
          MOVE      ZERO,CSTDOWN            * No stepdown
.
          CLOSE     PMSMTIA1
          CLOSE     PMSMTIA4
.
          IF        CFEETYP=9
            OPEN      PMSMTIA1,"pmsmteaf"
            OPEN      PMSMTIA4,"pmsmteaf"
          ENDIF
          REP       " 0",CHNGDATE
          MOVE      CHNGDATE,BACKDATE
.
          MOVE      ONE,ESTFLAG
          CALL      DINV0000                * Display backdated invoice
          MOVE      ZERO,ESTFLAG
          CLOSE     PMSMTIA1
          CLOSE     PMSMTIA4
.
          MOVE      ZERO,JHFLAG
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          GOTO      INVD9999
.
INVD4700  PACK      KEY8,CCC,CYY,CMM,CDD
          IF        ASTAT=3
            MOVE      DDATE,KEY8
          ENDIF
          REP       " 0",KEY8
          UNPACK    KEY8 INTO CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD4800  PACK      CHNGDATE,CCC,CYY,CMM,CDD
          COMPARE   NINE,CFEETYP
          GOTO      INVD4840 IF NOT EQUAL   * Not using Johns Hopkins bed fees
.
          PACK      KEY18,ADMISSNO,ZERO,SP70
          CALL      RSPMMTE4
INVD4820  CALL      RKPMMTE4
          BRANCH    OVRCD,INVD4840
.
          MATCH     ADMISSNO,PMMIVISN        * Same visit number?
          GOTO      INVD4840 IF NOT EQUAL
          MATCH     "0",PMMIRTYP             * header record
          GOTO      INVD4840 IF NOT EQUAL
.
          MATCH     WBSEUID,PMMIWUSR         * WEB User ID
          GOTO      INVD4820 IF NOT EQUAL    * try next record
          MOVE      PMMITDAT,CHNGDATE    * Save Billing date
.
INVD4840  REP       " 0",CHNGDATE
          UNPACK    CHNGDATE INTO CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD4900  WRITE     HTMLFILE;VSPAY006;
          GOTO      INVD9999
.
INVD5000  CALL      CDCH0000                * check for doctor charges
          WRITE     HTMLFILE;FORM1;         * used by availability of add disc.
          GOTO      INVD9999
.
INVD5100  CALL      LPRC0000          * List of procedure codes
          GOTO      INVD9999
.
INVD5200  CALL      CHCODW00          * warning if coding required
          WRITE     HTMLFILE;EXIT;
          GOTO      INVD9999
.
INVD5300  WRITE     HTMLFILE;SUPERLEV;
          GOTO      INVD9999
.
INVD5400  WRITE     HTMLFILE;CERTINDC;
          GOTO      INVD9999
.
INVD5500  COMPARE   ZERO,NZSPFFEE
          GOTO      INVD5520 IF NOT EQUAL
          MOVE      ONE,PROGFLAG      * Workout fees only
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          CALL      GPFE0000          * Get fees from procedure fees file
INVD5520  WRITE     HTMLFILE;NZSPFFEE;
          GOTO      INVD9999
.
INVD5600  COMPARE   ZERO,NZSPCPAY
          GOTO      INVD5620 IF NOT EQUAL
          MOVE      ONE,PROGFLAG      * Workout fees only
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          CALL      GPFE0000          * Get fees from procedure fees file
INVD5620  WRITE     HTMLFILE;NZSPCPAY;
          GOTO      INVD9999
.
INVD5700  COMPARE   ZERO,NZSPHPAY
          GOTO      INVD5720 IF NOT EQUAL
          MOVE      ONE,PROGFLAG      * Workout fees only
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          CALL      GPFE0000          * Get fees from procedure fees file
INVD5720  WRITE     HTMLFILE;NZSPHPAY;
          GOTO      INVD9999
.
INVD5800  MOVE      ZERO,DISPROG
          MOVE      ONE,NUMINVS
          MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ONE,DBSFLAG
          MOVE      ZERO,TDBSAMNT
          MOVE      ZERO,CPAYPRIV           * Co-payment for private
          MOVE      ZERO,CPAYSHRD           * Co-payment for shared
          MOVE      ZERO,CPAYCCUH           * Co-payment for CCU/ICU/SCN/HDU
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,PAGENO
          CALL      DINV0000                * Display backdated invoice
          CALL      DELG0000                * Display Eligibility Check
          MOVE      ZERO,PRINTFLG
          CALL      DSIV0000                * Display all Invoices details
          GOTO      INVD9999
.
INVD5900  WRITE     HTMLFILE;IVDETAIL;
          GOTO      INVD9999
.
.         Patient Only Invoice will only Charge Accom./Items with NO HF portion
.
INVD6000  MATCH     SP10,CHNGDATE
          GOTO      INVD9999 IF EQUAL
.
.         Check if Accommodation has Patient portion only
.
          MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ZERO,IPATFLAG
          MOVE      ZERO,NETTOT
          MOVE      ONE,PROGFLAG
.
          MATCH     "1",PTCNPPIN
          GOTO      INVD6040 IF NOT EQUAL  * not using Pat.Inv.new functionality
.
          MOVE      TWO,IPATFLAG
          CALL      CALCTBI
.
          IF        NUMBINVR=1
            IF        HFACCM<>0
              MOVE      ONE,NCHACCOM      * Do not Charge Accommodation
            ENDIF
          ENDIF
          GOTO      INVD6080
.
INVD6040  CALL      CALCTBI
.
.         If Accommodation has HF portion, do not charge Accomodation
.         and Only charge items with No HF portion
.
          MOVE      ONE,IPATFLAG            * Flag for Patient Only Invoice
          IF        HFACCM<>0
            MOVE      ONE,NCHACCOM          * Do not Charge Accommodation
          ENDIF
.
INVD6080  CALL      CDEP0000                * Clear flag for Deposits
.
          MOVE      ZERO,DISPROG
          MOVE      ONE,NUMINVS
          MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,DBSFLAG
          CALL      DINV0000                * Display backdated invoice
          GOTO      INVD9999
.
INVD6100  WRITE     HTMLFILE;PTCNICLS;
          GOTO      INVD9999
.
INVD6200  CALL      SACT0000                * Selection of Action plans
          GOTO      INVD9999
.
INVD6300  PACK      KEY19,URNUMBER,SP70
          CALL      RSPTCER1
          CALL      RKPTCER1
          BRANCH    OVRCD,INVD9999
.
          MATCH     URNUMBER,PTCEURNO
          GOTO      INVD9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;          * Certificates exist
          GOTO      INVD9999
.
INVD6400  WRITE     HTMLFILE;SHOWHEAD;     * Show invoice header
          GOTO      INVD9999
.
INVD6500  MOVE      "CL",CATEGORY          * Selection List of Claimcode
          PACK      COMPCLAM,COMPCLAM,SP70
          MATCH     SP70,COMPCLAM
          IF        @EQUAL
            CALL      GCLM0000
          ENDIF
          MOVE      COMPCLAM,CODE
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE      PMEXT002,CODE
          ENDIF
          CALL      CODITM00
          GOTO      INVD9999
.
INVD6600  MATCH     COMPDATE,SP70
          GOTO      INVD9999 IF EQUAL
.
          UNPACK    COMPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD6700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,INVD6710
          WRITE     HTMLFILE;CMCODE;
          GOTO      INVD9999
.
INVD6710  OPEN      PATCMCA1,"patcmcaf"
          PACK      KEY9,CMCODE,SP70
          CALL      RDPTCMC1
          BRANCH    OVRCD,INVD9999
          WRITE     HTMLFILE;PTCADES1;
          GOTO      INVD9999
.
INVD6800  PACK      KEY30,CONTRCID,SP70
          MOVE      CONTRCID,KEY6
          CALL      RDPMCID1
          IF        OVRCD=0
            MOVE      "-",KEY1
            PACK      KEY20,PMCIDESC,SP70
            PACK      KEY30,CONTRCID,SP3,KEY1,KEY20,SP70
          ENDIF
          WRITE     HTMLFILE;KEY30;
          GOTO      INVD9999
.
INVD6900  UNPACK    SP70,PMPGCODE,PMPGDESC       * default - display Desc
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,INVD6910
.
          WRITE     HTMLFILE;"&nbsp;",PMVXPRGM;
          GOTO      INVD9999
.
INVD6910  OPEN      PMSPRGA1,"pmsprgaf"
          PACK      KEY8,PMVXPRGM,SP8
          CALL      RDPMPRG1
          WRITE     HTMLFILE;"&nbsp;",PMPGDESC;
          GOTO      INVD9999
.
INVD7000  MATCH     ACODDTE,SP70
          GOTO      INVD9999 IF EQUAL
          UNPACK    ACODDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD7100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          COMPARE   ZERO,ADYHOSP
          GOTO      INVD7120 IF EQUAL
.
          BRANCH    F1,INVD7110,INVD7111
          WRITE     HTMLFILE;"Days of Hospitalisation";
          GOTO      INVD9999
.
INVD7110  WRITE     HTMLFILE;ADYHOSP;
          GOTO      INVD9999
.
INVD7111  WRITE     HTMLFILE;"Prior Days Hospitalisation";
          GOTO      INVD9999
.
INVD7120  WRITE     HTMLFILE;"&nbsp;";
          GOTO      INVD9999
.
INVD7200  MOVE      TWO,F1
          CALL      RHIN0000
          MATCH     "&nbsp;",KEY30
          IF        @EQUAL
            WRITE     HTMLFILE;"Reason for Hold";
          ELSE
            WRITE     HTMLFILE;"<font color=red>Reason for Hold";
          ENDIF
          GOTO      INVD9999
.
INVD7300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      RHIN0000              * Check Reason for holding invoice
          BRANCH    F1,INVD7320           * display full description
          GOTO      INVD7340
.
INVD7320  MATCH     SP70,PTIPRDES
          GOTO      INVD7340 IF EQUAL
          WRITE     HTMLFILE;PTIPRDES;
          GOTO      INVD9999
.
INVD7340  WRITE     HTMLFILE;KEY30;
          GOTO      INVD9999
.
INVD7400  WRITE     HTMLFILE;NZPEFLAG;      * NZ Private error flag
          GOTO      INVD9999
.
INVD7500  WRITE     HTMLFILE;PRESFLAG;      * NZ Private Person responsible flag
          GOTO      INVD9999
.
INVD7600  MOVE      ZERO,FORM1             * default flag to non casepayment 
          CALL      CCPY0000                * Check for casepayment
          MOVE      CMXFLAG,FORM1           * set casepayment flag
          WRITE     HTMLFILE;FORM1;
          GOTO      INVD9999
.
INVD7700  CALL      ECLIND00
          GOTO      INVD9999
.
INVD7800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,PTMI3BDY
          GOTO      INVD7820 IF EQUAL
          MOVE      ZERO,FORM4
          MOVE      PTMI3BDY,FORM4
          COMPARE   FORM4,ZERO
          GOTO      INVD7820 IF NOT LESS
.
          BRANCH    F1,INVD7810
          WRITE     HTMLFILE;"3B Certificate Days Hospitalisation";
          GOTO      INVD9999
.
INVD7810  WRITE     HTMLFILE;PTMI3BDY;
          GOTO      INVD9999
.
INVD7820  WRITE     HTMLFILE;"&nbsp;";
          GOTO      INVD9999
.
INVD7900  CALL      DSTN0000          * Get Stationery code for the claim code
          GOTO      INVD9999
.
INVD8000  CALL      CPEX0000          * Check if Extra Comp.record already exist
          GOTO      INVD9999
.
INVD8100  MOVE      "BP",CATEGORY     * Selection List of Preferred Accom.
          MOVE      PMVXPACC,CODE
          CALL      CODITM00
          GOTO      INVD9999
.
INVD8200  PACK      PMVXCONM,PMVXCONM,SP70
          WRITE     HTMLFILE;PMVXCONM; * Contributor Name
          GOTO      INVD9999
.
INVD8300  CALL      LINS0000           * List of insurance for a claim code
          GOTO      INVD9999
.
INVD8400  CALL      LIN10000           * List of Insurance Companies for Other
          GOTO      INVD9999           * Compensable Details Screen
.
INVD8500  UNPACK    CMSTRTDT INTO CCENT,CYEAR,CMON,CDAY
          PACK      NPSTRTDT,NPSTRTDT,SP70  * Start of No pay day
          MATCH     SP70,NPSTRTDT
          IF        !@EQUAL
             UNPACK    NPSTRTDT INTO CCENT,CYEAR,CMON,CDAY
          ENDIF
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD8600  CALL      DRECV000                * NZ Time in  Recovery
          GOTO      INVD9999
.
INVD8700  MATCH     SP70,TADMTYP
          GOTO      INVD9999 IF EQUAL
          PACK      KEY5,ANSA,SP1,TADMTYP
          CALL      RDCODE1
          BRANCH    OVRCD,INVD9999
          WRITE     HTMLFILE;TCINDC12;
          GOTO      INVD9999
.
INVD8800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      SP70,KEY9
          MOVE      PTMIPCMX,KEY9
          IF        F1=1
            PACK      KEY9,CMCODE,SP70
          ENDIF
          MATCH     SP70,KEY9
          GOTO      INVD9999 IF EQUAL
.
          PACK      KEY18,ACLAIM,AFUNDH,KEY9,SP70
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,INVD9999
          MATCH     SP3,PTCMTRPT
          GOTO      INVD9999 IF EQUAL
          MOVE      "TP:",KEY3
          PACK      KEY6,KEY3,PTCMTRPT,SP70
          WRITE     HTMLFILE;KEY6;
          GOTO      INVD9999
.
INVD8900  WRITE     HTMLFILE;CKHOSPID;      * Check Hosp id
          GOTO      INVD9999
.
INVD9000  CALL      LPYR0000                * Payer breakdown
          GOTO      INVD9999
.
INVD9100  CALL      FBRK0000                * payer breakdown fields
          GOTO      INVD9999
.
INVD9200  COMPARE   ZERO,CFEETYP
          GOTO      INVD9999 IF NOT EQUAL   * Not using bed fees
.
          CALL      PYBR0000                * Details of Payer breakdown
          GOTO      INVD9999
.
INVD9300  WRITE     HTMLFILE;SHOWPAYR;      * Show payer breakdown
          GOTO      INVD9999
.
INVD9400  MATCH     SP70,INVTODAT
          IF        @EQUAL
            PACK      INVTODAT,CCC,CYY,CMM,CDD
            REP       " 0",INVTODAT
          ENDIF
.
          UNPACK    INVTODAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      INVD9999
.
INVD9500  MOVE      ZERO,F1
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECD1
INVD9505  CALL      RKPTECD1
          BRANCH    OVRCD,INVD9510
.
          MATCH     ADMISSNO,DPTEDADM
          IF        @EQUAL
            COMPARE   ZERO,PTEDEPNO                * Skip coding locked record
            GOTO      INVD9505 IF EQUAL
.
            GOTO      INVD9570
          ENDIF
.
INVD9510  CALL      RSPTECO1
          CALL      RKPTECO1
          BRANCH    OVRCD,INVD9999
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      INVD9999 IF NOT EQUAL
.
INVD9570  MOVE      ONE,F1              * record exists
.
INVD9580  WRITE     HTMLFILE;F1;
          GOTO      INVD9999
.
INVD9600  PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
          CALL      RDKMMBS1
          BRANCH    OVRCD,INVD9999
.
          MATCH     ADMISSNO,DMMADMN
          GOTO      INVD9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;          * record exist
          GOTO      INVD9999
.
INVD9700  CALL      CNTTY000               * Check Contract Type/Role
          IF        EXIT=1
            WRITE     HTMLFILE;"&nbsp;";
          ELSE
            WRITE     HTMLFILE;"Contract Type/Role";
          ENDIF
          GOTO      INVD9999
.
INVD9800  PACK      KEY30,SP70
          MOVE      "&nbsp;",KEY30
          CALL      CNTTY000               * Check Contract Type/Role
          BRANCH    EXIT,INVD9890
.
          MOVE      "Contract/Role Details Missing.",KEY30
          PACK      KEY25,ADMISSNO,Z70
          CALL      RSPTASF1
          CALL      RPPTASF1
          BRANCH    OVRCD,INVD9890
.
          MATCH     ADMISSNO,DPTAFADM
          GOTO      INVD9890 IF NOT EQUAL
.
          MATCH     SP70,PTAFCTYP
          IF        @EQUAL
            MATCH     SP70,PTAFCROL
            GOTO      INVD9890 IF EQUAL
          ENDIF
          PACK      KEY30,PTAFCTYP,SLASH,PTAFCROL,SP70
.
INVD9890  WRITE     HTMLFILE;KEY30;
          GOTO      INVD9999
.
INVD9900  MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ONE,DBSFLAG
          MOVE      ZERO,TDBSAMNT
          MOVE      ZERO,CPAYPRIV           * Co-payment for private
          MOVE      ZERO,CPAYSHRD           * Co-payment for shared
          MOVE      ZERO,CPAYCCUH           * Co-payment for CCU/ICU/SCN/HDU
          MOVE      ONE,PROGFLAG
          CALL      CALCTBI                 * Work out invoice date range
.
          CALL      DELG0000
          IF        TDBSAMNT=0
            WRITE     HTMLFILE;"$ ",TDBSAMNT;
          ELSE
            WRITE     HTMLFILE;"<font color=red>$ ",TDBSAMNT,"</font>";
          ENDIF
          GOTO      INVD9999
.
INVD9999  RETURN
+
.------------------------------------------------------------
.         Check if Contract Type/Role applicable
.------------------------------------------------------------
CNTTY000  MOVE      ONE,EXIT
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CNTTY999
.
          COMPARE   THREE,PVITYPE
          GOTO      CNTTY999 IF NOT EQUAL       * Not an inpatient
.
.                            <NZ>     <NSW>    <VIC>    <QLD>    <SA>
          BRANCH    PTCNHDPS,CNTTY999,CNTTY200,CNTTY400,CNTTY100,CNTTY999:
                             CNTTY600,CNTTY500,CNTTY999,CNTTY300
.                            <WA>     <TAS>    <NT>     <ACT>
          GOTO      CNTTY999
.
.         QLD
.
CNTTY100  MATCH     "S ",PTCNQCCT
          IF        @EQUAL
            MOVE      "S ",KEY2
            PACK      KEY5,KEY2,ASRCE
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC8
              GOTO      CNTTY900 IF EQUAL
            ENDIF
          ELSE
            MATCH     "CL",PTCNQCCT
            IF        @EQUAL
              MOVE      "S ",KEY2
              PACK      KEY5,KEY2,ASRCE
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "P",TCINDC9
                GOTO      CNTTY900 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
          GOTO      CNTTY999
.
.         NSW
.
CNTTY200  MOVE      "S ",KEY2
          PACK      KEY5,KEY2,ASRCE
          CALL      RDCODE1
          BRANCH    OVRCD,CNTTY999
.
          CMATCH    "1",THCSCOD              * Position one of HDP Equivalent
          GOTO      CNTTY900 IF EQUAL
          GOTO      CNTTY999
.
.         ACT
.
CNTTY300  MOVE      "S ",KEY2
          PACK      KEY5,KEY2,ASRCE
          CALL      RDCODE1
          BRANCH    OVRCD,CNTTY999
.
          MATCH     "1",TCINDC6
          GOTO      CNTTY900 IF EQUAL
          MATCH     "2",TCINDC6
          GOTO      CNTTY900 IF EQUAL
          GOTO      CNTTY999
.
.         VIC
.
CNTTY400  MOVE      "A ",KEY2
          PACK      KEY5,KEY2,ATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CNTTY999
.
          MATCH     "C",THCSCOD
          GOTO      CNTTY900 IF EQUAL        * Contracted
          MATCH     "S",THCSCOD
          GOTO      CNTTY900 IF EQUAL        * Hub/Spoke
          GOTO      CNTTY999
.
.         TAS
.
CNTTY500  MOVE      "S ",KEY2
          PACK      KEY5,KEY2,ASRCE
          CALL      RDCODE1
          BRANCH    OVRCD,CNTTY999
.
          MATCH     "1",TCINDC6
          GOTO      CNTTY900 IF EQUAL        * Contracted from Public
          MATCH     "2",TCINDC6
          GOTO      CNTTY900 IF EQUAL        * Contracted from Private
          GOTO      CNTTY999
.
.         WA
.
CNTTY600  MOVE      "A ",KEY2
          PACK      KEY5,KEY2,ATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CNTTY999
.
          MATCH     "0",THCSCOD
          GOTO      CNTTY900 IF EQUAL        * Contracting Status
          MATCH     "5",THCSCOD
          GOTO      CNTTY900 IF EQUAL        * Contracting Service
          GOTO      CNTTY999
.
CNTTY900  MOVE      ZERO,EXIT
CNTTY999  RETURN
+
.------------------------------------------------------------
.         Payer breakdown fields
.------------------------------------------------------------
FBRK0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FBRK1000,FBRK2000,FBRK3000,FBRK4000,FBRK5000:
                       FBRK6000
          GOTO      FBRK9999
.
FBRK1000  MOVE      "CL",CATEGORY                * claim code
          MOVE      PMPYCLTY,CODE
          CALL      CODITM00
          GOTO      FBRK9999
.
FBRK2000  MATCH     SP70,PMPYEFDT                * Effective date
          GOTO      FBRK9999 IF EQUAL
.
          UNPACK    PMPYEFDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FBRK9999
.
FBRK3000  MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          WRITE     HTMLFILE;PACFNAME;
          GOTO      FBRK9999
.
FBRK4000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,FBRK9999
.
          PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,SP70
          CALL      RSPMPBR1
          CALL      RKPMPBR1
          IF        OVRCD=0
            PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
            MATCH     KEY19,KEY22
            IF        @EQUAL
              WRITE     HTMLFILE;PMPBREGM;
            ENDIF
          ENDIF
          GOTO      FBRK9999
.
FBRK5000  MOVE      "No ",KEY3
          MATCH     "1",PMPYDEFT
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
          WRITE     HTMLFILE;KEY3;
          GOTO      FBRK9999
.
FBRK6000  WRITE     HTMLFILE;PMPBCNTR;
          GOTO      FBRK9999
.
FBRK9999  RETURN
+
.------------------------------------------------------------
.         Details of Payer breakdown
.------------------------------------------------------------
PYBR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA3,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          MOVE      ZERO,FORM3A
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,FORM122
          MOVE      ZERO,TOTALMAX
          MOVE      ZERO,TOTALCHR
          MOVE      ZERO,DEFPAYCL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PYBR9999
.
          MOVE      PMPYR003,KEY3
          CALL      DEBR0000              * Remove existing this invoice billing
.
          MOVE      ALACDTE,FROMDATE
          PACK      CHNGDATE,CHNGDATE,SP70
          MATCH     SP70,CHNGDATE
          IF        @EQUAL
            PACK      TODATE,CCC,CYY,CMM,CDD  * Default to current date
            IF        ASTAT=3
              MOVE      DDATE,TODATE
            ENDIF
          ELSE
            MOVE      CHNGDATE,TODATE
          ENDIF
          REP       " 0",TODATE
          MOVE      TODATE,BACKDATE
.
          MOVE      ZERO,NBRDAYS
          DAYSEP    FROMDATE,TODATE,NBRDAYS * LOS include leaves
.
          CALL      DSHD0000              * Display header line
.
.        Check if records exist for the selected payer
.
          MOVE      SP70,DEFINDIC
          PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,SP70
          CALL      RSPMPBR1
PYBR1000  CALL      RKPMPBR1
          BRANCH    OVRCD,PYBR4000
.
.         Display exisiting breakdown
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      PYBR4000 IF NOT EQUAL
.
          ADD       ONE,FORM3A
          MOVE      PMPBMAXB,MXBIL[FORM3A]
          MOVE      PMPBMAXD,MXDAY[FORM3A]
          MOVE      PMPBITEM,ITMCD[FORM3A]
          MOVE      PMPBREGM,RGMCD[FORM3A]
          MOVE      PMPBDEFT,DEFINDIC       * Save default
          GOTO      PYBR1000
.
PYBR4000  COMPARE   ZERO,FORM3A
          GOTO      PYBR9999 IF EQUAL
.
          MOVE      FORM3A,MAXCNTR
          MOVE      ZERO,FORM3A
.
.         Workout the Amount for This current invoice
.
          MOVE      ZERO,OPAYFLAG
          CALL      FACM0000         * Accom.start date for this payer
          WHILE     FORM3A<MAXCNTR
            MOVE      SP70,PMREDESC
            IF        FORM3A=0
              MOVE      "  0",PMPBICNT         * Item counter zero for Accomm.
              PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,PMPBICNT,SP70
              CALL      RDPMPBR1
              IF        OVRCD=0
                IF        MXBIL[1]<>0
                  MOVE      ONE,ISBLFLAG
                  MOVE      SEVEN,PROGFLAG   * work out accommodation charge
                  CALL      ISAC0000         * Get accom.for a payer -TOTACCM
                ENDIF
              ENDIF
              MOVE      "Accommodation",PMREDESC
              ADD       ONE,FORM3A
            ELSE
              ADD       ONE,FORM3A
              CALL      OTPY0000     * Check if there is a payer for this item
              CALL      ITMD0000                * Get Item Description
            ENDIF
.
            MOVE      FORM3A,KEY3
            REP       " 0",KEY3
            MOVE      PMPYR003,PMPBCLTY
            MOVE      ITMCD[FORM3A],PMPBITEM
            MOVE      MXBIL[FORM3A],PMPBMAXB
            MOVE      MXDAY[FORM3A],PMPBMAXD
            ADD       PMPBMAXB,TOTALMAX
            ADD       PMPBMAXD,TOTALCHR
            MOVE      DEFINDIC,PMPBDEFT       * default payer flag
.
            CALL      PROW0000                * display row of breakdown
          DO
.
          CALL      BTOT0000                  * display totals
.
          GOTO      PYBR9999
.
PYBR9999  RETURN
+
.------------------------------------------------------------
.         Get Item description
.------------------------------------------------------------
ITMD0000  MOVE      "1",PMREITYP
          PACK      PMREITMN,ITMCD[FORM3A],SP70
          PACK      KEY24,RGMCD[FORM3A],PMREITMN,PMREITYP,SP70
          CALL      RSPMREG4
          CALL      RKPMREG4
          BRANCH    OVRCD,ITMD4000
.
          PACK      KEY21,PMREREGM,PMREITMN,PMREITYP,SP70
          MATCH     KEY21,KEY24
          GOTO      ITMD9999 IF EQUAL
.
.         Item might have been removed from Regime file, try Misc.item file
.
ITMD4000  IF            IBCNMHOS=1
            OPEN          PMSVX1A1,"pmsvx1af"
            OPEN          PATHSPA1,"pathspaf"
.
            MOVE          SP10,PMVXMHOS
            MOVE          ADMISSNO,KEY8
            CALL          RDMISS1
            CALL          RDPMVX11
            MOVE          PMVXMHOS,KEY3
            CALL          RDPTHSP1
            IF            OVRCD=0
              MOVE          PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
.
.
          PACK      KEY29,ITMCD[FORM3A],ACLAIM,SP6,SP3,Z70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD6000
.
          PACK      KEY21,MCHARGE,MCLMCOD,SP70
          MATCH     KEY21,KEY29
          GOTO      ITMD8000 IF EQUAL
.
ITMD6000  PACK      KEY29,ITMCD[FORM3A],PTCNDCLM,SP6,SP3,Z70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD6200
.
          PACK      KEY21,MCHARGE,MCLMCOD,SP70
          MATCH     KEY21,KEY29
          GOTO      ITMD8000 IF EQUAL
.
ITMD6200  PACK      KEY21,ITMCD[FORM3A],SP70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD9999
.
          MATCH     ITMCD[FORM3A],MCHARGE
          GOTO      ITMD9999 IF NOT EQUAL
.
ITMD8000  MOVE      MDESC,PMREDESC
ITMD9999  RETURN
+
.------------------------------------------------------------
.         Display header Breakdown row
.------------------------------------------------------------
DSHD0000  WRITE     HTMLFILE;"<tr>":
                             "<td colspan=2>Maximum per Billing Period</td>":
                             "<td nowrap colspan=2>":
                             "Maximum per Day Amount (Partial Billing Periods)":
                             "</td>":
                             "<td align=center colspan=2>This Invoice (":
                             NBRDAYS ,")Days </td>":
                             "</tr>":
                             "<tr>":
                             "<td colspan=2>&nbsp;</td>":
                             "</tr>";
DSHD9999  RETURN

.------------------------------------------------------------
.         Display existing Breakdown row
.------------------------------------------------------------
PROW0000  
          COMPARE   ONE,OPAYFLAG
          GOTO      PROW2000 IF NOT EQUAL
.
.         If Other payer paying this item, this Item is not available for
.         this payer
.
          WRITE     HTMLFILE;"<input type=hidden name=itmcd",KEY3," value=#"":
                             PMPBITEM,"#">":
                             "<tr>":
                             "<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxbil",KEY3:
                             " class='Readonly Number' readonly":
                             " value='",PMPBMAXB,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Billing Period' ":
                             " id=mxbil",KEY3,">":
                             "</td>";
.
          WRITE     HTMLFILE;"<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxday",KEY3:
                             " class='Readonly Number' readonly":
                             " value='",PMPBMAXD,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Day Amount' ":
                             " id=mxday",KEY3:
              " onchange='TotalsDay(UpdateForm,mxbil",KEY3,",mxday",KEY3,",",KEY3,",itmcd",KEY3,",ivamt",KEY3,")'>":
                             "</td>";
.
          GOTO      PROW4000
.
PROW2000
          WRITE     HTMLFILE;"<input type=hidden name=itmcd",KEY3," value=#"":
                             PMPBITEM,"#">":
                             "<tr>":
                             "<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxbil",KEY3," class=Number":
                             " value='",PMPBMAXB,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Billing Period' ":
                             " id=mxbil",KEY3:
              " onchange='TotalsMax(UpdateForm,mxbil",KEY3,",mxday",KEY3,",",KEY3,",itmcd",KEY3,",ivamt",KEY3,")'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxday",KEY3," class=Number":
                             " value='",PMPBMAXD,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Day Amount' ":
                             " id=mxday",KEY3:
              " onchange='TotalsDay(UpdateForm,mxbil",KEY3,",mxday",KEY3,",",KEY3,",itmcd",KEY3,",ivamt",KEY3,")'>":
                             "</td>";
.
PROW4000 MOVE      ZERO,FORM12P2
          IF        FORM3A=1
            IF        MXBIL[FORM3A]<>0
              MOVE      TOTACCM,FORM12P2      * Payer Accommodation charges
              ADD       FORM12P2,FORM122
            ENDIF
          ELSE
            IF        MXBIL[FORM3A]<>0
              MOVE      ITMCD[FORM3A],KEY9
              MOVE      MXDAY[FORM3A],MAXIDAYB
              MOVE      MXBIL[FORM3A],MAXIBILL
              CALL      ITMI0000            * Calc.item amnt for this invoice
              IF        EXIT=0
                ADD       FORM12P2,FORM122
                MOVE      "3",SRECTYPE            * Item record
                MOVE      ZERO,PRTIFLAG
                CALL      WTID0000
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=ivamt",KEY3:
                             " class='Number Readonly'":
                             " tabindex=-1 size=10 ":
                             " value='",FORM12P2,"'":
                             " readonly>":
                             "</td></tr>";
          MOVE      ZERO,EXIT
          GOTO      PROW9999
.
PROW9999  RETURN
+
.------------------------------------------------------------
.         Check if there is another payer for this item
.------------------------------------------------------------
OTPY0000  MOVE      ZERO,OPAYFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA2,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,OTPY9999
.
          MOVE      SP70,KEY16
          PACK      KEY31,ADMISSNO,ITMCD[FORM3A],SP70
          CALL      RSPMPBR2
OTPY1000  CALL      RKPMPBR2
          BRANCH    OVRCD,OTPY9999
.
          PACK      KEY17,PMPBADMN,PMPBITEM,SP70
          MATCH     KEY17,KEY31
          GOTO      OTPY9999 IF NOT EQUAL
.
          MATCH     PMPBCLTY,PMPYR003
          GOTO      OTPY1000 IF EQUAL         * same payer
.
          COMPARE   ZERO,PMPBMAXB
          GOTO      OTPY1000 IF EQUAL         * no maximum billing
.
          MOVE      ONE,OPAYFLAG
.
OTPY9999  RETURN
+
.------------------------------------------------------------
.         Calculate item amount for this invoice
.------------------------------------------------------------
ITMI0000  MOVE      ONE,EXIT
          MOVE      ZERO,FORM12P2
          MOVE      "3",PMMIRTYP            * Misc.item record
          PACK      KEY18,ADMISSNO,PMMIRTYP,SP70
          CALL      RSPMMTI4
ITMI1000  CALL      RKPMMTI4
          BRANCH    OVRCD,ITMI9999
.
          MATCH     ADMISSNO,PMMIVISN       * Same visit number?
          GOTO      ITMI9999 IF NOT EQUAL
          MATCH     "3",PMMIRTYP
          GOTO      ITMI9999 IF NOT EQUAL
.
          MATCH     KEY9,PMMIITEM
          GOTO      ITMI1000 IF NOT EQUAL
          MATCH     "1",PMMIINCT
          GOTO      ITMI1000 IF NOT EQUAL   * Item not from Regime
.
          MOVE      PMMIAMTP,SAVAMNT
          ADD       PMMIRBAT,SAVAMNT        * Unit price
.
          MOVE      MAXIBILL,FORM12P2
          DIV       MAXIDAYB,FORM12P2
          MOVE      FORM12P2,FORM6          * no of items for max pay
          IF        FORM6<PMMISERV
            MOVE      FORM6,PMMISERV
          ENDIF
.
          MATCH     "1",PTCNISBZ         * Misc.item with quantity of zero?
          IF        !@EQUAL
            IF        PMMISERV=0
              MOVE       ONE,PMMISERV
            ENDIF
          ENDIF
.
          MOVE      SAVAMNT,LINETOT         * charge per day
          IF        SAVAMNT > MAXIDAYB
            MOVE      MAXIDAYB,LINETOT      * Max day charge
          ENDIF
          MULT      PMMISERV,LINETOT
          MOVE      LINETOT,FORM12P2
.
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      PMMIGSTA,PTDTGSTA
            MOVE      PMMIGSTC,PTDTGSTC
            CALL      IGST0000
            MOVE      LINETOT,LINEGST
            MULT      IBGEAMNT,LINEGST
            DIV       "100.00",LINEGST
          ENDIF
.
          IF        FORM12P2 > MAXIBILL
            MOVE      MAXIBILL,FORM12P2  * Max bill
          ENDIF
          MOVE      ZERO,EXIT
.
ITMI9999  RETURN
+
.------------------------------------------------------------
.         Display totals
.------------------------------------------------------------
BTOT0000  WRITE     HTMLFILE;"<tr><td>Total</td>":
                             "<td><Input type=text":
                             " class='Number Readonly'":
                             " name=totalmax":
                             " value='",TOTALMAX,"'":
                             " tabindex=-1 size=10 ":
                             " readonly></td>":
                             "<td>Total</td>":
                             "<td><Input type=text":
                             " class='Number Readonly'":
                             " name=totalpday":
                             " value='",TOTALCHR,"'":
                             " tabindex=-1 size=10 ":
                             " readonly></td>";
.
          WRITE     HTMLFILE;"<td>Total</td>":
                             "<td><input type=text":
                             " class='Number Readonly'":
                             " tabindex=-1 size=10 ":
                             " name=totalinva":
                             " value='",FORM122,"'":
                             " readonly>":
                             "</td></tr>";
.
BTOT9999  RETURN
+
.------------------------------------------------------------
.         List of Payer breakdown
.------------------------------------------------------------
LPYR0000
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA2,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999

          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,LPYR9999
          MOVE      ZERO,FORM12P2        * total inv amt of a payer
          MOVE      ZERO,FORM122         * total inv amt of all payers
.
.         Listing of admission payers only the accommodation record
.
          MOVE      ZERO,DEFDCOL
          MOVE      ZERO,ENDFLAG
          MOVE      "  0",PMPBICNT
          PACK      KEY26,ADMISSNO,PMPBICNT,SP70
          CALL      RSPMPBR4
LPYR1000  CALL      RKPMPBR4
          BRANCH    OVRCD,LPYR6000
.
          MATCH     ADMISSNO,PMPBADMN
          GOTO      LPYR6000 IF NOT EQUAL
.
          MATCH     "  0",PMPBICNT
          GOTO      LPYR6000 IF NOT EQUAL       * Not accommodation record
.
          PACK      KEY19,URNUMBER,PMPBCLTY,PMPBEFDT,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,LPYR1000
.
          PACK      PACFNAME,SP70,SP70
          MATCH     SP70,PMPYSNAM
          GOTO      LPYR2000 IF NOT EQUAL
          MATCH     SP70,PMPYGNAM
          GOTO      LPYR2000 IF NOT EQUAL
          MATCH     SP70,PMPYTITL
          GOTO      LPYR4000 IF EQUAL
.
LPYR2000  MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
LPYR4000  MOVE      SP70,TDESC
          MATCH     SP70,PMPYCLTY
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PMPYCLTY
            CALL      RDCODE1
          ENDIF
.
          MOVE      SP70,KEY12
          UNPACK    PMPYEFDT,CCENT,CYEAR,CMON,CDAY
          UNPACK    PMPYEFDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                               NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",PMPBDEFT
          IF        @EQUAL
            MOVE      SP70,PMPBCNTR
          ENDIF
          CALL      GTIN0000             * Get the current invoice amount
.
          MOVE      "No ",KEY3
          MATCH     "1",PMPYDEFT
          IF        @EQUAL
            MOVE      "Yes",KEY3
            MOVE      GROSSTOT,FORM12P2
            SUB       FORM122,FORM12P2
            MOVE      SP70,KEY20
            MOVE      ONE,DEFDCOL        * set flag for default payer
            MOVE      SP70,KEY15         * No Invoice todate
          ENDIF
          GOTO      LPYR8000
.
LPYR6000  BRANCH    DEFDCOL,LPYR9999     * found a default payer
.
.         Use patient as the default payer
.
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          MOVE      PADD1,PMPYADD1
          MOVE      PADD2,PMPYADD2
          MOVE      PSUBRB,PMPYADD3
          MOVE      PADD4,PMPYADD4
          MOVE      PPOST,PMPYPOST
          CLEAR     TDESC
          APPEND    ACLAIM,TDESC
          APPEND    " (SELF) ",TDESC
          APPEND    SP70,TDESC
          RESET     TDESC
          MOVE      SP70,PMPBCNTR
.
          MOVE      AURNO,PMPYURNO
          UNPACK    SP70,PMPYCLTY,KEY12
          MOVE      "1",PMPYDEFT
.
          MOVE      "Yes",KEY3
          MOVE      GROSSTOT,FORM12P2
          SUB       FORM122,FORM12P2
          MOVE      SP70,KEY20
          MOVE      SP70,KEY15         * No Invoice todate
          MOVE      ONE,ENDFLAG
.
.         If this is not a default payer, check if Payer order been allocated
.
LPYR8000  MOVE      PMPYDEFT,KEY1
          MATCH     "1",KEY1
          IF        !@EQUAL
            MATCH     SP70,PMPBCNTR
            IF        @EQUAL
              MOVE      "3",KEY1          * Order of Payer not allocated yet
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "UpdateLink('",HTMLLINK
          APPEND    PMPYURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPYCLTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY12,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    CHNGDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",PACFNAME,"#",":              *1
                                      "#"",PMPYADD1,PMPYADD2:
                                           PMPYADD3,PMPYADD4:
                                           PMPYPOST,"#",":              *2
                                      "#"",TDESC,"#",":                 *3
                                      "#"",FORM12P2,"#",":              *4
                                      "#"",KEY3,"#",":                  *5
                                      "#"",PMPBCNTR,"#",":              *6
                                      "#"",KEY15,"#");"                 *7
.
          BRANCH    ENDFLAG,LPYR9999
          GOTO      LPYR1000
.
LPYR9999 RETURN
+
.------------------------------------------------------------
.         Get amount of This invoice
.------------------------------------------------------------
GTIN0000  MOVE      ZERO,FORM12P2        * total inv amt of a payer
          MOVE      ZERO,FORM122         * total inv amt of all payers
          MOVE      SP70,KEY15
          MOVE      SP70,KEY20
          MOVE      SP70,SAVKEY18
          MOVE      SP70,KEY8            * blank invoice number
          PACK      KEY26,PMPBADMN,KEY8,SP70
          CALL      RSPMIDE2
GTIN1000  CALL      RKPMIDE2
          BRANCH    OVRCD,GTIN9999
.
          MATCH     PMIDADMN,PMPBADMN
          GOTO      GTIN9999 IF NOT EQUAL
.
          MATCH     SP70,PMIDINVN         * not invoiced
          GOTO      GTIN9999 IF NOT EQUAL
.
          MATCH     PMIDCLTY,PMPBCLTY
          IF        @EQUAL
            ADD       PMIDAMNT,FORM12P2
.
            UNPACK    PMIDITDT INTO CCENT,CYEAR,CMON,CDAY,KEY10
            MOVE      CMON,F2
            LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY15,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          ADD       PMIDAMNT,FORM122      * invoice for all payers
          GOTO      GTIN1000
.
GTIN9999  RETURN
+
.------------------------------------------------------------
.         List of Insurance for a claim code
.------------------------------------------------------------
LINS0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.         
          MOVE      SP70,ACLAIM
          MOVE      SP70,DIM6
          MOVE      URNUMBER,KEY8
          CALL      RDPMRES1           * read residency file
          IF        OVRCD=0
            MOVE      PMRSINCD,DIM6
          ENDIF
.
          MOVE      SP70,KEY3
.         BRANCH    F1,LINS1000        * PMI
.
          MATCH     SP70,ADMISSNO
          GOTO      LINS1000 IF EQUAL
.
          CALL      GCLM0000           * Get claim for a visit
          MOVE      ACLAIM,KEY3
.
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE      PMEXT002,KEY3
            MOVE      KEY3,COMPCLAM
          ENDIF
.
          PACK      KEY11,ADMISSNO,KEY3
          CALL      RDPMEXT1           * read extra compensable file
          IF        OVRCD=0
            MOVE      PMEXICOD,DIM6
          ENDIF
.
LINS1000  PACK      KEY6,SP70
          CALL      RDSINSR1
LINS2000  CALL      RDKINSR1
          BRANCH    OVRCD,LINS9999
.
          MATCH     SP70,ICODE
          GOTO      LINS2000 IF EQUAL
.
          COMPARE   THREE,F1
          GOTO      LINS3000 IF EQUAL
.
          MATCH     SP70,KEY3
          IF        !@EQUAL
            MATCH     KEY3,PTINCLAI              * check claim code
            GOTO      LINS2000 IF NOT EQUAL
          ENDIF
.
LINS3000  PACK      KEY8,QUOTE,ICODE,QUOTE
          MATCH     ICODE,DIM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               INAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",INAME,"</option>"
          ENDIF
          GOTO      LINS2000
.
LINS9999  RETURN
+
.------------------------------------------------------------
.         Check if Extra Comp.record already exist
.------------------------------------------------------------
CPEX0000  MOVE      ZERO,F1
          PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RDPMEXT1
          MOVE      OVRCD,F1
          WRITE     HTMLFILE;F1;       
CPEX9999  RETURN
+
.------------------------------------------------------------
.         Get Stationery code for the claim code
.------------------------------------------------------------
DSTN0000  MOVE      SP70,KEY3
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE       PMEXT002,KEY3
          ELSE
            MOVE       ACLAIM,KEY3
          ENDIF
.
          MATCH     SP70,KEY3
          GOTO      DSTN9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,DSTN9999
.
          UNPACK    SP70,IBTHSCOD,IBTHDESC
          MOVE      PTCDFELC,KEY6
          CALL      RDIBTH1
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,DSTN1000
          WRITE     HTMLFILE;IBTHSCOD;           * Stationery code
          GOTO      DSTN9999
.
DSTN1000  WRITE     HTMLFILE;IBTHDESC;           * Stationery description
.
DSTN9999  RETURN
+
.------------------------------------------------------------
.         Reason for Holding invoice
.------------------------------------------------------------
RHIN0000  MOVE      "&nbsp;",KEY6
          PACK      KEY30,KEY6,SP70
          MOVE      SP70,PTIPRDES
.
          MOVE      ADMISSNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,RHIN9999
.
          BRANCH    F1,RHIN2000            * get free format reason for hold
.
          MATCH     SP70,PTIPRHLD
          GOTO      RHIN1000 IF EQUAL      * No reason for holding code
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,RHIN1000
          PACK      KEY30,TDESC,SP70
          GOTO      RHIN9999
.
RHIN1000  COMPARE   TWO,F1
          GOTO      RHIN9999 IF NOT EQUAL
.
RHIN2000  MATCH     SP70,PTIPRDES
          GOTO      RHIN9999 IF EQUAL
          PACK      KEY30,PTIPRDES,SP70    * Free format reason for holding
          GOTO      RHIN9999
.
RHIN9999  RETURN
+
.------------------------------------------------------------
.         Clear Deposit flag for Patient Only Invoice
.------------------------------------------------------------
CDEP0000  MOVE      AADMNO,KEY8
          PACK      KEY25,KEY8,SP70
          CALL      RSRCDTE6
CDEP1000  CALL      RKRCDTE6
          BRANCH    OVRCD,CDEP9999
          MATCH     KEY8,RCDTVIST           * Same admission?
          GOTO      CDEP9999 IF NOT EQUAL
.
          MOVE      SP70,RCDTSFLAG
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE6
          GOTO      CDEP1000
.
CDEP9999  RETURN
+
.------------------------------------------------------------
.         Display Eligibility Check
.------------------------------------------------------------
DELG0000  BRANCH    PROGFLAG,DELG0200
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>";
.                            
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPPUT,"</td>":
                             "<td>&nbsp;</td></tr>";
.                            
DELG0200  MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      ZERO,CPAYPRIV
            MOVE      ZERO,CPAYSHRD
            MOVE      ZERO,CPAYCCUH           * Co-payment for CCU/ICU/SCN/HDU
          ELSE
            CALL      GBDY0000           * Check for invoiced accomm.bed days
          ENDIF
.
          MATCH     "1",PTCNGPHR
          GOTO      DELG1000 IF NOT EQUAL     * Not printing total of PHP & PHP
.
          BRANCH    PROGFLAG,DELG1000
          IF        PHXIAMNT<>0
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>PHX - Total</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",PHXIAMNT,"</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td></tr>";
          ENDIF
.
          IF        PHPIAMNT<>0
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>PHP - Total</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",PHPIAMNT,"</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td></tr>";
          ENDIF
.
DELG1000  MOVE      PTELPPUT,MAXCOPAY    * Max copayment $ amount
          MOVE      ZERO,SUMCOPAY        * Sum of copayment $ amount
.
          MOVE      CPAYPRIV,FORM12P2
          IF        PTELPPUT<>0
            IF        CPAYPRIV>PTELPPUT
              MOVE      PTELPPUT,FORM12P2
            ENDIF
          ENDIF
.
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    PROGFLAG,DELG1200
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - Private</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPPRI,"</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>";
DELG1200  ADD       FORM12P2,TDBSAMNT
.
          MOVE      CPAYSHRD,FORM12P2
          IF        PTELPSUT<>0
            IF        CPAYSHRD>PTELPSUT
              MOVE      PTELPSUT,FORM12P2
            ENDIF
          ENDIF
.
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    PROGFLAG,DELG1400
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - Shared</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPSHA,"</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>";
DELG1400  ADD       FORM12P2,TDBSAMNT
.
          MOVE      ZERO,FORM12P2
          MATCH     DDATE,ADATE
          IF        @EQUAL
            MOVE      PTELPSDY,FORM12P2
            IF        PTELPSDU<>0
              IF        PTELPSDY>PTELPSDU
                MOVE      PTELPSDU,FORM12P2
              ENDIF
            ENDIF
          ENDIF
.
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    PROGFLAG,DELG1600
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - Same day</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPSDY,"</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>";
DELG1600  ADD       FORM12P2,TDBSAMNT
.
          MOVE      CPAYCCUH,FORM12P2
          IF        PTELPCUT<>0
            IF        CPAYCCUH>PTELPCUT
              MOVE      PTELPCUT,FORM12P2
            ENDIF
          ENDIF
.
          BRANCH    PROGFLAG,DELG1700
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - CCU,ICU,SCN,HDU</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPCCU,"</td>":
.                            "<td align=right>",PTELPCUT,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>";
.
DELG1700  ADD       FORM12P2,TDBSAMNT
          MOVE      PTELPHSP,FORM12P2
.         MOVE      ASTAY,F3              * default to Expected LOS
          IF        DYCHRGED=0
            MOVE      ONE,F3              * treat LOS as 1
          ELSE
            MOVE      DYCHRGED,F3         * use the actual LOS
          ENDIF
          MULT      F3,FORM12P2
          IF        PTELPHSU<>0
            IF        FORM12P2>PTELPHSU
              MOVE      PTELPHSU,FORM12P2
            ENDIF
          ENDIF
.
          BRANCH    PROGFLAG,DELG1800
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - Hospital</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPHSP,"</td>":
.                            "<td align=right>",PTELPHSU,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>";
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Co-payment required - Theatre</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELPTHE,"</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",PTELPTHE,"</td></tr>";
.
DELG1800  ADD       FORM12P2,TDBSAMNT
          ADD       PTELPTHE,TDBSAMNT
.
          MATCH     "1",PTCNEMDB
          GOTO      DELG1830 IF NOT EQUAL
.
.         Display Sundry Misc.Items
.
          PACK      PTELMDES,PTELMDES,SP70
          MATCH     SP70,PTELMDES
          GOTO      DELG1830 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>",PTELMDES,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELMAMT,"</td>":
                             "<td align=right>":
                             "<input type=checkbox name=d_exclmisc value='1'":
                             " title='Exclude Misc.Amount from the Total.'":
                             " checked onclick=AddMisc();>":
                             "</td>":
                             "<td align=right>",PTELMAMT,"</td></tr>";
.
          MATCH     "1",EXCLMISC
          IF        !@EQUAL
            ADD       PTELMAMT,TDBSAMNT
          ENDIF
.
DELG1830  BRANCH    PROGFLAG,DELG1900
.
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            GOTO      DELG1840 IF EQUAL
          ENDIF
.
.         If patient is admitted today and Expected LOS is zero, display 
.         Excess for Sameday
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,ADATE
          IF        @EQUAL
            COMPARE   ZERO,ASTAY
            GOTO      DELG1840 IF EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Excess - Overnight</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELXCSS,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELXCSS,"</td></tr>";
          ADD       PTELXCSS,TDBSAMNT
          GOTO      DELG1900
.
DELG1840  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Excess - Same Day</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELXCSD,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",PTELXCSD,"</td></tr>";
          ADD       PTELXCSD,TDBSAMNT
.
DELG1900  BRANCH    PROGFLAG,DELG1920
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td><b>Out of Pocket Expenses Total</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",TDBSAMNT,"</b></td></tr>";
.
.         Check for any payments
.
DELG1920  PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
DELG2000  CALL      RKRCDTE6
          BRANCH    OVRCD,DELG9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      DELG9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      DELG2000 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,DELG2000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      DELG2000 IF EQUAL
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          IF        OVRCD=0
            MATCH     SP70,CMDERRFN
            GOTO      DELG2000 IF NOT EQUAL   * Refunded
          ENDIF
.
          MOVE      "Deposit ",TDESC
          MATCH     SP70,RCDTDPTY
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSP,RCDTDPTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Deposit Type",TDESC
              APPEND    RCDTDPTY,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
          CLEAR     KEY50
          APPEND    TDESC,KEY50
          APPEND    " RECEIPT ## ",KEY50
          APPEND    RCDTRECN,KEY50
          APPEND    SP70,KEY50
          RESET     KEY50
.
          MULT      "-1",RCDTAMNT
          BRANCH    PROGFLAG,DELG2200
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;",KEY50,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>";
DELG2200  ADD       RCDTAMNT,TDBSAMNT
.
.         ADD       NBNKAMNT,CSAMT
.         MULT      "-1",CSAMT
.         ADD       CSAMT,TDBSAMNT
.         MULT      "-1",CSAMT
.
          GOTO      DELG2000
DELG9999  RETURN
+
.------------------------------------------------------------
.         Display all Invoices details
.------------------------------------------------------------
DSIV0000  MOVE      "PATWEB76",PRGID
          MATCH     "1",IVDETAIL
          GOTO      DSIV2000 IF NOT EQUAL
.
          PACK      KEY32,URNUMBER,ADMISSNO,Z70
          CALL      RDSINV5  
DSIV1000  CALL      RDPINV5  
          BRANCH    OVRCD,DSIV2000
.
          MATCH     URNUMBER,PINVUR
          GOTO      DSIV2000 IF NOT EQUAL      * Different U/R number
          MATCH     ADMISSNO,DPINVADM
          GOTO      DSIV2000 IF NOT EQUAL      * Different Admission number
.
          COMPARE   THREE,PINVSYS
          GOTO      DSIV1000 IF NOT EQUAL      * Not inpatient invoice
.
          MATCH     "1",PTINCRST
          GOTO      DSIV1000 IF EQUAL          * Fully credit note
.
          MOVE      PINVAMT,FORM12P2
          SUB       PINVREB,FORM12P2           * patient portion
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            BRANCH    PINVTYP,DSIV1000         * Rebate invoice
          ENDIF
.
          COMPARE   ZERO,FORM12P2
          GOTO      DSIV1200 IF EQUAL
          GOTO      DSIV1200 IF LESS           * no patient portion
          GOTO      DSIV1800
.
DSIV1200  CALL      CPMN0000                * Check for deposit or pat.payment
          BRANCH    EXIT,DSIV1000
.
DSIV1800  IF        PRINTFLG=1
            COMPARE   MAXLINE,COUNT                   * Check For A Full Page
            CALL      TAIL IF NOT LESS
            PRINT     *N;
            ADD       ONE,COUNT
.
            UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
            COMPARE   MAXLINE,COUNT                   * Check For A Full Page
            CALL      TAIL IF NOT LESS
            IF        PTCNINVL=25
              PRINT     *1,"Invoice :",PINVNO,"  Invoice Date:",CPCDATE
            ELSE
              PRINT     *1,"Invoice No.:",PINVNO,"  Invoice Date:",CPCDATE
            ENDIF
            ADD       ONE,COUNT
          ENDIF
.
          MOVE      ONE,DBSFLAG                * Discharge billing
          CALL      CALCTAI                    * Display inpat invoice
          ADD       PAYMTTOT,TOTALFEE
          GOTO      DSIV1000
.
DSIV2000  BRANCH    PRINTFLG,DSIV4000
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td><b>Balance Payable</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",TDBSAMNT,"</b></td></tr>"
          GOTO      DSIV9000
.
.         Print balance payable
.
DSIV4000  MOVE      TDBSAMNT,GROSSTOT
          MOVE      GROSSTOT,INVCTOTL
          ADD       TOTALFEE,TDBSAMNT
          MOVE      TOTALFEE,PAYMTTOT
          MOVE      ZERO,CSAMT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,CREDTOT
.
.         Print balance payable for Cabrini layout
.
          IF        PTCNINVL=25
            COMPARE   MAXLINE,COUNT                   * Check For A Full Page
            CALL      TAIL IF NOT LESS
            PRINT     *19,"Balance Payable",*66,TDBSAMNT
            ADD       ONE,COUNT
          ENDIF
.
          MOVE      MAXLINE,FORM2
DSIV4200  COMPARE   FORM2,COUNT
          GOTO      DSIV5000 IF NOT LESS
.
          PRINT     *N;
          ADD       ONE,COUNT
          GOTO      DSIV4200
.
DSIV5000  MOVE      THREE,PINVSYS
          CALL      SINVT000                 * set up tail stationery code
          BRANCH    EXIT,DSIV9000
.
.         IF        PTCNINVL=25
.           PRINT     *N;                    * linefeed needed before template
.         ELSE
.           PRINT     *N,*N;                 * linefeed needed before template
.         ENDIF
          MOVE      SP70,PINVNO
          MOVE      SP70,PINVDTE
          MOVE      ZERO,MPGEFLAG            * indicate single/last page
          ADD       ONE,CPAGENO
          CALL      PRTINVTL                 * print templated invoice tail
.
          COMPARE   FORM3,IBTHLENG           * check if last line is same as
          GOTO      DSIV9000 IF EQUAL        * page length
          PRINT     *N;
.         
DSIV9000  MOVE      "PATWEB71",PRGID
DSIV9999  RETURN    
+
.------------------------------------------------------------
.         Print/Display Deposit or any Patient payments
.------------------------------------------------------------
CPMN0000  MOVE      ZERO,EXIT
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,FIVE,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,TWO,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
          CALL      RDSDTRAN
CPMN1000  CALL      RDKDTRAN
          BRANCH    OVRCD OF CPMN9000
.
          MATCH     PINVNO,TREF
          GOTO      CPMN9000 IF NOT EQUAL
.
.         Checking Cash and Journal
.
          IF        PINVSYS<>3
            COMPARE   FIVE,TRECTYPE
            GOTO      CPMN2000 IF EQUAL
            COMPARE   SIX,TRECTYPE
            GOTO      CPMN1000 IF NOT EQUAL
.
            PACK      KEY5,ANSJ,SP1,TTYPE
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC8
              GOTO      CPMN1000 IF NOT EQUAL
              GOTO      CPMN9999
            ENDIF
          ELSE
            COMPARE   FIVE,TRECTYPE
            GOTO      CPMN2000 IF EQUAL
            COMPARE   SIX,TRECTYPE
            GOTO      CPMN9000 IF NOT EQUAL
.
            PACK      KEY5,ANSJ,SP1,TTYPE
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "P",TCINDC8
              GOTO      CPMN1000 IF NOT EQUAL
              GOTO      CPMN9999
            ENDIF
          ENDIF
.
CPMN2000  MATCH     "P" TO TTYPEDEB
          GOTO      CPMN9999 IF EQUAL     * Payment from patient
          MATCH     SP70,TDEPTYP
          GOTO      CPMN9999 IF NOT EQUAL * deposit
.
          GOTO      CPMN1000
.
CPMN9000  MOVE      ONE,EXIT
          GOTO      CPMN9999
.
CPMN9999  RETURN
+
.------------------------------------------------------------
.         Check for any existing doctor charges
.------------------------------------------------------------
CDCH0000  MOVE      ZERO,FORM1
          MOVE      "4",PMMIRTYP            * Doctor charges record
          PACK      KEY18,ADMISSNO,PMMIRTYP,SP70
          CALL      RSPMMTI4
CDCH1000  CALL      RKPMMTI4
          BRANCH    OVRCD,CDCH9999
.
          MATCH     ADMISSNO,PMMIVISN       * Same visit number
          GOTO      CDCH9999 IF NOT EQUAL
.
          MATCH     "4",PMMIRTYP
          GOTO      CDCH9999 IF NOT EQUAL   * No doctor charge
          MOVE      ONE,FORM1               * discount option disable
CDCH9999  RETURN
+
.*******************************************************************************
. List NZ Procedure records
.*******************************************************************************
LPRC0000  PACK      KEY17,ADMISSNO,SP70
          CALL      RSNZSPR2
LPRC1000  CALL      RKNZSPR2
          BRANCH    OVRCD,LPRC9999
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      LPRC9999 IF NOT EQUAL
.
          PACK      KEY9,NZSPCPRC,SP70
          CALL      RDPTCMC1
          IF        OVRCD=1
            MOVE      SP70,PTCADES1
          ENDIF
.
          PACK      KEY9,NZSPPROC,SP70
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD
          IF        OVRCD=1
            PACK      IDESC,SP70
          ENDIF
.
          PACK      KEY14,NZSPCNTR,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            PACK      HFNAME,SP70
          ENDIF
.
          PACK      DOCFNAME,SP70
          PACK      KEY10,NZSPSURG,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      DNO,KEY3
          COMPARE   ONE,NZSPPRIM
          IF        @EQUAL
            MOVE      DYES,KEY3
          ENDIF
.
          PACK      TDESC,SP70
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LPRC4000
.
          MATCH     SP70,NZSPCPRC
          GOTO      LPRC4000 IF EQUAL
.
          MATCH     "0",NZSPINVD
          GOTO      LPRC2000 IF EQUAL
.         
          MATCH     "1",NZSPINVD
          GOTO      LPRC4000 IF NOT EQUAL  * At least one of the invoice raised
.         
LPRC2000  CLEAR     HTMLLINK
          WRITE     HTMLFILE;"<tr><td><a HREF = 'javascript:AdjustFee":
                             "(#"",NZSPADMN,"#",#"":
                             NZSPUNIQ,"#",#"":
                             NZSPCONT:
                             "#")'>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon></a>";
          GOTO      LPRC6000
.
LPRC4000  WRITE     HTMLFILE;"<tr><td><img src=../images/EditIcon0.gif":
                             " class=ListIcon></a>";
.
LPRC6000  IF        NZSPPRIM=1
            WRITE     HTMLFILE;"<font color=#FF0000><b>":
                               NZSPPROC,"</font></b></td>";
          ELSE
            WRITE     HTMLFILE;NZSPPROC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",IDESC,"</td>":
                             "<td>&nbsp;",TDESC,"</td>":
                             "<td>&nbsp;",DOCFNAME,"</td>":
                             "<td>&nbsp;",HFNAME,"</td>":
                             "<td>",KEY3,"</td>":
                             "<td>",NZSPCPRC," - ",PTCADES1,"</td></tr>"
.
          GOTO      LPRC1000
.
LPRC9999  RETURN
+
.------------------------------------------------------------
.         Get default next expected payer
.------------------------------------------------------------
GPAY0000  COMPARE   FIVE,CFEETYP
          GOTO      GPAY8000 IF EQUAL        * NZ Private - default exp payer
.
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSVSPAY2
GPAY1000  CALL      RKVSPAY2
          BRANCH    OVRCD,GPAY8000
          MATCH     ADMISSNO,VSPAVISN        * Same visit no?
          GOTO      GPAY8000 IF NOT EQUAL
.
          BRANCH    VSPAISEN,GPAY1000       * Already sent
          GOTO      GPAY9999
.
GPAY8000  MOVE      "PRFA",VSPAPAYC
GPAY9999  RETURN
+
.------------------------------------------------------------
. Check if print invoice option should be available
.------------------------------------------------------------
CZER0000  MOVE      ZERO,FORM1
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CZER8000
          CALL      RDPMVX11
          BRANCH    OVRCD,CZER8000
.
.         If the Contract is for 'Discharged from' and patient is not Discharged
.         then Raise/Print option disabled
.
          IF        CNTRCEFR=2 & ASTAT<>3
            PACK      KEY5,ANSC,ANSL,ACLAIM
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "D",TCINDC19
              GOTO      CZER8000 IF EQUAL        * Disable Print invoice option
              MATCH     "1",PTCNUABF             * check if using ABF
              IF        @EQUAL
                MATCH     "A",TCINDC2
                GOTO      CZER8000 IF EQUAL      * Disable Print invoice option
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
.
          COMPARE   ZERO,PTCNIPEN
          GOTO      CZER1000 IF NOT EQUAL        * Not using Invoice pending
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDIPEN1                      * Read invoice pending record
          BRANCH    OVRCD,CZER1000
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,CZER0800
.
          MATCH     "P",TCINDC2
          GOTO      CZER0800 IF EQUAL             * Patient hold invoice
.
          MATCH     "C",TCINDC4
          GOTO      CZER0800 IF EQUAL             * CodeFocus hold invoice
.
.         Check current status of hold invoice
.
          PACK      PENDSDAT,CCC,CYY,CMM,CDD
          REP       " 0",PENDSDAT
.
          MOVE      AFUNDH,PENDFUND               * IP
          MOVE      ACLAIM,PENDCLAM
          PACK      PENDHOSP,SP70
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,PENDHOSP           * Hospital Id
          ENDIF
          MOVE      " 3",PENDSYST
          CALL      IPRH0000
          CALL      UPIPEN1
.
CZER0800  MATCH     SP70,PTIPRHLD                * On hold
          GOTO      CZER8000 IF NOT EQUAL
.
CZER1000  IF        CFEETYP<>5
.           IF        IPATFLAG=1 & NCHACCOM=1
.
            BRANCH    IPATFLAG,CZER6000   * Pat Only Inv. no coding check
.
.           Patient must be discharged for Raising Patient Invoice with Accomm.
.
            IF        IPATFLAG=2
              IF        NCHACCOM=0
                COMPARE   THREE,ASTAT
                GOTO      CZER8000 IF NOT EQUAL         * not discharge
              ENDIF
              GOTO      CZER6000       * Pat Only Inv. no coding check
            ENDIF
          ENDIF
.
          CALL      CHCOD000           * check if coding complete required
          BRANCH    EXIT,CZER8000
.
          CALL      PROST000           * check if Prosthetic required
          BRANCH    EXIT,CZER8000
.
          CALL      CHCMB000           * check if CMBS completed required
          BRANCH    EXIT,CZER8000
.
          COMPARE   FIVE,CFEETYP
          IF        @EQUAL
            CALL      CITNZ000         * check item against NOT performed proc.
            CALL      CHKNZ000         * check nzprivate validations
            GOTO      CZER6000
          ENDIF
.
          MATCH     "1",PTCNUABF       * check if using ABF
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSL,ACLAIM
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "A",TCINDC2
              IF        @EQUAL
                COMPARE   THREE,ASTAT
                GOTO      CZER8000 IF NOT EQUAL    * not discharge
                MATCH     SP70,PTDSDDRG
                GOTO      CZER8000 IF EQUAL        * No DRG Code (not coded)
                GOTO      CZER6000
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          GOTO      CZER6000 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      CZER8000 IF NOT EQUAL         * not discharge
.
.         If Prov.Casemix code is not blank and Matrix is not found, disable
.         Raise invoice button
.
          MATCH     SP70,PTMIPCMX                 * Prov.Casemix code
          IF        !@EQUAL
            BRANCH    MATRXFLG,CZER8000           * from DINV0000 routine
          ENDIF
.
CZER6000 
.         MOVE      ONE,WEBFLAG
.         MOVE      ONE,PROGFLAG
.         CALL      CALCTBI                       * Work out invoice date range
.         COMPARE   ZERO,TOTDAYS
.         GOTO      CZER9999 IF NOT EQUAL
.
          IF        CFEETYP=5
            COMPARE   ZERO,GROSSTOT
            GOTO      CZER8000 IF LESS
          ENDIF
.
          COMPARE   ZERO,GROSSTOT
          GOTO      CZER9999 IF NOT EQUAL         * no outstanding amount
.
          COMPARE   ONE,PTCNPRIN                  * Print zero total invoice?
          GOTO      CZER8000 IF NOT EQUAL
.
.         Check if there is any transaction
.
          MOVE      ZERO,EXIT
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,CZER7000
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      CZER9999 IF EQUAL             * Found items to be invoiced
.
CZER7000  COMPARE   ZERO,AINVPRT
          GOTO      CZER9999 IF EQUAL        * Invoice not printed yet
.
          CALL      CHKACCM0                 * Check if accom.has been charged
          COMPARE   ONE,EXIT
          GOTO      CZER9999 IF NOT EQUAL    * No Accommodation record
.
          IF        ASTAT=3
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1
            BRANCH    OVRCD,CZER8000
            MATCH     ALACDTE,DDATE
            GOTO      CZER9999 IF NOT EQUAL       * should have accom.record
          ELSE
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            MATCH     ALACDTE,KEY8
            GOTO      CZER9999 IF NOT EQUAL
          ENDIF
.
CZER8000  MOVE      ONE,FORM1                     * Print option disabled
.
CZER9999  RETURN
+
.-------------------------------------------------------
. Check NZ Private item against NOT performed procedures
.-------------------------------------------------------
CITNZ000  MOVE      SP70,NZITFLAG
          PACK      KEY14,ADMISSNO,SP20
          CALL      RSPMMTI1
CITNZ100  CALL      RKPMMTI1
          BRANCH    OVRCD,CITNZ999
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      CITNZ999 IF NOT EQUAL       * different visit
.
          MATCH     "3",PMMIRTYP
          GOTO      CITNZ100 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,CITNZ100
.
          COMPARE   "2",NZSPPIND                * Not performed ?
          GOTO      CITNZ100 IF NOT EQUAL
.
          MOVE      ONE,NZITFLAG       
CITNZ999  RETURN
+
.------------------------------------------------------------
. Check NZ Requirements for allowing print invoice
.------------------------------------------------------------
CHKNZ000  MOVE      SP70,NZPEFLAG
          MOVE      SP70,PRESFLAG
          MOVE      SP70,PLANFLAG
          MOVE      SP70,ZEROFLAG
          MOVE      SP70,FOUNDPRM
.
          READ      CONTROLF,HUND18;*113,PTCNDBIN,*114,PTCNPPCD
.
          MATCH     "1",PTCNDBIN
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1
            IF        OVRCD=1
              MOVE      "1",NZPEFLAG
              GOTO      CHKNZ999
            ENDIF
          ENDIF
.
.
. **** first check if only cancelled bookings exist ***
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
CHKNZ100  CALL      RKOPDEA2
          BRANCH    OVRCD,CHKNZ110
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      CHKNZ110 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          IF        @EQUAL
            MOVE      TWO,NZPEFLAG
          ELSE
            MOVE      ZERO,NZPEFLAG
            GOTO      CHKNZ110
          ENDIF
          GOTO      CHKNZ100
.
CHKNZ110  MATCH     "2",NZPEFLAG
          GOTO      CHKNZ800 IF EQUAL
.
          MATCH     "1",PTCNPPCD
          GOTO      CHKNZ800 IF NOT EQUAL
.
. ****   check if nzpspraf records associated with theatre booking ****
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
CHKNZ210  CALL      RKNZSPR1
          BRANCH    OVRCD,CHKNZ800
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      CHKNZ800 IF NOT EQUAL
.
          MATCH     SP70,NZSPUNTH
          GOTO      CHKNZ210 IF EQUAL
.
. ****   has associated theatre bookings ****
.
CHKNZ300  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
CHKNZ310  CALL      RKNZSPR1
          BRANCH    OVRCD,CHKNZ400
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      CHKNZ400 IF NOT EQUAL
.
          MATCH     SP70,NZSPUNTH
          GOTO      CHKNZ310 IF EQUAL
.
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,CHKNZ310
.
          COMPARE   THREE,OPDASTAT
          GOTO      CHKNZ310 IF EQUAL
.
          IF        NZSPPIND=0
            MOVE      ONE,PLANFLAG
            GOTO      CHKNZ310
          ENDIF
.
          IF        NZSPTDUR=0 & NZSPPIND=1 & NZSPPRIM<>2
            MOVE      ONE,ZEROFLAG
            GOTO      CHKNZ310
          ENDIF
.
          COMPARE   "1",NZSPPRIM
          GOTO      CHKNZ310 IF NOT EQUAL
.
          COMPARE   "1",NZSPPIND
          GOTO      CHKNZ310 IF NOT EQUAL
.
          IF        NZSPTDUR=0
            GOTO      CHKNZ400
          ENDIF
          MOVE      "1",FOUNDPRM
.
          GOTO      CHKNZ310
.
CHKNZ400  MATCH     "1",FOUNDPRM
          IF        !@EQUAL
            MOVE      "3",NZPEFLAG
            GOTO      CHKNZ999
          ENDIF
.
          MATCH     "1",PLANFLAG
          IF        @EQUAL
            MOVE      "4",NZPEFLAG
            GOTO      CHKNZ999
          ENDIF
.
          MATCH     "1",ZEROFLAG
          IF        @EQUAL
            MOVE      "5",NZPEFLAG
            GOTO      CHKNZ999
          ENDIF
. ****   check if the person responsible is populated ***
.
CHKNZ800  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            MOVE      ONE,PRESFLAG
          ELSE
            MATCH     SP70,PKNAME
            IF        @EQUAL
              MOVE      ONE,PRESFLAG
            ENDIF
          ENDIF
.
CHKNZ999  RETURN
+
.------------------------------------------------------------
. Invoice From Date
.------------------------------------------------------------
FRMDAT00  MATCH     "1",PTCNPPIN
          GOTO      FRMDAT20 IF NOT EQUAL
.
.         Check if this is a 'to be invoiced' of a Rebate invoice
.
          PACK      KEY22,DPINVADM,SP70
          CALL      RSPTHTR1
          CALL      RKPTHTR1
          BRANCH    OVRCD,FRMDAT20
.
          MATCH     DPINVADM,PTHTADMN     * Same admission
          GOTO      FRMDAT20 IF NOT EQUAL
.
          MATCH     SP70,PTHTTREF
          GOTO      FRMDAT20 IF NOT EQUAL
.
          MOVE      PTHTFCEN,CCENT
          MOVE      PTHTFYER,CYEAR
          MOVE      PTHTFMON,CMON
          MOVE      PTHTFDAY,CDAY
          GOTO      FRMDAT80
.
FRMDAT20  UNPACK    ALACDTE INTO CCENT,CYEAR,CMON,CDAY
FRMDAT80  MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
FRMDAT99  RETURN
+
.------------------------------------------------------------
. Invoice To Date
.------------------------------------------------------------
TODATE00  COMPARE   "3",ASTAT
          GOTO      TODATE10 IF EQUAL
.
.   Patient admitted - use current date
.
          CALL      IBACLOCK
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDD,SP1,MTHNAM3,SP1,CCC,CYEAR;
          GOTO      TODATE99
.
.  Patient discharged - use discharged date
.
TODATE10  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY 
          CALL      IBACLOCK
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;

TODATE99  RETURN
.------------------------------------------------------------
. Display Invoice Details
.------------------------------------------------------------
DINV0000  MOVE      TWO,PROGFLAG            * display next invoice
          CALL      CLPATDSC
          PACK      KEY8,AADMNO
          CALL      RDDSCH1
          IF        OVRCD<>1
            MOVE      ZERO,ITEMFLAG         *Input items flag - no
            MATCH     ADATE,DDATE
          ENDIF 
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          PACK      KEY50 WITH ADIAG1,ADIAG2
.
          MOVE      ZERO,INVTYPE            * Standard invoice
          IF        CFEETYP=9
            MOVE      ONE,INVTYPE           * Default to summary
          ENDIF
.
          IF        JHFLAG=1 | CFEETYP=5
            MATCH     "031",TEMPLATE
            IF        @EQUAL
              MOVE      ONE,INVTYPE         * Johns Hopkins Summary invoice
            ELSE
              MOVE      TWO,INVTYPE         * Johns Hopkins Detailed invoice
            ENDIF
          ENDIF
.
          MOVE      ZERO,MSGFLAG
          MOVE      ONE,INVPRTD
          MOVE      ZERO,PAGENO
.
          CALL      INVPRT                  * Display the invoice
          MOVE      ZERO,EXIT
.
DINV9999  RETURN
+
.------------------------------------------------------------
.  Invoice Pending List
.------------------------------------------------------------
PEND0000  IF        NORECORD=0
            MOVE    "10",NORECORD           * Number of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ONE,WEBFLAG
          MOVE      ONE,PROGFLAG            * Flag to workout tobe invoiced amt
          MOVE      ZERO,GRNDTOT
          MOVE      ZERO,GRNDNET
          PACK      KEY8,SP70
          CALL      RDSIPEN1
          IF        OVRCD=0
            CALL      RDPIPEN1
          ENDIF 
.
PEND1000  CALL      RDKIPEN1
          BRANCH    OVRCD,PEND9000
.
          MOVE      IPADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF PEND1000
          MOVE      PVIBILL,AADMNO
.
          MOVE      PVIURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF PEND1000
          CALL      RDPMPX21
          BRANCH    OVRCD,PEND1000
.
          MOVE      SP10,DDATE
          MOVE      PVIURNO,URNUMBER
          MOVE      PVIBILL,ADMISSNO
          MOVE      SP10,PTMICMXP
          MOVE      SP10,SYSTEM
.
          MOVE      ZERO,FORM1
          MOVE      PTSTATUS,FORM1
.
          MOVE      ZERO,EXIT
          BRANCH    IPSYSTM OF PEND2000,PEND3000,PEND4000,PEND3000
          GOTO      PEND1000
.
PEND2000  COMPARE   ZERO,FORM1
          GOTO      PEND1000 IF NOT EQUAL  * not all system
          CALL      RREC0000             * emrgency record
          BRANCH    EXIT,PEND1000
          MOVE      "EMR",SYSTEM
          GOTO      PEND5000
.
PEND3000  COMPARE   ZERO,FORM1
          GOTO      PEND1000 IF NOT EQUAL  * not all system
          CALL      OREC0000             * outpatient record
          BRANCH    EXIT,PEND1000
          MOVE      "OUT",SYSTEM
          GOTO      PEND5000
.
PEND4000  CALL      IREC0000             * inpatient record
          BRANCH    EXIT,PEND1000
          MOVE      "INP",SYSTEM
.
PEND5000  CALL      PATNAA00             * setup patient name
.
.       If the invoice is for zero amount, and zero bed days, then ignore it
.
          MOVE      NETTOT,GROSSTOT
          COMPARE   ZERO,GROSSTOT
          GOTO      PEND6000 IF NOT EQUAL
          COMPARE   ZERO,TOTDAYS
          GOTO      PEND1000 IF EQUAL
.
.       Check if zero invoice to be included/excluded or print only zero inv.
.
          CMATCH    "1",ZEROINVC
          GOTO      PEND1000 IF EQUAL      * Exclude zero invoice
          GOTO      PEND8000
.
PEND6000  CMATCH    "2",ZEROINVC
          GOTO      PEND1000 IF EQUAL      * Only zero invoice
.
.       Process any pending cash
.
PEND8000  CALL      GETCASH
          SUB       CSAMT,NETTOT
.
          ADD       GROSSTOT,GRNDTOT
          ADD       NETTOT,GRNDNET
          ADD       ONE,RECNUMB
.
          IF        STARTNUM>=RECNUMB
            GOTO    PEND1000                * If < than strt Rec then Read Next
          ENDIF
.
          CALL      PRTD0000                * print invoice row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PEND1000 IF NOT EQUAL
          GOTO      PEND9999
.
PEND9000  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>Total :</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",GRNDTOT,"</td>":
                             "<td align=right>",GRNDNET,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>"
.
PEND9999  RETURN
+
.------------------------------------------------------------
.         Inpatient record
.------------------------------------------------------------
IREC0000  MOVE      ZERO,EXIT
          MOVE      IPADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF IREC9000
          BRANCH    ASTAT,IREC9000,IREC1000,IREC1000,IREC1000
          GOTO      IREC9000
.
IREC1000  CALL      VREC0000             * Validate record
          BRANCH    EXIT,IREC9000
.
          MOVE      ZERO,FORM1
          MOVE      PTSTATUS,FORM1       * 0 for All, 1 for Discharged 
.
.         ptstatus= 0 - Consolidated, 1- Discharge 
.
          COMPARE   THREE TO ASTAT
          GOTO      IREC2310 IF NOT EQUAL        * not discharge
.
          COMPARE   ZERO,FORM1
          GOTO      IREC9000 IF EQUAL            * don't print discharged pat.
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,IREC9000
.
          MATCH     FRSTDATE,DDATE
          GOTO      IREC9000 IF LESS
.
          MATCH     DDATE,LASTDATE
          GOTO      IREC9000 IF LESS
          GOTO      IREC2500
.
.         Current patients
.
IREC2310  BRANCH    FORM1,IREC9000          * don't display current patient  
.
.       Inpatient to be invoiced
.
IREC2500  MOVE      ZERO,DISPROG
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      ZERO,IBCNUGST         * set no GST for pending report
            CALL      CALCTBI
            READ      CONTROLF,ZERO;*85,IBCNUGST
          ELSE
            CALL      CALCTBI
          ENDIF
          GOTO      IREC9999
.
IREC9000  MOVE      ONE,EXIT
IREC9999  RETURN
+
.------------------------------------------------------------
.         Outpatient record
.------------------------------------------------------------
OREC0000  MOVE      ZERO,EXIT
          COMPARE   FOUR,IPSYSTM
          GOTO      OREC3200 IF NOT EQUAL
.
.         Other financial
.
          MOVE      "out",OSTFILE
          MOVE      PVIURNO,PURNO
          MOVE      SP10,OTBBFUND
          MOVE      SP3,OBACOMP
          MOVE      SP3,OBACLASS
          MOVE      SP10,OBADATE
          GOTO      OREC3400
.
.         Outpatient
.
OREC3200  MOVE      SP3,OSTSYST
          MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
.
.        Get the finanical booking details
.
          PACK      CFNAME WITH OSTFILE,FILBB1A2
          CLOSE     OUTBB1A2
          CALL      OPOTBB12
.
          CLOSE     OUTDTRO1
          PACK      CFNAME,OSTFILE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      KEY16,PVIDATE,PVIBILL
          CALL      RDBOKB2
          BRANCH    OVRCD,OREC9000
.
OREC3400  MOVE      PVISITE,OBASITE
          MOVE      OBADATE,ADATE
          MOVE      OBACOMP,ACLAIM
          MOVE      OBACLASS,ATYPE
          MOVE      OTBBFUND,AFUNDH
          MOVE      SP10,ACODDTE
          MOVE      SP10,PTMICMXP
          CALL      VREC0000             * Validate record
          BRANCH    EXIT,OREC9000
.
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      ZERO,IBCNUGST         * set no GST for pending report
            CALL      OUTTBI
            READ      CONTROLF,ZERO;*85,IBCNUGST
          ELSE
            CALL      OUTTBI
          ENDIF
          MOVE      ZERO,TOTDAYS
          GOTO      OREC9999
.
OREC9000  MOVE      ONE,EXIT
OREC9999  RETURN
+
.---------------------------------------------------
.        Emergency record
.---------------------------------------------------
RREC0000  MOVE      ZERO,EXIT
          COMPARE   NINE,PVITYPE
          GOTO      RREC2000 IF NOT EQUAL
.
          MOVE      PVIURNO,ADAURNO
          MOVE      PVIBILL,ADANUMB
          MATCH     " 1",PVISYST
          GOTO      RREC2000 IF NOT EQUAL        * Not Emergency event
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,RREC2000
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RREC2000
          MATCH     ANSE,TCINDC1
          GOTO      RREC2000 IF NOT EQUAL        * Emergency event
.
          MOVE      PMEVADTE,ADATE
          MOVE      PMEVCCOD,ACLAIM
          MOVE      PMEVADMT,ATYPE
          UNPACK    SP70,AFUNDH,AFNDTB,ACODDTE,PTMICMXP
          MOVE      PMEVDDTE,DDATE
          GOTO      RREC8000
.
RREC2000  MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD OF RREC9000
.
          UNPACK    ADADATE,ADATE
          MOVE      ADACOMP,ACLAIM
          MOVE      ADACLASS,ATYPE
          MOVE      AEDAFUND,AFUNDH
          MOVE      SP10,ACODDTE
          MOVE      SP10,PTMICMXP
.
RREC8000  CALL      VREC0000             * Validate record
          BRANCH    EXIT,RREC9000
.
          IF        IBCNUGST=2 | IBCNUGST=3
            MOVE      ZERO,IBCNUGST         * set no GST for pending report
            CALL      AAETBI
            READ      CONTROLF,ZERO;*85,IBCNUGST
          ELSE
            CALL      AAETBI
          ENDIF
          MOVE      ZERO,TOTDAYS
          GOTO      RREC9999
.
RREC9000  MOVE      ONE,EXIT
RREC9999  RETURN
+
.------------------------------------------------------------
.         Validate record
.------------------------------------------------------------
VREC0000  MOVE      ZERO,EXIT
          MATCH     SP70,CLAIMTYP
          GOTO      VREC1000 IF EQUAL      * all claim code
          MATCH     "All",CLAIMTYP
          GOTO      VREC1000 IF EQUAL      * all claim code
          MATCH     ACLAIM,CLAIMTYP
          GOTO      VREC9000 IF NOT EQUAL
.
VREC1000  MATCH     SP70,HEALTHFN
          GOTO      VREC2000 IF EQUAL      * all health fund
          MATCH     "All",HEALTHFN
          GOTO      VREC2000 IF EQUAL      * all health fund
          MATCH     AFUNDH,HEALTHFN
          GOTO      VREC9000 IF NOT EQUAL
.
VREC2000  MATCH     SP70,ADMNTYPE
          GOTO      VREC3000 IF EQUAL
          MATCH     "All",ADMNTYPE
          GOTO      VREC3000 IF EQUAL
          MATCH     ATYPE,ADMNTYPE
          GOTO      VREC9000 IF NOT EQUAL
.
VREC3000  MOVE      ZERO,FORM1
          MOVE      CODESTAT,FORM1
.
.         FORM1 = 0 for all, 1 for Coded patient only, 2 for Not coded
.
          BRANCH    FORM1,VREC3100,VREC3200
          GOTO      VREC4000                 * all
.
VREC3100  MATCH     SP10,ACODDTE
          GOTO      VREC9000 IF EQUAL        * not coded
          GOTO      VREC4000
.
VREC3200  MATCH     SP10,ACODDTE
          GOTO      VREC9000 IF NOT EQUAL    * coded
          GOTO      VREC4000
.
VREC4000  MOVE      ZERO,FORM1
          MOVE      CASEPAYM,FORM1            * casepayment
.
.         FORM1 = 0 for all, 1 for C/P patient only, 2 for Not Casepayment
.
          BRANCH    FORM1,VREC4100,VREC4200
          GOTO      VREC9999                 * all
.
VREC4100  MATCH     ANSY,PTMICMXP
          GOTO      VREC9999 IF EQUAL        * casepayment
          GOTO      VREC9000
.
VREC4200  MATCH     ANSY,PTMICMXP
          GOTO      VREC9999 IF NOT EQUAL    * not casepayment
.
VREC9000  MOVE      ONE,EXIT
VREC9999  RETURN
+
.------------------------------------------------------------
.  Print Invoice pending line
.------------------------------------------------------------
PRTD0000  MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLMDESC            * claim code
.
          MOVE      "A ",CATEGORY
          MOVE      ATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYDESC            * admission type
.
          MOVE      SP70,HFNDESC
          PACK      KEY14,AFUNDH,ZERO8,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,HFNDESC         * Health fund
          ENDIF
.
          MOVE      SP10,CODED
          MOVE      SP10,CASEPAY
          IF        IPSYSTM=3
            MOVE      "No ",CODED
            MATCH     SP10,ACODDTE
            IF        !@EQUAL
              MOVE      "Yes",CODED           * coding
            ENDIF
            MOVE      "No ",CASEPAY
            MATCH     "Y",PTMICMXP
            IF        @EQUAL
              MOVE      "Yes",CASEPAY         * Casepayment
            ENDIF
          ENDIF
.
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      IPADMNO,ADMISSNO
          MOVE      URNUMBER,PURNO
.
          MOVE      "01",KEY2
          MOVE      "001",KEY3
          IF        IPSYSTM=1
            MOVE      "emrweb04",KEY8
          ELSE
            IF        IPSYSTM=2
              MOVE      "outweb07",KEY8
            ELSE
              MOVE      "patweb71",KEY8
            ENDIF
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"<tr><td><a HREF ='javascript:InvoiceLink":
                             "(#"",KEY8:
                             ".pbl?reportno=",KEY2:
                             "&template=",KEY3:
                             "&admissno=",ADMISSNO:
                             "&urnumber=",URNUMBER:
                             "#");'><img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          WRITE     HTMLFILE;ADMISSNO,"</td>":
                             "<td>",SYSTEM,"</td>":
                             "<td>",URNUMBER,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MATCH     SP6,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",CLMDESC,"</td>":
                             "<td>&nbsp;",HFNDESC,"</td>":
                             "<td>&nbsp;",ATYDESC,"</td>":
                             "<td align=right>",TOTDAYS,"</td>":
                             "<td align=right>",GROSSTOT,"</td>":
                             "<td align=right>",NETTOT,"</td>":
                             "<td>&nbsp;",CODED,"</td>":
                             "<td>&nbsp;",CASEPAY,"</td></tr>"
.
.
PRTD9999  RETURN
+
.*****************************************************************************
.*            Link to Next Group of Numbers                                  *
.*****************************************************************************
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",CLAIMTYP
          REP       " +",HEALTHFN
          REP       " +",ADMNTYPE
          REP       " +",CODESTAT
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          WRITE     HTMLFILE;"patweb71.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&claimtyp=",CLAIMTYP:
                                 "&healthfn=",HEALTHFN:
                                 "&admntype=",ADMNTYPE:
                                 "&codestat=",CODESTAT:
                                 "&casepaym=",CASEPAYM:
                                 "&ptstatus=",PTSTATUS:
                                 "&zeroinvc=",ZEROINVC:
                             "&frstdate=",FRSTDATE:
                             "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE;
.
          REP       "+ ",CLAIMTYP
          REP       "+ ",HEALTHFN
          REP       "+ ",ADMNTYPE
          REP       "+ ",CODESTAT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NEXTPR99  RETURN
.
.*****************************************************************************
.*             Link to Previous Group of Numbers                             *
.*****************************************************************************
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
.
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",CLAIMTYP
          REP       " +",HEALTHFN
          REP       " +",ADMNTYPE
          REP       " +",CODESTAT
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          WRITE     HTMLFILE;"patweb71.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&claimtyp=",CLAIMTYP:
                                 "&healthfn=",HEALTHFN:
                                 "&admntype=",ADMNTYPE:
                                 "&codestat=",CODESTAT:
                                 "&casepaym=",CASEPAYM:
                                 "&ptstatus=",PTSTATUS:
                                 "&zeroinvc=",ZEROINVC:
                             "&frstdate=",FRSTDATE:
                             "&lastdate=",LASTDATE:
                                 "&viewtype=",VIEWTYPE;
.
          REP       "+ ",CLAIMTYP
          REP       "+ ",HEALTHFN
          REP       "+ ",ADMNTYPE
          REP       "+ ",CODESTAT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PREVPR99  RETURN
+
.******************************************************************************
.*                       Next Day, Week, Month                                *
.******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",CLAIMTYP
          REP       " +",HEALTHFN
          REP       " +",ADMNTYPE
          REP       " +",CODESTAT
          WRITE     HTMLFILE;"patweb71.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",NXTLDATE:
                             "&claimtyp=",CLAIMTYP:
                             "&healthfn=",HEALTHFN:
                             "&admntype=",ADMNTYPE:
                             "&codestat=",CODESTAT:
                             "&casepaym=",CASEPAYM:
                             "&ptstatus=",PTSTATUS:
                             "&zeroinvc=",ZEROINVC;
          REP       "+ ",CLAIMTYP
          REP       "+ ",HEALTHFN
          REP       "+ ",ADMNTYPE
          REP       "+ ",CODESTAT
.
NEXT9999  RETURN
.
.******************************************************************************
.*                      Previous Day, Week, Month                             *
.******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          REP       " 0",KEY2
          REP       " +",CLAIMTYP
          REP       " +",HEALTHFN
          REP       " +",ADMNTYPE
          REP       " +",CODESTAT
          WRITE     HTMLFILE;"patweb71.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",PRELDATE:
                             "&claimtyp=",CLAIMTYP:
                             "&healthfn=",HEALTHFN:
                             "&admntype=",ADMNTYPE:
                             "&codestat=",CODESTAT:
                             "&casepaym=",CASEPAYM:
                             "&ptstatus=",PTSTATUS:
                             "&zeroinvc=",ZEROINVC;
.
          REP       "+ ",CLAIMTYP
          REP       "+ ",HEALTHFN
          REP       "+ ",ADMNTYPE
          REP       "+ ",CODESTAT
PREV9999  RETURN
+
.------------------------------------------------------------
. Health Fund Table - 0=Code, 1=Desc, 2=Selection List
.------------------------------------------------------------
HFND0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,HFND0010,HFND0020
          WRITE     HTMLFILE;AFUNDH;
          GOTO      HFND9999
.
HFND0010  PACK      KEY14,AFUNDH,ZERO8,SP10
          CALL      RDFUND1
          BRANCH    OVRCD,HFND9999
          WRITE     HTMLFILE;HFNAME;
          GOTO      HFND9999
.
HFND0020  CALL      DHFND000
.
HFND9999  RETURN
.------------------------------------------------------------
.   Display Selection List for health fund
.------------------------------------------------------------
DHFND000  PACK      KEY14,SP70
          CALL      RDSFUND1
DHFND010  CALL      RDKFUND1
          BRANCH    OVRCD,DHFND999
.
          MATCH     "0000    ",HFTABL
          GOTO      DHFND010 IF NOT EQUAL     * skip table record
.
          MATCH     HCODE,HEALTHFN
          IF        @EQUAL
.           WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
.                              HCODE,": ",HFNAME,"</option>"
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
                               HFNAME,"</option>"
          ELSE
.           WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
.                              HCODE,": ",HFNAME,"</option>"
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
                               HFNAME,"</option>"
          ENDIF
          GOTO      DHFND010
.
DHFND999  RETURN
+
.------------------------------------------------------------
.  List of patient status
.------------------------------------------------------------
PSOP0000  MATCH     "1",PTSTATUS
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ONE,"#" selected> ":
                               "Discharged</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                               "Discharged</option>"
          ENDIF
PSOP9999  RETURN
+
.------------------------------------------------------------
.  Coding status
.------------------------------------------------------------
CDOP0000  MATCH     "1",CODESTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ONE,"#" selected> ":
                               "Yes</option>":
                               "<option value=#"",TWO,"#"> ":
                               "No</option>"
          ELSE
            MATCH     "2",CODESTAT
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Yes</option>":
                                 "<option value=#"",TWO,"#" selected> ":
                                 "No</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Yes</option>":
                                 "<option value=#"",TWO,"#"> ":
                                 "No</option>"
            ENDIF
          ENDIF
CDOP9999  RETURN
+
.------------------------------------------------------------
.  Casepayment
.------------------------------------------------------------
CPOP0000  MATCH     "1",CASEPAYM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ONE,"#" selected> ":
                               "Yes</option>":
                               "<option value=#"",TWO,"#"> ":
                               "No</option>"
          ELSE
            MATCH     "2",CASEPAYM
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Yes</option>":
                                 "<option value=#"",TWO,"#" selected> ":
                                 "No</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Yes</option>":
                                 "<option value=#"",TWO,"#"> ":
                                 "No</option>"
            ENDIF
          ENDIF
CPOP9999  RETURN
+
.------------------------------------------------------------
.  Zero invoice  0 - Include, 1 - Exclude, 2 - Only
.------------------------------------------------------------
IVOP0000  MATCH     "1",ZEROINVC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ONE,"#" selected> ":
                               "Exclude</option>":
                               "<option value=#"",TWO,"#"> ":
                               "Only</option>"
          ELSE
            MATCH     "2",ZEROINVC
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Exclude</option>":
                                 "<option value=#"",TWO,"#" selected> ":
                                 "Only</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=#"",ONE,"#"> ":
                                 "Exclude</option>":
                                 "<option value=#"",TWO,"#"> ":
                                 "Only</option>"
            ENDIF
          ENDIF
IVOP9999  RETURN
+
.------------------------------------------------------------
. Billing Comments
.------------------------------------------------------------
BCMN0000  BRANCH    FLDITMNO,BCMN1000,BCMN2000,BCMN3000,BCMN4000,BCMN5000:
                             BCMN6000
          GOTO      BCMN9999
.
BCMN1000  CALL      DCMN0000                * Display billing comments
          GOTO      BCMN9999
.
BCMN2000  CALL      MCMN0000                * Display past medical his comments
          GOTO      BCMN9999
.
BCMN3000  CALL      WCMN0000                * Display working diagnosis comments
          GOTO      BCMN9999
.
BCMN4000  CALL      CCMN0000                * Display Clinical Notes comments
          GOTO      BCMN9999
.
BCMN5000  CALL      CINC0000                * Check invoice comments
          GOTO      BCMN9999
.
BCMN6000  PACK      KEY17,ADMISSNO,ZERO,ZERO,THREE,SP70
          CALL      RSVSMDTA1
BCMN6001  CALL      RKVSMDTA1
          BRANCH    OVRCD,BCMN9999
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      BCMN9999 IF NOT EQUAL
.
          MATCH     "003",VSMDTYPE
          GOTO      BCMN9999 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      BCMN6001 IF EQUAL

          WRITE     HTMLFILE;"1";
          GOTO      BCMN9999
.
BCMN9999  RETURN
.
.------------------------------------------------------------
. Display Misc.item fields
.------------------------------------------------------------
MCHG0000  BRANCH    FLDITMNO,MCHG0100,MCHG0200,MCHG0300,MCHG0400,MCHG0500:
                             MCHG0600,MCHG0700,MCHG0800,MCHG0900,MCHG1000:
                             MCHG1100,MCHG1200,MCHG1300,MCHG1400,MCHG1500:
                             MCHG1600,MCHG1700,MCHG1800,MCHG1900,MCHG2000:
                             MCHG2100,MCHG2200,MCHG2300,MCHG2400,MCHG2500:
                             MCHG2600,MCHG2700,MCHG2800,MCHG2900,MCHG3000:
                             MCHG3100,MCHG3200,MCHG3300,MCHG3400,MCHG3500:
                             MCHG3600,MCHG3700,MCHG3800,MCHG3900,MCHG4000:
                             MCHG4100,MCHG4200,MCHG4300,MCHG4400,MCHG4500:
                             MCHG4600,MCHG4700,MCHG4800,MCHG4900,MCHG5000:
                             MCHG5100,MCHG5200,MCHG5300,MCHG5400,MCHG5500: 
                             MCHG5600,MCHG5700,MCHG5800,MCHG5900,MCHG6000:
                             MCHG6100,MCHG6200,MCHG6300,MCHG6400,MCHG6500:
                             MCHG6600,MCHG6700,MCHG6800,MCHG6900,MCHG7000
          GOTO      MCHG9999
.
MCHG0100  MATCH     PMMITDAT,SP70 
          GOTO      MCHG9999 IF EQUAL   
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      MCHG9999
.
MCHG0200  WRITE     HTMLFILE;PMMIITEM;
          GOTO      MCHG9999
.
MCHG0300  WRITE     HTMLFILE;PMMIDESC;
          GOTO      MCHG9999
.
MCHG0400  IF        PMMISERV < 1
            IF        CFEETYP=0
              MATCH     "1",PTCNISBZ         * Misc.item with quantity of zero?
              IF        @EQUAL
                MOVE      ZERO,PMMISERV
                MATCH     "1",PMMIINCT       * Ind.Billing - item from Regime
                GOTO      MCHG0420 IF EQUAL
              ENDIF
            ENDIF
            MOVE      ONE,PMMISERV
          ENDIF
MCHG0420  WRITE     HTMLFILE;PMMISERV;
          GOTO      MCHG9999
.
MCHG0500  WRITE     HTMLFILE;PMMIREFN;
          GOTO      MCHG9999
.
MCHG0600  WRITE     HTMLFILE;PMMIAMTP;           * patient portion
          GOTO      MCHG9999
.
MCHG0700  MATCH     "0",PMMIINCT                 * include in contract
          IF        @EQUAL
            MATCH     "Y",KEYINPRC               * keyin amt(item to be charged)
            IF        @EQUAL
              WRITE     HTMLFILE;PMMIRBAT;       * rebate portion
              GOTO      MCHG9999
            ENDIF
          ENDIF
.
          IF        PMMIRBAT=0 & PMMIAMTG<>0
            WRITE     HTMLFILE;PMMIAMTG;         * keyin amount
          ELSE
            WRITE     HTMLFILE;PMMIRBAT;         * rebate portion
          ENDIF
          GOTO      MCHG9999
.
MCHG0800  WRITE     HTMLFILE;CHNGDESC;
          GOTO      MCHG9999
.
MCHG0900  WRITE     HTMLFILE;CHNGAMNT;
          GOTO      MCHG9999
.
MCHG1000  MOVE      PMMIAMTP,FORM122             * Patient Misc.amount per unit
          IF        PMMISERV > 1
            MOVE      PMMIAMTP,FORM122 
            MULT      PMMISERV,FORM122 
          ENDIF
          WRITE     HTMLFILE;FORM122;
          GOTO      MCHG9999
.
MCHG1100  MOVE      PMMIRBAT,FORM122             * Funder Misc.amount per unit
.
          MATCH     "0",PMMIINCT
          IF        @EQUAL
            MATCH     "Y",KEYINPRC
            GOTO      MCHG1120 IF EQUAL
          ENDIF
.
          IF        PMMIRBAT=0 & PMMIAMTG<>0
            MOVE      PMMIAMTG,FORM122           * Keyin item amount
          ENDIF
.
MCHG1120  IF        PMMISERV > 1
            MULT      PMMISERV,FORM122 
          ENDIF
          WRITE     HTMLFILE;FORM122;
          GOTO      MCHG9999
.
MCHG1200  WRITE     HTMLFILE;PMMIRTYP;
          GOTO      MCHG9999
.
MCHG1300  MULT      "-1",PMMIAMTP
          WRITE     HTMLFILE;PMMIAMTP;           * Discount
          GOTO      MCHG9999
.
MCHG1400  CALL      DSDT0000                     * get default discount date
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MCHG9999
.
MCHG1500  WRITE     HTMLFILE;PTCNHITC;
          GOTO      MCHG9999
.
MCHG1600  MATCH     "1",PTCNHITC
          GOTO      MCHG1610 IF NOT EQUAL
.
          MOVE      "Rt",CATEGORY           * Reason Theatre Incomplete
          MOVE      PMVXTICM,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG1610  UNPACK    DIM127,D1,KEY1,DIM127
          WRITE     HTMLFILE;"&nbsp;";
          GOTO      MCHG9999
.
MCHG1700  MATCH     "00:00",MMSTIM
          IF        @EQUAL
            MOVE      SP5,MMSTIM
          ENDIF
          WRITE     HTMLFILE;MMSTIM;
          GOTO      MCHG9999
.
MCHG1800  MATCH     "00:00",MMETIM
          IF        @EQUAL
            MOVE      SP5,MMETIM
          ENDIF
          WRITE     HTMLFILE;MMETIM;
          GOTO      MCHG9999
.
MCHG1900  MATCH     "1",PTCNHITC
          GOTO      MCHG1910 IF NOT EQUAL
          WRITE     HTMLFILE;"Reason Theatre Incomplete";
          GOTO      MCHG9999
.
MCHG1910  WRITE     HTMLFILE;"&nbsp;";
          GOTO      MCHG9999
.
MCHG2000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     "1",PTCNHITC
          GOTO      MCHG2030 IF NOT EQUAL   * Not using theatre
.
          BRANCH    F1,MCHG2010
          MATCH     "1",PMVXATCP
          IF        !@EQUAL
            WRITE     HTMLFILE;"<font color=red>Theatre Complete";
          ELSE
            WRITE     HTMLFILE;"Theatre Complete";
          ENDIF
          GOTO      MCHG9999
.
MCHG2010  MATCH     "1",PMVXATCP
          GOTO      MCHG2020 IF EQUAL
.
          MOVE      ADMISSNO,IPADMNO
          CALL      CHKT0000                 * Check if there is theatre
          IF        EXIT=0
            WRITE     HTMLFILE;"No";
          ELSE
            WRITE     HTMLFILE;"N/A";
          ENDIF
.
          GOTO      MCHG9999
.
MCHG2020  WRITE     HTMLFILE;"Yes";      * Theatre complete
          GOTO      MCHG9999
.
MCHG2030  WRITE     HTMLFILE;"&nbsp;";
          GOTO      MCHG9999
.
MCHG2100  MOVE      SP70,PMCDCNUM
          PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
MCHG2120  CALL      RPPMCCD1
          BRANCH    OVRCD,MCHG9999
          MATCH     URNUMBER,PMCDURNO
          IF        @EQUAL
            MOVE      "ct",KEY2
            PACK      KEY5,KEY2,PMCDCTYP,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,MCHG2120
            MATCH     "3",TCINDC1
            GOTO      MCHG2120 IF NOT EQUAL     * Not for DVA
            WRITE     HTMLFILE;PMCDCNUM;
          ENDIF
          GOTO      MCHG9999
.
MCHG2200  MOVE      SP70,PMCDDVAC
          PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
MCHG2220  CALL      RPPMCCD1
          BRANCH    OVRCD,MCHG2210
          MATCH     URNUMBER,PMCDURNO
          GOTO      MCHG2210 IF NOT EQUAL
.
          MOVE      "ct",KEY2
          PACK      KEY5,KEY2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MCHG2220
          MATCH     "3",TCINDC1
          GOTO      MCHG2220 IF NOT EQUAL     * Not for DVA
.
          MOVE      "DX",CATEGORY
          MOVE      PMCDDVAC,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG2210  UNPACK    DIM127,D1,KEY1,DIM127
          WRITE     HTMLFILE;"&nbsp;";
          GOTO      MCHG9999
.
MCHG2300  MOVE      "Ve",CATEGORY
          MOVE      PMEXSERV,CODE
          CALL      DSRV0000                 * Selection for DF Service code
          GOTO      MCHG9999
.
MCHG2400  CALL      GETNZM00                   * Get NZ private Misc.Charge
          MOVE      ZERO,FORM12P2
          IF        EXIT=0
            MOVE      NZMCPATP,FORM12P2
            ADD       NZMCREBP,FORM12P2
          ENDIF
          WRITE     HTMLFILE;FORM12P2;
          GOTO      MCHG9999
.
MCHG2500  CALL      ITYP0000              * Selection of Item type
          GOTO      MCHG9999
.
MCHG2600  MATCH     SP70,NZSPPROC
          GOTO      MCHG9999 IF EQUAL
          WRITE     HTMLFILE;NZSPPROC;
          GOTO      MCHG9999
.
MCHG2700  WRITE     HTMLFILE;NZSPUNIQ;    * unique count
          GOTO      MCHG9999
.
MCHG2800  PACK      KEY65,PMMIDESC,PMMIDES2,SP70
          WRITE     HTMLFILE;KEY65;
          GOTO      MCHG9999
.
MCHG2900  WRITE     HTMLFILE;PMMIMVBR;    * Exploding/Pack item for NZ private
          GOTO      MCHG9999
.
MCHG3000  CALL      PACI0000              * Contents of Pack Item
          GOTO      MCHG9999
.
MCHG3100  WRITE     HTMLFILE;PMMIINCT;
          GOTO      MCHG9999
.
MCHG3200  MOVE      SP70,KEY6
          MOVE      ZERO,FORM32
          MOVE      PMMISCHF,FORM32
          IF        FORM32=9.50
            MOVE      "0.50",FORM32         * Standard - 50% of Schedule fee
          ELSE
            IF        FORM32=9.55
              MOVE      "0.50",FORM32       * HEC - 50% of AMA fee
            ELSE
              IF        FORM32=9.25
                MOVE      "0.25",FORM32     * HEC - 50% of AMA fee
              ENDIF
            ENDIF
          ENDIF
          MULT      "100",FORM32
          MOVE      FORM32,F3
          MOVE      "%",KEY1
          PACK      KEY4,F3,KEY1,SP70
          WRITE     HTMLFILE;KEY4;
          GOTO      MCHG9999
.
MCHG3300  WRITE     HTMLFILE;PMMIAMTT;
          GOTO      MCHG9999
.
MCHG3400  PACK      KEY10,PMMIEDAD,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,MCHG9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      MCHG9999
.
MCHG3500  MOVE      ZERO,PRITSFEE
          CALL      SCHF0000                   * Get scheduled fee
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MCHG3510,MCHG3520,MCHG3530
.
MCHG3505  WRITE     HTMLFILE;PRITSFEE;
          MOVE      ZERO,EXIT
          GOTO      MCHG9999
.
MCHG3510  WRITE     HTMLFILE;PRITSF75;
          GOTO      MCHG9999
.
MCHG3520  WRITE     HTMLFILE;PRITSF85;
          GOTO      MCHG9999
.
MCHG3530  WRITE     HTMLFILE;PRITSAFE;
          GOTO      MCHG9999
.
MCHG3600  MOVE      ZERO,F1
          MATCH     SP70,NZSPCPRC
          GOTO      MCHG3620 IF EQUAL        * no contract - Normal charge
          MATCH     "1",NZSPCONT
          GOTO      MCHG3640 IF NOT EQUAL    * no max contr.- Normal charge
.
MCHG3620  MOVE      ONE,F1
MCHG3640  WRITE     HTMLFILE;F1;
          GOTO      MCHG9999
.
MCHG3700  CALL      GETNZM00                 * Get NZ private Misc.Charge
          MOVE      SP70,KEYINPRC
          IF        NZMCCHGT<>1
            WRITE     HTMLFILE;NZMCKPRI;     * not an exploding item,keyin price
            MOVE      NZMCKPRI,KEYINPRC
          ENDIF
          GOTO      MCHG9999
.
MCHG3800  MATCH     "1",PMMIINCT
          IF        @EQUAL
            MOVE      PMMIAMTP,FORM122             * Bill to patient
            GOTO      MCHG3880
          ENDIF
          MOVE      PMMIAMTG,FORM122               * default to keyin amount
          MATCH     "2",PMMIINCT
          GOTO      MCHG3880 IF NOT EQUAL
.
          MOVE      PMMIRBAT,FORM122 
          IF        FORM122=0
            MOVE      PMMIAMTP,FORM122
          ENDIF
.
MCHG3880  WRITE     HTMLFILE;FORM122;
          GOTO      MCHG9999
.
MCHG3900  WRITE     HTMLFILE;PMMIINCT;             * Community billing item
          GOTO      MCHG9999
.
MCHG4000  WRITE     HTMLFILE;ISBLFLAG;
          GOTO      MCHG9999
.
MCHG4100  MATCH     "2",PMMIRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Banding: ",PMMISUNQ;           * Theatre Banding
          ENDIF
          GOTO      MCHG9999
.
MCHG4200  MOVE      "Rr",CATEGORY
          MOVE      PMMIRBRS,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG4300  WRITE     HTMLFILE;PATAMOUN;
          GOTO      MCHG9999
.
MCHG4400  WRITE     HTMLFILE;REBAMOUN;
          GOTO      MCHG9999
.
MCHG4500  WRITE     HTMLFILE;EXCLMISC;
          GOTO      MCHG9999
.
MCHG4600  WRITE     HTMLFILE;PTELMDES;
          GOTO      MCHG9999
.
MCHG4700  WRITE     HTMLFILE;PMMIACOI;
          GOTO      MCHG9999
.
MCHG4800  WRITE     HTMLFILE;PMMIDSOV;
          GOTO      MCHG9999
.
MCHG4900  WRITE     HTMLFILE;PMMISTXT;
          GOTO      MCHG9999
.
MCHG5000  WRITE     HTMLFILE;PMMILSPN;
          GOTO      MCHG9999
.
MCHG5100  WRITE     HTMLFILE;PMMIMPOV;
          GOTO      MCHG9999
.
MCHG5200  WRITE     HTMLFILE;PMMINMPT;
          GOTO      MCHG9999
.
MCHG5300  MOVE      "Sd",CATEGORY
          MOVE      PMMISDCD,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG5400  WRITE     HTMLFILE;PMMITDUR;
          GOTO      MCHG9999
.
MCHG5500  MOVE      "Ro",CATEGORY
          MOVE      PMMIROVR,CODE
          CALL      CODITM00
          GOTO      MCHG9999
.
MCHG5600  WRITE     HTMLFILE;PMVXUD15;       * UDF 15
          GOTO      MCHG9999
.
MCHG5700  PACK      MDATE000,MDATE000,SP70
          MATCH     SP70,MDATE000
          GOTO      MCHG5705 IF EQUAL
.
          REP       " 0",MDATE000
          UNPACK    MDATE000,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MCHG9999
.
MCHG5705  MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY    * default to current date
.
          IF        ASTAT=3
            MOVE      SP70,DDATE
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1
            MOVE      DDATE,DIM8                    * Set date to disc.date
          ENDIF
.
          REP       " 0",DIM8
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MCHG9999
.
MCHG5800  WRITE     HTMLFILE;PREBFLAG;       * Patient invoice raised flag
          GOTO      MCHG9999
.
MCHG5900  WRITE     HTMLFILE;INVIACTV;       * Patient invoice inactive flag
          GOTO      MCHG9999
.
MCHG6000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      HIDS0000                 * Hold invoice desc.
          GOTO      MCHG9999
.
MCHG6100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      IHOLD0000                * Display invoice hold details
          GOTO      MCHG9999
.
MCHG6200  WRITE     HTMLFILE;PVITYPE;
          GOTO      MCHG9999
.
MCHG6300  WRITE     HTMLFILE;ASTAT;
          GOTO      MCHG9999
.
MCHG6400  WRITE     HTMLFILE;PMEXT049;
          GOTO      MCHG9999
.
MCHG6500  PACK      KEY46,ADMISSNO,Z70
          CALL      RDPMCHA1
          CALL      RPPMCHA1
          BRANCH    OVRCD,MCHG9999
.
          MATCH     ADMISSNO,PMCHADMN
          GOTO      MCHG9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMCHREAS;
          GOTO      MCHG9999
.
MCHG6600  PROC      MVCONF00
          UNPACK    D2,MVITTYPE,MVITSTAT
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MCHG6610
.
          WRITE     HTMLFILE;MVITTYPE;             * .0 Visit Type
          GOTO      MCHG9999
.
MCHG6610  WRITE     HTMLFILE;MVITSTAT;             * .1 Visit Status
          GOTO      MCHG9999
.
MCHG6700  WRITE     HTMLFILE;NZITFLAG;  * Item with NOT performed procedure flag
          GOTO      MCHG9999
.
MCHG6800  MOVE      ZERO,LOSDAYS
          COMPARE   THREE,ASTAT
          IF        !@EQUAL
            MOVE      CURRDATE,DDATE
          ENDIF
.
          DAYSEP    ADATE,DDATE,LOSDAYS
          MOVE      LOSDAYS,KEY9
          SQUEEZE   KEY9
          MOVE      "Days",KEY4
          PACK      KEY10,KEY9,SP1,KEY4
          WRITE     HTMLFILE;KEY10;
          GOTO      MCHG9999
.
MCHG6900  MOVE      ADATE,FROMDATE
          MOVE      DDATE,TODATE
          CALL      RHIHDAYS                * Get HIH Days
.
          MOVE      ZERO,CALDAYS
          MOVE      HIHLOS,CALDAYS
          MOVE      CALDAYS,KEY9
          SQUEEZE   KEY9
          MOVE      "Days",KEY4
          PACK      KEY10,KEY9,SP1,KEY4
          WRITE     HTMLFILE;KEY10;
          GOTO      MCHG9999
.
MCHG7000  CALL      CHCKBT00                * Check if site has ind1=H Bed Type
          GOTO      MCHG9999
.
MCHG9999  RETURN
.
.------------------------------------------------------------
.         Display Hold invoice title
.------------------------------------------------------------
HIDS0000  PACK      KEY24,ADMISSNO,Z70
          CALL      RSPTONH1
          CALL      RPPTONH1
          BRANCH    OVRCD,HIDS6010
.
          MATCH     ADMISSNO,PTONVISN
          GOTO      HIDS6010 IF NOT EQUAL
.
          BRANCH    F1,HIDS6010,HIDS6020,HIDS6030,HIDS6040
          GOTO      HIDS9999
.
HIDS6010  COMPARE   ONE,F1     
          IF        @EQUAL
            MATCH     PTIPRHLD,SP70
            IF        @EQUAL
              WRITE     HTMLFILE;"Reason for Hold";
            ELSE
              WRITE     HTMLFILE;"<font color=red>Reason for Hold";
            ENDIF
          ENDIF
          GOTO      HIDS9999
.
HIDS6020  WRITE     HTMLFILE;"On Hold Audit";
          GOTO      HIDS9999
.
HIDS6030  WRITE     HTMLFILE;"User";
          GOTO      HIDS9999
.
HIDS6040  WRITE     HTMLFILE;"On Hold Action";
          GOTO      HIDS9999
.
HIDS9999  RETURN
+
.------------------------------------------------------------
.         Display Hold invoice details
.------------------------------------------------------------
IHOLD0000 PACK      KEY8,ADMISSNO,Z70
          CALL      RDIPEN1
          BRANCH    OVRCD,IHOLD999
.
.         MATCH     PTIPRHLD,SP70
.         GOTO      IHOLD999 IF EQUAL        * invoice not on hold
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPTONH1
          CALL      RPPTONH1
          BRANCH    OVRCD,IHOLD102           * no history record
.
          MATCH     ADMISSNO,PTONVISN
          GOTO      IHOLD104 IF EQUAL
.
.         No history data found but invoice is on hold
.
IHOLD102  MOVE      SP70,PTONHACT
          MOVE      PTIPRHLD,PTONREAH        * use pending hold code
          MOVE      PTIPRDES,PTONDESC
          MOVE      SP70,PTONTDAT
          MOVE      SP70,PTONURID
.
IHOLD104  BRANCH    F1,IHOLD110,IHOLD120,IHOLD130,IHOLD140
          IF        F1=ZERO
            MATCH     ANSR,PTONHACT
            GOTO      IHOLD999 IF EQUAL      * Deleted by patient
            MATCH     ANSH,PTONHACT
            GOTO      IHOLD999 IF EQUAL      * Deleted by claim code
            MATCH     ANSD,PTONHACT
            GOTO      IHOLD999 IF EQUAL      * Deleted by health fund
            MATCH     ANSM,PTONHACT
            GOTO      IHOLD999 IF EQUAL      * Deleted by HL7 receiver
.
            MATCH     SP70,PTONREAH
            GOTO      IHOLD999 IF EQUAL      * No reason for holding code
.
            MOVE      "rh",KEY2
            PACK      KEY5,KEY2,PTONREAH
            CALL      RDCODE1
            BRANCH    OVRCD,IHOLD999
            WRITE     HTMLFILE;TDESC;
          ENDIF
          GOTO      IHOLD999
.
IHOLD110  MATCH     ANSR,PTONHACT
          GOTO      IHOLD999 IF EQUAL      * Deleted by patient
          MATCH     ANSH,PTONHACT
          GOTO      IHOLD999 IF EQUAL      * Deleted by claim code
          MATCH     ANSD,PTONHACT
          GOTO      IHOLD999 IF EQUAL      * Deleted by health fund
          MATCH     ANSM,PTONHACT
          GOTO      IHOLD999 IF EQUAL      * Deleted by HL7 receiver
.
          MATCH     SP70,PTONDESC
          GOTO      IHOLD999 IF EQUAL      * no reason for hold
.
          WRITE     HTMLFILE;PTONDESC; 
          GOTO      IHOLD999
.
IHOLD120  MATCH     SP70,PTONTDAT
          GOTO      IHOLD999 IF EQUAL
.
          UNPACK    PTONTDAT,CCENT,CYEAR,CMON,CDAY   * On Hold Audit
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             SP1,AT,SP1,PTONTTIM,SP70
          GOTO      IHOLD999
.
IHOLD130  MATCH     SP70,PTONURID                    * User
          GOTO      IHOLD999 IF EQUAL
          PACK      KEY10,PTONURID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ELSE
            WRITE     HTMLFILE;WBSENAM;
          ENDIF
          GOTO      IHOLD999
.
IHOLD140  MATCH     "A",PTONHACT                     * On Hold Action
          IF        @EQUAL
            WRITE     HTMLFILE;RHINA;
            GOTO      IHOLD999
          ENDIF
.
          MATCH     "U",PTONHACT
          GOTO      IHOLD142 IF EQUAL           * Updated by Health fund
          MATCH     "G",PTONHACT
          GOTO      IHOLD142 IF EQUAL           * Updated by Claim code
          MATCH     "L",PTONHACT
          GOTO      IHOLD144 IF EQUAL           * Updated by HL7 Receiver
          MATCH     "T",PTONHACT
          GOTO      IHOLD200 IF NOT EQUAL       * NOT Updated hold for visit
.
IHOLD142  WRITE     HTMLFILE;RHINU;
          GOTO      IHOLD999
.
IHOLD144  WRITE     HTMLFILE;RHINR;
          GOTO      IHOLD999
.
IHOLD200  MATCH     "D",PTONHACT
          GOTO      IHOLD220 IF EQUAL           * Deleted by Health fund
          MATCH     "H",PTONHACT
          GOTO      IHOLD220 IF EQUAL           * Deleted by Claim code
          MATCH     "M",PTONHACT
          GOTO      IHOLD220 IF EQUAL           * Deleted by HL7 Receiver
          MATCH     "R",PTONHACT
          GOTO      IHOLD300 IF NOT EQUAL       * NOT Deleted hold for visit
.
IHOLD220  WRITE     HTMLFILE;RHIND;
          GOTO      IHOLD999
.
IHOLD300  MATCH     "C",PTONHACT            * Added hold for claim code
          IF         @EQUAL
            WRITE     HTMLFILE;RHINC;
          ENDIF
.
          MATCH     "F",PTONHACT            * Added hold for health fund
          IF        @EQUAL
            WRITE     HTMLFILE;RHINF;
          ENDIF
          GOTO      IHOLD999
.
IHOLD9999 RETURN
+
.------------------------------------------------------------T
.         Get scheduled fees
.------------------------------------------------------------
SCHF0000  OPEN      PRIITEM1,"priitemf"
          MOVE      ZERO,F2
          MOVE      PMMIITYP,F2
          PACK      KEY2,SP1,PMMIITYP,SP70
          PACK      KEY22,KEY2,PMMIITEM,PMMISUBN,Z70
          CALL      RSPRIT1
SCHF1000  CALL      RPPRIT1
          BRANCH    OVRCD,SCHF9000
.
          COMPARE   F2,PRITFLAG
          GOTO      SCHF9000 IF NOT EQUAL
.
          MATCH     PMMIITEM,PRITITMN
          GOTO      SCHF9000 IF NOT EQUAL
.
          MATCH     SP70,PMMISUBN
          IF        !@EQUAL
            MATCH     PMMISUBN,PRITSUBN
            GOTO      SCHF9000 IF NOT EQUAL
          ENDIF
.
          MATCH     PRITDAT1,PMMITDAT       * check against Item commenced date
          GOTO      SCHF1000 IF LESS
.
          MATCH     SP70,PRITDAT2           * check against Item end date
          IF        !@EQUAL
            MATCH     PMMITDAT,PRITDAT2
            GOTO      SCHF1000 IF LESS      * read next if past Cease date
          ENDIF
          GOTO      SCHF9999
.
SCHF9000  MOVE      ZERO,PRITSFEE
          MOVE      ZERO,PRITSF75
          MOVE      ZERO,PRITSF85
          MOVE      ZERO,PRITSAFE
SCHF9999  RETURN
+
.------------------------------------------------------------------
.         Contents of Pack Item
.------------------------------------------------------------------
PACI0000  CALL      HPAC0000                  * heading
.
          PACK      KEY14,ADMISSNO,TRANSNUM
          CALL      RDPMMTI1
          BRANCH    OVRCD,PACI9999
.
          CALL      GETNZM00
          BRANCH    EXIT,PACI9999
          COMPARE   ONE,NZMCCHGT
          GOTO      PACI9999 IF NOT EQUAL     * Not an exploding or pack item
.
          MOVE      ZERO,COUNTITM
.
          OPEN      NZPMXCA1,"nzpmxcaf"
          PACK      KEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                          NZMCEFDT,SP70
          PACK      SAVKEY37,KEY37,SP70
          PACK      KEY40,KEY37,SP70
          CALL      RSNZMXC1
PACI1000  CALL      RKNZMXC1
          BRANCH    OVRCD,PACI9999
.
          PACK      DIM37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                              NZMXEFDT,SP70
.
          MATCH     DIM37,SAVKEY37
          GOTO      PACI9999 IF NOT EQUAL
.
          PACK      PMMIITEM,NZMXITMN,SP70       * item code of pack item
          CALL      GETNZM00
          BRANCH    EXIT,PACI1000               * invalid misc.item
.
          ADD       ONE,COUNTITM
          MOVE      COUNTITM,KEY3
          REP       " 0",KEY3
.
          MOVE      NZMXQNTY,FORM3
          IF        PMMISERV<>0
            MULT      PMMISERV,FORM3
          ENDIF
          WRITE     HTMLFILE;"<input type=hidden name=puniq",KEY3," value=#"":
                             NZMXUNIQ,"#">":
                             "<tr><td>",NZMCMCHG,"</td>":
                             "<td>",NZMCDESC,"</td>":
                             "<td>",FORM3,"</td>":
                             "<td align=center>":
                            "<input type=checkbox name=cstrn",KEY3," value='1'":
                             "></td>":
                             "</tr>";
          GOTO      PACI1000
.
PACI9999  RETURN
+
.------------------------------------------------------------
.         Heading for Contents of Pack item
.------------------------------------------------------------
HPAC0000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Misc.Item Code</td>":
                               "<td class=HeadingCell>":
                               "Description</td>":
                               "<td class=HeadingCell>":
                               "Quantity</td>":
                               "<td align=center class=HeadingCell>":
                               "Delete</td>":
                             "</tr>"
HPAC9999  RETURN
+
.------------------------------------------------------------------
.         SX Item type
.------------------------------------------------------------------
ITYP0000  MOVE      ZERO,F1
          MOVE      PMMIINCT,F1
.
          IF        F1=0
            WRITE     HTMLFILE;"<option value=0 selected>":
                               "Included in Contract</option>":
                               "<option value=1>":
                               "Bill to Patient</option>":
                               "<option value=2>":
                               "Extra to Contract</option>";
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;"<option value=0>":
                               "Included in Contract</option>":
                               "<option value=1 selected>":
                               "Bill to Patient</option>":
                               "<option value=2>":
                               "Extra to Contract</option>";
          ENDIF
.
          IF        F1=2
            WRITE     HTMLFILE;"<option value=0>":
                               "Included in Contract</option>":
                               "<option value=1>":
                               "Bill to Patient</option>":
                               "<option value=2 selected>":
                               "Extra to Contract</option>";
          ENDIF
.
ITYP9999  RETURN
+
.------------------------------------------------------------------
. Get the appropriate miscellaneous charges  for NZ private billing
.------------------------------------------------------------------
GETNZM00  MOVE      ZERO,EXIT
          PACK      KEY11,ADMISSNO,PMMISUNQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,GETNZM90
.
          MOVE      SP70,KEY3
          PACK      KEY8,ADMISSNO,SP70   * is theatre complete
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXMHOS,KEY3
          ENDIF
          MOVE      ZERO,F1
          MOVE      PMMITDAT,MISCDATE
.
GETNZM10  PACK      KEY29,KEY3,NZSPCLMN,NZSPCNTR,SP8,PMMIITEM,SP70
          CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      GETNZM99 IF EQUAL
.
.         No record with health fund details - try a blank health fund
.
          PACK      KEY29,KEY3,NZSPCLMN,SP6,SP8,PMMIITEM,SP70
          CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      GETNZM99 IF EQUAL
.
.         No record with health fund details - try default claim, blank hf
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000        * Check Hospital claim code charging
          MOVE      PTCNDCLM,NZMCCLMC
          IF        F1=1
            MOVE      SP70,KEY3
          ENDIF
          PACK      KEY29,KEY3,NZMCCLMC,SP14,PMMIITEM
          CALL      NZGMC000
          COMPARE   ZERO,OVRCD
          GOTO      GETNZM99 IF EQUAL
.
.         No record for the hosp.- try with blank hosp
.
GETNZM30  BRANCH    F1,GETNZM90
          ADD       ONE,F1
          MOVE      SP70,KEY3
          GOTO      GETNZM10
.
GETNZM90  MOVE      ONE,EXIT
          GOTO      GETNZM99
.
GETNZM99  RETURN
+
.------------------------------------------------------------
. Defence force service code selection
.------------------------------------------------------------
DSRV0000  UNPACK    DIM127,D1,KEY2,DIM127        * Indicator Number (F2)
          MOVE      ZERO,F2
          MOVE      KEY2,F2
.
          UNPACK    DIM127,D1,KEY1,DIM127        * Include / Exclude (F1)
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          UNPACK    SP70,KEY4,KEY1
          IF        F2=99
            UNPACK    DIM127,D1,KEY4             * Indicator Value (KEY4)
          ELSE
            IF        F1<>0
              UNPACK    DIM127,D1,KEY1,DIM127    * Indicator Value (KEY1)
            ENDIF
          ENDIF
.
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
DSRV1000  CALL      RDKCODE2
          BRANCH    OVRCD,DSRV9999
          MATCH     CATEGORY,TCODE
          GOTO      DSRV9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      DSRV1000 IF EQUAL
.
          MATCH     "A",TCINDC3
          GOTO      DSRV1000 IF NOT EQUAL      * Not for Aust.Defence
.
          PACK      KEY35,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
.
          PACK      KEY40,QUOTE,ACODE,KEY35,QUOTE
          MATCH     CODE,ACODE
          GOTO      DSRV2000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                             TDESC,"</option>"
          GOTO      DSRV1000
.
DSRV2000  MATCH     "I",PTCOACTV
          GOTO      DSRV1000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,DSRV1000
            ENDIF
          ENDIF
.
          LOAD      D1,F2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,TCINDC12,TCINDC13,TCINDC14,TCINDC15:
                          TCINDC16,TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
.
          IF        F1=0
            MATCH     SP1,D1                   * Only display if ind F2 blank
            GOTO      DSRV1000 IF NOT EQUAL
          ENDIF
.
          IF        F1=1
            MATCH     KEY1,D1                  * Only display if ind F2=KEY1
            GOTO      DSRV1000 IF NOT EQUAL
          ENDIF
.
          IF        F1=2
            MATCH     KEY1,D1                  * Skip if ind F2=KEY1
            GOTO      DSRV1000 IF EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<option value=",KEY40,">",TDESC,"</option>"
          GOTO      DSRV1000
.
DSRV9999  RETURN
+
.------------------------------------------------------------
. Default Discount date
.------------------------------------------------------------
DSDT0000  MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY    * default to current date
          MOVE      ADMISSNO,KEY8
.
          COMPARE   ONE,PVITYPE
          GOTO      DSDT1220 IF NOT EQUAL
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,DIM8
          ENDIF
          GOTO      DSDT1260
.
DSDT1220  COMPARE   TWO,PVITYPE
          GOTO      DSDT1240 IF NOT EQUAL
          MOVE      SP3,OSTSYST
          MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          CALL      OPOTBB11
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      OBADATE,DIM8
          ENDIF
          GOTO      DSDT1260
.
DSDT1240  COMPARE   THREE,PVITYPE
          GOTO      DSDT1260 IF NOT EQUAL
          COMPARE   THREE,ASTAT
          GOTO      DSDT1260 IF NOT EQUAL
.
          MOVE      SP70,DDATE
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      DDATE,DIM8                    * Set date to disc.date
.
DSDT1260  REP       " 0",DIM8
          GOTO      DSDT9999
.
DSDT9999  RETURN
+
.------------------------------------------------------------
. Billing Summary
.------------------------------------------------------------
SUMM0000  BRANCH    FLDITMNO,SUMM0100,SUMM0200,SUMM0300,SUMM0400,SUMM0500:
                             SUMM0600,SUMM0700,SUMM0800,SUMM0900,SUMM1000:
                             SUMM1100,SUMM1200,SUMM1300,SUMM1400,SUMM1500:
                             SUMM1600,SUMM1700
          GOTO      SUMM9999
.
SUMM0100  PACK      INVDATE,CCC,CYY,CMM,CDD
          REP       " 0",INVDATE
          MOVE      ZERO,BDTEFLAG    * set 'No' to backdating invoice flag
          CALL      DBIL0000             * Display billing summary
          GOTO      SUMM9999
.
SUMM0200  MOVE      ONE,BDTEFLAG            * set backdating invoice flag
          MOVE      CHNGDATE,BACKDATE
          MOVE      ONE,PROGFLAG
          CALL      CALCTBI                 * calculate Invoice total
          CALL      GETCASH
.
          ADD       NBNKAMNT,CSAMT
          SUB       CSAMT,NETTOT
          WRITE     HTMLFILE;NETTOT;        * Balance payable
          GOTO      SUMM9999
.
SUMM0300  CALL      NXBC0000                * Next Invoice billing comment
          GOTO      SUMM9999
.
SUMM0400  CALL      PRFA0000                * PRFA
          GOTO      SUMM9999
.
SUMM0500  MOVE      ASRCE,KEY3              * Admission Source
          MOVE      ZERO,FORM1
          CALL      TSRC0000
          GOTO      SUMM9999
.
SUMM0600  MOVE      DDEST,KEY3              * Discharge Destination
          MOVE      ONE,FORM1
          MATCH     SP70,KEY3             * use dstat (Cat D) if ddest is blank
          IF        @EQUAL
            MOVE      DSTAT,KEY3
            MOVE      TWO,FORM1
          ENDIF
          MATCH     SP70,KEY3
          CALL      TSRC0000                
          GOTO      SUMM9999
.
SUMM0700  WRITE     HTMLFILE;PREVTRID;
          GOTO      SUMM9999
.
SUMM0800  MOVE      ZERO,NWAUFLAG
          MOVE      SP70,KEY3
          UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY3,KEY3,SP70
          MATCH     "001",KEY3
          IF        @EQUAL
            MOVE      ONE,NWAUFLAG         * NWAU Calculations
          ELSE
            MOVE      ONE,PROGFLAG
            CALL      CALCTBI              * calculate ABF charges
          ENDIF
.
          CALL      ABFPTDET               * ABF Details
          MOVE      ZERO,NWAUFLAG
          GOTO      SUMM9999
.
SUMM0900  MOVE      SP70,D8
          PACK      D8,INVOICNO,SP70
          MATCH     SP70,D8
          GOTO      SUMM0920 IF NOT EQUAL
.
          CALL      ABIV0000                * Get ABF Invoice number
          MOVE      ZERO,F8
          MOVE      D8,F8
          COMPARE   ZERO,F8
          GOTO      SUMM9999 IF EQUAL       * No ABF Invoice raised
.
SUMM0920  MOVE      ", Invoice : ",KEY12
          PACK      KEY20,KEY12,D8,SP70
          WRITE     HTMLFILE;KEY20;
          GOTO      SUMM9999
.
SUMM1000  CALL      ABFSADET             * ABF Sub-Acute Details
          GOTO      SUMM9999
.
SUMM1100  MOVE      ZERO,F1
          PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "11",PTCDUDF6
            IF        @EQUAL
              MOVE      ONE,F1           * Mental Health Event
            ENDIF
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      SUMM9999
.
SUMM1200  MOVE      ZERO,NWAUFLAG
          MOVE      SP70,KEY3
          UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY3,KEY3,SP70
          MATCH     "001",KEY3
          IF        @EQUAL
            MOVE      ONE,NWAUFLAG         * NWAU Calculations
          ELSE
            MOVE      ONE,PROGFLAG
            CALL      CALCTBI              * calculate ABF charges
          ENDIF
          CALL      ABFMHDET             * ABF MH Details
          MOVE      ZERO,NWAUFLAG
          GOTO      SUMM9999
.
SUMM1300  MATCH     SP70,PRDSDATE         * Episode Start date
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PRDSDATE;
          GOTO      SUMM9999
.
SUMM1400  MATCH     SP70,PRDEDATE         * Episode End date
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PRDEDATE;
          GOTO      SUMM9999
.
SUMM1500  MATCH     SP70,PRDEPSOD         * Episode number
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PRDEPSOD;
          GOTO      SUMM9999
.
SUMM1600  MATCH     SP70,PRDCCLSS         * Care class
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PRDCCLSS;
          GOTO      SUMM9999
.
SUMM1700  CALL      PCAR0000             * Phase of ABF Palliative care
          GOTO      SUMM9999
.
SUMM9999  RETURN
+
.------------------------------------------------------------
. Phase of ABF Palliative Care Change Details Table
.------------------------------------------------------------
PCAR0000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PCAR9999
.
          MOVE      ZERO,FORM2
          MATCH     SP70,PTCDUDF6
          GOTO      PCAR9999 IF EQUAL
          MOVE      ZERO,NSNAPFLG
.
.          UDF 6 3=Palliative
.
          SQUEEZE   PTCDUDF6
          MOVE      PTCDUDF6,FORM2
          COMPARE   THREE,FORM2
          GOTO      PCAR9999 IF NOT EQUAL     * NOT Palliative care
.
          MOVE      SP70,KEY1
          UNPACK    THCSCOD,KEY1
          MATCH     "8",KEY1
          GOTO      PCAR9999 IF NOT EQUAL    * NOT Palliative phase of Care
.
          MOVE      ADATE,PRDSDATE
          REP       " 0",PRDSDATE
          MOVE      SP70,PRDEDATE
.
          MOVE      ACARE,PRDCCLSS
          MOVE      ACARE,SCHCODE
          MOVE      SP70,PRDEPSOD
          MOVE      " 1",DPTRDEPN           * default episode number
          MOVE      ZERO,COUNTITM
.
          PACK      KEY27,ADMISSNO,SP70
          CALL      RSPTABF1
PCAR1000  CALL      RKPTABF1
          BRANCH    OVRCD,PCAR4000
.
          MATCH     ADMISSNO,PTABADMN
          GOTO      PCAR4000 IF NOT EQUAL
.
          MATCH     SP70,PTABINVN
          GOTO      PCAR1000 IF NOT EQUAL
.
          MATCH     "070",PTABADJT          * AN-SNAP Adjustment
          GOTO      PCAR1000 IF NOT EQUAL
.
.         Check if AN-SNAP record Extracted from QuickSnap (IBAPMS63)
.
          MATCH     "QUICKSNAP",PTABCUID
          GOTO      PCAR1800 IF EQUAL
          MATCH     "QUICKSNAP",PTABUUID
          GOTO      PCAR4000 IF NOT EQUAL
.
.         Check if Episode number is populated in patabfaf file from QUICKSNAP
.
PCAR1800  MOVE      SP70,D1
          UNPACK    PTABCDES,KEY8,D1          * KEY8 = AN-SNAP Code/Version
          MATCH     SP70,D1
          GOTO      PCAR4000 IF EQUAL         * AN-SNAP is blank
.
.         PTABCDES contains ANSNAP code, Version, Episode no and phase End Date
.
          MOVE      ONE,NSNAPFLG
          MOVE      PTABENCT,PRDSDATE
          UNPACK    PTABCDES,PTRDSNAP,SLASH,PTRDVERS:
                             KEY1,DPTRDEPN,KEY1,PRDEDATE
.
          MATCH     DPTRDEPN,PRDEPSOD
          GOTO      PCAR1900 IF EQUAL      * Episode number hasn't changed
.
          MOVE      DPTRDEPN,PRDEPSOD      * Episode no
.
          PACK      KEY10,ADMISSNO,DPTRDEPN,SP70
          CALL      RDPTRDE1
          BRANCH    OVRCD,PCAR1000
.
          MOVE      DPTRDEPN,PRDEPSOD
          MOVE      PTRDPOCA,PMFOPHOC      * Phase of Care
          GOTO      PCAR2000
.
PCAR1900  PACK      KEY18,ADMISSNO,DPTRDEPN,PRDSDATE,SP70
          CALL      RDPMFOC1
          BRANCH    OVRCD,PCAR1000
.
PCAR2000  CALL      NEPS0000                * Get care class
          CALL      POCROW00                * Change phase table row
          GOTO      PCAR1000
.
.         If AN-SNAP NOT extracted from QuickSnap then
.         generate it from Rehabilitation details file for each Palliative 
.         Episode
.
PCAR4000  BRANCH    NSNAPFLG,PCAR9999
.
          MOVE      ADATE,PRDSDATE           * Episode Start date
          REP       " 0",PRDSDATE
          PACK      PRDEDATE,CCC,CYY,CMM,CDD    * Use current date
          IF        ASTAT=3
            MOVE      DDATE,PRDEDATE           * Episode End date
          ENDIF
          REP       " 0",PRDEDATE
          MOVE      ZERO,CHGCCLSS
.
.         Get the Episode number from Rehabilitation details
.
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRDE1
PCAR4100  CALL      RKPTRDE1
          BRANCH    OVRCD,PCAR9999
.
          MATCH     ADMISSNO,DPTRDADM
          GOTO      PCAR9999 IF NOT EQUAL
.
          MOVE      DPTRDEPN,PRDEPSOD
          CALL      NEPS0000                * Get end of episode
.
.         Get the last record of Phase of Care change for the Episode
.
          PACK      KEY18,ADMISSNO,DPTRDEPN,Z70
          CALL      RSPMFOC1
          CALL      RPPMFOC1
          BRANCH    OVRCD,PCAR4200
.
          MATCH     ADMISSNO,PMFOVISN
          GOTO      PCAR4200 IF NOT EQUAL
.
          MATCH     DPTRDEPN,PMFOEPNO
          GOTO      PCAR5000 IF EQUAL
.
PCAR4200  MOVE      PTRDPOCA,PMFOPHOC       * phase of care
.
PCAR5000  CALL      POCROW00                * Change phase table row
          GOTO      PCAR4100
.
PCAR9999  RETURN
+
.--------------------------------------------------------------------------
. Get Start & End of episode and Change of care class
.--------------------------------------------------------------------------
NEPS0000  COMPARE   ZERO,CHGCCLSS
          GOTO      NEPS1000 IF EQUAL
.
          IF        NSNAPFLG=1
            MATCH     PRDEDATE,CHDATE
            GOTO      NEPS9999 IF NOT LESS  * no change
          ENDIF
.
          GOTO      NEPS1200              * get next care class change
.
NEPS1000  PACK      KEY26,DPTRDADM,DPTRDEPN,SP70
          CALL      RDSCHCO2
NEPS1200  CALL      RDKCHCO2
          BRANCH    OVRCD,NEPS8000
.
          MATCH     DDADMNO,DCHADMN
          GOTO      NEPS8000 IF NOT EQUAL
.
          MATCH     DPTRDEPN,CHEPISNO     * Check episode number
          GOTO      NEPS2000 IF NOT EQUAL
.
          MATCH     "CC",CHCATG           * care class change ?
          GOTO      NEPS1200 IF NOT EQUAL
.
          PACK      KEY5,CHCATG,CHCODE
          CALL      RDCODE1
          BRANCH    OVRCD,NEPS1200
.
          MOVE      ZERO,FORM1
          SQUEEZE   PTCDUDF6
          MOVE      PTCDUDF6,FORM1
          COMPARE   THREE,FORM1
          GOTO      NEPS1200 IF NOT EQUAL     * NOT Palliative care
.
          MOVE      SP70,KEY2
          UNPACK    THCSCOD,KEY2
          MATCH     "8",KEY2
          GOTO      NEPS1200 IF NOT EQUAL    * NOT Palliative phase of Care
.
          IF        NSNAPFLG=0
            MOVE      CHDATE,PRDEDATE       * set End date of episode care
          ENDIF
          MOVE      CHCODE,PRDCCLSS
          ADD       ONE,CHGCCLSS
          GOTO      NEPS9999
.
NEPS2000  IF        NSNAPFLG=0
            MOVE      CHDATE,PRDSDATE       * start of new episode
          ENDIF
          GOTO      NEPS1200
.
NEPS8000  IF        NSNAPFLG=0
            MOVE      DDATE,PRDEDATE        * use discharged date
          ENDIF
          MOVE      ACARE,PRDCCLSS
.
NEPS9999  RETURN
+
.*******************************************************************************
. Phase of Care Change Details Table Row
.*******************************************************************************
POCROW00  CLEAR     HTMLLINK
          APPEND    "javascript:ShowNWAU('",HTMLLINK
          APPEND    PRDEPSOD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRDSDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRDEDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRDCCLSS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "pu",KEY2
          PACK      KEY5,KEY2,PMFOPHOC,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",DPTRDEPN,"#",":               * 1
                             "#"",PRDSDATE,"#",":               * 2
                             "#"",PRDEDATE,"#",":               * 3
                             "#"",TDESC,"#",":                  * 4
                             "#"",PRDCCLSS,"#")"                * 5
.
POCROW99  RETURN
+
.------------------------------------------------------------
. Get ABF Invoice number
.------------------------------------------------------------
ABIV0000  MOVE      ZERO,D8
          OPEN      PATINVR3,"patinvrf"
          PACK      KEY16,AADMNO,SP70
          CALL      RDSINV3
ABIV1000  CALL      RDKINV3
          BRANCH    OVRCD,ABIV9999
.
          MATCH     PINVADM,AADMNO
          GOTO      ABIV9999 IF NOT EQUAL
.
          COMPARE   THREE,PTINCMIX           * ABF Invoice ?
          GOTO      ABIV1000 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABIV1000 IF NOT EQUAL    * Credit notes
.
          MOVE      PINVNO,D8
.
ABIV9999  RETURN
+
.------------------------------------------------------------
.         Transfer source
.------------------------------------------------------------
TSRC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,KEY3
          GOTO      TSRC9000 IF EQUAL
.
          BRANCH    F1,TSRC1000
          GOTO      TSRC2000
.
TSRC1000  IF        FORM1=0
            WRITE     HTMLFILE;"Admission Source";
          ENDIF
          IF        FORM1=1
            WRITE     HTMLFILE;"Discharge Destination";
          ENDIF
          IF        FORM1=2
            WRITE     HTMLFILE;"Discharge Status";
          ENDIF
          GOTO      TSRC9999
.
TSRC2000  IF        FORM1=0
            MOVE      "S ",KEY2
          ENDIF
          IF        FORM1=1
            MOVE      "DD",KEY2
          ENDIF
          IF        FORM1=2
            MOVE      "D ",KEY2
          ENDIF
          PACK      KEY5,KEY2,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,TSRC9000
.
          PACK      KEY8,ADMISSNO
          CALL      RDPTDAD1
          BRANCH    OVRCD,TSRC8000
.
          MOVE      PTDAADTS,DIM5
          LOAD      DIM5,FORM1,PTDADCTS       * Discharge Transfer source
.
          MATCH     SP70,DIM5
          GOTO      TSRC8000 IF EQUAL
          PACK      KEY5,DIM5,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,TSRC8000
.
          MOVE      "-",ANS
          WRITE     HTMLFILE;TDESC,ANS,PTVADESC;
          GOTO      TSRC9999
.
TSRC8000  WRITE     HTMLFILE;TDESC;           * Admission source
          GOTO      TSRC9999
.
TSRC9000  WRITE     HTMLFILE;"&nbsp;";
TSRC9999  RETURN
+
.------------------------------------------------------------
.         PRFA
.------------------------------------------------------------
PRFA0000  PACK      KEY138,SP70,SP70
          PACK      KEY8,ADMISSNO
          CALL      RDRESP1
          BRANCH    OVRCD,PRFA2000
.
          CALL      SPRF0000                     * Setup PRFA Name and Address
.
.         MATCH     SP70,KEY138
.         GOTO      PRFA2000 IF EQUAL
.
          MATCH     PKADD1,PADD1
          GOTO      PRFA2000 IF NOT EQUAL
          MATCH     PKSUBR,PSUBRB
          GOTO      PRFA2000 IF NOT EQUAL
          MATCH     PKPOST,PPOST
          GOTO      PRFA7000 IF EQUAL
.
PRFA2000  STRIP     KEY138
          ENDSET    KEY138
          APPEND    " (Address Different to PMI)",KEY138
          APPEND    SP70,KEY138
          RESET     KEY138
          WRITE     HTMLFILE;"<font color=red>",KEY138,"</font>";
          GOTO      PRFA9999
.
PRFA7000  WRITE     HTMLFILE;KEY138;
          GOTO      PRFA9999
.
PRFA9999  RETURN
+
.------------------------------------------------------------
.         Set up PRFA Name and Address
.------------------------------------------------------------
SPRF0000  PACK      KEY138,SP70,SP70
          MOVE      PKNAME,KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
          MATCH     SP70,PKADD1
          GOTO      SPRF2000 IF EQUAL        * blank address
.
          APPEND    ",",KEY138
          APPEND    PKADD1,KEY138
          RESET     KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
SPRF2000  MATCH     SP70,PKADD2
          GOTO      SPRF3000 IF EQUAL        * blank address line 2
.
          APPEND    ",",KEY138
          APPEND    PKADD2,KEY138
          RESET     KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
SPRF3000  MATCH     SP70,PKSUBR
          GOTO      SPRF4000 IF EQUAL        * blank suburb
.
          APPEND    ",",KEY138
          APPEND    PKSUBR,KEY138
          RESET     KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
SPRF4000  MATCH     SP70,PKADD4
          GOTO      SPRF5000 IF EQUAL        * blank address line 4
.
          APPEND    ",",KEY138
          APPEND    PKADD4,KEY138
          RESET     KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
SPRF5000  MATCH     SP70,PKPOST
          GOTO      SPRF6000 IF EQUAL        * blank postcode
.
          APPEND    ",",KEY138
          APPEND    PKPOST,KEY138
          RESET     KEY138
          STRIP     KEY138
          ENDSET    KEY138
.
SPRF6000  APPEND    SP70,KEY138
          RESET     KEY138
SPRF9999  RETURN
+
.------------------------------------------------------------
.         Check Next invoice billing comments
.------------------------------------------------------------
NXBC0000  MOVE      ZERO,F1
          MOVE      "003",KEY3
          PACK      KEY17,ADMISSNO,KEY3,Z70
          CALL      RSVSMDT1
NXBC1000  CALL      RPVSMDT1
          BRANCH    OVRCD,NXBC9000
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      NXBC1000 IF EQUAL        * Deleted
.
          MOVE      ONE,F1
.
NXBC9000  WRITE     HTMLFILE;F1;
NXBC9999  RETURN
+
.------------------------------------------------------------
. Display Billing Summary details
.------------------------------------------------------------
DBIL0000  CALL      TINV0000         * Get total invoice
          MOVE      ZERO,IPASS
          MOVE      ONE,PROGFLAG
.
          UNPACK    INVDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,TCENT
          MOVE      XYEAR,TYEAR
          MOVE      XMON,TMON
          MOVE      XDAY,TDAY
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
.
          MOVE      ZERO,NETTOT
          MOVE      ZERO,REBTOT
          COMPARE   "1",PVITYPE
          GOTO      DBIL5000 IF EQUAL         * Emergency
.
          COMPARE   "2",PVITYPE               * Outpatient
          GOTO      DBIL1000 IF EQUAL
.
          COMPARE   "3",PVITYPE               * Inpatient
          GOTO      DBIL2000 IF EQUAL
.
          COMPARE   "9",PVITYPE
          GOTO      DBIL6000 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      DBIL6000 IF NOT EQUAL     * Not an event
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DBIL6000
          MATCH     ANSE,TCINDC1
          GOTO      DBIL4000 IF EQUAL         * Emergency event
          GOTO      DBIL6000
.
.         Outpatient
.
DBIL1000  MOVE      ADMISSNO,OBAOUTNO
          MOVE      ADMISSNO,KEY8
          MOVE      SP3,OSTSYST
          MOVE      "out",OSTFILE
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
          PACK      CFNAME,OSTFILE,FILBB1A1   * Set up physical filename
          CALL      OPOTBB11
          CALL      RDBOKB1
          BRANCH    OVRCD,DBIL9999
.
          MOVE      ONE,PROGFLAG
          MOVE      OBAOUTNO,OTNUMB
          MOVE      OBADATE,ALACDTE
          CALL      OUTTBI                    * Outpatient
          GOTO      DBIL6000
.
.         Inpatient
.
DBIL2000  MOVE      SP10,DDATE
          COMPARE   ONE,ASTAT
          GOTO      DBIL6000 IF EQUAL
.
          COMPARE   THREE,ASTAT
          IF        @EQUAL
            MATCH     DDATE,ALACDTE
            IF        !@LESS
              CALL      GMSC0000
              CALL      CALCTBI
              GOTO      DBIL6000
            ENDIF
          ENDIF
          CALL      CALCTBI
          GOTO      DBIL6000
.
DBIL4000  MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,DBIL9999
          MOVE      PVIURNO,ADAURNO
          MOVE      PVIBILL,ADANUMB
          MOVE      PMEVADTE,ADADATE
          GOTO      DBIL5500
.
.         Emergency
.
DBIL5000  MOVE      ADMISSNO,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,DBIL9999
.
DBIL5500  MOVE      ONE,PROGFLAG
          MOVE      ADMISSNO,ATNUMB
          MOVE      ADADATE,ALACDTE
          CALL      AAETBI
          GOTO      DBIL6000
.
DBIL6000  CALL      GETCASH
.
          UNPACK    ALACDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
.         Calculate balance outstanding
.
          MOVE      TOTINV,TOTBAL
          ADD       TOTPD,TOTBAL
          ADD       TOTJR,TOTBAL
          ADD       TOTCR,TOTBAL
.
          WRITE     HTMLFILE;"<tr><td>Invoice to<b>":
                          SP2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</b></td>":
                          "<td align=right>",DOLLAR,TOTINV,"</td></tr>":
                         "<tr><td>Payment</td>":
                          "<td align=right>",DOLLAR,TOTPD,"</td></tr>":
                         "<tr><td>Journal Adjustments</td>":
                          "<td align=right>",DOLLAR,TOTJR,"</td></tr>":
                         "<tr><td>Credit Note</td>":
                          "<td align=right>",DOLLAR,TOTCR,"</td></tr>":
                         "<tr><td><b>Outstanding Balance</b></td>":
                          "<td align=right><b>",DOLLAR,TOTBAL,"</b></td></tr>";
.
          UNPACK    INVDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,CCENT
          MOVE      XYEAR,CYEAR
          MOVE      XMON,CMON
          MOVE      XDAY,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      NETTOT,FORM12P2
          CALL      GRND0000                 * Work out the rounding adjustment
          MOVE      FORM12P2,FORM122
          SUB       CSAMT,FORM122
.
          BRANCH    PVITYPE,DBIL8000,DBIL8000,DBIL8000
.
          COMPARE   "9",PVITYPE
          GOTO      DBIL9999 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      DBIL9999 IF NOT EQUAL     * Not an event
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DBIL9999
          MATCH     ANSE,TCINDC1
          GOTO      DBIL8000 IF EQUAL            * Emergency event
.
          GOTO      DBIL9999
.
DBIL8000  WRITE    HTMLFILE;"<tr><td>&nbsp;</td><td>&nbsp;</td></tr>"
.
          WRITE    HTMLFILE;"<tr><td><b>Since last Invoice</b></td>":
                             "<td>&nbsp;</td></tr>":
                            "<tr><td>Amount to be Billed - Up to:<b>":
                             SP2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</b></td>":
                             "<td align=right>",DOLLAR,FORM12P2,"</td></tr>":
                            "<tr><td>Cash already Received</td>":
                             "<td align=right>",DOLLAR,CSAMT,"</td></tr>":
                            "<tr><td><b>Patient next Invoice</b></td>":
                             "<td align=right><b>",DOLLAR,FORM122:
                             "</b></td></tr>"
DBIL9999  RETURN
+
.------------------------------------------------------------
. Get total invoice
.------------------------------------------------------------
TINV0000  MOVE      ZERO,TOTPD
          MOVE      ZERO,TOTJR
          MOVE      ZERO,TOTCR
          MOVE      ZERO,TOTINV
          MOVE      ZERO,TOTBAL
.
          PACK      KEY16 WITH ADMISSNO,SP8
          CALL      RDSINV3
TINV1000  CALL      RDKINV3
          BRANCH    OVRCD OF TINV9999
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      TINV9999 IF NOT EQUAL
.
.         Add up payments
.
          MOVE      PINVPATA,FORM122
          ADD       PINVHFDA,FORM122

          MOVE      PINVPATA,FORM122
          ADD       PINVHFDA,FORM122
          ADD       PINVOTHA,FORM122
.
.         Accumulate totals
.
          ADD       PINVAMT,TOTINV
          ADD       FORM122,TOTPD
          ADD       PINVJOUR,TOTJR
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTINGSTJ,TOTJR
          ENDIF
          ADD       PTINCRTT,TOTCR
.
          GOTO      TINV1000
.
TINV9999  RETURN
+
.------------------------------------------------------------
. Display Billing Comments
.------------------------------------------------------------
DCMN0000  MOVE      "003",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
DCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,DCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      DCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      DCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      DCMN1000
.
DCMN9999  RETURN
+
.------------------------------------------------------------
. Display Past Medical History Comments
.------------------------------------------------------------
MCMN0000  MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
MCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,MCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      MCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      MCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      MCMN1000
.
MCMN9999  RETURN
+
.------------------------------------------------------------
. Display Working Diagnosis Comments
.------------------------------------------------------------
WCMN0000  MOVE      "016",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
WCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,WCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      WCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      WCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      WCMN1000
.
WCMN9999  RETURN
+
.------------------------------------------------------------
. Display Clinical Notes Comments
.------------------------------------------------------------
CCMN0000  MOVE      "017",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
CCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,CCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      CCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      CCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      CCMN1000
.
CCMN9999  RETURN
+
.------------------------------------------------------------
. Print Billing Statement in bulk
.------------------------------------------------------------
BSTA0000  MOVE      ZERO,COUNTITM
BSTA1000  ADD       ONE,COUNTITM
          COMPARE   "999",COUNTITM
          GOTO      BSTA9999 IF NOT LESS
.
          MOVE      BADMN[COUNTITM],ADMISSNO
          MATCH     SP70,BADMN[COUNTITM]
          GOTO      BSTA9999 IF EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      BPRNT[COUNTITM],FORM1
          COMPARE   ONE,FORM1
          GOTO      BSTA1000 IF NOT EQUAL * not to print
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,BSTA1000
          MOVE      AURNO,URNUMBER        * setup U/R number
.
          MOVE      "010",KEY3            * Pooling Type
          CALL      PNTX0000              * print billing statement
          GOTO      BSTA1000
.
BSTA9999  RETURN
+
.*****************************************************************************
. Write Adm and U/R number to the COMWEB70 polling table to print billing stat
.*****************************************************************************
PNTX0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,PNTX1000
.
          MOVE      IBPLUNIQ,FORM10
PNTX1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      KEY3,IBPLTYPE     * Pooling Type
          MOVE      URNUMBER,IBPLURNO
          MOVE      ADMISSNO,IBPLVISN
          PACK      IBPLSKEY,SELPRINT,WBSEUID,SP70
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,PNTX1000
          ELSE
            GOTO      PNTX1000
          ENDIF
.
PNTX9999  RETURN
.
.------------------------------------------------------------
.  Print Invoice
.------------------------------------------------------------
PRTINV00  MOVE      ZERO,EXIT
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRTINV85
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,PRTINV85
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PRTINV80
.
          CALL      DGTU0000                * Check unknown gst file
          COMPARE   FIVE,CFEETYP
          GOTO      PRTINV60 IF EQUAL             * SX
          COMPARE   NINE,CFEETYP
          GOTO      PRTINV60 IF EQUAL             * Johns Hopkins
.
.         Check for Independent services billing
.
          IF        ISBLFLAG=1
            MOVE      ONE,WEBFLAG
            MOVE      ZERO,PAGENO
            MOVE      SP70,DDATE
            IF        ASTAT=3
              MOVE      AADMNO,KEY8
              CALL      RDDSCH1
            ENDIF
            CALL      ICDSG000              * Check for ICD10 Sugg. Class.
            GOTO      PRTINV70
          ENDIF
.
          MATCH     "019",TEMPLATE
          GOTO      PRTINV60 IF EQUAL      * Patient invoice
.
          MATCH     ANSY,PTMICMXP
          GOTO      PRTINV60 IF NOT EQUAL
.
          BRANCH    DBSFLAG,PRTINV60              * Discharge billing
          COMPARE   THREE,ASTAT
          GOTO      PRTINV81 IF NOT EQUAL         * not discharge
.
PRTINV60  MOVE      ONE,WEBFLAG
          MOVE      ONE,PROGFLAG
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,REVBFLAG
          MOVE      ZERO,PAGENO
.
          MOVE      ZERO,INVTYPE            * Standard invoice
          IF        CFEETYP=9
            MOVE      ONE,INVTYPE           * Default to summary
            MOVE      ONE,JHFLAG            * Johns Hopkins
          ENDIF
.
          IF        JHFLAG=1 | CFEETYP=5
            MATCH     "031",TEMPLATE
            IF        @EQUAL
              MOVE      ONE,INVTYPE         * Johns Hopkins Summary invoice
            ELSE
              MOVE      TWO,INVTYPE         * Johns Hopkins Detailed invoice
            ENDIF
          ENDIF
.
          MOVE      SP70,DDATE
          IF        ASTAT=3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1
          ENDIF
.
          IF        DBSFLAG=1
            CALL      CALCTBI
            GOTO      PRTINV70             *  Discharge Billing
          ENDIF
.
          MATCH     "1",PTCNPPIN
          GOTO      PRTINV66 IF NOT EQUAL  * not using Pat.Inv.new functionality
.
          MATCH     "019",TEMPLATE
          IF        @EQUAL
            MOVE      TWO,IPATFLAG          * Patient Inv.New Functionality
            CALL      CALCTBI               * calculate Patient invoice amount
            IF        NUMBINVR=1
              IF        HFACCM<>0
                MOVE      ONE,NCHACCOM      * Do not Charge Accommodation
              ENDIF
            ENDIF
            GOTO      PRTINV68
          ENDIF
.
PRTINV66  CALL      CALCTBI                     * Work out invoice date range
.
          CALL      ICDSG000                    * Check for ICD10 Sugg. Class.
.
.         If this is Patient only Invoice and Accom.has HF portion,
.      do not charge Accommodation and only charge any items with No HF portion
.
          MATCH     "019",TEMPLATE
          IF        @EQUAL
            MOVE      ONE,IPATFLAG
            IF        HFACCM<>0
              MOVE      ONE,NCHACCOM            * Do not Charge Accommodation
            ENDIF
          ENDIF
.
PRTINV68  COMPARE   ZERO,TOTDAYS
          GOTO      PRTINV70 IF NOT EQUAL
          COMPARE   ZERO,GROSSTOT
          GOTO      PRTINV70 IF NOT EQUAL
.
          COMPARE   ONE,PTCNPRIN                * print a zero invoice total?
          GOTO      PRTINV80 IF NOT EQUAL       * no outstanding amount
.
PRTINV70  CALL      OPNPRINT 
          MOVE      THREE,PROGFLAG
          MOVE      ZERO,ERRFLAG
.
          COMPARE   ONE,DBSFLAG
          GOTO      PRTINV72 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            MOVE      ZERO,PTELPPRI
            MOVE      ZERO,PTELPPUT
            MOVE      ZERO,PTELPSHA
            MOVE      ZERO,PTELPSUT
            MOVE      ZERO,PTELPSDY
            MOVE      ZERO,PTELPCCU
            MOVE      ZERO,PTELPSDU
            MOVE      ZERO,PTELPHSP
            MOVE      ZERO,PTELPHSU
            MOVE      ZERO,PTELPTHE
            MOVE      ZERO,PTELPTUT
            MOVE      ZERO,PTELXCSS
            MOVE      ZERO,PTELXCSD
          ENDIF
.
          MOVE      ZERO,IPASS
          MOVE      ONE,NUMINVS
          MOVE      ZERO,TDBSAMNT
          MOVE      ZERO,TOTALFEE
          MOVE      ZERO,CPAYPRIV             * Co-payment for private
          MOVE      ZERO,CPAYSHRD             * Co-payment for shared
          MOVE      ZERO,CPAYCCUH             * Co-payment for CCU/ICU/SCN/HDU
          MOVE      ZERO,BPDAYS
          MOVE      ZERO,BSDAYS
          MOVE      ZERO,BCDAYS
          MOVE      ZERO,EPSFLAG              * flag for first invoice 
          MOVE      SIX,PROGFLAG              * Discharge billing statement
          MOVE      ONE,MSGFLAG               * not display error message
          MOVE      ZERO,CREDTOT
          MOVE      ZERO,CNEXTINV
          CALL      PRNTINV1
          BRANCH    EXIT,PRTINV99
.
          CALL      PRTELIGI                  * Print eligibility table
          MOVE      ONE,PRINTFLG
          CALL      DSIV0000                  * Print all Invoices details
.
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
          ENDIF
.
          MOVE      "PATWEB71",SETDFPRG
          MOVE      "2",SETDFRPT
          MOVE      SELPRINT,SCHDPRNT
          CALL      SETDEF00                 * save default printer
.
          GOTO      PRTINV98
.
PRTINV72  
.     CLOCK     TIME,CTIMEIS
.     DISPLAY    "XXXXXXX BEFORE PRIS0000 PRGFLG=3 ",CTIMEIS," XXXXXXXX"
          IF        CFEETYP=5
            CALL      PRSX0000                * printing SX invoice
          ELSE
            IF        ISBLFLAG=1
              CALL      IBRK0000              * Check Payer breakdown uptodate
              BRANCH    EXIT,PRTINV86
.
              MOVE      ZERO,EXIT
              CALL      PRIS0000              * printing Independent Services
              BRANCH    EXIT,PRTINV99
              COMPARE   FOUR,ERRFLAG
              GOTO      PRTINV74 IF NOT EQUAL
              MOVE      ZERO,ISBLFLAG         * print normal invoice
            ENDIF
            CALL      PRNTINV0
          ENDIF
.
PRTINV74  BRANCH    ERRFLAG,PRTINV82,PRTINV83,PRTINV84
          BRANCH    EXIT,PRTINV99
.
.     CLOCK     TIME,CTIMEIS
.     DISPLAY    "XXXXXXX FINISHED PRIS0000 PRGFLG=3 ",CTIMEIS," XXXXXXXX"
.
PRTINV77  MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
          ENDIF
.
          MATCH     SP70,EXPPAYER
          IF        !@EQUAL
            PACK      KEY14,ADMISSNO,EXPPAYER,SP70
            CALL      RDVSPAY1
            IF        OVRCD=0
              MOVE      ONE,VSPAISEN          * Set to Yes for sending invoice
              CALL      UPVSPAY1
            ENDIF
          ENDIF
.
.         Update Reassign debt for Patient invoice
.
          IF        IPATFLAG=1 & IPASS=0
            PROC      PATRDEBT         * Update Reassign debt 
          ENDIF
.
          IF        IPATFLAG=2
            PROC      PATRDEBT         * Update Reassign debt 
          ENDIF
.
          CALL      INVC0000                  * Transfer tobe invoiced comments
.
.         Check if this claim has Associated field 3 = X
.         (do not write to Future Action follow up)
.
          PACK      KEY5,ANSC,ANSL,ACLAIM        * check for DVA indicator
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSX,PTCDASC7           * Associated Field 7
            GOTO      PRTINV78 IF EQUAL       * X - No future Action follow up
          ENDIF
.
          MATCH     "1",PTCNDFUP
          IF        @EQUAL
            CALL      WACT0000                * Write Action plan if required
          ENDIF
.
PRTINV78  MOVE      ZERO,EXIT
          MATCH     "007",TEMPLATE
          GOTO      PRTINV79 IF NOT EQUAL
.
          MATCH     SELECTID,SP10
          GOTO      PRTINV98 IF EQUAL
.
          PACK      KEY12,SELECTID,ADMISSNO,SP70
          CALL      RDPMBII1                   * read bulk invoice list
          BRANCH    OVRCD,PRTINV98
          MOVE      ONE,PMBIPRNT
          CALL      UPPMBII1                   * update already printed flag
          GOTO      PRTINV98
.
PRTINV79  MATCH     "013",TEMPLATE
          GOTO      PRTINV98 IF NOT EQUAL
.
          MATCH     SELECTID,SP10
          GOTO      PRTINV98 IF EQUAL
.
          PACK      KEY12,SELECTID,ADMISSNO,SP70
          CALL      RDPMBBI1                   * read bulk invoice list
          BRANCH    OVRCD,PRTINV98
          MOVE      ONE,PMBBPRNT
          CALL      UPPMBBI1                   * update already printed flag
          GOTO      PRTINV98
.
PRTINV80  MOVE      "No Invoice details to be printed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV81  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          APPEND    "Casemix Patient must be discharged",WEBTITLE
          APPEND    " before invoicing.",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV82  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          APPEND    "Invoice for more than ",WEBTITLE
          APPEND    CMAXINV,WEBTITLE
          APPEND    " days.- No Invoice produced.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV83  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          MOVE      "Invalid Invoice Range.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV84  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          MOVE      "Missing Transfer file record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV85  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          MOVE      "Missing Master/Visit record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV86  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          MOVE      "Payer Breakdown is not Up to date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTINV99
.
PRTINV98  MOVE      ZERO,EXIT
PRTINV99  RETURN
+
.------------------------------------------------------------
. New Correspondenance Item
.------------------------------------------------------------
NEWCOR00  PACK      CORSP001,SPLFILE,CORSPPRT,SP70
          PACK      CORSP002,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CORSP002
          CLOCK     TIME,CTIMEIS
          PACK      CORSP004,CTIMEIS
.
          PACK      KEY8,ADMISSNO           * validate admissno
          MOVE      ADMISSNO,SAVVISIT
          MATCH     SP70,ADMISSNO
          IF        @EQUAL|@EOS
            MOVE      "00000000",SAVVISIT
          ENDIF
.
NEWCOR20  PACK      KEY8,URNUMBER         * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
.
          MOVE      ONE,CORRESID
          PACK      KEY20,URNUMBER,SAVVISIT,Z70
          CALL      RSOBPC1
          CALL      RPOBPC1              * Positions on last value
          BRANCH    OVRCD,NEWCOR50
          MATCH     URNUMBER,OBPCURNO
          GOTO      NEWCOR50 IF NOT EQUAL
          MATCH     SAVVISIT,OBPCCVIS
          GOTO      NEWCOR50 IF NOT EQUAL
          MOVE      OBPCCPID,CORRESID
          ADD       ONE,CORRESID
.
NEWCOR50  MOVE      CORRESID,OBPCCPID       * Correspondance ID
          MOVE      SAVVISIT,OBPCCVIS
          MOVE      URNUMBER,OBPCURNO
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD * Last update date
          REP       " 0",OBPCDTLU
          MOVE      CTIMEIS,OBPCTMLU        * Last Update time
.
          MOVE      WBSEUID,OBPCINUS        * Web User ID
          MOVE      WBSEUID,OBPCLUID        * Last Web User ID
          MOVE      ZERO,OBPCMDEL           * Delete indicator not set
.
          MATCH     SP70,CORSP001
          IF        @EQUAL
            CLOSE     TEMPFILE
            CLEAR     CORSP001
            APPEND    TEMPNAME,CORSP001
            APPEND    ".html",CORSP001
            RESET     CORSP001
          ENDIF
.
          SCAN      ".",CORSP001
          MOVE      CORSP001,OBPCFEXT
          RESET     CORSP001
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CORSFILE
          REP       " 0",CORSFILE
.
          READ      CONTROLF,NINTY1;*219,CWEBCLOC
          PACK      KEY4,CWEBCLOC
          CALL      RDOBPT1
          BRANCH    OVRCD,NEWCOR91
.
          MOVE      OBPTSLID,OBPCSLID       * Storage Location ID
          STRIP     OBPTSDIR
          GETENV    TBSPOOL,KEY80
          STRIP     KEY80
          STRIP     CORSP001
          PACK      CMDLINE,CMDFCHK,USERID,SP1,KEY80,SLASH,CORSP001,SP1,CORSFILE
          EXECUTE   CMDLINE,TASKID
          PACK      CMDLINE,CMDMOVE,KEY80,SLASH,CORSP001,SP1,OBPTSDIR,CORSFILE
          EXECUTE   CMDLINE,TASKID
.
          MOVE      CORSP002,OBPCINDT       * Input date
          REP       " 0",OBPCINDT
          MOVE      CORSP004,OBPCINTM       * Input time
          CALL      GETCTY00               * get type of correspondence
          MOVE      SP70,OBPCSLEV       * Security Level
          MOVE      SP70,OBPCCOM1       * Comment 1
          MOVE      SP70,OBPCCOM2       * Comment 2
          MOVE      SP70,OBPCCFRM       * From
          MOVE      SP70,OBPCCTOO       * To
          MOVE      SP70,OBPCUDF1       * User Def Code 1
          MOVE      SP70,OBPCUDF2       * User Def Code 2
          MOVE      SP70,OBPCUYN1       * User Def Y/N 1
          MOVE      SP70,OBPCUYN2       * User Def Y/N 2
          MOVE      SP70,OBPCUDD1       * User Def Date 1
          MOVE      SP70,OBPCUDD2       * User Def Date 2
          MOVE      SP70,OBPCACAT  *   Alert Category
          MOVE      SP70,OBPCACOD  *   Alert Code
          MOVE      SP70,OBPCCNTR  *   Alert Counter
.
          MOVE      SAVVISIT,OBPCCVIS
NEWCOR80  PACK      KEY12,OBPCCVIS,OBPCCPID
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROBPC1
          TRAPCLR   IO
          IF        OVRCD=1
            ADD       ONE,CORRESID
            MOVE      CORRESID,OBPCCPID     * Correspondance ID
            GOTO      NEWCOR80
          ENDIF
.
          PACK      KEY8,URNUMBER           * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
          MATCH     "1",PTMXSIN4
          IF        !@EQUAL
            PACK      KEY8,URNUMBER         * validate UR
            CALL      RLPTMAS1
            BRANCH    OVRCD,NEWCOR90,NEWCOR96
            MOVE      "1",PTMXSIN4
            CALL      UPMAST1
            CALL      UUPTMAS1
          ENDIF
          GOTO      NEWCOR99
.
NEWCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR93  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR94  MOVE      "Invalid File - ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR95  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No for UR - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR96  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR99  RETURN
+
.------------------------------------------------------------
. Get correspondence type - Category wi indicator 1=I Invoice
.------------------------------------------------------------
GETCTY00  MOVE      "wi",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
GETCTY10  CALL      RDKCODE1
          BRANCH    OVRCD,GETCTY90
.
          MATCH     CATEGORY,TCODE
          GOTO      GETCTY90 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      GETCTY10 IF EQUAL
.
          MATCH     ANSI,TCINDC1
          GOTO      GETCTY10 IF NOT EQUAL
          PACK      OBPCCTYP,ACODE
          GOTO      GETCTY99
.
GETCTY90  MOVE      SP70,OBPCCTYP
.
GETCTY99  RETURN
+
.------------------------------------------------------------
. Show Error Based on Call Type.  0=Page, 1=AJAX
.------------------------------------------------------------
SHWERR00
. IF        CALLTYPE=0
            CALL      WEBERR00
.         ELSE
.           CALL      AJXERR00
.         ENDIF
          RETURN
.-------------------------------------------------------------------------------
.     Payer breakdown is up to date must be equal to Keyin Backdate/Inv.To Date
.         only allow to raise invoice if no payer breakdown setup at all
.-------------------------------------------------------------------------------
IBRK0000  MOVE      ZERO,OVRCD
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,IBRK9000
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,IBRK9000
.
.         Check if all payer has the invoice breakdown setup
.
          MOVE      ZERO,F1
          MOVE      ZERO,F2
          MOVE      "  0",PMPBICNT
          PACK      KEY26,ADMISSNO,PMPBICNT,SP70
          CALL      RSPMPBR4
IBRK1000  CALL      RKPMPBR4
          BRANCH    OVRCD,IBRK8000
.
          MATCH     ADMISSNO,PMPBADMN
          GOTO      IBRK8000 IF NOT EQUAL
          MATCH     "  0",PMPBICNT          * Accommodation
          GOTO      IBRK8000 IF NOT EQUAL
.
.         Default payer will not have Invoice breakdown yet
.
          MATCH     "1",PMPBDEFT
          GOTO      IBRK1000 IF EQUAL
.
          MOVE      ONE,F1
          MOVE      SP70,PMIDINVN
          PACK      KEY25,ADMISSNO,PMPBCLTY,PMIDINVN,SP70
          CALL      RSPMIDE1
IBRK6000  CALL      RKPMIDE1
          BRANCH    OVRCD,IBRK7000
.
          MATCH     ADMISSNO,PMIDADMN
          GOTO      IBRK7000 IF NOT EQUAL
          MATCH     PMPBCLTY,PMIDCLTY
          GOTO      IBRK7000 IF NOT EQUAL
          MATCH     SP70,PMIDINVN
          GOTO      IBRK7000 IF NOT EQUAL
.
.         Payer breakdown must be up to date
.
          MOVE      ONE,F2
          MATCH     SP70,PMIDITDT
          IF        !@EQUAL
            MATCH     CHNGDATE,PMIDITDT           * check invoice todate
            GOTO      IBRK6000 IF EQUAL
          ENDIF
          GOTO      IBRK9000 
.
IBRK7000  COMPARE   ZERO,F2
          GOTO      IBRK9000 IF EQUAL             * No payer breakdown
.
          MOVE      ZERO,F1
          MOVE      ZERO,F2
          GOTO      IBRK1000
.
IBRK8000  COMPARE   ZERO,F1
          GOTO      IBRK8800 IF EQUAL
.
          COMPARE   ZERO,F2
          GOTO      IBRK9000 IF EQUAL             * No payer breakdown
.
IBRK8800  MOVE      ZERO,EXIT
          GOTO      IBRK9999
.
IBRK9000  MOVE      ONE,EXIT
IBRK9999  RETURN
+
.-------------------------------------------------------------------------
.         Tranfer any tobe invoiced comments to invoiced
.-------------------------------------------------------------------------
INVC0000  PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMICM1
          CALL      RKPMICM1
          BRANCH    OVRCD,INVC9999
          MATCH     ADMISSNO,PMICVISN      * Same visit no?
          GOTO      INVC9999 IF NOT EQUAL
          MATCH     SP70,PMICINVN
          GOTO      INVC9999 IF NOT EQUAL
.
          MOVE      CNEXTINV,PMICINVN
          PACK      PMICUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMICUDAT
          CLOCK     TIME,PMICUTIM                * System time
          MOVE      USERID,PMICUUID              * web user id
          CALL      UPPMICM1
          GOTO      INVC0000
.
INVC9999  RETURN
+
.------------------------------------------------------------
.         Check invoice comments
.------------------------------------------------------------
CINC0000  MOVE      ZERO,F1
          PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMICM1
          CALL      RKPMICM1
          BRANCH    OVRCD,CINC9000          * end of file
          MATCH     PMICVISN,ADMISSNO       * same Admission Number?
          GOTO      CINC9000 IF NOT EQUAL
.
          MATCH     SP70,PMICINVN
          GOTO      CINC9000 IF NOT EQUAL
          MOVE      ONE,F1
.
CINC9000  WRITE     HTMLFILE;F1;
CINC9999  RETURN
+
.-------------------------------------------------------------------------
.         Assign Action Plan
.-------------------------------------------------------------------------
ASAP0000  MATCH     "A",UPDTTYPE
          GOTO      ASAP1000 IF EQUAL
          MATCH     "U",UPDTTYPE
          GOTO      ASAP2000 IF EQUAL
          GOTO      ASAP9000
.
ASAP1000  CALL      APLN0000        * Get Future action for an Action plan
          MOVE      ZERO,EXIT
          GOTO      ASAP9999
.
ASAP2000  CALL      MAPL0000        * Modify Action Plan
          MOVE      ZERO,EXIT
          GOTO      ASAP9999
.
ASAP9000  MOVE      ONE,EXIT
ASAP9999  RETURN
+
.-------------------------------------------------------------------------
.         Modify Action Plan
.-------------------------------------------------------------------------
MAPL0000  MATCH     SP70,MODECODE
          GOTO      MAPL9999 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      "mr",KEY2
          PACK      KEY5,KEY2,MODECODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MAPL9999
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            MOVE      ONE,F1                * Suspend
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            MOVE      TWO,F1                * Reinstate
          ENDIF
.
          MATCH     "C",TCINDC1
          IF        @EQUAL
            MOVE      THREE,F1              * Cancel
          ENDIF
.
MAPL2000  PACK      KEY19,ADMISSNO,INITDATE,SP70
          CALL      RDSFACT1
MAPL2100  CALL      RDKFACT1
          BRANCH    OVRCD,MAPL9999
.
          MATCH     ADMISSNO,DFADMNO
          GOTO      MAPL9999 IF NOT EQUAL
.
          MOVE      INVOICEN,DIM8
          MATCH     DIM8,PTFCINVN            * Same invoice number?
          GOTO      MAPL2100 IF NOT EQUAL
.
          MOVE      "FA",KEY2
          PACK      KEY5,KEY2,FACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MAPL2100
          MATCH     "H",TCINDC1
          GOTO      MAPL3000 IF EQUAL
          MATCH     "B",TCINDC1
          GOTO      MAPL3000 IF EQUAL
          MATCH     "P",TCINDC1
          GOTO      MAPL2100 IF NOT EQUAL
.
MAPL3000  BRANCH    F1,MAPL4000,MAPL5000,MAPL6000
          GOTO      MAPL2100
.
.         Suspend, will update Future action records (TCINDC1=H,B or P) 
.         on or after the Initiate date as Suspended
.
MAPL4000  MOVE      "S",PTFCSTAT               * Suspended
          PACK      PTFCUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCUDAT
          CLOCK     TIME,PTFCUTIM
          MOVE      USERID,PTFCUUID
          CALL      UPFACT1
          GOTO      MAPL2100
.
.         Reinstate, will update Future Action records (TCINDC1=H,B or P)
.         on or after the Initiate date with status of Suspended to
.         a 'Normal' status
.
MAPL5000  MATCH     "S",PTFCSTAT
          GOTO      MAPL2100 IF NOT EQUAL
.
          MOVE      SP70,PTFCSTAT
          PACK      PTFCUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCUDAT
          CLOCK     TIME,PTFCUTIM
          MOVE      USERID,PTFCUUID
          CALL      UPFACT1
          GOTO      MAPL2100
.
.         Cancel, will remove Future Action records (TCINDC1=H,B or P)
.         on or after the Initiate date
.
MAPL6000  PACK      KEY19,FADMNO,FADATE,FACODE,SP70
          CALL      DEFACT1
          GOTO      MAPL2000
.
MAPL9999  RETURN
+
.-------------------------------------------------------------------------
.         Write Action plan if required 
.-------------------------------------------------------------------------
WACT0000  PACK      ACTNPLAN,ACTNPLAN,SP70
          CALL      ACTP0000                * Check Claim/HF future action
          IF        EXIT=0
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            MOVE      CNEXTINV,DIM8         * Invoice Number
            CALL      WFAC0000              * Write record to Future Action
          ENDIF
.
.         Check if we want to Activate Action Plan
.
          MATCH     "1",ACTNPLAN
          GOTO      WACT9999 IF NOT EQUAL
.
          MATCH     SP70,ACTNCODE
          GOTO      WACT9999 IF EQUAL
.
          MOVE      CNEXTINV,INVOICEN
          CALL      APLN0000              * Get Future action for an Action plan
.
WACT9999  RETURN
+
.-------------------------------------------------------------------------
.         Write Future Action for an Action plan
.-------------------------------------------------------------------------
APLN0000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,APLN9999
          CALL      RDVISA1
          BRANCH    OVRCD,APLN9999
.
          MOVE      INVOICEN,KEY8
          CALL      WPFA0000              * Write to patient action plan
          CALL      GFAP0000              * Get Future action for an Action plan
APLN9999  RETURN
+
.------------------------------------------------------------
. Check if Claim code or Health Fund Action plan is set
.------------------------------------------------------------
ACTP0000  MOVE      ZERO,EXIT
.
.         Future Action will be created if Action plan is initiated when 
.         printing Patient Only Invoice
.
          IF        IPATFLAG=1 | IPATFLAG=2
            MATCH     "1",ACTNPLAN
            GOTO      ACTP9000 IF NOT EQUAL 
          ENDIF
.
          MATCH     SP70,AFUNDH
          GOTO      ACTP2000 IF EQUAL      * check claim code future action code
.
.         Only create HF future action if there is a HF portion in the invoice
.
          IF        IPATFLAG=1 | IPATFLAG=2
            COMPARE   ZERO,PINVREB
            GOTO      ACTP2000 IF EQUAL
          ENDIF
.
.         Check for Health fund future action
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,ACTP2000
          BRANCH    PHFTACT,ACTP2000       * if code is inactive,ignore
.
          MATCH     SP70,PTHFFACD
          GOTO      ACTP2000 IF EQUAL      * blank future action code
.
          MOVE      PTHFFACD,FUTRACTN      * Health Fund Future action code
          MOVE      PTHFNDFP,PAYMDAYS      * No of days for payment
          MOVE      PTHFOCGR,GROUPCOD      * Occupational Group
          GOTO      ACTP9999
.
.         Check for Claim code future action
.
ACTP2000  MOVE      ACLAIM,KEY3
          CALL      RDPTCFA1
          BRANCH    OVRCD,ACTP9000
          MATCH     SP70,PTCFFACD
          GOTO      ACTP9000 IF EQUAL      * blank future action code
.
          MOVE      PTCFFACD,FUTRACTN      * Claim Code future action code
          MOVE      ZERO,PAYMDAYS
          SQUEEZE   PTCFNDFP
          MOVE      PTCFNDFP,PAYMDAYS      * No of days for payment
          MOVE      PTCFOCGR,GROUPCOD      * Occupational Group
          GOTO      ACTP9999
.
ACTP9000  MOVE      ONE,EXIT
ACTP9999  RETURN
+
.-------------------------------------------------------------------------
.         Write record to Patient Future Action plan
.-------------------------------------------------------------------------
WPFA0000  CALL      RDPTPFA1
          COMPARE   ZERO,OVRCD
          GOTO      WPFA2000 IF EQUAL
.
          MOVE      KEY8,PTPFINVN                 * Invoice Number
          MOVE      INITDATE,PTPFIFDT             * Initiate From date
          PACK      PTPFPLAN,ACTNCODE,SP70        * Action Plan code
          MOVE      WBSEUID,PTPFWEBC              * Web user id created
          PACK      PTPFDATC,CCC,CYY,CMM,CDD
          REP       " 0",PTPFDATC                 * Date created
          CLOCK     TIME,PTPFTIMC                 * Time created
          UNPACK    SP70,PTPFSTAT,PTPFMODR,PTPFWEBU,PTPFDATU,PTPFTIMU
          MOVE      SP70,PTPFSPAR
          CALL      WRPTPFA1
          GOTO      WPFA9999
.
WPFA2000  MOVE      INITDATE,PTPFIFDT             * Initiate From date
          PACK      PTPFPLAN,ACTNCODE,SP70        * Action Plan code
          MOVE      WBSEUID,PTPFWEBU              * Web user id updated
          PACK      PTPFDATU,CCC,CYY,CMM,CDD
          REP       " 0",PTPFDATU                 * Date updated
          CLOCK     TIME,PTPFTIMU                 * Time updated
          CALL      UPPTPFA1
.
WPFA9999  RETURN
.
.-------------------------------------------------------------------------
.         Activate an Action plan
.-------------------------------------------------------------------------
GFAP0000  PACK      KEY6,ACLAIM,ACTNCODE,SP70
          CALL      RDPTFAP1
          BRANCH    OVRCD,GFAP9999
.
          MOVE      ZERO,F2
GFAP1000  ADD       ONE,F2
          COMPARE   TEN1,F2
          GOTO      GFAP9999 IF NOT LESS
.
          MOVE      SP70,FUTRACTN           * future action code
          LOAD      FUTRACTN,F2,PTFPFAC1,PTFPFAC2,PTFPFAC3,PTFPFAC4,PTFPFAC5:
                            PTFPFAC6,PTFPFAC7,PTFPFAC8,PTFPFAC9,PTFPFAC0
          MATCH     SP70,FUTRACTN
          GOTO      GFAP1000 IF EQUAL
.
          MOVE      SP70,KEY3           * days from initiate date
          LOAD      KEY3,F2,PTFPDFA1,PTFPDFA2,PTFPDFA3,PTFPDFA4,PTFPDFA5:
                            PTFPDFA6,PTFPDFA7,PTFPDFA8,PTFPDFA9,PTFPDFA0
          MATCH     SP70,KEY3
          GOTO      GFAP1000 IF EQUAL
          MOVE      ZERO,PAYMDAYS
          SQUEEZE   KEY3
          MOVE      KEY3,PAYMDAYS      * No of days for initiate date
.
          MOVE      SP70,GROUPCOD
          LOAD      GROUPCOD,F2,PTFPOCG1,PTFPOCG2,PTFPOCG3,PTFPOCG4,PTFPOCG5:
                                PTFPOCG6,PTFPOCG7,PTFPOCG8,PTFPOCG9,PTFPOCG0
.
          MOVE      INITDATE,KEY8       * Initialiate from date
          MOVE      INVOICEN,DIM8       * Invoice number
          CALL      WFAC0000            * Write record to Future Action
          GOTO      GFAP1000
.
GFAP9999  RETURN
+
.-------------------------------------------------------------------------
.         Write record to Future Action file
.-------------------------------------------------------------------------
WFAC0000  CALL      SFDT0000               * Set future action date
          MOVE      KEY8,FADATE
          MOVE      FUTRACTN,FACODE
.
          PACK      KEY19,ADMISSNO,FADATE,FACODE,SP70
          CALL      RDFACT1
          BRANCH    OVRCD,WFAC3000
.
          MOVE      GROUPCOD,PTFCOCGR      * Occupational group
          PACK      PTFCUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCUDAT
          CLOCK     TIME,PTFCUTIM
          MOVE      USERID,PTFCUUID
          CALL      UPFACT1
          GOTO      WFAC9999
.
WFAC3000  UNPACK    KEY19,DFADMNO,FADATE,FACODE
          MOVE      DFADMNO,FADMNO         * Admission Number
          MOVE      SP70,FACOMM            * Comments
          MOVE      PVIURNO,PTFCURNO       * U/R number
          MOVE      SP70,PTFCDTCP          * Date completed
          MOVE      GROUPCOD,PTFCOCGR      * Occupational group
          MOVE      AFUNDH,PTFCHFND        * Health Fund
          MOVE      SP70,PTFCSTAT          * Status
          MOVE      DIM8,PTFCINVN          * Invoice number
          PACK      PTFCCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTFCCDAT
          CLOCK     TIME,PTFCCTIM
          MOVE      USERID,PTFCCUID
          MOVE      SP70,PTFCUDAT
          MOVE      SP70,PTFCUTIM
          MOVE      SP70,PTFCUUID
          MOVE      SP70,PTFCSPAR
          CALL      WRFACT1
.
WFAC9999  RETURN
+
.-------------------------------------------------------------------------
.         Set up the future date
.-------------------------------------------------------------------------
SFDT0000  UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       PAYMDAYS,JULDAY
.
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      KEY8,CC,YY,MM,DD
          REP       " 0",KEY8
SFDT9999  RETURN
+
.-------------------------------------------------------------------------
. Flag Receipt Indicator to be excluded when printing Patient Only Invoice
.-------------------------------------------------------------------------
FLRECP00  CALL      XMLHED00
          BRANCH    EXIT,FLRECP99
.
FLRECP10  PACK      KEY17,RECEIPTN,RECTRNNO,SP70
          CALL      RDRCDTE1
          BRANCH    OVRCD,FLRECP90
.
          MATCH     "1",CHECKBOX
          IF        @EQUAL
            MOVE      "9",RCDTSFLG         * flag to temporary exclude payment
          ELSE
            MOVE      SP70,RCDTSFLAG
          ENDIF
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE1
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Update Complete":
                             "</RETURN_VALUE>"
          GOTO      FLRECP95
.
FLRECP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Receipt":
                             "</RETURN_VALUE>"
.
FLRECP95  CALL      XMLEND00
.
FLRECP99  RETURN
+
.-------------------------------------------------------------------------
.   Check for ICD10 Suggested Classification
.-------------------------------------------------------------------------
ICDCLS00  CALL      XMLHED00
          BRANCH    EXIT,ICDCLS99
          MOVE      SP70,PMSGCLSS
          MOVE      ADMISSNO,AADMNO
          CALL      ISUG0000           * Check if ICD10 Sugg.Class.required
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             INVBFLAG,"|",PMSGCLSS,"|":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
ICDCLS99  RETURN
+
.------------------------------------------------------------
.         Print Estimate Invoice
.------------------------------------------------------------
ESTINV00  MOVE      ZERO,EXIT
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,ESTINV85
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,ESTINV85
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,ESTINV80
.
          MOVE      ONE,WEBFLAG
          MOVE      ONE,PROGFLAG
          MOVE      ZERO,JHFLAG
          MOVE      ZERO,REVBFLAG
          MOVE      ZERO,DBSFLAG
.
          CLOSE     PMSMTIA1
          CLOSE     PMSMTIA4
.
          IF        CFEETYP=9
            OPEN      PMSMTIA1,"pmsmteaf"
            OPEN      PMSMTIA4,"pmsmteaf"
          ENDIF
          MOVE      ONE,ESTFLAG                    * flag for Estimate invoice
          CALL      CALCTBI                        * Work out invoice date range
.
          COMPARE   ZERO,TOTDAYS
          GOTO      ESTINV70 IF NOT EQUAL
          COMPARE   ZERO,GROSSTOT
          GOTO      ESTINV80 IF EQUAL
.
ESTINV70  CALL      OPNPRINT
          MOVE      CHNGDATE,BACKDATE
          MOVE      FIVE,PROGFLAG                  * print invoice (no update)
          MOVE      ZERO,ERRFLAG
          MOVE      ZERO,IPASS
          CALL      PRNTINV1
          BRANCH    ERRFLAG,PRTINV82,PRTINV83,PRTINV84
          BRANCH    EXIT,ESTINV90
          CALL      CLSPRINT
          GOTO      ESTINV88
.
ESTINV80  MOVE      "No Invoice details to be printed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ESTINV90
.
ESTINV85  PACK      WEBTITLE,SP70
          CLEAR     WEBTITLE
          MOVE      "Missing Master/Visit record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ESTINV90
.
ESTINV88  MOVE      ZERO,EXIT
ESTINV90  CLOSE     PMSMTIA1
          CLOSE     PMSMTIA4
          MOVE      ZERO,PROGFLAG
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          MOVE      ZERO,ESTFLAG
ESTINV99  RETURN
+
.------------------------------------------------------------
.  GST
.------------------------------------------------------------
SGST0000  BRANCH    FLDITMNO,SGST1000,SGST2000,SGST3000
          GOTO      SGST9999
.
SGST1000  CALL      UGST0000               * Unknown GST List
          GOTO      SGST9999
.
SGST2000  CALL      NXTG0000               * Next Unknown GST screen
          GOTO      SGST9999
.
SGST3000  CALL      PREG0000               * Previous Unknown GST screen
          GOTO      SGST9999
.
SGST9999  RETURN
+
.------------------------------------------------------------
.  Unknown GST
.------------------------------------------------------------
UGST0000  IF        NORECORD=0
            MOVE    "10",NORECORD         * Number of records=0 Default to 10
          ENDIF
.
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY8,SP70             * read through Unknown GST file
          CALL      RSPTGTU1
UGST1000  CALL      RKPTGTU1
          BRANCH    OVRCD,UGST9999
.
          PACK      KEY8,DPTGTADM         * validate admission number
          CALL      RDMISS1
          BRANCH    OVRCD,UGST1000
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UGST1000
          CALL      RDPMPX21
          BRANCH    OVRCD,UGST1000
.
.         MOVE      ZERO,NETTOT
.         MOVE      ONE,PROGFLAG
.         CALL      CALCTBI
.         COMPARE   ZERO,NETTOT           * Check for outstanding amount
.         GOTO      UGST1000 IF EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      UGST1000
          ENDIF
.
          CALL      PATNAA00             * setup patient name
.
          MOVE      "Unknown",ACCMGST
.
.         Check if accommodation GST code is really unknown, use admission file
.
          MATCH     "U",PTMIGSTA
          IF        !@EQUAL
            MOVE      "-",ACCMGST        * not unknown
          ENDIF
.
.         Check if any item has unknown GST Code, use patdtr file
.
          MOVE      "Unknown",ITMNGST
          CALL      CDTR0000
          IF        EXIT=0
            MOVE      "-",ITMNGST         * no unknown item gst code
          ENDIF
.
          MATCH     "-",ACCMGST
          IF        @EQUAL
            MATCH     "-",ITMNGST
            GOTO      UGST1000 IF EQUAL   * can't find any Unknown Accm/Item GST
          ENDIF
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS
          ENDIF
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          MOVE      "patweb98",KEY8
          WRITE     HTMLFILE;"<tr><td><a HREF = 'javascript:linkPatient":
                             "(#"",KEY8:
                             ".pbl?reportno=01":
                             "&template=002":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "#");'><img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MATCH     SP70,KEY20
            IF        !@EQUAL
              WRITE     HTMLFILE;KEY20,"</td>";
            ELSE
              WRITE     HTMLFILE;PURNO,"</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;URNUMBER,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>",ADMISSNO,"</td>":
                             "<td>",PATFNAME,"</td>";
.
          MATCH     "-",ACCMGST
          GOTO      UGST3000 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          MOVE      "patweb71",KEY8
          WRITE     HTMLFILE;"<td><a HREF = 'javascript:UpdatAGST":
                             "(#"",KEY8:
                             ".pbl?reportno=03":
                             "&template=002":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "#");'><img src=../images/EditIcon.gif":
                             " class=ListIcon></a>":
                             ACCMGST,"</td>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      UGST3200
.
UGST3000 
          WRITE     HTMLFILE;"<td>",ACCMGST,"</td>";
.
UGST3200  MATCH     "-",ITMNGST
          GOTO      UGST4000 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          MOVE      "patweb71",KEY8
          WRITE     HTMLFILE;"<td><a HREF = 'javascript:UpdatMGST":
                             "(#"",KEY8:
                             ".pbl?reportno=03":
                             "&template=003":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "#");'><img src=../images/EditIcon.gif":
                             " class=ListIcon></a>":
                             ITMNGST,"</td></tr>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      UGST4200
.
UGST4000
          WRITE     HTMLFILE;"<td>",ITMNGST,"</td></tr>";
.
UGST4200  ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      UGST1000 IF NOT EQUAL
.
UGST9999  RETURN
+
.------------------------------------------------------------
.      Unknown MBS/Misc.GST Code
.------------------------------------------------------------
CDTR0000  MOVE      ZERO,EXIT
          PACK      KEY14,DPTGTADM,SP70
          CALL      RSPMMTI1
CDTR1000  CALL      RKPMMTI1
          BRANCH    OVRCD,CDTR9999
.
          MATCH     DPTGTADM,PMMIVISN
          GOTO      CDTR9999 IF NOT EQUAL
.
          COMPARE   TWO,PMMIGSTA
          GOTO      CDTR1000 IF NOT EQUAL       * not unknown GST
.
          MOVE      ONE,EXIT                    * Found unknown gst item
CDTR9999  RETURN
+
.*****************************************************************************
.*            Link to Next Group of GST screen                               *
.*****************************************************************************
NXTG0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb71.pbl":
                                 "?reportno=03":
                                 "&template=001":
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
NXTG9999  RETURN
+
.*****************************************************************************
.*             Link to Previous Group of GST Screen                          *
.*****************************************************************************
PREG0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
.
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      "01",F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"patweb71.pbl":
                             "?reportno=03":
                             "&template=001":
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO;
          MOVE      F3,KEY3
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
PREG9999  RETURN
+
.------------------------------------------------------------
.      Allocating GST Code
.------------------------------------------------------------
MGST0000  BRANCH    FLDITMNO,MGST1000,MGST2000:
                             MGST3000,MGST4000,MGST5000:
                             MGST6000,MGST7000
          GOTO      MGST9999
.
MGST1000  MOVE      PTMIGSTA,DIM1
          CALL      GSTA0000           * GST applicable 
          GOTO      MGST9999
.
MGST2000  CALL      MISC0000           * Misc/MBS GST List
          GOTO      MGST9999
.
MGST3000  WRITE     HTMLFILE;PMMIITEM;
          GOTO      MGST9999
.
MGST4000  WRITE     HTMLFILE;PMMIDESC;
          GOTO      MGST9999
.
MGST5000  MOVE      PMMIGSTA,DIM1
          CALL      GSTA0000             * GST applicable?
          GOTO      MGST9999
.
MGST6000  CALL      KYGC0000             * Keyin GST Code 
          GOTO      MGST9999
.
MGST7000  WRITE     HTMLFILE;TRANSCNO;
          GOTO      MGST9999
.
MGST9999  RETURN
+
.------------------------------------------------------------
.      GST Applicable
.------------------------------------------------------------
GSTA0000  UNPACK   DIM127,D1,KEY1,DIM127
          MOVE     ZERO,F1
          MOVE     KEY1,F1
          BRANCH   F1,GSTA1000,GSTA2000,GSTA3000
          WRITE    HTMLFILE;PMMIGSTA;
          GOTO     GSTA9999
.
GSTA1000  MOVE     "Unknown ",KEY8
          WRITE    HTMLFILE;KEY8;
          GOTO     GSTA9999
.
GSTA2000  WRITE    HTMLFILE;"<option value=",ANSU," selected>":
                            "Unknown</option>":
                            "<option value=",ANSY,">":
                            "Yes</option>":
                            "<option value=",ANSN,">":
                            "No</option>";
          GOTO     GSTA9999
.
GSTA3000  MATCH     "Y",DIM1
          IF        @EQUAL
            WRITE    HTMLFILE;"<option value=",ANSU,">":
                              "Unknown</option>":
                              "<option value=",ANSY," selected>":
                              "Yes</option>":
                              "<option value=",ANSN,">":
                              "No</option>";
          ELSE
            MATCH      "N",DIM1
            IF         @EQUAL
              WRITE    HTMLFILE;"<option value=",ANSU,">":
                              "Unknown</option>":
                              "<option value=",ANSY,">":
                              "Yes</option>":
                              "<option value=",ANSN," selected>":
                              "No</option>";
            ELSE
              WRITE    HTMLFILE;"<option value=",ANSU," selected>":
                              "Unknown</option>":
                              "<option value=",ANSY,">":
                              "Yes</option>":
                              "<option value=",ANSN,">":
                              "No</option>";
            ENDIF
          ENDIF
GSTA9999  RETURN
+
.------------------------------------------------------------
.      Keyin GST Code
.------------------------------------------------------------
KYGC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,KYGC1200,KYGC1400
          WRITE     HTMLFILE;PMMIGSTC;
          GOTO      KYGC9999
.
KYGC1200  PACK      KEY6,PMMIGSTC
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ELSE
            WRITE     HTMLFILE;PMMIGSTC;
          ENDIF
          GOTO      KYGC9999
.
.   Display Selection List for GST code
.
KYGC1400  PACK      KEY6,SP70
          CALL      RSIBGS1
KYGC1425  CALL      RKIBGS1 
          BRANCH    OVRCD,KYGC9999
.
          MATCH     IBGSCODE,PMMIGSTC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      KYGC1425
.
KYGC9999  RETURN
+
.------------------------------------------------------------
.      Unknown MBS/Misc.GST Code
.------------------------------------------------------------
MISC0000  PACK      KEY14,ADMISSNO,SP20
          CALL      RSPMMTI1
MISC1000  CALL      RKPMMTI1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      MISC9999 IF NOT EQUAL
.
          COMPARE   TWO,PMMIGSTA
          GOTO      MISC1000 IF NOT EQUAL        * not unknown GST
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          MOVE      "00000000",TREF
          MOVE      "patweb71",KEY8
          WRITE     HTMLFILE;"<tr><td><a HREF = 'javascript:ItemTrns":
                             "(#"",KEY8:
                             ".pbl?reportno=03":
                             "&template=004":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&invoicno=",TREF:
                             "&transcno=",PMMITRAN:
                             "#");'><img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon></a>";
.
          MOVE      "Unknown ",KEY8
          WRITE     HTMLFILE;PMMIITEM,"</td>":
                             "<td>",PMMIDESC,"</td>":
                             "<td>",KEY8,"</td>";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      MISC1000
.
MISC9999  RETURN
+
.------------------------------------------------------------
. ADMT000 - field for Patient status adjusments screen
.------------------------------------------------------------
ADMT0000  BRANCH    FLDITMNO,ADMT0100,ADMT0200,ADMT0300,ADMT0400,ADMT0500:
                             ADMT0600,ADMT0700,ADMT0800,ADMT0900,ADMT1000:
                             ADMT1100,ADMT1200,ADMT1300,ADMT1400,ADMT1500
          GOTO      ADMT9999
.
ADMT0100  CALL      LTRN0000            * List of Transfer records 
          GOTO      ADMT9999
.
ADMT0200  CALL      CDATE000            *Transfer out date
          GOTO      ADMT9999
.
ADMT0300  CALL      CTIME000            *Transfer out time
          GOTO      ADMT9999
.
ADMT0400  CALL      LTRD0000            *Last Transfer Date
          GOTO      ADMT9999
.
ADMT0500  CALL      LTRT0000            *Last Transfer Time 
          GOTO      ADMT9999
.
ADMT0600  CALL      DATSEL00            * Date selection from Admis to Curr
          GOTO      ADMT9999
.
ADMT0700  WRITE     HTMLFILE;ADATE;
          GOTO      ADMT9999
.
ADMT0800  WRITE     HTMLFILE;DDATE;
          GOTO      ADMT9999
.
ADMT0900  MOVE      ONE,PROGFLAG
          CALL      CALCTBI        * calculate the estimate fund rebate amount
          WRITE     HTMLFILE;REBTOT;
          GOTO      ADMT9999
.
ADMT1000  WRITE     HTMLFILE;ITEMCODE;
          GOTO      ADMT9999
.
ADMT1100  MATCH     SP70,ITEMCODE
          GOTO      ADMT9999 IF EQUAL
          PACK      CURDATE8,CCC,CYY,CDD,CMM  * Default to current date
          MATCH     SP8,TRANDATE                                      *I-119158
          IF        !@EQUAL
            MOVE      TRANDATE,CURDATE8
          ENDIF
          REP       " 0",CURDATE8
.
          IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,ITEMCODE,CURDATE8,SP70
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,ITEMCODE,CURDATE8,SP70
          ENDIF
.
          CALL      PATMCHRE                * read Misc.Charges file (one test)
          COMPARE   ZERO,EXIT
          GOTO      ADMT1150 IF EQUAL
.
          GOTO      ADMT9999
.
ADMT1150  WRITE     HTMLFILE;MDESC;
          GOTO      ADMT9999
.
ADMT1200  WRITE     HTMLFILE;TRANDATE;
          GOTO      ADMT9999
.
ADMT1300  WRITE     HTMLFILE;TRANTIME;
          GOTO      ADMT9999
.
ADMT1400  WRITE     HTMLFILE;TRNTOWRD;
          GOTO      ADMT9999
.
ADMT1500  WRITE     HTMLFILE;TRNTOBED;
          GOTO      ADMT9999
.
ADMT9999  RETURN
+
.------------------------------------------------------------
. List of transfer records
.------------------------------------------------------------
LTRN0000  COMPARE   FIVE,CFEETYP
          GOTO      LTRN0600 IF EQUAL       * SX
.
          COMPARE   ZERO,CFEETYP            * Using bed fees
          GOTO      LTRN9999 IF NOT EQUAL   * no
.
LTRN0600  MOVE      SP70,KEY10
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
LTRN1000  CALL      RDKTRAN2
          BRANCH    OVRCD,LTRN9999
          MATCH     ADMISSNO,DTADMN
          GOTO      LTRN9999 IF NOT EQUAL
.
          MATCH     "A",TMOVE
          GOTO      LTRN3000 IF EQUAL
          MATCH     "C",TMOVE
          GOTO      LTRN4000 IF EQUAL
          MATCH     "D",TMOVE
          GOTO      LTRN5000 IF EQUAL
          MATCH     "L",TMOVE
          GOTO      LTRN6000 IF EQUAL
          MATCH     "R",TMOVE
          GOTO      LTRN7000 IF EQUAL
          GOTO      LTRN1000
.
LTRN3000  MOVE      "Admit     ",KEY10
          GOTO      LTRN8000
.
LTRN4000  MOVE      "Change    ",KEY10
          GOTO      LTRN8000
.
LTRN5000  MOVE      "Discharged",KEY10
          GOTO      LTRN8000
.
LTRN6000  MOVE      "Leave ",KEY10
          MOVE      ZERO,PTTRADPT
          MOVE      ZERO,PTTRADRB
          MOVE      ZERO,TRATEF
          MOVE      ZERO,TRATEH
          MOVE      ZERO,TDISC
          GOTO      LTRN8000
.
LTRN7000  MOVE      "Return    ",KEY10
.
LTRN8000  ADD       TRATEF,PTTRADPT
          ADD       TRATEH,PTTRADRB
.
          MOVE      PTTRADPT,FORM82
          ADD       TEXTRA,FORM82
          SUB       TDISC,FORM82
.         SUB       TALLW,FORM82
.
          PACK      KEY7,SP10
          PACK      KEY7,TWARD,SLASH,TBED
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr><td>":
                           CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                           "<td>",TTIME,"&nbsp;</td>":
                           "<td>",KEY7,"&nbsp;</td>":
.                          "<td width=12% align=right>",PTTRADPT,"&nbsp;</td>":
.                          "<td width=12% align=right>",TDISC,"&nbsp;</td>":
.                          "<td width=12% align=right>",FORM82,"&nbsp;</td>":
.                          "<td width=12% align=right>",PTTRADRB,"&nbsp;</td>":
                           "<td width=12%>",KEY10,"&nbsp;</td></tr>"
          GOTO      LTRN1000
.
LTRN9999  RETURN
+
.------------------------------------------------------------
. Calculate different option dates for bed transfer date. 
.------------------------------------------------------------
CDATE000  CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          IF        ASTAT=3
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          ENDIF
          MOVE      ZERO,FAILCNT
.
CDATE100  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     ADATE,KEY8
          GOTO      CDATE999 IF LESS   
.
          ADD       ONE,FAILCNT
          MATCH     TODAY,KEY8
          IF        @EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                                MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE                                              
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                                 MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ENDIF
.
          MOVE      "-1",ADJDAYS
          CALL      ADJDAT00
          IF        FAILCNT<180
            GOTO      CDATE100
          ENDIF
.
..CDATE200  MOVE      CMON,F2
..          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
..          WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
..                               MTHNAM3,SP1,CCENT,CYEAR,"</option>";
.
CDATE999  RETURN
.------------------------------------------------------------
. Last bed transfer date 
.------------------------------------------------------------
LBTD0000  MOVE      ADMISSNO,KEY8
          PACK      KEY30,KEY8,Z70 
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LBTD9999
.
          MATCH     ADMISSNO,TADMN
          GOTO      LBTD9999 IF NOT EQUAL
.
LBTD9999  RETURN
.------------------------------------------------------------
. Calculate different option times for bed transfer time. 
.------------------------------------------------------------
CTIME000  CALL      IBACLOCK
          MOVE      CTIMEIS,TRANTIME
          WRITE     HTMLFILE;TRANTIME;
.
CTIME999  RETURN
.------------------------------------------------------------
.   Calculate the last bed transfer date
.------------------------------------------------------------
LTRD0000  CALL      LBTD0000
          CALL      IBACLOCK
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
LTRD9999  RETURN      
.------------------------------------------------------------
.   Calculate the last bed transfer time
.------------------------------------------------------------
LTRT0000  CALL      LBTD0000
          MOVE      TTIME,KEY5
          WRITE     HTMLFILE;KEY5;
.
LTRT9999  RETURN      
.
.------------------------------------------------------------
. Date selection from Admission Date to Current Date
.------------------------------------------------------------
DATSEL00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,DATSEL99
.             
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,FAILCNT
.
          MOVE      SP10,DDATE
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD<>1
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
DATSEL10  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     ADATE,KEY8
          GOTO      DATSEL99 IF LESS   
.
          ADD       ONE,FAILCNT
          MATCH     TODAY,KEY8
          IF        @EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                                MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE                                              
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                                 MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ENDIF
.
          MOVE      "-1",ADJDAYS
          CALL      ADJDAT00
          IF        FAILCNT<150
            GOTO      DATSEL10
          ENDIF
DATSEL99  RETURN 
+
.------------------------------------------------------------
. Bed fees and Casepayment stepdown
.------------------------------------------------------------
STDW0000  BRANCH    FLDITMNO,STDW0100,STDW0200,STDW0300,STDW0400,STDW0500:
                             STDW0600,STDW0700,STDW0800,STDW0900,STDW1000:
                             STDW1100,STDW1200,STDW1300,STDW1400,STDW1500:
                             STDW1600,STDW1700,STDW1800,STDW1900,STDW2000:
                             STDW2100,STDW2200,STDW2300,STDW2400,STDW2500:
                             STDW2600,STDW2700,STDW2800,STDW2900,STDW3000:
                             STDW3100,STDW3200,STDW3300,STDW3400,STDW3500:
                             STDW3600,STDW3700,STDW3800,STDW3900,STDW4000:
                             STDW4100,STDW4200,STDW4300,STDW4400,STDW4500:
                             STDW4600,STDW4700,STDW4800
          GOTO      STDW9999
.
.         Check for Admission bed fees
.
STDW0100  MOVE      ZERO,F1
          UNPACK    DIM127,DIM1,KEY1,DIM127
          PACK      KEY1,KEY1,SP70
          MOVE      KEY1,F1
.
          COMPARE   ZERO,F1
          GOTO      STDW0102 IF EQUAL
.
          BRANCH    F1,STDW0104
          GOTO      STDW0110
.
STDW0102  COMPARE   ONE,CMIXFLAG
          GOTO      STDW0110 IF NOT EQUAL
.
STDW0104  CALL      DSCP0000             * Display Casepayment heading
          GOTO      STDW9999
.
STDW0110  CALL      DSBF0000             * Display bed fees heading
          GOTO      STDW9999
.
STDW0200  MOVE      ZERO,F1
          UNPACK    DIM127,DIM1,KEY1,DIM127
          PACK      KEY1,KEY1,SP70
          MOVE      KEY1,F1
          COMPARE   ZERO,F1
          GOTO      STDW0210 IF NOT EQUAL
          COMPARE   ONE,CMIXFLAG
          GOTO      STDW0210 IF NOT EQUAL
.
          MOVE      "0",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get daily Casepayment rate
          CALL      LSRT0000
          MOVE      "1",KEY1
          PACK      DIM127,SP1,KEY1,SP70
          CALL      GTCP0000              * Get Additional Casepayment rate
          CALL      LSRT0000
          GOTO      STDW9999
.
STDW0210  MOVE      ZERO,CMIXFLAG             * Admission bed fees
          IF        CFEETYP=5
            CALL      NZRT0000                * Get NZ bed fees
          ELSE
            MOVE      SP70,PMSGCLSS
            MOVE      ADMISSNO,AADMNO
            CALL      ISUG0000           * Check if ICD10 Sugg.Class.required
            IF        INVBFLAG=0
              MOVE      PMSGCLSS,SAVATYP
              MOVE      PMSGCLSS,ATYPE
            ENDIF
            MOVE      ADATE,CEFFDATE
            PACK      KEY9,ACLAIM,AFUNDH
            CALL      GETCNEFF               * Get Contract Effective From
            IF        EXIT=1
              WRITE     HTMLFILE;"<tr><td><font color=red>Bed Fee Not Set Up -":
                        " Contract Effective Detail not found. </td></tr>";
              GOTO      STDW9999
            ENDIF
            MOVE      ZERO,BFECOLNO
            CALL      GRAT0000               * generate rate
.
            IF        CHOSTYP=1
              IF        SDOWNFLG=1
                MATCH    BFECONTR,CONTRCID
                IF       !@EQUAL
                  MOVE      BFECONTR,CONTRCID
                  MATCH     ADATE,DDATE
                  IF        @EQUAL
                    WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                  "<td><b><font color=red>Check Bed Fees, ":
                                  "Daycase Rates not set up! ":
                              "Overnight rates will be applied.</b></td></tr>";
                  ELSE
                    WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                                  "<td><b><font color=red>Check Bed Fees, ":
                                  "Overnight Rates not set up! ":
                                "Default rates will be applied. </b></td></tr>";
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      DEFCOLNO,BFECOLNO
            MOVE      DEFCOLAD,ADDCOLNO
            CALL      GTRT0000                * Get bed fees
          ENDIF
.
          IF        NOFEE=1
            WRITE     HTMLFILE;"<tr><td><font color=red>No Bed Fee details,":
                      "Default not set up yet !! </td></tr>";
            GOTO      STDW9999
          ENDIF
.
          IF        CFEETYP=0
            CALL      DFER0000              * Display bed fee for each column
            MOVE      DEFCOLNO,BFECOLNO
          ELSE
            CALL      DSFE0000              * Display bed fee
          ENDIF
.
          GOTO      STDW9999
.
STDW0300  CALL      ASAT0000                * Display as at bed days
          GOTO      STDW9999
.
STDW0400  CALL      NBTP0000                * New Bed type
          GOTO      STDW9999
.
STDW0500  CALL      DFCL0000                * range of column no for  bed fees
          GOTO      STDW9999
.
STDW0600  CALL      BFEE0000                * bed fees amount
          GOTO      STDW9999
.
STDW0700  CALL      DISC0000                * Change bed fees discount
          GOTO      STDW9999
.
STDW0800  CALL      ALLW0000                * Change bed fees allowance
          GOTO      STDW9999
.
STDW0900  CALL      DCOL0000                * Default column no for bedfee/daily
          GOTO      STDW9999
.
STDW1000  CALL      CFEE0000                * type of daily charge file
          GOTO      STDW9999
.
STDW1100  CALL      CHDT0000                * Change date
          GOTO      STDW9999
.
STDW1200  CALL      CHTM0000                * Change time
          GOTO      STDW9999
.
STDW1300  CALL      NPAT0000                * New patient portion amount
          GOTO      STDW9999
.
STDW1400  CALL      NREB0000                * New rebate portion amount
          GOTO      STDW9999
.
STDW1500  CALL      NEND0000                * New end day range
          GOTO      STDW9999
.
STDW1600  CALL      DAYT0000                * Daily total fee
          GOTO      STDW9999
.
STDW1700  CALL      DBTP0000                * Bed type
          GOTO      STDW9999
.
STDW1800  CALL      GCSM0000               * Check Casemix rate
          BRANCH    EXIT,STDW9999
          CALL      DSRT0000                * Display casepayment rate heading
          GOTO      STDW9999
.
STDW1900  CALL      LSRT0000                * Display casepayment rate
          GOTO      STDW9999
.
STDW2000  CALL      CPLP0000                * Casepayment Lumpsum amount
          GOTO      STDW9999
.
STDW2100  CALL      DFDA0000                * range of column no for daily rate
          GOTO      STDW9999
.
STDW2200  CALL      DFAD0000                * range of column for add.rate
          GOTO      STDW9999
.
STDW2300  CALL      DFEE0000                * daily fees
          GOTO      STDW9999
.
STDW2400  CALL      AFEE0000                * additional fees
          GOTO      STDW9999
.
STDW2500  CALL      DTOT0000                * casemix daily total
          GOTO      STDW9999
.
STDW2600  CALL      NAND0000                * New additional end day range
          GOTO      STDW9999
.
STDW2700  CALL      NDAY0000                * new daily rate
          GOTO      STDW9999
.
STDW2800  CALL      ADAY0000                * new additional rate
          GOTO      STDW9999
.
STDW2900  MATCH     SP10,ACLAIM
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;ACLAIM;        * Claim code           
          GOTO      STDW9999
.
STDW3000  MATCH     SP10,AFUNDH
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;AFUNDH;        * Health Fund          
          GOTO      STDW9999
.
STDW3100  MATCH     SP10,AFNDTB
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;AFNDTB;        * Health Fund Table          
          GOTO      STDW9999
.
STDW3200  MATCH     SP10,SAVATYP
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;SAVATYP;        * Admission Type       
          GOTO      STDW9999
.
STDW3300  MATCH     SP10,SAVBTYP
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;SAVBTYP;        * Bed Type             
          GOTO      STDW9999
.
STDW3400  MOVE      ZERO,FORM1             * default flag to non casepayment 
          CALL      CCPY0000                * Check for casepayment
          MOVE      CMXFLAG,FORM1           * set casepayment flag
          WRITE     HTMLFILE;FORM1;
          GOTO      STDW9999
.
STDW3500  MATCH     ALACDTE,SP70 
          GOTO      STDW9999 IF EQUAL   
          UNPACK    ALACDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      STDW9999
.
STDW3600  MATCH     SP10,MVMEDREC
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;MVMEDREC;        * Move Medical Record  
          GOTO      STDW9999
.
STDW3700  MATCH     SP10,RETURNCD
          GOTO      STDW9999 IF EQUAL
          WRITE     HTMLFILE;RETURNCD;        * Return screen code for NZ
          GOTO      STDW9999
.
STDW3800  READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          WRITE     HTMLFILE;PTCNUEOC;        * Go to EOC referral flag
          GOTO      STDW9999
.
STDW3900  MOVE      "00:00:00",DIM8
          MOVE      ATIME,DIM8                * default to admission time
          CALL      CHKSEC00                  * Check second
          WRITE     HTMLFILE;DIM8;
          GOTO      STDW9999
.
STDW4000  WRITE     HTMLFILE;NEWDHOSP;
          GOTO      STDW9999
.
STDW4100  WRITE     HTMLFILE;SBFEEKEY;
          GOTO      STDW9999
.
STDW4200  CALL      CSPY0000                  * Get Current Contract
          GOTO      STDW9999
.
STDW4300  CALL      GLSM0000                  * Get Lumpsum amount
          MOVE      "$",KEY1
          WRITE     HTMLFILE;KEY1,FORM12P2;
          GOTO      STDW9999
.
STDW4400  PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF                  * Get Contract Effective From
          BRANCH    EXIT,STDW9999
.
          IF        ASTAT=2
            MOVE      SP70,DDATE
          ENDIF
          PACK      CHNGDATE,CHNGDATE,SP70
          MATCH     SP70,CHNGDATE
          IF        @EQUAL
            PACK      CEFFDATE,CCC,CYY,CMM,CDD  * Default to current date
          ENDIF
          REP       " 0",CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
.
          WRITE     HTMLFILE;CEFFDATE;
          GOTO      STDW9999
.
STDW4500  MOVE      "Yes",KEY3
          MOVE      ZERO,F1
          MOVE      MANCHNGE,F1
          BRANCH    F1,STDW4520,STDW4520
          MOVE      "No ",KEY3
STDW4520  WRITE     HTMLFILE;KEY3;
          GOTO      STDW9999
.
STDW4600  WRITE     HTMLFILE;CONTRCID;
          GOTO      STDW9999
.
STDW4700  WRITE     HTMLFILE;PDIEMKEY;
          GOTO      STDW9999
.
STDW4800  WRITE     HTMLFILE;BFECONTR;
          GOTO      STDW9999
.
STDW9999  RETURN
+
.------------------------------------------------------------
.         Check casepayment rate
.------------------------------------------------------------
GCSM0000  CALL      GTCP0000                * Get Casepayment rate
          BRANCH    NOFEE,GCSM5000
          MOVE      ZERO,EXIT
          GOTO      GCSM9999
.
GCSM5000  BRANCH    RATEFLG,GCSM7000,GCSM8000
.
          WRITE     HTMLFILE;"<tr><td>No Low Outlier details,":
                             "Default not set up yet !! </td></tr>";
          GOTO      STDW9999
.
GCSM7000  WRITE     HTMLFILE;"<tr><td>No High Outlier details,":
                             "Default not set up yet !! </td></tr>";
          GOTO      STDW9999
.
GCSM8000  WRITE     HTMLFILE;"<tr><td>No Additional Charge details,":
                             "Default not set up yet !! </td></tr>";
          GOTO      STDW9999
.
GCSM9000  MOVE      ONE,EXIT
GCSM9999  RETURN
+
.------------------------------------------------------------
. NZ Bed fees stepdown
.------------------------------------------------------------
NZST0000  BRANCH    FLDITMNO,NZST0100
          GOTO      NZST9999
.
NZST0100  WRITE     HTMLFILE;SNZBFKEY;
          GOTO      NZST9999
.
NZST9999  RETURN
+
.------------------------------------------------------------
.         Get Current Contract
.------------------------------------------------------------
CSPY0000  CALL      GTAB0000                *get table type
.
          MOVE      ONE,PROGFLAG
          MOVE      ONE,MSGFLAG
          CALL      CMXMATRX                * Check for matrix
          IF        CMXFLAG=1
            PACK      PTMIPCMX,CMCODE,SP70
          ELSE
            MATCH     SP10,PTMIPCMX         * Casemix code entered?
            GOTO      CSPY9000 IF EQUAL     * no matrix found, charge as patcat
            MOVE      PTMIPCMX,CMCODE
          ENDIF
.
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
.
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          CALL      VALCMXFN                * Check if a casemix record exists
          BRANCH    EXIT,CSPY9000           * Not casepayment
          MOVE      ONE,CMXFLAG
.
          UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,CSPY4000
.
          WRITE     HTMLFILE;PTMIPCMX;
          GOTO      CSPY9999
.
CSPY4000  OPEN      PATCMCA1,"patcmcaf"
          MOVE      SP70,PTCADES1
          PACK      KEY9,PTMIPCMX,SP70
          CALL      RDPTCMC1
          WRITE     HTMLFILE;PTCADES1;
          GOTO      CSPY9999
.
CSPY9000  UNPACK    DIM127,DIM1,KEY1,DIM127
CSPY9999  RETURN
+
.------------------------------------------------------------
.         Get lumpsum amount
.------------------------------------------------------------
GLSM0000  MOVE      ZERO,FORM12P2 
          MATCH     "1",PTMICONB            * Continuous billing?
          GOTO      GLSM9999 IF EQUAL
.
          CALL      GTAB0000                *get table type
.
          MOVE      ONE,PROGFLAG
          MOVE      ONE,MSGFLAG
          IF        ASTAT<>3
            MOVE      "PATWEB96",PRGID      * set to discharge
          ENDIF
          CALL      CMXMATRX                * Check for matrix
          MOVE      "PATWEB71",PRGID
.
          IF        CMXFLAG=1
            PACK      PTMIPCMX,CMCODE,SP70
            GOTO      GLSM2000
          ELSE
            MATCH     SP10,PTMIPCMX         * Casemix code entered?
            GOTO      GLSM9999 IF EQUAL     * no matrix found, charge as patcat
            MOVE      PTMIPCMX,CMCODE
          ENDIF
.
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
.
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,GLSM9999         * not casepayment
          MOVE      ONE,CMXFLAG
.
GLSM2000  IF        DCFLAG=1
            CALL      DLUM0000              * Daycase lumpsum
            IF        NOFEE=0
              MOVE      PTLSLREB,FORM12P2
              ADD       PTLSLPAT,FORM12P2
            ENDIF
          ELSE
            CALL     OLUM0000              * Overnight lumpsum
            IF       NOFEE=0
              MOVE      PTHLLREB,FORM12P2
              ADD       PTHLLPAT,FORM12P2
            ENDIF
          ENDIF
GLSM9999  RETURN
+
.------------------------------------------------------------
.         Check the second of time
.------------------------------------------------------------
CHKSEC00  UNPACK    SP70,KEY5,KEY1,KEY2
          UNPACK    DIM8,KEY5,KEY1,KEY2
          MATCH     SP2,KEY2
          IF        @EQUAL
            MOVE      ":",KEY1
            MOVE      "00",KEY1
            PACK      DIM8,KEY5,KEY1,KEY2
          ENDIF
CHKSEC99  RETURN
.------------------------------------------------------------
. Display Casepayment heading
.------------------------------------------------------------
DSCP0000  MOVE      SP20,DANS1
          MOVE      SP20,DANS2
          MOVE      SP20,DANS3
          MOVE      SP20,DANS4
          MOVE      ZERO,FIRST
          COMPARE   NINE,CFEETYP
          GOTO      DSCP9999 IF EQUAL    * Johns Hopkins doesn't have C/P
.
.                               Contract, Claim, HF, HF TAB,   C/P,   Bed type
          UNPACK    CASMXKEY,KEY6,KEY3,DIM6,DIM3
.
          PACK      CMCODE,CMCODE,SP70
          MATCH     SP70,CMCODE
          IF        !@EQUAL
            MOVE      CMCODE,PTMIPCMX
          ENDIF
          MOVE      PTMIPCMX,KEY9
          CALL      RDPTCMC1
          IF        OVRCD=0
            MOVE      PTCADES1,DANS4
          ENDIF
.
          MOVE      SP70,KEY20
          CALL      RDPMCID1
          IF        OVRCD=0
            MOVE      PMCIDESC,KEY20     * Contract ID description
          ENDIF
.
          MATCH     SP70,KEY3
          IF        !@EQUAL
            PACK      KEY5 WITH ANSC,ANSL,KEY3
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DANS1
            ENDIF
          ENDIF
.
          MATCH     SP70,DIM6
          IF        !@EQUAL
            PACK      KEY14 WITH DIM6,ZERO,ZERO,ZERO,ZERO,SP10
            CALL      RDFUND1
            IF        OVRCD=0
              MOVE      HFNAME,DANS2
            ENDIF
          ENDIF
.
          MATCH     SP70,DIM3
          IF        !@EQUAL
            PACK      KEY5,ANSH,ANST,DIM3
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DANS3      * HF Category
            ENDIF
          ENDIF
.
          MATCH     "1",DEFFEES
          IF        @EQUAL
            WRITE     HTMLFILE;"<table width=100%>":
                               "<tr><td width=20%><font color=red>":
                               "Using Default Fees</td></tr></table>";
          ENDIF
.
          WRITE     HTMLFILE;"<table width=100%><tr><td>&nbsp;</td>":
                             "<td width=20%>Contract ID</td>":
                             "<td><b>",KEY20,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Claim Code</td>":
                             "<td><b>",DANS1,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund</td>":
                             "<td><b>",DANS2,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund Table Type</td>":
                             "<td><b>",DANS3,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Casemix Code</td>":
                             "<td><b>",PTMIPCMX:
                             " - ",DANS4,"&nbsp;</b></td></tr>"
DSCP9999  RETURN
.------------------------------------------------------------
.         Get Current Contract ID
.------------------------------------------------------------
GCTR0000  COMPARE   NINE,CFEETYP
          GOTO      GCTR9999 IF EQUAL      * Johns Hopkins
.
          MOVE      SP70,CONTRCID          * Contract ID
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,AFUNDH,AFNDTB
          CALL      RDFUND1
          PACK      KEY18 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP,SP70
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF                  * Get Contract Effective From
          BRANCH    EXIT,GCTR9000
          MOVE      CHNGDATE,CEFFDATE         * Contract Effective date
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      DSEF0000                * Check for 'Disc.Eff.Date From'
.
          PACK      KEY27 WITH KEY18,SP70
          CALL      RDSBFEE1
GCTR2000  CALL      RDKBFEE1
          BRANCH    OVRCD OF GCTR9000
.
          PACK      DIM18A WITH BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE
          MATCH     KEY18,DIM18A
          GOTO      GCTR9000 IF NOT EQUAL
.
          MOVE      PTBFCNID,KEY6         * Contract ID
          CALL      VALCONTR              * Validate the Contract ID
          BRANCH    EXIT,GCTR2000         * not valid
          MOVE      PTBFCNID,CONTRCID     * Contract ID
.
GCTR9000  MOVE      ONE,EXIT
GCTR9999  RETURN
+
.------------------------------------------------------------
. Display Bed fees heading
.------------------------------------------------------------
DSBF0000  MOVE      SP20,DANS1
          MOVE      SP20,DANS2
          MOVE      SP20,DANS3
          MOVE      ZERO,FIRST
.
          UNPACK    BFEESKEY,DEFFEES,KEY3,KEY6,DIM3,DIM3A
          MATCH     SP70,KEY3
          IF        !@EQUAL
            PACK      KEY5 WITH ANSC,ANSL,KEY3
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DANS1
            ENDIF
          ENDIF
.
          PACK      AFUNDH,AFUNDH,SP70
          PACK      AFNDTB,AFNDTB,SP70
          PACK      KEY14 WITH KEY6,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,DANS2
          ENDIF
.
          MOVE      SP20,DANS4
          PACK      KEY5 WITH ANSA,SP1,DIM3A
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DANS4
          ENDIF
.
          COMPARE   FIVE,CFEETYP
          GOTO      DSBF1000 IF EQUAL    * SX
.
          COMPARE   NINE,CFEETYP
          GOTO      DSBF2000 IF EQUAL    * Johns Hopkins bed fees
.
          MOVE      SP70,DANS3
          MATCH     SP70,DIM3
          IF        !@EQUAL
            PACK      KEY5,ANSH,ANST,DIM3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DANS3        * HF Category
            ENDIF
          ENDIF
.
          UNPACK    BFEESKEY,DEFFEES,KEY18,KEY6
          MOVE      SP70,KEY20
          CALL      RDPMCID1
          IF        OVRCD=0
            MOVE      PMCIDESC,KEY20     * Contract ID description
          ENDIF
.
.         Check if using default bed fees
.
          MATCH     "1",DEFFEES
          IF        @EQUAL
            WRITE     HTMLFILE;"<table width=100%>":
                               "<tr><td width=20%><font color=red>":
                               "Using Default Bed Fees</td></tr></table>";
          ENDIF
.
          WRITE     HTMLFILE;"<table width=100%><tr><td>&nbsp;</td>":
                             "<td width=20%>Contract ID</td>":
                             "<td><b>",KEY20,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Claim Code</td>":
                             "<td><b>",DANS1,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund</td>":
                             "<td><b>",DANS2,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund Table Type</td>":
                             "<td><b>",DANS3,"&nbsp;</b></td></tr>";
.
          GOTO      DSBF8000
.
.         SX
.
DSBF1000  PACK      KEY14 WITH AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,DANS3
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td width=20%>Claim Code</td>":
                             "<td><b>",DANS1,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Contract</td>":
                             "<td><b>",DANS2,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Table</td>":
                             "<td><b>",DANS3,"&nbsp;</b></td></tr>";
          GOTO      DSBF8000
.
.        JHS
.
DSBF2000  PACK      KEY14 WITH AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,DANS3
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td width=20%>Claim Code</td>":
                             "<td><b>",DANS1,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund</td>":
                             "<td><b>",DANS2,"&nbsp;</b></td></tr>":
                             "<tr><td>&nbsp;</td>":
                             "<td width=20%>Health Fund Table</td>":
                             "<td><b>",DANS3,"&nbsp;</b></td></tr>";
.
DSBF8000  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td width=20%>Admission Type</td>":
                             "<td><b>",DANS4,"&nbsp;</b></td></tr>"
.
DSBF9999  RETURN
+
.------------------------------------------------------------
. Display Bed Type
.------------------------------------------------------------
DBTP0000  MOVE      ZERO,TCFORM6
          PACK      KEY5 WITH ANSB,ANST,SAVBTYP
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,DANS5
          ENDIF
          BRANCH    TCFORM6 OF DBTP0200,DBTP0100,DBTP0200:
                               DBTP0100,DBTP0200,DBTP0100
.
DBTP0100  MOVE      "SHRD ",KEY4
          GOTO      DBTP0400
.
DBTP0200  MOVE      "PRIV ",KEY4
.
DBTP0400  MOVE      "BT",CATEGORY
          MOVE      SAVBTYP,CODE
.
          MATCH     SP10,NEWBTYPE
          IF        !@EQUAL
            MOVE      NEWBTYPE,CODE
          ENDIF
          CALL      CODITM00
.
.         WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
.                            "<td width=20%>Bed Type:</td>":
.                            "<td><b>",DANS5,"</b> -":
.                            "<b>",KEY4,"&nbsp;</b></td></tr>":
.                            "<tr><td>&nbsp;</td></tr>"
.
DBTP9999  RETURN
+
.------------------------------------------------------------
. Display new Bed Type
.------------------------------------------------------------
NBTP0000  WRITE     HTMLFILE;NEWBTYPE;
NBTP9999  RETURN
+
.------------------------------------------------------------
. Display NZ Bed fees
.------------------------------------------------------------
NZRT0000  PACK     KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP,SP70
.
.         Display the Bed Fee for the above codes
.
          MOVE      ZERO,FIRST
          MOVE      ZERO,NOFEE
          MOVE      ZERO,NUMBER
          MOVE      ZERO,BFCOL
          MOVE      ZERO,COLNO
          MOVE      ZERO,CBFLAG
          MOVE      ZERO,MAXNUM
          CALL      CLROW0000           * Clear variables
.
.         Set up the first column
.
NZRT1000  ADD       ONE,COLNO
          MOVE      SP70,ROW1[COLNO]
          MOVE      "Rate",ROW2A[COLNO]
          MOVE      "Rebate",ROW3A[COLNO]
          MOVE      "Total",ROW4A[COLNO]
          MOVE      SP70,ROW5[COLNO]
          MOVE      ZERO,FORM2
.
NZRT1200  CALL      EFDT0000                  * Get last effective date
          MATCH     SP70,EFTDATE
          GOTO      NZRT2200 IF EQUAL         * No record found
.
.         Display  all  bed fee for the above parameters
.
          PACK      KEY37 WITH KEY26,EFTDATE,SP70
          CALL      RSNZBFE1
NZRT2000  CALL      RKNZBFE1
          BRANCH    OVRCD OF NZRT2200
.
          PACK      DIM26A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,SP70
          MATCH     KEY26,DIM26A
          GOTO      NZRT2200 IF NOT EQUAL
          MATCH     EFTDATE,NZBFEFDT         * Same effective date?
          GOTO      NZRT4000 IF EQUAL
.
.         Check to see if we found anything
.
NZRT2200  MOVE      ZERO,OVRCD
          COMPARE   ZERO,BFCOL
          GOTO      NZRT9999 IF NOT EQUAL
.
          MOVE      ONE,OVRCD
          ADD       ONE,FORM2
          BRANCH    FORM2 OF NZRT3000,NZRT3200
.         WRITE     HTMLFILE;"<tr><td>No Bed Fee details,":
.                   "Default not set up yet !! </td></tr>";
          MOVE      ONE,NOFEE
          GOTO      NZRT9999
.
NZRT3000  PACK      KEY26 WITH PMVXMHOS,ACLAIM,SP6,SP8,SAVATYP,SAVBTYP
          GOTO      NZRT1200
.
NZRT3200  MOVE      ONE,DEFLAG
          IF        IBCNMHOS=1
            PACK      KEY26 WITH PMVXMHOS,PTHSDCLM,SP6,SP8,SAVATYP,SAVBTYP
          ELSE
            PACK      KEY26 WITH PMVXMHOS,PTCNDCLM,SP6,SP8,SAVATYP,SAVBTYP
          ENDIF
          GOTO      NZRT1200
.
.             Display the bed fee
.
NZRT4000  COMPARE   SIX,BFCOL
          GOTO      NZRT9999 IF NOT LESS
.
          ADD       ONE,BFCOL
          ADD       ONE,COLNO
.
          MATCH     ADATE,DDATE
          GOTO      NZRT6200 IF NOT EQUAL
.
.         For DAYCASE Fee the NZBFEDAY is equal to zero
.
          MATCH     "  0",NZBFEDAY
          GOTO      NZRT6500 IF EQUAL
          GOTO      NZRT6700
.
.         If the TOTDAY is zero then the default is the first column of
.         the bed fee but not the day case
.
NZRT6200  COMPARE   ZERO,TOTDAY
          GOTO      NZRT6400 IF NOT EQUAL
.
          MATCH     "  0",NZBFEDAY
          GOTO      NZRT6700 IF EQUAL
          GOTO      NZRT6500
.
NZRT6400  MOVE      NZBFEDAY,FORM3
          COMPARE   TOTDAY,FORM3
          GOTO      NZRT6700 IF LESS
.
NZRT6500  BRANCH    CBFLAG OF NZRT6700
          MOVE      ONE,CBFLAG              * Current bed fee
          MOVE      NZBFRATE,SAVPAT
          MOVE      NZBFREBA,SAVHF
          MOVE      NZBFEDAY,SAVEND
          MOVE      BFCOL,DEFCOLNO            * save the current bed column
.
.         First colum of bed fee
.
NZRT6700  MOVE      NZBFRATE,TOTAL
          ADD       NZBFREBA,TOTAL
.
          MATCH     "  0",NZBFEDAY
          GOTO      NZRT7100 IF NOT EQUAL
.
          MOVE      "DAYCASE",ROW1[COLNO]
          MOVE      NZBFRATE,ROW2A[COLNO]
          MOVE      NZBFREBA,ROW3A[COLNO]
          MOVE      TOTAL,ROW4A[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          GOTO      NZRT8000
.
.         Not a day case
.
NZRT7100  BRANCH    FIRST,NZRT7200
          RESET     ROW1[COLNO]
          APPEND    "1 - ",ROW1[COLNO]
          APPEND    NZBFEDAY,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      NZBFRATE,ROW2A[COLNO]
          MOVE      NZBFREBA,ROW3A[COLNO]
          MOVE      TOTAL,ROW4A[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          MOVE      ONE,FIRST
          GOTO      NZRT8000
.
.         Display each column of bed fee
.
NZRT7200  RESET     ROW1[COLNO]
          APPEND    NUMBER,ROW1[COLNO]
          APPEND    " - ",ROW1[COLNO]
          APPEND    NZBFEDAY,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      NZBFRATE,ROW2A[COLNO]
          MOVE      NZBFREBA,ROW3A[COLNO]
          MOVE      TOTAL,ROW4A[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
.
NZRT8000  MOVE      ZERO,NUMBER
          MOVE      NZBFEDAY,NUMBER
          ADD       ONE,NUMBER
          MOVE      NZBFEDAY,FORM3
          STORE     FORM3 WITH BFCOL OF BFEND1,BFEND2,BFEND3,BFEND4:
                                        BFEND5,BFEND6
.
          PACK      SNZBFKEY,EFTDATE,ADMISSNO,SAVATYP,SAVBTYP:
                             BFEND1,BFEND2,BFEND3:
                             BFEND4,BFEND5,BFEND6,SP70
.
          MOVE      SP70,NZBFEDAY
          MOVE      BFCOL,MAXNUM
          GOTO      NZRT2000
.
NZRT9999  RETURN
.------------------------------------------------------------
.         Get the last effective date
.------------------------------------------------------------
EFDT0000  MOVE      SP70,EFTDATE
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     SP70,DDATE
          IF        !@EQUAL
            IF        ASTAT=3
              MOVE      DDATE,KEY8           * Use Discharge date
            ENDIF
          ENDIF
          PACK      KEY34,KEY26,KEY8,SP70
          PACK      KEY37,KEY34,SP70
          CALL      RSNZBFE1
EFDT1000  CALL      RKNZBFE1
          BRANCH    OVRCD,EFDT2000
          PACK      DIM34A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,NZBFEFDT,SP70
          MATCH     DIM34A,KEY34
          GOTO      EFDT4000 IF EQUAL       
.
EFDT2000  CALL      RPNZBFE1                  * check for previous record
          BRANCH    OVRCD,EFDT9999
.
          PACK      DIM26A WITH NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB,NZBFATYP:
                                NZBFBTYP,SP70
          MATCH     DIM26A,KEY26
          GOTO      EFDT9999 IF NOT EQUAL
.
EFDT4000  MOVE      NZBFEFDT,EFTDATE         * Save the effective date
EFDT9999  RETURN
+
.------------------------------------------------------------
. Display Bed fees 
.------------------------------------------------------------
GTRT0000  MOVE      ZERO,FIRST
          MOVE      ZERO,NOFEE
          MOVE      ZERO,NUMBER
          MOVE      ZERO,BFCOL
          MOVE      ZERO,COLNO
          MOVE      ZERO,CBFLAG
          MOVE      ZERO,MAXNUM
          MOVE      SP70,BFEESKEY
          MOVE      ZERO,DEFCOLNO
          CALL      CLROW0000           * Clear variables
          PACK      PDIEMKEY,SP70,SP70,SP70,SP70,SP70
          CLEAR     PDIEMKEY
.
.         Set up the first column
.
          ADD       ONE,COLNO
          MOVE      SP70,ROW1[COLNO]
          MOVE      "Patient",ROW2[COLNO]
          MOVE      "H.F.",ROW3[COLNO]
          MOVE      "Total",ROW4[COLNO]
          MOVE      SP70,ROW5[COLNO]
          MOVE      ZERO,FORM2
.
          OPEN      PATBFEE1,"patbfeef"
.
          MOVE      SP70,PMSGCLSS
          CALL      ISUG0000           * Check if ICD10 Sugg.Class.required
          IF        INVBFLAG=0
            MOVE      PMSGCLSS,SAVATYP
            MOVE      PMSGCLSS,ATYPE
          ENDIF
.
          PACK      KEY23 WITH ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP,SP70
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,AFUNDH,AFNDTB
          CALL      RDFUND1
          PACK      KEY24 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP:
                               CONTRCID,SP70
.
.         Display  all  bed fee for the above parameters
.
GTRT1200  COMPARE   NINE,CFEETYP
          GOTO      GTRT2100 IF EQUAL         * Johns Hopkins bed fees
.
          PACK      KEY27 WITH KEY24,SP70
          CALL      RDSBFEE1
GTRT2000  CALL      RDKBFEE1
          BRANCH    OVRCD OF GTRT2200
.
          PACK      DIM24A WITH BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE:
                                PTBFCNID,SP70
          MATCH     KEY24,DIM24A
          GOTO      GTRT2200 IF NOT EQUAL
.
.         Check if Overnight rate setup for the above parameters
.
          MATCH     ADATE,DDATE
          IF        !@EQUAL
            CALL      COVR0000                * Check if overnight rate setup
            BRANCH    EXIT,GTRT2200
          ENDIF
.
          MOVE      "0",DEFFEES
          IF        FORM2<>0
            MOVE      "1",DEFFEES              * Flag for using default fees
          ENDIF
          PACK      BFEESKEY,DEFFEES,KEY24,SP70
.
          PACK      KEY5 WITH ANSA,SP1,SAVATYP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "U",TCINDC12
            IF        @EQUAL
              MOVE      ONE,DEFCOLNO          * default to first column
              IF        BFENDDY=0
                MOVE      TWO,DEFCOLNO        * Next column after Daycase
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      GTRT4000
.
.         Johns Hopkins bed fees
.
GTRT2100  OPEN      JHSBFEA1,"jhsbfeaf"
          PACK      KEY26 WITH KEY23,SP3
          CALL      RSJHBFE1
GTRT2120  CALL      RKJHBFE1
          BRANCH    OVRCD OF GTRT2200
.
          PACK      DIM23A WITH BFCLM,BFHFUND,BFHFTAB,BFATYPE,BFBTYPE
          MATCH     KEY23,DIM23A
          GOTO      GTRT4000 IF EQUAL
.
.         Check to see if we found anything
.
GTRT2200  MOVE      ZERO,OVRCD
          COMPARE   ZERO,BFCOL
          GOTO      GTRT9000 IF NOT EQUAL
.
          MOVE      ONE,OVRCD
          ADD       ONE,FORM2
          BRANCH    FORM2 OF GTRT3000,GTRT3200
.
          PACK      ERRORDES,KEY24,SP70
          IF        CFEETYP=9
            PACK      ERRORDES,KEY23,SP70
          ENDIF
          MOVE      ONE,NOFEE
          GOTO      GTRT9000
.
GTRT3000  PACK      KEY24 WITH ACLAIM,SP6,SP3,SAVATYP,SAVBTYP,CONTRCID,SP70
          PACK      KEY23 WITH ACLAIM,SP6,SP8,SAVATYP,SAVBTYP
          GOTO      GTRT1200
.
GTRT3200  MOVE      ONE,DEFLAG
          IF        IBCNMHOS=1
            PACK      KEY24 WITH PTHSDCLM,SP6,SP3,SAVATYP,SAVBTYP,CONTRCID,SP70
            PACK      KEY23 WITH PTHSDCLM,SP6,SP8,SAVATYP,SAVBTYP
          ELSE
            PACK      KEY24 WITH PTCNDCLM,SP6,SP3,SAVATYP,SAVBTYP,CONTRCID,SP70
            PACK      KEY23 WITH PTCNDCLM,SP6,SP8,SAVATYP,SAVBTYP
          ENDIF
          GOTO      GTRT1200
.
.             Display the bed fee
.
GTRT4000  
.         COMPARE   SIX,BFCOL
.         GOTO      GTRT9000 IF NOT LESS
.
          ADD       ONE,BFCOL
          ADD       ONE,COLNO
.
          MATCH     ADATE,DDATE
          GOTO      GTRT6200 IF NOT EQUAL
.
.         For DAYCASE Fee the BFENDDY is equal to zero
.
          COMPARE   ZERO,BFENDDY
          GOTO      GTRT6500 IF EQUAL
          GOTO      GTRT6700
.
.         If the TOTDAY is zero then the default is the first column of 
.         the bed fee but not the day case
.
GTRT6200  COMPARE   ZERO,TOTDAY
          GOTO      GTRT6400 IF NOT EQUAL
.
          COMPARE   ZERO,BFENDDY
          GOTO      GTRT6700 IF EQUAL
          GOTO      GTRT6500
.
GTRT6400  MATCH     "1",MANCHNGE
          GOTO      GTRT6420 IF NOT EQUAL       * Not a manual change
.
          MOVE      BFPAT,FORM12P2
          ADD       BFHF,FORM12P2
          COMPARE   FORM12P2,MANSAMNT
          GOTO      GTRT6700 IF NOT EQUAL
          GOTO      GTRT6500
.
GTRT6420  COMPARE   TOTDAY,BFENDDY
          GOTO      GTRT6700 IF LESS
.
GTRT6500  BRANCH    CBFLAG OF GTRT6700
.
          MOVE      BFCOL,DEFCOLNO            * save the current bed column
          MOVE      ONE,CBFLAG              * Current bed fee
          MOVE      BFPAT,SAVPAT
          MOVE      BFHF,SAVHF
          MOVE      BFENDDY,SAVEND
.
.         First colum of bed fee
.
GTRT6700  MOVE      BFPAT,TOTAL
          ADD       BFHF,TOTAL
.
          COMPARE   SIX,BFCOL
          GOTO      GTRT8000 IF NOT LESS
.
          COMPARE   ZERO,BFENDDY
          GOTO      GTRT7100 IF NOT EQUAL
.
          PACK      KEY5 WITH ANSA,SP1,SAVATYP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "U",TCINDC12
            IF        @EQUAL
              ADD       ONE,DEFCOLNO        * Next column after Daycase
            ENDIF
          ENDIF
.
          MOVE      "DAYCASE",ROW1[COLNO]
          MOVE      BFPAT,ROW2[COLNO]
          MOVE      BFHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          GOTO      GTRT8000
.
.         Not a day case
.
GTRT7100  BRANCH    FIRST,GTRT7200
          RESET     ROW1[COLNO]
          APPEND    "1 - ",ROW1[COLNO]
          APPEND    BFENDDY,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      BFPAT,ROW2[COLNO]
          MOVE      BFHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          MOVE      ONE,FIRST
          GOTO      GTRT8000
.
.         Display each column of bed fee
.
GTRT7200  RESET     ROW1[COLNO]
          APPEND    NUMBER,ROW1[COLNO]
          APPEND    " - ",ROW1[COLNO]
          APPEND    BFENDDY,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      BFPAT,ROW2[COLNO]
          MOVE      BFHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
.
GTRT8000  MOVE      ZERO,NUMBER
          MOVE      BFENDDY,NUMBER
          ADD       ONE,NUMBER
          STORE     BFENDDY WITH BFCOL OF BFEND1,BFEND2,BFEND3,BFEND4:
                                          BFEND5,BFEND6
.
          PACK      SBFEEKEY,ADMISSNO,SAVATYP,SAVBTYP,BFEND1,BFEND2,BFEND3:
                             BFEND4,BFEND5,BFEND6,CONTRCID,SP70
          MOVE      SP70,KEY3
          MOVE      BFENDDY,KEY3
          MOVE      ZERO,BFENDDY
          MOVE      BFCOL,MAXNUM
.
          COMPARE   ZERO,CFEETYP
          GOTO      GTRT2000 IF NOT EQUAL      * Not using bed fees
.
          IF        BFCOL=1
            APPEND    ADMISSNO,PDIEMKEY
            APPEND    SAVATYP,PDIEMKEY
            APPEND    SAVBTYP,PDIEMKEY
            APPEND    CONTRCID,PDIEMKEY
            APPEND    KEY3,PDIEMKEY
          ELSE
            APPEND    KEY3,PDIEMKEY
          ENDIF
.
          GOTO      GTRT2000
.
GTRT9000  APPEND    SP70,PDIEMKEY
          APPEND    SP70,PDIEMKEY
          APPEND    SP70,PDIEMKEY
          APPEND    SP70,PDIEMKEY
          APPEND    SP70,PDIEMKEY
          RESET     PDIEMKEY
.
GTRT9999  RETURN
+
.------------------------------------------------------------
.         Check if overnight rate setup
.------------------------------------------------------------
COVR0000  MOVE      ZERO,EXIT
          COMPARE   FIVE,CFEETYP
          GOTO      COVR9999 IF EQUAL         * NZ Private
          COMPARE   NINE,CFEETYP
          GOTO      COVR9999 IF EQUAL         * JH Bed fees
          COMPARE   ONE,CHOSTYP
          GOTO      COVR9999 IF NOT EQUAL     * Not Public hospital
.
          PACK      SKEY27,BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE:
                           PTBFCNID,BFENDDY
          PACK      KEY27 WITH KEY24,SP70
          CALL      RDSBFEE1
COVR2000  CALL      RDKBFEE1
          BRANCH    OVRCD OF COVR7000
.
          PACK      DIM24A WITH BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE:
                                PTBFCNID,SP70
          MATCH     KEY24,DIM24A
          GOTO      COVR7000 IF NOT EQUAL
.
          COMPARE   ZERO,BFENDDY
          GOTO      COVR2000 IF EQUAL       * Daycase rate
.
          MOVE      ZERO,EXIT
          GOTO      COVR8000
.
COVR7000  MOVE      ONE,EXIT
COVR8000  MOVE      SKEY27,KEY27
          CALL      RDBFEE1                 * reposition
COVR9999  RETURN
+
.------------------------------------------------------------
. Display the bed fees
.------------------------------------------------------------
DSFE0000  WRITE     HTMLFILE;"<tr><td class=HeadingCell align=right width=8%>":
                           ROW1[1],"&nbsp;</td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[2],"</b></td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[3],"</b></td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[4],"</b></td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[5],"</b></td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[6],"</b></td>":
                           "<td class=HeadingCell align=right width=15%><b>":
                           ROW1[7],"</b></td></tr>";
.
          IF        CFEETYP=5
            WRITE    HTMLFILE;"<tr><td align=right>",ROW2A[1],"<b>($)</b></td>":
                                   "<td align=right><b>",ROW2A[2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td align=right>",ROW2[1],"<b>($)</b></td>":
                                   "<td align=right><b>",ROW2[2],"</b></td>";
          ENDIF
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of second row
.
DSFE8210  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      DSFE8300 IF LESS
          IF        CFEETYP=5
            WRITE     HTMLFILE;"<td align=right><b>",ROW2A[FORM2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right><b>",ROW2[FORM2],"</b></td>";
          ENDIF
          GOTO      DSFE8210
.
DSFE8300  IF        CFEETYP=5
            WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW3A[1]:
                                    "<b>($)</b></td>":
                                    "<td align=right><b>",ROW3A[2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW3[1]:
                                    "<b>($)</b></td>":
                                    "<td align=right><b>",ROW3[2],"</b></td>";
          ENDIF
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of third row
.
DSFE8310  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      DSFE8400 IF LESS
          IF        CFEETYP=5
            WRITE     HTMLFILE;"<td align=right><b>",ROW3A[FORM2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right><b>",ROW3[FORM2],"</b></td>";
          ENDIF
          GOTO      DSFE8310
.
DSFE8400  IF        CFEETYP=5
            WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW4A[1]:
                               "<b>($)</b></td>":
                               "<td align=right><b>",ROW4A[2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW4[1]:
                               "<b>($)</b></td>":
                               "<td align=right><b>",ROW4[2],"</b></td>";
          ENDIF
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of fourth row
.
DSFE8410  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      DSFE8500 IF LESS
          IF        CFEETYP=5
            WRITE     HTMLFILE;"<td align=right><b>",ROW4A[FORM2],"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right><b>",ROW4[FORM2],"</b></td>";
          ENDIF
          GOTO      DSFE8410
.
DSFE8500  WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW5[1],"</td>":
                             "<td align=right>(<b>",ROW5[2],"</b>)</td>";
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of fifth row
.
DSFE8510  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      DSFE9000 IF LESS
          WRITE     HTMLFILE;"<td align=right>(<b>":
                             ROW5[FORM2],"</b>)</td>";
          GOTO      DSFE8510
.
DSFE9000  WRITE     HTMLFILE;"</tr>";
DSFE9999  RETURN
+
.------------------------------------------------------------
. Display the bed fees for each row
.------------------------------------------------------------
DFER0000  MOVE     ZERO,NUMBER
          MOVE     ZERO,FORM3A
          MOVE     ZERO,COUNT
          MOVE     ZERO,FORM2
          MOVE     ZERO,NOFEE
.
          WRITE     HTMLFILE;"<tr><td>";
.
          WRITE     HTMLFILE;"<td><table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr>";
.
          WRITE     HTMLFILE;"<tr>":
                      "<td nowrap class=HeadingCell align=center width=15%><b>":
                       "&nbsp;</b></td></tr>";
          WRITE    HTMLFILE;"<tr><td align=right nowrap>Patient ($)</td></tr>";
         WRITE     HTMLFILE;"<tr><td align=right nowrap>     HF ($)</td></tr>";
         WRITE     HTMLFILE;"<tr><td align=right nowrap>  Total ($)</td></tr>";
          WRITE     HTMLFILE;"<tr><td align=right nowrap>&nbsp;</td></tr>";
.
          WRITE     HTMLFILE;"</tr></table></td>";
.
          OPEN      PATBFEE1,"patbfeef"
.
          PACK      KEY23 WITH ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP,SP70
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,AFUNDH,AFNDTB
          CALL      RDFUND1
          PACK      KEY24 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP:
                               CONTRCID,SP70
.
DFER0200  PACK      KEY27 WITH KEY24,SP70
          CALL      RDSBFEE1
DFER1000  CALL      RDKBFEE1
          BRANCH    OVRCD OF DFER5000
.
          PACK      DIM24A WITH BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE:
                                PTBFCNID,SP70
          MATCH     KEY24,DIM24A
          GOTO      DFER5000 IF NOT EQUAL
.
.         Check if Overnight rate setup for the above parameters
.
          MATCH     ADATE,DDATE
          IF        !@EQUAL
            CALL      COVR0000                * Check if overnight rate setup
            BRANCH    EXIT,DFER1000
          ENDIF
          ADD       ONE,COUNT
.
.         Display the bed fee
.
          ADD       ONE,FORM3A
          MOVE      BFPAT,FORM12P2
          ADD       BFHF,FORM12P2
.
          WRITE     HTMLFILE;"<td><table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr>";
.
          COMPARE   ZERO,BFENDDY
          GOTO      DFER3000 IF NOT EQUAL     * Not daycase
.
          WRITE     HTMLFILE;"<tr>":
                       "<td nowrap class=HeadingCell align=right><b>":
                       "DAYCASE</b></td></tr>";
          GOTO      DFER4000
.
DFER3000  IF        NUMBER=0
            MOVE      ONE,NUMBER
          ENDIF
          WRITE     HTMLFILE;"<tr>":
                       "<td nowrap class=HeadingCell align=right><b>":
                       NUMBER,"-",BFENDDY,"</b></td></tr>";
.
DFER4000
          WRITE    HTMLFILE;"<tr><td align=right nowrap>",BFPAT,"</td></tr>";
          WRITE    HTMLFILE;"<tr><td align=right nowrap>",BFHF,"</td></tr>";
        WRITE     HTMLFILE;"<tr><td align=right nowrap>",FORM12P2,"</td></tr>";
        WRITE     HTMLFILE;"<tr><td align=center nowrap>(",FORM3A,")</td></tr>";
.
          WRITE     HTMLFILE;"</tr></table></td>";
.
          MOVE      ZERO,NUMBER
          MOVE      BFENDDY,NUMBER
          ADD       ONE,NUMBER
          GOTO      DFER1000
.
.             Use default bed fee if hospitalization day not in range
.
DFER5000  COMPARE   ZERO,COUNT
          GOTO      DFER8000 IF NOT EQUAL
.
          ADD       ONE,FORM2
          BRANCH    FORM2 OF DFER5200,DFER5400
          MOVE      ONE,NOFEE
.         DISPLAY   *P1:23,*EL,*P1:23,*V2LON,*B:
.                   " Default not set up yet !!     ",*HOFF:
.                   "KEY:[",*V2LON,DIM23,*HOFF,"] ",*W2;
          GOTO      DFER8000
.
DFER5200  PACK      KEY24 WITH ACLAIM,SP9,SAVATYP,SAVBTYP:
                               CONTRCID,SP70
          GOTO      DFER0200
.
DFER5400  PACK      KEY24 WITH PTCNDCLM,SP9,SAVATYP,SAVBTYP:
                               CONTRCID,SP70
          GOTO      DFER0200
.
DFER8000  WRITE     HTMLFILE;"</td></tr>";
          GOTO      DFER9999
.
DFER9999  RETURN
+
.------------------------------------------------------------
. Display Casemix rates heading
.------------------------------------------------------------
DSRT0000  MATCH     ANSY,PTMICMXP
          GOTO      DSRT9999 IF NOT EQUAL
.
          MOVE      SP70,KEY26
          MOVE      "&nbsp;",KEY26
          COMPARE   TWO,RATEFLG
          GOTO      DSRT1000 IF NOT EQUAL
.
          MOVE      "Additional Rates",KEY26
          GOTO      DSRT8000
.
DSRT1000  COMPARE   THREE,ASTAT
          GOTO      DSRT2000 IF NOT EQUAL
          MATCH     ADATE,DDATE
          GOTO      DSRT8000 IF EQUAL      * daycase doesn't have daily charge
.
DSRT2000  IF        RATEFLG=1
            MOVE      "Daily Rates - High Outlier",KEY26
          ELSE
            MOVE      "Daily Rates - Low Outlier",KEY26
          ENDIF
.
DSRT8000  WRITE     HTMLFILE;"<tr><td class=HeadingCell align=center>":
                             KEY26,"</td></tr>"
DSRT9999  RETURN
.
.------------------------------------------------------------
. Display Casemix rates 
.------------------------------------------------------------
LSRT0000  BRANCH    NOFEE,LSRT9999
          COMPARE   THREE,ASTAT
          GOTO      LSRT1000 IF NOT EQUAL
          MATCH     ADATE,DDATE
          GOTO      LSRT9999 IF EQUAL
.
LSRT1000  WRITE     HTMLFILE;"<tr><td class=HeadingCell align=right width=8%>":
                           ROW1[1],"&nbsp;</td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[2],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[3],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[4],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[5],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[6],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[7],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[8],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[9],"</b></td>":
                           "<td class=HeadingCell align=right width=10%><b>":
                           ROW1[10],"</b></td></tr>"
.
          WRITE     HTMLFILE;"<tr><td align=right>",ROW2[1],"<b>($)</b></td>":
                                 "<td align=right><b>",ROW2[2],"</b></td>";
          MOVE      TWO,FORM2
          MOVE      TEN,COLNO
.
.         Display the rest of the columns of second row - Patient row
.
LSRT8210  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      LSRT8300 IF LESS
          WRITE     HTMLFILE;"<td align=right><b>",ROW2[FORM2],"</b></td>";
          GOTO      LSRT8210
.
LSRT8300  WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW3[1]:
                                    "<b>($)</b></td>":
                                    "<td align=right><b>",ROW3[2],"</b></td>";
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of third row - HF row
.
LSRT8310  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      LSRT8400 IF LESS
          WRITE     HTMLFILE;"<td align=right><b>",ROW3[FORM2],"</b></td>";
          GOTO      LSRT8310
.
LSRT8400  WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW4[1]:
                             "<b>($)</b></td>":
                             "<td align=right><b>",ROW4[2],"</b></td>";
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of fourth row - total row
.
LSRT8410  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      LSRT8500 IF LESS
          WRITE     HTMLFILE;"<td align=right><b>",ROW4[FORM2],"</b></td>";
          GOTO      LSRT8410
.
LSRT8500  WRITE     HTMLFILE;"</tr><tr><td align=right>",ROW5[1],"</td>":
                             "<td align=right>(<b>",ROW5[2],"</b>)</td>";
          MOVE      TWO,FORM2
.
.         Display the rest of the columns of fifth row
.
LSRT8510  ADD       ONE,FORM2
          COMPARE   FORM2,COLNO
          GOTO      LSRT9000 IF LESS
.
          MATCH     SP20,ROW4[FORM2]
          GOTO      LSRT9000 IF EQUAL
.
          WRITE     HTMLFILE;"<td align=right>(<b>":
                             ROW5[FORM2],"</b>)</td>";
          GOTO      LSRT8510
.
LSRT9000  WRITE     HTMLFILE;"</tr>";
LSRT9999  RETURN
+
.------------------------------------------------------------
. Clear variables for each row
.------------------------------------------------------------
CLROW000  MOVE      ZERO,FORM2
CLROW100  ADD       ONE,FORM2
          COMPARE   "12",FORM2
          GOTO      CLROW999 IF NOT LESS
          MOVE      SP70,ROW1[FORM2]
          MOVE      SP70,ROW2[FORM2]
          MOVE      SP70,ROW3[FORM2]
          MOVE      SP70,ROW4[FORM2]
          MOVE      SP70,ROW5[FORM2]
          GOTO      CLROW100
CLROW999  RETURN
.
.------------------------------------------------------------
. Clear variables for each row for c/p
.------------------------------------------------------------
CPVAR000  COMPARE   ONE,CMIXFLAG
          GOTO      CPVAR999 IF NOT EQUAL   * not a casepayment
.
          MOVE      ZERO,FORM2
CPVAR210  ADD       ONE,FORM2
          COMPARE   "20",FORM2
          GOTO      CPVAR300 IF NOT LESS
          MOVE      ZERO,DAYENDD[FORM2]
          GOTO      CPVAR210
.
CPVAR300  MOVE      ZERO,FORM2
CPVAR310  ADD       ONE,FORM2
          COMPARE   "20",FORM2
          GOTO      CPVAR999 IF NOT LESS
          MOVE      ZERO,ADDENDD[FORM2]
          GOTO      CPVAR310
.
CPVAR999  RETURN
+
.------------------------------------------------------------
. Set up NZ Priv bed fees variable for the selected column no
.------------------------------------------------------------
NZVR0000  MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVEND
          MOVE      ZERO,FORM1
          LOAD      SAVEND WITH BFECOLNO OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
NZVR1000  
.         PACK      KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,TATYPE,TRBTYP
          PACK      KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP
          CALL      EFDT0000                  * Get last effective date
          MATCH     SP70,EFTDATE
          GOTO      NZVR1200 IF EQUAL         * No record found
.
          PACK      KEY26 WITH PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP
          PACK      KEY37 WITH KEY26,EFTDATE,SAVEND,SP70
          CALL      RDNZBFE1
          COMPARE   ZERO,OVRCD
          GOTO      NZVR8000 IF EQUAL
.
NZVR1200  ADD       ONE,FORM1
          BRANCH    FORM1,NZVR2000,NZVR3000
          GOTO      NZVR9999
.
NZVR2000  UNPACK    SP70,AFUNDH,AFNDTB
          GOTO      NZVR1000
.
NZVR3000  IF        IBCNMHOS=1
            MOVE      PTHSDCLM,ACLAIM
          ELSE
            MOVE      PTCNDCLM,ACLAIM
          ENDIF
          GOTO      NZVR1000
.
NZVR8000  MOVE      NZBFREBA,SAVHF
          MOVE      NZBFRATE,SAVPAT
          MOVE      NZBFEDAY,SAVEND
NZVR9999  RETURN
+
.------------------------------------------------------------
. Set up bed fees variable for the selected column no
.------------------------------------------------------------
FVAR0000  MATCH     "1",MANCHNGE
          GOTO      FVAR9999 IF EQUAL    * manual stepdown
.
          MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVEND
          MOVE      ZERO,FORM1
.
          PACK      KEY5 WITH ANSA,SP1,SAVATYP
          CALL      RDCODE1
          BRANCH    OVRCD,FVAR0200
.
          MATCH     "U",TCINDC12
          GOTO      FVAR0200 IF NOT EQUAL
.
          MOVE      ONE,BFECOLNO     * Always default to column one
          LOAD      SAVEND WITH BFECOLNO OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
          IF        SAVEND=0
            ADD       ONE,BFECOLNO
          ENDIF
          GOTO      FVAR0400
.
FVAR0200  COMPARE   ZERO,CFEETYP
          GOTO      FVAR0400 IF NOT EQUAL
.
          CALL      UPKEY000            * Unpack into an array variable
          MOVE      ZERO,SAVEND
          IF        BFECOLNO<>0
            MOVE      BFENDARY[BFECOLNO],SAVEND
          ENDIF
          GOTO      FVAR0600
.
FVAR0400  LOAD      SAVEND WITH BFECOLNO OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
.
FVAR0600  PACK      KEY23 WITH ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP
          COMPARE   NINE,CFEETYP
          GOTO      FVAR1000 IF EQUAL        * Johns Hopkins bed fees
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14 WITH AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
          PACK      KEY18 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP,SP70
.
FVAR1000  PACK      KEY26 WITH KEY23,SAVEND
          PACK      KEY27 WITH KEY18,CONTRCID,SAVEND
          IF        CFEETYP<>9
            CALL      RDBFEE1
          ELSE
            OPEN      JHSBFEA1,"jhsbfeaf"
            CALL      RDJHBFE1
          ENDIF
          BRANCH    OVRCD,FVAR1400
.
.         Check if Overnight rate setup for the above parameters
.
          MATCH     ADATE,DDATE
          IF        !@EQUAL
            CALL      COVR0000                * Check if overnight rate setup
            BRANCH    EXIT,FVAR1400
          ENDIF
          GOTO      FVAR8000
.
FVAR1400  ADD       ONE,FORM1
          BRANCH    FORM1,FVAR2000,FVAR3000
          GOTO      FVAR9999
.
FVAR2000  PACK      KEY18,ACLAIM,SP6,SP3,SAVATYP,SAVBTYP,SP70
          PACK      KEY23,ACLAIM,SP6,SP8,SAVATYP,SAVBTYP,SP70
          GOTO      FVAR1000
.
FVAR3000  IF        IBCNMHOS=1
            MOVE      PTHSDCLM,KEY3
          ELSE
            MOVE      PTCNDCLM,KEY3
          ENDIF
          PACK      KEY18,KEY3,SP6,SP3,SAVATYP,SAVBTYP,SP70
          PACK      KEY23,KEY3,SP6,SP8,SAVATYP,SAVBTYP,SP70
          GOTO      FVAR1000
.
FVAR8000  MOVE      BFHF,SAVHF
          MOVE      BFPAT,SAVPAT
          MOVE      BFENDDY,SAVEND
FVAR9999  RETURN
+
.------------------------------------------------------------
. Set up daily fee variable for the selected column no
.------------------------------------------------------------
DVAR0000  MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVEND
          COMPARE   ZERO,BFECOLNO
          GOTO      DVAR9999 IF EQUAL
.
          MOVE      SP10,KEY4
          MOVE      DAYENDD[BFECOLNO],KEY4
.
DVAR1000  BRANCH    LOWFLAG,DVAR5000          * low outlier
.
.         High outlier
.
          PACK      KEY31,CASMXKEY,PTMIPCMX,KEY4
          CALL      RDPTHDF1
          BRANCH    OVRCD,DVAR9999
.
          MOVE      PTHDDREB,SAVHF
          MOVE      PTHDDPAT,SAVPAT
          MOVE      PTHDEDAY,SAVEND
          GOTO      DVAR9999
.
.         Low outlier
.
DVAR5000  PACK      KEY31,CASMXKEY,PTMIPCMX,KEY4
          CALL      RDPTLDF1
          BRANCH    OVRCD,DVAR9999
.
          MOVE      PTLDDREB,SAVHF
          MOVE      PTLDDPAT,SAVPAT
          MOVE      PTLDEDAY,SAVEND
.
DVAR9999  RETURN
+
.------------------------------------------------------------
. Set up additional fees variable for the selected column no
.------------------------------------------------------------
AVAR0000  MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVEND
          COMPARE   ZERO,ADDCOLNO
          GOTO      AVAR9999 IF EQUAL
.
          MOVE      ADDENDD[ADDCOLNO],KEY4
.
AVAR1000  PACK      KEY34 WITH CASMXKEY,PTMIPCMX,SAVBTYP,KEY4  
          CALL      RDPTAFE1               * Additional rates
          BRANCH    OVRCD,AVAR9999
.
          MOVE      PTFEDREB,SAVHF
          MOVE      PTFEDPAT,SAVPAT
          MOVE      PTFEEDAY,SAVEND
.
AVAR9999  RETURN
+
.------------------------------------------------------------
. Display As At bed days
.------------------------------------------------------------
ASAT0000  UNPACK    CHNGDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MATCH     SP70,SAVATYP
          GOTO      ASAT1000 IF EQUAL
.
          PACK      KEY5 WITH ANSA,SP1,SAVATYP
          CALL      RDCODE1
          BRANCH    OVRCD,ASAT1000
          MATCH     "U",TCINDC12
          GOTO      ASAT1000 IF NOT EQUAL
.
          CLEAR     KEY90
          APPEND    "Additional Casepayment Perdiem rate.",KEY90
          APPEND    SP70,KEY90
          RESET     KEY90
          GOTO      ASAT2000
.
ASAT1000  CLEAR     KEY90
          APPEND    "As at ",KEY90
          APPEND    CPCDATE,KEY90
          APPEND    " Patient has been in Hospital for : ",KEY90
          APPEND    NOHOSP,KEY90
          APPEND    " Days.",KEY90
          MATCH     ACLAIM,PTCNCLEV
          IF        @EQUAL
            APPEND    "(Including Leave Days)",KEY90
          ENDIF
          APPEND    SP70,KEY90
          RESET     KEY90
.
ASAT2000  MATCH     ANSY,PTMICMXP
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell align=center><b>":
                             KEY90,"</b></td></tr>";
.
ASAT9999  RETURN
+
.------------------------------------------------------------
. Display warning for changing the stepdown period
.------------------------------------------------------------
CPER0000  MATCH     ANSY,PTMICMXP
          GOTO      CPER9999 IF EQUAL         * Casemix payment
.
          COMPARE   ZERO,CFEETYP
          GOTO      CPER9999 IF NOT EQUAL     * not using bed fees
.
          COMPARE   ZERO,NOHOSP
          GOTO      CPER9999 IF EQUAL
.
          MOVE      ZERO,UPRANGE
          MOVE      ONE,COUNT
          MOVE      MAXNUM,FORM2
.
CPER1000  LOAD      UPRANGE WITH COUNT OF BFEND1,BFEND2,BFEND3,BFEND4:
                                            BFEND5,BFEND6
          COMPARE   ZERO,UPRANGE
          GOTO      CPER2000 IF EQUAL
.
.         If no of day is one, don't bother to check
.
          BRANCH    NOHOSP OF CPER9999
          ADD       ONE,UPRANGE
.
          COMPARE   UPRANGE,NOHOSP
          GOTO      CPER9999 IF EQUAL
.
CPER2000  ADD       ONE,COUNT
.         COMPARE   FIVE,COUNT        * Max column is only five
.         GOTO      CPER3000 IF EQUAL
.
          COMPARE   COUNT,FORM2       * Check with the available max column
          GOTO      CPER3000 IF LESS
.
          MOVE      ZERO,UPRANGE
          GOTO      CPER1000
.
CPER3000  PACK      KEY70,SP70
          CLEAR     KEY70
          APPEND    "Warning.. You will be ",KEY70
          APPEND    "modifying the stepdown period !! ",KEY70
          RESET     KEY70
.         WRITE     HTMLFILE;KEY70;
          WRITE     HTMLFILE;"<tr><td align=center><font color=#FF0000><b>":
                               KEY70,"</font></b></td></tr>";
.
CPER9999  RETURN
.
.------------------------------------------------------------
. Range of colum no for bed fee 
.------------------------------------------------------------
DFCL0000  MOVE      ZERO,FORM2
DFCL1000  ADD       ONE,FORM2
          COMPARE   FORM2,MAXNUM
          GOTO      DFCL9999 IF LESS
.
          IF        FORM2=DEFCOLNO
            WRITE     HTMLFILE;"<option value=#"",FORM2,"#" selected>":
                               FORM2,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",FORM2,"#">":
                               FORM2,"</option>"
          ENDIF
          GOTO      DFCL1000
.
DFCL9999  RETURN
+
.------------------------------------------------------------
. Bed fees amount
.------------------------------------------------------------
BFEE0000  IF        CFEETYP=5
            CALL      NZVR0000       * calculate NZ bed fees for new column no
          ELSE
            CALL      FVAR0000       * calculate bed fees for new column no
          ENDIF
          MOVE      SAVHF,BFEEAMNT
          ADD       SAVPAT,BFEEAMNT
          WRITE     HTMLFILE;BFEEAMNT;
BFEE9999  RETURN
+
.------------------------------------------------------------
. Bed fees discount
.------------------------------------------------------------
DISC0000  WRITE     HTMLFILE;DISCAMNT;
DISC9999  RETURN
+
.------------------------------------------------------------
. Bed fees allowance
.------------------------------------------------------------
ALLW0000  WRITE     HTMLFILE;ALLWAMNT;
ALLW9999  RETURN
+
.------------------------------------------------------------
. Daily total
.------------------------------------------------------------
DAYT0000  MOVE      BFEEAMNT,TOTALFEE
          SUB       DISCAMNT,TOTALFEE
          SUB       ALLWAMNT,TOTALFEE
          WRITE     HTMLFILE;TOTALFEE;
DAYT9999  RETURN
+
.------------------------------------------------------------
. Default column no
.------------------------------------------------------------
DCOL0000  WRITE     HTMLFILE;DEFCOLNO;
DCOL9999  RETURN
+
.------------------------------------------------------------
. Type of daily charge file
.------------------------------------------------------------
CFEE0000  WRITE     HTMLFILE;CFEETYP;
CFEE9999  RETURN
+
.------------------------------------------------------------
. Change date
.------------------------------------------------------------
CHDT0000  MATCH     CHNGDATE,SP70 
          GOTO      CHDT9999 IF EQUAL   
          UNPACK    CHNGDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
CHDT9999  RETURN
+
.------------------------------------------------------------
. Change time
.------------------------------------------------------------
CHTM0000  WRITE     HTMLFILE;CHNGTIME;
CHTM9999  RETURN
+
.------------------------------------------------------------
. New Patient portion for bed fees or daily charge
.------------------------------------------------------------
NPAT0000  WRITE     HTMLFILE;PPORAMNT;
NPAT9999  RETURN
+
.------------------------------------------------------------
. New Rebate portion
.------------------------------------------------------------
NREB0000  WRITE     HTMLFILE;RPORAMNT;
NREB9999  RETURN
+
.------------------------------------------------------------
. New end day range
.------------------------------------------------------------
NEND0000  WRITE     HTMLFILE;EDAYRANG;
NEND9999  RETURN
+
.--------------------------------------------------------------------
. Casepayment rate
.         F1=0 (Daily rate, either Low or High outlier) F1=1 (Additional rate)
.         RATEFLG= 0 - Low outlier, 1 - High outlier, 2 - Additional 
.--------------------------------------------------------------------
GTCP0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      ZERO,RATEFLG
          MOVE      ZERO,FIRST
          MOVE      SP10,PTHFBCAT
          MATCH     SP10,AFNDTB
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
          ENDIF
.
          PACK      SDIM27,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,PTMIPCMX
          PACK      SDIM30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,PTMIPCMX,SAVBTYP
.
          MOVE      ZERO,NOFEE
          MOVE      ZERO,NUMBER
          MOVE      ZERO,BFCOL
          MOVE      ZERO,COLNO
          MOVE      ZERO,CBFLAG
          CALL      CLROW0000           * Clear variables
.
          COMPARE   THREE,ASTAT
          GOTO      GTCP0100 IF NOT EQUAL
          MATCH     ADATE,DDATE
          GOTO      GTCP9999 IF EQUAL
.
.         Set up the first column
.
GTCP0100  ADD       ONE,COLNO
          MOVE      SP70,ROW1[COLNO]
          MOVE      "Patient",ROW2[COLNO]
          MOVE      "H.F.",ROW3[COLNO]
          MOVE      "Total",ROW4[COLNO]
          MOVE      SP70,ROW5[COLNO]
          MOVE      ZERO,FORM2
.
GTCP0200  MOVE      TWO,RATEFLG          * default to additional rate
          COMPARE   THREE,ASTAT
          GOTO      GTCP1000 IF NOT EQUAL
          MATCH     ADATE,DDATE
          GOTO      GTCP1000 IF NOT EQUAL
.
.         Display daycase rate as the additional charge
.
          MOVE      SDIM30,KEY30
          CALL      RDPTASD1
          BRANCH    OVRCD,GTCP5000
.
          MOVE      PTADDREB,SAVHF 
          MOVE      PTADDPAT,SAVPAT
          MOVE      ZERO,ENDDAY
          MOVE      ONE,BFCOL
          GOTO      GTCP6000
.
GTCP1000  BRANCH    F1,GTCP1100            * Display additional rate
          IF        LOWFLAG=1
            MOVE      ZERO,RATEFLG         * Low outlier
          ELSE
            MOVE      ONE,RATEFLG          * High outlier
          ENDIF
.
GTCP1100  CALL      RSRT0000               * Position read
GTCP1200  CALL      RKRT0000
          COMPARE   ZERO,OVRCD
          GOTO      GTCP6000 IF EQUAL
.
GTCP5000  MOVE      ZERO,OVRCD
          COMPARE   ZERO,BFCOL
          GOTO      GTCP9999 IF NOT EQUAL
.
          MOVE      ONE,OVRCD
          ADD       ONE,FORM2
          MOVE      ONE,DEFFEES
          BRANCH    FORM2,GTCP5200,GTCP5500
GTCP5129  MOVE      ONE,NOFEE
          GOTO      GTCP9999
.
.         Try without hf
.
GTCP5200  BRANCH     RATEFLG,GTCP5300,GTCP5400
GTCP5300  PACK       SDIM27,CONTRCID,ACLAIM,SP6,SP3,PTMIPCMX,SP10
          GOTO       GTCP0200
GTCP5400  PACK       SDIM30,CONTRCID,ACLAIM,SP6,SP3,PTMIPCMX,SAVBTYP,SP10
          GOTO       GTCP0200
.
.         Try with zero claim code
.
GTCP5500  BRANCH     RATEFLG,GTCP5600,GTCP5700
.
GTCP5600  IF        IBCNMHOS=1
            MOVE      MULTHOSP,KEY3
            CALL      RDPTHSP1
            PACK       SDIM27,CONTRCID,PTHSDCLM,SP6,SP3,PTMIPCMX,SP10
          ELSE
            PACK       SDIM27,CONTRCID,PTCNDCLM,SP6,SP3,PTMIPCMX,SP10
          ENDIF
          GOTO       GTCP0200
.
GTCP5700  IF        IBCNMHOS=1
            PACK       SDIM30,CONTRCID,PTHSDCLM,SP6,SP3,PTMIPCMX,SAVBTYP,SP10
          ELSE
            PACK       SDIM30,CONTRCID,PTCNDCLM,SP6,SP3,PTMIPCMX,SAVBTYP,SP10
          ENDIF
          GOTO       GTCP0200
.
.         Set up each column
.
GTCP6000  MOVE      SAVPAT,TOTAL
          ADD       SAVHF,TOTAL
          ADD       ONE,BFCOL
          ADD       ONE,COLNO
.
          PACK      CASMXKEY,SDIM30,SP70
          IF        RATEFLG=1
            PACK      CASMXKEY,SDIM27,SP70
          ENDIF
.
          MOVE      SP10,KEY4
          MOVE      ENDDAY,KEY4
          COMPARE   ZERO,ENDDAY
          GOTO      GTCP6100 IF NOT EQUAL
.
          MOVE      "DAYCASE",ROW1[COLNO]
          MOVE      SAVPAT,ROW2[COLNO]
          MOVE      SAVHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          GOTO      GTCP9999
.
.         Not a day case
.
GTCP6100  BRANCH    FIRST,GTCP7200
          RESET     ROW1[COLNO]
          APPEND    "1 - ",ROW1[COLNO]
          APPEND    KEY4,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      SAVPAT,ROW2[COLNO]
          MOVE      SAVHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
          MOVE      ONE,FIRST
          GOTO      GTCP8000
.
.         Setup each column of bed fee
.
GTCP7200  RESET     ROW1[COLNO]
          APPEND    NUMBER,ROW1[COLNO]
          APPEND    " - ",ROW1[COLNO]
          APPEND    KEY4,ROW1[COLNO]
          RESET     ROW1[COLNO]
          MOVE      SAVPAT,ROW2[COLNO]
          MOVE      SAVHF,ROW3[COLNO]
          MOVE      TOTAL,ROW4[COLNO]
          MOVE      BFCOL,ROW5[COLNO]
.
GTCP8000  MOVE      ZERO,NUMBER
          MOVE      ENDDAY,NUMBER
          ADD       ONE,NUMBER
.
          IF        F1=1
            MOVE      ENDDAY,ADDENDD[BFCOL]
            MOVE      BFCOL,MAXADD
          ELSE
            MOVE      ENDDAY,DAYENDD[BFCOL]
            MOVE      BFCOL,MAXDAY
          ENDIF
.
          MOVE      ZERO,ENDDAY
          GOTO      GTCP1200
.
GTCP9999  RETURN
+
.------------------------------------------------------------
. Casepayment Lumpsum amount
.------------------------------------------------------------
CPLP0000  MOVE      ZERO,FORM82
.         COMPARE   ZERO,AINVPRT
.         GOTO      CPLP9000 IF NOT EQUAL
.
          CALL      CHKACCM0           * Check if accom.has been charged
          BRANCH    EXIT,CPLP9000      * Found accommodation record
.
          IF        LOWFLAG <> 1
            MOVE      LUMPAT,FORM82
            ADD       LUMHF,FORM82
          ENDIF
CPLP9000  WRITE     HTMLFILE;FORM82;
CPLP9999  RETURN
+
.------------------------------------------------------------
. Default column no of Daily charge for casepayment
.------------------------------------------------------------
DFDA0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,DFDA2000
          MOVE      ZERO,FORM1
          COMPARE   ZERO,MAXDAY
          GOTO      DFDA1200 IF EQUAL
.
DFDA1000  COMPARE   NINE,FORM1
          GOTO      DFDA9999 IF EQUAL       * max column no for C/P
          ADD       ONE,FORM1
          COMPARE   FORM1,MAXDAY
          GOTO      DFDA9999 IF LESS
.
          IF        FORM1=DEFCOLNO
            WRITE     HTMLFILE;"<option value=#"",FORM1,"#" selected>":
                               FORM1,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",FORM1,"#">":
                               FORM1,"</option>";
          ENDIF
          GOTO      DFDA1000
.
DFDA1200  WRITE     HTMLFILE;"<option value=#"",FORM1,"#">":
                               FORM1,"</option>";
          GOTO      DFDA9999
.
.         'No Pay day' period will have no Daily charge
.
DFDA2000  IF        ECTRFLAG<>0
            PACK      NPSTRTDT,NPSTRTDT,SP70
            MATCH     SP70,NPSTRTDT
            IF        !@EQUAL
              MATCH     NPSTRTDT,CHNGDATE
              IF        !@LESS
                MATCH     CMSTRTDT,CHNGDATE
                IF        @LESS
                  MOVE      ZERO,DEFCOLNO
                  MOVE      ZERO,BFECOLNO
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;DEFCOLNO;
DFDA9999  RETURN
+
.------------------------------------------------------------
. Default  column no of Additional charge for casepayment
.------------------------------------------------------------
DFAD0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,DFAD2000
.
          MOVE      ZERO,FORM1
DFAD1000  COMPARE   NINE,FORM1
          GOTO      DFAD9999 IF EQUAL       * Max column for C/P 
          ADD       ONE,FORM1
          COMPARE   FORM1,MAXADD
          GOTO      DFAD9999 IF LESS
.
          IF        FORM1=DEFCOLAD
            WRITE     HTMLFILE;"<option value=#"",FORM1,"#" selected>":
                               FORM1,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",FORM1,"#">":
                               FORM1,"</option>";
          ENDIF
          GOTO      DFAD1000
.
DFAD2000  IF        ECTRFLAG=2
            PACK      NPSTRTDT,NPSTRTDT,SP70
            MATCH     SP70,NPSTRTDT
            IF        !@EQUAL
              MATCH     NPSTRTDT,CHNGDATE
              IF        !@LESS
                MATCH     CMSTRTDT,CHNGDATE
                IF        @LESS
                  MOVE      ZERO,DEFCOLAD    * No charge on 'No Pay Day' period
                  MOVE      ZERO,ADDCOLNO
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;DEFCOLAD;
DFAD9999  RETURN
+
.------------------------------------------------------------
. Daily fee amount
.------------------------------------------------------------
DFEE0000  CALL      DVAR0000          * calculate bed fees for new column no
          MOVE      SAVHF,BFEEAMNT
          ADD       SAVPAT,BFEEAMNT
          WRITE     HTMLFILE;BFEEAMNT;
DFEE9999  RETURN
.------------------------------------------------------------
. Additional fee amount
.------------------------------------------------------------
AFEE0000  CALL      AVAR0000          * calculate bed fees for new column no
          MOVE      SAVHF,ADDFAMNT
          ADD       SAVPAT,ADDFAMNT
          WRITE     HTMLFILE;ADDFAMNT;
AFEE9999  RETURN
.
.------------------------------------------------------------
. Daily total
.------------------------------------------------------------
DTOT0000  MOVE      BFEEAMNT,TOTALFEE
          ADD       ADDFAMNT,TOTALFEE
          SUB       DISCAMNT,TOTALFEE
          SUB       ALLWAMNT,TOTALFEE
          WRITE     HTMLFILE;TOTALFEE;
DTOT9999  RETURN
+
.------------------------------------------------------------
. New end day range
.------------------------------------------------------------
NAND0000  WRITE     HTMLFILE;ADAYRANG;
NAND9999  RETURN
+
.------------------------------------------------------------
. New Patient portion for additional charge
.------------------------------------------------------------
NDAY0000  WRITE     HTMLFILE;PADDAMNT;
NDAY9999  RETURN
+
.------------------------------------------------------------
. New Rebate portion for additional charge
.------------------------------------------------------------
ADAY0000  WRITE     HTMLFILE;RADDAMNT;
ADAY9999  RETURN
+
+
.------------------------------------------------------------
. Validate Date
.------------------------------------------------------------
VALDT000  REP        " 0",TRANDATE
.
.         Date must be after the admission date
.
          UNPACK     ADATE WITH XCENT,XYEAR,XMON,XDAY
          PACK       XDATE WITH XCENT,XYEAR,XMON,XDAY
          REP        " 0",XDATE
.
          MATCH      XDATE,TRANDATE
          GOTO       VALDT900 IF LESS
.
.         Date must be before discharge date (or current date if current)
.
          PACK       XDATE WITH CCC,CYY,CMM,CDD
          REP        " 0",XDATE
.
          COMPARE    THREE,ASTAT
          GOTO       VALDT010 IF NOT EQUAL
.
          UNPACK     DDATE WITH XCENT,XYEAR,XMON,XDAY
          PACK       XDATE WITH XCENT,XYEAR,XMON,XDAY
.
VALDT010  MATCH      TRANDATE,XDATE
          GOTO       VALDT990 IF NOT LESS
.
          UNPACK     XDATE WITH XCENT,XYEAR,XMON,XDAY
          GOTO       VALDT910
.
VALDT900  CLEAR      WEBTITLE 
          PACK       KEY8,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          APPEND     "Date must be >= ",WEBTITLE
          APPEND     KEY8,WEBTITLE
          RESET      WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALDT999
.
VALDT910  CLEAR      WEBTITLE 
          PACK       KEY8,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          APPEND     "Date must be <= ",WEBTITLE
          APPEND     KEY8,WEBTITLE
          RESET      WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALDT999
.
VALDT990  MOVE       ZERO,EXIT
VALDT999  RETURN 
+
.--------------------------------------------------------------------
.         Position read for different rates
.--------------------------------------------------------------------
RSRT0000  BRANCH     RATEFLG,RSRT7000,RSRT8000
          PACK       KEY31,SDIM27,SP20
          CALL       RSPTLDF1               * low outliers
          GOTO       RSRT9999
.
RSRT7000  PACK       KEY31,SDIM27,SP20
          CALL       RSPTHDF1               * high outliers
          GOTO       RSRT9999
.
RSRT8000  PACK       KEY34,SDIM30,SP20
          CALL       RSPTAFE1               * additional rates
RSRT9999  RETURN
+
.--------------------------------------------------------------------
.    Read next record for different rates
.--------------------------------------------------------------------
RKRT0000  BRANCH     RATEFLG,RKRT1000,RKRT2000
          CALL       RKPTLDF1               * low outliers
          BRANCH     OVRCD,RKRT9999
          PACK       DIM27,CONTRCID,PTLDCLMN,PTLDHFND,PTLDTABT,PTLDCASM
          MATCH      DIM27,SDIM27
          IF         @EQUAL
            MOVE       PTLDEDAY,ENDDAY
            MOVE       PTLDDPAT,SAVPAT
            MOVE       PTLDDREB,SAVHF
          ELSE
            MOVE       ONE,OVRCD
          ENDIF
          GOTO       RKRT9999
.
RKRT1000  CALL       RKPTHDF1               * high outliers
          BRANCH     OVRCD,RKRT9999
          PACK       DIM27,CONTRCID,PTHDCLMN,PTHDHFND,PTHDTABT,PTHDCASM
          MATCH      DIM27,SDIM27
          IF         @EQUAL
            MOVE       PTHDEDAY,ENDDAY
            MOVE       PTHDDPAT,SAVPAT
            MOVE       PTHDDREB,SAVHF
          ELSE
            MOVE       ONE,OVRCD
          ENDIF
          GOTO       RKRT9999
.
RKRT2000  CALL       RKPTAFE1               * Additional rates
          BRANCH     OVRCD,RKRT9999
          PACK       DIM30,CONTRCID,PTFECLMN,PTFEHFND,PTFETABT,PTFECASM,PTFEBTYP
          MATCH      DIM30,SDIM30
          IF         @EQUAL
            MOVE       PTFEEDAY,ENDDAY
            MOVE       PTFEDPAT,SAVPAT
            MOVE       PTFEDREB,SAVHF
          ELSE
            MOVE       ONE,OVRCD
          ENDIF
RKRT9999  RETURN
+
.------------------------------------------------------------
.      These are dummy routine's that need to be defined for 
.      PATDSBFE,PATINVS.
.------------------------------------------------------------
ADDWRN00
PATSTRYR
PDAT0000               * for ABFSAINV
          RETURN
.------------------------------------------------------------
. Routines that should never be called
.------------------------------------------------------------
PATDSITM  DISPLAY   "ERROR ROUTINE PATDSITM CALLED"
          RETURN
PATDSMSC  DISPLAY   "ERROR ROUTINE PATDSMSC CALLED"
          RETURN
PATDSALW  DISPLAY   "ERROR ROUTINE PATDSALW CALLED"
          RETURN
PATDSCOD  DISPLAY   "ERROR ROUTINE PATDSCOD CALLED"
          RETURN
.
.------------------------------------------------------------
.     Clear Claim Details
.------------------------------------------------------------
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      ZERO,WCCLMNO
.
          MOVE      SP70,VCLMNO
.
          MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
.
          MOVE      SP70,PMWXVISN           * Visit Number
          MOVE      SP70,PMWXALOC           * Accident Location
          MOVE      SP70,PMWXCINJ           * of Injury (Cat IK)
          MOVE      SP70,PMWXICOD           * Injury Code (Cat IJ)
          MOVE      SP70,PMWXCNAM           * Contact Name
          MOVE      SP70,PMWXCDTE           * Date Record Created (ccyymmdd)
          MOVE      SP70,PMWXCTIM           * Time Record Created (hh:mm:ss)
          MOVE      SP70,PMWXWEBC           * WEB User Id rec. creator(websecaf)
          MOVE      SP70,PMWXLUPD           * Last Update Date (ccyymmdd)
          MOVE      SP70,PMWXLUPT           * Last Update Time (hh:mm:ss)
          MOVE      SP70,PMWXWEBU           * WEB User Id rec. updater(websecaf)
          MOVE      SP70,PMWXSPAR           * Spare Variable
.
          MOVE      SP70,PMCTADMN           * Admission Number
          MOVE      SP70,PMCTURNO           * U/R Number
          MOVE      SP70,PMCTVDAT           * Visit Date
          MOVE      SP70,PMCTSNAM           * Solicitor's name
          MOVE      SP70,PMCTSAD1           * Solicitor's address line 1
          MOVE      SP70,PMCTSAD2           * Solicitor's address line 2
          MOVE      SP70,PMCTSAD3           * Solicitor's address line 3
          MOVE      SP70,PMCTSAD4           * Solicitor's address line 4
          MOVE      SP70,PMCTSPCO           * Solicitor's postcode
          MOVE      SP70,PMCTSPHN           * Solicitor's phone number
          MOVE      SP70,PMCTCONT           * Contact Name
          MOVE      SP70,PMCTREFN           * Reference Number
.
          MOVE      SP70,COMPCLAM
          MOVE      SP70,COMPDATE
.
CLRCLM99  RETURN
.
.------------------------------------------------------------
. Expected Payor Maintenance
.------------------------------------------------------------
EXPPAY00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EXPPAY50 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      EXPPAY10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      EXPPAY20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      EXPPAY30 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Swap formaction
          GOTO      EXPPAY40 IF EQUAL
.
          GOTO      EXPPAY90
.
.         ************ ADD FORMACTION ***********
.
EXPPAY10  PACK      KEY14,VSPAY001,VSPAY002,SP70
          CALL      RAVSPAY1
          COMPARE   ZERO,OVRCD
          GOTO      EXPPAY91 IF EQUAL
.
          MOVE      ONE,F2
          PACK      KEY10,VSPAY001,Z70
          CALL      RSVSPAY2                     * Generate sequence number
          CALL      RPVSPAY2
          BRANCH    OVRCD,EXPPAY15
.
          MATCH     VSPAY001,VSPAVISN
          GOTO      EXPPAY15 IF NOT EQUAL
.
          MOVE      VSPASEQN,F2
          ADD       ONE,F2
.
EXPPAY15  CALL      CLVISPAY                     * Clear all the file variables
          CALL      CLVISPMA                     * Clear file vars
          CALL      MVVSPA00                     * Move cgi to file variables
.
          MOVE      F2,VSPASEQN                  * Allocate sequence number
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPACDAT                * System date
          CLOCK     TIME,VSPACTIM                * System time
          MOVE      USERID,VSPACUID              * web user id
.
          PACK      KEY14,VSPAY001,VSPAY002,SP70
          CALL      WRVSPAY1                     * Writes the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ UPDATE FORMACTION **********
.
EXPPAY20  PACK      KEY14,VSPAY001,VSPAY002,SP70
          CALL      RDVSPAY1
          BRANCH    OVRCD,EXPPAY92
.
          CALL      MVVSPA00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPAUDAT                * System date
          CLOCK     TIME,VSPAUTIM                * System time
          MOVE      USERID,VSPAUUID              * web user id
.
          CALL      UPVSPAY1                     * Updates the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ DELETE FORMACTION **********
.
EXPPAY30  PACK      KEY14,VSPAY001,VSPAY002,SP70
          CALL      RDVSPAY1
          BRANCH    OVRCD,EXPPAY92
.
          CALL      DEVSPAY1                        * Deletes the data
.
.                                                * resequence all Payors
EXPPAY34  MOVE      ZERO,F2
          PACK      KEY10,VSPAY001,SP70
          CALL      RSVSPAY2                     * Generate sequence number
EXPPAY35  CALL      RKVSPAY2
          BRANCH    OVRCD,EXPPAY39
.
          MATCH     VSPAY001,VSPAVISN
          GOTO      EXPPAY39 IF NOT EQUAL
.
          ADD       ONE,F2
          MOVE      F2,KEY2
          MATCH     KEY2,VSPASEQN
          GOTO      EXPPAY35 IF EQUAL
.
          MOVE      KEY2,VSPASEQN
          CALL      UPVSPAY2
          GOTO      EXPPAY34
.
EXPPAY39  MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ SWAP FORMACTION **********
.
EXPPAY40  PACK      KEY10,VSPAY001,MOVESEQN,SP70
          CALL      RDVSPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      VSPASEQN,SAVESEQN
.
          MOVE      "XX",VSPASEQN                * Move to a temp sequence
          CALL      UPVSPAY2
.
          PACK      KEY10,VSPAY001,MOVTOSEQ,SP70
          CALL      RDVSPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      SAVESEQN,VSPASEQN            * Swap sequences
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPAUDAT                * System date
          CLOCK     TIME,VSPAUTIM                * System time
          MOVE      USERID,VSPAUUID              * web user id
.
          CALL      UPVSPAY2
.
          PACK      KEY10,VSPAY001,ANSX,ANSX,SP70
          CALL      RDVSPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      MOVTOSEQ,VSPASEQN            * Move temp sequence back
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPAUDAT                * System date
          CLOCK     TIME,VSPAUTIM                * System time
          MOVE      USERID,VSPAUUID              * web user id
.
          CALL      UPVSPAY2
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ DISPLAY FORMACTION **********
.
EXPPAY50  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,EXPPAY93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPPAY93
.
          PACK      KEY14,VSPAY001,VSPAY002,SP70
          CALL      RDVSPAY1                      * Read department table
          IF        OVRCD=1
            CALL      CLVISPAY                    * Clear all the file variables
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,EXPPAY94
.
          CLEAR     WEBTITLE
          MOVE      "Expected Payor Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXPPAY99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY91  MOVE      "Expected Payor Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY92  MOVE      "Invalid Expected Payor Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY93  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY94  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY99  RETURN
.
.------------------------------------------------------------
. List Expected Payor Details for this visit
.------------------------------------------------------------
LSTPAY00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MATCH     "0",PTCNUCCP
..        IF        @EQUAL
            UNPACK    DIM127,D1,DIM8A,DIM127
            UNPACK    DIM127,D1,DIM2A,DIM127
            UNPACK    DIM127,D1,DIM3A,DIM127
..        ENDIF
.
          MOVE      ZERO,LASTSEQN
          PACK      KEY10,ADMISSNO,Z70
          CALL      RSVSPAY2
          CALL      RPVSPAY2                * Get highest sequence number
          BRANCH    OVRCD,LSTPAY05
.
          MATCH     ADMISSNO,VSPAVISN
          GOTO      LSTPAY05 IF NOT EQUAL
.
          MOVE      VSPASEQN,LASTSEQN
.
LSTPAY05  PACK      KEY10,ADMISSNO,SP70
          CALL      RSVSPAY2
LSTPAY10  CALL      RKVSPAY2
          BRANCH    OVRCD,LSTPAY99
.
          MATCH     ADMISSNO,VSPAVISN
          GOTO      LSTPAY99 IF NOT EQUAL
.
          PACK      KEY14,VSPAPAYC,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      VSPAPAYC,HFNAME
          ENDIF
.
          MOVE      ZERO,PTFXEXTR                                     *I-103368
          PACK      KEY6,VSPAPAYC,SP8       * is H/F MediSave? PTFXEXTR = 1
          CALL      RDPTFX11
.
          MOVE      "No ",DIM3
          IF        VSPAISEN=1
            MOVE      "Yes",DIM3
          ENDIF
.
          MATCH     "1",VSPAACTV
          IF        @EQUAL
            MOVE      "Inactive",DIM8
          ELSE
            MOVE      "Active",DIM8
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,VSPAUDAT
          IF        !@EQUAL
            UNPACK    VSPAUDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,VSPACDAT
          IF        !@EQUAL
            UNPACK    VSPACDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             "<A HREF='javascript:":
                             "UpdatePayor":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&vspay001=",VSPAVISN:
                             "&vspay002=",VSPAPAYC,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             VSPAPAYC,"</td>":
                             "<td>&nbsp;",HFNAME,"</td>";
.
          MOVE      VSPASEQN,DIM2
          REP       " 0",DIM2
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          WRITE     HTMLFILE;"<td><form action=patweb71.pbl ":
                               "method=post name=moveseq_",DIM2,">":
                             "<input type=hidden name=reportno ":
                              "value=#"10#">":
                             "<input type=hidden name=updttype ":
                              "value=#"S#">":
                             "<input type=hidden name=template ":
                              "value=#"",KEY3,"#">":
                             "<input type=hidden name=vspay001 ":
                              "value=#"",VSPAVISN,"#">":
                             "<input type=hidden name=moveseqn ":
                              "value=#"",VSPASEQN,"#">":
                             "<select name=movtoseq ":
                             " onchange=MoveSeq(moveseq_",DIM2,");>";
.
          MOVE      ZERO,SEQUENCE
          MOVE      VSPASEQN,SEQUENCE
          MOVE      ONE,SEQCOUNT
LSTPAY20  IF        SEQCOUNT=SEQUENCE
            WRITE     HTMLFILE;"<option value=#"",SEQCOUNT,"#" selected>":
                                SEQCOUNT,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",SEQCOUNT,"#">":
                                SEQCOUNT,"</option>";
          ENDIF
          ADD       ONE,SEQCOUNT
.
          COMPARE   SEQCOUNT,LASTSEQN
          GOTO      LSTPAY20 IF NOT LESS
.
          WRITE     HTMLFILE;"</select></form></td>":
                             "<td>&nbsp;",VSPACOMM,"</td>":
                             "<td>&nbsp;",DIM3,"</td>":
                             "<td>&nbsp;",DIM8,"</td>":
                             "<td>&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DISPDATE,"</td>";
.
          COMPARE   ONE,PTFXEXTR                                      *I-103368
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp; &nbsp; &nbsp; ":
                               "<A HREF='javascript:":
                               "ListAccounts":
                               "(#"",DIM8A,"#.pbl":
                               "?reportno=",DIM2A:
                               "&template=",DIM3A:
                               "&urnumber=",URNUMBER:
                               "&admissno=",ADMISSNO:
                               "&vspay001=",VSPAVISN:
                               "&vspay002=",VSPAPAYC,"#")'>":
                               "<img src=../images/MaintenanceIcon.gif ":
                               "hspace=4 border=0 align=absmiddle></td>"; 
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp; &nbsp; &nbsp; </td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
          GOTO      LSTPAY10
.
LSTPAY99  RETURN
+
.------------------------------------------------------------
. Expected Payer Member Accounts Maintenance
.------------------------------------------------------------
EXPPMA00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EXPPMA50 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      EXPPMA10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      EXPPMA20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      EXPPMA30 IF EQUAL
.
          GOTO      EXPPMA90
.
.         ************ ADD FORMACTION ***********
.
EXPPMA10  PACK      KEY23,VSPMA001,VSPMA003,SP70
          CALL      RAVSPMA1
          COMPARE   ZERO,OVRCD
          GOTO      EXPPMA91 IF EQUAL
.
EXPPMA15  CALL      CLVISPMA                     * Clear file vars
          CALL      MVVSPM00                     * Move cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPMCDAT                * System date
          CLOCK     TIME,VSPMCTIM                * System time
          MOVE      USERID,VSPMCUID              * web user id
.
          PACK      KEY23,VSPMA001,VSPMA003,SP70
          CALL      WRVSPMA1                     * Writes the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPMA99
.
.         ************ UPDATE FORMACTION **********
.
EXPPMA20  PACK      KEY23,VSPMA001,VSPMA003,SP70
          CALL      RDVSPMA1
          BRANCH    OVRCD,EXPPMA92
.
          CALL      MVVSPM00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPMUDAT                * System date
          CLOCK     TIME,VSPMUTIM                * System time
          MOVE      USERID,VSPMUUID              * web user id
.
          CALL      UPVSPMA1                     * Updates the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPMA99
.
.         ************ DELETE FORMACTION **********
.
EXPPMA30  PACK      KEY23,VSPMA001,VSPMA003,SP70
          CALL      RDVSPMA1
          BRANCH    OVRCD,EXPPMA92
.
          CALL      DEVSPMA1                        * Deletes the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPMA99
.
.         ************ DISPLAY FORMACTION **********
.
EXPPMA50  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,EXPPMA93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPPMA93
.
          PACK      KEY23,VSPMA001,VSPMA003,SP70
          CALL      RDVSPMA1                      * Read department table
          IF        OVRCD=1
            CALL      CLVISPMA                    * Clear all the file variables
          ENDIF
.
....      MOVE      ADMISSNO,KEY8
....      CALL      RDVISA1
....      BRANCH    OVRCD,EXPPMA94
.
          CLEAR     WEBTITLE
          MOVE      "Payor Medisave Account Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXPPMA99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA91  MOVE      "Payer Account Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA92  MOVE      "Invalid Payer Account Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA93  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA94  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPMA99
.
EXPPMA99  RETURN
.
.------------------------------------------------------------
. List Payer MediSave Account Details for this visit
.------------------------------------------------------------
LSTPMA00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
LSTPMA10  PACK      KEY23,ADMISSNO,SP30
          CALL      RSVSPMA1
LSTPMA20  CALL      RKVSPMA1
          BRANCH    OVRCD,LSTPMA99
.
          MATCH     ADMISSNO,VSPMVISN
          GOTO      LSTPMA99 IF NOT EQUAL
.
          MOVE      "Not Known",TDESC
          PACK      KEY5,CATRL,VSPMRLTP,SP5
          CALL      RDCODE1                 * Cat."RL" - Relationship
          MOVE      VSPMEAMT,DIM15
          MOVE      VSPMEPEC,DIM3
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             "<A HREF='javascript:":
                             "UpdateAccts":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&vspay001=",VSPAVISN:
                             "&vspay002=",VSPAPAYC:
                             "&vspma001=",VSPMVISN:
                             "&vspma002=",VSPMPAYC:
                             "&vspma003=",VSPMMACN,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             VSPMMACN,"</td>":
                             "<td>&nbsp;",VSPMMNAM,"</td>";
.
          WRITE     HTMLFILE;"</select></form></td>":
                             "<td>&nbsp;",TDESC,"</td>":    * Relationship
                             "<td>&nbsp;",DIM15,"</td>":
                             "<td>&nbsp;&nbsp;&nbsp;",DIM3,"</td></tr>" 
.
          GOTO      LSTPMA20
.
LSTPMA99  RETURN
+
.------------------------------------------------------------
.         Check for Events
.         Return KEY1=1 for Emergency 2=Outpatient
.------------------------------------------------------------
CEVT0000  MOVE      SP70,KEY1
          COMPARE   NINE,PVITYPE
          GOTO      CEVT9999 IF NOT EQUAL
.
          MATCH     " 1",PVISYST          * Event?
          GOTO      CEVT9999 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,CEVT9999
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CEVT9999
.
          MATCH     ANSE,TCINDC1
          IF        @EQUAL
            MOVE      "1",KEY1           * Emergency system
          ENDIF
.
          MATCH     ANSO,TCINDC1
          IF        @EQUAL
            MOVE      "2",KEY1           * Outpatient system
          ENDIF
.
CEVT9999  RETURN
+
.------------------------------------------------------------
. Delete Record from emrvcdaf
.------------------------------------------------------------
DVCD0000  MATCH     "8",PMMIRTYP
          GOTO      DVCD9999 IF NOT EQUAL
.
          PACK      KEY14,PMMIVISN,ZERO,ZERO,ZERO,FOUR,SP70
          CALL      RSEMVCD1
DVCD0100  CALL      RKEMVCD1
          BRANCH    OVRCD,DVCD9999
.
          MATCH     PMMIVISN,EMVCVIST
          GOTO      DVCD9999 IF NOT EQUAL
.
          MATCH     "004",EMVCTYPE
          GOTO      DVCD9999 IF NOT EQUAL
.
          COMPARE   SIX,EMVCCSYS
          GOTO      DVCD0100 IF NOT EQUAL
.
          MOVE      EMVCMNCD,DIM9
          MATCH     DIM9,PMMIITEM
          GOTO      DVCD0100 IF NOT EQUAL
.
          MATCH     EMVCSUBN,PMMISUBN
          GOTO      DVCD0100 IF NOT EQUAL
.
          MATCH     EMVCEDAD,PMMIEDAD
          GOTO      DVCD0100 IF NOT EQUAL
.
          MATCH     EMVCDATE,PMMITDAT
          GOTO      DVCD0100 IF NOT EQUAL
.
          MATCH     EMVCTIME,PMMISVTM
          GOTO      DVCD0100 IF NOT EQUAL
.
          PACK      KEY14,EMVCVIST,EMVCTYPE,EMVCUNIQ,SP70
          CALL      DEEMVCD1
.
DVCD9999  RETURN
+
.------------------------------------------------------------
. Selection of Action plans
.------------------------------------------------------------
SACT0000  PACK      KEY6,ACLAIM,SP70
          CALL      RSPTFAP1
SACT1000  CALL      RKPTFAP1
          BRANCH    OVRCD,SACT9999
.
          MATCH     ACLAIM,PTFPCLAI
          GOTO      SACT9999 IF NOT EQUAL
.
          MOVE      "AK",KEY2
          PACK      KEY5,KEY2,PTFPACPL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACT1000
.
          WRITE     HTMLFILE;"<option value=",PTFPACPL,">",TDESC,"</option>"
          GOTO      SACT1000
.
SACT9999  RETURN
+
.------------------------------------------------------------
. Display time in recovery
.------------------------------------------------------------
DRECV000  PACK      KEY31,ADMISSNO,SP70   * has the patient been to theatre?
          CALL      RSOPDEA2
DRECV100  CALL      RKOPDEA2
          BRANCH    OVRCD,DRECV999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DRECV999 IF NOT EQUAL
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,DRECV100
.
          MATCH     SP70,OPARTIRD
          GOTO      DRECV100 IF EQUAL    * Time in Recovery is blank
          MATCH     SP70,OPARTETC
          GOTO      DRECV100 IF EQUAL    * Time Exit Theatre is blank
.
          PACK      FIRSTDAT,OPDADATE,SP70
          PACK      LASTDATE,OPDADATE,SP70
.
          MOVE      OPARTIRD,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      FIRSTIME,DIM5,SP70
.
          MOVE      OPARTETC,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      LASTTIME,DIM5,SP70
.
.         Assume Overnight if Theatre Exit time is Less than Time in Recover.
.
          MATCH     FIRSTIME,LASTTIME
          IF        @LESS
            MOVE      FIRSTDAT,DATFIELD
            ADD       ONE,DATFIELD
            MOVE      DATFIELD,LASTDATE
          ENDIF
.
          CALL      TIMEDIFF               * calculate the time difference
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>":
                             "Recovery Time:",CALCTIME:
                             "mins, Booking ID:":
                             OPDAUNIQ,"</td></tr>";
          GOTO      DRECV100

DRECV999  RETURN
.
.------------------------------------------------------------
. Check if coding complete is required
.------------------------------------------------------------
CHCOD000  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND12;*103,PTCNHICC
.
          MATCH     "1",PTCNHICC          * not required
          GOTO      CHCOD999 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE          * coding is complete
          GOTO      CHCOD999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHCOD200
.
          MOVE      ACLAIM,KEY3
          CALL      RDPTCFA1
          IF        OVRCD=0
            MATCH     "3",PTCFCEFR  * Check if 'Not in use'
            IF        !@EQUAL
              MATCH     "1",PTCFHINV
              GOTO      CHCOD150 IF EQUAL  * Hold invoice until coding complete
            ENDIF
          ENDIF
.
          MATCH     "1",TCINDC10
          IF        @EQUAL
            GOTO      CHCOD100      * check health fund for Coding complete req.
          ENDIF
.
          MATCH     "2",TCINDC10
          IF        @EQUAL
            GOTO      CHCOD150      * Coding complete always required
          ENDIF
.
          MATCH     "0",TCINDC10
          IF        @EQUAL
            GOTO      CHCOD999      * don't check Coding complete
          ENDIF
.
          MATCH     "1",TCINDC5
          IF        !@EQUAL
            MATCH     "2",TCINDC5
            IF        !@EQUAL
              GOTO      CHCOD999
            ENDIF
          ENDIF
.
.         Check Health fund if Coding required
.
CHCOD100  MATCH     SP70,AFUNDH
          GOTO      CHCOD999 IF EQUAL
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,CHCOD999
.
          MATCH     "1",PTHFCARC
          GOTO      CHCOD999 IF NOT EQUAL
.
CHCOD150  MATCH     ALACDTE,ADATE
          GOTO      CHCOD999 IF NOT EQUAL
.
CHCOD200  MATCH     "1",PTCNHICC
          IF        @EQUAL
            MOVE      ONE,EXIT
          ENDIF
.
CHCOD999  RETURN
+
.------------------------------------------------------------
. Check if coding complete warning is required
.------------------------------------------------------------
CHCODW00  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND12;*103,PTCNHICC
.
          MATCH     "2",PTCNHICC          * not required
          GOTO      CHCODW99 IF NOT EQUAL
.
          MATCH     SP70,ACODDTE          * coding is complete
          GOTO      CHCODW99 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHCODW20
.
          MOVE      ACLAIM,KEY3
          CALL      RDPTCFA1
          IF        OVRCD=0
            MATCH     "3",PTCFCEFR  * Check if 'Not in use'
            IF        !@EQUAL
              MATCH     "1",PTCFHINV
              GOTO      CHCODW15 IF EQUAL  * Hold invoice until coding complete
            ENDIF
          ENDIF
.
          MATCH     "1",TCINDC10
          IF        @EQUAL
            GOTO      CHCODW10      * check health fund for Coding complete req.
          ENDIF
.
          MATCH     "2",TCINDC10
          IF        @EQUAL
            GOTO      CHCODW15      * Coding complete always required
          ENDIF
.
          MATCH     "0",TCINDC10
          IF        @EQUAL
            GOTO      CHCODW99      * don't check Coding complete
          ENDIF
.
          MATCH     "1",TCINDC5
          IF        !@EQUAL
            MATCH     "2",TCINDC5
            IF        !@EQUAL
              GOTO      CHCODW99
            ENDIF
          ENDIF
.
          MATCH     "1",TCINDC5
          IF        !@EQUAL
            MATCH     "2",TCINDC5
            IF        !@EQUAL
              GOTO      CHCODW99
            ENDIF
          ENDIF
.
CHCODW10  MATCH     SP70,AFUNDH
          GOTO      CHCODW99 IF EQUAL
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,CHCODW99
.
          MATCH     "1",PTHFCARC
          GOTO      CHCODW99 IF NOT EQUAL
.
CHCODW15  MATCH     ALACDTE,ADATE
          GOTO      CHCODW99 IF NOT EQUAL
.
CHCODW20  MOVE      ONE,EXIT
.
CHCODW99  RETURN
+
.------------------------------------------------------------
. Check if Theatre complete is required
.------------------------------------------------------------
CHCMB000  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND12;*102,PTCNHITC
.
          MATCH     "0",PTCNHITC          * not required
          GOTO      CHCMB999 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70   * is theatre complete
          CALL      RDPMVX11
          BRANCH    OVRCD,CHCMB999
.
          MATCH     "1",PMVXATCP
          GOTO      CHCMB999 IF EQUAL   * all theatre charges posted
.
          PACK      KEY31,AADMNO,SP70   * has the patient been to theatre?
          CALL      RSOPDEA2
CHCMB100  CALL      RKOPDEA2
          BRANCH    OVRCD,CHCMB999
.
          MATCH     KEY8,OPDAADMN
          GOTO      CHCMB999 IF NOT EQUAL
.
.         OPDASTAT=0 Booked, 1=Preadmitted 2=Admitted 3=Cancelled 4=Discharged
.
          BRANCH    OPDASTAT,CHCMB999,CHCMB200,CHCMB100,CHCMB200
          GOTO      CHCMB999
.
.         Check booking type 
.
CHCMB200  OPEN      BOKRC1A1,"bokrc1af"
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,CHCMB900
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHCMB900
          MATCH     "C",TCINDC1
          GOTO      CHCMB999 IF EQUAL       * not required theatre complete
.
CHCMB900  MOVE      ONE,EXIT                * raise button not available
.
CHCMB999  RETURN
+
.------------------------------------------------------------
. Check if Prosthetic complete is required
.------------------------------------------------------------
PROST000  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND13;*49,OPCNVPIN
          READ      CONTROLF,HUND18;*115,PTCNPROS
.
          MATCH     "1",PTCNPROS          * Prosthetic complete required ?
          GOTO      PROST800 IF NOT EQUAL
.
          PACK      KEY31,ADMISSNO,SP70   * has the patient been to theatre?
          CALL      RSOPDEA2
PROST100  CALL      RKOPDEA2
          BRANCH    OVRCD,PROST800
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      PROST800 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      PROST100 IF EQUAL       * Cancelled
.
.         Check for the 'Verify Prosthetics Implant' parameter
.
          MATCH     "1",OPCNVPIN
          GOTO      PROST300 IF NOT EQUAL * No Verify Prosthetic input
.
.         Check if Prostheics Verified 1 (OPDAVUN1)
.
          MATCH     SP70,OPDAVUN1
          GOTO      PROST900 IF EQUAL     * Blank username
.
.         Check if Prosthetics completed (OPDACOMP)
.
PROST300  MATCH     "1",OPDAPCOM
          GOTO      PROST100 IF EQUAL     * Prosthetics completed
          MATCH     "2",OPDAPCOM
          GOTO      PROST100 IF EQUAL     * N/A
          GOTO      PROST900
.
PROST800  MOVE      ZERO,EXIT
          GOTO      PROST999
.
PROST900  MOVE      ONE,EXIT
PROST999  RETURN
+
.------------------------------------------------------------
. Get the appropriate miscellaneous charges record
.------------------------------------------------------------
GETMSC00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9            * (MCHARGE re-use in PATMCHRD)
.
          UNPACK    SP20,PTHFBCAT      * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
          MOVE      PTHFBCAT,PTMCHFTT
.
          PACK      KEY29,ACLAIM,AFUNDH,PTMCHFTT,KEY9,CURRDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - try a blank health fund
.
GETMSC10  PACK      KEY29,ACLAIM,SP6,SP3,KEY9,CURRDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
.         No record with health fund detials - last chance, try default claim
.
GETMSC20  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ENDIF
.
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC99 IF EQUAL
.
GETMSC90  MOVE      ONE,EXIT
.
GETMSC99  RETURN
+
.------------------------------------------------------------
. NZ Private Cat CL Selection List
.------------------------------------------------------------
NZCTCL00  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF     
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
. 
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
NZCTCL10  CALL      RDKCODE2
          BRANCH    OVRCD,NZCTCL99
          MATCH     CATEGORY,TCODE
          GOTO      NZCTCL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      NZCTCL10 IF EQUAL
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      NZCTCL10 IF EQUAL
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,NZCTCL10
              ENDIF
.
              IF       PTCNNHII=ONE
                PACK     KEY40,WBSEHOSP,ACODE,SP70 
                CALL     RSMLCFN1
                CALL     RKMLCFN1
                BRANCH   OVRCD,NZCTCL10
.
                MATCH    MLCFHOSP,WBSEHOSP
                GOTO     NZCTCL10 IF NOT EQUAL
.
                MATCH    MLCFCLMC,ACODE
                GOTO     NZCTCL10 IF NOT EQUAL
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          ENDIF
          GOTO      NZCTCL10
NZCTCL99  RETURN
+
.------------------------------------------------------------
. NZ Private Contract Selection List
.------------------------------------------------------------
NZCTRT00  PACK      KEY14,SP70
          CALL      RDSFUND1
NZCTRT10  CALL      RDKFUND1
          BRANCH    OVRCD,NZCTRT99
          MATCH     "0000    ",HFTABL
          GOTO      NZCTRT10 IF NOT EQUAL     * skip table record
.
          BRANCH    PHFTACT,NZCTRT10   * if code is inactive,ignore
.
          MATCH     HCODE,FILTHFND
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
                               HCODE,": ",HFNAME,"</option>"
          ELSE
.
            IF        IBCNMHOS=ONE
              IF        PTCNNHII=ONE
                MATCH     SP70,FILTCLAM
                IF        !@EQUAL & !@EOS
.
                  MATCH    "All",FILTCLAM
                  GOTO     NZCTRT75 IF EQUAL
.
                  PACK     KEY30,SP1,SP1,SP1,FILTCLAM,SP70
                  CALL     RSNZCFN1
NZCLRT40          CALL     RKNZCFN1                           
                  BRANCH   OVRCD,NZCLRT60
.
                  MATCH    SP70,NZCFHOSP
                  GOTO     NZCLRT60 IF NOT EQUAL
.
                  MATCH    FILTCLAM,NZCFCLMC
                  GOTO     NZCLRT60 IF NOT EQUAL
.
                  MATCH    HCODE,NZCFCNTR
                  GOTO     NZCLRT40 IF NOT EQUAL
.
                  GOTO     NZCTRT80
.
NZCLRT60          PACK     KEY30,WBSEHOSP,FILTCLAM,SP70
                  CALL     RSNZCFN1
NZCLRT70          CALL     RKNZCFN1
                  BRANCH   OVRCD,NZCTRT10  
.
                  MATCH    WBSEHOSP,NZCFHOSP
                  GOTO     NZCTRT10 IF NOT EQUAL
.
                  MATCH    FILTCLAM,NZCFCLMC
                  GOTO     NZCTRT10 IF NOT EQUAL
.
                  MATCH    HCODE,NZCFCNTR
                  GOTO     NZCLRT70 IF NOT EQUAL
.
                  GOTO     NZCTRT80
.
                ELSE
.
NZCTRT75          PACK     KEY30,SP70
                  CALL     RSNZCFN1  
NZCTRT76          CALL     RKNZCFN1
                  BRANCH   OVRCD,NZCTRT77
.
                  MATCH    SP70,NZCFHOSP
                  GOTO     NZCTRT77 IF NOT EQUAL
.
                  MATCH    HCODE,NZCFCNTR
                  GOTO     NZCTRT76 IF NOT EQUAL
.
                  GOTO     NZCTRT80
.
NZCTRT77          PACK     KEY30,WBSEHOSP,SP70
                  CALL     RSNZCFN1
NZCTRT78          CALL     RKNZCFN1
                  BRANCH   OVRCD,NZCTRT10
.
                  MATCH    WBSEHOSP,NZCFHOSP
                  GOTO     NZCTRT10 IF NOT EQUAL
.
                  MATCH    HCODE,NZCFCNTR
                  GOTO     NZCTRT78 IF NOT EQUAL
.
                  GOTO     NZCTRT80
.
                ENDIF
              ENDIF
            ENDIF
.
NZCTRT80    WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
                               HCODE,": ",HFNAME,"</option>"
          ENDIF
          GOTO      NZCTRT10
.
NZCTRT99  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse
.------------------------------------------------------------
ECLIND00  MOVE      ZERO,DIM1
.
          COMPARE   ONE,PTCNUEDI
          GOTO      ECLIND90 IF NOT EQUAL
.
          MATCH     SP70,ACLAIM
          GOTO      ECLIND50 IF EQUAL
          GOTO      ECLIND50 IF EOS
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ECLIND50
.
          MATCH     ANSX,PTCDASC2                * Associated Field 2 
          GOTO      ECLIND90 IF EQUAL            * X - Exclude from Eclipse
.
          MOVE      ZERO,FORM1
          WHILE     FORM1 < 5
            ADD       ONE,FORM1
            LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
            MATCH     ANSV,ANS                   * DVA code ?
            IF        @EQUAL
              PACK      KEY3,ANSD,ANSV,ANSA,SP70
              CALL      RDPTPAR1
.             BRANCH    OVRCD,ECLIND90
              IF        OVRCD=1
.
                MATCH     "1",PTCNWSIN
                IF        @EQUAL
                  PACK      KEY3,ANSD,ANSV,ANSA,SP70
                  CALL      RDWBPAR1
                  IF        OVRCD=0
                    GOTO      ECLIND40
                  ENDIF
                ENDIF
.
                GOTO      ECLIND90
.
              ENDIF
.
ECLIND40      MOVE      ONE,DIM1
              GOTO      ECLIND90                 * yes
            ENDIF
          DO 
. 
ECLIND50  MATCH     SP70,AFUNDH
          GOTO      ECLIND90 IF EQUAL
          GOTO      ECLIND90 IF EOS
.
          PACK      KEY6,AFUNDH,SP70
          CALL      RDPTFX11
          BRANCH    OVRCD,ECLIND90 
.
          IF        PTFXEXTR=THREE
            MOVE      ONE,DIM1
          ENDIF 
.
ECLIND90  WRITE     HTMLFILE;DIM1;
ECLIND99  RETURN
+
.*****************************************************************************
.*                            ASEC0000                                       *
.*               Add one second to date/time                                 *
.* Requires: XDATTIME - Date/time value (ccyymmddhhmmss)                     *
.* Returns : XDATTIME - Date/time value (ccyymmddhhmmss) incremented by 1 sec*
.*****************************************************************************
ASEC0000  UNPACK    XDATTIME,DIM8,HOURTM,MINTIME,KEY2
          MATCH     "59",KEY2
          IF        !@EQUAL
            MOVE      KEY2,FORM2              * just increment seconds
            ADD       ONE,FORM2
            MOVE      FORM2,KEY2
            REP       " 0",KEY2
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,KEY2
            GOTO      ASEC9999
          ENDIF
.
.         The seconds were "59", so reset these to "00" and increment the
.         minutes
.
          MOVE      "00",KEY2
          MATCH     "59",MINTIME
          IF        !@EQUAL
            MOVE      MINTIME,FORM2              * just increment minutes
            ADD       ONE,FORM2
            MOVE      FORM2,MINTIME
            REP       " 0",MINTIME
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,KEY2
            GOTO      ASEC9999
          ENDIF
.
.         The minutes were "59", so reset these to "00" and increment the
.         hours
.
          MOVE      "00",KEY2
          MOVE      "00",MINTIME
          MATCH     "23",HOURTM
          IF        !@EQUAL
            MOVE      HOURTM,FORM2              * just increment hours
            ADD       ONE,FORM2
            MOVE      FORM2,HOURTM
            REP       " 0",HOURTM
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,KEY2
            GOTO      ASEC9999
          ENDIF
.
.         The hours were "59", so reset these to "00" and increment the
.         date
.         We need to increment the date by 1 day
.
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON                       * get julian day
          ADD       ONE,JULDAY                   * increment julian day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                       * get new date
          PACK      XDATTIME,CC,YY,MM,DD,ZERO6
          REP       " 0",XDATTIME
.
ASEC9999  RETURN
.
.*****************************************************************************
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.*****************************************************************************
DSEF0000  MOVE      ZERO,EXIT
          COMPARE   TWO,CNTRCEFR
          GOTO      DSEF9999 IF NOT EQUAL      * Not 'For Discharges From'
.
          PACK      DDATE,DDATE,SP70
          MATCH     SP70,DDATE
          GOTO      DSEF9999 IF NOT EQUAL
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "A",TCINDC2
            GOTO      DSEF9999 IF EQUAL        * ABF
.
            MATCH     "D",TCINDC19
            IF        @EQUAL
              PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
              REP       " 0",CEFFDATE
              GOTO      DSEF9999
            ENDIF
          ENDIF
          MOVE      ONE,EXIT
DSEF9999  RETURN
+
.-------------------------------------------------------------------------------
. LIN10000 - List of Insurance Companies for Other Compensable Details Screen
.-------------------------------------------------------------------------------
LIN10000  PACK      KEY6,SP70
          CALL      RDSINSR1
LIN11000  CALL      RDKINSR1
          BRANCH    OVRCD,LIN19999
.
          PACK      KEY8,QUOTE,ICODE,QUOTE
          MATCH     ICODE,PMEXSCHL
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               INAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",INAME,"</option>"
          ENDIF
.
          GOTO      LIN11000
.
LIN19999  RETURN
+
.----------------------------------------------------------------------
.   Invoice payer breakdown
.----------------------------------------------------------------------
PAYB0000  CALL      XMLHED00
          BRANCH    EXIT,PAYB9999
          MOVE      ADMISSNO,AADMNO
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYB9998
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYB9998
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYB9998
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA3,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYB9998
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PAYB9998
.
          MOVE      ALACDTE,FROMDATE
          MATCH     SP70,CHNGDATE
          IF        @EQUAL
            PACK      TODATE,CCC,CYY,CMM,CDD  * Default to current date
            IF        ASTAT=3
              MOVE      DDATE,TODATE
            ENDIF
          ELSE
            MOVE      CHNGDATE,TODATE
          ENDIF
          REP       " 0",TODATE
.
          MOVE      ZERO,NBRDAYS
          DAYSEP    FROMDATE,TODATE,NBRDAYS * LOS include leaves
.
          MOVE      PMPYR003,KEY3
          CALL      DEBR0000              * Remove payer existing breakdown
          MOVE      ZERO,FORM12P2
.
          IF        LINENUMB<>1
            PACK      KEY9,ITEMCODE,SP70
            CALL      ITMI0000                 * Check if item has been entered
            BRANCH    EXIT,PAYB2000
          ELSE
            CALL      FACM0000                 * Accom.start date for this payer
            MOVE      "  0",PMPBICNT           * zero for Accommodation
            PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,PMPBICNT,SP70
            CALL      RDPMPBR1
            IF        OVRCD=0
              MOVE      ONE,ISBLFLAG
              MOVE      MAXIBILL,PMPBMAXB      * New value of maximum billing
              MOVE      MAXIDAYB,PMPBMAXD      * New value of maximum day charge
              MOVE      SEVEN,PROGFLAG         * work out accommodation charge
              CALL      ISAC0000               * Get accommodation for a payer
              MOVE      TOTACCM,FORM12P2       * Max day charge
              MOVE      ZERO,ISBLFLAG
            ENDIF
          ENDIF
          GOTO      PAYB8000
.
PAYB2000  MOVE      ZERO,FORM12P2
.
PAYB8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FORM12P2,"|":
                             "</RETURN_VALUE>"
PAYB9998  CALL      XMLEND00
PAYB9999  RETURN
+
.----------------------------------------------------------------------
.         Get the Start and End Accommodation date for this payer
.----------------------------------------------------------------------
FACM0000  MOVE      ZERO,ACDAYCS             * Assume not a day case
          MOVE      SP10,DDATE
          IF        ASTAT=3
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1
            IF        OVRCD=0
              MATCH     ADATE,DDATE
              IF        @EQUAL
                MOVE      ONE,ACDAYCS            * This is a day case
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,FORM5A
          MOVE      ALACDTE,SFRDATE          * Default Accommodation fromdate
          MOVE      "  0",PMPBICNT
          PACK      KEY26,DAADMNO,PMPBICNT,SP70
          CALL      RSPMPBR4
FACM1000  CALL      RKPMPBR4
          BRANCH    OVRCD,FACM1200
.
          MATCH     PMPBADMN,DAADMNO
          GOTO      FACM1200 IF NOT EQUAL
.
          MATCH     "  0",PMPBICNT        * Accommodation record
          GOTO      FACM2000 IF NOT EQUAL
.
          MATCH     PMPBCLTY,PMPYR003
          GOTO      FACM1200 IF EQUAL
.
.         Workout how many days of this payer is paying
.
          MOVE      PMPBMAXB,FORM12P2
          DIV       PMPBMAXD,FORM12P2
.
          ADD       FORM12P2,FORM5A
          GOTO      FACM1000
.
FACM1200  COMPARE   ZERO,FORM5A
          GOTO      FACM2000 IF EQUAL
.
          MOVE      ALACDTE,ISBLDATE
          ADD       FORM5A,ISBLDATE
          MOVE      ISBLDATE,SFRDATE
.
          UNPACK    SFRDATE INTO XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,FDAY
          MOVE      XMON,FMON
          MOVE      XYEAR,FYEAR
          MOVE      XCENT,FCENT
.
.         If there is no discharge date, use the current date as end date
.
FACM2000
          COMPARE   THREE,ASTAT
          GOTO      FACM5000 IF NOT EQUAL

          MATCH     SP8,DDATE
          GOTO      FACM5000 IF EQUAL
.
          MATCH     ADATE,DDATE
          IF        @EQUAL
           MOVE      FDAY,TDAY
           MOVE      FMON,TMON
           MOVE      FYEAR,TYEAR
           MOVE      FCENT,TCENT
           GOTO      FACM9999
          ENDIF
.
.         For day cases ( or no accommodation range ) use from-date as to-date
.
          MATCH     BACKDATE,DDATE
          IF        @LESS
            UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
            MOVE      XDAY,TDAY
            MOVE      XMON,TMON
            MOVE      XYEAR,TYEAR
            MOVE      XCENT,TCENT
          ENDIF
          GOTO      FACM9999
.
.         Use the keyin date
.
FACM5000  UNPACK    BACKDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,TDAY
          MOVE      XMON,TMON
          MOVE      XYEAR,TYEAR
          MOVE      XCENT,TCENT
          GOTO      FACM9999
.
FACM9999  RETURN
+
.-------------------------------------------------------------------------
.****************************************************************************
.  SINVH000 - Set up invoice header for stationery templating
.****************************************************************************
SINVH000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          MOVE      PTCNPAIH,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVH900
.
          PACK      KEY12,PTCNPAIH,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVH900
.
          MATCH     PTCNPAIH,IBDTSCOD         * match stationery codes
          GOTO      SINVH950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVH900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVH999
.
SINVH950  MOVE      ZERO,EXIT
SINVH999  RETURN
+
.****************************************************************************
.  SINVT000 - Set up invoice tail for stationery templating
.****************************************************************************
SINVT000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          READ      CONTROLF,NINTY8;*136,PTCNPAIH,*142,PTCNPAIT
          MOVE      PTCNPAIT,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVT900
.
          PACK      KEY12,PTCNPAIT,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVT900
.
          MATCH     PTCNPAIT,IBDTSCOD         * match stationery codes
          GOTO      SINVT950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVT900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVT999
.
SINVT950  MOVE      ZERO,EXIT
SINVT999  RETURN
+
.****************************************************************************
.  CHCKBT00 - Check if site has a Bed Type with Ind1=H
.****************************************************************************
CHCKBT00  MOVE      "BT",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
CHCKBT10  CALL      RDKCODE1
          BRANCH    OVRCD,CHCKBT99
.
          MATCH     "BT",TCODE
          GOTO      CHCKBT99 IF NOT EQUAL
.
          MATCH     "H",TCINDC1
          GOTO      CHCKBT10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      CHCKBT99
.
CHCKBT99  RETURN
+
.******************************************************************************

          INC       IBAWEBCD    
          INC       IBAGSTKY
          INC       IBAGKIKY
          INC       PATGNCMX
          INC       CMXMATRX
          INC       PABXBILL
          INC       PTDRCHRG
          INC       CLNZPPIC
          INC       DGCLIITM
          INC       PMIGTNID
          INC       CALCCODE
          INC       RTIODAYS 
          INC       RHIHDAYS
          INC       PRTINVBD
          INC       CLPMSEXT
          INC       CLPMSPWA
          INC       CLPMSABF
          INC       CLPATABF
          INC       READHTRA
          INC       PATRDEBT
.
          INC       IBAPOLIO/INC
          INC       APSMASIO/INC
          INC       ACCDIAIO/INC
          INC       ACCRFPIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       COMDEPIO/INC
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRICDIO/INC
          INC       EMRVISIO/INC
          INC       EMRVCDIO/INC
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       IBATMDIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATCHCIO/INC
          INC       PATAFEIO/INC
          INC       PATALRIO/INC
          INC       PATASDIO/INC
          INC       PATCERIO/INC
          INC       PMSCCDIO/INC
          INC       PMSRESIO/INC
          INC       PATCMXIO/INC
          INC       PATCRAIO/INC
          INC       PATCTFIO/INC
          INC       PMSCIDIO/INC
          INC       PATELGIO/INC
          INC       PATDRGIO/INC
          INC       PATDGWIO/INC
          INC       PATFEEIO/INC
          INC       PMSCTCIO/INC
          INC       PMSWX1IO/INC
..          INC       PMSHCPIO/INC
..          INC       PMSHCGIO/INC
          INC       PATINLIO/INC
          INC       PATHDFIO/INC
          INC       PATHSPIO/INC
          INC       PATHLFIO/INC
          INC       PATHTRIO/INC
          INC       EMRHTRIO/INC
          INC       OUTHTRIO/INC
          INC       PATIPRIO/INC
          INC       PATALWIO/INC
          INC       PATACHIO/INC
          INC       PATBFEIO/INC
          INC       PATCFAIO/INC
          INC       NZPCMTIO/INC
          INC       NZPIBRIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRVBIO/INC
          INC       NZPBFEIO/INC
          INC       NZPTFEIO/INC
          INC       NZPPFEIO/INC
          INC       NZPCFNIO/INC
          INC       MLTCFNIO/INC
          INC       MLTCF1IO/INC
          INC       NZPSPRIO/INC
          INC       NZPEXTIO/INC
          INC       NZPPICIO/INC
          INC       PATCMCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCURIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATECHIO/INC
          INC       PATEDSIO/INC
          INC       PATEDTIO/INC
          INC       PATEORIO/INC
          INC       PATFN2IO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATIPEIO/INC
          INC       PATONHIO/INC
          INC       PATIBLIO/INC
          INC       PATINVIO/INC
          INC       PATIOVIO/INC
          INC       PATIRNIO/INC
          INC       NZPIRNIO/INC
          INC       PATITMIO/INC
          INC       PATICUIO/INC
          INC       PATICDIO/INC
          INC       PATIN1IO/INC
          INC       PATINMIO/INC
          INC       PATFACIO/INC
          INC       PATFIGIO/INC
          INC       NZPFIGIO/INC
          INC       PATFINIO/INC
          INC       NZPFINIO/INC
          INC       PATFMOIO/INC
          INC       PATFN1IO/INC
          INC       PATGTUIO/INC
          INC       PATCHXIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATMCHIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       OBSPCOIO/INC
          INC       OBSPCTIO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATNHHIO/INC
          INC       PATPR1IO/INC
          INC       PATPGRIO/INC
          INC       PATASFIO/INC
          INC       PATRATIO/INC
          INC       PATRBLIO/INC
          INC       PATRCAIO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       MRTMASIO/INC
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
          INC       PATOVBIO/INC
          INC       PATVADIO/INC
          INC       PATDADIO/INC
          INC       PATJRNIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       NZPRFNIO/INC
          INC       NZPRDTIO/INC
          INC       PATSCFIO/INC 
          INC       PATSGCIO/INC
          INC       PATSRBIO/INC
          INC       OPRARDIO/INC
          INC       OPRPMBIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDECIO/INC
          INC       OPRSESIO/INC
          INC       OPRSRGIO/INC
          INC       OUTDTRIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTSITIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       RCPDTEIO/INC
          INC       RCPCRSIO/INC
          INC       PATNIDIO/INC
          INC       PATNZRIO/INC
          INC       PMSEXTIO/INC
          INC       PMSCNOIO/INC
          INC       PMSFCIIO/INC
          INC       PMSEVTIO/INC
          INC       PMSBBIIO/INC
          INC       PMSBIIIO/INC
          INC       PMSSINIO/INC
          INC       PMSCMTIO/INC
          INC       PATCMTIO/INC
          INC       PMSECTIO/INC
          INC       PMSVX1IO/INC
          INC       PMSMTIIO/INC
          INC       PMSMTEIO/INC
          INC       PMSMPRIO/INC
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIVBIO/INC
          INC       PMSIDEIO/INC
          INC       PMSREGIO/INC
          INC       PMSPTDIO/INC
          INC       VISCMTIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       VISPAYIO/INC
          INC       VISPMAIO/INC
          INC       PRIITMIO/INC
          INC       PATSTAIO/INC
          INC       PATAA1IO/INC
          INC       PMSSGAIO/INC
          INC       PMSICMIO/INC
          INC       PATPARIO/INC
          INC       PMSPRGIO/INC
          INC       PATFAPIO/INC
          INC       PATATRIO/INC
          INC       PATPFAIO/INC
          INC       PATRGMIO/INC
          INC       ALLCASIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
.
          INC       PATRDEIO/INC
          INC       PMSFOCIO/INC
          INC       PMSABFIO/INC
          INC       PATABFIO/INC
          INC       PMSADJIO/INC
          INC       PMSTLEIO/INC
          INC       PMSPWAIO/INC
          INC       PMSHATIO/INC
          INC       PATDDHIO/INC
.
          INC       WEBIHCIO/INC
          INC       WEBPARIO/INC
          INC       PATHGPIO/INC
          INC       PMSCHAIO/INC
          INC       PATVENIO/INC
.
          INC       GETDRG
          INC       ABFPTDET
          INC       ABFSAINV
          INC       ABFSADET
          INC       ABFMHDET
          INC       CINVPEND
          INC       PMSPYRTM
          INC       PRTIPROV                   * Print Insurance provider
          INC       NZPSPRTM
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CMGETTHR
          INC       CHKCMXPT
          INC       PATCALFN 
          INC       PATCMSTP
          INC       PATCOMN3
          INC       PATDOCTM
          INC       PATGBCRN                   * I-48227
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATVISTM
          INC       PATCLMTM
          INC       PATDSCTM
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       VISPAYTM
          INC       VISPMATM
          INC       NAMSTRCD
          INC       STEPDOWN
          INC       CALCAGE
          INC       NHOSPDAY
          INC       PATSBTYP     * calculate bed days for a specialty bed
          INC       PATINVS
          INC       PATINVHL
          INC       PATINVTL
          INC       PATCATAI
          INC       PATCATBI
          INC       OUTCATBI
          INC       AAECATBI
          INC       CLPATDSC
          INC       WEBDATCD
          INC       DAYOFWEK
          INC       GETALTID
          INC       ICDSCLAS
          INC       GETBFEES
          INC       GETTFEES
          INC       GETCNEFF
          INC       VALCMXFN
.
          INC       PRTELIGI
          INC       PATIPERH
          INC       PATNAMCD
          INC       PMSEXTTM
          INC       PATATRTM
          INC       CLPATATR
          INC       KYPTBANK
          INC       CLPATDTR
          INC       CLOUTDTR
          INC       PATCKEXC
          INC       PATIVMES
          INC       CHNADMTP
          INC       CLVISPAY
          INC       CLPATINV
          INC       PMSOSDTM                * Outstanding Debt alert routine
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       PROSTRAK
          INC       CLPMSPTD
          INC       CLPMSVX1
          INC       CLPMSPYR
          INC       CLPMSPBR
          INC       CLPMSIDE
          INC       RSHWEBCD
          INC       TFILENAM
          INC       GETEFDRG
          INC       MVITCONF
          INC       CHKCLDCP
