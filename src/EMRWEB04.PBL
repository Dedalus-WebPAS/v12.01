.----------------------------------------------------------------------
. Program       : EMRWEB04
.
. Function      : Print EMR Invoices
.
. Modifications  :
.----------------------------------------------------------------------
. V12.01.01 16/12/2025  Bella Turco     TSK 0949715
.           Recompiled for EMRVISTM
. V12.00.02 30/09/2025  Thanh T         TSK 0937505
.           Recompiled for PATINVHL changes
. V12.00.01 21/05/2025 Bella Turco      TSK 0955096
.           Alphanumeric changes                                 
. V11.05.02 15/04/2024 J.Tan            TSK 0959080
.           Mod checking if ABF invoice already raise (CZER0000)
. V11.05.01 21/02/2025  J.Tan   TSK 0955356
.           Recompiled for PATCALFN - Financial details
. V11.04.02 07/11/2024 Thanh T          TSK 0946085
.           Recompiled for RCPCONFD changes
. V11.04.01 22/02/2024  PJ Le Febour     TSK 0929044db
.           update WBPICUID WBPICDAT WBPICTIM before call WRWBPCI1 
. V11.03.09 08/11/2023  Nikitha B      TSK 0927699c
.           Read PTCNHABN for Hospital  ABN number.
. V11.03.08 04/10/2023  Nikitha B     TSK 0927699
.           Recomplied for PATINVHL, PATINVTL - Stationary variables
. V11.03.07 03/10/2023 J.Tan           TSK 0938230
.           Recompiled for ABFAECCL and ABFAEDET
. V11.03.06 20/07/2023 Thanh T         TSK 0914385
.           Added DIM13 and open EMRVCDA1
. V11.03.05 10/07/2023  J.Tan          TSK 0923703
.           Recompiled for ABFAEINV - Hospital remoteness              
. V11.03.04 15/06/2023  Bella Turco    TSK 0931756
.           Recompiled for PRTINVBD                                    
. V11.03.03 25/05/2023  J.Tan          TSK 0923703
.           Recompiled for ABF new calculations
. V11.03.02 07/02/2023 Peter Vela          0910319
.           Changed looping order in EMDCC000 to correct doctor order
. V11.03.01 05/04/2023 Bella Turco     TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.02.11 25/10/2022 Peter Vela          0910319
.           Added EMDCC00 for Cabrini Emr Raise Invoice screen
.           Service Doctor dropdown
. V11.02.10 20/09/2022 Thanh T         TSK 0908346
.           Recompiled for CHKCLDCP changes
. V11.02.09 19/09/2022 Thanh T         TSK 0908346
.           Recompiled for CHKCLDCP changes
. V11.02.08 08/09/2022 Thanh T         TSK 0908346
.           Added EMRPAT70, EMRPAT75, INVD2500.
.           Called CHKCLDCP to check if the clinical document is setup for
.           the claim type clininal document mapping table. This will determine
.           the disabled status of the Invoice button
. V11.02.07 18/07/2022 J.Tan           TSK 0906596
.           Recompiled for ABFAECCL - Mods for Claim code Indic2=N (NWAUFLAG)
. V11.02.06 2806/2022  Peter Vela          0918312
.           Changed MOVE to PACK of KEY8 for RDINV1 in PCIW0000
. V11.02.05 29/06/2022 J.Tan           TSK 0920712
.           Recompiled for ABFAECCL - I*D on emrvcdaf file
. V11.02.04 03/06/2022  J.Tan          TSK 0906596
.           Mod for NWAU Calculations details
. V11.02.03 08/04/2022  Jacob Jackson   TSK 0864505
.           Recompiled for PATINVHL, PATINVTL
.           Add CONTROLF parameters PTCNPFSN, PTCNPFGN
. V11.02.02 03/03/2022  J.Tan           TSK 0902652
.           Recompiled for AAECATBI - Patient Invoice new functionality
. V11.02.01 01/02/2022 Peter Vela      TSK 0902857
.           Added WebServices parameter validation around PCIW0000
. V11.01.13 17/11/2021 J.Tan           TSK 0880410
.           Recompiled for PATIPERH - added Hospital and System
. V11.01.12 11/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFAEINV - Mod for Multiple NEP Values
. V11.01.11 27/10/2021 J.Tan           TSK 0913056
.           Recompiled for ABFAECCL-ADMFLAG and CCAR0000(Clinical Care)
. V11.01.10 13/10/2021 J.Tan    TSK 0905305
.           Recompiled for ABFAECCL - Adjustment type 068 & 069
. V11.01.09 01/10/2020  J.Tan           TSK 0911732
.           Recompiled for AAEINVS - checking 'tobe invoiced' amount (CKPD000)
. V11.01.08 14/09/2021  Davin           TSK 0911277
.           Recompiled for PRTINVBD
. V11.01.07 10/09/2021  Davin           TSK 0911277
.           Recompiled for PATINVTL - Changed field 20 length to 12.2
. V11.01.06 09/08/2021  J.Tan           TSK 0905305
.           Recompiled for AAECATBI - AE Care class for 2021/2022(ABFAECCL)
.           24/08/2021  Davin           TSK 0897318
.           Recompiled for PATINVTL - added field 57(Adjustment Total)
.           31/08/2021  J.Tan          TSK 0910799
.           Recompiled for PRTINVBD - printing Referring ADF
. V11.01.05 05/08/2021  Peter Vela     TSK 0909974
.           Added validation for PCS Lodgement Advice for Raise and Claim
.           LADV0000 LADW0000
. V11.01.04 27/05/2021  Thanh T        TSK 0873184
.           Added SEENDTIM, TESTDTIM, EMCNPBSD for EMRVISTM changes
. V11.01.03 21/05/2021  Peter Vela     TSK 0906538
.           Added WebServices PCIW functionality
. V11.01.02 21/05/2021  Thanh T        TSK 0873184
.           Added SEENDTIM, TESTDTIM, EMCNPBSD for EMRVISTM changes 
. V11.01.01 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
. V11.00.11 19/01/2021  J.Tan          TSK 0883075
.           Recompiled for PRTINVBD - mod to print ADF address line on invoice
. V11.00.10 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.09 22/10/2020  J.Tan           TSK 0898866
.           Recompiled for PATIPERH - on hold invoice(Contract for Eff.Adm.from)
. V11.00.08 14/10/2020  J.Tan          TSK 0894879
.           Recompiled for PRTINVBD - Print 30 item desc.for RCH Invoice layout
. V11.00.07 06/08/2020 J.Tan            TSK 0892319
.           Recompiled for ABFAEINV - Added Adjustment type 026 and 027 
. V11.00.06 03/08/2020 J.Tan      TSK 0886178
.           Recompiled for ABFPTDET - fixed displaying ABF calculation
. V11.00.05 24/06/2020 J.Tan           TSK 0886178
.           Recompiled for ABFAEDET - Mod to ABF details
. V11.00.04 29/06/2020  J.Tan           TSK 0893767
.           Recompiled for ABFAEINV - Changes CALCFLAG to 01/01/2021
. V11.00.03 20/04/2020 J.Tan           TSK 0890733
.           Recompiled for ABFAEINV - ABF new 2020 calculation
. V11.00.02 08/04/2020 J.Tan           TSK 0868813
.           Recompiled for PATINVHL
. V11.00.01 12/03/2020  J.Tan          TSK 0838262
.           Removed PATITMVD (not used)
. V10.15.02 31/12/2019  J.Tan            TSK 0886176
.           Added INVOICNO tag for 'ABF details' option from Invoiced screen
. V10.15.01 08/11/2019  J.Tan           TSK 0883871
.           Mod checking for Procedure for Raise inv.button avail.for ABF 
. V10.14.06 24/09/2019  J.Tan           TSK 0857392
.           Recompiled for AAEINVS - updating invoice no to ABF file
. V10.14.05 23/09/2019  J.Tan           TSK 0857392
.           Recompiled for AAECATBI - fixed invoice pending
. V10.14.04 16/09/2019  J.Tan           TSK 0857392
.           Recompiled for ABFAEINV - checking URG effective date
. V10.14.03 09/07/2019  Peter Vela      TSK 0857392
.           Added ABF functionality 
.           21/06/2019  J.Tan           TSK 0857392
.           Mod for ABF EMR invoice
. V10.14.02 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.01 27/02/2019  Don Nguyen     TSK 0821139
.           Recompiled for EMRVISTM - Modified Location selection list code
.----------------------------------------------------------------------
. V10.13.08 09/11/2018  J.Tan            TSK 0859742
.           Mod to print Lodgement of Advice
. V10.13.07 07/11/2018  Peter Vela     TSK 0863035
.           Extended ECCLMARR for Eclipse PCS
. V10.13.06 30/10/2018  Peter Vela     TSK 0863035
.           Added Raise and Claim functionality for Eclipse Store and
.           Forward
. V10.13.05 18/10/2018  Peter Vela     TSK 0863035
.           Commented out rebate reason validation in CPRC0000
. V10.13.04 20/09/2018  J.Tan          TSK 0863727
.           Recompiled for AAECATBI - Restrictive Override code
. V10.13.03 13/09/2018  Peter Vela     TSK 0863035
.           Recompiled for AAECATBI
. V10.13.02 30/08/2018  J.Tan          TSK 0859742
.           Added Eclipse Store and Forward
. V10.13.01 20/08/2018  Ebon Clements  TSK 0859742
.           Added Eclipse other claimant functionality
.----------------------------------------------------------------------
. V10.12.02 19/06/2018  Peter Vela     TSK 0852438
.           Added Standardised Emergency Billing Functionality for HEA
. V10.12.01 28/02/2018  J.Tan          TSK 0852351
.           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)
.----------------------------------------------------------------------
. V10.11.03 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.02 25/08/2017  Thanh T.       TSK 0821710
.           Removed PATCMNTS.
. V10.11.01 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.----------------------------------------------------------------------
. V10.08.01 07/11/2016  Ebon Clements     TSK 0827937
.           Recompiled for PATINVHL - Hospital approval number
. V10.07.02 22/12/2015  J.Tan             CAR 0303942
.           Recompiled for AAECATBI - additional payment types
. V10.07.01 12/10/2015  J.Tan           CAR 320522
.           Recompiled for PRBILCMN
. V10.06.07 14/08/2015  J.Tan           CAR 320073
.           Recompiled for PATCATAI - reprint invoice for unreleased cash
. V10.06.06 07/08/2015  Davin          CAR 317002
.           Recompiled for PRTINVBD - Print pmexname for ADF MO
. V10.06.05 14/07/2015  Peter Vela     CAR 318700
.           Recompiled for PRBILCMN - Validate for deleted VISMDT record
. V10.06.04 23/06/2015  J.Tan          CAR 318039
.           Recompiled for PRBILCMN - printing billing comments for EMR
. V10.06.03 15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.02 02/04/2015  Ania P         CAR 313236                     
.           Recompiled for PRTINVBD                                   
. V10.06.01 25/03/2015 J.Tan      CAR 314662
.           Fixed Billing Comments for Outpatient invoice
. V10.05.05 10/02/2015 J.Tan      CAR 311717
.           Recompiled for PATINVHL
. V10.05.04 14/01/2015 J.Tan      CAR 310973
.           Recompiled for AAECATBI - fixed up Invoice date
. V10.05.03 12/01/2014  Peter Vela     CAR 310738
.           Recompiled for PRTINVBD
. V10.05.02 28/10/2014 J.Tan     CAR 304455
.           Recompiled for PATINVHL - fixed Doctor Name and Provider no
. V10.05.01 06/08/2014  Peter Vela     CAR 302164
.           Recompiled for AAECATBI
. V10.04.06 26/05/2014  J.Tan          CAR 265319
.           Added tag for Invoice balance payable
. V10.04.05 01/05/2014  J.Tan          CAR 261630
.           Removed patauc Cash audit file and pataum Misc.audit file
. V10.04.04 15/04/2014  J.Tan          CAR 261630
.           Removed port number from temp file name
. V10.04.03 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.02 26/02/2014  J.Tan          CAR 275810                            *
.           Recompiled for PRTINVBD - to print Defence Force details         *
. V10.04.01 20/01/2014  J.Tan          CAR 273713      
.           Recompiled for PRTINVBD -Print payment types of a receipt on invoice
. V10.03.15 09/12/2013  Ania P         CAR 294740      
.           Recompiled for PATINVHL
. V10.03.14 12/09/2013  Peter Vela     CAR 271911
.           Recompiled for PATINVTL
. V10.03.13 20/06/2013  Davin          CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi            
. V10.03.12 06/06/2013  J.Tan          CAR 286530
.           Recompiled for PATINVHL - printing claim code desc.for emergency
. V10.03.11 17/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATINVHL, PATINVTL
. V10.03.10 09/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN, PATINVHL, PATINVTL
. V10.03.09 26/03/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN
. V10.03.08 05/03/2013  Patrick Adair  CAR 281898
.           Recompiled for PRTINVBD PATCATAI
. V10.03.07 16/01/2012  J.Tan          CAR 277877
.           Fixed displaying EMR invoice with zero U/R Number
. V10.03.06 30/07/2012  J.Tan          CAR 268318
.           Recompiled for AAECATBI - to display Procedure rate and percentage
. V10.03.05 18/07/2012  Don Nguyen     CAR 264561
.           Recompiled for PATGBCRN
. V10.03.04 06/07/2012  Peter Vela     CAR 268174
.           Read CAPPRVNO from controlf
. V10.03.03 23/05/2012  J.Tan          CAR 260029
.           Recompiled for AAECATBI - fixed transaction number
. V10.03.02 26/04/2012  J.Tan          CAR 264231
.           Recompiled for PRTINVBD - fixed printing HEC Emergency invoice
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.02.06 11/10/2011 J.Tan  CAR 253138
.           Recompiled for AAECATBI- fixed printing claim details
. V10.02.05 12/10/2011 J.Tan  CAR 235370 
.           Recompiled for PATINVHL - NHI names for SX
. V10.02.04 11/10/2011 J.Tan  CAR 251207
.           Fixed printing zero amt of invoice
. V10.02.03 10/10/2011 J.Tan  CAR 251207
.           Mods to read parameter for printing invoice with zero amt of transc.
. V10.02.02 29/09/2011 J.Tan  CAR 252227
.           Recompiled for PRTINVBD - fixed printing items
. V10.02.01 04/04/2011  Jill Parkinson CAR 239574
.           Removed open of ibaprntf
. V10.01.03 13/01/2011  Mike Laming   CAR 233084
.           Added include CLPATINV for AAEINVS & Recompiled
. V10.01.02 14/12/2010  Mike Laming   CAR 233046
.           Mods to Misc.Charges PATMCHFD - incl. new routine PATMCHRD
. V10.01.01 30/10/2010 J.Tan          CAR 233043
.           Recompiled for AAECATBI - mods to print invoice
. V10.00.02 08/10/2010 J.Tan          CAR 231497
.           Recompiled for AAECATBI - print doctor on HEC Emergency invoice
. V10.00.01 27/09/2010 J.Tan            CAR 230664
.           Mods for HEC invoice layout
. V9.12.11  04/12/2009  Peter Vela    CAR 202333
.           Recompiled for PATINVHL - Changed variable 88 to surname only 
. V9.12.10  14/10/2009  J.Tan         CAR 206435
.           Disable Raise Invoice button if Claim code is blank
. V9.12.09  05/10/2009  J.Tan         CAR 191624                      
.           Recompiled for AAEINVS - set Deposit Applied date to Current date
. V9.12.08  24/08/2009 J.Tan  CAR 186102
.           Recompiled for NZPCATAI - Mods to display Win/Loss after invoiced
. V9.12.07  21/07/2009  J.Tan         CAR 199603
.           Recompiled for PATCATAI - prints ICD codes on TAC/WC Inv.
. V9.12.06  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.05  20/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.04  13/07/2009  J.Tan         CAR 199759
.           Recompiled for AAECATBI - Printing Pendlebury ED invoice
. V9.12.03  03/07/2009  Peter Vela    CAR 199927
.           Recompiled for EMROPOCK - Check if PMMIAMTT = 0 GPRC4000
. V9.12.02  03/06/2009  J.Tan         CAR 198199
.           Recompiled for AAEINVS - printing invoice for ALL doctors
. V9.12.01  27/05/2009  J.Tan         CAR 197652
.           Recompiled for AAECATBI - printing invoice for item with no doctor
. V9.11.04  27/04/2009  Mike Laming   CAR 195368
.           Recompiled for AAECATBI - added PTCNINVL=16
. V9.11.03  23/04/2009  Davin         CAR 195282
.           Mods to read PTCNMFEE
. V9.11.02  23/03/2009  Davin         CAR 178015
.           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number
. V9.11.01  14/10/2008  Peter Vela    CAR 159227
.           Recompiled for PATINVHL - Added Emergency Invoice
.           Arrival Date and Time
. V9.10.08  22/08/2008  J.Tan         CAR 170219
.           Recompiled for AAECATBI - to print item description for Cabrini inv.
. V9.10.07  12/08/2008  J.Tan         CAR 175967
.           Recompiled for AAEINVS - Doctor Provider no on EMR invoice header
. V9.10.06  04/08/2008  J.Tan         CAR 175246
.           Recompiled for AAEINVS - Doctor on Emergency invoice header
. V9.10.05  23/07/2008  J.Tan         CAR 173734
.           Recompiled for PATANVS - Doctor on Emergency invoice header
. V9.10.04  21/05/2008  J.Tan         CAR 167702
.           Recompiled for AAECATBI - Cabrini invoice layout
. V9.10.03  13/05/2008  Ebon Clements CAR 166566
.           Recompiled for PATINVHL
. V9.10.02  13/05/2008 J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.10.01  02/05/2008 J.Tan          CAR 167579
.           Recompiled for AAECATBI- Removed checking for facility fees
. V9.09.19  14/04/2008 J.Tan          CAR 161684
.           Recompiled for AAECATBI - Print Procedure Date/time on invoice
. V9.09.18  08/04/2008 J.Tan          CAR 165485
.           Recompiled for AAECATBI - I*C on pending file
. V9.09.16  04/04/2008 J.Tan          CAR 165485
.           Recompiled for AAECATBI -Allow to remove Facility fee for Public Hos
. V9.09.15  12/03/2008 J.Tan          CAR 163659
.           Recompiled for AAEINVS - I*C on Pending file
. V9.09.14  04/03/2008 J.Tan          CAR 157583
.           Recompiled for AAECATBI - Invoice total with 'Out of Pocket "
. V9.09.13  27/12/2007 Peter Vela     CAR 155907
.           Recompiled for PATINVTL
. V9.09.12  16/11/2007 Peter Vela     CAR 110766
.           Recompiled for PATINVHL
. V9.09.11  15/11/2007  Peter Vela    CAR 151199
.           Changes new Emergency Cancellation status
. V9.09.10  12/11/2007  J.Tan         CAR 151803
.           Mods for Cabrini ED Billing
. V9.09.09  26/10/2007  Peter Vela    CAR 151159
.           Added new Emergency Cancellation status
. V9.09.08  10/08/2007 Peter Vela     CAR 146143
.           Recompiled for PATCATAI
. V9.09.07  25/07/2007 Peter Vela     CAR 144787
.           Recompiled for PATCATAI
. V9.09.06  05/07/2007 Peter Vela     CAR 144548
.           Recompiled for AAEINVS
. V9.09.05  02/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.04  01/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATINVTL
. V9.09.03  29/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.02  25/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.01  31/05/2007 Peter Vela     CAR 142173
.           Added tag for Doctor Emergency event
.           07/06/2007 J.Tan          CAR 142173
.           Mods for invoicing Emergency event
. V9.08.09  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.08  22/02/2007 Mike Laming   CAR 119436
.           Add PMSOSDTM (PROC FLAGDEBT) for Outstanding Debt Alert ind.
. V9.08.07  31/01/2007  Peter Vela    CAR 127930
.           Recompiled for EMRSITFD
. V9.08.06  13/12/2006  J.Tan         CAR 127625
.           Mods to JH HRN
. V9.08.05  05/12/2006  J.Tan         CAR 127092
.           Recompiled for PATCATAI - JH Invoices
. V9.08.04  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.03  16/11/2006  Steve Armstrong   CAR 124160
.           Recompiled for PATINVHL (Singapore HRN)
.           Recompiled for PATINVTL (Singapore HRN)
. V9.08.02  15/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.01  29/09/2006  Peter Vela    CAR 120319
.           Recompiled for PATINVHL
.----------------------------------------------------------------------
. V9.07.03  25/09/2006  Peter Vela    CAR 118940
.           Recompiled for PATCATAI
. V9.07.02  02/08/2006  Peter Vela    CAR 113658
.           Recompiled for PATINV21 - Fixed Date and Cash Payment
.           display
. V9.07.01  25/07/2006  Peter Vela    CAR 113658
.           Recompiled for PATCATAI - Fixed "Journal Total" display
. V9.06.02  16/05/2006  Peter Vela    CAR 104103
.           Recompiled for PATCATAI - PTCNINVL=12
. V9.06.01  24/04/2006  J.Tan         CAR 102287 
.           Recompiled for PATINVHL - Added fields for multi hospital details
. V9.05.03  29/03/2006 Peter Vela    CAR 95780
.           Recompiled for PATINVHL - Added emg mobile contact numbers
. V9.05.02  6/03/2006  Peter Vela    CAR 61299
.           Recompiled for PATINVHL
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.18  17/11/2005  Peter Vela    CAR 84547
.           Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1
. V9.04.17  25/10/2005 Sandra Barcham   81362
.           Recompiled for AAEINVS - Fixed fincode for deposits
. V9.04.16  06/10/2005 J.Tan   CAR  78676
.           Recompiled for AAECATBI - Printing RCH invoice
. V9.04.15  29/09/2005 J.Tan   CAR  77671
.           Recompiled for AAECATBI - Printing invoice
. V9.04.14  01/08/2005 J.Tan   CAR  69340
.           Recompiled for PATCATAI - fixed printing credit note total
. V9.04.13  14/07/2005  Peter Vela    CAR 62172
.           Recompiled for PATINVTL
. V9.04.12  17/02/2005  Mike Laming   CAR 56030
.           Re-compile for PATINV25 - fix screen painted tail printing
. V9.04.11  09/12/2004  J.Tan         CAR 55635
.           Recompiled for PATINVTL - Receipt amount on invoice tail
. V9.04.10  18/11/2004  J.Tan CAR 54392
.           Recompiled for AAEINVS - set up discharged date for print invoice
. V9.04.09  11/11/2004  J.Tan CAR 55071
.           Recompiled for PATINV24 - SVHM invoice layout
. V9.04.08  05/10/2004 J.Tan   CAR 53798   
.           Removed PATDSMSC           
. V9.04.07  04/10/2004  Peter Vela CAR 52906
.           Recompiled for PATCATAI 
.           23/09/2004  Lina Vo CAR 53660  
.           Recompiled for AAEINVS & PATCATAI                              
. V9.04.06  09/09/2004  J.Tan CAR 53226    
.           Recompiled for AAECATBI - checking for zeros transaction number
. V9.04.05  06/09/2004  Lina Vo  CAR 52998
.           Initialise Page Number for PRTINVHL
. V9.04.04  30/08/2004  J.Tan    CAR 53073
.           Mods to display Hospital ID on invoice heading
. V9.04.03  27/08/2004  J.Tan    CAR 52835
.           Recompiled for PATCATAI - multi hospital
. V9.04.02  27/08/2004  J.Tan    CAR 52891
.           Recompiled for PATCATAI - printing journals over payments
. V9.04.01  23/08/2004  J.Tan  CAR 52835
.           Recompiled for AAEINVS - Multi hospital
. V9.03.26  13/08/2004 J.Tan  CAR 52540
.           Recompiled for AAECATBI - Fixed I*D on 2nd index of aaedtref    
. V9.03.25  13/08/2004 J.Tan  CAR 50504
.           Recompiled for AAEINVS - checking for AAE register
. V9.03.24  30/06/2004 J.Tan  CAR 51112
.           Recompiled for AAEINVS - Checking for nonrelease deposit
. V9.03.23  18/06/2004 Ebon Clements CAR 50833
.           Fixed call stack overflow from CALL MAIN1000          
. V9.03.22  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.21  02/06/2004 J.Tan  CAR 50273
.           Recompiled for AAEINVS- Exclude cancelled non-bank deposit
. V9.03.20  25/05/2004 J.Tan  CAR 50111	
.           Recompiled for AAECATBI - I*D on aaedtref file
. V9.03.19  25/05/2004 J.Tan  CAR 50111	
.           Mods to read invoice layout flag 
. V9.03.18  25/05/2004 J.Tan  CAR 50111	
.           Recompiled for AAEINVS - I*C on patirngaf file
. V9.03.17  13/05/2004 J.Tan  CAR 49827	
.           Fixed printing invoice with deposit
. V9.03.16  16/04/2004 J.Tan  CAR 47920
.           Mods to check for zero amount of invoice total
. V9.03.15  16/04/2004 J.Tan  CAR 47922
.           Mods to display invoice number after printing invoice
. V9.03.14  06/04/2004 Peter Vela   CAR 48227
.           Added VARGBCRN and PATGBCRN - BPAY Reference Number
. V9.03.13  26/03/2004 Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.12  04/02/2004  J.Tan  CAR 46269
.           Mods for cancelling items from the next invoice screen
. V9.03.11  03/02/2004  J.Tan  CAR 45047 
.           Recompiled for PATCATAI - Non-banked Cash
. V9.03.10  19/12/2003 J.Tan   CAR 44093
.           Removed patcashf file
. V9.03.09  21/11/2003  J.Tan   CAR  44161
.           Recompiled for PATCATAI - print credit note
. V9.03.08  07/11/2003  Peter Vela CAR 44849
.           Recompiled for PATINVTL
. V9.03.07  03/11/2003  Peter Vela CAR 44757
.           Recompiled for PATINVTL
. V9.03.06  24/10/2003  J.Tan  CAR 44172
.           Recompiled for AAEDTRFD - added credit note
. V9.03.05  17/09/2003  CAR 40497   Lina Vo    
.           Recompiled for AAECATBI, AAEINVS & PATDSMSC.              
.           Added KEY26A for AAECATBI & AAEINVS.              
. V9.03.04  02/09/2003  CAR 42713   Mike Laming
.           Recompiled for PATINVTL (correct GST twice in final Total)
. V9.03.03  01/08/2003 J.Tan
.           Recompiled for AAEINVS - Change colour for the invoice heading
. V9.03.02  27/06/2003 J.Tan  
.           Mods to check if any invoice to be printed
. V9.03.01  18/06/2003 J.Tan  CAR 39832
.           Mods to validate emergency visit
. V9.02.13  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.12  04/12/2002  Lina Vo             
.           Add OPNOUT00 in INIT0000                     
. V9.02.11  09/10/2002  Peter Vela SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.10  11/06/2002  J.Tan
.           Added patrfn    
. V9.02.09  20/05/2002 J.Tan
.           Recompiled for PATCATAI
. V9.02.08  06/05/2002 J.Tan
.           Recompiled for PATCATAI
. V9.02.07  28/03/2002 Bronko Sosic
.           Recompiled for EMRICDFD
. V9.02.06  08/02/2002 Pat Dirito
.           Recompiled for MRTVISCD
. V9.02.05  15/01/2002 Sai
.           Recompiled after PATMDIFD/IO being removed SRF 14169
. V9.02.04  07/12/2001 Tonii
.           Recompiled for PATCATAI - Casemix changes
. V9.02.03  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.02  22.09.2001 Tonii SRF 13075
.           Recompiled for PATDINVS
. V9.02.01  30.08.2001 Harvinder
.           Changed the sequence of MASF0000 for correct header display
. V9.00.001 13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B02 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B01 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
.----------------------------------------------------------------------
.         V5.09.03  12.01.2001  Bronko Sosic                              
.                   Recompiled for PATMASTM                                 
.         V5.09.02  11.01.2001  Bronko Sosic                              
.                   Recompiled for MRTVISCD & changes to MRTMASFD           
.         V5.08.13  22/11/2000  Greg Horvat                               
.                   Recompiled for PATCATAI - Commented out any code to do
.                   with Hong Kong or Mt Alvernia
.                 V5.08.11 28/09/2000 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.10  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.09 29/07/2000  B.G.Ackland
.                          Recompiled for MPGEFLAG
.                 V5.08.08 29/06/2000  Steve Armstrong
.                          Recompiled for PATCATAI
.                 V5.08.07 07/06/2000  Bronko Sosic                        
.                          Recompiled for changes PATMASTM                    
.                 V5.08.06 18/05/2000  Jill Habasque                        
.                          Recompiled for changes to AAECATBI                 
.                 V5.08.05 18/05/2000  Pat Dirito                       
.                          Recompiled for AAEINVS                         
.                 V5.08.04 17/05/2000  Jill Habasque                    
.                          Recompiled for AAEINVS                         
.                 V5.08.03 08/05/2000 Nicole Harrington
.                          Recompiled for changes to EMRVISFD
.                 V5.08.02 04/05/2000 Nicole Harrington
.                          Changed open of BOKRC1A1 to call OPBKREC1
.                V5.08.B02 26/04/2000 Davin
.                          Recompiled for invoice templating
.                V5.08.B01 11/04/2000 J.Tan
.                          Mods for GST
.                 V5.07.03  14/03/2000  Nicole Harrington
.                           Added PATCOMFD/PATCOMIO
.                 V5.07.02  28.01.2000  B.G.Ackland
.                           Recompile in Work
.                 V5.07.01 10/01/2000  Nicole Harrington
.                          Fixed Y2K date problem - CYY displaying " 0"
.                 V5.07.00 14/10/1999  Nicole Harrington
.                          Port 6.06 - 5.07
.----------------------------------------------------------------------
. Modifications : V6.06.01 22.06.1999 K.C.Nelson
.                          Re-Compiled for EMRVISTM  
.                 V6.06.00 13.04.1999 K.C.Nelson
.                          Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       TFILEVAR/INC                 * Generate Temp File Name
.
          INC       APSMASFD/INC
          INC       AAECONFD/INC
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDI1FD/INC
          INC       AAEDTRFD/INC
          INC       AAEMCHFD/INC
          INC       BOKRC1FD/INC
          INC       CHKDIGVR/INC
          INC       COMDEPFD/INC
          INC       EMRCONFD/INC
          INC       EMRLOCFD/INC
          INC       EMRHISFD/INC
          INC       EMRICDFD/INC
          INC       EMRDOCFD/INC
          INC       EMRSITFD/INC
          INC       EMRVISFD/INC
          INC       EMRVCDFD/INC
          INC       EMRGRCFD/INC
          INC       EMRUNKFD/INC
          INC       EMRECTFD/INC
          INC       IBATMDFD/INC
          INC       IBAGSTFD/INC
          INC       IBAGEDFD/INC
          INC       MLTCFNFD/INC
          INC       NZPCFNFD/INC
          INC       NZPFINFD/INC
          INC       NZPFIGFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRDTFD/INC
          INC       NZPSPRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       OPRNURFD/INC
          INC       MRTMASFD/INC
          INC       MAMMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       PATCMXFD/INC
          INC       PATCRAFD/INC
          INC       PATINPFD/INC
          INC       PMSTLEFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCFAFD/INC
          INC       PATDHEAD/INC
          INC       PATDSCFD/INC
          INC       PATDRGFD/INC
          INC       PATDTRFD/INC
          INC       PATDO1FD/INC
          INC       PATECDFD/INC
          INC       PATFIGFD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATFINFD/INC
          INC       PATFN1FD/INC
          INC       PATIBLFD/INC
          INC       PATICDFD/INC
          INC       PATINLFD/INC
          INC       PATITMFD/INC
..          INC       PATINMFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATIRNFD/INC
          INC       PATTFEFD/INC
          INC       PATTRNFD/INC
          INC       PATMA1FD/INC
          INC       PATRFGFD/INC
          INC       PATONHFD/INC
          INC       PMSEXTFD/INC
          INC       PMSPRGFD/INC
          INC       PMSEVTFD/INC
          INC       PMSCLTFD/INC
          INC       PMSCLTTD/INC
          INC       PMSCNOFD/INC
          INC       PMSFCIFD/INC
          INC       PMSMTIFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       PMSCCDFD/INC            * Concession Card Details
          INC       EMRHTRFD/INC
.
          INC       PATHSPFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC
          INC       PATREMFD/INC
          INC       PATRFNFD/INC
          INC       PATRE1FD/INC
          INC       PATVISFD/INC
          INC       PATVADFD/INC
          INC       PATWMAFD/INC
          INC       PATWC1FD/INC
          INC       PATWVEFD/INC
          INC       PATWR1FD/INC
          INC       RCPCRSFD/INC
          INC       RCPBNKFD/INC
          INC       RCPCONFD/INC
          INC       RCPREGFD/INC
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC
          INC       RESLNKFD/INC
          INC       PRIITMFD/INC
          INC       VISMDTFD/INC
.
          INC       PMSABFFD/INC
          INC       PMSVMTFD/INC
.
          INC       VARGBCRN/INC     * I-48227
.
          INC       WEBDINVS/INC     * ---- substitue include for PATDINVS ----
.
          INC       WEBPCIFD/INC
          INC       CHKCLDCD/INC
.
          INC       RSHWEBDF
.
MPGEFLAG   FORM      1
.
TEMPFILE  IFILE     SQL, FIXED=227, KEY="u1-8"
.
DUNIQUE    DIM       8         8         1      UNIQUE COUNTER
UNIQUE     FORM      8         5         9
.ADANUMB   FORM      8         5        14      A & E NUMBER
.ATDDATE   DIM       8         8        19      DATE YYMMDD
.ATPATAMT  FORM      8.2       6        27      AMOUNT - PATIENT PORTION
.ADAURNO   FORM      8         5        33      U/R NUMBER
.MCHARGE   DIM       9         9        38      CHARGE CODE
.MDESC     DIM       30        30       47      DESCRIPTION
.PNAME     DIM       35        35       77      PATIENT NAME
.ATRECEPT  DIM       8         8       112      RECEIPT NUMBER
MULTNUM    FORM      3         3       120      MULT NUM
.MINDIC    FORM      1         2       123      INDICATOR FOR CHANGING DESC.
.ADACOMP   DIM       3         3       125      COMPENSATION CODE (CL)
.PFUNDH    DIM       6         6       128      HEALTH FUND TABLE
.PFNDTB    DIM       8         8       134      HEALTH FUND TABLE
.IAMT      FORM      5         4       145      MBS AMOUNT
.MMSCGRP   DIM       3         3       146      MISC CHRGE GROUP (CATEGORY F
.MNINV     FORM      1         2       149      NUMBER OF INVS - 1 or 2 ONLY
.IBAND1    DIM       3         3       151      THEATRE CLASS 1 (CAT TB)
.IBAND2    DIM       3         3       154      THEATRE CLASS 2 (CAT TB)
.IBAND3    DIM       3         3       157      THEATRE CLASS 3 (CAT TB)
.IBAND4    DIM       3         3       160      THEATRE CLASS 4 (CAT TB)
.IBAND5    DIM       3         3       163      THEATRE CLASS 5 (CAT TB)
.IBAND6    DIM       3         3       166      THEATRE CLASS 6 (CAT TB)
.IBAND7    DIM       3         3       169      THEATRE CLASS 7 (CAT TB)
.IBAND8    DIM       3         3       172      THEATRE CLASS 8 (CAT TB)
.ATPATPOR  FORM      8.2       6       175      PATIENT PORTION OF CHARGE
.ATREBPOR  FORM      8.2       6       181      REBATE PORTION OF CHARGE
MBSFLAG    FORM      1         2       187      MBS FLAG
PCENFLG    FORM      1         2       189      PERCENTAGE FEE FLAG
.ADACLASS  DIM       3         3       191      Patient Classification
.IBAND9    DIM       3         3       194
.IBAND10   DIM       3         3       197
.IBAND11   DIM       3         3       200
.IBAND12   DIM       3         3       203
.IBAND13   DIM       3         3       206
.IBAND14   DIM       3         3       210
.IBAND15   DIM       3         3       212
.IBAND16   DIM       3         3       215
.PTMCKREB  DIM       1         1       218
.PTMCGSTA  FORM1     1         2       219
.PTMCGSTC  DIM       6         6       221
. End of record                        227
.
.
.  Program Variables
.
ZABFFLAG  FORM      1
AAEDFLAG  FORM      1
ADIAG     DIM       50
ACCDTE    DIM       8
ATTDOCT   DIM       31
ATTPROV   DIM       10
.
CMDLINE   DIM       50
CURRDATE  DIM       8
CURSESS   DIM       16
CCENT1    DIM       2
CYEAR1    DIM       2
CMON1     DIM       2
CDAY1     DIM       2
CPDATE1   DIM       8
COUNTER   FORM      3
.
DAYFORMT  DIM       4
DESCOPT   DIM       20
DIM1A     DIM       1
DIM2A     DIM       2
DIM3      DIM       3
DIM3A     DIM       3
DIM3B     DIM       3
DIM4      DIM       4
DIM9      DIM       9
DIM12A    DIM       12
DIM13     DIM       13
DIM14     DIM       14
DIM14A    DIM       14
DIM16     DIM       16
DIM18     DIM       18
DIM18A    DIM       18
DIM30     DIM       30
DIM30A    DIM       30
DIM32     DIM       32
DIM70     DIM       70
DNAME     DIM       20
DOCLINE1  DIM       62
DOCLINE2  DIM       62
DOCTCODE  DIM       8
DOCTNAM   DIM       36
.
EMRVFLAG  FORM      1
.
FORM42    FORM      4.2
FORM52    FORM      5.2
FORM8     FORM      8
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FNAMER    DIM       8
FIVE9     FORM      "59"
FORM5     FORM      5
.
FGSTFLAG  FORM      1
EXPVALUE  DIM       30
F10P6     FORM      10.6
EXPFILE   FILE      ASCII, FIXED=127
.
HDUDAY1   FORM      3          * HIGH DEPENDENCY
HDUDAY2   FORM      3
HDUFLG    FORM      "0"
.
ITEMCD    FORM      1
INVOICNO  DIM       8
INVIACTV  DIM       1
.
JOURFLAG  FORM      1
JOURTOT   FORM      7.2
.
KEY12A    DIM       12
KEY21A    DIM       21
KEY26A    DIM       26
KEY29A    DIM       29
KEYFLAG   FORM      1
.
LWCHG     FORM      6.2        * LABOUR WARD FEE
LWCODE    INIT      "LW"
LWDT      DIM       8
LNO       FORM      2
LINENO    FORM      3
.
MULTAMT   FORM      8.2
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MBSLOP    FORM      2
MBSNUM    FORM      "0"
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
OPOCFLAG  FORM      1
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCODE    INIT      "OT"
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8          * OTHER ITEMS
OTDT2     DIM       8
OTFLG     FORM      "0"
.
RACLUESF  DIM       1
REFDOCT   DIM       29
REGIST8   DIM       2
.
FULLPAID  DIM       1
KEYINDOC  DIM       10
SERVDOCT  DIM       10
SELCDATE  DIM       8
SAVAMNT   FORM      12.2
SAVKEY12  DIM       12
SBWINDOW  FORM      1
SELFLG    FORM      "0"
SURGFLG   FORM      "0"
SMCHARGE  DIM       9
SMMSCGRP  DIM       3
SNETTOT   FORM      8.2
.
SEENDTIM  DIM       16
TESTDTIM  DIM       16
TESTDATE  DIM       8
TESTTIME  DIM       8
.
TODAY     DIM       8
TFFSAMNT  FORM      12.2
TRANSNUM  DIM       6
TABLNA    DIM       25
TEMP1     FILE      ASCII, FIXED=79
TEMPAMT   FORM      8.2
THCFLG    FORM      2
THEACHG   FORM      6.2
THDUDT1   DIM       8
THDUDT2   DIM       8
THEADTE   DIM       8
.
CFILEPRE  DIM       3
.
UPDATEKY  DIM       16
.
VCODE     DIM       5
.
WTEXT     FORM      1
.
XAMT      FORM      4.2
XMBS      FORM      5
XDESC     DIM       30
XXADM     DIM       8
XXDATE    DIM       8
XXMULT    FORM      3
XXNAM     DIM       22
.
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODECL    INIT      "CL"
.
SP12      INIT      "            "
SP14      INIT      "              "
.
ZERO8     INIT      "0000    "
.
.
.----------------------------------------------------------------------
PRGID     INIT      "EMRWEB04"
VERSION   INIT      "V12.01.01"
PRGNAM    INIT      "Print EMR Invoices"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      EMRPAT00
          GOTO      MAIN1000
.
MAIN1200  CALL      PRTINV00
          BRANCH    EXIT,MAIN1000
.
          MOVE      SP70,WEBTITLE
          RESET     WEBTITLE
          APPEND    "Printing Complete. Invoice Number:",WEBTITLE
          APPEND    CNEXTINV,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      PREDIR00                * Parent Redirect
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                              " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.------------------------------------------------------------
. Output EMR Patient Enquiry Page
.------------------------------------------------------------
EMRPAT00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,EMRVFLAG
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,EMRPAT50
.
          MOVE      ADMISSNO,ADANUMB
          MOVE      PVIURNO,ADAURNO
.
          COMPARE   NINE,PVITYPE
          GOTO      EMRPAT40 IF NOT EQUAL
.
          MATCH     " 1",PVISYST              * check for Emergency event
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPMEVT1
            IF        @EQUAL
              MOVE      PMEVCCOD,ADACOMP
              MOVE      PMEVACON,ADADOCT
              MOVE      PMEVADTE,ADADATE
              GOTO      EMRPAT60
            ENDIF
          ENDIF
.
EMRPAT40  MOVE      ZERO,EMRVFLAG
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRPAT50
.
          COMPARE   FOUR,EMVISTAT
          IF        @EQUAL
            MOVE      ONE,EMRVFLAG
          ENDIF
.
          MOVE      ZERO,AAEDFLAG
          PACK      KEY8,PVIBILL,SP70
          CALL      RDDETA1
          MOVE      OVRCD,AAEDFLAG
.
          COMPARE   ONE,EMRVFLAG
          IF        @EQUAL
            MOVE      "Emergency Visit record has been Cancelled",WEBTITLE
            CALL      WEBERR00
            GOTO      EMRPAT99
          ENDIF
.
          COMPARE   ONE,AAEDFLAG
          GOTO      EMRPAT60 IF NOT EQUAL
.
EMRPAT50  MOVE      "Invalid Emergency Visit record",WEBTITLE
          CALL      WEBERR00
          GOTO      EMRPAT99
.
EMRPAT60  CALL      CLPATMAS
          CALL      CLPMSPX2
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      TWO,PROGFLAG
.
EMRPAT70  MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE  
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      EMVICOMP,INDMCLAM
          MOVE      "E",INDMSYST 
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
          MOVE      URNUMBER,INDMURNO
          MOVE      ADMISSNO,INDMADNO
.
EMRPAT75  PROC      CHKCLDCP     
          MOVE      EXIT,INVIACTV
.
          CALL      PATNAA00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EMRPAT99
.
          CALL      WEBBOD00   * Output Templated Body of HTML
.
EMRPAT90  CALL      WEBEND00   * Output End of Web Page
.
EMRPAT99  RETURN
.------------------------------------------------------------
. Print Invoice
.------------------------------------------------------------
PRTINV00  MOVE      ZERO,EXIT 
          MOVE      ONE,WEBFLAG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRTINV99
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
.
          MOVE      ADMISSNO,ADANUMB
          MOVE      PVIURNO,ADAURNO
.
          COMPARE   NINE,PVITYPE
          GOTO      PRTINV20 IF NOT EQUAL
.
          MATCH     " 1",PVISYST              * check for Emergency event
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPMEVT1
            IF        @EQUAL
              MOVE      PMEVCCOD,ADACOMP
              MOVE      PMEVACON,ADADOCT
              MOVE      PMEVADTE,ADADATE
              GOTO      PRTINV40
            ENDIF
          ENDIF
.
PRTINV20  MOVE      ADMISSNO,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,PRTINV99
.
PRTINV40  MOVE      ONE,PROGFLAG
.
          MOVE      ZERO,ZABFFLAG              * flag for printing zero dollar
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      PRTINV42 IF NOT EQUAL      * Not Using ABF
.
          PACK      KEY5,ANSC,ANSL,ADACOMP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "A",TCINDC2              * ABF Funding ?
            IF        @EQUAL
              MATCH     SP70,EMVIDSTA
              GOTO      PRTINV42 IF EQUAL      * blank Discharge status
              IF        PRABFINV=0
                MOVE      TWO,PRABFINV         * Calculate Item charges only
              ENDIF
              IF        PRABFINV=1
                MOVE      ONE,ZABFFLAG         * print zero dollar ABF charge
              ENDIF
            ENDIF
          ENDIF
.
PRTINV42  MOVE      ZERO,IPATFLAG
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            MATCH     "003",TEMPLATE
            IF        @EQUAL
              MOVE      TWO,IPATFLAG          * Patient Inv.New Functionality
            ENDIF
          ENDIF
.
          CALL      AAETBI
          COMPARE   ZERO,GROSSTOT
          GOTO      PRTINV70 IF NOT EQUAL
.
.         If ABF invoice amount is zero, check if a $0 amount of invoice
.         had already been raised
.
          IF         ZABFFLAG=1
            CALL       CZER0000               * Check if $0 inv.has been raised
            BRANCH     EXIT,PRTINV80,PRTINV80     * ABF invoice has been raised
            GOTO       PRTINV70                   * print zero dollar invoice
          ENDIF
.
          COMPARE   ONE,PTCNPRIN                  * Print zero total invoice?
          GOTO      PRTINV80 IF NOT EQUAL
.
.         Check if there is any transaction
.
          MOVE      ADANUMB,ADMISSNO
          MOVE      ZERO,EXIT
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
PRTINV44  CALL      RKPMMTI1
          BRANCH    OVRCD,PRTINV80
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      PRTINV80 IF NOT EQUAL     * Found items to be invoiced
.
.         Procedures are included when raising ABF invoice
.
          IF        PRABFINV=2
            MATCH     "8",PMMIRTYP
            GOTO      PRTINV44 IF EQUAL       * Procedure
          ENDIF
.
PRTINV70  CALL      OPNPRINT
          MOVE      THREE,PROGFLAG
          CALL      PRNTINV0
          CALL      CLSPRINT
          CALL      ECLMT000                * Write Eclipse other claimant
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      PCIW0000         * WebServices PCIW
            CALL      LADW0000         * WebServices PCIW Lodgement Advice
          ELSE
            CALL      ESTRF000         * Update Ecipse Store and Forward
            CALL      LADV0000         * ED -Print Lodgement Advice if necessary
          ENDIF
.
.         Update Reassign debt for Patient invoice
.
          IF        IPATFLAG=2
            PROC      PATRDEBT         * Update Reassign debt
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      PRTINV99
.
PRTINV80  MOVE      "No Invoice details to be printed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
PRTINV99  RETURN
+
.------------------------------------------------------------------------------
.         Generating a Lodgement of Advice
.------------------------------------------------------------------------------
LADV0000  MATCH     "1",PTCNUESF
          GOTO      LADV9999 IF NOT EQUAL     * Not using store and forward
.
          MATCH     SP70,EMVICOMP
          GOTO      LADV9999 IF EQUAL         * Blank type of account/claim
.
          MATCH     "1",RACLUESF
          GOTO      LADV9999 IF NOT EQUAL
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LADV9999            * Invalid code
.
          MATCH     "H",TCINDC1
          GOTO      LADV2000 IF EQUAL
          MATCH     "J",TCINDC1
          GOTO      LADV9999 IF NOT EQUAL
.
LADV2000  MOVE      "IBAADT26",SCHDPGID
          MOVE      "Generating a Lodgement of Advice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for ED
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
LADV9999  RETURN
+
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDETB1,"aaedetbf"
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      AAEDTRE1,"aaedtref"
..          OPEN      AAEDTRE3,"aaedtref"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      EMRVISA1,"emrvisaf" 
          OPEN      EMRHISA2,"emrhisaf" 
          OPEN      EMRVCDA1,"emrvcdaf" 
          OPEN      IHAPASS1,"ihapassf"
          OPEN      IBAPRTA1,"ibaprtaf"
          OPEN      IBACODE1,"ibacodef"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATFINS1,"patfinsf"
          OPEN      PATFIGA1,"patfigaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATVISA1,"patvisaf" 
          OPEN      PMSCLTA1,"pmscltaf"
          OPEN      PMSVX1A1,"pmsvx1af" 
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      OUTSITA1,"outsitaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      COMDEPA1,"comdepaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
          OPEN      PMSEVTA1,"pmsevtaf"  
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      VISMDTA1,"vismdtaf"
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
.         Read in parameters
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
          READ      CONTROLF,TEN;*66,CINVLAY,*73,DD,MM,YY,*79,CAPPRVNO:
                                 *94,CAGECOFF,*96,CNEXTINV:
                                *166,CMEMB,*183,CVIEWIP
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2:
                                  CHPPOST,CHTELEB,*211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN9;*219,CINVRAE
          READ      CONTROLF,SEVENTY8;*40,AECNAEIH,*46,AECNAEIT
          READ      CONTROLF,NINTY8;*136,PTCNPAIH,*142,PTCNPAIT
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*237,PTCNPAOF
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN:
                                    *214,PTCNHHFT,*215,PTCNHCLM:
                                    *220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND09;*238,PTCNPRIN     * Display zero invoice
          READ      CONTROLF,EIGHTY9;*205,EMCNDPOC,*206,EMCNOPOC,*221,EMCNGINV
          READ      CONTROLF,HUND22;*12,EMCNPBSD
          READ      CONTROLF,HUND24;*222,PTCNUESF
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          READ      CONTROLF,HUND27;*1,PTCNESFO
          READ      CONTROLF,HUND29;*1,PTCNWSDR,*61,PTCNWSIN,*91,PTCNPCIW:
                                    *89,PTCNPPIN
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
..          READ      CONTROLF,TWENTY;*7,PTCNHP6I,*15,PTCNPEFR:
..                                    *160,PTCND2I7,*171,PTCNHB6I:
..                                    *239,PTCN5LUR,PTCN5LAD
..          READ      CONTROLF,THIRTY;*131,HEMBSTHE,HSTANDM,HINVDES,*168,HNUMDES:
..                                    *203,AECNRECT
..          READ      CONTROLF,FIVE9;*210,PTMBSINV,PTPAYRPR,PTREBRPR,*234,PTHCATAL
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE
.
          READ      CONTROLF,HUND05;*195,PTCNLASR
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMER
.
...  used in ABFAECCL
          CALL      TFILENAM                * Get file name calculating Exponent
          MOVE      TFILNAME,FNAMEN
.
          RETURN
.------------------------------------------------------------
. Open Outpatient files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBB1A1
          OPEN      OUTBB1A1,CFNAME    
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME    
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,SELPRINT
          MOVE      SP70,NOCOPIES
          MOVE      SP70,SBWINDOW
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,TRANSNUM
          MOVE      SP70,SERVDOCT
          MOVE      SP70,KEYINDOC
          MOVE      Z70,FULLPAID
          MOVE      SP70,RACLUESF
          MOVE      ZERO,PRABFINV
          MOVE      SP70,INVOICNO
          MOVE      ZERO,IPATFLAG
          MOVE      ZERO,NWAUFLAG
          CALL      CLPMCL00
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbwindow=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SBWINDOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERVDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keyindoc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYINDOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fullpaid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FULLPAID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmclt",QRYNAME
          IF        @EQUAL
            CALL      SPMCL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "racluesf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLUESF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prabfinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRABFINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVOICNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      INVD0000
          GOTO      PROFLD99
.
PROFLD13  CALL      EMRA0000
          GOTO      PROFLD99
.
PROFLD14  CALL      EMRB0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
.   Verify Patient Invoice
.------------------------------------------------------------
INVD0000  BRANCH    FLDITMNO,INVD0100,INVD0200,INVD0300,INVD0400,INVD0500:
                             INVD0600,INVD0700,INVD0800,INVD0900,INVD1000:
                             INVD1100,INVD1200,INVD1300,INVD1400,INVD1500:
			     INVD1600,INVD1700,INVD1800,INVD1900,INVD2000:
                             INVD2100,INVD2200,INVD2300,INVD2400,INVD2500:
                             INVD2600
          GOTO      INVD9999
.
INVD0100  CALL      SELPRT00                * Select Printer
          GOTO      INVD9999
.
INVD0200  CALL      FRMDAT00
          GOTO      INVD9999
.
INVD0300  CALL      TODATE00
          GOTO      INVD9999
.
INVD0400  MOVE      ZERO,IPATFLAG
          CALL      EMRD0000                * Display EMR Invoice
          GOTO      INVD9999
.
INVD0500  WRITE     HTMLFILE;TRANSNUM;
          GOTO      INVD9999
.
INVD0600  MOVE      ZERO,PRABFINV
          CALL      ZERINV00                * Check for zero invoice amount
          WRITE     HTMLFILE;FORM1;
          GOTO      INVD9999
.
INVD0700  COMPARE   ONE,IBCNMHOS
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXMHOS,KEY3
            OPEN      PATHSPA1,"pathspaf"
            CALL      RDPTHSP1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTHSNAME;
            ENDIF
          ENDIF
          GOTO      INVD9999
.
INVD0800  MOVE      SP70,KEY10
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,INVD0880
          COMPARE   NINE,PVITYPE
          GOTO      INVD0820 IF NOT EQUAL
          MATCH     " 1",PVISYST        * check for Emergency event
          GOTO      INVD0820 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,INVD0880
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,INVD0880
.
          MATCH     ANSE,TCINDC1
          GOTO      INVD0880 IF NOT EQUAL
.
          MOVE      PMEVACON,KEY10      * attending doctor
          GOTO      INVD0880
.
INVD0820  MOVE      SP70,EMVIDOCT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,INVD0880
.
          MOVE      EMVIDOCT,KEY10
INVD0880  WRITE     HTMLFILE;KEY10;
          GOTO      INVD9999
.
INVD0900  WRITE     HTMLFILE;EMCNGINV;
          GOTO      INVD9999
.
INVD1000  WRITE     HTMLFILE;ADADOCT;
          GOTO      INVD9999
.
INVD1100  CALL      EMDOC000            * Get doctors from history file
          GOTO      INVD9999
.
INVD1200  WRITE     HTMLFILE;SERVDOCT;
          GOTO      INVD9999
.
INVD1300  MOVE      ONE,PROGFLAG
          CALL      AAETBI 
          CALL      GCSH0000
          SUB       FORM12P2,GROSSTOT
          WRITE     HTMLFILE;GROSSTOT;
          GOTO      INVD9999
.
INVD1400  CALL      NXBC0000                * Next Invoice billing comment
          GOTO      INVD9999
.
INVD1500  MATCH     "1",PTCNHCLM
          IF        !@EQUAL
            UNPACK    DIM127,D1,KEY1,DIM127
            GOTO      INVD9999
          ENDIF
.         GOTO      INVD9999 IF NOT EQUAL
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          CALL      CODITM00
          GOTO      INVD9999
.
INVD1600  MATCH     "1",PTCNHHFT
          GOTO      INVD9999 IF NOT EQUAL
.
          MATCH     SP70,EMVIFUND
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;EMVIFUND,SLASH,EMVITABL;
          ENDIF
          GOTO      INVD9999
.
INVD1700  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMCL0000                * Eclipse other claimant tags
          GOTO      INVD9999
.
INVD1800  CALL      AGEA0000                * Age at time of attendance
          WRITE     HTMLFILE;F1;
          GOTO      INVD9999
.
INVD1900  CALL      ECLESF00
          GOTO      INVD9999
.
INVD2000  MOVE      ZERO,NWAUFLAG
          MOVE      SP70,KEY3
          UNPACK    DIM127,D1,KEY3,DIM127
          PACK      KEY3,KEY3,SP70
          MATCH     "001",KEY3
          IF        @EQUAL
            MOVE      ONE,NWAUFLAG          * NWAU Calculations
          ENDIF
          CALL      ABFAEDET
          MOVE      ZERO,NWAUFLAG
          GOTO      INVD9999
.
INVD2100  WRITE     HTMLFILE;PRABFINV;
          GOTO      INVD9999
.
INVD2200  MOVE      ONE,PRABFINV            * ABF invoice only
          CALL      ZERINV00                * Check for zero ABF invoice amount
          WRITE     HTMLFILE;FORM1;
          GOTO      INVD9999
.
INVD2300  MOVE      SP70,D8
          PACK      D8,INVOICNO,SP70
          MATCH     SP70,D8
          GOTO      INVD2320 IF NOT EQUAL
.
          CALL      ABIV0000                * Get ABF Invoice number
          MOVE      ZERO,F8
          MOVE      D8,F8
          COMPARE   ZERO,F8
          GOTO      INVD9999 IF EQUAL       * No ABF Invoice raised
.
INVD2320  MOVE      ", Invoice : ",KEY12
          PACK      KEY20,KEY12,D8,SP70
          WRITE     HTMLFILE;KEY20;
          GOTO      INVD9999
.
INVD2400  MATCH     "1",PTCNPPIN
          GOTO      INVD9999 IF NOT EQUAL
          MOVE      TWO,IPATFLAG
          CALL      EMRD0000                * Display EMR Invoice
          GOTO      INVD9999
.
INVD2500  WRITE     HTMLFILE;INVIACTV;      * Patient invoice inactive flag
          GOTO      INVD9999
.
INVD2600  CALL      EMDCC000            * Get doctors from history file
          GOTO      INVD9999
.
INVD9999  RETURN
+
.------------------------------------------------------------
.         Check Patient's age at time of attendance
.------------------------------------------------------------
AGEA0000  MOVE      ZERO,F1
          MATCH     "1",PTCNUESF
.         GOTO      AGEA9999 IF NOT EQUAL   * Not using Store and Forward
          IF        !@EQUAL
            MATCH     "1",PTCNPCIW
            GOTO      AGEA9999 IF NOT EQUAL   * Not using PCIW
          ENDIF
.
          MOVE      EMVIDATE,AGEDATE        * attendance date
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          COMPARE   PSAGEYRS,CAGECOFF         * Child?
          GOTO      AGEA9999 IF LESS          * No
.
          MOVE      ONE,F1                    * default Other Claimant to tick
.
AGEA9999  RETURN
+
.------------------------------------------------------------
.         Check Next invoice billing comments
.------------------------------------------------------------
NXBC0000  MOVE      ZERO,F1
          MOVE      "003",KEY3
          PACK      KEY17,ADMISSNO,KEY3,Z70
          CALL      RSVSMDT1
NXBC1000  CALL      RPVSMDT1
          BRANCH    OVRCD,NXBC9000
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      NXBC9000 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      NXBC1000 IF EQUAL        * Deleted
.
          MOVE      ONE,F1
.
NXBC9000  WRITE     HTMLFILE;F1;
NXBC9999  RETURN
+
.******************************************************************************
.   Get doctors from history file
.******************************************************************************
EMDOC000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          OPEN      EMRHISA2,"emrhisaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          COMPARE   ONE,PVITYPE
          GOTO      EMDOC500 IF EQUAL
          COMPARE   NINE,PVITYPE
          GOTO      EMDOC100 IF EQUAL
.         
          GOTO      EMDOC999
.         
EMDOC100  MOVE      SP70,PMEVACON
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,EMDOC999
.
          MATCH     SP70,PMEVACON
          GOTO      EMDOC999 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDOC999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          PACK      KEY12,QUOTE,PMEVACON,QUOTE
          WRITE     HTMLFILE;"<option value=#"",PMEVACON,"#" selected>":
                                PACFNAME,"</option>";
          GOTO      EMDOC999
.
EMDOC500  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMDOC999
.
          MATCH     SP70,SERVDOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=ALL selected>":
                             "All</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=ALL>":
                             "All</option>";
          ENDIF
.
          MOVE      SP70,DIM10
          PACK      KEY32,ADMISSNO,Z70
          CALL      RSEMHIS2
EMDOC600  CALL      RPEMHIS2
          BRANCH    OVRCD,EMDOC999
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      EMDOC999 IF NOT EQUAL
.
          MATCH     SP70,EMHIDOC
          GOTO      EMDOC600 IF EQUAL
.
          MATCH     DIM10,EMHIDOC
          GOTO      EMDOC600 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          PACK      KEY10,EMHIDOC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDOC600
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          MATCH     SP70,SERVDOCT
          GOTO      EMDOC700 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#">":
                              PACFNAME,"</option>";
          GOTO      EMDOC600
.
EMDOC700  MATCH     EMHIDOC,SERVDOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#" selected>":
                                PACFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#">":
                                PACFNAME,"</option>";
          ENDIF
          GOTO      EMDOC600
.
EMDOC999  RETURN
+
.------------------------------------------------------------
.------------------------------------------------------------
. Display EMR Invoice Details
.------------------------------------------------------------
EMRD0000  MOVE      ADMISSNO,ADANUMB
          MOVE      ADANUMB,KEY8
          MOVE      TWO,PROGFLAG
          MOVE      ONE,INVPRTD
          MOVE      ZERO,PAGENO
          MOVE      ONE,WEBFLAG
          MOVE      ZERO,IPASS
          MOVE      ONE,NUMINVS
          MOVE      ZERO,PPAYABLE
          CALL      INVPRT                     *Display the invoice
          MOVE      ZERO,EXIT
.
EMRD9999  RETURN
.------------------------------------------------------------
. Check for zero EMR Invoice amount
.------------------------------------------------------------
ZERINV00  MOVE      ZERO,FORM1
          MOVE      ZERO,ZABFFLAG              * flag for printing zero dollar
          MOVE      ONE,WEBFLAG
          MOVE      SP70,ADACOMP
          MOVE      ADANUMB,KEY8
          CALL      RDDETA1
          IF        OVRCD=1
            OPEN      PMSEVTA1,"pmsevtaf"
            CALL      RDPMEVT1
            IF        @EQUAL
              MOVE      PMEVCCOD,ADACOMP
            ENDIF
          ENDIF
          MATCH     SP70,ADACOMP
          GOTO      ZERINV90 IF EQUAL         * Blank claim code
.
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      ZERINV20 IF NOT EQUAL      * Not Using ABF
.
          PACK      KEY5,ANSC,ANSL,ADACOMP
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "A",TCINDC2              * ABF Funding ?
            IF        @EQUAL
              MATCH     SP70,EMVIDSTA
              GOTO      ZERINV90 IF EQUAL      * blank Discharge status
              IF        PRABFINV=0
                MOVE      TWO,PRABFINV         * Calculate Item charges only
              ENDIF
              IF        PRABFINV=1
                MOVE      ONE,ZABFFLAG         * print zero dollar ABF charge
              ENDIF
            ENDIF
          ENDIF
.
ZERINV20  MOVE      ONE,PROGFLAG
          CALL      AAETBI 
          COMPARE   ZERO,GROSSTOT             * check for zero invoice amount
          GOTO      ZERINV92 IF NOT EQUAL
.
.         If ABF invoice amount is zero, check if a $0 amount of invoice
.         had already been raised
.
          IF        ZABFFLAG=1
            CALL       CZER0000               * Check if $0 inv.has been raised
            BRANCH     EXIT,ZERINV90,ZERINV90 * ABF invoice has been raised
            GOTO       ZERINV92               * print zero dollar invoice
          ENDIF
.
          BRANCH    PRABFINV,ZERINV90         * ABF Invoice only
.
          COMPARE   ONE,PTCNPRIN              * Print zero total invoice?
          GOTO      ZERINV90 IF NOT EQUAL
.
.         Check if there is any transaction
.
          MOVE      ADANUMB,ADMISSNO
          MOVE      ZERO,EXIT
          PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
ZERINV30  CALL      RKPMMTI1
          BRANCH    OVRCD,ZERINV90
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      ZERINV90 IF NOT EQUAL
.
.         Procedures are included when raising ABF invoice
.
          IF        PRABFINV=2
            MATCH     "8",PMMIRTYP
            GOTO      ZERINV30 IF EQUAL       * Procedure
          ENDIF
.
          GOTO      ZERINV92                  * Found items to be invoiced
.
ZERINV90  MOVE      ONE,FORM1                 * Print option disabled
          MOVE      ZERO,PRABFINV
          GOTO      ZERINV99
.
ZERINV92  MOVE      ZERO,FORM1                * Print option available
          MOVE      ZERO,PRABFINV
ZERINV99  RETURN
+
.--------------------------------------------------------------
.       Check for cancelled visit or $0 invoice has been raised
.       Do not raise invoice if patient is not discharged
.--------------------------------------------------------------
CZER0000  MOVE      ZERO,EXIT
          MOVE      ADANUMB,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            BRANCH   EMVISTAT,CZER9000           * not discharged
            COMPARE  FOUR,EMVISTAT
            GOTO     CZER9000 IF EQUAL           * Cancelled visit
          ENDIF
.
          PACK      KEY16,ADANUMB,Z70            * position in invoice file
          CALL      RDSINV3
CZER1000  CALL      RDPINV3                      * read the next record
          BRANCH    OVRCD,CZER9999               * no more records
.
          MATCH     ADANUMB,PINVADM              * same admission # ?
          GOTO      CZER9999 IF NOT EQUAL        * no
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      CZER1000 IF NOT EQUAL        * Credit note
.
          COMPARE   THREE,PTINCMIX
          GOTO      CZER9200 IF EQUAL            * ABF Invoice
.
          COMPARE   ZERO,PINVAMT
          GOTO      CZER1000 IF NOT EQUAL
.
CZER9000  MOVE      ONE,EXIT                     * found an invoice with $0
          GOTO      CZER9999
.
CZER9200  MOVE      TWO,EXIT                     * ABF invoice raised already
CZER9999  RETURN
+
.------------------------------------------------------------
. Get ABF Invoice number
.------------------------------------------------------------
ABIV0000  MOVE      ZERO,D8
          PACK      KEY16,ADANUMB,SP70
          CALL      RDSINV3
ABIV1000  CALL      RDKINV3
          BRANCH    OVRCD,ABIV9999
.
          MATCH     PINVADM,ADANUMB
          GOTO      ABIV9999 IF NOT EQUAL
.
          COMPARE   THREE,PTINCMIX           * ABF Invoice ?
          GOTO      ABIV1000 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABIV1000 IF NOT EQUAL    * Credit notes
.
          MOVE      PINVNO,D8
.
ABIV9999  RETURN
+
.------------------------------------------------------------
TODATE00  BRANCH    EMVISTAT,TODATE10,TODATE20,TODATE30,TODATE40
          GOTO      TODATE99
.
TODATE10  CALL      IBACLOCK
          MOVE      CMM,F2
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDD,SP1,MTHNAM3,SP1,CCC,CYEAR;
          GOTO      TODATE99
.
TODATE20  WRITE     HTMLFILE;"Discharge Incomplete"
          GOTO      TODATE99
.
TODATE30  UNPACK    EMVIDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
TODATE40  WRITE     HTMLFILE;"Visit Cancelled"
          GOTO      TODATE99
.
TODATE99  RETURN
.------------------------------------------------------------
FRMDAT00  PACK      KEY16,AADMNO,Z70
          CALL      RDSINV3
FRMDAT10  CALL      RDPINV3
          BRANCH    OVRCD,FRMDAT20
.
          MATCH     EMVIADMN,PINVADM
          GOTO      FRMDAT20 IF NOT EQUAL
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FRMDAT99
.
FRMDAT20  UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
. 
FRMDAT99  RETURN
+
.***************************************************************************
.         Subroutine to get the total cash amount currently entered
.***************************************************************************
GCSH0000  OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          MOVE      ZERO,FORM12P2
.
          MOVE      AADMNO,DAADMNO
          MOVE      "0",CMDESTAT
          PACK      KEY26,AADMNO,CMDESTAT,SP70
          CALL      RSCMDEP2
GCSH1000  CALL      RKCMDEP2
          BRANCH    OVRCD,GCSH5000
.
          MATCH     DAADMNO,CMDEADMN
          GOTO      GCSH5000 IF NOT EQUAL
          MATCH     "0",CMDESTAT
          GOTO      GCSH5000 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,GCSH1000
.
          ADD       RCDTAMNT,FORM12P2
          GOTO      GCSH1000
.
.         Check for any non-banked deposits
.
GCSH5000  PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
GCSH7000  CALL      RKRCDTE6
          BRANCH    OVRCD,GCSH9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      GCSH9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      GCSH7000 IF NOT EQUAL
          MATCH     SP70,RCDTRELD
          GOTO      GCSH7000 IF NOT EQUAL   * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,GCSH7000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      GCSH7000 IF EQUAL
.
          ADD       RCDTAMNT,FORM12P2
          GOTO      GCSH7000
.
GCSH9999  RETURN
+
.------------------------------------------------------------
. This is how the routines are setup in IBAAAE20
.------------------------------------------------------------
RDADMB1   RETURN  *Maternity for PATINVT5
RDSITA1   RETURN  *outpatients for PATINVT8
CHKCMXPT  RETURN
.
OLUM0000 
DLUM0000  RETURN
SCODL000  RETURN
.
.------------------------------------------------------------------------------
. Write Eclipe other claimant details record
.------------------------------------------------------------------------------
ECLMT000  MATCH     Z70,PMCLT001            * webPAS Module
          GOTO      ECLMT999 IF EQUAL
.
          MATCH     Z70,PMCLT003            * Claimant Family Name
          GOTO      ECLMT999 IF EQUAL
.
          MOVE      CNEXTINV,PMCLT002       * Populate invoice number
          CALL      CLPMSCLT                * Clear variables
          CALL      MVPMCL00                * Populate variables
.
          PACK      KEY9,PMCLWMOD,PMCLINUM,SP70
          CALL      RAPMCLT1
          IF        OVRCD=1
            CALL     WRPMCLT1
          ENDIF
.
ECLMT999  RETURN

.------------------------------------------------------------------------
.         Update Account Paid in Full and Eclipse Claim Store anf Forward
.------------------------------------------------------------------------
ESTRF000  MATCH     "1",PTCNUESF
          GOTO      ESTRF999 IF NOT EQUAL   * Not using Store and Forward
.
          MATCH     Z70,FULLPAID
          GOTO      ESTRF999 IF EQUAL
.
          MOVE      PINVNO,KEY8
          CALL      RDINV1
          IF        OVRCD=0
            MOVE      FULLPAID,PTINAPIN     * Account paid indicator (ECLIPSE)
            CALL      UPINV1
          ENDIF
.
.         Check for Private Claim
.
          MATCH     SP70,PINVCLM
          GOTO      ESTRF999 IF EQUAL
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PINVCLM
          CALL      RDCODE1
          BRANCH    OVRCD,ESTRF999
.
          MATCH     "H",TCINDC1
          GOTO      ESTRF200 IF EQUAL      * Private claim
          MATCH     "J",TCINDC1
          GOTO      ESTRF999 IF NOT EQUAL  * Private uninsured
.
ESTRF200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      ESTRF9999 IF EQUAL     * No item to claim
.
.         Write a record to Claim store and forward file
.
          OPEN      EMRECTA1,"emrectaf"
.
          CALL      CLEMRECT
          MOVE      PMVXMHOS,EMECHOSP
          MOVE      ZERO,EMECFLAG
          MOVE      "1",EMECMODL           * Emergency
          MOVE      PINVNO,EMECINVN
          MOVE      PINVUR,EMECURNO
          MOVE      PINVADM,EMECUNIQ
          MOVE      FORM12P2,EMECAMTC      * Amoutn claimed
          PACK      KEY30,EMECHOSP,EMECFLAG,EMECMODL,EMECUNIQ:
                          EMECINVN,EMECBATN,SP70
          CALL      WREMECT1
.
          MATCH     "1",RACLUESF
          GOTO      ESTRF999 IF NOT EQUAL
.
          MATCH     SP70,PTCNESFO                * eclipse outbound path set?
          GOTO      ESTRF999 IF EQUAL
.
          CALL      SESFX000
.
ESTRF999  RETURN
+
.------------------------------------------------------------------------
.         Check if all procedures have a rebate reason
.------------------------------------------------------------------------
CPRC0000  MOVE      ZERO,FORM12P2
          PACK      KEY22,ADMISSNO,PINVNO,SP70
          CALL      RDSDTRE1
CPRC1000  CALL      RDKDTRE1
          BRANCH    OVRCD,CPRC9999
.
          MATCH     ADMISSNO,DATNUMB
          GOTO      CPRC9999 IF NOT EQUAL
          MATCH     PINVNO,ATINVNO
          GOTO      CPRC9999 IF NOT EQUAL
.
          MATCH     "5",DATRECTY
          GOTO      CPRC1000 IF NOT EQUAL     * Not a procedure record
.
.         MATCH     SP70,ATDTRBRS
.         GOTO      CPRC8000 IF EQUAL         * No rebate reason
.
          ADD       ATPATAMT,FORM12P2
          GOTO      CPRC1000
.
CPRC8000  MOVE      ZERO,FORM12P2          * found procedure with No reb.reason
.
CPRC9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SESFX000                                   *
.*               Schedule Eclipse Extract (IBAEMR04)                      *
.--------------------------------------------------------------------------
SESFX000  MOVE      "IBAEMR04",SCHDPGID
          MOVE      "Eclipse PCS Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAEMR04",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      EMECHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SESFX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SESFX600
.
SESFX500  MOVE      TWO,F3
.
SESFX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    EMECHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    EMECUNIQ,ECCLMARR
          APPEND    EMECINVN,ECCLMARR
          APPEND    EMECURNO,ECCLMARR
          APPEND    PINVDTE,ECCLMARR
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),EMECAMTC
          IF        IBCNUGST=2
            ADD       PTINGSTJ,EMECAMTC
          ENDIF
.
          APPEND    EMECAMTC,ECCLMARR
          APPEND    ONE,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SESFX999  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse PCS / WebServices PCIW
.------------------------------------------------------------
ECLESF00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNUESF
.         GOTO      ECLESF90 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",PTCNPCIW
            GOTO      ECLESF90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,EMVICOMP
          GOTO      ECLESF90 IF EQUAL
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          CALL      GETCOD00
.
          MATCH     "H",TCINDC1
          IF        @EQUAL
            GOTO      ECLESF80
          ENDIF
.
          MATCH     "J",TCINDC1
          IF        @EQUAL
            GOTO      ECLESF80
          ENDIF
.
          GOTO      ECLESF90
.
ECLESF80  MOVE      ONE,DIM1
.
ECLESF90  WRITE     HTMLFILE;DIM1;
ECLESF99  RETURN
+
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
+
.------------------------------------------------------------------------
.         Update Account Paid in Full and WebServices PCIW
.------------------------------------------------------------------------
PCIW0000  MATCH     "1",PTCNWSIN
          GOTO      PCIW9999 IF NOT EQUAL   * Not using WebServices
.
          MATCH     "1",PTCNPCIW
          GOTO      PCIW9999 IF NOT EQUAL   * Not Using PCIW
.
          MATCH     Z70,FULLPAID
          GOTO      PCIW9999 IF EQUAL
.
.         MOVE      PINVNO,KEY8
          PACK      KEY8,CNEXTINV,SP70
          CALL      RDINV1
          IF        OVRCD=0
            MOVE      FULLPAID,PTINAPIN     * Account paid indicator (ECLIPSE)
            CALL      UPINV1
          ENDIF
.
.         Check for Private Claim
.
          MATCH     SP70,PINVCLM
          GOTO      PCIW9999 IF EQUAL
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PINVCLM
          CALL      RDCODE1
          BRANCH    OVRCD,PCIW9999
.
          MATCH     "H",TCINDC1
          GOTO      PCIW0200 IF EQUAL      * Private claim
          MATCH     "J",TCINDC1
          GOTO      PCIW9999 IF NOT EQUAL  * Private uninsured
.
PCIW0200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      PCIW99999 IF EQUAL     * No item to claim
.
.         Write a record to PCIW file
.
          OPEN      WEBPCIA1,"webpciaf"
.
          CALL      CLWEBPCI
          MOVE      PMVXMHOS,WBPIHOSP
          MOVE      ZERO,WBPIFLAG
          MOVE      "1",WBPIMODL           * Emergency
          MOVE      PINVNO,WBPIINVN
          MOVE      PINVUR,WBPIURNO
          MOVE      PINVADM,WBPIUNIQ
          MOVE      FORM12P2,WBPIAMTC      * Amoutn claimed
          PACK      KEY30,WBPIHOSP,WBPIFLAG,WBPIMODL,WBPIUNIQ:
                          WBPIINVN,WBPIBATN,SP70

          CALL      IBACLOCK
          PACK      WBPICDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBPICDAT
          MOVE      CTIMEIS,WBPICTIM
          MOVE      USERID,WBPICUID

          CALL      WRWBPCI1
.
          MATCH     "1",RACLUESF
          GOTO      PCIW9999 IF NOT EQUAL
.
.         MATCH     SP70,PTCNESFO                * eclipse outbound path set?
.         GOTO      PCIW9999 IF EQUAL
.
          CALL      SPCIX000
.
PCIW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SPCIX000                                   *
.*               Schedule WebServices PCIW Extract (IBAWEB05)             *
.--------------------------------------------------------------------------
SPCIX000  MOVE      "IBAWEB05",SCHDPGID
          MOVE      "WebServices PCIW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB05",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBPIHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SPCIX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SPCIX600
.
SPCIX500  MOVE      TWO,F3
.
SPCIX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBPIHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBPIUNIQ,ECCLMARR
          APPEND    WBPIINVN,ECCLMARR
          APPEND    WBPIURNO,ECCLMARR
          APPEND    PINVDTE,ECCLMARR
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),WBPIAMTC
          IF        IBCNUGST=2
            ADD       PTINGSTJ,WBPIAMTC
          ENDIF
.
          APPEND    WBPIAMTC,ECCLMARR
          APPEND    ONE,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SPCIX999  RETURN
+
.------------------------------------------------------------------------------
.         Generating a Lodgement of Advice PCIW
.------------------------------------------------------------------------------
LADW0000  MATCH     "1",PTCNWSIN
          GOTO      LADW9999 IF NOT EQUAL     * Not using WebServices
.
          MATCH     "1",PTCNPCIW
          GOTO      LADW9999 IF NOT EQUAL     * Not using WebServices PCIW
.
          MATCH     SP70,EMVICOMP
          GOTO      LADW9999 IF EQUAL         * Blank type of account/claim
.
          MATCH     "1",RACLUESF
          GOTO      LADW9999 IF NOT EQUAL
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LADW9999            * Invalid code
.
          MATCH     "H",TCINDC1
          GOTO      LADW2000 IF EQUAL
          MATCH     "J",TCINDC1
          GOTO      LADW9999 IF NOT EQUAL
.
LADW2000  MOVE      "IBAWEB26",SCHDPGID
          MOVE      "Generating a PCIW Lodgement of Advice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for ED
          MOVE      CNEXTINV,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
LADW9999  RETURN
+
.******************************************************************************
.   Get doctors from history file Cabrini
.******************************************************************************
EMDCC000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          OPEN      EMRHISA2,"emrhisaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          COMPARE   ONE,PVITYPE
          GOTO      EMDCC500 IF EQUAL
          COMPARE   NINE,PVITYPE
          GOTO      EMDCC100 IF EQUAL
.
          GOTO      EMDCC999
.
EMDCC100  MOVE      SP70,PMEVACON
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,EMDCC999
.
          MATCH     SP70,PMEVACON
          GOTO      EMDCC999 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDCC999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          PACK      KEY12,QUOTE,PMEVACON,QUOTE
          WRITE     HTMLFILE;"<option value=#"",PMEVACON,"#" selected>":
                                PACFNAME,"</option>";
          GOTO      EMDCC999
.
EMDCC500  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMDCC999
.
          MATCH     SP70,SERVDOCT
          IF        @EQUAL
.            WRITE     HTMLFILE;"<option value=ALL selected>":
.                             "All</option>";
          ELSE
.            WRITE     HTMLFILE;"<option value=ALL>":
.                             "All</option>";
          ENDIF
.
          MOVE      SP70,DIM10
          PACK      KEY22,ADMISSNO,SP70
          CALL      RSEMHIS1
EMDCC600  CALL      RKEMHIS1
          BRANCH    OVRCD,EMDCC999
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      EMDCC999 IF NOT EQUAL
.
          MATCH     SP70,EMHIDOC
          GOTO      EMDCC600 IF EQUAL
.
          MATCH     DIM10,EMHIDOC
          GOTO      EMDCC600 IF EQUAL
.
          MOVE      EMHIDOC,DIM10
          PACK      KEY10,EMHIDOC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,EMDCC600
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          MATCH     SP70,SERVDOCT
          GOTO      EMDCC700 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#">":
                              PACFNAME,"</option>";
          GOTO      EMDCC600
.
EMDCC700  MATCH     EMHIDOC,SERVDOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#" selected>":
                                PACFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",EMHIDOC,"#">":
                                PACFNAME,"</option>";
          ENDIF
          GOTO      EMDCC600
.
EMDCC999  RETURN
+
          INC       IBAWEBCD
          INC       TFILENAM                * Generate Temp File Name
          INC       CLPMSCLT
          INC       CLPMSABF
.
          INC       APSMASIO/INC
          INC       AAEDE1IO/INC
          INC       AAEDEBIO/INC
          INC       AAEDI1IO/INC
          INC       AAEDTRIO/INC
          INC       AAEMCHIO/INC
          INC       BOKRC1IO/INC
          INC       COMDEPIO/INC
          INC       EMRVISIO/INC
          INC       EMRVISTM
          INC       EMRDOCIO/INC
          INC       EMRHISIO/INC
          INC       EMRICDIO/INC
          INC       EMRSITIO/INC
          INC       EMRGRCIO/INC
          INC       EMRLOCIO/INC
          INC       EMRVCDIO/INC
          INC       EMRUNKIO/INC
          INC       EMRECTIO/INC
          INC       IBATMDIO/INC
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       MLTCFNIO/INC
          INC       NZPCFNIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIVBIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       NZPRDTIO/INC
          INC       NZPSPRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       OUTDTRIO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       OPRNURIO/INC
          INC       MAMMASIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       PATALRIO/INC
          INC       PATDRGIO/INC
          INC       PATCRAIO/INC
          INC       PATINPIO/INC
          INC       PMSTLEIO/INC
          INC       PATINLIO/INC
          INC       PATICDIO/INC
          INC       PATCFAIO/INC
          INC       PATCMXIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATDO1IO/INC
          INC       PATECDIO/INC
          INC       PATIBLIO/INC
          INC       PATIN1IO/INC
          INC       PATIPEIO/INC
..          INC       PATINMIO/INC
          INC       PATIRNIO/INC
          INC       PATITMIO/INC
          INC       PATINVIO/INC
          INC       PATFN1IO/INC
          INC       PATFIGIO/INC
          INC       PATFINIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATMCHIO/INC
          INC       PATHSPIO/INC
          INC       PATMA1IO/INC
          INC       PATRFGIO/INC
          INC       PATONHIO/INC
          INC       PMSCLTTM
          INC       PMSCLTIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATRFNIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATWMAIO/INC
          INC       PATWC1IO/INC
          INC       PATWVEIO/INC
          INC       PATWR1IO/INC
          INC       PATVISIO/INC
          INC       PATVADIO/INC
          INC       PMSEXTIO/INC
          INC       PMSPRGIO/INC
          INC       PMSEVTIO/INC
          INC       PMSCNOIO/INC
          INC       PMSFCIIO/INC
          INC       PMSMTIIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
          INC       EMRHTRIO/INC
.
          INC       RESLNKIO/INC
          INC       RCPCRSIO/INC
          INC       RCPBNKIO/INC
          INC       RCPREGIO/INC
          INC       RCPBDTIO/INC
          INC       RCPDTEIO/INC
          INC       MRTMASIO/INC
          INC       PRIITMIO/INC
          INC       VISMDTIO/INC
.
          INC       PMSABFIO/INC
          INC       PMSVMTIO/INC
.
          INC       WEBPCIIO/INC
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       AAECMNT
          INC       AAEINVS
          INC       AAECATBI
          INC       CALCAGE
          INC       NAMSTRCD
          INC       PATCALFN
          INC       PATCATAI
          INC       PATGBCRN             * I-48227
..          INC       PATIVMES
          INC       PATCODKY
..          INC       KYPTBANK
          INC       PATMASTM
          INC       CLPATMAS
          INC       CLPMSPX2
          INC       CLPATINV
          INC       CLPATDTR
          INC       CLPATINP
          INC       CLAAEDTR
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       GETALTID
          INC       PRNTICDC
          INC       PATIPERH
          INC       ABFAEDET
          INC       PATRDEBT
.
          INC       RSHWEBCD
          INC       PATINVHL
          INC       PATINVTL
          INC       PRTINVBD
          INC       PMSOSDTM                * Outstanding Debt alert routine
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       PATITMRD
          INC       CLEMRVIS
          INC       CLEMRECT
          INC       CLWEBPCI
          INC       WEBDATCD
          INC       DAYOFWEK
          INC       CHKCLDCP
