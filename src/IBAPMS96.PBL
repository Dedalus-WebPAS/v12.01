.*******************************************************************************
.* System         : Waiting List                                               *
.* Program        : IBAPMS96.PBL                                               *
.* Name           : AROC Inpatient Clinical Data Set                           *
.*******************************************************************************
.* Date           : 17/05/2012                                                 *
.* Author         : Patrick Adair                                              *
.* Function       : Extract AROC Inpatient Clinical Data Set Version 3 and     *
.                   Version 4 modificatons                                     *
.* Modifications  :                                                            *
.*-----------------------------------------------------------------------------*
.* V10.11.01  26/09/2017 Richa Phogat   TSK 0844773                            *
.*            Added 'Admission number' in ETAC0000                             *
.* V10.10.01  16/0/2017  Jill Parkinson TSK 0818098                            *
.*            Changed to use PMAGDUGO and PMAGDWLK                             *
.* V10.08.02  31/08/2016 Peter Vela     TSK 0819601                            *
.*            Added extra codes to EPRG3300 (Duration of PTA)                  *
.* V10.08.01  11/05/2015 Ebon Clements  TSK 0816206                            *
.*            Default XXAFUNDH to 999 for type 02, 04 and 05.                  *
.*            It was originally doing it for types 02,03 and 04. - EPRG0000    *
.* V10.07.01  12/10/2015 Peter Vela     CAR 319148                             *
.*            In EPRG0000 - Default XXAFUNDH to spaces first, then default to  *
.*            999 only for claim types 02,03 or 04. Then use existing          *
.*            functionality to update XXAFUNDH.                                *
.* V10.06.01  14/07/2015 Jill Parkinson CAR 317036                             *
.*            Added clear of CLAIMTYP                                          *
.* V10.05.02  21/01/2015 Jill Parkinson CAR 306662                             *
.*            Mods to only send Duration of PTA for codes 02.22 and fixed      *
.*            DVA to send blank fund                                           *
.* V10.05.01  17/07/2014 Patrick Adair                              CAR 299233 *
.*                       Amended to Extract first admission fim score and      *
.*                       last discharge fim score only for all visits for the  *
.*                       program                                               *
.* V10.04.04  06/05/2014 Patrick Adair                              CAR 298784 *
.*                       AROC V4 Dataset Modification for Chronic              *
.*                       Amnesiac/Duration of PTA                              *
.* V10.04.03  26/03/2014 Patrick Adair                              CAR 296308 *
.*                       Amended Date of Impairment to ignore spaces in format *
.* V10.04.02  19/12/2013 Patrick Adair                              CAR 289797 *
.*                       Amended reason for delay in start extract values      *
.*                       Update R118 for new requirements                      *
.* V10.04.01  19/12/2013 Patrick Adair                              CAR 295492 *
.*                       Move PMAGDCRC to dim 8 field for comparison           *
.*                       Corrected Date of Impairment onset check R104         *
.* V10.03.19  13/12/2013 Jill Parkinson CAR 283236                             *
.*                       Changed EXTR1000 to validate atype, aclaim, afundh    *
.*                       instead of just checking it is a rehab visit          *
.* V10.03.18  04/12/2013 Patrick Adair                              CAR 294211 *
.*                       Added new errors R104, R112 and R118                  *
.*                       Patrick Adair                              CAR 289797 *
.*                       Amended reason for delay in discharge extract values  *
.* V10.03.17  03/12/2013 Sandra Barcham                             CAR 294744 *
.*                       Fixing the Discharge FIM score for Expression         *
.* V10.03.16  30/11/2013 Ania P                                     CAR 289117 *
.*                       Changed mapping of incorrect claim code 6 to 5 and    *
.*                       added new mapping for claim code 6                    *
.* V10.03.15  27/11/2013 Ebon Clements                              CAR 294212 *
.*                       Added from date range - STRTDATE                      *
.* V10.03.14  14/11/2013 Patrick Adair                              CAR 292258 *
.*                       Include same day suspension in total no of days       *
.* V10.03.13  05/09/2013 Jill Parkinson CAR 287851                             *
.*                       Added map of 99.9 to 9999 for XXXXDTUG                *
.* V10.03.12  03/09/2013 Jill Parkinson CAR 291075                             *
.*                       Added check for ASTAT<>3 to ignore incomplete visits  *
.* V10.03.11  04/03/2013 Patrick Adair                              Car 281879 *
.*                       Corrected AROC Audit Errors                           *
.* V10.03.10  27/02/2013 Patrick Adair                       CAR 281879/281925 *
.*                       Final requirements from AROC feedback - at last!      *
.* V10.03.09  19/12/2012 Patrick Adair                              CAR 261630 *
.*                       Removed port number from temp file name               *
.* V10.03.08  30/10/2012 Patrick Adair                              Car 274594 *
.*                       Removed Error messages if no visit is found           *
.* V10.03.07  29/10/2012 Patrick Adair                              Car 275452 *
.*                       Changes Raised by Cabrini/Healthscope testing         *
.* V10.03.06  11/10/2012 Patrick Adair                              Car 273294 *
.*                       Change Health Fund Extract Processing - XXAFUNDH      *
.* V10.03.05  09/10/2012 Patrick Adair                              Car 274255 *
.*                       Amended discharge Fim processing                      *
.* V10.03.04  27/09/2012 Patrick Adair                              Car 273298 *
.*                       Changed state code to full two characters             *
.* V10.03.03  20/09/2012 Patrick Adair                              Car 273295 *
.*                       extract indicator 2 for Employment status after       *
.* V10.03.02  19/09/2012 Peter McMullen                             Car 273296 *
.*                       correct spinal injury data elements                   *
.* V10.03.01  12/09/2012 Patrick Adair                              Car 272760 *
.*                       correct extract to use pmugendd not pmugedat for      *
.*                       episode end date                                      *
.* V10.03.00  17/05/2012 Patrick Adair                       CAR 257776/265836 *
.*                       Created Extract                                       *
.*******************************************************************************
.
          INC       STD001FD                     * Standard Include
.
          INC       IBACONFD/INC                 * Control File
          INC       IBASEQFD/INC                 * Sequential Numbers File
          INC       PATCODFD/INC                 * Category Codes
          INC       PATCONFD/INC                 * Control File
          INC       PATFIMFD/INC                 * FIM Scores File
          INC       PATFN1FD/INC                 * Health Fund File
          INC       PATHSPFD/INC                 * Hospital File
          INC       PATIN1FD/INC                 * Insurance Details File
          INC       PATMA1FD/INC                 * Patient Master File
          INC       PATMI1FD/INC                 * Patient Admission File
          INC       PATTRNFD/INC                 * Patient Transfer File
          INC       PATVISFD/INC                 * Patient Visit File
          INC       PATWC1FD/INC                 * Workers Compensation Claims
          INC       PATWMAFD/INC                 * Motor Accident Board Claims
          INC       PATWR1FD/INC                 * Patient Ward/Bed File
          INC       PMSAPGFD/INC                 * Program Details Ext File
          INC       PMSPX2FD/INC                 * PMI Extension File
          INC       PMSPITFD/INC                 * Program Interruption File
          INC       PMSUPGFD/INC                 * Program Details File
          INC       PMSVX1FD/INC                 * Patient Visit Ext File
          INC       WEBSECFD/INC                 * Web Security File
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
.
.*------------------------------------------------------------------------------
.
EXTRFILE  FILE      ASCII, FIXED=707                                * Car 275452
.
.Name     Type    Length    Start  Description
.----     ----    ------    -----  -----------
XXXXPATH  DIM     1         1      Hardcoded "3"
XXXXAPPR  DIM     10        2      Establishment Identifier
XXXXNAME  DIM     40        12     Establishment Name
XXXTWARD  DIM     10        52     Ward Identifier
XXWBDESC  DIM     40        62     Ward Name
XXXPURNO  DIM     12        102    Person Identifier
XXXLOFNM  DIM     5         114    Letters of Name
XXPBDATE  DIM     10        119    Date of Birth
XXDOBEST  DIM     1         129    Date of Birth Estimate Flag
XXXXPSEX  DIM     1         130    Sex
XXXXABRG  DIM     1         131    Indigenous Status                     (Cat VA)
XXXXETHN  DIM     2         132    Ethnicity                   (NR for Australia)
XXXPADD4  DIM     2         134    State                        (program mapping)
XXXPPOST  DIM     4         136    Postcode
XXACLAIM  DIM     2         140    Funding Source For Hospital Patients  (Cat CL)
XXAFUNDH  DIM     3         142    Health Fund/Payer
XXXXINTR  DIM     1         145    Interpreter Required
XXXXRFDT  DIM     10        146    Referral Date
XXXXDART  DIM     10        156    Date Assessed by Referral team
XXXXDCRC  DIM     10        166    Date Clinically ready for Rehab Care
XXXESDLY  DIM     1         176    Was there a Delay in Episode Start?
XXXESTPR  DIM     1         177    Delay in Epsiode Start - Patient related
XXXESTSI  DIM     1         178    Delay in Epsiode Start - service Issue
XXXESTES  DIM     1         179    Delay in Epsiode Start - External Support
XXXESTEI  DIM     1         180    Delay in Epsiode Start - Equipment Issue
XXXESTBI  DIM     1         181    Delay in Epsiode Start - Behavioural Issue
XXXXSDAT  DIM     10        182    Episode Begin Date
XXXXACPA  DIM     1         192    Accommodation Prior To Admission      (Cat py)
XXXXLSPA  DIM     1         193    Carer Status Prior to this Impairment (Cat ar)
XXXXSRPI  DIM     1         194    Were any services received prior to this
.                                        impairment
XXXXSRPD  DIM     1         195    Service Received Prior - Domestic
XXXXSRPS  DIM     1         196    Service Received Prior - Social
XXXXSRPN  DIM     1         197    Service Received Prior - Nursing
XXXXSRPA  DIM     1         198    Service Received Prior - Allied Health Care
XXXXSRPP  DIM     1         199    Service Received Prior - Personal Care
XXXXSRPM  DIM     1         200    Service Received Prior - Meals
XXXXSRPG  DIM     1         201    Service Received Prior - Prov of goods/equip
XXXXSRPT  DIM     1         202    Service Received Prior - Transport Service
XXXXSRPC  DIM     1         203    Service Received Prior - Case Management
XXXXEMST  DIM     1         204    Employment Status Prior               (cat KD)
XXXXFADM  DIM     1         205    First Admission For This Impairment
XXXXRPDT  DIM     10        206    Date Multi-Disciplinary Rehab Plan Establshd
XXXXDADM  DIM     10        216    Date of relevant acute admission
XXXXTOCC  DIM     1         226    Time Since Onset                      (Cat tq)
XXXXDRAE  DIM     10        227    Date of Relevant Acute Episode
XXXXMEST  DIM     1         237    Mode Of Episode Start                 (Cat px)
XXXXAMBS  DIM     10        238    Ambulatory Services          (NR by Hospitals)
XXXXICDE  DIM     7         248    Impairment Code
XXXAMBF1  DIM     2         255    Ambulatory Fields               (Not required)
XXXAFMDT  DIM     10        257    Date Admission FIM Assessed
XXXAEATS  DIM     1         267    Admission FIM Eating Score
XXXAGRMS  DIM     1         268    Admission FIM Grooming Score
XXXABTHS  DIM     1         269    Admission FIM Bathing Score
XXXAUPBS  DIM     1         270    Admission FIM Dressing Upper Body Score
XXXALWBS  DIM     1         271    Admission FIM Dressing Lower Body Score
XXXATLTS  DIM     1         272    Admission FIM Toileting Score
XXXABLMS  DIM     1         273    Admission FIM Bladder Management Score
XXXABWMS  DIM     1         274    Admission FIM Bowel Management Score
XXXATBDS  DIM     1         275    Admission FIM Xfers - Bed/Chr/WChr Score
XXXATTLS  DIM     1         276    Admission FIM Xfers - Toilet Score
XXXATBTS  DIM     1         277    Admission FIM Xfers - Bath/Shower Score
XXXALOCS  DIM     1         278    Admission FIM Locomotion Score
XXXASTRS  DIM     1         279    Admission FIM Stairs Score
XXXACOMS  DIM     1         280    Admission FIM Comprehension Score
XXXAEXPS  DIM     1         281    Admission FIM Expression Score
XXXASCIS  DIM     1         282    Admission FIM Social Interaction Score
XXXAPRBS  DIM     1         283    Admission FIM Problem Solving Score
XXXAMEMS  DIM     1         284    Admission FIM Memory Score
XXXAMBF2  DIM     18        285    Ambulatory Fields (not required)
XXXXEMSA  DIM     1         303    Employment Status after Discharge
XXXDFMDT  DIM     10        304    Date Discharge FIM Assessed
XXXDEATS  DIM     1         314    Discharge FIM Eating Score
XXXDGRMS  DIM     1         315    Discharge FIM Grooming Score
XXXDBTHS  DIM     1         316    Discharge FIM Bathing Score
XXXDUPBS  DIM     1         317    Discharge FIM Dressing Upper Body Score
XXXDLWBS  DIM     1         318    Discharge FIM Dressing Lower Body Score
XXXDTLTS  DIM     1         319    Discharge FIM Toileting Score
XXXDBLMS  DIM     1         320    Discharge FIM Bladder Management Score
XXXDBWMS  DIM     1         321    Discharge FIM Bowel Management Score
XXXDTBDS  DIM     1         322    Discharge FIM Xfers - Bed/Chr/WChr Score
XXXDTTLS  DIM     1         323    Discharge FIM Xfers - Toilet Score
XXXDTBTS  DIM     1         324    Discharge FIM Xfers - Bath/Shower Score
XXXDLOCS  DIM     1         325    Discharge FIM Locomotion Score
XXXDSTRS  DIM     1         326    Discharge FIM Stairs Score
XXXDCOMS  DIM     1         327    Discharge FIM Comprehension Score
XXXDEXPS  DIM     1         328    Discharge FIM Expression Score
XXXDSCIS  DIM     1         329    Discharge FIM Social Interaction Score
XXXDPRBS  DIM     1         330    Discharge FIM Problem Solving Score
XXXDMEMS  DIM     1         331    Discharge FIM Memory Score
XXXAMBF3  DIM     18        332    Ambulatory Fields               (not Required)
XXXXDCRD  DIM     10        350    Date Clinically Ready for Discharge
XXXXDDLY  DIM     1         360    Was there a delay in discharge
XXXDEDPR  DIM     1         361    Delay in Episode Discharge - Patient related
XXXDEDSI  DIM     1         362    Delay in Episode Discharge - Service Issue
XXXDEDES  DIM     1         363    Delay in Episode Discharge - External Support
XXXDEDEI  DIM     1         364    Delay in Episode Discharge - Equipment Issue
XXXDEDBI  DIM     1         365    Delay in Episode Discharge - Behavioural Issue
XXXXEMOR  DIM     1         366    Existing Co-Morbidity
XXXXCMR1  DIM     2         367    Co-Morbidity 1                        (Cat m1)
XXXXCMR2  DIM     2         369    Co-Morbidity 2                        (Cat m1)
XXXXCMR3  DIM     2         371    Co-Morbidity 3                        (Cat m1)
XXXXCMR4  DIM     2         373    Co-Morbidity 4                        (Cat m1)
XXXXCIRH  DIM     1         375    Complication Interfering with Rehab
XXXXCMP1  DIM     2         376    Complication 1                        (Cat m2)
XXXXCMP2  DIM     2         378    Complication 2                        (Cat m2)
XXXXCMP3  DIM     2         380    Complication 3                        (Cat m2)
XXXXCMP4  DIM     2         382    Complication 4                        (Cat m2)
XXXXENDD  DIM     10        384    Episode End Date
XXXXMEEN  DIM     1         394    Mode Of Episode End                   (Cat pw)
XXXXIDES  DIM     1         395    Interim Destination                   (Cat py)
XXXXACPD  DIM     1         396    Accommodation Post Discharge          (Cat pz)
XXXXLSPD  DIM     1         397    Carer Status Post Discharge           (Cat as)
XXXAMBF4  DIM     26        398    Ambulatory Fields               (not Required)
XXXXTLDS  DIM     3         424    Total Leave Days
XXXXTRSD  DIM     3         427    Total Rehab Treatment Suspension Days
XXXXTRSO  DIM     3         430    Total Rehab Treatment Suspension Occurs
XXXSRPDS  DIM     1         433    Will any Services be received Post Discharge
XXXXSRAD  DIM     1         434    Service Received Post - Domestic Assistance
XXXXSRAS  DIM     1         435    Service Received Post - Social
XXXXSRAN  DIM     1         436    Service Received Post - Nursing
XXXXSRAA  DIM     1         437    Service Received Post - Allied Health Care
XXXXSRAP  DIM     1         438    Service Received Post - Personal Care
XXXXSRAM  DIM     1         439    Service Received Post - Meals
XXXXSRAG  DIM     1         440    Service Received Post - Prov of goods/equi
XXXXSRAT  DIM     1         441    Service Received Post - Transport Services
XXXXSRAC  DIM     1         442    Service Received Post - Case Management
XXXXRDDT  DIM     1         443    Discharge Plan Available to Patient
XXXXDEFP  DIM     10        444    Date Emerged from PTA
XXXXCAMN  DIM     1         454    Chronic Amnesiac
XXXXESAS  DIM     1         455    Episode Start ASIA Score A,B,C or D   (Cat ra)
XXXXESSC  DIM     2         456    Episode Start Level of Spinal Chord   (Cat rb)
XXXXEESC  DIM     2         458    Episode End Level of Spinal Chord I   (Cat rb)
XXXXVDEE  DIM     1         460    Ventilator Dependant at Episode End
XXXXEEAS  DIM     1         461    Episode End ASIA Score                (Cat ra)
XXXXDRCA  DIM     10        462    Date Ready For Casting
XXXXPACS  DIM     1         472    Phase of Amputee Care at Episode St
XXXXDWPC  DIM     1         473    Delayed Wound Phase of Care during
XXXXPPPC  DIM     1         474    Pre Prosthetic Phase of Care during
XXXXAPPC  DIM     1         475    Prosthetic Phase of Care during Episode
XXXXPACE  DIM     1         476    Phase of Amputee Care at Episode End
XXXXPROS  DIM     1         477    Prosthetic
XXXXDFPF  DIM     10        478    Date First Prosthetic Fitting
XXXXRDIF  DIM     1         488    Reason for Delay in Fitting           (Cat re)
XXXXDTUG  DIM     4         489    Discharge Timed Up and Go
XXXXD06M  DIM     5         493    Discharge 6 Minute walk test
XXXXD10M  DIM     4         498    Discharge 10 Metre Walk
XXXXFRAI  DIM     1         502    Fraility (pre-morbid)                 (Cat rg)
XXXXPITD  DIM     1         503    Participation in Therapy from Day 1
XXXXF12M  DIM     1         504    Fallen last 12 Months
XXXXWL12  DIM     1         505    Weight Loss >10% in last 12 Months
.                                                                   * Car 275452
XXXXCMNT  DIM     200       506    Comment                             (optional)
.
. End of Record             707
.
. ----- Program Variables ------------------------------------------------------
.
CALCDAYS  FORM      4                            * Rehab Suspension Days
CARECATG  DIM       2                            * category for care type
CLAIMTYP  DIM       2                            * claim code type
.                                                  02 = private
.                                                  03 = Workers Comp
.                                                  04 = Insurance Groups
CMDLINE   DIM       127                          * Command Line
DCRCDATE  DIM       8                            * Date clincally ready for rehab
EENDDATE  DIM       8                            * Input Extract End Date
FILENAME  DIM       8                            * Extract Text File Name
FIMADMOK  DIM       1                            * Adm FIM record indic
FIMDSCOK  DIM       1                            * Dsc FIM record indic
FROMDATE  DATE      8                            * Date Calculation From
HOSPAPPR  DIM       10                           * Hospital Approval Number
HOSPCODE  DIM       3                            * Hospital Code
HOSPNAME  DIM       40                           * Hospital Name
ICOMMNT1  DIM       50                           * Optional Input Comment 1
ICOMMNT2  DIM       50                           * Optional Input Comment 2
ICOMMNT3  DIM       50                           * Optional Input Comment 3
ICOMMNT4  DIM       50                           * Optional Input Comment 4
ICOMMENT  DIM       200                          * Optional Input Comment Concat
INTRPTOK  DIM       1                            * Program Int Record Indic
LOFSURNM  DIM       3                            * Letters of Name Surname
LOFFSTNM  DIM       2                            * Letters of Given Names
LONWRKNM  DIM       20                           * Letters of name Work Field
LONCNTR   FORM      1                            * Letters of Name Counter
PRTODATE  DIM       10                           * Extract End Date
PRSTDATE  DIM       10                           * Extract Start Date
SAVEVIST  DIM       8                            * Save Visit Record Key
STRTDATE  DIM       8                            * Input Extract Start Date
TODATE    DATE      8                            * Date Calculation To
TOTALLDS  FORM      4                            * Total Leave Days
TOTALREC  FORM      8                            * Total Records Extracted
TOTALSDS  FORM      4                            * Total Rehab Susp Days
TOTALSOC  FORM      4                            * Total Rehab Susp Occur
TOTALVIS  FORM      3                            * Total Visit Records Read
URNUMBER  DIM       8                            * UR Number
VISITOK   DIM       1                            * Visit Record Indic
WEBUSRID  DIM       10                           * Input User ID
.
. ----- Program Constants ------------------------------------------------------
.
CATA      INIT      "A "
CATAR     INIT      "ar"
CATAS     INIT      "as"
CATCC     INIT      "CC"
CATCL     INIT      "CL"
CATKD     INIT      "KD"
CATM1     INIT      "m1"
CATM2     INIT      "m2"
CATPW     INIT      "pw"
CATPX     INIT      "px"
CATPY     INIT      "py"
CATPZ     INIT      "pz"
CATRA     INIT      "ra"
CATRB     INIT      "rb"
CATRD     INIT      "rd"
CATRE     INIT      "re"
CATRG     INIT      "rg"
CATRZ     INIT      "RZ"
CATTQ     INIT      "tq"
CATVA     INIT      "VA"
FOURZERO  INIT      "0000"
ONEINIT   INIT      "1"
TWOINIT   INIT      "2"
THREEINT  INIT      "3"
.
PRGID     INIT      "IBAPMS96"
PRGNAM    INIT      "AROC Inpatient Clinical Data Set Extract"
VERSION   INIT      "V12.01.00"
.
.*******************************************************************************
.*                                  MAIN0000                                   *
.*                               Main Function                                 *
.*******************************************************************************
.
MAIN0000  CALL      INIT0000                     * Initialise
.
MAIN1000  CALL      GOPT0000                     * Choose exec option
          BRANCH    OPTION,MAIN2000
          BRANCH    EXIT,MAIN9999
.
MAIN2000  IF        IBCNMHOS=1
            CALL      GHOS0000                   * Get Multi Hospital Id
            BRANCH    EXIT,MAIN1000
          ELSE
            PACK       HOSPAPPR,CAPPRVNO,SP70    * Hospital Approval Number
            PACK       HOSPNAME,CONAME,SP70      * Hospital Name
          ENDIF
.
          CALL      GDAT0000                     * Get Extract End Date
          BRANCH    EXIT,MAIN1000
.
          CALL      GUSR0000                     * Get Web User Id
          BRANCH    EXIT,MAIN1000
.                                                * Get Optional Comment1
          KEYIN     *P1:17,*EL,"Comment 1    : ",*V2LON,ICOMMNT1
          STRIP     ICOMMNT1
.                                                * Get Optional Comment1
          KEYIN     *P1:18,*EL,"Comment 2    : ",*V2LON,ICOMMNT2
          STRIP     ICOMMNT2
.                                                * Get Optional Comment1
          KEYIN     *P1:19,*EL,"Comment 3    : ",*V2LON,ICOMMNT3
          STRIP     ICOMMNT3
.                                                * Get Optional Comment1
          KEYIN     *P1:20,*EL,"Comment 4    : ",*V2LON,ICOMMNT4
          STRIP     ICOMMNT4
.
          PACK      ICOMMENT,ICOMMNT1,ICOMMNT2,ICOMMNT3,ICOMMNT4:
                            SP70,SP30,SP70,SP30
.
          CALL      CONTQST                      * Ok to Continue (Y/N/C)?
          BRANCH    CEXIT,MAIN4000,MAIN2000,MAIN1000
.
MAIN4000  CALL      TFILENAM                     * Generate temporary file name
          MOVE      TFILNAME,FILENAME
.
          CLOSE     EXTRFILE,DELETE              * Create Extract Text File
          PREP      EXTRFILE,FILENAME
.
          CALL      PROC0000                     * Process Extract
.
.                                                * Print Extract Total
          IF        TOTALREC = 0
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS    * Line count >= 60
            PRINT     "Warning : No Records Extracted for this report",*N
            PRINT     *N,*40,"*** End of Report ***"
            GOTO      MAIN8000
          ELSE
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS    * Line count >= 60
            PRINT     *20,"Total Records Extracted : ",TOTALREC
            CALL      UND132
            PRINT     *N,*40,"*** End of Report ***"
          ENDIF
.
          CALL      MVEX0000                     * Move Extract to Web Dir
.
MAIN8000  CLOSE     EXTRFILE,DELETE              * Create Extract Text File
          GOTO      MAIN1000
.
MAIN9999  CHAIN     PGM
.
.*******************************************************************************
.*                                  INIT0000               Called by: MAIN0000 *
.*                                                                             *
.* Initialise Variables and  Open all Files                                    *
.*******************************************************************************
INIT0000  CALL      DISPHEAD                     * Display screen heading
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"patfimaf";
          OPEN      PATFIMA1,"patfimaf"
.
          DISPLAY   *P64:24,"patfn1af";
          OPEN      PATFN1A1,"patfn1af"
.
          DISPLAY   *P64:24,"patin1af";
          OPEN      PATIN1A1,"patin1af"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patwc1af";
          OPEN      PATWC1A1,"patwc1af"
.
          DISPLAY   *P64:24,"patwmabf";
          OPEN      PATWMAB1,"patwmabf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"pmsapgaf";
          OPEN      PMSAPGA1,"pmsapgaf"
.
          DISPLAY   *P64:24,"pmspitaf";
          OPEN      PMSPITA1,"pmspitaf"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"pmsupgaf";
          OPEN      PMSUPGA1,"pmsupgaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"websecaf";
          OPEN      WEBSECA1,"websecaf"
.
          DISPLAY   *P56:24,"Opening controlf"
          OPEN      CONTROLF,"controlf"
.                                                * 1 = Multi Hospital
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.                                                * Hospital Approval Number
          READ      CONTROLF,TEN;*79,CAPPRVNO
.                                                * Hospital Name
          READ      CONTROLF,TWO;*4,CONAME
.
          CALL      IBACLOCK
.
          MOVE      "60",CLNO                    * Force Header Print
.
INIT9000  MOVE      ZERO,EXIT
.
INIT9999  RETURN
.
.*******************************************************************************
.*                                  GOPT0000               Called by: MAIN0000 *
.*                                                                             *
.* Select Option - Run or Exit                                                 *
.*******************************************************************************
GOPT0000  MOVE      ZERO,EXIT
          MOVE      ZERO,OPTION
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Run":
                    *P1:8,"Select Option : ";
GOPT1000  KEYIN     *P17:8,*V2LON,*DV,UNDLN2,*P17:8,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      GOPT9800 IF EQUAL
.
          BRANCH    OPTION,GOPT9000
.
          BEEP
          GOTO      GOPT1000
.
GOPT9000  MOVE      ZERO,EXIT
          GOTO      GOPT9999
.
GOPT9800  MOVE      ONE,EXIT
.
GOPT9999  RETURN
.
.*******************************************************************************
.*                                  GHOS0000               Called by: MAIN0000 *
.*                                                                             *
.* Get Hospital Id                                                             *
.*******************************************************************************
GHOS0000  MOVE      ZERO,EXIT
.
          MOVE      SP70,HOSPCODE
          MOVE      SP70,PTHSHOSP
          DISPLAY   *P1:10,*EL,"Hospital Id  : ";
          MOVE      TEN6,ECOL
          MOVE      TEN,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ONE,CKYIMAND                 * Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,GHOS98000,GHOS98000
.
          PACK      HOSPCODE,KEY3,SP70           * Hospital Code
          PACK      HOSPAPPR,PTHSAPPR,SP70       * Hospital Approval Number
          PACK      HOSPNAME,PTHSNAME,SP70       * Hospital Name
.
GHOS3000  DISPLAY   *P20:10,*V2LON,PTHSNAME;
          MOVE      ZERO,EXIT
          GOTO      GHOS9999
.
GHOS98000  MOVE     ONE,EXIT
.
GHOS9999  RETURN
.
.*******************************************************************************
.*                                  GDAT0000               Called by: MAIN0000 *
.*                                                                             *
.* Get Extract End Date                                                        *
.*******************************************************************************
GDAT0000  DISPLAY   *P1:12,*EL,"Extract From Date : ";
          DISPLAY   *P1:13,*EL,"Extract To Date   : ";
.
          MOVE      ZERO,CDEFDTE
          MOVE      ZERO,CHIGHLT
          MOVE      TWENTY1,CCOL
          MOVE      TEN2,CVERT
.
          UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          CALL      KEYDATE
          BRANCH    OVRCD,GDAT9800
.
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
.
          MOVE      ZERO,CDEFDTE
          MOVE      ZERO,CHIGHLT
          MOVE      TWENTY1,CCOL
          MOVE      TEN3,CVERT
.
          UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          CALL      KEYDATE
          BRANCH    OVRCD,GDAT0000
.
          PACK      EENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",EENDDATE
.
          MATCH      STRTDATE,EENDDATE
          GOTO       GDAT8000 IF NOT LESS
.
          DISPLAY    *P1:24,*EL,*B,"To Date Must Be Greater Than From Date ";
          CALL       HITENTER
          GOTO       GDAT0000

GDAT8000  MOVE      ZERO,EXIT
          GOTO      GDAT9999
.
GDAT9800  MOVE      ONE,EXIT
.
GDAT9999  RETURN
.
.*******************************************************************************
.*                                  GUSR0000               Called by: MAIN0000 *
.*                                                                             *
.* Get Web User Id                                                             *
.*******************************************************************************
GUSR0000  MOVE      SP70,WEBUSRID
          KEYIN     *P1:15,*EF,"Web User Id  : ",*V2LON,WEBUSRID
.
          PACK      WEBUSRID,WEBUSRID,SP70
          MATCH     SP70,WEBUSRID
          GOTO      GUSR9100 IF EQUAL
.
          PACK      KEY10,WEBUSRID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,GUSR9100
.
          MOVE      ZERO,EXIT
          GOTO      GUSR9999
.
GUSR9100  MOVE      ONE,EXIT
.
GUSR9999  RETURN
.
.*******************************************************************************
.*                                  HEAD0000               Called by: various  *
.*                                                                             *
.* Print a New Page                                                            *
.*******************************************************************************
HEAD0000  CALL      HEAD132                      * Standard heading
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRSTDATE
.
          UNPACK    EENDDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRTODATE
.
          PRINT     *40,"Hospital : ",HOSPNAME
.
          PRINT     *N,*40,"Extract Date Range : ",PRSTDATE," to ",PRTODATE
.
          PRINT     *N,*40,"User Id : ",WEBUSRID
.
          CALL      UND132
.
          ADD       FIVE,CLNO
.
HEAD9999  RETURN
.
.*******************************************************************************
.*                                  PROC0000               Called by: MAIN0000 *
.*                                                                             *
.* Process the Program Extract                                                 *
.*******************************************************************************
PROC0000  MOVE      ZERO,TOTALREC
.
          READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            MOVE      CATA,CARECATG
          ELSE
            MOVE      CATCC,CARECATG
          ENDIF
.
          PACK      KEY31,SP70
          CALL      RSPMUPG1
PROC1000  CALL      RKPMUPG1
          BRANCH    OVRCD,PROC9999
.
          MATCH     SP70,PMUGENDD
          GOTO      PROC1000 IF LESS
.
          MATCH     STRTDATE,PMUGENDD            * Extract Start Date
          GOTO      PROC1000 IF LESS
.
          MATCH     PMUGENDD,EENDDATE            * Extract End Date
          GOTO      PROC1000 IF LESS
.
          CALL      CLRV0000                     * Clear Extract and Work Fields
.
          CALL      EXTR0000                     * Setup EXTR Extract Fields
.
          IF        TOTALVIS > 0
            CALL      WRIT0000                   * Write to extract file
          ENDIF
.
          GOTO      PROC1000                     * loop all Program records
.
PROC9999  RETURN
.
.*******************************************************************************
.*                                  MVEX0000               Called by: MAIN0000 *
.*                                                                             *
.* Move The Extract text File to the Web Directory                             *
.*******************************************************************************
MVEX0000  PACK      KEY3,HOSPCODE,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            CALL      CLPATHSP
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    "ibapms96.us1 '",CMDLINE
          APPEND    FILENAME,CMDLINE             * Report text file
.
          APPEND    "' '",CMDLINE
          STRIP     PTHSNAME
          REP       " _",PTHSNAME
          APPEND    PTHSNAME,CMDLINE             * Hospital Id
.
          APPEND    "' '",CMDLINE
          UNPACK    EENDDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRTODATE

          APPEND    PRTODATE,CMDLINE             * Extract End Date
.
          APPEND    "' '",CMDLINE
          APPEND    WEBUSRID,CMDLINE             * User Id
.
          APPEND    "'",CMDLINE
.
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
.
MVEX9999  RETURN
.
.*******************************************************************************
.*                                  CLRV0000               Called by: PROC0000 *
.*                                                                             *
.* Clear the Extract File Variables                                            *
.* Clear the Extract Variables                                                 *
.*******************************************************************************
CLRV0000  MOVE      SP70,XXXXAPPR
          MOVE      SP70,XXXXNAME
          MOVE      SP70,XXXTWARD
          MOVE      SP70,XXWBDESC
          MOVE      SP70,XXXPURNO
          MOVE      SP70,XXXLOFNM
          MOVE      SP70,XXPBDATE
          MOVE      SP70,XXXXPSEX
          MOVE      SP70,XXXXABRG
          MOVE      SP70,XXXXETHN
          MOVE      SP70,XXXPADD4
          MOVE      SP70,XXXPPOST
          MOVE      SP70,XXACLAIM
          MOVE      SP70,XXAFUNDH
          MOVE      SP70,XXXXRFDT
          MOVE      SP70,XXXXDART
          MOVE      SP70,XXXXDCRC
          MOVE      SP70,XXXESTPR
          MOVE      SP70,XXXESTSI
          MOVE      SP70,XXXESTES
          MOVE      SP70,XXXESTEI
          MOVE      SP70,XXXESTBI
          MOVE      SP70,XXXXSDAT
          MOVE      SP70,XXXXACPA
          MOVE      SP70,XXXXEMST
          MOVE      SP70,XXXXRPDT
          MOVE      SP70,XXXXDADM
          MOVE      SP70,XXXXTOCC
          MOVE      SP70,XXXXDRAE
          MOVE      SP70,XXXXMEST
          MOVE      SP70,XXXXAMBS
          MOVE      SP70,XXXXICDE
          MOVE      SP70,XXXAMBF1
          MOVE      SP70,XXXAFMDT
          MOVE      SP70,XXXAEATS
          MOVE      SP70,XXXAGRMS
          MOVE      SP70,XXXABTHS
          MOVE      SP70,XXXAUPBS
          MOVE      SP70,XXXALWBS
          MOVE      SP70,XXXATLTS
          MOVE      SP70,XXXABLMS
          MOVE      SP70,XXXABWMS
          MOVE      SP70,XXXATBDS
          MOVE      SP70,XXXATTLS
          MOVE      SP70,XXXATBTS
          MOVE      SP70,XXXALOCS
          MOVE      SP70,XXXASTRS
          MOVE      SP70,XXXACOMS
          MOVE      SP70,XXXAEXPS
          MOVE      SP70,XXXASCIS
          MOVE      SP70,XXXAPRBS
          MOVE      SP70,XXXAMEMS
          MOVE      SP70,XXXAMBF2
          MOVE      SP70,XXXXEMSA
          MOVE      SP70,XXXDFMDT
          MOVE      SP70,XXXDEATS
          MOVE      SP70,XXXDGRMS
          MOVE      SP70,XXXDBTHS
          MOVE      SP70,XXXDUPBS
          MOVE      SP70,XXXDLWBS
          MOVE      SP70,XXXDTLTS
          MOVE      SP70,XXXDBLMS
          MOVE      SP70,XXXDBWMS
          MOVE      SP70,XXXDTBDS
          MOVE      SP70,XXXDTTLS
          MOVE      SP70,XXXDTBTS
          MOVE      SP70,XXXDLOCS
          MOVE      SP70,XXXDSTRS
          MOVE      SP70,XXXDCOMS
          MOVE      SP70,XXXDEXPS
          MOVE      SP70,XXXDSCIS
          MOVE      SP70,XXXDPRBS
          MOVE      SP70,XXXDMEMS
          MOVE      SP70,XXXAMBF3
          MOVE      SP70,XXXXDCRD
          MOVE      SP70,XXXDEDPR
          MOVE      SP70,XXXDEDSI
          MOVE      SP70,XXXDEDES
          MOVE      SP70,XXXDEDEI
          MOVE      SP70,XXXDEDBI
          MOVE      SP70,XXXXCMR1
          MOVE      SP70,XXXXCMR2
          MOVE      SP70,XXXXCMR3
          MOVE      SP70,XXXXCMR4
          MOVE      SP70,XXXXCMP1
          MOVE      SP70,XXXXCMP2
          MOVE      SP70,XXXXCMP3
          MOVE      SP70,XXXXCMP4
          MOVE      SP70,XXXXENDD
          MOVE      SP70,XXXXMEEN
          MOVE      SP70,XXXXIDES
          MOVE      SP70,XXXXACPD
          MOVE      SP70,XXXXLSPD
          MOVE      SP70,XXXAMBF4
          MOVE      SP70,XXXXTLDS
          MOVE      SP70,XXXXDEFP
          MOVE      SP70,XXXXCAMN
          MOVE      SP70,XXXXESAS
          MOVE      SP70,XXXXESSC
          MOVE      SP70,XXXXEESC
          MOVE      SP70,XXXXEEAS
          MOVE      SP70,XXXXDRCA
          MOVE      SP70,XXXXPACS
          MOVE      SP70,XXXXPACE
          MOVE      SP70,XXXXDFPF
          MOVE      SP70,XXXXRDIF
          MOVE      SP70,XXXXDTUG
          MOVE      SP70,XXXXD06M
          MOVE      SP70,XXXXD10M
          MOVE      SP70,XXXXFRAI
          MOVE      SP70,XXXXCMNT
.
          MOVE      THREEINT,XXXXPATH            * Hard Coded 3
.                                             * Default Extract Fields to 2 (No)
          MOVE      TWOINIT,XXDOBEST
          MOVE      TWOINIT,XXXXINTR
          MOVE      TWOINIT,XXXXLSPA
          MOVE      TWOINIT,XXXXDWPC
          MOVE      TWOINIT,XXXXPPPC
          MOVE      TWOINIT,XXXXAPPC
          MOVE      TWOINIT,XXXXPROS
          MOVE      TWOINIT,XXXXFADM
          MOVE      TWOINIT,XXXXEMOR
          MOVE      TWOINIT,XXXXCIRH
          MOVE      TWOINIT,XXXXSRPI
          MOVE      TWOINIT,XXXXRDDT
.                                                             * Start Car 275452
          MOVE      TWOINIT,XXXXF12M
          MOVE      TWOINIT,XXXXPITD
          MOVE      TWOINIT,XXXSRPDS
          MOVE      TWOINIT,XXXXSRAA
          MOVE      TWOINIT,XXXXSRAC
          MOVE      TWOINIT,XXXXSRAD
          MOVE      TWOINIT,XXXXSRAG
          MOVE      TWOINIT,XXXXSRAS
          MOVE      TWOINIT,XXXXSRAN
          MOVE      TWOINIT,XXXXSRAP
          MOVE      TWOINIT,XXXXSRAM
          MOVE      TWOINIT,XXXXSRAT
          MOVE      TWOINIT,XXXXSRPD
          MOVE      TWOINIT,XXXXSRPS
          MOVE      TWOINIT,XXXXSRPN
          MOVE      TWOINIT,XXXXSRPA
          MOVE      TWOINIT,XXXXSRPP
          MOVE      TWOINIT,XXXXSRPM
          MOVE      TWOINIT,XXXXSRPG
          MOVE      TWOINIT,XXXXSRPT
          MOVE      TWOINIT,XXXXSRPC
          MOVE      TWOINIT,XXXXVDEE
          MOVE      TWOINIT,XXXXWL12
          MOVE      TWOINIT,XXXESDLY
          MOVE      TWOINIT,XXXXDDLY
.                                                             *   End Car 275452
          MOVE      SP70,SAVEVIST                * Save Visit Record Key
          MOVE      ZERO,TOTALLDS                * Total Leave Days
          MOVE      ZERO,TOTALSDS                * Total Rehab Susp Days
          MOVE      ZERO,TOTALSOC                * Total Rehab Susp Occur
          MOVE      ZERO,TOTALVIS                * Total Visits read
          MOVE      ZERO,VISITOK                 * Visit Record Indic
          MOVE      "0  ",XXXXTRSD
          MOVE      "0  ",XXXXTRSO
.
CLRV9999  RETURN
.
.*******************************************************************************
.*                                  WRIT0000               Called by: PROC0000 *
.*                                                                             *
.* Write the Extract Record                                                    *
.*******************************************************************************
WRIT0000  WRITE     EXTRFILE,SEQ;XXXXPATH,XXXXAPPR,XXXXNAME,XXXTWARD,XXWBDESC:
                                 XXXPURNO,XXXLOFNM,XXPBDATE,XXDOBEST,XXXXPSEX:
                                 XXXXABRG,XXXXETHN,XXXPADD4,XXXPPOST,XXACLAIM:
                                 XXAFUNDH,XXXXINTR,XXXXRFDT,XXXXDART,XXXXDCRC:
                                 XXXESDLY,XXXESTPR,XXXESTSI,XXXESTES,XXXESTEI:
                                 XXXESTBI,XXXXSDAT,XXXXACPA,XXXXLSPA,XXXXSRPI:
                                 XXXXSRPD,XXXXSRPS,XXXXSRPN,XXXXSRPA,XXXXSRPP:
                                 XXXXSRPM,XXXXSRPG,XXXXSRPT,XXXXSRPC,XXXXEMST:
                                 XXXXFADM,XXXXRPDT,XXXXDADM,XXXXTOCC,XXXXDRAE:
                                 XXXXMEST,XXXXAMBS,XXXXICDE,XXXAMBF1,XXXAFMDT:
                                 XXXAEATS,XXXAGRMS,XXXABTHS,XXXAUPBS,XXXALWBS:
                                 XXXATLTS,XXXABLMS,XXXABWMS,XXXATBDS,XXXATTLS:
                                 XXXATBTS,XXXALOCS,XXXASTRS,XXXACOMS,XXXAEXPS:
                                 XXXASCIS,XXXAPRBS,XXXAMEMS,XXXAMBF2,XXXXEMSA:
                                 XXXDFMDT,XXXDEATS,XXXDGRMS,XXXDBTHS,XXXDUPBS:
                                 XXXDLWBS,XXXDTLTS,XXXDBLMS,XXXDBWMS,XXXDTBDS:
                                 XXXDTTLS,XXXDTBTS,XXXDLOCS,XXXDSTRS,XXXDCOMS:
                                 XXXDEXPS,XXXDSCIS,XXXDPRBS,XXXDMEMS,XXXAMBF3:
                                 XXXXDCRD,XXXXDDLY,XXXDEDPR,XXXDEDSI,XXXDEDES:
                                 XXXDEDEI,XXXDEDBI,XXXXEMOR,XXXXCMR1,XXXXCMR2:
                                 XXXXCMR3,XXXXCMR4,XXXXCIRH,XXXXCMP1,XXXXCMP2:
                                 XXXXCMP3,XXXXCMP4,XXXXENDD,XXXXMEEN,XXXXIDES:
                                 XXXXACPD,XXXXLSPD,XXXAMBF4,XXXXTLDS,XXXXTRSD:
                                 XXXXTRSO,XXXSRPDS,XXXXSRAD,XXXXSRAS,XXXXSRAN:
                                 XXXXSRAA,XXXXSRAP,XXXXSRAM,XXXXSRAG,XXXXSRAT:
                                 XXXXSRAC,XXXXRDDT,XXXXDEFP,XXXXCAMN,XXXXESAS:
                                 XXXXESSC,XXXXEESC,XXXXVDEE,XXXXEEAS,XXXXDRCA:
                                 XXXXPACS,XXXXDWPC,XXXXPPPC,XXXXAPPC,XXXXPACE:
                                 XXXXPROS,XXXXDFPF,XXXXRDIF,XXXXDTUG,XXXXD06M:
                                 XXXXD10M,XXXXFRAI,XXXXPITD,XXXXF12M,XXXXWL12:
                                 XXXXCMNT
.
          ADD       ONE,TOTALREC
.
WRIT9999  RETURN
.
.*******************************************************************************
.*                                  EXTR0000               Called by: PROC0000 *
.*                                                                             *
.* Process  all Visits for patient with date prior to input end date           *
.*   Check visit is for correct hosiptal in multi hospital site                *
.*   Check visit is for rehabilitation                                         *
.*   Calculate Program Interruption total fields for each Rehab visit          *
.*   Set up admission extract fields for first visit found                     *
.*   Calculate Total Leave Days                                                *
.*   Set up Discharge FIM scores from discharge visit                          *
.*******************************************************************************
EXTR0000  MOVE      ZERO,FIMADMOK
          PACK      KEY24,PMUGURNO,SP70
          CALL      RDSVISA2
EXTR1000  CALL      RDKVISA2
          BRANCH    OVRCD,EXTR8000
.
          MATCH     PVIURNO,PMUGURNO
          GOTO      EXTR8000 IF NOT EQUAL
.
          MATCH     PMUGSDAT,PVIDATE
          GOTO      EXTR1000 IF LESS
.
          MATCH     PMUGENDD,SP70
          IF        !@EQUAL
            MATCH     PVIDATE,PMUGENDD
            GOTO      EXTR1000 IF LESS
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      EXTR1000 IF NOT EQUAL
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXTR9901
.
          IF        IBCNMHOS=1
            MATCH     PMVXMHOS,HOSPCODE
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EXTR9902
.
.  *** only send completed visits ***
          IF        ASTAT<>3
            GOTO      EXTR1000
          ENDIF
.
.-------------------------------------------------------------------------------
. check that visit is valid for this program
.-------------------------------------------------------------------------------
          MATCH     PMUGATYP,ATYPE
          GOTO      EXTR1000 IF NOT EQUAL
.
          MATCH     SP70,PMUGCLAM
          IF        !@EQUAL
            MATCH     PMUGCLAM,ACLAIM
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGFUND
          IF        !@EQUAL
            MATCH     PMUGFUND,AFUNDH
            GOTO      EXTR1000 IF NOT EQUAL
.
            PACK      KEY14,AFUNDH,AFNDTB,SP10
            CALL      RDFUND1
            BRANCH    OVRCD,EXTR1000
.
            MATCH     PMUGTABT,PTHFBCAT
            GOTO      EXTR1000 IF NOT EQUAL
          ENDIF
.
.         MATCH     "A ",CARECATG                * Read relevant category type
.         IF        @EQUAL
.           PACK      KEY5,CARECATG,ATYPE,SP70
.         ELSE
.           PACK      KEY5,CARECATG,ACARE,SP70
.         ENDIF
.
.         CALL      RDCODE1
.         IF        OVRCD=1
.           CALL      CTGER000                   * Print Category Code Error
.           GOTO      EXTR1000
.         ENDIF
.
.         MATCH     "A ",CARECATG                * Check if Rehabilitation Visit
.         IF        @EQUAL
.           MATCH   "9",TCINDC8
.           GOTO    EXTR2000 IF EQUAL
.         ELSE
.           MATCH   "2",TCINDC6
.           GOTO    EXTR2000 IF EQUAL
.         ENDIF
.
.         GOTO      EXTR1000                     * Next record
.
EXTR2000  MOVE      ONEINIT,VISITOK
          MATCH     SP70,SAVEVIST                * Admission Extract info done
          GOTO      EXTR4000 IF NOT EQUAL
.
EXTR3000  MOVE      HOSPAPPR,XXXXAPPR            * Establishment Identifier
          MOVE      HOSPNAME,XXXXNAME            * Establishment Name
.
          MOVE      PMUGURNO,XXXPURNO            * Person Identifier
.
          MATCH     SP70,PMVXABRG                * Indigenous Status
          GOTO      EXTR3500 IF EQUAL
.
          PACK      KEY5,CATVA,PMVXABRG
          CALL      RDCODE1
          IF        OVRCD=1
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EXTR1000
          ENDIF
.
          MOVE      TCINDC2,XXXXABRG
.
EXTR3500  PACK      XXXXCMNT,ICOMMENT,SP70       * Optional Comment
.
          CALL      EWRD0000                     * Ward Info
.
          CALL      EMAS0000                     * Patient Master Info
.                                                *
          CALL      EPX20000                     * PMI Extension Info
.
          CALL      EPRG0000                     * Program Details Info
.
          MOVE      ZERO,INTRPTOK
          CALL      EINT0000                     * Program Interruption Info
.
EXTR4000  MATCH     ONEINIT,FIMADMOK
          IF        !@EQUAL
            CALL      EAFM0000                   * Admission FIM Info
          ENDIF
.
          IF        TOTALVIS > 0
            MOVE      ZERO,FIMDSCOK
            CALL      EDFM0000                   * Discharge FIM Info
          ENDIF
.
          MOVE      DPVIBILL,SAVEVIST            * Save the visit file key
          ADD       ONE,TOTALVIS                 * Increment Visit records read
.
          CALL      ELEA0000                     * Calculate Total Leave Days
.
          ADD       CALCDAYS,TOTALLDS
.
          GOTO      EXTR1000                     * Loop all visits for program
.
EXTR8000  IF        TOTALVIS = 0
            GOTO      EXTR9999                   * Check if no Visits Found ?
          ENDIF
.
EXTR8500  MOVE      TOTALLDS,F2
          MOVE      F2,XXXXTLDS                  * Total Leave Days
.
          IF        TOTALVIS > 0
            MOVE      ZERO,FIMDSCOK
            CALL      EDFM0000                   * Discharge FIM Info
          ENDIF
.
          GOTO      EXTR9999
.
EXTR9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Visit Extension Record found for URNO ":
                    PMUGURNO," and admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EXTR1000
.
EXTR9902  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Admission Record found for URNO ",PMUGURNO:
                    " and admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EXTR1000
.
EXTR9999  RETURN
.
.*******************************************************************************
.*                                  EMAS0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Patient Master Extract Fields                                        *
.*******************************************************************************
EMAS0000  PACK      KEY8,PMUGURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            GOTO      EMAS9901
          ENDIF
.                                                * Date of Birth
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      XXPBDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          MOVE      PSEX,XXXXPSEX                * Sex
          REP       "M1m1F2f2I3i3R3r3U9u9",XXXXPSEX
.
          CALL      ELON0000                     * Extract Letters Of Name
.
.                                                * State
EMAS5000  SQUEEZE   PADD4
          RESET     PADD4
.
          MATCH     "NSW",PADD4
          IF        @EQUAL
            MOVE     "01",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "VIC",PADD4
          IF        @EQUAL
            MOVE     "02",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "QLD",PADD4
          IF        @EQUAL
            MOVE     "03",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "SA",PADD4
          IF        @EQUAL
            MOVE     "04",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "WA",PADD4
          IF        @EQUAL
            MOVE     "05",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "TAS",PADD4
          IF        @EQUAL
            MOVE     "06",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "NT",PADD4
          IF        @EQUAL
            MOVE     "07",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "ACT",PADD4
          IF        @EQUAL
            MOVE     "08",XXXPADD4
            GOTO     EMAS8000
          ENDIF
.
          MATCH     "8888",PADD4
          IF        @EQUAL
            MOVE      "10",XXXPADD4              * Overseas
            GOTO      EMAS8000
          ENDIF
.
          MOVE      "09",XXXPADD4                * Other State/Territory
.
EMAS8000  MOVE      PPOST,XXXPPOST               * Postcode
.
          GOTO      EMAS9999
.
EMAS9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No Patient Master found for ",PMUGURNO,*N
          ADD       TWO,CLNO
          GOTO      EMAS9999
.
EMAS9999  RETURN
.
.*******************************************************************************
.*                                  ELON0000               Called by: EMAS0000 *
.*                                                                             *
.* Set up Letters of Name                                                      *
.*******************************************************************************
ELON0000  PACK      LONWRKNM,PSNAME,SP20   * Patient Surname
          STRIP     LONWRKNM
          REP       "' - ",LONWRKNM
          SQUEEZE   LONWRKNM
          MOVE      1,LONCNTR
          CLEAR     LOFSURNM
.
ELON1000  IF        LONCNTR = 2 | LONCNTR = 3 | LONCNTR = 5
            GOTO    ELON1500
          ENDIF
.
          GOTO      ELON1600
.
ELON1500  MOVE      LONWRKNM,ANS
          APPEND    ANS,LOFSURNM
.
ELON1600  BUMP      LONWRKNM
          IF        @EOS
            APPEND    SP3,LOFSURNM
            GOTO    ELON2000
          ENDIF
.
          ADD       "1",LONCNTR
          IF        LONCNTR < 6
            GOTO      ELON1000
          ENDIF
.
ELON2000  PACK      LONWRKNM,PGNAME,SP20   * Patient Given Names
          STRIP     LONWRKNM
          REP       "' - ",LONWRKNM
          SQUEEZE   LONWRKNM
          MOVE      1,LONCNTR
          CLEAR     LOFFSTNM
.
ELON3000  IF        LONCNTR = 2 | LONCNTR = 3
            GOTO    ELON3500
          ENDIF
.
          GOTO      ELON3600
.
ELON3500  MOVE      LONWRKNM,ANS
          APPEND    ANS,LOFFSTNM
.
ELON3600  BUMP      LONWRKNM
          IF        @EOS
            APPEND    SP2,LOFFSTNM
            GOTO    ELON5000
          ENDIF
.
          ADD       "1",LONCNTR
          IF        LONCNTR < 4
            GOTO      ELON3000
          ENDIF
.
ELON5000  RESET     LOFSURNM
          RESET     LOFFSTNM
          REP       " 2",LOFSURNM
          REP       " 2",LOFFSTNM
          PACK      XXXLOFNM,LOFSURNM,LOFFSTNM,SP20
.
ELON9999  RETURN
.
.*******************************************************************************
.*                                  EPX20000               Called by: EXTR0000 *
.*                                                                             *
.* Set up PMI Extension Fields                                                 *
.*******************************************************************************
EPX20000  PACK      KEY8,PMUGURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS       * Line count >= 60
            PRINT     "Error : No PMI Extension found for : '",KEY8,"'",*N
            ADD       TWO,CLNO
            GOTO      EPX29999
          ENDIF
.
          MATCH     ONEINIT,PMPXEDOB
          IF        @EQUAL
            MOVE      PMPXEDOB,XXDOBEST
          ENDIF
.
          MATCH     ONEINIT,PMPXINTR
          IF        @EQUAL
            MOVE      PMPXINTR,XXXXINTR
          ENDIF
.
EPX29999  RETURN
.
.*******************************************************************************
.*                                  EPRG0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Program Extract Fields Including Interruption Details                *
.*     Fields from PMSAPGAF and PMSUPGAF                                       *
.*******************************************************************************
.
.                                        * Funding Source For Hospital Patients
EPRG0000  MOVE      SP70,XXAFUNDH               * Default Health Fund/Payer
          MOVE      SP70,CLAIMTYP
          MATCH     SP70,PMUGCLAM
          IF        @EQUAL
            MOVE      "999",XXAFUNDH
            CALL      EHFN0000                   * Get AROC Equiv from HFund
            MOVE      "02",XXACLAIM                                 * Car 275452
            GOTO      EPRG0100
          ENDIF
.
          PACK      KEY5,CATCL,PMUGCLAM
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXACLAIM,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG0100
          ENDIF
.
          MOVE      PTCDNHCP,XXACLAIM
.                                                * Default Health Fund/Payer
          UNPACK    PTCDNHCP,CLAIMTYP
.
          MATCH     "02",CLAIMTYP
          IF        @EQUAL
            MOVE      "999",XXAFUNDH
          ENDIF
          MATCH     "04",CLAIMTYP
          IF        @EQUAL
            MOVE      "999",XXAFUNDH
          ENDIF
          MATCH     "05",CLAIMTYP
          IF        @EQUAL
            MOVE      "999",XXAFUNDH
          ENDIF
.                                                * Private Health Fund
          MATCH     "02",CLAIMTYP
          GOTO      EPRG0040 IF NOT EQUAL
.
          CALL      EADM0000                     * Get Admission H/F Details
          GOTO      EPRG0100
.                                                * Work Cover
EPRG0040  MATCH     "04",CLAIMTYP
          GOTO      EPRG0060 IF NOT EQUAL
.
          CALL      EWRC0000                     * Get Work Cover Details
          GOTO      EPRG0100
.                                                * Insurance Groups
EPRG0060  MATCH     "05",CLAIMTYP
          GOTO      EPRG0070 IF NOT EQUAL
.
          CALL      ETAC0000                     * Get Motor Accident Board Dtls
          MATCH     "999",XXAFUNDH
          IF        @EQUAL
            IF        PTCNHDPS=3
              MOVE      "607",XXAFUNDH           * Default TAC for Victoria
            ENDIF
          ENDIF
          GOTO      EPRG0100
.
EPRG0070  MATCH     "06",CLAIMTYP
          GOTO      EPRG0100 IF NOT EQUAL
.
          CALL      EOTH0000                     * Other compensation
          GOTO      EPRG0100
.
EPRG0100  MATCH     "07",CLAIMTYP
          IF        @EQUAL
            MOVE      SP70,XXAFUNDH
          ENDIF
.
          MATCH     SP70,PMUGENDD                * Episode End Date
          GOTO      EPRG0200 IF EQUAL
.
          UNPACK    PMUGENDD,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXENDD,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                              * Date Multi-Disciplinary Rehab Plan Established
EPRG0200  MATCH     SP70,PMUGRPDT
          GOTO      EPRG0300 IF EQUAL
.
          UNPACK    PMUGRPDT,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXRPDT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                                            *  Date Discharge Plan Established
EPRG0300  MATCH     SP70,PMUGRDDT
          GOTO      EPRG0400 IF EQUAL
.
          MOVE      ONEINIT,XXXXRDDT
.
.                                                * Read Program Extension
EPRG0400  PACK      KEY31,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RDPMAPG1
          IF        OVRCD=1
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS       * Line count >= 60
            PRINT     "Error : No Program Extension Record Found for ":
                      PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT,PMUGEDAT,*N
            ADD       TWO,CLNO
            GOTO      EPRG9999
          ENDIF
.
          MATCH     SP70,PMAGACPA             * Accommodation Prior To Admission
          GOTO      EPRG0500 IF EQUAL
.
          PACK      KEY5,CATPY,PMAGACPA
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXACPA,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG0500
          ENDIF
.
          MOVE      TCINDC1,XXXXACPA
.
.                                * Level of Support Received Prior to Admission
EPRG0500  MATCH     SP70,PMAGLSPA
          GOTO      EPRG0600 IF EQUAL
.
          PACK      KEY5,CATAR,PMAGLSPA
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPA,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG0600
          ENDIF
.
          MOVE      TCINDC1,XXXXLSPA
.
EPRG0600  MATCH     SP70,PMAGEMST                * Employment Status
          GOTO      EPRG0700 IF EQUAL
.
          PACK      KEY5,CATKD,PMAGEMST
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXEMST,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG0700
          ENDIF
.
          MOVE      TCINDC1,XXXXEMST
.
EPRG0700  MATCH     SP70,PMUGSDAT
          GOTO      EPRG0800 IF EQUAL
.
          UNPACK    PMUGSDAT,CCENT,CYEAR,CMON,CDAY     * Episode Start Date
          PACK      XXXXSDAT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG0800  MATCH     ONEINIT,PMAGFADM      * First Admission For This Impairment
          IF        @EQUAL
            MOVE      ONEINIT,XXXXFADM
          ENDIF
.                                           *  Date of relevant acute admission
          MATCH     SP70,PMAGDADM
          IF        @EQUAL
            MATCH     SP70,PMAGTOCC
            IF        @EQUAL
              GOTO      EPRG0810
            ENDIF
            GOTO      EPRG0900
          ENDIF
.
          GOTO      EPRG0850
.
EPRG0810  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R118 - Date of injury/impairment onset must ":
                    "not be blank for UR ",PMUGURNO,*N
          ADD       TWO,CLNO
          GOTO      EPRG0900
.
EPRG0850  UNPACK    PMAGDADM,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDADM,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG0900  MATCH     SP70,PMAGTOCC                * Time Since Onset
          GOTO      EPRG1000 IF EQUAL
.
          PACK      KEY5,CATTQ,PMAGTOCC
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXTOCC,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1000
          ENDIF
.
          MOVE      TCINDC1,XXXXTOCC
.
EPRG1000  MATCH     SP70,PMAGMEST                * Mode Of Episode Start
          GOTO      EPRG1100 IF EQUAL
.
          PACK      KEY5,CATPX,PMAGMEST
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXMEST,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1100
          ENDIF
.
          MOVE      TCINDC1,XXXXMEST
.
EPRG1100  MATCH     SP70,PMAGMEEN                * Mode of Episode End
          GOTO      EPRG1200 IF EQUAL
.
          PACK      KEY5,CATPW,PMAGMEEN
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXMEEN,SP70
            CALL      CTGER000                   * Print Category Code Error
            COMPARE   "60",CLNO
          ENDIF
.
          MOVE      TCINDC1,XXXXMEEN
.
EPRG1200  MATCH     SP70,PMAGACPDA               * Accommodation Post Discharge
          GOTO      EPRG1300 IF EQUAL
.
          PACK      KEY5,CATPZ,PMAGACPD
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXACPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1300
          ENDIF
.
          MOVE      TCINDC1,XXXXACPD
.
.                                     * Level of support received at episode end
EPRG1300  MATCH     SP70,PMAGLSPD
          GOTO      EPRG1400 IF EQUAL
.
          PACK      KEY5,CATAS,PMAGLSPD
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1400
          ENDIF
.
          MOVE      TCINDC1,XXXXLSPD
.
EPRG1400  MOVE      PMAGICDE,XXXXICDE            * Impairment Code
.
          MATCH     ONEINIT,PMAGEMOR             * Existing Co-Morbidity
          IF        @EQUAL
            MOVE      ONEINIT,XXXXEMOR
          ENDIF
.
.                        * Co-Morbidities Interfering With Rehab Episode
EPRG1500  MATCH     SP70,PMAGCMR1
          GOTO      EPRG1600 IF EQUAL
.
          PACK      KEY5,CATM1,PMAGCMR1
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1600
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMR1
.
EPRG1600  MATCH     SP70,PMAGCMR2
          GOTO      EPRG1700 IF EQUAL
.
          PACK      KEY5,CATM1,PMAGCMR2
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1700
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMR2
.
EPRG1700  MATCH     SP70,PMAGCMR3
          GOTO      EPRG1800 IF EQUAL
.
          PACK      KEY5,CATM1,PMAGCMR3
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1800
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMR3
.
EPRG1800  MATCH     SP70,PMAGCMR4
          GOTO      EPRG1900 IF EQUAL
.
          PACK      KEY5,CATM1,PMAGCMR4
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG1900
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMR4
.
.                         * Complications Interfering With Rehab Episode
EPRG1900  MATCH     SP70,PMAGCMP1
          GOTO      EPRG2000 IF EQUAL
.
          PACK      KEY5,CATM2,PMAGCMP1
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG2000
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMP1
          MOVE      ONEINIT,XXXXCIRH
.
EPRG2000  MATCH     SP70,PMAGCMP2
          GOTO      EPRG2100 IF EQUAL
.
          PACK      KEY5,CATM2,PMAGCMP2
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG2100
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMP2
          MOVE      ONEINIT,XXXXCIRH
.
EPRG2100  MATCH     SP70,PMAGCMP3
          GOTO      EPRG2200 IF EQUAL
.
          PACK      KEY5,CATM2,PMAGCMP3
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG2200
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMP3
          MOVE      ONEINIT,XXXXCIRH
.
EPRG2200  MATCH     SP70,PMAGCMP4
          GOTO      EPRG2300 IF EQUAL
.
          PACK      KEY5,CATM2,PMAGCMP4
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXLSPD,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG2300
          ENDIF
.
          MOVE      PTCDNHCP,XXXXCMP4
          MOVE      ONEINIT,XXXXCIRH
.                                         * Complication Interferring with Rehab
EPRG2300  MATCH     SP70,PMAGRFDT                * Referral Date
          IF        @EQUAL
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS         * Line count >= 60
            PRINT     "Error R112 - Referral Date is missing for UR ":
                      PMUGURNO,*N
            ADD       TWO,CLNO
            GOTO      EPRG2400
          ENDIF
.
          UNPACK    PMAGRFDT,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXRFDT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                                               * Date Assessed by Referral Team
EPRG2400  MATCH     SP70,PMAGDART
          IF        @EQUAL
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS         * Line count >= 60
            PRINT     "Error R112 - Assessment Date is missing for UR ":
                      PMUGURNO,*N
            ADD       TWO,CLNO
            GOTO      EPRG2500
          ENDIF
.
          UNPACK    PMAGDART,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDART,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                                         * Date Clinically Ready for Rehab Care
EPRG2500  MATCH     SP70,PMAGDCRC
          IF        @EQUAL
            COMPARE   "60",CLNO
            CALL      HEAD0000 IF NOT LESS         * Line count >= 60
            PRINT     "Error R112 - Date clinically ready for ":
                      "rehabilitation is missing for UR ",PMUGURNO,*N
            ADD       TWO,CLNO
            GOTO      EPRG2600
          ENDIF
.
          UNPACK    PMAGDCRC,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDCRC,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
.                               * Were any Services received prior to Impairment
EPRG2600  MATCH     ONEINIT,PMAGSRPD
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPD
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPS
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPS
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPN
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPN
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPA
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPA
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPP
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPP
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPM
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPM
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPG
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPG
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPT
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPT
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
          MATCH     ONEINIT,PMAGSRPC
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRPC
            MOVE      ONEINIT,XXXXSRPI
          ENDIF
.
.                                               * Date of Relevant Acute Episode
EPRG2700  MATCH     SP70,PMAGDRAE
          GOTO      EPRG2800 IF EQUAL
.
          UNPACK    PMAGDRAE,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDRAE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG2800  MATCH     SP70,PMAGEMSA            * Employment Status after Discharge
          GOTO      EPRG2900 IF EQUAL
.
          PACK      KEY5,CATKD,PMAGEMSA
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXEMSA,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG2900
          ENDIF
.
          MOVE      TCINDC2,XXXXEMSA
.
.                                          * Date Clinically Ready For Discharge
EPRG2900  MATCH     SP70,PMAGDCRD
          GOTO      EPRG3000 IF EQUAL
.
          UNPACK    PMAGDCRD,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDCRD,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG3000  MATCH     SP70,PMAGIDES                * Interim Destination
          GOTO      EPRG3100 IF EQUAL
.
          PACK      KEY5,CATPZ,PMAGIDES
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXIDES,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG3100
          ENDIF
.
          MOVE      TCINDC1,XXXXIDES
.
.                                 * Will any Services be received post Discharge
EPRG3100  MATCH     ONEINIT,PMAGSRAD
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAD
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAS
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAS
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAN
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAN
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAA
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAA
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAP
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAP
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAM
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAM
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAG
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAG
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAT
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAT
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAC
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAC
            MOVE      ONEINIT,XXXSRPDS
          ENDIF
.
.                                                * Date Emerged From PTA
EPRG3200  MATCH     SP70,PMAGDEFP
          GOTO      EPRG3300 IF EQUAL
.
          UNPACK    PMAGDEFP,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDEFP,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG3300  MATCH     "02.22",XXXXICDE
          GOTO      EPRG3350 IF EQUAL
.
          MATCH     "02.21",XXXXICDE
          GOTO      EPRG3350 IF EQUAL
.
          MATCH     "14.1",XXXXICDE
          GOTO      EPRG3350 IF EQUAL
.
          MATCH     "14.2",XXXXICDE
          GOTO      EPRG3350 IF EQUAL
.
          GOTO      EPRG3400
.
EPRG3350  MOVE      PMAGCAMN,XXXXCAMN            * Duration of PTA
.
EPRG3400  MATCH     SP70,PMAGESAS                * Episode Start ASIA Score
          GOTO      EPRG3500 IF EQUAL
.
          PACK      KEY5,CATRA,PMAGESAS
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXESAS,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG3500
          ENDIF
.
          MOVE      TCINDC1,XXXXESAS
.
EPRG3500  MATCH     SP70,PMAGESSC          * Episode Start Level of Spinal Chord
          GOTO      EPRG3600 IF EQUAL
.
          PACK      KEY5,CATRB,PMAGESSC
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXESSC,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG3600
          ENDIF
.
          MOVE      THCSCOD,XXXXESSC
.
EPRG3600  MATCH     SP70,PMAGEESC          * Episode End Level of Spinal Chord I
          GOTO      EPRG3700 IF EQUAL
.
          PACK      KEY5,CATRB,PMAGEESC
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXEESC,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG3700
          ENDIF
.
          MOVE      THCSCOD,XXXXEESC
.
EPRG3700  MATCH     ONEINIT,PMAGVDEE       * Ventilator Dependant at Episode End
          IF        @EQUAL
            MOVE      ONEINIT,XXXXVDEE
          ENDIF
.
EPRG3800  MATCH     SP70,PMAGEEAS                * Episode End ASIA Score
          GOTO      EPRG3900 IF EQUAL
.
          PACK      KEY5,CATRA,PMAGEEAS
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXEEAS,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG3900
          ENDIF
.
          MOVE      TCINDC1,XXXXEEAS
.
.                                                * Date Ready for Casting
EPRG3900  MATCH     SP70,PMAGDRCA
          GOTO      EPRG4000 IF EQUAL
.
          UNPACK    PMAGDRCA,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDRCA,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG4000  MATCH     SP70,PMAGPACS           * Phase of Amputee Care at Episode St
          GOTO      EPRG4100 IF EQUAL
.
          PACK      KEY5,CATRD,PMAGPACS
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXPACS,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG4100
          ENDIF
.
          MOVE      TCINDC1,XXXXPACS
.
EPRG4100  MATCH     ONEINIT,PMAGDWPC        * Delayed Wound Phase of Care during
          IF        @EQUAL
            MOVE      ONEINIT,XXXXDWPC
          ENDIF
.
EPRG4200  MATCH     ONEINIT,PMAGPPPC       * Pre Prosthetic Phase of Care during
          IF        @EQUAL
            MOVE      ONEINIT,XXXXPPPC
          ENDIF
.
EPRG4300  MATCH     ONEINIT,PMAGAPPC       * Prosthetic Phase of Care during Epi
          IF        @EQUAL
            MOVE      ONEINIT,XXXXAPPC
          ENDIF
.
EPRG4400  MATCH     SP70,PMAGPACE          * Phase of Amputee Care at Episode En
          GOTO      EPRG4500 IF EQUAL
.
          PACK      KEY5,CATRD,PMAGPACE
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXPACE,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG4500
          ENDIF
.
          MOVE      TCINDC1,XXXXPACE
.
EPRG4500  MATCH     ONEINIT,PMAGPROS             * Prosthetic?
          IF        @EQUAL
            MOVE      ONEINIT,XXXXPROS
          ENDIF
.
.                                                * Date First Prosthetic Fitting
EPRG4600  MATCH     SP70,PMAGDFPF
          GOTO      EPRG4700 IF EQUAL
.
          UNPACK    PMAGDFPF,CCENT,CYEAR,CMON,CDAY
          PACK      XXXXDFPF,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EPRG4700  MATCH     SP70,PMAGRDIF                * Reason for Delay in Fitting
          GOTO      EPRG4800 IF EQUAL
.
          PACK      KEY5,CATRE,PMAGRDIF
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXRDIF,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG4800
          ENDIF
.
          MOVE      TCINDC1,XXXXRDIF
.                                                * Discharge Timed Up and Go
EPRG4800  MOVE      PMAGDUGO,XXXXDTUG
          MATCH     SP70,XXXXDTUG
          IF        !@EQUAL
            RJUSTIFY  XXXXDTUG
            REP       " 0",XXXXDTUG
          ENDIF
.                                                * Discharge 10 Metre Walk
          MOVE      PMAGDWLK,XXXXD10M
          MATCH     SP70,XXXXD10M
          IF        !@EQUAL
            RJUSTIFY  XXXXD10M
            REP       " 0",XXXXD10M
          ENDIF
.
EPRG4900  IF        PMAGD06M <> 0
            MOVE      PMAGD06M,XXXXD06M
          ENDIF
.
EPRG5100  MATCH     SP70,PMAGFRAI                * Fraility (pre-morbid)
          GOTO      EPRG5200 IF EQUAL
.
          PACK      KEY5,CATRG,PMAGFRAI
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      XXXXRDIF,SP70
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EPRG5200
          ENDIF
.
          MOVE      TCINDC1,XXXXFRAI
.
EPRG5200  MATCH     ONEINIT,PMAGPITD
          IF        @EQUAL
            MOVE      ONEINIT,XXXXPITD
          ENDIF
.
          MATCH     ONEINIT,PMAGF12M
          IF        @EQUAL
            MOVE      ONEINIT,XXXXF12M
          ENDIF
.
          MATCH     ONEINIT,PMAGWL12
          IF        @EQUAL
            MOVE      ONEINIT,XXXXWL12
          ENDIF
.
          MATCH     ONEINIT,PMAGSRAA
          IF        @EQUAL
            MOVE      ONEINIT,XXXXSRAA
          ENDIF
.                                                * check dates are in sequence
EPRG6000  MATCH     SP70,PMAGRFDT
          GOTO      EPRG6200 IF EQUAL
.
          MATCH     SP70,PMAGDART
          GOTO      EPRG6100 IF EQUAL
.
          MATCH     PMAGRFDT,PMAGDART
          GOTO      EPRG6100 IF NOT LESS
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R104 - Referral Date must occur on or before ":
                    "assessment date for UR ",PMUGURNO,*N
          ADD       TWO,CLNO
.
EPRG6100  MATCH     SP70,PMAGDADM
          GOTO      EPRG6200 IF EQUAL
.
          MATCH     "05",PMAGICDE                * Do not check Impairment 05
          GOTO      EPRG6200 IF EQUAL
.
          MATCH     "08.2",PMAGICDE              * Do not check impairment 08.2*
          GOTO      EPRG6200 IF EQUAL
.
          MATCH     PMAGDADM,PMAGRFDT
          GOTO      EPRG6200 IF NOT LESS
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R104 - Date of impairment onset must occur on or ":
                    "before referral date for UR ",PMUGURNO,*N
          ADD       TWO,CLNO
.
EPRG6200  MATCH     SP70,PMAGDART
          GOTO      EPRG6300 IF EQUAL
.
          PACK      DCRCDATE,PMAGDCRC,SP70
          MATCH     PMAGDART,DCRCDATE
          GOTO      EPRG6300 IF NOT LESS
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R104 - Assessment date must occur on or before ":
                    "date clinically ready for rehabilitation for UR ":
                    PMUGURNO,*N
          ADD       TWO,CLNO
.
EPRG6300  PACK      DCRCDATE,PMAGDCRC,SP70
          MATCH     DCRCDATE,PMUGSDAT
          GOTO      EPRG6400 IF NOT LESS
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R104 - Date clinically ready for rehabilitation ":
                    "must occur on or before episode start date for UR ":
                    PMUGURNO,*N
          ADD       TWO,CLNO
.
EPRG6400  PACK      DCRCDATE,PMAGDCRC,SP70
          MATCH     DCRCDATE,PMUGENDD
          GOTO      EPRG9999 IF NOT LESS
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error R104 - Date clinically ready for rehabilitation ":
                    "must occur on or before episode end date for UR ":
                    PMUGURNO,*N
          ADD       TWO,CLNO
.
EPRG9999  RETURN
.
.*******************************************************************************
.*                                  EADM0000               Called by: EPRG0000 *
.*                                                                             *
.* Extract Admission Health Fund AROC Equivalent Code                          *
.*******************************************************************************
EADM0000  PACK      KEY8,DPVIBILL,SP70
          CALL      RDAMISS1
          IF        OVRCD=1
            GOTO      EADM9901
          ENDIF
.
          PACK      KEY14,AFUNDH,FOURZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      EADM9902
          ENDIF
.
          MOVE      PTHFARCE,XXAFUNDH            * AROC Equivalent Code
          GOTO      EADM9999
.
EADM9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No Admission Record found for admission number ":
                    DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EADM9999
.
EADM9902  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No AROC Equivalent code found for Health Fund" :
                    " '",KEY14,"' on Admission Number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EADM9999
.
EADM9999  RETURN
.
.*******************************************************************************
.*                                  EWRC0000               Called by: EPRG0000 *
.*                                                                             *
.* Extract Workers Compensation AROC Equivalent Code                           *
.*******************************************************************************
EWRC0000  PACK      KEY8,DPVIBILL,SP70
          CALL      RDWCOM1
          IF        OVRCD=1
            GOTO      EWRC9901
          ENDIF
.
          PACK      KEY6,WCICODE,SP70
          CALL      RDINSR1
          IF        OVRCD=1
            GOTO      EWRC9902
          ENDIF
.
          MOVE      PTINARCE,XXAFUNDH            * AROC Equivalent Code
          GOTO      EWRC9999
.
EWRC9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No Workers Compensation Code found for ":
                    "admission number",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EWRC9999
.
EWRC9902  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No AROC Equivalent code found for Insurance" :
                    " code ",KEY6,*N
          ADD       TWO,CLNO
          GOTO      EWRC9999
.
EWRC9999  RETURN
.
.*******************************************************************************
.*                                  ETAC0000               Called by: EPRG0000 *
.*                                                                             *
.* Extract Motor Accident Board Claims AROC Equivalent Code                    *
.*******************************************************************************
ETAC0000  PACK      KEY8,DPVIBILL,SP70
          CALL      RDWMAB1
          IF        OVRCD=1
            GOTO      ETAC9901
          ENDIF
.
          PACK      KEY6,PTWMICDE,SP70
          CALL      RDINSR1
          IF        OVRCD=1
            GOTO      ETAC9902
          ENDIF
.
          MOVE      PTINARCE,XXAFUNDH            * AROC Equivalent Code
          GOTO      ETAC9999
.
ETAC9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No TAC Insurance Code found for ":
                    "admission number",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      ETAC9999
.
ETAC9902  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No AROC Equivalent code found for TAC" :
                    " Insurance code ",KEY6," ,Admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      ETAC9999
.
ETAC9999  RETURN
.
.*******************************************************************************
.*                                  EOTH0000               Called by: EPRG0000 *
.*                                                                             *
.* Extract Other Compensation Equivalent Code                                  *
.*******************************************************************************
EOTH0000  PACK      KEY6,SP70
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDWCOM1
          IF        OVRCD=1
            GOTO      EOTH9901
          ENDIF
.
          PACK      KEY6,WCICODE,SP70
          CALL      RDINSR1
          IF        OVRCD=1
            GOTO      EOTH9901
          ENDIF

          MOVE      PTINARCE,XXAFUNDH            * AROC Equivalent Code
          GOTO      EOTH9999
.
EOTH9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No AROC Equivalent code found for insurance " :
                    "number ",KEY6," on ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EOTH9999
.
EOTH9999  RETURN
.
.*******************************************************************************
.*                                  EHFN0000               Called by: EPRG0000 *
.*                                                                             *
.* Extract Health Fund AROC Equivalent Code if no Program Claim Code exists    *
.*******************************************************************************
EHFN0000  PACK      KEY14,PMUGFUND,FOURZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      EHFN9901
          ENDIF
.
          MOVE      PTHFARCE,XXAFUNDH            * AROC Equivalent Code
          GOTO      EHFN9999
.
EHFN9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Warning : No AROC Equivalent code found for Health Fund" :
                    " '",KEY14,"' on Admission Number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EHFN9999
.
EHFN9999  RETURN
.
.*******************************************************************************
.*                                  CTGER000               Called by: ERINT000 *
.*                                                                    EPRG0000 *
.*                                                                    EXTR0000 *
.*                                                                             *
.* Print Category Code Lookup Error message                                    *
.*******************************************************************************
CTGER000  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Category Code found for : '",KEY5:
                    "' Program '",PMUGURNO,",",PMUGATYP,",",PMUGCLAM,",":
                    PMUGFUND,",",PMUGTABT,",",PMUGEDAT,"'",*N
          ADD       TWO,CLNO
.
CTGER999  RETURN
.
.*******************************************************************************
.*                                  EWRD0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Ward Extract Fields                                                  *
.*******************************************************************************
EWRD0000  PACK      KEY30,DPVIBILL,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,EWRD9901
.
          MATCH     "A",TMOVE                    * check admission exists
          GOTO      EWRD9902 IF NOT EQUAL
.
          MOVE      TWARD,XXXTWARD               * Admission Ward Identifier

          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EWRD9903
.
          MOVE      WBDESC,XXWBDESC              * Admission Ward Description
.
          GOTO      EWRD9999
.
EWRD9901  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Transfer Records found for URNO ",PMUGURNO:
                    " and admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EWRD9999
.
EWRD9902  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Transfer Admission Record found for URNO ":
                    PMUGURNO," and admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EWRD9999
.
EWRD9903  COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Ward Record found for URNO ",PMUGURNO:
                    " and ward identifier ",TWARD,*N
          ADD       TWO,CLNO
          GOTO      EWRD9999
.
EWRD9999  RETURN
.
.*******************************************************************************
.*                                  EAFM0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Admission FIM Score Extract Fields                                   *
.*******************************************************************************
.
EAFM0000  PACK      KEY24,DPVIBILL,SP70
          CALL      RDPTFIM1
EAFM1000  CALL      RKPTFIM1
          BRANCH    OVRCD,EAFM9901
.
          MATCH     PTFIVISN,DPVIBILL
          GOTO      EAFM9901 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      EAFM1000 IF EQUAL
.
          MATCH     "A",PTFITYPE
          GOTO       EAFM9901 IF NOT EQUAL
.
          MOVE      ONEINIT,FIMADMOK
.                                           ******************  Admission Scores
          MOVE      PTFIEATS,F1                   * Eating
          MOVE      F1,XXXAEATS
.
          MOVE      PTFIGRMS,F1                   * Grooming
          MOVE      F1,XXXAGRMS
.
          MOVE      PTFIBTHS,F1                   * Bathing
          MOVE      F1,XXXABTHS
.
          MOVE      PTFIUPBS,F1                   * Dressing Upper Body
          MOVE      F1,XXXAUPBS
.
          MOVE      PTFILWBS,F1                   * Dressing Lower Body
          MOVE      F1,XXXALWBS
.
          MOVE      PTFITLTS,F1                   * Toileting Score
          MOVE      F1,XXXATLTS
.
          MOVE      PTFIBLMS,F1                   * Bladder Management
          MOVE      F1,XXXABLMS
.
          MOVE      PTFIBWMS,F1                   * Bowel Management
          MOVE      F1,XXXABWMS
.
          MOVE      PTFITBDS,F1                  * Transfers - Bed/Chair/W'Chair
          MOVE      F1,XXXATBDS
.
          MOVE      PTFITTLS,F1                  * Transfers - Toilet
          MOVE      F1,XXXATTLS
.
          MOVE      PTFITBTS,F1                  * Transfers - Bath/Shower
          MOVE      F1,XXXATBTS
.
          MOVE      PTFILOCS,F1                  * Locomotion
          MOVE      F1,XXXALOCS
.
          MOVE      PTFISTRS,F1                  * Stairs
          MOVE      F1,XXXASTRS
.
          MOVE      PTFICOMS,F1                  * Comprehension
          MOVE      F1,XXXACOMS
.
          MOVE      PTFIEXPS,F1                  * Expression
          MOVE      F1,XXXAEXPS
.
          MOVE      PTFISCIS,F1                  * Social Interaction
          MOVE      F1,XXXASCIS
.
          MOVE      PTFIPRBS,F1                  * Problem Solving
          MOVE      F1,XXXAPRBS
.
          MOVE      PTFIMEMS,F1                  * Memory
          MOVE      F1,XXXAMEMS
.
          MATCH     SP70,PTFIDATE                * Date Admission FIM Assessed
          GOTO      EAFM9901 IF EQUAL
.
          UNPACK    PTFIDATE,CCENT,CYEAR,CMON,CDAY
          PACK      XXXAFMDT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EAFM9901  MATCH     ONEINIT,FIMADMOK
          GOTO      EAFM9999 IF EQUAL
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Admission FIM Record found for URNO ",PMUGURNO:
                    " and admission number ",DPVIBILL,*N
          ADD       TWO,CLNO
          GOTO      EAFM9999
.
EAFM9999  RETURN
.
.*******************************************************************************
.*                                  EINT0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Program Interruption Extract Fields                                  *
.*******************************************************************************
.
EINT0000  PACK      KEY36,PMUGURNO,PMUGATYP,PMUGCLAM,PMUGFUND,PMUGTABT:
                          PMUGEDAT,SP70
          CALL      RSPMPIT1
EINT1000  CALL      RKPMPIT1
          BRANCH    OVRCD,EINT8000
.
          MATCH     PMPIURNO,PMUGURNO
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     PMPIATYP,PMUGATYP
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     PMPICLAM,PMUGCLAM
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     PMPIFUND,PMUGFUND
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     PMPITABT,PMUGTABT
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     PMPIEDAT,PMUGEDAT
          GOTO      EINT8000 IF NOT EQUAL
.
          MATCH     ONEINIT,PMPIDELT
          GOTO      EINT1000 IF EQUAL
.
          ADD       ONE,TOTALSOC
          MOVE      ONEINIT,INTRPTOK
.
          MOVE      PMPIFDAT,FROMDATE
          MATCH     SP70,PMPITDAT
          IF        @EQUAL
            MOVE      EENDDATE,TODATE
          ELSE
            MOVE      PMPITDAT,TODATE
          ENDIF
.                                              * Calculate Rehab Suspension Days
          MOVE      ZERO,CALCDAYS
          DAYSEP    FROMDATE,TODATE,CALCDAYS
          COMPARE   ZERO,CALCDAYS
          IF        @EQUAL
            MOVE      ONE,CALCDAYS
          ENDIF
          ADD       CALCDAYS,TOTALSDS
.
EINT5000  MATCH     SP70,PMPIRINT                * Reason for Interruption
          GOTO      EINT5100 IF EQUAL
.
          PACK      KEY5,CATRZ,PMPIRINT
          CALL      RDCODE1
          IF        OVRCD=1
            CALL      CTGER000                   * Print Category Code Error
            GOTO      EINT5100
          ENDIF
.
          MATCH     "P",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXESTPR
            MOVE      ONEINIT,XXXESDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "S",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXESTSI
            MOVE      ONEINIT,XXXESDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "E",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXESTES
            MOVE      ONEINIT,XXXESDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "Q",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXESTEI
            MOVE      ONEINIT,XXXESDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "B",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXESTBI
            MOVE      ONEINIT,XXXESDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "A",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXDEDPR
            MOVE      ONEINIT,XXXXDDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "R",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXDEDSI
            MOVE      ONEINIT,XXXXDDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "X",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXDEDES
            MOVE      ONEINIT,XXXXDDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "U",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXDEDEI
            MOVE      ONEINIT,XXXXDDLY
            GOTO      EINT5100
          ENDIF
.
          MATCH     "H",TCINDC2
          IF        @EQUAL
            MOVE      ONEINIT,XXXDEDBI
            MOVE      ONEINIT,XXXXDDLY
            GOTO      EINT5100
          ENDIF
.
EINT5100  GOTO      EINT1000
.
EINT8000  MATCH     ONEINIT,XXXESDLY
          IF        @EQUAL
            REP     " 2",XXXESTPR
            REP     " 2",XXXESTSI
            REP     " 2",XXXESTES
            REP     " 2",XXXESTEI
            REP     " 2",XXXESTBI
          ENDIF
.
          MATCH     ONEINIT,XXXXDDLY
          IF        @EQUAL
            REP     " 2",XXXDEDPR
            REP     " 2",XXXDEDSI
            REP     " 2",XXXDEDES
            REP     " 2",XXXDEDEI
            REP     " 2",XXXDEDBI
          ENDIF
.
          MATCH     ONEINIT,INTRPTOK
          GOTO      EINT9999 IF NOT EQUAL
.
          MOVE      TOTALSDS,F2
          MOVE      F2,XXXXTRSD                  * Total Rehab Susp Days
          MOVE      TOTALSOC,F2
          MOVE      F2,XXXXTRSO                  * Total Rehab Susp Occur
.
EINT9999  RETURN
.
.*******************************************************************************
.*                                  ELEA0000               Called by: EXTR0000 *
.*                                                                             *
.* Calculate Leave Days for this visit                                         *
.*******************************************************************************
.
ELEA0000  MOVE      ZERO,CALCDAYS
.
          PACK      KEY30,PVIBILL,SP30
          CALL      RDSTRAN2
ELEA1000  CALL      RDKTRAN2
          BRANCH    OVRCD,ELEA9999               * No transfer records
.
          MATCH     DPVIBILL,DTADMN
          GOTO      ELEA9999 IF NOT EQUAL        * Different admission no
.
          MATCH     ANSL,TMOVE                   * Find leave transfer
          GOTO      ELEA1000 IF NOT EQUAL
.
          MATCH     TDATE,EENDDATE               * Leave taken after extract dte
          GOTO      ELEA9999 IF LESS             * Read next admission
.
          MOVE      TDATE,FROMDATE               * Save Leave Start date
.
          MOVE      EENDDATE,TODATE              * Set return date as end date
ELEA2000  CALL      RDKTRAN2
          BRANCH    OVRCD,ELEA3000               * No return from leave
.
          MATCH     DPVIBILL,DTADMN
          GOTO      ELEA3000 IF NOT EQUAL        * No return from leave
.
          MATCH     ANSR,TMOVE                   * Return from leave
          GOTO      ELEA3000 IF NOT EQUAL        * Still on leave
.
          MATCH     TDATE,EENDDATE               * Is Return Date > End Date ?
          IF        @LESS
            MOVE      EENDDATE,TODATE            * Save End Date as Return Date
          ELSE
            MOVE      TDATE,TODATE               * Save Return date
          ENDIF
.
ELEA3000  DAYSEP    FROMDATE,TODATE,CALCDAYS
.
          MATCH     TDATE,EENDDATE
          IF        @LESS
            ADD       ONE,CALCDAYS               * Still on leave so add a day
          ENDIF
.
ELEA9999  RETURN
.
.*******************************************************************************
.*                                  EDFM0000               Called by: EXTR0000 *
.*                                                                             *
.* Set up Discharge FIM Score Extract Fields                                   *
.*******************************************************************************
.
EDFM0000  PACK      KEY24,SAVEVIST,SP70
          CALL      RDPTFIM1
EDFM1000  CALL      RKPTFIM1
          BRANCH    OVRCD,EDFM9901
.
          MATCH     PTFIVISN,SAVEVIST
          GOTO      EDFM9901 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      EDFM1000 IF EQUAL
.
          MATCH     "D",PTFITYPE
          GOTO      EDFM1000 IF NOT EQUAL
.
          MOVE      ONEINIT,FIMDSCOK
.                                           ******************  Discharge Scores
          MOVE      PTFIEATS,F1                  * Eating
          MOVE      F1,XXXDEATS
.
          MOVE      PTFIGRMS,F1                  * Grooming
          MOVE      F1,XXXDGRMS
.
          MOVE      PTFIBTHS,F1                  * Bathing
          MOVE      F1,XXXDBTHS
.
          MOVE      PTFIUPBS,F1                  * Dressing Upper Body
          MOVE      F1,XXXDUPBS
.
          MOVE      PTFILWBS,F1                  * Dressing Lower Body
          MOVE      F1,XXXDLWBS
.
          MOVE      PTFITLTS,F1                  * Toileting Score
          MOVE      F1,XXXDTLTS
.
          MOVE      PTFIBLMS,F1                  * Bladder Management
          MOVE      F1,XXXDBLMS
.
          MOVE      PTFIBWMS,F1                  * Bowel Management
          MOVE      F1,XXXDBWMS
.
          MOVE      PTFITBDS,F1                  * Transfers - Bed/Chair/W'Chair
          MOVE      F1,XXXDTBDS
.
          MOVE      PTFITTLS,F1                  * Transfers - Toilet
          MOVE      F1,XXXDTTLS
.
          MOVE      PTFITBTS,F1                  * Transfers - Bath/Shower
          MOVE      F1,XXXDTBTS
.
          MOVE      PTFILOCS,F1                  * Locomotion
          MOVE      F1,XXXDLOCS
.
          MOVE      PTFISTRS,F1                  * Stairs
          MOVE      F1,XXXDSTRS
.
          MOVE      PTFICOMS,F1                  * Comprehension
          MOVE      F1,XXXDCOMS
.
          MOVE      PTFIEXPS,F1                  * Expression
          MOVE      F1,XXXDEXPS
.
          MOVE      PTFISCIS,F1                  * Social InteractionR
          MOVE      F1,XXXDSCIS
.
          MOVE      PTFIPRBS,F1                  * Problem Solving
          MOVE      F1,XXXDPRBS
.
          MOVE      PTFIMEMS,F1                  * Memory
          MOVE      F1,XXXDMEMS
.
          MATCH     SP70,PTFIDATE                * Date Discharge FIM Assessed
          GOTO      EDFM9901 IF EQUAL
.
          UNPACK    PTFIDATE,CCENT,CYEAR,CMON,CDAY
          PACK      XXXDFMDT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
EDFM9901  MATCH     ONEINIT,FIMDSCOK
          GOTO      EDFM9999 IF EQUAL
.
          COMPARE   "60",CLNO
          CALL      HEAD0000 IF NOT LESS         * Line count >= 60
          PRINT     "Error : No Discharge FIM Record found for URNO ",PMUGURNO:
                    " and admission number ",SAVEVIST,*N
          ADD       TWO,CLNO
          GOTO      EDFM9999
.
EDFM9999  RETURN
.
.******************************************************************************
.
          INC       STD001IO                     * Standard Include
.
          INC       PATHSPKY                     * Keyin of a Hospital Id/code
          INC       CLPATHSP                     * Clear Hospital Table variables
          INC       TFILENAM                     * Generate Temp File Name
.
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       PATCODIO/INC                 * Category Codes
          INC       PATFIMIO/INC                 * FIM Score File
          INC       PATFN1IO/INC                 * Health Fund File
          INC       PATHSPIO/INC                 * Hospital File
          INC       PATIN1IO/INC                 * Insurance Details File
          INC       PATMA1IO/INC                 * Patient Master File
          INC       PATMI1IO/INC                 * Patient Admission File
          INC       PATTRNIO/INC                 * Patient Transfer File
          INC       PATVISIO/INC                 * Patient Visit File
          INC       PATWC1IO/INC                 * Workers Compensation Claims
          INC       PATWMAIO/INC                 * Motor Accident Board Claims
          INC       PATWR1IO/INC                 * Patient Ward/Bed File
          INC       PMSAPGIO/INC                 * Program Details Ext File
          INC       PMSPITIO/INC                 * Program Interruption File
          INC       PMSPX2IO/INC                 * PMI Extension File
          INC       PMSUPGIO/INC                 * Program Details File
          INC       PMSVX1IO/INC                 * Patient Visit Ext File
          INC       WEBSECIO/INC                 * Web Security File
          INC       WEBERRIO/INC                 * Web Server Error Logging
