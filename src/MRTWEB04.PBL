.-------------------------------------------------------------------------------
. Program       : MRTWEB04 
.
. Function      : Medical Record Post Discharge Tracking
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.01 19/05/2025  Ebon Clements    TSK 0955096
.           Alphanueric visit number changes
. V11.03.03 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.03.02 14/07/2023  Bella Turco    TSK 0901388
.           Changed MATCH conditions for MRCNEACA in DISHD000 and DISRW000
. V11.03.01 18/11/2022  Jacob Jackson  TSK 0925779
.           Fix issue where post discharge history would be overwritten instead
.           of writing a new record
. V11.02.07 11/05/2022  Thanh T        TSK 0901057
.           Changed MISSDA00 to trigger onclick instead of onchange event when
.           calling ShowMissingDetails
. V11.02.06 06/05/2022  Thanh T        TSK 0901057
.           Changed MISSDA00 to trigger onclick instead of onchange event when
.           calling ShowMissingDetails
. V11.02.05 05/05/2022  Thanh T       TSK 0901057
.           Changed MISSDA00 for MR missing details 1 to 6 fields
. V11.02.04 05/05/2022  Thanh T       TSK 0901057
.           Changed MISSDA00 to add comment flag 
. V11.02.03 11/03/2022  Thanh T       TSK 0901057
.           Added PSTR0400, PSTR0500, DISHDA00, DISRWA00, MISSDA00, DISHDA00
.           DISRWA00, MISSDA00 for MR missing details 1 to 6 fields
. V11.02.02 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 24/01/2022  Jacob Jackson  TSK  0864505
.           Added preferred name option fields -
.           MRPR2466, MRPR2467, MRPR2468, MRPR2469, MRPR2470
. V11.01.05 04/11/2021  Ebon Clements  Task 0909584
.           Added call to CHKMOV00 in CHKMVN00 if not NZ
.           valdtype=3 will behave like valdtype=2 if not NZ.
. V11.01.04 03/08/2021  Jill Parkinson Task 0909584
.           Added check to match hospital in CHKMVN00            
. V11.01.03 25/06/2021  Jill Parkinson Task 0907902
.           Removed check for NZ only in CHKMVN00            
. V11.01.02 26/04/2021  Ebon Clements  TSK 0901388
.           Recompiled for MRTPSHFD - Free text description
. V11.01.01 22/02/2021  J.Tan          TSK 0888639
.           Changed patmmbs counter record to DIM3
. V11.00.08 09/12/2020  Thanh T        TSK 0872840
.           Recompiled as PMSPX2TM changes 
. V11.00.07 17/11/2020  Thanh T          TSK 0878747
.           Added MRPR2465 for multiple birth details 
. V11.00.06 20/07/2020  Thanh T           TSK 0883886
.           Changed CHKMVN00 to validate if any uncoded discharge addmission
.           has incomplete coding
. V11.00.05 14/07/2020  Thanh T           TSK 0883886
.           Changed CHKMVN00 to validate if any uncoded discharge addmission
.           has incomplete coding    
. V11.00.04 18/05/2020  Thanh T           TSK 0883886
.           Added CHKMVN00
. V11.00.03 06/04/2020  Thanh T           TSK 0879163             
.           Changed MRPRN414, MRPRN798 for Sex category.                    
.           Added MRPR2464 for sex long description               
. V11.00.02 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.01 10/03/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
.------------------------------------------------------------------------------
. V10.15.02 12/11/2019  Ken Bell       TSK 0863343
.           Incorrect Branch, S/B next code after the inactive code
. V10.15.01 08/11/2019  Ken Bell       TSK 0886343
.           Discharge Status dropdown list to exclude inactive code
. V10.14.01 24/09/2019  Thanh T        TSK 0873083
.           Changed GETVIS00 to check for user hospital access using
.           centralised coding
. V10.12.01 03/04/2018  J.Tan          TSK 0854298
.           Changed DISDC000 to check COUNT for maximum limit of 99 records
. V10.11.04 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.------------------------------------------------------------------------------
. V10.10.01 20/03/2017  Thanh T.          TSK 0832066
.           Changed DVA PREPAT/PMPXDVAC fields to use the new
.           concession card PMCDCNUM/PMCDDVAC fields 
. V10.08.02 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.01 07/06/2016  Jill Parkinson TSK 0820003                          
.           Recompiled for PMSCEXCD - allow patmx1af/prepa/prepat/patma1af dets
. V10.06.01 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.05.02 26/11/2014 Ebon Clements    CAR 299539
.           Added multi hospital test to default document type - SING0200
. V10.05.01 02/09/2014  Don Nguyen      CAR 303883
.           Added TBPDSH00 (PDSH0000).
.           Added Report 8 processing - Post Discharge Status History
. V10.04.05 22/05/2014 Sandra Barcham  CAR 301498
.           Mods to display Document Type correctly in RECRW000
. V10.04.04 15/05/2014  J.Tan          CAR 291374
.           Mods to display Microfilm or Volume Comments on Record movement
. V10.04.03 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.02 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.01 20/02/2014  Don Nguyen        CAR 291879
.           Added variable 362 (MRPR2463) - IHI Number        
.------------------------------------------------------------------------------
. V10.03.09 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.08 04/03/2013  Ebon Clements     CAR 277797   
.           Added read of medical record before movement list - HISTB000
. V10.03.07 30/03/2012  Mike Laming       CAR 259379
.           Mods to RECDC000 to correct Row number                            
. V10.03.06 30/01/2012  Mike Laming       CAR 259106
.           Mods to use PTHSRCTY instead of MRCNRCTY in "Red" Hospital fields.
. V10.03.05 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.04 08/12/2011  Mike Laming       CAR 248696
.           More mods to Red or Black Hospital Id (Added Cat TY test)
. V10.03.03 21/11/2011  Mike Laming       CAR 254569
.           More mods to Hospital Id (with colours)
. V10.03.01 14/11/2011  Peter Vela       CAR 254732
.           Display hospitals with the same MRT Home Location HSEL0000
.           10/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
.           18/11/2011  Peter McMullen   CAR 254569
.           Extend location display fields to avoid truncation 
. V10.02.12 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.11 29/09/2011  Mike Laming      CAR 250386
.           Fixed HSEL000 to select primary Hospital for non-super Users     
. V10.02.10 15/09/2011  Mike Laming      CAR 248696
.           Mods to (hos) fields where Home Hospital is not Current Hospital
. V10.02.09 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.08 26/07/2011  Ebon Clements    CAR 243582
.           Recompiled for MRTLOCFD - Tracking receipt functionality
. V10.02.07 20/07/2011  Mike Laming    CAR 240724
.           Mods for "Post Discharge Tracking" in RECRW000                 
. V10.02.06 11/07/2011  Mike Laming    CAR 240724
.           Mods for "Post Discharge Tracking" in RECRW000                 
. V10.02.05 08/07/2011  Ebon Clements  CAR 240724
.           Mods for MRT hospital/location - Added hospital to location key
. V10.02.04 04/07/2011  Steve Armstrong  CAR 240722
.           Recompiled for changes to PMSCEXCD.
.           26/05/2011  Mike Laming      CAR 240724
.           Mods for MRT Hospital/Location - add Hospitals, change Keys on MRT
.           Tables. Mods to 
. V10.02.03 10/06/2011  Ebon Clements CAR 239530
.           Added print extra contact functionality
. V10.02.02 11/05/2011  Mike Laming   CAR 240707
.           Added "Movement Comment" MRHICOMM (MRTME018) - plus MRTHISFD change
. V10.02.01 04/04/2011  Jill Parkinson    CAR 239574
.           Removed open of ibaprntf
. V10.01.01 06/01/2011  Jill Parkinson    CAR 233088
.           Mods to print PMVXFNDM instead of AFNDMM                    
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.01  17/12/2009  Peter McMullen CAR 210130
.           Convert to newer Dr name format routine DOCNM000
. V9.09.06  22/02/2008  Ebon Clements  CAR 162091
.           Added homeloct default to HHMLOC00
. V9.09.03  18/02/2008  Ebon Clements  CAR 161653
.           Changed size of DFLTHLOC from DIM 3 to DIM 4
. V9.09.02  15/01/2008  Ebon Clements  CAR 157822
.           Added web user default of mrt document type - SING0200
. V9.09.01  19/11/2007  Ebon Clements  CAR 150855
.           Added cross campus medical record tracking functionality
. V9.08.03  07/06/2007  Mike Laming    CAR 125736
.           Added functionality for Address Line 4 for all Doctor types at
.           MRPRN000 - varibles also added to Stationery Type 43               
. V9.08.02  08/03/2007  Peter Vela     CAR 128233
.           Added functionality for Discharge Summary Request
.           Added Stationery Template Type 43 - Dis Sum Req / Incomplete Dis
. V9.08.01  25/01/2007  Peter Vela     CAR 127930
.           Added MRMADTCR MRMATMCR before WRTMAS1
. V9.06.02  01/06/2006  Davin        CAR 106952
.           Changed to not default any medical record destination (locsel00)
. V9.06.01  31/05/2006  Prasad kvkg  CAR 106952
.           Fixed Default Home Location for Multi Hospital - HOMLOC00
. V9.05.02  17/03/2006  Ebon Clements CAR 89155
.           Mods for multi hospital medical record locations
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 20/02/2006  Ebon Clements     CAR 73880
.           Mods to movement reason maintenance borrowing period
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.03  08/08/2005  Davin                    CAR 58644
.           Post discharge tracking (savloc00) - Write user id associated with 
.           MRT security number to mrthis (kids)
. V9.04.02  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.01  17/09/2004  Guomin Fu     CAR 51445
.           Added in GTPEX000 to check PTCNRQCF for whether to use
.           staff code or free format for requester. If set to using free format
.           then allows ext.no and pager no. to be displayed even requester
.           field is empty.
. V9.03.16  27/07/2004  Peter Vela    CAR 51682
.           Removed error message SAVMVE93
.           "Can't move to a home location other than it's own."
. V9.03.15  30/06/2004  Ebon Clements CAR 51222                       
.           Fixed I * D on  medical record history file writes
. V9.03.14  28/06/2004  Ebon Clements CAR 51144                       
.           Changed DISDC000 to use visit file key 4 to find inpatient visits
. V9.03.13  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.12  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.11  07/06/2004 Ebon Clements             CAR 50499
.           Changed MOVREC30 to write post discharge details to MRTPDSFD for
.           the last discharged or current inpatient visit.
. V9.03.10  31/05/2004 Ebon Clements             CAR 50296
.           Now only checking Home Location (HOMELOCT) in HIHVOL00 & GETHIH00 if
.           it is not blank.
. V9.03.09  06/05/2004 Pat Dirito                CAR 49620
.           Now not only checking Home Location (HOMELOCT) in MRSING00 if
.           it is not blank.
.           20/04/2004 Henry Son                 CAR 44792
.           Display Extension and Pager in Movement History.
. V9.03.08  15/04/2004 Ebon Clements             CAR 49006
.           Added check for blank security numbers in CHKSEC00
. V9.03.07  30/03/2004 Ebon Clements             CAR 48433
.           Added clear of MRHIDDUE in CALDUE00
.           26/03/2004 Peter Vela                CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.06  04/03/2004  Davin                    CAR 34825
.           Added option 6 (CHKSEC00) to validate MRT security number
.           Write user id associated with MRT security number to mrthis (kids)
.           09/03/2004 Jill Habasque             CAR 43608
.           Added homeloct
. V9.03.05  25/02/2004 Peter Vela                CAR 43134
.           Added tag for MRCNWNHL - Parameter for Home Location Warning Msg
. V9.03.04  18/12/2003 Peter Vela                CAR 43134
.           Recompiled for MRTCONFD
. V9.03.03  05/11/2003 Pat Dirito                CAR 44627
.           Added check for active indicator on Movement Reason selection
.           lists. Routines - REASEL00 & SING0500
. V9.03.02  11/09/2003 Pat Dirito                CAR 43132
.           Added PTCNRQCF - Free Format for Requested By             
. V9.03.01  12/08/2003 Sylvek Litewka            CAR 41293
.           Removed WEBSCHFD and WEBSCHIO. These are now included in 
.           IBAWEBDF.PBL and IBAWEBCD.PBL.
.------------------------------------------------------------------------------
. V9.02.30  12/12/2002 Pat Dirito                SRF 34349
.           Removed usauge of MRCNSTAT for Medical Records 
.           08/07/2002 Mike Laming              
.           Add call to DataGate to Single Record Movements
. V9.02.29  28/06/2002 Ebon Clements             SRF 19104
.           Recompiled for sigpipe 
. V9.02.28  24/06/2002 Pat Dirito                SRF 18908
.           LOCSEL00 now checking for Active Records                           
. V9.02.27  14/06/2002 Pat Dirito                SRF 18637
.           Now deleting all movements after selected movement date - SAVMVE00.
. V9.02.26  21/03/2002 Pat Dirito
.           I * D on WRMRPDS1 removed REP of Date before write.
. V9.02.25  12/03/2002 Pat Dirito  
.           Added blank option output in DISTAT00
. V9.02.24  04/03/2002 Pat Dirito  
.           Included MrtLocations() - Location Selection javascript in 
.           RECRW000 so page loads faster.
. V9.02.23  15/02/2002 Bronko Sosic
.           SAVMVE00 now updates MRMALOC with most current history location
. V9.02.22  01/02.2002 Pat Dirito
.           SAVMVE00 was using DAYSEP incorrectly
. V9.02.21  31/01/2002 Bronko Sosic                    
.           changed Person responsible in Post disc tracking to drop down list
.           STALST00
. V9.02.20  30/01/2002 Pat Dirito                      
.           MEDRECKY was not being passed back into the server for Single  
.           Record Movement, so was moving incorrect information! 
. V9.02.19  23/01/2002 Pat Dirito                      
.           SAVMVE00 was causing an I*U and I*P Now fixed, was reading with
.           RDMRMAS2 & updatting with UPMRMAS1 
. V9.02.18  22/01/2002 Pat Dirito                      
.           Added more concise and descriptive error messages to routine 
.           CHKMOV00 & Cleaned up alot of the code in SAVMVE00
. V9.02.17  11/01/2002 Ebon Clements                   
.           Added new field to post discharge tracking - MRPDRMOR
. V9.02.16  27/12/2001 Pat Dirito                      
.           Now clearing SAVKEYMR in CLRPAR00 
. V9.02.15  18/12/2001 Pat Dirito                      
.           Converted CKINTN00 into remote scripting routine CHKMOV00
.           Also recompiled for PATMSXTM
. V9.02.14  17/12/2001 Pat Dirito                      
.           Set warning messages in CKINTN00 called from PSTTRK00 
. V9.02.13  14/12/2001 Pat Dirito                      
.           Changes RECDC000 now using parameter to output different table
.           displays.
. V9.02.12  08/12/2001 Pat Dirito                      
.           Added TABLEFLG which sets various row outputs for routine RECDC000 
. V9.02.11  05/12/2001 Bronko Sosic                           
.           Changed Post Discharge Table              
. V9.02.10  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.09  17.11.2001 Ebon Clements
.           Post Discharge Table defaults ticked to the latest volume only
. V9.02.08  18.10.2001 Pat Dirito   
.           Post Discharge Table now outputing latest admission first.
. V9.02.07  17.10.2001 Ebon Clements
.           Recompiled for PATCODFD
. V9.02.06  15.10.2001 Pat Dirito
.           Modified HIHVOL00 & GETHIH00 to get Volumen No by Document Type
. V9.02.05  08.10.2001 Pat Dirito
.           Program was never saving Web-Userid corectly. Was saving desc
.           into a DIM6(MRTME006) should be saving Web-Userid into MRTME015
.           Now Fixed
. V9.02.04  14.09.2001  Mike Laming   RCH/SVHM
.           Activate Datagate API as below (V9.02.01)          
. V9.02.03  13.09.2001  J.Tan
.           Mods to change error message if no record movement.
. V9.02.02  08.09.2001  Sandra BarchamRCH/SVHM
.           Removed Datagate API for Medical Records Movement (DGCLICRM)       
. V9.02.01  30/08/2001  Mike Laming   RCH/SVHM
.           Add Datagate API for Medical Records Movement (DGCLICRM)       
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.001 14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B05 13.07.2001 Sandra Barcham
.           Replaced GP with HCP
. V9.00.B04 29.06.2001 B.G.Ackland
.           Recompile for Changes to WEBSCHFD
. V9.00.B03 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B02 24.05.2001 Ebon Clements 
.           Added warning messagee if movement date is 
.           before the last movement date
.--------------------------------------------------------
.                 V5.09.01 08.02.2001 Bronko sosic
.                          Added Option 2 - Delete Record Movement
.                 V5.09.00 23.01.2001 Pat Dirito  
.                          Created Program                                      
.                    
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       RSHWEBDF
.
          INC       APSMASFD/INC
          INC       IBALPCFD/INC
          INC       IBATMDFD/INC
          INC       MLTSECFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PMSCCDFD/INC
          INC       PATMMBFD/INC
          INC       PMSCEXFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSIHIFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       PMSDUNFD/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PATVADFD/INC
          INC       PATDADFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDGWFD/INC
          INC       PATALRFD/INC   
          INC       PATASFFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
.
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATRE1FD/INC
          INC       OUTSITFD/INC   * Outpatients - Site Codes File
          INC       PATFN1FD/INC   * Health Fund File
          INC       PATGO1FD/INC
          INC       PATICDFD/INC
          INC       PATIN1FD/INC   * Insurance File
          INC       PATITMFD/INC
          INC       PATPR1FD/INC   * New Patient Master File
          INC       PATWR1FD/INC
          INC       PATHSPFD/INC   * Hospital Details File
          INC       PATECDFD/INC
.
          INC       MRTCONFD/INC
          INC       MRTDSRFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMOVFD/INC
          INC       MRTPDSFD/INC
          INC       MRTPSHFD/INC
          INC       MRTHISFD/INC
          INC       MRTSTFFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       VARGBCRN/INC
          INC       PATMISTD/INC
.
.---------------------------------------------------------------------------
.  CGI Variables
.---------------------------------------------------------------------------
DAYSDIFF  FORM      2     
DEFTMOVE  DIM       1       * Default move
FRHOSPLV  DIM       1       * Come From hospital level
DESTHOSP  DIM       3
DISPRMOR  FORM      1       * Display flag for post discharge tracking
DISPDSRQ  FORM      1       * Display for Discharge Summary Request
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
CATTC     INIT      "tc"
CATTY     INIT      "TY"
CONTTYPE  DIM       1
CURRDATE  DIM       8       * Current Date
DOCTCODE  DIM       6       * Doctor Code
VOLUMENO  DIM       2       * Volume Number
MBSDESC   DIM       40
DIM8      DIM       8
DIM80     DIM       80
CHECKFLG  DIM       7
MRTMS005  DIM       20      * Comments
MRTMS007  DIM       25      * MicroFile Address
.
MRTMASKY  DIM       20[99]  * Array of MRTMASFD keys                  *C-240724
MOVINGRC  DIM       1[99]   * Array of Moving Indicators
NEWLOCAT  DIM       4[99]   * Array of New Locations     
NEWHOSPT  DIM       3[99]   * Array of New Hospitals    
MOVEREAS  DIM       4[99]   * Array of Movement Reasons  
PERRESPN  DIM       35[99]  * Array of Persons Responsible
ADMISSKY  DIM       8[99]   * Array of Admission No's
DISTATUS  DIM       3[99]   * Array of Discharges Status
DISTRMOR  DIM       3[99]   * Array of Discharges RMO responsible
FILREQED  DIM       1       * Filing Required
VALDCODE  DIM       70      * Validation Code
LOCATION  DIM       4       * Record Location
VALDTYPE  FORM      1       * Validation Type 1,Disease 2,Operation
.
DFLTHLOC  DIM       4       * Dummy Variable for Default Home Location
DFLTHHOS  DIM       3       * Dummy Variable for Default Home Hospital
PRNTSTRT  FORM      3
.
VALDMRTS  DIM       8       * Validate MRT security number
MRTSECID  DIM       10      * MRT security number User ID
MRTSECNO  DIM       8       * MRT security number
.
MVTOFLAG  FORM      1
FROMFLAG  FORM      1
.                                                                     *C-240724
MEDRECKY  DIM       20      * Full Medical Record Key - Index 1 on MRTMASFD
.
MRTRQ001  DIM       8       * From Date
MRTRQ002  DIM       8       * To Date
MRTRQ003  DIM       3       * Document Type
MRTRQ004  DIM       4       * Destination Location 
MRTRQ005  DIM       4       * Destination Location Hospital
.
MRTME001  DIM       8       * Date of Movement
MRTME002  DIM       8       * Time of Movement
MRTME003  DIM       4       * Destination of Location
MRTME004  DIM       6       * Reciver of Record
MRTME005  DIM       4       * Reasion of Movement
MRTME006  DIM       6       * Operator
MRTME007  DIM       8       * Due Date
MRTME008  DIM       1       * Status 1=Out 2=In
MRTME009  DIM       2       * Lock Feild Variable
MRTME010  DIM       3       * Document Type
MRTME011  DIM       2       * Volume Number
MRTME012  DIM       3       * Post discharge Header Current status
MRTME013  DIM       20      * Extention Number
MRTME014  DIM       20      * Pager Number
MRTME015  DIM       10      * Web UserID
MRTME016  DIM       35      * Requested By
MRTME017  DIM       4       * Home Location
MRTME018  DIM       50      * Movement Comments                       *I-240724
MRTME019  DIM       3       * Destination of Hospital (see MRTME003)  *I-240724
MRTME020  DIM       3       * MR Home Hospital ID     (see MRTME017)  *I-240724
.
MRTDS001  DIM       8       * Visit Number
MRTDS002  DIM       3       * Unique Counter
MRTDS003  DIM       8       * Date of Request
MRTDS004  DIM       10      * Consultant
MRTDS005  DIM       3       * Letter Sent
MRTDS006  DIM       100     * Comments 1
MRTDS007  DIM       100     * Comments 2
MRTDS008  DIM       100     * Comments 3
MRTDS009  DIM       100     * Comments 4
MRTDS010  DIM       100     * Comments 5
MRTDS011  DIM       1       * Print Indicator
MRTDS012  DIM       3       * Printer
MRTDS013  DIM       6       * Stationery Code
.
STATDESC  DIM       50      * Status long description (Cat CP) 
STATDATE  DIM       11      * Status date
CPDESC    DIM       20      * Cat CP description
.---------------------------------------------------------------------------
.  Variables
.---------------------------------------------------------------------------
.
ADMDATE   DIM       11
ADDRLN    DIM       57
ADOCDESC  DIM       22
CLMDET1   DIM       50
CLMDET2   DIM       50
CURRROW   FORM      3
DIM3      DIM       3
DIM5      DIM       5
DIM11     DIM       11
DIM20     DIM       20
DISDATE   DIM       11
DISPDOC   DIM       25
DISPRECN  DIM       30
DISPRECS  DIM       11
DSMOKE    DIM       3
DALERG    DIM       3
FORM5     FORM      5
LASTITEM  FORM      2       * Last Array Item 
LASTADMN  FORM      2       * Last Array Item 
MISSINGD  DIM       1[99][7]  * Array of Missing Details
DOCTORCD  DIM       6[99]   * Array of Doctor Codes 
DOBDATE   DIM       11
CURRLOCA  DIM       60
COUNT     FORM      2 
COUNTER   FORM      3 
EXTNTXT   INIT      "<br>Ext: "        * extention break text          *I-44792
FORM8     FORM      8       * Form of 8
FMTAGE    DIM       10
FMTSEX    DIM       8
FMTYRS    INIT      " yrs"
FMTMTHS   INIT      " mths"
FMTWKS    INIT      " wks"
FMTDAYS   INIT      " days"
HISFLAG   FORM      1
HDOCDESC  DIM       22
HLOCDSC1  DIM       60
LASTVIST  DIM       8
LASTROW   FORM      3
LASTVDAT  DIM       11
LASTVTYP  DIM       15
.
MBIRURNO  DIM       8
MBIRTYOR  DIM       24
.
NETTOT    FORM      6.2
PAGERTXT  INIT      "<br>Pager: "      * page break text               *I-44792
PRESDETS  DIM       100     * Person Responsible details               *I-44792
PSAGECON  DIM       3
PSAGETYP  DIM       3
RECSTAT1  INIT      "In Transit"
RECSTAT2  INIT      "Received"
RECSTAT3  INIT      "Sent Direct"
SELHOSP   DIM       3                                                 *I-240724
SUPERLEV  DIM       1                                                 *I-240724
SAVKEY3A  DIM       3
SAVKEY3B  DIM       3
SAVKEY08  DIM       8
SAVVOL    FORM      2
TABLEFLG  FORM      1
HIGHEST   FORM      2
STATUS    DIM       30
STAFFKEY  DIM       6
VOLFLAG   FORM      1       * Volume No flag
VTYPFLAG  FORM      1       * Last Visit Type Required 1=Discharged Inpatient
MRVSFLAG  DIM       1
.
DOCMTYPE  DIM       3       * Document Type
HOMEHOSP  DIM       3       * Home hospital                           *I-240724
HOMELOCT  DIM       4       * Home location
REASONMV  DIM       4       * Reasion of Movement
MEDHISKY  DIM       10     
FORMVOLN  FORM      2
ROWNUM    FORM      2                                                 *I-259379
HOSKEY    DIM       3                                                 *I-240724
IHINUMBR  DIM       20
LOCKEY    DIM       4
RTYKEY    DIM       3
VOLKEY    DIM       2
JUSTNO    FORM      2                       * Right justification amount
LJUSCODE  DIM       70                      * Left justified code
RJUSCODE  DIM       70                      * Right justified code
EPISODET  DIM       8       * Episode type
CHRCOUNT  FORM      1       * Count
STATNCOD  DIM       6                       * Stationery code
VARIABLE  DIM       127
XAGE      DIM       3
XWKAGE    DIM       2
.
CODEA     INIT      "A "
CODEAC    INIT      "AC"
CODEBT    INIT      "BT"
CODEC     INIT      "C "
CODECC    INIT      "CC"
CODECL    INIT      "CL"
CODED     INIT      "D "
CODEDD    INIT      "DD"
CODED1    INIT      "D1"
CODED2    INIT      "D2"
CODED3    INIT      "D3"
CODED4    INIT      "D4"
CODED5    INIT      "D5"
CODER     INIT      "R "
CODEU2    INIT      "U2"
CODEU3    INIT      "U3"
CODEU4    INIT      "U4"
CODEU5    INIT      "U5"
CODEU6    INIT      "U6"
CODEU7    INIT      "U7"
CODECP    INIT      "CP"
CODEM     INIT      "M "
CODEMO    INIT      "MO"
CODEP     INIT      "P "
CODEP1    INIT      "P1"
CODEP2    INIT      "P2"
CODEP3    INIT      "P3"
CODEP4    INIT      "P4"
CODEP5    INIT      "P5"
CODEP6    INIT      "P6"
CODES     INIT      "S "
CODEU1    INIT      "U1"
OBB       INIT      "("
CBB       INIT      ")"
OBR       INIT      "<font color=red>("
CBR       INIT      ")</font>"
VT1       INIT      "Emergency"
VT2       INIT      "Outpatient"
VT3       INIT      "Inpatient"
VT4       INIT      "Other Financial"
VT5       INIT      "Day Centre"
VT6       INIT      "Community"
VT7       INIT      "Ward Attendee"
VT8       INIT      "Adhoc Attendee"
ZERO4     INIT      "0000"
.---------------------------------------------------------------------------
PRGID     INIT      "MRTWEB04"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Medical Record Post Discharge Tracking"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
MAIN1010  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PSTTRK00        * Medical Records Post Discharge Tracking
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      MRTRQD00        * Medical Records Request Cancel         
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      CHKMED00        * Get Record ID information
          GOTO      MAIN1000
.
MAIN1400  CALL      MRTLOC00        * Medical Record Remote Scripting
          GOTO      MAIN1000
.
MAIN1500  CALL      MRSING00        * Medical Records Single Request         
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
.          CALL      WEBERR00
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      CHKSEC00        * check mrt security number
          GOTO      MAIN1000
.
MAIN1700  CALL      DSRQ0000        * Discharge Summary Request
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      PDSHIS00        * Post Discharge Status History
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------
. Format sex
.------------------------------------------------------------
FMTSEX00  MOVE      SP8,FMTSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,FMTSEX
.* ******************************************   End of Changes         *C-49016
.
FMTSEX99  RETURN
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
FMTAGE00  MATCH     "y",PSAGETYP
          GOTO      FMTAGE10 IF NOT EQUAL
          PACK      FMTAGE,PSAGEYRS,FMTYRS,SP70
          GOTO      FMTAGE99
.
FMTAGE10  MATCH     "d",PSAGETYP
          GOTO      FMTAGE20 IF NOT EQUAL
          PACK      FMTAGE,PSAGEDAY,FMTDAYS,SP70
          GOTO      FMTAGE99
.
FMTAGE20  MATCH     "m",PSAGETYP
          GOTO      FMTAGE30 IF NOT EQUAL
          PACK      FMTAGE,PSAGEMNT,FMTMTHS,SP70
          GOTO      FMTAGE99
.
FMTAGE30  MATCH     "w",PSAGETYP
          GOTO      FMTAGE99 IF NOT EQUAL
          PACK      FMTAGE,PSAGEWKS,FMTWKS,SP70
.
FMTAGE99  RETURN
.------------------------------------------------------------
. Check Record ID Information
.   Required  - VALDCODE
.             - VALDTYPE (1.Ur Info 2.Validate Record Movement)
.------------------------------------------------------------
CHKMED00  BRANCH    VALDTYPE,CHKMED10,CHKMED20,CHKMED30
          GOTO      CHKMED91
.
CHKMED10  MOVE      ONE,VTYPFLAG
          CALL      VALPUR00     * Validate UR Info
          GOTO      CHKMED99
.
CHKMED20  CALL      CHKMOV00     * Validate Medical Record Movement
          GOTO      CHKMED99
.
CHKMED30  CALL      CHKMVN00     * Validate Medical Record Movement
          GOTO      CHKMED99     * Will call CHKMOV00 if not NZ
.
CHKMED91  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Validation Type":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKMED99
.
CHKMED99  RETURN
.
.------------------------------------------------------------
. Medical record remote scripting
.------------------------------------------------------------
MRTLOC00  CALL      XMLHED00
          BRANCH    EXIT,MRTLOC99
.
          MATCH     "1",UPDTTYPE
          GOTO      MRTLOC10 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      MRTLOC90
.
MRTLOC10  CALL      LOCTYP00           * Check location type
          GOTO      MRTLOC90
.
MRTLOC90  CALL      XMLEND00
MRTLOC99  RETURN
+
.------------------------------------------------------------
. MRT Location type
.------------------------------------------------------------
LOCTYP00  PACK      KEY7,DESTHOSP,LOCATION
          CALL      RDMRLOC1
          BRANCH    OVRCD,LOCTYP99
.
          UNPACK    SP70,KEY15,KEY25,TCINDC2
          MATCH     SP70,MRLOTYPE
          GOTO      LOCTYP80 IF EQUAL
.
          PACK      KEY5,ANSL,ANST,MRLOTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,LOCTYP80
.
          PACK      KEY20,URNUMBER,HOMEHOSP,HOMELOCT,DOCMTYPE,VOLUMENO,SP70
          CALL      RDMRMAS1
          IF        OVRCD=1
            UNPACK    SP70,MRMACOMM,MRMAFILM
          ENDIF
.
          MATCH     "V",TCINDC2
          IF        @EQUAL
            MOVE      "Volume Comments",KEY15
            PACK      KEY25,MRMACOMM,SP70
          ENDIF
          MATCH     "M",TCINDC2
          IF        @EQUAL
            MOVE      "Microfilm      ",KEY15
            PACK      KEY25,MRMAFILM,SP70
          ENDIF
.
LOCTYP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY15,"|",TCINDC2,"|",KEY25:
                             "</RETURN_VALUE>"
LOCTYP99  RETURN
+
.------------------------------------------------------------
. Check MRT Security Number
.   Required  - VALDMRTS (security number entered)
.------------------------------------------------------------
CHKSEC00  CALL      XMLHED00
          BRANCH    EXIT,CHKSEC99
.
          PACK      VALDMRTS,VALDMRTS,SP70
.
          MATCH     SP70,VALDMRTS           * MRT sec number is mandatory
          GOTO      CHKSEC90 IF EQUAL
.
          PACK      KEY18,VALDMRTS,SP70
          CALL      RSWBSE5
CHKSEC10  CALL      RKWBSE5
          BRANCH    OVRCD,CHKSEC90
.
          MATCH     VALDMRTS,WBSEMRTS
          GOTO      CHKSEC10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             WBSEUID:
                             "</RETURN_VALUE>"
          GOTO      CHKSEC10
.
CHKSEC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid MRT number entered.":
                             "</RETURN_VALUE>"
.
CHKSEC98  CALL      XMLEND00
CHKSEC99  RETURN
+
.------------------------------------------------------------
.                    Validate Record Movement
. Check if record is moving to or from an Internal Loaction or between
. Internal Locations, only if Filing Required (FILREQED) is ticked!
. Required : VALDCODE, LOCATION
.------------------------------------------------------------
CHKMOV00  CALL      XMLHED00
          BRANCH    EXIT,CHKMOV99
.
          MOVE      ZERO,FROMFLAG
          MOVE      ZERO,MVTOFLAG
.
          PACK      KEY20,VALDCODE,SP70                               *C-240724
          CALL      RDMRMAS1           * Read for current location 
          BRANCH    OVRCD,CHKMOV90
.
          PACK      KEY7,MRMACHOS,MRMACLOC,SP70                       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CHKMOV91
.
          MATCH     "1",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,FROMFLAG  * Moving from an Internal Location 
          ENDIF 
.
          PACK      KEY7,DESTHOSP,LOCATION,SP70  * New Location       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CHKMOV92
.
          MATCH     "1",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MVTOFLAG  * Moving to an Internal Location
          ENDIF 
.
          IF        FROMFLAG=1 & MVTOFLAG=1
            MOVE      THREE,MVTOFLAG    * Between Internal Locations
            GOTO      CHKMOV10
          ENDIF
.
          IF        FROMFLAG=1
            MOVE      TWO,MVTOFLAG      * From an Internal Location
            GOTO      CHKMOV10
          ENDIF
.
          IF        MVTOFLAG=1
            MOVE      ONE,MVTOFLAG      * To an Internal Location
            GOTO      CHKMOV10
          ENDIF
.
CHKMOV10  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MVTOFLAG:
                             "</RETURN_VALUE>"
.                             
          GOTO      CHKMOV98
.
CHKMOV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No Medical Record Details found for this ":
                             "Patient!":
                             "</RETURN_VALUE>"
          GOTO      CHKMOV98
.
CHKMOV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Current Location - Not on File!":
                             "</RETURN_VALUE>"
          GOTO      CHKMOV98
.
CHKMOV92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Dest Location - Not on File!":
                             "</RETURN_VALUE>"
          GOTO      CHKMOV98
.
CHKMOV98  CALL      XMLEND00
CHKMOV99  RETURN
+
.-----------------------------------------------------------------
. Check uncoded discharged admission, if any admission has category
. P and indictaor 7 <> 'R', Return 1. Otherwise return 0
. Required : VALDCODE, LOCATION
.------------------------------------------------------------------
CHKMVN00  COMPARE   ONE,PTCNHDPS                * PTCNHDPS = 1 (NZ)
          IF        !@EQUAL
            CALL      CHKMOV00
            GOTO      CHKMVN99
          ENDIF
.
          CALL      XMLHED00
          BRANCH    EXIT,CHKMVN99
.
CHKMVN02  MOVE      ZERO,MVTOFLAG
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70          * Re read logged in user to
            CALL      RDWBSE1                    * get hospital
            BRANCH    OVRCD,CHKMVN98
          ENDIF
.
          PACK      KEY20,VALDCODE,SP70
          CALL      RDMRMAS1           * Read for current location
          BRANCH    OVRCD,CHKMVN90
.
          PACK      KEY7,MRMACHOS,MRMACLOC,SP70
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CHKMVN91
.
          PACK      KEY7,DESTHOSP,LOCATION,SP70  * New Location
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CHKMVN92
.
          MOVE      VALDCODE,SAVKEY08
          PACK      KEY24,SAVKEY08,SP70
          CALL      RDSDSCH3
CHKMVN20  CALL      RDKDSCH3
          BRANCH    OVRCD,CHKMVN80    * must have discharged visits
.
          MATCH     SAVKEY08,DURNO
          GOTO      CHKMVN80 IF NOT EQUAL   * same u/r?
.
          IF        IBCNMHOS=1
            PACK      KEY8,DDADMNO,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,CHKMVN20
.
            MATCH     WBSEHOSP,PMVXMHOS        * same as user log on hospital
            GOTO      CHKMVN20 IF NOT EQUAL
          ENDIF
.
          PACK      KEY13,DDADMNO,SP70
          CALL      RSPTECD1
CHKMVN30  CALL      RKPTECD1
          BRANCH    OVRCD,CHKMVN50
.
          MATCH     DDADMNO,DPTEDADM       * same Admission ?
          GOTO      CHKMVN50 IF NOT EQUAL
.
          GOTO      CHKMVN20
.
CHKMVN50  PACK      KEY8,DDADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKMVN70
.
          PACK      KEY5,ANSP,SP1,ACLSS
          CALL      RDCODE1
          BRANCH    OVRCD,CHKMVN70
.
          MATCH     ANSR,TCINDC7
          GOTO      CHKMVN20 IF EQUAL        * No warning is needed
.
CHKMVN70  MOVE      ONE,MVTOFLAG
.
CHKMVN80  MOVE      SP70,TDESC
          MOVE      "DD",CATEGORY
          MOVE      DDEST,CODE
          CALL      GETCOD00
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MVTOFLAG,"|",DDADMNO,"|",TDESC,"|",DIM11:
                             "</RETURN_VALUE>"
.
          GOTO      CHKMVN98
.
CHKMVN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No Medical Record Details found for this ":
                             "Patient!":
                             "</RETURN_VALUE>"
          GOTO      CHKMVN98
.
CHKMVN91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Current Location - Not on File!":
                             "</RETURN_VALUE>"
          GOTO      CHKMVN98
.
CHKMVN92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Dest Location - Not on File!":
                             "</RETURN_VALUE>"
          GOTO      CHKMVN98
.
CHKMVN98  CALL      XMLEND00
CHKMVN99  RETURN
.
.------------------------------------------------------------
. Validate Patient U/R
.------------------------------------------------------------
VALPUR00  CALL      XMLHED00
          BRANCH    EXIT,VALPUR99
.
          MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALPUR90
.
          COMPARE   ONE,PSTAT
          GOTO      VALPUR60 IF NOT EQUAL
.
VALPUR50  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
          BRANCH    PSTAT,VALPUR50   * Another associated U/R number
.
VALPUR60  CALL      GETVIS00
          CALL      PATNAA00
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      FMTAGE00      * Format age
          CALL      FMTSEX00      * Format Sex
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DOBDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      GETVOL00   * Get Current Volume No.                 
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",FMTSEX,"|",DOBDATE,"|",PCEASE,"|":
                             PURNO,"|",LASTVIST,"|",LASTVDAT,"|",LASTVTYP,"|":
                             FMTAGE,"|",VOLFLAG,"|",SAVVOL:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient UR - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR98  CALL      XMLEND00
VALPUR99  RETURN
.------------------------------------------------------------
. Get Last Visit
.------------------------------------------------------------
GETVIS00  PACK      KEY24,PURNO,Z70
          MOVE      SP70,LASTVIST
          MOVE      SP70,LASTVDAT
          MOVE      SP70,LASTVTYP
          CALL      RDSVISA2
GETVIS10  CALL      RDPVISA2
          BRANCH    OVRCD,GETVIS99
          MATCH     PURNO,PVIURNO
          GOTO      GETVIS99 IF NOT EQUAL
          BRANCH    VTYPFLAG,GETVIS15
          GOTO      GETVIS90
.
GETVIS15  PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GETVIS10
.
          IF        IBCNMHOS <> 1
            GOTO      GETVIS60
          ENDIF
.
. Centralised coding
.
          MATCH     "1",MRCNCCOD               * Using centralise coding
          GOTO      GETVIS50 IF EQUAL
.
          PACK      KEY10,USERID,SP70          * Re read logged in user to
          CALL      RDWBSE1                    * get hospital
.
          MATCH     WBSEHOSP,PMVXMHOS          * same as user log on hospital
          GOTO      GETVIS10 IF NOT EQUAL
          GOTO      GETVIS60
.
GETVIS50  PACK      KEY13,USERID,SP70              * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
            CALL      RDMLSEC1
            GOTO      GETVIS10 IF NOT EQUAL
          ENDIF
.
GETVIS60  COMPARE   "3",PVITYPE
          GOTO      GETVIS10 IF NOT EQUAL
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIS10
          COMPARE   "3",ASTAT
          GOTO      GETVIS10 IF NOT EQUAL
          GOTO      GETVIS90
.
GETVIS90  MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
GETVIS99  RETURN
.------------------------------------------------------------
. Get Last/Current Volume No.        
.-------------------------------------------------------------------------------
GETVOL00  MOVE      ZERO,VOLFLAG 
          MOVE      ZERO,SAVVOL
.
          PACK      KEY20,VALDCODE,SP70                               *C-240724
          CALL      RSMRMAS3
GETVOL10  CALL      RKMRMAS3
          BRANCH    OVRCD,GETVOL99
.
          MATCH     VALDCODE,MRMAURNO
          GOTO      GETVOL99 IF NOT EQUAL
.
          MATCH     MRMADOTY,MRCNRCTY
          GOTO      GETVOL10 IF NOT EQUAL
.
          IF        MRMAVOLN <= SAVVOL
            GOTO      GETVOL10
          ENDIF

          MOVE      MRMAVOLN,SAVVOL
          MOVE      ONE,VOLFLAG
          GOTO      GETVOL10
.
GETVOL99  RETURN 
.------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSDUNA1,"pmsdunaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSRELA2,"pmsrelaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATGO1A1,"patgo1af"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      MRTDSRA1,"mrtdsraf"
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      MRTSTFA1,"mrtstfaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTMASA3,"mrtmasaf"
          OPEN      MRTMASA4,"mrtmasaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTPDSA1,"mrtpdsaf"
          OPEN      MRTPSHA1,"mrtpshaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      WEBSECA5,"websecaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCMCA1,"patcmcaf" 
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATITEM1,"patitemn"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PATECDA1,"patecdaf"
.
          READ      CONTROLF,SIXTY;*79,MRCNLAYT,*84,MRCNHLOC,*88,MRCNRCTY:
                                   *105,MRCNHMTY,*108,MRCNSTAT,*114,MRCNFUTD:
                                    HTNUMDAY,*131,MRCNCHGL,*148,MRCNWNHL
          READ      CONTROLF,FIFTY9;*193,PTCNRQCF
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,NINTY7;*176,MRCNTREC,*180,MRCNCCOD,*248,MRCNEACA
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      MLTSECA1,"mltsecaf"
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"    * IHI Details
          ENDIF
.
INIT9999  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,VOLUMENO
          MOVE      SP70,FILREQED
          MOVE      SP70,MEDRECKY
          MOVE      SP70,MRTSECID
          MOVE      SP70,MRTSECNO
          MOVE      SP70,DESTHOSP
          MOVE      SP70,DEFTMOVE
          MOVE      SP70,FRHOSPLV
          MOVE      SP70,SUPERLEV
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      SP70,MRTMASKY[COUNTER]
            MOVE      SP70,MOVINGRC[COUNTER] 
            MOVE      SP70,NEWLOCAT[COUNTER]
            MOVE      SP70,NEWHOSPT[COUNTER]                          *I-240724
            MOVE      SP70,MOVEREAS[COUNTER] 
            MOVE      SP70,ADMISSKY[COUNTER]   
            MOVE      SP70,DISTATUS[COUNTER]  
            MOVE      SP70,DOCTORCD[COUNTER] 
            MOVE      SP70,PERRESPN[COUNTER] 
            MOVE      SP70,DISTRMOR[COUNTER] 
            ADD       ONE,COUNTER
          DO
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      ONE,COUNT
            WHILE     COUNT <= 7
              MOVE      SP70,MISSINGD[COUNTER][COUNT] 
              ADD       ONE,COUNT
            DO
            ADD       ONE,COUNTER
          DO
.
          MOVE      SP70,MRTRQ001  
          MOVE      SP70,MRTRQ002  
          MOVE      SP70,MRTRQ003  
          MOVE      SP70,MRTRQ004  
          MOVE      SP70,MRTRQ005  
.
          MOVE      SP70,DOCMTYPE
          MOVE      SP70,HOMEHOSP                                     *I-240724
          MOVE      SP70,HOMELOCT
          MOVE      SP70,REASONMV
.
          MOVE      SP70,MRTME001
          MOVE      SP70,MRTME002
          MOVE      SP70,MRTME003
          MOVE      SP70,MRTME004
          MOVE      SP70,MRTME005
          MOVE      SP70,MRTME006
          MOVE      SP70,MRTME007
          MOVE      SP70,MRTME008
          MOVE      SP70,MRTME009
          MOVE      SP70,MRTME010
          MOVE      SP70,MRTME011
          MOVE      SP70,MRTME012
          MOVE      SP70,MRTME013
          MOVE      SP70,MRTME014
          MOVE      SP70,MRTME015
          MOVE      SP70,MRTME016
          MOVE      SP70,MRTME017
          MOVE      SP70,MRTME018
          MOVE      SP70,MRTME019
          MOVE      SP70,MRTME020
.
          MOVE      Z70,MRTDS001
          MOVE      Z70,MRTDS002
          MOVE      Z70,MRTDS003
          MOVE      Z70,MRTDS004
          MOVE      Z70,MRTDS005
          MOVE      Z70,MRTDS006
          MOVE      Z70,MRTDS007
          MOVE      Z70,MRTDS008
          MOVE      Z70,MRTDS009
          MOVE      Z70,MRTDS010
          MOVE      Z70,MRTDS011
          MOVE      Z70,MRTDS012
          MOVE      Z70,MRTDS013
.
          MOVE      SP70,MRTMS005
          MOVE      SP70,MRTMS007
.
CLRPAR99  RETURN
.--------------------------------------------------------------------------
. Set Parameters
.--------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docmtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homehosp=",QRYNAME                               *I-240724
          IF        @EQUAL
            MOVE      QRYDATA,HOMEHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "homeloct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOMELOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasonmv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASONMV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "volumeno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VOLUMENO
            RESET     VOLUMENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "location=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LOCATION
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filreqed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILREQED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrecky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRECKY
            PACK      MEDRECKY,MEDRECKY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtsecid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECID
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "mrtsecno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTSECNO
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "valdmrts=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDMRTS
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "mrtmas",QRYNAME    * Contains MRTMASFD KEY      
          IF        @EQUAL
            CALL      STMAS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "moverc",QRYNAME    
          IF        @EQUAL
            CALL      STMOV000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newloc",QRYNAME    
          IF        @EQUAL
            CALL      STLOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newhos",QRYNAME                                  *I-240724
          IF        @EQUAL
            CALL      STHOS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvreas",QRYNAME    
          IF        @EQUAL
            CALL      STREA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "peresp",QRYNAME    
          IF        @EQUAL
            CALL      STRESP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admiss",QRYNAME    
          IF        @EQUAL
            CALL      STADM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disrmo",QRYNAME    
          IF        @EQUAL
            CALL      STRMO000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "distat",QRYNAME    
          IF        @EQUAL
            CALL      STSTA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "missd",QRYNAME    
          IF        @EQUAL
            CALL      STMIS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctor",QRYNAME    
          IF        @EQUAL
            CALL      STDOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtrq",QRYNAME    
          IF        @EQUAL
            CALL      STREQ000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtme",QRYNAME    
          IF        @EQUAL
            CALL      STMOE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtds",QRYNAME
          IF        @EQUAL
            CALL      MRTDSSET
            GOTO      SETPAR99
          ENDIF    
.
          MATCH     "desthosp=",QRYNAME
          IF        @EQUAL
            PACK      DESTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtms005",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTMS005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrtms007",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRTMS007
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftmove=",QRYNAME
          IF        @EQUAL
            PACK      DEFTMOVE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frhosplv=",QRYNAME
          IF        @EQUAL
            PACK      FRHOSPLV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 10 - Medical Record Movement Maintenance
.-------------------------------------------------------------------------------
STMOE000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMOE001,STMOE002,STMOE003,STMOE004,STMOE005,STMOE006:
                       STMOE007,STMOE008,STMOE009,STMOE010,STMOE011,STMOE012:
                       STMOE013,STMOE014,STMOE015,STMOE016,STMOE017,STMOE018:
                       STMOE019,STMOE020
.
          GOTO      STMOE999
.
STMOE001  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME001 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME001,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME001
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE002  MOVE      QRYDATA,MRTME002
          GOTO      STMOE999
.
STMOE003  MOVE      QRYDATA,MRTME003
          GOTO      STMOE999
.
STMOE004  MOVE      QRYDATA,MRTME004
          GOTO      STMOE999
.
STMOE005  MOVE      QRYDATA,MRTME005
          GOTO      STMOE999
.
STMOE006  MOVE      QRYDATA,MRTME006
          GOTO      STMOE999
.
STMOE007  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME007 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME007,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME007
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE008  MOVE      QRYDATA,MRTME008
          GOTO      STMOE999
.
STMOE009  MOVE      QRYDATA,MRTME009
          GOTO      STMOE999
.
STMOE010  MOVE      QRYDATA,MRTME010
          GOTO      STMOE999
.
STMOE011  MOVE      QRYDATA,MRTME011
          GOTO      STMOE999
.
STMOE012  MOVE      QRYDATA,MRTME012
          GOTO      STMOE999
.
STMOE013  MOVE      QRYDATA,MRTME013
          GOTO      STMOE999
.
STMOE014  MOVE      QRYDATA,MRTME014
          GOTO      STMOE999
.
STMOE015  MOVE      QRYDATA,MRTME015
          GOTO      STMOE999
.
STMOE016  PACK      QRYDATA,QRYDATA,SP70
          MOVE      QRYDATA,MRTME016
          GOTO      STMOE999
.
STMOE017  MOVE      QRYDATA,MRTME017
          GOTO      STMOE999
.
STMOE018  MOVE      QRYDATA,MRTME018
          GOTO      STMOE999
.
STMOE019  MOVE      QRYDATA,MRTME019
          GOTO      STMOE999
.
STMOE020 MOVE      QRYDATA,MRTME020
          GOTO      STMOE999
.
STMOE999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: MRTMASFD Index 1 keys        
.----------------------------------------------------------------
STMAS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      MRTMASKY[F2],QRYDATA,SP70
.
STMAS999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Moving Indicator             
.----------------------------------------------------------------
STMOV000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      MOVINGRC[F2],QRYDATA,SP70
          MOVE      F2,LASTITEM
.
STMOV999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: New Location                 
.----------------------------------------------------------------
STLOC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      NEWLOCAT[F2],QRYDATA,SP70
.
STLOC999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: New Hospital                 
.----------------------------------------------------------------
STHOS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      NEWHOSPT[F2],QRYDATA,SP70
.
STHOS999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Movement Reason              
.----------------------------------------------------------------
STREA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      MOVEREAS[F2],QRYDATA,SP70
.
STREA999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Persons Responsible          
.----------------------------------------------------------------
STRESP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      QRYDATA,QRYDATA,SP70
          MOVE      QRYDATA,PERRESPN[F2]
.
STRESP99  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Admission Numbers            
.----------------------------------------------------------------
STADM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      ADMISSKY[F2],QRYDATA,SP70
          MOVE      F2,LASTADMN
.
STADM999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Discharge RMO Responsible
.----------------------------------------------------------------
STRMO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      DISTRMOR[F2],QRYDATA,SP70
.
STRMO999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Discharge Statuses          
.----------------------------------------------------------------
STSTA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      DISTATUS[F2],QRYDATA,SP70
.
STSTA999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Doctor Codes             
.----------------------------------------------------------------
STDOC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          PACK      DOCTORCD[F2],QRYDATA,SP70
.
STDOC999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Missing Details          
.----------------------------------------------------------------
STMIS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY1,KEY2
          MOVE      KEY1,F1
          MOVE      KEY2,F2
          PACK      MISSINGD[F2][F1],QRYDATA,SP70
.
STMIS999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Cancel Past Requests     
.----------------------------------------------------------------
STREQ000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STREQ010,STREQ020,STREQ030,STREQ040,STREQ050
.
          MOVE      ONE,EXIT
          GOTO      STREQ999

STREQ010  MOVE      QRYDATA,MRTRQ001
          GOTO      STREQ999
.
STREQ020  MOVE      QRYDATA,MRTRQ002
          GOTO      STREQ999
.
STREQ030  MOVE      QRYDATA,MRTRQ003
          GOTO      STREQ999
.
STREQ040  MOVE      QRYDATA,MRTRQ004
          GOTO      STREQ999
.
STREQ050  MOVE      QRYDATA,MRTRQ005
          GOTO      STREQ999
.
STREQ999  RETURN
.-------------------------------------------------------------------------------
. Medical Record Post Discharge Tracking
.-------------------------------------------------------------------------------
PSTTRK00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PSTTRK50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PSTTRK10 IF EQUAL
.
          GOTO      PSTTRK93
.
.         ************ ADD FORMACTION ***********
.
PSTTRK10  MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTITEM
            MATCH     SP70,MOVINGRC[COUNTER]
            IF        !@EQUAL
              CALL      SAVLOC00  * Save Location Details & History Details
            ENDIF
            ADD       ONE,COUNTER
          DO 
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTADMN
            MATCH     SP70,ADMISSKY[COUNTER]
            IF        !@EQUAL
              CALL      SAVMIS00  * Save Missing Details for Incomplete Dis
            ENDIF
            ADD       ONE,COUNTER
          DO 
.
          MATCH     SP70,FILREQED
          IF        !@EQUAL
            PACK      KEY8,URNUMBER,SP70 
            CALL      RDMAST1
            BRANCH    OVRCD,PSTTRK91
            MOVE      "Y  ",PTMXFILN
            CALL      UPMAST1
            CALL      UUPTMAS1
          ELSE
            PACK      KEY8,URNUMBER,SP70 
            CALL      RDMAST1
            BRANCH    OVRCD,PSTTRK91
            MOVE      "N  ",PTMXFILN
            CALL      UPMAST1
            CALL      UUPTMAS1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PSTTRK99
.
.         ************ DISPLAY FORMACTION **********
.
PSTTRK50  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PSTTRK91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Medical Records Post Discharge Tracking",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PSTTRK99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PSTTRK99
.
PSTTRK99  RETURN
.-------------------------------------------------------------------------------
. Save Medical Record to a new Location & write to the History file.  
.-------------------------------------------------------------------------------
SAVLOC00  PACK      KEY20,MRTMASKY[COUNTER],SP70                      *C-240724
          CALL      RLMRMAS1    * Read with Lock
          BRANCH    OVRCD,SAVLOC99

          MOVE      NEWLOCAT[COUNTER],MRMACLOC
          MOVE      NEWHOSPT[COUNTER],MRMACHOS                        *C-240724
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS1    * Update
          CALL      ULMRMAS1    * Unlock record
.        
.  Write to Medical Record Tracking History File
.
          CALL      CLMRTHIS
          MOVE      MRMAKEY,MRHIKEY      * Key to History Table
          PACK      MRHIDATE,CCC,CYY,CMM,CDD
          REP       " 0",MRHIDATE        * Date of Movement
          MOVE      CTIMEIS,MRHITIME     * Time of Movement
          MOVE      MRMACHOS,MRHIDHOS    * Destination Hospital       *I-240724
          MOVE      MRMACLOC,MRHILOC     * Destination Location of Rec 
          MOVE      MOVEREAS[COUNTER],MRHIREAS  * Reason for Movement
          CALL      CALDUE00             * Calculate Due Date
          CALL      CALSTA00             * Get Status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          COMPARE   ONE,PTCNRQCF       * Requested By (Free Format)?
          IF        @EQUAL
            MOVE      PERRESPN[COUNTER],MRHIREQB  * Requested By (Free Format)
          ELSE
            MOVE      PERRESPN[COUNTER],MRHIRECV  * Requested By (Staff Code)
          ENDIF
.
          MATCH     SP70,MRTSECNO
          IF        !@EQUAL
            MOVE      MRTSECID,MRHIUSID  * MRT Security number User ID
          ELSE
            MOVE      USERID,MRHIUSID    * Web User ID
          ENDIF
.
.       
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1           * Write History record
          ENDIF
.
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM             * Pass Med.Recs.Movement to DG I-90201
.
SAVLOC99  RETURN
.-------------------------------------------------------------------------------
. Save Incomplete Discharge Information                               
.-------------------------------------------------------------------------------
SAVMIS00  PACK      KEY8,ADMISSKY[COUNTER],SP70
          CALL      RLMRPDS1
          BRANCH    OVRCD,SAVMIS99
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CURRDATE,MRPDDATE
          CLOCK     TIME,MRPDTIME
.
          MOVE      DOCTORCD[COUNTER],MRPDDOCT
          MOVE      DISTATUS[COUNTER],MRPDSTAT
          MOVE      DISTRMOR[COUNTER],MRPDRMOR
.
          CALL      UPMRPDS1
          CALL      ULMRPDS1
.
.  Update/Write to Post Discharge History File
.
          PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME
          CALL      RLMRPSH1    * Read Lock 
          BRANCH    OVRCD,SAVMIS10
.
          MOVE      DISTATUS[COUNTER],MRPSSTAT     * Discharge Status
          MOVE      SP70,MRPSCMNT                  * Comments
          MOVE      MISSINGD[COUNTER][1],MRPSMIS1  * Missing Details 1
          MOVE      MISSINGD[COUNTER][2],MRPSMIS2  * Missing Details 2
          MOVE      MISSINGD[COUNTER][3],MRPSMIS3  * Missing Details 3
          MOVE      MISSINGD[COUNTER][4],MRPSMIS4  * Missing Details 4
          MOVE      MISSINGD[COUNTER][5],MRPSMIS5  * Missing Details 5
          MOVE      MISSINGD[COUNTER][6],MRPSMIS6  * Missing Details 6
.
          CALL      UPMRPSH1    * Update Record
          CALL      ULMRPSH1    * Unlock Record
          GOTO      SAVMIS99
.                                  
SAVMIS10  MOVE      MRPDADMN,MRPSADMN
          MOVE      MRPDDATE,MRPSDATE
          MOVE      MRPDTIME,MRPSTIME 
          MOVE      DISTATUS[COUNTER],MRPSSTAT     * Discharge Status
          MOVE      SP70,MRPSCMNT                  * Comments
          MOVE      MISSINGD[COUNTER][1],MRPSMIS1  * Missing Details 1
          MOVE      MISSINGD[COUNTER][2],MRPSMIS2  * Missing Details 2
          MOVE      MISSINGD[COUNTER][3],MRPSMIS3  * Missing Details 3
          MOVE      MISSINGD[COUNTER][4],MRPSMIS4  * Missing Details 4
          MOVE      MISSINGD[COUNTER][5],MRPSMIS5  * Missing Details 5
          MOVE      MISSINGD[COUNTER][6],MRPSMIS6  * Missing Details 6
          PACK      MRPSFTM1,SP70,SP70
          PACK      MRPSFTM2,SP70,SP70
          PACK      MRPSFTM3,SP70,SP70
          PACK      MRPSFTM4,SP70,SP70
          PACK      MRPSFTM5,SP70,SP70
          MOVE      SP70,MRPSSPAR
.
          CALL      WRMRPSH1    * Write Record
.
SAVMIS99  RETURN 
.-------------------------------------------------------------------------------
. Calculate Due Date - returns MRHIDDUE
.-------------------------------------------------------------------------------
CALDUE00  MOVE      SP70,MRHIDDUE
.
          PACK      KEY4,MRHIREAS,SP70
          CALL      RDMRMOV1            * Get Borrowing Period
          BRANCH    OVRCD,CALDUE99
.
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY  * Date of Movement
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       MRMOPERD,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      MRHIDDUE,CC,YY,MM,DD           * Calculated Due Date
          REP       " 0",MRHIDDUE  
.
CALDUE99  RETURN
.-------------------------------------------------------------------------------
. Calculate Status - returns MRHISTAT
.-------------------------------------------------------------------------------
CALSTA00  PACK      KEY7,MRMACHOS,MRMACLOC,SP70                       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CALSTA99
.
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT   * 1-Out
          ELSE
            MOVE      TWO,MRHISTAT   * 2-In
          ENDIF
.
CALSTA99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Request Cancel (For a date range)
.-------------------------------------------------------------------------------
MRTRQD00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRTRQD40 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Add formaction
          GOTO      MRTRQD10 IF EQUAL
.
          GOTO      MRTRQD93
.
.         ************ DELETE FORMACTION ***********
.
MRTRQD10  CALL      RUNDEL00                  
          MOVE      ZERO,EXIT
          GOTO      MRTRQD99
.
.         ************ DISPLAY FORMACTION **********
.
MRTRQD40  CLEAR     WEBTITLE
          MOVE      "Cancel Past Requests (Not Filled)",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRTRQD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRTRQD99
.
MRTRQD93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRTRQD99
.
MRTRQD99  RETURN
.-------------------------------------------------------------------------------
. Medical Record Single Request
.-------------------------------------------------------------------------------
MRSING00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MRSING70 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Move Medical Record
          GOTO      MRSING10 IF EQUAL
.
          MATCH     "L",UPDTTYPE            * List History details
          GOTO      MRSING40 IF EQUAL
.
          GOTO      MRSING93
.
.         ************ ADD FORMACTION ***********
.
MRSING10  CALL      SAVMVE00                   
          BRANCH    EXIT,MRSING99
.
          CALL      CLPATMAS 
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
.
          MOVE      ZERO,EXIT
          GOTO      MRSING99
.
.         ************ DISPLAY FORMACTION **********
.
MRSING40  MATCH     SP70,URNUMBER
          GOTO      MRSING70 IF EQUAL
.
          PACK      LJUSCODE,URNUMBER,SP70
          MOVE      "8",JUSTNO
          CALL      RJUS0000
          MOVE      RJUSCODE,URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1                * Read Pateint Master File
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,VOLUMENO
          IF        @EQUAL
            CALL      GETHIH00    * Get Highest Volume No.
          ENDIF
.
          MOVE      VOLUMENO,DIM2
          SQUEEZE   DIM2
          MOVE      ZERO,FORMVOLN
          MOVE      DIM2,FORMVOLN 
.
          PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RSMRMAS3
MRSING50  CALL      RPMRMAS3               * Read MRT Master File
          BRANCH    OVRCD,MRSING91
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      MRSING91 IF NOT EQUAL
.
          MATCH     DOCMTYPE,MRMADOTY
          GOTO      MRSING50 IF NOT EQUAL
.
          MATCH     SP70,HOMELOCT        * Using Home Location?
          IF        !@EQUAL
            MATCH     HOMEHOSP,MRMAHHOS                               *I-240724
            GOTO      MRSING50 IF NOT EQUAL
            MATCH     HOMELOCT,MRMAHLOC
            GOTO      MRSING50 IF NOT EQUAL
          ENDIF          
.
          MOVE      MRMAVOLN,VOLKEY
          IF        FORMVOLN<>0
            COMPARE   MRMAVOLN,FORMVOLN
            GOTO      MRSING60 IF EQUAL
            GOTO      MRSING50
          ENDIF
.
MRSING60  MOVE      MRMAHHOS,HOSKEY                                   *I-240724
          MOVE      MRMAHLOC,LOCKEY
          MOVE      MRMADOTY,RTYKEY
          MOVE      MRMACOMM,EPISODET
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                * Read MRT History File
          IF        OVRCD=1
            PACK      MRHIDATE,SP70
            MOVE      MRMAHLOC,MRHILOC      * Moves home loc into file
          ELSE
            MATCH     MRHIKEY,MRMAKEY
            IF        !@EQUAL
              PACK      MRHIDATE,SP70
              MOVE      MRMAHLOC,MRHILOC    * Moves home loc into file
            ENDIF
          ENDIF
.
          PACK      MEDRECKY,URNUMBER,HOSKEY,LOCKEY,RTYKEY,VOLKEY     *C-240724
          MOVE      MRMAKEY,MEDHISKY        * Set Medical Record Key
.
          CLEAR     WEBTITLE
          MOVE      "Single Record Movement",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRSING99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MRSING99
.
MRSING70  CLEAR     WEBTITLE
          MOVE      "Single Record Movement",WEBTITLE
          RESET     WEBTITLE
.
          CALL      CLPATMAS
          CALL      CLRMRM00                          * HPSI
          CALL      CLMRTHIS                          * HPSI
.
          MOVE      SP70,MEDHISKY
          MOVE      SP70,URNUMBER
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRSING99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MRSING99
.
MRSING90  MOVE      "No Master File Details.",WEBTITLE
          CALL      WEBERR00
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
          MOVE      ONE,EXIT
          GOTO      MRSING99

MRSING91  MOVE      "No Record Movement Found.",WEBTITLE
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRSING99
.
MRSING93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRSING99
.
MRSING99  RETURN
.***************************************************************************
.                                GETHIH00              called by: MRSING00
.    Get Highest Volume Number by Document Type 
.    Returns: VOLUMENO
.***************************************************************************
GETHIH00  PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RSMRMAS3
GETHIH10  CALL      RPMRMAS3
          BRANCH    OVRCD,GETHIH99
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      GETHIH99 IF NOT EQUAL
.
          MATCH     SP70,DOCMTYPE
          IF        @EQUAL
            MATCH     MRMADOTY,MRCNRCTY     * Control variable
            GOTO      GETHIH10 IF NOT EQUAL
          ELSE
            MATCH     MRMADOTY,DOCMTYPE     * CGI variable
            GOTO      GETHIH10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HOMELOCT           * Using home locations
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP     * CGI variable            *I-240724
            GOTO      GETHIH10 IF NOT EQUAL
            MATCH     MRMAHLOC,HOMELOCT     * CGI variable
            GOTO      GETHIH10 IF NOT EQUAL
          ENDIF
.
          MOVE      MRMAVOLN,VOLUMENO
.
GETHIH99  RETURN
.
. HPS Code Starts Here
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRMRM00  MOVE      SP70,MRMAURNO
          MOVE      SP70,MRMAHHOS
          MOVE      SP70,MRMAHLOC
          MOVE      SP70,MRMADOTY
          MOVE      ZERO,MRMAVOLN
          MOVE      SP70,MRMASTAT
          MOVE      SP70,MRMACOMM
          MOVE      SP70,MRMAKEY
          MOVE      SP70,MRMACHOS
          MOVE      SP70,MRMACLOC
          MOVE      SP70,MRMAOHOS
          MOVE      SP70,MRMAFILM
.
CLRMRM99  RETURN
.
.------------------------------------------------------------------------------
. Right Justify The Code
.------------------------------------------------------------------------------
RJUS0000  PACK      RJUSCODE,SP70
          RESET     LJUSCODE,JUSTNO
          MOVE      ZERO,CHRCOUNT
RJUS1000  CMATCH    SP1,LJUSCODE
          GOTO      RJUS2000 IF NOT EQUAL
.
          ADD       ONE,CHRCOUNT
          BUMP      LJUSCODE,-1
          GOTO      RJUS2000 IF EOS
.
          COMPARE   JUSTNO,CHRCOUNT
          GOTO      RJUS1000 IF LESS
.
RJUS2000  RESET     LJUSCODE
          CLEAR     RJUSCODE
          RESET     RJUSCODE,CHRCOUNT
          APPEND    LJUSCODE,RJUSCODE
          RESET     RJUSCODE
.
RJUS9000  MOVE      ZERO,EXIT
RJUS9999  RETURN
.------------------------------------------------------------
.                       RUNDEL00
.   Schedule Request List Extract Delete to be run via Program Scheduler
.------------------------------------------------------------
RUNDEL00  MOVE      "IBAMRT07",SCHDPGID
          MOVE      "Delete Medical Records Requests",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S",SCHDPRNT             * Spool File
.
.         Write Keyin parameters for Extract
.
          MOVE      TWO,KEYSTARR[1]          * Option
          MOVE      MRTRQ001,KEYSTARR[2]     * From Date 
          MOVE      MRTRQ002,KEYSTARR[3]     * To Date    
          MOVE      MRTRQ003,KEYSTARR[4]     * Document Type
          PACK      KEYSTARR[5],MRTRQ005,MRTRQ004 * * Destination Hosp/Location
          MOVE      FIVE,KEYSTCNT             * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
RUNDEL99  RETURN
.-------------------------------------------------------------------------------
. Save Medical Record Movement        
.-------------------------------------------------------------------------------
SAVMVE00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE 
.
          MATCH     CURRDATE,MRTME001    * Current date against move date
          GOTO      SAVMVE10 IF EQUAL
.
          MATCH     CURRDATE,MRTME001    * Is it a past date?
          GOTO      SAVMVE10 IF LESS
.
          COMPARE   MRCNFUTD,ZERO        * Future Date Parameter
          GOTO      SAVMVE90 IF EQUAL
.
          DAYSEP    CURRDATE,MRTME001,DAYSDIFF
          IF        DAYSDIFF > HTNUMDAY
            GOTO      SAVMVE90           * Future date too far in advance!
          ENDIF
.
SAVMVE10  PACK      KEY20,MEDRECKY,SP70                               *C-240724
          CALL      RDMRMAS1           * Read Medical Record Master File
          BRANCH    OVRCD,SAVMVE91
.
          PACK      KEY7,MRTME019,MRTME003      * Check Location      *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,SAVMVE92
.
.         MATCH     MRLOTYPE,MRCNHMTY  * Home Location?                *D-51682
.         IF        @EQUAL
.           MATCH     MRMAHLOC,MRTME003
.           IF        !@EQUAL
.             GOTO      SAVMVE93
.           ENDIF
.         ENDIF                                                    *end D-51682
.
          CALL      MOVREC00     * Save & Move Medical Record
          GOTO      SAVMVE99 
.
SAVMVE90  MOVE      "Cannot Move Record this far in the future ",WEBTITLE 
          CALL      WEBERR00
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
          MOVE      ONE,EXIT
          GOTO      SAVMVE99
.
SAVMVE91  MOVE      "No Record Found for this UR on - mrtmasaf.",WEBTITLE
          CALL      WEBERR00
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
          MOVE      ONE,EXIT
          GOTO      SAVMVE99
.
SAVMVE92  MOVE      "Dest not found on Locations File - mrtlocaf.",WEBTITLE 
          CALL      WEBERR00
          PACK      URNUMBER,SP70
          PACK      MEDHISKY,SP70
          MOVE      ONE,EXIT
          GOTO      SAVMVE99
.                                                                      *D-51682
.SAVMVE93  MOVE      "Can't Move to a Home Location other than its own",WEBTITLE
.          CALL      WEBERR00
.          PACK      URNUMBER,SP70
.          PACK      MEDHISKY,SP70
.          MOVE      ONE,EXIT
.          GOTO      SAVMVE99                                      *end D-51682
.
SAVMVE99  RETURN
.--------------------------------------------------------------------
.                          MOVREC00
. * First Delete all movements after current movement if there are any.
.--------------------------------------------------------------------
MOVREC00  PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
MOVREC10  CALL      RSMRHIS1
          CALL      RKMRHIS1
          BRANCH    OVRCD,MOVREC20
.
          MATCH     MRHIKEY,MRMAKEY         * Match on History Key
          GOTO      MOVREC20 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1
.
          GOTO      MOVREC10                * Read next record
.
MOVREC20  PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RDMRHIS1
          COMPARE   ZERO,OVRCD
          GOTO      MOVREC99 IF EQUAL 
.
          CALL      MVESAV00  * Save Variables
.
          PACK      KEY26,MRMAKEY,MRTME001,MRTME002,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1     * Write to History File
          ENDIF
.
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG      *I-90230
.
          PACK      KEY10,MRMAKEY,SP70
          CALL      RDMRMAS2       * Updates the master file with current loc
          BRANCH    OVRCD,MOVREC99
.
          MATCH     SP70,MRTMS005
          IF        !@EQUAL
            PACK      MRMACOMM,MRTMS005,SP70
          ENDIF
.
          MATCH     SP70,MRTMS007
          IF        !@EQUAL
            PACK      MRMAFILM,MRTMS007,SP70
          ENDIF
.
          MOVE      MRHIDHOS,MRMACHOS                                 *C-240724
          MOVE      MRHILOC,MRMACLOC
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2       * Update Master Record 
.
          MATCH     SP70,MRTME012  * Change in Post Discharge Status ?
          GOTO      MOVREC99 IF EQUAL
.
          PACK      KEY26,URNUMBER,SP1,THREE,Z70
          CALL      RDSVISA4     * Reads Visit file for admission number
MOVREC30  CALL      RDPVISA4
          BRANCH    OVRCD,MOVREC99
.
          MATCH     URNUMBER,PVIURNO             * Same U/R
          GOTO      MOVREC99 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE                * Inpatient Visit
          GOTO      MOVREC99 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MOVREC30
.
          COMPARE   TWO,ASTAT                    * Current Admission
          GOTO      MOVREC35 IF EQUAL
.
          COMPARE   THREE,ASTAT                  * Discharged
          GOTO      MOVREC35 IF EQUAL
.
          GOTO      MOVREC30
.
MOVREC35  PACK      KEY8,AADMNO,SP70
          CALL      RDMRPDS1     * checks for existing Post discharge status
          IF        OVRCD=1
            MOVE      AADMNO,MRPDADMN
            MOVE      ADOCTA,MRPDDOCT
            MOVE      MRTME012,MRPDSTAT
            MOVE      CURRDATE,MRPDDATE
            CLOCK     TIME,MRPDTIME
            MOVE      SP70,MRPDRMOR
            MOVE      SP70,MRPDSPAR
            CALL      WRMRPDS1
          ELSE
            PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
            CALL      RDMRPSH1
            IF        OVRCD=1
              MOVE      MRPDADMN,MRPSADMN
              MOVE      MRPDDATE,MRPSDATE
              MOVE      MRPDTIME,MRPSTIME
              MOVE      MRPDSTAT,MRPSSTAT
              MOVE      SP70,MRPSCMNT
              MOVE      SP70,MRPSMIS1
              MOVE      SP70,MRPSMIS2
              MOVE      SP70,MRPSMIS3
              MOVE      SP70,MRPSMIS4
              MOVE      SP70,MRPSMIS5
              MOVE      SP70,MRPSMIS6
              PACK      MRPSFTM1,SP70,SP70
              PACK      MRPSFTM2,SP70,SP70
              PACK      MRPSFTM3,SP70,SP70
              PACK      MRPSFTM4,SP70,SP70
              PACK      MRPSFTM5,SP70,SP70
              MOVE      SP70,MRPSSPAR
              CALL      WRMRPSH1
            ELSE
              MOVE      MRPDSTAT,MRPSSTAT
              CALL      UPMRPSH1
            ENDIF
            MOVE      ADOCTA,MRPDDOCT
            MOVE      MRTME012,MRPDSTAT
            MOVE      CURRDATE,MRPDDATE
            CLOCK     TIME,MRPDTIME
            CALL      UPMRPDS1
          ENDIF
.
MOVREC99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
MVESAV00  MOVE      MRMAKEY,MRHIKEY
          MOVE      MRTME001,MRHIDATE
          MOVE      MRTME002,MRHITIME
          MOVE      MRTME003,MRHILOC
          MOVE      SP70,MRHIRECV
          MOVE      REASONMV,MRHIREAS
          MOVE      MRTME006,MRHIOPER
          MOVE      MRTME007,MRHIDDUE
.
          PACK      KEY7,MRHIDHOS,MRHILOC,SP70                        *C-240724
          CALL      RDMRLOC1
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT     * external
          ELSE
            MOVE      TWO,MRHISTAT     * internal
          ENDIF
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MATCH     SP70,MRTSECNO
          IF        !@EQUAL
            MOVE      MRTSECID,MRHIUSID  * MRT Security number User ID
          ELSE
            MOVE      USERID,MRHIUSID    * Web User ID
          ENDIF
.
          COMPARE   ONE,PTCNRQCF       * Requested by Free Format?
          IF        @EQUAL
            MOVE      MRTME016,MRHIREQB  * Requested By Free Format
          ELSE
            MOVE      MRTME016,MRHIRECV  * Requested By (Using Staff Code)
          ENDIF
.
          MOVE      SP70,MRHILOCK
          MOVE      MRTME013,MRHIEXTN
          MOVE      MRTME014,MRHIPAGE
          MOVE      MRTME018,MRHICOMM
          MOVE      MRTME019,MRHIDHOS
.
MVESAV99  RETURN
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD10,PROFLD10,PROFLD50:
                             PROFLD99,PROFLD70,PROFLD80
          GOTO      PROFLD99
.
.      Medical Record Post Discharge Tracking
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD12  CALL      PSTR0000                * Post Discharge Tracking
          GOTO      PROFLD99
.
.      Medical Record Request Cancelation    
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD22  CALL      RQDR0000                * Record Cancelation     
          GOTO      PROFLD99
.
.      Medical Record Single Movement       
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99
.
PROFLD52  CALL      SING0000                * Single Record Movement
          GOTO      PROFLD99
.
.      Discharge Summary Request
.      
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.         
PROFLD71  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99  
.
PROFLD72  CALL      DRRT0000                * MRTDSRFD Details
          GOTO      PROFLD99
.
PROFLD73  CALL      MISF0000                * PATMI1FD Details
          GOTO      PROFLD99
.
.
.         Post Discharge Status History
.      
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          GOTO      PROFLD99
.         
PROFLD81  CALL      MASF0000                * Patient Master Details
          GOTO      PROFLD99  
.
PROFLD82  CALL      PDSH0000                * Post Discharge Status Maintenance
          GOTO      PROFLD99  
.
PROFLD99  RETURN
+
.-----------------------------------------------------------
. Option 1 - Medical Record Template Details Maintenance
.-----------------------------------------------------------
PSTR0000  BRANCH    FLDITMNO,PSTR0100,PSTR0200,PSTR0300,PSTR0400,PSTR0500:
                             PSTR0600
          GOTO      PSTR9999
.
PSTR0100  CALL      VOLSEL00    * Selectiuon List of Volume No's
          GOTO      PSTR9999
.
PSTR0200  CALL      RECDC000    * Table of Document Types
          GOTO      PSTR9999
.
PSTR0300  CALL      DISDC000    * Table of Incomplete Discharges
          GOTO      PSTR9999
.
PSTR0400  WRITE     HTMLFILE;DEFTMOVE;  
          GOTO      PSTR9999          
.
PSTR0500  MOVE      SP70,MRVSFLAG
          PACK      KEY8,ADMISSNO,SP70  
          CALL      RDMRVS1
          IF        OVRCD=0
            MOVE      ONE,MRVSFLAG
          ENDIF
          WRITE     HTMLFILE;MRVSFLAG;
          GOTO      PSTR9999
.
PSTR0600  WRITE     HTMLFILE;FRHOSPLV;
          GOTO      PSTR9999
.
PSTR9999  RETURN
+
.-----------------------------------------------------------
. Option 8 - Post Discharge Status History Maintenance
.-----------------------------------------------------------
PDSH0000  BRANCH    FLDITMNO,PDSH0100
          GOTO      PDSH9999
.
PDSH0100  CALL      TBPDSH00
          GOTO      PDSH9999
.
PDSH9999  RETURN
+
.----------------------------------------------------------------
.  Outputs a selection list of Volume numbers for a given UR
.                   ******** VOLSEL00 ********
.----------------------------------------------------------------
VOLSEL00  MOVE      ZERO,SAVVOL
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS3
VOLSEL10  CALL      RKMRMAS3
          BRANCH    OVRCD,VOLSEL99
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      VOLSEL99 IF NOT EQUAL
.
          MATCH     MRMADOTY,MRCNRCTY
          GOTO      VOLSEL10 IF NOT EQUAL
.
          IF        MRMAVOLN <= SAVVOL
            GOTO      VOLSEL10
          ENDIF

          MOVE      MRMAVOLN,SAVVOL
.
          MATCH     SP70,VOLUMENO    * Check Volume No.
          IF        @EQUAL
            MOVE      ZERO,FORM2
          ELSE
            MOVE      VOLUMENO,FORM2
          ENDIF
.
          COMPARE   MRMAVOLN,FORM2
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRMAVOLN,"#" selected>":
                               MRMAVOLN,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRMAVOLN,"#">":
                               MRMAVOLN,"</option>"
          ENDIF
          GOTO    VOLSEL10
.
VOLSEL99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of volume numbers for a given UR
.  outputs in order of highest volume number by Document Type
.                   ******** HIHVOL00 ********
.----------------------------------------------------------------
HIHVOL00  MOVE      ZERO,SAVVOL
.
.  Get Highest Volume No.. Used when VOLUMENO not set
.
          PACK      KEY20,URNUMBER,Z70                                *C-240724
          CALL      RSMRMAS3
HIHVOL10  CALL      RPMRMAS3
          BRANCH    OVRCD,HIHVOL99
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      HIHVOL99 IF NOT EQUAL
.
          MATCH     SP70,DOCMTYPE
          IF        @EQUAL
            MATCH     MRMADOTY,MRCNRCTY     * Control variable
            GOTO      HIHVOL10 IF NOT EQUAL
          ELSE
            MATCH     MRMADOTY,DOCMTYPE     * CGI variable
            GOTO      HIHVOL10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HOMELOCT           * Using home locations
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP     * CGI variable            *I-240724
            GOTO      HIHVOL10 IF NOT EQUAL
            MATCH     MRMAHLOC,HOMELOCT     * CGI variable
            GOTO      HIHVOL10 IF NOT EQUAL
          ENDIF
.
          MOVE      MRMAVOLN,HIGHEST
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS3
HIHVOL20  CALL      RKMRMAS3
          BRANCH    OVRCD,HIHVOL99
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      HIHVOL99 IF NOT EQUAL
.
          MATCH     SP70,DOCMTYPE
          IF        @EQUAL
            MATCH     MRMADOTY,MRCNRCTY     * Control variable
            GOTO      HIHVOL20 IF NOT EQUAL
          ELSE
            MATCH     MRMADOTY,DOCMTYPE     * CGI variable
            GOTO      HIHVOL20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HOMELOCT           * Using home locations
          IF        !@EQUAL
            MATCH     MRMAHHOS,HOMEHOSP     * CGI variable            *I-240724
            GOTO      HIHVOL20 IF NOT EQUAL
            MATCH     MRMAHLOC,HOMELOCT     * CGI variable
            GOTO      HIHVOL20 IF NOT EQUAL
          ENDIF
.
          IF        MRMAVOLN <= SAVVOL
            GOTO      HIHVOL20
          ENDIF

          MOVE      MRMAVOLN,SAVVOL
.
          MATCH     SP70,VOLUMENO    * Check Volume No.
          IF        @EQUAL
            MOVE      HIGHEST,FORM2
          ELSE
            MOVE      VOLUMENO,FORM2
          ENDIF
.
          COMPARE   MRMAVOLN,FORM2
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRMAVOLN,"#" selected>":
                             MRMAVOLN,"</option>"
          ELSE 
            WRITE     HTMLFILE;"<option value=#"",MRMAVOLN,"#">":
                             MRMAVOLN,"</option>"
          ENDIF
          GOTO    HIHVOL20
.
HIHVOL99  RETURN
.----------------------------------------------------------------
.  Set Home Hospital & Home Location defaults
.  (was "Outputs a selection list of Home Locations")
.                   ******** HOMLOC00 ********
.----------------------------------------------------------------
HOMLOC00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1

HOMLOC10  MOVE      MRCNHLOC,DFLTHLOC  *  Move Control File Variable to dummy
          MOVE      SP3,DFLTHHOS
.
.         First check if the user has Home Location then Default with that 
.         location. Otherwise, check if Multi hospital exists then Read Hospital
.         file and take Home location and Default it. If it doesnt exists
.         take home location from control file and default it.
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHLOC,DFLTHLOC
            MOVE      WBSEHHOS,DFLTHHOS                               *I-240724
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,HOMLOC99
.
              MATCH     SP70,PTHSHLOC
              IF        !@EQUAL
                MOVE      PTHSHLOC,DFLTHLOC
                MOVE      PTHSHHOS,DFLTHHOS                           *I-240724
              ENDIF
            ENDIF
          ENDIF 
.
HOMLOC20  IF        F1 > 1
            MATCH     SP70,HOMELOCT
            IF        !@EQUAL
              MOVE      HOMEHOSP,DFLTHHOS
              MOVE      HOMELOCT,DFLTHLOC
            ENDIF
          ENDIF
.
          BRANCH    F1,HOMLOC51,HOMLOC52,HOMLOC53
.
HOMLOC50  WRITE     HTMLFILE;DFLTHHOS;      * set Home Hospital
          GOTO      HOMLOC99
.
HOMLOC51  WRITE     HTMLFILE;DFLTHLOC;      * set Home Location
          GOTO      HOMLOC99
.
HOMLOC52  WRITE     HTMLFILE;DFLTHHOS;      * set Home Hospital with memory
          GOTO      HOMLOC99
.
HOMLOC53  WRITE     HTMLFILE;DFLTHLOC;      * set Home RLocation with memory
          GOTO      HOMLOC99
.
HOMLOC99  RETURN
. ---------------------------------------------------------------------------
.                        now obsolete
....
...HOMLOC09  PACK      KEY7,SP70                                       *C-240724
...          CALL      RSMRLOC1
...HOMLOC10  CALL      RKMRLOC1
...          BRANCH    OVRCD,HOMLOC99
....
...          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
...          IF        @EQUAL
...            GOTO      HOMLOC10
...          ENDIF
....
...          MATCH     MRLOTYPE,MRCNHMTY
...          GOTO      HOMLOC10 IF NOT EQUAL
....
...          MATCH     MRLOCODE,DFLTHLOC   * Default Medical Records Home Loc
...          IF        @EQUAL
...            MATCH     MRLOHOSP,DFLTHHOS                             *I-240724
...            GOTO      HOMLOC12 IF NOT EQUAL
...            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
...                                 MRLODESC,"</option>"
...          ELSE
...HOMLOC12    IF        IBCNMHOS=1
...              MATCH     WBSEHOSP,MRLOHOSP
...              GOTO      HOMLOC10 IF NOT EQUAL
...            ENDIF
...            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
...                                 MRLODESC,"</option>"
...          ENDIF
....
...          GOTO    HOMLOC10
....
...HOMLOC99  RETURN
.
.----------------------------------------------------------------
.                            Obselete 06/07/2011 CAR 240724
.  Outputs a selection list of Home Locations
.                   ******** HHMLOC00 ********
.----------------------------------------------------------------
HHMLOC00  MOVE      MRCNHLOC,DFLTHLOC    *  Move Control File Variable to dummy
          MOVE      SP3,DFLTHHOS
.
.         Check if the user has Home Location then Default with that location.
.         Otherwise, check if Multi hospital exists then Read Hospital file 
.         and take Home location and Default it.  If it doesnt exists take Home
.         Location from control file and default it.
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHLOC,DFLTHLOC
            MOVE      WBSEHHOS,DFLTHHOS                               *I-240724
          ELSE
            IF        IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              BRANCH    OVRCD,HHMLOC09
.
              MATCH     SP70,PTHSHLOC
              IF        !@EQUAL
                MOVE      PTHSHLOC,DFLTHLOC
                MOVE      PTHSHHOS,DFLTHHOS                           *I-240724
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,HOMELOCT
          IF        !@EQUAL
            MOVE      HOMEHOSP,DFLTHHOS                               *I-240724
            MOVE      HOMELOCT,DFLTHLOC
          ENDIF
.
HHMLOC09  PACK      KEY7,SP70                                         *C-240724
          CALL      RSMRLOC1
HHMLOC10  CALL      RKMRLOC1
          BRANCH    OVRCD,HHMLOC99
.
          COMPARE   MRLOSTAT,ONE    * Checks for Active locations only
          IF        @EQUAL
            GOTO      HHMLOC10
          ENDIF
.
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      HHMLOC10 IF NOT EQUAL
.
          MATCH     MRLOCODE,DFLTHLOC    * Default Medical Records Home Location
          IF        @EQUAL
            MATCH     MRLOHOSP,DFLTHHOS                               *I-240724
            GOTO      HHMLOC12 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
                                 MRLODESC,"</option>"
          ELSE
HHMLOC12    IF        IBCNMHOS = 1
              PACK      KEY13,USERID,SP70            * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,MRLOHOSP,SP70 * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,HHMLOC10
              ENDIF
              WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
                                   MRLODESC,"</option>"
              GOTO      HHMLOC10
            ENDIF
.
....        IF        IBCNMHOS=1
....          MATCH     WBSEHOSP,MRLOHOSP
....          GOTO      HHMLOC10 IF NOT EQUAL
....        ENDIF
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
                                 MRLODESC,"</option>"
          ENDIF
.
          GOTO    HHMLOC10
.
HHMLOC99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of Reasons for Movement
.                   ******** REASEL00 ********
.----------------------------------------------------------------
REASEL00  PACK      KEY4,SP70
          CALL      RSMRMOV1
REASEL10  CALL      RKMRMOV1
          BRANCH    OVRCD,REASEL99
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      REASEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",MRMOREAS,"#">":
                               MRMODESC,"</option>"
.
          GOTO    REASEL10
.
REASEL99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of MRT Staff           
.                   ******** STALST00 ********
.----------------------------------------------------------------
STALST00  PACK      KEY6,SP70
          CALL      RSMRSTF1
STALST10  CALL      RKMRSTF1
          BRANCH    OVRCD,STALST99
.
          COMPARE   MRSTSTAT,ONE    * Checks for Active Staff only
          IF        @EQUAL
            GOTO      STALST10
          ENDIF
.
          PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
.
          COMPARE   ONE,PTCNRQCF       * Requested By (Free Format)?
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",KEY50,"#">":
                                 KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#">":
                                 KEY50,"</option>"
          ENDIF
.
          GOTO    STALST10
.
STALST99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of MRT Staff           
.                   ******** MRTSTF00 ********
.----------------------------------------------------------------
MRTSTF00  PACK      KEY6,STAFFKEY,SP70
          CALL      RSMRSTF1
MRTSTF10  CALL      RKMRSTF1
          BRANCH    OVRCD,MRTSTF99
.
          COMPARE   MRSTSTAT,ONE    * Checks for Active Staff only
          IF        @EQUAL
            GOTO      MRTSTF10
          ENDIF
.
          PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
.
          MATCH     STAFFKEY,MRSTCODE    * Default Staff Code
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#" selected>":
                                 KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRSTCODE,"#">":
                                 KEY50,"</option>"
          ENDIF 
.
          GOTO    MRTSTF10
.
MRTSTF99  RETURN
.------------------------------------------------------------
. Table of Document Types
.------------------------------------------------------------
RECDC000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      F1,TABLEFLG   * Set Row output type
.   
          MOVE      ZERO,VOLFLAG
          MOVE      ZERO,FORM2
.
          CALL      RECHD000      * Output Table Heading
.
          MOVE      ZERO,ROWNUM                                       *I-259379
          MATCH     SP70,VOLUMENO
          IF        !@EQUAL
            MOVE      ONE,VOLFLAG
            GOTO      RECDC200
          ENDIF
.
          PACK      KEY20,URNUMBER,Z70    * Volume no not set         *C-240724
          CALL      RSMRMAS4
RECDC100  CALL      RPMRMAS4
          BRANCH    OVRCD,RECDC999
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      RECDC999 IF NOT EQUAL
.
          MATCH     MRMADOTY,MRCNRCTY     * Document type must be Medical Record
          GOTO      RECDC100 IF NOT EQUAL
.
          CALL      RECRW000               * Display Row
          GOTO      RECDC100
.
RECDC200  PACK      KEY20,URNUMBER,Z70    * Volume no not set         *C-240724
          CALL      RSMRMAS3
RECDC300  CALL      RPMRMAS3
          BRANCH    OVRCD,RECDC999
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      RECDC999 IF NOT EQUAL
.
          MATCH     MRMADOTY,MRCNRCTY     * Document type must be Medical Record
          GOTO      RECDC300 IF NOT EQUAL
.
          IF        VOLFLAG=1
            MOVE      VOLUMENO,FORM2
            COMPARE   MRMAVOLN,FORM2      * Match on Volume no if Flag set
            GOTO      RECDC300 IF NOT EQUAL
          ENDIF
.
          CALL      RECRW000               * Display Row
          GOTO      RECDC300

RECDC999  RETURN
.-----------------------------------------------------------
. Option 2 - Medical Record Request Cancelation        
.-----------------------------------------------------------
RQDR0000  BRANCH    FLDITMNO,RQDR0100,RQDR0200,RQDR0300
          GOTO      RQDR9999
.
RQDR0100  
....      CALL      LOCSEL00                * Selection List of Location's
          GOTO      RQDR9999
.
RQDR0200  MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      RQDR9999
.
RQDR0300  CALL      MLTH0000                * Hospital list (with security)
          GOTO      RQDR9999
.
RQDR9999  RETURN
.-----------------------------------------------------------
. Option 5 - Medical Record Single Request             
.-----------------------------------------------------------
SING0000  BRANCH    FLDITMNO,SING0100,SING0200,SING0300,SING0400,SING0500:
                             SING0600,SING0700,SING0800,SING0900,SING1000:
                             SING1100,SING1200,SING1300,SING1400,SING1500:
                             SING1600,SING1700
          GOTO      SING9999
.
SING0100  
....      CALL      LOCSEL00                * Selection List of Location's
          GOTO      SING9999
.
SING0200  MATCH     DOCMTYPE,SP70
          IF        @EQUAL
            IF       IBCNMHOS=1
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD<>1
                MOVE      PTHSRCTY,DOCMTYPE
              ENDIF
            ELSE
              MOVE     MRCNRCTY,DOCMTYPE
            ENDIF
.
            MATCH     SP70,WBSEDTYP
            IF        !@EQUAL
              MOVE      WBSEDTYP,DOCMTYPE
            ENDIF
          ENDIF
          MOVE      "TY",CATEGORY           * Selection List of Documents
          MOVE      DOCMTYPE,CODE
          CALL      CODITM00
          GOTO      SING9999
.
SING0300  WRITE     HTMLFILE;URNUMBER;
          GOTO      SING9999
.
SING0400  CALL      HIHVOL00                * Volume Number Selection List 
          GOTO      SING9999
.
SING0500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.      
          PACK      KEY4,SP70               * Selection List of Reasons
          CALL      RSMRMOV1
SING0510  CALL      RKMRMOV1
          BRANCH    OVRCD,SING9999
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      SING0510 IF EQUAL
.
          IF        F1=1
            PACK      KEY30,QUOTE,MRMOREAS,MRMOTYPE,MRMOINDC,MRMOUSAG:
                                  MRMOPERD,QUOTE
          ELSE
            PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          ENDIF
          MATCH     MRMOREAS,REASONMV
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               MRMODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          ENDIF
          GOTO      SING0510
.
SING0600  WRITE     HTMLFILE;WBSENAM;       * User Name
          GOTO      SING9999
.
SING0700  CALL      HISTB000 
          GOTO      SING9999
.
SING0800  WRITE     HTMLFILE;MEDHISKY;      * Medical Record key Hist Table
          GOTO      SING9999
.
SING0900  WRITE     HTMLFILE;MEDRECKY;      * Medical Record key
          GOTO      SING9999
.
SING1000  MOVE      "CP",CATEGORY           * Selection List of Post Discharge
          CALL      CODITM00
          GOTO      SING9999
.
SING1100  WRITE     HTMLFILE;PTCNRQCF;      * Free Format for Requested Para
          GOTO      SING9999
.
SING1200  MOVE      SP70,STAFFKEY           * Set Staff Key
          CALL      MRTSTF00                * Selection List of Mrt Staff   
          GOTO      SING9999
.
SING1300  WRITE     HTMLFILE;MRCNWNHL;                            * I CAR 43134
          GOTO      SING9999
.
SING1400  CALL      HOMLOC00                * Set Hospital & Location defaults 
          GOTO      SING9999
.
SING1500  MOVE      WBSEHOSP,SELHOSP        * Hospital list (with security)   
          CALL      HSEL0000
....      CALL      MLTH0000                * Hospital list (with security)   
          GOTO      SING9999
.
SING1600  
....      CALL      HHMLOC00                * Selection List of Home Location's 
          GOTO      SING9999
.
SING1700  WRITE     HTMLFILE;SUPERLEV;      * Supervisor flag 
          GOTO      SING9999
.
SING9999  RETURN
.------------------------------------------------------------
. Table of History of a Record
.------------------------------------------------------------
HISTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,MEDHISKY
          GOTO      HISTB999 IF EQUAL
.
          PACK      KEY10,MEDHISKY,SP70
          CALL      RDMRMAS2           * Read Medical Record Master File
          BRANCH    OVRCD,HISTB999
.
          PACK      KEY26,MEDHISKY,SP70
          CALL      RDMRHIS1
HISTB100  CALL      RKMRHIS1
          BRANCH    OVRCD,HISTB999
.
          MATCH     MEDHISKY,MRHIKEY
          GOTO      HISTB999 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:HistoryLink('",HTMLLINK
          APPEND    MRHIKEY,HTMLLINK
          APPEND    MRHIDATE,HTMLLINK
          APPEND    MRHITIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          MOVE      SP70,MRLODESC
          PACK      KEY7,MRHIDHOS,MRHILOC                             *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP20                     * start   *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRHIDHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRHIDHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRHIDHOS
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      KEY30,OBR,MRHIDHOS,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRHIDHOS,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC       * format "(HOS)Location"
          ENDIF
          MOVE      KEY70,HLOCDSC1                          * end     *I-240724
.
          MOVE      MRHIREAS,KEY4
          CALL      RDMRMOV1
          IF        OVRCD=1
            MOVE      SP70,MRMODESC
          ENDIF
.
          MOVE      SP70,DISPRECN
          MATCH     SP70,MRHIRCUI
          IF        !@EQUAL
            PACK      KEY10,MRHIRCUI,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      MRHIRCUI,WBSENAM
            ENDIF
            MOVE      WBSENAM,DISPRECN
          ENDIF
.
          MOVE      SP70,DISPRECS
          MOVE      ZERO,F1
          MOVE      MRHIRCST,F1
          LOAD      DISPRECS,F1,RECSTAT1,RECSTAT2,RECSTAT3
.
          MOVE      MRHIUSID,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.
          MOVE      SP70,KEY50
          PACK      PRESDETS,SP70,SP70                                 *I-44792
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,KEY50   * Requested By Free Format
            CALL      GTPEX000         * get pager,ext details         *I-44792
          ELSE
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      KEY50,MRSTGNAM,SP1,MRSTSNAM,SP70
              CALL      GTPEX000                                       *I-44792
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MRHIDATE,MRHITIME,"#",":      * 1
                             "#"",MRHIDDUE,"#",":               * 2
                             "#"",HLOCDSC1,"#",":               * 3
                             "#"",PRESDETS,"#",":               * 4    *C-44792
                             "#"",MRMODESC,"#",":               * 5
                             "#"",WBSENAM,"#",":                * 6
                             "#"",MRHISTAT,"#",":               * 7
                             "#"",MRHICOMM,"#",":               * 8
                             "#"",DISPRECS,"#",":               * 9
                             "#"",MRHIRCDT,MRHIRCTM,"#",":      * 10
                             "#"",DISPRECN,"#");"               * 11
.
          MOVE      USERID,KEY10
          CALL      RDWBSE1
          BRANCH    OVRCD,HISTB100
.
          GOTO      HISTB100
.
HISTB999  RETURN
.------------------------------------------------------------
. Get the pager and extension if there is one.                         *I-44792
.------------------------------------------------------------
GTPEX000  PACK      PRESDETS,SP70,SP70
          PACK      PRESDETS,KEY50
          STRIP     PRESDETS
.
.... I-51445  if using staff code for requester, it needs to have a value
.... to get ext.no and pager no
          COMPARE   ONE,PTCNRQCF
          IF        !@EQUAL
            MATCH     SP20,KEY50         * check for 20 spaces.
            GOTO      GTPEX999 IF EQUAL
          ENDIF
.
          MATCH     SP20,MRHIEXTN
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,EXTNTXT,MRHIEXTN
            STRIP     PRESDETS
          ENDIF
.
          MATCH     SP20,MRHIPAGE
          IF        !@EQUAL
            PACK      PRESDETS,PRESDETS,PAGERTXT,MRHIPAGE
            STRIP     PRESDETS
          ENDIF
.
GTPEX999  RETURN
.------------------------------------------------------------
. Document Types Table Details (TABLE HEADING)
.------------------------------------------------------------
RECHD000   BRANCH    TABLEFLG,RECHD100
.
           WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "Document Type</td>":
                               "<td class=HeadingCell width=20%>":
                               "Current Location</td>":
                               "<td class=HeadingCell align=center width=10%>":
                               "Volume</td>":
                               "<td class=HeadingCell align=center width=10%>":
                               "Moving</td>"
           IF        IBCNMHOS = 1
             WRITE     HTMLFILE;"<td class=HeadingCell width=18%>":
                                "Hospital</td>"
           ENDIF
           WRITE     HTMLFILE;"<td class=HeadingCell width=25%>":
                               "New Location</td>":
                               "<td class=HeadingCell>":
                               "Reason</td>":
                             "</tr>"
.
           GOTO      RECHD999
.
RECHD100   WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=15%>":
                               "Document Type</td>":
                               "<td class=HeadingCell width=20%>":
                               "Current Location</td>":
                               "<td class=HeadingCell align=center width=10%>":
                               "Volume</td>":
                               "<td class=HeadingCell align=center width=10%>":
                               "Moving</td>"
           IF        IBCNMHOS = 1
             WRITE     HTMLFILE;"<td class=HeadingCell width=25%>":
                                "Hospital</td>"
           ENDIF
           WRITE     HTMLFILE;"<td class=HeadingCell width=25%>":
                               "New Location</td>":
                               "<td class=HeadingCell>":
                               "Person Responsible</td>":
                             "</tr>"
.
RECHD999  RETURN
.------------------------------------------------------------
. Document Types (TABLE ROW)
.------------------------------------------------------------
RECRW000  MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20
.
          UNPACK    SP70,MRLODESC
          UNPACK    SP70,CURRLOCA
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          PACK      KEY70,MRLODESC                           * start  *I-240724
          IF        IBCNMHOS = 1
            MOVE      SP70,KEY30
            PACK      KEY30,OBB,MRMACHOS,CBB     * set default to black
            MATCH     MRMAHHOS,MRMACHOS
            IF        !@EQUAL
              MOVE      SP3,PTHSHHOS
              PACK      KEY3,MRMACHOS
              CALL      RDPTHSP1
              MATCH     PTHSHHOS,MRMAHHOS
              IF        !@EQUAL
                PACK      KEY30,OBR,MRMACHOS,CBR     * set to red
              ELSE
                UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
                PACK      KEY5,CATTY,PTHSRCTY                         *C-259106
                CALL      RDCODE1
                MATCH     "B",TCINDC1                       
                IF        !@EQUAL
                  PACK      KEY30,OBR,MRMACHOS,CBR   * set to red
                ENDIF
              ENDIF
            ENDIF
            RESET     KEY30
            PACK      KEY70,KEY30,MRLODESC  * format "(HOS)Location"
          ENDIF
          MOVE      KEY70,CURRLOCA                            * end   *I-240724
.
....      ADD       ONE,FORM2               * Increment parameter counter
....      MOVE      FORM2,KEY2
....      REP       " 0",KEY2
          ADD       ONE,ROWNUM              * Increment parameter counter
          MOVE      ROWNUM,KEY2
          REP       " 0",KEY2
.                                                                     *C-240724
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
.
          WRITE     HTMLFILE;"<input type=hidden name=mrtmas",KEY2," value=#"":
                             KEY20,"#">":
                             "<tr><td>",DIM20,"</td>":
                             "<td>",CURRLOCA,"&nbsp;</td>":
                             "<td align=center>",MRMAVOLN,"</td>":
                             "<td align=center>":
                             "<input type=checkbox name=moverc":
                             KEY2," value=1 onclick='SetLoc(this);'></td>"
          IF        IBCNMHOS = 1
            WRITE     HTMLFILE;"<td><select name=newhos",KEY2," ":
                               "onchange='setNewLocn(#"",KEY2,"#")' >":
                               "<option></option>"
            MOVE      MRMAHHOS,SELHOSP
            CALL      HSEL0000

          ENDIF
          WRITE     HTMLFILE;"</select></td><td><input type=hidden ":
                             "name=d_newloc",KEY2," value=",MRMACLOC,">":
                             "<select name=newloc",KEY2:
                             " onchange='setMov(moverc",KEY2,")' >":
                             "<option></option></select></td>"
.
          MOVE      USERID,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.
          COMPARE   ZERO,TABLEFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><select name=mvreas",KEY2,">"
            CALL      REASEL00 * Selection List of Movement Reasons
          ELSE
            WRITE     HTMLFILE;"<td><select name=peresp",KEY2,">"
            CALL      STALST00 * Selection List of MRT Staff        
..          WRITE     HTMLFILE;"</td><td><input type=text size=30 maxlength=35":
..                             " name=peresp",KEY2," value='":
..                             WBSENAM,"' title='Person Responsible'>":
..                             "<img src='../images/erase.gif' align=absmiddle":
..                             " onclick='clrFields(peresp",KEY2,");'>"

          ENDIF
          WRITE     HTMLFILE;"</td></tr>";
          IF        IBCNMHOS
            WRITE     HTMLFILE;"<script type='text/javascript'> ":
                               "MrtMultiLocations(UpdateForm.newloc",KEY2,",#"":
                                MRMAHLOC,"#",#"",MRMAHHOS,"#") </script>"
          ELSE
            WRITE     HTMLFILE;"<script type='text/javascript'> ":
                               "MrtLocations(UpdateForm.newloc",KEY2,",#"":
                                MRCNHLOC,"#") </script>"
          ENDIF
.
RECRW999  RETURN

.-------------------------------------------------------------------------------
.                         ******* DISDC000 ********
.    Check if there any incomplete discharge records for this patient?
.    First read the visit file by UR and then check Discharge file for
.    this admission.
.-------------------------------------------------------------------------------
DISDC000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          MOVE      F1,DISPRMOR             * Display RMO Responsible or 
.                                           * Display Doctor Responsible
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      F1,DISPDSRQ             * Display Discharge Summary Request
.
          MOVE      ZERO,COUNT 
          CALL      DISHD000      * Output Table Heading
.
          PACK      KEY26,URNUMBER,SP1,THREE,Z70
          CALL      RDSVISA4
DISDC010  CALL      RDPVISA4
          BRANCH    OVRCD,DISDC999
.
          MATCH     URNUMBER,PVIURNO     * Check UR
          GOTO      DISDC999 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE         * Must be an Inpatient    
          GOTO      DISDC999 IF NOT EQUAL  * ????????????????
.
          PACK      KEY8,DPVIBILL,SP70   * Read Discharge File 
          CALL      RDDSCH1
          
.
          PACK      KEY8,DPVIBILL,SP70   * Read Visit Extn File 
          CALL      RDPMVX11           
          BRANCH    OVRCD,DISDC010       * Record not found read next visit
.
          PACK      KEY8,DPVIBILL,SP70   * Read Admission File
          CALL      RDMISS1            
          BRANCH    OVRCD,DISDC010       * Record not found read next visit
.
          PACK      KEY8,DPVIBILL,SP70   * Read Post Discharge File
          CALL      RDMRPDS1
          BRANCH    OVRCD,DISDC010       * Record not found read next visit
.
          PACK      KEY5,CODECP,MRPDSTAT * Check Status 
          CALL      RDCODE1
          IF        OVRCD=0            
            MATCH     "C",TCINDC1        * If equal then Completed & Filed
            GOTO      DISDC010 IF EQUAL
            MOVE      TDESC,STATUS
          ELSE 
            MOVE      "&nbsp;",STATUS
          ENDIF
.
.         Read Post Discharge Status History File
.         Do either an exact match, or search by
.         visit number and find newest record.
.
          MATCH     SP70,MRPDDATE
          IF        !@EQUAL
            PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
            CALL      RDMRPSH1
            IF        OVRCD=1
              MOVE    ONE,HISFLAG    * Record found
            ELSE
              MOVE    ZERO,HISFLAG   * No record found
            ENDIF
          ELSE
            PACK      KEY21,MRPDADMN,Z70
            CALL      RSMRPSH1
            CALL      RPMRPSH1 
            IF        OVRCD=1
              MOVE    ONE,HISFLAG    * Record found 
            ELSE
              MOVE    ZERO,HISFLAG   * No record found
            ENDIF
          ENDIF
.
          COMPARE   "99",COUNT
          GOTO      DISDC800 IF EQUAL   * reached the limit
.
          CALL      DISRW000    * Display Incomplete Discharge Row
          GOTO      DISDC010
.
DISDC800  CALL      LIMREC00        * Show reached limit message
.
DISDC999  RETURN
+
.------------------------------------------------------------
. LIMREC00 - Display "Limit reached" at end of list
.------------------------------------------------------------
LIMREC00  WRITE     HTMLFILE;"<tr bgcolor=#FFFF00>":
                             "<td colspan=9 align=center>":
                             "<b>Found more than 99 records.":
                             "</b></td>"
.
LIMREC99  RETURN
+
.------------------------------------------------------------------------------
.         Table of Post Discharge Status History (reverse chronological order)
.------------------------------------------------------------------------------
TBPDSH00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY21,ADMISSNO,CURRDATE,Z70
          CALL      RSMRPSH1
TBPDSH10  CALL      RPMRPSH1
          BRANCH    OVRCD,PDSH9999
.
          MATCH     DMRPSADM,ADMISSNO
          GOTO      TBPDSH99 IF NOT EQUAL
.
          CALL      PDHSRW00      * Display Post Discharge History Status row
          GOTO      TBPDSH10
.
TBPDSH99  RETURN
+
.------------------------------------------------------------------------------
.         Table Row - Post Discharge Status History
.------------------------------------------------------------------------------
PDHSRW00  MOVE      SP70,ADMDATE
          MOVE      SP70,DISDATE
          MOVE      SP70,STATDESC
          MOVE      SP70,STATDATE
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          COMPARE   THREE,ASTAT
          GOTO      PDHSRW10 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,PDHSRW10
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PDHSRW10  MATCH     SP70,MRPSDATE
          GOTO      PDHSRW15 IF EQUAL
.
          UNPACK    MRPSDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STATDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
PDHSRW15  MOVE      SP70,STATDESC
          MATCH     SP70,MRPSSTAT
          IF        !@EQUAL
            PACK      KEY5,CODECP,MRPSSTAT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,STATDESC
            ENDIF
          ENDIF 
.
PDHSRW20  WRITE     HTMLFILE;"t.addRow(#"",ADMDATE,"#",":       * 0
                             "#"",ADATE,ATIME,"#",":            * 1
                             "#"",DISDATE,"#",":                * 2
                             "#"",DDATE,DTIME,"#",":            * 3
                             "#"",STATDATE,"#",":               * 4
                             "#"",MRPSTIME,"#",":               * 5
                             "#"",MRPSDATE,MRPSTIME,"#",":      * 6
                             "#"",STATDESC,"#",";               * 7
.
          MATCH     "1",MRPSMIS1                                        * 8
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails1);'>#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF   
.
          MATCH     "1",MRPSMIS2                                        * 9
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails2);'>#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          MATCH     "1",MRPSMIS3                                        * 10
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails3);'>#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          MATCH     "1",MRPSMIS4                                        * 11
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails4);'>#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          MATCH     "1",MRPSMIS5                                        * 12
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails5);'>#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          MATCH     "1",MRPSMIS6                                        * 13
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<img notab src='../images/tick.gif'":
                           " class=Icon onmouseover=":
                           "'showMouseOverText(MRCodingMissingDetails6);'>#")"
          ELSE
            WRITE     HTMLFILE;"#"#")"
          ENDIF
.
PDHSRW99  RETURN
+
.------------------------------------------------------------
. Incomplete Discharges (TABLE HEADING)
.------------------------------------------------------------
DISHD000  MOVE      SP70,CPDESC
          PACK      KEY5,ANSC,ANSP,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,CPDESC
          ENDIF   
.
          MATCH     "0",MRCNEACA
          IF        !@EQUAL
            CALL      DISHDA00
            GOTO      DISHD999
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=12%>":
                             "Admission Date</td>":
                             "<td class=HeadingCell width=12%>":
                             "Discharge Date</td>":
                             "<td class=HeadingCell width=12%>";
.
          WRITE     HTMLFILE;CPDESC,"</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell align=center width=17%>":
                               "Missing Details<br> 1 &nbsp;&nbsp; 2 &nbsp;":
                               "&nbsp; 3 &nbsp;&nbsp; 4 &nbsp;&nbsp; 5 &nbsp;":
                               "&nbsp; 6 </td>":
                               "<td class=HeadingCell width=20%>":
                               "Dr Responsible</td>";
.
         IF         DISPDSRQ=1
           WRITE      HTMLFILE;"<td class=HeadingCell width=20%>":
                               "&nbsp;</td>";
         ENDIF
.
         WRITE      HTMLFILE;"</tr>";
.
DISHD999  RETURN
.
.------------------------------------------------------------
. Incomplete Discharges (TABLE HEADING)
.------------------------------------------------------------
DISHDA00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=8%>":
                             "Admission Date</td>":
                             "<td class=HeadingCell width=8%>":
                             "Discharge Date</td>":
                             "<td class=HeadingCell width=8%>":
                             "Visit No.</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=8%>";
.
          WRITE     HTMLFILE;CPDESC,"</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell align=left width=20%>":
                             "Missing Details<br>";
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=0":
                             " width=100% align=center>":
                             "<tr>":
                           "<td width=7% align=left class=HeadingCell>1</td>":
                           "<td width=7% align=left class=HeadingCell>2</td>":
                           "<td width=7% align=left class=HeadingCell>3</td>":
                           "<td width=7% align=left class=HeadingCell>4</td>":
                           "<td width=7% align=left class=HeadingCell>5</td>":
                           "<td width=7% align=left class=HeadingCell>6</td>":
                           "<td width=12% align=center class=HeadingCell></td>":
                           "<td width=13% align=left ":
                           "class=HeadingCell>Comment</td>":
                           "<td width=33%>&nbsp;</td>":
                           "</td></tr></table></td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=20%>":
                             "Dr Responsible</td>";
.
          IF         DISPDSRQ=1
            WRITE      HTMLFILE;"<td class=HeadingCell width=20%>":
                                "&nbsp;</td>";
          ENDIF 
.
          WRITE      HTMLFILE;"</tr>";
.
DISHDA99  RETURN
.
.------------------------------------------------------------
. Post Discharge Tracking (TABLE ROW)
.------------------------------------------------------------
DISRW000  MATCH     "0",MRCNEACA
          IF        !@EQUAL
            CALL      DISRWA00
            GOTO      DISRW999
          ENDIF
.
          ADD       ONE,COUNT   * Increment parameter counter
          MOVE      COUNT,KEY2
          REP       " 0",KEY2
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    SDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<input type=hidden name=admiss",KEY2," value=#"":
                             DPVIBILL,"#">":
                             "<tr><td>",ADMDATE,"</td>":
                             "<td>",DISDATE,"</td>":
                             "<td><select name=distat",KEY2,">"
          CALL      DISTAT00  * Discharge Status selection List
          WRITE     HTMLFILE;"</select></td><td align=center>"
          CALL      MISSDT00  * Missing Details tick boxes
          WRITE     HTMLFILE;"</td><td>"
.
          IF        DISPRMOR = 0
            CALL      DISDOC00              * Display Doctor
          ELSE
            WRITE     HTMLFILE;"<select name=disrmo",KEY2,">"
            CALL      DISRMO00              * Discharge RMO Responsible
            WRITE     HTMLFILE;"</select>";
          ENDIF
.
          IF        DISPDSRQ=1
            WRITE     HTMLFILE;"</td><td><input type=button class=button type=button value=Request onclick='linkPatient(#"",DPVIBILL,"#")'></td></tr>";
          ELSE
            WRITE     HTMLFILE;"</td></tr>";
          ENDIF
.
DISRW999 RETURN
.
.------------------------------------------------------------
. Post Discharge Tracking (TABLE ROW)
.------------------------------------------------------------
DISRWA00  ADD       ONE,COUNT   * Increment parameter counter
          MOVE      COUNT,KEY2
          REP       " 0",KEY2
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    SDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<input type=hidden name=admiss",KEY2," value=#"":
                             DPVIBILL,"#">":
                             "<tr><td width=8%>";
          WRITE     HTMLFILE;"<img src='../images/AppointmentIcon.gif'":
                             " class=ListIcon onclick='PatientDetails(":
                             "#"",URNUMBER,"#",":
                             "#"",MRPDADMN,"#");'>":
                             ADMDATE,"</td>":
                             "<td width=8%>",DISDATE,"</td>";
.
          WRITE     HTMLFILE;"<td width=8%>",DPVIBILL,"</td>";
.
          WRITE     HTMLFILE;"<td width=8%><select name=distat",KEY2,">";
          CALL      DISTAT00  * Discharge Status selection List
          WRITE     HTMLFILE;"</select></td><td align=left width=20%>";
          CALL      MISSDA00  * Missing Details tick boxes
          WRITE     HTMLFILE;"</td><td width=20%>";
.
          IF        DISPRMOR = 0
            CALL      DISDOC00              * Display Doctor
          ELSE
            WRITE     HTMLFILE;"<select name=disrmo",KEY2,">";
            CALL      DISRMO00              * Discharge RMO Responsible
            WRITE     HTMLFILE;"</select>";
          ENDIF
.
          IF        DISPDSRQ=1
            WRITE     HTMLFILE;"</td><td width=20%>":
                               "<input type=button class=button type=button":
                               " value=Request ":
                               "onclick='linkPatient(#"",DPVIBILL,"#")'>":
                               "</td></tr>";
          ELSE
            WRITE     HTMLFILE;"</td></tr>";
          ENDIF
.
DISRWA99 RETURN
.
.--------------------------------------------------------------------------
. Missing Details Tick Boxes
.--------------------------------------------------------------------------
MISSDT00  BRANCH    HISFLAG,MISSDT10
.
          MATCH     "1",MRPSMIS1
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd1":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd1":
                                KEY2," value=1>";
          ENDIF
.
          MATCH     "1",MRPSMIS2
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd2":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd2":
                                KEY2," value=1>";
          ENDIF
.
          MATCH     "1",MRPSMIS3
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd3":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd3":
                                KEY2," value=1>";
          ENDIF
.
          MATCH     "1",MRPSMIS4
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd4":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd4":
                                KEY2," value=1>";
          ENDIF
.
          MATCH     "1",MRPSMIS5
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd5":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd5":
                                KEY2," value=1>";
          ENDIF
.
          MATCH     "1",MRPSMIS6
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd6":
                                KEY2," value=1 checked>";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd6":
                                KEY2," value=1>";
          ENDIF
.
          GOTO      MISSDT99
.
. No vaild read was found on file, so output unticked boxes.
.
MISSDT10  WRITE     HTMLFILE;"<input type=checkbox name=missd1":
                              KEY2," value=1>":
                             "<input type=checkbox name=missd2":
                              KEY2," value=1>":
                             "<input type=checkbox name=missd3":
                              KEY2," value=1>":
                             "<input type=checkbox name=missd4":
                              KEY2," value=1>":
                             "<input type=checkbox name=missd5":
                              KEY2," value=1>":
                             "<input type=checkbox name=missd6":
                              KEY2," value=1>";

MISSDT99  RETURN
.
.--------------------------------------------------------------------------
. Missing Details Tick Boxes 
.--------------------------------------------------------------------------
MISSDA00  BRANCH    HISFLAG,MISSDA10     
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=0":
                             " width=100% align=center>":
                             "<tr>";
.         
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";          
          MATCH     "1",MRPSMIS1 
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd1":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd1":
                                KEY2," value=1";
          ENDIF 
          WRITE     HTMLFILE;" onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails1);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";
          MATCH     "1",MRPSMIS2
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd2":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd2":
                                KEY2," value=1";
          ENDIF
          WRITE     HTMLFILE;" onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails2);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";
          MATCH     "1",MRPSMIS3
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd3":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd3":
                                KEY2," value=1";
          ENDIF
          WRITE     HTMLFILE;" onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails3);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";
          MATCH     "1",MRPSMIS4
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd4":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd4":
                                KEY2," value=1";
          ENDIF
          WRITE     HTMLFILE;" onmouseover='showMouseOverText":
                             "(MRCodingMissingDetails4);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";
          MATCH     "1",MRPSMIS5
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd5":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd5":
                                KEY2," value=1";
          ENDIF
          WRITE     HTMLFILE;" onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails5);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>";
          MATCH     "1",MRPSMIS6
          IF        @EQUAL
            WRITE     HTMLFILE;"<input type=checkbox name=missd6":
                                KEY2," value=1 checked";
          ELSE
            WRITE     HTMLFILE;"<input type=checkbox name=missd6":
                                KEY2," value=1";
          ENDIF
          WRITE     HTMLFILE;" onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails6);'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=12% align=center class=DataLabel>";
          WRITE     HTMLFILE;"<img notab src='../images/MaintenanceIcon.gif'":
                             " class=Icon onmouseover=":
                             "'showMouseOverText(#"":
                             "Post Discharge Status History details#");'":
                             " onclick='ShowStatusHistory();'>";
          WRITE     HTMLFILE;"</td>";
.
          PACK      DIM80,SP70,SP70
          MOVE      SP70,CHECKFLG
          MATCH     DIM80,MRPSFTM1
          IF        !@EQUAL
            MOVE      "checked",CHECKFLG
          ENDIF
.
          WRITE     HTMLFILE;"<td width=13% align=left class=DataLabel>";
          WRITE     HTMLFILE;"<input type=checkbox name=missd7":
                              KEY2," id=missd7",KEY2," value=1 ":
                             CHECKFLG," title='":
                             "Click to maintain missing details comment'":
                             " onclick='ShowMissingDetailComment(":
                             "#"missd7",KEY2,"#",":
                             "#"",MRPDADMN,"#",":
                             "#"",MRPDDATE,"#",":
                             "#"",MRPDTIME,"#",":
                             "#"mpfmt1",KEY2,"#");'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=33%>":
                             "<input type=hidden name=mpfmt1":
                              KEY2," id=mpfmt1",KEY2," value=#"":
                             MRPSFTM1,"#">":
                             "</td>";
          WRITE     HTMLFILE;"</tr></table>"
.
          GOTO      MISSDA99
.
. No vaild read was found on file, so output unticked boxes.
.
MISSDA10  WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=0":
                             " width=100% align=center>":
                             "<tr>";
.
          WRITE     HTMLFILE;"<td width=7% align=left class=DataLabel>":      
                             "<input type=checkbox name=missd1":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails1);'>":
                             "</td>":
                             "<td width=7% align=left class=DataLabel>":
                             "<input type=checkbox name=missd2":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails2);'>":
                             "</td>":
                             "<td width=7% align=left class=DataLabel>":
                             "<input type=checkbox name=missd3":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails3);'>":
                             "</td>":
                             "<td width=7% align=left class=DataLabel>":
                             "<input type=checkbox name=missd4":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails4);'>":
                             "</td>":
                             "<td width=7% align=left class=DataLabel>":
                             "<input type=checkbox name=missd5":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails5);'>":
                             "</td>":
                             "<td width=7% align=left class=DataLabel>":
                             "<input type=checkbox name=missd6":
                              KEY2," value=1":
                             " onmouseover='":
                             "showMouseOverText(MRCodingMissingDetails6);'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td width=12% align=center class=DataLabel>";
          WRITE     HTMLFILE;"<img notab src='../images/MaintenanceIcon.gif'":
                             " class=Icon onmouseover=":
                             "'showMouseOverText(#"":
                             "Post Discharge Status History details#");'":
                             " onclick='ShowStatusHistory();'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=13% align=left class=DataLabel>";
          WRITE     HTMLFILE;"<input type=checkbox name=missd7":
                              KEY2," id=missd7",KEY2," value=0 ":
                             "title='":
                             "Click to maintain missing details comment'":
                             " onclick='ShowMissingDetailComment(":
                             "#"missd7",KEY2,"#",":
                             "#"",MRPDADMN,"#",":
                             "#"",MRPDDATE,"#",":
                             "#"",MRPDTIME,"#",":
                             "#"mpfmt1",KEY2,"#");'>";
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td width=33%>":
                             "<input type=hidden name=mpfmt1":
                              KEY2," id=mpfmt1",KEY2," value=#"":
                             MRPSFTM1,"#">":
                             "</td>";
          WRITE     HTMLFILE;"</tr></table>"
.
MISSDA99  RETURN
.------------------------------------------------------------
.  Display Doctor
.------------------------------------------------------------
DISDOC00  MATCH     SP70,MRPDDOCT     * Doctor from MRTPDSFD
          GOTO      DISDOC10 IF EQUAL 
.
          PACK      KEY6,MRPDDOCT,SP70       
          CALL      RDDOCT1 
          BRANCH    OVRCD,DISDOC10 
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,DISPDOC
.
          WRITE     HTMLFILE;"<input type=hidden name=doctor":
                             KEY2," value=#"",DCODE,"#">":
                             "<input type=text size=25 maxlength=25 ":
                             "name=dummyc",KEY2," value=#"",DISPDOC,"#">":
                             "<img src=#"../images/SearchIcon.gif#" class=Icon":
                             " onClick=#"DoctorSearchFrame(":
                             "doctor",KEY2,",dummyc",KEY2,");#">":  
                             "<img src=#"../images/erase.gif#" class=Icon ": 
                             "onClick=#"clrDoc(doctor",KEY2,",dummyc",KEY2,");":
                             "#">";  
.
          GOTO      DISDOC99 
.
DISDOC10  PACK      KEY6,ADOCTA,SP70   * Defualt Doctor Attending from 
          CALL      RDDOCT1            * Admission Record 
          BRANCH    OVRCD,DISDOC20 
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,DISPDOC
.
          WRITE     HTMLFILE;"<input type=hidden name=doctor":
                             KEY2," value=#"",DCODE,"#">":
                             "<input type=text size=25 maxlength=25 ":
                             "name=dummyc",KEY2," value=#"",DISPDOC,"#">":
                             "<img src=#"../images/SearchIcon.gif#" class=Icon":
                             " onClick=#"DoctorSearchFrame(":
                             "doctor",KEY2,",dummyc",KEY2,");#">":  
                             "<img src=#"../images/erase.gif#" class=Icon ": 
                             "onClick=#"clrDoc(doctor",KEY2,",dummyc",KEY2,");":
                             "#">";  
.
          GOTO      DISDOC99 
.
DISDOC20  MOVE      SP70,KEY1   * defualt empty input box 
          WRITE     HTMLFILE;"<input type=hidden name=doctor":
                             KEY2," value=",KEY1,">":
                             "<input type=text name=dummyc":
                             KEY2," size=25 value=",KEY1,">":
                             "<img src=#"../images/SearchIcon.gif#" class=Icon":
                             " onClick=#"DoctorSearchFrame(":
                             "doctor",KEY2,",dummyc",KEY2,");#">":  
                             "<img src=#"../images/erase.gif#" class=Icon ": 
                             "onClick=#"clrDoc(doctor",KEY2,",dummyc",KEY2,");":
                             "#">";  
.
DISDOC99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of Discharge Status Code Descriptions
.                   ******** DISTAT00 ********
.----------------------------------------------------------------
DISTAT00  WRITE     HTMLFILE;"<option></option>"

          PACK      KEY5,CODECP,SP70
          CALL      RDSCODE1 
DISTAT10  CALL      RDKCODE1
          BRANCH    OVRCD,DISTAT99
.
          MATCH     TCODE,CODECP
          GOTO      DISTAT99 IF NOT EQUAL        
.
          MATCH     ACODE,MRPDSTAT
          IF        @EQUAL 
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#" selected>":
                                 TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV          * Inactive Discharge Status Code
            GOTO      DISTAT10 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#">":
                                 TDESC,"</option>"
          ENDIF
          GOTO    DISTAT10
.
DISTAT99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of Discharge Status Code Descriptions
.                   ******** DISRMO00 ********
.----------------------------------------------------------------
DISRMO00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
. 
          MATCH     SP70,MRPDRMOR
          GOTO      DISRMO20 IF NOT EQUAL
.
          PACK      KEY5,CODEMO,SP70        * Default RMO from visit extn file
          CALL      RDSCODE1
DISRMO10  CALL      RDKCODE1
          BRANCH    OVRCD,DISRMO99
.
          MATCH     TCODE,CODEMO
          GOTO      DISRMO99 IF NOT EQUAL
.
          MATCH     ACODE,PMVXRMOR
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#" selected>":
                                 TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#">":
                                 TDESC,"</option>"
          ENDIF
          GOTO    DISRMO10
.
DISRMO20  PACK      KEY5,CODEMO,SP70         * Default list from current RMO
          CALL      RDSCODE1
DISRMO25  CALL      RDKCODE1
          BRANCH    OVRCD,DISRMO99
.
          MATCH     TCODE,CODEMO
          GOTO      DISRMO99 IF NOT EQUAL
.
          MATCH     ACODE,MRPDRMOR
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#" selected>":
                                 TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",ACODE,"#">":
                                 TDESC,"</option>"
          ENDIF
          GOTO    DISRMO25
.
DISRMO99  RETURN
.-------------------------------------------------------------------------------
. Discharge Summary Request
.-------------------------------------------------------------------------------
DSRQ0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      DSRQ5000 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      DSRQ1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      DSRQ2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Discharge formaction
          GOTO      DSRQ3000 IF EQUAL
.
          GOTO      DSRQ9300
.
.         ************ ADD FORMACTION ***********
.
DSRQ1000  MOVE      ADMISSNO,MRTDS001
.
          MOVE      "  1",MRTDS002
          PACK      KEY11,MRTDS001,Z70
          CALL      RSMRDSR1
          CALL      RPMRDSR1
          IF        OVRCD=0
            MATCH     MRTDS001,MRDSVISN
            IF        @EQUAL
              ADD       ONE,MRDSCNT
              MOVE      MRDSCNT,MRTDS002
            ENDIF
          ENDIF
.
          CALL      IBACLOCK
          PACK      MRTDS003,CCC,CYY,CMM,CDD
          REP       " 0",MRTDS003
.
          CALL      MVBOK000
.
          PACK      MRDSSPAR,SP70,SP70
.
.          PACK      KEY11,MRDSVISN,DMRDSCNT,SP70
.          CALL      RAMRDSR1
.          IF        OVRCD=1
.            CALL      WRMRDSR1
.          ENDIF
.
. ***** Print Discharge Summary Request Section *****
.
          MATCH     "0",MRTDS011
          GOTO      DSRQ1500 IF NOT EQUAL
.
          MATCH     SP70,MRTDS012
          GOTO      DSRQ1999 IF EQUAL
.
          MATCH     SP70,MRTDS013
          GOTO      DSRQ1999 IF EQUAL
.
          CALL      CHKCOD00
          BRANCH    EXIT,DSRQ9999
.
          CALL      READFIL0
.
          MOVE      MRTDS012,SELPRINT
          MOVE      MRTDS013,STATNCOD
          CALL      MRPRN000
.
          CALL      CLSPRINT
.
          GOTO      DSRQ1999
.
. ***** Fax Discharge Summary Request Section *****
.
DSRQ1500  MATCH     "1",MRTDS011
          GOTO      DSRQ1999 IF NOT EQUAL
.
          MATCH     SP70,MRTDS013
          GOTO      DSRQ1999 IF EQUAL
.
          CALL      CHKCOD00
          BRANCH    EXIT,DSRQ9999
.
          CALL      READFIL0
.
          MOVE      "S",SELPRINT
          MOVE      MRTDS013,STATNCOD
          CALL      MRPRN000
.
          CALL      FAXPRINT
.
          GOTO      DSRQ1999
.
DSRQ1999  PACK      KEY11,MRDSVISN,DMRDSCNT,SP70
          CALL      RAMRDSR1
          IF        OVRCD=1
            CALL      WRMRDSR1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      DSRQ9999
.
.         ************ UPDATE FORMACTION ***********
.
DSRQ2000  
          MOVE      ZERO,EXIT
          GOTO      DSRQ9999
.
.         ************ DELETE FORMACTION ***********
.
DSRQ3000  PACK      KEY11,ADMISSNO,MRTDS002,SP70
          CALL      DEMRDSR1
          BRANCH    OVRCD,DSRQ9500
.
          MOVE      ZERO,EXIT
          GOTO      DSRQ9999
.
.         ************ DISPLAY FORMACTION **********
.
DSRQ5000  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,DSRQ9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70   * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,DSRQ9400       * Record not found dis error message
.
          MATCH     "3",TEMPLATE
          IF        @EQUAL
            PACK      KEY11,ADMISSNO,MRTDS002,SP70
            CALL      RDMRDSR1
            BRANCH    OVRCD,DSRQ9500
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Discharge Summary Request",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DSRQ9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DSRQ9999
.
DSRQ9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSRQ9999
.
DSRQ9300  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSRQ9999
.
DSRQ9400  MOVE      "Admission Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSRQ9999
.
DSRQ9500  MOVE      "Discharge Request Record Not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DSRQ9999
.
DSRQ9999  RETURN
+
.-------------------------------------------------------------------------------
.         Post Discharge Status History
.-------------------------------------------------------------------------------
PDSHIS00  MOVE      URNUMBER,KEY8           * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PDSHIS91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70      * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PDSHIS92          * Record not found dis error message
.
          CALL      IBACLOCK
.
          CLEAR     WEBTITLE
          MOVE      "Post Discharge Status History",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PDSHIS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PDSHIS99
.
PDSHIS91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PDSHIS99
.
PDSHIS92  MOVE      "Admission Record Not Found. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PDSHIS99
.
PDSHIS93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PDSHIS99
.
PDSHIS99  RETURN
+
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
MRTDSSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,MRTDS001,MRTDS002,MRTDS003,MRTDS004,MRTDS005:
                               MRTDS006,MRTDS007,MRTDS008,MRTDS009,MRTDS010:
                               MRTDS011,MRTDS012,MRTDS013
          RETURN
.------------------------------------------------------------
. Move in Booking Details
.------------------------------------------------------------
MVBOK000  MATCH     Z70,MRTDS001
          IF        !@EQUAL
            MOVE       MRTDS001,MRDSVISN
          ENDIF
          MATCH     Z70,MRTDS002
          IF        !@EQUAL
            MOVE       MRTDS002,DMRDSCNT            
            SQUEEZE    MRTDS002
            MOVE       MRTDS002,MRDSCNT
          ENDIF
          MATCH     Z70,MRTDS003
          IF        !@EQUAL
            MOVE       MRTDS003,MRDSDTRQ
          ENDIF
          MATCH     Z70,MRTDS004
          IF        !@EQUAL
            MOVE       MRTDS004,MRDSCONS
          ENDIF
          MATCH     Z70,MRTDS005
          IF        !@EQUAL
            MOVE       MRTDS005,MRDSLTST
          ENDIF
          MATCH     Z70,MRTDS006
          IF        !@EQUAL
            MOVE       MRTDS006,MRDSCOM1
          ENDIF
          MATCH     Z70,MRTDS007
          IF        !@EQUAL
            MOVE       MRTDS007,MRDSCOM2
          ENDIF
          MATCH     Z70,MRTDS008
          IF        !@EQUAL
            MOVE       MRTDS008,MRDSCOM3
          ENDIF
          MATCH     Z70,MRTDS009
          IF        !@EQUAL
            MOVE       MRTDS009,MRDSCOM4
          ENDIF
          MATCH     Z70,MRTDS010
          IF        !@EQUAL
            MOVE       MRTDS010,MRDSCOM5
          ENDIF
          RETURN
.
.-----------------------------------------------------------
. Option 7 - Discharge Summary Request tags
.-----------------------------------------------------------
DRRT0000  BRANCH    FLDITMNO,DRRT0100,DRRT0200,DRRT0300,DRRT0400,DRRT0500:
                             DRRT0600,DRRT0700,DRRT0800,DRRT0900,DRRT1000:
                             DRRT1100
          GOTO      DRRT9999
.
DRRT0100  CALL      DSRTAB00    * Table of Discharge Summary Requests
          GOTO      DRRT9999
.
DRRT0200  WRITE     HTMLFILE;MRDSVISN;
          GOTO      DRRT9999
.
DRRT0300  WRITE     HTMLFILE;MRDSCNT;
          GOTO      DRRT9999
.

DRRT0400  MATCH     SP70,MRDSDTRQ
          GOTO      DRRT9999 IF EQUAL
          UNPACK    MRDSDTRQ,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NO
.
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      DRRT9999
.
DRRT0500  MOVE      MRDSCONS,DOCTCODE
          CALL      DOCDET00
          GOTO      DRRT9999
.
DRRT0600  MATCH     "  1",MRDSLTST
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      DRRT9999
.
DRRT0700  WRITE     HTMLFILE;MRDSCOM1;
          GOTO      DRRT9999
.
DRRT0800  WRITE     HTMLFILE;MRDSCOM2;
          GOTO      DRRT9999
.
DRRT0900  WRITE     HTMLFILE;MRDSCOM3;
          GOTO      DRRT9999
.
DRRT1000  WRITE     HTMLFILE;MRDSCOM4;
          GOTO      DRRT9999
.
DRRT1100  WRITE     HTMLFILE;MRDSCOM5;
          GOTO      DRRT9999
.
DRRT9999  RETURN
.-----------------------------------------------------------
. DSRTAB00 - Output Discharge Summary Request Table Details
.-----------------------------------------------------------
DSRTAB00  PACK      KEY11,ADMISSNO,SP70
          CALL      RSMRDSR1
DSRTAB10  CALL      RKMRDSR1
          BRANCH    OVRCD,DSRTAB99
.
          MATCH     ADMISSNO,MRDSVISN
          GOTO      DSRTAB99 IF NOT EQUAL
.
          UNPACK    MRDSDTRQ,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<A HREF='javascript:":
                             "document.PatientLinks.template.value=3;":
                        "document.PatientLinks.mrtds002.value=#"",MRDSCNT,"#";":
                             "PatientLinkTo(#"mrtweb04.pbl#",7,3,1,600,400)'>":
                             " <img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>",DIM11,"</td>":
                             "<td width=33%>",MRDSCONS,"</td>";
          MATCH     "  1",MRDSLTST
          IF        @EQUAL
            WRITE     HTMLFILE;"<td width=33%>Yes</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td width=33%>No</td></tr>";
          ENDIF
.
          GOTO      DSRTAB10
.
DSRTAB99  RETURN
.------------------------------------------------------------
. Check Stationary Code
.------------------------------------------------------------
CHKCOD00  MOVE      ZERO,EXIT                     * initialize exit flag
.
          MOVE      MRTDS013,KEY6
          CALL      RDIBTH1
          COMPARE   ONE,OVRCD
          GOTO      CHKCOD99 IF NOT EQUAL         * On file ?
.
          MOVE      "Stationery Code not on File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                      * Stat. code not on file
CHKCOD99  RETURN
.------------------------------------------------------------
. READFIL0   used to read files for printing                 
.------------------------------------------------------------
READFIL0  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            CALL      CLPATDAD
          ENDIF
.
READFIL9  RETURN
.------------------------------------------------------------
. CLPATRE1 - Clear Person Responsible for Account Variables
.------------------------------------------------------------
CLPATRE1  MOVE     ZEROVISN,PKADMN
          PACK     PKNAME,SP70,SP10
          MOVE     SP70,PKADD1
          MOVE     SP70,PKADD2
          MOVE     SP70,PKSUBR
          MOVE     SP70,PKADD4
          MOVE     SP70,PKPOST
          MOVE     SP70,PKTELEP
          MOVE     SP70,PKTELEB
          MOVE     SP70,PKRELP
          RETURN
.------------------------------------------------------------
. CLPATDAD - Clear Transfer Destination Variables
.------------------------------------------------------------
CLPATDAD  MOVE     ZEROVISN,PTDAADMN
          MOVE     SP70,PTDAADTS
          MOVE     SP70,PTDADCTS
          MOVE     SP70,PTDASPAR
          RETURN
.
.------------------------------------------------------------
. MRPRN000
. Routine to print the discharge summary request form    
.------------------------------------------------------------
MRPRN000  CALL      OPNPRINT                   * open the spool file
.         
          PRINT     *N;
          MOVE      ONE,CURRROW
          PACK      KEY12,MRTDS013,SP6
          CALL      RSIBDET1                   * position on the details file
          CALL      RKIBDET1
          BRANCH    OVRCD,MRPRN990
.
          MATCH     MRTDS013,IBDTSCOD           * match stationary codes
          GOTO      MRPRN990 IF NOT EQUAL
.
          MOVE      IBDTROW,LASTROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
.------ print new-lines until current row equals the one read in ------
.
MRPRN050  PRINT     *N;
          ADD       ONE,CURRROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
          GOTO      MRPRN050
.
.------ read through the details file ------
.
MRPRN100  CALL      RKIBDET1
          BRANCH    OVRCD,MRPRN900
.
          MATCH     MRTDS013,IBDTSCOD           * match stationary codes
          GOTO      MRPRN900 IF NOT EQUAL
.
          MOVE      IBDTROW,LASTROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
.------ print new-lines until current row equals the one read in ------
.
MRPRN110  PRINT     *N;
          ADD       ONE,CURRROW
.
          COMPARE   CURRROW,IBDTROW            * compare rows
          GOTO      MRPRN200 IF EQUAL
.
          GOTO      MRPRN110
.
.------ branch on the field type ------
.
MRPRN200  BRANCH    IBDTINDC,MRPRN300,MRPRN400
.
.------ the field is a text field ------
.
MRPRN300  RESET     IBDTTXFL,IBDTPLEN
          LENSET    IBDTTXFL
          RESET     IBDTTXFL
          PRINT     *IBDTCOL,*+,IBDTTXFL;
          GOTO      MRPRN100
.
.------ the field is a data field ------
.
MRPRN400  MOVE      IBDTTXFL,DIM5
          MOVE      DIM5,FORM5
.
          PACK      VARIABLE,SP70,SP70
.
. ******* INSERT BRANCH STATEMENT HERE *******
.
          BRANCH    FORM5,MRPRN401,MRPRN402,MRPRN403,MRPRN404,MRPRN405: * 5
                          MRPRN406,MRPRN406,MRPRN408,MRPRN409,MRPRN410: * 10
                          MRPRN411,MRPRN412,MRPRN413,MRPRN414,MRPRN415: * 15
                          MRPRN416,MRPRN417,MRPRN418,MRPRN419,MRPRN420: * 20
                          MRPRN421,MRPRN422,MRPRN423,MRPRN424,MRPRN425: * 25
                          MRPRN501,MRPRN503,MRPRN505,MRPRN506,MRPRN507: * 30
                          MRPRN508,MRPRN510,MRPRN512,MRPRN513,MRPRN514: * 35
                          MRPRN515,MRPRN516,MRPRN517,MRPRN518,MRPRN519: * 40
                          MRPRN520,MRPRN521,MRPRN522,MRPRN523,MRPRN524: * 45
                          MRPRN525,MRPRN527,MRPRN530,MRPRN531,MRPRN532: * 50
                          MRPRN600,MRPRN601,MRPRN605,MRPRN606,MRPRN607: * 55
                          MRPRN608,MRPRN609,MRPRN610,MRPRN611,MRPRN612: * 60
                          MRPRN613,MRPRN614,MRPRN615,MRPRN616,MRPRN618: * 65
                          MRPRN619,MRPRN620,MRPRN621,MRPRN622,MRPRN623: * 70
                          MRPRN624,MRPRN701,MRPRN710,MRPRN711,MRPRN712: * 75
                          MRPRN713,MRPRN716,MRPRN717,MRPRN718,MRPRN719: * 80
                          MRPRN720,MRPRN721,MRPRN722,MRPRN723,MRPRN724: * 85
                          MRPRN725,MRPRN727,MRPRN728,MRPRN729,MRPRN730: * 90
                          MRPRN732,MRPRN733,MRPRN734,MRPRN736,MRPRN738: * 95
                          MRPRN740,MRPRN741,MRPRN742,MRPRN743,MRPRN746: * 100
                          MRPRN748,MRPRN749,MRPRN750,MRPRN751,MRPRN753: * 105
                          MRPRN754,MRPRN756,MRPRN757,MRPRN759,MRPRN760: * 110
                          MRPRN762,MRPRN763,MRPRN765,MRPRN766,MRPRN767: * 115
                          MRPRN768,MRPRN769,MRPRN770,MRPRN771,MRPRN773: * 120
                          MRPRN775,MRPRN777,MRPRN779,MRPRN780,MRPRN782: * 125
                          MRPRN783,MRPRN785,MRPRN786,MRPRN788,MRPRN789: * 130
                          MRPRN791,MRPRN792,MRPRN794,MRPRN795,MRPRN797: * 135
                          MRPRN798,MRPRN800,MRPRN802,MRPRN803,MRPRN804: * 140
                          MRPRN808,MRPRN809,MRPRN810,MRPRN811,MRPRN812: * 145
                          MRPRN813,MRPRN814,MRPRN815,MRPRN816,MRPRN817: * 150
                          MRPRN818,MRPR1004,MRPR1005,MRPR1006,MRPR1008: * 155
                          MRPR1010,MRPR1012,MRPR1014,MRPR1015,MRPR1016: * 160
                          MRPR1017,MRPR1018,MRPR1019,MRPR1020,MRPR1021: * 165
                          MRPR1022,MRPR1023,MRPR1024,MRPR1025,MRPR1026: * 170
                          MRPR1027,MRPR1028,MRPR1029,MRPR1030,MRPR1031: * 175
                          MRPR1032,MRPR1033,MRPR1034,MRPR1035,MRPR1036: * 180
                          MRPR1037,MRPR1038,MRPR1039,MRPR1040,MRPR1041: * 185
                          MRPR1042,MRPR1043,MRPR1044,MRPR1045,MRPR1046: * 190
                          MRPR1047,MRPR1400,MRPR1436,MRPR1440,MRPR1444: * 195
                          MRPR1448,MRPR2263,MRPR2263,MRPR2263,MRPR2263: * 200
                          MRPR2263,MRPR2263,MRPR2263,MRPR2263,MRPR2266: * 205
                          MRPR2270,MRPR2270,MRPR2270,MRPR2270,MRPR2270: * 210
                          MRPR2270,MRPR2272,MRPR2273,MRPR2273,MRPR2273: * 215
                          MRPR2273,MRPR2275,MRPR2288,MRPR2292,MRPR2296: * 220
                          MRPR2297,MRPR2299,MRPR2303,MRPR2304,MRPR2305: * 225
                          MRPR2306,MRPR2307,MRPR2308,MRPR2309,MRPR2310: * 230
                          MRPR2311,MRPR2312,MRPR2313,MRPR2314,MRPR2315: * 235
                          MRPR2316,MRPR2317,MRPR2318,MRPR2319,MRPR2320: * 240
                          MRPR2328,MRPR2329,MRPR2330,MRPR2331,MRPR2332: * 245
                          MRPR2333,MRPR2334,MRPR2335,MRPR2336,MRPR2337: * 250
                          MRPR2338,MRPR2339,MRPR2340,MRPR2341,MRPR2342: * 255
                          MRPR2343,MRPR2344,MRPR2345,MRPR2346,MRPR2347: * 260
                          MRPR2348,MRPR2349,MRPR2350,MRPR2351,MRPR2352: * 265
                          MRPR2353,MRPR2354,MRPR2355,MRPR2356,MRPR2357: * 270
                          MRPR2358,MRPR2359,MRPR2360,MRPR2361,MRPR2362: * 275
                          MRPR2363,MRPR2364,MRPR2365,MRPR2366,MRPR2367: * 280
                          MRPR2368,MRPR2369,MRPR2370,MRPR2371,MRPR2372: * 285
                          MRPR2373,MRPR2374,MRPR2375,MRPR2376,MRPR2377: * 290
                          MRPR2378,MRPR2379,MRPR2380,MRPR2381,MRPR2382: * 295
                          MRPR2383,MRPR2384,MRPR2385,MRPR2386,MRPR2387: * 300
                          MRPR2388,MRPR2389,MRPR2396,MRPR2397,MRPR2398: * 305
                          MRPR2399,MRPR2400,MRPR2402,MRPR2404,MRPR2405: * 310
                          MRPR2406,MRPR2407,MRPR2408,MRPR2409,MRPR2410: * 315
                          MRPR2411,MRPR2412,MRPR2413,MRPR2414,MRPR2415: * 320
                          MRPR2416,MRPR2417,MRPR2418,MRPR2419,MRPR2420: * 325
                          MRPR2421,MRPR2422,MRPR2423,MRPR2425,MRPR2426: * 330
                          MRPR2427,MRPR2428,MRPR2429,MRPR2430,MRPR2432: * 335
                          MRPR2433,MRPR2434,MRPR2435,MRPR2436,MRPR2437: * 340
                          MRPR2438,MRPR2442,MRPR2443,MRPR2444,MRPR2445: * 345
                          MRPR2447,MRPR2448,MRPR2449,MRPR2450,MRPR2451: * 350
                          MRPR2452,MRPR2453,MRPR2454,MRPR2455,MRPR2456: * 355
                          MRPR2457,MRPR2458,MRPR2459,MRPR2460,MRPR2461: * 360
                          MRPR2462,MRPR2463,MRPR2464,MRPR2465,MRPR2466: * 365
                          MRPR2467,MRPR2468,MRPR2469,MRPR2470
.
          GOTO      MRPRN100
.
MRPRN401  MOVE      AADMNO,VARIABLE          * Admission number
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
MRPRN402  MOVE      AURNO,VARIABLE           * U/R number
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
MRPRN403  MOVE      PMEDI,VARIABLE           * Medicare number
          GOTO      MRPRN840
.
MRPRN404  MOVE      PSNAME,VARIABLE          * Surname
          GOTO      MRPRN840
.
MRPRN405  MOVE      ATIME,VARIABLE           * Admission time
          GOTO      MRPRN840
.
MRPRN406  MOVE      ACLSS,VARIABLE           * Admission class
          GOTO      MRPRN840
.
MRPRN407  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY    * Admission date
          CALL      PACDATE
          MOVE      CPDATE,VARIABLE
          GOTO      MRPRN840
.
MRPRN408  MOVE      PGNAME,VARIABLE          * Given name
          GOTO      MRPRN840
.
MRPRN409  MOVE      PADD1,VARIABLE           * Address line 1
          GOTO      MRPRN840
.
MRPRN410  MOVE      PADD2,VARIABLE           * Address line 2
          GOTO      MRPRN840
.
MRPRN411  MOVE      PSUBRB,VARIABLE          * Suburb
          GOTO      MRPRN840
.
MRPRN412  MOVE      PTELEP,VARIABLE          * Private telephone
          GOTO      MRPRN840
.
MRPRN413  MOVE      PPOST,VARIABLE           * Postcode
          GOTO      MRPRN840
.
MRPRN414  MOVE      ZERO,ANS                 * Sex
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00           
          MOVE      DSEXIND1,VARIABLE
          GOTO      MRPRN840
.
MRPRN415  CALL      LABELAGE
          MOVE      XAGE,VARIABLE           * Age
          MOVE      THREE,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
MRPRN416  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY   * Birth date
          CALL      PACDATE
          MOVE      CPDATE,VARIABLE
          GOTO      MRPRN840
.
MRPRN417  MOVE      PCONT,VARIABLE           * Country
          GOTO      MRPRN840
.
MRPRN418  COMPARE   ONE,ASTAT                * Ward - check for pre-adm
          GOTO      MRPRN419 IF NOT EQUAL
          MOVE      PTMIXWRD,VARIABLE        * Use Expected Ward for Pre-Adm.
          GOTO      MRPRN840
.
MRPRN419  MOVE      AWARD,VARIABLE           * Ward - not Pre-adm
          GOTO      MRPRN840
.
MRPRN420  MOVE      ABED,VARIABLE            * Bed
          GOTO      MRPRN840
.
MRPRN421  MOVE      PMSTAT,VARIABLE          * Marital status
          GOTO      MRPRN840
.
MRPRN422  MOVE      CODER,TCODE              * Religion
          PACK      ACODE,PREG,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
MRPRN423  MOVE      POCCUP,VARIABLE          * Occupation
          GOTO      MRPRN840
.
MRPRN424  MOVE      PTYPE,VARIABLE           * Patient Type
          GOTO      MRPRN840
.
MRPRN425  MOVE      TWO,ANS                  * Claim code
          CMATCH    "0",ACLAIM
          GOTO      MRPRN426 IF EQUAL
          MOVE      ONE,ANS
.
MRPRN426  MOVE      ANS,VARIABLE
          GOTO      MRPRN840
.
MRPRN501  MOVE      SP30,HFNAME              * Health fund
          MATCH     SP6,AFUNDH
          GOTO      MRPRN502 IF EQUAL
          PACK      KEY14,AFUNDH,ZERO4,SP10
          CALL      RDFUND1
.
MRPRN502  MOVE      HFNAME,VARIABLE
          GOTO      MRPRN840
.
MRPRN503  MOVE      SP30,HFNAME              * Health Fund table
          MATCH     SP8,AFNDTB
          GOTO      MRPRN504 IF EQUAL
          PACK      KEY14,AFUNDH,AFNDTB,SP10
          CALL      RDFUND1
.
MRPRN504  MOVE      HFNAME,VARIABLE
          GOTO      MRPRN840
.
MRPRN505  MOVE      PPENNO,VARIABLE          * Pension number
          GOTO      MRPRN840
.
MRPRN506  MOVE      AUSR1,VARIABLE           * User defined 1
          GOTO      MRPRN840
.
MRPRN507  MOVE      CODEU2,TCODE             * User defined 1
          PACK      ACODE,AUSR2,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
MRPRN508  BRANCH    CRDRTYP,MRPRN509         * Referring Doctor
          MOVE      SP30,ARDRNAM
          MATCH     SP6,ADOCTR
          GOTO      MRPRN509 IF EQUAL
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,MRPRN509
          MOVE      DGNAME,ANS
          PACK      ARDRNAM,ANS,DOT,DSNAME
.
MRPRN509  MOVE      ARDRNAM,VARIABLE
          GOTO      MRPRN840
.
MRPRN510  MOVE      SP30,ADOCDESC            * Attending Doctor
          MATCH     SP6,ADOCTA
          GOTO      MRPRN511 IF EQUAL
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,MRPRN511
          MOVE      DGNAME,ANS
          PACK      ADOCDESC,ANS,DOT,DSNAME
.
MRPRN511  MOVE      ADOCDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the next of kin name ------
.
MRPRN512  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,VARIABLE
          ELSE
            MOVE      PNKNAME,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin relationship ------
.
MRPRN513  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCERELP,VARIABLE
          ELSE
            MOVE      PNKRELP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin address ------
.
MRPRN514  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,PKADD1
            MOVE      PMCEADD2,PKADD2
            MOVE      PMCEPOST,PKPOST
          ELSE
            MOVE      PNKADD1,PKADD1
            MOVE      PNKADD2,PKADD2
            MOVE      PNKPOST,PKPOST
          ENDIF
.
          CALL      PAC6ADDR               * pack the address
          PACK      VARIABLE,ADDRLN,SP30,SP30
          GOTO      MRPRN840
.
.------ format the next of kin private telephone number ------
.
MRPRN515  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,VARIABLE
          ELSE
            MOVE      PNKTELP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin business telephone number ------
.
MRPRN516  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELB,VARIABLE
          ELSE
            MOVE      PNKTELB,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the financially responsible relationship ------
.
MRPRN517  MOVE      "SELF",PKRELP
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          PACK      VARIABLE,PKRELP,SP10
          GOTO      MRPRN840
.
.------ format the financially responsible address ------
.
MRPRN518  MOVE      PADD1,PKADD1
          MOVE      PADD2,PKADD2
          MOVE      PPOST,PKPOST
.
          MOVE      AADMNO,KEY8
          CALL      RDRESP1            * read the responsible for account file
.
          CALL      PAC6ADDR           * pack the address
.
          PACK      VARIABLE,ADDRLN,SP30,SP30
          GOTO      MRPRN840
.
.------ format the attending doctors surgury telephone number ------
.
MRPRN519  MOVE      SP20,DTELES
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DTELES,VARIABLE
          GOTO      MRPRN840
.
.------ format the attending doctors private telephone number ------
.
MRPRN520  MOVE      SP20,DTELEH
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DTELEH,VARIABLE
          GOTO      MRPRN840
.
.------ format the next of kin address line 1------
.
MRPRN521  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PNKADD1,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin address line 2------
.
MRPRN522  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PNKADD2,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin suburb ------
.
MRPRN523  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PNKSUBR,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the next of kin post code ------
.
MRPRN524  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PNKPOST,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format the discharge date ------
.
MRPRN525  MOVE      SP8,CPDATE
          COMPARE   THREE,ASTAT               * patient must be discharged
          GOTO      MRPRN526 IF NOT EQUAL
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
MRPRN526  MOVE      CPDATE,VARIABLE
          GOTO      MRPRN840
.
.------ format the discharge time ------
.
MRPRN527  COMPARE   THREE,ASTAT               * patient must be discharged
          GOTO      MRPRN528 IF NOT EQUAL
.
          MATCH     SP8,DDATE                 * test date for spaces
          GOTO      MRPRN528 IF EQUAL
.
          GOTO      MRPRN529
.
MRPRN528  MOVE      SP8,DTIME
.
MRPRN529  MOVE      DTIME,VARIABLE
          GOTO      MRPRN840
.
.------ format the patients sex ------
.
MRPRN530  MOVE      PSEX,VARIABLE
          GOTO      MRPRN840
.
.------ format the discharge destination ------
.
MRPRN531  MOVE      DDEST,VARIABLE
          GOTO      MRPRN840
.
.------ format the admission diagnosis ------
.
MRPRN532  MOVE      ADIAG1,VARIABLE
          GOTO      MRPRN840
.
.------ format the last year of discharge ------
.
MRPRN600  UNPACK    PLDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CYEAR,VARIABLE
          GOTO      MRPRN840
.
.------ format the patient fund membership number ------
.
MRPRN601  MOVE      PMVXFNDM,VARIABLE
          GOTO      MRPRN840
.
.------ format the hospital name ------
.
MRPRN605  MOVE      CNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format the marital status description ------
.
MRPRN606  MOVE      CODEM,TCODE
          PACK      ACODE,PMSTAT,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the allergies indicator ------
.
MRPRN607  MOVE      "UNKNOWN",DALERG
          LOAD      DALERG,AALERG,DYES,DNO
          MOVE      DALERG,VARIABLE
          GOTO      MRPRN840
.
.------ format the smoker indicator ------
.
MRPRN608  MOVE      "UNKNOWN",DSMOKE
          LOAD      DSMOKE,PSMOK,DYES,DNO
          MOVE      DSMOKE,VARIABLE
          GOTO      MRPRN840
.
.------ format the repatriation number ------
.
MRPRN609  MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      MRPRN840
.
.------ format the country of birth description ------
.
MRPRN610  MOVE      CODEC,TCODE
          PACK      ACODE,PCONT,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the patient claim code description ------
.
MRPRN611  MOVE      CODECL,TCODE
          PACK      ACODE,ACLAIM,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the attending doctor address line 1 ------
.
MRPRN612  MOVE      SP35,DSADD1
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DSADD1,VARIABLE
          GOTO      MRPRN840
.
.------ format the attending doctor address line 2 ------
.
MRPRN613  MOVE      SP35,DSADD2
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DSADD2,VARIABLE
          GOTO      MRPRN840
.
.------ format the attending doctor address line 3 ------
.
MRPRN614  MOVE      SP35,DSADD3
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DSADD3,VARIABLE
          GOTO      MRPRN840
.
                                       * see MRPR2458 for address line 4
.
.------ format the attending doctors post code ------
.
MRPRN615  MOVE      SP30,DSPOST
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DSPOST,VARIABLE
          GOTO      MRPRN840
.
.------ format the referring doctors surgury phone ------
.
MRPRN616  MOVE      SP20,DTELES
          BRANCH    CRDRTYP,MRPRN617
.
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1
.
MRPRN617  MOVE      DTELES,VARIABLE
          GOTO      MRPRN840
.
.------ format the admission source description ------
.
MRPRN618  MOVE      CODES,TCODE
          PACK      ACODE,ASRCE,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions diagnosis number 2 ------
.
MRPRN619  MOVE      ADIAG2,VARIABLE
          GOTO      MRPRN840
.
.------ format the discharge destination description ------
.
MRPRN620  MOVE      CODEDD,TCODE
          PACK      ACODE,DDEST,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the discharge status description ------
.
MRPRN621  MOVE      CODED,TCODE
          PACK      ACODE,DSTAT,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the hospital code ------
.
MRPRN622  MOVE      CHCSCOD,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 6 ------
.
MRPRN623  MOVE      AUSR6,VARIABLE           * User defined 1
          GOTO      MRPRN840
.
.------ format the case notes indicator ------
.
MRPRN624  MOVE      SP1,ANS
          LOAD      ANS,PCASE,CCNOTES
          MOVE      ANS,VARIABLE
          GOTO      MRPRN840
.
.------ format the patient birth year ------
.
MRPRN701  UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      VARIABLE,XCENT,XYEAR
          GOTO      MRPRN840
.
.------ format the local doctor ------
.
MRPRN710  MOVE      ADOCTL,VARIABLE
          GOTO      MRPRN840
.
.------ format the referring doctors code ------
.
MRPRN711  MOVE      ADOCTR,VARIABLE
          GOTO      MRPRN840
.
.------ format the attending doctors code ------
.
MRPRN712  MOVE      ADOCTA,VARIABLE
          GOTO      MRPRN840
.
.------ format the ward/bed ------
.
MRPRN713  COMPARE   ONE,ASTAT                     * check for pre-adm
          GOTO      MRPRN714 IF NOT EQUAL
          PACK      VARIABLE,PTMIXWRD,SLASH,SP10  * Use Expected Ward
          GOTO      MRPRN840
.
MRPRN714  MATCH     SP3,ABED
          GOTO      MRPRN715 IF EQUAL
.
          PACK      VARIABLE,AWARD,SLASH,ABED
          GOTO      MRPRN840
.
MRPRN715  PACK      VARIABLE,AWARD,SP10
          GOTO      MRPRN840
.
.------ format the person financially responsible name ------
.
MRPRN716  PACK      PKNAME,SP70,SP10
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format the person financially responsible private telephone no. ------
.
MRPRN717  MOVE      SP20,PKTELEP
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKTELEP,VARIABLE
          GOTO      MRPRN840
.
.------ format the person financially responsible address line 1 ------
.
MRPRN718  MOVE      SP30,PKADD1
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKADD1,VARIABLE
          GOTO      MRPRN840
.
.------ format the person financially responsible address line 2 ------
.
MRPRN719  MOVE      SP30,PKADD2
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKADD2,VARIABLE
          GOTO      MRPRN840
.
.------ format the person financially responsible suburb ------
.
MRPRN720  MOVE      SP20,PKSUBR
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKSUBR,VARIABLE
          GOTO      MRPRN840
.
.------ format the person financially responsible post code ------
.
MRPRN721  MOVE      SP4,PKPOST
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKPOST,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 3 ------
.
MRPRN722  MOVE      AUSR3,VARIABLE           * User defined 1
          GOTO      MRPRN840
.
.------ format the person financially responsible business telephone no. ------
.
MRPRN723  MOVE      SP20,PKTELEB
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          MOVE      PKTELEB,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 4 ------
.
MRPRN724  MOVE      AUSR4,VARIABLE           * User defined 1
          GOTO      MRPRN840
.
.------ format the estimated fund rebate description ------
.
MRPRN725  MOVE      SP20,TDESC
          PACK      KEY6,AWARD,WBED
          CALL      RDWARD1                * read the ward file
          BRANCH    OVRCD,MRPRN726
.
          MOVE      CODEBT,TCODE
          PACK      ACODE,WEFRBT,SP3
          CALL      GTCOD000
.
MRPRN726  MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the patient care class description ------
.
MRPRN727  MOVE      CODECC,TCODE
          PACK      ACODE,ACARE,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 5 ------
.
MRPRN728  MOVE      AUSR5,VARIABLE           * User defined 1
          GOTO      MRPRN840
.
.------ format the number of years resident ------
.
MRPRN729  MOVE      PYRRES,VARIABLE
          MOVE      TWO,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
.------ format the business telephone number ------
.
MRPRN730  MOVE      PTELEB,VARIABLE
          GOTO      MRPRN840
.
.------ format the master user defined field 3 description ------
.
MRPRN732  MOVE      CODEP3,TCODE
          PACK      ACODE,PUSR3,SP3
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the admission class description ------
.
MRPRN733  MOVE      CODEP,TCODE
          PACK      ACODE,ACLSS,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the admission type ------
.
MRPRN734  MOVE      ATYPE,VARIABLE
          GOTO      MRPRN840
.
.------ format the admission type description ------
.
MRPRN736  MOVE      CODEA,TCODE
          PACK      ACODE,ATYPE,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharge status code ------
.
MRPRN738  MOVE      DSTAT,VARIABLE
          GOTO      MRPRN840
.
.------ format care class code ------
.
MRPRN740  MOVE      ACARE,VARIABLE
          GOTO      MRPRN840
.
.------ format HCS attending doctor code -------
.
MRPRN741  MOVE      ZERO,DHCSCOD
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1                  * read doctors file
.
          MOVE      DHCSCOD,VARIABLE
          MOVE      THREE,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
.------ format religion ------
.
MRPRN742  MOVE      PREG,VARIABLE
          GOTO      MRPRN840
.
.------ format fund table code ------
.
MRPRN743  MOVE      AFNDTB,VARIABLE
          GOTO      MRPRN840
.
.------ format claim code ------
.
MRPRN746  MOVE      ACLAIM,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 1 code ------
.
MRPRN748  MOVE      PUSR1,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 1 description ------
.
MRPRN749  MOVE      CODEP1,TCODE           * User defined 1
          PACK      ACODE,PUSR1,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 2 code ------
.
MRPRN750  MOVE      PUSR2,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 2 description ------
.
MRPRN751  MOVE      CODEP2,TCODE           * User defined 2
          PACK      ACODE,PUSR2,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 3 code ------
.
MRPRN753  MOVE      PUSR3,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 3 description ------
.
MRPRN754  MOVE      CODEP3,TCODE           * User defined 3
          PACK      ACODE,PUSR3,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 4 code ------
.
MRPRN756  MOVE      PUSR4,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 4 description ------
.
MRPRN757  MOVE      CODEP4,TCODE           * User defined 4
          PACK      ACODE,PUSR4,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 5 code ------
.
MRPRN759  MOVE      PUSR5,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 5 description ------
.
MRPRN760  MOVE      CODEP5,TCODE           * User defined 5
          PACK      ACODE,PUSR5,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 6 code ------
.
MRPRN762  MOVE      PUSR6,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined field 6 description ------
.
MRPRN763  MOVE      CODEP6,TCODE           * User defined 6
          PACK      ACODE,PUSR6,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined Y/N field 1 -----
.
MRPRN765  MOVE      DNO,DIM3
          LOAD      DIM3,PUYN1,DYES,DNO
          MOVE      DIM3,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined Y/N field 2 -----
.
MRPRN766  MOVE      DNO,DIM3
          LOAD      DIM3,PUYN2,DYES,DNO
          MOVE      DIM3,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined Y/N field 3 -----
.
MRPRN767  MOVE      DNO,DIM3
          LOAD      DIM3,PUYN3,DYES,DNO
          MOVE      DIM3,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 1 description ------
.
MRPRN768  MOVE      CODEU1,TCODE             * User defined 1
          PACK      ACODE,AUSR1,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format user defined 2 code ------
.
MRPRN769  MOVE      AUSR2,VARIABLE           * User defined 2
          GOTO      MRPRN840
.
.------ format user defined 2 description ------
.
MRPRN770  MOVE      CODEU2,TCODE             * User defined 2
          PACK      ACODE,AUSR2,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the admissions user defined field number 3 description ------
.
MRPRN771  MOVE      CODEU3,TCODE             * User defined 3
          PACK      ACODE,AUSR3,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format admission user defined 4 code description ------
.
MRPRN773  MOVE      CODEU4,TCODE             * User defined 4
          PACK      ACODE,AUSR4,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format admission user defined 5 code description ------
.
MRPRN775  MOVE      CODEU5,TCODE             * User defined 5
          PACK      ACODE,AUSR5,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format admission user defined 6 code description ------
.
MRPRN777  MOVE      CODEU6,TCODE             * User defined 6
          PACK      ACODE,AUSR6,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format admission user defined 7 code ------
.
MRPRN779  MOVE      AUSR7,VARIABLE
          GOTO      MRPRN780
.
.------ format admission user defined 7 code description ------
.
MRPRN780  MOVE      CODEU7,TCODE             * User defined 7
          PACK      ACODE,AUSR7,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 1 code ------
.
MRPRN782  MOVE      DUSD1,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 1 code description ------
.
MRPRN783  MOVE      CODED1,TCODE             * User defined 1
          PACK      ACODE,DUSD1,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 2 code ------
.
MRPRN785  MOVE      DUSD2,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 2 code description ------
.
MRPRN786  MOVE      CODED2,TCODE             * User defined 2
          PACK      ACODE,DUSD2,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 3 code ------
.
MRPRN788  MOVE      DUSD3,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 3 code description ------
.
MRPRN789  MOVE      CODED3,TCODE             * User defined 3
          PACK      ACODE,DUSD3,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 4 code ------
.
MRPRN791  MOVE      DUSD4,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 4 code description ------
.
MRPRN792  MOVE      CODED4,TCODE             * User defined 4
          PACK      ACODE,DUSD4,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 5 code ------
.
MRPRN794  MOVE      DUSD5,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged user defined 5 code description ------
.
MRPRN795  MOVE      CODED5,TCODE             * User defined 5
          PACK      ACODE,DUSD5,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format pension number expiry date ------
.
MRPRN797  REP       " 0",PPNDTE
          UNPACK    PPNDTE,XCENT,XYEAR,XMON
          PACK      VARIABLE,XMON,SLASH,XYEAR
          GOTO      MRPRN840
.
.------ format sex description ------
.
MRPRN798  MOVE      SP8,VARIABLE          * Sex
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00  
          MOVE      DSEXASC1,VARIABLE
.
MRPRN799  GOTO      MRPRN840
.
.------ format referral doctor HCS code ------
.
MRPRN800  MOVE      ZERO,DHCSCOD
          MATCH     SP6,ADOCTR
          GOTO      MRPRN801 IF EQUAL
.
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1                  * read doctors file
.
MRPRN801  MOVE      DHCSCOD,VARIABLE
          MOVE      THREE,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
.------ format years of membership ------
.
MRPRN802  MOVE      AFNDYY,VARIABLE
          GOTO      MRPRN840
.
.----- format day of hospitalization ------
.
MRPRN803  MOVE      ADYHOSP,VARIABLE
          MOVE      THREE,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      MRPRN840
.
.----- format discharged diagnosis description ------
.
MRPRN804  BRANCH    CKMBS OF MRPRN805,MRPRN806
          PACK      VARIABLE,DDIAG,DDIAG2      * Free format
          GOTO      MRPRN840
.
.       Check for a valid ICD code
.
MRPRN805  MATCH     SP9,DFMBS
          GOTO      MRPRN840 IF EQUAL
.
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
          PACK      DDESC,SP20,SP20,SP20,SP20
          MOVE      DFMBS,KEY9
            CALL      RD10T9D1
            IF        OVRCD=1
                CALL     RDPT10D1
            ENDIF
          CLOSE     PATICDD1
          CLOSE     PATI10D1
          MOVE      DDESC,VARIABLE
          GOTO      MRPRN840
.
.       Check for a valid MBS code
.
MRPRN806  PACK      IDESC,SP20,SP20
          MATCH     SP9,DFMBS
          GOTO      MRPRN807 IF EQUAL
.
          OPEN      PATITEM1,"patitemn"
          PACK      IDESC,SP20,SP20
          PACK      KEY17,DFMBS,DDATE,SP70
          CALL      PATITMRD
          CLOSE     PATITEM1
.
MRPRN807  MOVE      IDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharged diagnosis code ------
.
MRPRN808  MOVE      DFMBS,VARIABLE
          GOTO      MRPRN840
.
.------ format admission source ------
.
MRPRN809  MOVE      ASRCE,VARIABLE
          GOTO      MRPRN840
.
.------ format patient title ------
.
MRPRN810  MOVE      PTITL,VARIABLE
          GOTO      MRPRN840
.
. ------- Format the Current Legal Status Description ------ variable 177
.
MRPRN811  MOVE      "LS",TCODE
          PACK      ACODE,PTMXLS,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
. ------- Format Date of Legal Status -------
.
MRPRN812  UNPACK    PTMXLSDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
. ------- Format Familial history of mental disorder -------
.
MRPRN813  MOVE      "No ",ACODE
          MOVE      PTMXFHMD,FORM1
          LOAD      ACODE,FORM1,DYES
          MOVE      ACODE,VARIABLE
          GOTO      MRPRN840
.
. ------- Format MH User Defined Field 1 -------
.
MRPRN814  MOVE      "V6",TCODE
          PACK      ACODE,PTMXMHU1,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
. ------- Format MH User Defined Field 2 -------
.
MRPRN815  MOVE      "V7",TCODE
          PACK      ACODE,PTMXMHU2,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
. ------- Format MH User Defined Field 3 -------
.
MRPRN816  MOVE      "V8",TCODE
          PACK      ACODE,PTMXMHU3,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
. ------- Format Emergency contact address -------
.
MRPRN817  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,PKADD1
            MOVE      PMCEADD2,PKADD2
            MOVE      PMCEPOST,PKPOST
          ELSE
            MOVE      PTMXECA1,PKADD1
            MOVE      PTMXECA2,PKADD2
            MOVE      PTMXECPC,PKPOST
          ENDIF
          CALL      PAC6ADDR           * pack the address
          PACK      VARIABLE,ADDRLN,SP30,SP30
          GOTO      MRPRN840
.
. ------- Format Nearest Relative address -------
.
MRPRN818  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative 
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,PKADD1
            MOVE      PMCEADD2,PKADD2
            MOVE      PMCEPOST,PKPOST
          ELSE
            MOVE      PTMXNRA1,PKADD1
            MOVE      PTMXNRA2,PKADD2
            MOVE      PTMXNRPC,PKPOST
          ENDIF
          CALL      PAC6ADDR           * pack the address
          PACK      VARIABLE,ADDRLN,SP30,SP30
          GOTO      MRPRN840
.
.------ format Birth date with century ------
.
MRPR1004  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
.------ format Admission date with century ------
.
MRPR1005  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY    * Admission Date
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
.------ format address 1 of referring doctor ------
.
MRPR1006  PACK      DSADD1,SP20,SP20
          BRANCH    CRDRTYP,MRPR1007
.
          MATCH     SP6,ADOCTR
          GOTO      MRPR1007 IF EQUAL
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1               * Read doctors file
.
MRPR1007  MOVE      DSADD1,VARIABLE
          GOTO      MRPRN840
.
.------ format address 2 of referring doctor ------
.
MRPR1008  PACK      DSADD2,SP20,SP20
          BRANCH    CRDRTYP,MRPR1009
.
          MATCH     SP6,ADOCTR
          GOTO      MRPR1009 IF EQUAL
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1               * Read doctors file
.
MRPR1009  MOVE      DSADD2,VARIABLE
          GOTO      MRPRN840
.
.------ format address 3 of referring doctor ------
.
MRPR1010  PACK      DSADD3,SP20,SP20
          BRANCH    CRDRTYP,MRPR1011
.
          MATCH     SP6,ADOCTR
          GOTO      MRPR1011 IF EQUAL
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1               * Read doctors file
.
MRPR1011  MOVE      DSADD3,VARIABLE
          GOTO      MRPRN840
.
.                                         * see MRPR2459 for address line 4
.
.------ format postcode of referring doctor ------
.
MRPR1012  PACK      DSPOST,SP20,SP20
          BRANCH    CRDRTYP,MRPR1013
.
          MATCH     SP6,ADOCTR
          GOTO      MRPR1013 IF EQUAL
          MOVE      ADOCTR,KEY6
          CALL      RDDOCT1               * Read doctors file
.
MRPR1013  MOVE      DSPOST,VARIABLE
          GOTO      MRPRN840
.
. ------- Format Emergency contact name -------
.
MRPR1014  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,VARIABLE
          ELSE
            MOVE      PTMXECNM,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact address 1 -------
.
MRPR1015  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PTMXECA1,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact address 2 -------
.
MRPR1016  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PTMXECA2,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact address 3 -------
.
MRPR1017  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PTMXECA3,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact postcode -------
.
MRPR1018  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PTMXECPC,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact private phone -------
.
MRPR1019  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,VARIABLE
          ELSE
            MOVE      PTMXECPP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact business phone -------
.
MRPR1020  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELB,VARIABLE
          ELSE
            MOVE      PTMXECBP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Emergency contact relationship -------
.
MRPR1021  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCERELP,VARIABLE
          ELSE
            MOVE      PTMXECRE,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative name -------
.
MRPR1022  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,VARIABLE
          ELSE
            MOVE      PTMXNRNM,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative address 1 -------
.
MRPR1023  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PTMXNRA1,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative address 2 -------
.
MRPR1024  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PTMXNRA2,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative address 3 -------
.
MRPR1025  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PTMXNRA3,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative postcode -------
.
MRPR1026  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PTMXNRPC,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative private phone -------
.
MRPR1027  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,VARIABLE
          ELSE
            MOVE      PTMXNRPP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative business phone -------
.
MRPR1028  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELB,VARIABLE
          ELSE
            MOVE      PTMXNRBP,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ------- Format Nearest relative relationship -------
.
MRPR1029  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCERELP,VARIABLE
          ELSE
            MOVE      PTMXNRRE,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format admission transfer source code ------
.
MRPR1030  COMPARE   ONE,PTCNUADT          * parameter on ?
          GOTO      MRPRN840 IF NOT EQUAL * no.
.
          MATCH     SP5,PTDAADTS
          GOTO      MRPRN840 IF EQUAL
.
          MOVE      PTDAADTS,VARIABLE
          GOTO      MRPRN840
.
.------ format admission transfer source code description ------
.
MRPR1031  COMPARE   ONE,PTCNUADT          * parameter on ?
          GOTO      MRPRN840 IF NOT EQUAL * no.
.
          MATCH     SP5,PTDAADTS
          GOTO      MRPRN840 IF EQUAL
.
          MOVE      PTDAADTS,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,MRPRN840
          MOVE      PTVADESC,VARIABLE
          GOTO      MRPRN840
.
.------ format discharge transfer source code ------
.
MRPR1032  COMPARE   ONE,PTCNUADT          * parameter on ?
          GOTO      MRPRN840 IF NOT EQUAL * no.
.
          MATCH     SP5,PTDADCTS
          GOTO      MRPRN840 IF EQUAL
.
          MOVE      PTDADCTS,VARIABLE
          GOTO      MRPRN840
.
.------ format admission transfer source code description ------
.
MRPR1033  COMPARE   ONE,PTCNUADT          * parameter on ?
          GOTO      MRPRN840 IF NOT EQUAL * no.
.
          MATCH     SP5,PTDADCTS
          GOTO      MRPRN840 IF EQUAL
.
          MOVE      PTDADCTS,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,MRPRN840
          MOVE      PTVADESC,VARIABLE
          GOTO      MRPRN840
.
.------ format District of Residence code ------
.
MRPR1034  MOVE      PTMXDOFR,VARIABLE
          GOTO      MRPRN840
.
.------ format District of Residence description ------
.
MRPR1035  MOVE      "DA",TCODE
          PACK      ACODE,PTMXDOFR,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. code (PMI Based) ------
.
MRPR1036  MOVE      PMPXRHC1,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. description (PMI Based) ------
.
MRPR1037  PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format HCP practice code (PMI Based) ------
.
MRPR1038  MOVE      "-",ANS
          MATCH     SP2,PMPXR1GC
          IF        @EQUAL
            MOVE      SP1,ANS
          ENDIF
          PACK      VARIABLE,PMPXRH1G,ANS,PMPXR1GC,SP30
          GOTO      MRPRN840
.
.------ format HCP practice description (PMI Based) ------
.
MRPR1039  PACK      PMHGPNAM,SP30
          PACK      KEY10,PMPXRH1G,SP70
          PACK      KEY12,KEY10,PMPXR1GC,SP70
          CALL      RDPMHCG1
          MOVE      PMHGPNAM,VARIABLE
          GOTO      MRPRN840
.
.------ format supplementary Id ------
.
MRPR1040  MOVE      PTMXSPID,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. code (Admission based) ------
.
MRPR1041  MOVE      PMVXRHC1,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. description (Admission Based) ------
.
MRPR1042  PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format HCP practice code (Admission Based) ------
.
MRPR1043  MOVE      "-",ANS
          MATCH     SP2,PMVXRH1C
          IF        @EQUAL
            MOVE      SP1,ANS
          ENDIF
          PACK      VARIABLE,PMVXRH1G,ANS,PMVXRH1C,SP30
          GOTO      MRPRN840
.
.------ format HCP practice description (Admission Based) ------
.
MRPR1044  PACK      PMHGPNAM,SP30
          PACK      KEY10,PMVXRH1G,SP70
          PACK      KEY12,KEY10,PMVXRH1C,SP70
          CALL      RDPMHCG1
          MOVE      PMHGPNAM,VARIABLE
          GOTO      MRPRN840
.
.----- format GPRH Approval number ------
.
MRPR1045  MOVE      PTMSFHAN,VARIABLE
          GOTO      MRPRN840
.
.----- format ECR Approval number ------
.
MRPR1046  MOVE      PTMSECRA,VARIABLE
          GOTO      MRPRN840
.
.----- format Management Intent code ------
.
MRPR1047  MOVE      PTMSMGIN,VARIABLE
          GOTO      MRPRN840
.
.----- format Management Intent desc ------
.
MRPR1400  MOVE      "MI",TCODE
          PACK      ACODE,PTMSMGIN,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
. --- format doctor title ----
.
MRPR1436  MOVE      SP10,DTITL
          MATCH     SP6,ADOCTA
          GOTO      MRPR1437 IF EQUAL
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
MRPR1437  MOVE      DTITL,VARIABLE
          GOTO      MRPRN840
.      
.----- format Admission Class code ------
.
MRPR1440  MOVE      ACLSS,VARIABLE
          GOTO      MRPRN840
.      
.----- format Admission Class desc ------
.
MRPR1444  MOVE      "P ",TCODE
          PACK      ACODE,ACLSS,SP3
          CALL      GTCOD000                 * Read the patient codes file
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.      
.----- format Microfilm Address ------
.
MRPR1448  MOVE      PMICRO,VARIABLE
          GOTO      MRPRN840
.
. ------- HCP Practice Address details * PMI based -------
.
MRPR2263  PACK      KEY10,PMPXRH1G,SP70
          PACK      KEY12,KEY10,PMPXR1GC,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,MRPRN840
.
          SUB       "196",FORM5
          LOAD      VARIABLE,FORM5,PMHGADD1,PMHGADD2,PMHGADD3:
                                   PMHGADD4,PMHGPOST,PMHGPTEL:
                                   PMHGPPNO,PMHGPFAX
          GOTO      MRPRN840
.
. ------- ward description -------
.
MRPR2266  COMPARE   ONE,ASTAT                * Ward - check for pre-adm
          GOTO      MRPR2267 IF NOT EQUAL
          PACK      KEY6,PTMIXWRD,SP6        * Use Expected Ward for Pre-Adm.
          GOTO      MRPR2268
.
MRPR2267  PACK      KEY6,AWARD,ABED
MRPR2268  CALL      RDWARD1
          BRANCH    OVRCD,MRPRN840
          PACK      VARIABLE,WBDESC,SP30,SP30,SP30
          GOTO      MRPRN840
.
.
. ------- HCP Practice Address details * Admission based -------
.
MRPR2270  PACK      KEY10,PMPXRH1G,SP70
          PACK      KEY12,KEY10,PMVXRH1C,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,MRPRN840
.
          SUB       "205",FORM5
          LOAD      VARIABLE,FORM5,PMHGADD1,PMHGADD2,PMHGADD3:
                                   PMHGADD4,PMHGPOST,PMHGPTEL
          GOTO      MRPRN840
.
.-------- Employer Name ---------------------
.
MRPR2272  PACK      KEY6,PTMAEMPC,SP10
          CALL      RDGOVR1
          BRANCH    OVRCD,MRPRN840
.
          MOVE      GNAME,VARIABLE
.
          GOTO      MRPRN840
.
.-------- Employer Address -----------------
.
MRPR2273  PACK      KEY6,PTMAEMPC,SP10
          CALL      RDGOVR1
          BRANCH    OVRCD,MRPRN840
.
          SUB       "212",FORM5
          LOAD      VARIABLE,FORM5,GADD1,GADD2,GADD3,GADD4
.
          GOTO      MRPRN840
.
.-------- Next Of Kin Occupation ---------------
.
MRPR2275  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      SP70,VARIABLE
          ELSE
            MOVE      PTMANOKO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
. ----- Get Hospital Approval Number -----
.
MRPR2288  MOVE      CAPPRVNO,VARIABLE
          GOTO      MRPRN840
.
. ----- Get Hospital File Number -----
.
MRPR2292  MOVE      CFILENO,VARIABLE
          GOTO      MRPRN840
.
. Display Religion Y/N
.
MRPR2296  MOVE      DNO,DIM3
          LOAD      DIM3,AVISIT,DYES,DNO
          MOVE      DIM3,VARIABLE
          GOTO      MRPRN840
.
.------ format the associated doctors code ------
.
MRPR2297  MOVE      PTMIADOC,VARIABLE
          GOTO      MRPRN840
.
MRPR2298  MOVE      SP30,ADOCDESC
          MATCH     SP6,PTMIADOC
          IF        !@EQUAL
            MOVE      PTMIADOC,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DGNAME,ANS
              PACK      ADOCDESC,ANS,DOT,DSNAME
            ENDIF
          ENDIF
          MOVE      ADOCDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrars doctors code ------
.
MRPR2299  MOVE      PTMIREGS,VARIABLE
          GOTO      MRPRN840
.
MRPR2300  MOVE      SP30,ADOCDESC
          MATCH     SP6,PTMIREGS
          IF        !@EQUAL
            MOVE      PTMIREGS,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DGNAME,ANS
              PACK      ADOCDESC,ANS,DOT,DSNAME
            ENDIF
          ENDIF
          MOVE      ADOCDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc. doctors surgury telephone number ------
.
MRPR2303  MOVE      SP20,DTELES
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DTELES,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc. doctors private telephone number ------
.
MRPR2304  MOVE      SP20,DTELEH
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DTELEH,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc. doctor address line 1 ------
.
MRPR2305  MOVE      SP35,DSADD1
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DSADD1,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc. doctor address line 2 ------
.
MRPR2306  MOVE      SP35,DSADD2
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DSADD2,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc doctor address line 3 ------
.
MRPR2307  MOVE      SP35,DSADD3
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DSADD3,VARIABLE
          GOTO      MRPRN840
.
.                                         * see MRPR2560 for address line 4
.
.------ format the assoc doctors post code ------
.
MRPR2308  MOVE      SP30,DSPOST
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DSPOST,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctors surgury telephone number ------
.
MRPR2309  MOVE      SP20,DTELES
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DTELES,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctors private telephone number ------
.
MRPR2310  MOVE      SP20,DTELEH
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DTELEH,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctor address line 1 ------
.
MRPR2311  MOVE      SP35,DSADD1
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD1,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctor address line 2 ------
.
MRPR2312  MOVE      SP35,DSADD2
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD2,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctor address line 3 ------
.
MRPR2313  MOVE      SP35,DSADD3
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD3,VARIABLE
          GOTO      MRPRN840
.
.                                         * see MRPR2461 for address line 4
.
.------ format the registrar doctors post code ------
.
MRPR2314  MOVE      SP30,DSPOST
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DSPOST,VARIABLE
          GOTO      MRPRN840
.
MRPR2315  MOVE      PTMXCELL,VARIABLE          * cellular telephone
          GOTO      MRPRN840
.
MRPR2316  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address  
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PTMXADD1,VARIABLE          * Postal Address line 1
          ENDIF
          GOTO      MRPRN840
.
MRPR2317  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PTMXADD2,VARIABLE          * Postal Address line 2
          ENDIF
          GOTO      MRPRN840
.
MRPR2318  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PTMXADD3,VARIABLE          * Postal Address line 3
          ENDIF
          GOTO      MRPRN840
.
MRPR2319  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD4,VARIABLE
          ELSE
            MOVE      PTMXADD4,VARIABLE          * Postal Address line 4
          ENDIF
          GOTO      MRPRN840
.
MRPR2320  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PTMXPOST,VARIABLE             * Postcode
          ENDIF
          GOTO      MRPRN840
.
MRPR2328  MOVE      PTMXCHNM,VARIABLE          * chinese name
          GOTO      MRPRN840
.
.------ format Registered HCP. address 1 (PMI Based) ------
.
MRPR2329  PACK      PMHCADR1,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR1,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. address 2 (PMI Based) ------
.
MRPR2330  PACK      PMHCADR2,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR2,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. address 3 (PMI Based) ------
.
MRPR2331  PACK      PMHCADR3,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR3,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. address 4 (PMI Based) ------
.
MRPR2332  PACK      PMHCADR4,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR4,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. postcode  (PMI Based) ------
.
MRPR2333  PACK      PMHCPOST,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCPOST,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. phone     (PMI Based) ------
.
MRPR2334  PACK      PMHCSTEL,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCSTEL,VARIABLE
          GOTO      MRPRN840
.
.------ format Registered HCP. fax number(PMI Based) ------
.
MRPR2335  PACK      PMHCFAXN,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCFAXN,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. address 1 (ADM Based) ------
.
MRPR2336  PACK      PMHCADR1,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR1,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. address 2 (ADM Based) ------
.
MRPR2337  PACK      PMHCADR2,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR2,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. address 3 (ADM Based) ------
.
MRPR2338  PACK      PMHCADR3,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR3,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. address 4 (ADM Based) ------
.
MRPR2339  PACK      PMHCADR4,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCADR4,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. postcode  (ADM Based) ------
.
MRPR2340  PACK      PMHCPOST,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCPOST,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. phone     (ADM Based) ------
.
MRPR2341  PACK      PMHCSTEL,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCSTEL,VARIABLE
          GOTO      MRPRN840
.
.------ format Referring HCP. fax number(ADM Based) ------
.
MRPR2342  PACK      PMHCFAXN,SP30,SP30,SP20
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCFAXN,VARIABLE
          GOTO      MRPRN840
.
.-------- format previous surname --------------
.
MRPR2343  MOVE      PPSNAME,VARIABLE
          GOTO      MRPRN840
.
.-------- format NOK address 4 --------------
.
MRPR2344  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin     
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD4,VARIABLE
          ELSE 
            MOVE      PNKADD4,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.-------- format NOK address 4 --------------
.
MRPR2345  PACK      VARIABLE,SP70,SP70
          MOVE      PADD4,VARIABLE
          GOTO      MRPRN840
.
.-------- format PRA address 4 --------------
.
MRPR2346  PACK      VARIABLE,SP70,SP70
          MOVE      PKADD4,VARIABLE
          GOTO      MRPRN840
.
.-------- format Emergency Contact address 4 --------------
.
MRPR2347  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact 
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD4,VARIABLE
          ELSE
            MOVE      PTMXECA4,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.-------- format Nearest Relative address 4 --------------
.
MRPR2348  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Relative
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PTMXNRA4,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.-------- format Previous Admission Number --------------
.
MRPR2349  PACK      VARIABLE,SP70,SP70
          MOVE      PTMIPANO,VARIABLE
          GOTO      MRPRN840
.
.-------- format Previous Admission Date --------------
.
MRPR2350  PACK      VARIABLE,SP70,SP70
          UNPACK    PTMIPADT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
.---------format Admission Weight ----------------------
.
MRPR2351  PACK      VARIABLE,SP70,SP70
          MOVE      ABWGHT,VARIABLE
          GOTO      MRPRN840
.
.-------- format Medicare Reference Number -------------
.
MRPR2352  PACK      VARIABLE,SP70,SP70
          MOVE      PTMXMCCD,VARIABLE
          GOTO      MRPRN840
.
.------ format Mothers FULL Name ---------
.
MRPR2353  MOVE      PMPXMSNA,PACSNAME              * Mothers Details
          MOVE      PMPXMGNA,PACGNAME
          MOVE      PMPXMTLE,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format Mothers Surname  ---------
.
MRPR2354  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,VARIABLE
          ELSE
            MOVE      PMPXMSNA,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers First name  ---------
.
MRPR2355  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEGNAM,VARIABLE
          ELSE
            MOVE      PMPXMGNA,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Title  ---------
.
MRPR2356  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETITL,VARIABLE
          ELSE
            MOVE      PMPXMTLE,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Address Line 1 ---------
.
MRPR2357  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PMPXMAD1,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Address Line 2 ---------
.
MRPR2358  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PMPXMAD2,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Address Line 3 ---------
.
MRPR2359  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PMPXMAD3,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Address Line 4 ---------
.
MRPR2360  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD4,VARIABLE
          ELSE
            MOVE      PMPXMAD4,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Post Code ---------
.
MRPR2361  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PMPXMPOS,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Privite Number ---------
.
MRPR2362  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,VARIABLE
          ELSE
            MOVE      PMPXMPNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Business Number ---------
.
MRPR2363  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELB,VARIABLE
          ELSE
            MOVE      PMPXMBNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Mobile Number ---------
.
MRPR2364  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELM,VARIABLE
          ELSE
            MOVE      PMPXMMNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers E-Mail ---------
.
MRPR2365  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEEMAI,VARIABLE
          ELSE
            MOVE      PMPXMEML,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Country of Birth ---------
.
MRPR2366  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            PACK      ACODE,PMCECONT,SP70
          ELSE
            PACK      ACODE,PMPXMCNT,SP70
          ENDIF
          PACK      TCODE,ANSC,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Mothers Correspondence ---------
.
MRPR2367  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ELSE
            MATCH     "1",PMPXMCRP
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Mothers Name on Labels ---------
.
MRPR2368  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      SP70,VARIABLE
          ELSE
            MATCH     "1",PMPXMLAB
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Relationship to Patient  --------
.
MRPR2369  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCERELP,VARIABLE
          ELSE
            MOVE      PMPXMREL,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers FULL Name  --------
.
MRPR2370  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME              * Fathers Details
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
          ELSE
            MOVE      PMPXFSNA,PACSNAME              * Fathers Details
            MOVE      PMPXFGNA,PACGNAME
            MOVE      PMPXFTLE,PACTITLE
          ENDIF
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN840
.
.------ format Fathers Surname  --------
.
MRPR2371  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,VARIABLE
          ELSE
            MOVE      PMPXFSNA,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers First Name  --------
.
MRPR2372  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEGNAM,VARIABLE
          ELSE
            MOVE      PMPXFGNA,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Title  --------
.
MRPR2373  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETITL,VARIABLE
          ELSE
            MOVE      PMPXFTLE,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Adress Line 1  --------
.
MRPR2374  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD1,VARIABLE
          ELSE
            MOVE      PMPXFAD1,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Adress Line 2  --------
.
MRPR2375  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD2,VARIABLE
          ELSE
            MOVE      PMPXFAD2,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Adress Line 3  --------
.
MRPR2376  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD3,VARIABLE
          ELSE
            MOVE      PMPXFAD3,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Adress Line 4  --------
.
MRPR2377  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEADD4,VARIABLE
          ELSE
            MOVE      PMPXFAD4,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Post Code  --------
.
MRPR2378  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEPOST,VARIABLE
          ELSE
            MOVE      PMPXFPOS,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Privite Number  --------
.
MRPR2379  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELP,VARIABLE
          ELSE
            MOVE      PMPXFPNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Busines Number  --------
.
MRPR2380  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELB,VARIABLE
          ELSE
            MOVE      PMPXFBNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Mobile Number  --------
.
MRPR2381  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELM,VARIABLE
          ELSE
            MOVE      PMPXFMNO,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers E-Mail  --------
.
MRPR2382  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEEMAI,VARIABLE
          ELSE
            MOVE      PMPXFEML,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Country of birth  --------
.
MRPR2383  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            PACK      ACODE,PMCECONT,SP70
          ELSE
            PACK      ACODE,PMPXFCNT,SP70
          ENDIF
          PACK      TCODE,ANSC,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Fathers Correspondence  --------
.
MRPR2384  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ELSE
            MATCH     "1",PMPXFCRP
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Name on labels  --------
.
MRPR2385  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE     SP70,VARIABLE
          ELSE
            MATCH     "1",PMPXFLAB
            IF        @EQUAL
              MOVE     DYES,VARIABLE
            ELSE
              MOVE     DNO,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Fathers Relationship to Patient  --------
.
MRPR2386  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCERELP,VARIABLE
          ELSE
            MOVE      PMPXFREL,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format DVA Card Colour (DX)  --------
.
MRPR2387  MOVE      SP70,VARIABLE
          MOVE      THREE,DIM1	
          CALL      GCCARD00  
          MATCH     SP70,PMCDDVAC 
          IF        !@EQUAL & !@EOS 
            PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP10   * DVA Card colour 
            CALL      RDCODE1 
            IF        OVRCD = 0	
              MOVE      TDESC,VARIABLE	
            ENDIF 
          ENDIF	
          GOTO      MRPRN840
.
.------ format Aboriginality (VA)  --------
.
MRPR2388  PACK      TCODE,ANSV,ANSA,SP70
          PACK      ACODE,PMPXABRG,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Privacy (PV)  --------
.
MRPR2389  PACK      TCODE,ANSP,ANSV,SP70
          PACK      ACODE,PMPXPRVI,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Admitting point ward   --------
.
MRPR2396  MATCH     SP70,PMVXAPWD
          IF        @EQUAL
            MOVE      SP70,VARIABLE
            GOTO      MRPRN840
          ENDIF
.
          PACK      KEY6,PMVXAPWD,PMVXAPBD
          CALL      RDWARD1
          IF        OVRCD = 0
            MOVE     WBDESC,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Admitting point bed   --------
.
MRPR2397  MOVE      PMVXAPBD,VARIABLE
          GOTO      MRPRN840
.
.------ format Current Date  --------
.
MRPR2398  CALL      IBACLOCK
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          CALL      PACDATE
          MOVE      CPDATE,VARIABLE
          GOTO      MRPRN840
.
.------ format Web user ID --------
.
MRPR2399  MOVE      IBLPRUID,VARIABLE
          GOTO      MRPRN840
.
.------ format baptised --------
.
MRPR2400  MOVE      DNO,DIM3
          LOAD      DIM3,PUYN1,DYES
          MOVE      DIM3,VARIABLE
          GOTO      MRPRN840
.
.------ format Insurance Level --------
.
MRPR2402  MOVE      AFNDTB,VARIABLE
          GOTO      MRPRN840
.
.------ format Medicare Expiry Date  --------
.
MRPR2404  UNPACK    PMPXMEDC,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPDATE,VARIABLE
          GOTO      MRPRN840
.
.------ format Consent Release of Info --------
.
MRPR2405  MATCH     "1",PMPXCRIN
          IF        @EQUAL
            MOVE      "YES",VARIABLE
          ELSE
            MOVE      "NO",VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Prefered Language (LA)  --------
.
MRPR2406  PACK      TCODE,ANSL,ANSA,SP70
          PACK      ACODE,PMPXLNG1,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format UNIT (AC)  --------
.
MRPR2407  PACK      TCODE,ANSA,ANSC,SP70
          PACK      ACODE,ACLSSFT,SP70
          CALL      GTCOD000
          MOVE      TDESC,VARIABLE
          GOTO      MRPRN840
.
.------ format Interpreter Required  --------
.
MRPR2408  MATCH     "1",PMPXINTR
          IF        @EQUAL
            MOVE      "YES",VARIABLE
          ELSE
            MATCH     "0",PMPXINTR
            IF        @EQUAL
              MOVE      "NO",VARIABLE
            ELSE
              MOVE      "NOT STATED",VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Admitting Proc (MBS) --------
.
MRPR2409  MOVE      AMBS,VARIABLE
          GOTO      MRPRN840
.
.------ format Admitting Proc Description (MBS) --------
.
MRPR2410  PACK      KEY17,AMBS,ADATE,SP70
          CALL      PATITMRD
          IF        OVRCD = 1
            MOVE      SP70,VARIABLE
            GOTO      MRPRN840
          ENDIF
          MOVE      IDESC,VARIABLE
          GOTO      MRPRN840

.
.------ format Death --------
.
MRPR2411  COMPARE   "1",PCEASE
          IF        @EQUAL
            MOVE      "YES",VARIABLE
          ELSE
            MOVE      "NO ",VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------ format Date of Death ------
.
MRPR2412  PACK      VARIABLE,SP70
          MATCH     SP70,PDECDTE
          GOTO      MRPRN100 IF EQUAL
          UNPACK    PDECDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
.------ Doctor Head of Unit ------
.
MRPR2413  PACK      VARIABLE,SP70
          MOVE      SP30,HDOCDESC            * Attending Doctor
.
          PACK      KEY10,ACLSSFT,ONE,SP70
          CALL      RSPMDUN2
          CALL      RKPMDUN2
          BRANCH    OVRCD,MRPRN840
.
          MATCH     ACLSSFT,PMDUUNIT
          GOTO      MRPRN840 IF NOT EQUAL
.
          MATCH     "1",PMDUHEAD
          GOTO      MRPRN840 IF NOT EQUAL
.
          PACK      KEY6,PMDUDOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,MRPRN840
.
          MOVE      DGNAME,ANS
          PACK      HDOCDESC,ANS,DOT,DSNAME
          MOVE      HDOCDESC,VARIABLE
          GOTO      MRPRN840
.
.------ Provisional Diagnosis ------
.
MRPR2414  PACK      VARIABLE,SP70
.
          MATCH     SP70,PMVXPICD
          GOTO      MRPRN840 IF EQUAL
.
          MOVE      PMVXPICD,KEY9
          CALL      RDICD1
          BRANCH    OVRCD,MRPRN840
          PACK      VARIABLE,LBRACK,PMVXPICD,RBRACK,DDESC
          GOTO      MRPRN840
.
.------- Facility Name ------------
.
MRPR2415  PACK      VARIABLE,SP70
          MOVE      CHADD1,VARIABLE
          GOTO      MRPRN840
.
.------- MBS item Number ----------
.
MRPR2416  PACK      KEY11,AADMNO,SP10
          CALL      RDSMMBS1
          CALL      RDKMMBS1
.
          MATCH     AADMNO,MMADMN
          GOTO      MRPRN840 IF NOT EQUAL
          PACK      VARIABLE,MMCODE,SP70
          GOTO      MRPRN840
.
.------- Theatre Time Start -------
.
MRPR2417  PACK      KEY11,AADMNO,SP10
          CALL      RDSMMBS1
          CALL      RDKMMBS1
.
          MATCH     AADMNO,MMADMN
          GOTO      MRPRN840 IF NOT EQUAL
.
          PACK      VARIABLE,MMSTIM,SP70
          GOTO      MRPRN840
.
.------- Theatre Time END -------
.
MRPR2418  PACK      KEY11,AADMNO,SP10
          CALL      RDSMMBS1
          CALL      RDKMMBS1
.
          MATCH     AADMNO,MMADMN
          GOTO      MRPRN840 IF NOT EQUAL
.
          PACK      VARIABLE,MMETIM,SP70
          GOTO      MRPRN840

.
.------ format Web user ID Name --------
.
MRPR2419  MOVE      IBLPRUID,KEY10
          CALL      RDWBSE1

          MOVE      WBSENAM,VARIABLE
          GOTO      MRPRN840
.
.------ format Doctors Title --------
.
MRPR2420  MOVE      ADOCTR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,VARIABLE
            GOTO      MRPRN840
          ENDIF
          MOVE       SP70,VARIABLE
          GOTO       MRPRN840
.
.------ format Doctors Given Name --------
.
MRPR2421  MOVE      ADOCTR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DGNAME,VARIABLE
            GOTO      MRPRN840
          ENDIF
          MOVE       SP70,VARIABLE
          GOTO       MRPRN840
.
.------ format Doctors Surname Name --------
.
MRPR2422  MOVE      ADOCTR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DSNAME,VARIABLE
            GOTO      MRPRN840
          ENDIF
          MOVE       SP70,VARIABLE
          GOTO       MRPRN840
.
.------ format Ward --------
.
MRPR2423  MOVE      AWARD,VARIABLE           * Ward - not Pre-adm
          GOTO      MRPRN840
.
.------ Local GP Practice Email Address
.
MRPR2425  PACK      PMHCSEML,SP70,SP70
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          MOVE      PMHCSEML,VARIABLE
          GOTO      MRPRN840
.
.------ Local GP Preferred Method of Contact code (Cat CZ)
.
MRPR2426  MOVE      SP70,VARIABLE
          MATCH     SP10,PMPXRHC1
          IF        !@EQUAL
            PACK      KEY10,PMPXRHC1,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCPRFC,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.-------- Local GP Preferred Method of Contact description (Cat CZ)
.
MRPR2427  MOVE      SP70,VARIABLE
          MATCH     SP10,PMPXRHC1
          IF        !@EQUAL
            PACK      KEY10,PMPXRHC1,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MATCH     SP70,PMHCPRFC
              IF        !@EQUAL & !@EOS
                PACK      KEY5,ANSC,ANSZ,PMHCPRFC,SP10
                CALL      RDCODE1
                IF        OVRCD = 0
                  MOVE      TDESC,VARIABLE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.-------- Local GP First Name --------
.
MRPR2428  MOVE      SP70,VARIABLE
          MATCH     SP10,PMPXRHC1
          IF        !@EQUAL
            PACK      KEY10,PMPXRHC1,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCGNAM,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.-------- Local GP Surname --------
.
MRPR2429  MOVE      SP70,VARIABLE
          MATCH     SP10,PMPXRHC1
          IF        !@EQUAL
            PACK      KEY10,PMPXRHC1,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
              MOVE      PMHCSNAM,VARIABLE
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.------ format Registered HCP. Title Given Name Surname(PMI Based) ------
.
MRPR2430  PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,VARIABLE
          GOTO      MRPRN840
.
.------- Next of Kin Mobile Number-------
.
MRPR2432  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELM,VARIABLE
          ELSE
            MOVE      PMPXKMOB,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Next of Kin Email Address-------
.
MRPR2433  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEEMAI,VARIABLE
          ELSE
            MOVE      PMPXKEML,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Emergency Contact Mobile Number-------
.
MRPR2434  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELM,VARIABLE
          ELSE
            MOVE      PMPXCMOB,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Emergency Contact Email Address-------
.
MRPR2435  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * Emergency Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEEMAI,VARIABLE
          ELSE
            MOVE      PMPXCEML,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Nearest Relative Mobile Number-------
.
MRPR2436  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Realtive 
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCETELM,VARIABLE
          ELSE
            MOVE      PMPXRMOB,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Nearest Relative Email Address-------
.
MRPR2437  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Nearest Realtive
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCEEMAI,VARIABLE
          ELSE
            MOVE      PMPXREML,VARIABLE
          ENDIF
          GOTO      MRPRN840
.
.------- Aboriginality Code -------
.
MRPR2438  MOVE      PMPXABRG,VARIABLE
          GOTO      MRPRN840
.
.------- Next of Kin Relation Description -------
.
MRPR2442  MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            PACK      KEY10,PMCERELP,SP10
          ELSE
            PACK      KEY10,PNKRELP,SP10
          ENDIF
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      KEY10,PMRLDESC
          ENDIF
          MOVE      PMRLDESC,VARIABLE
          GOTO      MRPRN840
.
.------- Title Description -------
.
MRPR2443  PACK      KEY4,PTITL,SP10
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PTITL,PMTLDESC
          ENDIF
          MOVE      PMTLDESC,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSRFD Date of Request ------
.
MRPR2444  UNPACK    MRDSDTRQ,CCENT,CYEAR,CMON,CDAY    * Date of Request
          CALL      PACDATE
          MOVE      CPCDATE,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Name ------
.
MRPR2445  MOVE      SP70,ADOCDESC
          MATCH     SP70,MRDSCONS
          GOTO      MRPR2446 IF EQUAL
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,MRPR2446
          MOVE      DGNAME,ANS
          PACK      ADOCDESC,ANS,DOT,DSNAME
.
MRPR2446  MOVE      ADOCDESC,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Surgery Telephone Number ------
.
MRPR2447  MOVE      SP20,DTELES
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DTELES,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Address Line 1 ------
.
MRPR2448  MOVE      SP35,DSADD1
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD1,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Address Line 2 ------
.
MRPR2449  MOVE      SP35,DSADD2
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD2,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Address Line 3 ------
.
MRPR2450  MOVE      SP35,DSADD3
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD3,VARIABLE
          GOTO      MRPRN840
.
.                                         * see MRPR2462 for address line 4
.
.------ MRTDSR Consultant Post Code ------
.
MRPR2451  MOVE      SP30,DSPOST
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DSPOST,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Code ------
.
MRPR2452  MOVE      MRDSCONS,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Comments Line 1 ------
.         
MRPR2453  MOVE      MRDSCOM1,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Comments Line 2 ------
.
MRPR2454  MOVE      MRDSCOM2,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Comments Line 3 ------
.
MRPR2455  MOVE      MRDSCOM3,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Comments Line 4 ------
.
MRPR2456  MOVE      MRDSCOM4,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Comments Line 5 ------
.
MRPR2457  MOVE      MRDSCOM5,VARIABLE
          GOTO      MRPRN840
.
.                                                                     *I-125736
.------ format the attending doctor address line 4 ------
.
MRPR2458  MOVE      SP35,DSADD4
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          MOVE      DSADD4,VARIABLE
          GOTO      MRPRN840
.
.------ format referring doctor address line 4 of ------
.
MRPR2459  PACK      DSADD4,SP20,SP20
          IF        CRDRTYP <> 1
            MOVE      ADOCTR,KEY6
            CALL      RDDOCT1
          ENDIF
          MOVE      DSADD4,VARIABLE
          GOTO      MRPRN840
.
.------ format the assoc doctor address line 4 ------
.
MRPR2460  MOVE      SP35,DSADD4
          MOVE      PTMIADOC,KEY6
          CALL      RDDOCT1
          MOVE      DSADD4,VARIABLE
          GOTO      MRPRN840
.
.------ format the registrar doctor address line 4 ------
.
MRPR2461  MOVE      SP35,DSADD4
          MOVE      PTMIREGS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD4,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Address Line 4 ------
.
MRPR2462  MOVE      SP35,DSADD4
          MOVE      MRDSCONS,KEY6
          CALL      RDDOCT1
          MOVE      DSADD4,VARIABLE
          GOTO      MRPRN840
.
.------ MRTDSR Consultant Address Line 4 ------
.
MRPR2463  PACK      VARIABLE,SP70
          MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,VARIABLE       * IHI Number
          ENDIF
          GOTO      MRPRN840
.	  
.----- format patient sex long description ------	  
.	  
MRPR2464  MOVE      PSEX,DSEXCHAR	  
          CALL      SEXDSP00	      
          MOVE      DSEXLDES,VARIABLE        * Get sex long description		
          GOTO      MRPRN840	      
.
.----- format multiple birth details ------
.
MRPR2465  MOVE      AURNO,MBIRURNO
          CALL      MULBIR00                 * Get multlple birth details
          MOVE      MBIRTYOR,VARIABLE
          GOTO      MRPRN840
.
MRPR2466  PACK      VARIABLE,PMPXPFSN,SP70   * Preferred Surname
          GOTO      MRPRN840
.
MRPR2467  PACK      VARIABLE,PMPXPFGN,SP70   * Preferred Given Name
          GOTO      MRPRN840
.
MRPR2468  PACK      VARIABLE,PSNAME,SP70     * Pref Surname instead of Actual SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
MRPR2469  PACK      VARIABLE,PGNAME,SP70     * Pref GN instead of Actual GN
          MATCH     "1",PTCNPFGN
          IF        @EQUAL
            MATCH     SP70,PMPXPFGN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFGN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
MRPR2470  PACK      VARIABLE,PTMASNAM,SP70   * Pref Surname instead of 40char SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      MRPRN840
.
.
. ------------------------------------------------------
.
MRPRN840  RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
          PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      MRPRN100
.
.------ formatting for Form fields and right justified variables ------
.
MRPRN850  COMPARE   ZERO,PRNTSTRT          * don't bump if printing full length
          GOTO      MRPRN860 IF EQUAL
.
          BUMP      VARIABLE,PRNTSTRT      * bump to starting position
.
.------ print the variable ------
.
MRPRN860  PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      MRPRN100
.
.------ end of discharge summary request form reached ------
.
MRPRN900  MOVE      FALSE,EXIT
.
.------ print new-lines until the end of page is reached ------
.
MRPRN910  PRINT     *N;
          ADD       ONE,LASTROW
.
          COMPARE   LASTROW,IBTHLENG          * test page length
          GOTO      MRPRN999 IF EQUAL
.
          GOTO      MRPRN910
.
.------ no details on file ------
.
MRPRN990  MOVE      TRUE,EXIT
.
MRPRN999  
.         CALL      CLSPRINT                  * close the spool file
          RETURN
.
.------- Get a codes file record -------
.
GTCOD000  MOVE      SP20,TDESC               * Initialise description
          UNPACK    SP20,THCSCOD,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      ZERO,TCFORM6
.
.         Is the code blank ?
.
          MATCH     SP3,ACODE
          GOTO      GTCOD999 IF EQUAL
.
.         Get the code file record
.
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1
.
.
.------ pack the address ------
.
PAC6ADDR  PACK      ADDRLN WITH SP30,SP30
          MOVE      PKADD1,ADDRLN
          CALL      FENDSHT6                    * skip blanks
.
          APPEND    COMMA,ADDRLN
          APPEND    PKADD2,ADDRLN
          CALL      FENDSHT6                    * skip blanks
.
          APPEND    SP1,ADDRLN
          APPEND    PKPOST,ADDRLN
          RESET     ADDRLN
          RETURN
GTCOD999  RETURN
.
.------ set at end of field ------
.
FENDSHT6  RESET     ADDRLN,57
.
.------ skip over blanks ------
.
FSHT6LP1  CMATCH    SP1,ADDRLN
          RETURN    IF NOT EQUAL
          BUMP      ADDRLN,-1
          GOTO      FSHT6LP1 IF NOT EOS
.
          RESET     ADDRLN
          RETURN
.
.------------------------------------------------------------
. Close Spool File and Send Fax
.------------------------------------------------------------
FAXPRINT  COMPARE   ZERO,CPRTFLG
          GOTO      FAXPR999 IF NOT EQUAL
.
.         Check if file is of non-zero size
.
          CALL      SPLEMPTY
          BRANCH    OVRCD,FAXPR800,FAXPR900
.
          MATCH     SP70,PTDOFAXN
          GOTO      FAXPR950 IF EQUAL
.
          CLEAR     KEY80
          APPEND    "mrtweb04.us1 ",KEY80
          APPEND    SPLFILE,KEY80
          APPEND    SP1,KEY80
          APPEND    "#"",KEY80
          APPEND    PTDOFAXN,KEY80
          APPEND    "#"",KEY80
          APPEND    SP1,KEY80
          APPEND    PASSCODE,KEY80
          APPEND    SP1,KEY80
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          APPEND    "#"",KEY80
          APPEND    DOCFNAME,KEY80
          APPEND    "#"",KEY80
          RESET     KEY80
.
          DISPLAY   *P1:24,*EL:
                    *P20:24,*EL,*V2LON,"Fax being queued. Please wait";
          EXECUTE   KEY80,TASKID
          MOVE      "  1",MRDSLTST
          GOTO      FAXPR900
.
.         Quick delete of spool file
.
FAXPR800  MOVE      FILENAME,CSPDESC       * Name of file to be deleted
          CALL      SPLDELET
FAXPR900  MOVE      SP8,SPLFILE
          GOTO      FAXPR999
.
FAXPR950  CALL      CLSPRINT               * No Fax Number
.
FAXPR999  RETURN
.
.**********************************************************************
.*                            SPLDELET                                *
.*                     Delete the Spool File                          *
.**********************************************************************
SPLDELET  PACK        CSPDESC,CSPDESC,SP20
          MATCH       SP20,CSPDESC
          IF          !(@EQUAL)
            PREPARE     SPLTFILE,CSPDESC
            CLOSE       SPLTFILE
.
            OPEN        IBASPOL1,"ibaspolf"
            MOVE        SPLFILE,KEY8
            CALL        DESPOL1              * delete from files spooled
          ENDIF
          MOVE        SP8,SPLFILE
          RETURN
.
.
.------------------------------------------------------------
. Hospital Selection - With hospital security test
.------------------------------------------------------------
MLTH0000  MATCH     SP70,DESTHOSP
          IF        @EQUAL
            MOVE      WBSEHOSP,DESTHOSP
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
MLTH0100  CALL      RKPTHSP1
          BRANCH    OVRCD,MLTH9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,MLTH0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     DESTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      MLTH0100
.
MLTH9999  RETURN
.
.------------------------------------------------------------
. Hospital Selection - List of Hospitals allowed to User
.------------------------------------------------------------
HSEL0000  IF        IBCNMHOS = 1
            MATCH     "1",SUPERLEV
            GOTO      HSEL5000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
.
          MATCH     SP70,PTHSHHOS                * Any default MR home hospital
          GOTO      HSEL0100 IF EQUAL
.
          MATCH     PTHSHOSP,PTHSHHOS            * MR home hospital different to
          GOTO      HSEL0100 IF EQUAL            * current hosptial
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD = 1
            PACK      KEY13,USERID,PTHSHHOS,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL2000
          ENDIF
          GOTO      HSEL0100
.
HSEL2000  PACK      KEY3,PTHSHHOS,SP70           * Output associated MR home
          CALL      RDPTHSP1                     * hospital the user doesn't
          BRANCH    OVRCD,HSEL0100               * have direct access to.
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
.
          GOTO      HSEL0100
.
HSEL5000  MOVE      SP10,WBSEHOSP           * only display User Hospital
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,HSEL9999
.    
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                             KEY50,"</option>"
.
          MATCH     SP70,PTHSHHOS                * Any default MR home hospital
          GOTO      HSEL9999 IF EQUAL
.
          MOVE      PTHSHOSP,SAVKEY3A
          MOVE      PTHSHHOS,SAVKEY3B
.
.         MATCH     PTHSHOSP,PTHSHHOS            * MR home hospital different to
.         GOTO      HSEL6000 IF EQUAL            * current hosptial
.
.         PACK      KEY3,PTHSHHOS,SP70           * Output MR home hospital
.         CALL      RDPTHSP1
.         BRANCH    OVRCD,HSEL6000
.    
.         MOVE      PTHSNAME,KEY50
.         PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
.         WRITE     HTMLFILE;"<option value=",KEY5,">":
.                            KEY50,"</option>"
HSEL6000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL6100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          MATCH     SAVKEY3A,PTHSHOSP
          GOTO      HSEL6100 IF EQUAL
.
.         MATCH     SAVKEY3B,PTHSHHOS
.         GOTO      HSEL6100 IF EQUAL
.
          MATCH     PTHSHHOS,SAVKEY3B
          GOTO      HSEL6100 IF NOT EQUAL
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY5,">":
                             KEY50,"</option>"
.
          GOTO      HSEL6100
.
HSEL9999  RETURN
+
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       GTIHINUM
          INC       WEBDATCD
          INC       RSHWEBCD
          INC       DGCLICRM             * DG API for Med.Rec.Movement *I-90201
          INC       GCCARD00
.
          INC       APSMASIO/INC
          INC       MLTSECIO/INC
          INC       PMSCCDIO/INC 
          INC       PATMA1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       IBATMDIO/INC
          INC       IBALPCIO/INC
          INC       PMSPX2IO/INC
          INC       PATMI1IO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PATVADIO/INC
          INC       PMSVX1IO/INC
          INC       PMSTLEIO/INC
          INC       PMSDUNIO/INC
          INC       PMSRELIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDADIO/INC
          INC       PATDGWIO/INC
          INC       PATASFIO/INC
          INC       PATALRIO/INC   
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATITMIO/INC
          INC       PATICDIO/INC
          INC       PATGO1IO/INC
          INC       PATMMBIO/INC
          INC       OUTSITIO/INC   * Outpatients - Site Codes File
          INC       PATFN1IO/INC   * Health Fund File
          INC       PATIN1IO/INC   * Insurance File
          INC       PATPR1IO/INC   * New Patient Master File
          INC       PATWR1IO/INC
          INC       PATHSPIO/INC   * Hospital Details File
          INC       PATECDIO/INC
          INC       PATRE1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSIHIIO/INC
.
          INC       PATATRIO/INC
          INC       MULBIR00
.
          INC       MRTDSRIO/INC
          INC       MRTSTFIO/INC
          INC       MRTMASIO/INC
          INC       MRTVISIO/INC
          INC       MRTLOCIO/INC
          INC       MRTMOVIO/INC
          INC       MRTPDSIO/INC
          INC       MRTPSHIO/INC
          INC       MRTHISIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
.
          INC       CLMRTHIS
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPATMAS
          INC       CLPATDSC
          INC       CLPATMIS
          INC       CLPMSCEX
          INC       CLPMSVX1
          INC       CLPATVIS
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATMASTM
          INC       PATMISTM
          INC       CLPMSPX2
          INC       PMSCEXCD
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       LABELAGE
