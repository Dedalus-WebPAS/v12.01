.----------------------------------------------------------------------
. Program       : PATWEB15
.
. Function      : Electronic Admissions
.               
. Modifications : 
.----------------------------------------------------------------------
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.00.03 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.02 30/07/2020  Thanh T        TSK 0834767
.           Added GTAG0360 and RQRVST00
. V11.00.01 24/07/2020  Thanh T        TSK 0834767
.           Added GTAG0360 and RQRVST00 
. V10.11.03 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.01 12/04/2017  Richa Phogat   TSK 0323730
.           Updated MAATAB00 - display all lines of comments on 'Medical
.           Authorisation Status' screen
. V10.09.02 24/01/2017  Don Nguyen     TSK 0323730
.           Modified HRTB0000 - removed exclusion for 'Approval Denied' status.
.           Modified HRRW0000 - output javascript for Procedure Description 
.           Comments icon on mouse hover action (HOVERSTR).
. V10.09.01 14/12/2016  Don Nguyen     TSK 0323730
.           Modified HRTB0000 to exclude 'Approval Denied' for PMARSTAT
.           Added ADDMAA00, DISSTAT7, DISSTAT8, REVEXT00, MAATAB00, GETCMF00
.           Recompiled for PMSARQTM - Modified value descriptions in PMAR0580
. V10.06.06 09/06/2015  Ebon Clements  CAR 311702 
.           Added showproc - Show processed and removed records filter
. V10.06.05 22/05/2015  Jill Parkinson CAR 317185 
.           Added read of pmsarqaf before UPDCMB00 so comments go to the correct
.           admission request
. V10.06.04 13/05/2015  Ania P          CAR 311416
.           Added XREQ1500
. V10.06.03 04/05/2015  Don Nguyen      CAR 316151
.           Recompiled for PMSARQTM - output default '0' for PMARHGHT / PMARWGHT
. V10.06.02 01/04/2015  Ania P          CAR 311416
.           Added PMAVASAS to XREQ0000
. V10.06.01 30/03/2015  Peter Vela      CAR 314075
.           Added pack of ADMISSNO in PREQ8000
. V10.05.01 21/08/2014  Peter Vela      CAR 303909
.           Added IBCNMHOS
. V10.04.02 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.16 13/11/2013  Ebon Clements            CAR 291974
.           Recompiled for PMSARQFD - Added index 5 for 
.           lists with no date range
. V10.03.15 12/11/2013  Ebon Clements            CAR 291974
.           Only update the same review status - REVU0000
. V10.03.14 11/11/2013  Ebon Clements            CAR 291974
.           Changed category of PMAVBTYP from RT to yj
. V10.03.13 11/11/2013  Ebon Clements            CAR 291974
.           Added procedure comments to HRRW0000 and HRVR0000
. V10.03.12 28/10/2013  Ebon Clements            CAR 291974
.           Fixed pre anaesthetic and clinic triage update
. V10.03.11 25/10/2013  Ebon Clements            CAR 291974
.           Fixed procecdure display on review list 
. V10.03.10 23/10/2013  Ebon Clements            CAR 291974
.           Added review/clinical triage exists tag - GTAG0290
. V10.03.09 22/10/2013  Ebon Clements            CAR 291974
.           Added merged message to PREQ0000
. V10.03.08 22/10/2013  Ebon Clements            CAR 291974
.           Allow return to clinician to be saved as a draft - EDIT0000
. V10.03.07 21/10/2013  Ebon Clements            CAR 291974
.           Changed title of PMARUDF1 to preferred language
. V10.03.06 08/10/2013  Ebon Clements            CAR 275205
.           Recompiled for PATMSXTM - Added PSTAT tag
. V10.03.05 03/10/2013  Ebon Clements            CAR 275205
.           Recompiled for PMSARQFD - Addition of transfer source
. V10.03.04 27/09/2013  Ebon Clements            CAR 275205
.           Added report 4 remote scripts
. V10.03.03 26/09/2013  Ebon Clements            CAR 275205
.           Added hospital level PMI search functionality
. V10.03.02 25/09/2013  Ebon Clements            CAR 275205
.           Added hospital level review list
. V10.03.01 20/09/2013  Ebon Clements            CAR 275205
.           Added report 3 - Reviews
. V10.03.00 28/08/2013  Ebon Clements            CAR 275205
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       APSMASFD/INC
          INC       MLTHCPFD/INC
          INC       MLTSECFD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATASFFD/INC
          INC       PATCALAG/INC
          INC       PATCMCFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATDADFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDGWFD/INC
          INC       PATFN1FD/INC
          INC       PATHSPFD/INC
          INC       PATIN1FD/INC
          INC       PATITMFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSAMNFD/INC
          INC       PMSAMNTD/INC
          INC       PMSARQFD/INC
          INC       PMSARQTD/INC
          INC       PMSARVFD/INC
          INC       PMSARVTD/INC
          INC       PMSATCFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSTEMFD/INC
          INC       PMSVX1FD/INC
          INC       WATPROFD/INC
          INC       WATTR1FD/INC
.
          INC       TFILEVAR/INC
.
.----------------------------------------------------------------------
ALLDATES  FORM      1
ADMREQNO  DIM       10
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
SAVEURNO  DIM       8
STARTKEY  DIM       10      * Starting Key
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATYE     INIT      "ye"
CLINICAL  DIM       1                       * Menu cgi Clinical view = 1
CATECODE  DIM       3                       * Filter for category CAT TP
LINECNT1  DIM       3
LINECNT2  FORM      3
.
COMFAEND  FORM      3
COMFAFLG  FORM      1
COMFILAF  FILE      ASCII, FIXED=128        * Comment type 003
COMFILNA  DIM       8
.
COMFBEND  FORM      3
COMFBFLG  FORM      1
COMFILBF  FILE      ASCII, FIXED=128        * Comment type 004
COMFILNB  DIM       8
.
COMFCEND  FORM      3
COMFCFLG  FORM      1
COMFILCF  FILE      ASCII, FIXED=128        * Comment type 001
COMFILNC  DIM       8
.
COMFDEND  FORM      3
COMFDFLG  FORM      1
COMFILDF  FILE      ASCII, FIXED=128        * Comment type 005
COMFILND  DIM       8
.
COMFEEND  FORM      3
COMFEFLG  FORM      1
COMFILEF  FILE      ASCII, FIXED=128        * Comment type 002
COMFILNE  DIM       8
.
COMFFEND  FORM      3
COMFFFLG  FORM      1
COMFILFF  FILE      ASCII, FIXED=128        * Comment type 006
COMFILNF  DIM       8
.
COMM127   DIM       127
CURRDATE  DIM       8       * Current Date
FLDRTYPE  DIM       3
FORM8     FORM      8 
FORM3     FORM      3 
DEFTVIEW  FORM      1
DESCBTYP  DIM       20
DESCCOM1  DIM       50
DESCCOM2  DIM       50
DESCCLTR  DIM       20
DESCHOSP  DIM       50
DESCPARC  DIM       20
DESCPPBY  DIM       20
DESCPROC  DIM       80
DESCPHOS  DIM       50
DESCPRTY  DIM       20
DESCRSTA  DIM       20
DESCRTYP  DIM       35
DESCSTAT  DIM       25
DESCTBED  DIM       20
DESCUNIT  DIM       20
DESCUUID  DIM       30
DESCRESC  DIM       50
DIM3      DIM       3
DIM8      DIM       8
DISPDAT1  DIM       11
DISPDAT2  DIM       11
DISPSUR   DIM       8                          * Display Saved U/R Number
DISPMUR   DIM       8                          * Display Merged U/R Number
DOCTCODE  DIM       8
.
FILTCLTR  DIM       3
FILTHOSP  DIM       3
FILTREQT  DIM       1
FILTUNIT  DIM       3
FILTPRTY  DIM       3
FILTPARC  DIM       3
FILTPPBY  DIM       3
FILTRESC  DIM       10
FILTSTAT  DIM       1
FILTTURN  DIM       1
.
HOSPCODE  DIM       3
LOOPCNTR  FORM      8
MBSDESC   DIM       70
MRGEFLAG  FORM      1
PSAGECON  DIM       3
PSAGETYP  DIM       3
REMOTENO  FORM      1
RETURNFL  FORM      1
SHOWFLAG  FORM      1
SHOWPROC  FORM      1
SUBMTFLG  DIM       1        * Submit flag for Medical Authorisation Review
.                                D - Draft
.                                S - Submit
.
UPDTPARC  DIM       3
UPDTCLTR  DIM       3
UPDTBTYP  DIM       3
.
CHRCOUNT  FORM      3        * char count
DESTSTRN  DIM       300      * destination string with js escaped single-quotes
HOVERSTR  DIM       350      * javascript for HoverData()
SRCESTRN  DIM       100      * source string
.
DISRTYP1  INIT      "Elective Waitlist"
DISRTYP2  INIT      "Elective - Non Waitlist (Surgical)"
DISRTYP3  INIT      "Elective - Non Waitlist (Medical)"
.
DISSTAT1  INIT      "Draft"
DISSTAT2  INIT      "Submitted"
DISSTAT3  INIT      "Returned to Clinician"
DISSTAT4  INIT      "Processed"
DISSTAT5  INIT      "Removed"
DISSTAT6  INIT      "Review"
DISSTAT7  INIT      "Approval Required"
DISSTAT8  INIT      "Approval Denied"
TILDA24   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~"
.
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB15"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Electronic Admissions Web Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400

.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PREQ0000                * Patiet Level Admission Requests
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      HLST0000                * Hospital Level Lists
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      REVW0000                * Reviews
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      REMT0000                * Remote Scripts
          MOVE      ONE,EXIT
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00           * Redirect
          GOTO      NXTPAG99
.
NXTPAG20  CALL      PREDIR00           * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
.
          OPEN      MLTHCPA1,"mlthcpaf"
          OPEN      MLTHCPA2,"mlthcpaf"
          OPEN      MLTSECA1,"mltsecaf"
.
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA2,"patvisaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSAMNA1,"pmsamnaf"
          OPEN      PMSARQA1,"pmsarqaf"
          OPEN      PMSARQA2,"pmsarqaf"
          OPEN      PMSARQA3,"pmsarqaf"
          OPEN      PMSARQA4,"pmsarqaf"
          OPEN      PMSARQA5,"pmsarqaf"
          OPEN      PMSARVA1,"pmsarvaf"
          OPEN      PMSARVA2,"pmsarvaf"
          OPEN      PMSATCA1,"pmsatcaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSTEMA1,"pmstemaf"
.
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      WATPROA1,"watproaf"
          OPEN      WATTR1A1,"wattr1af"
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNA
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNB
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNC
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILND
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNE
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNF
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*94,CAGECOFF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,REDIRECT
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,CLINICAL
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,SHOWFLAG
          MOVE      SP70,CATECODE
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,RETURNFL
          MOVE      ZERO,REMOTENO
          MOVE      SP70,ADMREQNO
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,ALLDATES
.
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTUNIT
          MOVE      SP70,FILTPRTY
          MOVE      SP70,FILTPARC
          MOVE      SP70,FILTCLTR
          MOVE      SP70,FILTPPBY
          MOVE      SP70,FILTRESC
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTREQT
          MOVE      SP70,FILTTURN
          MOVE      SP70,HOSPCODE
.
          MOVE      ZERO,COMFAEND
          MOVE      ONE,COMFAFLG
.
          MOVE      ZERO,COMFBEND
          MOVE      ONE,COMFBFLG
.
          MOVE      ZERO,COMFCEND
          MOVE      ONE,COMFCFLG
.
          MOVE      ZERO,COMFDEND
          MOVE      ONE,COMFDFLG
.
          MOVE      ZERO,COMFEEND
          MOVE      ONE,COMFEFLG
.
          MOVE      ZERO,COMFFEND
          MOVE      ONE,COMFFFLG
.
          MOVE      ZERO,SHOWPROC
          MOVE      SP70,SUBMTFLG
.
          CALL      CPPMAR00
          CALL      CPPMAM00
          CALL      CPPMAV00
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmarq",QRYNAME
          IF        @EQUAL
            CALL      SPMAR000
          ENDIF
.
          MATCH     "pmatc001",QRYNAME
          IF        @EQUAL
            CALL      GETCMC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmatc002",QRYNAME
          IF        @EQUAL
            CALL      GETCME00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmatc003",QRYNAME
          IF        @EQUAL
            CALL      GETCMA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmatc004",QRYNAME
          IF        @EQUAL
            CALL      GETCMB00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmatc005",QRYNAME
          IF        @EQUAL
            CALL      GETCMD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmatc006",QRYNAME
          IF        @EQUAL
            CALL      GETCMF00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmamcatg",QRYNAME
          IF        @EQUAL
            CALL      SPMCAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmamcode",QRYNAME
          IF        @EQUAL
            CALL      SPMCOD00
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "clinical=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICAL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtreqt=",QRYNAME
          IF        @EQUAL
            PACK      FILTREQT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtunit=",QRYNAME
          IF        @EQUAL
            PACK      FILTUNIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtprty=",QRYNAME
          IF        @EQUAL
            PACK      FILTPRTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtparc=",QRYNAME
          IF        @EQUAL
            PACK      FILTPARC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtcltr=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLTR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtppby=",QRYNAME
          IF        @EQUAL
            PACK      FILTPPBY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtresc=",QRYNAME
          IF        @EQUAL
            PACK      FILTRESC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtturn=",QRYNAME
          IF        @EQUAL
            PACK      FILTTURN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "catecode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CATECODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "deftview=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,DEFTVIEW
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "returnfl=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,RETURNFL
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "pmarv",QRYNAME
          IF        @EQUAL
            CALL      SPMAV000
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alldates=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLDATES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showproc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWPROC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admreqno=",QRYNAME
          IF        @EQUAL
            PACK      ADMREQNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "submtflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUBMTFLG
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Patient Level Admission Requests
.------------------------------------------------------------
PREQ0000  MATCH     SP70,UPDTTYPE
          GOTO      PREQ8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE                 * Add
          GOTO      PREQ1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE                 * Update
          GOTO      PREQ2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete
          GOTO      PREQ3000 IF EQUAL
.
          MATCH     "C",UPDTTYPE                 * Comments
          GOTO      PREQ4000 IF EQUAL
.
          MATCH     "R",UPDTTYPE                 * Remove
          GOTO      PREQ5000 IF EQUAL
.
          MATCH     "N",UPDTTYPE                 * Return to Clinician
          GOTO      PREQ6000 IF EQUAL
.
          MATCH     "V",UPDTTYPE                 * Review
          GOTO      PREQ7000 IF EQUAL
.
          GOTO      PREQ9000
.
PREQ1000  MOVE      "120",PRXCODE      * System Lock Sector 120         * Add
          CALL      GETSLK00           * Get System Lock of Sector 10
.
          READ      CONTROLF,HUND20;*222,PTCNREQN
          MOVE      PTCNREQN,F10
          ADD       ONE,F10
          MOVE      F10,PTCNREQN
          WRITAB    CONTROLF,HUND20;*222,PTCNREQN
.
          SUB       ONE,F10
          MOVE      F10,PTCNREQN
.
          CALL      RELSLK00           * Release System Lock of Sector 10
.
          PACK      KEY10,PTCNREQN,SP70
          CALL      RDPMARQ1
          COMPARE   ZERO,OVRCD
          GOTO      PREQ1000 IF EQUAL             * get the next request number
.
          MOVE      PTCNREQN,PMARQ001             * Set request number cgi
.
          CALL      CLPMSARQ
          CALL      MVPMAR00                      
.
          PACK      PMARCDAT,CCC,CYY,CMM,CDD      * Set created by fields
          REP       " 0",PMARCDAT
          CLOCK     TIME,PMARCTIM
          MOVE      USERID,PMARCUID
.
          CALL      WRPMARQ1                      * Write new request
.
          CALL      UPDCMA00                      * Update Comments
          CALL      MVPMAM00                      * Update patient needs
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ2000  PACK      KEY10,PMARQ001,SP70           * Update
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          CALL      EDIT0000                      * Edit checks
          BRANCH    EXIT,PREQ9999
          
          CALL      MVPMAR00                      
.
          PACK      PMARUDAT,CCC,CYY,CMM,CDD      * Set updated by fields
          REP       " 0",PMARUDAT
          CLOCK     TIME,PMARUTIM
          MOVE      USERID,PMARUUID
.
          CALL      UPPMARQ1                      * Update Request
.
          CALL      UPDCMA00                      * Update Comments
          CALL      MVPMAM00                      * Update patient needs
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ3000  PACK      KEY10,PMARQ001,SP70          * Delete
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          CALL      DEPMARQ1
.
          CALL      DELCOM00                     * Delete comments
          CALL      DELPMA00                     * Delete patient needs
          CALL      DELREV00                     * Delete review
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ4000  PACK      KEY10,PMARQ001,SP70           * Remove
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          CALL      UPDCMB00                     * Comments
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ5000  PACK      KEY10,PMARQ001,SP70           * Remove
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          MOVE      "5",PMARQ057                  
          CALL      MVPMAR00
.
          PACK      PMARUDAT,CCC,CYY,CMM,CDD      * Set updated by fields
          REP       " 0",PMARUDAT
          CLOCK     TIME,PMARUTIM
          MOVE      USERID,PMARUUID
.
          CALL      UPPMARQ1                      * Update Request
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ6000  PACK      KEY10,PMARQ001,SP70           * Return to Clinician
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          MOVE      "3",PMARQ057
          CALL      MVPMAR00
.
          PACK      PMARUDAT,CCC,CYY,CMM,CDD      * Set updated by fields
          REP       " 0",PMARUDAT
          CLOCK     TIME,PMARUTIM
          MOVE      USERID,PMARUUID
.
          CALL      UPPMARQ1                      * Update Request
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ7000  PACK      KEY10,PMARQ001,SP70           * Review
          CALL      RDPMARQ1
          BRANCH    OVRCD,PREQ9200
.
          MOVE      "6",PMARQ057
          CALL      MVPMAR00
.
          PACK      PMARUDAT,CCC,CYY,CMM,CDD      * Set updated by fields
          REP       " 0",PMARUDAT
          CLOCK     TIME,PMARUTIM
          MOVE      USERID,PMARUUID
.
          CALL      UPPMARQ1                      * Update Request
.
          MOVE      ZERO,EXIT
          GOTO      PREQ9999
.
PREQ8000  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PREQ9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21                     * Read Pmi Extn
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      PREQ8000
          ENDIF
.
          PACK      KEY10,PMARQ001,SP70
          CALL      RDPMARQ1                     * Read Adm Request
          IF        OVRCD=1
            CALL      CLPMSARQ
          ELSE
            PACK      ADMISSNO,PMARVISN,SP70
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Admission Requests",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PREQ9999
.
          CALL      WEBBOD00   * Process Web Body
.
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PREQ9999
.
PREQ9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PREQ9999
.
PREQ9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PREQ9999
.
PREQ9200  MOVE      "Invalid Admission Request. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PREQ9999
.
PREQ9999  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          CLOSE     COMFILCF,DELETE
          CLOSE     COMFILDF,DELETE
          CLOSE     COMFILEF,DELETE
          RETURN
.
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.
.------------------------------------------------------------
. Edit checks prior to admission request update
.------------------------------------------------------------
EDIT0000  MATCH     "1",PMARQ057            * Saving Draft
          IF        @EQUAL
            MATCH     "4",PMARSTAT          * Error if status not draft
            GOTO      EDIT9000 IF EQUAL
.
            MATCH     "5",PMARSTAT          * Error if status not draft
            GOTO      EDIT9000 IF EQUAL
          ENDIF
.
          MATCH     "2",PMARQ057            * Saving Submitted
          IF        @EQUAL
            MATCH     "4",PMARSTAT          * Error if status not draft
            GOTO      EDIT9000 IF EQUAL
.
            MATCH     "5",PMARSTAT          * Error if status not draft
            GOTO      EDIT9000 IF EQUAL
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      EDIT9999
.
EDIT9000  MOVE      "Invalid status update.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EDIT9999
.
EDIT9999  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000           * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      PMAR0000           * Admission Request 
          GOTO      PROFLD99
.
PROFLD13  CALL      GTAG0000           * General Tags
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      GTAG0000           * General Tags
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000           * Master File Info
          GOTO      PROFLD99
.
PROFLD32  CALL      PMAR0000           * Admission Request
          GOTO      PROFLD99
.
PROFLD33  CALL      GTAG0000           * General Tags
          GOTO      PROFLD99
.
PROFLD34  CALL      PMAV0000           * Review
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0010,GTAG0020,GTAG0030,GTAG0040,GTAG0050:
                             GTAG0060,GTAG0070,GTAG0080,GTAG0090,GTAG0100:
                             GTAG0110,GTAG0120,GTAG0130,GTAG0140,GTAG0150:
                             GTAG0160,GTAG0170,GTAG0180,GTAG0190,GTAG0200:
                             GTAG0210,GTAG0220,GTAG0230,GTAG0240,GTAG0250:
                             GTAG0260,GTAG0270,GTAG0280,GTAG0290,GTAG0300:
                             GTAG0310,GTAG0320,GTAG0330,GTAG0340,GTAG0350:
                             GTAG0360
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      GTAG9999
.
GTAG0010  CALL      RTAB0000                * U/R level adm request list
          GOTO      GTAG9999
.
GTAG0020  MOVE      SP70,DIM3
          UNPACK    DIM127,D1,DIM3,DIM127
.
          PACK      KEY19,PMARREQN,DIM3,SP2,ONE,SP70
          CALL      RSPMATC1
GTAB0021  CALL      RKPMATC1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     PMARREQN,PMATREQN
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     DIM3,PMATTYPE
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     "  1",PMATCNTR               * 1 for admission request
          GOTO      GTAG9999 IF NOT EQUAL
.
          STRIP     PMATDATA
          MOVELPTR  PMATDATA,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      PMATDATA,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      GTAB0021
.
GTAG0030  CALL      AMAITM00                * Patient Needs
          GOTO      GTAG9999
.
GTAG0040  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GTAG0041
.
          MATCH     "1",CLINICAL
          IF        @EQUAL
            WRITE     HTMLFILE;"Clinician View";
          ELSE
            WRITE     HTMLFILE;"Clerical View";
          ENDIF
          GOTO      GTAG9999
.
GTAG0041  WRITE     HTMLFILE;CLINICAL;
          GOTO      GTAG9999
.
GTAG0050  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD
          ENDIF
          CALL      CALCAGE
          COMPARE   PSAGEYRS,CAGECOFF
          IF        @LESS
            WRITE     HTMLFILE;ONE;         // Adult
          ELSE
            WRITE     HTMLFILE;ZERO;        // Child
          ENDIF
          GOTO      GTAG9999
.
GTAG0060  MOVE      SP70,DIM3
          UNPACK    DIM127,D1,DIM3,DIM127
.
          PACK      KEY19,PMARREQN,DIM3,SP2,ONE,SP70
          CALL      RSPMATC1
          CALL      RKPMATC1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     PMARREQN,PMATREQN
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     DIM3,PMATTYPE
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     "  1",PMATCNTR           // 1 for admission request
          GOTO      GTAG9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;            // Comments exist
          GOTO      GTAG9999
.
GTAG0070  CALL      SELV0000 
          GOTO      GTAG9999
.
GTAG0080  CALL      NEXT0000
          GOTO      GTAG9999
.
GTAG0090  CALL      PREV0000
          GOTO      GTAG9999
.
GTAG0100  WRITE     HTMLFILE;FILTREQT;           // Request type filter
          GOTO      GTAG9999
.
GTAG0110  CALL      HRTB0000                * Hospital level adm request list
          GOTO      GTAG9999
.
GTAG0120  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            MOVE      WBSEHOSP,FILTHOSP     
          ENDIF
.
          CALL      HSEL0000                * Hospital filter
          GOTO      GTAG9999
.
GTAG0130  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      GTAG9999
.
GTAG0140  MOVE      "WU",CATEGORY
          MOVE      FILTUNIT,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0150  MATCH     SP70,CATECODE
          IF        !@EQUAL
            CALL      PMAP0000              * Map priority cat TP to ye
          ENDIF
.
          MOVE      "ye",CATEGORY
          MOVE      FILTPRTY,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0160  MOVE      "yh",CATEGORY
          MOVE      FILTPPBY,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0170  IF        SHOWFLAG=0
            MATCH     SP70,FILTRESC
            IF        @EQUAL
              MOVE      WBSEDOC,FILTRESC
            ENDIF
          ENDIF
.
          MOVE      FILTRESC,DOCTCODE
          CALL      DOCDET00
          GOTO      GTAG9999
.
GTAG0180  WRITE     HTMLFILE;FILTSTAT;
          GOTO      GTAG9999
.
GTAG0190  CALL      SRTB0000                * Hospital level adm request list
          GOTO      GTAG9999                * By status
.
GTAG0200  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      GTAG9999
.
GTAG0210  WRITE     HTMLFILE;RETURNFL;
          GOTO      GTAG9999
.
GTAG0220  PACK      KEY19,PMARURNO,SP70      * Other WL
          CALL      RDSTREA1
GTAG0221  CALL      RDKTREA1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     WMURNO,PMARURNO
          GOTO      GTAG9999 IF NOT EQUAL
.
          IF        WMSTAT<5
            WRITE     HTMLFILE;ONE;
            GOTO      GTAG9999
          ENDIF
          GOTO      GTAG0221
.
GTAG0230  CALL      ARTB0000                * Pre anaesthetic review table
          GOTO      GTAG9999
.
GTAG0240  CALL      CTTB0000                * Clinical triage review table
          GOTO      GTAG9999
.
GTAG0250  MOVE      SP70,DIM3
          UNPACK    DIM127,D1,DIM3,DIM127
.
          PACK      KEY19,PMAVREQN,DIM3,PMAVCNTR,SP70
          CALL      RSPMATC1
GTAB0251  CALL      RKPMATC1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     DIM3,PMATTYPE
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      GTAG9999 IF NOT EQUAL
.
          STRIP     PMATDATA
          MOVELPTR  PMATDATA,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      PMATDATA,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      GTAB0251
.
GTAG0260  CALL      HRVT0000                * Hospital level adm req rev list
          GOTO      GTAG9999
.
GTAG0270  MOVE      "ym",CATEGORY
          MOVE      FILTPARC,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0280  MOVE      "yl",CATEGORY
          MOVE      FILTCLTR,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0290  MOVE      SP70,DIM3
          UNPACK    DIM127,D1,DIM3,DIM127

          PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
GTAG0291  CALL      RPPMARV2
          BRANCH    OVRCD,GTAG9999
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      GTAG9999 IF NOT EQUAL
.
          MATCH     DIM3,PMAVRTYP
          GOTO      GTAG0291 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;      * Review/Clincicl traige exists
          GOTO      GTAG9999
.
GTAG0300  WRITE     HTMLFILE;FILTTURN;
          GOTO      GTAG9999
.
GTAG0310  WRITE     HTMLFILE;ALLDATES;
          GOTO      GTAG9999
.
GTAG0320  WRITE     HTMLFILE;SHOWPROC;      * Show processed and removed filter
          GOTO      GTAG9999
.
GTAG0330  MATCH     SP70,PBDATE
          GOTO      GTAG9999 IF EQUAL
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     "00",CDAY
          GOTO      GTAG9999 IF EQUAL
.
          CALL      IBACLOCK
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          WRITE     HTMLFILE;PSAGEYRS;      * Patient age in years
          GOTO      GTAG9999
.
GTAG0340  CALL      REVEXT00           * Check if Authorisation Approval exists
          IF        EXIT=0
            WRITE     HTMLFILE;ONE;    * Exist
          ELSE
            WRITE     HTMLFILE;ZERO;   * Does not exist
          ENDIF
          GOTO      GTAG9999
.
GTAG0350  CALL      MAATAB00           * Medical Authorisation Approval list
          GOTO      GTAG9999
.
GTAG0360  CALL      RQRVST00           * Latest reuqest review status
          GOTO      GTAG9999
.
GTAG9999  RETURN
+
.------------------------------------------------------------------------------
. Checks if Admission Request Review record exists for 'Medical Authorisation
. Approval' (type 003).
.------------------------------------------------------------------------------
REVEXT00  MOVE      PMARREQN,PMARV001
          MOVE      "003",PMARV002
.
          PACK      KEY16,PMARV001,PMARV002,Z70
          CALL      RSPMARV1
          CALL      RPPMARV1
          BRANCH    OVRCD,REVEXT91
.
          MATCH     PMARV001,PMAVREQN
          GOTO      REVEXT91 IF NOT EQUAL
.
          MATCH     PMARV002,PMAVRTYP
          GOTO      REVEXT91 IF NOT EQUAL
.
REVEXT90  MOVE      ZERO,EXIT          * No Review Status        
          GOTO      REVEXT99
.
REVEXT91  MOVE      ONE,EXIT           * Review Status exists
REVEXT99  RETURN
+
.------------------------------------------------------------
. Patient Level Admission Request List
.------------------------------------------------------------
RTAB0000  PACK      KEY18,URNUMBER,SP70
          CALL      RSPMARQ2
RTAB1000  CALL      RKPMARQ2
          BRANCH    OVRCD,RTAB9999
.
          MATCH     URNUMBER,PMARURNO
          GOTO      RTAB9999 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdRequest01('",HTMLLINK
          APPEND    PMARREQN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,DESCRTYP
          MOVE      ZERO,F1
          MOVE      PMARRTYP,F1
          LOAD      DESCRTYP,F1,DISRTYP1,DISRTYP2,DISRTYP3
.
          MOVE      SP70,DESCSTAT
          MOVE      ZERO,F1
          MOVE      PMARSTAT,F1
          LOAD      DESCSTAT,F1,DISSTAT1,DISSTAT2,DISSTAT3,DISSTAT4:
                                DISSTAT5,DISSTAT6,DISSTAT7,DISSTAT8
.
          PACK      KEY10,PMARRESC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      PMHCTITL,FMTTITLE            * I CAR 13038
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
          MOVE      DOCFNAME,DESCRESC
.
          MOVE      "WU",CATEGORY
          MOVE      PMARUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCUNIT
.
          MOVE      "ye",CATEGORY
          MOVE      PMARPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPRTY
.
          MOVE      "yh",CATEGORY
          MOVE      PMARPPBY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPPBY
.
          MOVE      SP70,DESCPHOS
          PACK      KEY3,PMARPHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            MOVE      PTHSNAME,DESCPHOS
          ENDIF
. 
          MOVE      SP70,DESCPROC
          PACK      KEY9,PMARPROC,SP70
          CALL      RDPROA1
          IF        OVRCD<>1
            MOVE      WPDESC,DESCPROC
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",PMARREQN,"#",":               * 1
                             "#"",PMARREQD,"#",":               * 2
                             "#"",PMARREQT,"#",":               * 3
                             "#"",PMARREQD,PMARREQT,"#",":      * 4
                             "#"",DESCRTYP,"#",":               * 5
                             "#"",DESCSTAT,"#",":               * 6
                             "#"",DESCRESC,"#",":               * 7
                             "#"",DESCUNIT,"#",":               * 8
                             "#"",DESCPRTY,"#",":               * 9
                             "#"",DESCPPBY,"#",":               * 10
                             "#"",DESCPHOS,"#",":               * 11
                             "#"",PMARPPAD,"#",":               * 12
                             "#"",DESCPROC,"#",":               * 13
                             "#"",PMARPRDT,"#",":               * 14
                             "#"",PMARPROD,"#");"               * 15
.
          GOTO      RTAB1000
.
RTAB9999  RETURN
.
.*******************************************************************************
. Get comments for pmsatcaf type 003 clinical details / other conditions
.*******************************************************************************
GETCMA00  PREP      COMFILAF,COMFILNA
          MOVE      ZERO,COMFAFLG
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCMA10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMA90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMA80 IF NOT EQUAL
.
          IF        F3=999       
            GOTO      GETCMA10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCMA10
.
GETCMA80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMA90  MOVE      F3,COMFAEND
          OPEN      COMFILAF,COMFILNA
GETCMA99  RETURN
.
.*******************************************************************************
. Get comments for pmsatcaf type 004 admission request comments
.*******************************************************************************
GETCMB00  PREP      COMFILBF,COMFILNB
          MOVE      ZERO,COMFBFLG
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETCMB10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMB90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMB80 IF NOT EQUAL
.
          IF        F3=999
            GOTO      GETCMB10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETCMB10
.
GETCMB80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMB90  MOVE      F3,COMFBEND
          OPEN      COMFILBF,COMFILNB
GETCMB99  RETURN
.
.*******************************************************************************
. Get comments for pmsatcaf type 001 admission request pre anaesthtic comments
.*******************************************************************************
GETCMC00  PREP      COMFILCF,COMFILNC
          MOVE      ZERO,COMFCFLG
          MOVE      ONE,F3
          WRITE     COMFILCF,SEQ;QRYDATA
.
GETCMC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMC90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMC80 IF NOT EQUAL
.
          IF        F3=999
            GOTO      GETCMC10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILCF,SEQ;QRYDATA
          GOTO      GETCMC10
.
GETCMC80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMC90  MOVE      F3,COMFCEND
          OPEN      COMFILCF,COMFILNC
GETCMC99  RETURN
.
.
.*******************************************************************************
. Get comments for pmsatcaf type 002 admission request clinical review comments
.*******************************************************************************
GETCME00  PREP      COMFILEF,COMFILNE
          MOVE      ZERO,COMFEFLG
          MOVE      ONE,F3
          WRITE     COMFILEF,SEQ;QRYDATA
.
GETCME10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCME90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCME80 IF NOT EQUAL
.
          IF        F3=999
            GOTO      GETCME10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILEF,SEQ;QRYDATA
          GOTO      GETCME10
.
GETCME80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCME90  MOVE      F3,COMFEEND
          OPEN      COMFILEF,COMFILNE
GETCME99  RETURN
.
.*******************************************************************************
. Get comments for pmsatcaf type 005 admission request other hospital comments
.*******************************************************************************
GETCMD00  PREP      COMFILDF,COMFILND
          MOVE      ZERO,COMFDFLG
          MOVE      ONE,F3
          WRITE     COMFILDF,SEQ;QRYDATA
.
GETCMD10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMD90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMD80 IF NOT EQUAL
.
          IF        F3=999
            GOTO      GETCMD10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILDF,SEQ;QRYDATA
          GOTO      GETCMD10
.
GETCMD80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMD90  MOVE      F3,COMFDEND
          OPEN      COMFILDF,COMFILND
GETCMD99  RETURN
+
.*******************************************************************************
. Get comments for pmsatcaf type 006 admission request Authorisation Approval 
.*******************************************************************************
GETCMF00  PREP      COMFILFF,COMFILNF
          MOVE      ZERO,COMFFFLG
          MOVE      ONE,F3
          WRITE     COMFILFF,SEQ;QRYDATA
.
GETCMF10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMF90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMF80 IF NOT EQUAL
.
          IF        F3=999
            GOTO      GETCMF10 IF EQUAL          * Max 999 lines of comments
          ENDIF                                  * can be saved
.
          ADD       ONE,F3
          WRITE     COMFILFF,SEQ;QRYDATA
          GOTO      GETCMF10
.
GETCMF80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMF90  MOVE      F3,COMFFEND
          OPEN      COMFILFF,COMFILNF
GETCMF99  RETURN
+
.*******************************************************************************
. Save comments for pmsatcaf type 003 clinical details / other conditions
.*******************************************************************************
UPDCMA00  BRANCH    COMFAFLG,UPDCMA90
.
          PACK      KEY19,PMARREQN,ZERO,ZERO,THREE,SP2,ONE,SP70
          CALL      RSPMATC1
UPDCMA10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCMA20
.
          MATCH     PMARREQN,PMATREQN
          GOTO      UPDCMA20 IF NOT EQUAL
.
          MATCH     "003",PMATTYPE
          GOTO      UPDCMA20 IF NOT EQUAL
.
          MATCH     "  1",PMATCNTR
          GOTO      UPDCMA20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCMA10
.
UPDCMA20  COMPARE   ZERO,COMFAEND
          GOTO      UPDCMA99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNA
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCMA99
.
UPDCMA30  READ      COMFILAF,SEQ;COMM127
          GOTO      UPDCMA90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMARREQN,PMATREQN
          MOVE      "003",PMATTYPE
          MOVE      "  1",PMATCNTR
          MOVE      F3,PMATLINE
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFAEND
          GOTO      UPDCMA30 IF NOT EQUAL
.
UPDCMA90  CLOSE     COMFILAF,DELETE
.
UPDCMA99  RETURN
.
.*******************************************************************************
. Save comments for pmsatcaf type 004 Admission request comments          
.*******************************************************************************
UPDCMB00  BRANCH    COMFBFLG,UPDCMB90
.
          PACK      KEY19,PMARREQN,ZERO,ZERO,FOUR,SP2,ONE,SP70
          CALL      RSPMATC1
UPDCMB10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCMB20
.
          MATCH     PMARREQN,PMATREQN
          GOTO      UPDCMB20 IF NOT EQUAL
.
          MATCH     "004",PMATTYPE
          GOTO      UPDCMB20 IF NOT EQUAL
.
          MATCH     "  1",PMATCNTR
          GOTO      UPDCMB20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCMB10
.
UPDCMB20  COMPARE   ZERO,COMFBEND
          GOTO      UPDCMB99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILBF,COMFILNB
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCMB99
.
UPDCMB30  READ      COMFILBF,SEQ;COMM127
          GOTO      UPDCMB90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMARREQN,PMATREQN
          MOVE      "004",PMATTYPE
          MOVE      "  1",PMATCNTR
          MOVE      F3,PMATLINE
.
          IF        F3=1 & F3=COMFBEND
            MATCH     SP70,COMM127
            GOTO      UPDCMB90 IF EQUAL
          ENDIF
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFBEND
          GOTO      UPDCMB30 IF NOT EQUAL
.
UPDCMB90  CLOSE     COMFILBF,DELETE
.
UPDCMB99  RETURN
.
.
.*******************************************************************************
. Save comments for pmsatcaf type 005 Admission request other hospital comments
.*******************************************************************************
UPDCMD00  BRANCH    COMFDFLG,UPDCMD90
.
          PACK      KEY19,PMAVREQN,ZERO,ZERO,FIVE,PMAVCNTR,SP70
          CALL      RSPMATC1
UPDCMD10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCMD20
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      UPDCMD20 IF NOT EQUAL
.
          MATCH     "005",PMATTYPE
          GOTO      UPDCMD20 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      UPDCMD20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCMD10
.
UPDCMD20  COMPARE   ZERO,COMFDEND
          GOTO      UPDCMD99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILDF,COMFILND
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCMD99
.
UPDCMD30  READ      COMFILDF,SEQ;COMM127
          GOTO      UPDCMD90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMAVREQN,PMATREQN
          MOVE      "005",PMATTYPE
          MOVE      PMAVCNTR,PMATCNTR
          MOVE      F3,PMATLINE
.
          IF        F3=1 & F3=COMFDEND
            MATCH     SP70,COMM127
            GOTO      UPDCMD90 IF EQUAL
          ENDIF
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFDEND
          GOTO      UPDCMD30 IF NOT EQUAL
.
UPDCMD90  CLOSE     COMFILDF,DELETE
.
UPDCMD99  RETURN
.
.
.*******************************************************************************
. Save comments for pmsatcaf type 002 Admission request clinical triage comments
.*******************************************************************************
UPDCME00  BRANCH    COMFEFLG,UPDCME90
.
          PACK      KEY19,PMAVREQN,ZERO,ZERO,TWO,PMAVCNTR,SP70
          CALL      RSPMATC1
UPDCME10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCME20
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      UPDCME20 IF NOT EQUAL
.
          MATCH     "002",PMATTYPE
          GOTO      UPDCME20 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      UPDCME20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCME10
.
UPDCME20  COMPARE   ZERO,COMFEEND
          GOTO      UPDCME99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILEF,COMFILNE
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCME99
.
UPDCME30  READ      COMFILEF,SEQ;COMM127
          GOTO      UPDCME90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMAVREQN,PMATREQN
          MOVE      "002",PMATTYPE
          MOVE      PMAVCNTR,PMATCNTR
          MOVE      F3,PMATLINE
.
          IF        F3=1 & F3=COMFEEND
            MATCH     SP70,COMM127
            GOTO      UPDCME90 IF EQUAL
          ENDIF
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFEEND
          GOTO      UPDCME30 IF NOT EQUAL
.
UPDCME90  CLOSE     COMFILEF,DELETE
.
UPDCME99  RETURN
.
.*******************************************************************************
. Save comments for pmsatcaf type 001 Admission request pre anaesthtic comments
.*******************************************************************************
UPDCMC00  BRANCH    COMFCFLG,UPDCMC90
.
          PACK      KEY19,PMAVREQN,ZERO,ZERO,ONE,PMAVCNTR,SP70
          CALL      RSPMATC1
UPDCMC10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCMC20
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      UPDCMC20 IF NOT EQUAL
.
          MATCH     "001",PMATTYPE
          GOTO      UPDCMC20 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      UPDCMC20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCMC10
.
UPDCMC20  COMPARE   ZERO,COMFCEND
          GOTO      UPDCMC99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILCF,COMFILNC
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCMC99
.
UPDCMC30  READ      COMFILCF,SEQ;COMM127
          GOTO      UPDCMC90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMAVREQN,PMATREQN
          MOVE      "001",PMATTYPE
          MOVE      PMAVCNTR,PMATCNTR
          MOVE      F3,PMATLINE
.
          IF        F3=1 & F3=COMFCEND
            MATCH     SP70,COMM127
            GOTO      UPDCMC90 IF EQUAL
          ENDIF
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFCEND
          GOTO      UPDCMC30 IF NOT EQUAL
.
UPDCMC90  CLOSE     COMFILCF,DELETE
.
UPDCMC99  RETURN
.
.*******************************************************************************
. Save comments for pmsatcaf type 006 admission request review - 
. Medical Authorisation Approval
.*******************************************************************************
UPDCMF00  BRANCH    COMFFFLG,UPDCMF90
.
          PACK      KEY19,PMAVREQN,ZERO,ZERO,SIX,PMAVCNTR,SP70
          CALL      RSPMATC1
UPDCMF10  CALL      RKPMATC1
          BRANCH    OVRCD,UPDCMF20
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      UPDCMF20 IF NOT EQUAL
.
          MATCH     "006",PMATTYPE
          GOTO      UPDCMF20 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      UPDCMF20 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
          CALL      RSPMATC1
          GOTO      UPDCMF10
.
UPDCMF20  COMPARE   ZERO,COMFFEND
          GOTO      UPDCMF99 IF EQUAL
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILFF,COMFILNF
          TRAPCLR   IO
          BRANCH    OVRCD,UPDCMF99
.
UPDCMF30  READ      COMFILFF,SEQ;COMM127
          GOTO      UPDCMF90 IF OVER
.
          ADD       ONE,F3
          MOVE      PMAVREQN,PMATREQN
          MOVE      "006",PMATTYPE
          MOVE      PMAVCNTR,PMATCNTR
          MOVE      F3,PMATLINE
.
          IF        F3=1 & F3=COMFFEND
            MATCH     SP70,COMM127
            GOTO      UPDCMF90 IF EQUAL
          ENDIF
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      RDPMATC1
          IF        OVRCD=1
            MOVE      COMM127,PMATDATA
            CALL      WRPMATC1
          ENDIF
.
          COMPARE   F3,COMFFEND
          GOTO      UPDCMF30 IF NOT EQUAL
.
UPDCMF90  CLOSE     COMFILFF,DELETE
.
UPDCMF99  RETURN
.
.*******************************************************************************
. Delete all comments from pmsatcaf when an adm request is deleted
.*******************************************************************************
DELCOM00  PACK      KEY19,PMARREQN,SP70
          CALL      RSPMATC1
          CALL      RKPMATC1
          BRANCH    OVRCD,DELCOM99
.
          MATCH     PMARREQN,PMATREQN
          GOTO      DELCOM99 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
.
          GOTO      DELCOM00
.
DELCOM99  RETURN
.
.*******************************************************************************
. Delete comments by type from pmsatcaf 
.*******************************************************************************
DELCMT00  PACK      KEY19,PMAVREQN,KEY3,PMAVCNTR,SP70
          CALL      RSPMATC1
          CALL      RKPMATC1
          BRANCH    OVRCD,DELCMT99
.
          MATCH     PMAVREQN,PMATREQN
          GOTO      DELCMT99 IF NOT EQUAL
.
          MATCH     KEY3,PMATTYPE
          GOTO      DELCMT99 IF NOT EQUAL
.
          MATCH     PMAVCNTR,PMATCNTR
          GOTO      DELCMT99 IF NOT EQUAL
.
          PACK      KEY19,PMATREQN,PMATTYPE,PMATCNTR,PMATLINE,SP70
          CALL      DEPMATC1
.
          GOTO      DELCMT00
.
DELCMT99  RETURN
.
.*******************************************************************************
. Delete all details from pmsamnaf when an adm request is deleted
.*******************************************************************************
DELPMA00  PACK      KEY15,PMARREQN,SP70
          CALL      RSPMAMN1
          CALL      RKPMAMN1
          BRANCH    OVRCD,DELPMA99
.
          MATCH     PMARREQN,PMAMREQN
          GOTO      DELPMA99 IF NOT EQUAL
.
          PACK      KEY15,PMAMREQN,PMAMCATG,PMAMCODE,SP70
          CALL      DEPMAMN1
.
          GOTO      DELPMA00
.
DELPMA99  RETURN
.
.
.*******************************************************************************
. Delete all details from pmsarvaf when an adm request is deleted
.*******************************************************************************
DELREV00  PACK      KEY16,PMARREQN,SP70
          CALL      RSPMARV1
          CALL      RKPMARV1
          BRANCH    OVRCD,DELREV99
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      DELREV99 IF NOT EQUAL
.
          PACK      KEY16,PMAVREQN,PMAVRTYP,PMAVCNTR,SP70
          CALL      DEPMARV1
.
          GOTO      DELREV00
.
DELREV99  RETURN
.
.------------------------------------------------------------
. Hospital Level Admission Request Lists
.------------------------------------------------------------
HLST0000  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "Admission Request Lists",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,HLST9999
.
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      HLST9999
.
HLST9999  RETURN
.
.
.*******************************************************************************
.                          Next Day, Week, Month
.*******************************************************************************
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",FILTREQT
          REP       " +",FILTHOSP
          REP       " +",FILTUNIT
          REP       " +",FILTPRTY
          REP       " +",FILTPPBY
          REP       " +",FILTRESC
          REP       " +",FILTSTAT
          REP       " +",FILTPARC
          REP       " +",FILTCLTR
          REP       " +",FILTTURN
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb15.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtreqt=",FILTREQT:
                             "&filthosp=",FILTHOSP:
                             "&filtunit=",FILTUNIT:
                             "&filtprty=",FILTPRTY:
                             "&filtppby=",FILTPPBY:
                             "&filtresc=",FILTRESC:
                             "&showflag=",SHOWFLAG:
                             "&filtstat=",FILTSTAT:
                             "&deftview=",DEFTVIEW:
                             "&returnfl=",RETURNFL:
                             "&filtparc=",FILTPARC:
                             "&filtcltr=",FILTCLTR:
                             "&filtturn=",FILTTURN:
                             "&alldates=",ALLDATES:
                             "&showproc=",SHOWPROC;
.
          REP       "+ ",FILTREQT
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTUNIT
          REP       "+ ",FILTPRTY
          REP       "+ ",FILTPPBY
          REP       "+ ",FILTRESC
          REP       "+ ",FILTSTAT
          REP       "+ ",FILTPARC
          REP       "+ ",FILTCLTR
          REP       "+ ",FILTTURN
.
NEXT9999  RETURN
.*******************************************************************************
.                          Previous Day, Week, Month
.*******************************************************************************
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          REP       " +",FILTREQT
          REP       " +",FILTHOSP
          REP       " +",FILTUNIT
          REP       " +",FILTPRTY
          REP       " +",FILTPPBY
          REP       " +",FILTRESC
          REP       " +",FILTSTAT
          REP       " +",FILTPARC
          REP       " +",FILTCLTR
          REP       " +",FILTTURN
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb15.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtreqt=",FILTREQT:
                             "&filthosp=",FILTHOSP:
                             "&filtunit=",FILTUNIT:
                             "&filtprty=",FILTPRTY:
                             "&filtppby=",FILTPPBY:
                             "&filtresc=",FILTRESC:
                             "&showflag=",SHOWFLAG:
                             "&filtstat=",FILTSTAT:
                             "&deftview=",DEFTVIEW:
                             "&returnfl=",RETURNFL:
                             "&filtparc=",FILTPARC:
                             "&filtcltr=",FILTCLTR:
                             "&filtturn=",FILTTURN:
                             "&alldates=",ALLDATES:
                             "&showproc=",SHOWPROC;
.
          REP       "+ ",FILTREQT
          REP       "+ ",FILTHOSP
          REP       "+ ",FILTUNIT
          REP       "+ ",FILTPRTY
          REP       "+ ",FILTPPBY
          REP       "+ ",FILTRESC
          REP       "+ ",FILTSTAT
          REP       "+ ",FILTPARC
          REP       "+ ",FILTCLTR
          REP       "+ ",FILTTURN
.
PREV9999  RETURN
.
.------------------------------------------------------------
. Hospital Level Admission Request List
.------------------------------------------------------------
HRTB0000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LOOPCNTR
.
          IF        ALLDATES=1
            MATCH     SP70,FILTHOSP
            GOTO      HRTB9999 IF EQUAL
.
            MATCH     SP70,FILTUNIT
            GOTO      HRTB9999 IF EQUAL
.
            PACK      KEY33,FILTHOSP,FILTUNIT,SP70
            CALL      RSPMARQ5
          ELSE
            PACK      KEY29,FILTHOSP,FRSTDATE,SP70
            CALL      RSPMARQ3
          ENDIF
.
HRTB1000  IF        ALLDATES=1
            CALL      RKPMARQ5
            BRANCH    OVRCD,HRTB9999
.
            MATCH     FILTHOSP,PMARIHOS
            GOTO      HRTB9999 IF NOT EQUAL
.
            MATCH     FILTUNIT,PMARUNIT
            GOTO      HRTB9999 IF NOT EQUAL

          ELSE 
            CALL      RKPMARQ3
            BRANCH    OVRCD,HRTB9999
.
            MATCH     FILTHOSP,PMARIHOS
            GOTO      HRTB9999 IF NOT EQUAL
.
            MATCH     PMARREQD,LASTDATE
            GOTO      HRTB9999 IF LESS
          ENDIF
.
          ADD       ONE,LOOPCNTR
.
.  Write record number in a comment to keep apache listening if no matching
.  clinics are found per 4,000 records
.
          IF        (LOOPCNTR = 4000)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          MATCH     SP70,FILTREQT
          IF        !@EQUAL
            MATCH     FILTREQT,PMARRTYP
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTUNIT
          IF        !@EQUAL
            MATCH     FILTUNIT,PMARUNIT
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPRTY
          IF        !@EQUAL
            MATCH     FILTPRTY,PMARPRTY
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPARC
          IF        !@EQUAL
            MATCH     FILTPARC,PMARPARC
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLTR
          IF        !@EQUAL
            MATCH     FILTCLTR,PMARCLTR
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPPBY
          IF        !@EQUAL
            MATCH     FILTPPBY,PMARPPBY
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRESC
          IF        !@EQUAL
            MATCH     FILTRESC,PMARRESC
            GOTO      HRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     "1",FILTSTAT
            IF        @EQUAL
               MATCH     "1",PMARSTAT
               IF        !@EQUAL
                 MATCH     "3",PMARSTAT               * Include returned to 
                 GOTO      HRTB1000 IF NOT EQUAL      * clinician with draft
               ENDIF
            ELSE
              MATCH     FILTSTAT,PMARSTAT
              GOTO      HRTB1000 IF NOT EQUAL
            ENDIF
          ELSE
            IF        SHOWPROC=0 
              MATCH     "4",PMARSTAT        * Show proccessed and removed = No
              GOTO      HRTB1000 IF EQUAL   * Skip if status is processed 
.
              MATCH     "5",PMARSTAT        * Skip if status is removed
              GOTO      HRTB1000 IF EQUAL    
            ENDIF
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
          CALL      HRRW0000                          * Hosp Level Request row
          GOTO      HRTB1000
.
HRTB9999  RETURN
.
.------------------------------------------------------------
. Hospital Level Admission Request List Row
.------------------------------------------------------------
HRRW0000  PACK      KEY8,PMARURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,HRRW9999
.
          MATCH     "1",FILTTURN                 * Temp U/R filter
          IF        @EQUAL
            COMPARE   FOUR,PSTAT
            GOTO      HRRW9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,PMARURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,HRRW9999
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FLDRTYPE
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdRequest02('",HTMLLINK
          APPEND    PMARREQN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMARVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK

.
          MOVE      SP70,DESCRTYP
          MOVE      ZERO,F1
          MOVE      PMARRTYP,F1
          LOAD      DESCRTYP,F1,DISRTYP1,DISRTYP2,DISRTYP3
.
          MOVE      SP70,DESCSTAT
          MOVE      ZERO,F1
          MOVE      PMARSTAT,F1
          LOAD      DESCSTAT,F1,DISSTAT1,DISSTAT2,DISSTAT3,DISSTAT4:
                                DISSTAT5,DISSTAT6,DISSTAT7,DISSTAT8
.
          PACK      KEY10,PMARRESC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      PMHCTITL,FMTTITLE            * I CAR 13038
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
          MOVE      DOCFNAME,DESCRESC
.
          MOVE      "WU",CATEGORY
          MOVE      PMARUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCUNIT
.
          MOVE      "ye",CATEGORY
          MOVE      PMARPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPRTY
.
          MOVE      "yh",CATEGORY
          MOVE      PMARPPBY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPPBY
.
          MOVE      SP70,DESCPHOS
          PACK      KEY3,PMARPHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            MOVE      PTHSNAME,DESCPHOS
          ENDIF
.
          MOVE      SP70,DESCPROC
          PACK      KEY9,PMARPROC,SP70
          CALL      RDPROA1
          IF        OVRCD<>1
            MOVE      WPDESC,DESCPROC
          ENDIF
.
          MOVE      ZERO,F8                 * Days since referral date
          DAYSEP    PMARREQD,CURRDATE,F8
.
          CALL      CMTHOV00      * Get js code for Proc Desc Comments hover
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",PMARREQN,"#",":               * 1
                             "#"",PMARREQD,"#",":               * 2
                             "#"",PMARREQT,"#",":               * 3
                             "#"",PMARREQD,PMARREQT,"#",":      * 4
                             "#"",DESCRTYP,"#",":               * 5
                             "#"",DESCSTAT,"#",":               * 6
                             "#"",DESCRESC,"#",":               * 7
                             "#"",DESCUNIT,"#",":               * 8
                             "#"",DESCPRTY,"#",":               * 9
                             "#"",DESCPPBY,"#",":               * 10
                             "#"",DESCPHOS,"#",":               * 11
                             "#"",PMARPPAD,"#",":               * 12
                             "#"",DESCPROC,"#",":               * 13
                             "#"",PMARPRDT,"#",":               * 14
                             "#"",FLDRTYPE,"#",":               * 15
                             "#"",FORMATNM,"#",":               * 16
                             "#"",F8,"#",":                     * 17
                             "#"",PMARPROD,"#",":               * 18
                             "#"",*+,HOVERSTR,*-,"#");"         * 19
.
HRRW9999  RETURN
+
.------------------------------------------------------------------------------
.         Get javascript string for Procedure Description Comments hover action
.         
.         PARAMETERS:
.           PMARPROD - Procedure Description Comments
.
.         RETURNS:
.           HOVERSTR - Javascript string for HoverData()
.------------------------------------------------------------------------------
CMTHOV00  MOVE      PMARPROD,SRCESTRN
          CALL      ESCQUT00           * Escape single-quotes
          STRIP     DESTSTRN
.
          CLEAR     HOVERSTR
          APPEND    "\#"javascript:HoverData('",HOVERSTR
          APPEND    DESTSTRN,HOVERSTR
          APPEND    "');\#"",HOVERSTR
          RESET     HOVERSTR
.
CMTHOV99  RETURN
+
.------------------------------------------------------------------------------
.         Takes a Source string and produces a Destination string (3x size)
.         with js escaped single-quotes; i.e. "\\'" instead of "'"
.
.         PARAMETERS:
.           SRCESTRN - Source string
.
.         RETURNS:
.           DESTSTRN - Destination string (with escaped single quotes; "\\'")
.------------------------------------------------------------------------------
ESCQUT00  STRIP     SRCESTRN
          MOVE      ZERO,CHRCOUNT
          MOVELPTR  SRCESTRN,CHRCOUNT
.
          COMPARE   ZERO,CHRCOUNT      * Bail if zero-length source string
          GOTO      ESCQUT99 IF EQUAL
.
          PACK      DESTSTRN,SP70,SP70,SP70
          RESET     SRCESTRN
          RESET     DESTSTRN
.
          MOVE      ONE,LOOPCNTR
          WHILE     LOOPCNTR <= CHRCOUNT
            CMATCH    "'",SRCESTRN          * Single quote? replace with "\\'"
            IF        @EQUAL
              CMOVE     "\",DESTSTRN
              BUMP      DESTSTRN
              CMOVE     "\",DESTSTRN
              BUMP      DESTSTRN
              CMOVE     "'",DESTSTRN
              BUMP      DESTSTRN
            ELSE
              CMOVE     SRCESTRN,DESTSTRN   * just copy char
              BUMP      DESTSTRN
            ENDIF
.
            BUMP      SRCESTRN
            ADD       ONE,LOOPCNTR
          DO
.
          RESET     SRCESTRN
.
          MOVEFPTR  DESTSTRN,F2
          SUB       ONE,F2
          SETLPTR   DESTSTRN,F2
          RESET     DESTSTRN
.
ESCQUT99  RETURN
+
.----------------------------------------------------------------------
. Hospital Level Admission Request List By Intended Hospital and Status
.----------------------------------------------------------------------
SRTB0000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY30,FILTHOSP,FILTSTAT,SP70
          CALL      RSPMARQ4
SRTB1000  CALL      RKPMARQ4
          BRANCH    OVRCD,SRTB9999
.
          MATCH     FILTHOSP,PMARIHOS
          GOTO      SRTB9999 IF NOT EQUAL
.
          MATCH     FILTSTAT,PMARSTAT
          GOTO      SRTB9999 IF NOT EQUAL
.
          MATCH     SP70,FILTUNIT
          IF        !@EQUAL
            MATCH     FILTUNIT,PMARUNIT
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPRTY
          IF        !@EQUAL
            MATCH     FILTPRTY,PMARPRTY
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPARC
          IF        !@EQUAL
            MATCH     FILTPARC,PMARPARC
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLTR
          IF        !@EQUAL
            MATCH     FILTCLTR,PMARCLTR
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPPBY
          IF        !@EQUAL
            MATCH     FILTPPBY,PMARPPBY
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRESC
          IF        !@EQUAL
            MATCH     FILTRESC,PMARRESC
            GOTO      SRTB1000 IF NOT EQUAL
          ENDIF
.
          CALL      HRRW0000                          * Hosp Level Request row
          GOTO      SRTB1000
.
SRTB9999  RETURN
.
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
.
.------------------------------------------------------------
. Map WL priority TP to cat ye HDP
.------------------------------------------------------------
PMAP0000  PACK      KEY5,CATYE,SP70
          CALL      RDSCODE1
PMAP1000  CALL      RDKCODE1
          BRANCH    OVRCD,PMAP9999
.
          MATCH     CATYE,TCODE
          GOTO      PMAP9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      PMAP1000 IF EQUAL
.
          MATCH     CATECODE,THCSCOD
          GOTO      PMAP1000 IF NOT EQUAL
.
          MOVE      ACODE,FILTPRTY
.
PMAP9999  RETURN
.
.------------------------------------------------------------
. Patient Level Admission Requests Reviews
.------------------------------------------------------------
REVW0000  MATCH     SP70,UPDTTYPE
          GOTO      REVW8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE                 * Add
          GOTO      REVW1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE                 * Update
          GOTO      REVW2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE                 * Delete
          GOTO      REVW3000 IF EQUAL
.
          MATCH     "C",UPDTTYPE                 * Add Med Auth Approval review
          GOTO      REVW4000 IF EQUAL
.
          GOTO      REVW9000
.
REVW1000  PACK      KEY10,PMARV001,SP70           * Read admission request
          CALL      RDPMARQ1
          BRANCH    OVRCD,REVW9300
.
          MOVE      ZERO,F3
          PACK      KEY16,PMARV001,PMARV002,Z70
          CALL      RSPMARV1
          CALL      RPPMARV1
          BRANCH    OVRCD,REVW1100
.
          MATCH     PMARV001,PMAVREQN
          GOTO      REVW1100 IF NOT EQUAL
.
          MATCH     PMARV002,PMAVRTYP
          GOTO      REVW1100 IF NOT EQUAL
.
          MOVE      PMAVCNTR,F3
.
REVW1100  ADD       ONE,F3
          MOVE      F3,PMARV003
          CALL      CLPMSARV
          CALL      MVPMAV00
.
          PACK      PMAVCDAT,CCC,CYY,CMM,CDD      * Set created by fields
          REP       " 0",PMAVCDAT
          CLOCK     TIME,PMAVCTIM
          MOVE      USERID,PMAVCUID
.
          PACK      KEY16,PMAVREQN,PMAVRTYP,PMAVCNTR,SP70
          CALL      RAPMARV1
          IF        OVRCD=1
            CALL      WRPMARV1                      * Write new request
          ELSE
            GOTO      REVW1000
          ENDIF
.
          CALL      UPDCMC00                      * Update Comments
          CALL      UPDCMD00                      * Update Comments
          CALL      UPDCME00                      * Update Comments
.
          CALL      REVU0000                      * Update Adm Request
.
          MOVE      ZERO,EXIT
          GOTO      REVW9999
.
REVW2000  PACK      KEY10,PMARV001,SP70           * Read admission request
          CALL      RDPMARQ1
          BRANCH    OVRCD,REVW9300
.
          PACK      KEY16,PMARV001,PMARV002,PMARV003,SP70           * Update
          CALL      RDPMARV1
          BRANCH    OVRCD,REVW9200
.
          CALL      MVPMAV00
.
          PACK      PMAVUDAT,CCC,CYY,CMM,CDD      * Set updated by fields
          REP       " 0",PMAVUDAT
          CLOCK     TIME,PMAVUTIM
          MOVE      USERID,PMAVUUID
.
          CALL      UPPMARV1                      * Update Request
.
          CALL      UPDCMC00                      * Update Comments
          CALL      UPDCMD00                      * Update Comments
          CALL      UPDCME00                      * Update Comments
.
          CALL      REVU0000                      * Update Adm Request
.
          MOVE      ZERO,EXIT
          GOTO      REVW9999
.
REVW3000  PACK      KEY10,PMARV001,SP70           * Read admission request
          CALL      RDPMARQ1
          BRANCH    OVRCD,REVW9300
.
          PACK      KEY16,PMARV001,PMARV002,PMARV003,SP70           * Delete
          CALL      RDPMARV1
          BRANCH    OVRCD,REVW9200
.
          CALL      DEPMARV1
.
          MOVE      "001",KEY3                   * Pre Anaesthetic
          CALL      DELCMT00                     * Delete comments
.
          MOVE      "005",KEY3                   * Pre Anaesthetic
          CALL      DELCMT00                     * Delete comments
.
          CALL      REVU0000                     * Update Adm Request
.
          MOVE      ZERO,EXIT
          GOTO      REVW9999
.
REVW4000  PACK      KEY10,PMARV001,SP70     * Read admission request
          CALL      RDPMARQ1
          BRANCH    OVRCD,REVW9300
.
          CALL      ADDMAA00                * Add Adm Request Review (type 003)
.
          MATCH     "D",SUBMTFLG            * Draft
          IF        @EQUAL
            MOVE      ONE,PMARSTAT          * Set request status to 'Draft'
            MOVE      ONE,PMARMAPR          * Approved
          ENDIF
.
          MATCH     "S",SUBMTFLG            * Submitted
          IF        @EQUAL
            MOVE      TWO,PMARSTAT          * Set request status to 'Submitted'
            MOVE      TWO,PMARMAPR          * Approved Required
          ENDIF
.
          MOVE      "Ma",CATEGORY
          MOVE      PMAVRSTA,CODE
          CALL      GETCOD00
          MATCH     "D",TCINDC1
          IF        @EQUAL
            MOVE      EIGHT,PMARSTAT        * Set Request Status to 'Denied'
            MOVE      THREE,PMARMAPR        * Approval Denied
          ELSE
            MATCH     "P",TCINDC1
            IF        @EQUAL
              MOVE      SEVEN,PMARSTAT      * Set Request Status to 'Denied'
              MOVE      "X",PMARMAPR        * Pending 
            ENDIF
          ENDIF
.
          PACK      PMARUDAT,CCC,CYY,CMM,CDD     * Set adm req updated by fields
          REP       " 0",PMARUDAT
          CLOCK     TIME,PMARUTIM
          MOVE      USERID,PMARUUID
.
          CALL      UPPMARQ1                * Update Adm Request
          CALL      UPDCMF00                * Update Comments (type 006)
.
          MOVE      ZERO,EXIT
          GOTO      REVW9999
.
REVW8000  MOVE      URNUMBER,KEY8                * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,REVW9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21                     * Read Pmi Extn
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY10,PMARV001,SP70
          CALL      RDPMARQ1                     * Read Adm Request
          IF        OVRCD=1
            CALL      CLPMSARQ
          ENDIF
.
          PACK      KEY16,PMARV001,PMARV002,PMARV003,SP70  * Read Review
          CALL      RDPMARV1
          IF        OVRCD=1
            CALL      CLPMSARV
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Admission Requests Reviews",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,REVW9999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      REVW9999
.
REVW9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REVW9999
.
REVW9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REVW9999
.
REVW9200  MOVE      "Invalid Admission Request Review. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REVW9999
.
REVW9300  MOVE      "Invalid Admission Request. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REVW9999
.
REVW9999  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          CLOSE     COMFILCF,DELETE
          CLOSE     COMFILDF,DELETE
          CLOSE     COMFILEF,DELETE
          CLOSE     COMFILFF,DELETE
          RETURN
+
.------------------------------------------------------------------------------
. Add Admission Request Review record for 'Medical Authorisation Approval'
. (Type 003)
.------------------------------------------------------------------------------
ADDMAA00  MOVE      ZERO,F3
          MOVE      PMARREQN,PMARV001
          MOVE      "003",PMARV002
.
          PACK      KEY16,PMARV001,PMARV002,Z70
          CALL      RSPMARV1
          CALL      RPPMARV1
          BRANCH    OVRCD,ADDMAA11
.
          MATCH     PMARV001,PMAVREQN
          GOTO      ADDMAA11 IF NOT EQUAL
.
          MATCH     PMARV002,PMAVRTYP
          GOTO      ADDMAA11 IF NOT EQUAL
.
          MOVE      PMAVCNTR,F3
.
ADDMAA11  ADD       ONE,F3
          MOVE      F3,PMARV003
.
          CALL      CLPMSARV
          CALL      MVPMAV00
.
          MOVE      PMARURNO,PMAVURNO
          MOVE      PMARVISN,PMAVVISN
.
          PACK      PMAVCDAT,CCC,CYY,CMM,CDD      * Set created by fields
          REP       " 0",PMAVCDAT
          CLOCK     TIME,PMAVCTIM
          MOVE      SECUREID,PMAVCUID             * User ID entered on screen
.
          PACK      KEY16,PMAVREQN,PMAVRTYP,PMAVCNTR,SP70
          CALL      RAPMARV1
          IF        OVRCD=1
            CALL      WRPMARV1              * Write new request review details
          ENDIF
.
ADDMAA99  RETURN
.
.------------------------------------------------------------
. Update Adm request pre anaesthetic review and clinical
. triage values from the last review record
.------------------------------------------------------------
REVU0000  PACK      KEY10,PMARV001,SP70
          CALL      RDPMARQ1                     * Read Adm Request
          BRANCH    OVRCD,REVU9999
.
          MATCH     "001",PMARV002               * Pre Anaesthetic Review
          GOTO      REVU1000 IF EQUAL
.
          MATCH     "002",PMARV002               * Clinical Triage
          GOTO      REVU5000 IF EQUAL
.
          GOTO      REVU9999
.
REVU1000  MOVE      SP70,UPDTPARC                * Clear pre anaesthetic review
          MOVE      SP70,UPDTBTYP                * Clear type of bed required 
.
          PACK      KEY32,PMARV001,Z70
          CALL      RSPMARV2                     * Read the last review record
REVU2000  CALL      RPPMARV2
          BRANCH    OVRCD,REVU3000
.
          MATCH     PMARV001,PMAVREQN
          GOTO      REVU3000 IF NOT EQUAL
.
          MATCH     "001",PMAVRTYP
          GOTO      REVU2000 IF NOT EQUAL
.
          MOVE      PMAVRSTA,UPDTPARC            * New pre anaesthetic review
          MOVE      PMAVBTYP,UPDTBTYP            * New type of bed required
.
REVU3000  MATCH     SP70,UPDTBTYP                * Any new type of bed required
          GOTO      REVU4000 IF EQUAL
.
          MATCH     SP70,PMARBTYP                * Any type of bed on adm req
          GOTO      REVU4000 IF EQUAL
.
          MATCH     PMARBTYP,UPDTBTYP
          IF        !@EQUAL
            MOVE      SIX,PMARSTAT               * Set status to review as
          ENDIF                              
.
REVU4000  MOVE      UPDTPARC,PMARPARC
          CALL      UPPMARQ1
          GOTO      REVU9999
.
REVU5000  MOVE      SP70,UPDTCLTR                * Clear clinical triage
.
          PACK      KEY32,PMARV001,Z70
          CALL      RSPMARV2                     * Read the last review record
REVU6000  CALL      RPPMARV2
          BRANCH    OVRCD,REVU7000
.
          MATCH     PMARV001,PMAVREQN
          GOTO      REVU7000 IF NOT EQUAL
.
          MATCH     "002",PMAVRTYP
          GOTO      REVU6000 IF NOT EQUAL
.
          MOVE      PMAVRSTA,UPDTCLTR            * New clinical triage
.
REVU7000  MOVE      UPDTCLTR,PMARCLTR
          CALL      UPPMARQ1
          GOTO      REVU9999
.
REVU9999  RETURN
.
.------------------------------------------------------------
. Patient Level Admission Requests Anaesthetic Review List
.------------------------------------------------------------
ARTB0000  PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
ARTB1000  CALL      RPPMARV2 
          BRANCH    OVRCD,ARTB9000
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      ARTB9000 IF NOT EQUAL
.
          MATCH     "001",PMAVRTYP
          GOTO      ARTB1000 IF NOT EQUAL
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PMAVDATR
          IF        !@EQUAL
            UNPACK    PMAVDATR,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "yj",CATEGORY
          MOVE      PMAVBTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCBTYP
.
          MOVE      SP70,DESCHOSP
          PACK      KEY3,PMAVHOSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            MOVE      PTHSNAME,DESCHOSP
          ENDIF
.
          MOVE      "ym",CATEGORY
          MOVE      PMAVRSTA,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCRSTA
.
          MOVE      SP70,DESCCOM1
          PACK      KEY19,PMAVREQN,ZERO,ZERO,FIVE,PMAVCNTR,SP2,ONE
          CALL      RDPMATC1
          IF        OVRCD<>1
            MOVE      PMATDATA,DESCCOM1
          ENDIF
.
          MOVE      SP70,DESCCOM2
          PACK      KEY19,PMAVREQN,ZERO,ZERO,ONE,PMAVCNTR,SP2,ONE
          CALL      RDPMATC1
          IF        OVRCD<>1
            MOVE      PMATDATA,DESCCOM2
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>":
                             "<A HREF=#"":
                             "javascript:UpdateReview03('",PMAVREQN:
                           "','",PMAVRTYP,"','",PMAVCNTR,"','",PMAVURNO,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DISPDAT1," at ",PMAVTIMR,"</td>":
                             "<td>",DESCBTYP,"</td>":
                             "<td>",DESCHOSP,"</td>":
                             "<td>",DESCCOM1,"</td>":
                             "<td>",PMAVASAS,"</td>":
                             "<td>",DESCRSTA,"</td>":
                             "<td>",DESCCOM2,"</td>":
                             "</tr>"
          
          GOTO      ARTB1000
.
ARTB9000  CALL      CLPMSARV
.
ARTB9999  RETURN
.
.------------------------------------------------------------
. Patient Level Admission Requests Clincal/Triage Review List
.------------------------------------------------------------
CTTB0000  PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
CTTB1000  CALL      RPPMARV2
          BRANCH    OVRCD,CTTB9000
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      CTTB9000 IF NOT EQUAL
.
          MATCH     "002",PMAVRTYP
          GOTO      CTTB1000 IF NOT EQUAL
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PMAVDATR
          IF        !@EQUAL
            UNPACK    PMAVDATR,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "yl",CATEGORY
          MOVE      PMAVRSTA,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCRSTA
.
          MOVE      SP70,DISPDAT2
          MATCH     SP70,PMAVRSED
          IF        !@EQUAL
            UNPACK    PMAVRSED,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DESCCOM1
          PACK      KEY19,PMAVREQN,ZERO,ZERO,TWO,PMAVCNTR,SP2,ONE
          CALL      RDPMATC1
          IF        OVRCD<>1
            MOVE      PMATDATA,DESCCOM1
          ENDIF
.
          MOVE     SP70,DESCUUID
          MATCH    SP70,PMAVUUID
          IF       !@EQUAL
            PACK     KEY10,PMAVUUID,SP70
            CALL     RDWBSE1
            IF       OVRCD=1
              MOVE     PMAVUUID,WBSENAM
            ENDIF
            MOVE     WBSENAM,DESCUUID
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>":
                             "<A HREF=#"":
                             "javascript:UpdateReview03('",PMAVREQN:
                           "','",PMAVRTYP,"','",PMAVCNTR,"','",PMAVURNO,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DISPDAT1," at ",PMAVTIMR,"</td>":
                             "<td>",DESCRSTA,"</td>":
                             "<td>",DESCCOM1,"</td>":
                             "<td>",DISPDAT2,"</td>":
                             "<td>",DESCUUID,"</td>":
                             "</tr>"

          GOTO      CTTB1000
.
CTTB9000  CALL      CLPMSARV
.
CTTB9999  RETURN
+
.------------------------------------------------------------------------------
. Patient Level Admission Request Medical Authorisation Approval Review List
.------------------------------------------------------------------------------
MAATAB00  PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
MAATAB10  CALL      RPPMARV2 
          BRANCH    OVRCD,MAATAB90
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      MAATAB90 IF NOT EQUAL
.
          MATCH     "003",PMAVRTYP
          GOTO      MAATAB10 IF NOT EQUAL
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PMAVDATR
          IF        !@EQUAL
            UNPACK    PMAVDATR,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Ma",CATEGORY
          MOVE      PMAVRSTA,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCRSTA
.
          MOVE      SP70,DESCCOM1
          MOVE      ONE,LINECNT2
MAATAB20  MOVE      LINECNT2,LINECNT1
          RJUSTIFY  LINECNT1
          MOVE      LINECNT1,LINECNT2
          PACK      KEY19,PMAVREQN,ZERO,ZERO,SIX,PMAVCNTR,LINECNT2
          CALL      RDPMATC1
          IF        OVRCD = ONE
            IF        LINECNT2 = ONE
              GOTO    MAATAB70
            ELSE
              GOTO    MAATAB10
            ENDIF
          ENDIF
. 
          MOVE      PMATDATA,DESCCOM1
.
          MOVE     SP70,DESCUUID
          MATCH    SP70,PMAVCUID
          IF       !@EQUAL
            PACK     KEY10,PMAVCUID,SP70
            CALL     RDWBSE1
            IF       OVRCD=1
              MOVE     PMAVCUID,WBSENAM
            ENDIF
            MOVE     WBSENAM,DESCUUID
          ENDIF
.
MAATAB70  IF        LINECNT2=1
            WRITE     HTMLFILE;"<tr>":
                               "<td>",DISPDAT1," at ",PMAVTIMR,"</td>":
                               "<td>",DESCRSTA,"</td>":
                               "<td>",DESCCOM1,"</td>":
                               "<td>",DESCUUID,"</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr>":
                               "<td>"," ","</td>":
                               "<td>"," ","</td>":
                               "<td>",DESCCOM1,"</td>":
                               "<td>"," ","</td>":
                               "</tr>"
          ENDIF
.          
          ADD       ONE,LINECNT2
          GOTO      MAATAB20
.
MAATAB90  CALL      CLPMSARV
.
MAATAB99  RETURN
+
.------------------------------------------------------------------------------
. Get latest medical rquest review status
.------------------------------------------------------------------------------
RQRVST00  PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
RQRVST10  CALL      RPPMARV2
          BRANCH    OVRCD,RQRVST99
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      RQRVST99 IF NOT EQUAL
.
          MATCH     "003",PMAVRTYP
          GOTO      RQRVST10 IF NOT EQUAL
.
          MOVE      "Ma",CATEGORY
          MOVE      PMAVRSTA,CODE
          CALL      GETCOD00
          MATCH     SP70,TCINDC1
          GOTO      RQRVST99 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMAVRSTA;          
.
RQRVST99  RETURN
.
.------------------------------------------------------------
. Hospital Level Admission Request Review List
.------------------------------------------------------------
HRVT0000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      ZERO,LOOPCNTR
.
          IF        ALLDATES=1
            MATCH     SP70,FILTHOSP
            GOTO      HRVT9999 IF EQUAL
.
            MATCH     SP70,FILTUNIT
            GOTO      HRVT9999 IF EQUAL
.
            PACK      KEY33,FILTHOSP,FILTUNIT,SP70
            CALL      RSPMARQ5
          ELSE
            PACK      KEY29,FILTHOSP,FRSTDATE,SP70
            CALL      RSPMARQ3
          ENDIF
.
HRVT1000  IF        ALLDATES=1
            CALL      RKPMARQ5
            BRANCH    OVRCD,HRVT9999
.
            MATCH     FILTHOSP,PMARIHOS
            GOTO      HRVT9999 IF NOT EQUAL
.
            MATCH     FILTUNIT,PMARUNIT
            GOTO      HRVT9999 IF NOT EQUAL
          ELSE
            CALL      RKPMARQ3
            BRANCH    OVRCD,HRVT9999
.
            MATCH     FILTHOSP,PMARIHOS
            GOTO      HRVT9999 IF NOT EQUAL
.
            MATCH     PMARREQD,LASTDATE
            GOTO      HRVT9999 IF LESS
          ENDIF
.
          ADD       ONE,LOOPCNTR
.
.  Write record number in a comment to keep apache listening if no matching
.  clinics are found per 4,000 records
.
          IF        (LOOPCNTR = 4000)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          MATCH     "1",PMARRTYP                 * Elective WL only
          GOTO      HRVT1000 IF NOT EQUAL
.
          MATCH     SP70,FILTUNIT
          IF        !@EQUAL
            MATCH     FILTUNIT,PMARUNIT
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPRTY
          IF        !@EQUAL
            MATCH     FILTPRTY,PMARPRTY
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPARC
          IF        !@EQUAL
            MATCH     FILTPARC,PMARPARC
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLTR
          IF        !@EQUAL
            MATCH     FILTCLTR,PMARCLTR
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPPBY
          IF        !@EQUAL
            MATCH     FILTPPBY,PMARPPBY
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTRESC
          IF        !@EQUAL
            MATCH     FILTRESC,PMARRESC
            GOTO      HRVT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     "1",FILTSTAT
            IF        @EQUAL
               MATCH     "1",PMARSTAT
               IF        !@EQUAL
                 MATCH     "3",PMARSTAT               * Include returned to
                 GOTO      HRVT1000 IF NOT EQUAL      * clinician with draft
               ENDIF
            ELSE
              MATCH     FILTSTAT,PMARSTAT
              GOTO      HRVT1000 IF NOT EQUAL
            ENDIF
          ELSE
            IF        SHOWPROC=0 
              MATCH     "4",PMARSTAT        * Show proccessed and removed = No
              GOTO      HRVT1000 IF EQUAL   * Skip if status is processed
.
              MATCH     "5",PMARSTAT        * Skip if status is removed
              GOTO      HRVT1000 IF EQUAL
            ENDIF
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
          CALL      HRVR0000                          * Hosp Level Request row
          GOTO      HRVT1000
.
HRVT9999  RETURN
.
.------------------------------------------------------------
. Hospital Level Admission Request Review List Row
.------------------------------------------------------------
HRVR0000  PACK      KEY8,PMARURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,HRVR9999
.
          MATCH     "1",FILTTURN                 * Temp U/R filter
          IF        @EQUAL
            COMPARE   FOUR,PSTAT
            GOTO      HRVR9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,PMARURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,HRVR9999
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000
          CALL      PATFLD00                * Set Patient Folder suffix
          MOVE      KEY3,FLDRTYPE
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdRequest02('",HTMLLINK
          APPEND    PMARREQN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMARVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK

.
          MOVE      SP70,DESCRTYP
          MOVE      ZERO,F1
          MOVE      PMARRTYP,F1
          LOAD      DESCRTYP,F1,DISRTYP1,DISRTYP2,DISRTYP3
.
          MOVE      SP70,DESCSTAT
          MOVE      ZERO,F1
          MOVE      PMARSTAT,F1
          LOAD      DESCSTAT,F1,DISSTAT1,DISSTAT2,DISSTAT3,DISSTAT4:
                                DISSTAT5,DISSTAT6,DISSTAT7,DISSTAT8
.
          PACK      KEY10,PMARRESC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      PMHCTITL,FMTTITLE            * I CAR 13038
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
          MOVE      DOCFNAME,DESCRESC
.
          MOVE      "WU",CATEGORY
          MOVE      PMARUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCUNIT
.
          MOVE      "ye",CATEGORY
          MOVE      PMARPRTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPRTY
.
          MOVE      "yh",CATEGORY
          MOVE      PMARPPBY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPPBY
.
          MOVE      SP70,DESCPHOS
          PACK      KEY3,PMARPHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            MOVE      PTHSNAME,DESCPHOS
          ENDIF
.
          MOVE      SP70,DESCPROC
          PACK      KEY9,PMARPROC,SP70
          CALL      RDPROA1
          IF        OVRCD<>1
            MOVE      WPDESC,DESCPROC
          ENDIF
.
          MOVE      ZERO,F8                 * Days since referral date
          DAYSEP    PMARREQD,CURRDATE,F8
.
          MOVE      "yj",CATEGORY
          MOVE      PMARBTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCTBED
.
          MOVE      SP70,DESCBTYP
          MOVE      SP70,DESCRSTA
.
          PACK      KEY32,PMARREQN,Z70
          CALL      RSPMARV2
HRVR4000  CALL      RPPMARV2
          BRANCH    OVRCD,HRVR5000
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      HRVR5000 IF NOT EQUAL
.
          MATCH     "001",PMAVRTYP
          GOTO      HRVR4000 IF NOT EQUAL
.
          MOVE      "yj",CATEGORY
          MOVE      PMAVBTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCBTYP
.
          MATCH     "001",PMAVRTYP
          IF        @EQUAL
            MOVE      "ym",CATEGORY
          ENDIF
          MATCH     "002",PMAVRTYP
          IF        @EQUAL
            MOVE      "yl",CATEGORY
          ENDIF
          MOVE      PMARPARC,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCRSTA
.
HRVR5000  MOVE      "ym",CATEGORY
          MOVE      PMARPARC,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCPARC
.
          MOVE      "yl",CATEGORY
          MOVE      PMARCLTR,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCCLTR
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",PMARREQN,"#",":               * 1
                             "#"",PMARREQD,"#",":               * 2
                             "#"",PMARREQT,"#",":               * 3
                             "#"",PMARREQD,PMARREQT,"#",":      * 4
                             "#"",DESCRTYP,"#",":               * 5
                             "#"",DESCSTAT,"#",":               * 6
                             "#"",DESCRESC,"#",":               * 7
                             "#"",DESCUNIT,"#",":               * 8
                             "#"",DESCPRTY,"#",":               * 9
                             "#"",DESCPPBY,"#",":               * 10
                             "#"",DESCPHOS,"#",":               * 11
                             "#"",PMARPPAD,"#",":               * 12
                             "#"",DESCPROC,"#",":               * 13
                             "#"",PMARPRDT,"#",":               * 14
                             "#"",FLDRTYPE,"#",":               * 15
                             "#"",FORMATNM,"#",":               * 16
                             "#"",F8,"#",":                     * 17
                             "#"",DESCTBED,"<br><br>",DESCBTYP,"#",":    * 18
                             "#"",DESCRSTA,"#",":               * 19
                             "#"",DESCPARC,"#",":               * 20
                             "#"",DESCCLTR,"#",":               * 21
                             "#"",PMARPROD,"#");"               * 22
.
HRVR9999  RETURN
.
.------------------------------------------------------------------------------
. Remote Scripting
.------------------------------------------------------------------------------
REMT0000  CALL      XMLHED00
          BRANCH    EXIT,REMT9999
.
          BRANCH    REMOTENO,REMT1000,REMT2000,REMT3000
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMT9000
.
REMT1000  CALL      XREQ0000
          GOTO      REMT9000
.
REMT2000  CALL      XWAT0000
          GOTO      REMT9000
.
REMT3000  CALL      GTAGEL00           * Get Hospital Age Limits
          GOTO      REMT9000
.
REMT9000  CALL      XMLEND00
.
REMT9999  RETURN
.
.-----------------------------------------------------------
. Ouput Admission Request Values
.-----------------------------------------------------------
XREQ0000  PACK      KEY10,ADMREQNO,SP70
          CALL      RDPMARQ1
          BRANCH    OVRCD,XREQ9000
.
          PACK      KEY32,PMARREQN,TILDA24
          CALL      RSPMARV2
XREQ1000  CALL      RPPMARV2
          BRANCH    OVRCD,XREQ1500
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      XREQ1500 IF NOT EQUAL
.
          MATCH     "001",PMAVRTYP
          GOTO      XREQ1000 IF NOT EQUAL
.     
          GOTO      XREQ2000
.
XREQ1500  PACK      PMAVASAS,SP70
.
XREQ2000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMARREQN,"|":  0 - Admission Request Number
                             PMARURNO,"|":  1 - U/R Number
                             PMARVISN,"|":  2 - Visit Number
                             PMARREQD,"|":  3 - Request Date (CCYYMMDD)
                             PMARREQT,"|":  4 - Request Time (HH:MM:SS)
                             PMARRTYP,"|":  5 - Request Type
                             PMARRESC,"|":  6 - Responsible Clinicial (pmshcpaf)
                             PMARUNIT,"|":  7 - Unit (Cat WU)
                             PMARTEAM,"|":  8 - Team (pmstemaf)
                             PMARPRTY,"|":  9  - Priority (Cat ye)
                             PMARDIAG,"|":  10 - Diagnosis
                             PMARPROC,"|":  11 - Principal Procedure (watproaf)
                             PMARPROD,"|":  12 - Procedure Description Comments
                             PMARPRO1,"|":  13 - Additional Procedure 1
                             PMARPRO2,"|":  14 - Additional Procedure 2
                             PMARSIDE,"|":  15 - Side of Surgery (Cat yf)
                             PMARCONO,"|":  16 - Consent Obtained
                             PMARCONF,"|":  17 - Consent Obtained Reason
                             PMARPPBY,"|":  18 - Proc. Can Be Performed B
                             PMARIHOS,"|":  19 - Intended Hospital (pathspaf)
                             PMARPSAH,"|":  20 - Pat Suitable For Another Hospit
                             PMARPHOS,"|":  21 - Preferred Hospital (pathspaf)
                             PMARPPAD,"|":  22 - Preferred/Proposed Adm Date
                             PMARBTYP,"|":  23 - Type of Bed Required (Cat yj)
                             PMARANPR,"|":  24 - Admit Night Prior
                             PMARCCBR,"|":  25 - Critical Care Bed Required
                             PMARUDF1,"|":  26 - Preferred Language
                             PMARANTY,"|":  27 - Anaesthetic Type (Cat OA)
                             PMARODUR,"|":  28 - Operation Duration
                             PMARPARC,"|":  29 - Pre-Anaesth. Review Code
                             PMARCLTR,"|":  30 - Clinical Triage Code (Cat yl)
                             PMARHGHT,"|":  31 - Height
                             PMARWGHT,"|":  32 - Weight
                             PMARCBMI,"|":  33 - Calculated BMI
                             PMARCOAG,"|":  34 - Anti-Coagulants
                             PMARRACG,"|":  35 - Ref to Anti-Coagulant Clinic
                             PMARAPLT,"|":  36 - Anti-Platelet
                             PMARITCR,"|":  37 - Initial Tertiary Care Reason 
                             PMARINTR,"|":  38 - Interpreter Required
                             PMARCLAM,"|":  39 - Financial Class (Cat CL)
                             PMARSRCR,"|":  40 - Source of Referral (Cat S)
                             PMARREFC,"|":  41 - Referring Clinician (pmshcpaf)
                             PMARPRAC,"|":  42 - Practice (pmshcgaf)
                             PMARPCNT,"|":  43 - Practice Count
                             PMARLSTS,"|":  44 - Listing Status (Cat VL)
                             PMARINTS,"|":  45 - Intended Stay (Cat VI)
                             PMARSHTN,"|":  46 - Short Notice (Cat WS)
                             PMARPLOS,"|":  47 - Planned Length of Stay
                             PMARNWHC,"|":  48 - Non WA Hospital Contact 
                             PMARPRDT,"|":  49 - Procedure Date (CCYYMMDD)
                             PMARTHLC,"|":  50 - Theatre Location (Cat yp)
                             PMARIMPR,"|":  51 - Implants Required
                             PMARIMPD,"|":  52 - Implants Description
                             PMARIMPO,"|":  53 - Implants Ordered
                             PMARBNGR,"|":  54 - Bone Graft
                             PMAREXFX,"|":  55 - Ex Fix Removal
                             PMARSTAT,"|":  56 - Request Status
                             PMARMAPR,"|":  57 - Medical Authorisation App.
                             PMARTHRQ,"|":  58 - Theatre Required
                             PMARRECC,"|":  59 - Recurring Care
                             PMARRRCL,"|":  60 - Reason Returned to Clinician
                             PMARRREM,"|":  61 - Reason For Removal
                             PMARTSRC,"|":  62 - Transfer Source   
                             PMAVASAS,"|":  63 - ASA Score
                             "</RETURN_VALUE>"
          GOTO      XREQ9999
.
XREQ9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Admission Request- ",ADMREQNO:
                             "</RETURN_VALUE>"
.
XREQ9999  RETURN
.
.-----------------------------------------------------------
. Remote script to indicate WL records on file for a U/R
. with a status of 1, 2, 3 or 4
.-----------------------------------------------------------
XWAT0000  MOVE      ZERO,FORM1
.
          PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
XWAT1000  CALL      RDKTREA1
          BRANCH    OVRCD,XWAT8000          * no procedures
.
          MATCH     URNUMBER,WMURNO
          GOTO      XWAT8000 IF NOT EQUAL   * no procedures
.
          IF        WMSTAT>5   
            GOTO      XWAT1000              * not a valid status
          ENDIF
.
          MOVE      ONE,FORM1
.
XWAT8000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FORM1,"|": 
                            "</RETURN_VALUE>"
          GOTO      XWAT9999
.
XWAT9999  RETURN
+
.------------------------------------------------------------------------------
.         Remote script to get the Lowest and Highest Age Limits for a Hospital
.
.         Parameters:
.           HOSPCODE - Hospital Code
.
.         Returns:
.           PTHSAGEL - Lowest Age Limit Yrs
.           PTHSAGEH - Highest Age Limit Yrs
.------------------------------------------------------------------------------
GTAGEL00  PACK      KEY3,HOSPCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,GTAGEL91
.
          GOTO      GTAGEL98
.
GTAGEL91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Invalid Hospital ":
                    "</RETURN_VALUE>"
          GOTO      GTAGEL99

GTAGEL98  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTHSAGEL,"|",PTHSAGEH:
                            "</RETURN_VALUE>"
          GOTO      GTAGEL99
.
GTAGEL99  RETURN
+
.
.------------------------------------------------------------
.
          INC       CALCAGE
          INC       CLNHIMAS
          INC       CLPMSARQ
          INC       CLPMSARV
          INC       CLPMSPX2
          INC       DAYOFWEK
          INC       IBAWEBCD
          INC       NAMSTRCD
          INC       PATNAMCD
          INC       PATMASTM
          INC       PATMSXTM
          INC       PATDOCCD
          INC       PATDOCTM
          INC       PATDSCTM
          INC       PMSARQTM
          INC       PMSARVTM
          INC       PMSAMNTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       TFILENAM
          INC       WEBDATCD
.
          INC       APSMASIO/INC
          INC       MLTHCPIO/INC
          INC       MLTSECIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       OUTSITIO/INC
          INC       PATALRIO/INC
          INC       PATASFIO/INC
          INC       PATCMCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDADIO/INC
          INC       PATDGWIO/INC
          INC       PATDSCIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATVADIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSAMNIO/INC
          INC       PMSARQIO/INC
          INC       PMSARVIO/INC
          INC       PMSATCIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PMSTEMIO/INC
          INC       PMSVX1IO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
