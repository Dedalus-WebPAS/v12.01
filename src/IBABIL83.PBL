.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*     PROGRAM NAME:     IBABIL83                                             *
.*                                                                            *
.*     FUNCTION:         HEALTH FUND WARD INCOME REPORT                       *
.*                                                                            *
.*     DATE WRITTEN:     16/02/1988                                           *
.*                                                                            *
.*     AUTHOR:           J.TAN                                                *
.*                                                                            *
.*     MODIFICATIONS:                                                         *
.*       V12.00.01  23/05/2025  PJ Le Febour    TSK 0955096 AlphaNum VisitNum *
.*                  replace  COMPARE AADMNO,TADMNO with MATCH AADMNO,TADMNO   *
.*       V11.01.01  13/04/2021  J.Tan           TSK 0863287                   *
.*                  Recompiled for STEPDOWN -Patient Invoice new functionality*
.*       V11.00.01  04/03/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*       V10.13.01  05/12/2018  Don Nguyen       TSK 0838558                  *
.*                  Deleted temp file (PSTROL) after processing               *
.*       V10.11.01  21/09/2017  J.Tan          TSK 0843784                    *
.*                  Mod GCOL0000 - TRANEPSD to check if BFENDDY < TRANBEND    *
.*       V10.10.02  08/09/2017  J.Tan          TSK 0836172                    *
.*                  Recompiled for PATDBTYP (No Pay day)                      *
.*       V10.10.01 13/06/2017  J.Tan          TSK 0839991                     *
.*                  Recompiled for PATDBTYP (PATCMSTP)                        *
.*       V10.09.01  09/01/2017  J.Tan          TSK 0831153                    *
.*                  Changed to check for Force stepdown (TRANEPSD)            *
.*       V10.06.02  17/06/2015  J.Tan          CAR 317806                     *
.*                  Fixed daily rate for Patient on leave on Current date     *
.*       V10.06.01  05/04/2015  J.Tan          CAR 314824                     *
.*                  Mods to ignore current date transfer record               *
.*       V10.05.01  02/02/2015  Ania P         CAR 261630                     *
.*                  Removed use of PORT for temp file naming                  *
.*        V10.05.01 24/07/2014 J.Tan           CAR 303265                     *
.*                  Fixed dayrate for a new contract with no stepdown         *
.*        V10.04.03 19/06/2014 J.Tan           CAR 302452                     *
.*                  Recompiled for PATDINVS - Changed MCHGARR/MCHGAMT         *
.*        V10.04.02 27/05/2014  J.Tan          CAR 300784                     *
.*                  Recompiled for STEPDOWN - force stepdown prior inv.fromdat*
.*        V10.04.01 16/12/2013  Don Nguyen     CAR 294961                     *
.*                  Used HOSNAME to print Hospital name instead of PTHSNAME   *
.*        V10.03.08 14/10/2013  Peter Vela     CAR 285214                     *
.*                  Fixed assigned health fund portion @ TRAN05A              *
.*        V10.03.07 26/09/2013  Peter Vela     CAR 285214                     *
.*                  Fixed zeroes in DDATE                                     *
.*                  Assigned patient portion to DAYRATE after GCOL0000        *
.*        V10.03.06 26/09/2013  Peter Vela     CAR 285214                     *
.*                  Check for zeroes in DDATE @ GCOL1000                      *
.*        V10.03.05 06/05/2013  J.Tan          CAR 284902                     *
.*                  Recompiled for STEPDOWN - force stepdown prior Inv.Fromdat*
.*        V10.03.04 05/09/2012  J.Tan          CAR 267784                     *
.*                  Mods Checking for TCINDC19 Claim Code                     *
.*        V10.03.03 29/08/2012 J.Tan                   CAR 267241             *
.*                  Fixed Column number if No Stepdown                        *
.*        V10.03.02 30/07/2012 J.Tan                   CAR 267241             *
.*                  Fixed Column number for changed of Contract ID            *
.*        V10.03.01 25/07/2012  Patrick Adair          CAR 267241             *
.*                  Allow bed type changes to be reflected in report as well  *
.*                  as actual bed locations, if required                      *
.*        V10.02.02 27/04/2011  Saroeun Soeur CAR 241405                      *
.*                  fixed non multi hospital                                  *
.*        V10.02.01 15/04/2011 Saroeun Soeur CAR 241405                       *
.*                  added hospital filter for multi hospital                  *
.*        V10.01.03 23/02/2011 Peter Vela CAR 233034                          *
.*                  Removed PATBF2FD and PATBF2IO                             *
.*        V10.01.02 03/12/10 J.Tan    CAR 233034                              *
.*                  Mods bed fees file to use health fund table type          *
.*        V10.01.01 29/10/2010  J.Tan         CAR 232411                      *
.*                  Mods to print Current rate instead of yesterday rate      *
.*        V10.00.06 26/08/2010  J.Tan         CAR 226777 (HEA)                *
.*                  Mods NOT to print Prov.Casemix code if PTMICMXP is 'No'   *
.*        V10.00.05 22/07/2010  J.Tan         CAR 226158                      *
.*                  Mods to print yesterday rate instead of current           *
.*        V10.00.04 20/07/2010  J.Tan         CAR 226158                      *
.*                  Fixed stepdown after bed fees update                      *
.*        V10.00.03 14/07/2010  J.Tan         CAR 226158                      *
.*                  Recompiled for STEPDOWN - bed fees update                 *
.*        V10.00.02 20/05/2010  J.Tan         CAR 220449                      *
.*                  Fixed daily rate for per-diem (no Additional rate)        *
.*        V10.00.01 08/04/2010  J.Tan         CAR 215143                      *
.*                  Fixed to set pttrepsd for per-diem stepdown               *
.*        V9.12.06  11/03/2010  J.Tan         CAR 216044                      *
.*                  Mods to include Leave days in stepdown count for TAC      *
.*        V9.12.05  19/01/2010  J.Tan         CAR 166439                      *
.*                  Recompiled for PATCMSTP - C/P additional charge stepdown  *
.*        V9.12.04  21/12/2009  J.Tan         CAR 211664                      *
.*                  Mods to use Prov.Casemix instead of Prov.DRG for Casepaymt*
.*        V9.12.03  03/12/2009  J.Tan         CAR 202869                      *
.*                  Fixed to setup CONTRCID                                   *
.*        V9.12.02  24/11/2009  Davin         CAR 210721                      *
.*                  Recompiled for CHKCMXPT - I*C on patcmxaf file            *
.*        V9.12.01  21/09/2009  J.Tan         CAR 204390                      *
.*                  Recompiled for STEPDOWN - mods to old bed fees file       *
.*        V9.11.01  30/10/2008 J.Tan      CAR 181263                          *
.*                  Recompiled for PATCATAI - printing Disch.Billing Statement*
.*        V9.10.02  05/09/2008  J.Tan         CAR 177126                      *
.*                  Recompiled for PATCATBI - Checking matrix parameter       *
.*        V9.10.01  13/08/2008  J.Tan            CAR 176082                   *
.*                  Fixed bed type                                            *
.*        V9.08.04  15/03/2007  J.Tan            CAR 136149                   *
.*                  Recomp.for PATCATBI for using def.claim code for bed fee  *
.*        V9.08.03  06/03/2007  Peter Vela       CAR 135349                   *
.*                  Reread PATTRN @ TRAN30 with SAVKEY30 to prevent endless   *
.*                  loop                                                      *
.*        V9.08.02  02/02/2007  Ebon Clements CAR 120001                      *
.*                  Added nz private billing files                            *
.*        V9.08.01  25/09/2006  J.Tan            CAR 113167                   *
.*                  Fixed stepdown column number                              *
.*        V9.04.01  29/11/2004  Mike Laming   CAR 54534                       *
.*                  Re-comple for PATCMSTP - fix Addit.Charge Description     *
.*        V9.03.01  23/10/2003  J.Tan  CAR 44172                              *
.*                              Mods for Misc.Theatre item file (pmsmtiaf)    *
.*        V9.02.02  23/04/2003  Dean Cramer  CAR 38200                        *
.*                              Fix error in printing                         *
.*        V9.02.01  17/03/2003  Dean Cramer  CAR 36515                        *
.*                              Port from 6.10 and make changes for 9.02      *
.*        V6.10.11  06/01/2003  Henry Son SRF 35029                           *
.*                              Re-compile for SAR G/L Accruals               *
.*                              Include PATDINVS                              *
.*        V6.10.10  27/11/2002  Madhuri  SRF 33707                            *
.*                  Recompiled  for CMXMATRX                                  *
.*        V6.10.09  23/10/2002  Sunil Kumar  SRF 23084                        *
.*                  Recompiled  for PATCATBI - Fixed I*C error                *
.*        V6.10.08  19/09/2002  J.Tan                                         *
.*                  Recompiled  for PATCMSTP - casemix funding                *
.*        V6.10.07  30/08/2002  J.Tan                                         *
.*                  Recompiled  for PATCATBI - casemix funding                *
.*        V6.10.06  19/08/2002  Guomin Fu     SRF 17469                       *
.*                  Recompiled  for PATDINVS - Order of printing              *
.*                  invoices                                                  *
.*        V6.10.05  09/08/2002  J.Tan                                         *
.*                  - Recompiled for STEPDOWN - Changes for Specialty bed     *
.*        V6.10.04  16/07/2002  Greg Horvat      SRF 17570 Rebound            *
.*                  - Recompiled for STEPDOWN - Changed to use the highest day*
.*                    in period rate (TRBEND) from the transfer file if a     *
.*                    manual stepdown                                         *
.*                  - Recompiled for STEPDOWN - Changed to set the manual     *
.*                    stepdown flag (PTTREPSD) to yes when writing automatic  *
.*                    stepdowns & the flag write manual stepdown (WRMNSTDN) is*
.*                    yes                                                     *
.*        V6.10.03  15/07/2002  Mike Laming      SRF 17570 Rebound            *
.*                  Recompiled for PATCMSTP - Changes to PTTREPSD & ADIP0000  *
.*        V6.10.02  14/07/2002  Greg Horvat      SRF 17570 Rebound            *
.*                  Recompiled for PATCMSTP - Recorrected the test of PTTREPSD*
.*                  in the previous version change & removed the record       *
.*                  repositioning on pattranf that was put in in the previous *
.*                  version change                                            *
.*        V6.10.01  12/07/2002 Mike Laming  SRF 19094                         *
.*                  Recompile for STEPDOWN                                    *
.*        V6.09.04  22/02/2002 J.Tan                                          *
.*                  Recompiled for Stepdown                                   *
.*        V6.09.03  21/02/2002 J.Tan                                          *
.*                  Recompiled for billing problems                           *
.*        V6.09.02  08/02/2002  Greg Horvat                                   *
.*                  Recompiled for STEPDOWN - Commented out changes to        *
.*                  recalculate rate for admission record of trans            *
.*        V6.09.B03 19/03/2001  Jill Habasque  609 Mods                       *
.*                  Mods to print * next to adm type if a casemix patient     *
.*        V6.09.B02 23/02/2001  Ebon Clements  609 Mods                       *
.*                  Removed episode type                                      *
.*       V6.07.03   23/11/2000  Ebon Clements  609 Mods                       *
.*                  Added option 2 for provisional casemix code               *
.*       V6.07.02   18/08/2000  J.Tan SRF 5160                                *
.*                  Recompiled for PATCMSTP(PTCNIDES-cross reference acc.desc)*
.*                  Fixed invoicing discharged casemix patients (SRF 3690)    *
.*       V6.07.01   18/05/1999  J.Tan    SRF 633544                           *
.*                  Fixed number of days left for casemix                     *
.*       V6.06.07   22/12/1999  Bronko Sosic SRF 636268                       *
.*                  Change ADNAME from DIM 11 to DIM 9                        *
.*       V6.06.06   30/09/1999  Steve Downing                                 *
.*                  Recompiled for STEPDOWN                                   *
.*       V6.06.05   20/09/1999  Davin                                         *
.*                  Changes for 4 character DRGs                              *
.*       V6.06.04   16/09/1999  Steve Downing                                 *
.*                  Removed redundant code                                    *
.*       V6.06.03   21/07/1999  J.Tan  SRF 632998                             *
.*                  Mods to recalculate age                                   *
.*       V6.06.02   24/05/1999  J.Tan                                         *
.*                  Recompiled for PATCMSTP - description for additional chg  *
.*       V6.06.01   03/05/1999  Katie Nelson                                  *
.*                  Recompile for PATDINVS                                    *
.*       V6.05.02   21/12/1998  Nicole Harrington                             *
.*                  Fixed lining up of header                                 *
.*       V6.05.01   16/12/1998  Nicole Harrington  SRF 623211                 *
.*                  Mods to print claim no. when no health fund available     *
.*       V6.05.B01  01/07/98 J.Tan                                            *
.*                  Recompiled for PATCMSTP - reposition on pattranf          *
.*        V6.04.05  09/05/97 J.Tan                                            *
.*                  Recompiled for PATCMSTP - Casemix stepdown                *
.*        V6.04.04  09/04/97 J.Tan                                            *
.*                  Mods to use discharge DRG code for casemix funding only   *
.*                  if a DRG code is entered as the provisional DRG           *
.*        V6.04.03  17/03/97 J.Tan   SR 619393                                *
.*                  Fixed rates for onleave patients                          *
.*        V6.04.02  13/12/97 J.Tan                                            *
.*                  Changes for casemix funding                               *
.*        V6.04.01  12/12/1996  Greg Horvat      Holy Spirit Mods             *
.*                  Recompiled for PATDINVS                                   *
.*                                                                            *
.*        V6.03.04  23/05/96 J.Tan     SRF 615301                             *
.*                  Recompiled for STEPDOWN -problem with new date in the past*
.*        V6.03.03  27/10/1995  Greg Horvat      SRF 612064 612205 612206     *
.*                  Recompiled for changes to NHOSPDAY & STEPDOWN             *
.*        V6.03.02  13/10/1995  Greg Horvat      SRF 611811 (Rebound)         *
.*                  Recompiled for PATDINVS                                   *
.*        V6.03.01  11/10/1995  Greg Horvat      SRF 611811                   *
.*                  Changed to use CALCDAYS instead of CALC when calculating  *
.*                  the difference between two dates                          *
.*        V6.02.01  13/10/1994  Jeni Tan         SRF 132145                   *
.*                  Recompiled for STEPDOWN                                   *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
.
          INC       MLTCFNFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPCMTFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIBRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPPFEFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       NZPTFEFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
          INC       PATDINVS/INC
          INC       PATASDFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATLSDFD/INC
          INC       PATLDFFD/INC
          INC       PATAFEFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATBFEFD/INC
          INC       PATCFAFD/INC
          INC       PATCODFD/INC
          INC       PMSCIDFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATRCAUD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PATCMXFD/INC
          INC       PATITMFD/INC
          INC       PMSMTIFD/INC
          INC       PMSVX1FD/INC
          INC       WEBSECFD/INC
          INC       IBASEQFD/INC  
          INC       TFILEVAR/INC
          INC       WEBERRFD/INC
+
.
. ******  VARIABLES DEFINITIONS  ******
.
ADNAME    DIM       9 
AVDC      FORM      6.2
AVPAT     FORM      6.2
ASDATE    DIM       8
ASTER     INIT      "*"
.
CAUDQ     FORM      1
CALDAYS   FORM      4
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CFEETYP   FORM      1
CMDLINE   DIM       50
CRDRTYP   FORM      1
CHOSTYP   FORM      1
CSTDOWN   FORM      1
CDLSTEP   FORM      1
CMXPAT    DIM       1
CUDATE    DIM       8
.
.
DPSAGE    DIM       3
DNUMDAY   DIM       4
DDAYRATE  DIM       9
DDAYLEFT  DIM       3
DDAYCASE  DIM       1
DNOBF     DIM       1
DTDAYNO   DIM       4
DXCOLNUM  DIM       3
DPCMXLOS  DIM       4
.
DAYCASE   FORM      1
DAYLEFT   FORM      3
DAYRATE   FORM      6.2
DCNUM     FORM      6
DCRATE    FORM      6.2
DIM4      DIM       4
DIM18     DIM       18
DIM18A    DIM       18
DIM30     DIM       30
EFTDATE   DIM       8         * Effective date (ccyymmdd)
.
FORM3A    FORM      3
FNAMEI    DIM       8
FNAMER    DIM       8
IBCNMHOS  FORM      1
INCLACTB  FORM      1        * Include actual bed type in report      CAR 267241
JYEAR     FORM      2
.
LEAVFLAG  FORM      1
LSTDATE   DIM       8
NOBF      FORM      1
NUMDAY    FORM      4
.
ODATE     DIM       8
.
PTCNPPIN  DIM       1
PTCNCLEV  DIM       3
PTCNUCMX  FORM      1
PATNUM    FORM      6
.PATRATE   FORM      6.2
PATNAM    DIM       14
PTCNADES  FORM      1
PTCNIDES  FORM      1
PTCNCNDY  FORM      1
PTCNDCLM  DIM       3
PTCNXCHS  DIM       1
.
PSTSRT    FILE      ASCII, FIXED=256
PSTROL    FILE      ASCII, FIXED=256
PTRESDAY  FORM      1
PNAM1     DIM       1
PNAM2     DIM       1
PHEADFL   FORM      1
.
SRBDAY    DIM       4
SRYEAR    FORM      4
SEC       FORM      2
SHTABLE   DIM       8
STATUS    FORM      1
SAVDISC   FORM      6.2
SAVALLW   FORM      6.2
SAVBEND   FORM      3
STRBTYPE  DIM       3
.
TDAYNO    FORM      4
TRDATE    DIM       8
TRANEPSD  FORM      1
TRANBEND  FORM      3
.
UNIQUE    FORM      8
WDATE     DIM       8
WDATE1    DIM       8
WDATE2    DIM       8
WSTAT     FORM      1
.
XCBEND    FORM      3
XBED      DIM       3
XDATE1    DIM       8                       * Yesterday date DDMMYY
XMON2     DIM       2
XDAY2     DIM       2
XWARD     DIM       3
XYEAR2    DIM       2
XCENT2    DIM       2
YTDATE    DIM       8
HOSNAME   DIM       50
HOSCODE   DIM       3
.
. ******  Temporary index file for report  ******
.
TEMPFILE  IFILE     SQL, FIXED=154, KEY="u1-28"
.
.Name     Type      Size    Physical    Start
.----     ----      ----    --------    -----
.XWARD    DIM        3         3          1
.XBED     DIM        3         3          4
.PATNAM   DIM        14        14         7
XUNIQUE   DIM        8         8         21
.PGNAME   DIM        25        25        29
.PSEX     DIM        1         1         54
.PSAGE    FORM       3         3         55
.ADOCTA   DIM        6         6         58
.AFUNDH   DIM        6         6         64
.AFNDTB   DIM        8         8         70
.ADATE    DIM        8         8         78
.ODATE    DIM        8         8         86
.ACLAIM   DIM        3         3         94
.ATYPE    DIM        3         3         97
.NUMDAY   FORM       4         3        100
.DAYRATE  FORM       6.2       5        103
.DAYLEFT  FORM       3         3        108
.DAYCASE  FORM       1         2        111
.NOBF     FORM       1         2        113
.TDAYNO   FORM       4         3        115
.STRBTYP  DIM        3         3        118
XAADMNO   DIM        8         8        121
XCOLNUM   FORM       3         3        129
.PTMIPDRG DIM        9         9        132
.PTCMXLOS FORM       4         3        141
.PRICMBS  DIM        9         9        144
PTCASMX   DIM        1         1        153
.
.End of Record                          154
.
. ******  CONSTANTS  ******
.
ASK1      INIT      "*"
ASK2      INIT      "**"
ASK3      INIT      "***"
ASK4      INIT      "****"
CODEA     INIT      "A "
CODEBT    INIT      "BT"
OPNFLAG   FORM      "1"
.
PRGID     INIT      "IBABIL83"
PRGNAM    INIT      "HEALTH FUND WARD INCOME REPORT"
VERSION   INIT      "V12.01.00"
+
.
.         Display screen header and open files
.
          CALL      DISPHEAD
.
          DISPLAY   *P56:24,"Opening patbfeef";
          OPEN      PATBFEE1,"patbfeef"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patdtraf";
          OPEN      PATDTRA1,"patdtraf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"patcmxaf";
          OPEN      PATCMXA1,"patcmxaf"
.
          DISPLAY   *P64:24,"pmsmtiaf";
          OPEN      PMSMTIA2,"pmsmtiaf"
.
          DISPLAY   *P64:24,"nzpbfeaf";
          OPEN      NZPBFEA1,"nzpbfeaf"
.
          DISPLAY   *P64:24,"nzpcfnaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
.
          DISPLAY   *P64:24,"nzpcmtaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
.
          DISPLAY   *P64:24,"nzpfigaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
.
          DISPLAY   *P64:24,"nzpfinaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
.
          DISPLAY   *P64:24,"nzpibraf"
          OPEN      NZPIBRA1,"nzpibraf"
.
          DISPLAY   *P64:24,"nzpmchaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA2,"nzpmchaf"
.
          DISPLAY   *P64:24,"nzppicaf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPPICA2,"nzppicaf"
.
          DISPLAY   *P64:24,"nzprbraf"
          OPEN      NZPRBRA1,"nzprbraf"
.
          DISPLAY   *P64:24,"nzprfnaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
.
          DISPLAY   *P64:24,"nzppfeaf"
          OPEN      NZPPFEA1,"nzppfeaf"
.
          DISPLAY   *P64:24,"nzpspraf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
.
          DISPLAY   *P64:24,"nzptfeaf"
          OPEN      NZPTFEA1,"nzptfeaf"
          OPEN      NZPTFEA2,"nzptfeaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA1,"oprdetaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"oprsesaf"
          OPEN      OPRSESA1,"oprsesaf"
.
          DISPLAY   *P64:24,"pmsvx1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*217,CAUDQ
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,TEN5;*249,CRDRTYP,*247,CSTDOWN
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*164,PTRESDAY,*211,PTCNCNDY
          READ      CONTROLF,FIFTY9;*1,CDLSTEP
          READ      CONTROLF,EIGHTY8;*233,PTCNADES
          READ      CONTROLF,HUND16;*218,PTCNUCMX
          READ      CONTROLF,HUND29;*89,PTCNPPIN
.
          PACK      CUDATE WITH CCC,CYY,CMM,CDD
          REP       " 0",CUDATE
          MOVE      ZERO,INCLACTB                                   * CAR 267241
+
.
.        START OF PROGRAM
.
START     MOVE      ZERO,PHEADFL 
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = Ward/Bed Sequence":
                    *P1:6,*V2LON,TWO,*HOFF," = Ward/Bed Sequence ( Provisional":
                                           " Casemix )":
                    *P1:8,"Select Option :";
.
START1    KEYIN     *P17:8,*EL,*DV,UNDLN1,*P17:8,*V2LON,OPTION;
.
          COMPARE   ZERO TO OPTION
          GOTO      ENDIT IF EQUAL
.
          CALL      KHOS0000            * keyin hospital (jay)
          BRANCH    EXIT,START
.
REPEAT    BRANCH    OPTION OF START2,STPROC                         *CAR 267241
          DISPLAY   *P35:8,*EL,*B,*V2LON,"** Invalid Option **",*W2;
          GOTO      START1
.                                                               Start CAR 267241
START2    MOVE      ZERO,INCLACTB
          DISPLAY   *P1:22,*EL,"Include actual bed type of ward/bed (Y/N) : ";
.
          MOVE      ANSN,ANS
          KEYIN     *P45:22,*V2LON,ANS;
.
          REP       "yYnN",ANS
          CMATCH    ANSN,ANS
          GOTO      STPROC IF EQUAL
          CMATCH    ANSY,ANS
          GOTO      START21 IF NOT EQUAL
          MOVE      ONE,INCLACTB
          GOTO      STPROC
.
START21   DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Must be Y or N **    ";
          CALL      HITENTER
          GOTO      START2
.                                                                 End CAR 267241
+
.
.            PROCESS START
.
STPROC    CALL      INDZD
          CLOCK     TIME,CTIMEIS
          CALL      SETYDAY            * Set up yesterday date
.
          MOVE      ZERO,LEAVFLAG
          MOVE      ONE,UNIQUE
          MOVE      SP8,DDATE
          MOVE      ZERO,DAYCASE
          MOVE      ZERO,CPAGENO
          MOVE      " ",ANS
.
          DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing Current Admissions **",*HOFF:
                    *P1:24,*EL,*P10:24,"Current Admission No :":
                               *P50:24,"Scanning :";
          MOVE      "2",WSTAT
          CALL      ADMFN
.
          DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing On-Leave Admissions **",*HOFF:
                    *P1:24,*EL,*P10:24,"On-leave Admission No :":
                               *P50:24,"Scanning :";
          MOVE      "4",WSTAT
          CALL      ADMFN
.
          DISPLAY   *P1:24,*EL,*P22:24,*V2LON:
                    "** Processing Discharge Admissions **",*HOFF:
                    *P1:24,*EL,*P10:24,"Discharged Admission No :":
                               *P50:24,"Scanning :";
.
          MOVE      "3",WSTAT
.         MOVE      "000000" TO DDATE
.
.         Get the patients discharged from yesterday
.
          PACK      KEY16 WITH YTDATE,SP8
          CALL      RDSDSCH2
NXTDSH    CALL      RDKDSCH2
          BRANCH    OVRCD OF REPORT
.
          DISPLAY   *P62:24,DADMNO;
          MOVE      ZERO,DAYCASE
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              PACK      KEY8,DADMNO,SP70
              CALL      RDPMVX11
              IF        OVRCD <> 1
                MATCH     PMVXMHOS,HOSCODE    * Correct hospital
                GOTO      NXTDSH IF NOT EQUAL
              ELSE
                GOTO      NXTDSH
              ENDIF
            ENDIF
          ENDIF
.
.         Check for the Admission Date
.
          MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF NXTDSH
          CALL      RDPMVX11
          BRANCH    OVRCD OF NXTDSH
.
          MATCH     DDATE,YTDATE
          GOTO      NXTDS1 IF NOT EQUAL
.
          MATCH     ADATE,YTDATE            * patient was discharged yesterday
          GOTO      NXTDSH IF NOT EQUAL
.
          MOVE      ONE,DAYCASE             * It is a daycase - Patient
          GOTO      NXTDS2                    discharged & admitted yesterday
.
.         Not discharged yesterday, so it must be today
.
NXTDS1    UNPACK    ADATE WITH XCENT,XYEAR,XMON,XDAY
          PACK      XDATE WITH XCENT,XYEAR,XMON,XDAY
          REP       " 0",XDATE
.
          MATCH     CUDATE,XDATE            * Check if the patient was admitted
          GOTO      NXTDSH IF NOT LESS      * before today
.
NXTDS2    CALL      TRANS
          GOTO      NXTDSH
.
.             READ ADMISSIONS FILE
.
ADMFN     PACK      KEY9 WITH WSTAT,SP8
          CALL      RDSMISS2
.
NEXT5     CALL      RDKMISS2
          COMPARE   ONE,OVRCD
          RETURN    IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              PACK      KEY8,AADMNO,SP70
              CALL      RDPMVX11
              IF        OVRCD <> 1
                MATCH     PMVXMHOS,HOSCODE    * Correct hospital
                GOTO      NEXT5 IF NOT EQUAL
              ELSE
                GOTO      NEXT5
              ENDIF
            ENDIF
          ENDIF

          COMPARE   WSTAT,ASTAT
          RETURN    IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD OF NEXT5
.
          DISPLAY   *P62:24,AADMNO;
          UNPACK    ADATE INTO XCENT,XYEAR,XMON,XDAY
          PACK      WDATE WITH XCENT,XYEAR,XMON,XDAY
          REP       " 0",WDATE
.
          MATCH     CUDATE,WDATE
          GOTO      NEXT5 IF NOT LESS
          MOVE      ZERO,DAYCASE
          CALL      TRANS  
          GOTO      NEXT5
+
.
.            Subroutine to process the DTR and Transfer files for the patient
.
TRANS     MOVE      "00000000",ODATE
          MOVE      ZERO,LEAVFLAG
          PACK      KEY22 WITH AADMNO,SP20
          CALL      RDSDTRN1
.
NXTTRN    CALL      RDKDTRN1
          BRANCH    OVRCD OF NXT05
.
          MATCH     AADMNO,TADMNO
          GOTO      NXT05 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      NXTTRN IF NOT EQUAL
.
          PACK      TRDATE WITH TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",TRDATE
.
          MATCH     CUDATE,TRDATE
          GOTO      NXTTRN IF NOT LESS
.
          MATCH     ODATE,TRDATE
          GOTO      NXTTRN IF LESS
.
          MOVE      TRDATE,ODATE            * Save the latest date of theatre
          REP       " 0",ODATE
          GOTO      NXTTRN
.
NXT05     MOVE      "2",PMMIRTYP
          PACK      KEY15 WITH AADMNO,PMMIRTYP,SP20
          CALL      RSPMMTI2
NXT07     CALL      RKPMMTI2
          BRANCH    OVRCD OF NXT10
.          
          MATCH     PMMIVISN,DAADMNO
          GOTO      NXT10 IF NOT EQUAL
          MATCH     "2",PMMIRTYP
          GOTO      NXT10 IF NOT EQUAL       * Not a theatre record
.
          MATCH     CUDATE,PMMITDAT
          GOTO      NXT07 IF NOT LESS
.
          MATCH     ODATE,PMMITDAT
          GOTO      NXT07 IF LESS
.
          MOVE      PMMITDAT,ODATE            * Save the latest date of theatre
          REP       " 0",ODATE
          GOTO      NXT07
.
NXT10     DISPLAY   *P37:24,*V2LON,AADMNO;
.
.         Routine to get the rate
.
GETRATE   MOVE      SP10,SIDATET
          MOVE      ZERO,ENDFLAG
          MOVE      SP10,STATYPE
          MOVE      SP10,STRBTYP
          MOVE      ZERO,STRBEND
          MOVE      SP10,FROMDATE
          MOVE      ONE,PROGFLAG
          MOVE      SP3,STWARD
          MOVE      SP3,STBED
          MOVE      ZERO,XCBEND
          MOVE      ZERO,XCOLNUM            * Column of current stepdown
          MOVE      ZERO,COLNUM
          MOVE      SP30,PRICMBS
          MOVE      SP70,CMCODE
          MOVE      ZERO,PTCMXLOS
          MOVE      SP70,PTCASMX
          MOVE      ZERO,CMXFLAG
          MOVE      ZERO,DAYRATE
.
          CALL      GTAB0000                 * get health fund table
          PACK      CMDRG,PTMIPDRG,SP20      * Default to provisional DRG code
.
          UNPACK    SP10,KEY4,KEY5
          UNPACK    PTMIPDRG,KEY4,KEY5
          MATCH     SP5,KEY5
          IF        @EQUAL
            IF        ASTAT = 3
              MATCH     SP4,PTDSDDRG
              IF        !@EQUAL
                PACK      CMDRG,PTDSDDRG,SP20     * Use discharge DRG Code
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "Y",PTMICMXP
          IF        !@EQUAL
            MOVE      SP70,PTMIPCMX               * No prov.casemix
            MOVE      SP70,PTMIPDRG
          ENDIF
.
          MOVE      SP70,CONTRCID
          IF        OPTION = 1
            MOVE      SP30,PTMIPCMX
          ELSE
            MATCH     "Y",PTMICMXP
            IF        @EQUAL
              IF        PTCNUCMX=1
                PACK      CMCODE,PTMIPCMX,SP70
                MOVE      PTMIPCMX,PTMIPDRG
              ELSE
                PACK      CMCODE,PTMIPDRG,SP70
              ENDIF
              MOVE      ONE,CMXFLAG
              MOVE      ADATE,CEFFDATE
              CALL      VALCMXFN                  * Check Casemix funding
              IF        EXIT=1
                MOVE      ZERO,CMXFLAG            * not casepayment
                MOVE      ZERO,PTCMXLOS
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
.
          MOVE      ZERO,TRANEPSD
          MOVE      ZERO,TRANBEND
          MOVE      SP70,STRBTYPE
          PACK      KEY30 WITH AADMNO,SP20,SP10
          CALL      RDSTRAN2
NXTTRAN   CALL      RDKTRAN2
          BRANCH    OVRCD OF TRAN40
          MATCH     TADMN,AADMNO
          GOTO      TRAN40 IF NOT EQUAL
.
.         Ignore any transfer date for today's date
.
          MATCH     TDATE,CUDATE
          IF        @EQUAL
            MATCH     "L",TMOVE           * Check if patient just went onleave
            IF        @EQUAL
              MOVE      ZERO,NBRDAYS
              DAYSEP    FRDATE,TDATE,NBRDAYS
              MOVE      DAYNUM,TEMPDAY
              ADD       NBRDAYS,TEMPDAY
              MOVE      ONE,LEAVFLAG      * flag for Onleave on Current date
             ENDIF
            GOTO      TRAN40
          ENDIF
.
          PACK      SAVKEY30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
.
          MOVE      TDATE,XDATE1
          MOVE      TDATE,LSTDATE
          MOVE      TMOVE,STMOVE
.
.         Get yesterday ward/bed
.
          MATCH     CUDATE,TDATE
          GOTO      TRAN05 IF NOT LESS
          MOVE      TWARD,STWARD
          MOVE      TBED,STBED
          MOVE      TRBTYP,STRBTYPE
.
TRAN05    COMPARE   ONE,CMXFLAG
          GOTO      TRAN05A IF NOT EQUAL
.
          CMATCH    ANSA,TMOVE
          IF        @EQUAL
            MOVE      ZERO,ACDAYCS      * initialise daycase flag
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,ACDAYCS     * set one to daycase flag
            ENDIF
          ENDIF

          IF        ASTAT=3      
            MATCH     ADATE,DDATE
            GOTO      TRAN10 IF EQUAL   * sameday, no stepdown
          ENDIF 

          CALL      PATCMSTP
          GOTO      TRAN10
.
.         Not a casemix funding patient
.
TRAN05A   BRANCH    CHOSTYP,TRAN10       * Public hospitals don't have stepdown
          MOVE      TDATE,CEFFDATE       * set 'As at date'
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.          If Contract Effective From is 'For Discharges From', Discharged date
.          is blank and TCINDC19=D, default Effective date to Current date
.
           IF         CNTRCEFR=2
             MATCH      SP70,DDATE
.            IF         ASTAT<>THREE
               IF         @EQUAL
               PACK       DDATE,DDATE,SP70
               PACK       KEY5,ANSC,ANSL,ACLAIM
               CALL       RDCODE1
               IF         OVRCD=0
                 MATCH      "D",TCINDC19
                 IF         @EQUAL
                   PACK       CEFFDATE,CCC,CYY,CMM,CDD,SP70
                   REP        " 0",CEFFDATE
                 ENDIF
               ENDIF
             ENDIF
           ENDIF
.
          MOVE      SP70,DIM8
          IF        CSTDOWN=1
            MOVE      TRBEND,TRANBEND
            CALL      STEPDOWN
            IF        NOFEE=1
              MOVE      XDATE1,TDATE     * no fee found
              MOVE      ZERO,TRATEF
              MOVE      ZERO,TRATEH
            ENDIF
.
            MATCH     DIM8,SIDATET
            IF        !@LESS
              MOVE      PTTREPSD,TRANEPSD
              CALL      GCOL0000          * Get column no
              IF        FORM2<>3
                MOVE      BFPAT,TRATEF
                MOVE      BFHF,TRATEH
                MOVE      COLNUM,XCOLNUM  * From the stepdown routine
              ENDIF
            ENDIF
          ENDIF
.
TRAN10    COMPARE   ZERO,ENDFLAG
          GOTO      TRAN20 IF EQUAL
.
          MATCH     LSTDATE,TDATE
          GOTO      TRAN30 IF EQUAL
.
TRAN20    UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
.
          CMATCH    ANSD,TMOVE
          GOTO      TRAN50 IF EQUAL
          CMATCH    ANSL,TMOVE
          GOTO      TRAN25 IF EQUAL
.
          MOVE      TRATEH,DAYRATE
          ADD       TRATEF,DAYRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,DAYRATE
            ADD       PTTRADRB,DAYRATE
          ENDIF
          SUB       TDISC,DAYRATE
          SUB       TALLW,DAYRATE
.
TRAN22
          MATCH     STATYPE,TATYPE
          GOTO      TRAN30 IF EQUAL
          MOVE      TDATE,FROMDATE
          GOTO      TRAN30
.
.         On-leave record
.
TRAN25    MOVE      ZERO,TRATEF
          MOVE      ZERO,TDISC
          MOVE      ZERO,TALLW
          MOVE      ZERO,TRATEH
          MOVE      ZERO,DAYRATE
.
.         Save some variables for use by STEPDOWN
.
TRAN30    
.         PACK      KEY30,SAVKEY30,SP70
.         CALL      RDTRAN2
.
          MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      PTTREPSD,SPTTREPS
          MOVE      TDATE,SIDATET
.
          BRANCH    DAYCASE,NXTTRAN
          MATCH     CUDATE,TDATE
          GOTO      NXTTRAN IF NOT LESS
          MOVE      COLNUM,XCOLNUM          * From the stepdown routine
.
          IF        CMXFLAG=1
            MOVE      PTTRAEND,XCBEND          * casemix patients
            IF        TRBEND<PTTRAEND
              MOVE      TRBEND,XCBEND          * use the lowest ending day
            ENDIF
          ELSE
            MOVE      CURBEND,XCBEND
          ENDIF
          GOTO      NXTTRAN
.
TRAN40    MOVE      CUDATE,TDATE           * Use current date
.
          COMPARE   ONE,CMXFLAG
          GOTO      TRAN40A IF NOT EQUAL
.
            IF        ACDAYCS = 1
              GOTO       TRAN50
            ELSE
              MOVE      CUDATE,XDATE1
              REP       " 0",XDATE1
              MOVE      XDATE1,TDATE
              MOVE      SP1,TMOVE
              LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
              MOVE      STATYPE,TATYPE
              MOVE      STRBTYP,TRBTYP
              MOVE      STRBEND,TRBEND
              MOVE      SPTTRAEN,PTTRAEND
              MOVE      SPTTREPS,PTTREPSD
              CALL      PATCMSTP
              MOVE      ONE,ENDFLAG
              GOTO      TRAN45
            ENDIF
TRAN40A            
.
          BRANCH    CHOSTYP,TRAN50
.
.         Check if a stepdown is required
.
          COMPARE   ONE,CSTDOWN
          GOTO      TRAN50 IF NOT EQUAL
.
          MOVE      CUDATE,XDATE1
          REP       " 0",XDATE1
          MOVE      XDATE1,TDATE
.
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          MOVE      STRBEND,TRANBEND
          IF        ASTAT<>4 & SPTTREPS=2
            MOVE      SAVDATE,FRDATE
            MOVE      ZERO,PTTREPSD
          ELSE
            MOVE      SPTTREPS,PTTREPSD
          ENDIF
          MOVE      SP70,DIM8
          MOVE      CUDATE,CEFFDATE
          CALL      STEPDOWN
          MOVE      ONE,ENDFLAG
          IF        NOFEE=1
            MOVE      ZERO,DAYRATE
            GOTO      TRAN50
          ELSE
            IF      LEAVFLAG=1
              MOVE      BFPAT,DAYRATE           * daily rate prior on-leave
              ADD       BFHF,DAYRATE
              MOVE      COLNUM,XCOLNUM          * From the stepdown routine
              MOVE      BFENDDY,CURBEND
              MOVE      CURBEND,XCBEND
            ENDIF
          ENDIF
.
          MATCH     SP70,DIM8
          GOTO      TRAN45 IF EQUAL
.
          MATCH     DIM8,SIDATET
          IF        !@LESS
            MOVE      SPTTREPS,TRANEPSD
            CALL      GCOL0000          * Get column no
            IF        FORM2<>3
              MOVE      BFPAT,DAYRATE
              ADD       BFHF,DAYRATE
              MOVE      COLNUM,XCOLNUM  * From the stepdown routine
              MOVE      BFENDDY,CURBEND
              MOVE      CURBEND,XCBEND
            ENDIF
          ENDIF
.
.         Check if a stepdown was indicated = shown by a new TDATE
.
TRAN45    MATCH     TDATE,XDATE1
          GOTO      TRAN50 IF EQUAL
.
          MATCH     TDATE,LSTDATE
          GOTO      TRAN10 IF LESS
          GOTO      TRAN30
.
TRAN50    BRANCH    DAYCASE OF TRAN80
          MATCH     CUDATE,TDATE
          GOTO      TRAN60 IF NOT LESS
          MOVE      COLNUM,XCOLNUM          * From the stepdown routine
.
          IF        CMXFLAG=1
            MOVE      PTTRAEND,XCBEND
            IF        TRBEND<PTTRAEND
              MOVE      TRBEND,XCBEND
            ENDIF
          ELSE
            MOVE      CURBEND,XCBEND
          ENDIF
.
.         If not a daycase then day number is calculated from the last date the
.         admission type got changed to the current/dischgarged date
.
TRAN60    
.         REP       " 0",DDATE
          PACK      DDATE,DDATE,SP70
.         MATCH     "000000",DDATE
          MATCH     SP70,DDATE
          GOTO      TRAN65 IF EQUAL
.
          MOVE      DDATE,TODATE
          REP       " 0",TODATE
          GOTO      TRAN70
.
TRAN65    MOVE      CUDATE,TODATE           * Use current date
          REP       " 0",TODATE
.
TRAN70    REP       " 0",FROMDATE
          REP       " 0",TODATE
          CALL      NHOSPDAY                * Calculate no of days since the 
          MOVE      NBRDAYS,NUMDAY          * last change of admission type
.
          MOVE      ADATE,FROMDATE          * Cal. total number of days in hosp.
          REP       " 0",FROMDATE
          CALL      NHOSPDAY
          MOVE      NBRDAYS,TDAYNO
.
          IF        CMXFLAG=1
            IF        ACDAYCS=0   
              MOVE      NBRDAYS,NUMDAY      * Casemix-no of days since admission
            ENDIF
          ENDIF
.
          GOTO      TRAN85
.
TRAN80    MOVE      ONE,NUMDAY
          MOVE      ONE,TDAYNO
.
TRAN85    MOVE      STWARD,XWARD
          MOVE      STBED,XBED
.
.             Get the Day left at this rate
.
          MOVE      ZERO,DAYLEFT
.
          BRANCH    DAYCASE,UPFILE
.
          COMPARE   NUMDAY,XCBEND
          GOTO      UPFILE IF LESS
.
          MOVE      XCBEND,DAYLEFT
          SUB       NUMDAY,DAYLEFT
.
.         Updating the temp file
.
UPFILE    MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF NOMAST
.
          MOVE      NOFEE,NOBF
          MOVE      SP20,PATNAM
          MOVE      PSNAME,PATNAM
          PACK      KEY28 WITH XWARD,XBED,PATNAM,UNIQUE
.
          PACK      ASDATE,CCC,CYY,CMM,CDD        * Current date
          CALL      PATAGED                       * Get the current age
.
          IF        OPTION <> 1
            CALL      GETM0000
            MOVE      CMXFLAG,PTCASMX
          ENDIF
.
          CALL      WRTEMP
          ADD       ONE,UNIQUE
          RETURN
.
NOMAST    DISPLAY   *P1:24,*EL,*B,"** Adm. ",*V2LON,AADMNO,*HOFF:
                                  " has no Master file record **    ";
          CALL      HITENTER
.
          COMPARE   "2",WSTAT
          GOTO      NOMAST1 IF NOT EQUAL
          DISPLAY   *P1:24,*EL,*P10:24,"Current Admission No :";
          GOTO      NOMAST3
.
NOMAST1   COMPARE   "4",WSTAT
          GOTO      NOMAST2 IF NOT EQUAL
          DISPLAY   *P1:24,*EL,*P10:24,"On-leave Admission No :";
          GOTO      NOMAST3
.
NOMAST2   DISPLAY   *P1:24,*EL,*P10:24,"Discharged Admission No :";
.
NOMAST3   DISPLAY   *P50:24,"Scanning :";
          RETURN
+
GCOL0000 MOVE       ZERO,FORM2
         MOVE       ZERO,COLNUM
.
         PACK       DIM23 WITH ACLAIM,AFUNDH,AFNDTB,SAVATYP,SAVBTYP
         COMPARE    FIVE,CFEETYP
         GOTO       GCOL0100 IF EQUAL        * Johns Hopkins bed fees
.
         MOVE       SP70,PTHFBCAT
         PACK       KEY14,AFUNDH,AFNDTB
         CALL       RDFUND1
         PACK       DIM18 WITH ACLAIM,AFUNDH,PTHFBCAT,SAVATYP,SAVBTYP
.
GCOL0100 IF         CFEETYP=9
           PACK       KEY26 WITH DIM23,SP3
           OPEN       JHSBFEA1,"jhsbfeaf"
           CALL       RSJHBFE1
         ELSE
           PACK       KEY27 WITH DIM18,SP70
           CALL       RDSBFEE1
         ENDIF
GCOL1000 IF         CFEETYP=9
           CALL       RKJHBFE1
           BRANCH     OVRCD OF GCOL8000
           PACK       DIM23A WITH BFCLM,BFHFUND,BFHFTAB,BFATYPE,BFBTYPE
           MATCH      DIM23,DIM23A
           GOTO       GCOL8000 IF NOT EQUAL
         ELSE
           CALL       RDKBFEE1
           BRANCH     OVRCD OF GCOL8000
           PACK       DIM18A WITH BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE
           MATCH      DIM18,DIM18A
           GOTO       GCOL8000 IF NOT EQUAL
.
           MOVE       TDATE,CEFFDATE          * set 'As at date'
           LOAD       CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.          If Contract Effective From is 'For Discharges From', Discharged date
.          is blank and TCINDC19=D, default Effective date to Current date
.
           IF         CNTRCEFR=2
             MATCH      SP70,DDATE
.            IF         ASTAT<>THREE
               IF         @EQUAL
               PACK       DDATE,DDATE,SP70
               PACK       KEY5,ANSC,ANSL,ACLAIM
               CALL       RDCODE1
               IF         OVRCD=0
                 MATCH      "D",TCINDC19
                 IF         @EQUAL
                   PACK       CEFFDATE,CCC,CYY,CMM,CDD,SP70
                   REP        " 0",CEFFDATE
                 ENDIF
               ENDIF
             ENDIF
           ENDIF
.
           MOVE       PTBFCNID,KEY6           * Contract ID
           CALL       VALCONTR                * Validate Contract ID
           BRANCH     EXIT,GCOL1000
           MOVE       PTBFCNID,CONTRCID       * Contract ID
         ENDIF
.
.        We don't want a daycase bed fee
.
         IF         BFENDDY=0
           MATCH      DDATE,ADATE
           IF         @EQUAL
             COMPARE    ZERO,ADYHOSP
             GOTO       GCOL9999 IF EQUAL
           ENDIF
           GOTO       GCOL1000
         ENDIF
         ADD        ONE,COLNUM
.
         IF         TRANEPSD=1
           COMPARE    TRANBEND,BFENDDY
           GOTO       GCOL1000 IF LESS
           GOTO       GCOL9999 IF EQUAL
         ENDIF
.
         COMPARE    TEMPDAY,BFENDDY
         GOTO       GCOL1000 IF LESS
         GOTO       GCOL9999 IF NOT EQUAL
.
         IF         BFENDDY=999 & TEMPDAY=999
           GOTO      GCOL9999
         ENDIF
         GOTO       GCOL1000
.
.        Use default bed fee
.
GCOL8000 ADD        ONE,FORM2
         BRANCH     FORM2 OF GCOL8200,GCOL8400
         GOTO       GCOL9999
.
GCOL8200 PACK       DIM18 WITH ACLAIM,SP6,SP3,SAVATYP,SAVBTYP
         PACK       DIM23 WITH ACLAIM,SP10,SP4,SAVATYP,SAVBTYP
         GOTO       GCOL0100
.
GCOL8400 CALL       DCLM0000
         PACK       DIM18 WITH PTCNDCLM,SP6,SP3,SAVATYP,SAVBTYP
         PACK       DIM23 WITH PTCNDCLM,SP10,SP4,SAVATYP,SAVBTYP
         GOTO       GCOL0100
GCOL9999 RETURN
.
.             PRINT REPORT
.
REPORT    DISPLAY   *P1:24,*EL,*V2LON,"** ",*BLINKON,"Generating Report",*HOFF:
                     *V2LON," **",*HOFF,*P45:24,"Patient  :";
.
          MOVE      ZERO,DCNUM
          MOVE      ZERO,DCRATE
          MOVE      ZERO,PATNUM
          MOVE      ZERO,PATRATE
          MOVE      SP3,SAVWARD
          MOVE      "60",CLNO
.
          PACK      KEY28 WITH SP20,SP10
          CALL      RDSTEMP
NXTTEMP   CALL      RDKTEMP
          BRANCH    OVRCD OF ENDREP
          DISPLAY   *P57:24,*V2LON,PATNAM;
.
          COMPARE   ZERO,DAYCASE
          GOTO      NXTT10 IF EQUAL
.
          ADD       ONE,DCNUM
          ADD       DAYRATE,DCRATE
          GOTO      NXTT20
.
NXTT10    ADD       ONE,PATNUM
          ADD       DAYRATE,PATRATE
.
NXTT20    MATCH     SAVWARD,XWARD
          GOTO      NXTT50 IF EQUAL
.
          COMPARE   "60",CLNO
          GOTO      NXTT40 IF EQUAL
          ADD       ONE,CLNO               * this is to avoid double underlining
          COMPARE   "57",CLNO                at the bottom of the page
          GOTO      NXTT30 IF LESS
          CALL      HEAD
          GOTO      NXTT40
.
NXTT30    IF        OPTION = 1 
            CALL      PRTLN
          ELSE
            CALL      PRTLN
            PACK      KEY6,XWARD,SP3
            CALL      RDWARD1 
            PRINT     *1,"|"," WARD : ",XWARD,*16,WBDESC,*132,"|"
            CALL      PRTLN
            ADD       TWO,CLNO
          ENDIF
.
NXTT40    MOVE      XWARD,SAVWARD
.
NXTT50    COMPARE   "57",CLNO
          CALL      HEAD IF NOT LESS
          IF        OPTION = 2
            IF        CPAGENO = 1 & PHEADFL = 0
              MOVE      ONE,PHEADFL
              PACK      KEY6,XWARD,SP3
              CALL      RDWARD1
              IF        OVRCD = 0
                PRINT     *1,"|"," WARD : ",WWARD,*16,WBDESC,*132,"|"
              ELSE
                PRINT     *1,"|"," WARD : ",*132,"|"
              ENDIF
              CALL      PRTLN
              ADD       TWO,CLNO
            ENDIF
          ENDIF
.
.             Get the bed type
.
          MOVE      SP8,DIM8
          PACK      KEY5,CODEBT,STRBTYP
          CALL      RDCODE1
          BRANCH    OVRCD,NOBTYP
          MOVE      TDESC,DIM8
.                                                               Start CAR 267241
          IF        INCLACTB = 0
            GOTO      NOBTYP
          ENDIF
.
.             Get the bed type code from the ward file
.             and use the strbtype code for the patient bed type
.
ACTBTYP   PACK      WEFRBT,SP70
          PACK      KEY6,XWARD,XBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,NOBTYP
.                                                                 End Car 267241
.             Get the patient initial given name
.
NOBTYP    MOVE      SP1,PNAM1
          MOVE      PGNAME,PNAM1
.
.             Get the attending doctor name
.
          MOVE      SP20,ADNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD OF NOADOC
.
          MOVE      DGNAME,PNAM2
          MOVE      DSNAME,ADNAME
.
.             Get the admission and operation date
.
NOADOC    UNPACK    ADATE WITH XCENT,XYEAR,XMON,XDAY
.
.             Get the admission type
.
          MOVE      SP10,DIM10
          PACK      KEY5 WITH CODEA,ATYPE
          CALL      RDCODE1
          BRANCH    OVRCD OF NOATYP
          MOVE      TDESC,DIM10
.                                                               Start CAR 267241
NOATYP    IF        OPTION <> 1
            PRINT     *1,"|",XBED,"|",DIM8,"|",AADMNO," |":
                         PNAM1,DOT,PATNAM,"|";
            GOTO    NOATYP1
          ENDIF
.
          IF        INCLACTB = 1
            PRINT     *1,"|",XWARD,SLASH,XBED,"|",WEFRBT,"  ",STRBTYP,"|":
                         AADMNO," |",PNAM1,DOT,PATNAM,"| ",PSEX," |":
                         PSAGE,"|";
          ELSE
            PRINT     *1,"|",XWARD,SLASH,XBED,"|",DIM8,"|",AADMNO," |":
                         PNAM1,DOT,PATNAM,"| ",PSEX," |",PSAGE,"|";
          ENDIF
.
NOATYP1   MATCH     SP20,ADNAME                                 * End CAR 267241
          GOTO      PRT20 IF EQUAL
          IF        OPTION = 1
            PRINT     PNAM2,DOT,ADNAME;
          ELSE
            PRINT     PNAM2,DOT,ADNAME;
          ENDIF
.
PRT20     IF        OPTION = 1 
            MATCH     SP6,AFUNDH
            IF        @EQUAL
              PRINT     *65,"|",ACLAIM;
            ELSE
              MOVE      AFNDTB,SHTABLE
              PRINT     *65,"|",AFUNDH,SLASH,SHTABLE;
            ENDIF
          ELSE
            PRINT       *53,"|",*54,PTMIPDRG,*64,"|",PTCMXLOS,*70,"|",PRICMBS;
          ENDIF
.
          PRINT     *81,"|",XDAY,SLASH,XMON,SLASH,XYEAR,"|";
.
          MATCH     "000000",ODATE
          GOTO      NOOPER IF EQUAL
.
          UNPACK    ODATE WITH XCENT1,XYEAR1,XMON1,XDAY1
          PRINT     XDAY1,SLASH,XMON1,SLASH,XYEAR1;
.
NOOPER    MATCH     "1",PTCASMX
          IF        @EQUAL
            PACK      CMXPAT,ASTER
          ELSE
            MOVE      SP1,CMXPAT
          ENDIF 
.
          PRINT     *99,"| ",ATYPE,CMXPAT,*105,"|";
.
          BRANCH    NOBF,NOOPER1
          PRINT     XCOLNUM;
.
NOOPER1   COMPARE   ZERO,DAYCASE
          GOTO      NODCASE IF EQUAL
.
          PRINT     *110,"|",*115,"D";
          GOTO      PRATE
.
NODCASE   PRINT     *110,"| ",TDAYNO;
.
PRATE     PRINT     *117,"|",DAYRATE;
          ADD       ONE,CLNO
.
.             Check if number of days left is less 4 (max day)
.
          COMPARE   ZERO,DAYLEFT
          GOTO      NODAY IF EQUAL
.
          COMPARE   "5",DAYLEFT
          GOTO      MAXDAY IF NOT LESS
.
          MOVE      SP4,DIM4
          LOAD      DIM4 WITH DAYLEFT OF ASK1,ASK2,ASK3,ASK4
          PRINT     *127,"|",DIM4,*132,"|"
          GOTO      NXTTEMP
.
MAXDAY    PRINT     *127,"|",*132,"|"     * Nothing get printed if over max
          GOTO      NXTTEMP
.
NODAY     BRANCH    NOBF OF NAVBED
          PRINT     *127,"|ZERO",*132,"|"    * no days left
          GOTO      NXTTEMP
.
NAVBED    PRINT     *127,"| N/A",*132,"|"     * no bed fee in range
          GOTO      NXTTEMP
.
.             Report ended
.
ENDREP    COMPARE   "47",CLNO
          GOTO      ENDREP1 IF LESS
          CALL      HEAD
          GOTO      ENDREP2
.
ENDREP1   CALL      PRTLN
.
ENDREP2   MOVE      ZERO,AVPAT
          MOVE      ZERO,AVDC
.
          COMPARE   ZERO,PATNUM
          GOTO      END05 IF EQUAL
.
          MOVE      PATRATE,AVPAT
          DIV       PATNUM,AVPAT
.
END05     COMPARE   ZERO,DCNUM
          GOTO      END10 IF EQUAL
.
          MOVE      DCRATE,AVDC
          DIV       DCNUM,AVDC
.
END10     MOVE      PATRATE,FORM6P2
          PRINT     *N,*N,*5,"*------------------------":
                    *30,"------------------------------------------*":
                    *N,*5,"|",*30,"|   Number",*43,"|   Room Rates":
                    *60,"|  Average",*72,"|":
                    *N,*5,"*------------------------":
                    *30,"------------------------------------------*":
                    *N,*5,"| Overnight Patients":
                    *30,"|  ",PATNUM,*43,"|",*47,FORM6P2,*60,"|",AVPAT,*72,"|":
                    *N,*5,"| Day Case  Patients":
                    *30,"|  ",DCNUM,*43,"|",*47,DCRATE,*60,"|",AVDC,*72,"|":
                    *N,*5,"*------------------------":
                    *30,"------------------------------------------*":
                    *N,*N:
                    "Note : Zero Stepdown is the Daycase Rate.":
                    *N,*N,"Note: Where no Health Fund is available, a claim ":
                    "number has been printed."
.
.                                                               Start CAR 267241
          IF        INCLACTB = 1
            PRINT     *N,"Note : Wrd/Bed = Bed type from Ward/Bed Maintenance.":
                      *N,"       Pat/Bed = Bed Type selected by hospital ":
                                "staff."
          ENDIF
.
          PRINT     *N,"***  End of Report  ***"
.                                                                 End CAR 267241
          DISPLAY   *P1:24,*EL,*P25:24,*V2LON:
                    "** Report Generation Completed **";
          CALL      KILLIDZ
          GOTO      START
.
.             HEADING
.
HEAD      COMPARE   ZERO,CPAGENO
          CALL      PRTLN IF NOT EQUAL
.
          MOVE      ONE,CNOUNDLN
          IF        OPTION = 1
            MOVE      "(Ward/Bed Sequence)",CPHDROPT
          ELSE
            MOVE      "(Provisional C/mix)",CPHDROPT
          ENDIF
          CALL      IBACLOCK
          CALL      HEAD132
          ADD       ONE,CLNO
.
          IF        IBCNMHOS=1
            PRINT     *40,"Hospital Id : ",HOSNAME
            ADD       ONE,CLNO
          ENDIF
.
          PRINT     *N,*40,"Patients at Midnight ":
                       XDAY2,SLASH,XMON2,SLASH,XCENT2,XYEAR2,*N
.
          CALL      PRTLN
.                                                               Start CAR 267241
          IF        OPTION <> 1
            PRINT   *1,"|   |  Bed   | Adm.    |",*41,"|",*53,"|P.Vision. |":
                    *65,"Len. |Primary   |",*90,"|",*99,"|Adm.",*105,"|Step":
                    *110,"|No. of|   Room  | Day|":
                    *N,*1,"|Bed|  Type  |Number   |Patient Name":
                    *41,"| Att. Doct.|Case Mix  |Stay |CMBS",*81,"|Adm.Date":
                     "|Opr.Date|Type |Down| Days |   Rate  |Left|"
            GOTO    STDHDR1
          ENDIF
.
          IF        INCLACTB = 1
            PRINT    *1,"| Ward/ |Wrd  Pat| Adm.    |",*45,"|",*49,"|",*53,"|":
                     *65,"|Health         |",*90,"|",*99,"|Adm.",*105,"|Step":
                     *110,"|No. of|   Room  | Day|":
                     *N,*1,"|   Bed |Bed  Bed|Number   |Patient Name":
                     *45,"|Sex|Age| Att. Doct.",*65,"|Fund  /Table   |Adm.Date":
                        "|Opr.Date|Type |Down| Days |   Rate  |Left|"
          ELSE
            PRINT    *1,"| Ward/ |  Bed   | Adm.    |",*45,"|",*49,"|",*53,"|":
                     *65,"|Health         |",*90,"|",*99,"|Adm.",*105,"|Step":
                     *110,"|No. of|   Room  | Day|":
                     *N,*1,"|   Bed |  Type  |Number   |Patient Name":
                     *45,"|Sex|Age| Att. Doct.",*65,"|Fund  /Table   |Adm.Date":
                        "|Opr.Date|Type |Down| Days |   Rate  |Left|"
          ENDIF
.
STDHDR1   CALL      PRTLN                                       * End CAR 267241
          MOVE      NINE,CLNO
          RETURN
+
.
PRTLN     PRINT     *1,"*-------------------------------":
                    *33,"-----------------------------------------------":
                    *80,"----------------------------------------------------*"
          RETURN
+
.             Set up yesterday date
.
SETYDAY   MOVE      CDD,DD
          MOVE      CMM,MM
          MOVE      CYY,YY
          MOVE      CCC,CC
          CALL      DMYCON
.
          SUB       ONE,JULDAY
.
SET20     MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      YTDATE WITH CC,YY,MM,DD
          REP       " 0",YTDATE
          UNPACK    YTDATE WITH XCENT2,XYEAR2,XMON2,XDAY2
          RETURN
+
.
.         Create an indexed file based on port
.         for accumulating Admission Type totals
.
INDZD     MOVE      ZERO,STATUS
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEI
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMER
.
.         Check if previously exists..if so delete it
.
          CALL      KILLIDZ
.
          PREP      PSTROL,FNAMER
          WRITE     PSTROL,SEQ;"isbuild ",FNAMEI," 154 u1-28"
          WEOF      PSTROL,SEQ
.
          MOVE      ONE,STATUS
.
          CLEAR     CMDLINE
          APPEND    "sh ",CMDLINE
          APPEND    FNAMER,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
.
.         Delete rollout file
.
          CLOSE     PSTROL,DELETE
.
.         Open Temp Index file
.
          MOVE      ZERO,OPCND
          TRAP      NOINDZ IF IO
          OPEN	    TEMPFILE,FNAMEI
          TRAPCLR   IO
ENDC      RETURN
+
.
NOINDZ    MOVE      ONE,OPCND
          DISPLAY   *P1:24,*EL,*B,"** Temporary Index File ",*V2LON,FNAMEI:
                               *HOFF," not found **   ";
          CALL      HITENTER
          TRAPCLR   IO
          RETURN
+
.
.         Deleting an indexed file based on port
.
KILLIDZ   CLOSE     TEMPFILE
          MOVE      ZERO,STATUS
.
          DISPLAY   *P1:24,*EL,*P28:24,*V2LON,"** Deleting Index File **";
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEI,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.
.           I/O routines for the Temp Index file
.
WRTEMP    RESET     KEY28
          MOVE      AADMNO,XAADMNO
          MOVE      UNIQUE,XUNIQUE
.
          MOVE      PSAGE,DPSAGE
          MOVE      NUMDAY,DNUMDAY
          MOVE      DAYRATE,DDAYRATE
          MOVE      DAYLEFT,DDAYLEFT
          MOVE      DAYCASE,DDAYCASE
          MOVE      NOBF,DNOBF
          MOVE      TDAYNO,DTDAYNO
          MOVE      XCOLNUM,DXCOLNUM
          MOVE      PTCMXLOS,DPCMXLOS
.
          WRITE     TEMPFILE,KEY28;XWARD,XBED,PATNAM,XUNIQUE,PGNAME,PSEX,DPSAGE:
                                   ADOCTA,AFUNDH,AFNDTB,ADATE,ODATE,ACLAIM:
                                 ATYPE,DNUMDAY,DDAYRATE,DDAYLEFT,DDAYCASE,DNOBF:
                                   DTDAYNO,STRBTYPE,XAADMNO,DXCOLNUM,PTMIPDRG:
                                   DPCMXLOS,PRICMBS,PTCASMX
          RETURN
.
RDKTEMP   MOVE      ZERO,OVRCD
          READKS    TEMPFILE;XWARD,XBED,PATNAM,XUNIQUE,PGNAME,PSEX,DPSAGE:
                             ADOCTA,AFUNDH,AFNDTB,ADATE,ODATE,ACLAIM:
                             ATYPE,DNUMDAY,DDAYRATE,DDAYLEFT,DDAYCASE,DNOBF:
                             DTDAYNO,STRBTYP,XAADMNO,DXCOLNUM,PTMIPDRG:
                             DPCMXLOS,PRICMBS,PTCASMX
          GOTO      OVERCOND IF OVER
.
          MOVE      DPSAGE,PSAGE
          MOVE      DNUMDAY,NUMDAY
          MOVE      DDAYRATE,DAYRATE
          MOVE      DDAYLEFT,DAYLEFT
          MOVE      DDAYCASE,DAYCASE
          MOVE      DNOBF,NOBF
          MOVE      DTDAYNO,TDAYNO
          MOVE      DXCOLNUM,XCOLNUM
          MOVE      DPCMXLOS,PTCMXLOS
.
          MOVE      XAADMNO,AADMNO
          RETURN
.
RDSTEMP   MOVE      ZERO,OVRCD
          RESET     KEY28
          READ      TEMPFILE,KEY28;;
          GOTO      OVERCOND IF OVER
          RETURN
+
.******************************************************************************
.*         GETM0000 - loop thru patdtraf to find the Primary, Secondary &     *
.*                    Tertiary MBS item.  Primary will be the mbs with the    *
.*                    highest scheduled fee                                   *
.******************************************************************************
GETM0000  MOVE      SP10,PRICMBS            * initialise primary MBS code
          MOVE      SP10,SECCMBS            * initialise secondary MBS code
          MOVE      SP10,TERCMBS            * initialise tertiary MBS code
          MOVE      ZERO,FORM12A
          MOVE      ZERO,FORM12B
          MOVE      ZERO,FORM12C
          MOVE      ZERO,MTIFLAG
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATITEM1,"patitemn"
          PACK      KEY22,AADMNO,SP20,SP20
          CALL      RDSDTRN1
GETM1000  CALL      RDKDTRN1
          BRANCH    OVRCD,GETM5000
.
          MATCH     AADMNO,TADMNO           * compare admission number
          GOTO      GETM5000 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      GETM1000 IF NOT EQUAL   * not a theatre item
.
GETM2000  PACK      TRDATE WITH TFCENT,TFYEAR,TFMONTH,TFDAY,SP70
          PACK      KEY17,TITEMNO,TRDATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,GETM3000          * not a valid item code
.
          COMPARE   QIAMT,FORM12A
          IF        !@LESS
            MOVE      FORM12A,FORM12B
            MOVE      FORM12B,FORM12C
            MOVE      QIAMT,FORM12A
            MOVE      PRICMBS,SECCMBS
            MOVE      SECCMBS,TERCMBS
            MOVE      TITEMNO,PRICMBS
            GOTO      GETM3000
          ENDIF
.
          COMPARE   QIAMT,FORM12B
          IF        !@LESS
            MOVE      FORM12B,FORM12C
            MOVE      QIAMT,FORM12B
            MOVE      SECCMBS,TERCMBS
            MOVE      TITEMNO,SECCMBS
            GOTO      GETM3000
          ENDIF
.
          COMPARE   QIAMT,FORM12C
          IF        !@LESS
            MOVE      QIAMT,FORM12C
            MOVE      TITEMNO,TERCMBS
          ENDIF
.
GETM3000  BRANCH    MTIFLAG,GETM6000
          GOTO      GETM1000
.
.         Check with Misc.Theatre item file
.
GETM5000  MOVE      ONE,MTIFLAG
          MOVE      "2",PMMIRTYP
          PACK      KEY15,AADMNO,PMMIRTYP,SP20,SP20
          CALL      RSPMMTI2
GETM6000  CALL      RKPMMTI2
          BRANCH    OVRCD,GETM9999
.
          MATCH     DAADMNO,PMMIVISN
          GOTO      GETM9999 IF NOT EQUAL
          MATCH     "2",PMMIRTYP
          GOTO      GETM9999 IF NOT EQUAL
          MOVE      PMMIITEM,TITEMNO
          GOTO      GETM2000
.
GETM9999  RETURN
.
.*******************************************************************************
.         Get the default charging claim code for multi hospital
.*******************************************************************************
DCLM0000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
          MATCH     SP70,PTCNDCLM
          IF        @EQUAL
            MOVE      "0  ",PTCNDCLM          * Use zero claim code
          ENDIF
DCLM9999  RETURN
.
ENDIT     CHAIN     PGM
          STOP
+
.------------------------------------------------------------------------------
.         KHOS0000
.         Enter The Hospital
.------------------------------------------------------------------------------
KHOS0000  COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          DISPLAY   *P1:21,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      TWENTY1,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,PTHSHOSP
          MOVE      ZERO,EXIT
.
KHOS3000  CLOSE     PATHSPA1
.
          DISPLAY   *P20:21,*V2LON,PTHSNAME;
          PACK      HOSNAME,PTHSNAME,SP70
          PACK      HOSCODE,PTHSHOSP,SP70
.
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN
+
.==============================================================================
.
          INCLUDE   STD001IO
          INC       CALCDAYS
          INC       GETBFEES
          INCLUDE   NHOSPDAY
          INCLUDE   STEPDOWN
          INC       PATCMSTP
          INC       PATAGED
          INC       CHKCMXPT
          INC       CLNZPPIC
.
          INC       PATITMRD
          INC       PATHSPKY
          INC       GETCNEFF
          INC       VALCMXFN
.
          INC       MLTCFNIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPCMTIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIBRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPSPRIO/INC
          INC       NZPTFEIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       PATASDIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATLSDIO/INC
          INC       PATLDFIO/INC
          INC       PATAFEIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATBFEIO/INC
          INC       PATCFAIO/INC
          INC       PATCODIO/INC
          INC       PMSCIDIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATHSPIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATRCAIO/INC
          INC       PATTRNIO/INC
          INC       PATWR1IO/INC
          INC       PATCMXIO/INC
          INC       PATITMIO/INC
          INC       PMSMTIIO/INC
          INC       PMSVX1IO/INC
          INC       TFILENAM 
          INC       IBASEQIO/INC 
          INC       WEBERRIO/INC
+
