.***************************************************************************
.* System    :   Waiting List                                              *
.* Program   :   IBAWAT72                                                  *
.* Desc      :                                                             *
.***************************************************************************
.* Date      :   29/11/2004                                                *
.* Author    :   Jill Habasque                                             *
.* Function  :   ESIS extraction program                                   *
.* Modifications :                                                         *
.***************************************************************************
.* V12.00.03 03.07.2025  Peter Vela     TSK 0963111                        *
.*           Fixed datalabels for NDIS and ASA_Score                       *
.* V12.00.02 03.07.2025  Peter Vela     TSK 0963111                        *
.*           Change WTEERDAT to WTEEARDT in WESE0000 when validating ASA   *
.*           Score                                                         *
.* V12.00.01 02.07.2025  DA Sarkies     TSK 0963111                        *
.*           Fixed issue with ASAS score being displayed incorrectly       *
.* V11.05.10 02.07.2025  DA Sarkies     TSK 0955909                        *
.*           Fixed issue with ASAS score being displayed incorrectly       *
.* V11.05.09 30.04.2025  DA Sarkies     TSK 0955909                        *
.*           Added Surgeon ID back into the list.                          *
.* V11.05.08 27.03.2025  DA Sarkies     TSK 0955909                        *
.*           Fixed issue where incorrect catcode being displayed           *
.* V11.05.07 18.03.2025  DA Sarkies     TSK 0955909                        *
.*           Added NDIS and ASAS to ESIS extracts                          *
.* V11.05.06 06.03.2025  DA Sarkies     TSK 0955909                        *
.*           Updated file from 2024 to 2025                                *
.* V11.05.05 03/03/2025  Ebon Clements  TSK 0955540                        *
.*           Fix reported value of converted sex at birth values 3 & 4 to 5*
.* V11.05.04 25/02/2024  Ebon Clements  TSK 0953755                        *
.*           For all patients being extracted. Validate the last sent PMI  *
.*           details in watespaf. Trigger update if different - CESP0000   *
.* V11.05.03 30/01/2025  Alina Bbhari   TSK 0955540                        *
.*           Converted all code 3 & 4 to report to Sex At Birth code       *
.*           Acecepted 1-5 code for Sex At Birth code - WESP1100           *
.* V11.05.02 06/12/2024  Ebon Clements  TSK 0953786                        *
.*           Restored call to CDUPP000 in WESP1000. If U/R has already     *
.*           been sent today skip record.                                  *
.* V11.05.01 21/11/2024  Ebon Clements  TSK 0953786                        *
.*           Report Identifying Gender from WTEPPGEN instead of PMPXUCC4   *
.*           WESP0000                                                      *
.* V11.04.06 09/07/2024  Thanh T        TSK 0948274                        *
.*           Added WTESE000 for sex at birth validation                    *
.* V11.04.05 08/07/2024  Thanh T        TSK 0948274                        *
.*           Changed WESP1000 to remove call CDUPP000 for sex at birth     *
.*           validation                                                    *
.* V11.04.04 08/07/2024  Thanh T        TSK 0948274                        *
.*           Added WTESE000 for sex at birth validation                    *
.* V11.04.03 05/07/2024  Thanh T        TSK 0948274                        *
.*           Added WTESE000 for sex at birth validation                    *
.* V11.04.02 01/07/2024  Thanh T        TSK 0948274                        *
.*           Changed WESP1000 for sex at birth validation                  *   
.* V11.04.01 19/03/2024  Thanh T        TSK 0941760                        *
.*           ESIS Changes 2024-25                                          *
.* V11.03.12 24.07.2023  Ebon Clements  TSK 0934718                        *
.*           For removal reasons N, P, S, T, or X don't populate the       *
.*           treating campus with the destination  - WESE2000              *
.* V11.03.11 11.07.2023  Ebon Clements  TSK 0934718                        *
.*           Report the treating campus from the parameter PTCNHHDP or     *
.*           WTEETCMP if treated at another campus - (Manual entry)        *
.*           For removal reasons N, P, S, T, or X populate the treating    *
.*           campus and destination with the destination collected on      *
.*           transfer WTEEDEST. WESE2000                                   *
.* V11.03.10 04.07.2023  Ebon Clements  TSK 0934613                        *
.*           Changed gender to be an optional field and only validate      *
.*           if populated on the pmi - PMPXUCC4 XGEN                       *
.* V11.03.09 29.06.2023  Ebon Clements  TSK 0934444                        *
.*           Restored 2022 sex at birth edits.                             *
.* V11.03.08 08/06/2023  Davin          Task 0933309                       *
.*           Don't error if Referring Clinician is blank(WTEESGID@WESE3000)*
.* V11.03.07 02.05  2023  DA Sarkies     Task 0928366                      *
.*           Changed size of XGEN variable                                 *
.* V11.03.06 01.05  2023  DA Sarkies     Task 0928366                      *
.*           Changed IDTGEN00 to read the HDP Code                         *
.* V11.03.05 28.04.2023  DA Sarkies     Task 0928366                       *
.*           Fixed size of DGENCHAR from 1 to 3                            *
.* V11.03.04 31.03.2023  DA Sarkies     Task 0928366                       *
.*           Updated Extract for July 2023 changes to ESIS Extracts        *
.* V11.03.03 30/01/2023  Ebon Clements  Task 0925547                       *
.*           Only report destination for removal reasons N, P, S, T, or X  *
.*           WESE2000                                                      *
.* V11.03.02 23/01/2023  Ebon Clements  Task 0925547                       *
.*           Report treating campus as destination value if populated.     *
.*           Report destination blank if not removed. WESE2000             *
.* V11.03.01 20/01/2023  Bella Turco    Task 0914148                       *
.*           Commented out Procedure 031 error message in WESE1080         *
.* V11.02.02 29/03/2022  Jill Parkinson Task 0911807                       *
.*           Changed to use indicator 5 for sex                            *
.* V11.02.01 10/02/2022  Thanh T          TSK 0889899                      *
.*           Recompiled as WATTR1FD changes                                *
.***************************************************************************
.*        V11.01.02 16/06/2021  Jill Parkinson Task 0907716                *
.*                  Changed doyr2021 date to 01 July 2021                  *
.*        V11.01.01 26/04/2021  Jill Parkinson Task 0902610                *
.*                  Changed doyr2021 date to 01 Jan for testing            *
.*        V11.00.08 22/06/2020  Jill Parkinson Task 0893206                *
.*                  Changed order of the episode fields                    *
.*        V11.00.07 12/05/2020  Jill Parkinson Task 0891031                *
.*                  Changed DOYR2020 to be DOYR2021 so changes do not occur*
.*        V11.00.06 28/04/2020  Jill Parkinson Task 0890122                *
.*                  Mods to add V to readiness status check 265            *
.*        V11.00.05 24/04/2020  Jill Parkinson Task 0890122                *
.*                  Mods to add V to readiness statust(COVID19)            *
.*        V11.00.04 23/04/2020  Jill Parkinson Task 0890757                *
.*                  Mods to add P to REMREAS (COVID19)                     *
.*        V11.00.03 04/04/2020  Jill Parkinson Task 0890397                *
.*                  Mods to allow reason for re-booking 119 for COVID-19   *
.*        V11.00.02 27/03/2020  Jill Parkinson Task 0888687                *
.*                  July 2020 changes, added referral accepted date        *
.*        V11.00.01 10/03/2020  Jill Parkinson Task 0879163                *
.*                  Added SEXDSCIO include                                 *
.*        V10.14.10 03/07/2019  Peter Vela      TSK 0877736                *
.*                  Changed Intended_Procedure_Description to              *
.*                  IP_Description                                         *
.*        V10.14.09 02/07/2019  Peter Vela      TSK 0877642                *
.*                  Changed Suregon_Identifier to Surgeon_ID               *
.*        V10.14.08 28/06/2019  Jill Parkinson  TSK 0875636                *
.*                  Dates changed to 01 July                               *
.*        V10.14.07 12/06/2019  Jill Parkinson  TSK 0868835                *
.*                  Changed ppp to check exclude procedures 500-887        *
.*        V10.14.06 29/05/2019  Jill Parkinson  TSK 0875636                *
.*                  Beta test date set to 20190301                         *
.*        V10.14.05 29/05/2019  Jill Parkinson  TSK 0868835                *
.*                  Corrected check for non-reportable procs prior to 2019 *
.*        V10.14.04 12/04/2019  Jill Parkinson  TSK 0868835                *
.*                  Fixed edit S174                                        *
.*        V10.14.03 11/04/2019  Jill Parkinson  TSK 0868835                *
.*                  July 2019 rebounds - checking for IP in PPP            *
.*        V10.14.02 08/04/2019  Jill Parkinson  TSK 0868835                *
.*                  July 2019 changes  - added surgeon id                  *
.*        V10.14.01 01/04/2019  Jill Parkinson  TSK 0868835                *
.*                  July 2019 changes  - added surgeon id                  *
.*        V10.11.02 23/08/2017  Jill Parkinson  TSK 0835492                *
.*                  Corrected to use wmcode not wteeproc when checking     *
.*                  for 200 procedure codes in GETTRE00                    *
.*        V10.11.01 20/07/2017  Jill Parkinson  TSK 0841588                *
.*                  Corrected checking for watesnaf records with non-      *
.*                  reportable procedure codes                             *
.*        V10.10.01 06/03/2017  Jill Parkinson  TSK 0833048                *
.*                  July 2017 changes                                      *
.*        V10.09.02 21/12/2016  Jill Parkinson  TSK 0830360                *
.*                  Corrected setting of exit after calling PRNS0000       *
.*        V10.09.01 20/12/2016  Jill Parkinson  TSK 0830360                *
.*                  Moved to check for 200/500 procedures before checking  *
.*                  seal date                                              *
.*        V10.08.05 14/12/2016  Jill Parkinson  TSK 0830360                *
.*                  Corrected intra records that were not sent due to merge*
.*        V10.08.04 23/11/2016  Jill Parkinson  TSK 0822597                *
.*                  Corrected to allow procedures up to/inc 316            *
.*        V10.08.03 17/11/2016  Jill Parkinson  TSK 0823669                *
.*                  Corrected removal date check                           *
.*        V10.08.02 14/10/2016  Jill Parkinson  TSK 0823669                *
.*                  Added in use of WATESTFD for esis seal check           *
.*                  Added in check of procedure history table for intra    *
.*                  episode records                                        *
.*        V10.08.01 07/04/2016  Jill Parkinson  TSK 0813956                *
.*                  Mods for July 2016 changes                             *
.*        V10.06.01 16/03/2015  J.Tan           CAR 312722                 *
.*                  Mods for 2015 changes                                  *
.*        V10.04.01 12/03/2014  J.Tan           CAR 214185                 *
.*                  Mods for 2014 changes                                  *
.*        V10.03.03 18/10/2013  Don Nguyen      CAR 250510                 *
.*                  Added validation in GETTRE00 for removal date against  *
.*                  the seal date (WTSSDATE).                              *
.*                  Fixed up date string for DOYR2012 check (was 20080701) *
.*        V10.03.02 14/03/2012  Patrick Adair   CAR 260601                 *
.*                  ESIS July 2012 Changes                                 *
.*        V10.03.01 18/11/2011  Mike Laming     CAR 240184                 *
.*                  Changes to IBAPOSTF Post Code table - added to Keys    *
.*        V10.01.02 10/02/2011  Jill Parkinson  CAR 233088                 *
.*                  Added pmsvx1af                                         *
.*        V10.01.01 23/12/2010  Mike Laming     CAR 234831                 *
.*                  Add error message for invalid Sex Code                 *
.*        V9.12.01  05/03/2010  Mike Laming     CAR 204453                 *
.*                  Add check for XRREM="DELETE" at WESE1100 to clear flds *
.*        V9.11.01  21/11/2008 Sandra Barcham   CAR 184095                 *
.*                  Exclude Procedure with HDP Equivalent 500 and above    *
.*        V9.10.01  30/04/2008  Jill Habasque   CAR 165994                 *
.*                  2008 July mods                                         *
.*        V9.09.02  26/06/2007  Sandra Barcham  CAR 139862                 *
.*                  2007 July mods                                         *
.*        V9.09.01  15/05/2007  Jill Habasque   CAR 139862                 *
.*                  2007 July mods                                         *
.*        V9.08.01  04/05/2007  Jill Habasque   CAR 101492                 *
.*                  Added call to CHKMEDI                                  *
.*        V9.07.02  09/08/2006  Jill Habasque   CAR 115445                 *
.*                  Reversed change done for    CAR 107342                 *
.*        V9.07.01  01/08/2006  Jill Habasque   CAR 114206                 *
.*                  Removed W from REMREAS definition                      *
.*        V9.06.06  15/06/2006  Mike Laming     CAR 101512   ESIS 2006     *
.*                  Add XRREM edit to S303, add "Y" to S401 edit           *
.*        V9.06.05  15/06/2006   Peter Vela     CAR 107342                 *
.*                  Removed default of WTEEADAT into XREMDT (removal date) *
.*        V9.06.04  10/05/2006   Peter Vela     CAR 104724                 *
.*                  Added first index of PATMI1FD to fix I * C             *
.*        V9.06.03  09/05/2006   Peter Vela     CAR 104663                 *
.*                  Added third index of OPRDEAFD to fix I * C             *
.*        V9.06.02  27/04/2006   Mike Laming    CAR 101512  ESIS 2006      *
.*                  Add 'Y' to values for XRREM                            *
.*        V9.06.01  07/03/2006   Mike Laming    CAR 86155                  *
.*                  Add test for Event Date vs Admission date at CSAD9000  *
.*        V9.05.B03 10/02/2006   Mike Laming    CAR 88276                  *
.*                  Add test for Intra Episode SAD already "sent" at       *
.*                  CSAD1000                                               *
.*        V9.05.B02 09/01/2006   Sandra Barcham    90770                   *
.*                  If medicare number is DELETE clear Refernece Number    *
.*        V9.04.25  30/11/2005   Ebon Clements CAR 41965                   *
.*                  Added S296 error - Procedure received but not NRFC     *
.*        V9.04.24  09/11/2005   Ebon Clements CAR 84044                   *
.*                  Fixed S295 - should use event value not event date     *
.*                  for admission date test                                *
.*        V9.04.23  12/10/2005   Jill Habasque CAR 67891                   *
.*                  Added edits - S395 S401 and S414                       *
.*        V9.04.22  29/09/2005   Ebon Clements CAR 75638                   *
.*                  Added test for procedure code 200 in CHKCAN00          *
.*        V9.04.21  28/09/2005   Ebon Clements CAR 76051                   *
.*                  Added S295 error message                               *
.*        V9.04.20  21/09/2005   Jill Habasque CAR 76910                   *
.*                  Changed XCEASID and XRETAID to dim 10                  *
.*        V9.04.19  15/09/2005   Jill Habasque CAR 76147                   *
.*                  Fixed merge table headings and right justification     *
.*        V9.04.18  08/09/2005   Jill Habasque CAR 75186                   *
.*                  Added clear of locality for 1000 and 9988              *
.*                  Added medicare reference error messages                *
.*                  Changed order to WESN0000, WESE0000, WESP0000          *
.*        V9.04.17  05/09/2005   Jill Habasque CAR 73862                   *
.*                  Added merge table                                      *
.*        V9.04.16  31/08/2005   Jill Habasque CAR 74367                   *
.*                  Mods to clear XDEST in removal reason T                *
.*        V9.04.15  25/08/2005   Jill Habasque CAR 73464                   *
.*                  Changed filename to output re-run or test              *
.*        V9.04.14  23/08/2005   Jill Habasque CAR 73119                   *
.*                  Changed XTREAT to come from PTCNHHDP instead of CFILENO*
.*        V9.04.13  21/07/2005   Jill Habasque CAR 67889                   *
.*                  Mods to save keys and re-read record after updates     *
.*        V9.04.12  19/07/2005   Jill Habasque CAR 67889                   *
.*                  Mods to update XRREM with DELETE if removal reason E   *
.*        V9.04.11  12/07/2005   Jill Habasque CAR 66078                   *
.*                  Added check for 200 procedure codes for watesnaf       *
.*        V9.04.10  07/07/2005   Jill Habasque CAR 66078                   *
.*                  Added replace S with C for readiness status            *
.*        V9.04.09  20/06/2005  Mike Laming   CAR 60165                    *
.*                  Change XSADI to be zero filled for P & S only          *
.*        V9.04.08  09/06/2005  Jill Habasque CAR 60165                    *
.*                  Added new 2005 fields, wtepabrg,wteeardt and wtensadi  *
.*        V9.04.07  18/02/2005  Jill Habasque CAR 58419                    *
.*                  Fixed medicare suffix for blank medicare numbers       *
.*        V9.04.06  08/02/2005  Jill Habasque CAR 57944                    *
.*                  Stopped I*U if details modified while extract is running*
.*        V9.04.05  20/01/2004  Jill Habasque CAR 57027                    *
.*                  Fixed Set SAD to have dates ddmmccyy                   *
.*        V9.04.04  14/01/2004  Jill Habasque CAR 56809                    *
.*                  Added zero fill for patient and episode ID             *
.*                  Added reconciliation table                             *
.*        V9.04.03  13/01/2004  Jill Habasque CAR 56203                    *
.*                  Fixed event date for intra episode table               *
.*        V9.04.02  10/01/2004  Jill Habasque CAR 56203                    *
.*                  Added applicable errors from IBAWAT62                  *
.*        V9.04.01  04/01/2004  Jill Habasque CAR 54731                    *
.*                  Fixed event values for coded fields, previous ID       *
.***************************************************************************
.
          INC       STD001FD
.
. FILE DESCRIPTION INCLUDES
. -------------------------
          INC       WATESSFD/INC
          INC       WATESTFD/INC
          INC       WATESNFD/INC
          INC       WATESMFD/INC
          INC       WATESEFD/INC
          INC       WATESPFD/INC
          INC       WATTR1FD/INC
          INC       WATPROFD/INC
          INC       WATPHIFD/INC
          INC       PATMA1FD/INC
          INC       PATMRGFD/INC
          INC       PATMI1FD/INC
          INC       PMSHCPFD/INC
          INC       PMSVX1FD/INC
          INC       PATCALAG/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDRGFD/INC
          INC       IBAPOSFD/INC
          INC       WATCONFD/INC
          INC       WATSUSFD/INC
          INC       OPRDEAFD/INC
          INC       PMSPX2FD/INC
.
. LOCAL VARIABLE DEFINITION
. -------------------------
. Extract file definition
.
ESP1      FILE      ASCII, FIXED=256
.
. ESP Extract File Format
.
XPATID    DIM       10     * Patient Identifier
XDOB      DIM       8      * Date of Birth
XEDOB     DIM       3      * Date of Birth Accuracy (AAA or EEE) after 01/07/08
XSEX      DIM       1      * Sex at Birth
XGEN      DIM       4      * Identifying Gender
XNDIS     DIM       9      * NDIS Number
XMEDNUM   DIM       11     * Medicare Number
XMEDSUF   DIM       3      * Medicare Suffix
XPOST     DIM       4      * Post Code
XLOCAL    DIM       35     * Locality 
XINDIG    DIM       1      * Indigenous Status
.
. Extract file definition
.
ESE1      FILE      ASCII, FIXED=256
.
. ESE Extract File Format before 01/07/2019
.
.XEPISID   DIM       9      * Episode Identifier
.XPATID   DIM       10     * Patient Identifier
.XADATE    DIM       8      * Admission Date
.XDEST     DIM       4      * Destination
.XINSD     DIM       1      * Insurance Declaration
.XPLOS     DIM       1      * Planned LOS
.XPPP      DIM       9      * Principal Procedure
.XPPPDES   DIM       50     * PPP Description
.XRREM     DIM       6      * Reason for Removal
.XREG      DIM       8      * Registration Date
.XREMDT    DIM       8      * Removal Date
.XSRCREF   DIM       1      * Source of Referral
.XSURG     DIM       2      * Surgical Specialty
.XTREAT    DIM       4      * Treatment Campus  
.XPREV     DIM       13     * Previous Identifier
.XARDT     DIM       8      * Administrative Registration Date
.XPREVTT   DIM       4      * Previous Total Waiting Time
..
. ESE Extract File Format after 01/07/2019
.
.XEPISID   DIM       9      * Episode Identifier
.XPATID   DIM       10     * Patient Identifier
.XADATE    DIM       8      * Admission Date
.XDEST     DIM       4      * Destination
.XINSD     DIM       1      * Insurance Declaration
.XPLOS     DIM       1      * Planned LOS
.XPPP      DIM       9      * Intended Procedure
.XPPPDES   DIM       50     * PPP Description
.XRREM     DIM       6      * Reason for Removal
.XREG      DIM       8      * Registration Date
.XREMDT    DIM       8      * Removal Date
.XSRCREF   DIM       1      * Source of Referral
.XSURG     DIM       2      * Surgical Specialty
.XTREAT    DIM       4      * Treatment Campus
.XPREV     DIM       13     * Previous Identifier
.XARDT     DIM       8      * Administrative Registration Date
.XPREVTT   DIM       4      * Previous Total Waiting Time
.XSGID     DIM       13     * Surgeon_ID
.
. ESE Extract File Format after 01/07/2020
.
XEPISID   DIM       9      * Episode Identifier
.XPATID   DIM       10     * Patient Identifier
XADATE    DIM       8      * Admission Date
XDEST     DIM       4      * Destination
XINSD     DIM       1      * Insurance Declaration
XPLOS     DIM       1      * Planned LOS
XPPP      DIM       9      * Intended Procedure
XPPPDES   DIM       50     * PPP Description
XRREM     DIM       6      * Reason for Removal
XARDT     DIM       8      * Administrative Registration Date
XREG      DIM       8      * Registration Date
XREMDT    DIM       8      * Removal Date
XSRCREF   DIM       1      * Source of Referral
XSURG     DIM       2      * Surgical Specialty
XTREAT    DIM       4      * Treatment Campus
XPREV     DIM       13     * Previous Identifier
XPREVTT   DIM       4      * Previous Total Waiting Time
XSGID     DIM       13     * Surgeon_ID
XASAS     DIM       1      * ASAS Code
. ESE Extract File Format after 01/07/2021
XREFA     DIM       8      * Referral Accepted Date
.
ESN1      FILE      ASCII, FIXED=256
.
. ESN Extract File Format
.
.XEPISID   DIM       9      * Episode Identifier
XEVENTT   DIM       20     * Event Type
XEDAT     DIM       8      * Event Date
XVALUE    DIM       50     * Event Value
XSADI     DIM       10     * SAD Identifier
.
REC1      FILE      ASCII, FIXED=256
.
. Extract file definition
.
ESM1      FILE      ASCII, FIXED=256
.
. ESM Extract File Format
.
XCEASID   DIM       10     * Ceased Patient Identifier
XRETAID   DIM       10     * Ceased Patient Identifier
. Reconciliation File Format
.
XAGGID    DIM       1      * Aggregate Identifier
XAGGDESC  DIM       40     * Aggregate Description
XAGGVAL   DIM       6      * Aggregate Value
.
BJDAY     FORM      5
CJDAY     FORM      5
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CMDLINE   DIM       80
CHECK     FORM      3
CHECKA    FORM      3
CPTDATE   DIM       8
CHWEDATE  DIM       8
DIM3      DIM       3
COUNT     FORM      2
DATE1     FORM      8
DATE2     FORM      8
DATE3     FORM      8
DIM8      DIM       8
DOYR2025  FORM      1
ERRMSG    DIM       100
FILENAM1  DIM       8
FILENAM2  DIM       8
FILENAM3  DIM       8
FILENAM4  DIM       8
FILENAM5  DIM       8
FORM3     FORM      3
LENGTH    FORM      3
PSAGECON  DIM       3
PSAGETYP  DIM       3
NUMPPP    FORM      3
REGYTD    FORM      6
REMYTD    FORM      6
RERDATE   DIM       8
RUNNUM    DIM       3
SAVESADI  DIM       10
SAVKEY16  DIM       16
SAVKEY17  DIM       17
SAVKEY24  DIM       24
SAVKEY36  DIM       36
SESEKEY   DIM       17
SESNKEY   DIM       36
SESMKEY   DIM       24
TESTKEY   DIM       8
TODAY     DIM       8
VAR1      FORM      1
VAR2      FORM      2
DGENNO    FORM      4
DGENDESC  DIM       20
DGENCHAR  DIM       3
.
DEL       INIT      011
DELETE    INIT      "DELETE"
MAPT      INIT      "MAPT"
URGENCY   INIT      "Urgency"
READINS   INIT      "Readiness"
SETSAD    INIT      "Set SAD"
POSTSAD   INIT      "Reason SAD Changed"
UNDLINE   INIT      "_"
JULY2025  INIT      "20250701"
.
CATAs     INIT      "As"
CATW1     INIT      "W1"
CATW2     INIT      "W2"
CATW3     INIT      "W3"
CATW4     INIT      "W4"
CATX5     INIT      "X5"
CATX6     INIT      "X6"
CATX7     INIT      "X7"
CATX8     INIT      "X8"
CATGI     INIT      "Gi"
CATS      INIT      "S "
REMREAS   INIT      "MBIUSXYP"                           * add Y  *C-101512
.
PRGID     INIT      "IBAWAT72"
PRGNAM    INIT      "ESIS Extraction Program      "
VERSION   INIT      "V12.01.00"
+
.**************************************************************************
.*                              ML0000                                    *
.*                      Controlling Logic (Mainline code)                 *
.**************************************************************************
.
ML0000    CALL      INIT0000               * initialisation and open files
.
ML0100    CALL      OPTN0000               * select options
          BRANCH    EXIT,ML9999            * EXIT = 1 if 0 chosen in menu
.
ML1000    CALL      CONTQST                * Ok to continue ?
          BRANCH    CEXIT,ML2000:          * yes
                          ML0100:          * no
                          ML0100           * cancel
.
ML2000    BRANCH    COPTION,ML2100,ML2100,ML2100
          GOTO      ML9999
.
ML2100    CALL      HEAD0000
          CALL      PROC0000
          CALL      UND132
          PRINT     *1,"*** End of Report ***"
          CALL      MVEXT000
.
ML9999    CHAIN     PGM                    * chain back to program
+
.****************************************************************************
.*                                INIT0000             Called by: ML0000    *
.*                             initialisation                               *
.*  The initialisation routine is used to display headings and open files.  *
.****************************************************************************
.
INIT0000  CALL      DISPHEAD                  * display heading
.
          SCAN      "PreJulyTest",REPTNAME
          IF        @EQUAL
            MOVE      "20250101",JULY2025
          ENDIF     
          RESET     REPTNAME
.
          OPEN      WATESSA1,"watessaf"
          OPEN      WATESSA2,"watessaf"
          OPEN      WATESNA2,"watesnaf"
          OPEN      WATESNA3,"watesnaf"
          OPEN      WATESNA5,"watesnaf"
          OPEN      WATESPA1,"watespaf"
          OPEN      WATESPA2,"watespaf"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATESEA2,"wateseaf"
          OPEN      WATESMA1,"watesmaf"
          OPEN      WATESMA2,"watesmaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      WATPHIA1,"watphiaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTR1A2,"wattr1af"
          OPEN      PATMRGG1,"patmrgaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      IBAPOST1,"ibapostf"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      WATESTA1,"watestaf"
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MOVE      SP70,RERDATE
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*84,PTCNCSRL
          READ      CONTROLF,HUND09;*239,PTCNHHDP
          READ      CONTROLF,THIRTY7;*242,WTCNUSXB
          READ      CONTROLF,TEN5;*189,CTHETR
.
INIT9999  RETURN
+
.****************************************************************************
.*                                CREAT000             Called by: ML0000    *
.*                             Create files                                 *
.****************************************************************************
CREAT000  READ      CONTROLF,HUND09;*239,PTCNHHDP
          CALL      IBACLOCK
          MATCH     SP70,RERDATE
          IF        @EQUAL
            PACK      RERDATE,CCC,CYY,CMM,CDD
            REP       " 0",RERDATE
          ENDIF
          UNPACK    RERDATE,CCENT,CYEAR,CMON,CDAY
.
          COMPARE   TWO,COPTION
          IF        !@EQUAL
            PACK      RUNNUM,SP70
            REP       " 0",RUNNUM
          ENDIF
.
          COMPARE   THREE,COPTION
          IF        @EQUAL
             PACK     KEY15,RERDATE,SP70
             CALL     RSWTESS2
             CALL     RKWTESS2
             IF       OVRCD=0
               MATCH    RERDATE,WTSSDATE
               IF       @EQUAL
                 PACK     RUNNUM,WTSSRUNN
                 REP      " 0",RUNNUM
               ENDIF
             ENDIF
          ENDIF
.
          PACK      FILENAM1,RUNNUM,CYEAR,CMON,ANSP
.
          REP       " 0",FILENAM1
          PREP      ESP1,FILENAM1
.
          PACK      FILENAM2,RUNNUM,CYEAR,CMON,ANSE
.
          REP       " 0",FILENAM2
          PREP      ESE1,FILENAM2
.
          PACK      FILENAM3,RUNNUM,CYEAR,CMON,ANSI
.
          REP       " 0",FILENAM3
          PREP      ESN1,FILENAM3
.
          PACK      FILENAM5,RUNNUM,CYEAR,CMON,ANSM
.
          REP       " 0",FILENAM5
          PREP      ESM1,FILENAM5
.
          PACK      FILENAM4,RUNNUM,CYEAR,CMON,ANSR
.
          REP       " 0",FILENAM4
          PREP      REC1,FILENAM4
.
CREAT999  RETURN
.
.****************************************************************************
.*                                OPTN0000             Called by: ML0000    *
.*                        get user options or exit                          *
.*                                                                          *
.*    Returns:  EXIT    = FALSE (0)  Run clean up                           *
.*                        TRUE  (1)  Exit option selected                   *
.****************************************************************************
.
OPTN0000  MOVE      ZERO,DOYR2025
          DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Test Extract":
                    *P1:6,*V2LON,TWO,*HOFF,". Final Extract":
                    *P1:7,*V2LON,THREE,*HOFF,". Re-Run Extract"
.
OPTN0500  KEYIN     *P1:9,*EL,"Select Option : ",*DV,UNDLN1:
                    *P17:9,*V2LON,COPTION
.
          COMPARE   ZERO,COPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    COPTION,OPTN2000,OPTN2000:   * run clean-up
                            OPTN1000
.
          BEEP
          GOTO      OPTN0500
.
OPTN1000  MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          MOVE      "20",CCOL
          MOVE      "12",CVERT
          CALL      KEYDATE
          BRANCH    OVRCD,OPTN9500
.
          PACK      RERDATE,CCENT,CYEAR,CMON,CDAY,SP70
          REP       " 0",RERDATE
          MATCH     JULY2025,RERDATE
          IF        !@LESS
            MOVE      ONE,DOYR2025
          ENDIF
          PACK      CPTDATE,RERDATE
          CALL      GPERD
          BRANCH    EXIT,OPTN9500
          GOTO      OPTN9000
.
OPTN2000  CALL      CHKSN000         * Check sent table
          BRANCH    EXIT,OPTN9500
          MATCH     JULY2025,TODAY
          IF        !@LESS
            MOVE      ONE,DOYR2025
          ENDIF
          GOTO      OPTN9000
.
OPTN9000  MOVE      ZERO,EXIT
          CALL      CREAT000
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.**************************************************************************
.*                               PROC0000              Called by: ML0000  *
.*                                                                        *
.**************************************************************************
.
PROC0000  MOVE      SP70,WTESSDAT
.
          PACK      KEY8,Z70
          CALL      RSWTEST1                * Position on & read
          CALL      RPWTEST1                *  file record
          BRANCH    OVRCD,PROC1000
.
PROC1000  CALL      CHKCAN00
          CALL      WESN0000
          CALL      WESE0000
          CALL      WESP0000
          CALL      WESM0000
          CALL      RECN0000
.
PROC9999  RETURN
+
.**************************************************************************
.*                               CHKCAN00              Called by: ML0000  *
.*                                                                        *
.**************************************************************************
CHKCAN00  PACK      KEY20,NINE,SP70
          CALL      RDSTREA2
CHKCAN10  CALL      RDKTREA2
          BRANCH    OVRCD,CHKCAN99
.
          COMPARE   NINE,WMSTAT
          GOTO      CHKCAN99 IF NOT EQUAL
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1               * Read a procedure file record
          IF        OVRCD<>1
            SQUEEZE   WTWPHDPE
            PACK      DIM3,WTWPHDPE,SP5
            UNPACK    WTWPHDPE,DIM2,DIM3
            MATCH     "IP",DIM2
            IF        !@EQUAL
              UNPACK    WTWPHDPE,DIM3
            ENDIF
            MATCH     "200",DIM3
            GOTO      CHKCAN10 IF EQUAL   * Ignore this procedure
            MOVE      ZERO,FORM3
            MOVE      DIM3,FORM3
            IF        FORM3>499 & FORM3<887
              GOTO      CHKCAN10
            ENDIF
          ENDIF
.
          MOVE      "Patient has cancelled booking status",ERRMSG
          PACK      WTEEURNO,WMURNO,SP70
          PACK      WTEEUNIQ,WTWMECNT,SP70
          CALL      PRNTE000          * Print error message
          GOTO      CHKCAN10
.
CHKCAN99  RETURN
.**************************************************************************
.*                               WESP0000              Called by: PROC0000*
.*               Extract records from watespaf                            *
.**************************************************************************
WESP0000  CALL      WRESPH00
          IF        COPTION=1 | COPTION=2
            PACK      TESTKEY,SP70
          ENDIF
.
          IF        COPTION=3
            PACK      TESTKEY,RERDATE,SP70
          ENDIF
.
WESP0500  PACK      KEY16,TESTKEY,SP70
          CALL      RSWTESP2
WESP1000  CALL      RKWTESP2
          BRANCH    OVRCD,WESP9999 
.
          MATCH     TESTKEY,WTEPEDAT
          GOTO      WESP9999 IF NOT EQUAL
.
          IF        COPTION=2
            CALL      CDUPP000
            BRANCH    EXIT,WESP1000
          ENDIF
.
          PACK      KEY8,WTEPURNO,SP70
          CALL      RDMAST1
          CALL      RDPMPX21
          CALL      CLRESP00
.
          PACK      XPATID,SP2,WTEPURNO,SP70
          REP       " 0",XPATID
          UNPACK    WTEPPDOB,CCENT,CYEAR,CMON,CDAY
          PACK      XDOB,CDAY,CMON,CCENT,CYEAR
          REP       " 0",XDOB
.
          PACK      XEDOB,ANSA,ANSA,ANSA,SP70
          MATCH     "1",WTEPEDOB
          IF        @EQUAL
            PACK      XEDOB,ANSE,ANSE,ANSE,SP70
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                 * Calculate age as of admin date
.         
          MOVE      WTEPPSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
.         Pre and post 2024 new rule
          IF        DSEXNO = 3 | DSEXNO = 4
            MOVE      FIVE,DSEXNO
          ENDIF
.
          MOVE      DSEXNO,XSEX 
.
WESP1100  IF        DSEXNO <> 1 & DSEXNO <> 2 & DSEXNO <> 5
            MOVE      "R:S091 Sex at birth code invalid",ERRMSG
              CALL      PRNT0000
          ENDIF
.          CALL      WTESE000
.          MATCH     JULY2024,CHWEDATE
.WESP1100  IF        !@LESS
.            IF        DSEXNO <> 1 & DSEXNO <> 2 & DSEXNO <> 5
.              MOVE      "R:S091 Sex at birth code invalid",ERRMSG
.              CALL      PRNT0000
.            ENDIF 
.          ELSE
.            IF        DSEXNO < 1 | DSEXNO > 5
.              MOVE      "R:S091  Sex at birth code invalid",ERRMSG
.              CALL      PRNT0000
.            ENDIF
.            IF        DSEXNO = 3 & PSAGEDAY > 90
.              MOVE      "R:S093 Sex Code Invalid for age",ERRMSG
.              CALL      PRNT0000
.            ELSE        
.              IF        DSEXNO = 3 
.                MOVE      "W:S093  Notifiable Sex Code",ERRMSG
.                CALL      PRNT0000
.              ENDIF
.            ENDIF
.          ENDIF
.
          MATCH     SP70,WTEPPGEN
          IF        !@EQUAL
            MOVE      WTEPPGEN,DGENCHAR
            CALL      IDTGEN00               * Get ID Gender Description
.                                          * Returns DGENDESC & DGENNO
            MOVE      DGENNO,XGEN
.
            IF        DGENNO <> 1 & DGENNO <> 2 & DGENNO <> 3
              IF        DGENNO <> 4 & DGENNO <> 5 & DGENNO <> 9
                MOVE      "R:S442 Gender code has not been reported or is invalid",ERRMSG
                CALL      PRNT0000
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,WTEPMEDI
          IF        !@EQUAL
            MATCH     SP70,WTEPMREF
            IF        @EQUAL
              MOVE      "R:S081  Missing medicare reference",ERRMSG
              CALL      PRNT0000
            ENDIF
          ENDIF
.
          MATCH     "0",WTEPMREF
          IF        @EQUAL  
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE                 * Calculate age as of admin date
            IF        PSAGEDAY>365
              MOVE      "R:S083  Medicare code is '0' age is > 365",ERRMSG
              CALL      PRNT0000
            ENDIF
          ENDIF
.
          IF        DOYR2025=1
            MOVE      WTEPNDIS,XNDIS
          ENDIF
.
          MATCH     "DELETE    ",WTEPMEDI
          IF        @EQUAL
            PACK      XMEDNUM,WTEPMEDI,SP70
          ELSE
            PACK      XMEDNUM,WTEPMEDI,WTEPMREF,SP70
          ENDIF
.
          CALL      MSFX0000
          CALL      PTSB0000
.
          PACK      KEY5,ANSV,ANSA,WTEPABRG,SP70
          CALL      RDCODE1                 * read PATCODFD record
          PACK      XINDIG,THCSCOD,SP70
          UNPACK    THCSCOD,DIM1,XINDIG
.
          MOVE      ZERO,F1
          MOVE      XINDIG,F1
          IF        F1=0|F1=5|F1=6|F1=7
            MOVE      "R:S245  Indigenous Status Invalid",ERRMSG
            CALL      PRNT0000
          ENDIF
.
WESP2000  CALL      WRESP000
.
          IF        COPTION=2
            PACK      WTEPEDAT,TODAY
            REP       " 0",WTEPEDAT
            PACK      WTEPUDAT,TODAY
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS
            REP       " 0",WTEPUTIM
            CALL      UPWTESP2
            GOTO      WESP0500
          ENDIF
.
          GOTO      WESP1000
.
WESP9999  RETURN
.
.-----------------------------------------------------------------------------
. Return Waiting List ESIS Episode registration date
.-----------------------------------------------------------------------------
WTESE000  MOVE      "00000000",CHWEDATE
          PACK      KEY17,Z70
          CALL      RSWTESE1
WTESE200  CALL      RPWTESE1
          BRANCH    OVRCD,WTESE999
.
          MATCH     WTEPURNO,WTEEURNO
          GOTO      WTESE200 IF NOT EQUAL
.
WTESE500  MOVE      WTEERDAT,CHWEDATE
.
WTESE999  RETURN
+
.******************************************************************************
.*                                  CDUPP000                                  *
.*                       Check if record already sent today                   *
.******************************************************************************
CDUPP000  MOVE      ZERO,EXIT
          PACK      SAVKEY16,WTEPEDAT,WTEPURNO,SP70
          PACK      WTEPEDAT,TODAY
          REP       " 0",WTEPEDAT
          PACK      KEY16,WTEPURNO,WTEPEDAT,SP70
          CALL      RDWTESP1
          IF        OVRCD<>1
            MOVE      ONE,EXIT
          ENDIF
          PACK      KEY16,SAVKEY16,SP70
          CALL      RDWTESP2
.
CDUPP999  RETURN
+
.******************************************************************************
.*                                  MSFX0000                                  *
.*                              Get Medicare Suffix                           *
.******************************************************************************
MSFX0000  MATCH     SP10,WTEPMEDI
          GOTO      MSFX2100 IF NOT EQUAL
.
          PACK      KEY5,ANST,SP1,WTEPRESI,SP70
          CALL      RDCODE1                 * read PATCODFD record
.
          MATCH     SP1,TCINDC1             * blank 1st Indicator ?
          GOTO      MSFX1000 IF EQUAL       * yes

          TYPE      TCINDC1                 * is 1st Indicator numeric ?
          GOTO      MSFX1000 IF NOT EQUAL   * no
          MOVE      TCINDC1,FORM1           * yes
.
          BRANCH    FORM1,MSFX1000,MSFX1100,MSFX1200
          GOTO      MSFX2000                * invalid 1st Indicator
.
. ------  1st Indicator = "1"  ------
.
MSFX1000  MOVE      "C-U",XMEDSUF
          GOTO      MSFX1300
.
. ------  1st Indicator = "2"  ------
.
MSFX1100  MOVE      "N-E",XMEDSUF
          GOTO      MSFX1300
.
. ------  1st Indicator = "3"  ------
.
MSFX1200  MOVE      "P-N",XMEDSUF
.
. ------  when Suffix is C-U, N-E or P-N, Medicare Number is set to blank  -----
.
MSFX1300  MOVE      SP10,XMEDNUM
          GOTO      MSFX9999
.
. ------  invalid 1st Indicator  ------
.
MSFX2000  MATCH     SP10,WTEPMEDI
          GOTO      MSFX9999 IF EQUAL
.
. ------  valid Medicare Number  ------
.
MSFX2100  MOVE      WTEPMEDI,PMEDI
          CALL      CHKMEDI
          IF        OVRCD=1
            MOVE      "R:S081  Medicare Number Invalid",ERRMSG
            CALL      PRNT0000              * Print error message
          ENDIF
.
          MOVE      PGNAME,KEY25
          REP       UPPLOW,KEY25
          SCAN      "SON OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          SCAN      "DAUGHTER OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          SCAN      "BABY OF",KEY25
          GOTO      MSFX2200 IF EQUAL
.
          RESET     KEY25,3
          LENSET    KEY25
          RESET     KEY25
          MOVE      KEY25,XMEDSUF
          GOTO      MSFX9999
.
MSFX2200  MOVE      "BAB",XMEDSUF
          GOTO      MSFX9999
.
MSFX9999  RETURN
+
.******************************************************************************
.*                                  PTSB0000                                  *
.*                          Get The Postcode & Suburb                         *
.******************************************************************************
PTSB0000  REP       UPPLOW,WTEPSUBR
          PACK      KEY56,WTEPPOST,SP4,WTEPSUBR,SP70                  *C-240184
          CALL      RSIBPOS1                * Position on & read a postcode
          CALL      RKIBPOS1                  file record
          BRANCH    OVRCD,PTSB6000
.
          MATCH     WTEPPOST,IBPOPCOD
          GOTO      PTSB6000 IF NOT EQUAL   * Invalid postcode, error
.
          MOVE      IBPOSUBR,KEY22          * Save the 1st suburb for postcode
          MATCH     SP70,WTEPSUBR
          GOTO      PTSB5000 IF EQUAL       * Blank suburb
          GOTO      PTSB3000
.
PTSB2000  CALL      RKIBPOS1                * Read a postcode file record
          BRANCH    OVRCD,PTSB5000
.
          MATCH     WTEPPOST,IBPOPCOD
          GOTO      PTSB5000 IF NOT EQUAL   * Different postcode
.
PTSB3000  MATCH     WTEPSUBR,IBPOSUBR
          GOTO      PTSB2000 IF NOT EQUAL   * Different suburb
.
PTSB4000  MOVE      WTEPPOST,KEY4
          MOVE      KEY4,XPOST              * Postcode
          MOVE      IBPOSUBR,XLOCAL         * Suburb
          GOTO      PTSB9000
.
PTSB5000  MOVE      WTEPPOST,KEY4
          MOVE      KEY4,XPOST              * Postcode
          MOVE      KEY22,XLOCAL            * Suburb - 1st suburb for postcode
          GOTO      PTSB9000
.
PTSB6000  MOVE      "R:S121  Postcode/Locality Combination Invalid",ERRMSG
          CALL      PRNT0000              * Print error message
          GOTO      PTSB9999
.
PTSB9000  MATCH     XPOST,IBPOPCOD
          IF        @EQUAL
            MATCH     "OS",IBPOSTAT
            IF        @EQUAL
              PACK      XLOCAL,IBPOPCOD,SP30
              MOVE      "8888",XPOST
            ENDIF
          ENDIF
.
          MATCH     "OS",PADD4
          IF        @EQUAL
            MOVE      "8888",XPOST
          ENDIF
.
          MATCH     "9988",XPOST
          IF        @EQUAL
            MOVE      SP70,XLOCAL
          ENDIF
.
          MATCH     "1000",XPOST
          IF        @EQUAL
            MOVE      SP70,XLOCAL
          ENDIF
.
PTSB9999  RETURN
+
.**************************************************************************
.*                               WESE0000              Called by: PROC0000*
.*               Extract records from wateseaf                            *
.**************************************************************************
WESE0000  CALL      WRESEH00
          IF        COPTION=1 | COPTION=2
            PACK      TESTKEY,SP70
          ENDIF
.
          IF        COPTION=3
            PACK      TESTKEY,RERDATE,SP70
          ENDIF
.
WESE0500  PACK      KEY17,TESTKEY,SP70
          CALL      RSWTESE2
WESE1000  CALL      RKWTESE2
          BRANCH    OVRCD,WESE9999
.
          MATCH     TESTKEY,WTEEEDAT
          GOTO      WESE9999 IF NOT EQUAL
.
          PACK      SESEKEY,WTEEEDAT,WTEEUNIQ,SP70
          IF        COPTION=2
            CALL      CDUPE000
            BRANCH    EXIT,WESE1000
          ENDIF
.
          CALL      CLRESE00
.
          CALL      GETT0000               * get treatment detail   
          BRANCH    EXIT,WESE1000
.
          CALL      CESP0000                * Check watespaf patient details
.
          PACK      XEPISID,WTEEUNIQ,SP70
          REP       " 0",XEPISID
          PACK      XPATID,SP2,WTEEURNO,SP70
          REP       " 0",XPATID
          MATCH     SP70,WTEEADAT
          IF        !@EQUAL
            UNPACK    WTEEADAT,CCENT,CYEAR,CMON,CDAY
            PACK      XADATE,CDAY,CMON,CCENT,CYEAR
            REP       " 0",XADATE
            PACK      XREMDT,CDAY,CMON,CCENT,CYEAR
            REP       " 0",XREMDT
            PACK      XRREM,ANSW,SP70
          ENDIF
.
          MATCH     SP70,WTEEINSD
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,WTEEINSD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XINSD,THCSCOD
            ENDIF
          ENDIF
.
          COMPARE   ZERO,WTCNUSXB
          GOTO      WESE1050 IF NOT EQUAL
.
          MOVE      "4",XPLOS              * Intended LOS - overnight
          MATCH     "20160701",WMKEYDT
          IF        @LESS
            MATCH     ANSA,WTEEPLOS
            IF        @EQUAL
              MOVE      "3",XPLOS
            ELSE
              MOVE      WTEEPLOS,F3
              IF        F3=0
                MOVE      "1",XPLOS            * Intended LOS - sameday
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "20160701",WMKEYDT
          IF        !@LESS
            MOVE      WTEEPLOS,F3
            IF        F3=0
              MOVE      "1",XPLOS            * Intended LOS - sameday
            ENDIF
          ENDIF
.
          GOTO      WESE1060
.
WESE1050  PACK      KEY5,ANSX,ANSB,WTEEPLOS,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,TCINDC1
            IF        !@EQUAL
              MOVE      TCINDC1,XPLOS
            ENDIF
          ENDIF
.
WESE1060  PACK      KEY9,WTEEPROC
          CALL      RDPROA1               * Read a procedure file record
          IF        OVRCD=1
            MOVE      "Invalid Procedure Code",ERRMSG
            CALL      PRNTE000              * Print error message
          ENDIF
.
. **** read last record on the procedure HDP history table 
          PACK      KEY17,WTEEPROC,WMKEYDT,SP70
          CALL      RSWTPHI1
          CALL      RKWTPHI1
          BRANCH    OVRCD,WESE1070
.
          MATCH     WTEEPROC,WTPHPROC
          GOTO      WESE1070 IF NOT EQUAL
.
          PACK      WTWPHDPE,WTPHHDPV,SP70
.
WESE1070  SQUEEZE   WTWPHDPE
          MOVE      WTWPHDPE,NUMPPP
          MOVE      WTWPHDPE,XPPP       * Intended procedure
.
          UNPACK    WTWPHDPE,DIM2,DIM3
          MATCH     "IP",DIM2
          IF        @EQUAL
            SQUEEZE   DIM3
            MOVE      DIM3,NUMPPP
          ENDIF
.
WESE1080  COMPARE   "200",NUMPPP
          GOTO      WESE1000 IF EQUAL   * Ignore this procedure
          IF        NUMPPP>499 & NUMPPP<887
            GOTO      WESE1000
          ENDIF
.
          MOVE      NUMPPP,FORM3
.
....      COMPARE "031",NUMPPP
....      IF      @EQUAL
....        MATCH   "19990701",WTEERDAT
....        IF      !@LESS
....          MOVE     "R:S134  Procedure 031 is invalid from 01/07/1999",ERRMSG
....          CALL      PRNT0000
....        ENDIF
....      ENDIF
.
          CALL      CSAD0000              * Check scheduled admission date   
          CALL      CSUS0000              * Check ready for care status
.
          MATCH     DELETE,WTEEPDES
          IF        @EQUAL
            PACK      XRREM,DELETE
            GOTO      WESE1100
          ENDIF
.
          PACK      XPPPDES,WTEEPDES,SP70
.
          MATCH     SP70,WTEERREM
          GOTO      WESE1100 IF EQUAL
.
          PACK      KEY5,ANSW,ANSR,WTEERREM,SP70
          CALL      RDCODE1               * Read a codes file record
          IF        OVRCD<>1
            MOVE      TCINDC3,XRREM       * Reason for removal
            MOVE      SP1,KEY1
            MOVE      XRREM,KEY1
            REP       " 1H1W1M1Y1B1I1U1X1N1T1R1Z1Q1S1F1E1O1P1",KEY1
            MOVE      ZERO,FORM1
            MOVE      KEY1,FORM1
            IF        FORM1<>1
              MOVE      "R:S298  Invalid Reason for Removal",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
.
.                       Test and correct for -
.                       Error "S401 Date of Admis/Reason for Removal Mismatch"
            STRIP     XRREM
            RESET     REMREAS
            SCAN      XRREM,REMREAS           * "MBIUSX" + "Y" + "P"
            IF        @EQUAL
              UNPACK    WTEEREMD,CCENT,CYEAR,CMON,CDAY
              PACK      XADATE,CDAY,CMON,CCENT,CYEAR
              REP       " 0",XADATE
            ENDIF
          ENDIF
.
          MATCH     ANSE,XRREM
          IF        @EQUAL
            MOVE      DELETE,XRREM
          ENDIF
.
WESE1100  MATCH     DELETE,XRREM                                      *I-204453
          IF        @EQUAL
            UNPACK    SP70,XPLOS,XPPP,XPPPDES  * clear these fields for a DELETE
          ENDIF
.
WESE1150  MATCH     SP70,WTEEREMD
          IF        !@EQUAL
            MATCH     "00000000",WTEEREMD
            IF        !@EQUAL
              UNPACK    WTEEREMD,CCENT,CYEAR,CMON,CDAY
              PACK      XREMDT,CDAY,CMON,CCENT,CYEAR
              REP       " 0",XREMDT
            ENDIF
          ENDIF
          UNPACK    WTEERDAT,CCENT,CYEAR,CMON,CDAY
          PACK      XREG,CDAY,CMON,CCENT,CYEAR
          REP       " 0",XREG   
          DAYSEP    WTEERDAT,WMKEYDT,F8
          IF        F8>89
            MOVE      "W:S174  New Episode, Old Registration Date",ERRMSG
            CALL      PRNTE000
          ENDIF
.
          UNPACK    WTEEARDT,CCENT,CYEAR,CMON,CDAY
          PACK      XARDT,CDAY,CMON,CCENT,CYEAR
          REP       " 0",XARDT
.
          UNPACK    WTEERADT,CCENT,CYEAR,CMON,CDAY
          PACK      XREFA,CDAY,CMON,CCENT,CYEAR
          MATCH     SP70,WTEERADT
          IF        !@EQUAL
            REP       " 0",XREFA
          ENDIF
.
          MOVE      "1",XSRCREF
          MATCH     SP3,WTEESREF
          IF        !@EQUAL
            LOAD      TCODE,PTCNCSRL,CATW1,CATW2,CATW3,CATW4,CATX5,CATX6:
                                     CATX7,CATX8,CATS
            PACK      KEY5,TCODE,WTEESREF,SP70
            CALL      RDCODE1
            IF        OVRCD <>1
              UNPACK    THCSCOD,DIM1,XSRCREF * Source of referral
              REP       " 0",XSRCREF
              MOVE      ZERO,FORM1
              MOVE      XSRCREF,FORM1
              IF        FORM1<1|FORM1>5
                MOVE      "R:S192  Source of Referral is mandatory",ERRMSG
                CALL      PRNTE000
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP3,WTEESSPC
          IF        !@EQUAL
            PACK      KEY5,ANSW,ANSU,WTEESSPC,SP70
            CALL      RDCODE1               * Read a codes file record
            IF        OVRCD<>1
              MOVE      THCSCOD,XSURG       * Surgical speciality
              REP       " 0",XSURG   
              MATCH     "00",XSURG   
              GOTO      WESE1000 IF EQUAL   * Ignore this unit
              MOVE      ZERO,FORM2
              MOVE      XSURG,FORM2
              IF        FORM2<1 | FORM2>11
                MOVE      "R:S147  Surgical Speciality Invalid",ERRMSG
                CALL      PRNTE000              * Print error message
              ENDIF
            ENDIF
          ENDIF
.******************************************** start of changes        *C-101512
....      MATCH   ANSS,XRREM
....      IF      !@EQUAL
....        MATCH   ANSW,XRREM
....        IF      !@EQUAL
....          MATCH   ANSM,XRREM
....          IF      !@EQUAL
....            MATCH   ANSX,XRREM
....            GOTO    WESE2000 IF NOT EQUAL
....          ENDIF
....        ENDIF
....      ENDIF
.
          MOVE     XRREM,ANS
          REP      "M-S-W-X-Y-P-",ANS
          MATCH    "-",ANS
          GOTO     WESE2000 IF NOT EQUAL
.********************************************   end of changes        *C-101512
.
          MATCH    SP70,XINSD
          GOTO     WESE2000 IF NOT EQUAL
.
          MOVE      "S303: Insurance Declaration Invalid ",ERRMSG
          CALL      PRNTE000              * Print error message
.
. Report the treating campus from the parameter PTCNHHDP. If they have
. been treated at another campus WTEETCMP report that instead (STV Only)
.
WESE2000  PACK      XTREAT,PTCNHHDP         * Treating Campus parameter
.
          MATCH     SP70,WTEETCMP
          IF        !@EQUAL
            PACK      XTREAT,WTEETCMP       * Different treating 
          ENDIF                      
.
. Report destination for removal reasons N, P, S, T, or X
.
          MOVE      SP1,KEY1
          MOVE      XRREM,KEY1
          REP       "N1P1S1T1X1",KEY1
          MOVE      ZERO,FORM1
          MOVE      KEY1,FORM1
          IF        FORM1=1
            PACK      XDEST,WTEEDEST,SP70     * Destination
          ENDIF
.
          RJUSTIFY  WTEEPREV
          PACK      XPREV,WTEEREFR,WTEEPREV,SP70
          MATCH     SP70,XPREV
          IF        !@EQUAL
            REP       " 0",XPREV
          ENDIF
.
          SQUEEZE   WTEEPTWT
          MOVE      WTEEPTWT,FORM4
          IF        FORM4<>0
            PACK      XPREVTT,FORM4,SP70
            MATCH     SP70,XPREVTT
            IF        !@EQUAL
              REP       " 0",XPREVTT
            ENDIF
          ENDIF
.
          MATCH     SP70,XREMDT
          IF        !@EQUAL
            MATCH     SP70,XRREM
            IF        @EQUAL
              MOVE      "S395: Removal Date/Reason for Removal mismatch",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     SP70,XRREM
          IF        !@EQUAL
            MATCH     SP70,XREMDT
            IF        @EQUAL
              MOVE      "S395: Removal Date/Reason for Removal mismatch",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     SP70,XADATE
          IF        !@EQUAL
            MOVE      XRREM,DIM1
            REP       "W1S1X1M1B1U1I1Y1K1P1",DIM1          * add Y    *C-101512
            MATCH     "1",DIM1
            IF        !@EQUAL
            MOVE    "S401: Date of Admission/Reason for Removal mismatch",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     SP70,XADATE
          IF        @EQUAL
            MOVE      XRREM,DIM1
            REP       "W1S1X1M1B1U1I1Y1P1",DIM1 * removed K added P for 2016
            MATCH     "1",DIM1
            IF        @EQUAL
            MOVE    "S401: Date of Admission/Reason for Removal mismatch",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     "2",XSRCREF
          IF        @EQUAL
            MATCH     SP70,XPREV
            IF        @EQUAL
      MOVE    "S414: Previous Identifier of Transferred Episode Invalid",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     "2",XSRCREF
          IF        !@EQUAL
            MATCH     SP70,XPREV
            IF        !@EQUAL
      MOVE    "S414: Previous Identifier of Transferred Episode Invalid",ERRMSG
              CALL      PRNTE000              * Print error message
            ENDIF
          ENDIF
.
          IF        DOYR2025=1
            PACK      XSGID,SP70
            PACK      XASAS,SP70
            MATCH     SP70,WTEEASAS 
            IF        @EQUAL
              MATCH     JULY2025,WTEEARDT
              IF        !@LESS
                GOTO      WESE2490
              ELSE
                GOTO      WESE2500
              ENDIF
            ENDIF 
.
            PACK      KEY5,CATAs,WTEEASAS,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,WESE2490
.
            SQUEEZE   THCSCOD 
            PACK      D1,SP70
            MATCH     JULY2025,WTEEARDT
            IF        !@LESS
              MOVE      THCSCOD,D1
            ENDIF
            MOVE      D1,XASAS
.
            MATCH     SP70,D1
            IF        !@EQUAL
              TYPE      D1
              GOTO      WESE2490 IF NOT EQUAL 
              MOVE      D1,F1
              IF        F1<1 | F1>5
                IF        F1 <> 9 
                  MOVE      "R:S444  ASA Score invalid",ERRMSG
                  CALL      PRNTE000
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      WESE2500
.
WESE2490  MOVE      "R:S444  ASA Score invalid",ERRMSG
          CALL      PRNTE000
.
WESE2500  MATCH     SP70,WTEESGID
          GOTO      WESE8000 IF EQUAL            * TSK 0933309
.
          PACK      KEY10,WTEESGID,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,WESE3000
.
          IF        DOYR2025=0
            PACK      XSGID,PMHCMPGN,SP70
            STRIP     PMHCMPGN
            MOVELPTR  PMHCMPGN,LENGTH
          ENDIF
.
          COMPARE   LENGTH,TEN3
          GOTO      WESE8000 IF EQUAL
.
WESE3000  IF        DOYR2025=0
            MOVE     "W:S437 Surgeon Identifier Invalid. Please check HCP and corresponding AHPRA ID and amend",ERRMSG
            CALL      PRNTE000              * Print error message
          ENDIF
.
WESE8000  CALL      WRESE000
.
          IF        COPTION=2
            PACK      WTEEEDAT,TODAY
            REP       " 0",WTEEEDAT
            PACK      WTEEUDAT,TODAY
            REP       " 0",WTEEUDAT
            PACK      WTEEUTIM,CTIMEIS
            REP       " 0",WTEEUTIM
            CALL      UPWTESE2
            PACK      KEY17,SESEKEY,SP70
            CALL      RSWTESE2
          ENDIF
.
          GOTO      WESE1000
.
WESE9999  RETURN
+
.******************************************************************************
.*                                  CDUPE000                                  *
.*                       Check if record already sent today                   *
.******************************************************************************
CDUPE000  MOVE      ZERO,EXIT
          PACK      SAVKEY17,WTEEEDAT,WTEEUNIQ,SP70
          PACK      WTEEEDAT,TODAY
          REP       " 0",WTEEEDAT
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RDWTESE1
          IF        OVRCD<>1
            MOVE      ONE,EXIT
          ENDIF
            PACK      KEY17,SAVKEY17,SP70
            CALL      RDWTESE2
.
CDUPE999  RETURN
+
.**************************************************************************
.*                               WESN0000              Called by: PROC0000*
.*               Extract records from watesnaf                            *
.**************************************************************************
WESN0000  CALL      WRESNH00
          IF        COPTION=1 | COPTION=2
            PACK      TESTKEY,SP70
          ENDIF
.
          IF        COPTION=3
            PACK      TESTKEY,RERDATE,SP70
          ENDIF
.
WESN0500  PACK      KEY36,TESTKEY,SP70
          CALL      RSWTESN3
WESN1000  CALL      RKWTESN3
          BRANCH    OVRCD,WESN9999
.
          MATCH     TESTKEY,WTENEDAT
          GOTO      WESN9999 IF NOT EQUAL
.
          PACK      SESNKEY,WTENEDAT,WTENUNIQ,WTENETYP,WTENEVDT,WTENSADI,SP70
          IF        COPTION=2
            CALL      CDUPN000
            BRANCH    EXIT,WESN1000
          ENDIF
.
          CALL      CLRESN00
.
          CALL      GETTRE00     * ignore 200 procedure codes
          BRANCH    EXIT,WESN1000
.
          CALL      CESP0000                * Check watespaf patient details
.
          PACK      XEPISID,WTENUNIQ,SP70
          REP       " 0",XEPISID
          PACK      XVALUE,WTENEVAL
          PACK      XSADI,SP70      
.
          MATCH     ANSM,WTENETYP
          IF        @EQUAL
            PACK      XEVENTT,MAPT,SP70
          ENDIF
.
          MATCH     ANSU,WTENETYP
          GOTO      WESN1150 IF NOT EQUAL
.
          PACK      XEVENTT,URGENCY,SP70
          MATCH     DELETE,WTENEVAL
          IF        @EQUAL
            PACK      XVALUE,WTENEVAL,SP70
          ELSE
            PACK      KEY5,ANST,ANSP,WTENEVAL,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XVALUE,TCINDC3,SP70
              MOVE      ZERO,FORM1
              STRIP     XVALUE
              MOVE      XVALUE,FORM1
              IF        FORM1<1 | FORM1>3
                MOVE      "R:S161  Clinical Urgency Category Invalid",ERRMSG
                CALL      PRNTN000              * Print error message
              ENDIF
            ENDIF
.
WESN1150    MATCH     SP70,XVALUE
            IF        @EQUAL
   MOVE  "R:S412  Episode registered without a Clinical Urgency Category",ERRMSG
              CALL      PRNTN000              * Print error message
            ENDIF
          ENDIF
.
          MATCH     ANSR,WTENETYP
          IF        @EQUAL
            PACK      XEVENTT,READINS,SP70
            MATCH     DELETE,WTENEVAL
            IF        @EQUAL
              PACK      XVALUE,WTENEVAL,SP70
              GOTO      WESN1200
            ELSE
              PACK      KEY5,ANSV,ANSL,WTENEVAL,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MATCH   SP70,TCINDC5
                IF      !@EQUAL
                  PACK      XVALUE,TCINDC5,SP70
                  MOVE      SP1,KEY1
                  MOVE      XVALUE,KEY1
                  REP       "F1V1",KEY1
                  GOTO      WESN1100
                ENDIF
                PACK      XVALUE,TCINDC1,SP70
              ENDIF
              MATCH     SP70,XVALUE
              IF        @EQUAL
   MOVE      "R:S413  Episode registered without a Readiness for Surgery",ERRMSG
                CALL      PRNTN000              * Print error message
              ENDIF
            ENDIF
            MOVE    SP1,KEY1
            REP     "DP",XVALUE
            MOVE    XVALUE,KEY1
            REP     "R1C2P2S2V1",KEY1
.
WESN1100    MOVE    ZERO,FORM1
            MOVE    KEY1,FORM1
            IF      FORM1<1 | FORM1>2
              MOVE      "R:S265  Readiness Status Invalid",ERRMSG
              CALL      PRNTN000              * Print error message
            ENDIF
          ENDIF
.
WESN1200  MATCH     ANSS,WTENETYP
          IF        @EQUAL
            PACK      XEVENTT,SETSAD,SP70
            MATCH     DELETE,XVALUE
            IF        !@EQUAL
              UNPACK    XVALUE,CCENT,CYEAR,CMON,CDAY
              PACK      XVALUE,CDAY,CMON,CCENT,CYEAR,SP70
            ENDIF
            MOVE      WTENSADI,XSADI
            SQUEEZE   XSADI
            RJUSTIFY  XSADI
            REP       " 0",XSADI
          ENDIF
.
          MATCH     ANSP,WTENETYP
          GOTO      WESN2000 IF NOT EQUAL
.
          MATCH     SP70,WTENEVAL
          IF        @EQUAL
            MOVE      "R:S279  Invalid Reason for Rebooking",ERRMSG
            CALL      PRNTN000              * Print error message
          ENDIF
.
          PACK      XEVENTT,POSTSAD,SP70
          COMPARE   ONE,CTHETR
          IF        @EQUAL
            PACK      KEY5,ANSS,ANSC,WTENEVAL,SP70
          ELSE
            PACK      KEY5,ANSB,ANSC,WTENEVAL,SP70
          ENDIF
.
          CALL      RDCODE1
          BRANCH    OVRCD,WESN1600
.
WESN1500  PACK      XVALUE,THCSCOD,SP70
          MOVE      ZERO,FORM3
          STRIP     XVALUE
          MOVE      XVALUE,FORM3
          PACK      XVALUE,XVALUE,SP70
          IF        (FORM3>99&FORM3<112)|(FORM3>118&FORM3<125)|(FORM3=130)
            GOTO      WESN1600
          ENDIF
          MOVE      "R:S279  Invalid Reason for Rebooking",ERRMSG
          CALL      PRNTN000              * Print error message
.
WESN1600  MOVE      WTENSADI,XSADI
          SQUEEZE   XSADI
          RJUSTIFY  XSADI
          REP       " 0",XSADI
.
WESN2000  MATCH     SP70,WTENEVDT
          IF        !@EQUAL
            UNPACK    WTENEVDT,CCENT,CYEAR,CMON,CDAY
            PACK      XEDAT,CDAY,CMON,CCENT,CYEAR
            REP       " 0",XEDAT
          ENDIF
.
          CALL      WRESN000
.
          IF        COPTION=2
            PACK      WTENEDAT,TODAY
            REP       " 0",WTENEDAT
            PACK      WTENUDAT,TODAY
            REP       " 0",WTENUDAT
            PACK      WTENUTIM,CTIMEIS
            REP       " 0",WTENUTIM
            CALL      UPWTESN3
            PACK      KEY36,SESNKEY,SP70
            CALL      RSWTESN3
          ENDIF
.
          GOTO      WESN1000
.
WESN9999  RETURN
+
.**************************************************************************
.*                               WESM0000              Called by: PROC0000*
.*               Extract records from watesmaf                            *
.**************************************************************************
WESM0000  CALL      WRESMH00
          IF        COPTION=1 | COPTION=2
            PACK      TESTKEY,SP70
          ENDIF
.
          IF        COPTION=3
            PACK      TESTKEY,RERDATE,SP70
          ENDIF
.
WESM0500  PACK      KEY24,TESTKEY,SP70
          CALL      RSWTESM2
WESM1000  CALL      RKWTESM2
          BRANCH    OVRCD,WESM9999
.
          MATCH     TESTKEY,WTEMEDAT
          GOTO      WESM9999 IF NOT EQUAL
.
          PACK      SESMKEY,WTEMEDAT,WTEMCURN,WTEMRURN,SP70
          IF        COPTION=2
            CALL      CDUPM000
            BRANCH    EXIT,WESM1000
          ENDIF
.
          CALL      CLRESM00
.
          PACK      XCEASID,SP2,WTEMCURN,SP70
          REP       " 0",XCEASID
          PACK      XRETAID,SP2,WTEMRURN,SP70
          REP       " 0",XRETAID
.
          CALL      WRESM000
.
          IF        COPTION=2
            PACK      WTEMEDAT,TODAY
            REP       " 0",WTEMEDAT
            CALL      UPWTESM2
            PACK      KEY24,SESMKEY,SP70
            CALL      RSWTESM2
          ENDIF
.
          GOTO      WESM1000
.
WESM9999  RETURN
+
.******************************************************************************
.*                                  CDUPM000                                  *
.*                       Check if record already sent today                   *
.******************************************************************************
CDUPM000  MOVE      ZERO,EXIT
          PACK      SAVKEY24,WTEMEDAT,WTEMCURN,WTEMRURN,SP70
          PACK      WTEMEDAT,TODAY
          REP       " 0",WTEMEDAT
          PACK      KEY24,WTEMCURN,WTEMRURN,WTEMEDAT,SP70
          CALL      RDWTESM1
          IF        OVRCD<>1
            MOVE      ONE,EXIT
          ENDIF
            PACK      KEY24,SAVKEY24,SP70
            CALL      RDWTESM2
.
CDUPM999  RETURN
+
.------------------------------------------------------------
. Get treatment detail for unique ID
.------------------------------------------------------------
GETTRE00  MOVE      ZERO,EXIT
          MOVE      ZERO,F1
.
          PACK      KEY17,WTENUNIQ,Z70
          CALL      RSWTESE1
GETTRE10  CALL      RPWTESE1
          BRANCH    OVRCD,GETTRE90
.
          MATCH     WTENUNIQ,WTEEUNIQ
          GOTO      GETTRE90 IF NOT EQUAL
.
GETTRE15  PACK      KEY19,WTEEURNO,SP70
          CALL      RDSTREA1
GETTRE20  CALL      RDKTREA1
          BRANCH    OVRCD,GETTRE65
.
          MATCH     WMURNO,WTEEURNO
          GOTO      GETTRE65 IF NOT EQUAL
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      GETTRE20 IF NOT EQUAL
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1               * Read a procedure file record
          BRANCH    OVRCD,GETTRE80
.
. **** read last record on the procedure HDP history table
          PACK      KEY17,WMCODE,WMKEYDT,SP70
          CALL      RSWTPHI1
          CALL      RKWTPHI1
          BRANCH    OVRCD,GETTRE50
.
          MATCH     WMCODE,WTPHPROC
          GOTO      GETTRE50 IF NOT EQUAL
.
          PACK      WTWPHDPE,WTPHHDPV,SP70
.
GETTRE50  PACK      WTWPHDPE,WTWPHDPE,SP70
          UNPACK    WTWPHDPE,DIM2,DIM3
          MATCH     "IP",DIM2
          IF        @EQUAL
            PACK      WTWPHDPE,DIM3,SP70
          ENDIF
          SQUEEZE   WTWPHDPE
          MOVE      ZERO,F5
          MOVE      WTWPHDPE,F5
          IF        F5=200
            GOTO      GETTRE70 * Ignore this procedure
          ENDIF
.
          IF        F5>499 & F5<887
            GOTO      GETTRE70 * Ignore this procedure
          ENDIF
.
          MATCH     SP70,WTEEREMD
          IF        !@EQUAL
            MATCH     WTESSDAT,WTEEREMD   * Removed before seal date?
            GOTO      GETTRE85 IF LESS    * Skip
          ENDIF
.
          GOTO      GETTRE99
.
GETTRE65  IF        F1>8
            GOTO      GETTRE95    *  just in case of loop in merge table
          ENDIF
.
.  *****  try merged UR's as wateseaf sent records are not updated with new ur
          ADD       ONE,F1
          PACK      KEY17,THREE,WTEEURNO,SP70
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,GETTRE95
.
          MATCH     PTMROLUR,WTEEURNO
          GOTO      GETTRE95 IF NOT EQUAL
.
          PACK      WTEEURNO,PTMRNWUR
          GOTO      GETTRE15
.
GETTRE70  MOVE      "Not sending - Procedure Code 200 or 500",ERRMSG
......    CALL      PRNS0000
          MOVE      ONE,EXIT
          GOTO      GETTRE99
.
GETTRE80  MOVE      "Invalid Procedure Record ",ERRMSG
          CALL      PRNS0000
          MOVE      ONE,EXIT
          GOTO      GETTRE99
.
GETTRE85  MOVE      "Removed Before seal date ",ERRMSG
          MATCH     "20160701",WMDATE1
          IF        !@LESS
            CALL      PRNS0000
          ENDIF
          MOVE      ONE,EXIT
          GOTO      GETTRE99
.
GETTRE90  MOVE      ONE,EXIT
          MOVE      "ESIS Episode record not found ",ERRMSG
          CALL      PRNS0000
          GOTO      GETTRE99
.
GETTRE95  MOVE      ONE,EXIT
          MOVE      "Waiting list treatment record not found ",ERRMSG
          CALL      PRNS0000
          GOTO      GETTRE99
.
GETTRE99  RETURN
+
.******************************************************************************
.*                                  CDUPN000                                  *
.*                       Check if record already sent today                   *
.******************************************************************************
CDUPN000  MOVE      ZERO,EXIT
          PACK      SAVKEY36,WTENEDAT,WTENUNIQ,WTENETYP,WTENEVDT,WTENSADI,SP70
          PACK      WTENEDAT,TODAY
          REP       " 0",WTENEDAT
          PACK      KEY36,WTENUNIQ,WTENEDAT,WTENETYP,WTENEVDT,WTENSADI,SP70
          CALL      RDWTESN2
          IF        OVRCD<>1
            MOVE      ONE,EXIT
            MOVE      "Record already sent today ",ERRMSG
            CALL      PRNS0000
          ENDIF     
          PACK      KEY36,SAVKEY36,SP70
          CALL      RDWTESN3
.
CDUPN999  RETURN
+
CLRESP00  PACK      XPATID,SP70
          PACK      XDOB,SP70
          PACK      XEDOB,SP70
          PACK      XSEX,SP70
          PACK      XMEDNUM,SP70
          PACK      XMEDSUF,SP70
          PACK      XPOST,SP70
          PACK      XLOCAL,SP70
          PACK      XINDIG,SP70
          PACK      XGEN,SP70 
          PACK      XNDIS,SP70 
.
CLRESP99  RETURN
+
CLRESE00  PACK      XEPISID,SP70
          PACK      XPATID,SP70
          PACK      XADATE,SP70
          PACK      XDEST,SP70
          PACK      XINSD,SP70
          PACK      XPLOS,SP70
          PACK      XPPP,SP70
          PACK      XPPPDES,SP70
          PACK      XRREM,SP70
          PACK      XREG,SP70
          PACK      XREMDT,SP70
          PACK      XSRCREF,SP70
          PACK      XSURG,SP70
          PACK      XTREAT,SP70
          PACK      XPREV,SP70
          PACK      XPREVTT,SP70
          PACK      XARDT,SP70
          PACK      XSGID,SP70
          PACK      XREFA,SP70
.
CLRESE99  RETURN
+
CLRESN00  PACK      XEPISID,SP70
          PACK      XEVENTT,SP70
          PACK      XEDAT,SP70
          PACK      XVALUE,SP70
          PACK      XSADI,SP70
.
CLRESN99  RETURN
+
CLRESM00  PACK      XCEASID,SP70
          PACK      XRETAID,SP70
.
CLRESM99  RETURN
.**************************************************************************
.*                               RECN0000              Called by: PROC0000* 
.*                Create reconciliation table                             *
.**************************************************************************
RECN0000  CALL      WRRECH00
          MOVE      ZERO,REGYTD
          MOVE      ZERO,REMYTD
          PACK      KEY19,SP70
          CALL      RDSTREA1
RECN1000  CALL      RDKTREA1
          BRANCH    OVRCD,RECN3000
.
          MATCH     "20040701",WMKEYDT
          GOTO      RECN2000 IF NOT LESS
.
          ADD       ONE,REGYTD
.
RECN2000  MATCH     "20040701",WMREMOVE
          GOTO      RECN1000 IF LESS
.
          ADD       ONE,REMYTD
          GOTO      RECN1000
.
RECN3000  MOVE      "1",XAGGID
          MOVE      "Number of registration year-to-date",XAGGDESC
          MOVE      REGYTD,XAGGVAL
          CALL      WRREC000
.
          MOVE      "2",XAGGID
          MOVE      "Number of removals year-to-date",XAGGDESC
          MOVE      REMYTD,XAGGVAL
          CALL      WRREC000
.
RECN9999  RETURN
+
WRESP000  IF        DOYR2025=1
            WRITE     ESP1,SEQ;XPATID,DEL,XDOB,DEL,XEDOB,DEL,XINDIG,DEL:
                               XSEX,DEL,XMEDNUM,DEL,XMEDSUF,DEL,XPOST,DEL:
                               XLOCAL,DEL,XGEN,DEL,XNDIS

          ELSE
            WRITE     ESP1,SEQ;XPATID,DEL,XDOB,DEL,XEDOB,DEL,XINDIG,DEL:
                               XSEX,DEL,XMEDNUM,DEL,XMEDSUF,DEL,XPOST,DEL:
                               XLOCAL,DEL,XGEN
          ENDIF
.
WRESP999  RETURN
+
WRESPH00  IF        DOYR2025=1
            WRITE     ESP1,SEQ;"Patient_Identifier",DEL,"Date_Of_Birth",DEL:
                               "DOB_Accuracy_Code",DEL:
                               "Indigenous_Status",DEL:
                               "Sex",DEL,"Medicare_Number",DEL:
                               "Medicare_Suffix",DEL,"Postcode",DEL:
                               "Locality",DEL,"Gender",DEL,"NDIS"
          ELSE
            WRITE     ESP1,SEQ;"Patient_Identifier",DEL,"Date_Of_Birth",DEL:
                               "DOB_Accuracy_Code",DEL:
                               "Indigenous_Status",DEL:
                               "Sex",DEL,"Medicare_Number",DEL:
                               "Medicare_Suffix",DEL,"Postcode",DEL:
                               "Locality",DEL,"Gender"
          ENDIF
.
WRESPH99  RETURN
+
WRESE000  IF        DOYR2025=1 
            WRITE     ESE1,SEQ;XEPISID,DEL,XPATID,DEL,XADATE,DEL,XDEST,DEL:
                               XINSD,DEL,XPLOS,DEL,XPPP,DEL,XPPPDES,DEL:
                               XRREM,DEL,XARDT,DEL,XREG,DEL,XREMDT,DEL:
                               XSRCREF,DEL:
                               XSURG,DEL,XTREAT,DEL,XPREV,DEL,XPREVTT:
                               DEL,XSGID,DEL,XREFA,DEL,XASAS
          ELSE
            WRITE     ESE1,SEQ;XEPISID,DEL,XPATID,DEL,XADATE,DEL,XDEST,DEL:
                               XINSD,DEL,XPLOS,DEL,XPPP,DEL,XPPPDES,DEL:
                               XRREM,DEL,XARDT,DEL,XREG,DEL,XREMDT,DEL:
                               XSRCREF,DEL:
                               XSURG,DEL,XTREAT,DEL,XPREV,DEL,XPREVTT:
                               DEL,XSGID,DEL,XREFA
          ENDIF
.
WRESE999  RETURN
+
WRESEH00  IF       DOYR2025=1
            WRITE    ESE1,SEQ;"Episode_Identifier",DEL,"Patient_Identifier",DEL:
                              "Date_Of_Admission",DEL:
                              "Destination",DEL:
                              "Insurance_Declaration",DEL:
                              "Planned_Length_Of_Stay",DEL:
                              "Intended_Procedure",DEL:
                              "IP_Description",DEL:
                              "Reason_For_Removal",DEL:
                              "Administrative_Registration_Date",DEL:
                              "Clinical_Registration_Date",DEL:
                              "Removal_Date",DEL,"Source_Of_Referral",DEL:
                              "Surgical_Specialty",DEL,"Treatment_Campus",DEL:
                              "Previous_Identifier_of_Transferred_Episode",DEL:
                              "Previous_TWT",DEL,"Surgeon_ID",DEL:
                              "Referral_Accepted_Date",DEL,"ASA_Score"
          ELSE
            WRITE    ESE1,SEQ;"Episode_Identifier",DEL,"Patient_Identifier",DEL:
                              "Date_Of_Admission",DEL:
                              "Destination",DEL:
                              "Insurance_Declaration",DEL:
                              "Planned_Length_Of_Stay",DEL:
                              "Intended_Procedure",DEL:
                              "IP_Description",DEL:
                              "Reason_For_Removal",DEL:
                              "Administrative_Registration_Date",DEL:
                              "Clinical_Registration_Date",DEL:
                              "Removal_Date",DEL,"Source_Of_Referral",DEL:
                              "Surgical_Specialty",DEL,"Treatment_Campus",DEL:
                              "Previous_Identifier_of_Transferred_Episode",DEL:
                              "Previous_TWT",DEL,"Surgeon_ID",DEL:
                              "Referral_Accepted_Date"
          ENDIF
.
WRESEH99  RETURN
+
WRESMH00  WRITE     ESM1,SEQ;"Ceased_Patient_Identifier",DEL:
                             "Retained_Patient_Identifier"
.
WRESMH99  RETURN
+
WRESM000  WRITE     ESM1,SEQ;XCEASID,DEL,XRETAID
.
WRESM999  RETURN
+
WRESN000  WRITE     ESN1,SEQ;XEPISID,DEL,XEVENTT,DEL,XEDAT,DEL,XVALUE,DEL:
                             XSADI
.
WRESN999  RETURN
+
WRESNH00  WRITE     ESN1,SEQ;"Episode_Identifier",DEL,"Event_Type",DEL:
                             "Event_Date",DEL,"Event_Value",DEL:
                             "SAD_Identifier"
.
WRESNH99  RETURN
.
WRRECH00  WRITE     REC1,SEQ;"Aggregate_Identifier",DEL:
                             "Aggregate_Description",DEL:
                             "Aggregate_Value"
.
WRRECH99  RETURN
.
WRREC000  WRITE     REC1,SEQ;XAGGID,DEL,XAGGDESC,DEL,XAGGVAL
.
WRREC999  RETURN
+
.******************************************************************************
.*                                  PRNT0000                                  *
.*                             Print Error Message                            *
.******************************************************************************
PRNT0000  COMPARE   CLNO,FIFTY8
          CALL      HEAD0000 IF LESS        * Print report header
.
          PACK      ERRMSG,ERRMSG,SP70
          PRINT     *1,"|",WTEPURNO,*15,"|         ",*30,"|",ERRMSG,"|"
          ADD       ONE,CLNO
          PACK      ERRMSG,SP70
.
PRNT9000  MOVE      ZERO,EXIT
PRNT9999  RETURN
+
.******************************************************************************
.*                                  PRNS0000                                  *
.*                             Print Error Message                            *
.******************************************************************************
PRNS0000  COMPARE   CLNO,FIFTY8
          CALL      HEAD0000 IF LESS        * Print report header
.
          PACK      ERRMSG,ERRMSG,SP70
          PRINT     *1,"|",WTENUNIQ,*15,"| WTENUNIQ ",*30,"|",ERRMSG,"|"
          ADD       ONE,CLNO
          PACK      ERRMSG,SP70
.
PRNS9999  RETURN
+
.******************************************************************************
.*                                  PRNTE000                                  *
.*                             Print Error Message                            *
.******************************************************************************
PRNTE000  COMPARE   CLNO,FIFTY8
          CALL      HEAD0000 IF LESS        * Print report header
.
          PACK      ERRMSG,ERRMSG,SP70
          PRINT     *1,"|",WTEEURNO,*15,"|",WTEEUNIQ,*30,"|",ERRMSG,"|"
          ADD       ONE,CLNO
          PACK      ERRMSG,SP70
.
PRNTE900  MOVE      ZERO,EXIT
PRNTE999  RETURN
+
.******************************************************************************
.*                                  PRNTN000                                  *
.*                             Print Error Message                            *
.******************************************************************************
PRNTN000  COMPARE   CLNO,FIFTY8
          CALL      HEAD0000 IF LESS        * Print report header
.
          PACK      ERRMSG,ERRMSG,SP70
          PACK      KEY17,WTENUNIQ,Z70
          CALL      RSWTESE1
PRNTN100  CALL      RPWTESE1
          BRANCH    OVRCD,PRNTN200
.
          MATCH     WTENUNIQ,WTEEUNIQ
          GOTO      PRNTN300 IF EQUAL
.
PRNTN200  MOVE      SP70,WTEEURNO
.
PRNTN300  PRINT     *1,"|",WTEEURNO,*15,"|",WTENUNIQ,*30,"|",ERRMSG,"|"
          ADD       ONE,CLNO
          PACK      ERRMSG,SP70
.
PRNTN900  MOVE      ZERO,EXIT
PRNTN999  RETURN
+
.******************************************************************************
.*                                  CHKSN000              Called by: OPTN0000 *
.*                    Check sent table and get run number                     *
.******************************************************************************
CHKSN000  MOVE      ZERO,EXIT
          PACK      CPTDATE,TODAY
          CALL      GPERD
          BRANCH    EXIT,OPTN9500
          PACK      KEY7,DRGYR,Z70
          CALL      RSWTESS1
          CALL      RPWTESS1
          BRANCH    OVRCD,CHKSN100
.
          MATCH     TODAY,WTSSDATE
          GOTO      CHKSN910 IF NOT LESS
.
CHKSN100  MOVE      WTSSRUNN,F3
          MATCH     DRGYR,WTSSYEAR
          IF        !@EQUAL
            MOVE      DRGYR,WTSSYEAR
            MOVE      ZERO,F3
          ENDIF
          ADD       ONE,F3
          MOVE      F3,WTSSRUNN
          REP       " 0",WTSSRUNN
          PACK      WTSSDATE,TODAY
          REP       " 0",WTSSDATE
.
          IF        COPTION=2
            PACK      KEY7,DRGYR,WTSSRUNN,SP70
            CALL      WRWTESS1
          ENDIF
          MOVE      WTSSRUNN,RUNNUM
.
          GOTO      CHKSN999
.
CHKSN910  PRINT     *1,"Extract already run up to this date"
          MOVE      ONE,EXIT
.
CHKSN999  RETURN
+
.******************************************************************************
.*                                  HEAD0000              Called by: ML0000   *
.*                             Print Report Header                            *
.******************************************************************************
HEAD0000  CALL      HEAD132                 * Print report header
          PRINT     *N;
          BRANCH    COPTION,HEAD1000,HEAD2000,HEAD3000
.
HEAD1000  PRINT     "Test Extraction"
          GOTO      HEAD4000
.
HEAD2000  PRINT     "Final Extraction"
          GOTO      HEAD4000
.
HEAD3000  UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *35,"Re-Run Extraction for ",CPCDATE
          GOTO      HEAD4000
.
HEAD4000  CALL      UND132
          PRINT     *1,"| U/R No ",*15,"|Unique ID  ",*30,"|Error Message":
                    *132,"|"
          CALL      UND132
          ADD       "2",CLNO
.
HEAD9999  RETURN
.------------------------------------------------------------
. Move Extract to Web Directory
.------------------------------------------------------------
MVEXT000  CLEAR     CMDLINE                 * header file
          UNPACK    RERDATE,CCENT,CYEAR,CMON,CDAY
          CLEAR     CMDLINE
          APPEND    "ibawat72.us1 ",CMDLINE
          APPEND    FILENAM5,CMDLINE
          APPEND    ".txt ",CMDLINE
          CALL      APPSC000
          APPEND    ANSM,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CLEAR     CMDLINE                 * header file
          UNPACK    RERDATE,CCENT,CYEAR,CMON,CDAY
          CLEAR     CMDLINE
          APPEND    "ibawat72.us1 ",CMDLINE
          APPEND    FILENAM4,CMDLINE
          APPEND    ".txt ",CMDLINE
          CALL      APPSC000
          APPEND    ANSR,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CLEAR     CMDLINE
          APPEND    "ibawat72.us1 ",CMDLINE
          APPEND    FILENAM3,CMDLINE
          APPEND    ".txt ",CMDLINE
          CALL      APPSC000
          APPEND    ANSI,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CLEAR     CMDLINE
          APPEND    "ibawat72.us1 ",CMDLINE
          APPEND    FILENAM2,CMDLINE
          APPEND    ".txt ",CMDLINE
          CALL      APPSC000
          APPEND    ANSE,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CLEAR     CMDLINE
          APPEND    "ibawat72.us1 ",CMDLINE
          APPEND    FILENAM1,CMDLINE
          APPEND    ".txt ",CMDLINE
          CALL      APPSC000
          APPEND    ANSP,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
MVEXT999  RETURN
.------------------------------------------------------------
. Append common fields for us1 script
.------------------------------------------------------------
APPSC000  APPEND    PTCNHHDP,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    CYEAR,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    CMON,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    CDAY,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    RUNNUM,CMDLINE
          IF        COPTION=1
            APPEND    " Test ",CMDLINE
          ENDIF
          IF        COPTION=2
            APPEND    " Final ",CMDLINE
          ENDIF
          IF        COPTION=3
            APPEND    " Re-run ",CMDLINE
          ENDIF
APPSC999  RETURN
.
.------------------------------------------------------------
. When reporting an admission date in the episode record.
. Check if there is an equivalent set SAD for this date
. in the intra episode file. Error S295
.------------------------------------------------------------
CSAD0000  COMPARE   TWO,COPTION             
          GOTO      CSAD9999 IF EQUAL
.
          MATCH     SP70,WTEEADAT
          GOTO      CSAD9999 IF EQUAL
.
          PACK      KEY36,WTEEUNIQ,ANSS,SP70
          CALL      RSWTESN5
CSAD1000  CALL      RKWTESN5
          BRANCH    OVRCD,CSAD9999
.
          MATCH     WTEEUNIQ,WTENUNIQ       * Same unique number
          GOTO      CSAD9999 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP           * Set SAD
          GOTO      CSAD9999 IF NOT EQUAL
.
          MATCH     "DELETE",WTENEVAL       * Skip delete set SAD
          GOTO      CSAD1000 IF EQUAL
.
          MATCH     SP8,WTENEDAT            * skip set SAD if already 'sent'
          GOTO      CSAD1000 IF NOT EQUAL
.
          PACK      SAVKEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
          MOVE      WTENSADI,SAVESADI
.
          PACK      KEY36,WTEEUNIQ,ANSP,WTENSADI,SP70
          CALL      RSWTESN5
CSAD2000  CALL      RKWTESN5
          BRANCH    OVRCD,CSAD5000
.      
          MATCH     WTEEUNIQ,WTENUNIQ       * Same unique number
          GOTO      CSAD5000 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP           * Reason for change
          GOTO      CSAD5000 IF NOT EQUAL
.
          MATCH     SAVESADI,WTENSADI       * Set scheduled admission no
          GOTO      CSAD5000 IF NOT EQUAL
.
          MOVE      SAVKEY36,KEY36
          CALL      RDWTESN5                * Position on set SAD
          BRANCH    OVRCD,CSAD9999
.
          GOTO      CSAD1000
.
CSAD5000  MOVE      SAVKEY36,KEY36
          CALL      RDWTESN5                * Position on set SAD
          BRANCH    OVRCD,CSAD9999
.
          MATCH     WTEEADAT,WTENEVAL       * Admission date greater than
.******************************************** start of addition        *I-86155
          GOTO      CSAD9000 IF LESS
.
          PACK      DIM8,WTENEVAL,SP70
          MATCH     DIM8,WTEEADAT       * SAD greater than Admiss date
          GOTO      CSAD9100 IF LESS
.
          GOTO      CSAD9999
.
.CSAD6000  PACK      KEY10,WTENSADI,SP10     * SAD Identifier
.          CALL      RDOPDEA3                * read Oper. Details for Admiss.No.
.          BRANCH    OVRCD,CSAD9000
.          PACK      KEY8,OPDAADMN,SP10
.          CALL      RDPTMIS1               * read Admission recd for Admiss dat
.          BRANCH    OVRCD,CSAD9999
..
.          MATCH     ADATE,WTEEADAT          * Admis Date equal Sched Admis Date
.          GOTO      CSAD9999 IF EQUAL
.********************************************   end of addition        *I-86155
.
CSAD9000  CLEAR     ERRMSG
          APPEND    "R:S295  Date of Admission greater than ",ERRMSG
          APPEND    "Scheduled Admission Date",ERRMSG
          RESET     ERRMSG
.
          CALL      PRNTE000                * Print error message
          GOTO      CSAD9999
.
CSAD9100  CLEAR     ERRMSG
          APPEND    "W:S297  Date of Admission less than ",ERRMSG
          APPEND    "Scheduled Admission Date",ERRMSG
          RESET     ERRMSG
.
          CALL      PRNTE000                * Print error message
.
CSAD9999  RETURN
.
.-----------------------------------------------------------------------------
. CHKSTS00 - Check waiting list suspension status at admission date
.-----------------------------------------------------------------------------
CSUS0000  COMPARE   TWO,COPTION
          GOTO      CSUS9999 IF EQUAL
.
          MATCH     SP70,WTEEADAT
          GOTO      CSUS9999 IF EQUAL
.
          MOVE      WTEEADAT,DATE1
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
CSUS1000  CALL      RKWTSUS1
          BRANCH    OVRCD,CSUS9999
.
          MATCH     WMURNO,WTSUURNO
          GOTO      CSUS9999 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      CSUS9999 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      CSUS9999 IF NOT EQUAL
.
          MOVE      SP70,TCINDC4
          PACK      KEY5,ANSV,ANSL,WTSULSTS,SP70
          CALL      RDCODE1
.
          MATCH     ANSR,TCINDC1                 * Ignore if RFC Suspension
          GOTO      CSUS1000 IF EQUAL
.
          MOVE      ZERO,DATE2
          MOVE      ZERO,DATE3
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,DATE3
.
          IF        DATE1 >= DATE2
            COMPARE   ZERO,DATE3
            GOTO      CSUS9000 IF EQUAL
          ENDIF
.
          IF        DATE1 >= DATE2 & DATE1 < DATE3
            GOTO      CSUS9000
          ENDIF
.
          GOTO      CSUS1000
.
CSUS9000  CLEAR     ERRMSG
          APPEND    "R:S296  Reason For Removal Implies Procedure ",ERRMSG
          APPEND    "Received But Not Ready For Care",ERRMSG
          RESET     ERRMSG
.
          CALL      PRNTE000                * Print error message
.
          GOTO      CSUS9999

CSUS9999  RETURN
.
+
.------------------------------------------------------------
. Get treatment detail for unique ID
.------------------------------------------------------------
GETT0000  MOVE      ZERO,EXIT
.
          PACK      KEY19,WTEEURNO,SP70
          CALL      RDSTREA1
GETT1000  CALL      RDKTREA1
          BRANCH    OVRCD,GETT9000
.
          MATCH     WMURNO,WTEEURNO
          GOTO      GETT9000 IF NOT EQUAL
.
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      GETT1000 IF NOT EQUAL
.
          GOTO      GETT9999
.
GETT9000  MOVE      ONE,EXIT
.
GETT9999  RETURN
.
.******************************************************************************
.*        Created for TSK 0911056                                             *
.*        Requires DSEXCHAR as input                                          *
.*        Returns  DSEXDESC    8 character description                        *
.*                 DSEXNO      Form 1 field for Cat.G Indc.5                  *
.******************************************************************************
SEXDSC00  MOVE      NINE,DSEXNO             * default 9
.
          PACK      KEY5,ANSG,SP1,DSEXCHAR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SEXDSC90
.
          MOVE      ZERO,F1
          MOVE      TCINDC5,F1
          MOVE      F1,DSEXNO
.
          PACK      DSEXDESC,TDESC,SP70
          GOTO      SEXDSC99
.
SEXDSC90  MOVE      "Invalid Sex",DSEXDESC
.
SEXDSC99  RETURN
+
.
.******************************************************************************
.*        Created for TSK 0928366                                             *
.*        Requires DGENCHAR as input                                          *
.*        Returns  DGENDESC    8 character description                        *
.*                 DGENNO      Form 1 field for Cat.G Indc.11                 *
.******************************************************************************
IDTGEN00  MOVE      NINE,DGENNO             * default 9
.
          PACK      KEY5,CATGI,DGENCHAR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,IDTGEN90
.
          SQUEEZE   THCSCOD
          MOVE      ZERO,F1
          MOVE      THCSCOD,F1
          MOVE      F1,DGENNO
.
          PACK      DGENDESC,TDESC,SP70
          GOTO      IDTGEN99
.
IDTGEN90  MOVE      "Invalid Identifying Gender",DGENDESC
.
IDTGEN99  RETURN
+
.******************************************************************************
.* Identifying gender. Now mandatory and never reported or triggered to report*
.******************************************************************************
.* For all patients being reported in this extract run. If there are no       *
.* patient details to report in watespaf and it wasn't reported today. Check  *
.* what we sent in the last extract is update to date and re-report in needed *
.******************************************************************************
CESP0000  COMPARE   ONE,COPTION           * Validation
          GOTO      CESP1000 IF EQUAL
.
          COMPARE   TWO,COPTION           * Final
          GOTO      CESP1000 IF EQUAL
.
          GOTO      CESP9999
.
CESP1000  PACK      KEY16,WMURNO,SP70
          CALL      RDWTESP1              * Any patient details to report
          COMPARE   ZERO,OVRCD            * Yes exit
          GOTO      CESP9999 IF EQUAL
.
          PACK      KEY8,TODAY
          REP       " 0",KEY8
          PACK      KEY16,WMURNO,KEY8,SP70
          CALL      RDWTESP1              * Any patient details reported today
          COMPARE   ZERO,OVRCD            * Yes exit
          GOTO      CESP9999 IF EQUAL
.
          PACK      KEY8,WMURNO,SP70
          CALL      RDMAST1               * Read PMI
          BRANCH    OVRCD,CESP9999
.
          PACK      KEY8,PURNO,SP70
          CALL      RDPMPX21              * Read PMI Extn 2
          BRANCH    OVRCD,CESP9999
.
          CALL      WESIS000              * write any ESIS PMI detail changes
.
CESP9999  RETURN
.
.******************************************************************************
.*                                 WESIS000                                   *
.*                           Write/update watespaf                            *
.******************************************************************************
WESIS000  PACK      KEY16,PURNO,Z70
          CALL      RSWTESP1
          CALL      RPWTESP1
          BRANCH    OVRCD,WESIS999
.
          MATCH     PURNO,WTEPURNO
          GOTO      WESIS999 IF NOT EQUAL
.
          CALL      CHKESI00
          BRANCH    EXIT,WESIS999   * no changes
.
          GOTO      WESIS200
.
WESIS200  PACK      WTEPURNO,PURNO
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,PBDATE,SP70
          PACK      WTEPEDOB,PMPXEDOB,SP70
          PACK      WTEPPSEX,PSEX,SP70
          PACK      WTEPMEDI,PMEDI,SP70
          SQUEEZE   PTMXMCCD
          PACK      WTEPMREF,PTMXMCCD,SP70
          PACK      WTEPRESI,PTYPE,SP70
          PACK      WTEPPOST,PPOST,SP70
          PACK      WTEPSUBR,PSUBRB,SP70
          PACK      WTEPABRG,PMPXABRG,SP70
          PACK      WTEPPGEN,PMPXUCC4,SP70
          PACK      WTEPSPAR,SP70
.
          PACK      KEY16,PURNO,SP70
          CALL      RAWTESP1
          IF        OVRCD=1
            MOVE      "IBAWAT72  ",WTEPWEBC
            PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPCDAT
            PACK      WTEPCTIM,CTIMEIS,SP70
            REP       " 0",WTEPCTIM
            CALL      WRWTESP1
          ELSE
            MOVE      "IBAWAT72  ",WTEPWEBC
            PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS,SP70
            REP       " 0",WTEPUTIM
            CALL      UPWTESP1
          ENDIF
.
WESIS999  RETURN
.
.******************************************************************************
.*                                 CHKESI00                                   *
.*                 Check if any ESIS have changed since last sent             *
.******************************************************************************
.
CHKESI00  MOVE      ZERO,EXIT
.
          MATCH     WTEPPDOB,PBDATE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPEDOB,PMPXEDOB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPSEX,PSEX
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPMEDI,PMEDI
          GOTO      CHKESI90 IF NOT EQUAL
.
          SQUEEZE   PTMXMCCD
          MATCH     WTEPMREF,PTMXMCCD
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPRESI,PTYPE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPOST,PPOST
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPSUBR,PSUBRB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPABRG,PMPXABRG
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPGEN,PMPXUCC4
          GOTO      CHKESI90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESI90  GOTO      CHKESI99
.
CHKESI99  RETURN
CLRWTESI  PACK      WTEPURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,SP70
          PACK      WTEPCDAT,SP70
          PACK      WTEPCTIM,SP70
          PACK      WTEPWEBU,SP70
          PACK      WTEPUDAT,SP70
          PACK      WTEPUTIM,SP70
          PACK      WTEPPGEN,SP70
          PACK      WTEPNDIS,SP70
          PACK      WTEPSPAR,SP70
.
          RETURN
+
. =========================================================================
.         I/O Includes
. =========================================================================
. =========================================================================
.         I/O Includes
. =========================================================================
.
          INC       STD001IO
          INC       CHKMEDI
          INC       CALCAGE                 * Calculate a patients age
          INC       CALCDAYS                * Calculate the diff between dates
          INC       PATCOMN3
          INC       WATESSIO/INC
          INC       WATESTIO/INC
          INC       WATESNIO/INC
          INC       WATESMIO/INC
          INC       WATESEIO/INC
          INC       WATESPIO/INC
          INC       WATPROIO/INC
          INC       WATPHIIO/INC
          INC       WATTR1IO/INC
          INC       PATCODIO/INC
          INC       PATDRGIO/INC
          INC       PATMRGIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSVX1IO/INC
          INC       IBAPOSIO/INC
          INC       WATSUSIO/INC
          INC       OPRDEAIO/INC
          INC       PMSPX2IO/INC
