.------------------------------------------------------------------------------
. Program       : MRTWEB02 
.
. Function      : Medical Record Coding 
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.11 27/10/2025  Ebon Clements TSK 0964542
.           Recompiled for WEBGROUP - Load Codefinder clinician date and time
. V12.00.10 25/09/2025  Nikitha B     TSK 0966964
.           Recomplied for WEBGROUP - Format error message at LODENC93.
. V12.00.09 24/09/2025  Thanh T       TSK 0965186
.           Changed GOPDET00 to exit (GOPDET99) the loop when OPDAADMN is
.           different from ADMISSNO instead of GOPDET20
. V12.00.08 16/09/2025  Thanh T       TSK 0965186
.           Fixed issue with more than 100 diagnosis/procedure codes
. V12.00.07 11/09/2025  Thanh T       TSK 0964542
.           Added GOPDET00 to fix issue with date/time not defaulting when
.           there is no mbs details
. V12.00.06 10/09/2025  Ebon Clements TSK 0961623
.           Recompiled for WEBGROUP - alphanumeric visit number for Codefinder
. V12.00.05 28/08/2025  Nikitha B     TSK 0961744
.           Added new tag MRTS8800 & modified at CODUSR40 to accommodate .2 tag
. V12.00.04 18/08/2025  Thanh T       TSK 0964542
.           Changed GPR10000, GPR20000 and GPR30000 to default the doctor code
.           and name when MBS item is not found
. V12.00.03 21/07/2025  PJ LE Febour  TSK 0964128
.           BASDCYTO  corrected spelling of Heamatology to Haematology
. V12.00.02 29/05/2025  Ebon Clements TSK 0950532
.           Recompile for WEBGROUP - Validate cluster id
. V12.00.01 23/05/2025  Don Nguyen    TSK 0955096
.           Alphanumeric visit number changes
. V11.05.13 30/04/2025  Ebon Clements TSK 0950532
.           Recompiled for WEBGROUP - CGS diagnosis cluster id NWAU
. V11.05.12 24/04/2025  Ebon Clements TSK 0950532
.           Fixed class name row highlight for DCID - TDTRW400    
. V11.05.11 23/04/2025  Ebon Clements TSK 0950532
.           Recompiled for WEBGROUP - CGS diagnosis cluster id
. V11.05.10 17/04/2025  Ebon Clements TSK 0950532
.           Save cluster id from coding template - CODDIS00
.           Added diagnosis cluster id to TurboGrouper and Codefinder
. V11.05.09 02/04/2025  Ebon Clements TSK 0950532
.           Added diagnosis cluster id functionality
.           09/04/2025  Alina Bhari      TSK 0955699
.           Correctly added the National DRG detail and Health Fund Detail in
.           audit header file for ICD coding screen 
.           - GHDRG000,GNDRG000,SUMCOD6B         
.           14/04/2025  Davin            TSK 0951723
.           Recompiled for WEBGROUP - send 'I' procedures to grouper
. V11.05.08 27/03/2025  Davin         TSK 0956210
.           Mods to GRPDIS00/WIES0000/GDRG0000 and added PTCNE120 for DRG 12.0
. V11.05.07 20/03/2025  Davin         TSK 0956210
.           Recompiled for VALDIOPS - Add ICD10 Ed.13 - Go-live Date PTCNGDX3
. V11.05.06 07/03/2025  Ebon Clements    TSK 0944729
.           Recompiled for WEBGROUP - Load Codefinder QLD complication prefix
. V11.05.05 26/02/2025  Alina Bhari      TSK 0948402
.           Fixed the issue with LOS when patient returning from (w/without
.           Permision) - DTHPDY00
. V11.05.04 06/02/2025  Ebon Clements    TSK 0956930
.           Recompiled for WEBGROUP - Clear grouper vars
. V11.05.03 03/02/2025  Ebon Clements    TSK 0951861
.           Recompiled for WEBGROUP - Load Codefinder default clinician
. V11.05.02 21/01/2025  Ebon Clements    TSK 0956118
.           Fixed admission date sent to grouper when copying ICD codes
.           Called CPDATS00 at MEDCOD30
. V11.05.01 15/11/2024  Davin            TSK 0950787
.           Recompiled for WEBGROUP - Send CTYPE Tag to Codefinder (MRCNSCTC)
. V11.04.24 18/10/2024  Davin            TSK 0922271
.           Recompiled for WEBGROUP - allow grouper to handle up to 100 codes
. V11.04.23 08.10.2024 DA Sarkies      TSK 0948402
.           Rewrote code to calculating LOS for BHS in DTHPDY00 
. V11.04.22 23/09/2024 J.Tan           TSK 0950577
.           Recompiled for PATIPERH - Fixed Hold Invoice audit issue
. V11.04.21 09/09/2024  Thanh T          TSK 0856783
.           Changed CODCMT10 to fix the issue with comments not showing
.           correctly
. V11.04.20 02/09/2024  Thanh T          TSK 0856783
.           Added CODCMT00 to return coding comments in descending order and
.           ignoring deleted comments 
. V11.04.19 14/08/2024  Thanh T          TSK 0856783  
.           Added CVSCM000 to check if Coding Comments exist from viscmtaf 
. V11.04.18 09/08/2024  J.Tan            TSK 0948970  
.           Mod OPRCPY00 - default Operation date to Disc.date (MRCNOPDT=0)
. V11.04.17 05/07/2024  Ebon Clements    TSK 0948817  
.           Recompiled for WEBGROUP - CGS/Codefinder Separation mode
. V11.04.16 21/06/2024  Alina Bhari      TSK 0946963
.           Displayed web user ID if user id is not found -CODUSR05             
. V11.04.15 17/06/2024  Davin            TSK 0937495
.           Recompiled for WEBGROUP - get DCLs from new positions in grouper v11
. V11.04.14 04/06/2024  Ebon Clements    TSK 0947060
.           Recompiled for GETCHSCR - paticuaf write
. V11.04.13 30/05/2024  Thanh T          TSK 0925944
.           Added GPR30000 to return defaulting Surgeon from Theatre Case
. V11.04.12 28/05/2024  Thanh T          TSK 0925944
.           Added GPR30000 to return defaulting Surgeon from Theatre Case      
. V11.04.11 14.05.2024  DA Sarkies       TSK 0931016
.           Fixed problem where multiple days were being counted when leave
.           occured on same day as admission/returning from leave
. V11.04.10 01.05.2024  DA Sarkies       TSK 0931016
.           Changed end point of OVRCD in the calculate LOS tag    
. V11.04.09 23.04.2024  DA Sarkies       TSK 0931016
.           Added new tag to calculate length of stav based on VEAD
. V11.04.08 22/02/2024  Ebon Clements    TSK 0943354
.           Recompiled for WEBGROUP - TG export separation mode
. V11.04.07 29/01/2024  Davin            TSK 0928468
.           Added HONDET00 for AMHCC Grouper (Check if HONOS details exist)
. V11.04.06 25/01/2024  Davin            TSK 0928468
.           Recompiled for WEBGROUP - Added AMHCC Grouper
. V11.04.05 23/01/2024  Ebon Clements    TSK 0939233
.           Recompiled for PATCRDTD and PATCRDTM - Facility previously 
.           diagnosed textarea save and display
. V11.04.04 18/01/2024  Ebon Clements    TSK 0940233
.           Added cancer registrations exist tag - MRTS8500
. V11.04.03 11/01/2024  Ebon Clements    TSK 0942012
.           Added pmspx2af reads to cancer reg display - CANCOD70
. V11.04.02 28/11/2023  Peter Vela       TSK 0935874
.           Recompiled for PATCRSFP - Added validation for PTCNUNET = 3
. V11.04.01 21/11/2023  Thanh T          TSK 0939233
.           Recompiled for PATCRDFD changes
. V11.03.29 14.05.2024  DA Sarkies       TSK 0931016
.           Fixed problem where multiple days were being counted when leave
.           occured on same day as admission/returning from leave
. V11.03.28 01.05.2024  DA Sarkies       TSK 0931016
.           Changed end point of OVRCD in the calculate LOS tag    
. V11.03.27 23.04.2024  DA Sarkies       TSK 0931016
.           Added new tag to calculate length of stav based on VEAD
. V11.03.26 22/02/2024  Ebon Clements    TSK 0943354
.           Recompiled for WEBGROUP - TG export separation mode
. V11.03.25 29/01/2024  Davin            TSK 0928468
.           Added HONDET00 for AMHCC Grouper (Check if HONOS details exist)
. V11.03.24 25/01/2024  Davin            TSK 0928468
.           Recompiled for WEBGROUP - Added AMHCC Grouper
. V11.03.23 18/01/2024  Ebon Clements    TSK 0940233
.           Added cancer registrations exist tag - MRTS8500
. V11.03.22 11/01/2024  Ebon Clements    TSK 0942012
.           Added pmspx2af reads to cancer reg display - CANCOD70
. V11.03.21 28/11/2023  Peter Vela       TSK 0935874
.           Recompiled for PATCRSFP - Added validation for PTCNUNET = 3
. V11.03.20 24/10/2023  Bella Turco      TSK 0901388
.           Fixed traps around mrtcahaf & mrtcadaf opens
.           Delete patipenf record if MRCNEACA=2 & Cat rh ind3=C in SUMCOD62
. V11.03.19 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.03.18 26/09/2023  Ebon Clements  TSK 0934837
.           Recompiled for WEBGROUP - Load Codefinder default clinician
. V11.03.17 26/09/2023  PJ Le Febour   TSK 0937679
.           Recompiled for WEBGROUP - AGE using patma1af.PBDATE patmi1af.ADATE
. V11.03.16 04/09/2023  Ebon Clements  TSK 0936661
.           Recompiled for WEBGROUP - TurboGrouper QLD condition onset type
. V11.03.15 21/08/2023  Davin          TSK 0935074
.           Recompiled for WEBGROUP - loading operation codes from codefinder
. V11.03.14 17/08/2023  Ebon Clements  TSK 0936044
.           Added non mandatory accident date functionality for NZ activity
.           and place codes - CHCKA000 ACDNTMND
. V11.03.13 14/07/2023  Bella Turco    TSK 0901388
.           ICD Coding Audit Functionality writing records to mrtcahaf and 
.           mrtcadaf in SUMCOD6B/6C/6D/6F/6G
.           Recompiled for WEBGROUP
.           Changed MATCH condition for MRCNEACA in SUMCOD62
. V11.03.12 28/07/2023  Peter Vela     TSK 0935581
.           Added IF block at MEDCOD16 to prevent grouping if UPDTTYPE = N
.           from mrtweb0201001.html/private
. V11.03.11 21/07/2023  Davin          TSK 0930147
.           Send HL7 A08 based on "Coding Complete change" parameter (BVISUP00)
. V11.03.10 05/07/2023  Ebon Clements  TSK 0934723
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
.           if discharged post DRG 11 go live
. V11.03.09 03/07/2023  J.Tan          TSK 0923703
.           Mod defaulting ABF MH Coded date to current date
. V11.03.08 26/06/2023  Ebon Clements  TSK 0932535
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
. V11.03.07 14/06/2023  J.Tan          TSK 0923703
.           Mod for AMHCC - ABF mental health care class
. V11.03.06 30/05/2023  Davin          TSK 0933052
.           Added check for CodeFocus InvoiceOnHold reason (CHLD0000)
. V11.03.05 17/05/2023  Ebon Clements    TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.04 05/04/2023  Bella Turco      TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit               
. V11.03.03 21/03/2023  Ebon Clements    TSK 0909393
.           Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
. V11.03.02 23/12/2022  Davin          TSK 0926029
.           Recompiled for WEBGROUP - Use pateco code/desc for non-hosp ops
. V11.03.01 29/11/2022 Jacob Jackson   TSK 0918314
.           Recompiled for WEBGROUP changes
. V11.02.20 01/09/2022 Davin           TSK 0892581
.           Removed check for VIC for multiple cancer registrations  (CANCOD10)
.           Redirect to Cancer Reg after adding Reason for Diagnosis (CANCOD15)
. V11.02.19 03/08/2022 Ebon Clements   TSK 0922450
.           Added titles to move and swap icons - TDTRW000 TOPRW000
. V11.02.18 27/07/2022 Alina Bhari     TSK 0902663
.           Redirected to the origin Uncodeded discharge list
.           on completing the coding -UCDSCHRG,CHKDIS90,CLRPAR99
. V11.02.17 20/07/2022 J.Tan           TSK 0922228
.           Mod Checking for Patient Hold invoice
. V11.02.16 18/07/2022 J.Tan              TSK 0922228
.           Mod updating Current Status of Hold invoice
. V11.02.15 12/07/2022 Ebon Clements      TSK 0920004
.           Recompiled for WEBGROUP - Load codefinder operation dates
.           Added wahpdate cgi to stop auto default of the operation date
.           when loading codefinder procedures.
. V11.02.14 14/06/2022 Ebon Clements      TSK 0906596
.           Recompiled for WEBGROUP - Charlson score
.           Changed CLRICU00 to a common clear CLPATICU  
. V11.02.13 02/06/2022 Ebon Clements      TSK 0920519
.           Recompiled for WEBGROUP - Aboriginality to use cat VA indicator 4
. V11.02.12 16/05/2022  Thanh T           TSK 0901057
.           Fixed issue with Missing details 1-6 clearing out when adding
.           Diagnosis or procedure code in update template
. V11.02.11 11/05/2022  Thanh T           TSK 0901057
.           Fixed issue with Missing details 1-6 clearing out when adding
.           Diagnosis or procedure code in update template 
. V11.02.10 02/05/2022  Thanh T           TSK 0901057
.           Added LSTPSH00, MRTS8300, MRTS8400. Changed PDSCOM50 to fix the 
.           issues with missing details not created/updated  
. V11.02.09 21/04/2022  Davin         TSK 0917793
.           Mods to GRPDIS00/WIES0000/GDRG0000 and added PTCNE110 for DRG 11.0
. V11.02.08 01/04/2022 J.Tan          TSK 0918410
.           Mod to set AADMNO prior GETCHSCR routine
. V11.02.07 30/03/2022  Davin         TSK 0917793
.           Recompiled for VALDIOPS - Add ICD10 Ed.12 - Go-live Date PTCNGDX2
. V11.02.06 24/03/2022  Thanh T           TSK 0901057
.           Added MRTS7200-MRTS8200, PDSCCM00, MOVMIS00 and SAVSTS00 and
.           changed SUMCOD0 for MR missing details 1 to 6 fields 
. V11.02.05 07/03/2022  Ebon Clements     TSK 0905513
.           Added auto group after codefinder load functionality - runautog
.           02/03/2022  Thanh T           TSK 0901057
.           Added MRTS7200-MRTS8200, PDSCCM00, MOVMIS00 and SAVSTS00         
. V11.02.04 11/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG export/import operation times
. V11.02.03 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.02 08/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG operation times
. V11.02.01 26/01/2022  Jacob Jackson TSK 0864505
.           Recompiled for PATCRSFP - Added preferred name option fields
. V11.01.27 11/01/2021  Ebon Clements TSK 0912886
.           Added NWAU 2022 (N22) to WIES0000 
. V11.01.26 19/11/2021  Ebon Clements TSK 0911383
.           Recompiled for WEBGROUP - CGS Condition onset flag for NWAU
. V11.01.25 18/11/2021  Ebon Clements TSK 0911851
.           Recompiled for WEBGROUP - Codefinder/CGS - ICU NICU hrs
. V11.01.24 17/11/2021  Ebon Clements TSK 0911414
.           Recompiled for WEBGROUP - Export additional fields to TG
. V11.01.23 17/11/2021  DA Sarkies    TSK 0898433
.           Recompiled for WEBGROUP - Convert double quote to single
. V11.01.22 05/10/2021  Ebon Clements TSK 0909694
.           Recompiled for WEBGROUP - Codefinder care type
. V11.01.21 15/09/2021  Ebon Clements TSK 0902389
.           Recompiled for WEBGROUP - Urgency of Admission
. V11.01.20 14/09/2021  Ebon Clements TSK 0897701
.           Recompiled for WEBGROUP - Gender
. V11.01.19 20/08/2021  Ebon Clements TSK 0909624
.           Recompiled for WEBGROUP - LOS
. V11.01.18 05/08/2021  Jill Parkinson Task 0909737
.           Added J and L as valid discharge dest in CHKINT00           
. V11.01.17 05/08/2021  Ebon Clements   TSK 0909694
.           Recompiled for WEBGROUP - NWAU Care type - Codefinder input
. V11.01.16 04/08/2021  Ebon Clements   TSK 0909442
.           Recompiled for WEBGROUP - Admit Type - NZ - Codefinder input
. V11.01.15 13/07/2021  Ebon Clements   TSK 0902615
.           Recompiled for WEBGROUP - Not using NWAU test
. V11.01.14 07/07/2021  Ebon Clements  TSK 0908708
.           Recompiled for WEBGROUP - ICU Hours
. V11.01.13 06/07/2021  Ebon Clements  TSK 0908709
.           Recompiled for WEBGROUP - Use cat S admission mode
. V11.01.12 30/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - Export Care Type to TG
. V11.01.11 30/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - Don't restrict codes for NWAU             
. V11.01.10 29/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
. V11.01.09 24/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - Clear of unix grouper total NWAU
. V11.01.08 22/06/2021  Ebon Clements  TSK 0907810
.           Recompiled for WEBGROUP - Contract care type flag
. V11.01.07 18/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
. V11.01.06 28/05/2021  Thanh T        TSK 0901851
.           Changed column heading from "Contract" to "Contracted"
. V11.01.05 28/05/2021  Thanh T        TSK 0901851
.           Recompiled as PATMISTM changes
. V11.01.04 05/05/2021  Ebon Clements  TSK 0902615
.           Added read of NWAU parameters MRCNUNWA and MRCNENWA
. V11.01.03 26/04/2021  Ebon Clements  TSK 0901388
.           Recompiled for MRTPSHFD - Free text description
.           21/04/2021  Thanh T        TSK 0901851
.           Changed SAVECD00 for Contract Care flag changes
. V11.01.02 19/04/2021  Ebon Clements  TSK 0904891
.           Fixed max 300 procedure/diagnosis edit from the update coding(add)
.           screen - MEDCOD96, MEDCOD97, SAVECO00 and SAVECD00
. V11.01.01 23/02/2021  Ebon Clements  TSK 0900107
.           Increased max procedure/diagnosis array to 300 from 200 - MAXARRY
.           22/02/2021  J.Tan          TSK 0888639
.           Changed patmmbs counter record to DIM3
. V11.00.20 09/02/2021  Ebon Clements  TSK 0895992                  
.           Recompiled for WEBGROUP - TG coding complete
. V11.00.19 03/02/2021  Davin          TSK 0902458 CrossBrowser
.           Added ids to html output (MRCU0000)
. V11.00.18 08/10/2020  Ebon Clements  TSK 0892694
.           Recompiled for WEBGROUP - Export 6.2 DRG as 6.0x to TurboGrouper
. V11.00.17 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.16 08/10/2020  Ebon Clements  TSK 0892694
.           Recompiled for WEBGROUP - Send health fund defails to TG
. V11.00.15 28/10/2020  Ebon Clements  TSK 0848770
.           Added linked medical record primary key tag - MRTS7100
. V11.00.14 27/10/2020  Ebon Clements  TSK 0895254
.           Added long web error message max 200 diagnosis/procedures - MEDCOD98
. V11.00.13 26/10/2020  Ebon Clements  TSK 0895778
.           Recompiled for WEBGROUP - Load encoder button DRG 10
. V11.00.12 08/10/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - WIES27 Aboriginal and Torres Strait
.           Islander loading
. V11.00.11 23/09/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - Added WIES27 for 2020/2021
. V11.00.10 31/07/2020  J.Tan          TSK 0886178
.           Added GETCHSCR - Calculate Charlson score (SUMCOD22)
. V11.00.09 10/07/2020  Jill Parkinson Task 0894239
.           Corrected GOTO in PREVAD00 and NEXTAD00 to always re-read adm info
. V11.00.08 10/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG version 10
. V11.00.07 08/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG versions
. V11.00.06 30/06/2020  J.Tan          TSK 0886178
.           Recompiled for WEBGROUP - Automate calculate Charlson score
. V11.00.05 25/05/2020  Davin          TSK 0890603
.           Recompiled for WEBGROUP/WIESCALC - WIES for private facility
. V11.00.04 15/05/2020  Ebon Clements  TSK 0891590
.           Recompiled for WEBGROUP - TurboGrouper DRG version 6.2
. V11.00.03 30/04/2020  Jill Parkinson Task 0891317
.           Recompiled for WEBGROUP - mods to DRG 10.0 from grouper
. V11.00.02 03/04/2020  Thanh T         TSK 0879163
.           Recompiled for PATCRSFP
. V11.00.01 16/03/2020  Tracey Nguyen   TSK 0889496
.           Recompiled for MRTAUCFD/IO - Added MRACDDNR,MRACOHCP,MRACOCOF,
.           MRACODAT
.-----------------------------------------------------------------------------
. V10.15.09 17/02/2020  Davin          TSK 0881493
.           Recompiled for WEBGROUP - restrict diag codes to grouper
. V10.15.08 14/02/2020  Jill Parkinson Task 0886371
.           Mods to update date/time of coding when re-sequencing diagnoses
. V10.15.07 11/02/2020  Ebon Clements  Task 0888205
.           Recompiled for WEBGROUP - Turbogrouper I * D
. V10.15.06 03/02/2020  Jill Parkinson Task 0886371
.           Added update of pteddtcd/time in DLSECD00 for edward sites
. V10.15.05 08/01/2020  Jill Parkinson Task 0886371
.           Mods to remove UPDECD00 change in previous version.  Should have
.           only applied to UPDECO00
. V10.15.04 09/12/2019  Jill Parkinson Task 0885398
.           Added check for EDWARD before updating coding date/time in UPDECO00
.           and UPDECD00
. V10.15.03 04/12/2019  Ebon Clements  TSK 0881992   
.           Set copy visit number CPYADMNO when copying last discharge codes
.           PRVDIS00
. V10.15.02 12/11/2019  Nicole Torrisi TSK 0881409   
.           Recompiled for WEBGROUP - Added HMV to Encoder Load
. V10.15.01 09/10/2019  Ebon Clements  TSK 0877429   
.           Added channel and job to TurbGrouper import/export file 
. V10.14.26 03/10/2019  Thanh T        TSK 0882260
.           Recompiled for WEBGRPVA - DRG Version 11.0
. V10.14.25 02/10/2019  Ebon Clements  TSK 0877430
.           Populate TurboGrouper coded by user date and time
. V10.14.24 02/10/2019  Thanh T        TSK 0881566
.           Changed DEDI0000 to cater for ICD 10 edition of version 11
. V10.14.23 30/09/2019  Thanh T        TSK 0873083
.           Changed PREVAD00 and NEXTAD00 to check for user hospital access
.           using centralised coding         
. V10.14.22 30/09/2019  Ebon Clements  TSK 0877428
.           Populate TurboGrouper campus code
. V10.14.21 24/09/2019  Thanh T        TSK 0873083
.           Changed GETVIS00 to check for user hospital access using
.           centralised coding         
. V10.14.20 26/08/2019  Davin          TSK 0880255
.           Recompiled for WIESCALC - Added WIES26 for 2019/2020 (WIES0000)
. V10.14.19 08/08/2019  Ebon Clements  Task 0878505
.           Added EDWARD delete cancer registration trigger - WEDC0000
.           08/08/2019  Ebon Clements  Task 0876311
.           Add multiple cancer registration functionality after adding the
.           first cancer reg - CANCOD10 - CANCER00
. V10.14.18 02/08/2019  J.Tan          Task 0857392
.           Mod to display NWAU instead of WIES for ABF
. V10.14.17 24/07/2019  Peter Vela     Task 0878598
.           Added date validation in CHKINT00
. V10.14.16 08/07/2019  Peter Vela     Task 0877390
.           Changed CHKINT00 to accept CAT DD Transfer to other hosp
.           and CAT VR Re adm other hosp no booking for 20190701
. V10.14.15 04/06/2019  Ebon Clements  TSK 0875790
.           Recompiled for WEBGROUP - TurboGrouper operation prefix
.           05/06/2019  Nicole Torrisi TSK 0875762
.           Recompiled for WEBGROUP - Morphology prefix when PTCNHDPS=7 (TAS)
.           02/06/2019  Jill Parkinson Task 0873054
.           Added call to write to patecmaf when proc/diag are all deleted
. V10.14.14 31/05/2019  Ebon Clements  TSK 0875696
.           Recompiled for WEBGROUP - TurboGrouper coder id
. V10.14.13 21/05/2019  Davin          TSK 0870480
.           Recompiled for WEBGROUP - Changed eccsraw codefinder tag
. V10.14.12 14/05/2019  Ebon Clements  TSK 0874778
.           Recompiled for WEBGROUP - TurboGrouper diagnosis codes
. V10.14.11 13/05/2019  Jill Parkinson Task 0871398
.           Recompiled for WEBGROUP -  RLTAGS00 checking over to stop loop
. V10.14.10 02/05/2019  Ebon Clements  TSK 0874135
.           Recompiled for WEBGROUP - TurboGrouper theatre date/time defaults
. V10.14.09 01/05/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP - Added TURBOSAV - Retain previous details
. V10.14.08 08/04/2019  Ebon Clements  TSK 0872901
.           Recompiled for WEBGROUP -  Auto Coding user id
. V10.14.07 27/03/2019  Peter Vela     TSK 0857392
.           Added PTICCHSC to PATICU - Charlson Score
. V10.14.06 27/03/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP -  Export leave days
. V10.14.05 20/03/2019  Peter Vela     TSK 0868836
.           2019 VAED Stat Changes
. V10.14.04 19/03/2019  Don Nguyen     TSK 0869412
.           Recompiled for VALDIOPS - Added ICD10 Ed.11 - Go-live Date check
. V10.14.03 04/03/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper
.           27/02/2019  Richa Phogat   TSK 0870439
.           Mods to GRPDIS00/WIES0000/GDRG0000 and added PTCNE100 for DRG 
.           Version 10.0
.           12/03/2019  J.Tan          TSK 0871073
.           Fixed updating ICU and MV minutes
. V10.14.02 25/02/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper 
. V10.14.01 18/02/2019  Ebon Clements  TSK 0829856
.           Recompiled for GETEFDRG - Contract from effective date
. V10.13.10 24/01/2019  Ebon Clements  TSK 0869592
.           Recompiled for WEBGROUP - TurboGrouper
. V10.13.09 20/12/2018  Don Nguyen     TSK 0837732
.           Recompiled for WEBGROUP - Modified GODTM000 to get the first
.           matching MBS Item time values (if operation date exists).
. V10.13.08 01/11/2018  Davin            TSK 0852820
.           Recompiled for WEBGROUP - Use "TOTWT:" tag for nz wies
. V10.13.07 19/10/2018  Davin            TSK 0854372
.           Mods to procedure code validation (VALICO00) if CMORBDTM=3:
.           - Return hdp start/end time of procedure from patmmbsf
.           - Return hcp code/name matching AHPRA id (if valid) from patmmbsf
. V10.13.06 12/10/2018  Ebon Clements    TSK 0863023
.           Recompiled for WEBGROUP - HNIV: tag
. V10.13.05 27/09/2018  Richa Phogat   TSK 0862830
.           Updated CHKINT00 by removing RESET step and adding EOS check for
.           HRSICU06
. V10.13.04 06/09/2018  Richa Phogat   TSK 0862786
.           Recompiled for WEBGROUP - Removed bypass Morphology
. V10.13.03 31/08/2018  Jill Parkinson Task 0861535
.           Added setting of hrsicu04 with ptmis051
. V10.13.02 21/08/2018  Davin          TSK 0860935
.           Recompiled for WIESCALC - Added WIES25 for 2018/2019
. V10.13.01 21/08/2018  Ebon Clements  TSK 0861535
.           Added baby field cgi parameters to associated coding
. V10.12.08 10/07/2018  J.Tan          TSK 0817920
.           Added Hold invoice on Coding screen
. V10.12.07 14/06/2018  Ania P         TSK 0835945
.           Added output of defltman
. V10.12.06 05/06/2018  Ebon Clements  TSK 0845772   
.           Recompiled for WEBGROUP - TurboGrouper diagnosis
. V10.12.05 04/05/2018  Ebon Clements  TSK 0845772   
.           Added TurboGrouper functionality
. V10.12.04 29/05/2018  Richa Phogat   TSK 0857729
.           Fixed Primary Site display on cancer reg list - REGLST00
. V10.12.03 23/03/2018  Jill Parkinson TSK 0848131   
.           Mods to write to patecmaf is sending edward                 
.           23/03/2018  Tracey Nguyen  TSK 0852793
.           Mods to GRPDIS00/WIES0000/GDRG0000 and added PTCNED90 for DRG 
.           Version 9.0
. V10.12.02 09/03/2018  J.Tan            TSK 0842287
.           Recompiled for PATCRDTM - Added 'Best Basis for Diagnosis'
. V10.12.01 29/01/2018  Ania P           TSK 0851398
.           Recompiled for WEBGROUP
. V10.11.11 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
. V10.11.10 07/12/2017  J.Tan          Task 0844301
.           Changed Associated coding screen for private
.           11/12/2017  Don Nguyen       TSK 0848767
.           Recompiled for WEBGROUP - Modified GDSPX300 to include ACT
.           15/12/2017  Peter Vela       TSK 0847747
.           Added direct read of discharge table INDRG200
. V10.11.09 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.08 22/11/2017  Ania P           TSK 0261630
.           Removed use of PRFIXDP (INIT "GDPATH")
. V10.11.07 27/09/2017  Davin            TSK 0845070
.           Recompiled for WEBGROUP - fixed codefinder tag BWIES
. V10.11.06 17/08/2017  Ebon Clements    TSK 0843340
.           Fixed redirect to oldest uncoded discharge - CHKDIS00 - CHKEPS00
. V10.11.05 16/08/2017  Ebon Clements    TSK 0843663
.           Fixed MR merge table heading colspan - MRCU0000
.           Changed readonly volume to Integer in MR merge - MRCU0000
. V10.11.04 15/08/2017  Davin            TSK 0842626
.           Recompiled for WIESCALC - Added WIES24 for 2017/2018
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.-------------------------------------------------------------------------------
. V10.10.15 21/06/2017  Davin          TSK 0836775
.           Recompiled for WEBGROUP - mental health legal status
. V10.10.14 20/06/2017  Don Nguyen     TSK 0836345
.           Modified OPRCPY00 to default current admisison date (VISITDAT) 
.           into Operation Date; instead of the previous admission date.
. V10.10.13 13/06/2017  J.Tan          TSK 0839991
.           Recompiled for PATDBTYP (PATGNFEE)
. V10.10.12 07/06/2017  Jill Parkinson TSK 0832750
.           Recompiled for WIESCALC - R64Z issues
. V10.10.11 01/06/2017  Don Nguyen     TSK 0838360
.           Recompiled for WEBGROUP - Fixed RLTAGS00 to break out of processing
.           'COD:' related tags when the next 'COD:' tag is read; whilst still
.           ignoring unrecognised 'COD:' related tags.
. V10.10.10 30/05/2017  Don Nguyen     TSK 0838196
.           Recompiled for WEBGROUP - skip execution of 'mrtweb02.us1' &
.           'mrtweb02.us2' if PTCNOENC is set to use Web Codefinder.
.           Restored size of FILENAM2 & ENCOUTFN (to 8 & 12 respectively);
.           use WCFINPFN & WCFOUTFN instead.
. V10.10.09 26/05/2017  Don Nguyen     TSK 0838196
.           Added MAIN2000 (Web Codefinder Remote Scripting).
.           Modified DWCI0000 & GETENC00 to use different filename format
.           for Web Codefinder interface. Don't reset WEBCODER after tag output.
.           Increased size of FILENAM2 & ENCOUTFN.
. V10.10.08 25/05/2017  Jill Parkinson TSK 0832750
.           Recompiled for WIESCALC - surgical DRG check
. V10.10.07 17/05/2017  Don Nguyen     TSK 0836345
.           Modified OPRCPY00 to default admission date into Operation Date if
.           parameter (MRCNOPDT) is set.
. V10.10.06 11/05/2017  Ebon Clements  TSK 0834710
.           Branch on EXIT after SETGRP00 calls in copy coding - MEDCOD30
. V10.10.05 01/05/2017  Peter Vela     TSK 0837389
.           Made newvl readonly in MRCU1000
. V10.10.04 28/04/2017  Davin          TSK 0836380
.           Recompiled for WEBGROUP
. V10.10.03 26/04/2017  Peter Vela     TSK 0837389
.           Added id to newvl in MRCU0000
. V10.10.02 28/03/2017  Tracey Nguyen  TSK 0835346         
.           Amended MRTS2300 to calculate age at admission using adate only
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018    
.           Re-compiled for VALDIOPS - Add ICD10 Ed.10 - Go-live Date PTCNGDVX
. V10.09.08 20/02/2017  Don Nguyen     TSK 0323562
.           Modified CHKDIS00 - check for EPSFLAG after call to CHKEPS00
. V10.09.07 23/01/2017  J.Tan          TSK 0829949
.           Added NVALWGHT - validating baby weight in template
. V10.09.06 18/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
. V10.09.05 16/01/2017 Davin           TSK 0814742
.           Recompiled for VISCODTM - mods to selection list output
. V10.09.04 10/01/2017  Nicole Torrisi   TSK 0829851
.           Recompiled for PATCRSFP - Cancer Reg Form
.           09/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
. V10.09.03 19/12/2016  Don Nguyen       TSK 0323562
.           Added MRTS6800 (SUPERLEV) - output superlev flag
. V10.09.02 14/12/2016  Ebon Clements  TSK 0817794 0318374
.           Changed mandatory movement reason from ind 2 to ind 3 - REASNM00
. V10.09.01 13/12/2016  Jill Parkinson TSK 0817492
.           Recompiled for WIESCALC - Added check for surgical procs
. V10.08.27 24/11/2016  Jill Parkinson TSK 0817492
.           Recompiled for WIESCALC - Added check for surgical procs
. V10.08.26 08/11/2016  Don Nguyen       TSK 0828544
.           Recompiled for WEBGROUP - Modified RLTAGS00
. V10.08.25 18/10/2016  Ebon Clements    TSK 0823580
.           Only move the MR if the location or reason has changed - SAVMVE00
. V10.08.24 17/10/2016  Davin            TSK 0307316
.           Reset WEBCODER to zero after writing out tag @ MRTS6500
. V10.08.23 12/10/2016  Jill Parkinson TSK 0822032   
.           Added output of PT0ODTMN in TOPRW000                             
. V10.08.22 12/10/2016  Don Nguyen       TSK 0323562
.           Added SUPERLEV and modified STRDIR00 to append value accordingly
. V10.08.21 11/10/2016  Nicole Torrisi   TSK 0822881
.           Changed CCL column to DCL TDTHD000 for DRG 8.0
. V10.08.20 05/10/2016  Davin            TSK 0826104
.           Recompiled for WEBGROUP - importing codefinder procedure date
. V10.08.19 27/09/2016  Don Nguyen        TSK 0312570
.           Modified SUMCOD80 and the way we evaluate DRGCODHF; if no applicable
.           Health Fund DRG Code found revert to PTDSDDRG (Discharge DRG Code).
.           Changed to NOT default to PTCNDGPV if GSTDRG00 returns nothing.
.           Recompiled for GETEFDRG.
. V10.08.18 26/09/2016  Peter Vela        TSK 0324334
.           Added hidden outputs for onset type in TDTRW400
.           Added remote script functionality for onset type in UPDPRE00
. V10.08.17 21/09/2016  Davin             TSK 0307316
.           Mods for web Interface to 3M Codefinder (ptcnoenc=2)
.           - Added 3M input tags (DWCI0000) and output tags (GETENC00)
.           - Added codefinder parameter tags (MRTS6500/MRTS6600/MRTS6700)
. V10.08.16 20/09/2016  Don Nguyen        TSK 0312570
.           Modified SUMCOD80 to call GSTDRG00 if no Health Fund/Claim Code DRG
.           19/09/2016  J.Tan             TSK 0320461
.           Added CKWEIGHT to check for patient Weight
. V10.08.15 02/09/2016  Davin             TSK 0825157
.           Recompiled for WIESCALC
. V10.08.14 30/08/2016  Don Nguyen        TSK 0814947
.           Recompiled for WEBGROUP - Modified COPRS000 to check PT0ODTMN
. V10.08.13 26/08/2016  Don Nguyen        TSK 0312570
.           Added check for PTCNDGED where applicable (SUMCOD00 & GRPR0000)
.           Modified SUMCOD80 to call GHFDRG00, GCLDRG00 & GSTDRG00 instead
.           Recompiled for GETDRG - Modified GTDRG000 to call GTEDRG00
. V10.08.12 19/07/2016  Davin             TSK 0822753
.           Recompiled for WIESCALC - Added WIES23 functionality for 2016/2017
. V10.08.11 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.10 01/07/2016  J.Tan            TSK 0819914
.           Added a tag to check for Mechanical Ventilation record (patvenaf)
. V10.08.09 17/06/2016  Davin            TSK 0315393
.           Added retention fields PMPXRPER/PMPXRDAT/RECRT001/RECRT002/RECRETDT
.           06/06/2016  Peter Vela       TSK 0321157
.           Recompiled for VISCODFD
. V10.08.08 01/06/2016  J.Tan            TSK 0315587
.           Recompiled for PATCRDTM - NSW Cancer Reg.2015
. V10.08.07 27/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - Modified RDUNIX1 & RDCME1
. V10.08.06 20/04/2016  Ebon Clements    TSK 0289896
.           Only track record if it's not in the destination location - SAVMVE00
. V10.08.05 15/04/2016  Ebon Clements    TSK 0318374
.           Addded movement reason save from icd coding screen
. V10.08.04 14/04/2016  Peter Vela       TSK 0813958
.           Recompiled for PATCRDTD and PATCRDTM
. V10.08.03 13/04/2016  Don Nguyen       TSK 0321353
.           Recompiled for WEBGROUP - Modified WRENC000 to use GETDRG
. V10.08.02 12/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - process "I10ECCSRAW:" & "HNIV:"
.           Added output tag for PTPGECRW. Updated CLRGRP00 with PTPGECRW
. V10.08.01 31/03/2016  Peter Vela       TSK 0813901
.           Added hidden procedure date and times to TOPRW280 
. V10.07.07 18/03/2016  Ebon Clements    TSK 0813993
.           Added this to MoveRec03 for tempDisable - TOPRW000
. V10.07.06 07/01/2016  Ebon Clements    TSK 0321927 
.           Move MR linked to the visit instead of the highest volume 
.           after saving the ICD coding screen - SAVMVE00
. V10.07.05 03/12/2015  Davin            CAR 316612
.           Changed KEY116 to KEY24 for mrtcieaf (ETABH000/ETABP000/ERRCCA00)
. V10.07.04 12/11/2015  Peter Vela       CAR 313711
.           Added validations to PTEDDRGD and PTEODRGD in TDTRW00 and TOPRW00
. V10.07.03 11/11/2015  Davin            CAR 316612
.           Mods to CCA interface errors - added patient level list (etabp000)
. V10.07.02 30/10/2015  Davin            CAR 316612
.           Mods to CCA interface errors - mark as processed (errcca00)
. V10.07.01 23/10/2015  Davin            CAR 316612
.           Added report 9 - CCA interface errors
. V10.06.15 17/09/2015  Peter Vela       CAR 297383
.           Added duplicate cancer code validation in FNDPRM00
. V10.06.14 30/07/2015  Don Nguyen       CAR 318792
.           Recompiled for WEBGROUP - Modified RLTAGS00 to use KEY200
. V10.06.13 01/07/2015  Don Nguyen       CAR 317693
.           Recompiled for VALDIOPS - Removed Area checks '3' & '4' in VOPCD200
. V10.06.12 26/06/2015  Ebon Clements    CAR 315669
.           If wahealth only merge records from the users currently logged in
.           hospital - MRGEUR00
. V10.06.11 18/06/2015  Don Nguyen       CAR 314792
.           Recompiled for WEBGROUP - Modified ENCDT000; output PTEDACDT
. V10.06.10 11/06/2015  Patrick Adair    CAR 313223
.           Recompiled for WEBGROUP - admission weight check
. V10.06.09 02/06/2015  Peter Vela       CAR 313227
.           Changed GETUNR00 to allow current admission
. V10.06.08 29/05/2015  Ebon Clements    CAR 317094
.           Mods to GRPDIS00 & WIES0000 for DRG 8.0 - recomp for WEBGROUP etc
. V10.06.07 28/05/2015  Jill Parkinson   CAR 313321
.           Mods to update aelig with 5 when coding is updated for nz
. V10.06.06 25/03/2015  Jill Parkinson   CAR 313319
.           Mods to update gestation period using PTCNGEST
. V10.06.05 10/04/2015  J.Tan           CAR 304813
.           Added WIESCALC
. V10.06.04 20/03/2015  Jill Parkinson   CAR 304357
.           Mods to write to patecmaf for WA
. V10.06.03 24/03/2015  Don Nguyen       CAR 314100
.           Recompiled for WEBGROUP - modified output for mrtweb02.us1/us2
. V10.06.02 17/03/2015  Davin          CAR 311669           HDP 2015/16
.           Re-compiled for VALDIOPS - Add ICD10 Ed.9 - Go-live Date PTCNGDV9
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.-------------------------------------------------------------------------------
. V10.05.13 26/02/2015  Ebon Clements    CAR 313396
.           Move one to exit after WEBERR00 at SAVECD90 
.           Branch to SUMCOD99 after call to SAVECD00 if exit equals 1
. V10.05.12 10/02/2015  Peter Vela       CAR 310194
.           Added get drg based on discharge date GRPR4300
. V10.05.11 23/01/2015  Ebon Clements    CAR 310401
.           Added visit type tag - MRTL2100
. V10.05.10 23/10/2014  Patrick Adair    CAR 301756
.           Correct ICD Coding loop with Emergency Visits - SETMED00
. V10.05.09 06/10/2014  Davin            CAR 300056
.           Added Coding Delay Reason (codeinco/pmvxudf5/mrts5800)
. V10.05.08 01/10/2014  Peter Vela       CAR 285467
.           In GETUNR00:
.           Changed Ind 13 to Ind 14
.           Changed Ind 21 to Assoc 3 Pos 1
. V10.05.07 25/09/2014  Ania P           CAR 304641
.           Extended HRSICU11 to length 15
. V10.05.06 25/09/2014  Don Nguyen       CAR 303179
.           Recompiled for changes to VALDIOPS - new error msg's for sex checks
. V10.05.05 18/09/2014  Don Nguyen       CAR 305696
.           Added GRPR3800 - GRPR4300. Added CHKPGR00 and DRGDES00.
.           18/09/2014  Davin            CAR 304204
.           Recompiled for GETDRG - get drg version based on discharge date
. V10.05.04 11/09/2014  Don Nguyen       CAR 303179
.           Recompiled for changes to VALDIOPS
.           11/09/2014  Don Nguyen       CAR 302792
.           Recompiled for changes to VALDIOPS
.           09/09/2014  Davin            CAR 296980
.           Changes to handle WIES21
. V10.05.03 15/08/2014  Sandra Barcham   CAR 301312
.           Allow for reamission greater than 999 between visits
. V10.05.02 28/07/2014  Davin            CAR 303346
.           Mods to icd code description output at summ1400/summ2400
.           Mods to icd10 description output at tdtrw000/toprw000
.           Mods to icd10 description output at valico00/valicd00
. V10.05.01 24/07/2014  Davin            CAR 303444
.           Added tags for drg code/desc/version based on effective date
.           parameters (grpr3400/grpr3500/grpr3600/grpr3700/gdrg0000)
. V10.04.11 03/07/2014  Ebon Clements    CAR 302036
.           Recompiled for WEBGROUP - Urgency of admission tag
. V10.04.10 26/05/2014  Don Nguyen       CAR 301566
.           Initialised FORM var before used for PT0DACRQ
. V10.04.09 07/04/2014  Peter Vela       CAR 286258
.           Recompiled for PATMASTM
. V10.04.08 01/04/2014  Peter Vela       CAR 285467
.           Fixed date calculation in GETUNR00
. V10.04.07 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.06 20/03/2014  Peter Vela       CAR 285467
.           Added unplanned readmission flag to MRTS0000
. V10.04.05 13/03/2014  Don Nguyen       CAR 294888
.           Recompiled for changes to WEBGROUP
. V10.04.04 05/03/2014  Ebon Clements    CAR 295416
.           Added multi hopsital security test  - CHKDIS00
. V10.04.03 28/02/2014  Ebon Clements    CAR 295416
.           Added MRCNCCOD - Using centralised coding to redirect  - CHKDIS00
. V10.04.02 19/02/2014  Don Nguyen       CAR 291879
.           Deleted CNPRN000; it's been moved to an include (PATCRSFP.PBL).
.           Added GTIHINUM for PATCRSFP.PBL
. V10.04.01 10/02/2014  Patrick Adair    CAR 273419
.           updated pteodesc and ptddesc to display 200 characters
.-------------------------------------------------------------------------------
. V10.03.93 13/12/2013  Patrick Adair    CAR 289374
.           updated NZ medical record merge headers to read NHI instead of U/R
. V10.03.92 03/12/2013  Don Nguyen       CAR 284205
.           Recompiled for WEBGROUP - Added another test condition to WRTDIS00
. V10.03.91 02/12/2013  Don Nguyen       CAR 284205
.           Recompiled for WEBGROUP - Modified WRTDIS00 to address spec update
. V10.03.90 29/11/2013  Don Nguyen       CAR 284205
.           Recompiled for WEBGROUP - Modified WRTDIS00 to utilise DISCOUNT 
. V10.03.89 25/11/2013  Don Nguyen       CAR 284205
.           Recompiled for WEBGROUP - Modified WRTDIS00 
. V10.03.88 21/11/2013  Don Nguyen       CAR 293200
.           Added test for admission status of 1 (Pre-admission) in SETMED00
.           and updated error messages accordingly.
. V10.03.87 20/11/2013  Don Nguyen       CAR 293200
.           Recompiled for PATMISTM - MISB2000
. V10.03.86 18/11/2013  Ebon Clements    CAR 292824
.           Added locked record checks prior to admission file updates - SUMCOD
. V10.03.85 11/11/2013  Davin            CAR 292582
.           Recompiled for VISCODTM - added tag options for cancer reg
. V10.03.84 22/10/2013  Davin            CAR 278601
.           Don't show adm.weight for babies born in leap year (mrts1000)
. V10.03.83 22/10/2013  Patrick Adair    CAR 229471
.           Added write of AELIG for NMDS Resubmit processing (SAVODC00)
. V10.03.82 16/10/2013  Don Nguyen       CAR 292019
.           Recompiled for changes to BRHLCOMN (DGCLICAC)   
.           16/10/2013  Don Nguyen       CAR 289270
.           Added IO TRAP's around calls to WRPTECD1
. V10.03.81 15/10/2013  Don Nguyen       CAR 287886
.           Added VALADT00 - Validation of Accident Dates for Diagnosis Codes
. V10.03.80 14/10/2013  Peter Vela       CAR 281019
.           Replace double quotes with single quotes @ SUMM2400
. V10.03.79 14/10/2013  Don Nguyen       CAR 282453
.           Adjusted widths of 'Accident Date' & 'CCL' columns in TDTHD000
.           Recompiled for WEBGROUP.
. V10.03.78 11/10/2013  Peter Vela       CAR 289956
.           Added takeup outstanding debt visit date test to MEDCOD70
. V10.03.77 09/10/2013  Peter Vela       CAR 292070
.           Recompiled for WEBGROUP 
. V10.03.76 04/10/2013  Peter Vela       CAR 284261
.           Recompiled for PATWIS20
. V10.03.75 04/10/2013  Peter Vela       CAR 284261
.           Recompiled for PATWIS19
. V10.03.74 02/10/2013  Ania P           CAR 292081
.           Recompiled for WEBGROUP
. V10.03.73 02/10/2013  Peter Vela       CAR 291724
.           Recompiled for VISCODTM
. V10.03.72 09/09/2013  Ania P           CAR 290324
.           Added DIM3 and recompiled for WEBGROUP
. V10.03.71 10/09/2013  steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIIO
. V10.03.70 29/08/2013  Ania P           CAR 290324
.           Recompiled for WEBGROUP
.           02/09/2013  Davin            CAR 290919
.           Recompiled for PATWIS18/19/20
. V10.03.69 23/08/2013  Davin          CAR 290406
.           Don't access coding screen if admission is cancelled (setmed00)
. V10.03.68 15/08/2013  Peter Vela     CAR 289667
.           Fixed multihospital validation in GETVIS00
. V10.03.67 14/08/2013  Don Nguyen     CAR 290107
.           Added id attribute to move & swap buttons for disabling (MoveRec03)
. V10.03.66 12/08/2013  Peter Vela     CAR 289382
.           Further fixed in GETVIS00
. V10.03.65 12/08/2013  Peter Vela     CAR 289382
.           Fixed validation for last coded discharged visit GETVIS00
. V10.03.64 07/08/2013  Davin          CAR 284960
.           Changes to handle WIES20
. V10.03.63 25/07/2013  Ebon Clements  CAR 228354
.           Fixed selection of highest (latest) coding date & time - CODDAT00
. V10.03.62 30/06/2013  Davin          CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.61 18/07/2013  Peter Vela     CAR 287221
.           Changed GETVIS00 back to RS/RK and removed parameter functionality
.           18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
.           19/07/2013  Davin          CAR 287776
.           Call rsptecd instead of rpptecd when looping dis. codes (endldi10)
.           Call rspteco instead of rppteco when looping opr. codes (endlop10)
. V10.03.60 18/07/2013  Ania P         CAR 288386
.           Added tag %MRTWEB02.01.456 to output PTCNBAGE
. V10.03.59 17/07/2013  Peter Vela     CAR 288507
.           Changed GETVIS00 to RS/RP to return most recent coded (or uncoded)
.           visit.
. V10.03.58 12/07/2013  Ania P         CAR 249291
.           Changed CODCOM00 to not show Deleted comments.
. V10.03.57 09/07/2013  Peter Vela     CAR 287221
.           Added MRCNDCUD - Check for uncoded visits in Medical Records
.           Morbidity Coding (GETVIS00)
. V10.03.56 03/07/2013  Ania P         CAR 249291
.           Added functionality to display new coding comments
. V10.03.55 24/06/2013  Ebon Clements  CAR 287027
.           Added logged in hospital MR desination selection list - MRTS5500
. V10.03.54 14/06/2013  Jill Parkinson CAR 286785
.           Added check for PT0DACRQ=6,7 or 8 as external cause codes in 
.           CKEMR000
. V10.03.53 03/06/2013  Davin           CAR 283509  VIC Cancer Reg 2013
.           Added visit based coding (visitm00/viscodfd/td/tm)
.           29/05/2013  Jill Parkinson  CAR 282743
.           Added minutes in ICU and minutes in mechanical ventilation (QLD HDP)
. V10.03.52 03/05/2013  Davin            CAR 284669 HDP 2013 DRG 7.0
.           Mods to GRPDIS00 & WIES0000 for DRG 7.0 - recomp for WEBGROUP etc
. V10.03.51 23/04/2010  Davin          CAR 284420           HDP 2013/14
.           Re-compiled for VALDIOPS - Add ICD10 Ed.8 - Go-live Date PTCNGDV8
. V10.03.50 18/04/2013  J.Tan            CAR 278522
.           Removed remote scripts to validate Diagnosis combination
. V10.03.49 12/04/2013  J.Tan            CAR 278522
.           Added remote scripts to validate Diagnosis combination
. V10.03.48 04/04/2013  Patrick Adair    CAR 279058
.           Updated TOPTB100 to warn if no clinician on primary procedure
.           MRCNCLIN is not zero 
. V10.03.47 28/03/2013  Don Nguyen       CAR 273682
.           Added IO traps around WRPTECO1 and WRPTECM1 to prevent I * D crashes
. V10.03.46 19/03/2013  Jill Parkinson   CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.45 05/03/2013  Patrick Adair    CAR 281898
.           Corrected key for patecda1 and patecoa1 from KEY12 to KEY13
. V10.03.44 25/02/2013  Ania P           CAR 281021
.           RECOMPILED for WEBGROUP	
. V10.03.43 16/01/2013 Patrick Adair     CAR 274911 
.           Redirect to code update screen if codes exist for previous episode
. V10.03.42 09/01/2013 Jill Parkinson    CAR 275512 
.           Added RA's to all writes to patecdaf and patecoaf            
. V10.03.41 17/12/2012  Ebon Clements    CAR 269441
.           Fixed save of mrt movement location hospital code - SAVMVE00
. V10.03.40 29/11/2012  Mike Laming      CAR 270133
.           Reverted MRTS2500 - Add PATHSPFD.PTHSDCDT (Default Coding Dest)intoi
.           MRTS5300
. V10.03.39 16/11/2012  Mike Laming      CAR 228354
.           Changes to CODDAT00 to get latest Disease and Oper dates
. V10.03.38 09/11/2012  Mike Laming      CAR 270133
.           Add new field PATHSPFD.PTHSDCDT (Default Coding Dest)into MRTS2500
.           Also added MRCNDCDT for single Hospital
. V10.03.37 07/11/2012  Peter Vela       CAR 273712
.           Fixed MRCU0000 for wahealth
. V10.03.36 01/11/2012  Mike Laming      CAR 252329
.           Mods to TOPTB200 and MRTS5100 for "Principle Procedure Dates only"
. V10.03.35 23/10/2012  Davin            CAR 274522
.           Allow 'G' (POSTHUMOUS ORGAN PROCUREMENT) as valid ddest (chkint00)
. V10.03.34 01/10/2012  Mike Laming      CAR 271756
.           Recompiled for PATWIS18 - Added test for "Victoria" in V18IN000
. V10.03.33 02/10/2012  Mike Laming      CAR 270064
.           Added test for User's Hospital in CHKDIS00                      
. V10.03.32 01/10/2012  Mike Laming      CAR 271756
.           Recompiled for WEBGROUP - Mods for October Codefinder changes
. V10.03.31 25/09/2012  Peter Vela       CAR 272694
.           Fixed column widths @ TDTTB000 and TOPTB0000           
. V10.03.30 21/09/2012  Mike Laming      CAR 273546
.           Changed GENCAN00 to find the highest Cancer Registration No.
. V10.03.29 20/09/2012  Davin            CAR 273279
.           Recompiled for PATWIS19
. V10.03.28 20/09/2012  Mike Laming      CAR 268097
.           Added ITRN0000 to MRCU6000 for "(T)" if MR "In Transit" 
. V10.03.27 17/09/2012  Mike Laming      CAR 268097
.           Added ITRN0000 to create "(T)" if MR "In Transit" - later change  
. V10.03.26 04/09/2012  Mike Laming      CAR 268097
.           Added changes for WA Health MR Merge in MRCU000 & MRDS0000        
. V10.03.25 23/08/2012  Davin            CAR 271916
.           Recompiled for WEBGROUP
. V10.03.24 07/08/2012  Davin         CAR 270114
.           Changes to handle WIES19
. V10.03.23 31/07/2012  Mike Laming      CAR 269695                   
.           Removed Grouper routine in MEDCOD50 - not needed & causes problems
.           Recompiled for WEBGROUP - added "drg62o" into SETPTH00 (missed it)
. V10.03.22 19/07/2012  Patrick Adair    CAR 268975
.           Added check of PMVXMHLS to MRTS4200 for screen button colour
. V10.03.21 26/06/2012  Mike Laming      CAR 267797 HDP 2012 DRG 6.2
.           Mods to GRPPIS00 & WIES0000 for DRG 6.2 - recomp for WEBGROUP etc
. V10.03.20 18/06/2012  Don Nguyen    CAR 261697
.           Recompiled for changes in WEBGROUP and PATDSCTM
. V10.03.19 07/06/2012  Mike Laming   CAR 265259
.           Mods to set Red "OK" button if MRCNRCDT = 1 & changes in Coding   
.           06/06/2012  Steve Armstrong  CAR 266680
.           Mods to remove read lock prior to updating patecdaf/patecoaf
.           to prevent I*P
. V10.03.18 05/06/2012  Mike Laming   CAR 266421
.           Moved CPDATS00 to WEBGROUP.PBL, mod MAIN1700 to set Grouper Dates
. V10.03.17 04/06/2012  Don Nguyen       CAR 261697                 
.           Recompiled for PATDSCTM - Output ward location for non-discharged
. V10.03.16 18/05/2012  Davin            CAR 260777 WA-HMDS Triggers
.           Added calls to proc WRWATR00 for updates to pmsvx1 (assoc. coding)
. V10.03.15 14/05/2012  Mike Laming   CAR 263424
.           Mods to Episode Dates & LOS in CPDATS00 for Episodic Coding
. V10.03.14 27/04/2012  Davin            CAR 260600 VAED-2012
.           Added care plan documented date to associated coding screens 
.           (hrsicu13/pmvxcpdd/MRTL1700)
. V10.03.13 23/04/2012  Nicole Torrisi   CAR 260103
.           Changed Onset Type (PTEDOSET) setting and output to include NZ i
.           (when checking PTCNHDPS)
. V10.03.12 28/03/2012  Davin            CAR 261935
.           Added legal status tag to assoc. coding screens (hrsicu12/MRTL1500)
.           Added legal status indicator tag (MRTL1600)
. V10.03.11 09/03/2012  Mike Laming      CAR 260916
.           Mods to GETMOR00 to bypass Morphology checks if ind. MRCNMORP is "1"
. V10.03.10 05/03/2012  Ebon Clements   CAR 261197
.           If episode coding is off, don't display a discharge date for
.           current admissions  - CPDATS00
. V10.03.09 02/03/2012  Ebon Clements   CAR 261108
.           Recompiled for PATDSCTM - Discharge ward short description tag
. V10.03.08 15/02/2012  J.Tan           CAR 259022
.           Mods checking for Primary Procedure with no Clinician
. V10.03.07 07/02/2012  Jill Parkinson  CAR 254812
.           Changed GETVIS00 to check for multi hospital & match user hosp code
. V10.03.06 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.05 19/12/2011  Mike Laming      CAR 257260 
.           Recompiled for WEBGROUP - Change OPERDATE to use MRCNOPDT = 2 for 
.           "No default Date"
. V10.03.04 08/12/2011  Mike Laming       CAR 248696
.           More mods to Red or Black Hospital Id (Added Cat TY test)
. V10.03.03 02/12/2011  Davin            CAR 251748
.           Recompiled for changes to PATWIS18
. V10.03.02 18/11/2011  Peter McMullen CAR 254569 
.           Extend location display fields to avoid truncation    
. V10.03.01 14/11/2011  Ebon Clements CAR 254375
.           Fixed save of MR move destination hospital - SAVMVE00
. V10.02.30 26/10/2011  Mike Laming   CAR 245178
.           Changes to CKEMR000 for External Cause Code errors
. V10.02.29 12/10/2011  Mike Laming   CAR 249210 & 249284
.           Added PATONLFD - Recompiled for WEBGROUP
. V10.02.28 11/10/2011  Davin         CAR 238236
.           Changes to handle WIES18
. V10.02.27 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PATMASTM & PMSPX2TM
. V10.02.26 03/10/2011  Peter Vela     CAR 251747
.           Initialised EPSTTDAT and EPENTDAT @ CPDATS00
. V10.02.25 30/09/2011  Jill Parkinson CAR 249963   
.           Removed baby weight error for wa health (warning in template)
. V10.02.24 29/09/2011  Mike Laming      CAR 249011
.           Added WAHEALTH to allow bypassing Date processing in WEBGROUP
. V10.02.23 26.09.2011  Saroeun Soeur    CAR 240110
.           SELLOC10 - display active destinations
. V10.02.22 26/09/2011  Mike Laming      CAR 248747  
.           Recompiled for WEBGROUP - Mods to GDSPX000 for WA Disease Prefix
. V10.02.21 23/09/2011 Ebon Clements   CAR 250401
.           Changed GETVIS00 to next next uncoded episode
. V10.02.20 22/09/2011 Ebon Clements   CAR 249387
.           Strip spaces from the end of the drg description - DISDRG00
.           Changed heading Times to Time in TOPHD000
. V10.02.19 21/09/2011 Ebon Clements   CAR 249287
.           Added redirect to next uncoded episode - CHKDIS00
. V10.02.18 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.17 05/09/2011  Mike Laming      CAR 241939
.           Mods to display Episode start & end Dates correctly (CPDATS00), add-
.           ed "lockepno" to freeze Episode No. List when from "Discharge List"
. V10.02.16 01/09/2011  Steve Armstrong  CAR 248500
.           Recompiled for changes to WEBGROUP.                           
.           Also added DGCLICAC triger to "delete all" for coding.
. V10.02.15 31/08/2011  Mike Laming      CAR 241939
.           Mods to SETGRP03, MEDCOD15 and WEBGROUP.PBL to Group Episodes
. V10.02.14 25.08.2011  Saroeun Soeur CAR 246011
.           SUMCOD80 - read patdschf if patpgraf is empty
. V10.02.13 25/08/2011  Mike Laming      CAR 241939
.           Mod to SELEPS00 to correct selection list of Episodes
. V10.02.12 23/08/2011  Mike Laming       CAR 249284 & 249210
.           Add DRGIND in WEBGROUP.PBL (Encoder ARE:)- Recompiled for WEBGROUP
.           Add CCCLASS in WEBGROUP.PBL (Encoder ARCL:)- Recompiled for WEBGROUP
. V10.02.11 23/08/2011  Mike Laming       CAR 240103
.           Mods to MRTS0000 and TOPTB200 to check if Clinician is present
. V10.02.10 22/08/2011  Ebon Clements     CAR 241939
.           Mods to CPDATS00 for phantom episode number
. V10.02.09 17/08/2011  Mike Laming       CAR 241939
.           Added CPDATS00 and tags in MRTS0000 for Episode Dates and Care Type
. V10.02.08 10/08/2011  Mike Laming       CAR 241939
.           Mods to CHKEPS00 for Episode Coding Episode Number, added EPCMPL00
.           with call at COMPLT50
. V10.02.07 05/08/2011  Ebon Clements     CAR 243611
.           Added Mrt locations with default to hospital id home loc - SELLOC00
. V10.02.06 28/07/2011  Ebon Clements     CAR 243582
.           Added using tracking receipt functionality
. V10.02.05 06/07/2011  Mike Laming      CAR 240724
.           Mods to MRT Tables for Hospital Id. - WA Health changes
. V10.02.04 11/05/2011  Mike Laming      CAR 240707 
.           Mods to use CLMRTHIS - caused by MRTHISFD file change.
. V10.02.03 12/04/2011 Peter Vela     CAR 239759
.           Added Multi Hospital variables for Cancer forms
. V10.02.02 04/04/2011  Mike Laming   CAR 240103
.           Mods to input/display "Procedure Clinician" on ICD Coding screens
. ......... 04/04/2011  Mike Laming   CAR 240107
.           Mods to fix Coding Screen Sort routine
. V10.02.01 24/03/2011  Mike Laming   CAR 240107
.           Change length of Indexes for PATECDaf and PATECOaf - increase all
.           work variables (eg ECODECNT, ECREQCNT, MAXARRY) - Alter KEYs
.           Remove PATMDSFD/IO and all code for PATMDSaf 
. V10.01.06 22/03/2011 Sandra Barcham CAR 240108
.           Replace variable METC8090 with METC7990 (C79.9 Cancer code)
. V10.01.05 15/02/2011  Mike Laming   CAR 237278
.           Replace variable METC7988 with METC8090 (C80.9 Cancer code)
. V10.01.04 14/02/2011  Mike Laming   CAR 238110
.           Remove Oper Times when CMORBDTM = 2 (No Operation Times) at TOPRW400
. V10.01.03 11/02/2011  Mike Laming   CAR 231176
.           Recompiled for WEBGROUP - added Cat."LS" to MH Legal Status routine
. V10.01.02 23/11/2010  Jill Parkinson CAR 233199
.           Added PTCNDSAC - go to discharge summary after coding
. V10.01.01 03/11/2010  Mike Laming   CAR 217573
.           Changed STINT004 to allow Baby Weight to be 4 or 6 chars - for NZ
. V10.00.21 18/10/2010  Ebon Clements CAR 218241
.           Clear operation date and times when copying coding - OPRCPY00 
. V10.00.20 07/10/2010  Mike Laming   CAR 227029
.           Correct 1st Birthday Baby Weight to display at MRTS1000 (to "<=")
. V10.00.19 30/08/2010  Mike Laming   CAR 224176
.           Recompiled for WEBGROUP - error in Prefix "P-C-A-M-"     
. V10.00.18 10/08/2010  Davin        CAR 227937
.           Recompiled for changes to PATWIS17
. V10.00.17 09/08/2010  Mike Laming   CAR 227073
.           added MRCNOPDT (in CONTROLF) - re-compiled for WEBGROUP
. V10.00.16 06/08/2010 Sandra Barcham CAR 227675
.           Allow coding of Restorative Care
. V10.00.15 02/08/2010  Mike Laming   CAR 227522
.           Recompiled for WEBGROUP - comment out "DFLTVFLG = 1"
. V10.00.14 28/07/2010  Ebon Clements CAR 226012
.           Changed the get metastatic codes tag to check for secondary cancers
.           that are coded before the primary cancer. GETMET00
. V10.00.13 19/07/2010  Ebon Clements CAR 226446
.           Fixed coder id display on cancer reg list - REGLST00
. V10.00.12 19/07/2010  Ebon Clements CAR 226443
.           Fixed display of metastatic site codes for add cancer reg - GETMET00
. V10.00.11 09/07/2010  Mike Laming   CAR 224838
.           Recompiled for WEBGROUP - fix length of PTICUMEC/XDRGHMV
. V10.00.10 18/06/2010  Mike Laming   CAR 224240
.           Fix DDATE value when un-discharged - use Current Date at CHKICD10
. V10.00.09 28/05/2010  Mike Laming   CAR 212604
.           Recompiled for WEBGROUP - mods to GDSPX000 for handling "PRFX:"
. V10.00.08 20/05/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.10.07 19/05/2010  Mike Laming   CAR 221538
.           Mods to GETPRM00, GETMOR00 and GETMET00 "Add Cancer Reg."          
. V10.10.06 05/05/2010  Mike Laming   CAR 212604
.           Add PTCNAAPE, Recompiled for WEBGROUP - add Prefix code as "PREFX:"
. V10.00.05 27/04/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
. V10.00.04 27/04/2010  Ebon Clements  CAR 220613
.           Added tag to display ICD10 edition on coding summary - DEDI0000
. V10.00.03 13/04/2010  Jill Parkinson CAR 219469
.           Changed HRSICU01,2,3 and 7 from form4 for form5
. V10.00.02 06/04/2010  Mike Laming    CAR 219246           HDP 2010
.           Re-compiled for VALDIOPS - Add ICD10 Ed.7 - Go-live Date PTCNGDV7
.       ... 01/04/2010  Jill Parkinson CAR 214276
.           Mods to calls to PATHCS00
. V10.00.01 31/03/2010  Mike Laming       CAR 208570
.           Recompiled for PATCRDFD & PATCRDTM - pad out PTCDMET4, 5 & 6
.       ... 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.       ... 24/03/2009  Davin             CAR 216505
.           Changes to handle WIES17
.-------------------------------------------------------------------------------
. V9.12.16  02/03/2010  Jill Parkinson CAR 214276
.           Mods to call PATHCS00 for all coding changes
. V9.12.15  04/02/2010  Mike Laming   CAR 208570
.           Recompiled for VALDIOPS - fix Secondary Cancers Morphology message
. V9.12.14  22/01/2010  Ebon Clements   CAR 211345
.           Added save of place of occurance ptmis029 to add coding MEDCOD10
. V9.12.13  24/11/2009  Mike Laming   CAR 208570
.           Mods to handle Secondry Cancer Codes for range "C77.0" to "C79.88"
. V9.12.12  18/11/2009  Mike Laming   CAR 210010
.           Re-compile for WEBGROUP - mods to Morphology Prefix
. ........  18/11/2009  Mike Laming   CAR 208570
.           Mods to VIC Cancer Reg. routines for Feb 2010 + mods in PATCRGTM
. V9.12.11  16/10/2009  Mike Laming   CAR 207222
.           add CONTROLF reads for CMORBDTM & PTMORBDT in MRTS0000
. V9.12.10  30/09/2009  Mike Laming   CAR 206625
.           Rework NZ Primary Diag. change to fix output of PTEDOSET @ SAVDIS30
. V9.12.09  09/09/2009  WeeLee Koo      CAR 184103
.           Read Admission file to get the exact ADATE (VALDTE00)
. V9.12.08  31/08/2009  WeeLee Koo      CAR 184103
.           Disable multiple primary diagnosis for NZ only (SAVECD00,SAVDIS00)
. V9.12.07  10/08/2009  WeeLee Koo      CAR 184103
.           Added Validation for Diagnosis Date (VALDDT00)
.           Multiple primary diagnosis should not be allowed-Screen 2 (SAVECD00)
.           Added date checking on Procedure Code Dates (VALDTE00)
.           Multiple primary diagnosis should not be allowed-Screen 1 (SAVDIS00)
. V9.12.04  15/07/2009  Mike Laming      CAR 210379
.           Correct "I*M" error on temp LODFILxx
. V9.12.03  01/07/2009  Davin            CAR 199724
.           Changes to handle WIES16
. V9.12.02  29/06/2009  Mike Laming  CAR 199900
.           Re-compiled for WEBGROUP - Reinstate routine GODTM000
. V9.12.01  19/06/2009  Mike Laming      CAR 197814 HDP 2009 DRG 6.0
.           Added DRG 6.0 at WIES1000 - re-compiled for WEBGRPVA & WEBGROUP
. V9.11.05  04/03/2009  Mike Laming    CAR 190768
.           Recomp for WEBGROUP - Mods for 2009 version of 3M Codefinder
.           (VAR41GRP & PAT41GRP now Obsolete - Replaced by WEBGRPVA & WEBGROUP)
. V9.11.04  18/03/2009  Ebon Clements  CAR 191021
.           Added functionality to sort all diagnosis and procedure codes
.           in one transaction -  SORTDI00 and SORTOP00
. V9.11.03  04/02/2009  Jill Habasque  CAR 184289
.           Mods to allow admission weight 9000 for NZ (unknown value)
. V9.11.02  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.01  29/10/2008  Peter Vela       CAR 181329
.           Fixed tags for Coding Date and Time
.           Write current date and time and copying coding from previous
.           discharge.
. V9.10.15  25/09/1008  Davin            CAR 178428
.           Recompiled for PATWIS15 - radiotherapy drg modification
. V9.10.14  26/08/2008  Mike Laming       CAR 176293
.           Recompiled for VALDIOPS - correct "Posting Code" test
. V9.10.13  12/08/2008  Jill Habasque    CAR       
.           Added branch on exit=2 after SUMCOD00
. V9.10.12  17/07/2008  Davin            CAR 163993
.           Changes to handle WIES15
. V9.10.11  17/07/2008  Mike Laming      CAR 173863
.           Fix Qld Coding if no Cancers - at CANCER91                
. V9.10.10  09/07/2008  Mike Laming      CAR 173199
.           Move routine DISHED00 & OPRHED00 to VALDIOPS (keep ICD10 
.           validations together) - Re-compiled for VALDIOPS - fix Go-live
.           dates for NZ               
. V9.10.09  09/07/2008  Jill Habasque    CAR 172636
.           Changed to show onset codes for all states (except nz or not aust)
. V9.10.08  08/07/2008  Mike Laming      CAR 173199
.           Recompiled for PAT16DIO and PAT16OIO - correct ICD10 Ed.3, 4 & 5 flg
. V9.10.07  08/07/2008  Mike Laming      CAR 173199
.           Recompiled for PAT16DIO and PAT16OIO - correct ICD10 Ed.6 flag
. V9.10.06  02/07/2008  Jill Habasque    CAR 172067
.           Mods to only output PTODSET if not spaces
. V9.10.05  11/06/2008  Mike Laming      CAR 168872
.           Changes to Cancer Reg for Qld in CANCER00 and CANOVR00
. V9.10.04  06/06/2008  Jill Habasque    CAR 166095
.           Mods to output PT0DDESC and PT0ODESC                    
. V9.10.03  06/06/2008  Mike Laming      CAR 168872
.           Changes to Cancer Reg warning in CANCER00 and CANOVR00
. V9.10.02  04/06/2008  Mike Laming      CAR 168872
.           Re-compiled for PATCDRTM - add cgi var for Date Extracted PTCDDTEX
. V9.10.01  28/04/2008  Jill Habasque    CAR 164874
.           Added default of PTEDOSET for ACT
. V9.09.16  22/04/2008  Jill Habasque    CAR 166203
.           Added default of PTEDOSET for WA
. V9.09.15  18/04/2008  Jill Habasque    CAR 166315
.           Added default of PTEDOSET for SA
. V9.09.14  07/02/2008  Davin            CAR 111499
.           Added check for SCN bed type to ICUBED00 (for associated coding)
. V9.09.13  24/01/2008  Peter Vela       CAR 153625
.           Added post and display functionality of HRSICU11 PATICUFD.PTICAMBN
. V9.09.12  21/12/2007  Peter Vela       CAR 157415
.           Added read to claim type and grouper version parameter when
.           populating DRGCODHF and DRGVERHF @ SUMCOD00
. V9.09.11  27/11/2007  Mike Laming      CAR 145686
.           Mods to allow Outpatients to use ICD Coding & Cancer Registration
.           Changes in MEDCOD.. SUMCOD.. and CANCOD.. etal to read PATVISaf
. V9.09.10  22/11/2007  Mike Laming   CAR 154835
.           Added code for Qld. Cancer Reg. "Basis for Diagnosis" in Report 8
. V9.09.09  30/10/2007 Jill Habasque  CAR 151947
.           Added output of PT0ODTMN in VALICO00
. V9.09.08  24/10/2007 Sandra Barcham CAR 142588
.           Fixed look deleting mrthisaf records at DELHIS00
. V9.09.07  13/09/2007  Ebon Clements CAR 100599
.           Recompiled for VALDIOPS - Added OUTPFLAG
. V9.09.06  28/07/2007  Steve Armstrong  CAR 148718
.           Recompiled for changes to PAT41GRP.
. V9.09.05  23/08/2007  Steve Armstrong  CAR 148509
.           Fixed RDPTDGW1 in INDRG000 to get latest DRG.
. V9.09.04  16/08/2007  Mike Laming      CAR 147943
.           Corrected DRG Code & Desc. CGIs and added ability to select Hospital
.           Default DRG Info and Health Fund DRG Info
. V9.09.03  02/08/2007  Steve Armstrong  CAR 145161
.           Removed references to WIES 7, 8, 9 & 10 - no longer supported.
.           Recompiled for changes to PAT41GRP & VARWIS14.
. V9.09.02  18/06/2007  Steve Armstrong  CAR 145161
.           Changes to handle WIES14
. V9.09.01  22/06/2007  Ebon Clements CAR 143153                       
.           Changed CODUSR00 to use passcode if web user is blank
.-------------------------------------------------------------------------------
. V9.08.14  18/05/2007  Mike Laming  CAR 125991                        
.           Add variables for Singapore Cancer Reg. - also added to PATCRDFD/IO
.           Change all RDPTICD1 reads to handle ICD9 codes for Sing. 
.        -  21/05/2007  Steve Armstrong CAR 125991                     
.           Added template variables for Singapore Cancer Reg:
.           103 - Gender - Male Flag
.           104 - Gender - Female Flag
.           105 - Marital Status - Single
.           106 - Marital Status - Married
.           107 - Marital Status - Divorced
.           108 - Marital Status - Separated
.           109 - Marital Status - Widowed
.           110 - Marital Status - Others
.           111 - Country of Birth - Singapore
.           112 - Country of Birth - Malaysia
.           113 - Country of Birth - China
.           114 - Country of Birth - Indonesia
.           115 - Country of Birth - India
.           116 - Country of Birth - Pakistan
.           117 - Country of Birth - Others
.           118 - Ethnic Group - Chinese
.           119 - Ethnic Group - Malay
.           120 - Ethnic Group - Indian
.           121 - Ethnic Group - Others
.           122 - Basis for Diagnosis - Death Certificate Only
.           123 - Basis for Diagnosis - Clinical Only
.           124 - Basis for Diagnosis - Clinical Investigation
.           125 - Basis for Diagnosis - Specified Tumour Marker
.           126 - Basis for Diagnosis - Cytology
.           127 - Basis for Diagnosis - Cytology Lab No.
.           128 - Basis for Diagnosis - Metastasis
.           129 - Basis for Diagnosis - Metastasis Lab No.
.           130 - Basis for Diagnosis - Primary Tumour
.           131 - Basis for Diagnosis - Primary Tumour Lab No.
.           132 - Grade/Diff. - Well
.           133 - Grade/Diff. - Moderate
.           134 - Grade/Diff. - Poor
.           135 - Grade/Diff. - Undifferentiated
.           136 - Grade/Diff. - T-cell
.           137 - Grade/Diff. - B-cell
.           138 - Grade/Diff. - Null cell
.           139 - Grade/Diff. - NK cell
.           140 - Grade/Diff. - N.O.S
.           141 - Present Status - Alive
.           142 - Present Status - Dead
.           143 - Place of Death
.           144 - Cause of Death Line 1
.           145 - Cause of Death Line 2
.           146 - Clinical Stage T
.           147 - Clinical Stage N
.           148 - Clinical Stage M
.           149 - Clinical Stage - Stage Grouping
.           150 - Clinical Stage - Class. Manual
.           151 - Treatment - No Treatment
.           152 - Treatment - Surgery
.           153 - Treatment - Surgery Initiation Date
.           154 - Treatment - Radiotherapy
.           155 - Treatment - Radiotherapy Initiation Date
.           156 - Treatment - Chemotherapy
.           157 - Treatment - Chemotherapy Initiation Date
.           158 - Treatment - Hormones
.           159 - Treatment - Hormones Initiation Date
.           160 - Treatment - Biological/Other
.           161 - Treatment - Biological/Other Initiation Date
.           162 - Treatment - Date of First Relapse
.           163 - Source of Notification - SN
.           164 - Source of Notification - OR
.           165 - Source of Notification - RS
.           166 - Date of Notification
.           167 - Notifying Doctor Code
.           168 - Notifying Doctor Formatted Name
.           169 - Notifying Hospital
.           170 - Notifying Doctor Surname
.           171 - Notifying Doctor Given Names
.           172 - Notifying Doctor Title
.           173 - Notifying Department/Clinic
.           174 - Treating Hospital - Same
.           175 - Treating Hospital - Other
.           176 - Treating Hospital - Other Description
.           177 - Resident Status - Singapore Citizen
.           178 - Resident Status - Singapore PR
.           179 - Resident Status - Malaysia
.           180 - Resident Status - Indonesia
.           181 - Resident Status - Other
.           182 - Consultant Code   
.           183 - Consultant Formatted Name
.           184 - Consultant Surname
.           185 - Consultant Given Names
.           186 - Consultant Title  
.        -  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
.        -  07/05/2007  Ebon Clements    CAR 139414 
.           2007 HDP changes
. V9.08.13  12/04/2007  Mike Laming      CAR 137125 HDP 2007 DRG 5.2
.           Added DRG 5.2 for WIES (changed DRG Version literals to INITs)
.           Added routine DCLM0000 needed for PATGNFEE changes             
. V9.08.12  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.11  01/03/2007  Jill Habasque  CAR 125126
.           Recompiled for VALDIOPS - Added gender error messages  
. V9.08.10  22/02/2007  Neelkamal Pyla CAR 116167
.           Added code to WIES0000 to display State DRG Description
. V9.08.09  25/01/2007  Peter Vela    CAR 127930
.           Added MRMADTUP MRMATMUP MRMAUUID before UPMRMASX 
. V9.08.08  05/01/2007  Ebon Clements CAR 130022
.           Added B2 to edit check in CHKINT00
. V9.08.07  13/12/2006  J.Tan         CAR 127625
.           Mods to Singapore HRN 
. V9.08.06  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.05  21/11/2006  Peter Vela        CAR 124550
.           Added Copy ICD Coding functionality for SJOG mrtweb0201001.html
. V9.08.04  16/11/2006  Steve Armstrong   CAR 124160
.           Added Singapore HRN for stationery templating (Canc. reg.)
. V9.08.03  16/11/2006  Peter Vela    CAR 115230
.           Fixed validations in SAVDIS00
. V9.08.02  10/11/2006  Davin         CAR 123200
.           Added new update type (I) to option 3 for manual input of drg
.           Added routine chicd000 to allow for icd9 codes (singapore only)
. V9.08.01  24/10/2006  Davin         CAR 121542
.           Fixed display of diagnoses codes row (tdtrw000)
.-------------------------------------------------------------------------------
. V9.07.10  25/09/2006  Ebon Clements CAR 119310
.           Changed CHKDIS00 to not select the same visit you have just coded
. V9.07.09  24/08/2006  Peter Vela    CAR 116826
.           Added PT99TIMW and PT99TSDW tags to WIES12, WIES13 at WIES0000
. V9.07.08  23/08/2006  J.Tan         CAR 116977
.           Mods PTCDSTAG Staging - Not used
. V9.07.07  19/07/2006  Peter Vela    CAR 112770
.           Added validations for episode no. CHKEPS00
. V9.07.06  17/07/2006  Peter Vela    CAR 112753
.           Recompiled for VALDIOPS
. V9.07.05  11/07/2006  Davin S       CAR 111764
.           Added 2006/2007 WIES13 file (patw13af)
. V9.07.04  10/07/2006  Peter Vela    CAR 111913
.           Recompiled for PAT41GRP
. V9.07.03  10/07/2006  Peter Vela    CAR 111913
.           Recompiled for PAT41GRP
. V9.07.02  06/07/2006  Peter Vela    CAR 111376
.           Added new NXTPAG00 subroutine WINEX100 close 
.           parent.parent.PopUpScreen
. V9.07.01  03/07/2006  Peter Vela    CAR 110906
.           Fixed 5.1 grouper version display
. V9.06.03  07/06/2006  J.Tan         CAR 96476  
.           Added new fields to Cancer registration
. V9.06.02  26/05/2006  Ebon Clements CAR 104165 
.           2006 QLD HDP mods - Added diagnostic onset type
. V9.06.01  16/05/2006  Mike Laming   CAR 105244           2006 HDP
.           Add ICD10 Ed.5 variable PTCNGDV5 and DRG Ver 5.1
. V9.05.03  23/03/2006  Peter Vela    CAR 61299
.           Increased field no size from DIM3 to DIM5 for stationery templating 
. V9.05.02  17/03/2006  Ebon Clements CAR 89155
.           Mods for multi hospital medical record locations
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B05 02/03/2006  Peter Vela    CAR 95945
.           Modified error message for ICD Coding add screen
. V9.05.B04 28/02/2006  Peter Vela    CAR 95945
.           Fixed error message for ICD Coding add screen
. V9.05.B03 24/02/2006  Peter Vela    CAR 95945
.           Added validation to restrict diagnosis and procedure code entries
.           to 99 each
. V9.05.B02 03/02/2006  Peter Vela    CAR 92244
.           Recompiled for PAT41GRP
.           Added new nextpage value 8=Redirect parent with alert
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.28  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.27  11/11/2005  Jill Habasque CAR 55028
.           Added write to patodcaf
. V9.04.26  31/10/2005  Jill Habasque CAR 61741
.           Added tag for HIHLOS
. V9.04.25  26/10/2005  Ebon Clements CAR 72448
.           Added print cancer reg form to add cancer registration
. V9.04.24  21/10/2005  Jill Habasque CAR 80709
.           Fixed to goto CANCER99 at CANCER90
. V9.04.23  07/10/2005  Ebon Clements CAR 50415
.           Changed GETVIS00 and CHKDIS00 to scan one year of visits
. V9.04.22  20/09/2005  Jill Habasque CAR 75791
.           Commented out calls to AGEDIT00 - these should not be required if 
.           ICD table has age edits set up
. V9.04.21  12/09/2005  Mike Laming              CAR 62290
.           Add check for Age ( < 1yr.) at AGEDIT00             
. V9.04.20  17/08/2005   J.Tan        CAR 62750
.           Recompiled for WEBDINVS - not to use the redefined amount variables
. V9.04.19  17/08/2005  Ebon Clements CAR 72181
.           Added update of ACOMM1 and ACOMM2 in MEDCOD20 and MEDCOD60
.           for nz associated coding
. V9.04.18  22/07/2005  Peter Vela    CAR 66960
.           Added 2005/2006 WIES12 file (patw12bf)
. V9.04.17  19/07/2005  Ebon Clements CAR 66500
.           Added new tag for coding comments
. V9.04.16  30/05/2005  Peter Vela    CAR 60167
.           July 2005 Mods for PRS/2 - Validation for Intention to Readmit
.                                      Separation Mode
.           24/05/2005  Mike Laming   CAR 61562   
.           July 2005 mods for DRG 5.1 - Recomp for PAT41GRP & VAR41GRP
.           - at WIES0000 - temporary changes for DRG 5.1
. V9.04.15  08/06/2005  Jill Habasque    CAR 61013
.           Added ACAS outputs        
. V9.04.14  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.13  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.12  16/02/2005  Peter Vela               CAR 56959
.           Added combine of linked visits to duplicate medical records
.           when merging.
. V9.04.11  17/01/2005  Henry Son                CAR 54558
.           Check to see if there are any codes, if not delete DRG.
. V9.04.10  11/01/2005  Lina Vo                  CAR 55670
.           Change Add Cancer Reg (CANCOD10) to only redirect to Reason screen
.           for QLD
. V9.04.09  04/01/2005  Lina Vo                  CAR 55676
.           Change CANCOD70 to read master file using admission record UR number
.           Clear urnumber and admissno cgi variables so patients don't get 
.           swapped when none passed.
.           Change CANCOD70 to only read master file by common urnumber when on
.           Cancer Reg List by Visit (mrtweb0208004.html).
. V9.04.08  22/12/2004  Peter Vela               CAR 50640
.           Default 1 if episode number is = 0 when reading patpgraf
. V9.04.07  13/12/2004  Henry Son        CAR 55406
.           Change CME to read new output format.
.           Re-compile PAT41GRP.
. V9.04.06  30/11/2004  Henry Son                CAR 54882
.           Populate operation times from patmmbsf.
.           Re-compile PAT41GRP.
. V9.04.05  24/11/2004  Lina Vo    CAR 34301
.           Add tag for Audit Date
. V9.04.04  04/10/2004  Peter Vela CAR 53464
.           Added new variables to Cancer Registration stat template
. V9.04.03  08/09/2004  Henry son                CAR 52585
.           Add Indeterminate to Sex check.
. V9.04.02  07/09/2004  Lina Vo                  CAR 52865
.           Allow ICD Coding to be completed even when Cancer Reg has not been
.           created.
. ........  01/09/2004  Henry son                CAR 53126
.           Further changes for WIES12.
.           Diagnosis or procedure incompatible with SEX code.
.           Recompile for changes in PATWIS12.
. V9.04.01  20/06/2004  Peter Vela               CAR 50640
.           Reset Episode no to one when accessing ICD Coding template
.           (mrtweb0203001.html) via change patient pop up screen.
.-------------------------------------------------------------------------------
. V9.03.30  28/07/2004  Henry Son                CAR 51504
.           Add WIES12 (2004/2005 changes)
. V9.03.29  28/07/2004  Pat Dirito               CAR 52153
.           Added function GRPDIS00 - Format Grouper display        
. V9.03.28  27/07/2004  Jill Habasque            CAR 50862
.           Changed CHLPYR00 to use adate instead of current date
. V9.03.27  20/07/2004  Lina Vo                  CAR 50862
.           Added leap year into calculation of admission weight (CHLPYR00) 
. V9.03.26  20/07/2004  Lina Vo                  CAR 51071
.           Changed CANCER00 to also display admission date.             
. V9.03.25  12/07/2004  Lina Vo                  CAR 51071
.           Added functionality to report 8 to add and delete Reason for 
.           Clinical Diagnosis.
. ........  30/06/2004  Henry Son                CAR 50344
.           Call new 3M Quickgroup.
. V9.03.24  01/07/2004  Ebon Clements            CAR 51076
.           Added update of autopsy and place of occurance from associated
.           coding screen
. V9.03.23  30/06/2004  Pat Dirito               CAR 51078
.           Added PTCNOENC - Using Online Encoder Parameter
.           30/06/2004  Ebon Clements            CAR 51070
.           Added TAG MRTS3700 - Grouper version
. V9.03.22  21/06/2004  Henry Son                CAR 49037
.           Add ICD Edition 4 changes. Include VALDIOPS.
. V9.03.21  17/06/2004  Peter Vela    CAR 49016  July 2004 PRS/2
.           - Recompiled for PMSPX2TM
.           11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.20  30/03/2004 Ebon Clements    CAR 48433
.           Added clear of MRHIDDUE in CALDUE00
. V9.03.19  26/03/2004 Peter Vela       CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.18  03/03/2004  Jill Habasque   CAR 47761
.           Modified to allow coding of current inpatients
. V9.03.17  12/02/2004  Sylvek Litewka  CAR 47213
.           Modified procedure REGLST00 to set up ICDRDDTE using Discharge Date
.           before reading ICD files.
. V9.03.16  21/01/2004  Henry Son  CAR 46856
.           Further mapping changs to Nasopharyngeal Intubation.
.           Map 9017902 and 9017905 to 9203500 for grouper.
.           Recompiled for PAT41GRP, PATWIS10, PATWIS11
. V9.03.15  22/12/2003  Sylvek Litewka  CAR 45685
.           VIC DHS 2003 changes - ICD10v3 changes. Added CGI parameter 
.           SEXASSCD to indicate that a Sex Associated code was entered when 
.           coding via "mrtweb0201001.html".
.           18/12/2003  Peter Vela      CAR 43134
.           Recompiled for MRTCONFD
.           17/12/2003  Sylvek Litewka  CAR 20222
.           Modified ICD Coding and Cancer Registration functions to to use 
.           patient Discharge Date when accessing ICD Disease and Procedure
.           files. 
. V9.03.14  25/11/2003  Pat Dirito      CAR 40313
.           Added code for lock patient during Coding
.           LOCSCR00, DELLCK00, UNLOCK00 
. V9.03.13  29/10/2003  Sylvek Litewka  CAR 44328
.           Mods to populate and display new Free Format Description fields 
.           patecdaf.PTEDDESC and patecoaf.PTEODESC based on the value of 
.           CFFMORB parameter (Allow Description Change in Morbidity).
. V9.03.12  30/10/2003  Jill Habasque CAR 43466
.           Changed MEDCOD20 to allow changes before a patient is discharged
. V9.03.11  23/10/2003  Henry Son                CAR 41650
.           Fix Nasopharyngeal Intubation.
.           Re compile to pick up PATWIS10 and PATWIS11
. V9.03.10  14/10/2003 Guomin Fu     CAR 41584
.           Added to read in MRCNSOMV and Recompiled for PAT41GRP
. ......... 10/10/2003 Henry Son     CAR 44242
.           Fix Calc. of Hosptital home days.
.           Re-Compile RHIHDAYS
. V9.03.09  10/10/2003 Jill Habasque CAR 43243
.           Recompiled for PAT41GRP - Added move of one to GRPVER in lodenc00
. V9.03.08  24/09/2003 Jill Habasque CAR 41315
.           Added write to patpeiaf when updating associated coding
. ........  23/09/2003 CAR 43526   Henry Son
.           Fix Grouper 4.1 to use WIES8.
. V9.03.07  08/09/2003 Jill Habasque CAR 43142                   
.           Added match for spaces at SUMM1200 and SUMM1300
. V9.03.06  04/09/2003 Jill Habasque CAR 43143                   
.           Added match for spaces at SUMM2300
. V9.03.05  12/08/2003 CAR 42039   Henry Son
.           Added WIES11 functionality
. V9.03.04  12/08/2003 Guomin Fu    CAR 42210
.           Fix to allow combination of CAT VR HDP 0 and CAT DD HDP S at
.           CHKINT00
. V9.03.03  01/07/2003 Jill Habasque             CAR 40660
.           Recompiled for PATDSCTM
. V9.03.02  28/05/2003 Davin                     CAR 38714
.           Added broadcast of medical record movements (DGCLICRM)
. V9.03.01  10/04/2003 Lina Vo                              
.           Added ptcrd008 to urllink in REGRW000 so CANCOD70 can read patcrdaf
.           with the whole key.
.-------------------------------------------------------------------------------
. V9.02.97  21/03/2003 Tracey Nguyen             SRF 23950
.           Changed KEY16 to KEY25 for all read/write/update/delete to PATCRDA1
. V9.02.96  19/03/2003 J.Tan
.           Mods to clear DRG discharge after deleting grouper details
. V9.02.95  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
. V9.02.94  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.93  07/01/2003  Jill Habasque            SRF 35080
.           Increased length of WEBERR                         
. V9.02.92  12/12/2002  Pat Dirito               SRF 34063
.           Added variable PTEODRGD                            
. V9.02.91  05/12/2002  Pat Dirito               SRF 34145
.           Routine CANCER00 now listing Cancer regs for a U/R.
. V9.02.90  04/12/2002  Pat Dirito               SRF 34066
.           Routine DISCON00 was reading back without a positional read.
. V9.02.89  20/11/2002  Pat Dirito               SRF 33644
.           Fixed read of PTCNI10D was reading incorrect position
. V9.02.88  11/10/2002  Pat Dirito               SRF 22696
.           Changes for NZPAS - Displaying of Accident Dates TDTRW000
. V9.02.87  09/10/2002  Peter Vela               SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.86  04/10/2002  Pat Dirito               SRF 22422  
.           Modified weberror message in VDCB0000.
. V9.02.85  17/09/2002  Pat Dirito               SRF 22304  
.           Added routine CTBH0000 to round up and output LOS Hours.
. V9.02.84  29/08/2002  Pat Dirito               SRF 21608  
.           Recompiled for PAT41GRP and fixed read of parameter CMDISL.
.           Jill Habasque  SRF 17573
.           Recompiled for PAT41GRP                      
. V9.02.83  27/08/2002  Pat Dirito               SRF 21538  
.           Added output flag for CPAP hrs
. V9.02.82  20/08/2002  Pat Dirito               SRF 21159
.           Recompiled for PAT41GRP & modified delete of patpgraf record
. V9.02.81  14/08/2002  Davin                    SRF 20183
.           Recompiled for PATWIS10
. V9.02.80  12/07/2002  Pat Dirito               SRF 18264,19847,19123
.           Added Cancer Registration option 8 & various routines.
.           Recompiled for PAT41GRP              
.           Removed routine MECHCK00 no done in js.
. V9.02.79  26.07.2002 Davin
.           Added WIES10 functionality
. V9.02.78  17.07.2002 Davin                     SRF 18551,18323
.           Recompiled for PATWIES9
. V9.02.77  03/07/2002  Pat Dirito               SRF 19336                    
.           PTCNGDV3 was read from incorrect pos.                    
.           05/07/2002  Davin
.           Read parameter PNSWRACE
. V9.02.76  02.07.2002 Pat Dirito                SRF 19123
.           Modified MECHCK00 now checks combined Mech & NIV Hrs              
. V9.02.75  27.06.2002 Pat Dirito                SRF 19126
.           Changes to allow the use of Header codes, as some V2 Posting codes
.           have changed to Header Codes.
.           Modified TOPRW000 to output Operation Date/Time
. V9.02.74  25.06.2002 Pat Dirito                SRF 18988        
.           Changes for Hours of Constant Positive Air Pressure.
. V9.02.73  20.06.2002 Davin                     SRF 18551,18323
.           Recompiled for PATWIES9
. V9.02.72  06/06/2002 J.Tan                                            
.           Added unplanned readmission and unplanned visit to theatre
.           06/06/2002 Pat Dirito                SRF 18489 
.           Added read on Discharge File in routine CHKICD00           
. V9.02.71  30/05/2002 Pat Dirito                SRF 17760              
.           Added routine CODOVR00 for Warning message.        
.           30.05.2002 Davin                     SRF 18236
.           Recompiled for PATWIES9
. V9.02.70  22/05/2002 Pat Dirito                SRF 17837              
.           Saving of Admission weight when exporting encoder 
. V9.02.69  20/05/2002 Pat Dirito                SRF 17536,17541,17543
.           Grouper now executed for saving of templates & copying of previous
.           discharges.
. V9.02.68  26/04/2002 Pat Dirito    
.           Wrapped IO write WRMDSA1 in RA read.
. V9.02.67  02/04/2002 Pat Dirito    
.           Recompiled for PAT41GRP              
. V9.02.66  28/03/2002 Pat Dirito    
.           Recompiled for PAT41GRP              
. V9.02.65  26/03/2002 Pat Dirito    
.           Modified CHLINT00 to now replace 3/1 
. V9.02.64  20/03/2002 Pat Dirito    
.           Modified MECHCK00 - error checks now done in Javascript 
. V9.02.63  15/03/2002 Pat Dirito    
.           Added parameter PTCNODRG - Using DRG Grouper
. V9.02.62  13/03/2002 Pat Dirito    
.           Ported Grouper routines to PAT41GRP.PBL
.           Added parameters MRCNGRUP & MRCNMECH    
. V9.02.61  26/02/2002 Ebon Clements 
.           Added TRAP to SAVICU00 to prevent I * D at RCH
. V9.02.60  19/02/2002 Pat Dirito
.           Added routine WINRLD00 which display an alert on screen and then
.           refresh the page. Encoder error message problems! 
.           14/02/2002 Pat Dirito   
.           Added Report 8 Cancer Coding
. V9.02.59  14/02/2002 Jill Habasque
.           Added check for bad debts in GETVIS00
. V9.02.58  12/02/2002 Pat Dirito  
.           Added RA in SAVICU00 even though not needed as for reasons unknown
.           was getting an I * D at RCH?? 
. V9.02.57  11/02/2002 Pat Dirito  
.           Added Save on Associated Coding without checking for Codes(MEDCOD60)
.           10/02/2002 B.G.Ackland
.           Move Zero to NICU field
. V9.02.56  05/02/2002 Pat Dirito 
.           Routine ENDLDI00, STRLDI00, STRLOP00 & ENDLOP00 had RA -Reads 
.           added, these are not needded as they are swapping routines!!! 
.           When RA's where added lost pointer in file which inturn lost records
. V9.02.55  04/02/2002 Pat Dirito 
.           Changes to MECHCK00 Changes to Error Messages & added submit before 
.           Encoder. 
.           Changed WIES0000 to output Low & High Inliner Boundary Point(days)
. V9.02.54  02/02/2002 Pat Dirito 
.           WRENC000 was using current date to calculate patients age. 
.           Should be Admission Date 
. V9.02.53  01/02/2002 Pat Dirito 
.           MECHCK00 was not checking CCU hrs agianst LOS   
. V9.02.52  31/01/2002 Pat Dirito 
.           Modified ICUBED00 to check all transfer records       
. V9.02.51  29/01/2002 Pat Dirito 
.           Modified ICUBED00 to output flags for individual Bed Types.      
.           Added Tags for Low Trim, High Trim & LOS from WIES files. 
. V9.02.50  24/01/2002 Pat Dirito 
.           Modified GETVIS00 to return Current Visit & Admission Type 
.           VALVIS00 is now also returning Admission Type
. V9.02.49  23/01/2002 Pat Dirito 
.           Fixed calls to IBACLOCK and use of variable CURRDATE.       
. V9.02.48  22/01/2002 Pat Dirito 
.           Added PTICCPAP & PTICHNCU to CLRICU00                       
. V9.02.47  21/02/2002 J.Tan         
.           Mods to read the grouper details file without grouper version if the
.           record for the current grouper version not exist.
. V9.02.46  18/01/2002 Ebon Clements 
.           Added a tag to show the U/R to keep records in the medical record
.           merge screen.Added a delete checkbok to the merge record list
. V9.02.45  18/01/2002 Pat Dirito 
.           Now checking Mech hrs against (ICU hrs + NCU hrs) in routine
.           MECHCK00. Added CGI var EXPRTENC which will export the encoder
. V9.02.44  18/01/2002 J.Tan
.           Mods to read before write to avoid I*D on patecoaf file
. V9.02.43  17/01/2002 J.Tan
.           Mods to read before write to avoid I*D on patecdaf file
. V9.02.42  15/01/2002 Pat Dirito    
.           Recompile for changes to PATMISTM
. V9.02.41  11/01/2002 Ebon Clements 
.           Recompile for changes to MRTPDSFD
. V9.02.40  10/01/2002  Pat Dirito 
.           Corrected Resequencing of Unique Record Counter in patecdaf & 
.           patecoaf routine DISSQE00 & PROSQE00
. V9.02.39  08/01/2002  Pat Dirito 
.           Added Validation against Intention to Readmit routine -CHKINT00     
. V9.02.38  04/01/2002  Pat Dirito 
.           Added PTCNICUT - Checking for an ICU/NCU Bed Type? When writing
.           ICU/NCU hrs. Also removed routine INTUBA00 now doing intubation
.           checks in javascript. 
. V9.02.37  17/12/2001  Pat Dirito 
.           Changes to routine DRGCCL00 as was using incorrect sequence.  
. V9.02.36  15/12/2001  Pat Dirito 
.           Added WGHTSV00 to MEDCOD40 & Clear Encoder Option to SETGRP00
. V9.02.35  14/12/2001  Pat Dirito 
.           Modified DRGCCL00 Exclude Morphology Codes!                
. V9.02.34  11/12/2001  Pat Dirito 
.           Changes to Admission weight checks for RCH                 
. V9.02.33  10/12/2001  Pat Dirito 
.           Age Edit now in if statement on Coding Complete (SUMCOD60) 
. V9.02.32  07/12/2001  Pat Dirito 
.           Changed GETVIS00 to also return last coded visit, if all visits 
.           in the range are coded.                     
. V9.02.31  06/12/2001  Pat Dirito 
.           Added Edit on Hrs of ICU against LOS                      
.           Changed WGHTCK00 & VDCB0000 to reflect conditions of upto 9999
. V9.02.30  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
.           04/12/2001  Pat Dirito
.           Added UR & Admission validation to Coding Template Saving(MEDCOD40)
. V9.02.29  03/12/2001  Pat Dirito 
.           Set Intention to Readmit/Planned Readmit to save correctly
. V9.02.28  29/11/2001  Pat Dirito 
.           Added Extra Weight Checks to Associated Coding Updating
. V9.02.27  27/11/2001  Pat Dirito 
.           Mods to Routine DISDRG00
. V9.02.26  26/11/2001  Pat Dirito 
.           Added edits for Intubation Codes                           
. V9.02.25  23/11/2001  Pat Dirito 
.           Set Primary Diagnosis DRG Driver to 1 in routine DRGCCL00  
. V9.02.24  22/11/2001  Pat Dirito 
.           Made Mods to highlighting of DRG Drivers                        
. V9.02.23  22/11/2001  Pat Dirito 
.           Load CCL values from Unix Grouper                               
.           Reset Grouper to run on Swaping of Codes
. V9.02.22  21/11/2001  Pat Dirito 
.           Mods to to output ICD9 Descriptions on Summary Coding Screen   
.           Recompiled for VALDIOPS
. V9.02.21  20/11/2001  Ebon Clements 
.           Move medical record when the post discharge status is updated 
.           in the icd coding screen if the record destination is not blank
.           Added save key to record merge to save position in mrtmasaf
.           20/11/2001  Pat Dirito    
.           MEDCOD00 & SUMCOD00 Now writing to Episode Morbidity File(patecmaf) 
.           Added Mechanical Ventilation Checks to Associated Coding(MEDCOD20)
. V9.02.20  19/11/2001  Pat Dirito 
.           Changes for Neonate weight edits & mods to NEXTAD00 & PREVAD00 
. V9.02.19  18/11/2001  Pat Dirito 
.           Mods for Extra Age Edits and displaying of OK button. 
. V9.02.18  17/11/2001  Pat Dirito 
.           Mods for Unix Grouper & Extra Edit Checks on Coding
.           16/11/2001  Pat Dirito 
.           New tag to output Age at Admission                  
.           16/11/2001  Ebon Clements
.           Changed GETVIS00 function to return the oldest uncoded discharge
. V9.02.17  07/11/2001  Pat Dirito 
.           Mods to allow for use of Unix Grouper              
.           07/11/2001  Davin
.           Mods WIES9 (2001/2002)
. V9.02.16  03/11/2001  Pat Dirito 
.           Now also Deleting Grouper Detail Record            
. V9.02.15  03/11/2001  Pat Dirito 
.           Mods to display of weight alert.(routine NEONAT00) 
. V9.02.14  01/11/2001  Greg Horvat
.           Recompiled for PATGILOS - Added xtra option to the parameter.
.           PTCNDSCI & recompiled for PATWIES7 & PATWIES8 - Added xtra option
.           to the parameter PNSWRACE
.           30.10.2001 Pat Dirito
.           Added UPDPRE00 & DISCON00(remote scripting)
. V9.02.13  29.10.2001 Pat Dirito    
.           Now only loads PATECOFD & PATECDFD with ICD10 Codes others will be
.           Ignored!!!
. V9.02.12  26.10.2001 Pat Dirito    
.           Added Fatal Warning if no Diagnosis code present when Coding
.           Complete is checked.
.           Recompiled for VALDIOPS
. V9.02.11  24.10.2001 Pat Dirito    
.           Modified Coding Date & Time Output now outputs last Coding Date &
.           Time. Defualts Coding Complete Box to unticked when there are no
.           Disease or Procedure Codes
. V9.02.10  24.10.2001 B.G.Ackland
.           Strip Spaces off End of Codes for Encoder
. V9.02.09  22.10.2001 Pat Dirito    
.           Now using ADATE when checking for Weight Checks and Displays..
.           Search for AGEDATE when looking for the mods I have made!!!   
. V9.02.08  18.10.2001 Pat Dirito    
.           Recompiled for VALDIOPS                                          
.           17.10.2001 Pat Dirito    
.           Now capturing Web User ID in Episode Coding (PATECDFD & PATECOFD)
. V9.02.07  12.10.2001 Pat Dirito    
.           Added CMDISM to MRTS0000
. V9.02.06  10.10.2001 B.G.Ackland 
.           Fix I * U on UPDT0000
. V9.02.05  08.10.2001 Pasquale Dirito 
.           Modified LOCSEL00 to only display home locations.
.           20.09.2001 J.Tan
.           Mods to refresh screen after error in grouper in swap procedure.
. V9.02.04  17.09.2001 J.Tan
.           Mods to display CCL for each disease code
. V9.02.03  04.09.2001 J.Tan
.           Added Reason for Critical care transfer (PMVXRCCT)
. V9.02.02  31.08.2001 J.Tan
.           Default coding date/time if not episode disease/operation code
. V9.02.01  23.08.2001 J.Tan
.           Default coding date/time to current on the associated screen
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.001 14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B07 13.07.2001 Sandra Barcham
.           Replaced GP with HCP
. V9.00.B06 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B05 07.06.2001 B.G.Ackland
.           Fixed saving encoder details and move disgnosis
. V9.00.B04 06.06.2001 Pat Dirito 
.           Fixed saving of Post Discharge Status    
. V9.00.B03 24.05.2001 Ebon Clements
.           Fixed warning message for discharge date
. V9.00.B02 22.05.2001 B.G.Ackland
.           Grouper / Encoder Update
.--------------------------------------------------------
.                 V5.10.B04 21/05/2001 Pat Dirito    
.                           Fixed array out of bounds in merge records   
.                 V5.10.B03 01/03/2001 Pat Dirito    
.                           Added Intention to Readmit - param(HRSICU06)
.                 V5.10.B02 01/03/2001 Pat Dirito    
.                           Added Intention to Readmit - param(HRSICU06)
.                           Mods for Grouper(Finished as of 3/5/2001)
.                 V5.10.B01 26/02/2001 Jill Habasque
.                          Mods for ABWGHT - changed from DIM 4 to DIM 6     
.                 V5.09.B05 20/02/2001 Pat Dirito 
.                          Reinitialised Grouper Details File                
.                 V5.09.B04 20/02/2001 Pat Dirito 
.                          Made mods to Coding Incomplete Now Coding Complete
.                 V5.09.03 12/02/2001 J.Tan
.                          Mods for Medical Record Merge
.                 V5.09.02 15.01.2001 Bronko Sosic 
.                          Recompiled for PATMASTM                         
.                 V5.09.01 09.01.2001 Katie Nelson 
.                          Added control cache header                      
.                 V5.09.00 11.09.2000 Pat Dirito  
.                          Created Program                                      
.                    
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
.  For Grouper
.
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATVADFD/INC
          INC       PATDADFD/INC
          INC       PATODCFD/INC
          INC       WEBDINVS/INC
          INC       WEBGRPVA/INC          * Variables for WEBGROUR (was PAT41GRP
          INC       VARWISCM/INC          * Common variables for WIES
          INC       VARWIS11/INC          * Variables for PATWIS11
          INC       VARWIS12/INC          * Variables for PATWIS12 
          INC       VARWIS13/INC          * Variables for PATWIS13
          INC       VARWIS14/INC          * Variables for PATWIS14
          INC       VARWIS15/INC          * Variables for PATWIS15
          INC       VARWIS16/INC          * Variables for PATWIS16
          INC       VARWIS17/INC          * Variables for PATWIS17
          INC       VARWIS18/INC          * Variables for PATWIS18
          INC       VARWIS19/INC          * Variables for PATWIS19
          INC       VARWIS20/INC          * Variables for PATWIS20
          INC       VARWIS21/INC          * Variables for PATWIS21
          INC       PATW11FD/INC          * WIES11 File 
          INC       PATW12FD/INC          * WIES12 File
          INC       PTW12BFD/INC          * WIES12B File
          INC       PATW13FD/INC          * WIES13 File
          INC       PATW14FD/INC          * WIES14 File
          INC       PATW15FD/INC          * WIES15 File
          INC       PATW16FD/INC          * WIES16 File
          INC       PATW17FD/INC          * WIES17 File
          INC       PATW18FD/INC          * WIES18 File
          INC       PATW19FD/INC          * WIES19 File
          INC       PATW20FD/INC          * WIES20 File
          INC       PATW21FD/INC          * WIES21 File
          INC       PATWIEFD/INC          * WIES   File
          INC       PATRDCFD/INC
          INC       PATASFFD/INC
          INC       PATHLFFD/INC
          INC       PATHSPFD/INC
          INC       PATBFEFD/INC
          INC       PATCMPFD/INC   
          INC       PATCDEFD/INC
          INC       PATCMXFD/INC
          INC       PATIPEFD/INC
          INC       PATVENFD/INC
          INC       MEHDLSFD/INC
          INC       VISXDCTD/INC
          INC       VISXDCFD/INC
.
          INC       CHKDIGVR/INC
          INC       APSMASFD/INC
          INC       MEHHONFD/INC
          INC       MEHLERFD/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCANFD/INC
          INC       PATCRGFD/INC   * Cancer registration Header
          INC       PATCRDFD/INC   * Cancer registration Details
          INC       PATCRDTD/INC   * Cancer registration Details cgi vars
          INC       PMSCDGFD/INC   * Reason for Clinical Diagnosis (Cancer)
          INC       PATCONFD/INC
          INC       PATCMCFD/INC
          INC       PATECMFD/INC   
          INC       PATDO1FD/INC   * Doctor File
          INC       PATDGWFD/INC
          INC       PATDSCFD/INC
          INC       PATPGRFD/INC   * Grouper Details
          INC       PATTRNFD/INC
          INC       PATIN1FD/INC
          INC       PATITMFD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATPEIFD/INC
          INC       PATMA1FD/INC
          INC       PMSBRQFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSIHIFD/INC   * IHI Details
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSVMTFD/INC
          INC       OPRCLIFD/INC
          INC       OPRDEAFD/INC
          INC       OPRARDFD/INC
          INC       OPRSRGFD/INC
          INC       OPRSESFD/INC
          INC       OPRTSMFD/INC
          INC       PATWR1FD/INC
          INC       OUTSITFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCFAFD/INC
          INC       PMSCIDFD/INC
          INC       PMSPWAFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATPR1FD/INC
          INC       PATMMBFD/INC
          INC       PATCHCFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATONHFD/INC
          INC       PMSADWFD/INC
          INC       PMSWTRFD/INC
          INC       MLTSECFD/INC
          INC       MRTAUCFD/INC
          INC       MRTCIEFD/INC
          INC       MRTMASFD/INC
          INC       MRTHISFD/INC
          INC       MRTMOVFD/INC
          INC       MRTLOCFD/INC
          INC       MRTCONFD/INC
          INC       MRTPDSFD/INC
          INC       MRTPSHFD/INC
          INC       MRTTHDFD/INC
          INC       MRTTDTFD/INC
          INC       MRTRQDFD/INC
          INC       MRTRESFD/INC
          INC       MRTVISFD/INC
          INC       MRTCAHFD/INC
          INC       MRTCADFD/INC
          INC       MRTCAHTD/INC
          INC       MRTCADTD/INC
          INC       PATRE1FD/INC
          INC       IBATMDFD/INC
          INC       VISCMTFD/INC
          INC       VISCODFD/INC
          INC       VISCODTD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATONLFD/INC
          INC       OPRCONFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PMSABFFD/INC
          INC       PATINVFD/INC
          INC       PATMISTD/INC
          INC       TFILEVAR/INC
          INC       PMSCCDFD/INC   * Concession Card Details
.
.---------------------------------------------------------------------------
.   Variables
.---------------------------------------------------------------------------
AGECARAS  DIM       3
AVAILSEQ  DIM       3 
.
CANDSC01  FORM      3
CANDSC02  FORM      3
CCAERRKY  DIM       24
CCARFLAG  FORM      1
CLINREQD  FORM      1       * Clinicion required on Coding Screen
CLUSTERV  DIM       2       * Cluster value
CDCIDBUT  FORM      1       * Display clear DCID button flag
DATEREQD  FORM      1       * Date required on Coding Screen
DCIDCLAS  DIM       15      * DCID class
DISPDTTM  FORM      1       * Display coding date and time
TIMEREQD  FORM      1       * Time required on Coding Screen
DRGVERZ   DIM       3                                      
DRGVERHF  DIM       3       * Health Fund Grouper Version   
DRGCODHF  DIM       4       * Health Fund Grouper Code       
DRGVERHS  DIM       3       * Hospital Default Grouper Version
DRGCODHS  DIM       4       * Hospital Default Grouper Code    
DEFLTHOS  DIM       3
DEFLTLOC  DIM       4
KEY11A    DIM       11
LAST      INIT      "999"
LASTEPIS  DIM       2
LASTREAS  DIM       4
LOCKEPNO  FORM      1       * lock Episode No on Coding screen
TAGCODE   DIM       4       * Tag Code 
ADMSTATS  DIM       1
OTHRHOSP  FORM      1
VISITNO   DIM       8
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NEWWDCID  DIM       2       * New cluster id retruned from procedure
UPDTTYPE  DIM       1       * Update Type
SELECTED  DIM       4         * Selected Index
SHOWPROC  FORM      1
SELHOSP   DIM       3       * Selected Hospital for HSEL0000 
SQDCOUNT  FORM      3       * Total number of diagnosis codes in SEQDIAGN[]
SEQDIAGN  DIM       16[300] * Sort sequence array for diagnosis codes
SQOCOUNT  FORM      3       * Total number of procedure codes in SEQOPRAT[]
SEQOPRAT  DIM       16[300] * Sort sequence array for procedure codes 
SORTBUTT  FORM      1       * Display sort button flag
SORTKY16  DIM       16      * Sort key 
SORTSEQN  DIM       3       * Sort key sequence number 
STARTKEY  DIM       10      * Starting Key
SVVKEY13  DIM       13      * Save key13
CODINGED  DIM       2       * Display coding edition
CURRDATE  DIM       8       * Current Date
CPYADMNO  DIM       8
NOTEFILT  DIM       3
.
FLEXPENC  FORM      1
COUNTFL   FORM      1
TEMPDP    FILE      ASCII, FIXED=127
.
CODETYPE  DIM       1       * Type of code, O - operation
.                                           D - disease
PRIMCODE  DIM       9
PRIMCANC  DIM       9       * Save primary cancer code
PROCCODE  DIM       7
DISECODE  DIM       5
DSSCODE   DIM       9       * Disease/operation code
ICDCODE   DIM       9       * Disease/operation code
..ICDCDESC  DIM      100      * Code description          (now in WEBGRPVA.INC)
ICDREQ1   DIM       9
ICDREQ2   DIM       9
ICDREQ3   DIM       9
ICDREQ4   DIM       9
ICDREQ5   DIM       9
ICDREQ6   DIM       9
ICDREQ7   DIM       9
ICDREQ8   DIM       9
ICDZ50C   DIM       9
ICDACTV   DIM       9
ICDPLAC   DIM       9
ICDERRDS  FORM      1       * External Cause Code errots
IHINUMBR  DIM       20                      * IHI Number
NMDSCHGF  FORM      1
SAVCOUNT  FORM      3
SECBCANC  DIM       9       * Secondary before primary cancer code
SECBFLAG  FORM      1       * Secondary before primary loop flag
COAUFLAG  FORM      1       * do Coding Audit tables exist mrtcahaf & mrtcadaf
DISTYPE   DIM       1       * Disease type
OPERTYPE  DIM       1       * Operation type
OPERDATE  DIM       8       * Operation date (CCYYMMDD)
OPERSTME  DIM       5       * Operation start time
OPERETME  DIM       5       * Operation finish time
OPERCLIN  DIM       10      * Operation Clinician Code 
OPRCODE   DIM       9       * Operation code
DOCTCODE  DIM       6       * Doctor Code
DIM3      DIM       3
DIM8B     DIM       8
DIM13     DIM       13
DIM18     DIM       18
DIM18A    DIM       18
DIM20A    DIM       20
DIM50     DIM       50
DIM150    DIM       150
DISP200   DIM       200
DCC       DIM       2
DYY       DIM       2
DFYEAR    DIM       4
.
EPSSLIST  FORM      1[99]
..EPSTTDAT  DIM       8       * selected Episode Start Date - Date format
..EPENDDAT  DIM       8       * selected Episode End Date   - Date format
..EPSTTDIS  DIM       15      * selected Episode Start Date - Display format
..EPENDDIS  DIM       15      * selected Episode End Date   - Display format
..EPSTTTIM  DIM       8       * selected Episode Start Time
..EPENDTIM  DIM       8       * selected Episode End Time
..CARETYPE  DIM       3
..EPNODAYS  DIM       20
..EPSNOLOS  FORM      3
..ADNODAYS  FORM      3
.
CODEINCO  DIM       3       * coding delay reason (CAT dr)
MRTTD001  DIM       4       * Template ID
MEDCD001  DIM       1       * Coding Complete
NMDSRESB  DIM       1       * NMDS Resubmit
PTECD001  DIM       8       * Admission No.
PTECD002  DIM       2       * Episode No.        
PTECD003  DIM       3       * Episode Unique Counter
PTECD004  DIM       8       * Procedure/Accident Date
PTECD005  DIM       5       * Procedure Start Time 
PTECD006  DIM       5       * Procedure End Time 
PTECD007  DIM       3       * Coder Snag
PTECD008  DIM       3       * PDT Status
PTECD009  DIM       10      * Procedure Clinician 
.
MRSTSFLG   DIM      1
.
HRSICU01  FORM      5       * Hours in Intensive Care
HRSICU02  FORM      5       * Hours in Critical Care
HRSICU03  FORM      5       * Hours on Mechanical Ventilation
HRSICU04  FORM      6       * Admission Weight        
HRSICU05  DIM       3       * Reason for Critical Care
HRSICU06  DIM       3       * Intention to Readmit      
HRSICU07  FORM      5       * Hours in NCU
HRSICU08  DIM       3       * Unplanned Readmission
HRSICU09  DIM       3       * Unplanned visit to theatre
HRSICU10  FORM      5       * Hours of Constant Positive Air Pressure (CRAP)
HRSICU11  DIM       15      * Ambulance Client Number
HRSICU12  DIM       3       * Mental Health Legal Status (Cat.LS)
HRSICU13  DIM       8       * Care Plan Documented Date (ccyymmdd)
HRSICU14  DIM       2       * Minutes in ICU
HRSICU15  DIM       2       * Minutes in Mechanical Ventilation
HRSICU16  DIM       3       * Gestation Period
HRSICU17  DIM       3       * Prev Specialised Treatment (Cat YE)
HRSICU18  DIM       15      * Charlson Score
.
NEWHOSPT  DIM       3[100]  * Array of hospitals
NEWLOCAT  DIM       4[100]  * Array of locations
NEWTYPDC  DIM       3[100]  * Array of type of documents
NEWVOLUM  DIM       2[100]  * Array of volumes
NEWDELFL  DIM       1[100]  * Array of Delete Flags
.
NEWSEQNC  DIM       3       * New sequence passed in from BSP 
SETFUNCT  DIM       1       * Indicates Procedure or Diagnosis Code 
MOVESWAP  DIM       1       * Indicates swap or move function
DIOPC001  DIM       9       * Diagnosis Procedure Code 
DIOPC002  DIM       200      * Diagnosis/Procedure Code Description
DIOPC003  DIM       1       * Diagnosis/Diagnostic onset type
DIOPC004  DIM       2       * Contract Care flag
.
CALDAYS   FORM      8
CATTY     INIT      "TY"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATVI     INIT      "VI"
MARK      INIT      "'"
CMPCNT    FORM      1
COD1CNT   FORM      3
COD9CNT   FORM      2
CODESTAT  FORM      1
CKWEIGHT  DIM       1
NVALWGHT  DIM       1
DIM30     DIM       30
DISCODNO  FORM      2       * Diagnosis Code Counter
DSPREFIX  DIM       1       * Diagnosis Code Prefix
DIACODES  DIM       9[300]  * Array of Diagnosis Codes 
CANCODES  DIM       9[10]   * Array of Cancer Diagnosis Codes   
DDRGCODE  DIM       4
DRGOUTFN  DIM       12
.DMDCCODE  DIM       4
.DRGVER    DIM       3
PROCFLAG  FORM      1
DIAGFLAG  FORM      1
.
EMVIADMN  DIM       8
EMVIDDAT  DIM       8
.
ERRORKEY  DIM       24
.
MAXARRY   INIT      "300" 
.
NWAUZERO  INIT      ".0000"
DASH      INIT      " - "
AT        INIT      "at"
.                                  * Disease & Procedure arrays - see MAXARRY
ACCIDENT  DIM       8[300]  * Array of Accident Dates    
PROCODES  DIM       9[300]  * Array of Procedure Codes   
PRODATES  DIM       8[300]  * Array of Procedure Dates   
PROSTART  DIM       5[300]  * Array of Procedure Start Times
PROENDTM  DIM       5[300]  * Array of Procedure End Times
CCFLAG    DIM       2[300]  * Array of Contract Care Flag 
PRODOCCD  DIM       10[300] * Array of Procedure Clinician Code 
.
PREFIXES  DIM       1[300]  * Array of Diagnosis Prefixes
DESCRIPT  DIM       200[300] * Array of Diagnosis/Procedure Descriptions
SVEOCLIN  DIM       10      * Save field for Oper Clinician 
SVEODATE  DIM       8       * Save field for Oper Date 
UMISFLAG  FORM      1       * Update admission file flag
NOOFCANC  FORM      2       * Cancer count for current admission
UNRGCANC  FORM      2       * Unregistered cancers count
VALDCODE  DIM       70      * Validation Code
VALDTYPE  FORM      1       * Validation Type 1,Diagnosis 2,Procedure
VALDEPIS  DIM       2       * Validation Episode No. 
SEXASSCD  FORM      1       * Sex Associated Code Flag
FOUNDFLG  FORM      1
HIGHDATT  DIM       13      * Highest (latest) date & time for Dis. & Oper Codes
.
PDCOMFLG  FORM      1
DISCOMAF  FILE      ASCII, FIXED=127
DISCOMNM  DIM       8
PDISCLIN  FORM      3
DISCCOMM  DIM       80
DISCOMAR  DIM       80[5]
BLANK80   DIM       80
QRYDATA1  DIM       240
LVSTDTE   DIM       8      * Temp variable to hold leave start date
LVEDDTE   DIM       8      * Temp variable to hold leave end date
LEAVDAY   FORM      3      * Number Leave Days
TMPNUM    FORM      3      * Variable to hold temporary values
.
.---------------------------------------------------------------------------
.  CGI Variables
.---------------------------------------------------------------------------
MRTME001  DIM       8       * Date of Movement
MRTME002  DIM       8       * Time of Movement
MRTME003  DIM       4       * Destination of Location
MRTME004  DIM       6       * Reciver of Record
MRTME005  DIM       4       * Reasion of Movement
MRTME006  DIM       6       * Operator
MRTME007  DIM       8       * Due Date
MRTME008  DIM       1       * Status 1=Out 2=In
MRTME009  DIM       2       * Lock Feild Variable
MRTME010  DIM       3       * Document Type
MRTME011  DIM       2       * Volume Number
MRTME012  DIM       3       * Post discharge Header Current status
MRTME013  DIM       20      * Extention Number
MRTME014  DIM       20      * Pager Number
MRTME015  DIM       10      * Web UserID
MRTME016  DIM       35      * Requested By
MRTME017  DIM       4       * MR Home Location
MRTME018  DIM       50      * Movement Comments
MRTME019  DIM       3       * Destination of Hospital
MRTME020  DIM       3       * MR Home Hospital ID   
.
PTCRG001  DIM       3       * Multiple Primaries                 
PTCRG002  FORM      2       * LOS in NZ (Yrs)        
.
PMCDG001  DIM       8       * Admission Number
PMCDG002  FORM      8       * Cancer Registration Number
PMCDG003  DIM       9       * Primary Site           
PMCDG004  FORM      2       * Basis for Diagnosis
PMCDG005  FORM      2       * Reason for Clinical Diagnosis Code
PMCDG006  DIM      50       * Reason for Clinical Diagnosis Text
.
MSCOM001  DIM       1
MSCOM002  DIM       1
MSCOM003  DIM       1
MSCOM004  DIM       1
MSCOM005  DIM       1
MSCOM006  DIM       1
MSCOM007  DIM       8
MSCOM008  DIM       5
.
ACCIDATE  DIM       11
ACDNTFLG  FORM      1
ACDNTMND  FORM      1
ADMIN     FORM      8
ADMISDTE  FORM      8
.
BASDCLIN  INIT      "Clinical Only"              * Basis for Diag - 01
BASDIMAG  INIT      "Imaging"                    * Basis for Diag - 03
BASDENDO  INIT      "Endoscopy"                  * Basis for Diag - 04
BASDCYTO  INIT      "Cytology or Haematology"    * Basis for Diag - 06
BASDMETA  INIT      "Histology of Metastasis"    * Basis for Diag - 07
BASDPRIM  INIT      "Histology of Primary"       * Basis for Diag - 08
BASDAUTO  INIT      "Autopsy & Histology"        * Basis for Diag - 09
.
CDPALLAT  INIT      "Palliative Care/Admission"           * 01
CDDOCREF  INIT      "Doctor's Notes/Referral"             * 02
CDPATHOL  INIT      "Pathology"                           * 03
CDRADIOL  INIT      "Radiological Investigation"          * 04
CDOTHERN  INIT      "Other Non-Invasive Investigation"    * 05
CDINVASI  INIT      "Invasive Investigation"              * 06
CDNONCAN  INIT      "Non-Cancer Admission"                * 07
CDOTHERC  INIT      "Other/Chemo/RT"                      * 08
.
CDLAUSLL  INIT      "Auslab Laboratory"                   * 01
CDLSANDN  INIT      "S & N Laboratory"                    * 02
CDLQMLLA  INIT      "QML Laboratory"                      * 03
CDLPRIVL  INIT      "Private Laboratory"                  * 04
CDLOTHER  INIT      "Other Laboratory"                    * 05
.
CODEFLAG  FORM      1       * 1=disease/2=operation
CHKCODE   DIM       9
CMDLINE   DIM       227
COUNTER   FORM      3     
COUNTER3  FORM      3 
RTDAYS    FORM      4
RUNAUTOG  FORM      1
RETFIELD  DIM       8
CDATAFLD  DIM       8
CODTYP    FORM      3       * Coding type
.                             9 - ICD9 coding
.                             101 - ICD10 version 1 coding
.                             102 - ICD10 version 2 coding
ENO3      DIM       3 
EPSCOUNT  DIM       3       * Episode Unique Counter 
EPSNUMBR  DIM       2       * Episode Number 
ERRORFLG  FORM      1       * Error flag for medical record merge
DAYCOL    FORM      4
DISCOUNT  FORM      3       * Diagnosis Code Counter 
DRGINP    INIT      "drginp"
...CODELINE  DIM       30                        * now 150 in WEBGRPVA.INC
CNCODCNT  FORM      2       * Cancer Code Counter
LOADFILE  FILE      ASCII,FIXED=200
LOADNAME  DIM       8
LOADCNT   FORM      3
ENCINP    INIT      "encinp"
ENCOUT    INIT      "encout"
ENCDSP    DIM       2
ENCODERF  DIM       1
TYPOFCOD  DIM       2
ENCFILEF  FILE      ASCII,FIXED=256
ENCOUTAF  FILE      ASCII,FIXED=256
ENCOUTFN  DIM       12
DEFLTMAN  DIM       2       * 1st char -Default mandatory fields(Add template)
.                           * 2nd char -Default tick box for 'No Change' field
DISIND    INIT      "D"     * Diagnosis Indicator
PROIND    INIT      "O"     * Procedure Indicator
DSCOD     DIM       9       * Diagnosis code
DSCODNO   FORM      3       * Diagnosis code no 
DSCODPFX  DIM       1       * Diagnosis code prefix
DISHDP    DIM       1
DOBDATE   DIM       11
DOCTYPE   DIM       3
ECODECNT  FORM      3       * 'E' code counter
ECREQCNT  FORM      3       * 'E' code required counter 
EPISODNO  FORM      2       * Episode No
EPSCD001  FORM      2       * Episode No  
FILEPTH   DIM       50[30]
FILENAM1  DIM       8
FILENAM2  DIM       8
FILENAM3  DIM       8
FILENAM4  DIM       8
F3A       FORM      3
F3B       FORM      3
FORM5     FORM      5
FORM8     FORM      8       * Form of 8
FMTAGE    DIM       10
FMTSEX    DIM       8
FMTYRS    INIT      " yrs"
FMTMTHS   INIT      " mths"
FMTWKS    INIT      " wks"
FMTDAYS   INIT      " days"
GRPVERSN  DIM       3
GRPFLAG   FORM      1
HOMHOSPT  DIM       3 
HOMLOCAT  DIM       4
HDPEQUIV  DIM       2
ICUBED    DIM       1
ICUFLAG2  FORM      1
INPUTDRG  DIM       4       * drg entered on screen
LASTDIAG  FORM      3       * Last Item of Diagnosis array 
LASTPROC  FORM      3       * Last Item of Procedure array
LASTVIST  DIM       8
LASTVDAT  DIM       11
LASTVTYP  DIM       15
LASTROW   FORM      3
MBSDESC   DIM       70
MCODECNT  FORM      2
NEWBDATE  DIM       20
NEWPTAGE  DIM       10
NEWPNAME  DIM       35
NEWURNUM  DIM       8
NEWPTSEX  DIM       8
NMPNUMB   DIM       20
NOOFDAYS  FORM      3
OLDBDATE  DIM       20
OLDPTAGE  DIM       10
OLDPNAME  DIM       35
OLDURNUM  DIM       8
OLDPTSEX  DIM       6 
OLDICU16  DIM       3
OPCOD     DIM       9       * Procedure code
OPCODNO   FORM      3       * Procedure code no 
OUTPFLAG  FORM      1
OVERRIDE  FORM      1       * Override Warning Message passed in CGI var
ORGDDATE  DIM       8
PRVDDATE  DIM       8
CANCEROV  FORM      1       * Override Warning Message passed in CGI var
CODCOUNT  FORM      3
PATHNO    FORM      2
PRINTREG  DIM       1       * Print cancer reg form
PTMAS031  DIM       1       * Autopsy
PTMIS029  DIM       3       * Place of occurance
PTMIS034  DIM       40      * Comments 1 (acomm1) 
PTMIS035  DIM       30      * Comments 2 (acomm2)
PTMIS036  DIM       1           * Plurality of Baby (aplur)
PTMIS042  DIM       3           * User Defined Field 6 (Cat U6) (ausr6)
PTMIS051  DIM       6           * Baby's Admission Weight (abwght)
PSAGECON  DIM       3
PSAGETYP  DIM       3
SAVKEY2   DIM       2
SAVKEY3   DIM       3
SAVEKEY8  DIM       8
SAVKEY9   DIM       9
SAVKEY13  DIM       13
SAVKEY20  DIM       20 
SCANDATE  DATE      8       * Scan visits from date.
SWAPFLG   FORM      1       * Swap flag
SDSCNCD   DIM       9       * Save the disease cancer code
SDSDGCD   DIM       9       * Save the disease dagger code
SERVER    DIM       13      * Server Name
STATNCOD  DIM       6       * Sationary Code
TOTBEDHR  FORM      8       * Total bed hours
PRINTSEL  DIM       3       * Select Printer
RECRT001  DIM       3
RECRT002  DIM       8
RECRETDT  DIM       8
REPTNO    DIM       3
RESPNVAR  FORM      1       * Extra Session Clashers indicator
.
SMPSMIS1  DIM       1
SMPSMIS2  DIM       1
SMPSMIS3  DIM       1
SMPSMIS4  DIM       1
SMPSMIS5  DIM       1
SMPSMIS6  DIM       1
SMPSFTM1  DIM       80
SMPSFTM2  DIM       80
SMPSFTM3  DIM       80
SMPSFTM4  DIM       80
SMPSFTM5  DIM       80
.
THREEHUND FORM      "300"
UCDSCHRG  DIM       1       * Uncoded discharge list variable
UNKNOWN   INIT      "Unknown"
VOLUMNUM  DIM       2
VISITNUM  DIM       8 
VISITDAT  DIM       8 
DISCHDAT  DIM       8
DPTXT     INIT      ".txt"
VT1       INIT      "Emergency"
VT2       INIT      "Outpatient"
VT3       INIT      "Inpatient"
VT4       INIT      "Other Financial"
VT5       INIT      "Day Centre"
VT6       INIT      "Community"
VT7       INIT      "Ward Attendee"
VT8       INIT      "Adhoc Attendee"
VIEWFLAG  FORM      1
VIEWONLY  FORM      1
VIEWCCFL  FORM      1
WARNCNT   FORM      2         * Warning counter
WAHPDATE  FORM      1         * WA Health procedure date test
WEBWRN    DIM       90[10]    * Warning Array
WEBERR    DIM       55        * Output Web error
CANCERDS  DIM       110[10]   * Cancer Warning
CODERROR  DIM       300       * Output Web error     (was 125)
CURRLOCA  DIM       95
CURRSTAT  DIM       20
HOMELOCA  DIM       70
HOMEHOSP  DIM       30
INTRANST  DIM       26
CURRHOSP  DIM       40
CFNAMEDP  DIM       8
.
USEDENC   FORM      1
WDATE1    DIM       8
WDATE2    DIM       8
WRNFLAG   FORM      1
VARLONG   DIM       500
SUPERLEV  DIM       1
WCFINPFN  DIM       22       * Web Codefinder input filename
WCFOUTFN  DIM       22       * Web Codefinder output filename
.---------------------------------------------------------------------------
. Variables required by PATGRPSG.PBL
.---------------------------------------------------------------------------
OBB       INIT      "("
CBB       INIT      ")"
OBR       INIT      "<font color=red>("
CBR       INIT      ")</font>"
CODED     INIT      "D "
CODEDD    INIT      "DD"
CODEP     INIT      "P "
CODEDESC  DIM       27                      * Code description
CHECKDRG  DIM       2                       * Check DRG
DIM4      DIM       4
DIM4A     DIM       4
DIM4B     DIM       4
DIM4C     DIM       4
DISDATE   DIM       10                      * Discharge date
DISTIME   DIM       5                       * Discharge time
DRGCCL    DIM       1                       * DRG severity index
DRGCODE   DIM       3                       * DRG code
DRGDOCNE  DIM       20                      * Doctors name
DRGGRP    DIM       3                       * DRG grouper version
DRGPATNE  DIM       20                      * Patient name
ESC       INIT      27                      * ESC char
MAPFILE   FORM      1                       * Using mapping or not
METASTIC  FORM      1
METC770   INIT      "C77.0 " 
METC7990  INIT      "C79.9 "
MDCCODE   DIM       3                       * MDC code
ONEHUND   FORM      "100"
PATALOS   DIM       4                       * Acute LOS
PATHMV    DIM       4                       * Hours on mechanical ventilation
PATILOS   DIM       1                       * Intended LOS
PATWGHT   FORM      4                       * Patient weight
SEPEMODE  DIM       2                       * Separation mode
SEX       DIM       8                       * Sex
URNO      DIM       8
UNPLREAD  DIM       1
WEIGHT    FORM      6
VMDILIST  DIM       4                       * Valid disease types
ZED20     INIT      "zzzzzzzzzzzzzzzzzzzz"
NOOFCODE  FORM      2
ENCERR01  INIT      "Backup at Key Word Prompt               "
ENCERR02  INIT      "Abort at Key Word Prompt                "
ENCERR03  INIT      "No Entry at Key Word Prompt             "
ENCERR04  INIT      "Next at Key Word Prompt                 "
ENCERR05  INIT      "Invalid File Format                     "
ENCERR06  INIT      "Bad Command or Command Unauthorised     "
ENCERR07  INIT      "Error Opening Interface Input File      "
ENCERR08  INIT      "Error Opening Interface Output File     "
ENCERR09  INIT      "Output File Already Exists              "
ENCERR10  INIT      "Invalid DRG / Fiscal Year               "
ENCERR12  INIT      "Invalid Codes Passed to Application     "
ENCERR34  INIT      "Not Authorised                          "
ENCERR37  INIT      "Invalid or No Age in Input File         "
ENCERR38  INIT      "Invalid or No Gender in Input File      "
ENCERR39  INIT      "Invalid or Not Integrated in Input File "
ENCERR40  INIT      "Invalid or No State in Input File       "
ENCERR41  INIT      "Invalid or No Payor in Input File       "
ENCERR42  INIT      "Invalid Discharge Date in Input File    "
ZERO20    INIT      "00000000000000000000"
.
CCFLAG01  INIT      "B - Care provided by hospital B"
CCFLAG02  INIT      "AB - Care provided by hospital A and hospital"
.
.---------------------------------------------------------------------------
PRGID     INIT      "MRTWEB02"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Medical Record Coding"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE 
.
MAIN1010  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MEDCOD00        * Medical Record Coding Display
          BRANCH    EXIT,MAIN1000
          MOVE      "Coding Successful",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      CHKICD00        * Medical Record Coding Remote Scripting
          GOTO      MAIN1000
.
MAIN1300  CALL      SUMCOD00        * Coding Summary Maintenance              
          BRANCH    EXIT,MAIN1000,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      CHKMED00        * Get Record ID information
          GOTO      MAIN1000
.
MAIN1500  CALL      MRMERG00        * Medical Record merge
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      SETMED00        * Set Record Coding URL
          BRANCH    EXIT,MAIN1000
          MOVE      "Merge Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  MOVE      "Y",GRPSWICH    * Switch on CPDATS00 in SETGRP00        
          MOVE      ZERO,SETCLACC
          CALL      SETGRP00        * Prep Grouper & Process Returned Files 
          IF        SETCLACC = 1
            CALL      CLRACC00      * clear Coding Date to set Red Button
          ENDIF
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      CANCOD00        * Cancer Coding   
          BRANCH    EXIT,MAIN1000,MAIN1000
          MOVE      "Cancer Coding Successful",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      ERRCCA00        * CCA Error Reporting
          BRANCH    EXIT,MAIN1000
          MOVE      "CCA Error Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      WCREMT00        * Web Codefinder Remote Scripting
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60:
                       NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREDER00       * Redirect with alert
          GOTO      NXTPAG99
.
NXTPAG80  CALL      PREDPR00       * Redirect parent with alert
          GOTO      NXTPAG99
.
NXTPAG90  CALL      WINEX100
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------
. Close Window
.------------------------------------------------------------
WINEX100  CALL      OPENHTML
          BRANCH    EXIT,WINEX199
WINEX110  WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name.match(/PopUpFrame/)) ":
 "parent.parent.document.getElementById('PopUpScreen').style.display=#"none#";":
                             " else  ":
                             "  self.close(); ":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINEX199  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL with alert
.------------------------------------------------------------------------------
PREDPR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDPR99
.
PREDPR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDPR99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDER00  CALL      OPENHTML
          BRANCH    EXIT,PREDER90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             " location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDER99
.
PREDER90  DISPLAY   "*** Fifo Not Found ***"
.
PREDER99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Output HTML Error File
.------------------------------------------------------------
CODERR00  CALL      OPENHTML
          BRANCH    EXIT,CODERR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
          "  var PopUpScreen=parent.document.getElementById('PopUpScreen');":
                    "  alert(#"",CODERROR,"#");":
                    "  if (window.name.substr(0,4)=='Hide') {":
                    "    self.close();} else {":
                    "  if (PopUpScreen) {":
                    "     PopUpScreen.style.display='none'; }":
                    "  else { history.go(-1); }}":
                    "}":
                    "</script>",012
.
          CALL      CLOSHTML     * End of Document
          GOTO      CODERR99
.
CODERR95  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
CODERR99  RETURN
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
CODOVR00  CALL      OPENHTML
          BRANCH    EXIT,CODOVR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
          "  var PopUpScreen=parent.document.getElementById('PopUpScreen');":
                   "  if (confirm(#"",CODERROR,"\n\nClick Ok if you want to":
                   " Override Warning.#")) {;":
                   "    parent.UpdateForm.override.value=#"1#"; ":
                   "    parent.UpdateForm.target=#"PopUpFrame#"; ":
                   "    parent.UpdateForm.submit(); }":
                   "  else {":
                    "  if (PopUpScreen) {":
                    "     PopUpScreen.style.display='none'; }":
                    "  else { history.go(-1); }}":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      CODOVR99
.
CODOVR95  DISPLAY   "*** Fifo Not Found ***"
.
CODOVR99  RETURN
.------------------------------------------------------------
. Output HTML Override Confirm Message
.------------------------------------------------------------
CANOVR00  CALL      OPENHTML
          BRANCH    EXIT,CANOVR95
.
          MOVE     "1",KEY1                 * default to 'Click on Cancel'
          IF       UNRGCANC > 0
            MOVE     "2",KEY1               * set redirect to Add screen
          ELSE
            IF       NOOFCANC > 0
              MOVE     "3",KEY1             * set redirect to List screen
            ENDIF
          ENDIF
.
CANOVR10  WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WEBTITLE,"\n\n",CANCERDS[1],"\n":
                   CANCERDS[2],"\n",CANCERDS[3],"\n",CANCERDS[4],"\n":
                   CANCERDS[5],"\n\n",CANCERDS[10]:
                   "\n\nClick 'Ok' for Cancer Registration maintenance":
                   "  or  'Cancel' to continue.#")) {;":
                   "    parent.UpdateForm.cancerov.value=#"",KEY1,"#"; ":
                   "    parent.UpdateForm.target=#"PopUpFrame#"; ":
                   "    parent.UpdateForm.submit(); }":
                   "  else {":
                   "    parent.UpdateForm.cancerov.value=#"1#"; ":
                   "    parent.UpdateForm.target=#"PopUpFrame#"; ":
                   "    parent.UpdateForm.submit(); }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      CANOVR99
.
CANOVR95  DISPLAY   "*** Fifo Not Found ***"
.
CANOVR99  RETURN
.------------------------------------------------------------
. Check Record ID Information
.   Required  - VALDCODE
.             - VALDTYPE : 1. Validate UR Info 
.                          2. Validate Admission Info 
.                          3. Validate Episode No.
.                          4. Validate Operation Date 
.                          5. Update Procedure/Diagnosis Prefix
.                          6. Return Disease Episode Unique Counter    
.                          7. Return Laterality if found for a Cancer Code
.                          8. Validate Diagnosis Date 
.                          9. Check if movement reason is mandatory
.------------------------------------------------------------
CHKMED00  BRANCH    VALDTYPE,CHKMED10,CHKMED20,CHKMED30,CHKMED40,CHKMED50:
                             CHKMED60,CHKMED70,CHKMED80,CHKMED90
          GOTO      CHKMED91
.
CHKMED10  CALL      VALPUR00        * Validate UR Info
          GOTO      CHKMED99
.
CHKMED20  CALL      VALVIS00        * Validate Admissno Info
          GOTO      CHKMED99
.
CHKMED30  CALL      VALEPS00        * Validate Episode No
          GOTO      CHKMED99
.
CHKMED40  CALL      VALDTE00        * Validate Operation Date
          GOTO      CHKMED99
.
CHKMED50  CALL      UPDPRE00        * Update Procedure/Diagnosis Prefix
          GOTO      CHKMED99
.
CHKMED60  CALL      DISCON00        * Return Disease Episode Unique Counter
          GOTO      CHKMED99
.
CHKMED70  CALL      VALLAT00        * Return Laterality if is a Cancer Code
          GOTO      CHKMED99
.
CHKMED80  CALL      VALDDT00        * Validate Diagnosis Date
          GOTO      CHKMED99
.
CHKMED90  MATCH     "CHECKHONOS",VALDCODE
          IF        @EQUAL
            CALL      HONDET00        * Check if HONOS details exist
          ELSE
            CALL      REASNM00        * Check if movement reason is mandatory
          ENDIF
          GOTO      CHKMED99
.
CHKMED91  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Validation Type":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKMED99
.
CHKMED99  RETURN
.------------------------------------------------------------
. Validate Patient U/R
.------------------------------------------------------------
VALPUR00  CALL      XMLHED00
          BRANCH    EXIT,VALPUR99
.
          MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALPUR90
.
          COMPARE   ONE,PSTAT
          GOTO      VALPUR60 IF NOT EQUAL
.
VALPUR50  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
          BRANCH    PSTAT,VALPUR50   * Another associated U/R number
.
VALPUR60  CALL      GETVIS00
          CALL      PATNAA00
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      FMTAGE00      * Format age
          CALL      FMTSEX00      * Format Sex
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DOBDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      LASTEPIS,VALDEPIS
          CALL      CHKEPS00   * Check if Patient has existing Episodes
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",FMTSEX,"|",DOBDATE,"|",PCEASE,"|":
                             PURNO,"|",LASTVIST,"|",LASTVDAT,"|",LASTVTYP,"|":
                             FMTAGE,"|",EPSFLAG,"|",EPSNUMBR,"|",VISITNO,"|":
                             ADMSTATS,"|",OTHRHOSP:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient UR - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR98  CALL      XMLEND00
VALPUR99  RETURN
.---------------------------------------------------------------
.   Update the Procedure/Diagnosis Prefix                        
.   Required  - ADMISSNO - Admission Number 
.             - DIOPC001 - Procedure/Diagnosis Code  
.             - DSPREFIX - Prefix           
.             - PTECD002 - Episode Number
.             - PTECD003 - Episode Unique Counter
.---------------------------------------------------------------
UPDPRE00  CALL      XMLHED00
          BRANCH    EXIT,UPDPRE99
.
          PACK      CHKCODE,DIOPC001,SP70
          CALL      CHICD000           * check if using icd9
          BRANCH    CODEFLAG,UPDPRE20,UPDPRE10
.                   update:  disease  operat
.
          GOTO      UPDPRE90
.
UPDPRE10  PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECO1              * Episode disease file record
          BRANCH    OVRCD,UPDPRE90
.
          MOVE      DSPREFIX,PTEOTYPE     * Procedure Prefix
          CALL      UPPTECO1              * Update an eps pro coding file rec
.
.  Outputting Dummy Info so that Remote scripting does not fall over
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ADMISSNO,"|":
                             "</RETURN_VALUE>"
.
          GOTO      UPDPRE98
.
UPDPRE20  PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECD1              * Episode disease file record
          BRANCH    OVRCD,UPDPRE90
.
          MOVE      DSPREFIX,PTEDTYPE     * Diagnosis Prefix
.
          IF        PTCNHDPS>0
            MOVE      TWO,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      ONE,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
          ENDIF
.
          IF        PTCNHDPS=4
            MOVE      ONE,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      TWO,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
          ENDIF          
.
          CALL      UPPTECD1              * Update an eps dis coding file rec
.
.  Outputting Dummy Info so that Remote scripting does not fall over
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ADMISSNO,"|",PTEDOSET,"|":
                             "</RETURN_VALUE>"
.
          GOTO      UPDPRE98         
.
UPDPRE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Record Not Found! ": 
                             DIOPC001,"</RETURN_VALUE>"
          GOTO      UPDPRE98
.
UPDPRE98  CALL      XMLEND00
          CALL      PTHCS000                                           *214276
UPDPRE99  RETURN
.---------------------------------------------------------------
.   Return Disease Episode Unique Counter                        
.   Required  - ADMISSNO - Admission Number 
.             - EPSCD001 - Episode Number        
.---------------------------------------------------------------
DISCON00  CALL      XMLHED00
          BRANCH    EXIT,DISCON99
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70  
          CALL      RSPTECD1              * Episode disease file record
          CALL      RPPTECD1                                            
          BRANCH    OVRCD,DISCON10
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      DISCON10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      DISCON10 IF NOT EQUAL    * Different episode no
.
. * Note adding 1 here as this Code counter is now set for follwing validation
. * in the respective javascript function. 
.
          ADD       ONE,PTEDCNT        
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTEDCNT,"|":
                             "</RETURN_VALUE>"
.
          GOTO      DISCON98
.
.   Outputt Record Unique Counter as 1 thus no record found set to 1!! 
.
DISCON10  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|":
                             "</RETURN_VALUE>"
.
          GOTO      DISCON98
.
DISCON98  CALL      XMLEND00
DISCON99  RETURN
.---------------------------------------------------------------
.   Return Laterality if found for a valid Cancer Code                   
.   Required  - VALDCODE - ICD10 Disease Code
.---------------------------------------------------------------
VALLAT00  CALL      XMLHED00
          BRANCH    EXIT,VALLAT99
.
          PACK      KEY9,VALDCODE,SP70  
          CALL      RDPTCAN1                 * Cancer File                
          BRANCH    OVRCD,VALLAT90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTCCLATR,"|":
                             "</RETURN_VALUE>"
.
          GOTO      VALLAT98
.
.   Outputt Zero as not a valid Cancer Codes anyway. 
.
VALLAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,"|":
                             "</RETURN_VALUE>"
.
          GOTO      VALLAT98
.
VALLAT98  CALL      XMLEND00
VALLAT99  RETURN
.
.---------------------------------------------------------------
. Validate Diagnosis Date against Current Date & Discharge Date
.   Required  - VALDCODE - Diagnosis Date
.             - ADMISSNO - Admission Number
.---------------------------------------------------------------
VALDDT00  CALL      XMLHED00
          BRANCH    EXIT,VALDDT99
.
          MOVE      ADMISSNO,KEY8     * Read Discharge File for Discharge Date
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      CURRDATE,DDATE
          ENDIF
.
          UNPACK    VALDCODE,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
.
..         MATCH     CURRDATE,KEY8
..         GOTO      VALDDT91 IF LESS
.
          MATCH     KEY8,DDATE
          GOTO      VALDDT91 IF LESS
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDATE,"|":
                             "</RETURN_VALUE>"
.
          GOTO      VALDDT98
.
VALDDT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Discharge Details - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALDDT98
.
VALDDT91  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Warning! Accident Date cannot be ":
                             "> than Discharge Date: ":
                             KEY11,"</RETURN_VALUE>"
          GOTO      VALDDT98
.
VALDDT98  CALL      XMLEND00
VALDDT99  RETURN
+
.---------------------------------------------------------------
. Validate Operation Date against Current Date & Discharge Date
.   Required  - VALDCODE - Operation Date
.             - ADMISSNO - Admission Number 
.---------------------------------------------------------------
VALDTE00  CALL      XMLHED00
          BRANCH    EXIT,VALDTE99
.
          MOVE      ADMISSNO,KEY8     * Read Admission File for Admission Date
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      CURRDATE,ADATE
          ENDIF
.
          MOVE      ADMISSNO,KEY8     * Read Discharge File for Discharge Date
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      CURRDATE,DDATE
          ENDIF
.
          UNPACK    VALDCODE,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
.
..         MATCH     CURRDATE,KEY8   
..         GOTO      VALDTE91 IF LESS 
.
          MATCH     KEY8,DDATE
          GOTO      VALDTE91 IF LESS 
.
          MATCH     KEY8,ADATE
          GOTO      VALDTE10 IF EQUAL
.
          MATCH     KEY8,ADATE
          GOTO      VALDTE92 IF NOT LESS
.
VALDTE10  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDATE,"|":
                             "</RETURN_VALUE>"
.
          GOTO      VALDTE98
.
VALDTE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Discharge Details - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALDTE98
.
VALDTE91  PACK      KEY11,SP20
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Warning! Operation Date cannot be ": 
                             "> than Discharge Date: ":
                             KEY11,"</RETURN_VALUE>"
          GOTO      VALDTE98
.
VALDTE92  PACK      KEY11,SP20
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Warning! Operation Date cannot be ":
                             "< than Admission Date: ":
                             KEY11,"</RETURN_VALUE>"
          GOTO      VALDTE98
.
VALDTE98  CALL      XMLEND00
VALDTE99  RETURN
.
.------------------------------------------------------------
.  Check if Patient has existing Episodes with no coding
.  Used to default to Coding Screen
.------------------------------------------------------------
CHKEPS00  MOVE      ZERO,EPSFLAG   * Return Variable 
          MOVE      SP70,EPSNUMBR  * Episode No - Return Variable
          MOVE      ZERO,ECDFLAG   * Diagnosis Episode Flag
          MOVE      ZERO,ECOFLAG   * Procedure Episode Flag
.
          MATCH     SP70,LASTVIST
          IF        @EQUAL
            MOVE      ONE,ECDFLAG
            MOVE      ONE,ECOFLAG
            GOTO      CHKEPS90
          ENDIF
.                                                                     *I-241939
          IF        MRCNEPSC = 0
            MOVE      " 1",VALDEPIS
          ELSE
            MATCH     SP2,VALDEPIS
            IF        @EQUAL
              MOVE      " 1",VALDEPIS
            ENDIF
          ENDIF
.
          PACK      KEY13,LASTVIST,VALDEPIS,SP70  * Check Diagnosis Coding file
          CALL      RSPTECD1
CHKEPS10  CALL      RKPTECD1
          IF        OVRCD=1
            MOVE      ONE,ECDFLAG
            GOTO      CHKEPS20
          ENDIF
.
          MATCH     LASTVIST,DPTEDADM
          IF        !@EQUAL
            MOVE      ONE,ECDFLAG
            GOTO      CHKEPS20
          ENDIF
.
          MATCH     VALDEPIS,DPTEDEPN                                 *I-241939
          IF        !@EQUAL
            MOVE      ONE,ECDFLAG
            GOTO      CHKEPS20
          ENDIF
.
          MATCH     SP70,PTEDCODE   
          IF        @EQUAL
            MOVE      ONE,EPSFLAG  * Episode with no Coding
            IF        PTEDEPNO=ZERO
              MOVE      ONE,EPSNUMBR
            ELSE
              MOVE      PTEDEPNO,EPSNUMBR
            ENDIF
            GOTO      CHKEPS99      
          ELSE
            MOVE      TWO,EPSFLAG  * Episode with Coding Found
            MATCH     SP70,EPSNUMBR
            IF        @EQUAL
              MOVE      PTEDEPNO,EPSNUMBR  * Only need First Episode with Coding
            ENDIF
          ENDIF
.
CHKEPS20  PACK      KEY13,LASTVIST,VALDEPIS,SP70  * Check Procedures Coding File
          CALL      RSPTECO1
CHKEPS21  CALL      RKPTECO1
          IF        OVRCD=1
            MOVE      ONE,ECOFLAG
            GOTO      CHKEPS90
          ENDIF
.
          MATCH     LASTVIST,DPTEOADM
          IF        !@EQUAL
            MOVE      ONE,ECOFLAG
            GOTO      CHKEPS90
          ENDIF
.
          MATCH     VALDEPIS,DPTEOEPN                                 *I-241939
          IF        !@EQUAL
            MOVE      ONE,ECOFLAG
            GOTO      CHKEPS90
          ENDIF
.
          MATCH     SP70,PTEOCODE   
          IF        @EQUAL
            MOVE      ONE,EPSFLAG  * Episode with no Coding
            IF        PTEOEPNO=ZERO
              MOVE      ONE,EPSNUMBR
            ELSE
              MOVE      PTEOEPNO,EPSNUMBR
            ENDIF 
            GOTO      CHKEPS99      
          ELSE
            MOVE      TWO,EPSFLAG  * Episode with Coding Found
            MATCH     SP70,EPSNUMBR
            IF        @EQUAL
              MOVE      PTEOEPNO,EPSNUMBR  * Only need First Episode with Coding
            ENDIF
          ENDIF
.
          IF        ECDFLAG=1 
            GOTO    CHKEPS21
          ELSE  
            GOTO    CHKEPS10
          ENDIF
.
CHKEPS90  MATCH     SP70,EPSNUMBR    * If nothing is found then default values
          IF        @EQUAL
            MOVE      ONE,EPSFLAG
            MOVE      VALDEPIS,EPSNUMBR                               *C-241939
          ENDIF
.
CHKEPS99  RETURN
.------------------------------------------------------------
. Validate Episode No
. Checks if Coding exists for the entered episode no. 
.   Required  - VALDCODE - Episode No 
.             - ADMISSNO - Admission Number 
.------------------------------------------------------------
VALEPS00  CALL      XMLHED00
          BRANCH    EXIT,VALEPS99

          MOVE      VALDCODE,EPISODNO  * Form variable
          MOVE      ZERO,EPSFLAG   * Episode Flag
.
          PACK      KEY13,ADMISSNO,EPISODNO,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,VALEPS10
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      VALEPS10 IF NOT EQUAL
.
          COMPARE   EPISODNO,PTEDEPNO
          GOTO      VALEPS10 IF NOT EQUAL
.
          MATCH     SP70,PTEDCODE   
          IF        !@EQUAL
            MOVE      ONE,EPSFLAG  * Episode with Coding
          ELSE
            MOVE      TWO,EPSFLAG  * Episode with no Coding
          ENDIF
.
VALEPS10  PACK      KEY13,ADMISSNO,EPISODNO,SP70
          CALL      RSPTECO1
          CALL      RKPTECO1
          BRANCH    OVRCD,VALEPS90
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      VALEPS90 IF NOT EQUAL
.
          COMPARE   EPISODNO,PTEOEPNO
          GOTO      VALEPS90 IF NOT EQUAL
.
          MATCH     SP70,PTEOCODE   
          IF        !@EQUAL
            IF        EPSFLAG<>2
              MOVE      ONE,EPSFLAG    * Episode with Coding
            ENDIF 
          ELSE 
            MOVE      TWO,EPSFLAG    * Episode with no Coding
          ENDIF
.
VALEPS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              EPSFLAG,"|":
                             "</RETURN_VALUE>"
          GOTO      VALEPS98
.
VALEPS98  CALL      XMLEND00
VALEPS99  RETURN
.------------------------------------------------------------
. Validate Patient Visit No
.------------------------------------------------------------
VALVIS00  CALL      XMLHED00
          BRANCH    EXIT,VALVIS99
.
          MOVE      VALDCODE,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VALVIS90
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALVIS90
          COMPARE   ONE,PSTAT
          GOTO      VALVIS80 IF NOT EQUAL
.
VALVIS10  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALVIS90   * New U/R number missing
          BRANCH    PSTAT,VALVIS10   * Another associated U/R number
.
VALVIS80  CALL      PATNAA00
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ASTAT,ADMSTATS    * Returned Admission Status
          ELSE
            MOVE      SP70,ADMSTATS     * Returned Admission Status
          ENDIF
.
          MOVE      PVIBILL,LASTVIST   * Set for CHKEPS00
          CALL      CHKEPS00           * Check if Patient has existing Episodes
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PSEX,"|",PBDATE,"|",PCEASE,"|":
                             PURNO,"|",PVIBILL,"|",LASTVDAT,"|",LASTVTYP,"|":
                             PSAGE,"|",EPSFLAG,"|",EPSNUMBR,"|",ADMSTATS:
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Visit - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS98  CALL      XMLEND00
VALVIS99  RETURN
.------------------------------------------------------------
. Format sex
.------------------------------------------------------------
FMTSEX00  MOVE      SP8,FMTSEX
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,FMTSEX
.
FMTSEX99  RETURN
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
FMTAGE00  MATCH     "y",PSAGETYP
          GOTO      FMTAGE10 IF NOT EQUAL
          PACK      FMTAGE,PSAGEYRS,FMTYRS,SP70
          GOTO      FMTAGE99
.
FMTAGE10  MATCH     "d",PSAGETYP
          GOTO      FMTAGE20 IF NOT EQUAL
          PACK      FMTAGE,PSAGEDAY,FMTDAYS,SP70
          GOTO      FMTAGE99
.
FMTAGE20  MATCH     "m",PSAGETYP
          GOTO      FMTAGE30 IF NOT EQUAL
          PACK      FMTAGE,PSAGEMNT,FMTMTHS,SP70
          GOTO      FMTAGE99
.
FMTAGE30  MATCH     "w",PSAGETYP
          GOTO      FMTAGE99 IF NOT EQUAL
          PACK      FMTAGE,PSAGEWKS,FMTWKS,SP70
.
FMTAGE99  RETURN
.------------------------------------------------------------------------
.                      ******* GETVIS00 *******
. This routine will either return the oldest uncoded discharge visit or
. the last coded visit, if all visits in the range are coded.
. RETURN VAR: LASTVIST, LASTVDAT, LASTVTYP, VISITNO, ADMSTATS, OTHRHOSP
.------------------------------------------------------------------------
GETVIS00  MOVE      SP70,LASTVIST * Visit No(only returned if criteria met!!) 
          MOVE      SP70,LASTVDAT * Visit Date(only returned if criteria met!!) 
          MOVE      SP70,LASTVTYP * Visit Typ Desc(same as above!!) 
          MOVE      SP70,VISITNO  * Visit No
          MOVE      SP70,ADMSTATS * Admission Status
          MOVE      ZERO,OTHRHOSP * Exists but other hospital
          MOVE      " 1",LASTEPIS * Visit episode number
.
          PACK      SCANDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCANDATE                * Scan one years visits
          MOVE      365,F3 
          SUB       F3,SCANDATE
.
          PACK      KEY24,PURNO,SCANDATE,SP70
          CALL      RDSVISA2                     * look for oldest visits first
GETVIS10  CALL      RDKVISA2
          BRANCH    OVRCD,GETVIS99
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GETVIS10
.
          MATCH     PURNO,PVIURNO
          GOTO      GETVIS99 IF NOT EQUAL
.
          MATCH     "00000000",PVIDATE   * bad debt
          GOTO      GETVIS10 IF EQUAL
.
.         MOVE      PVIBILL,VISITNO   * Returned Visit No
          MOVE      SP70,ADMSTATS     * Returned Admission Status
.
          COMPARE   "3",PVITYPE                * Inpatients only
          GOTO      GETVIS10 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIS10
.
          IF        MRCNEPSC<>1
            COMPARE   "3",ASTAT
            GOTO      GETVIS10 IF NOT EQUAL
          ENDIF
.
          MOVE      PVIBILL,VISITNO   * Returned Visit No
.
          MATCH     SP70,ACODDTE                * Get oldest uncoded discharge
          GOTO      GETVIS10 IF NOT EQUAL
.
          IF        IBCNMHOS <> 1
            GOTO      GETVIS60
          ENDIF 
.
. Centralised coding
.
          MATCH     "1",MRCNCCOD               * Using centralise coding
          GOTO      GETVIS50 IF EQUAL
.
          PACK      KEY10,USERID,SP70          * Re read logged in user to
          CALL      RDWBSE1                    * get hospital
.
          MATCH     WBSEHOSP,PMVXMHOS          * same as user log on hospital 
          IF        !@EQUAL
            MOVE      ONE,OTHRHOSP
            GOTO      GETVIS10
          ENDIF
          GOTO      GETVIS60 
.
GETVIS50  PACK      KEY13,USERID,SP70              * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
            CALL      RDMLSEC1
            IF        !@EQUAL
              MOVE      ONE,OTHRHOSP
              GOTO      GETVIS10
            ENDIF
          ENDIF
.
GETVIS60  MOVE      ASTAT,ADMSTATS    * Returned Admission Status
.
          IF        MRCNEPSC=1
             IF      ASTAT<>2 & ASTAT<>3
               GOTO    GETVIS10          * Must be current adm or discharged
             ENDIF                       * if using episode coding
             CALL      NEPS0000          * Get next uncoded epsiode EPSCD001
             BRANCH    EXIT,GETVIS10
             MOVE      EPSCD001,LASTEPIS
          ELSE
            COMPARE   "3",ASTAT                   * Discharged only
            GOTO      GETVIS10 IF NOT EQUAL
            MOVE      " 1",LASTEPIS
          ENDIF
.
          MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
GETVIS99  RETURN
.------------------------------------------------------------
. Check ICD Record
.   Required  - URNUMBER
.             - ADMISSNO
.             - VALDCODE
.             - VALDTYPE (1.Diagnosis 2.Procedure 3.Lock Patient for Coding)
.------------------------------------------------------------
CHKICD00  MOVE      URNUMBER,KEY8       * Read Master File 
          CALL      RDMAST1
          BRANCH    OVRCD,CHKICD90
.
          PACK      KEY8,ADMISSNO,SP70   * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,CHKICD94
.
.                                           * I/P or O/P ?            *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          COMPARE   "2",PVITYPE
          GOTO      CHKICD20 IF EQUAL
.
.                                       * inpatient processing *******
CHKICD10  PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,CHKICD91
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      IBACLOCK
            PACK      DDATE,CCC,CYY,CMM,CDD                           *I-224240
            REP       " 0",DDATE
          ENDIF
.
          MOVE      DDATE,ICDRDDTE      * Use Discharge Date to read ICD files
.
          MOVE      ADATE,AGEDATE       * Now using Admission Date
          CALL      CALCAGE             * Needed for VDSCD000 & VOPCD000
          GOTO      CHKICD40
.
.                                       * Outpatient processing ***** *I-145686
CHKICD20  MOVE      "3",ASTAT
          MOVE      PVIDATE,ICDRDDTE
          MOVE      PVIDATE,AGEDATE 
          CALL      CALCAGE             * Needed for VDSCD000 & VOPCD000
          GOTO      CHKICD40
.
.
CHKICD40  BRANCH    VALDTYPE,CHKICD50,CHKICD60,CHKICD70,CHKICD80,CHKICD81
          GOTO      CHKICD93
.
CHKICD50  CALL      VALICD00    * Validate Diagnosis Code
          GOTO      CHKICD99
.
CHKICD60  CALL      VALICO00    * Validate Procedure Code
          GOTO      CHKICD99
.
CHKICD70  CALL      LOCSCR00    * Lock Patient for Coding
          GOTO      CHKICD99
.
CHKICD80  CALL      UNLOCK00    * Unlock Patient for Coding
          GOTO      CHKICD99
.
CHKICD81  CALL      VALADT00    * Validate Accident Date exists
          GOTO      CHKICD99
.
CHKICD90  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient U/R - ":
                             URNUMBER,"</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD91  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Admission - ":
                             ADMISSNO,"</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD92  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Discharge - ":
                             ADMISSNO,"</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD93  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Validation Type":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD94  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Visit - ":
                             ADMISSNO,"</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD95  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Not an Inpatient or Outpatient - ":
                             ADMISSNO,"</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      CHKICD99
.
CHKICD99  RETURN
.------------------------------------------------------------
. Validate ICD Diagnosis
.------------------------------------------------------------
VALICD00  CALL      XMLHED00
          BRANCH    EXIT,VALICD99
.
          MOVE      ZERO,WARNCNT
.
          PACK      PT0DDSC2,SP70,SP70,SP70
          PACK      PT0DDESC,SP70,SP70
          MOVE      VALDCODE,KEY9
          CALL      RDPTICD1 
          BRANCH    OVRCD,VALICD90
          IF        ICDRDVER=1
            MATCH     "999",PTCNDGPV
            GOTO      VALICD10 IF EQUAL       * allowing icd9 codes
            GOTO      VALICD90                * not allowing icd9 codes
          ENDIF
.
          MOVE      ZERO,ECODECNT      * E code counter  
          MOVE      DISCODNO,DSCODNO   * Diagnosis Code Sequence Counter
          MOVE      DSPREFIX,DSCODPFX  * Diagnosis Code Prefix
          MOVE      VALDCODE,DSCOD     * Diagnosis Code       
          CALL      VDSCD000
          BRANCH    EXIT,VALICD92
.
VALICD10  MATCH     SP70,PT0DDSC2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                PT0DDSC2,"|",PT0DACRQ,"|";
            GOTO      VALICD80
          ENDIF
          MATCH     SP70,PT0DDESC
          IF        !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                PT0DDESC,"|",PT0DACRQ,"|";
            GOTO      VALICD80
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DDESC,"|",PT0DACRQ,"|";
VALICD80  CALL      ADDWRN00
          WRITE     HTMLFILE;"</RETURN_VALUE>"
.
          GOTO      VALICD98
.
VALICD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Diagnosis Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Diagnosis Prefix not Posting - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>";
          WRITE     HTMLFILE;WEBERR
          CALL      ADDWRN00
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD98  CALL      XMLEND00
VALICD99  RETURN
.------------------------------------------------------------
. Validate ICD Procedure
.------------------------------------------------------------
VALICO00  CALL      XMLHED00
          BRANCH    EXIT,VALICO99
.
          MOVE      ZERO,WARNCNT
.
          PACK      PT0ODSC2,SP70,SP70,SP70
          PACK      PT0ODESC,SP70,SP70
          MOVE      VALDCODE,KEY9
          CALL      RDPTICO1 
          BRANCH    OVRCD,VALICO90
          IF        ICDRDVER=1
            MATCH     "999",PTCNDGPV          
            IF        @EQUAL
              GOTO      VALICO10              * allowing icd9 codes
            ELSE
              GOTO      VALICO90              * not allowing icd9 codes
            ENDIF
          ENDIF
.
          MOVE      VALDCODE,OPCOD       * Set Var for routine
          CALL      VOPCD000
          BRANCH    EXIT,VALICO92
.
VALICO10  MOVE      ONE,MMRECN
          PACK      KEY11,ADMISSNO,MMRECN,SP70
          CALL      RDMMBS1
          IF        OVRCD=1
            MOVE      ONE,EPSFLAG    * No date information 
            MOVE      SP70,KEY11
            MOVE      SP70,D5
            MOVE      SP70,DIM5
            MOVE      SP10,D10
            MOVE      SP70,DOCFNAME
            CALL      GOPDET00
          ELSE
            UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      ZERO,EPSFLAG    * Date information displayed
.
            IF        CMORBDTM = 3
              MOVE      PTMMRPST,D5              * HDP operation Start Time
              MOVE      PTMMRPET,DIM5            * HDP operation End Time
            ELSE
              MOVE      MMSTIM,D5                * operation start time
              MOVE      MMETIM,DIM5              * operation end time
            ENDIF
.
            MOVE      SP10,D10                   * clinician
            MOVE      SP70,DOCFNAME              * clinician name
            MATCH     "0",MRCNCLIN
            GOTO      VALICO50 IF EQUAL          * not displaying clinician
.
            MATCH     "1",PTMMVAID
            IF        @EQUAL
              MATCH     SP70,PTMMAPRA
              GOTO      VALICO30 IF EQUAL        * AHPRA id is blank
.
              PACK      KEY30,PTMMAPRA,SP70      * Get AHPRA HCP full name
              CALL      RDPMHCP7
              CALL      RKPMHCP7
              BRANCH    OVRCD,VALICO40           * AHPRA id not on file
.
              MATCH     PTMMAPRA,PMHCMPGN
              GOTO      VALICO40 IF NOT EQUAL    * AHPRA id not on file
.
              STRIP     PMHCTITL
              STRIP     PMHCGNAM
              STRIP     PMHCSNAM
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              RESET     PMHCTITL
              RESET     PMHCGNAM
              RESET     PMHCSNAM
              CALL      DOCNM000                 * AHPRA HCP full name
              MOVE      PMHCHCPC,D10             * AHPRA HCP code
            ELSE
              MOVE      SP10,D10                 * clear HCP code
              MOVE      SP70,DOCFNAME            * clear HCP name
            ENDIF
.
            MATCH     "0",PTMMVAID
            IF        @EQUAL
VALICO30      MOVE      SP10,D10                 * clear HCP code
              MOVE      SP70,DOCFNAME            * clear HCP name
              ADD       ONE,WARNCNT
              MOVE      "No AHPRA identifier sent. Please enter a valid clinician.",WEBWRN[WARNCNT]
              GOTO      VALICO50
            ENDIF
.
            MATCH     "2",PTMMVAID
            IF        @EQUAL
VALICO40      MOVE      SP10,D10                 * clear HCP code
              MOVE      SP70,DOCFNAME            * clear HCP name
              ADD       ONE,WARNCNT
              MOVE      "Invalid AHPRA identifier sent. Please enter a valid clinician.",WEBWRN[WARNCNT]
              GOTO      VALICO50
            ENDIF
.
          ENDIF
.
VALICO50  MATCH     SP70,PT0ODSC2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                PT0ODSC2,"|",KEY11,"|",D5,"|",DIM5,"|":
                                EPSFLAG,"|",PT0OBLKN,"|",PT0ODTMN,"|":
                                D10,"|",DOCFNAME,"|";
            GOTO      VALICO80
          ENDIF
          MATCH     SP70,PT0ODESC
          IF        !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                PT0ODESC,"|",KEY11,"|",D5,"|",DIM5,"|":
                                EPSFLAG,"|",PT0OBLKN,"|",PT0ODTMN,"|":
                                D10,"|",DOCFNAME,"|";
            GOTO      VALICO80
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ODESC,"|",KEY11,"|",D5,"|",DIM5,"|":
                              EPSFLAG,"|",PT0OBLKN,"|",PT0ODTMN,"|":
                              D10,"|",DOCFNAME,"|";
VALICO80  CALL      ADDWRN00
          WRITE     HTMLFILE;"</RETURN_VALUE>"
.
          GOTO      VALICO98
.
VALICO90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Procedure Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Procedure Prefix not Posting - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>";
          WRITE     HTMLFILE;WEBERR
          CALL      ADDWRN00
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO98  CALL      XMLEND00
VALICO99  RETURN
+
.------------------------------------------------------------------------------
. When there is No MBS, get the 1st oprdetaf row
.------------------------------------------------------------------------------
GOPDET00  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
GOPDET20  CALL      RKOPDEA2
          BRANCH    OVRCD,GOPDET99
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      GOPDET99 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      GOPDET20 IF EQUAL
.
          MOVE      "1",DIM1
          PACK      KEY11,OPDAUNIQ,DIM1,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,GOPDET99
.
          READ      CONTROLF,FORTY2;*235,OPCNFTIM,*237,OPCNTTIM
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                * Reading Arrival/Departure table
          BRANCH    OVRCD,GOPDET99
.
          CALL      RCVT0000                * determine time in recovery
.
.                                           * load Start time from selected
          LOAD      D5,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                OPARTIDP,OPARTETC
.                                           * load End time from selected
          LOAD      DIM5,OPCNTTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                  OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                  OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                  OPARTIDP,OPARTETC
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
GOPDET99  RETURN
.
.------------------------------------------------------------------------------
. Validate Accident Date exists for applicable ICD Diagnosis codes
.------------------------------------------------------------------------------
VALADT00  CALL      XMLHED00
          BRANCH    EXIT,VALADT99
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECD1
VALADT10  CALL      RKPTECD1
          BRANCH    OVRCD,VALADT98
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      VALADT98 IF NOT EQUAL
.
          PACK      KEY9,PTEDCODE,SP70      * Additional Code Requirements
          CALL      RDPTICD1
          BRANCH    OVRCD,VALADT90
.
          CALL      CHCKA000           * Check if Displaying Accident Dates
.
          IF        ACDNTFLG = 1 & ACDNTMND = 0
            MATCH     PTEDACDT,SP70         * No Accident Date?
            GOTO      VALADT91 IF EQUAL
          ENDIF
.
          GOTO      VALADT10
.
VALADT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Diagnosis Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALADT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Accident Date for Diagnosis Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALADT98  CALL      XMLEND00
VALADT99  RETURN
.------------------------------------------------------------
. Lock Patient for Coding  
.------------------------------------------------------------
LOCSCR00  CALL      XMLHED00
          BRANCH    EXIT,LOCSCR99
.
          MOVE      ZERO,KEY1
.
          MOVE      ZERO,PTEDCNT        * Set Unique Counter 
          MOVE      ZERO,FORM2
          PACK      KEY13,ADMISSNO,FORM2,PTEDCNT,SP70
          CALL      RDPTECD1                 
          BRANCH    OVRCD,LOCSCR10
.
          MATCH     PTEDDTCD,CURRDATE   * Locked today?
          IF        !@EQUAL
            CALL      DELLCK00 
            GOTO      LOCSCR10
          ENDIF
.
          GOTO      LOCSCR90            * Record is set to coding
.
LOCSCR10  MOVE      ADMISSNO,PTEDADMN        * Admin no
          MOVE      ZERO,PTEDEPNO            * Epsiode no
          ADD       ZERO,PTEDCNT             * Increment the episode unique cnt
          MOVE      SP70,PTEDCODE            * Diagnosis code
          MOVE      SP70,PTEDTYPE            * Diagnosis type
          MOVE      ZERO,PTEDUNQN            * Unique no
          MOVE      CURRDATE,PTEDDTCD        * Date of coding
          MOVE      SP70,PTEDTIME            * Time of coding
          MOVE      PASSCODE,PTEDOPER        * Operator
          MOVE      USERID,PTEDUSID          * Web User ID
          MOVE      SP70,PTEDACDT            * Diagnosis accident date
          MOVE      SP70,PTEDCCCL            * CCL Class Level
          MOVE      SP70,PTEDDRGD            * DRG Driver 0=Not Used 1=Used
          MOVE      SP70,PTEDOSET            * Diagnosis onset type
          MOVE      SP70,PTEDCCFL            * Contract Care Flag
          MOVE      SP70,PTEDDCID            * Diagnosis cluster id
          MOVE      SP70,PTEDSPAR
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1              * Write an eps dis coding file rec
            TRAPCLR   IO
            BRANCH    OVRCD,LOCSCR30
          ENDIF
.
          MOVE      ONE,KEY1                * Successful write
.
LOCSCR30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              KEY1:
                             "</RETURN_VALUE>"
.
          GOTO      LOCSCR98
.
LOCSCR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "This visit is currently being coded!":
                             "</RETURN_VALUE>"
          GOTO      LOCSCR98
.
LOCSCR98  CALL      XMLEND00
LOCSCR99  RETURN
.------------------------------------------------------------
. Unlock Patient for Coding  
.------------------------------------------------------------
UNLOCK00  CALL      XMLHED00
          BRANCH    EXIT,UNLOCK99
          MOVE      ZERO,KEY1
.
          MOVE      ZERO,PTEDCNT        * Set Unique Counter 
          MOVE      ZERO,FORM2          * Set Episode No.
          PACK      KEY13,ADMISSNO,FORM2,PTEDCNT,SP70
          CALL      RDPTECD1                 
          BRANCH    OVRCD,UNLOCK30
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      DEPTECD1                
.
UNLOCK30  MOVE      ONE,KEY1                * Dummy Var         
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              KEY1:
                             "</RETURN_VALUE>"
.
          GOTO      UNLOCK98
.
UNLOCK98  CALL      XMLEND00
UNLOCK99  RETURN
.---------------------------------------------------------------------------
. Add Warnings for Procedure/Diagnosis Codes
.---------------------------------------------------------------------------
ADDWRN00  MOVE      ZERO,F2
ADDWRN10  ADD       ONE,F2
          IF        F2>WARNCNT
            GOTO      ADDWRN99
          ENDIF
          WRITE     HTMLFILE;WEBWRN[F2]
          GOTO      ADDWRN10
ADDWRN99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSADWA1,"pmsadwaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATCANA1,"patcanaf"
          OPEN      PATCRGA1,"patcrgaf"
          OPEN      PATCRGA2,"patcrgaf"
          OPEN      PATCRDA1,"patcrdaf"
          OPEN      PATODCA1,"patodcaf"
          OPEN      PMSCDGA1,"pmscdgaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATECMA1,"patecmaf" 
          OPEN      PATITEM1,"patitemn"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA7,"pmshcpaf"
          OPEN      PATCHCO2,"patchcof"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
          OPEN      PATECDA3,"patecdaf"
          OPEN      PATECDA5,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATECOA2,"patecoaf"
          OPEN      PATECOA3,"patecoaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATICDD1,"paticddf"
          OPEN      PATICDO1,"paticdof"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATTRAN3,"pattranf"
          OPEN      MRTTHDR1,"mrtthdaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATPGRA1,"patpgraf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATFN1A1,"patfn1af"
.
          OPEN      MRTAUCA2,"mrtaucaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTMASA3,"mrtmasaf"
          OPEN      MRTMASA4,"mrtmasaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTLOCA2,"mrtlocaf"
          OPEN      MRTPDSA1,"mrtpdsaf"
          OPEN      MRTPSHA1,"mrtpshaf"
          OPEN      MRTTDTR1,"mrttdtaf"
          OPEN      MRTRQDR2,"mrtrqdaf"
          OPEN      MRTRESA1,"mrtresaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTVISA2,"mrtvisaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
.
          OPEN      IHAPASS1,"ihapassf"
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATMHA2,"ibatmhaf"
          OPEN      VISCODA1,"viscodaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      VISXDCA1,"visxdcaf"
          OPEN      WEBSECA3,"websecaf"
.
.  For Grouper
.
          OPEN      PATW11A1,"patw11af"                                *I-902B1
          OPEN      PATW12A1,"patw12af"                                *I-51504
          OPEN      PATW12B1,"patw12bf"
          OPEN      PATW13A1,"patw13af"
          OPEN      PATW14A1,"patw14af"
          OPEN      PATW15A1,"patw15af"
          OPEN      PATW16A1,"patw16af"
          OPEN      PATW17A1,"patw17af"
          OPEN      PATW18A1,"patw18af"
          OPEN      PATW19A1,"patw19af"
          OPEN      PATW20A1,"patw20af"
          OPEN      PATW21A1,"patw21af"
          OPEN      PATWIEA1,"patwieaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCDEA3,"patcdeaf"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PATRDCA1,"patrdcaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,HUND09;*195,PTCNACAS
          READ      CONTROLF,FORTY;*111,OPCNCLSU
          READ      CONTROLF,FIFTY9;*63,CFFMORB,*85,CMORBDTM,*202,PTCNMRPN:
                                    *218,PTMORBDT
          READ      CONTROLF,SIXTY;*84,MRCNHLOC,*151,MRCNDCDT
          READ      CONTROLF,SIXTY;*88,MRCNRCTY,*105,MRCNHMTY,*133,MRCNEPSC
          READ      CONTROLF,SIXTY;*147,MRCNSOMV,*157,MRCNWURL,*237,MRCNWSES:
                                   *247,MRCNAUTG,*248,MRCN3MCD,*249,MRCN3MCG
          READ      CONTROLF,NINTY7;*145,MRCNGRUP,*146,MRCNMECH,*173,MRCNOPDT:
                                    *174,MRCNCLIN,*176,MRCNTREC,*177,MRCNMORP:
                                    *178,MRCNRCDT,*180,MRCNCCOD,*245,MRCNDFPR:
                                    *248,MRCNEACA,*251,MRCNSCTC
          READ      CONTROLF,EIGHTY;*243,PTCNODRG,*249,PTCNEDTE
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*242,PNSWRACE
.                                                                     *C-212604
          READ      CONTROLF,SEVENTY9;*82,PTCNDSCI,*92,PTCNOENC,*93,PTCNAAPE:
                                      *119,PTCNEAPD,*247,PTCNOPHO
          READ      CONTROLF,SEVENTY7;*220,PTCNEDRG
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND25;*93,PTCNNSSI,*249,PTCNCODC
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND31;*1,MRCNDCID
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      ONE,COAUFLAG
          MATCH     "2",MRCNEACA
          IF        @EQUAL
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      MRTCAHA1,"mrtcahaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,COAUFLAG
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      MRTCADA1,"mrtcadaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,COAUFLAG
            ENDIF
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MRTCIEA1,"mrtcieaf"
          TRAPCLR   IO
          IF        OVRCD=0
            OPEN      MRTCIEA2,"mrtcieaf"
          ENDIF
.
          OPEN      PMSEDGA1,"pmsedgaf"     * Effective DRG
          OPEN      PMSEDGA2,"pmsedgaf"     * Effective DRG
.
          CALL      OPICO1
          CALL      OPICO2
          CALL      OPICD1
          CALL      OPICD2
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     PTCNI10D,KEY8
          IF        !@LESS
            MOVE       "101",CODTYP         * Using ICD10 v1 codes
          ELSE
            MOVE       "9",CODTYP           * Using ICD9 codes
          ENDIF
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,EIGHTY8;*241,PTCNCSTA
          READ      CONTROLF,TEN;*36,CMDISD,CMOPRT,*235,CMDISP:
                                 *236,CMDISS,*237,CMDISC,*238,CMDISA
          READ      CONTROLF,TWENTY;*191,PTCECODE
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,PTCNBAGE,*180,PTCNCDRS:
                                     *209,PTCNADMT,*217,CMDISL
          READ      CONTROLF,SIXTY;*150,MRCNECOD
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG,*240,MRCNUNWA,*241,MRCNENWA
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,TEN;*105,PTCNU50G                         *I-50344
          READ      CONTROLF,HUND05;*104,PTCNDGET,*147,CMDISM,*158,PTCNDGPV:
                                    *173,PTCNICUT:
                                    *217,PTCNGDV4,*227,PTCNGDV5       *C-105244
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND13;*4,OPCNPLIN
          READ      CONTROLF,HUND19;*183,PTCNED41,*191,PTCNED42,*199,PTCNED50:
                                    *207,PTCNED51,*215,PTCNED52,*223,PTCNED60:
                                    *231,PTCNED62,*239,PTCNED70       * 303444
          READ      CONTROLF,HUND20;*158,PTCNUNET,*232,PTCNED80
          READ      CONTROLF,HUND23;*232,PTCNED90
          READ      CONTROLF,HUND24;*121,PTCNDGED,*224,PTCNE100
          READ      CONTROLF,HUND28;*239,PTCNE110
          READ      CONTROLF,HUND30;*94,PTCNE120
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,DISCOMNM
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"    * IHI Details
          ENDIF
.
INIT9999  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      ZERO,FLEXPENC
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,ENCODERF
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,STATNCOD
          MOVE      SP70,PRINTSEL
          MOVE      ZERO,EPSCD001
          MOVE      SP70,VALDCODE          
          MOVE      ZERO,VALDTYPE          
          MOVE      SP70,VALDEPIS          
          MOVE      ZERO,DISCODNO  
          MOVE      SP70,DSPREFIX  
          MOVE      SP70,DIOPC001
          PACK      DIOPC002,SP70,SP70,SP70
          MOVE      SP70,DIOPC003
          MOVE      SP70,DIOPC004
          MOVE      SP70,NEWSEQNC
          MOVE      SP70,MOVESWAP
          MOVE      SP70,SETFUNCT
          MOVE      SP70,MEDCD001
          MOVE      SP70,NMDSRESB
          MOVE      SP70,MRTTD001
          MOVE      SP70,WEBERR  
          MOVE      ZERO,RESPNVAR
          MOVE      ZERO,OVERRIDE
          MOVE      ZERO,CANCEROV
          MOVE      ZERO,SEXASSCD 
          MOVE      ZERO,VIEWONLY
          MOVE      ZERO,NMDSCHGF
          MOVE      SP70,OLDICU16
.
          MOVE      ZERO,HRSICU01  
          MOVE      ZERO,HRSICU02  
          MOVE      ZERO,HRSICU03  
          MOVE      ZERO,HRSICU04  
          MOVE      Z70,HRSICU05  
          MOVE      Z70,HRSICU06  
          MOVE      ZERO,HRSICU07  
          MOVE      Z70,HRSICU08  
          MOVE      Z70,HRSICU09  
.
          MOVE      ZERO,HRSICU10  
          MOVE      Z70,HRSICU11
          MOVE      Z70,HRSICU12
          MOVE      Z70,HRSICU13
          MOVE      Z70,HRSICU14  
          MOVE      Z70,HRSICU15  
          MOVE      Z70,HRSICU16  
          MOVE      Z70,HRSICU17
          MOVE      Z70,HRSICU18
          MOVE      SP70,PTECD001
          MOVE      SP70,PTECD002
          MOVE      SP70,PTECD003
          MOVE      SP70,PTECD004
          MOVE      SP70,PTECD005
          MOVE      SP70,PTECD006
          MOVE      SP70,PTECD007  
          MOVE      SP70,PTECD008  
          MOVE      SP70,PTECD009  
.
          MOVE      SP70,MRSTSFLG
.
          MOVE      SP70,OLDURNUM
          MOVE      SP70,OLDBDATE
          MOVE      SP70,OLDPTAGE
          MOVE      SP70,OLDPNAME
          MOVE      SP70,OLDPTSEX
          MOVE      SP70,NEWURNUM
          MOVE      SP70,NEWBDATE
          MOVE      SP70,NEWPTAGE
          MOVE      SP70,NEWPNAME
          MOVE      SP70,NEWPTSEX
.
          MOVE      SP70,MRTME001
          MOVE      SP70,MRTME002
          MOVE      SP70,MRTME003
          MOVE      SP70,MRTME004
          MOVE      SP70,MRTME005
          MOVE      SP70,MRTME006
          MOVE      SP70,MRTME007
          MOVE      SP70,MRTME008
          MOVE      SP70,MRTME009
          MOVE      SP70,MRTME010
          MOVE      SP70,MRTME011
          MOVE      SP70,MRTME012
          MOVE      SP70,MRTME013
          MOVE      SP70,MRTME014
          MOVE      SP70,MRTME015
          MOVE      SP70,MRTME016
          MOVE      SP70,MRTME017
          MOVE      SP70,MRTME018
          MOVE      SP70,MRTME019
          MOVE      SP70,MRTME020
.
          MOVE      SP70,MSCOM001
          MOVE      SP70,MSCOM002
          MOVE      SP70,MSCOM003
          MOVE      SP70,MSCOM004
          MOVE      SP70,MSCOM005
          MOVE      SP70,MSCOM006
          MOVE      SP70,MSCOM007
          MOVE      SP70,MSCOM008
.
          MOVE      SP70,PTCRG001
          MOVE      SP70,PTCRG002
          MOVE      ZERO,PRINTREG
.
          CALL      CLCRDCGI                * clear cgi variables for "patcrdaf"
          CALL      CLRCAH00      * clear mrtcahaf
          CALL      CLCCAH00
          CALL      CLRCAD00      * clear mrtcadaf
          CALL      CLCCAD00
.
          MOVE      Z70,PTMIS029
          MOVE      Z70,PTMIS034
          MOVE      Z70,PTMIS035
          MOVE      Z70,PTMAS031
          MOVE      Z70,PTMIS036
          MOVE      Z70,PTMIS042
          MOVE      Z70,PTMIS051
.
          MOVE      ZERO,PMCDG001
          MOVE      ZERO,PMCDG002
          MOVE      SP70,PMCDG003
          MOVE      ZERO,PMCDG004
          MOVE      ZERO,PMCDG005
          MOVE      SP70,PMCDG006
.
          MOVE      ONE,COUNT               
          WHILE     COUNT <= 10
            MOVE      SP70,WEBWRN[COUNT]  * Warning Array
            MOVE      SP70,CANCODES[COUNT]
            ADD       ONE,COUNT
          DO
.
          MOVE      ONE,COUNT               
          MOVE      MAXARRY,FORM3                                     *C-240107
          WHILE     COUNT <= FORM3                                   
            MOVE      SP70,PREFIXES[COUNT]
            MOVE      SP70,DESCRIPT[COUNT]
            MOVE      SP70,DIACODES[COUNT]
            MOVE      SP70,PROCODES[COUNT]
            MOVE      SP70,CCFLAG[COUNT]                           
            MOVE      SP70,PRODOCCD[COUNT]                            *C-240103
            MOVE      SP70,PRODATES[COUNT]
            MOVE      SP70,PROSTART[COUNT]
            MOVE      SP70,PROENDTM[COUNT]
            MOVE      SP70,ACCIDENT[COUNT]
            MOVE      SP70,SEQDIAGN[COUNT]
            MOVE      SP70,SEQOPRAT[COUNT]
            ADD       ONE,COUNT
          DO
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 100
            MOVE      SP70,NEWHOSPT[COUNT]
            MOVE      SP70,NEWLOCAT[COUNT]
            MOVE      SP70,NEWTYPDC[COUNT]
            MOVE      SP70,NEWVOLUM[COUNT]
            MOVE      SP70,NEWDELFL[COUNT]
            ADD       ONE,COUNT
          DO
.
          MOVE      SP70,CANCERDS[1] 
          MOVE      SP70,CANCERDS[2] 
          MOVE      SP70,CANCERDS[3] 
          MOVE      SP70,CANCERDS[4] 
          MOVE      SP70,CANCERDS[5] 
          MOVE      SP70,CANCERDS[10] 
          MOVE      Z70,AGECARAS
          MOVE      Z70,INPUTDRG
          MOVE      SP70,CPYADMNO
          MOVE      ZERO,OUTPFLAG
          MOVE      ZERO,SQDCOUNT
          MOVE      ZERO,SQOCOUNT
          MOVE      ZERO,CLINREQD
          MOVE      ZERO,DATEREQD
          MOVE      ZERO,TIMEREQD
          MOVE      ZERO,LOCKEPNO
          MOVE      ZERO,WAHEALTH                                     *I-249011
          MOVE      SP70,CKWEIGHT
          MOVE      SP70,NVALWGHT
.
          CALL      CPVSCO00                * visit coding
.
          MOVE      Z70,CODEINCO  
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,SHOWPROC
          PACK      CCAERRKY,SP70
.
          MOVE      SP70,RECRT001
          MOVE      SP70,RECRT002
          MOVE      SP70,SUPERLEV
          MOVE      SP70,DEFLTMAN
          MOVE      SP70,ADMISDTE
          MOVE      ZERO,UNIXNWAU
          MOVE      ZERO,PDCOMFLG
          MOVE      ZERO,PDISCLIN
          MOVE      ZERO,RUNAUTOG
          MOVE      SP70,RETFIELD
          MOVE      SP70,CDATAFLD
          MOVE      ZERO,WAHPDATE
.
          MOVE      SP70,UCDSCHRG
          MOVE      SP70,CLUSTERV
.
          CALL      CLRVXD00             * Visit Extra data
.
CLRPAR99  RETURN
.--------------------------------------------------------------------------
. Set Parameters
.--------------------------------------------------------------------------
SETPAR00  MATCH     "flexpenc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLEXPENC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoderf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCODERF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            PACK      STATNCOD,STATNCOD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printsel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTSEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epscd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdepis=",QRYNAME
          IF        @EQUAL
            PACK      VALDEPIS,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lockepno=",QRYNAME
          IF        @EQUAL
            MOVE      ZERO,F1
            PACK      KEY1,QRYDATA,SP10
            MOVE      KEY1,LOCKEPNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "discodno=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,KEY1,KEY2
            MOVE      KEY2,DISCODNO
            MATCH     "1",KEY1
            IF        !@EQUAL
              UNPACK    QRYDATA,DIM3
              MOVE      ZERO,F3
              MOVE      DIM3,F3
              IF        F3 > 200
                SUB       ONEHUND,F3
                MOVE      F3,DISCODNO
              ENDIF
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diopc001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIOPC001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diopc002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIOPC002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diopc003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIOPC003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diopc004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIOPC004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dsprefix=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSPREFIX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newseqnc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWSEQNC
            PACK      NEWSEQNC,NEWSEQNC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrttd001=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,MRTTD001
            PACK      MRTTD001,MRTTD001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medcd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nmdsresb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NMDSRESB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldurnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDURNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldpname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDPNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldbdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDBDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldptage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDPTAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldptsex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDPTSEX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newurnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWURNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newpname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWPNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newbdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newptage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWPTAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newptsex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWPTSEX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setfunct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETFUNCT
            PACK      SETFUNCT,SETFUNCT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "moveswap=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVESWAP
            PACK      MOVESWAP,MOVESWAP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "respnvar=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESPNVAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "override=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRIDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cancerov=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CANCEROV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sexasscd=",QRYNAME   * Sex Ass code entered flg   
          IF        @EQUAL
            MOVE      QRYDATA,SEXASSCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mripr",QRYNAME       * Contains Prefix Data
          IF        @EQUAL
            CALL      STPRE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mricd",QRYNAME    * Contains Diagnosis/Procedure Codes
          IF        @EQUAL
            CALL      STDIG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ccflg",QRYNAME    * Contains Diagnosis/Procedure Codes
          IF        @EQUAL
            CALL      CCFLG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mride",QRYNAME    * Contains Diagnosis/Proc Descriptions
          IF        @EQUAL
            CALL      STDES000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdt",QRYNAME    * Contains Accident Dates
          IF        @EQUAL
            CALL      STACC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprcl",QRYNAME    * Contains Procedure Clinician codes
          IF        @EQUAL
            CALL      STOCL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprdt",QRYNAME    * Contains Procedure Dates
          IF        @EQUAL
            CALL      STOPR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oprst",QRYNAME    * Contains Procedure Start Time
          IF        @EQUAL
            CALL      STSTR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opred",QRYNAME    * Contains Procedure End Time
          IF        @EQUAL
            CALL      STEND000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hrsicu",QRYNAME   * Contains Intensive Care info 
          IF        @EQUAL
            CALL      STINT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptecd",QRYNAME
          IF        @EQUAL
            CALL      STSUM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "newhs",QRYNAME
          IF         @EQUAL
            CALL       HOSPT000
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "newlc",QRYNAME
          IF         @EQUAL
            CALL       LOCAT000
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "newdf",QRYNAME
          IF         @EQUAL
            CALL       DELTF000
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "newtp",QRYNAME
          IF         @EQUAL
            CALL       TYPDC000
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "newvl",QRYNAME
          IF         @EQUAL
            CALL       VOLUM000
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "mrtme",QRYNAME
          IF        @EQUAL
            CALL      STMOE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mscom",QRYNAME
          IF        @EQUAL
            CALL      MSCOM000 
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcrd",QRYNAME
          IF        @EQUAL
            CALL      STCRD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcrg",QRYNAME
          IF        @EQUAL
            CALL      STCRG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmcdg",QRYNAME
          IF        @EQUAL
            CALL      STCDG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis029=",QRYNAME   * Place if occurance         
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS029
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis034=",QRYNAME   * Admission comment 1
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS034
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis035=",QRYNAME   * Admission comment 2
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS035
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis036=",QRYNAME   * Plurality of Baby
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS036
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis042=",QRYNAME   * User Defined Field 6 (Cat U6
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS042
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis051=",QRYNAME   *Baby's Admission Weight
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS051
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmas031=",QRYNAME   * Autopsy
          IF        @EQUAL
            PACK      PTMAS031,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "agecaras=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AGECARAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printreg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTREG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inputdrg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INPUTDRG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpyadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPYADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seqdi",QRYNAME
          IF        @EQUAL
            MOVE      MAXARRY,FORM3                                   *C-240107
            COMPARE   FORM3,SQDCOUNT
            GOTO      SETPAR99 IF EQUAL
.
            ADD       ONE,SQDCOUNT
            PACK      SEQDIAGN[SQDCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seqop",QRYNAME
          IF        @EQUAL
            MOVE      MAXARRY,FORM3                                   *C-240107
            COMPARE   FORM3,SQOCOUNT
            GOTO      SETPAR99 IF EQUAL
.
            ADD       ONE,SQOCOUNT
            PACK      SEQOPRAT[SQOCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wahealth",QRYNAME                                *I-249011
          IF        @EQUAL
            MOVE      ZERO,F1
            PACK      KEY1,QRYDATA
            MOVE      KEY1,F1
            MOVE      F1,WAHEALTH
          ENDIF
.
          MATCH     "vscdcatg",QRYNAME
          IF        @EQUAL
            CALL      SVSCAT00              * Visit based coding
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vscdcode",QRYNAME
          IF        @EQUAL
            CALL      SVSCOD00              * Visit based coding
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "codeinco=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CODEINCO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showproc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWPROC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ccaerrky=",QRYNAME
          IF        @EQUAL
            PACK      CCAERRKY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ckweight=",QRYNAME
          IF        @EQUAL
            PACK      CKWEIGHT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nvalwght=",QRYNAME
          IF        @EQUAL
            PACK      NVALWGHT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recrt001=",QRYNAME
          IF        @EQUAL
            PACK      RECRT001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recrt002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      RECRT002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "3MOutput=",QRYNAME
          IF        @EQUAL
            IF        PTCNOENC = 2
              CALL      GETENC00            * only if using web Codefinder
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defltman=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFLTMAN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisdte=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISDTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pdisccom=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,PDCOMFLG
            CALL      PDSCCM00              * Read in Adm Comments
          ENDIF
.
          MATCH     "runautog=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RUNAUTOG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retfield=",QRYNAME
          IF        @EQUAL
            PACK      RETFIELD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cdatafld=",QRYNAME
          IF        @EQUAL
            PACK      CDATAFLD,QRYDATA,SP70,SP70,SP70,SP70,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wahpdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAHPDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ucdschrg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UCDSCHRG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsxdc",QRYNAME
          IF        @EQUAL
            CALL      SVSXDC00              * Visit extra data
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clusterv=",QRYNAME
          IF        @EQUAL
            PACK      CLUSTERV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.----------------------------------------------------------------
.   Set Parameters for Option 08: Cancer Registration                      
.----------------------------------------------------------------
STCRG000  UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STCRG001,STCRG002
          GOTO      STCRG999
.
STCRG001  MOVE      QRYDATA,PTCRG001
          GOTO      STCRG999
.
STCRG002  MOVE      QRYDATA,PTCRG002
          GOTO      STCRG999
.
STCRG999  RETURN
.----------------------------------------------------------------
.   Set Parameters for Option 08: Cancer Registration                      
.----------------------------------------------------------------
...       see       PATCRDTM.PBL
+
.----------------------------------------------------------------
.   Set Parameters for Option 08: Cancer Reason for Clinical Diagnosis     
.----------------------------------------------------------------
STCDG000  UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STCDG001,STCDG002,STCDG003,STCDG004,STCDG005:
                       STCDG006
.
STCDG001  MOVE      QRYDATA,PMCDG001
          GOTO      STCDG999
.
STCDG002  MOVE      QRYDATA,PMCDG002
          GOTO      STCDG999
.
STCDG003  MOVE      QRYDATA,PMCDG003
          PACK      PMCDG003,PMCDG003,SP70
          GOTO      STCDG999
.
STCDG004  MOVE      QRYDATA,PMCDG004
          GOTO      STCDG999
.
STCDG005  MOVE      QRYDATA,PMCDG005
          GOTO      STCDG999
.
STCDG006  MOVE      QRYDATA,PMCDG006
          PACK      PMCDG006,PMCDG006,SP70
          GOTO      STCDG999
.
STCDG999  RETURN
+
.-------------------------------------------------------------------------------
.   Set Parameters for Option 01: Intensive Care Details & Admission Weight 
.-------------------------------------------------------------------------------
STINT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STINT001,STINT002,STINT003,STINT004,STINT005:
                       STINT006,STINT007,STINT008,STINT009,STINT010:
                       STINT011,STINT012,STINT013,STINT014,STINT015:
                       STINT016,STINT017,STINT018
.
          MOVE      ONE,EXIT
          GOTO      STINT999
.
STINT001  MOVE      QRYDATA,HRSICU01
          GOTO      STINT999
.
STINT002  MOVE      QRYDATA,HRSICU02
          GOTO      STINT999
.
STINT003  MOVE      QRYDATA,HRSICU03
          GOTO      STINT999
.
...STINT004  MOVE      QRYDATA,HRSICU04                               *D-217573
STINT004  MOVE      QRYDATA,KEY6                                      *C-217573
          SQUEEZE   KEY6
          MOVE      KEY6,HRSICU04
          GOTO      STINT999
.
STINT005  MOVE      QRYDATA,HRSICU05
          GOTO      STINT999
.
STINT006  MOVE      QRYDATA,HRSICU06
          GOTO      STINT999
.
STINT007  MOVE      QRYDATA,HRSICU07
          GOTO      STINT999
.
STINT008  MOVE      QRYDATA,HRSICU08
          GOTO      STINT999
.
STINT009  MOVE      QRYDATA,HRSICU09
          GOTO      STINT999
.
STINT010  MOVE      QRYDATA,HRSICU10
          GOTO      STINT999
.
STINT011  MOVE      QRYDATA,HRSICU11
          GOTO      STINT999
.
STINT012  MOVE      QRYDATA,HRSICU12
          GOTO      STINT999
.
STINT013  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00              * Set CMON from MTHNAM3
          PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
          MOVE      QRYDATA,HRSICU13
          GOTO      STINT999
.
STINT014  MOVE      QRYDATA,HRSICU14
          GOTO      STINT999
.
STINT015  MOVE      QRYDATA,HRSICU15
          GOTO      STINT999
.
STINT016  MOVE      QRYDATA,HRSICU16
          GOTO      STINT999
.
STINT017  MOVE      QRYDATA,HRSICU17
          GOTO      STINT999
.
STINT018  MOVE      QRYDATA,HRSICU18
          GOTO      STINT999
.
STINT999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 3 - Record coding summary 
.-------------------------------------------------------------------------------
STSUM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STSUM001,STSUM002,STSUM003,STSUM004,STSUM005:
                       STSUM006,STSUM007,STSUM008,STSUM009
          GOTO      STSUM999
.
STSUM001  MOVE      QRYDATA,PTECD001
          GOTO      STSUM999
.
STSUM002  MOVE      QRYDATA,F2
          MOVE      F2,PTECD002
          GOTO      STSUM999
.
STSUM003  MOVE      QRYDATA,KEY3                                      *C-240107
          SQUEEZE   KEY3
          MOVE      KEY3,F3
          MOVE      F3,PTECD003
          GOTO      STSUM999
.
STSUM004  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      PTECD004,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PTECD004
          ELSE
            MOVE      QRYDATA,PTECD004     
          ENDIF
          GOTO      STSUM999
.
STSUM005  MOVE      QRYDATA,PTECD005
          GOTO      STSUM999
.
STSUM006  MOVE      QRYDATA,PTECD006
          GOTO      STSUM999
.
STSUM007  MOVE      QRYDATA,PTECD007
          GOTO      STSUM999
.
STSUM008  MOVE      QRYDATA,PTECD008
          MOVE      "1",MRSTSFLG 
          GOTO      STSUM999
.
STSUM009  PACK      PTECD009,QRYDATA,SP20                             *I-240103
          GOTO      STSUM999
.
STSUM999  RETURN
.----------------------------------------------------------------
. Set parameter for hospital
.----------------------------------------------------------------
HOSPT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      NEWHOSPT[F3],QRYDATA,SP70
HOSPT999  RETURN
.----------------------------------------------------------------
. Set parameter for location
.----------------------------------------------------------------
LOCAT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      NEWLOCAT[F3],QRYDATA,SP70
LOCAT999  RETURN
.----------------------------------------------------------------
. Set parameter for document type
.----------------------------------------------------------------
DELTF000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      NEWDELFL[F3],QRYDATA,SP70
DELTF999  RETURN
.----------------------------------------------------------------
. Set parameter for document type
.----------------------------------------------------------------
TYPDC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      NEWTYPDC[F3],QRYDATA,SP70
TYPDC999  RETURN
.----------------------------------------------------------------
. Set parameter for volume
.----------------------------------------------------------------
VOLUM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      NEWVOLUM[F3],QRYDATA,SP70
VOLUM999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Input of Prefix Information            
.----------------------------------------------------------------
STPRE000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STPRE999
          ENDIF
          PACK      PREFIXES[F3],QRYDATA,SP70
.
STPRE999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Input of Prefix Information
.----------------------------------------------------------------
STDES000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STDES999
          ENDIF
          PACK      DESCRIPT[F3],QRYDATA,SP70
.
STDES999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Input of Procedure Start Times            
.----------------------------------------------------------------
STSTR000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STSTR999
          ENDIF
          PACK      PROSTART[F3],QRYDATA,SP70
.
STSTR999  RETURN
.----------------------------------------------------------------
. Set Parameters for Option 1: Input of Procedure End Time            
.----------------------------------------------------------------
STEND000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STEND999
          ENDIF
          PACK      PROENDTM[F3],QRYDATA,SP70
.
STEND999  RETURN
+
.-----------------------------------------------------------------------
. Check if code is disease or operation (based on grouper version = 9.9)
.-----------------------------------------------------------------------
CHICD000  MOVE      ZERO,CODEFLAG
          MATCH     "999",PTCNDGPV          * allowing icd9 codes?
          GOTO      CHICD100 IF NOT EQUAL
.
          PACK      KEY9,CHKCODE,SP70
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      ONE,CODEFLAG          * disease
            GOTO      CHICD999
          ENDIF
          PACK      KEY9,CHKCODE,SP70
          CALL      RDPTICO1
          IF        OVRCD<>1
            MOVE      TWO,CODEFLAG          * operation
            GOTO      CHICD999
          ENDIF
.
CHICD100  UNPACK    CHKCODE,KEY1
          TYPE      KEY1
          IF        @EQUAL
            MOVE      TWO,CODEFLAG          * icd10 operation
          ELSE
            MOVE      ONE,CODEFLAG          * icd10 disease
          ENDIF
CHICD999  RETURN
+
.-----------------------------------------------------------------
. Set Parameters for Option 1: Input of Diagnosis/Procedures
.-----------------------------------------------------------------
STDIG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDIG999 IF EQUAL
.
          PACK      CHKCODE,QRYDATA,SP70
          CALL      CHICD000
          BRANCH    CODEFLAG,STDIG300,STDIG200
.                            disease  operat
.
          GOTO      STDIG999      * code not on file
.
STDIG200  MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            MOVE      ONE,PROCFLAG
            GOTO      STDIG999
          ENDIF
          MOVE      ZERO,PROCFLAG
.
          PACK      PROCODES[F3],QRYDATA,SP70   * Procedure Code
          MOVE      F3,LASTPROC
          GOTO      STDIG999
.
STDIG300  MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            MOVE      ONE,DIAGFLAG
            GOTO      STDIG999
          ENDIF
          MOVE      ZERO,DIAGFLAG
.
          PACK      DIACODES[F3],QRYDATA,SP70   * Diagnosis Code
          MOVE      F3,LASTDIAG
          GOTO      STDIG999
.
STDIG999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Option 1: Input of Accident Dates                      
.-----------------------------------------------------------------
STACC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STACC999
          ENDIF
.
          MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
            PACK      ACCIDENT[F3],KEY8,SP70
          ELSE
            MOVE      QRYDATA,ACCIDENT[F3]
          ENDIF
.
STACC999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Option 1: Input of Contract Care Flag
.-----------------------------------------------------------------
CCFLG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3
          IF        F3 > FORM3
            GOTO      CCFLG999
          ENDIF
.
          MOVE      QRYDATA,CCFLAG[F3]
.
CCFLG999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Option 1: Input of Procedure Clinician Codes     *I-240103
.-----------------------------------------------------------------
STOCL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3 
          IF        F3 > FORM3                                       
            GOTO      STOCL999
          ENDIF
.
          MOVE      QRYDATA,PRODOCCD[F3] 
.
STOCL999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Option 1: Input of Procedure Dates                      
.-----------------------------------------------------------------
STOPR000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          MOVE      MAXARRY,FORM3                                     *I-240107
          IF        F3 > FORM3                                       
            GOTO      STOPR999
          ENDIF
.
          MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
            PACK      PRODATES[F3],KEY8,SP70
          ELSE
            MOVE      QRYDATA,PRODATES[F3] 
          ENDIF
.
STOPR999  RETURN
.-----------------------------------------------------------------
. Set Record Coding URL
. If Coding exist then redirect to Summury Coing Screen otherwise
. it will redirect to Coding input screen
.-----------------------------------------------------------------
SETMED00  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,SETMED90
.                                                * check for In/Outpatient
          IF        PVITYPE = 2 | PVITYPE = 3
            GOTO      SETMED05
          ENDIF
.                                                * else don't process
          GOTO      SETMED93
.
SETMED05  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            COMPARE   ONE,ASTAT
            GOTO      SETMED91 IF EQUAL          * don't code if pre-admission
.
            COMPARE   FIVE,ASTAT
            GOTO      SETMED92 IF EQUAL          * don't code if cancelled
          ENDIF
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,SETMED90
          COMPARE   ONE,PSTAT
          GOTO      SETMED20 IF NOT EQUAL
.
SETMED10  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,SETMED90   * New U/R number missing
          BRANCH    PSTAT,SETMED10   * Another associated U/R number
.
SETMED20  MOVE      PVIBILL,LASTVIST * Set for CHKEPS00
          CALL      CHKEPS00         * Check if Patient has existing Episodes
.
          IF        EPSFLAG=1 
            MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
            MOVE      "01",REPTNO             * Set for STRDIR00
            MOVE      "001",TEMPLATE          * Set for STRDIR00
            MOVE      EPSNUMBR,EPSCD001       * Set for STRDIR00 - default to 1
            MOVE      ONE,NEXTPAGE            * Set for STRDIR00
            CALL      STRDIR00 
          ELSE
            MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
            MOVE      "03",REPTNO             * Set for STRDIR00
            MOVE      "001",TEMPLATE          * Set for STRDIR00
            MOVE      EPSNUMBR,EPSCD001       * Set for STRDIR00 - default to 1
            MOVE      ONE,NEXTPAGE            * Set for STRDIR00
            CALL      STRDIR00 
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SETMED99
.
SETMED90  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETMED99
.
SETMED91  MOVE      "Cannot code pre-admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETMED99
.
SETMED92  MOVE      "Cannot code cancelled admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETMED99
.
SETMED93  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETMED99
.
SETMED99  RETURN
.-----------------------------------------------------------------
. Medical Record Coding
.-----------------------------------------------------------------
MEDCOD00  MATCH     SP70,UPDTTYPE
          GOTO      MEDCOD70 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Save Asscociated & ICD Coding       
          GOTO      MEDCOD10 IF EQUAL
.
          MATCH     "N",UPDTTYPE    * Save Asscociated only & No ICD Coding
          GOTO      MEDCOD10 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Update Associated Coding Screen    
          GOTO      MEDCOD20 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Copy Codes From Previous Discharge
          GOTO      MEDCOD30 IF EQUAL
.
          MATCH     "T",UPDTTYPE    * Post Coding Template 
          GOTO      MEDCOD40 IF EQUAL
.
          MATCH     "E",UPDTTYPE    * Save ICD Coding Before executing Encoder 
          GOTO      MEDCOD50 IF EQUAL
.
          MATCH     "M",UPDTTYPE      * Save ICD Coding Before executing 
          GOTO      MEDCOD50 IF EQUAL * TurboGrouper Export
.
          MATCH     "S",UPDTTYPE    * Save Associated Coding Screen    
          GOTO      MEDCOD60 IF EQUAL
.
          MATCH     "P",UPDTTYPE    * Save Post discharge missing details
          IF        @EQUAL
            CALL      PDSCOM00 
            GOTO      MEDCOD99
          ENDIF             
.
          MATCH     "H",UPDTTYPE    * Aust Mental Health Care Class.template
          IF        @EQUAL
            CALL      MHCC0000      * AMHCC End Code
            GOTO      MEDCOD99
          ENDIF
.
          GOTO      MEDCOD90
.
.   ************ SAVE ICD10 CODING ************
. 
MEDCOD10  COMPARE   ONE,DIAGFLAG
          GOTO      MEDCOD98 IF EQUAL
.
          COMPARE   ONE,PROCFLAG
          GOTO      MEDCOD98 IF EQUAL
.
          MOVE      URNUMBER,KEY8   * Read Master File to get Date of Birth 
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Visit file
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
. 
          COMPARE   "2",PVITYPE             * check for Outpatient
          GOTO      MEDCOD13 IF EQUAL
.
.                                           * inpatient processing *******
MEDCOD11  PACK      KEY8,ADMISSNO,SP70      * Read for Discharge Data
          PACK      DDATE,CURRDATE          * default Discharge date
          CALL      RDDSCH1
.
          MOVE      DDATE,ICDRDDTE  * Use Discharge Date for reading ICD files.
.
          CALL      CHKINT00        * Check for Invalid Intention to Readmit
          BRANCH    EXIT,MEDCOD99
.
          CALL      CKHEAD00        * Check for Invalid Disease/Procedure Codes
          BRANCH    EXIT,MEDCOD99
.
          IF        OVERRIDE<>1 
            CALL      CKEMR000      * Check for E & M Codes
            BRANCH    EXIT,MEDCOD99  
          ENDIF
.
          MOVE      ZERO,UMISFLAG           * Update admission file flag to no
          PACK      KEY8,ADMISSNO,SP70      * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93,MEDCOD89
.
          MATCH     Z70,PTMIS029
          IF        !@EQUAL
            MOVE      PTMIS029,APLOCCR  * Update place of occurance
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          IF        UMISFLAG=1
            CALL      UPMISS1
          ENDIF
.
          MOVE      ADATE,AGEDATE           * Now using Admission Date
          CALL      CALCAGE                 * Calculate age
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00                * Check if leap year
          IF        PSAGEDAY < NOOFDAYS
            MOVE      HRSICU04,WEIGHT       * Set input Var for WGHTCK00
            CALL      WGHTCK00              * Patient Weight Edit check
            BRANCH    EXIT,MEDCOD99  
            MOVE      HRSICU04,WEIGHT       * Set for VDCB0000
            CALL      VDCB0000              * Validate the dis codes for babies
            BRANCH    EXIT,MEDCOD99  
            CALL      WGHTSV00              * Save Patient Weight      
          ELSE
...         CALL      AGEDIT00              * Validation for Age Edits
...         BRANCH    EXIT,MEDCOD99          
          ENDIF
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          CALL      SAVICU00        * Save ICU Info
          CALL      SAVSNG00        * Save Coder Snag
          CALL      SAVPDS00        * Save Post Discharge Status
          CALL      SAVINT00        * Save Intention to Readmit
.         
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            CALL      GROUPR00      * Save Diagnosis/Procedure Codes
          ENDIF
.  
          CALL      PTHCS000        * Update Episode Morbidity Changes File
          GOTO      MEDCOD15
.
.                                   * outpatient processing *******   *I-145686
MEDCOD13  MOVE      "3",ASTAT
          MOVE      PVIDATE,ICDRDDTE
.
          CALL      CKHEAD00        * Check for Invalid Disease/Procedure Codes
          BRANCH    EXIT,MEDCOD99
.
          IF        OVERRIDE<>1 
            CALL      CKEMR000      * Check for E & M Codes
            BRANCH    EXIT,MEDCOD99  
          ENDIF
.
          CALL      SAVSNG00        * Save Coder Snag
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            CALL      GROUPR00      * Save Diagnosis/Procedure Codes
          ENDIF
.
          GOTO      MEDCOD19
.
.
.    Run UNIX or PC Grouper Depending on PARAMETER 
.
MEDCOD15  BRANCH    MRCNEPSC,MEDCOD16       * continue if Episode Coding
          IF        ASTAT <> 3
            GOTO      MEDCOD19              * don't group if not discharged
          ENDIF
.
MEDCOD16  MATCH     "N",UPDTTYPE
          IF        !@EQUAL
            COMPARE   ONE,PTCNODRG
            IF        @EQUAL
              COMPARE   ONE,MRCNGRUP          * 1=PC, 0=UNIX Grouper
              IF        @EQUAL
                MOVE      "G",UPDTTYPE        * Export/Import PC Grouper
                CALL      SETGRP00
              ELSE
                IF        MRCNGRUP=3
                  MOVE      "O",UPDTTYPE        * Run TurboGrouper
                ELSE
                  MOVE      "U",UPDTTYPE        * Run UNIX Grouper
                ENDIF
                CALL      SETGRP00
                MOVE      "U",UPDTTYPE
              ENDIF
            ENDIF
          ENDIF
.
MEDCOD19  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "03",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string 
.
          MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.   ************ SAVE ASSOCIATED CODING INFO ************
.
MEDCOD20  MOVE      URNUMBER,KEY8   * Read Master File to get Date of Birth 
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
          MATCH     Z70,PTMAS031        * Update Autopsy 
          IF        !@EQUAL
            MOVE      PTMAS031,PAUTOPY
            CALL      UPMAST1
          ENDIF
.                                                                     *I-145686
          PACK      KEY8,ADMISSNO,SP70      * Read for Visit file
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
. 
          COMPARE   "2",PVITYPE             * check for Outpatient
          GOTO      MEDCOD99 IF EQUAL       * no Associate data for O/P
.
.                                           * inpatient processing
          MOVE      ZERO,UMISFLAG       * Update admission file flag to no
          PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93,MEDCOD89 
.
          MATCH     Z70,PTMIS029
          IF        !@EQUAL
            MOVE      PTMIS029,APLOCCR  * Update place of occurance
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     Z70,PTMIS034
          IF        !@EQUAL
            MOVE      PTMIS034,ACOMM1   * Admission comment 1
            MOVE      ONE,UMISFLAG      * Yes update admission file 
          ENDIF
.
          MATCH     Z70,PTMIS035
          IF        !@EQUAL
            MOVE      PTMIS035,ACOMM2   * Admission comment 2
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     PTMIS036,Z70
          IF        !@EQUAL
            MOVE      PTMIS036,APLUR
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     PTMIS042,Z70
          IF        !@EQUAL
            MOVE      PTMIS042,AUSR6
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     PTMIS051,Z70            * ensure Baby Weight right aligned
          IF        !@EQUAL
            SQUEEZE   PTMIS051
            MOVE      PTMIS051,HRSICU04
            IF        @EOS
              MOVE      SP6,ABWGHT          * PTMIS051 is blank
            ELSE
              MOVE      ZERO,FORM6
              MOVE      PTMIS051,FORM6
              MOVE      FORM6,ABWGHT
            ENDIF
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          IF        UMISFLAG=1
            CALL      UPMISS1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
          CALL      RDDSCH1
          IF        OVRCD<>1
            CALL      CHKINT00        * Check for Invalid Intention to Readmit
            BRANCH    EXIT,MEDCOD99
          ENDIF
.
          MOVE      ADATE,AGEDATE           * Now using Admission Date
          CALL      CALCAGE                 * Calculate age
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00                * Check if leap year
          IF        PSAGEDAY < NOOFDAYS
            MOVE      HRSICU04,WEIGHT       * Set input Var for WGHTCK00
            CALL      WGHTCK00              * Patient Weight Edit check
            BRANCH    EXIT,MEDCOD99
            CALL      WGHTSV00              * Save Patient Weight      
          ENDIF
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          CALL      SAVICU00        * Save ICU Info
          CALL      SAVCAR00        * Save Reason for Critical Care
          CALL      SAVEXT00        * Save Visit extension details
          MOVE      "12",HDPEQUIV
          CALL      WPEI0000        * Write patpeiaf record
.
          MATCH     "1",MRCNRCDT            * is "Reset Coding Date" set ?
          IF        @EQUAL
            CALL      CLRACC00              * then set ACODDTE to blank
          ENDIF
.
          CALL      SAVSTS00
.
          MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.
.   ************ COPY PREVIOUS DISCHARGE INFO ************
.
MEDCOD30  MATCH     SP70,CPYADMNO
          IF        @EQUAL|@EOS
            CALL      PRVDIS00        * Get Previous Discharge Record
          ELSE
            CALL      PRVDSN00        * Get Selected Discharge Record
          ENDIF
          BRANCH    EXIT,MEDCOD99
.
          CALL      DISSQE00        * Resequence Disease Codes & MDS Data
          CALL      PROSQE00        * Resequence Procedure Codes & MDS Data
.
          MATCH     SP70,CPYADMNO
          IF        !@EQUAL & !@EOS
            CALL      SAVICU00  * Save ICU Info
            CALL      SAVSNG00  * Save Coder Snag
            CALL      SAVINT00  * Save Intention to Readmit
            CALL      SAVPDS00  * Save Post Discharge Status
            CALL      WGHTSV00  * Save Patient Weight
          ENDIF
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
.
.    Run UNIX or PC Grouper Depending on PARAMETER 
.
          COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP          * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "G",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
              BRANCH    EXIT,MEDCOD99
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE        * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE        * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
              MOVE      "U",UPDTTYPE
              BRANCH    EXIT,MEDCOD99
            ENDIF
          ENDIF
.
          MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "03",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string 
.
          MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.   ************ POST CODING TEMPLATE DETAILS ************
.
MEDCOD40  MOVE      URNUMBER,KEY8       * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Visit file
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
. 
          COMPARE   "2",PVITYPE             * check for Outpatient
          GOTO      MEDCOD42 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Admission File 
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93          
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Discharge File 
          PACK      DDATE,CURRDATE,SP10     * default DDATE
          CALL      RDDSCH1
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
MEDCOD42  PACK      KEY8,MRTTD001,SP70      * Check for Coding Template
          CALL      RSMRTDT1 
          CALL      RKMRTDT1 
          BRANCH    OVRCD,MEDCOD94
.
          MATCH     MRTTD001,MRTDTMNO  
          GOTO      MEDCOD94 IF NOT EQUAL
.
          PACK      KEY8,MRTTD001,DISIND,Z70
          CALL      RSMRTDT1
          CALL      RPMRTDT1
          MOVE      MRTDSEQN,F3
          COMPARE   F3,THREEHUND            * Max 300
          GOTO      MEDCOD96 IF LESS
.
          PACK      KEY8,MRTTD001,PROIND,Z70
          CALL      RSMRTDT1
          CALL      RPMRTDT1
          MOVE      MRTDSEQN,F3
          COMPARE   F3,THREEHUND            * Max 300
          GOTO      MEDCOD97 IF LESS
.
          CALL      DELLCK00  * Delete Diagnosis Lock Record if found  
          CALL      DELECD00  * Delete all records from Diagnosis Coding file
          CALL      DELECO00  * Delete all records from Procedure Coding file
          CALL      CLRCHC00  * clear "Date Episode Coding Complete" in PATCHCof
.
          CALL      GETDIS00  * Save Diagnosis Codes to Episode File
          CALL      GETPRO00  * Save Procedure Codes to Episode File
          CALL      DISSQE00  * Resequence Disease Codes & MDS Data
          CALL      PROSQE00  * Resequence Procedure Codes & MDS Data
. 
          COMPARE   "2",PVITYPE             * check for Outpatient    *I-145686
          GOTO      MEDCOD45 IF EQUAL       * bypass coding
.
          CALL      SAVICU00  * Save ICU Info
          CALL      SAVSNG00  * Save Coder Snag
          CALL      SAVINT00  * Save Intention to Readmit
          CALL      SAVPDS00  * Save Post Discharge Status
          CALL      WGHTSV00  * Save Patient Weight
.
.    Run UNIX or PC Grouper Depending on PARAMETER 
.
          IF        ASTAT<>3
            GOTO      MEDCOD45
          ENDIF
.
          COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "G",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE        * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE        * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
              MOVE      "U",UPDTTYPE
            ENDIF
          ENDIF
.
MEDCOD45  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "03",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string 
. 
          MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.   ************ SAVE ICD10 CODING BEFORE EXECUTING ENCODER ************
.
.    Note no edit checks need to be done here as going straight to the 
.    encoder. All edit checks will be done when OK is pressed on screen 6.
. 
MEDCOD50  MOVE      URNUMBER,KEY8   * Read Master File to get Date of Birth 
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Visit file
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
. 
          COMPARE   "2",PVITYPE             * check for Outpatient
          IF        @EQUAL
            CALL      SAVSNG00              * Save Coder Snag
            CALL      GROUPR00              * Save Diagnosis/Procedure Codes 
            MOVE      ZERO,EXIT
            GOTO      MEDCOD99              * end - bypass Grouper coding
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93          
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Discharge Data
          MOVE      CURRDATE,DDATE          * default DDATE
          CALL      RDDSCH1
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          CALL      SAVICU00        * Save ICU Info
          CALL      SAVSNG00        * Save Coder Snag
          CALL      SAVPDS00        * Save Post Discharge Status
          CALL      SAVINT00        * Save Intention to Readmit
          CALL      WGHTSV00        * Save Patient Weight      
          CALL      GROUPR00        * Save Diagnosis/Procedure Codes 
          CALL      PTHCS000        * Update Episode Morbidity Changes File
.
. ******* removed - causes Version problems and should not be needed  *D-269695
....    Run UNIX or PC Grouper Depending on PARAMETER
....
...       IF        ASTAT<>3
...         GOTO      MEDCOD55
...       ENDIF
...
...       COMPARE   ONE,PTCNODRG
...       IF        @EQUAL
...         COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
...         IF        @EQUAL
...           MOVE      "G",UPDTTYPE        * Export/Import PC Grouper
...           CALL      SETGRP00
...         ELSE
...           MOVE      "U",UPDTTYPE        * Run UNIX Grouper
...           CALL      SETGRP00
...         ENDIF
...       ENDIF                                            * end      *D-269695
.
MEDCOD55  IF        MRCNGRUP<>3
            MOVE      "E",UPDTTYPE         
          ENDIF
          CALL      SETGRP00                * Export to Codefinder (Encoder)
          MOVE      "E",UPDTTYPE
. 
MEDCOD59  MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.   ************ SAVE ASSOCIATED CODING INFO NO CODE ERROR CHECKS ************
.
MEDCOD60  MOVE      URNUMBER,KEY8   * Read Master File to get Date of Birth 
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
          MATCH     Z70,PTMAS031        * Update Autopsy 
          IF        !@EQUAL
            MOVE      PTMAS031,PAUTOPY
            CALL      UPMAST1
          ENDIF
.
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Visit file
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
. 
          COMPARE   "2",PVITYPE             * check for Outpatient
          GOTO      MEDCOD99 IF EQUAL
.
          MOVE      ZERO,UMISFLAG           * Update admission file flag to no
          PACK      KEY8,ADMISSNO,SP70      * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93,MEDCOD89 
.
          MATCH     Z70,PTMIS029
          IF        !@EQUAL
            MOVE      PTMIS029,APLOCCR      * Update place of occurance
            MOVE      ONE,UMISFLAG          * Yes update admission file
          ENDIF
.
          MATCH     Z70,PTMIS034
          IF        !@EQUAL
            MOVE      PTMIS034,ACOMM1       * Admission comment 1
            MOVE      ONE,UMISFLAG          * Yes update admission file
          ENDIF
.         
          MATCH     Z70,PTMIS035
          IF        !@EQUAL
            MOVE      PTMIS035,ACOMM2       * Admission comment 2
            MOVE      ONE,UMISFLAG          * Yes update admission file
          ENDIF
.
          MATCH     PTMIS036,Z70
          IF        !@EQUAL
            MOVE      PTMIS036,APLUR
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     PTMIS042,Z70
          IF        !@EQUAL
            MOVE      PTMIS042,AUSR6
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          MATCH     PTMIS051,Z70            * ensure Baby Weight right aligned
          IF        !@EQUAL
            SQUEEZE   PTMIS051
            IF        @EOS
              MOVE      SP6,ABWGHT          * PTMIS051 is blank
            ELSE
              MOVE      ZERO,FORM6
              MOVE      PTMIS051,FORM6
              MOVE      FORM6,ABWGHT
            ENDIF
            MOVE      ONE,UMISFLAG      * Yes update admission file
          ENDIF
.
          IF        UMISFLAG=1
            CALL      UPMISS1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70      * Read for Discharge Data
          MOVE      CURRDATE,DDATE
          CALL      RDDSCH1
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          CALL      CHKINT00        * Check for Invalid Intention to Readmit
          BRANCH    EXIT,MEDCOD99
.
          MOVE      ADATE,AGEDATE           * Now using Admission Date
          CALL      CALCAGE                 * Calculate age
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00                * Check if leap year
          IF        PSAGEDAY < NOOFDAYS
            MOVE      HRSICU04,WEIGHT       * Set input Var for WGHTCK00
            CALL      WGHTCK00              * Patient Weight Edit check
            BRANCH    EXIT,MEDCOD99
            CALL      WGHTSV00              * Save Patient Weight      
          ENDIF
.
          CALL      SAVICU00        * Save ICU Info
          CALL      SAVCAR00        * Save Reason for Critical Care
          CALL      SAVEXT00        * Save Visit extension details
.
          CALL      SAVSTS00        * Save status (MRPDSTAT)
.
MEDCOD69  MOVE      ZERO,EXIT
          GOTO      MEDCOD99
.
.   ************ DISPLAY: VALIDATE URNUMBER & VISIT NUMBER ************
.
MEDCOD70  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MEDCOD91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8   * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,MEDCOD92
.
          MATCH     "00000000",PVIDATE   * bad debt
          GOTO      MEDCOD92 IF EQUAL
.                                           * I/P or O/P ?            *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          CALL      CLVISXDC                * Visit extra data
.
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          COMPARE   "2",PVITYPE
          GOTO      MEDCOD80 IF EQUAL
.                                   * inpatient processing *******
          MOVE      ADMISSNO,KEY8           * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,MEDCOD93
.
          MOVE      "004",KEY3              * AMHCC End class code
          PACK      KEY11,ADMISSNO,KEY3
          CALL      RDVSXDC1
          IF        OVRCD=0
            MATCH     SP70,VSXDTXT1
            IF        @EQUAL
              MOVE      "Manually Added",VSXDTXT1
            ENDIF
          ELSE
            PACK      VSXDDAT1,CCC,CYY,CMM,CDD
            REP       " 0",VSXDDAT1
          ENDIF
.
          MOVE      ADMISSNO,KEY8           * Read Discharge File
          MOVE      CURRDATE,DDATE          * default DDATE
          CALL      RDDSCH1
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          MOVE      ADMISSNO,KEY8           * Read Intensive Care Unit File
          CALL      RDPTICU1
.
MEDCOD80  MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLRVX100
          ENDIF    
.
          CALL      CLMRTPSH
.
          MOVE      ADMISSNO,KEY8   * Read 
          CALL      RDMRPDS1
          IF        OVRCD=1
            CALL      CLMRTPDS
            GOTO      MEDCOD82
          ENDIF    
.
          PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
          CALL      RDMRPSH1
          IF        OVRCD=1
            CALL      CLMRTPSH
          ENDIF
.
MEDCOD82  MOVE      ADMISSNO,KEY8             * check hold invoice
          CALL      RDIPEN1
          IF        OVRCD=1
            MOVE      SP70,PTIPRHLD           * Reason for Hold
            PACK      PTIPRDES,SP70,SP70      * Reason for Hold free text
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Medical Record Coding",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEDCOD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD89  MOVE      "Patient Admission Details Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD92  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD93  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD94  MOVE      "Coding Template Record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD95  MOVE      "Can't find patient Discharge Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD96  MOVE      "Can't enter more than 300 diagnosis codes.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD97  MOVE      "Can't enter more than 300 procedure codes.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD98  CLEAR     DIM150
          APPEND    "Can't enter more than a combined total of 200",DIM150
          APPEND    " diagnosis/procedure codes on the add screen. ",DIM150
          APPEND    "Please add remaining codes on the update screen.",DIM150
          CALL      WEBLER00
          MOVE      ONE,EXIT
          GOTO      MEDCOD99
.
MEDCOD99  RETURN
+
.------------------------------------------------------------
. Output Ling (DIM150) HTML Error File
.------------------------------------------------------------
WEBLER00  CALL      OPENHTML
          BRANCH    EXIT,WEBLER95
          BRANCH    FHIRTYPE,WEBLER10
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
 "  var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                    "  alert(#"",DIM150,"#");":
                    "  if (window.name.substr(0,4)=='Hide') {":
                    "    self.close();} else {":
                    "  if (PopUpScreen) {":
                    "    PopUpScreen.style.display='none'; } else {":
                    "    history.go(-1); }":
                    "}":
                    "</script>",012
.
          CALL      CLOSHTML     * End of Document
          GOTO      WEBLER99
.
. FHIR Error Response.
.
WEBLER10  CALL      FHRERR00
          GOTO      WEBLER99
.
WEBLER95  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
WEBLER99  RETURN
+
.*****************************************************************************
.*   CHLPYR00 - Check if leap year and additional day
.*****************************************************************************
CHLPYR00  IF        NOOFDAYS<>365
            GOTO      CHLPYR99
          ENDIF
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          CALL      DMLEAPYR
          IF        LEAPYR=1 
            IF        MM>2
.
.             Add extra day if current date is a leap year after february 
.
              ADD       ONE,NOOFDAYS   
            ENDIF
            GOTO      CHLPYR99
          ENDIF
          PACK      DFYEAR,CCENT,CYEAR
          REP       " 0",DFYEAR
          MOVE      DFYEAR,F4
          SUB       ONE,F4
          MOVE      F4,DFYEAR
          UNPACK    DFYEAR,DCC,DYY    * Previous year
          MOVE      DCC,CC
          MOVE      DYY,YY           
          CALL      DMLEAPYR
          IF        LEAPYR=1 
            IF        MM<=2
.
.             Add extra day if previous year is a leap year &
.             current date is before end of february
.
              ADD       ONE,NOOFDAYS 
            ENDIF
          ENDIF
.
CHLPYR99  RETURN
+
.*****************************************************************************
.  Resequence Morbidity Data Free Format File & patecdaf
.  Write Unique Counter to Disease file if records exist for this Admission
.*****************************************************************************
DISSQE00  MOVE      ZERO,COUNTER3
.....     CALL      DELMDD00  * Delete disease records from free format file
.
          MOVE      ZERO,COUNTER3
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECD1              * Episode disease file record
DISSQE10  CALL      RKPTECD1              * Episode disease file record
          BRANCH    OVRCD,DISSQE99
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      DISSQE99 IF NOT EQUAL * Different admin no
.         
          MOVE      PTEDUNQN,F3
          ADD       ONE,COUNTER3
          MOVE      COUNTER3,PTEDUNQN      * Write Unique Counter 
.
. * only update date/time of coding if sequence changes and sending edward
          COMPARE   F3,PTEDUNQN
          GOTO      DISSQE70 IF EQUAL
.
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      DISSQE70 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      DISSQE70 IF EQUAL
.
          CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS
          PACK      PTEDDTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEDDTCD            * Date of coding
          MOVE      CTIMEIS,PTEDTIME         * Time of coding
.
DISSQE70  CALL      UPPTECD1              * Update an eps dis coding file rec
.
          GOTO      DISSQE10             * Read Next Record          
.
DISSQE99  CALL      PTHCS000                                            *214276
          RETURN
.*****************************************************************************
.  Resequence Morbidity Data Free Format File & patecoaf
.  Write Unique Counter to Procedure file if records exist for this Admission
.*****************************************************************************
PROSQE00  MOVE      ZERO,COUNTER3
.....     CALL      DELMDP00  * Delete Procedure records from free format file
.
          MOVE      ZERO,COUNTER3
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECO1              * Episode Procedure File 
PROSQE10  CALL      RKPTECO1              * Episode Procedure File
          BRANCH    OVRCD,PROSQE99
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      PROSQE99 IF NOT EQUAL * Different admin no
.         
          ADD       ONE,COUNTER3
          MOVE      COUNTER3,PTEOUNQN      * Write Unique Counter 
.
          CALL      UPPTECO1              * Update an eps pro coding file rec
.
          GOTO      PROSQE10             * Read Next Record          
.
PROSQE99  CALL      PTHCS000                                           * 214276
          RETURN
.**********************************************************************
.  Clear VX1 DATA         
.**********************************************************************
CLRVX100  MOVE      SP70,PMVXIRAD 
          MOVE      SP70,PMVXCSNG 
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUVTH
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXCPDD
          MOVE      SP70,PMVXUDF5
          RETURN
.**********************************************************************
.  Clear PDS DATA         
.**********************************************************************
CLRPDS00  MOVE      SP70,MRPDSTAT 
          RETURN
.
.******************************************************************************
.*                                  PTHCS000              Called by: MEDCOD00 *
.*             ----- Update The Episode Morbidity Changes File -----          *
.******************************************************************************
.
PTHCS000  COMPARE   THREE,PTCNHDPS          * State Indicator - victoria
          GOTO      PTHCS050 IF EQUAL       * Not Using Morbidity Changes File
.
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      PTHCS999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      PTHCS999 IF EQUAL
.
PTHCS050  MOVE      SP1,CKYIDEF1            * 1st record flag - default
          UNPACK    CURRDATE,CKYIDEF6
.
          PACK      KEY18,ADMISSNO,EPSCD001,SP20
PTHCS100  CALL      RSPTECM1                * Position on & read an episode
PTHCS200  CALL      RKPTECM1                * morbidity changes file record
          BRANCH    OVRCD,PTHCS300
.
          MATCH     ADMISSNO,DPTEMADM
          GOTO      PTHCS300 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEMEPNO
          GOTO      PTHCS300 IF NOT EQUAL   * Different Episode no
.
          UNPACK    PTEMCDTE,KEY6
          MATCH     CKYIDEF6,KEY6
          GOTO      PTHCS200 IF NOT EQUAL   * Different change month
.
          PACK      KEY18,PTEMADMN,PTEMEPNO,PTEMCDTE
          CALL      DEPTECM1                * Delete an eps morb change file rec
          MOVE      ANSC,CKYIDEF1           * 1st record flag - changed
.
          GOTO      PTHCS100
.
PTHCS300  MOVE      ONE,FORM3
          PACK      KEY13,ADMISSNO,EPSCD001,FORM3,SP20                *C-240107
          CALL      RDPTECD1         * Read episode disease file record
          BRANCH    OVRCD,PTHCS400
.
          CALL      WTECM000         * Write a record of eps changes file
.
PTHCS400  MOVE      ONE,FORM3 
          PACK      KEY13,ADMISSNO,EPSCD001,FORM3,SP20                *C-240107
          CALL      RDPTECO1         * Read episode operation file record
          BRANCH    OVRCD,PTHCS999
.
          MOVE      PTEOADMN,PTEDADMN
          MOVE      PTEOEPNO,PTEDEPNO
          CALL      WTECM000        * Write a record of eps changes file
.
PTHCS999  RETURN
.******************************************************************************
.*                                  WTECM000              Called by: PTHCS000 *
.*                  Write A Record To The Episode Changes File                *
.******************************************************************************
WTECM000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE 
.
          PACK      KEY18,PTEDADMN,PTEDEPNO,CURRDATE
          CALL      RAPTECM1                * Read An Eps Morb Change File Rec
          COMPARE   ZERO,OVRCD
          GOTO      WTECM999 IF EQUAL       * Record already there
.
          MOVE      PTEDADMN,PTEMADMN
          MOVE      PTEDEPNO,PTEMEPNO
          MOVE      CURRDATE,PTEMCDTE
          MOVE      CKYIDEF1,PTEMNEWF
          PACK      PTEMSPAR,SP20
.
          PACK      KEY18,PTEMADMN,PTEMEPNO,PTEMCDTE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO        * Trap to stop I * D
          CALL      WRPTECM1              * Write an eps morb change file rec
          TRAPCLR   IO
          BRANCH    OVRCD,WTECM999
.
WTECM999  RETURN
.------------------------------------------------------------
.  Check Intention To Readmit
.------------------------------------------------------------
CHKINT00  COMPARE   THREE,PTCNHDPS
          GOTO      CHKINT99 IF NOT EQUAL
.
          MATCH     Z70,HRSICU06
          GOTO      CHKINT99 IF EQUAL   * Not on screen
. 
          MOVE      SP70,DISHDP 
.
          MATCH     SP70,HRSICU06
          GOTO      CHKINT98 IF EQUAL
          GOTO      CHKINT98 IF EOS
.
          PACK      KEY5,ANSV,ANSR,HRSICU06,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DIM1        * HDP for Intention To Readmit
          MOVE      ZERO,F1
          MOVE      DIM1,F1
.
          PACK      KEY5,ANSD,ANSD,DDEST,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DISHDP      * HDP for Discharge Destination
.
.         REP       "2131415161718191S1D1G1T2Z1C2N2A2H2K2B2R2",DISHDP 
.
          MATCH     SP70,DDATE
          IF        @EQUAL | @EOS
            REP       "S1D1T2Z1B2N2A2H2G1J2L2",DISHDP
          ELSE
            MATCH     "20030701",DDATE
            IF        @LESS
              REP       "2131415161718191D1T1Z1N2A2H2K2",DISHDP
            ELSE
              MATCH     "20190701",DDATE
              IF        @LESS
                REP       "S1D1T1Z1B2N2A2H2R2G1",DISHDP
              ELSE
                REP       "S1D1T2Z1B2N2A2H2G1J2L2",DISHDP
              ENDIF
            ENDIF
          ENDIF
.
          IF        F1=0
            MATCH     "1",DISHDP
            GOTO      CHKINT98 IF EQUAL
          ENDIF
.
          IF        F1>0 & F1<5 | F1=9
            MATCH     "2",DISHDP
            GOTO      CHKINT98 IF EQUAL
          ENDIF
.
CHKINT91  MOVE      "Error: Invalid Intention to Readmit for",CODERROR
          ENDSET    CODERROR 
          APPEND    " Discharge Destination.",CODERROR
          CALL      CODERR00 
          MOVE      ONE,EXIT
          GOTO      CHKINT99
.
CHKINT98  MOVE      ZERO,EXIT
CHKINT99  RETURN
.******************************************************************************
.*                                  CKEMR000              Called by: MEDCOD00 *
.*                   Check If An 'E' or 'M' Code Is Required                  *
.******************************************************************************
CKEMR000  MOVE      ZERO,CNCODCNT           * Reset the cancer code counter
          MOVE      ZERO,ECODECNT           * Reset the 'E' code counter
          MOVE      ZERO,ECREQCNT           * Reset the 'E' code required count
          MOVE      ZERO,MCODECNT           * Reset the 'M' code counter
          MOVE      SP9,CKYIDEF9
.
.                                           * PTCECODE (PTCN) Mandatory "E" Code
.                                           * edit - 0=No, 1=Yes
          MOVE      ONE,WRNFLAG             * default to "Warning"
          IF        PTCECODE = 1
            MOVE      ZERO,WRNFLAG          * set flag to "Error"
          ELSE
            MATCH     "1",MRCNECOD
            IF        @EQUAL
              MOVE      ZERO,WRNFLAG        * set flag to "Error"
            ENDIF
          ENDIF
.
. ----- Validate ICD10 Cancer Coding with Morphology -----
...        COMPARE   TWO,MRCNUCRG
...        GOTO      CKEMR200 IF NOT EQUAL  * Not using NZ cancer reg validation
.
          MOVE      ZERO,COUNT              * Array Counter
CKEMR050  ADD       ONE,COUNT               * Increment Array Counter
          IF        COUNT > LASTDIAG 
            GOTO      CKEMR100              * Output Error or Continue 
          ENDIF
.
          MATCH     SP70,DIACODES[COUNT]
          GOTO      CKEMR050 IF EQUAL       * Read next code if blank
.
          PACK      KEY9,DIACODES[COUNT],SP70
          CALL      RDPTICD1                * Read ICD10 disease file rec
          BRANCH    OVRCD,CKEMR050
          COMPARE   "1",ICDRDVER
          IF        @EQUAL
            MATCH     "999",PTCNDGPV        * allowing icd9 codes?
            IF        @EQUAL
              PACK      KEY9,DIACODES[COUNT],SP70
              CALL      RDPTCAN1
              BRANCH    OVRCD,CKEMR050      * not a Cancer code
              ADD       ONE,CNCODCNT        * Increment the cancer code counter
              ADD       ONE,MCODECNT        * only done to satisfy icd9 codes  
              GOTO      CKEMR050
            ENDIF
            GOTO      CKEMR050              * ICD9, skip this record
          ENDIF
.
          MATCH     "3",PT0DACRQ         * Cancer Code Requires Morphology Code
          IF        @EQUAL    
            ADD       ONE,CNCODCNT          * Increment the cancer code counter
          ENDIF
.
          MATCH     "4",PT0DACRQ            * Morpholgy Code
          IF        @EQUAL
            ADD       ONE,MCODECNT          * Increment the 'M' code counter
          ENDIF
.
          GOTO      CKEMR050
.
CKEMR100  IF        MCODECNT=0 & CNCODCNT=0
            GOTO      CKEMR200              * finish Cancer -Continue Processing
          ENDIF
.            
          IF        MCODECNT=0 & CNCODCNT<>0 
            CLEAR     WEBTITLE
            MOVE      "Error: Cancer code requires a Morphology Code!",WEBTITLE
            CALL      WEBERR00
            GOTO      CKEMR950
          ENDIF
          IF        CNCODCNT=0 & MCODECNT<>0 
            CLEAR     WEBTITLE
            MOVE      "Error: Morphology code requires a Cancer Code!",WEBTITLE
            CALL      WEBERR00
            GOTO      CKEMR950
          ENDIF
.
          GOTO      CKEMR200  * Here just in case if statments don't work!
.
. ----- Validate ICD10 External Cause codes -----
.
.
CKEMR200  MOVE      ZERO,COUNT              * Array Counter
          UNPACK    SP70,ICDREQ1,ICDREQ2,ICDREQ3,ICDREQ4,ICDREQ5
          UNPACK    SP70,ICDREQ6,ICDREQ7,ICDREQ8,ICDZ50C,ICDACTV,ICDPLAC
.
CKEMR210  ADD       ONE,COUNT               * Increment Array Counter
          COMPARE   COUNT,LASTDIAG
          GOTO      CKEMR500 IF LESS        * if finished reading all codes
.
          MATCH     SP70,DIACODES[COUNT]    * (left over from the past)
          GOTO      CKEMR210 IF EQUAL       * Read next code if blank

          MOVE      DIACODES[COUNT],KEY4
          MATCH     "Z50.",KEY4
          IF        @EQUAL
            MOVE      COUNT,SAVCOUNT
            MOVE      DIACODES[COUNT],ICDZ50C
.
.                         ????????
            MOVE      SAVCOUNT,COUNT
            GOTO      CKEMR210
          ENDIF
.
CKEMR300  COMPARE   "1",ICDRDVER
          GOTO      CKEMR210 IF EQUAL       * ICD9, skip this record
.
          PACK      KEY9,DIACODES[COUNT],SP70
          CALL      RDPTICD1                * Read an ICD10 disease file rec
          BRANCH    OVRCD,CKEMR210
.
          TYPE      PT0DACRQ                * Additional code requirement
          IF        @EQUAL
            MOVE      ZERO,F1
            MOVE      PT0DACRQ,F1
            STORE     DPCODE,F1,ICDREQ1,ICDREQ2,ICDREQ3,ICDREQ4,ICDREQ5:
                             ICDREQ6,ICDREQ7,ICDREQ8
.
.   *** PT0DACRQ values 6,7, and 8 are also External Cause Codes ****
.
            IF        F1>5 & F1<9
              PACK      ICDREQ2,DPCODE,SP70
            ENDIF
          ELSE
            MOVE      PT0DACRQ,KEY1         * Activity & Place codes
            REP       "A1P2",KEY1
            TYPE      KEY1
            IF        @EQUAL
              MOVE      KEY1,F1
              STORE     DPCODE,F1,ICDACTV,ICDPLAC
            ENDIF
          ENDIF
.
          GOTO      CKEMR210
.
.                                           * test requirement rules
CKEMR500  MOVE      ZERO,ICDERRDS
          CLEAR     CODERROR
          MOVE      "Error: ",CODERROR
          IF        WRNFLAG = 1
            MOVE      "Warning: ",CODERROR
          ENDIF
          ENDSET    CODERROR
.
CKEMR520  MATCH     SP9,ICDREQ1             * code requires External cause code
          GOTO      CKEMR530 IF EQUAL
          MATCH     SP9,ICDREQ2
          IF        @EQUAL
            APPEND    "\n",CODERROR
            SQUEEZE   ICDREQ1
            APPEND    ICDREQ1,CODERROR
            APPEND    "  An external cause code must be ",CODERROR
            APPEND    "included in the coding.",CODERROR
            MOVE      ONE,ICDERRDS
          ENDIF
.
CKEMR530  MATCH     SP9,ICDREQ6             * code requires a Place code
          GOTO      CKEMR540 IF EQUAL
          MATCH     SP9,ICDPLAC
          IF        @EQUAL
            APPEND    "\n",CODERROR
            SQUEEZE   ICDREQ6
            APPEND    ICDREQ6,CODERROR
            APPEND    "  Needs a Place code ",CODERROR
            MOVE      ONE,ICDERRDS
          ENDIF
.
CKEMR540  MATCH     SP9,ICDREQ8             * requires Activity & Place code
          GOTO      CKEMR550 IF EQUAL
          MATCH     SP9,ICDPLAC
          GOTO      CKEMR545 IF EQUAL
          MATCH     SP9,ICDACTV
          GOTO      CKEMR545 IF EQUAL
          GOTO      CKEMR550
.
CKEMR545  APPEND    "\n",CODERROR
          SQUEEZE   ICDREQ8
          APPEND    ICDREQ8,CODERROR
          APPEND    "  Needs an Activity & a Place code ",CODERROR
          MOVE      ONE,ICDERRDS
.
CKEMR550  COMPARE   ZERO,ICDERRDS
          GOTO      CKEMR900 IF EQUAL
.
          RESET     CODERROR
.                                       * Following call to CODOVR00 gives the
.                                       * option to continue, as is a warning!
          IF        WRNFLAG = 1
            CALL      CODOVR00          * Warning 
          ELSE
            CALL      CODERR00          * Fatal error
          ENDIF
          GOTO      CKEMR950
.
CKEMR900  MOVE      ZERO,EXIT
          GOTO      CKEMR999
.
CKEMR950  MOVE      ONE,EXIT
CKEMR999  RETURN
+
.**********************************************************************
.  Save Templated Diagnosis ICD Coding to Episode File
.**********************************************************************
GETDIS00  PACK      KEY8,MRTTD001,DISIND,SP70  * Check for Coding Template
          CALL      RSMRTDT1 
GETDIS10  CALL      RKMRTDT1 
          BRANCH    OVRCD,GETDIS99
.
          MATCH     MRTTD001,MRTDTMNO          * Match Template No 
          GOTO      GETDIS99 IF NOT EQUAL
.
          MATCH     DISIND,MRTDRECT            * Match Coding Type
          GOTO      GETDIS99 IF NOT EQUAL
.
          CALL      CODDIS00      * Save Diagnosis Coding Info
          GOTO      GETDIS10
.
GETDIS99  RETURN
.**********************************************************************
.  Save Templated Procedure ICD Coding to Episode File
.**********************************************************************
GETPRO00  PACK      KEY8,MRTTD001,PROIND,SP70  * Check for Coding Template
          CALL      RSMRTDT1 
GETPRO10  CALL      RKMRTDT1 
          BRANCH    OVRCD,GETPRO99
.
          MATCH     MRTTD001,MRTDTMNO          * Match Template No 
          GOTO      GETPRO99 IF NOT EQUAL
.
          MATCH     PROIND,MRTDRECT            * Match Coding Type
          GOTO      GETPRO99 IF NOT EQUAL
.
          CALL      CODPRO00      * Save Procedure Coding Info
          GOTO      GETPRO10
.
GETPRO99  RETURN
.-------------------------------------------------------------------------------
.                        ******* CODDIS00 ********                   
. ----- Save one record at a time to the medical records Diagnosis file ----
.-------------------------------------------------------------------------------
CODDIS00  IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF 
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECD1                 * Position on & read a patient
          CALL      RPPTECD1                 * episode disease file record
          BRANCH    OVRCD,CODDIS10
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      CODDIS10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      CODDIS20 IF EQUAL        * Same episode no
.
CODDIS10  MOVE      ZERO,PTEDCNT             * Reset the episode unique counter
.
CODDIS20  MOVE      ADMISSNO,PTEDADMN        * Admin no
          MOVE      EPSCD001,PTEDEPNO        * Epsiode no
          ADD       ONE,PTEDCNT              * Increment the episode unique cnt
          MOVE      MRTDDECD,PTEDCODE        * Diagnosis code
          MOVE      MRTDDEST,PTEDTYPE        * Diagnosis Prefix type
          MOVE      ZERO,PTEDUNQN            * Unique no
          PACK      PTEDDTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEDDTCD            * Date of coding 
          MOVE      CTIMEIS,PTEDTIME         * Time of coding
          MOVE      PASSCODE,PTEDOPER        * Operator
          MOVE      USERID,PTEDUSID          * Web User ID
          MOVE      SP70,PTEDACDT            * Diagnosis accident date
          MOVE      SP70,PTEDCCCL            * CCL Class Level
          MOVE      SP70,PTEDDRGD            * DRG Driver 0=Not Used 1=Used
          PACK      PTEDDESC,MRTDDESC,SP70   * Free Format Description
          MOVE      SP70,PTEDOSET            * Diagnosis onset type
.
          IF        PTCNHDPS>0
            MOVE      TWO,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      ONE,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
          ENDIF
.
          IF        PTCNHDPS=4
            MOVE      ONE,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      TWO,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
          ENDIF
.
          MOVE      SP70,PTEDCCFL
.
          MOVE      SP70,PTEDDCID              * Diagnosis cluster id
.  
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id & ICD10 ED 13
          GOTO      CODDIS50 IF NOT EQUAL
.
          MATCH     PTCNGDX3,DDATE   * disc.date > ICD10 ED 13 Go live?
          GOTO      CODDIS50 IF LESS
.
          MOVE      MRTDDCID,PTEDDCID          * Cluster id
.
          MATCH     SP70,PTEDDCID              * Cluster id populated
          GOTO      CODDIS50 IF NOT EQUAL
.
          MATCH     ANSU,PTEDCODE              * U prefix
          IF        @EQUAL
            UNPACK    PTEDCODE,D1,D2
            MOVE      ZERO,F2
            SQUEEZE   D2
            MOVE      D2,F2                   * U78 to U88 range
            IF        F2 >= 78 & F2 <=88
              MOVE      "0 ",PTEDDCID         * Assign chronic
              GOTO      CODDIS50
            ENDIF
          ENDIF
.
          MOVE      "8 ",PTEDDCID             * Assign unclusterd
.
CODDIS50  MOVE      SP70,PTEDSPAR
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1              * Write an eps dis coding file rec
            TRAPCLR   IO
          ENDIF
.
CODDIS99  RETURN
.-------------------------------------------------------------------------------
.                        ******* CODPRO00 ********                   
. -----  Save one record at a time to the medical records Procedure file ----
.-------------------------------------------------------------------------------
CODPRO00  IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF 
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECO1                 * Position on & read a patient
          CALL      RPPTECO1                   episode Procedure file record
          BRANCH    OVRCD,CODPRO10
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      CODPRO10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      CODPRO20 IF EQUAL        * Same episode no
.
CODPRO10  MOVE      ZERO,PTEOCNT             * Reset the episode unique counter
.
CODPRO20  MOVE      ADMISSNO,PTEOADMN        * Admin no
          MOVE      EPSCD001,PTEOEPNO        * Epsiode no
          ADD       ONE,PTEOCNT              * Increment the episode unique cnt
          MOVE      MRTDDECD,PTEOCODE        * Procedure code
          MOVE      MRTDDEST,PTEOTYPE        * Procedure Prefix type
          MOVE      ZERO,PTEOUNQN            * Unique no
          PACK      PTEODTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEODTCD            * Date of coding 
          MOVE      CTIMEIS,PTEOTIME         * Time of coding
          MOVE      PASSCODE,PTEOOPER        * Operator
          MOVE      USERID,PTEOUSID          * Web User ID
          MOVE      SP70,PTEODATE            * Procedure Date
          MOVE      SP70,PTEOSTTM            * Procedure Start Time
          MOVE      SP70,PTEOEDTM            * Procedure End Time
          MOVE      SP70,PTEODRGD            * DRG Driver
          PACK      PTEODESC,MRTDDESC,SP70   * Free Format Description
          MOVE      SP70,PTEOCLIN            * Procedure Clinician Code
          MOVE      SP70,PTEOCCFL            * Contract Care Flag
          MOVE      SP70,PTEOSPAR
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
            BRANCH    OVRCD,CODPRO99
          ENDIF
.
CODPRO99  RETURN
.******************************************************************************
.*                                  VDCB0000                                  *
.*                    Validate The Diagnosis Codes For Babies                 *
.*      INPUT REQUIRED: WEIGHT
.******************************************************************************
VDCB0000  MOVE      "  1000",FORM6 
          COMPARE   FORM6,WEIGHT   
          GOTO      VDCB9000 IF NOT LESS    * Weight >= 1000
.
VDCB1000  MOVE      ONE,COUNT
          WHILE     COUNT <= LASTDIAG
            MATCH     SP70,DIACODES[COUNT]
            IF        !@EQUAL
              PACK      KEY7,DIACODES[COUNT],SP70
              MATCH     "P07.0",KEY7 
              GOTO      VDCB9000 IF EQUAL       * Valid code
              MATCH     "P07.2",KEY7 
              GOTO      VDCB9000 IF EQUAL       * Valid code
              MATCH     "P05",KEY7 
              GOTO      VDCB9000 IF EQUAL       * Valid code
              MATCH     "P96.4",KEY7 
              GOTO      VDCB9000 IF EQUAL       * Valid code
              MATCH     "P01.8",KEY7 
              GOTO      VDCB9000 IF EQUAL       * Valid code
            ENDIF
            ADD      ONE,COUNT
          DO
.
          CLEAR     CODERROR
          MOVE      "Error: Admission weight < 1000 grams. ",CODERROR
          ENDSET    CODERROR
          APPEND    "Please add a code of either P07.0*, P07.2*,\n",CODERROR
          ENDSET    CODERROR
          APPEND    "P05*, P96.4 or P01.8",CODERROR
          ENDSET    CODERROR
          CALL      CODERR00
          MOVE      ONE,EXIT  
          GOTO      VDCB9999
.
VDCB9000  MOVE      ZERO,EXIT
VDCB9999  RETURN
.******************************************************************************
.*                                  AGEDIT00                                  *
.*                    Validate Diagnosis Specific Age Codes                   *
.******************************************************************************
AGEDIT00  MOVE      ONE,COUNT
.
          COMPARE   ONE,PSAGEYRS                                       *I-62290
          GOTO      AGEDIT90 IF LESS                                   *I-62290
          
          WHILE     COUNT <= LASTDIAG
            MATCH     SP70,DIACODES[COUNT]
            IF        !@EQUAL
              PACK      KEY10,PREFIXES[COUNT],DIACODES[COUNT],SP70
              MATCH     "PP07.0",KEY10
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "PP07.2",KEY10
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "PP05",KEY10
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "PP96.4",KEY10
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "PP01.8",KEY10
              GOTO      AGEDIT91 IF EQUAL       * Valid code
            ENDIF
            ADD      ONE,COUNT
          DO
.
          MOVE      ONE,COUNT  
          WHILE     COUNT <= LASTDIAG
            MATCH     SP70,DIACODES[COUNT]
            IF        !@EQUAL
              PACK      KEY7,DIACODES[COUNT],SP70
              MATCH     "P07.1",KEY7
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "P07.3",KEY7
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "P05",KEY7
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "P96.4",KEY7
              GOTO      AGEDIT91 IF EQUAL       * Valid code
              MATCH     "P01.8",KEY7
              GOTO      AGEDIT91 IF EQUAL       * Valid code
            ENDIF
            ADD      ONE,COUNT
          DO
.
          GOTO       AGEDIT90
. 
AGEDIT91  CLEAR     CODERROR
          MOVE      "Warning: Age Edit, Code - ",CODERROR
          ENDSET    CODERROR
          APPEND    DIACODES[COUNT],CODERROR 
          ENDSET    CODERROR
          APPEND    " can only be used for patients under 1 yr.",CODERROR
          ENDSET    CODERROR
          CALL      CODERR00
          MOVE      ONE,EXIT  
          GOTO      AGEDIT99
.
AGEDIT90  MOVE      ZERO,EXIT
AGEDIT99  RETURN
.-------------------------------------------------------------------------------
.                         ******* PRVDIS00 ********
.    Copy the previous discharge coding record for this patient?    
.    First read the visit file by UR and then check Discharge file for 
.    this admission
.-------------------------------------------------------------------------------
PRVDIS00  MOVE      ZERO,EXIT
          MOVE      ZERO,EPSNUMBR   
          MOVE      ADMISSNO,VISITNUM     * Visit no save variable
.
.         Read admission record and save the admission date for OPRCPY00
.
          PACK      VISITDAT,SP70
          PACK      DISCHDAT,SP70
          PACK      KEY8,ADMISSNO,SP70      * Read admission record
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ADATE,VISITDAT        * Save admission date
            IF        ASTAT=3
              CALL      RDDSCH1               * discharge record on file ?
              IF        OVRCD=0
                MOVE      DDATE,DISCHDAT      * Save discharged date
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RSPTVIS2
PRVDIS10  CALL      RPPTVIS2
          BRANCH    OVRCD,PRVDIS90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PRVDIS90 IF NOT EQUAL              
.
          MATCH     ADMISSNO,DPVIBILL  * Don't need this one read next   
          GOTO      PRVDIS10 IF EQUAL              
.
          COMPARE   THREE,PVITYPE      * Must be an Inpatient 
          GOTO      PRVDIS10 IF NOT EQUAL              
.
          PACK      KEY8,DPVIBILL,SP70 * Read Discharge File for a valid record
          CALL      RDADSCH1
          BRANCH    OVRCD,PRVDIS10     * Record not found read next visit
.
          PACK      KEY8,DPVIBILL,SP70 * Read Admission File for a valid record
          CALL      RDMISS1            * and check ACODDTE if blank?
          BRANCH    OVRCD,PRVDIS10     * Record not found read next visit
.  
.   Check for an existing episode with Coding for this patient
.
          MOVE      DPVIBILL,VISITNUM  * Set for GETEPS00 & Last Visit found 
          CALL      GETEPS00           * Get first existing episodes with Coding 
          MATCH     " 0",EPSNUMBR
          GOTO      PRVDIS10 IF EQUAL  * No Episode found for this Admission 
.
          MOVE      DPVIBILL,CPYADMNO  * Set copy from visit number
.
.  
.   Clear the current Episode we are copying to.
.
          CALL      DELLCK00  * Delete Diagnosis Lock Record if found  
          CALL      DELECD00  * Delete all records from Diagnosis Coding file
          CALL      DELECO00  * Delete all records from Procedure Coding file
          CALL      CLRCHC00  * clear "Date Episode Coding Complete" in PATCHCof
.  
.   Read and Copy the Previous Discharge Episode 
.
          PACK      SAVKEY13,VISITNUM,EPSNUMBR,SP70
          CALL      OPRCPY00  * Copy Procedures Episode File 
.
          PACK      SAVKEY13,VISITNUM,EPSNUMBR,SP70
          CALL      DISCPY00  * Copy Diagnosis Episode File 
.
          GOTO      PRVDIS99  
.
PRVDIS90  MOVE      "No Prevous Discharge Details Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVDIS99
.
PRVDIS99  RETURN
.-----------------------------------------------------------------
.   Read and Copy the Previous Discharge Episode - Procedures Episode File 
.-----------------------------------------------------------------
OPRCPY00  PACK      KEY13,SAVKEY13,SP70                               *C-240107
          CALL      RSPTECO1                * Position on & read a patient
          CALL      RKPTECO1                * episode operation file record
          BRANCH    OVRCD,OPRCPY99 
.
          MATCH     VISITNUM,DPTEOADM       * Admission not found
          GOTO      OPRCPY99 IF NOT EQUAL 
.
          MATCH     EPSNUMBR,DPTEOEPN       * Episode Not found
          GOTO      OPRCPY99 IF NOT EQUAL 
.
          PACK      SAVKEY13,DPTEOADM,DPTEOEPN,DPTEOCNT,SP70  * Save Key
.
          MOVE      ADMISSNO,PTEOADMN
          MOVE      EPSCD001,PTEOEPNO
.
          MOVE      SP70,PTEOCLIN           * Clear Opr Clinician code *I-240103
          MOVE      DISCHDAT,PTEODATE
          MATCH     "1",MRCNOPDT            * Default Operation Date with ADATE?
          IF        @EQUAL
            MOVE      VISITDAT,PTEODATE     * Copy saved admis date to Op Date
          ENDIF
          MATCH     "2",MRCNOPDT            * No def date
          IF        @EQUAL
            MOVE      SP70,PTEODATE         * Clear Operation date
          ENDIF
.
          MOVE      SP70,PTEOSTTM           * Clear Operation start time
          MOVE      SP70,PTEOEDTM           * Clear Operation end time
.
          CALL      IBACLOCK
          PACK      PTEODTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEODTCD            * Date of coding
          MOVE      CTIMEIS,PTEOTIME         * Time of coding
.
          MOVE      USERID,PTEOUSID          * Web User ID
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write record to destination
            TRAPCLR   IO
            BRANCH    OVRCD,OPRCPY99
          ENDIF
.
          GOTO      OPRCPY00
.
OPRCPY99  RETURN
.-----------------------------------------------------------------
.   Read and Copy the Previous Discharge Episode - Diagnosis Episode File 
.-----------------------------------------------------------------
DISCPY00  PACK      KEY13,SAVKEY13,SP70
          CALL      RSPTECD1                * Position on & read a patient
          CALL      RKPTECD1                * episode disease file record
          BRANCH    OVRCD,DISCPY99 
.
          MATCH     VISITNUM,DPTEDADM       * Admission not found
          GOTO      DISCPY99 IF NOT EQUAL 
.
          MATCH     EPSNUMBR,DPTEDEPN       * Episode Not found
          GOTO      DISCPY99 IF NOT EQUAL 
.
          PACK      SAVKEY13,DPTEDADM,DPTEDEPN,DPTEDCNT,SP70  * Save Key
.
          MOVE      ADMISSNO,PTEDADMN
          MOVE      EPSCD001,PTEDEPNO
.
          CALL      IBACLOCK
          PACK      PTEDDTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEDDTCD            * Date of coding
          MOVE      CTIMEIS,PTEDTIME         * Time of coding
.
          MOVE      USERID,PTEDUSID          * Web User ID
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1       * Write record to destination 
            TRAPCLR   IO
            BRANCH    OVRCD,DISCPY99
          ENDIF
.
          GOTO      DISCPY00
.
DISCPY99  RETURN
.-----------------------------------------------------------------
. Summary Record Coding
.-----------------------------------------------------------------
SUMCOD00  MATCH     SP70,UPDTTYPE
          GOTO      SUMCOD70 IF EQUAL
.
          MOVE      ADMISSNO,AADMNO
          MATCH     "A",UPDTTYPE    * Add Diagnosis/Procedure Coding      
          GOTO      SUMCOD10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update Diagnosis/Procedure Coding      
          GOTO      SUMCOD20 IF EQUAL
.
          MATCH     "L",UPDTTYPE    * Delete all Formaction               
          GOTO      SUMCOD30 IF EQUAL
.
          MATCH     "S",UPDTTYPE    * Swap Sequence        
          GOTO      SUMCOD40 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete Diagnosis/Procedure Coding      
          GOTO      SUMCOD50 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Check if Coding Complete               
          GOTO      SUMCOD60 IF EQUAL
.
          MATCH     "F",UPDTTYPE    * Coding Complete - Bypass Cancer Reg 
          GOTO      SUMCOD66 IF EQUAL
.
          MATCH     "I",UPDTTYPE    * Input DRG from screen
          GOTO      SUMCOD68 IF EQUAL
.
          GOTO      SUMCOD90
.
.         ************ ADD FORMACTION **********
. 
SUMCOD10  PACK      CHKCODE,DIOPC001,SP70
          CALL      CHICD000           * check if using icd9
          BRANCH    CODEFLAG,SUMCOD12,SUMCOD11
.                            disease  operat
.
SUMCOD11  CALL      SAVECO00    * Save Episode Procedure Coding
          BRANCH    EXIT,SUMCOD99
          CALL      PROSQE00    * Resequence Procedure Codes & MDS Data
          GOTO      SUMCOD15
.
SUMCOD12  CALL      SAVECD00    * Save Episode Diagnosis Coding
          BRANCH    EXIT,SUMCOD99
          CALL      DISSQE00    * Resequence Disease Codes & MDS Data
          CALL      GETCHSCR    * Automate calculate Charlson score
. 
SUMCOD15  CALL      SAVSNG00      * Save Coder Snag
          CALL      SAVPDS00      * Save Post Discharge Status
.
          MATCH     "1",MRCNRCDT  * is "Reset Coding Date" set ?
          IF        @EQUAL
            CALL      CLRACC00    * then set ACODDTE to blank
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.         ************ UPDATE FORMACTION **********
.
SUMCOD20  PACK      CHKCODE,DIOPC001,SP70
          CALL      CHICD000           * check if using icd9
          BRANCH    CODEFLAG,SUMCOD22,SUMCOD21
.                            disease  operat
.
SUMCOD21  CALL      UPDECO00    * Update Episode Procedure Coding
          GOTO      SUMCOD25
.
SUMCOD22  CALL      UPDECD00    * Update Episode Diagnosis Coding
          CALL      GETCHSCR    * Automate calculate Charlson score
.
SUMCOD25  CALL      SAVSNG00      * Save Coder Snag 
          CALL      SAVPDS00      * Save Post Discharge Status
.
          MATCH     "1",MRCNRCDT  * is "Reset Coding Date" set ?
          IF        @EQUAL
            CALL      CLRACC00    * then set ACODDTE to blank
          ENDIF
. 
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.         ************ DELETE ALL CODES FORMACTION **********
.
SUMCOD30  CALL      DELECD00  * Delete all records from Diagnosis Coding file
          CALL      GETCHSCR    * Automate calculate Charlson score
          CALL      DELMDD00  * Delete disease records from free format file
          CALL      DELECO00  * Delete all records from Procedure Coding file
          CALL      DELMDP00  * Delete Procedure records from free format file 
          CALL      DELGRP00  * Delete Grouper Detail Record
          CALL      CLRCHC00  * clear "Date Episode Coding Complete" in PATCHCof
          CALL      UPDDSC00  * Clear DRG Code on Discharge file
.
.    If at last episode for this admission, then set ACODDTE to blank.
.
          MOVE      ADMISSNO,VISITNUM  * Set for GETEPS00
          CALL      GETEPS00           * Get Episode No for Admission record
          MATCH     " 0",EPSNUMBR    
          GOTO      SUMCOD31 IF NOT EQUAL 
.
          CALL      CLRACC00      * No more episodes found set ACODDTE to blank
. 
SUMCOD31  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "01",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1                 * admission on file ?
          BRANCH    OVRCD,SUMCOD39          * no - shouldn't happen
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                 * patient on file ?
          BRANCH    OVRCD,SUMCOD39          * no - shouldn't happen
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                * pt. extension on file ?
          BRANCH    OVRCD,SUMCOD39          * no - shouldn't happen
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11                * visit extension on file ?
          BRANCH    OVRCD,SUMCOD39          * no - shouldn't happen
.
          MOVE      SP70,PMVXUDF5           * Clear Coding Delay Reason
          CALL      UPPMVX11
.
          CALL      CLPATDSC
          MOVE      CURRDATE,DDATE          * default DDATE
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1                 * discharge record on file ?
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          PACK      KEY30,AADMNO,ZED30
          CALL      RDSTRAN2                * position on admission number
          CALL      RDPTRAN2                * read previous transfer record
          BRANCH    OVRCD,SUMCOD39          * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      SUMCOD39 IF NOT EQUAL   * no - should happen
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI 
          MOVE      TWO,HL7TRGID   
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * trigger I/P visit update message
.
SUMCOD39  MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.         ************ SWAP FORMACTION **********
.
SUMCOD40  MATCH     "D",SETFUNCT
          IF        @EQUAL
            CALL      SWPDIS00    * Swap Diagnosis Codes 
            CALL      DISSQE00    * Resequence Disease Codes & MDS Data
          ELSE
            CALL      SWPOPR00    * Swap Procedure Codes
            CALL      PROSQE00    * Resequence Procedure Codes & MDS Data
          ENDIF
.
.    Run UNIX or PC Grouper Depending on PARAMETER
.
          COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "G",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE        * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE        * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
              MOVE      "U",UPDTTYPE
            ENDIF
          ENDIF
.
          MATCH     "1",MRCNRCDT            * is "Reset Coding Date" set ?
          IF        @EQUAL
            CALL      CLRACC00              * then set ACODDTE to blank
          ENDIF
.
          IF        EXIT=1
            MOVE      ZERO,NEXTPAGE            * Set for STRDIR00
            CALL      NXTPAG00
          ENDIF
          GOTO      SUMCOD99
.
.         ************ DELETE FORMACTION **********
.
SUMCOD50  PACK      CHKCODE,DIOPC001,SP70
          CALL      CHICD000           * check if using icd9
          BRANCH    CODEFLAG,SUMCOD52,SUMCOD51
.                            disease  operat
.
SUMCOD51  CALL      DLSECO00    * Delete Episode Procedure Coding
          GOTO      SUMCOD55
.
SUMCOD52  CALL      DLSECD00    * Delete Episode Diagnosis Coding
          CALL      GETCHSCR    * Automate calculate Charlson score
.
.    Check to see if you have any disease or operation codes if you do
.    Need to clear out the files.
.
SUMCOD55  CALL      CLRCD000      * Clear files if no Codes            *I-54558
.
.    If at last episode for this admission, then set ACODDTE to blank.
.
          MOVE      ADMISSNO,VISITNUM  * Set for GETEPS00
          CALL      GETEPS00           * Get Episode No for Admission record
          MATCH     " 0",EPSNUMBR    
          GOTO      SUMCOD57 IF NOT EQUAL 
          CALL      CLRACC00      * No more episodes found set ACODDTE to blank
          GOTO      SUMCOD59
.
SUMCOD57  MATCH     "1",MRCNRCDT            * is "Reset Coding Date" set ?
          IF        @EQUAL
            CALL      CLRACC00              * then set ACODDTE to blank
          ENDIF
.
SUMCOD59  MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.         ************ CODING COMPLETE FORMACTION **********
.
SUMCOD60  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,SUMCOD91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ELSE
            MATCH     SP70,RECRT002
            IF        !@EQUAL
              MATCH     RECRT002,PMPXRDAT
              IF        @LESS
                PACK      PMPXRPER,RECRT001,SP70
                PACK      PMPXRDAT,RECRT002,SP70
                CALL      UPPMPX21                    * update retention fields
              ENDIF
            ENDIF
          ENDIF
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          MOVE      ADMISSNO,KEY8   * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,SUMCOD92
.
          IF        PVITYPE = 2
            MOVE      "3",ASTAT
          ELSE
            MOVE      ADMISSNO,KEY8   * Read Discharge File
            CALL      RDDSCH1
            IF        OVRCD = 1
              IF        MRCNEPSC = 1
                CALL      CLPATDSC          * clear Discharge record
                MOVE      CURRDATE,DDATE
              ELSE
                GOTO      SUMCOD97          * issue error message
              ENDIF
            ENDIF
            MOVE      DDATE,ICDRDDTE  * Use Discharge Date for reading ICD files
          ENDIF
.
          CALL      CKDIAG00        * Must have a Diagnosis Code   
          BRANCH    EXIT,SUMCOD99  
.
          CALL      LODPRC00        * Load Procedure Code Array, as used in 
.                                   * following routines
.
          CALL      LODDIS00        * Load the Disease Code Array for following 
.                                   * Routines           
.
          IF        OVERRIDE<>1 
            CALL      CKEMR000      * Check for E & M Codes
            BRANCH    EXIT,SUMCOD99  
          ENDIF
.
          COMPARE   "2",PVITYPE         * check if Outpatient         *I-145686
          GOTO      SUMCOD62 IF EQUAL
.
.                                       * inpatient processing *******
SUMCOD61  PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,SUMCOD93
.
          MOVE      ADATE,AGEDATE       * Now using Admission Date
          CALL      CALCAGE             * Calculate age
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00            * Check if leap year
          IF        PSAGEDAY < NOOFDAYS
            MOVE      ABWGHT,WEIGHT     * Set input var for WGHTCK00 & VDCB0000
            CALL      WGHTCK00          * Patient Weight Edit check
            BRANCH    EXIT,SUMCOD99
            CALL      VDCB0000          * Validate the dis code for babies
            BRANCH    EXIT,SUMCOD99
          ELSE
...         CALL      AGEDIT00          * Validation for Age Edits
...         BRANCH    EXIT,SUMCOD99          
          ENDIF
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          CALL      SAVSNG00      * Save Coder Snag
          CALL      SAVPDS00      * Save Post Discharge Status
          CALL      PTHCS000      * Update Episode Morbidity Changes File
          CALL      SAVMVE00      * Move latest record to destination
          CALL      SAVODC00      * write patodcaf if required
          CALL      CHGNZ000      * update NMDS submission required
          CALL      UNDCID00      * Complete diagnosis clusrer id
.
SUMCOD62  MATCH     "2",MRCNEACA
          IF        @EQUAL
            MATCH     SP70,PTIPRHLD
            GOTO      SUMCO62A IF EQUAL
.
            MOVE      "rh",KEY2
            PACK      KEY5,KEY2,PTIPRHLD
            CALL      RDCODE1
            BRANCH    OVRCD,SUMCO62A
.
            MATCH     "C",TCINDC3
            GOTO      SUMCO62A IF NOT EQUAL
.
            MOVE      ADMISSNO,KEY8
            CALL      RAIPEN1
            BRANCH    OVRCD,SUMCO62A
            CALL      DEIPEN1       
          ENDIF
.
SUMCO62A  MATCH     "0",MRCNEACA
          GOTO      SUMCOD6A IF EQUAL
.
          MATCH     "1",MEDCD001          * Complete code 
          GOTO      SUMCOD6A IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,SUMCOD6A
.
          MOVE      ZERO,F1
          MATCH     SP70,PTIPRHLD          * Reason for hold (cat rh)
          GOTO      SUMCOD6A IF EQUAL
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,SUMCOD6A
.
          MATCH     "C",TCINDC3
          GOTO      SUMCOD6A IF NOT EQUAL
.
          MOVE      SP70,PTIPRHLD
          CALL      UPIPEN1
.
SUMCOD6A  MATCH     "1",MEDCD001          * Complete code
          GOTO      SUMCOD6B IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSP,PTECD008,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SUMCOD6B
.
          MATCH     "K",TCINDC2
          GOTO      SUMCOD6B IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMRPDS1
          IF        OVRCD=0
            MOVE      SP70,MRPDSTAT   * PDT Status
            MOVE      CURRDATE,MRPDDATE   * Date of Current Status
            CLOCK     TIME,MRPDTIME       * Time of Current Status
            CALL      UPMRPDS1
          ENDIF
.
..........................................................................
. Write to Audit Header mrtcahaf                                 
..........................................................................
SUMCOD6B  MATCH     "2",MRCNEACA          * if Coding Audit func is set
          GOTO      SUMCOD63 IF NOT EQUAL 
          COMPARE   ZERO,COAUFLAG         * if Coding Audit tables don't exist
          GOTO      SUMCOD63 IF EQUAL   
.
          CALL      GNDRG000              * Get Health Fund DRG
          MOVE      DRGCODHF,MRCHHDRG     * Health Fund DRG
          MOVE      DRGVERHF,MRCHHDGV     * Health Fund DRG Version
.
          CALL      GHDRG000              * Get National Drg Version
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERHS,MRCHDRGV     * National DRG Version
          ELSE
            MOVE      PTCNDGPV,MRCHDRGV     * National DRG Version
          ENDIF
          MOVE      DRGCODHS,MRCHNDRG     * National DRG
.
          CALL      IBACLOCK              * get current date/time
          MOVE      ADMISSNO,MRCHADMN     * Adm No 
          PACK      MRCHADAT,CCC,CYY,CMM,CDD
          REP       " 0",MRCHADAT         * Audit Date  
          MOVE      CTIMEIS,MRCHATIM      * Audit Time
.
          MOVE      USERID,MRCHWEBU       * User ID
.
          COMPARE   ZERO,PTPGWTOL
          IF        @EQUAL
            PACK      MRCHNWAU,NWAUZERO,SP70   * if blank make NWAU zero
          ELSE
            MOVE      SP70,KEY17
            MOVE      PTPGWTOL,KEY17
            SQUEEZE   KEY17
            PACK      MRCHNWAU,KEY17,SP70
          ENDIF
.
          CALL      SVIC0000               * set CODINGED
          PACK      MRCHICDV,ONE,ZERO,DOT,CODINGED  * ICD Version
.
. NOTE: ICD Version above is hard coded as ICD10. Will need to be manually
. changed when ICD11 is instated.
.
          MOVE      SP70,PTEDCODE
          MOVE      SP70,PTEOCODE
          PACK      KEY13,ADMISSNO,EPSCD001,SP1,SP1,ONE,SP70
          CALL      RDPTECD1
          MOVE      PTEDCODE,MRCHPDCD     * Primary Diagnosis Code
          PACK      KEY13,ADMISSNO,EPSCD001,SP1,SP1,ONE,SP70
          CALL      RDPTECO1
          MOVE      PTEOCODE,MRCHPPCD     * Primary Procedure Code
.
          PACK      KEY24,MRCHADMN,MRCHADAT,MRCHATIM,SP70
          CALL      RAMRCAH1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO      * Trap to stop I * D
            CALL      WRMRCAH1            * Write Audit Header mrtcahaf
            TRAPCLR   IO
          ENDIF
..........................................................................
. Write to Audit Details mrtcadaf from Diagnosis Code patecdaf
..........................................................................
          MOVE      ZERO,FORM3
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1              * read patecdaf Diagnosis file
SUMCOD6C  CALL      RKPTECD1
          BRANCH    OVRCD,SUMCOD6D
          MATCH     ADMISSNO,DPTEDADM
          GOTO      SUMCOD6D IF NOT EQUAL
.
          MOVE      DPTEDADM,MRCDADMN     * Admission Number
          MOVE      MRCHADAT,MRCDADAT     * Audit Date
          MOVE      MRCHATIM,MRCDATIM     * Audit Time
.
          MOVE      MRCDCNTR,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,MRCDCNTR        * Counter
.
          PACK      MRCDRTYP,ZERO,ONE,SP70   * Record Type "01" = Diagnosis
          MOVE      PTEDTYPE,MRCDPRFX     * Prefix
          MOVE      PTEDCODE,MRCDDCOD     * Diagnosis Code
          PACK      MRCDDDES,PTEDDESC,SP70 * Diagnosis Description
          MOVE      PTEDOSET,MRCDOFLG     * Onset Flag
          MOVE      SP70,MRCDPCOD         * Procedure Code (blank for Diag)
          MOVE      SP70,MRCDPDES         * Procedure Desc (blank for Diag)
          MOVE      SP70,MRCDODAT         * Operation Date (blank for Diag)
          MOVE      SP70,MRCDOSTM         * Op Start Time (blank for Diag)
          MOVE      SP70,MRCDOETM         * Op End Time (blank for Diag)
          MOVE      SP70,MRCDSURG         * Surgeon (blank for Diag)
          MOVE      PTEDDRGD,MRCDDRGD     * DRG Driver
.
          PACK      KEY27,MRCDADMN,MRCDADAT,MRCDATIM,MRCDCNTR,SP70
          CALL      RAMRCAD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO      * Trap to stop I * D
            CALL      WRMRCAD1            * Write Audit Detail mrtcahaf
            TRAPCLR   IO
          ENDIF
.
          GOTO      SUMCOD6C
.
..........................................................................
. Write to Audit Details mrtcadaf from Procedure Code patecoaf
..........................................................................
SUMCOD6D  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1                 * read patecoaf Procedure file
SUMCOD6E  CALL      RKPTECO1
          BRANCH    OVRCD,SUMCOD6F
          MATCH     ADMISSNO,DPTEOADM
          GOTO      SUMCOD6F IF NOT EQUAL
.
          MOVE      DPTEOADM,MRCDADMN        * Admission Number
          MOVE      MRCHADAT,MRCDADAT        * Audit Date
          MOVE      MRCHATIM,MRCDATIM        * Audit Time 
.
          MOVE      MRCDCNTR,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,MRCDCNTR           * Counter
.
          PACK      MRCDRTYP,ZERO,TWO,SP70   * Record Type "02" = Procedure
          MOVE      PTEOTYPE,MRCDPRFX        * Prefix
          MOVE      SP70,MRCDDCOD            * Diagnosis Code (blank for Proc)
          PACK      MRCDDDES,SP70            * Diagnosis Desc (blank for Proc)
          MOVE      SP70,MRCDOFLG            * Onset Flag (blank for Proc)
          MOVE      PTEOCODE,MRCDPCOD        * Procedure Code  
          PACK      MRCDPDES,PTEODESC,SP70   * Procedure Description
          MOVE      PTEODATE,MRCDODAT        * Operation Date   
          MOVE      PTEOSTTM,MRCDOSTM        * Operation Start Time
          MOVE      PTEOEDTM,MRCDOETM        * Operation End Time
          MOVE      PTEOCLIN,MRCDSURG        * Surgeon
          MOVE      PTEODRGD,MRCDDRGD        * DRG Driver
.
          PACK      KEY27,MRCDADMN,MRCDADAT,MRCDATIM,MRCDCNTR,SP70
          CALL      RAMRCAD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO      * Trap to stop I * D
            CALL      WRMRCAD1            * Write Audit Detail mrtcahaf
            TRAPCLR   IO
          ENDIF
.
          GOTO      SUMCOD6E
.
..........................................................................
. Write to Audit Details mrtcadaf for Claim Type               
..........................................................................
SUMCOD6F  CALL      CLRCAD00                   * clear Audit Detail fields
          MOVE      MRCHADMN,MRCDADMN          * Admission Number
          MOVE      MRCHADAT,MRCDADAT          * Audit Date
          MOVE      MRCHATIM,MRCDATIM          * Audit Time
.
          MOVE      MRCDCNTR,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,MRCDCNTR             * Counter
.
          PACK      MRCDRTYP,ZERO,THREE,SP70   * Record Type "03" = Claim Type
          PACK      MRCDDCOD,ACLAIM,SP70       * Diag Code / Claim Code
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,MRCDDDES
          ELSE
            PACK      MRCDDDES,TDESC,SP70      * Diag Desc / Claim Code Desc
          ENDIF
.
          PACK      KEY27,MRCDADMN,MRCDADAT,MRCDATIM,MRCDCNTR,SP70
          CALL      RAMRCAD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO      * Trap to stop I * D
            CALL      WRMRCAD1            * Write Audit Detail mrtcahaf
            TRAPCLR   IO
          ENDIF
.
..........................................................................
. Write to Audit Details mrtcadaf for Health Fund              
..........................................................................
SUMCOD6G  CALL      CLRCAD00                  * clear Audit Detail fields
          MOVE      MRCHADMN,MRCDADMN         * Admission Number
          MOVE      MRCHADAT,MRCDADAT         * Audit Date
          MOVE      MRCHATIM,MRCDATIM         * Audit Time 
.
          MOVE      MRCDCNTR,FORM3
          ADD       ONE,FORM3
          MOVE      FORM3,MRCDCNTR            * Counter
.
          PACK      MRCDRTYP,ZERO,FOUR,SP70   * Record Type "04" = Health Fund
          PACK      MRCDDCOD,PFUNDH,SP70      * Diag Code / Health Fund
.
          PACK      KEY14,PFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      SP70,MRCDDDES
          ELSE
            PACK      MRCDDDES,HFNAME,SP70    * Diag Desc / HF Desc
          ENDIF
.
          PACK      KEY27,MRCDADMN,MRCDADAT,MRCDATIM,MRCDCNTR,SP70
          CALL      RAMRCAD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO      * Trap to stop I * D
            CALL      WRMRCAD1            * Write Audit Detail mrtcahaf
            TRAPCLR   IO
          ENDIF
.
.
.   Initially CANCEROV is zero to allow CANCER00 to be called - if CANCER00
.   displays the "Cancer Dialog Box" a value will be set in CANCEROV for a
.   second pass thru the Server (and CANCER00 will be bypassed).
.
SUMCOD63  BRANCH    CANCEROV,SUMCOD66:      * Cancer Reg. "Cancel" clicked
                             SUMCOD64:      *             "Ok" clicked (Add)
                             SUMCOD65       *             "Ok" clicked (Updt)
.
          CALL      CANCER00      * Check for Cancer Coding and set redirect.
          BRANCH    EXIT,SUMCOD64:          * New cancers - no prev.registrat'ns
                         SUMCOD99           * went via CANCEROV
          GOTO      SUMCOD66                * No Cancer codes found
.
.                                           * redirect to Cancer Add screen
SUMCOD64  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "08",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.                                           * redirect to Cancer List screen
SUMCOD65  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "08",REPTNO             * Set for STRDIR00
          MOVE      "002",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
SUMCOD66  CALL      COMPLT00      * Check if Coding is Complete?
.
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
SUMCOD68  CALL      INDRG000      * Save drg input from screen
.
          MOVE      ZERO,EXIT
          GOTO      SUMCOD99
.
.   ************ DISPLAY: VALIDATE URNUMBER & VISIT NUMBER ************
.
SUMCOD70  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,SUMCOD91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8   * Read Visit File
          CALL      RDVISA1
          MOVE      PVIDATE,ADMISDTE   * Save Date
          BRANCH    OVRCD,SUMCOD92
.
          MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLRVX100
          ENDIF    
.
.          MOVE      ADMISSNO,KEY8   * Read 
.          CALL      RDMRPDS1
.          IF        OVRCD=1
.            CALL      CLRPDS00
.          ENDIF    
.
          CALL      CLMRTPSH
.
          MOVE      ADMISSNO,KEY8   * Read
          CALL      RDMRPDS1
          IF        OVRCD=1
            CALL      CLMRTPDS
            GOTO      SUMCOD71
          ENDIF
.
          PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
          CALL      RDMRPSH1
          IF        OVRCD=1
            CALL      CLMRTPSH
          ENDIF
.                                           * I/P or O/P ?            *I-145686
SUMCOD71  CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          COMPARE   "2",PVITYPE
          GOTO      SUMCOD80 IF EQUAL       * ouptatient
.
SUMCOD72  MOVE      ADMISSNO,KEY8           * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,SUMCOD93
.
          MOVE      ADMISSNO,KEY8           * Read Discharge File
          MOVE      CURRDATE,DDATE          * default date
          CALL      RDDSCH1 
          MOVE      DDATE,ICDRDDTE        * Use Discharge Date to read ICD files
.
.                                           * set Coding Period Dates - either
          CALL      CPDATS00                * Episode Coding or Admission Coding
.
          MOVE      ADMISSNO,KEY8   * Read Intensive Care Unit File
          CALL      RDPTICU1
.
SUMCOD80  IF        EPSCD001=ZERO
            MOVE      ONE,EPSCD001                                     *I-50640
          ENDIF
.
          MOVE      SP10,KEY3
          CALL      GTDRG000        * Get Grouper Version - returns it in KEY3
          MOVE      KEY3,DRGVERZ    * safer than KEY3                 *I-147943
.
.                                                                     *I-147943
.                                          * get patient's Health fund DRG Ver.
          UNPACK    SP30,PTHFGRPV,DRGVERHF,DRGCODHF
          MATCH     "1",PTCNDGED
          IF        @EQUAL
.
.           Determine DRG Version using NEW 'Effective DRG' table

            MATCH     SP6,AFUNDH
            IF        !@EQUAL
              CALL      GHFDRG00              * Get Health Fund DRG version
              IF        EXIT=0
                PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
                CALL      RDPTPGR1
                IF        OVRCD=0
                  MOVE      PTPGNDRG,DRGCODHF
                  MOVE      KEY3,DRGVERHF
                ENDIF
              ELSE
                PACK    KEY8,ADMISSNO,SP70
                CALL    RDDSCH1
                IF      OVRCD=0
                  MOVE    PTDSDDRG,DRGCODHF
                  MOVE    PTDSVOGU,DRGVERHF
                ENDIF
              ENDIF
            ELSE
              CALL      GCLDRG00            * Get Claim Code DRG version
              IF        EXIT=1
                CALL      GSTDRG00          * Get State/System DRG version
.               IF        EXIT=1
.                 MOVE      PTCNDGPV,KEY3   * Use System Default DRG instead
.               ENDIF
              ENDIF
.
              PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
              CALL      RDPTPGR1
              IF        OVRCD=0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      KEY3,DRGVERHF
              ENDIF
            ENDIF
.
          ELSE
.
.           Determine DRG Version (via Health Fund/Claim Code/System Default)
.
            MATCH     SP6,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
              CALL      RDFUND1       * Read a health fund file record
              PACK      KEY13,ADMISSNO,EPSCD001,PTHFGRPV,SP70
              CALL      RDPTPGR1             * Read Grouper Details
              IF        OVRCD = 0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      PTHFGRPV,DRGVERHF
              ELSE
                PACK    KEY8,ADMISSNO,SP70
                CALL    RDDSCH1
                IF      OVRCD = 0
                  MOVE    PTDSDDRG,DRGCODHF
                  MOVE    PTDSVOGU,DRGVERHF
                ENDIF          
              ENDIF
            ELSE
              PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      PTCNDGPV,KEY3
              ELSE
                MATCH     SP3,PTCDGRPV
                IF        @EQUAL
                  MOVE      PTCNDGPV,KEY3
                ELSE
                  MOVE      PTCDGRPV,KEY3
                ENDIF
              ENDIF
.
              PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
              CALL      RDPTPGR1
              IF        OVRCD=0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      KEY3,DRGVERHF
              ENDIF
            ENDIF
          ENDIF
.
.                                                                     *I-147943
.                                          * get Hospital default DRG Ver.
          UNPACK    SP30,PTHFGRPV,DRGVERHS,DRGCODHS
          MATCH     "1",PTCNDGED
          IF        @EQUAL
.
.           Determine DRG Version using NEW 'Effective DRG' table
.
            CALL      GSTDRG00              * Get State/System DRG version
.           IF        EXIT=1
.             MOVE     PTCNDGPV,KEY3        * Use System Default DRG instead
.           ENDIF
.
            PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
            CALL      RDPTPGR1
            IF        OVRCD=0
              MOVE      KEY3,DRGVERHS
              MOVE      PTPGNDRG,DRGCODHS
            ELSE
              PACK    KEY8,ADMISSNO,SP70
              CALL    RDDSCH1
              IF        OVRCD=0
                MOVE    PTDSVOGU,DRGVERHS
                MOVE    PTDSDDRG,DRGCODHS
              ENDIF
            ENDIF
.
          ELSE
.
.           Determine DRG Version (via Health Fund/Claim Code/System Default)
.
            PACK      KEY13,ADMISSNO,EPSCD001,PTCNDGPV,SP70
            CALL      RDPTPGR1               * Read Grouper Details
            IF        OVRCD = 0
              MOVE      PTCNDGPV,DRGVERHS
              MOVE      PTPGNDRG,DRGCODHS
            ELSE
              PACK    KEY8,ADMISSNO,SP70
              CALL    RDDSCH1
              IF      OVRCD = 0
                MOVE    PTDSVOGU,DRGVERHS
                MOVE    PTDSDDRG,DRGCODHS
              ENDIF          
            ENDIF
.
          ENDIF
.
.
.                                          * get Patient Grouper record
          PACK      KEY13,ADMISSNO,EPSCD001,DRGVERZ,SP70     * (KEY3 = DRGVERZ)
          CALL      RDPTPGR1   * Read Grouper Details
          IF        OVRCD=1
            PACK      KEY10,ADMISSNO,EPSCD001
            PACK      KEY13,KEY10,SP70 
            CALL      RSPTPGR1   * Read Grouper Details
            CALL      RKPTPGR1
            IF        OVRCD=0
              PACK      DIM10,PTPGADMN,PTPGEPNO
              MATCH     KEY10,DIM10
              GOTO      SUMCOD81 IF EQUAL
            ENDIF
            CALL      CLRGRP00
          ENDIF
          CALL      RHIHDAYS
.
SUMCOD81  MATCH     SP70,DIOPC001   * Not Displaying Update info for Codes
          GOTO      SUMCOD85 IF EQUAL
.
          PACK      CHKCODE,DIOPC001,SP70
          CALL      CHICD000           * check if using icd9
          BRANCH    CODEFLAG,SUMCOD83,SUMCOD82
.                            disease  operat
.
SUMCOD82  PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECO1
          BRANCH    OVRCD,CLRECO00   * Clear Episode Procedure Coding File
          GOTO      SUMCOD85
.
SUMCOD83  PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,CLRECD00   * Clear Episode Diagnosis Coding File

.                                           * set Coding Period Dates - either
SUMCOD85  CALL      CPDATS00                * Episode Coding or Admission Coding
.
          MOVE      ADMISSNO,KEY8           * check hold invoice
          CALL      RDIPEN1
          IF        OVRCD=1
            MOVE      SP70,PTIPRHLD           * Reason for Hold
            PACK      PTIPRDES,SP70,SP70      * Reason for Hold free text
          ENDIF
.
SUMCOD86  CLEAR     WEBTITLE
          MOVE      "Coding Summary",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SUMCOD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD92  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD93  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD94  MOVE      "Can't enter more than 99 diagnosis codes.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD95  MOVE      "Can't find Grouper Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD96  MOVE      "Can't find Intensive Care Unit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD97  MOVE      "Can't find patient Discharge Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUMCOD99
.
SUMCOD99  RETURN
.-------------------------------------------------------------------------------
.                        ****** INDRG000 ******
.                      Save drg input from screen
.-------------------------------------------------------------------------------
INDRG000  IF        ASTAT<>3
            GOTO      INDRG900
          ENDIF
.
          MATCH     INPUTDRG,Z70
          GOTO      INDRG900 IF EQUAL
.
          MOVE      "999",XDRGGRP           * default grouper version
.
          PACK      KEY4,INPUTDRG
          PACK      KEY7,KEY4,XDRGGRP,SP10  * latest DRG version      *I-137125
          CALL      RSPTDGW1
          CALL      RPPTDGW1
          BRANCH    OVRCD,INDRG900
.
          MATCH     PTDWDRGC,KEY4           * the same DRG code ?   *I-137125
          GOTO      INDRG900 IF NOT EQUAL                           *I-137125
.
          PACK      KEY13,AADMNO,EPSCD001,XDRGGRP,SP70
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,INDRG100
.
          CALL      SPGPV000         * Setup Patient Grouper Variables
          CALL      UPPTPGR1         * Update a patient grouper file rec
          GOTO      INDRG200
.
INDRG100  CALL      SPGPV000         * Setup Patient Grouper Variables
.
          MOVE      AADMNO,PTPGADMN    * Admission No
          MOVE      EPSCD001,PTPGEPNO  * Episode No
          MOVE      XDRGGRP,PTPGGPVR   * Grouper Version
.
          PACK      KEY13,PTPGADMN,PTPGEPNO,PTPGGPVR,SP70
          CALL      RAPTPGR1                * Read a patient grouper file record
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPTPGR1              * Write a patient grouper file rec
            TRAPCLR   IO
            BRANCH    OVRCD,INDRG999
          ENDIF
.
INDRG200  PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=0
            PACK      PTDSDMDC,PTDWMDCC,SP4    * MDC code
            PACK      PTDSDDRG,PTDWDRGC,SP4    * DRG code
.>>>>       MOVE      XDRGCCL,PTDSSIDX        * DRG severity index
            MOVE      XDRGGRP,PTDSVOGU        * Version of the grouper used
.
            CALL      UPDSCH1                 * Update a discharge file record
          ENDIF
.
          COMPARE   ZERO,AINVPRT
          CALL      PATGNFEE IF EQUAL       * Update rates if no invoice printed
.
INDRG900  MOVE      ZERO,EXIT
INDRG999  RETURN
+
.-------------------------------------------------------------------------------
.                        ****** SPGPV000 ******
.-------------------------------------------------------------------------------
SPGPV000  PACK      PTPGNDRG,PTDWDRGC,SP4  * National DRG
          PACK      PTPGNMDC,PTDWMDCC,SP4  * National MDC
          MOVE      ZERO,PTPGNWGT         * No value for National Weight
          MOVE      ZERO,PTPGNALS         * No value for National Avg LOS
.
          PACK      PTPGSDRG,PTDWDRGC,SP4  * State DRG
          PACK      PTPGSMDC,PTDWMDCC,SP4  * State MDC
          MOVE      ZERO,PTPGSWGT         * State Weight Set by WIES
          MOVE      ZERO,PTPGSALS         * No value for State Avg LOS
.
          PACK      PTPGLDRG,PTDWDRGC,SP4  * Local DRG
          PACK      PTPGLMDC,PTDWMDCC,SP4  * Local MDC
          MOVE      ZERO,PTPGLWGT         * No value for Local Weight
          MOVE      ZERO,PTPGLALS         * No value for Local LOS
.
.>>>>     MOVE      XDRGCCL,PTPGPCCL
          MOVE      ZERO,PTPGWFIX
          MOVE      ZERO,PTPGWVAR
          MOVE      ZERO,PTPGWTOL
          MOVE      ZERO,PTPGWWTU
          MOVE      SP20,PTPGWWTD
.
          MOVE      SP70,PTPGSPAR
SPGPV999  RETURN
+
.-------------------------------------------------------------------------------
.                        ****** CANCER00 ******
.-------------------------------------------------------------------------------
CANCER00  MOVE      ZERO,COUNT              * Array Counter
          MOVE      ZERO,F2
          MOVE      ZERO,NOOFCANC           * Cancer count for current Adm.
          MOVE      ZERO,UNRGCANC           * Unregistered Cancer count  
.
CANCER10  ADD       ONE,COUNT               * Increment Array Counter
          IF        COUNT > LASTDIAG
            GOTO      CANCER15
          ENDIF
.
          MATCH     SP70,DIACODES[COUNT]
          GOTO      CANCER10 IF EQUAL     * Read next code if this isblank
.
.   Check if there are any Cancer Codes entered.
.
          PACK      KEY9,DIACODES[COUNT],SP70
          CALL      RDPTCAN1
          BRANCH    OVRCD,CANCER10        * Cancer Code?
.
.                                                             * start *I-208570
.                                           * check that this Cancer code is not
.                                           * a Metastatic (secondary) cancer -
.                                           * range (C77.0 to C80.9 )
          PACK      KEY6,KEY9,SP5
          MATCH     METC770,KEY6
          IF        !@LESS
            MATCH     KEY6,METC7990                                   *C-237278
            GOTO      CANCER12 IF LESS
            GOTO      CANCER10
          ENDIF                                                 * end *I-208570
.
CANCER12  IF        F2 < 10
            ADD       ONE,F2              * save the Cancer Codes
            MOVE      KEY9,CANCODES[F2]
            ADD       ONE,NOOFCANC
          ENDIF
          GOTO      CANCER10
.
.   Check State - Qld reports previous Cancers even if no current Cancers
.
CANCER15  IF        NOOFCANC = 0 & PTCNHDPS <> 4
            GOTO      CANCER92              * No Cancer Coding Found  
          ENDIF
.
.    - now check Cancer Registration File
.
          PACK      KEY16,URNUMBER,ZED20    * read previous Cancers backwards
          CALL      RSPTCRG2
          CALL      RPPTCRG2
          BRANCH    OVRCD,CANCER91        
.
          MATCH     URNUMBER,PTCRURNO
          GOTO      CANCER91 IF NOT EQUAL
.
          CLEAR     WEBTITLE
          MOVE      "Cancer Registration/s exists for this ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "patient.",WEBTITLE
.
          MOVE      ZERO,F1
          PACK      KEY16,URNUMBER,ZED20
          CALL      RSPTCRG2
CANCER20  CALL      RPPTCRG2
          BRANCH    OVRCD,CANCER50        
.
          MATCH     URNUMBER,PTCRURNO
          GOTO      CANCER50 IF NOT EQUAL
.
          PACK      KEY25,DPTCRADN,Z70    * Read Cancer Reg Details File  
          CALL      RSPTCRD1
CANCER30  CALL      RPPTCRD1
          BRANCH    OVRCD,CANCER20        
.
          MATCH     DPTCRADN,DPTCDDAD     * Check Admission 
          GOTO      CANCER20 IF NOT EQUAL
.
          PACK      KEY8,DPTCRADN,SP10
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      PTCDADTE,ADATE
          ENDIF
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      DIM12,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,SP10
.
          ADD       ONE,F1
          COMPARE   SIX,F1   * Only want 5 previous Registraions 
          GOTO      CANCER50 IF EQUAL
          
          APPEND    "Adm Date:",CANCERDS[F1]
          APPEND    SP1,CANCERDS[F1]
          APPEND    DIM12,CANCERDS[F1]
          APPEND    "Adm No :",CANCERDS[F1]
          APPEND    SP1,CANCERDS[F1]
          APPEND    DPTCDDAD,CANCERDS[F1]
          APPEND    "  Reg No :",CANCERDS[F1]
          APPEND    PTCDCNRG,CANCERDS[F1]
          APPEND    "  Primary Site :",CANCERDS[F1]
          APPEND    SP1,CANCERDS[F1]
          APPEND    PTCDPRMM,CANCERDS[F1]
          APPEND    "  Hist Site :",CANCERDS[F1]
          APPEND    SP1,CANCERDS[F1]
          APPEND    PTCDHTYP,CANCERDS[F1]
.
          GOTO      CANCER30
...       GOTO      CANCER20                - was this but seems wrong
.
.   check if any of the current Cancers are registered for this Admission
.
CANCER50  MOVE      ZERO,F2                 * see if Cancers are registered 
          PACK      KEY25,ADMISSNO,SP30
          CALL      RSPTCRD1
CANCER52  CALL      RKPTCRD1
          BRANCH    OVRCD,CANCER54
          MATCH     ADMISSNO,DPTCDDAD
          GOTO      CANCER54 IF NOT EQUAL
.
          MOVE      ZERO,F2
          WHILE     F2 < NOOFCANC
            ADD       ONE,F2    
            MOVE      CANCODES[F2],KEY9
            MATCH     KEY9,PTCDPRMM
            IF        @EQUAL
              MOVE      SP10,CANCODES[F2]
              MOVE      "10",F2
            ENDIF
          DO
          GOTO      CANCER52
.
CANCER54  CLEAR     CANCERDS[10]            * check what's left
          MOVE      ZERO,UNRGCANC           * Unregistered Cancer count  
          MOVE      ZERO,F2
          WHILE     F2 < 10
            ADD       ONE,F2    
            MOVE      CANCODES[F2],KEY9
            MATCH     SP9,KEY9
            IF        !@EQUAL
              ADD       ONE,UNRGCANC        * count Unregistered Cancers
              STRIP     KEY9
              IF        UNRGCANC > 1
                APPEND    ", ",CANCERDS[10]
              ENDIF
              APPEND    KEY9,CANCERDS[10]
            ENDIF
          DO
.
          RESET     CANCERDS[10]
.
          IF        REPORTNO=8 & UNRGCANC = 0
            GOTO      CANCER92             * Posted from cancer reg maintenance
          ENDIF                            * so ignore existing registrations
.                                          * Message
          MATCH     SP70,CANCERDS[10]
          GOTO      CANCER90 IF EQUAL
.
CANCER60  CLEAR     CANCERDS[9]
          APPEND    "Codes : ",CANCERDS[9]
          APPEND    CANCERDS[10],CANCERDS[9]
          APPEND    " have not been registered for this Admission",CANCERDS[9]
          RESET     CANCERDS[9]
          PACK      CANCERDS[10],CANCERDS[9],SP70
.
CANCER90  CALL      CANOVR00    * HTML Override Confirm Message
          MOVE      TWO,EXIT    * Previous Registration Details Found
          GOTO      CANCER99 
.
CANCER91  IF        NOOFCANC = 0
            GOTO      CANCER92              * only happens if Queensland
          ENDIF
          MOVE      ONE,EXIT    * New cancers - no prev.registartions found
          GOTO      CANCER99 
.
CANCER92  MOVE      ZERO,EXIT   * No Cancer Coding Found
          GOTO      CANCER99 
.
CANCER99  RETURN
.-------------------------------------------------------------------------------
.                        ****** CLRGRP00 ******
.-------------------------------------------------------------------------------
CLRGRP00  MOVE      SP70,DPTPGADM   * Admission no
          MOVE      SP70,DPTPGEPN   * Episode no
          MOVE      SP70,PTPGGPVR   * Grouper version
          MOVE      SP70,PTPGNDRG   * National DRG
          MOVE      SP70,PTPGNMDC   * National MDC
          MOVE      ZERO,PTPGNWGT   * National weight
          MOVE      ZERO,PTPGNALS   * National average LOS
          MOVE      SP70,PTPGSDRG   * State DRG
          MOVE      SP70,PTPGSMDC   * State MDC
          MOVE      ZERO,PTPGSWGT   * State weight
          MOVE      ZERO,PTPGSALS   * State average LOS
          MOVE      SP70,PTPGLDRG   * Local DRG
          MOVE      SP70,PTPGLMDC   * Local MDC
          MOVE      ZERO,PTPGLWGT   * Local weight
          MOVE      ZERO,PTPGLALS   * Local average LOS
          MOVE      SP70,PTPGPCCL   * Patient CC class level
          MOVE      ZERO,PTPGWFIX   * WIES value fixed
          MOVE      ZERO,PTPGWVAR   * WIES value variable
          MOVE      ZERO,PTPGWTOL   * WIES value total
          MOVE      ZERO,PTPGWWTU   * WIES weight used
          MOVE      SP70,PTPGWWTD   * WIES weight description
          MOVE      SP70,PTPGECRW   * ECCS RAW Format
          MOVE      SP70,PTPGSPAR   * Spare variable
.
CLRGRP99  RETURN
.-------------------------------------------------------------------------------
.                        ****** CLRECO00 ******
.-------------------------------------------------------------------------------
CLRECO00  MOVE      SP70,DPTEOADM   * Admin no
          MOVE      SP70,DPTEOEPN   * Episode no
          MOVE      SP70,DPTEOCNT   * Episode unique counter
          MOVE      SP70,PTEOCODE   * Procedure code
          MOVE      SP70,PTEOTYPE   * Procedure type (O,I,N,X)
          MOVE      SP70,DPTEOUNQ   * Unique no/patmoprf record no
          MOVE      SP70,PTEODTCD   * Date of coding (ccyymmdd)
          MOVE      SP70,PTEOOPER   * Operator id
          MOVE      SP70,PTEODATE   * Procedure date (ccyymmdd)
          MOVE      SP70,PTEOSTTM   * Procedure start time
          MOVE      SP70,PTEOEDTM   * Procedure end time
          MOVE      SP70,PTEOTIME   * Coding Time
          MOVE      SP70,PTEODRGD   * DRG Driver
          MOVE      SP70,PTEOCLIN   * Procedure Clinician code 
          MOVE      SP70,PTEOCCFL   * Contract Care Flag
          MOVE      SP70,PTEOSPAR   * Spare variable
.
CLRECO99  RETURN
.-------------------------------------------------------------------------------
.                        ****** CLRECD00 ******
.-------------------------------------------------------------------------------
CLRECD00  MOVE      SP70,DPTEDADM   * Admin no
          MOVE      SP70,DPTEDEPN   * Episode no
          MOVE      SP70,DPTEDCNT   * Episode unique counter
          MOVE      SP70,PTEDCODE   * Diagnosis code
          MOVE      SP70,PTEDTYPE   * Diagnosis type (O,I,N,X)
          MOVE      SP70,DPTEDUNQ   * Unique no/patmoprf record no
          MOVE      SP70,PTEDDTCD   * Date of coding (ccyymmdd)
          MOVE      SP70,PTEDOPER   * Operator id
          MOVE      SP70,PTEDACDT   * Accident date (ccyymmdd)
          MOVE      SP70,PTEDTIME   * Coding Time
          MOVE      SP70,PTEDOSET   * Onset Type
          MOVE      SP70,PTEDCCFL   * Contract Care Flag
          MOVE      SP70,PTEDDCID   * Diagnosis cluster id
          MOVE      SP70,PTEDSPAR   * Spare variable
.
CLRECD99  RETURN
.-------------------------------------------------------------------------------
.                        ****** CLRDIS00 ******
.-------------------------------------------------------------------------------
CLRDIS00  MOVE     SP70,DURNO      * U.R No.
          MOVE     SP70,DDADMNO    *  ADMISSION NO.
          MOVE     SP70,DDATE      * PATIENT DIS. DATE (CCYYMMDD)
          MOVE     SP70,DTIME      * PATIENT DISCHARGE TIME
          MOVE     SP70,DSTAT      * DISCHARGE STATUS      (CAT D )
          MOVE     SP70,DDEST      * DISCHARGE DESTINATION (CAT DD)
          MOVE     SP70,DDIAG      * DISCHARGE DIAGNOSIS
          MOVE     SP70,DDIAG2     * DISCHARGE DIAGNOSIS (PART 2)
          MOVE     SP70,DUSD1      * USER DEFINED FIELD 1 (CAT D1)
          MOVE     SP70,DUSD2      * USER DEFINED FIELD 2 (CAT D2)
          MOVE     SP70,DUSD3      * USER DEFINED FIELD 3 (CAT D3)
          MOVE     SP70,DUSD4      * USER DEFINED FIELD 4 (CAT D4)
          MOVE     SP70,DUSD5      * USER DEFINED FIELD 5 (CAT D5)
          MOVE     SP70,DFMBS      * DISCHARGE DIAGNOSIS CODE
          MOVE     SP70,PTDSDMDC   * MDC code
          MOVE     SP70,PTDSDDRG   * DRG code
          MOVE     SP70,DWLREASN   * Reason Discharged Patient was
          MOVE     SP70,PTDSSIDX   * DRG severity index
          MOVE     SP70,PTDSVOGU   * Vers grouper used when grouping
          MOVE     SP70,PTDSOPER   * Operator who discharged patie
          MOVE     ZERO,PTDSUYN1   * User Defined Y/N Field 1
          MOVE     ZERO,PTDSUYN2   * User Defined Y/N Field 2
          MOVE     ZERO,PTDSUYN3   * User Defined Y/N Field 3
          MOVE     ZERO,PTDSUYN4   * User Defined Y/N Field 4
          MOVE     SP70,PTDSDWRD   * Discharge Ward
          MOVE     ZERO,PTDSDLOS   * Length of Stay
          MOVE     SP70,PTDSSREF   * Separation referral
          MOVE     SP70,DSPARE     * Spare
.
CLRDIS99  RETURN
.-------------------------------------------------------------------------------
.                        ******** CLRACC00 ********                   
. ----- Set ACODDTE VARIABLE to blank ----
.-------------------------------------------------------------------------------
CLRACC00  PACK      KEY8,ADMISSNO
          CALL      RLPTMIS1            * Read with lock
          BRANCH    OVRCD,CLRACC99      *                             *I-145686
.
          MOVE      SP70,ACODDTE        * Set Date to blank
          CALL      UPPTMIS1            * Update & unlock
          CALL      UUPTMIS1            * Read with lock
.
CLRACC99  RETURN
.
.                                                                      *I-54558
.****************************************************************************
.*                      ***** CLRCD000 *****
.*   Check to see if we have any disease or operation codes. If we dont
.*   Then clear out the files.
.****************************************************************************
CLRCD000  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1                * Position on & read a patient
CLRCD100  CALL      RKPTECD1                  episode disease file record
          BRANCH    OVRCD,CLRCD300
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      CLRCD300 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      CLRCD300 IF NOT EQUAL   * Different episode no
.
          GOTO      CLRCD999                * Disease code found, exit
.
CLRCD300  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1                * Position on & read a patient
          CALL      RKPTECO1                * episode operation file record
          BRANCH    OVRCD,CLRCD500
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      CLRCD500 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      CLRCD500 IF NOT EQUAL   * Different episode no
.
          GOTO      CLRCD999                * Op Code found, exit
.
.         If you reach here then there are no Disease and
.         Operation codes. Clear out the files.
.
CLRCD500  CALL      DELECD00  * Delete all records from Diagnosis Coding file
....ML    CALL      DELMDD00  * Delete disease records from free format file
          CALL      DELECO00  * Delete all records from Procedure Coding file
....ML    CALL      DELMDP00  * Delete Procedure records from free format file
          CALL      DELGRP00  * Delete Grouper Detail Record
          CALL      CLRCHC00  * Clear "Date Episode Coding Complete" field
          CALL      UPDDSC00  * Clear DRG Code on Discharge file
.
          MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "01",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
CLRCD999  RETURN
.
.****************************************************************************
.                       ***** LODDIS00 *****
.    Loads the Diagnosis Code array & Prefix array. Easier to create a 
.    Load array routine than to duplicate the code of functions used
.    REPORT 1 - MEDCOD00!!      
.****************************************************************************
LODDIS00  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1              
LODDIS10  CALL      RKPTECD1              
          BRANCH    OVRCD,LODDIS99
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      LODDIS99 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      LODDIS99 IF NOT EQUAL    * Different episode no
.
.  Uses unique code counter PTEDCNT as array counter
.
          PACK      DIACODES[PTEDCNT],PTEDCODE,SP70   * Diagnosis Code
          PACK      PREFIXES[PTEDCNT],PTEDTYPE        * Diagnosis Prefix
          MOVE      PTEDCNT,LASTDIAG         * Set Array Index Counter 
.
          GOTO      LODDIS10
.
LODDIS99  RETURN
.****************************************************************************
.                       ***** LODPRC00 *****
.    Loads the Procedure Code array & Prefix array. Easier to create a 
.    Load array routine than to duplicate the code of functions used
.    REPORT 1 - MEDCOD00!!      
.****************************************************************************
LODPRC00  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1              
LODPRC10  CALL      RKPTECO1              
          BRANCH    OVRCD,LODPRC99
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      LODPRC99 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      LODPRC99 IF NOT EQUAL    * Different episode no
.
.  Uses unique code counter PTEOCNT as array counter
.
          PACK      PROCODES[PTEOCNT],PTEOCODE,SP70   * Procedure Code
          PACK      PREFIXES[PTEOCNT],PTEOTYPE        * Procedure Prefix
          MOVE      PTEOCNT,LASTPROC                  * Set Array Index Counter 
.
          GOTO      LODPRC10
.
LODPRC99  RETURN
.****************************************************************************
.                   ***** CKDIAG00 *****
.    If Coding Complete flag is checked then must have a Diagnois Code
.****************************************************************************
CKDIAG00  MATCH     SP70,MEDCD001 * Coding Complete Flag? 
          GOTO      CKDIAG98 IF EQUAL
.
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,CKDIAG20
.
          MATCH     ADMISSNO,DPTEDADM       * Admission No.
          GOTO      CKDIAG20 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTEDEPNO       * Episode No.
          GOTO      CKDIAG20 IF NOT EQUAL
.
          GOTO      CKDIAG98
.
CKDIAG20  MOVE      "Error: Must have a Diagnosis Code!",WEBTITLE
          PACK      WEBTITLE,WEBTITLE,SP1,EPSCD001 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDIAG99

CKDIAG98  MOVE      ZERO,EXIT
CKDIAG99  RETURN
.------------------------------------------------------------
.                   ***** COMPLT00 *****
.    Check if Coding is Complete              
.------------------------------------------------------------
COMPLT00  IF        MRCNEPSC = 1
            CALL      EPCMPL00          * if using Episodic Coding do not write
            COMPARE   THREE,ASTAT       * Admission ACODDTE until discharge
            GOTO      COMPLT70 IF NOT EQUAL * Upd Episode Coding "patchcof" recd
          ENDIF
.
COMPLT60  MATCH     SP70,MEDCD001 * Coding Complete Flag?
          IF        @EQUAL 
            CALL      CLRACC00    * Clear Accodate Coding Incomplete
          ELSE
            CALL      SETACC00    * Set ACODDTE in Coding Complete
          ENDIF
.
.         Send HL7 A08 based on "Coding Complete change" parameter (TSK 0930147)
          MATCH     "1",PTCNCODC
          IF        @EQUAL
            CALL      BVISUP00          * Broadcast HL7 A08
          ENDIF
.
COMPLT70  CALL      CHKDIS00      * Check this patient for anymore discharges
.
COMPLT99  RETURN
.-------------------------------------------------------------------------------
.                        ******** SETACC00 ********                   
. ----- Set ACODDTE VARIABLE to current date ----
.-------------------------------------------------------------------------------
.
SETACC00  PACK      KEY8,ADMISSNO
          CALL      RLPTMIS1            * Read with lock
          BRANCH    OVRCD,SETACC99                                    *I-145686
.
          PACK      ACODDTE,CCC,CYY,CMM,CDD
          REP       " 0",ACODDTE        * Date Coding Completed
          CALL      UPPTMIS1            * Update & unlock
          CALL      UUPTMIS1            * Read with lock
.
.
. For WA, patecmaf is used to store acoddte changes (VIC uses it differently)
          COMPARE   SIX,PTCNHDPS
          GOTO      SETACC99 IF NOT EQUAL
.
          CALL      WAECM000             * write to patecmaf
.
SETACC99  RETURN
.
.-------------------------------------------------------------------------------
.                         ******* WAECM000 ********
.    Store acoddte for use by WA Extract
.-------------------------------------------------------------------------------
WAECM000  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY18,ADMISSNO,SP1,ONE,CURRDATE,SP70
          CALL      RAPTECM1                * Read An Eps Morb Change File Rec
          COMPARE   ZERO,OVRCD
          GOTO      WAECM999 IF EQUAL       * Record already there
.
          MOVE      ADMISSNO,PTEMADMN
          MOVE      ONE,PTEMEPNO
          MOVE      CURRDATE,PTEMCDTE
          MOVE      SP70,PTEMNEWF
          PACK      PTEMSPAR,SP20
.
          PACK      KEY18,PTEMADMN,PTEMEPNO,PTEMCDTE,SP70
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO        * Trap to stop I * D
          CALL      WRPTECM1              * Write an eps morb change file rec
          TRAPCLR   IO
          BRANCH    OVRCD,WAECM999
.
WAECM999  RETURN
+
.-------------------------------------------------------------------------------
.                         ******* EBCMPL00 ********
.    Set Episode Complete Date in "patchcof" record
.-------------------------------------------------------------------------------
EPCMPL00  MOVE      EPSCD001,KEY2
          PACK      KEY26,ADMISSNO,EPSCD001,SP30
          CALL      RDSCHCO2
EPCMPL10  CALL      RDKCHCO2
          BRANCH    OVRCD,EPCMPL99
.
          MATCH     ADMISSNO,DCHADMN
          GOTO      EPCMPL99 IF NOT EQUAL
.
          MATCH     KEY2,CHEPISNO
          GOTO      EPCMPL10 IF NOT EQUAL
.
          MOVE      WBSEPCD,CHUPUSID
          PACK      CHUPDATE,CURRDATE
          MOVE      CTIMEIS,CHUPTIME
          MATCH     SP70,MEDCD001           * Coding Complete Flag?
          IF        @EQUAL 
            MOVE      SP8,CHCODCMP
          ELSE
            MOVE      CURRDATE,CHCODCMP
          ENDIF
          CALL      UPCHCO2
.
EPCMPL99  RETURN
.-------------------------------------------------------------------------------
.                         ******* CHKDIS00 ********
.    Check if there are any more discharge records for this patient?       
.    First read the visit file by UR and then check Discharge file for 
.    this admission, if valid check ACODDTE is blank then continue...
.    If using episode coding is turned on also include current admissions
.-------------------------------------------------------------------------------
CHKDIS00  MOVE      ZERO,EPSNUMBR   
          MOVE      ADMISSNO,VISITNUM
.
          PACK      SCANDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCANDATE                * Scan one years visits
          MOVE      365,F3
          SUB       F3,SCANDATE
.
          PACK      KEY24,URNUMBER,SCANDATE,SP70
          CALL      RSPTVIS2
CHKDIS10  CALL      RKPTVIS2
          BRANCH    OVRCD,CHKDIS90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      CHKDIS90 IF NOT EQUAL              
.
          COMPARE   THREE,PVITYPE    
          GOTO      CHKDIS10 IF NOT EQUAL              
.
          IF        IBCNMHOS=1
            PACK      KEY8,DPVIBILL,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,CHKDIS10
.
            MATCH     "1",MRCNCCOD               * Using centralise coding
            IF        @EQUAL
              PACK      KEY13,USERID,SP70             * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70  * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CHKDIS10
              ENDIF
            ELSE
              MATCH     PMVXMHOS,WBSEHOSP        * Not using centralised coding
              GOTO      CHKDIS10 IF NOT EQUAL    * so only select visits from
            ENDIF                                * users current hosital
          ENDIF
.
          IF        MRCNEPSC<>1
            MATCH     VISITNUM,DPVIBILL * Skip the admission you have just coded
            GOTO      CHKDIS10 IF EQUAL    
          ENDIF
.
          PACK      KEY8,DPVIBILL,SP70 * Read Discharge File for a valid record
          CALL      RDADSCH1
          IF        OVRCD=1
            IF        MRCNEPSC=1
              CALL     CLPATDSC           * Clear discharge fields
            ELSE
              GOTO     CHKDIS10           * No discharge found read next visit
            ENDIF
          ENDIF
.
          PACK      KEY8,DPVIBILL,SP70 * Read Admission File for a valid record
          CALL      RDMISS1            * and check ACODDTE if blank?
          BRANCH    OVRCD,CHKDIS10     * Record not found read next visit
.
          MATCH     SP70,ACODDTE       * If blank then contiue..
          GOTO      CHKDIS10 IF NOT EQUAL 
.
          IF        MRCNEPSC=1
             IF      ASTAT<>2 & ASTAT<>3
               GOTO    CHKDIS10          * Must be current adm or discharged
             ENDIF                       * if using episode coding
             CALL      NEPS0000          * Get next uncoded epsiode EPSCD001
             BRANCH    EXIT,CHKDIS10
          ELSE
             MOVE      DPVIBILL,LASTVIST   * Set for CHKEPS00
             CALL      CHKEPS00
          ENDIF
.
          IF        EPSFLAG=1
            MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
            MOVE      "01",REPTNO             * Set for STRDIR00
            MOVE      "001",TEMPLATE          * Set for STRDIR00
            MOVE      DPVIBILL,ADMISSNO       * Set for STRDIR00
          ELSE                                                         * C274911
            MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00       * C274911
            MOVE      "03",REPTNO             * Set for STRDIR00       * C274911
            MOVE      "001",TEMPLATE          * Set for STRDIR00       * C274911
            MOVE      DPVIBILL,ADMISSNO       * Set for STRDIR00       * C274911
          ENDIF                                                        * C274911
.
          IF        MRCNEPSC<>1
            MOVE      ONE,EPSCD001          * Set for STRDIR00 - default to 1
          ENDIF
.
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00 
          GOTO      CHKDIS99  
.
CHKDIS90  READ      CONTROLF,HUND18;*83,PTCNDSAC
          MATCH     "1",PTCNDSAC
          IF        @EQUAL
            MATCH     "1",MEDCD001
            IF        @EQUAL
              MOVE      "cliweb06.pbl?",SERVER  * Set for STRDIR00
              MOVE      "09",REPTNO             * Set for STRDIR00
              MOVE      "001",TEMPLATE          * Set for STRDIR00
              MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
              CALL      STRDIR00
              GOTO      CHKDIS99
            ENDIF
          ENDIF
.
          MATCH     "1",UCDSCHRG
          IF        @EQUAL
            MOVE      "patweb86.pbl?",SERVER  * Set for STRDIR00
          ELSE
            MOVE      "patweb98.pbl?",SERVER  * Set for STRDIR00
          ENDIF
.
          MOVE      "02",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00 
.
CHKDIS99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVECD00 ********                   
. ----- Save Episode Diagnosis Coding ----
.-------------------------------------------------------------------------------
SAVECD00  IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF 
.         
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECD1                 * Position on & read a patient
          CALL      RPPTECD1                 * episode disease file record
          BRANCH    OVRCD,SAVECD10
.         
          MATCH     ADMISSNO,DPTEDADM
          GOTO      SAVECD10 IF NOT EQUAL    * Different admin no
.         
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      SAVECD20 IF EQUAL        * Same episode no
.
SAVECD10  MOVE      ZERO,PTEDCNT             * Reset the episode unique counter
.
SAVECD20  MOVE      ADMISSNO,PTEDADMN        * Admin no
          MOVE      EPSCD001,PTEDEPNO        * Epsiode no
.
          MOVE      ZERO,FORM3                                        *C-240107
          MOVE      PTEDCNT,FORM3             * move episode count to temp form3
          ADD       ONE,FORM3                 * increment count
.
          IF        FORM3>300
            MOVE      "Can't enter more than 300 diagnosis codes.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      SAVECD99
          ENDIF
.
          COMPARE   ONE,FORM3                 * is it first record?
          GOTO      SAVECD30 IF EQUAL
.
          MATCH     CMDISP,DSPREFIX
          GOTO      SAVECD30 IF NOT EQUAL
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,SP70
          CALL      RSPTECD1
SAVECD25  CALL      RKPTECD1
          BRANCH    OVRCD,SAVECD30
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      SAVECD30 IF NOT EQUAL
.
          MATCH     DSPREFIX,PTEDTYPE
          IF        @EQUAL
            IF        PTCNHDPS=1
              GOTO      SAVECD90        * we have multiple primary prefix
            ELSE
              GOTO      SAVECD25
            ENDIF
          ELSE
            GOTO      SAVECD25          * continue search
          ENDIF
.
SAVECD30  MOVE      ADMISSNO,PTEDADMN
          MOVE      EPSCD001,PTEDEPNO
          MOVE      FORM3,KEY3                                        *C-240107
          PACK      KEY13,PTEDADMN,PTEDEPNO,KEY3                      *C-240107
          CALL      RDPTECD1
          IF        OVRCD=1
SAVECD35    MOVE      KEY3,PTEDCNT                                    *C-240107
            MOVE      DIOPC001,PTEDCODE        * Diagnosis code
            MOVE      DSPREFIX,PTEDTYPE        * Diagnosis type
            MOVE      ZERO,PTEDUNQN            * Unique no
            PACK      PTEDDTCD,CCC,CYY,CMM,CDD
            REP       " 0",PTEDDTCD            * Date of coding
            MOVE      CTIMEIS,PTEDTIME         * Time of coding
            MOVE      PASSCODE,PTEDOPER        * Operator
            MOVE      USERID,PTEDUSID          * Web User ID
            MOVE      PTECD004,PTEDACDT        * Diagnosis accident date
            MOVE      SP70,PTEDCCCL            * CCL Class Level
            MOVE      SP70,PTEDDRGD            * DRG Driver 0=Not Used 1=Used
            MOVE      DIOPC002,PTEDDESC        * Free Format Description
            MOVE      DIOPC003,PTEDOSET        * Diagnosit onset type
            MOVE      DIOPC004,PTEDCCFL        * Contract care flag
            MOVE      SP70,PTEDDCID            * Diagnosis cluster id
            MOVE      SP70,PTEDSPAR
.
            PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
            CALL      RAPTECD1
            IF        OVRCD=1
              MOVE      ZERO,OVRCD
              TRAP      OVERCOND IF IO        * Trap to stop I * D
              CALL      WRPTECD1              * Write an eps dis coding file rec
              TRAPCLR   IO
              BRANCH    OVRCD,SAVECD99
            ENDIF
          ENDIF
          GOTO      SAVECD99
.
SAVECD90  CLEAR     WEBTITLE
          MOVE      "Please use other Prefix Indicator as this is a Primary Field. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
SAVECD99  RETURN
.
.-------------------------------------------------------------------------------
.                        ******* SAVECO00 ********                   
. ----- Save Episode Procedure Coding ----
.-------------------------------------------------------------------------------
SAVECO00  MOVE      ZERO,EXIT
.
          IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF 
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECO1                 * Position on & read a patient
          CALL      RPPTECO1                 * episode Procedure file record
          BRANCH    OVRCD,SAVECO10
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      SAVECO10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      SAVECO20 IF EQUAL        * Same episode no
.
SAVECO10  MOVE      ZERO,PTEOCNT             * Reset the episode unique counter
.
SAVECO20  MOVE      ADMISSNO,PTEOADMN        * Admin no
          MOVE      EPSCD001,PTEOEPNO        * Epsiode no
          ADD       ONE,PTEOCNT              * Increment the episode unique cnt
          COMPARE   ZERO,PTEOCNT
          GOTO      SAVECO90 IF EQUAL
.
          IF        PTEOCNT>300
            MOVE      "Can't enter more than 300 procedure codes.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      SAVECO99
          ENDIF
.
          MOVE      DIOPC001,PTEOCODE        * Procedure code
          MOVE      DSPREFIX,PTEOTYPE        * Procedure type
          MOVE      ZERO,PTEOUNQN             * Unique no
          PACK      PTEODTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEODTCD            * Date of coding
          MOVE      CTIMEIS,PTEOTIME         * Time of coding
          MOVE      PASSCODE,PTEOOPER        * Operator
          MOVE      USERID,PTEOUSID          * Web User ID
          MOVE      PTECD004,PTEODATE        * Procedure Date
          MOVE      PTECD005,PTEOSTTM        * Procedure Start Time
          MOVE      PTECD006,PTEOEDTM        * Procedure End Time
          MOVE      SP70,PTEODRGD            * DRG Driver
          MOVE      DIOPC002,PTEODESC        * Free Format Description
          MOVE      DIOPC004,PTEOCCFL        * Contract care flag
          MOVE      PTECD009,PTEOCLIN        * Procedure Clinician    *I-240103
          MOVE      SP70,PTEOSPAR
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
            BRANCH    OVRCD,SAVECO90
          ENDIF
          GOTO      SAVECO99
.
SAVECO90  MOVE      ONE,EXIT
.
SAVECO99  RETURN
.-------------------------------------------------------------------------------
.                        ******* UPDECD00 ********                   
. ----- Update Diagnosis Coding record ----
.-------------------------------------------------------------------------------
UPDECD00  PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECD1              * Episode disease file record
          BRANCH    OVRCD,UPDECD99
.
          MOVE      DSPREFIX,PTEDTYPE     * Diagnosis Prefix
          PACK      PTEDDTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEDDTCD         * Date of coding
          MOVE      CTIMEIS,PTEDTIME      * Time of coding
.
UPDECD20  MOVE      PASSCODE,PTEDOPER     * Operator
          MOVE      USERID,PTEDUSID       * Web User ID
          MOVE      PTECD004,PTEDACDT     * Diagnosis accident date
          MOVE      DIOPC002,PTEDDESC     * Free Format Description
          MOVE      DIOPC003,PTEDOSET     * Diagnosit onset type 
          MOVE      DIOPC004,PTEDCCFL     * Contract care flag
.
          CALL      UPPTECD1              * Update an eps dis coding file rec
          CALL      PTHCS000 *214276
.
UPDECD99  RETURN
.-------------------------------------------------------------------------------
.                        ******* UPDECO00 ********                   
. ----- Update Procedure Coding record ----
.-------------------------------------------------------------------------------
UPDECO00  PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECO1              * Read with Lock 
          BRANCH    OVRCD,UPDECO99
.
. ***  don't update the coding date for hospitals reporting to EDWARD
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      UPDECO10 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      UPDECO10 IF EQUAL
.
          GOTO      UPDECO20
.
UPDECO10  PACK      PTEODTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEODTCD         * Date of coding
          MOVE      CTIMEIS,PTEOTIME      * Time of coding
.
UPDECO20  MOVE      PASSCODE,PTEOOPER     * Operator
          MOVE      DSPREFIX,PTEOTYPE     * Operation Prefix  
          MOVE      USERID,PTEOUSID       * Web User ID
          MOVE      PTECD004,PTEODATE     * Procedure Date
          MOVE      PTECD005,PTEOSTTM     * Procedure Start Time
          MOVE      PTECD006,PTEOEDTM     * Procedure End Time
          MOVE      DIOPC002,PTEODESC     * Free Format Description
          MOVE      DIOPC004,PTEOCCFL     * Contract care flag
          MOVE      PTECD009,PTEOCLIN     * Procedure Clinician       *I-240103
          MOVE      SP70,PTEOSPAR
.
          CALL      UPPTECO1              * Update an eps Pro coding file rec
          CALL      PTHCS000                                            *214276
.
UPDECO99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DLSECD00 ********                   
. ----- Delete Diagnosis Coding record and Resequence codes ----
.-------------------------------------------------------------------------------
DLSECD00  PACK      SAVKEY13,ADMISSNO,PTECD002,PTECD003,SP70 
          PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECD1              * Read record    
          BRANCH    OVRCD,DLSECD99
.
....ML    PACK      KEY11,ONE,PTEDADMN,PTEDUNQN,SP70
....ML    CALL      RDAMDSA1              * Read a free format desc file rec
....ML    BRANCH    OVRCD,DLSECD10
....ML    CALL      DEMDSA1               * Delete free format desc file rec
.
DLSECD10  PACK      KEY13,SAVKEY13
          CALL      DEPTECD1              * Delete Record 
.
          CALL      RSPTECD1              * Position on next
          CALL      RKPTECD1  
          BRANCH    OVRCD,DLSECD99
.
          MATCH     ADMISSNO,DPTEDADM    * Match on Admission No. 
          GOTO      DLSECD99 IF NOT EQUAL
.
          MATCH     PTECD002,DPTEDEPN    * Match on Episode No.
          GOTO      DLSECD99 IF NOT EQUAL
.
.. added for task 0886371 edward
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      DLSECD50 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      DLSECD50 IF EQUAL
.
          PACK      PTEDDTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEDDTCD            * Date of coding
          MOVE      CTIMEIS,PTEDTIME         * Time of coding
          MOVE      PASSCODE,PTEDOPER        * Operator
          MOVE      USERID,PTEDUSID          * Web User ID
.end 0886371
DLSECD50  PACK      SAVKEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          SUB       ONE,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
            BRANCH    OVRCD,DLSECD99
          ENDIF
.
          GOTO      DLSECD10 
.
DLSECD99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DLSECO00 ********                   
. ----- Delete Procedure Coding record and Resequnce codes ---
.-------------------------------------------------------------------------------
DLSECO00  PACK      SAVKEY13,ADMISSNO,PTECD002,PTECD003,SP70
          PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECO1              * Read record    
          BRANCH    OVRCD,DLSECO99
.
....ML    PACK      KEY11,TWO,PTEOADMN,PTEOUNQN,SP70       
....ML    CALL      RDAMDSA1              * Read a free format desc file rec
....ML    BRANCH    OVRCD,DLSECO10
....ML    CALL      DEMDSA1               * Delete free format desc file rec
.
DLSECO10  PACK      KEY13,SAVKEY13
          CALL      DEPTECO1              * Delete Record 
.
          CALL      RSPTECO1              * Position on next
          CALL      RKPTECO1  
          BRANCH    OVRCD,DLSECO99
.
          MATCH     ADMISSNO,DPTEOADM    * Match on Admission No. 
          GOTO      DLSECO99 IF NOT EQUAL
.
          MATCH     PTECD002,DPTEOEPN    * Match on Episode No.
          GOTO      DLSECO99 IF NOT EQUAL
.
          PACK      SAVKEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          SUB       ONE,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
            BRANCH    OVRCD,DLSECO99
          ENDIF
          GOTO      DLSECO10 
.
DLSECO99  RETURN
.---------------------------------------------------------------------
.         Swap Function for Diagnosis Codes                   
.---------------------------------------------------------------------
SWPDIS00  MATCH     "S",MOVESWAP
          GOTO      SWAPDI00 IF EQUAL
.
          MATCH     "R",MOVESWAP  * Re sequence all diagnosis codes
          IF        @EQUAL
            CALL      SORTDI00
            GOTO      SWPDIS99
          ENDIF
.
          MOVE      NEWSEQNC,F3                                       *C-240107
          MOVE      PTECD003,ECODECNT
.
          IF        F3 > ECODECNT
            GOTO      STRLDI00    * Set Diagnosis sequence from start to end
          ELSE
            GOTO      ENDLDI00    * Set Diagnosis sequence from end to start
          ENDIF
.
SWPDIS99  RETURN
.---------------------------------------------------------------------
.         Repositions Diagnosis sequence from start to end
.---------------------------------------------------------------------
STRLDI00  PACK      SAVKEY13,PTECD001,PTECD002,PTECD003,SP70
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECD1
          MOVE      MAXARRY,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
          MOVE      SAVKEY13,KEY13
          CALL      DEPTECD1

          PACK      KEY13,SAVKEY13,SP70
          CALL      RSPTECD1
STRLDI10  CALL      RKPTECD1
          BRANCH    OVRCD,STRLDI99
.
          MATCH     DPTEDADM,PTECD001
          GOTO      STRLDI99 IF NOT EQUAL
.
          MATCH     DPTEDEPN,PTECD002
          GOTO      STRLDI99 IF NOT EQUAL
.
          MATCH     DPTEDCNT,NEWSEQNC
          GOTO      STRLDI20 IF NOT EQUAL
.
          SUB       ONE,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,NEWSEQNC,SP70
          CALL      DEPTECD1
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,MAXARRY,SP70
          CALL      RDPTECD1
.
          MOVE      NEWSEQNC,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,MAXARRY,SP70              *C-240107
          CALL      DEPTECD1
          GOTO      STRLDI99
.
STRLDI20  MOVE      PTEDCNT,KEY3                                      *C-240107
          SUB       ONE,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,KEY3,SP70
          CALL      DEPTECD1
          GOTO      STRLDI10
.
STRLDI99  RETURN
.---------------------------------------------------------------------
.         Repositions Diagnosis sequence in template from end to start
.---------------------------------------------------------------------
ENDLDI00  PACK      SAVKEY13,PTECD001,PTECD002,PTECD003,SP70
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECD1
          MOVE      MAXARRY,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          MOVE      SAVKEY13,KEY13
          CALL      DEPTECD1
.
          PACK      KEY13,SAVKEY13,Z70
ENDLDI10  CALL      RSPTECD1                          * CAR 287776
          CALL      RPPTECD1
          BRANCH    OVRCD,ENDLDI99
.
          MATCH     DPTEDADM,PTECD001
          GOTO      ENDLDI99 IF NOT EQUAL
.
          MATCH     DPTEDEPN,PTECD002
          GOTO      ENDLDI99 IF NOT EQUAL
.
          MATCH     DPTEDCNT,NEWSEQNC
          GOTO      ENDLDI20 IF NOT EQUAL
.
          ADD       ONE,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,NEWSEQNC,SP70
          CALL      DEPTECD1
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,MAXARRY,SP70
          CALL      RDPTECD1
          MOVE      NEWSEQNC,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,MAXARRY,SP70
          CALL      DEPTECD1
          GOTO      ENDLDI99
.          
ENDLDI20  MOVE      PTEDCNT,KEY3                                      *C-240107
          ADD       ONE,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,KEY3,SP70
          CALL      DEPTECD1
          GOTO      ENDLDI10
.
ENDLDI99  RETURN
.---------------------------------------------------------------------
.        Re sequence all diagnosis codes in the list
.---------------------------------------------------------------------
SORTDI00  MOVE      SP70,AVAILSEQ           * Clear available sequence numbers
.
SORTDI05  MOVE      ZERO,COUNT
SORTDI10  ADD       ONE,COUNT             
          IF        COUNT > SQDCOUNT
            GOTO      SORTDI99              * Checked all diagnosis codes
          ENDIF
.         
          UNPACK    SEQDIAGN[COUNT],PTECD001,PTECD002,PTECD003,NEWSEQNC
.
          MATCH     PTECD003,NEWSEQNC       * Sequence not changed or sequence
          GOTO      SORTDI10 IF EQUAL       * update has been processed so skip
.
          MATCH     SP70,AVAILSEQ           * Any sequence numbers available
          GOTO      SORTDI20 IF NOT EQUAL   * to use
.
          PACK      KEY13,PTECD001,PTECD002,MAXARRY,SP70
          CALL      RDPTECD1                * Make sure temp sequence is maximum
          COMPARE   ONE,OVRCD               * is not there
          GOTO      SORTDI99 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,SORTDI99
.
          MOVE      PTEDCNT,AVAILSEQ        * New available sequence number 
          MOVE      MAXARRY,PTEDCNT         * Move to temp maximum sequence 
.
          CALL      UPPTECD1
          PACK      SEQDIAGN[COUNT],PTECD001,PTECD002,MAXARRY,NEWSEQNC
.
SORTDI20  MOVE      ZERO,COUNT
.
SORTDI21  ADD       ONE,COUNT          * Look for record moving to free sequence
          IF        COUNT > SQDCOUNT
            GOTO      SORTDI99         * Checked all diagnosis codes
          ENDIF
.
          UNPACK    SEQDIAGN[COUNT],PTECD001,PTECD002,PTECD003,NEWSEQNC
.
          MATCH     AVAILSEQ,NEWSEQNC  * Find record moving to free sequence  
          GOTO      SORTDI21 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,AVAILSEQ,SP70
          CALL      RDPTECD1
          COMPARE   ONE,OVRCD          * Make sure available sequence is free
          GOTO      SORTDI99 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,SORTDI99
.
          MOVE      AVAILSEQ,PTEDCNT   * Move to New free sequence number
.
          MATCH     MAXARRY,PTECD003                                  *C-240107
          IF        @EQUAL
            MOVE      SP70,AVAILSEQ         * No free sequence number 
          ELSE
            MOVE      PTECD003,AVAILSEQ     * Set next free sequence number
          ENDIF
.
          CALL      UPPTECD1
          PACK      SEQDIAGN[COUNT],PTEDADMN,PTEDEPNO,PTEDCNT,NEWSEQNC
.
          GOTO      SORTDI05
.
SORTDI99  RETURN
.---------------------------------------------------------------------
.        Re sequence all procedure codes in the list
.---------------------------------------------------------------------
SORTOP00  MOVE      SP70,AVAILSEQ           * Clear available sequence numbers
.
SORTOP05  MOVE      ZERO,COUNT
SORTOP10  ADD       ONE,COUNT
          IF        COUNT > SQOCOUNT
            GOTO      SORTOP99              * Checked all procedure codes
          ENDIF
.
          UNPACK    SEQOPRAT[COUNT],PTECD001,PTECD002,PTECD003,NEWSEQNC
.
          MATCH     PTECD003,NEWSEQNC       * Sequence not changed or sequence
          GOTO      SORTOP10 IF EQUAL       * update has been processed so skip
.
          MATCH     SP70,AVAILSEQ           * Any sequence numbers available
          GOTO      SORTOP20 IF NOT EQUAL   * to use
.
          PACK      KEY13,PTECD001,PTECD002,MAXARRY,SP70
          CALL      RDPTECO1                * Make sure temp sequence is last 
          COMPARE   ONE,OVRCD               * is not there
          GOTO      SORTOP99 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECO1
          BRANCH    OVRCD,SORTOP99
.
          MOVE      PTEOCNT,AVAILSEQ        * New available sequence number
          MOVE      MAXARRY,PTEOCNT         * Move to last temp sequence
.
          CALL      UPPTECO1
          PACK      SEQOPRAT[COUNT],PTECD001,PTECD002,MAXARRY,NEWSEQNC
.
SORTOP20  MOVE      ZERO,COUNT
.
SORTOP21  ADD       ONE,COUNT          * Look for record moving to free sequence
          IF        COUNT > SQOCOUNT
            GOTO      SORTOP99         * Checked all procedure codes
          ENDIF
.
          UNPACK    SEQOPRAT[COUNT],PTECD001,PTECD002,PTECD003,NEWSEQNC
.
          MATCH     AVAILSEQ,NEWSEQNC  * Find record moving to free sequence
          GOTO      SORTOP21 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,AVAILSEQ,SP70
          CALL      RDPTECO1
          COMPARE   ONE,OVRCD          * Make sure available sequence is free
          GOTO      SORTOP99 IF NOT EQUAL
.
          PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECO1
          BRANCH    OVRCD,SORTOP99
.
          MOVE      AVAILSEQ,PTEOCNT        * Move to New free sequence number
.
          MATCH     MAXARRY,PTECD003                                  *C-240107
          IF        @EQUAL
            MOVE      SP70,AVAILSEQ         * No free sequence number
          ELSE
            MOVE      PTECD003,AVAILSEQ     * Set next free sequence number
          ENDIF
.
          CALL      UPPTECO1
          PACK      SEQOPRAT[COUNT],PTEOADMN,PTEOEPNO,PTEOCNT,NEWSEQNC
.
          GOTO      SORTOP05
.
SORTOP99  RETURN
.---------------------------------------------------------------------
.         Swap Diagnosis sequence in list
.---------------------------------------------------------------------
SWAPDI00  PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECD1                * read first record
          CALL      DEPTECD1                * delete first record
          MOVE      MAXARRY,PTEDCNT
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1              * write first record to MAXARRY
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTECD001,PTECD002,NEWSEQNC,SP70
          CALL      RDPTECD1                * read second record
          CALL      DEPTECD1                * delete second record
.
          MOVE      PTECD003,PTEDCNT        * insert first record's Count
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1              * write second record to first rec.
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTECD001,PTECD002,MAXARRY,SP70
          CALL      RDPTECD1                * read first record from MAXARRY
          CALL      DEPTECD1                * delete the temp first record
.
          MOVE      NEWSEQNC,PTEDCNT        * insert second rec's count to first
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RAPTECD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECD1              * write first record to second rec.
            TRAPCLR   IO
          ENDIF
.
SWAPDI99  RETURN
.---------------------------------------------------------------------
.         Swap Function for Procedure Codes                   
.---------------------------------------------------------------------
SWPOPR00  MATCH     "S",MOVESWAP
          GOTO      SWAPOP00 IF EQUAL
.
          MATCH     "R",MOVESWAP            * Re sequence all procedure codes
          IF        @EQUAL
            CALL      SORTOP00
            GOTO      SWPOPR99
          ENDIF
.
          MOVE      NEWSEQNC,F3
          MOVE      PTECD003,ECODECNT
.
          IF        F3 > ECODECNT
            GOTO      STRLOP00    * Set Procedure sequence from start to end
          ELSE
            GOTO      ENDLOP00    * Set Procedure sequence from end to start
          ENDIF
.
SWPOPR99  RETURN
.---------------------------------------------------------------------
.         Repositions Procedure sequence from start to end
.---------------------------------------------------------------------
STRLOP00  PACK      SAVKEY13,PTECD001,PTECD002,PTECD003,SP70
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECO1
.
          MOVE      MAXARRY,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
          MOVE      SAVKEY13,KEY13
          CALL      DEPTECO1

          PACK      KEY13,SAVKEY13,SP70
          CALL      RSPTECO1
STRLOP10  CALL      RKPTECO1
          BRANCH    OVRCD,STRLOP99
.
          MATCH     DPTEOADM,PTECD001
          GOTO      STRLOP99 IF NOT EQUAL
.
          MATCH     DPTEOEPN,PTECD002
          GOTO      STRLOP99 IF NOT EQUAL
.
          MATCH     DPTEOCNT,NEWSEQNC
          GOTO      STRLOP20 IF NOT EQUAL
.
          SUB       ONE,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,NEWSEQNC,SP70
          CALL      DEPTECO1
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,MAXARRY,SP70
          CALL      RDPTECO1
.
          MOVE      NEWSEQNC,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,MAXARRY,SP70
          CALL      DEPTECO1
          GOTO      STRLOP99
.
STRLOP20  MOVE      PTEOCNT,KEY3
          SUB       ONE,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,KEY3,SP70
          CALL      DEPTECO1
          GOTO      STRLOP10
.
STRLOP99  RETURN
.---------------------------------------------------------------------
.         Repositions Procedure sequence in template from end to start
.---------------------------------------------------------------------
ENDLOP00  PACK      SAVKEY13,PTECD001,PTECD002,PTECD003,SP70
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECO1
          MOVE      MAXARRY,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
          MOVE      SAVKEY13,KEY13
          CALL      DEPTECO1
.
          PACK      KEY13,SAVKEY13,Z70
ENDLOP10  CALL      RSPTECO1
          CALL      RPPTECO1
          BRANCH    OVRCD,ENDLOP99
.
          MATCH     DPTEOADM,PTECD001
          GOTO      ENDLOP99 IF NOT EQUAL
.
          MATCH     DPTEOEPN,PTECD002
          GOTO      ENDLOP99 IF NOT EQUAL
.
          MATCH     DPTEOCNT,NEWSEQNC
          GOTO      ENDLOP20 IF NOT EQUAL
.
          ADD       ONE,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,NEWSEQNC,SP70
          CALL      DEPTECO1
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,MAXARRY,SP70
          CALL      RDPTECO1
.
          MOVE      NEWSEQNC,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,MAXARRY,SP70
          CALL      DEPTECO1
          GOTO      ENDLOP99
.          
ENDLOP20  MOVE      PTEOCNT,KEY3
          ADD       ONE,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,KEY3,SP70
          CALL      DEPTECO1
          GOTO      ENDLOP10
.
ENDLOP99  RETURN
.---------------------------------------------------------------------
.         Swap Procedure sequence in list
.---------------------------------------------------------------------
SWAPOP00  PACK      KEY13,PTECD001,PTECD002,PTECD003,SP70
          CALL      RDPTECO1
          CALL      DEPTECO1
          MOVE      MAXARRY,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTECD001,PTECD002,NEWSEQNC,SP70
          CALL      RDPTECO1
          CALL      DEPTECO1
          MOVE      PTECD003,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
          PACK      KEY13,PTECD001,PTECD002,MAXARRY,SP70
          CALL      RDPTECO1
          CALL      DEPTECO1
          MOVE      NEWSEQNC,PTEOCNT
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
SWAPOP99  RETURN
.---------------------------------------------------------------
. ********************* Set Redirect String ******************  
.  INPUTS: URNUMBER  - Urnumber No
.          ADMISSNO  - Admission No
.          REPTNO    - Report No
.          TEMPLATE  - Template No        
.          EPSCD001  - Episode No
.          SERVER    - Server 
.          NEXTPAGE  - Nextpage    
.          MEDCD001  - Coding Complete Indicator(used for when going to 
.                      Cancer Registration Screens)       
.---------------------------------------------------------------
STRDIR00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      EPSCD001,KEY2
          REP       " 0",KEY2
.
          CLEAR     REDIRECT
          APPEND    SERVER,REDIRECT
          APPEND    "&reportno=",REDIRECT
          APPEND    REPTNO,REDIRECT
          APPEND    "&template=",REDIRECT
          APPEND    TEMPLATE,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&defltman=",REDIRECT
          APPEND    DEFLTMAN,REDIRECT
          APPEND    "&epscd001=",REDIRECT
          APPEND    KEY2,REDIRECT 
          APPEND    "&medcd001=",REDIRECT
          APPEND    MEDCD001,REDIRECT 
          IF        LOCKEPNO = 1
            APPEND    "&lockepno=",REDIRECT
            APPEND    LOCKEPNO,REDIRECT 
          ENDIF
.
          MATCH     SP70,SUPERLEV
          IF        !@EQUAL
            APPEND    "&superlev=",REDIRECT
            APPEND    SUPERLEV,REDIRECT
          ENDIF
.         
          IF        RUNAUTOG <> 0
            APPEND    "&runautog=",REDIRECT
            APPEND    RUNAUTOG,REDIRECT
          ENDIF
.
          RESET     REDIRECT
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
STRDIR99  RETURN
.------------------------------------------------------------
.                       CKHEAD00 
.          Checks Disease/Procedure Codes, cannot be header codes
. REQUIRED : Diagnosis/Procedure Code Array must be set      
.------------------------------------------------------------
CKHEAD00  MOVE      ONE,COUNT     
          WHILE     COUNT <= LASTDIAG
            MATCH     SP70,DIACODES[COUNT]
            IF        !@EQUAL
              MOVE      DIACODES[COUNT],KEY9
              CALL      RDPTICD1
              BRANCH    OVRCD,CKHEAD90
              IF        ICDRDVER=1     
                MATCH     "999",PTCNDGPV
                GOTO      CKHEAD10 IF EQUAL     * allowing icd9 codes
                GOTO      CKHEAD90              * not allowing icd9 codes
              ENDIF
.
              CALL      DISHED00       * Validate Code for ICD10 Version [N] 
              BRANCH    EXIT,CKHEAD99
            ENDIF
CKHEAD10    ADD      ONE,COUNT
          DO
.
          MOVE      ONE,COUNT     
          WHILE     COUNT <= LASTPROC
            MATCH     SP70,PROCODES[COUNT]
            IF        !@EQUAL
              MOVE      PROCODES[COUNT],KEY9
              CALL      RDPTICO1
              BRANCH    OVRCD,CKHEAD91
              IF        ICDRDVER=1
                MATCH     "999",PTCNDGPV
                IF        @EQUAL
                  GOTO      CKHEAD11              * allowing icd9 codes
                ELSE
                  GOTO      CKHEAD91              * not allowing icd9 codes
                ENDIF
              ENDIF
.
              CALL      OPRHED00      * Validate Code for ICD10 Version [N] 
              BRANCH    EXIT,CKHEAD99
            ENDIF
CKHEAD11    ADD      ONE,COUNT
          DO
.
          GOTO      CKHEAD98 
.
CKHEAD90  MOVE      "Error: Invalid Diagnosis Code - ",WEBTITLE
          ENDSET    WEBTITLE 
          APPEND    DIACODES[COUNT],WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKHEAD99
.
CKHEAD91  MOVE      "Error: Invalid Procedure Code - ",WEBTITLE
          ENDSET    WEBTITLE 
          APPEND    PROCODES[COUNT],WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKHEAD99
.
CKHEAD98  MOVE      ZERO,EXIT
CKHEAD99  RETURN
.------------------------------------------------------------
.   Validate Code for ICD10 Version [N]    
.   DISHED00  -   Moved to VALDIOPS.PBL to be with other ICD10 Validations
.------------------------------------------------------------
.------------------------------------------------------------
.   Validate Code for ICD10 Version [N]    
.   OPRHED00  -   Moved to VALDIOPS.PBL to be with other ICD10 Validations
.------------------------------------------------------------
.------------------------------------------------------------
.                        ******* WGHTSV00 ********                   
.-------------------------------------------------------------------------------
WGHTSV00  MOVE      ADMISSNO,KEY8   * Read Admission File
          CALL      RLPTMIS1        * Read with lock
          IF        OVRCD=0      
            MOVE      HRSICU04,DIM6
            MATCH     DIM6,ABWGHT
            IF        !@EQUAL
              MOVE      ONE,NMDSCHGF
            ENDIF
            MOVE      HRSICU04,ABWGHT
            MATCH     Z70,HRSICU16
            IF        !@EQUAL
              READ      CONTROLF,SEVENTY9;*81,PTCNGEST
              LOAD      OLDICU16,PTCNGEST,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                                    AUSR7,PTMIUSR8,PTMIUSR9
              STORE     HRSICU16,PTCNGEST,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                                    AUSR7,PTMIUSR8,PTMIUSR9
              IF        PTCNGEST = 0
                MOVE      HRSICU16,PTMIUSR0
                MOVE      PTMIUSR0,OLDICU16
              ENDIF
              MATCH     OLDICU16,HRSICU16
              IF        !@EQUAL
                MOVE      ONE,NMDSCHGF
              ENDIF
            ENDIF
.
.
            CALL      UPPTMIS1      * Updates and unlocks record
            CALL      UUPTMIS1        * Read with lock
          ENDIF
.
          IF        NMDSCHGF=1
            CALL      CHGNZ000           * date/time changed - update nmds
          ENDIF
.
WGHTSV99  RETURN
+
.------------------------------------------------------------
. CHGNZ000 - Change NZ NMDS if fields have changed, and require resubmission
.------------------------------------------------------------
CHGNZ000  COMPARE   ONE,PTCNHDPS
          GOTO      CHGNZ999 IF NOT EQUAL   * NZ
.
          MOVE      ADMISSNO,KEY8           * Read in current admission
          CALL      RDMISS1
          BRANCH    OVRCD,CHGNZ999
.
          COMPARE   ONE,AELIG               * has this record been submitted?
          GOTO      CHGNZ999 IF NOT EQUAL
.
          MOVE      "5",AELIG               * update resubmit flag
          CALL      UPMISS1
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          PACK      KEY19,PMVXMHOS,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      CHGNZ999    * record is already on file to be resent
          ENDIF
.
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,PMVXMHOS,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
.
CHGNZ999  CLOSE      PMSWTRA1
          RETURN
+
.-------------------------------------------------------------------------------
.                        ******* SAVCAR00 ********                   
.-------------------------------------------------------------------------------
SAVCAR00  MOVE      ADMISSNO,KEY8   * Read Admission File
          CALL      RLPTMIS1        * Read with lock
          IF        OVRCD=0      
            MATCH     Z70,HRSICU05
            IF        !@EQUAL
              MOVE      HRSICU05,AUSR7
            ENDIF
            CALL      UPPTMIS1      * Updates and unlocks record
            CALL      UUPTMIS1      * Read with lock
          ENDIF
.
SAVCAR99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVINT00 ********                   
.  Save Intention To Readmit
.-------------------------------------------------------------------------------
SAVINT00  MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11        
          IF        OVRCD=0      
            MATCH     Z70,HRSICU06
            IF        !@EQUAL
              MOVE      HRSICU06,PMVXIRAD   * Intent to readmit
            ENDIF
.
            MATCH     Z70,HRSICU08
            IF        !@EQUAL
              MOVE      HRSICU08,PMVXUREA   * Unplanned readmission
            ENDIF
.
            MATCH     Z70,HRSICU09
            IF        !@EQUAL
              MOVE      HRSICU09,PMVXUVTH   * Unplanned visit to theatre
            ENDIF
.
            MATCH     Z70,HRSICU17
            IF        !@EQUAL
              MOVE      HRSICU17,PMVXUDF6 * Prev Specialised Treatment
            ENDIF
.
            CALL      UPPMVX11      * Updates and unlocks record
          ENDIF
          MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDDSCH1        
          IF        OVRCD=0      
            MATCH     Z70,AGECARAS         * Store aged care assessment service
            IF        !@EQUAL
              STORE     AGECARAS,PTCNACAS,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
              CALL      UPDSCH1
            ENDIF
          ENDIF
.
SAVINT99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVEXT00 ********                   
.  Save Visit Extension Details on Associated Coding Screen
.-------------------------------------------------------------------------------
SAVEXT00  MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11        
          IF        OVRCD=0      
            MATCH     Z70,HRSICU06
            IF        !@EQUAL
              MOVE      HRSICU06,PMVXIRAD   * Intent to readmit
            ENDIF
.
            MATCH     Z70,HRSICU05
            IF        !@EQUAL
              MOVE      HRSICU05,PMVXRCCT   * Reason for critical care transfer
            ENDIF
.
            MATCH     Z70,HRSICU08
            IF        !@EQUAL
              MOVE      HRSICU08,PMVXUREA   * Unplanned readmission
            ENDIF
.
            MATCH     Z70,HRSICU09
            IF        !@EQUAL
              MOVE      HRSICU09,PMVXUVTH   * Unplanned visit to theatre
            ENDIF
.
            MATCH     Z70,HRSICU12
            IF        !@EQUAL
              MOVE      HRSICU12,PMVXMHLS   * Mental Health Legal Status
            ENDIF
            MATCH     Z70,HRSICU13
            IF        !@EQUAL
              MOVE      HRSICU13,PMVXCPDD   * Care Plan Documented Date
            ENDIF
.
            MATCH     Z70,HRSICU17
            IF        !@EQUAL
              MOVE      HRSICU17,PMVXUDF6   * Prev Specialised Treatment
            ENDIF
.
            CALL      UPPMVX11      * Updates and unlocks record
            PROC      WRWATR00              * write to WA triggers table
          ENDIF
          MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDDSCH1
          IF        OVRCD=0
            MATCH     Z70,AGECARAS         * Store aged care assessment service
            IF        !@EQUAL
              STORE     AGECARAS,PTCNACAS,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
              CALL      UPDSCH1
            ENDIF
          ENDIF
.
SAVEXT99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVSNG00 ********                   
.-------------------------------------------------------------------------------
SAVSNG00  MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11        * Read with lock
          IF        OVRCD=0      
            MATCH     Z70,CODEINCO
            IF        !@EQUAL
              MOVE      CODEINCO,PMVXUDF5   * Coding Delay Reason (cat dr)
            ENDIF
            MOVE      PTECD007,PMVXCSNG   * Coder Snag
            CALL      UPPMVX11      * Updates and unlocks record
          ENDIF
          RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVPDS00 ********                   
.-------------------------------------------------------------------------------
SAVPDS00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDMRPDS1        * Read with lock
          IF        OVRCD=0      
            MOVE      PTECD008,MRPDSTAT   * PDT Status
            MOVE      CURRDATE,MRPDDATE   * Date of Current Status
            CLOCK     TIME,MRPDTIME       * Time of Current Status
            CALL      UPMRPDS1            * Updates and unlocks record
          ELSE
            MOVE      ADMISSNO,KEY8   * Read Admission File
            CALL      RDMISS1
            MOVE      ADMISSNO,MRPDADMN
            MOVE      ADOCTA,MRPDDOCT    * Doctor Responsible
            MOVE      PTECD008,MRPDSTAT  * PDT Status
            MOVE      CURRDATE,MRPDDATE  * Date of Current Status
            CLOCK     TIME,MRPDTIME      * Time of Current Status
            MOVE      ADMISSNO,KEY8      * Read Visit Extension File
            MOVE      SP70,MRPDRMOR
.
            MOVE      ADMISSNO,KEY8  
            CALL      RAMRPDS1        
            IF        OVRCD=1
              CALL      WRMRPDS1      * Write Record 
            ENDIF
            GOTO      SAVPDS99           * Don't write to history file
          ENDIF
.
.  * Write a record to the post discharge history file.
.
SAVPDS50  PACK      KEY21,MRPDADMN,MRPDDATE,MRPDTIME,SP70
          CALL      RDMRPSH1
          IF        OVRCD=1
            CALL      LSTPSH00
            MOVE      MRPDADMN,MRPSADMN  * Admission No 
            MOVE      MRPDADMN,DMRPSADM  
            MOVE      MRPDDATE,MRPSDATE  * Date of Status
            MOVE      MRPDTIME,MRPSTIME  * Time of Status
            MOVE      MRPDSTAT,MRPSSTAT  * PDT Status
            MOVE      SP70,MRPSCMNT
            MATCH     "A",UPDTTYPE
            IF        @EQUAL
              MOVE      SMPSMIS1,MRPSMIS1
              MOVE      SMPSMIS2,MRPSMIS2
              MOVE      SMPSMIS3,MRPSMIS3
              MOVE      SMPSMIS4,MRPSMIS4
              MOVE      SMPSMIS5,MRPSMIS5
              MOVE      SMPSMIS6,MRPSMIS6
            ELSE
              MOVE      MSCOM001,MRPSMIS1
              MOVE      MSCOM002,MRPSMIS2
              MOVE      MSCOM003,MRPSMIS3
              MOVE      MSCOM004,MRPSMIS4
              MOVE      MSCOM005,MRPSMIS5
              MOVE      MSCOM006,MRPSMIS6
            ENDIF
            MOVE      SMPSFTM1,MRPSFTM1
            MOVE      SMPSFTM2,MRPSFTM2
            MOVE      SMPSFTM3,MRPSFTM3
            MOVE      SMPSFTM4,MRPSFTM4
            MOVE      SMPSFTM5,MRPSFTM5
            MOVE      SP70,MRPSSPAR
.
            PACK      KEY21,MRPSADMN,MRPSDATE,MRPSTIME,SP70
            CALL      WRMRPSH1           * Write Record
          ELSE
            MOVE      MRPDSTAT,MRPSSTAT  * PDT Status
            MATCH     "A",UPDTTYPE
            IF        !@EQUAL
              MOVE      MSCOM001,MRPSMIS1
              MOVE      MSCOM002,MRPSMIS2
              MOVE      MSCOM003,MRPSMIS3
              MOVE      MSCOM004,MRPSMIS4
              MOVE      MSCOM005,MRPSMIS5
              MOVE      MSCOM006,MRPSMIS6
            ENDIF
            CALL      UPMRPSH1           * Update Record
          ENDIF
.
SAVPDS99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVICU00 ********                   
.-------------------------------------------------------------------------------
SAVICU00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTICU1
          IF        OVRCD=1
            CALL      CLPATICU
            GOTO      SAVICU10  
          ENDIF

          MOVE      HRSICU01,PTICUINT   * Hrs in Intensive Care
          MOVE      HRSICU02,PTICUCCU   * Hrs in Critical Care
          MOVE      HRSICU03,PTICUMEC   * Hrs on Mechanical Ventilator
          MOVE      HRSICU07,PTICHNCU   * Hrs in NCU
          MOVE      HRSICU10,PTICCPAP   * Hrs in CRAP
.
          MATCH     Z70,HRSICU11
          IF        !@EQUAL
            MOVE      HRSICU11,PTICAMBN   * Ambulance Client Number
          ENDIF
          MATCH     Z70,HRSICU14
          IF        !@EQUAL
            MOVE      ZERO,FORM2
            SQUEEZE   HRSICU14
            MOVE      HRSICU14,FORM2
            MOVE      FORM2,PTICINTM   * Mins in Intensive Care
          ENDIF
.
          MATCH     Z70,HRSICU15
          IF        !@EQUAL
            MOVE      ZERO,FORM2
            SQUEEZE   HRSICU15
            MOVE      HRSICU15,FORM2
            MOVE      FORM2,PTICMECM   * Mins in Mechanical Ventilator
          ENDIF
.
          MATCH     Z70,HRSICU18
          IF        !@EQUAL
            PACK      PTICCHSC,HRSICU18,SP70
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      UPPTICU1            * Update
          GOTO      SAVICU99
.          
SAVICU10  MOVE      HRSICU01,PTICUINT   * Hrs in Intensive Care
          MOVE      HRSICU02,PTICUCCU   * Hrs in Critical Care
          MOVE      HRSICU03,PTICUMEC   * Hrs on Mechanical Ventilator
          MOVE      HRSICU07,PTICHNCU   * Hrs in NCU
          MOVE      HRSICU10,PTICCPAP   * Hrs in CRAP
.
          MATCH     Z70,HRSICU11
          IF        !@EQUAL
            MOVE      HRSICU11,PTICAMBN   * Ambulance Client Number
          ENDIF
.
          MATCH     Z70,HRSICU14
          IF        !@EQUAL
            MOVE      ZERO,FORM2
            SQUEEZE   HRSICU14
            MOVE      HRSICU14,FORM2
            MOVE      FORM2,PTICINTM   * Mins in Intensive Care
          ENDIF
.
          MATCH     Z70,HRSICU15
          IF        !@EQUAL
            MOVE      ZERO,FORM2
            SQUEEZE   HRSICU15
            MOVE      HRSICU15,FORM2
            MOVE      FORM2,PTICMECM   * Mins in Mechanical Ventilator
          ENDIF
.
          MATCH     Z70,HRSICU18
          IF        !@EQUAL
            PACK      PTICCHSC,HRSICU18,SP70
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPTICU1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPTICU1            * Write Record
            TRAPCLR   IO
            BRANCH    OVRCD,SAVICU99
          ENDIF
.
SAVICU99  RETURN
.
.-------------------------------------------------------------------------------
. Get Latest mrtpshaf data
.-------------------------------------------------------------------------------
LSTPSH00  MOVE      SP70,SMPSMIS1
          MOVE      SP70,SMPSMIS2
          MOVE      SP70,SMPSMIS3
          MOVE      SP70,SMPSMIS4
          MOVE      SP70,SMPSMIS5
          MOVE      SP70,SMPSMIS6
          PACK      SMPSFTM1,SP70,SP70
          PACK      SMPSFTM2,SP70,SP70
          PACK      SMPSFTM3,SP70,SP70
          PACK      SMPSFTM4,SP70,SP70
          PACK      SMPSFTM5,SP70,SP70
.
          PACK      KEY21,ADMISSNO,Z70
          CALL      RSMRPSH1
          CALL      RPMRPSH1
          BRANCH    OVRCD,LSTPSH99
.
          MATCH     ADMISSNO,DMRPSADM
          GOTO      LSTPSH99 IF NOT EQUAL 
.
          MOVE      MRPSMIS1,SMPSMIS1
          MOVE      MRPSMIS2,SMPSMIS2
          MOVE      MRPSMIS3,SMPSMIS3
          MOVE      MRPSMIS4,SMPSMIS4
          MOVE      MRPSMIS5,SMPSMIS5
          MOVE      MRPSMIS6,SMPSMIS6
          MOVE      MRPSFTM1,SMPSFTM1  
          MOVE      MRPSFTM2,SMPSFTM2  
          MOVE      MRPSFTM3,SMPSFTM3  
          MOVE      MRPSFTM4,SMPSFTM4  
          MOVE      MRPSFTM5,SMPSFTM5  
.
LSTPSH99  RETURN
.
.-------------------------------------------------------------------------------
.                        ******* WGHTCK00 ********                   
.     Required INPUT : WEIGHT - FORM 6
.-------------------------------------------------------------------------------
WGHTCK00  IF        PTCNHDPS=9 & WEIGHT = 999999
            GOTO       WGHTCK98                  * Not possible ACT
          ENDIF
.
          IF        PTCNHDPS=6
            GOTO      WGHTCK99      * WA only want warning - in the template
          ENDIF
.
          MATCH     "1",NVALWGHT
          GOTO      WGHTCK99 IF EQUAL    * Weight validate done in template
.
          IF        PTCNHDPS=1
            COMPARE   "9000",WEIGHT
            GOTO      WGHTCK98 IF EQUAL
          ENDIF
.
          MATCH     "1",CKWEIGHT
          IF        @EQUAL
            IF        WEIGHT < 125
              GOTO      WGHTCK90
            ENDIF
          ELSE
            IF        WEIGHT < 125 | WEIGHT > 9999 
              GOTO      WGHTCK90
            ENDIF
            IF        PSAGEDAY < 28 & WEIGHT > 6250
              GOTO      WGHTCK91
            ENDIF
          ENDIF
.
          GOTO      WGHTCK98
.
WGHTCK90  MOVE      "Error: Admission weight cannot be < 125g ",CODERROR
          ENDSET    CODERROR
          MATCH     "1",CKWEIGHT
          IF        !@EQUAL
            APPEND    "or > 9999g.",CODERROR
          ENDIF
          APPEND    SP70,CODERROR
          CALL      CODERR00
          MOVE      ONE,EXIT
          GOTO      WGHTCK99
.
WGHTCK91  MOVE      "Error: Patient < 28 days and Admission ",CODERROR
          ENDSET    CODERROR
          APPEND    "Weight > 6250g.",CODERROR
          CALL      CODERR00
          MOVE      ONE,EXIT
          GOTO      WGHTCK99
.
WGHTCK98  MOVE      ZERO,EXIT
WGHTCK99  RETURN
.-------------------------------------------------------------------------------
.                        ******* GROUPR00 ********                   
.-------------------------------------------------------------------------------
GROUPR00  CALL      DELLCK00  * Delete Diagnosis Lock Record if found  
          CALL      DELECD00  * Delete all records from Diagnosis Coding file
          CALL      DELECO00  * Delete all records from Procedure Coding file
          CALL      CLRCHC00  * clear "Date Episode Coding Complete" in PATCHCof
.
.  This Loop goes through the Diagnosis code array and saves each code.
.
          MOVE      ONE,COUNT               
          WHILE     COUNT <= LASTDIAG
            MATCH     SP70,DIACODES[COUNT] 
            IF        !@EQUAL
              CALL      SAVDIS00   * Save Diagnosis Record 
            ENDIF
            ADD      ONE,COUNT
          DO
.
.  This Loop goes through the Procedure Code array and saves each code.
.
          UNPACK    SP70,SVEOCLIN,SVEODATE                            *I-240103
          MOVE      ONE,COUNT               
          WHILE     COUNT <= LASTPROC
            MATCH     SP70,PROCODES[COUNT] 
            IF        !@EQUAL
....                                    * changed their minds - don't want this
....          MATCH     "0",MRCNCLIN                                  *I-240103
....          CALL      SAVCLN00 IF NOT EQUAL * save Clinician Info   *I-240103
.
              CALL      SAVPRO00              * Save Procedure Record 
            ENDIF
            ADD      ONE,COUNT
          DO
.
          CALL      DISSQE00        * Resequence Disease Codes & MDS Data
          CALL      PROSQE00        * Resequence Procedure Codes & MDS Data
.
GROUPR99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVDIS00 ********                   
. ----- Save one record at a time to the medical records Diagnosis file ----
.-------------------------------------------------------------------------------
SAVDIS00  MOVE      ZERO,EXIT
.
          IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECD1                * Position on & read a patient
          CALL      RPPTECD1                * episode disease file record
          BRANCH    OVRCD,SAVDIS10
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      SAVDIS10 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      SAVDIS20 IF EQUAL       * Same episode no
.
SAVDIS10  MOVE      ZERO,PTEDCNT            * Reset the episode unique counter
.
SAVDIS20  MOVE      ADMISSNO,PTEDADMN       * Admin no
          MOVE      EPSCD001,PTEDEPNO       * Epsiode no
.
          MOVE      ZERO,FORM3                                        *C-240107
          MOVE      PTEDCNT,FORM3           * move episode count to temp form2
          ADD       ONE,FORM3               * increment count
          COMPARE   ONE,FORM3               * is it first record?
          GOTO      SAVDIS30 IF EQUAL
.
          MATCH     CMDISP,PREFIXES[COUNT]
          GOTO      SAVDIS30 IF NOT EQUAL
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,SP70
          CALL      RSPTECD1
SAVDIS25  CALL      RKPTECD1
          BRANCH    OVRCD,SAVDIS30
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      SAVDIS30 IF NOT EQUAL
.
          MATCH     PREFIXES[COUNT],PTEDTYPE
          IF        @EQUAL
            IF        PTCNHDPS=1
              GOTO      SAVDIS90            * we have multiple primary prefix
            ENDIF
          ENDIF
          GOTO      SAVDIS25                * continue search
.
SAVDIS30  MOVE      ADMISSNO,PTEDADMN
          MOVE      EPSCD001,PTEDEPNO
          MOVE      FORM3,KEY3                                        *C-240107
          PACK      KEY13,PTEDADMN,PTEDEPNO,KEY3
          CALL      RDPTECD1
          IF        OVRCD=1
SAVDIS35    MOVE      KEY3,PTEDCNT
            PACK      PTEDCODE,DIACODES[COUNT] * Diagnosis code
            MOVE      PREFIXES[COUNT],PTEDTYPE * Diagnosis type
            MOVE      ZERO,PTEDUNQN            * Unique no
            PACK      PTEDDTCD,CCC,CYY,CMM,CDD
            REP       " 0",PTEDDTCD            * Date of coding
            MOVE      CTIMEIS,PTEDTIME         * Time of coding
            MOVE      PASSCODE,PTEDOPER        * Operator
            MOVE      USERID,PTEDUSID          * Web User ID
            MOVE      ACCIDENT[COUNT],PTEDACDT * Diagnosis accident date
            MOVE      SP70,PTEDCCCL            * CCL Class Level
            MOVE      SP70,PTEDDRGD            * DRG Driver 0=Not Used 1=Used
            MOVE      DESCRIPT[COUNT],PTEDDESC * Diagnosis code description
            MOVE      SP70,PTEDOSET            * Diagnosis onset type
            MOVE      CCFLAG[COUNT],PTEDCCFL   * Contract Care Flag
            MOVE      SP70,PTEDDCID            * Diagnosis cluster id
            MOVE      SP70,PTEDSPAR
.
            IF        PTCNHDPS>0
              MOVE      TWO,PTEDOSET        * Diagnosis onset type
              MATCH     CMDISC,PTEDTYPE
              IF        @EQUAL
                MOVE      ONE,PTEDOSET      * Diagnosis onset type (compl)
              ENDIF
            ENDIF
            IF        PTCNHDPS=4
              MOVE      ONE,PTEDOSET        * Diagnosis onset type
              MATCH     CMDISC,PTEDTYPE
              IF        @EQUAL
                MOVE      TWO,PTEDOSET      * Diagnosis onset type (compl)
              ENDIF
            ENDIF
.
            PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
            CALL      RAPTECD1
            IF        OVRCD=1
              MOVE      ZERO,OVRCD
              TRAP      OVERCOND IF IO        * Trap to stop I * D
              CALL      WRPTECD1              * Write an eps dis coding file rec
              TRAPCLR   IO
              BRANCH    OVRCD,SAVDIS99
            ENDIF
            CALL      PTHCS000                                          *214276
          ENDIF
          GOTO      SAVDIS99
.
SAVDIS90  CLEAR     WEBTITLE
          MOVE      "Please use other Prefix Indicator as ",DIM50
          PACK      DIM3,MARK,CMDISP,MARK
          MOVE      " is a Primary Field. ",DIM20
          PACK      WEBTITLE,DIM50,DIM3,DIM20
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
SAVDIS99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVPRO00 ********                   
. -----  Save one record at a time to the medical records Procedure file ----
.-------------------------------------------------------------------------------
SAVPRO00  IF        MRCNEPSC=0
            MOVE      ONE,EPSCD001   * Episode Coding not used so default to 1
          ENDIF 
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECO1                 * Position on & read a patient
          CALL      RPPTECO1                   episode Procedure file record
          BRANCH    OVRCD,SAVPRO10
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      SAVPRO10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      SAVPRO20 IF EQUAL        * Same episode no
.
SAVPRO10  MOVE      ZERO,PTEOCNT             * Reset the episode unique counter
.
SAVPRO20  MOVE      ADMISSNO,PTEOADMN        * Admin no
          MOVE      EPSCD001,PTEOEPNO        * Epsiode no
          ADD       ONE,PTEOCNT              * Increment the episode unique cnt
          MOVE      PROCODES[COUNT],PTEOCODE * Procedure code
          MOVE      PREFIXES[COUNT],PTEOTYPE * Procedure type
          MOVE      ZERO,PTEOUNQN            * Unique no
          PACK      PTEODTCD,CCC,CYY,CMM,CDD
          REP       " 0",PTEODTCD            * Date of coding
          MOVE      CTIMEIS,PTEOTIME         * Time of coding
          MOVE      PASSCODE,PTEOOPER        * Operator
          MOVE      USERID,PTEOUSID          * Web User ID
          MOVE      PRODATES[COUNT],PTEODATE * Procedure Date
          MOVE      PROSTART[COUNT],PTEOSTTM * Procedure Start Time
          MOVE      PROENDTM[COUNT],PTEOEDTM * Procedure End Time
          MOVE      SP70,PTEODRGD            * DRG Driver
          MOVE      DESCRIPT[COUNT],PTEODESC * Diagnosis code description
          MOVE      PRODOCCD[COUNT],PTEOCLIN * Proc. Clinician code   *I-240103
          MOVE      CCFLAG[COUNT],PTEOCCFL   * Contract Care Flag
          MOVE      SP70,PTEOSPAR
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT
          CALL      RAPTECO1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO        * Trap to stop I * D
            CALL      WRPTECO1              * Write an eps Pro coding file rec
            TRAPCLR   IO
          ENDIF
.
SAVPRO99  RETURN
.-------------------------------------------------------------------------------
.                        ******* SAVCLN00 ********                   
.              propagate Clinician to all following Procedures        *I-240103
.-------------------------------------------------------------------------------
SAVCLN00  MATCH     SP10,SVEOCLIN
          IF        @EQUAL
            MATCH     SP10,PRODOCCD[COUNT]
            GOTO      SAVCLN20 IF EQUAL
            MOVE      PRODOCCD[COUNT],SVEOCLIN
          ELSE
            MATCH     SP10,PRODOCCD[COUNT]
            GOTO      SAVCLN20 IF NOT EQUAL
            MOVE      SVEOCLIN,PRODOCCD[COUNT]
          ENDIF
.
SAVCLN20  MATCH     SP10,SVEODATE
          IF        @EQUAL
            MATCH     SP10,PRODATES[COUNT]
            GOTO      SAVCLN99 IF EQUAL
            MOVE      PRODATES[COUNT],SVEODATE
          ELSE
            MATCH     SP10,PRODATES[COUNT]
            GOTO      SAVCLN99 IF NOT EQUAL
            MOVE      SVEODATE,PRODATES[COUNT]
          ENDIF
.
SAVCLN99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DELLCK00 ********                   
. ----- Delete Lock record for Coding Screen if found -----
.-------------------------------------------------------------------------------
DELLCK00  MOVE      ZERO,PTEDCNT  
          MOVE      ZERO,FORM2
          PACK      KEY13,ADMISSNO,FORM2,PTEDCNT,SP70
          CALL      RDPTECD1                
          BRANCH    OVRCD,DELLCK99
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      DEPTECD1                * Delete an eps dis coding file rec
.
DELLCK99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DELECD00 ********                   
. ----- Delete all the records from the medical records disease file ----
.-------------------------------------------------------------------------------
DELECD00  PACK      KEY13,ADMISSNO,EPSCD001,SP70
DELECD10  CALL      RSPTECD1                * Position on & read a patient
          CALL      RKPTECD1                  episode disease file record
          BRANCH    OVRCD,DELECD90
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      DELECD90 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      DELECD90 IF NOT EQUAL   * Different episode no
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      DEPTECD1                * Delete an eps dis coding file rec
          GOTO      DELECD10
.
DELECD90  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      DELECD99 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      DELECD99 IF EQUAL
.
          CALL      WAECM000         * write patecmaf record so resent in edw
.
DELECD99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DELECO00 ********                   
. ----- Delete all the records from the medical records Procedure file ----
.-------------------------------------------------------------------------------
DELECO00  UNPACK    SP70,SVEOCLIN,SVEODATE
          PACK      KEY13,ADMISSNO,EPSCD001,SP70 
DELECO10  CALL      RSPTECO1                * Position on & read a patient
          CALL      RKPTECO1                * episode operation file record
          BRANCH    OVRCD,DELECO90
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      DELECO90 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      DELECO90 IF NOT EQUAL   * Different episode no
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT
          CALL      DEPTECO1                * Delete an eps opr coding file rec
.
          MATCH     "0",MRCNCLIN                                      *I-240103
          IF        !@EQUAL
            MATCH     SP10,PTEOCLIN                                   *I-240103
            IF        @EQUAL
              MOVE      PTEOCLIN,SVEOCLIN     * save first Opr Clinician & Date
              MOVE      PTEODATE,SVEODATE
            ENDIF
          ENDIF
          GOTO      DELECO10
.
DELECO90  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      DELECO99 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      DELECO99 IF EQUAL
.
          CALL      WAECM000         * write patecmaf record so resent in edw
.
DELECO99  RETURN
.-------------------------------------------------------------------------------
.                        ******* CLRCHC00 ********                   
. ----- Clear "Date Episode Coding Complete" field in patchcaf" -----
.-------------------------------------------------------------------------------
CLRCHC00  BRANCH    MRCNEPSC,CLRCHC10
          GOTO      CLRCHC99
.
CLRCHC10  MOVE      EPSCD001,KEY2
          PACK      KEY26,ADMISSNO,EPSCD001,SP70
          CALL      RDSCHCO2
CLRCHC20  CALL      RDKCHCO2
          BRANCH    OVRCD,CLRCHC99
.
          MATCH     ADMISSNO,DCHADMN
          GOTO      CLRCHC99 IF NOT EQUAL

          MATCH     KEY2,CHEPISNO
          GOTO      CLRCHC20 IF NOT EQUAL
.
          MOVE      WBSEPCD,CHUPUSID
          PACK      CHUPDATE,CURRDATE
          MOVE      CTIMEIS,CHUPTIME
          MOVE      SP20,CHCODCMP
          CALL      UPCHCO2
.
CLRCHC99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DELMDD00 ********                   
. ----- Delete disease records from the free format description file -----
.-------------------------------------------------------------------------------
DELMDD00  PACK      KEY11,ONE,ADMISSNO,SP20
....ML    CALL      RDSMDSA1                * Position on & read a free format
....ML    CALL      RDKMDSA1                  description file record
....ML    BRANCH    OVRCD,DELMDD99
....ML
....ML    COMPARE   ONE,MDSTYPE
....ML    GOTO      DELMDD99 IF NOT EQUAL   * Not a disease record
....ML
....ML    MATCH     ADMISSNO,DMDSADMN
....ML    GOTO      DELMDD99 IF NOT EQUAL   * Different admin no
....ML
....ML    PACK      KEY11,MDSTYPE,MDSADMN,MDSRECN,SP70
....ML    CALL      DEMDSA1                 * Delete a free format desc file rec
....ML    GOTO      DELMDD00
.
DELMDD99  RETURN
.-------------------------------------------------------------------------------
. ----- Delete Procedure records from the free format description file -----
.-------------------------------------------------------------------------------
DELMDP00  PACK      KEY11,TWO,ADMISSNO,SP20
....ML    CALL      RDSMDSA1                * Position on & read a free format
....ML    CALL      RDKMDSA1                  description file record
....ML    BRANCH    OVRCD,DELMDP99
....ML
....ML    COMPARE   TWO,MDSTYPE
....ML    GOTO      DELMDP99 IF NOT EQUAL   * Not a Procedure record
....ML
....ML    MATCH     ADMISSNO,DMDSADMN
....ML    GOTO      DELMDP99 IF NOT EQUAL   * Different admin no
....ML
....ML    PACK      KEY11,MDSTYPE,MDSADMN,MDSRECN,SP70
....ML    CALL      DEMDSA1                 * Delete a free format desc file rec
....ML    GOTO      DELMDP00
.
DELMDP99  RETURN
.-------------------------------------------------------------------------------
. ----- Delete Grouper Details Record -----
.-------------------------------------------------------------------------------
DELGRP00  PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTPGR1
          CALL      RKPTPGR1
          BRANCH    OVRCD,DELGRP99 
.
          MATCH     ADMISSNO,DPTPGADM
          GOTO      DELGRP99 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTPGEPNO
          GOTO      DELGRP99 IF NOT EQUAL
.
          PACK      KEY13,PTPGADMN,PTPGEPNO,PTPGGPVR,SP70
          CALL      DEPTPGR1       * Delete Record                      
.
          GOTO      DELGRP00
.
DELGRP99  RETURN
.-----------------------------------------------------------------
. Clear Discharge DRG code on discharge file
.-----------------------------------------------------------------
UPDDSC00  PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
          CALL      RDDSCH1
          BRANCH    OVRCD,UPDDSC99
          MOVE      SP10,PTDSDDRG       * DRG code
          MOVE      SP10,PTDSDMDC       * MDC code
          MOVE      SP10,PTDSSIDX       * IDX code
          MOVE      SP10,PTDSVOGU       * DRG vers
          CALL      UPDSCH1
UPDDSC99  RETURN
+
.-----------------------------------------------------------------
. Cancer Coding
.-----------------------------------------------------------------
CANCOD00  MATCH     SP70,UPDTTYPE
          GOTO      CANCOD70 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add Cancer Registration
          GOTO      CANCOD10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update Cancer Registration
          GOTO      CANCOD20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete Cancer Registration
          GOTO      CANCOD30 IF EQUAL
.
          MATCH     "P",UPDTTYPE    * Print Cancer Registration
          GOTO      CANCOD40 IF EQUAL
.
          MATCH     "B",UPDTTYPE    * Add Cancer Reason for Clinical Diagnosis
          GOTO      CANCOD50 IF EQUAL
.
          MATCH     "E",UPDTTYPE    * Delete Cancer Reason for Clinical Diagns
          GOTO      CANCOD60 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Complete Cancer Registration
          GOTO      CANCOD18 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Redirect to Cancer Registration
          GOTO      CANCOD15 IF EQUAL
.
          GOTO      CANCOD90
.
.         *********** ADD FORMACTION **********
. 
CANCOD10  BRANCH    CANCEROV,CANCOD18:      * Cancer Reg. "Cancel" clicked
                             CANCOD13:      *     "Ok" clicked (Add)
                             CANCOD18       *     "Ok" clicked (List/Cancel)
.
          PACK      KEY8,URNUMBER,SP70  * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CANCOD91      * Read details for print reg form
.
          PACK      KEY8,URNUMBER   
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL     CLPMSPX2
          ENDIF
.    
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          PACK      KEY8,ADMISSNO,SP70      * Read Visit File
          CALL      RDVISA1 
          BRANCH    OVRCD,CANCOD98
.                                           * check if outpatient
          IF        PVITYPE <> 2
            PACK      KEY8,ADMISSNO,SP70    * Read Admission File for reg form
            CALL      RDMISS1
            BRANCH    OVRCD,CANCOD92
          ENDIF
.
          MATCH     "1",PRINTREG
          IF        @EQUAL
            CALL      CNHED000          * Read & Validate Stationary Code
            BRANCH    EXIT,CANCOD99
.
            PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
            CALL      RDDSCH1
            IF        OVRCD=1
....          CALL      CLPATDSC      * CAR 47761
              PACK      DDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",DDATE
            ENDIF
.         
            MOVE      DDATE,ICDRDDTE      * Used for reading ICD files
            MOVE      PRINTSEL,SELPRINT   * Set default Printer from CGI var
          ENDIF
.
          CALL      CLRCRD00        * Clear CGI Before save
          CALL      WRTHED00        * Create Cancer Reg Header Record 
          CALL      GENCAN00        * Generate Registration No 
          CALL      SAVCRD00        * Save Details
.
CANCOD11  PACK      KEY25,ADMISSNO,PTCRD008,PTCRD002,SP70
          CALL      RAPTCRD1
          IF        OVRCD=1
            MOVE      PTCRD002,PTCDCNRG  * Set Cancer Reg no before write!
            CALL      WRPTCRD1      * Write Cancer Registration record
          ELSE
            ADD       ONE,PTCRD002 
            GOTO      CANCOD11
          ENDIF 
.
          PACK      VISCODKY,PTCDDADN,PTCDPRMM,PTCDCNRG,SP70
          CALL      MVVSCO00                * Save visit based coding
. 
          MATCH     "1",PRINTREG 
          IF        @EQUAL
            CALL      CNPRN000      * Print Cancer Registration 
          ENDIF
.
.         Redirect to Reason screen only for QLD
.
          IF        PTCNHDPS=4
            MATCH     "1",PTCDBT01          * Basis for Diag. Clinical Only
            GOTO      CANCOD19 IF EQUAL
            MATCH     "1",PTCDBT03          * Basis for Diag. Imaging
            GOTO      CANCOD19 IF EQUAL
            MATCH     "1",PTCDBT04          * Basis for Diag. Endoscopy 
            GOTO      CANCOD19 IF EQUAL
.                                                                     *I-154835
            MATCH     "1",PTCDBT06          * Basis for Diag. Cytology/Haematol
            GOTO      CANCOD19 IF EQUAL
            MATCH     "1",PTCDBT07          * Basis for Diag. Histol.of Metast.
            GOTO      CANCOD19 IF EQUAL
            MATCH     "1",PTCDBT08          * Basis for Diag. Histol.of Primary
            GOTO      CANCOD19 IF EQUAL
            MATCH     "1",PTCDBT10          * Basis for Diag. Autopsy & Histol.
            GOTO      CANCOD19 IF EQUAL
          ENDIF
.
          CALL      LODDIS00        * Load the Disease Code Array for following
.
          CALL      CANCER00      * Check for Cancer Coding and set redirect.
          BRANCH    EXIT,CANCOD13:          * New cancers - no prev.registrat'ns
                         CANCOD99           * went via CANCEROV
          GOTO      CANCOD18                * No Cancer codes found
.
.                                           * redirect to Cancer Add screen
CANCOD13  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "08",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99
.
.0892581  Redirect to Cancer Reg after adding Reason for Clinical Diagnosis
.
CANCOD15  BRANCH    CANCEROV,CANCOD18:      * Cancer Reg. "Cancel" clicked
                             CANCOD16:      *             "Ok" clicked (Add)
                             CANCOD17       *             "Ok" clicked (Updt)
.
          CALL      LODDIS00        * Load the Disease Code Array for following
.
          CALL      CANCER00      * Check for Cancer Coding and set redirect.
          BRANCH    EXIT,CANCOD16:          * New cancers - no prev.registrat'ns
                         CANCOD99           * went via CANCEROV
          GOTO      CANCOD18                * No Cancer codes found
.
.                                           * redirect to Cancer Add screen
CANCOD16  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "08",REPTNO             * Set for STRDIR00
          MOVE      "001",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99
.
.                                           * redirect to Cancer List screen
CANCOD17  MOVE      "mrtweb02.pbl?",SERVER  * Set for STRDIR00
          MOVE      "08",REPTNO             * Set for STRDIR00
          MOVE      "002",TEMPLATE          * Set for STRDIR00
          MOVE      FIVE,NEXTPAGE           * Set for STRDIR00
          CALL      STRDIR00                * Set redirect string
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99
.
CANCOD18  CALL      COMPLT00      * Check if Coding is Complete?
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99 
.
CANCOD19  MOVE      FIVE,NEXTPAGE           
          CALL      RDRCDG00     * Redirect to Reason for Clinical Diagnosis
          MOVE      ZERO,EXIT
          GOTO      CANCOD99 
.
.
.         *********** UPDATE FORMACTION **********
. 
CANCOD20  CALL      UPDHED00      * Update Cancer Reg Header Record 
.
          PACK      KEY25,ADMISSNO,PTCRD008,PTCRD002,SP70
          CALL      RDPTCRD1
          BRANCH    OVRCD,CANCOD94
.
          CALL      SAVCRD00      * Save Details
          CALL      UPPTCRD1      * Update Cancer Registration record
.
          PACK      VISCODKY,PTCDDADN,PTCDPRMM,PTCDCNRG,SP70
          CALL      MVVSCO00                * Save visit based coding
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99 
.
.         *********** DELETE FORMACTION **********
. 
CANCOD30  PACK      KEY25,ADMISSNO,PTCRD008,PTCRD002,SP70
          CALL      RDPTCRD1
          BRANCH    OVRCD,CANCOD94
.
          CALL      DEPTCRD1      * Delete Cancer Registration record
.
          CALL      WEDC0000      * EDWARD delete cancer registration trigger
.
          CALL      DELHED00      * Delete Cancer Reg Header Record if needed 
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99 
.
.         *********** PRINT CANCER REGISTRATION FORMACTION **********
. 
CANCOD40  PACK      KEY8,URNUMBER,SP70  * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CANCOD91
.
          PACK      KEY8,URNUMBER                                      *I-53464
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL     CLPMSPX2
          ENDIF
.    
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          PACK      KEY8,ADMISSNO,SP70  * Read Visit File
          CALL      RDVISA1 
          BRANCH    OVRCD,CANCOD98
.                                           * check if outpatient
          COMPARE   "2",PVITYPE
          GOTO      CANCOD42 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70  * Read Visit File
          CALL      RDPMVX11
          BRANCH    OVRCD,CANCOD98
.
          PACK      KEY8,ADMISSNO,SP70  * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,CANCOD92
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
          CALL      RDDSCH1
          IF        OVRCD=1
....        CALL      CLPATDSC      * CAR 47761
            PACK      DDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",DDATE
          ENDIF
.
          MOVE      DDATE,ICDRDDTE      * Used for reading ICD files
.
CANCOD42  PACK      KEY8,ADMISSNO,SP70      * Read Can Reg Header Details
          CALL      RDPTCRG1
          BRANCH    OVRCD,CANCOD95
.
          PACK      KEY25,ADMISSNO,PTCRD008,PTCRD002,SP70 
          CALL      RDPTCRD1                 
          BRANCH    OVRCD,CANCOD94
.
          MOVE      PRINTSEL,SELPRINT        * Set default Printer from CGI var
.
          CALL      CNHED000                 * Read & Validate Stationary Code 
          BRANCH    EXIT,CANCOD99
.
          CALL      CNPRN000                 * Print Cancer Registration
.
          MOVE      ZERO,EXIT
          GOTO      CANCOD99 
.
.         *********** ADD PMSCDGAF FORMACTION **********
.
CANCOD50  PACK      KEY25,ADMISSNO,PMCDG003,PMCDG002,SP70
          CALL      RDPTCRD1
          BRANCH    OVRCD,CANCOD94
.                                                           
          IF        PMCDG004=1
            MOVE      ONE,PTCDBT01   * Basis for Diag. Clinical Only
          ENDIF
          IF        PMCDG004=3
            MOVE      ONE,PTCDBT03   * Basis for Diag. Imaging 
          ENDIF
          IF        PMCDG004=4
            MOVE      ONE,PTCDBT04   * Basis for Diag. Endoscopy 
          ENDIF
.                                                                     *I-154835
          IF        PMCDG004=6
            MOVE      ONE,PTCDBT06   * Basis for Diag. Cytology or Haematology
          ENDIF
          IF        PMCDG004=7
            MOVE      ONE,PTCDBT07   * Basis for Diag. Histology of Metastasis
          ENDIF
          IF        PMCDG004=8
            MOVE      ONE,PTCDBT08   * Basis for Diag. Histology of Primary
          ENDIF
          IF        PMCDG004=9
            MOVE      ONE,PTCDBT10   * Basis for Diag. Autopsy & Histology
          ENDIF
.
          CALL      UPPTCRD1
.
          PACK      VISCODKY,PTCDDADN,PTCDPRMM,PTCDCNRG,SP70
          CALL      MVVSCO00                * Save visit based coding
.
          PACK      KEY29,ADMISSNO,PMCDG002,PMCDG003,PMCDG004,PMCDG005,SP70
          CALL      RAPMCDG1
          COMPARE   ZERO,OVRCD
          GOTO      CANCOD96 IF EQUAL
.
          MOVE      ADMISSNO,PMCGADNO  
          MOVE      PMCDG002,PMCGCNRG  
          MOVE      PMCDG003,PMCGPRMM  
          MOVE      PMCDG004,PMCGBSDG  
          MOVE      PMCDG005,PMCGCDIG  
          MOVE      PMCDG006,PMCGCDDS  
          CALL      WRPMCDG1      * Write Cancer Reason for Clinical Diagnosis 
.
          GOTO      CANCOD99 
.
.         *********** DELETE PMSCDGAF FORMACTION **********
. 
CANCOD60  PACK      KEY29,ADMISSNO,PMCDG002,PMCDG003,PMCDG004,PMCDG005,SP70
          CALL      RDPMCDG1
          BRANCH    OVRCD,CANCOD97
.
          CALL      DEPMCDG1      * Delete Cancer Reason for Clinical Diagnosis
          GOTO      CANCOD99 
.
.   ************ DISPLAY: VALIDATE URNUMBER & VISIT NUMBER ************
.
CANCOD70  MATCH     "004",TEMPLATE  * Patient Cancer Reg List (All Visits)
          IF        @EQUAL
            PACK      KEY8,URNUMBER,SP70  * Read Master File
            CALL      RDMAST1
            BRANCH    OVRCD,CANCOD91
.
            PACK      KEY8,URNUMBER,SP70  * Read Master Ext 2 File
            CALL      RDPMPX21
            BRANCH    OVRCD,CANCOD91
.
            GOTO      CANCOD80
          ENDIF
.    
.                                                                     *I-145686
          CALL      CLPATMIS                * clear Admission
          CALL      CLRDIS00                * clear Discharge
          CALL      CLPATICU                * clear Intensive Care
          MOVE      PVIDATE,ICDRDDTE        * default Visit Date for ICD files
.
          PACK      KEY8,ADMISSNO,SP70  * Read Visit File
          CALL      RDVISA1 
          BRANCH    OVRCD,CANCOD98
.                                           * check if outpatient
          IF        PVITYPE = 2
            MOVE      PVIURNO,AURNO
            GOTO      CANCOD72
          ENDIF
.
.                                           * inpatient processing *****
          PACK      KEY8,ADMISSNO,SP70  * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,CANCOD92
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Data
          CALL      RDDSCH1
          IF        OVRCD=1
....        CALL      CLPATDSC      * CAR 47761
            PACK      DDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",DDATE
          ENDIF
.
          MOVE      DDATE,ICDRDDTE      * Used for reading ICD files
.
CANCOD72  PACK      KEY8,AURNO,SP70  * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CANCOD91
.
          PACK      KEY8,AURNO,SP70  * Read Master Ext 2 File
          CALL      RDPMPX21
          BRANCH    OVRCD,CANCOD91
.
          PACK      KEY8,ADMISSNO,SP70  * Read Can Reg Header File
          CALL      RDPTCRG1
          IF        OVRCD=1      
            CALL      CLRCRG00
          ENDIF
.
          PACK      KEY25,ADMISSNO,PTCRD008,PTCRD002,SP70 
          CALL      RDPTCRD1            * Read Cancer Reg details file
          IF        OVRCD=1      
            CALL      CLRCRD00
            PACK      VISCODKY,SP70
          ELSE
            PACK      VISCODKY,PTCDDADN,PTCDPRMM,PTCDCNRG,SP70  * for viscodaf
          ENDIF
.
CANCOD80  CLEAR     WEBTITLE
          MOVE      "Cancer Coding",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CANCOD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD92  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD93  MOVE      "Can't find patient Discharge Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD94  MOVE      "Cancer Registration Details not found. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD95  MOVE      "Cancer Registration Header Details not found. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD96  MOVE      "Cancer Reason for Clinical Diagnosis already exists. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD97  MOVE      "Cancer Reason for Clinical Diagnosis not found. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD98  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANCOD99
.
CANCOD99  RETURN
+
.-------------------------------------------------------------------------------
.     Delete all PMSCDGaf records associated with PATCRDaf being deleted
.-------------------------------------------------------------------------------
DLPMCG00  PACK      KEY29,ADMISSNO,PTCRD002,PTCRD008,SP70
          CALL      RSPMCDG1
DLPMCG01  CALL      RKPMCDG1
          BRANCH    OVRCD,DLPMCG99
.
          MATCH     ADMISSNO,DPMCGADN
          GOTO      DLPMCG99 IF NOT EQUAL
.
          COMPARE   PTCRD002,PMCGCNRG
          GOTO      DLPMCG99 IF NOT EQUAL
.
          MATCH     PTCRD008,PMCGPRMM
          GOTO      DLPMCG99 IF NOT EQUAL
.
          PACK      KEY29,DPMCGADN,DPMCGCNR,PMCGPRMM,DPMCGBSD,DPMCGCDI,SP70
          CALL      DEPMCDG1
          GOTO      DLPMCG01
.
DLPMCG99  RETURN
+
.-------------------------------------------------------------------------------
.     Create Cancer Registration Header Record
.-------------------------------------------------------------------------------
RDRCDG00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      EPSCD001,KEY2
          REP       " 0",KEY2
.
          CLEAR     REDIRECT
          APPEND    "mrtweb02.pbl?&reportno=08&template=009",REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
...       APPEND    "&admissno=",REDIRECT
...       APPEND    ADMISSNO,REDIRECT
          APPEND    "&ptcrd002=",REDIRECT
          APPEND    PTCRD002,REDIRECT
          APPEND    "&ptcrd008=",REDIRECT
          APPEND    PTCRD008,REDIRECT
          APPEND    "&pmcdg002=",REDIRECT
          APPEND    PTCRD002,REDIRECT
          APPEND    "&pmcdg003=",REDIRECT
          APPEND    PTCRD008,REDIRECT
          APPEND    "&epscd001=",REDIRECT
          APPEND    KEY2,REDIRECT
          APPEND    "&medcd001=",REDIRECT
          APPEND    MEDCD001,REDIRECT
          RESET     REDIRECT
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
RDRCDG99  RETURN
.-------------------------------------------------------------------------------
.     Create Cancer Registration Header Record
.-------------------------------------------------------------------------------
WRTHED00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTCRG1
          BRANCH    OVRCD,WRTHED10
.
          MATCH     "1",PTCRG001
          IF        @EQUAL
            MOVE      ONE,PTCRMULT
          ELSE
            MOVE      ZERO,PTCRMULT
          ENDIF
.    
          MOVE      PTCRG002,PTCRSTAY     * LOS in NZ  

          MOVE      PTCRD008,PTCRPRIM     * Primary Site (ICD10 Code)
          MOVE      PTCRD009,PTCRHIST     * Histological Site (ICD10 Code)

          CALL      UPPTCRG1
.
          GOTO      WRTHED99

WRTHED10  MOVE      URNUMBER,PTCRURNO     * U/R Number
          MOVE      ADMISSNO,PTCRADNO     * Admission No
.
          MATCH     "1",PTCRG001
          IF        @EQUAL
            MOVE      ONE,PTCRMULT
          ELSE
            MOVE      ZERO,PTCRMULT
          ENDIF
.    
          MOVE      PTCRG002,PTCRSTAY     * LOS in NZ  
          MOVE      ZERO,PTCRVERT         * Converetd Record 0=No 1=Yes

          MOVE      PTCRD008,PTCRPRIM     * Primary Site (ICD10 Code)
          MOVE      PTCRD009,PTCRHIST     * Histological Site (ICD10 Code)
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPTCRG1
          IF        OVRCD=1
            CALL      WRPTCRG1
          ENDIF
.
WRTHED99  RETURN
.-------------------------------------------------------------------------------
.                   Update Cancer Registration Header
.  The Primary & Histological Site are atracted from the last detail record
.  for the Admission!
.-------------------------------------------------------------------------------
UPDHED00  PACK      KEY25,ADMISSNO,Z70
          CALL      RSPTCRD1
          CALL      RPPTCRD1
          BRANCH    OVRCD,UPDHED99
.
          MATCH     ADMISSNO,DPTCDDAD     * Match on Admission No
          GOTO      UPDHED99 IF NOT EQUAL
.
          COMPARE   PTCRD002,PTCDCNRG     * If match Reg no is most current
          GOTO      UPDHED90 IF NOT EQUAL
.
.  Only Update the Header Record Primary & Histological Site if we are on last 
.  Registraion Record Detail.
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTCRG1
          BRANCH    OVRCD,UPDHED99
.
          MATCH     "1",PTCRG001
          IF        @EQUAL
            MOVE      ONE,PTCRMULT
          ELSE
            MOVE      ZERO,PTCRMULT
          ENDIF
.    
          MOVE      PTCRG002,PTCRSTAY     * LOS in NZ  
.
          MOVE      PTCRD008,PTCRPRIM     * Primary Site (ICD10 Code)
          MOVE      PTCRD009,PTCRHIST     * Histological Site (ICD10 Code)
          CALL      UPPTCRG1
          GOTO      UPDHED99
.
.  *Update Multiple Primaries an LOS in NZ for NZ screens
.
UPDHED90  PACK      KEY8,ADMISSNO,SP70   
          CALL      RDPTCRG1
          BRANCH    OVRCD,UPDHED99
.
          MATCH     "1",PTCRG001
          IF        @EQUAL
            MOVE      ONE,PTCRMULT
          ELSE
            MOVE      ZERO,PTCRMULT
          ENDIF
.    
          MOVE      PTCRG002,PTCRSTAY     * LOS in NZ  
.
          CALL      UPPTCRG1
          GOTO      UPDHED99
.
UPDHED99  RETURN
.-------------------------------------------------------------------------------
.     Delete Cancer Registration Header Record
.     Only delete header records if all registrations are deleted!
.-------------------------------------------------------------------------------
DELHED00  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPTCRD1
          CALL      RKPTCRD1
          BRANCH    OVRCD,DELHED10
.
          MATCH     ADMISSNO,DPTCDDAD     * Match on Admission No
          GOTO      DELHED10 IF NOT EQUAL
.
          GOTO      DELHED99              * Registration found do not delete  
.
DELHED10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTCRG1
          BRANCH    OVRCD,DELHED99
.
          CALL      DEPTCRG1              * Delete Header Record
.
DELHED99  RETURN
.-------------------------------------------------------------------------------
.     Get new Registration next no                                    *C-273546
.-------------------------------------------------------------------------------
GENCAN00  MOVE      ZERO,PTCRD002
          PACK      KEY25,ADMISSNO,Z70    * Read Cancer Reg Details File
          CALL      RSPTCRD1
GENCAN10  CALL      RPPTCRD1
          BRANCH    OVRCD,GENCAN90
.
          MATCH     ADMISSNO,DPTCDDAD     * Match on Admission No
          GOTO      GENCAN90 IF NOT EQUAL
.
          COMPARE   PTCDCNRG,PTCRD002
          IF        @LESS
            MOVE      PTCDCNRG,PTCRD002   * find the highest PTCDCNRG Reg.No.
          ENDIF
          GOTO      GENCAN10
.
GENCAN90  ADD       ONE,PTCRD002          * add "one" to generate new Reg.No.
.
GENCAN99  RETURN
.
.-------------------------------------------------------------------------------
.     Save Cancer Registration Details
.-------------------------------------------------------------------------------
...       see       PATCDRTM.PBL
.
.-------------------------------------------------------------------------------
.     Clear Cancer Registration Details
.-------------------------------------------------------------------------------
CLRCRG00  MOVE      SP70,PTCRMULT      * Multiple Primaries   
          MOVE      ZERO,PTCRSTAY      * LOS in NZ  
          MOVE      "0",PTCRVERT       * Converted Record                   
          MOVE      SP70,PTCRPRIM      * Primary Site
          MOVE      SP70,PTCRHIST      * Primary Site
.
CLRCRG99  RETURN
.-------------------------------------------------------------------------------
.     Clear Cancer Registration Details
.-------------------------------------------------------------------------------
...       see       PATCRDTM.PBL
.
.-------------------------------------------------------------------------------
.         Set Coding Period Dates for either Episode Coding or Admission Coding
.                   ( CPDATS00 Removed to WEBGROUP.PBL)               *D-266421
.-------------------------------------------------------------------------------
.
.-------------------------------------------------------------------------------
. Read Staionary Header File as CNPRN000 uses file vars
.-------------------------------------------------------------------------------
CNHED000  MOVE      ZERO,EXIT                     * initialize exit flag
.
          PACK      KEY6,STATNCOD,SP70
          CALL      RDIBTH1
          BRANCH    OVRCD,CNHED900
.
          GOTO      CNHED999
.
CNHED900  CLEAR     WEBTITLE 
          MOVE      "Stationery Code not on File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT                   * Stat. code not on file
.
CNHED999  RETURN
+
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD10,PROFLD30,PROFLD99,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD80,PROFLD90
.
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000    * Discharge File Info
          GOTO      PROFLD99
.
PROFLD14  CALL      MRTL0000    * Intensive Care Info
          GOTO      PROFLD99
.
PROFLD15  CALL      MRTS0000    * Various Options
          GOTO      PROFLD99
.
PROFLD16  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD17  CALL      VSXD0000    * Visit Extra data
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37,PROFLD38
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD32  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD33  CALL      DSCF0000    * Discharge File Info
          GOTO      PROFLD99
.
PROFLD34  CALL      MRTS0000    * Various Options
          GOTO      PROFLD99
.
PROFLD35  CALL      SUMM0000    * Coding Summary Info
          GOTO      PROFLD99
.
PROFLD36  CALL      GRPR0000    * Grouper Details 
          GOTO      PROFLD99
.
PROFLD37  CALL      MRTL0000    * Intensive Care Info
          GOTO      PROFLD99
.
PROFLD38  CALL      CODCOM00    * Coding Comments
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      MRDET000                * MR Details                
          GOTO      PROFLD99
.
PROFLD52  CALL      MRMF0000                * MR Master Details 
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84,PROFLD85
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD82  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD83  CALL      DSCF0000    * Discharge File Info
          GOTO      PROFLD99
.
PROFLD84  CALL      MRTS0000    * Various Options
          GOTO      PROFLD99
.
PROFLD85  CALL      CANC0000    * Cancer Coding Options (in PATCRDTM)
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD92  CALL      CCAE0000    * CCA Errors
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. CCAE0000 - Web Server Errors
.------------------------------------------------------------
CCAE0000  BRANCH    FLDITMNO,CCAE0100,CCAE0200,CCAE0300,CCAE0400,CCAE0500:
                             CCAE0600,CCAE0700,CCAE0800,CCAE0900,CCAE1000:
                             CCAE1100,CCAE1200,CCAE1300,CCAE1400,CCAE1500:
                             CCAE1600,CCAE1700,CCAE1800,CCAE1900,CCAE2000:
                             CCAE2100
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      CCAE9999
.
CCAE0100  CALL      NXTPER00
          GOTO      CCAE9999
.
CCAE0200  CALL      PREPER00
          GOTO      CCAE9999
.
CCAE0300  CALL      CURSTD00
          GOTO      CCAE9999
.
CCAE0400  CALL      CUREND00
          GOTO      CCAE9999
.
CCAE0500  CALL      CURYR000
          GOTO      CCAE9999
.
CCAE0600  CALL      CURMON00
          GOTO      CCAE9999
.
CCAE0700  CALL      SELV0000
          GOTO      CCAE9999
.
CCAE0800  CALL      ETABH000        * Table of Errors (hospital level)
          GOTO      CCAE9999
.
CCAE0900  WRITE     HTMLFILE;SHOWPROC;
          GOTO      CCAE9999
.
CCAE1000  MATCH     SP70,MRCEDATE
          GOTO      CCAE9999 IF EQUAL
          UNPACK    MRCEDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     "00",CDAY
          GOTO      CCAE9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      CCAE9999
.
CCAE1100  MATCH     SP70,MRCETIME
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCETIME;
          GOTO      CCAE9999
.
CCAE1200  MATCH     SP70,MRCEURNO
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEURNO;
          GOTO      CCAE9999
.
CCAE1300  MATCH     SP70,MRCEVISN
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEVISN;
          GOTO      CCAE9999
.
CCAE1400  MATCH     SP70,MRCEFNAM
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEFNAM;
          GOTO      CCAE9999
.
CCAE1500  MATCH     SP70,MRCEERRM
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEERRM;
          GOTO      CCAE9999
.
CCAE1600  MATCH     SP70,MRCEPROC
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEPROC;
          GOTO      CCAE9999
.
CCAE1700  MATCH     SP70,MRCEUFAP
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEUFAP;
          GOTO      CCAE9999
.
CCAE1800  MATCH     SP70,MRCEDFAP
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCEDFAP;
          GOTO      CCAE9999
.
CCAE1900  MATCH     SP70,MRCETFAP
          GOTO      CCAE9999 IF EQUAL
          WRITE     HTMLFILE;MRCETFAP;
          GOTO      CCAE9999
.
CCAE2000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CCAE9999
.
CCAE2100  CALL      ETABP000        * Table of Errors (patient level)
          GOTO      CCAE9999
.
CCAE9999  RETURN
+
.------------------------------------------------------------
. CCA Error Table (hospital level)
.------------------------------------------------------------
ETABH000  MOVE      ZERO,DISNUMB
          MOVE      ZERO,RECNUMB
          PACK      KEY24,LASTDATE,Z70
          CALL      RSMRCIE1
ETABH100  CALL      RPMRCIE1
          BRANCH    OVRCD,ETABH999
          MATCH     FRSTDATE,MRCEDATE
          GOTO      ETABH999 IF LESS
.
          IF        SHOWPROC <> 1
            MATCH     "1",MRCEPROC
            GOTO      ETABH100 IF EQUAL     * don't show processed errors
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ETABH100
          ENDIF
.
          CALL      EROWH000
.
          ADD       ONE,DISNUMB
          IF        DISNUMB<50
            GOTO      ETABH100
          ENDIF
.
          WRITE     HTMLFILE;"alert('Too Many Rows to Output. Use Filters');"
          WRITE     HTMLFILE;"viewMore('",RECNUMB,"');"
.
ETABH999  RETURN
+
.-----------------------------------------------------------
. Output CCA Error Row
.-----------------------------------------------------------
EROWH000  PACK      KEY24,MRCEDATE,MRCETIME,MRCEVISN,SP70
          PACK      KEY10,MRCEUFAP,SP70   * Read websec
          CALL      RDWBSE1
          IF        OVRCD=0
            MOVE      WBSENAM,KEY30
          ELSE
            MOVE      MRCEUFAP,KEY30
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",MRCEDATE,MRCETIME,"#",":
                             "#"",MRCEURNO,"#",":
                             "#"",MRCEVISN,"#",":
                             "#"",MRCEFNAM,"#",":
                             "#"",MRCEERRM,"#",";
          MATCH     "1",MRCEPROC
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox":
                               " name=ccaerrky id=ccaerrky":
                               " onclick='submitcheck(this);'":
                               " value='",KEY24,"'>#",";
          ELSE
            WRITE     HTMLFILE;"#"&nbsp#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY30,"#",":
                             "#"",MRCEDFAP,MRCETFAP,"#"";
.
          WRITE     HTMLFILE;");"
EROWH999  RETURN
+
.------------------------------------------------------------
. CCA Error Table (patient level)
.------------------------------------------------------------
ETABP000  MOVE      ZERO,RECNUMB
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSMRCIE2
ETABP100  CALL      RPMRCIE2
          BRANCH    OVRCD,ETABP999
.
          MATCH     ADMISSNO,MRCEVISN
          GOTO      ETABP100 IF NOT EQUAL
.
          CALL      EROWH000
.
          ADD       ONE,RECNUMB
          IF        RECNUMB<50
            GOTO      ETABP100
          ENDIF
.
          WRITE     HTMLFILE;"alert('Too Many Rows to Output. Use Filters');"
.
ETABP999  RETURN
+
.--------------------------------------------------------------------------
. Option 8 - Cancer Coding             
.--------------------------------------------------------------------------
...       see       PATCRDTM.PBL
.
.------------------------------------------------------------
. Miscellaneous outputs
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600
          GOTO      MISC9999
.
MISC0100  READ      CONTROLF,HUND09;*195,PTCNACAS
          LOAD      CATEGORY,PTCNACAS,CATD1,CATD2,CATD3,CATD4,CATD5:
                                      CATU6,CATU7
.
          LOAD      CODE,PTCNACAS,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5:
                                  AUSR6,AUSR7
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0200  MOVE      ZERO,FORM8
          DAYSEP    PBDATE,ADATE,FORM8
          COMPARE   "18250",FORM8
          IF        !@LESS
            WRITE     HTMLFILE;ONE;              * > than 50 yrs old
          ELSE
            WRITE     HTMLFILE;ZERO;             * < than 50 yrs old
          ENDIF
          GOTO      MISC9999
.
MISC0300  WRITE     HTMLFILE;MRCNDFPR;
          GOTO      MISC9999
.
MISC0400  CALL      GPR10000
          GOTO      MISC9999
.
MISC0500  CALL      GPR20000
          GOTO      MISC9999
.
MISC0600  CALL      GPR30000
          GOTO      MISC9999
.
MISC9999  RETURN
.------------------------------------------------------------
. Table of Reason for Clinical Diagnosis         
.------------------------------------------------------------
LSTRCD00  MOVE      ZERO,F1
          CALL      HEDRCD00      * Output Table Heading
.
          MOVE      ADMISSNO,PMCDG001
          PACK      KEY29,PMCDG001,PMCDG002,PMCDG003,SP70
          CALL      RSPMCDG1
LSTRCD10  CALL      RKPMCDG1
          BRANCH    OVRCD,LSTRCD99
.
          MATCH     PMCGADNO,PMCDG001            * same admisson number
          GOTO      LSTRCD99 IF NOT EQUAL
.
          COMPARE   PMCGCNRG,PMCDG002            * same registration number
          GOTO      LSTRCD99 IF NOT EQUAL
.
          MATCH     PMCGPRMM,PMCDG003            * same primary site
          GOTO      LSTRCD99 IF NOT EQUAL
.
          IF        F1 = 0 & PMCGBSDG > 5
            MOVE      ONE,F1
            CALL      HEDRCD00
          ENDIF
.
          CALL      ROWRCD00      * Display Row
          GOTO      LSTRCD10 
.
LSTRCD99  CALL      HEDEND00
          RETURN
.------------------------------------------------------------
. Reason for Clinical Diagnosis       (TABLE HEADING)
.------------------------------------------------------------
HEDRCD00  IF        F1 = 0
            WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=25%>":
                               "Basis for Diagnosis</td>":
                               "<td class=HeadingCell width=25%>":
                               "Reason Code</td>":
                               "<td class=HeadingCell width=50%>":
                               "Reason Text</td>":
                             "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr>":
                                 "<td class=HeadingCell width=25%>":
                                 "Basis for Diagnosis</td>":
                                 "<td class=HeadingCell width=25%>":
                                 "Laboratory Code</td>":
                                 "<td class=HeadingCell width=50%>":
                                 "Specimen No.</td>":
                               "</tr>"
          ENDIF
.
HEDRCD99  RETURN
+
HEDEND00  MOVE      ZERO,F1
...       WRITE     HTMLFILE;"<tr>":
...                            "<td class=HeadingCell width=25%>":
...                            "&nbsp;</td>":
...                            "<td class=HeadingCell width=25%>":
...                            "&nbsp;</td>":
...                            "<td class=HeadingCell width=50%>":
...                            "&nbsp;</td>":
...                          "</tr>"
.
HEDEND99  RETURN
+
.------------------------------------------------------------
. Reason for Clinical Diagnosis       (TABLE ROW)
.------------------------------------------------------------
ROWRCD00  MOVE      UNKNOWN,DIM25
          LOAD      DIM25,PMCGBSDG,BASDCLIN,UNKNOWN,BASDIMAG,BASDENDO:
                                   UNKNOWN,BASDCYTO,BASDMETA,BASDPRIM:
                                   BASDAUTO
.
          MOVE      UNKNOWN,DIM35
          IF        PMCGBSDG < 6
            LOAD      DIM35,PMCGCDIG,CDPALLAT,CDDOCREF,CDPATHOL,CDRADIOL:
                                   CDOTHERN,CDINVASI,CDNONCAN,UNKNOWN:
                                   CDOTHERC
          ELSE
            LOAD      DIM35,PMCGCDIG,CDLAUSLL,CDLSANDN,CDLQMLLA,CDLPRIVL:
                                   CDLOTHER
          ENDIF
.
          MATCH     SP70,PMCGCDDS
          IF        @EQUAL
            MOVE      "&nbsp;",PMCGCDDS
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF=#"javascript:DeleteRecord":
                             "('",PMCGADNO,"','",PMCGCNRG,"','",PMCGBSDG,"',":
                             "'",PMCGCDIG,"');#">":
                             "<img src=../images/DeleteIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DIM25,"</td>":
                             "<td>",DIM35,"</td>":
                             "<td>",PMCGCDDS,"</td>":
                             "</tr>"
.
ROWRCD99 RETURN
.--------------------------------------------------------------------------
. Option 3 - Grouper Details           
.--------------------------------------------------------------------------
GRPR0000  BRANCH    FLDITMNO,GRPR0100,GRPR0200,GRPR0300,GRPR0400,GRPR0500:
                             GRPR0600,GRPR0700,GRPR0800,GRPR0900,GRPR1000:
                             GRPR1100,GRPR1200,GRPR1300,GRPR1400,GRPR1500:
                             GRPR1600,GRPR1700,GRPR1800,GRPR1900,GRPR2000:
                             GRPR2100,GRPR2200,GRPR2300,GRPR2400,GRPR2500:
                             GRPR2600,GRPR2700,GRPR2800,GRPR2900,GRPR3000:
                             GRPR3100,GRPR3200,GRPR3300,GRPR3400,GRPR3500:
                             GRPR3600,GRPR3700,GRPR3800,GRPR3900,GRPR4000:
                             GRPR4100,GRPR4200,GRPR4300,GRPR4400,GRPR4500
          GOTO      GRPR9999
.
GRPR0100  WRITE     HTMLFILE;DPTPGADM;  * Admissno No            
          GOTO      GRPR9999
.
GRPR0200  WRITE     HTMLFILE;DPTPGEPN;  * Episode No                    
          GOTO      GRPR9999
.
GRPR0300  WRITE     HTMLFILE;PTPGGPVR;  * Grouper Version (unformatted eg "051")
          GOTO      GRPR9999
.
GRPR0400  MOVE      PTPGNDRG,DDRGCODE   * National DRG 
          MOVE      DRGVERZ,DRGVER                                    *I-147943
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
                                        *         Low Trim (.2), High Trim (.3)
          GOTO      GRPR9999
.
GRPR0500  WRITE     HTMLFILE;PTPGNMDC;  * National MDC                  
          GOTO      GRPR9999
.
GRPR0600  WRITE     HTMLFILE;PTPGNWGT;  * National Weight               
          GOTO      GRPR9999
.
GRPR0700  WRITE     HTMLFILE;PTPGNALS;  * National average LOS              
          GOTO      GRPR9999
.
GRPR0800  MOVE      PTPGSDRG,DDRGCODE   * State DRG                     
          MOVE      DRGVERZ,DRGVER                                    *I-147943
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
GRPR0900  WRITE     HTMLFILE;PTPGSMDC;  * State MDC                     
          GOTO      GRPR9999
.
GRPR1000  WRITE     HTMLFILE;PTPGSWGT;  * State Weight               
          GOTO      GRPR9999
.
GRPR1100  WRITE     HTMLFILE;PTPGSALS;  * State average LOS               
          GOTO      GRPR9999
.
GRPR1200  MOVE      PTPGLDRG,DDRGCODE   * Local DRG                     
          MOVE      DRGVERZ,DRGVER                                    *I-147943
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
GRPR1300  WRITE     HTMLFILE;PTPGLMDC;  * Local MDC                     
          GOTO      GRPR9999
.
GRPR1400  WRITE     HTMLFILE;PTPGLWGT;  * Local Weight               
          GOTO      GRPR9999
.
GRPR1500  WRITE     HTMLFILE;PTPGLALS;  * Local average LOS             
          GOTO      GRPR9999
.
GRPR1600  WRITE     HTMLFILE;PTPGPCCL;  * Patient CC class level        
          GOTO      GRPR9999
.
GRPR1700  WRITE     HTMLFILE;PTPGWFIX;  * WIES value fixed              
          GOTO      GRPR9999
.
GRPR1800  WRITE     HTMLFILE;PTPGWVAR;  * WIES value variable           
          GOTO      GRPR9999
.
GRPR1900  WRITE     HTMLFILE;PTPGWTOL;  * WIES value total              
          GOTO      GRPR9999
.
GRPR2000  WRITE     HTMLFILE;PTPGWWTU;  * WIES weight used              
          GOTO      GRPR9999
.
GRPR2100  WRITE     HTMLFILE;PTPGWWTD;  * WIES weight description       
          GOTO      GRPR9999
.
GRPR2200  WRITE     HTMLFILE;PTPGNDRG;  * National DRG Code
          GOTO      GRPR9999
.
GRPR2300  WRITE     HTMLFILE;PTPGSDRG;  * State DRG Code
          GOTO      GRPR9999
.
GRPR2400  WRITE     HTMLFILE;PTPGLDRG;  * Local DRG Code
          GOTO      GRPR9999
.
GRPR2500  MOVE      PTPGNDRG,DDRGCODE   * National DRG                  
          CALL      WIES0000            * Display Wies Information
          GOTO      GRPR9999
.
GRPR2600  MOVE      PTPGSDRG,DDRGCODE   * State DRG                  
          CALL      WIES0000            * Display Wies Information
          GOTO      GRPR9999
.
GRPR2700  MOVE      PTPGLDRG,DDRGCODE   * Local DRG                  
          CALL      WIES0000            * Display Wies Information
          GOTO      GRPR9999
. 
GRPR2800  MOVE      PTPGGPVR,DRGVER     * Set Patient DRGVER Grouper Vers. No.  
          CALL      GRPDIS00            * Formatted Grouper Ver.No. (eg. "5.1") 
          GOTO      GRPR9999
.
GRPR2900  WRITE     HTMLFILE;HIHLOS;   * HITH Length of Stay
          GOTO      GRPR9999
.
GRPR3000  MOVE      DRGCODHS,DDRGCODE   * Hospital default DRG Code/Description
          MOVE      DRGVERHS,DRGVER
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
.                                                                     *I-147943
GRPR3100  MOVE      DRGVERHS,DRGVER     * Set Hospital default Grouper Ver No.
          CALL      GRPDIS00            * Formatted Grouper Ver.No. (eg. "5.1")
          GOTO      GRPR9999
.
.                                                                     *I-147943
GRPR3200  MOVE      DRGCODHF,DDRGCODE   * Health Fund DRG Code/Description
          MOVE      DRGVERHF,DRGVER
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.                                                                     *I-147943
GRPR3300  MOVE      DRGVERHF,DRGVER     * Set Health Fund Grouper Version No.
          CALL      GRPDIS00            * Formatted Grouper Ver.No. (eg. "5.1")
          GOTO      GRPR9999
.
GRPR3400  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            CALL      GDRG0000          * Get drg based on discharge date
            MOVE      DRGVERS,DRGVER    * State default Grouper version
          ENDIF
          MOVE      PTPGNDRG,DDRGCODE   * National DRG
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
GRPR3500  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            CALL      GDRG0000          * get drg based on discharge date
            MOVE      DRGVERS,DRGVER
          ENDIF
          MOVE      PTPGSDRG,DDRGCODE   * State DRG
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
GRPR3600  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            CALL      GDRG0000          * get drg based on discharge date
            MOVE      DRGVERS,DRGVER
          ENDIF
          MOVE      PTPGLDRG,DDRGCODE   * Local DRG
          CALL      DISDRG00            * Display DRG Descrip. (.0), Code (.1)
          GOTO      GRPR9999
.
GRPR3700  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            MOVE      DRGVERS,DRGVER    * Grouper version based on disch.date
          ENDIF
          CALL      GRPDIS00            * Formatted Grouper Ver.No. (eg. "7.0")
          GOTO      GRPR9999
.
GRPR3800  MATCH     "1",PTCNDGED
          GOTO      GRPR3810 IF EQUAL
.
          CALL      GDRG0000            * Get drg based on discharge date
          MATCH     DRGVERS,PTCNDGPV    * Discharge grouper version same as
                                        * Default Grouper Version ?
          IF        !@EQUAL
            MOVE      PTPGNDRG,DDRGCODE * National DRG
            MOVE      PTPGGPVR,DRGVER
            CALL      DISDRG00          * Display DRG Descrip. (.0), Code (.1)
          ELSE
            UNPACK    DIM127,DIM1,KEY1,DIM127
            WRITE     HTMLFILE;"";
          ENDIF
          GOTO      GRPR9999
.
GRPR3810  UNPACK    DIM127,DIM1,KEY1,DIM127
          WRITE     HTMLFILE;"";
          GOTO      GRPR9999
.
GRPR3900  MATCH     "1",PTCNDGED
          GOTO      GRPR3910 IF EQUAL
.
          CALL      GDRG0000            * Get drg based on discharge date
          MATCH     DRGVERS,PTCNDGPV    * Discharge grouper version same as
                                        * Default Grouper Version ?
          IF        !@EQUAL
            MOVE      PTPGNDRG,DDRGCODE * National DRG
            CALL      WIES0000          * Display Wies Information
          ELSE
            UNPACK    DIM127,DIM1,KEY1,DIM127
            WRITE     HTMLFILE;"";
          ENDIF
          GOTO      GRPR9999
.
GRPR3910  UNPACK    DIM127,DIM1,KEY1,DIM127
          WRITE     HTMLFILE;"";
          GOTO      GRPR9999
.
GRPR4000  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            CALL      GDRG0000            * Get drg based on discharge date
            MOVE      DRGVERS,DRGVER      * Grouper version based on disch.date
          ENDIF
          CALL      GRPDIS00            * Formatted Grouper Ver.No. (eg. "7.0")
          GOTO      GRPR9999
.
GRPR4100  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERHS,DRGVER
          ELSE
            MOVE      PTCNDGPV,DRGVER
          ENDIF
          MOVE      DRGCODHS,DDRGCODE
          CALL      DRGDES00
          GOTO      GRPR9999
.
GRPR4200  PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1       * Read a health fund file record
          MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERHF,DRGVER
          ELSE
            MOVE      PTHFGRPV,DRGVER
          ENDIF
          MOVE      DRGCODHF,DDRGCODE
          CALL      DRGDES00
          GOTO      GRPR9999
.
GRPR4300  MATCH     "1",PTCNDGED
          IF        @EQUAL
            MOVE      DRGVERZ,DRGVER
          ELSE
            CALL      GDRG0000             * Get drg based on discharge date
            MOVE      DRGVERS,DRGVER       * State default Grouper version
          ENDIF
          MOVE      PTPGSDRG,DDRGCODE      * State DRG
          CALL      DRGDES00
          GOTO      GRPR9999
.
GRPR4400  WRITE     HTMLFILE;PTPGECRW;     * ECCS Raw Format
          GOTO      GRPR9999
.
GRPR4500  CALL      NWAU0000               * NWAU
          GOTO      GRPR9999
.
GRPR9999  RETURN
+
.------------------------------------------------------------------------------
.         Display NWAU for ABF patient
.------------------------------------------------------------------------------
NWAU0000  MATCH     "1",PTCNUABF
          GOTO      NWAU9000 IF NOT EQUAL  * Not using ABF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,NWAU9000
          MATCH     "A",TCINDC2
          GOTO      NWAU9000 IF NOT EQUAL
.
.         Firt try with a blank invoice number for Next invoice
.
          OPEN      PMSABFA3,"pmsabfaf"
          OPEN      PATINVR1,"patinvrf"
.
          MOVE      "053",KEY3             * 053 for NWAU
          PACK      KEY19,ADMISSNO,KEY3,SP70
          CALL      RDPMABF3
          COMPARE   ZERO,OVRCD
          GOTO      NWAU8000 IF EQUAL
.
NWAU2000  CALL      RKPMABF3
          BRANCH    OVRCD,NWAU9000
          MATCH     ADMISSNO,PMABADMN
          GOTO      NWAU9000 IF NOT EQUAL  * different admission number
          MATCH     "053",PMABADJT
          GOTO      NWAU9000 IF NOT EQUAL
.
          MOVE      PMABINVN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,NWAU2000
          MATCH     "1",PTINCRST
          GOTO      NWAU2000 IF EQUAL      * Credit note
          MATCH     "2",PTINCRST
          GOTO      NWAU2000 IF EQUAL      * Credit note
.
NWAU8000  WRITE     HTMLFILE;PMABADJV      * Adjustment value
          GOTO      NWAU9999
.
NWAU9000  WRITE     HTMLFILE;"";
NWAU9999  RETURN
+
.------------------------------------------------------------------------------
.         Checks if a record exists in patpgraf for the corresponding admno,
.         episode no. & DRG version.
.------------------------------------------------------------------------------
CHKPGR00  MOVE      ZERO,EXIT
          PACK      KEY13,AADMNO,EPSCD001,DRGVER
          CALL      RDPTPGR1
          BRANCH    OVRCD,CHKPGR91
.
          GOTO      CHKPGR99
.
CHKPGR91  MOVE      ONE,EXIT
CHKPGR99  RETURN
+
.------------------------------------------------------------------------------
.         Displays the DRG code/Version info in a formatted way
.           i.e. "DRG/VER - DRG code description"
.
.         Parameters:
.           DDRGCODE - DRG code
.           DRGVER   - DRG version (e.g. "070")
.------------------------------------------------------------------------------
DRGDES00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
.
          CALL      CHKPGR00
          BRANCH    EXIT,DRGDES91
.
          BRANCH    F1,DRGDES10             * Wies output tag?
.
          PACK      DIM127,DOT,KEY1,SP70
          WRITE     HTMLFILE;DDRGCODE,"/";
          CALL      GRPDIS00
          WRITE     HTMLFILE;" - ";
          CALL      DISDRG00
          GOTO      DRGDES99
.
DRGDES10  WRITE     HTMLFILE;DDRGCODE,"/";
          CALL      GRPDIS00
          WRITE     HTMLFILE;" - ";
          CALL      WIES0000
          GOTO      DRGDES99
.
DRGDES91  IF        F1=1
            UNPACK    DIM127,DIM1,KEY1,DIM127    * Wies tag
          ENDIF
          WRITE     HTMLFILE;"No matching DRG in patient grouping record for ":
                             "DRG ";
          CALL      GRPDIS00                * print DRG version (eg "7.0")
DRGDES99  RETURN
+
.-----------------------------------------------------------
. Option 1 - Intensive Care Information
.-----------------------------------------------------------
MRTL0000  BRANCH    FLDITMNO,MRTL0100,MRTL0200,MRTL0300,MRTL0400,MRTL0500:
                             MRTL0600,MRTL0700,MRTL0800,MRTL0900,MRTL1000:
                             MRTL1100,MRTL1200,MRTL1300,MRTL1400,MRTL1500:
                             MRTL1600,MRTL1700,MRTL1800,MRTL1900,MRTL2000:
                             MRTL2100,MRTL2200,MRTL2300,MRTL2400,MRTL2500:
                             MRTL2600,MRTL2700,MRTL2800,MRTL2900,MRTL3000:
                             MRTL3100
          GOTO      MRTL9999
.
MRTL0100  COMPARE   ZERO,PTICUINT
          GOTO      MRTL9999 IF EQUAL
          WRITE     HTMLFILE;PTICUINT;  * Hours In Intensive Care
          GOTO      MRTL9999
.
MRTL0200  COMPARE   ZERO,PTICUCCU 
          GOTO      MRTL9999 IF EQUAL
          WRITE     HTMLFILE;PTICUCCU;  * Hours in Critical Care        
          GOTO      MRTL9999
.
MRTL0300  COMPARE   ZERO,PTICUMEC
          GOTO      MRTL9999 IF EQUAL
          WRITE     HTMLFILE;PTICUMEC;  * Hours in Mechanical Ventilator
          GOTO      MRTL9999
.
MRTL0400  MOVE      PMVXIRAD,CODE       * Intention To Readmit
          MOVE      "VR",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL0500  MOVE      PMVXCSNG,CODE       * Coder Snag
          MOVE      "VN",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL0600  MOVE      MRPDSTAT,CODE       * PDT Status
          MOVE      "CP",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL0700  MOVE      PMVXRCCT,CODE       * Reason for Critical care transfer
          MOVE      "VJ",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL0800  COMPARE   ZERO,PTICHNCU 
          GOTO      MRTL9999 IF EQUAL
          WRITE     HTMLFILE;PTICHNCU;  * Hours in NCU
          GOTO      MRTL9999
.
MRTL0900  WRITE     HTMLFILE;PTCNICUT;  * Checking ICU/NCU Bed 0=No 1=Yes
          GOTO      MRTL9999
.
MRTL1000  CALL      ICUBED00   * Output indicator if ICU/CCU/NCU/SCN Bed Found
          GOTO      MRTL9999
.
MRTL1100  MOVE      PMVXUREA,CODE       * Unplanned readmission
          MOVE      "KO",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL1200  MOVE      PMVXUVTH,CODE       * Unplanned visit to theatre
          MOVE      "KB",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL1300  COMPARE   ZERO,PTICCPAP
          GOTO      MRTL9999 IF EQUAL
          WRITE     HTMLFILE;PTICCPAP;  * Hours in Constant Positive Air
          GOTO      MRTL9999
.
MRTL1400  WRITE     HTMLFILE;PTICAMBN;
          GOTO      MRTL9999
.
MRTL1500  MOVE      "LS",CATEGORY             * Mental Health Legal status
          PACK      CODE,PMVXMHLS,SP70
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL1600  CALL      CPSY0000                  * check for psych stay
          GOTO      MRTL9999
.
MRTL1700  MATCH     SP70,PMVXCPDD
          GOTO      MRTL9999 IF EQUAL
          GOTO      MRTL9999 IF EOS
          UNPACK    PMVXCPDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTL9999
.
MRTL1800  WRITE     HTMLFILE;PTICINTM;  * Mins In Intensive Care
          GOTO      MRTL9999
.
MRTL1900  WRITE     HTMLFILE;PTICMECM;  * Mins In Mechanical Ventilator
          GOTO      MRTL9999
.
MRTL2000  CALL      CCCHK000
          GOTO      MRTL9999
.
MRTL2100  WRITE     HTMLFILE;PVITYPE;   * Visit Type
          GOTO      MRTL9999
.
MRTL2200  CALL      CKMV0000            * Check Mechanical Ventilation record
          GOTO      MRTL9999
.
MRTL2300  WRITE     HTMLFILE;PSAGEDAY;  * Patient age days
          GOTO      MRTL9999
.
MRTL2400  MOVE      PMVXUDF6,CODE       * Prev.Specialised Treatment
          MOVE      "YE",CATEGORY
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL2500  MOVE      ADMISSNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,RHIN9999
.
          CALL      CHLD0000              * Check current status of Hold invoice
          MOVE      ZERO,F1
          MATCH     SP70,PTIPRHLD          * Reason for hold (cat rh)
          GOTO      MRTL2520 IF EQUAL
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,MRTL2520
          MATCH     "C",TCINDC3
          GOTO      MRTL2520 IF NOT EQUAL  * Reason On Hold not to be displayed
          MOVE      ONE,F1
MRTL2520  WRITE     HTMLFILE;F1;
          GOTO      MRTL9999
.
MRTL2600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      RHIN0000              * Check Reason for holding invoice
          BRANCH    F1,MRTL2620           * display full description
          GOTO      MRTL2640
.
MRTL2620  MATCH     SP70,PTIPRDES
          GOTO      MRTL2640 IF EQUAL
          WRITE     HTMLFILE;PTIPRDES;
          GOTO      MRTL9999
.
MRTL2640  WRITE     HTMLFILE;KEY30;
          GOTO      MRTL9999
.
MRTL2700  MOVE      ADMISSNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,RHIN9999
          CALL      CHLD0000              * Check current status of Hold invoice
.
          MOVE      "rh",CATEGORY         * Reason for Hold
          MOVE      PTIPRHLD,CODE
          CALL      CODITM00
          GOTO      MRTL9999
.
MRTL2800  WRITE     HTMLFILE;PTICCHSC;
          GOTO      MRTL9999
.
MRTL2900  MOVE      ZERO,F1
          MATCH     SP70,ACARE
          IF        !@EQUAL
            MOVE      "CC",KEY2
            PACK      KEY5,KEY2,ACARE
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "11",PTCDUDF6
              IF        @EQUAL
                MOVE      ONE,F1              * Mental Health Care
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      MRTL9999
.
MRTL3000  MOVE      "004",VSXDTYDA           * 004 = AMHCC End code
          PACK      KEY11,ADMISSNO,VSXDTYDA,SP70
          CALL      RDVSXDC1
          IF        OVRCD=0
            WRITE     HTMLFILE;"Update";
          ELSE
            WRITE     HTMLFILE;"Add";
          ENDIF
          GOTO      MRTL9999
.
MRTL3100  CALL      CVSCM000
          GOTO      MRTL9999
.
MRTL9999  RETURN
+
.*******************************************************************************
.           Check Status of Hold invoice
.*******************************************************************************
CHLD0000  MATCH     SP70,PTIPRHLD
          GOTO      CHLD0200 IF EQUAL      * not on hold
.
.         Invoice already on hold, check for Patient hold invoice
.
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,CHLD0200
.
          MATCH     "P",TCINDC2
          GOTO      CHLD9999 IF EQUAL             * Patient hold invoice
.
          MATCH     "C",TCINDC4
          GOTO      CHLD9999 IF EQUAL             * CodeFocus hold invoice
.
CHLD0200  UNPACK    SP70,PENDHOSP,PENDDDAT,PENDCLAM,PENDFUND
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,PENDHOSP            * hospital id
          ENDIF
          MOVE      ZERO,F2
          MOVE      IPSYSTM,F2
          MOVE      F2,PENDSYST                    * system
.
          MOVE      ADATE,PENDADAT               * Admission date
          MOVE      ADATE,PENDSDAT               * as at date
          MOVE      ACLAIM,PENDCLAM              * claim code
          MOVE      AFUNDH,PENDFUND              * health fund
          IF        ASTAT=3
            MOVE      DDATE,PENDDDAT             * discharge date
          ENDIF
          CALL      IPRH0000
          CALL      UPIPEN1                        * Update Hold Invoice status
.
CHLD9999  RETURN
+
.------------------------------------------------------------
.         Reason for Holding invoice
.------------------------------------------------------------
RHIN0000  MOVE      "&nbsp;",KEY6
          PACK      KEY30,KEY6,SP70
          MOVE      SP70,PTIPRDES
.
          MOVE      ADMISSNO,KEY8
          CALL      RDIPEN1
          BRANCH    OVRCD,RHIN9999
.
          BRANCH    F1,RHIN2000            * get free format reason for hold
.
          MATCH     SP70,PTIPRHLD
          GOTO      RHIN1000 IF EQUAL      * No reason for holding code
          MOVE      "rh",KEY2
          PACK      KEY5,KEY2,PTIPRHLD
          CALL      RDCODE1
          BRANCH    OVRCD,RHIN1000
          PACK      KEY30,TDESC,SP70
          GOTO      RHIN9999
.
RHIN1000  COMPARE   TWO,F1
          GOTO      RHIN9999 IF NOT EQUAL

RHIN2000  MATCH     SP70,PTIPRDES
          GOTO      RHIN9999 IF EQUAL
          PACK      KEY30,PTIPRDES,SP70    * Free format reason for holding
          GOTO      RHIN9999
.
RHIN9999  RETURN
+
.-----------------------------------------------------------
. Option 1 - Output Various Options 
.-----------------------------------------------------------
MRTS0000  BRANCH    FLDITMNO,MRTS0100,MRTS0200,MRTS0300,MRTS0400,MRTS0500:  
                             MRTS0600,MRTS0700,MRTS0800,MRTS0900,MRTS1000: *10 
                             MRTS1100,MRTS1200,MRTS1300,MRTS1400,MRTS1500:
                             MRTS1600,MRTS1700,MRTS1800,MRTS1900,MRTS2000: *20
                             MRTS2100,MRTS2200,MRTS2300,MRTS2400,MRTS2500:
                             MRTS2600,MRTS2700,MRTS2800,MRTS2900,MRTS3000: *30
                             MRTS3100,MRTS3200,MRTS3300,MRTS3400,MRTS3500:
                             MRTS3600,MRTS3700,MRTS3800,MRTS3900,MRTS4000: *40
                             MRTS4100,MRTS4200,MRTS4300,MRTS4400,MRTS4500:
                             MRTS4600,MRTS4700,MRTS4800,MRTS4900,MRTS5000: *50
                             MRTS5100,MRTS5200,MRTS5300,MRTS5400,MRTS5500:
                             MRTS5600,MRTS5700,MRTS5800,MRTS5900,MRTS6000: *60
                             MRTS6100,MRTS6200,MRTS6300,MRTS6400,MRTS6500:
                             MRTS6600,MRTS6700,MRTS6800,MRTS6900,MRTS7000: *70
                             MRTS7100,MRTS7200,MRTS7300,MRTS7400,MRTS7500:
                             MRTS7600,MRTS7700,MRTS7800,MRTS7900,MRTS8000: *80
                             MRTS8100,MRTS8200,MRTS8300,MRTS8400,MRTS8500:
                             MRTS8600,MRTS8700,MRTS8800
.
          GOTO      MRTS9999
.
MRTS0100  WRITE     HTMLFILE;CMDISP;  * Prefix for a Primary Diagnosis
          GOTO      MRTS9999
.
MRTS0200  WRITE     HTMLFILE;CMDISS;  * Prefix for a Sequela Diagnosis
          GOTO      MRTS9999
.
MRTS0300  WRITE     HTMLFILE;CMDISC;  * Prefix for a Complication Diagnosis
          GOTO      MRTS9999
.
MRTS0400  WRITE     HTMLFILE;CMDISA;  * Prefix for a Associated Diagnosis
          GOTO      MRTS9999
.
MRTS0500  WRITE     HTMLFILE;CMDISL;  * Prefix for disease responsible for
          GOTO      MRTS9999          * Length of Stay
.
MRTS0600  WRITE     HTMLFILE;CMDISD;  * Disability disease type 
          GOTO      MRTS9999         
.
MRTS0700  WRITE     HTMLFILE;CMOPRT;  * Post-Surgical operation type 
          GOTO      MRTS9999         
.
MRTS0800  WRITE     HTMLFILE;MRCNEPSC; * Episode Coding Used.  0=Not used 
          GOTO      MRTS9999         
.
MRTS0900  IF        PTCNADMT = 8  
            MOVE      PMVXIRAD,CODE    * Using Cat VR
            MOVE      "VR",CATEGORY
            CALL      CODITM00
          ENDIF
          GOTO      MRTS9999         
.
MRTS1000  PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MRTS9999          
.
          MOVE      ADATE,AGEDATE           * Now using Admission Date
          CALL      CALCAGE                 * Calculate age
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00                * Check if leap year
          COMPARE   ONE,PTCNHDPS
          GOTO      MRTS1150 IF EQUAL       * Different test for NZ - CAR 278601
.
          IF        PSAGEDAY < NOOFDAYS
            WRITE     HTMLFILE;"1";     * Display Admission Weight
          ELSE
            WRITE     HTMLFILE;"0";     * Do not Display Admission Weight
          ENDIF
          GOTO      MRTS9999
.                                                                     *C-227029
MRTS1150  IF        PSAGEDAY <= NOOFDAYS
            WRITE     HTMLFILE;"1";     * Display Admission Weight
          ELSE
            WRITE     HTMLFILE;"0";     * Do not Display Admission Weight
          ENDIF
          GOTO      MRTS9999         
.
MRTS1100  CALL      CODTMP00            * Automatic Coding Template select list
          GOTO      MRTS9999         
.
MRTS1200  MATCH     SP70,ABWGHT
          GOTO      MRTS9999 IF EQUAL         
          WRITE     HTMLFILE;ABWGHT;    * Admission Weight 
          GOTO      MRTS9999         
.
MRTS1300  WRITE     HTMLFILE;EPSCD001;  * Episode No. 
          GOTO      MRTS9999         
.
MRTS1400  MOVE      ZERO,DISPDTTM       * Do not display Coding Date and Time
          CALL      CODDAT00            * Output Coding Date and Time
          GOTO      MRTS9999         
.
MRTS1500  WRITE     HTMLFILE;PTCNOPHO; * Perform Operations at Different Hosps?
          GOTO      MRTS9999         
.
MRTS1600  READ      CONTROLF,FIFTY9;*218,PTMORBDT                     *I-207222
          WRITE     HTMLFILE;PTMORBDT; * Procedure Date 0=exist 1=none 2=mand.
          GOTO      MRTS9999           
.         
MRTS1700  READ      CONTROLF,FIFTY9;*85,CMORBDTM                      *I-207222
          WRITE     HTMLFILE;CMORBDTM; * Procedure Time 0=mand, 1=exist 2=none
          GOTO      MRTS9999
.
MRTS1800  CALL      SELEPS00           * Selection List of Episodes
          GOTO      MRTS9999         
.
MRTS1900  CALL      NEONAT00           * Set Noenate Indicator 
          GOTO      MRTS9999
.
MRTS2000  WRITE     HTMLFILE;CMDISM;  * Prefix for a Morphology Diagnosis
          GOTO      MRTS9999
.
MRTS2100  CALL      CODUSR00          * Output Coder User ID 
          GOTO      MRTS9999
.
MRTS2200  WRITE     HTMLFILE;PTCNHDPS; * State Flag 3=Victoria            
          GOTO      MRTS9999         
.
MRTS2300  MATCH     SP70,PBDATE        * Output Age at Admission
          GOTO      MRTS9999 IF EQUAL
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     "00",CDAY
          GOTO      MRTS9999 IF EQUAL
.
          CALL      IBACLOCK
          MOVE      ADATE,AGEDATE      * Admission date
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      WRTAGE00
          GOTO      MRTS9999
.
MRTS2400  IF        FLEXPENC=1
            WRITE     HTMLFILE;"none";
          ENDIF
          GOTO      MRTS9999
.
MRTS2500  MOVE      SP70,DEFLTHOS  
          MOVE      MRCNHLOC,DEFLTLOC     
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,DEFLTHOS
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD<>1
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DEFLTHOS
                MOVE      PTHSHLOC,DEFLTLOC
              ENDIF
            ENDIF
          ENDIF
.        
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTS2510
.
          WRITE     HTMLFILE;DEFLTHOS;
          GOTO      MRTS9999

MRTS2510  CALL      SELLOC00           * Selection list for destinations
          GOTO      MRTS9999
.
MRTS2600  PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE      
          CALL      CALCAGE           * Calculate age in Years
          IF        PSAGEYRS < TEN6
            WRITE     HTMLFILE;"1";   * Perform Intubation Checks
          ELSE
            WRITE     HTMLFILE;"0";   * Do not perform Intubation Checks
          ENDIF 
          GOTO      MRTS9999
.
MRTS2700  WRITE     HTMLFILE;MRCNGRUP; * Type of Grouper used- 0=Unix 1=PC
          GOTO      MRTS9999         
.
MRTS2800  WRITE     HTMLFILE;MRCNMECH; * 0 = Mech Warn, 1 = Mech Fatal Error 
          GOTO      MRTS9999         
.
MRTS2900  WRITE     HTMLFILE;MEDCD001; * Coding complete flag 
          GOTO      MRTS9999         
.
MRTS3000  PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MRTS9999          
.
          MOVE      ADATE,AGEDATE       * Using Admission Date calc age at adm
          CALL      CALCAGE             * Calculate age
          IF        PSAGEDAY < TEN      
            WRITE     HTMLFILE;"1";     * Display CPAP hrs 
          ELSE
            WRITE     HTMLFILE;"0";     * Do not Display CPAP
          ENDIF
          GOTO      MRTS9999         
.
MRTS3100  CALL      CTBH0000            * Calculate Total LOS Hrs 
          WRITE     HTMLFILE;TOTBEDHR; 
          GOTO      MRTS9999         
.
MRTS3200  WRITE     HTMLFILE;PTCNEDTE;  * Enter date for every "E" code
          GOTO      MRTS9999         
.
MRTS3300  WRITE     HTMLFILE;CFFMORB;   * Allow free format desc for Diag/Proc
          GOTO      MRTS9999
. 
MRTS3400  WRITE     HTMLFILE;DDATE;     * Discharge Date
          GOTO      MRTS9999
. 
MRTS3500  WRITE     HTMLFILE;PTCNOENC;  * Using Online Encoder 1/2=Yes 0=No
          GOTO      MRTS9999
.
MRTS3600  IF        PTCNOENC=0
            WRITE     HTMLFILE;"none";
          ENDIF
          GOTO      MRTS9999
. 
MRTS3700  MATCH     SP70,PTDSVOGU
          GOTO      MRTS9999 IF EQUAL
.
          MOVE      PTDSVOGU,DRGVER  * Set input var
          CALL      GRPDIS00         * Formatted Grouper Version Number
          GOTO      MRTS9999
.
MRTS3800  PACK      KEY18,ADMISSNO,Z70
          CALL      RSMRAUC2
          CALL      RPMRAUC2
          BRANCH    OVRCD,MRTS3890
.
          MATCH     ADMISSNO,MRACVISN
          GOTO      MRTS3890 IF NOT EQUAL
.
          UNPACK    MRACADTE,CCENT,CYEAR,CMON,CDAY   
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTS9999
.
MRTS3890  WRITE     HTMLFILE;"&nbsp;";
          GOTO      MRTS9999
.
MRTS3900  IF        MRCNGRUP=0 | MRCNGRUP=3
            WRITE     HTMLFILE;"none";   * 1=PC, 0=UNIX Grouper          *I-????
          ENDIF
          GOTO      MRTS9999
.
MRTS4000  CALL      DCMT0000           * Display coding comments
          GOTO      MRTS9999
.
MRTS4100  READ      CONTROLF,NINTY7;*174,MRCNCLIN                     *I-240103
          REP       " 0",MRCNCLIN
          WRITE     HTMLFILE;MRCNCLIN; * Procedure Clinician 0=No 1=Yes 2=Mand.
          GOTO      MRTS9999           
.
MRTS4200  COMPARE   ZERO,PTICUINT              * Hrs intensive care
          GOTO      MRTS4250 IF NOT EQUAL   
.
          COMPARE   ZERO,PTICUCCU              * Hrs critical care
          GOTO      MRTS4250 IF NOT EQUAL 
.
          COMPARE   ZERO,PTICUMEC              * Hrs mechanical ventilation
          GOTO      MRTS4250 IF NOT EQUAL 
.
          COMPARE   ZERO,PTICCPAP              * Hrs non invasive ventilation
          GOTO      MRTS4250 IF NOT EQUAL 
.
          COMPARE   ZERO,PTICHNCU              * Hrs spec care nursery 
          GOTO      MRTS4250 IF NOT EQUAL 
. 
          MATCH     SP70,PMVXUVTH              * Unplanned visit to theatre
          GOTO      MRTS4250 IF NOT EQUAL
.
          MATCH     SP70,PMVXUREA              * Unplanned readmission
          GOTO      MRTS4250 IF NOT EQUAL
.
          MATCH     SP70,PMVXMHLS              * Mental Health Legal Status
          GOTO      MRTS4250 IF NOT EQUAL
.
          COMPARE   ONE,PAUTOPY                * Autopsy
          GOTO      MRTS4250 IF EQUAL
.
          MOVE      ZERO,F6
          MOVE      ABWGHT,F6
          COMPARE   ZERO,F6                    * Admission weight
          GOTO      MRTS4250 IF NOT EQUAL 
. 
          WRITE     HTMLFILE;ZERO;             * No wahealth associated details
          GOTO      MRTS9999
.
MRTS4250  WRITE     HTMLFILE;ONE;              * Yes wahealth associated details
          GOTO      MRTS9999
.
MRTS4300  MOVE      "0",KEY1                     * set Coding Completed flag
          COMPARE   ONE,MRCNEPSC                 * Episode Coding
          IF        @EQUAL
            PACK      KEY26,ADMISSNO,EPSCD001,SP30  * read "patchcof" 
            CALL      RDSCHCO2
            CALL      RDKCHCO2
            BRANCH    OVRCD,MRTS9999          
            MATCH     ADMISSNO,DCHADMN
            GOTO      MRTS9999 IF NOT EQUAL 
            MOVE      EPSCD001,KEY2
            MATCH     KEY2,CHEPISNO
            IF        @EQUAL
              MATCH     SP8,CHCODCMP
              IF        !@EQUAL
                MOVE      "1",KEY1
              ENDIF
            ENDIF
          ELSE
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,MRTS9999          
            MATCH     SP8,ACODDTE
            IF        !@EQUAL
              MOVE      "1",KEY1
            ENDIF
          ENDIF
          WRITE     HTMLFILE;KEY1;
          GOTO      MRTS9999
.
MRTS4400  WRITE     HTMLFILE;EPSTTDIS;      * Episode Start Date (formatted)
          GOTO      MRTS9999
.
MRTS4500  WRITE     HTMLFILE;EPENDDIS;      * Episode End Date (formatted)
          GOTO      MRTS9999
.
MRTS4600  MOVE      "CC",CATEGORY           * Episode Care Type
          MOVE      CARETYPE,CODE
          CALL      CODITM00
          GOTO      MRTS9999
.
MRTS4700  WRITE     HTMLFILE;EPNODAYS;      * Episode LOS
          GOTO      MRTS9999
.
MRTS4800  WRITE     HTMLFILE;CLINREQD;      * Clinician required for Prim Proc.
          GOTO      MRTS9999
.
MRTS4900  WRITE     HTMLFILE;LOCKEPNO;      * lock Episode list on Coding screen
          GOTO      MRTS9999
.
MRTS5000  MOVE      ZERO,FORM1
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1                * Position on & read a patient
          CALL      RKPTECO1                * episode operation file record
          BRANCH    OVRCD,MRTS5010
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      MRTS5010 IF NOT EQUAL   * Different admin no
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      MRTS5010 IF NOT EQUAL   * Different episode no
...       MATCH     SP70,PTEOCLIN
...       GOTO      MRTS5010 IF NOT EQUAL   * Blank clinician
          MOVE      ONE,FORM1
.
MRTS5010  WRITE     HTMLFILE;FORM1;         * lock Episode list on Coding screen
          GOTO      MRTS9999
.
MRTS5100  WRITE     HTMLFILE;DATEREQD;      * Date required for Prim Proc.
          GOTO      MRTS9999
.
MRTS5200  WRITE     HTMLFILE;TIMEREQD;      * Time required for Prim Proc.
          GOTO      MRTS9999
.
MRTS5300  MOVE      SP70,DEFLTHOS                            * added  *I-270133
          MOVE      MRCNHLOC,DEFLTLOC
          MATCH     SP4,MRCNDCDT
          IF        !@EQUAL
            PACK      DEFLTLOC,MRCNDCDT,SP4
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,DEFLTHOS
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD<>1
              MATCH     SP70,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DEFLTHOS
                MOVE      SP70,DEFLTLOC
                MATCH     SP4,PTHSDCDT
                IF        !@EQUAL
                  PACK      DEFLTLOC,PTHSDCDT,SP4
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTS5310
.
          WRITE     HTMLFILE;DEFLTHOS;
          GOTO      MRTS9999
.
MRTS5310  CALL      SELLOC00           * Selection list for destinations
          GOTO      MRTS9999
.
MRTS5400  CALL      VISITM00                * Visit based coding
          GOTO      MRTS9999
.
MRTS5500  MOVE      SP70,DEFLTHOS
          MOVE      SP70,DEFLTLOC
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,DEFLTHOS     * Users currently logged in hospital
          ENDIF
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MRTS5510
.
          WRITE     HTMLFILE;DEFLTHOS;
          GOTO      MRTS9999

MRTS5510  CALL      SELLOC00           * Selection list for destinations
          GOTO      MRTS9999
.
MRTS5600  WRITE     HTMLFILE;PTCNBAGE;
          GOTO      MRTS9999
.
MRTS5700  CALL      GETUNR00           * Get unplanned readmission
          WRITE     HTMLFILE;UNPLREAD;
          GOTO      MRTS9999
.
MRTS5800  MOVE      PMVXUDF5,CODE       * coding delay reason (CAT dr)
          MOVE      "dr",CATEGORY
          CALL      CODITM00
          GOTO      MRTS9999
.
MRTS5900  CALL      SELREA00            * Selection list of movement reasons
          GOTO      MRTS9999
.
MRTS6000  MOVE      "rt",CATEGORY
          MOVE      PMPXRPER,CODE
          CALL      CODITM00
          GOTO      MRTS9999
.
MRTS6100  MATCH     SP70,PMPXRDAT
          GOTO      MRTS9999 IF EQUAL
          UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTS9999
.
MRTS6200  MOVE      SP70,RECRETDT
          BRANCH    PVITYPE,MRTS6201,MRTS6202,MRTS6203
          GOTO      MRTS6290
.
MRTS6201  PACK      RECRETDT,EMVIDDAT,SP70
          GOTO      MRTS6290                     * display emr discharge date
.
MRTS6202  PACK      RECRETDT,PVIDATE,SP70
          GOTO      MRTS6290                     * display out visit date
.
MRTS6203  PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                      * discharged ?
          IF        OVRCD = 0
            PACK    RECRETDT,DDATE,SP70          * display inp discharge date
          ENDIF
.
MRTS6290  MATCH     SP70,RECRETDT
          IF        @EQUAL
            PACK      RECRETDT,CCC,CYY,CMM,CDD   * use current date
            REP       " 0",RECRETDT
          ENDIF
          UNPACK    RECRETDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MRTS9999
.
MRTS6300  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      RECRETDT,AGEDATE             * use visit/discharge date
          CALL      CALCAGE
          WRITE     HTMLFILE;PSAGEYRS;
          GOTO      MRTS9999
.
MRTS6400  IF        PTCNOENC = 2
            CALL      DWCI0000           * Display webCodefinder Input Tag
          ENDIF
          GOTO      MRTS9999
.
MRTS6500  WRITE     HTMLFILE;WEBCODER; * initiate web Codefinder? (1=yes/0=No)
.         MOVE      ZERO,WEBCODER
          GOTO      MRTS9999
.
MRTS6600  WRITE     HTMLFILE;MRCNWURL; * 3M Codefinder Web Interace URL
          GOTO      MRTS9999
.
MRTS6700  WRITE     HTMLFILE;MRCNWSES; * 3M Codefinder Web Interace Session
          GOTO      MRTS9999
.
MRTS6800  WRITE     HTMLFILE;SUPERLEV; * superlev flag
          GOTO      MRTS9999
.
MRTS6900  IF        MRCNGRUP<>3
            WRITE     HTMLFILE;"none";   * Not using TurboGrouper 
          ENDIF

          GOTO      MRTS9999
.
MRTS7000  WRITE     HTMLFILE;DEFLTMAN;  * Default mandatory Add screen fields
          GOTO      MRTS9999
.
MRTS7100  PACK      KEY8,ADMISSNO,SP70  * Read linked MR for this visit
          CALL      RDMRVS1
          BRANCH    OVRCD,MRTS9999
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2            * Read linked MR
          BRANCH    OVRCD,MRTS9999
.
          WRITE     HTMLFILE;MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN;
.
          GOTO      MRTS9999
.
MRTS7200  STRIP     MRPSFTM1
          MOVELPTR  MRPSFTM1,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      MRPSFTM1,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,80
.
          STRIP     MRPSFTM2
          MOVELPTR  MRPSFTM2,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      MRPSFTM2,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,80
.
          STRIP     MRPSFTM3
          MOVELPTR  MRPSFTM3,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      MRPSFTM3,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,80
.
          STRIP     MRPSFTM4
          MOVELPTR  MRPSFTM4,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      MRPSFTM4,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,80
.
          STRIP     MRPSFTM5
          MOVELPTR  MRPSFTM5,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      MRPSFTM5,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,80
.
          GOTO      MRTS9999 
.
MRTS7300  WRITE     HTMLFILE;MRPSMIS1;           * Missing Details 1
          GOTO      MRTS9999
.
MRTS7400  WRITE     HTMLFILE;MRPSMIS2;           * Missing Details 2
          GOTO      MRTS9999
.
MRTS7500  WRITE     HTMLFILE;MRPSMIS3;           * Missing Details 3
          GOTO      MRTS9999
.
MRTS7600  WRITE     HTMLFILE;MRPSMIS4;           * Missing Details 4
          GOTO      MRTS9999
.
MRTS7700  WRITE     HTMLFILE;MRPSMIS5;           * Missing Details 5
          GOTO      MRTS9999
.
MRTS7800  WRITE     HTMLFILE;MRPSMIS6;           * Missing Details 6
          GOTO      MRTS9999
.
MRTS7900  WRITE     HTMLFILE;MRPSDATE;           * Date of status
          GOTO      MRTS9999
.
MRTS8000  WRITE     HTMLFILE;MRPSTIME;           * Time of status
          GOTO      MRTS9999
.
MRTS8100  WRITE     HTMLFILE;RUNAUTOG;           * Run auto group after
          GOTO      MRTS9999                     * codefinder load
.
MRTS8200  WRITE     HTMLFILE;RETFIELD;           
          GOTO      MRTS9999
.
MRTS8300  WRITE     HTMLFILE;MRPSFTM1;           * Free text Missing Det 1
          GOTO      MRTS9999
.
MRTS8400  WRITE     HTMLFILE;CDATAFLD;           
          GOTO      MRTS9999
.
MRTS8500  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPTCRD1
          CALL      RKPTCRD1                * Check for a cancer reg
          BRANCH    OVRCD,MRTS9999
.
          MATCH     ADMISSNO,DPTCDDAD       * Correct visit
          GOTO      MRTS9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * Cancer reg exists for visit
          GOTO      MRTS9999
.
MRTS8600  CALL      DTHPDY00
          GOTO      MRTS9999
.
MRTS8700  CALL      CODCMT00 
          GOTO      MRTS9999
.
MRTS8800  MOVE      ONE,DISPDTTM        * Do not display Coding Date and Time
          CALL      CODDAT00            * Output Coding Date and Time
          GOTO      MRTS9999
.
MRTS9999  RETURN
.-----------------------------------------------------------------------
. Formatted Grouper Version Number
.-----------------------------------------------------------------------
GRPDIS00  MATCH     SP3,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG041,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"4.1";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG042,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"4.2";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG050,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"5.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG051,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"5.1";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG052,DRGVER                                     *I-137125
          IF        @EQUAL
            WRITE     HTMLFILE;"5.2";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG060,DRGVER                                     *I-197814
          IF        @EQUAL
            WRITE     HTMLFILE;"6.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG062,DRGVER                                     *I-267797
          IF        @EQUAL
            WRITE     HTMLFILE;"6.2";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG070,DRGVER                                     *I-284669
          IF        @EQUAL
            WRITE     HTMLFILE;"7.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG080,DRGVER
          IF        @EQUAL
            WRITE     HTMLFILE;"8.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG090,DRGVER                                    *I-0852793
          IF        @EQUAL
            WRITE     HTMLFILE;"9.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG100,DRGVER                                    *I-0852793
          IF        @EQUAL
            WRITE     HTMLFILE;"10.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG110,DRGVER                                    *I-0917793
          IF        @EQUAL
            WRITE     HTMLFILE;"11.0";
            GOTO      GRPDIS99
          ENDIF
.
          MATCH     DRG120,DRGVER                                    *I-0956210
          IF        @EQUAL
            WRITE     HTMLFILE;"12.0";
            GOTO      GRPDIS99
          ENDIF
.
GRPDIS99  RETURN
.-----------------------------------------------------------
. Option 1 - Coding Summary Information
.-----------------------------------------------------------
SUMM0000  BRANCH    FLDITMNO,SUMM0100,SUMM0200,SUMM0300,SUMM0400,SUMM0500:
                             SUMM0600,SUMM0700,SUMM0800,SUMM0900,SUMM1000: *10
                             SUMM1100,SUMM1200,SUMM1300,SUMM1400,SUMM1500:
                             SUMM1600,SUMM1700,SUMM1800,SUMM1900,SUMM2000: *20
                             SUMM2100,SUMM2200,SUMM2300,SUMM2400,SUMM2500:
                             SUMM2600,SUMM2700,SUMM2800,SUMM2900,SUMM3000: *30
                             SUMM3100,SUMM3200,SUMM3300,SUMM3400,SUMM3500:
                             SUMM3600,SUMM3700
          GOTO      SUMM9999
.
SUMM0100  CALL      TDTTB000     * Table of Medical Records Diagnosis Codes
          GOTO      SUMM9999
.
SUMM0200  CALL      TOPTB000     * Table of Medical Records Procedural Codes
          GOTO      SUMM9999
.
.   Episode Procedure Coding Details
.
SUMM0300  WRITE     HTMLFILE;DPTEOADM;    * Admission No
          GOTO      SUMM9999
.
SUMM0400  WRITE     HTMLFILE;DPTEOEPN;    * Episode No
          GOTO      SUMM9999
.
SUMM0500  WRITE     HTMLFILE;DPTEOCNT;    * Episode Unique Counter
          GOTO      SUMM9999
.
SUMM0600  WRITE     HTMLFILE;PTEOCODE;    * Procedure Code 
          GOTO      SUMM9999
.
SUMM0700  WRITE     HTMLFILE;PTEOTYPE;    * Procedure Type 
          GOTO      SUMM9999
.
SUMM0800  WRITE     HTMLFILE;DPTEOUNQ;    * Unique No
          GOTO      SUMM9999
.
SUMM0900  UNPACK    PTEODTCD,CCENT,CYEAR,CMON,CDAY    * Date of Coding 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUMM9999
.
SUMM1000  WRITE     HTMLFILE;PTEOOPER;    * Operator Id
          GOTO      SUMM9999
.
SUMM1100  MATCH     SP70,PTEODATE 
          GOTO      SUMM9999 IF EQUAL
          UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY    * Procedure Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUMM9999
.
SUMM1200  MATCH     SP70,PTEOSTTM
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PTEOSTTM;    * Procedure Time
          GOTO      SUMM9999
.
SUMM1300  MATCH     SP70,PTEOEDTM
          GOTO      SUMM9999 IF EQUAL
          WRITE     HTMLFILE;PTEOEDTM;    * Procedure End Time
          GOTO      SUMM9999
.
SUMM1400  UNPACK    DIM127,DIM1,KEY1,DIM127      * 0=Desc 1=Block Number
          MOVE      KEY1,F1
          PACK      PT0ODSC2,SP70,SP70,SP70
          PACK      PT0ODESC,SP70,SP70,SP70
          PACK      KEY9,PTEOCODE
          CALL      RDPTICO1
          IF        OVRCD=1 | ICDRDVER=1
            WRITE     HTMLFILE;"Invalid Procedure Code";
            GOTO      SUMM9999
          ENDIF
          BRANCH    F1,SUMM1410
          MATCH     SP70,PTEODESC                * Is Free Format Desc blank?
          IF        !@EQUAL
            WRITE     HTMLFILE;PTEODESC;         * No, use Free Format Desc
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,PT0ODSC2
          IF        !@EQUAL
            WRITE     HTMLFILE;PT0ODSC2;         * use ICO desc 200 chars
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,PT0ODESC
          IF        !@EQUAL
            WRITE     HTMLFILE;PT0ODESC;         * use ICO desc 100 chars
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,ODESC
          IF        !@EQUAL
            WRITE     HTMLFILE;ODESC;            * use ICO desc 70 chars
            GOTO      SUMM9999
          ENDIF
          GOTO      SUMM9999
.
SUMM1410  WRITE     HTMLFILE;PT0OBLKN;
          GOTO      SUMM9999
.
.   Episode Diagnosis Coding Details
.
SUMM1500  WRITE     HTMLFILE;DPTEDADM;    * Admission No
          GOTO      SUMM9999
.
SUMM1600  WRITE     HTMLFILE;DPTEDEPN;    * Episode No
          GOTO      SUMM9999
.
SUMM1700  WRITE     HTMLFILE;DPTEDCNT;    * Episode Unique Counter
          GOTO      SUMM9999
.
SUMM1800  WRITE     HTMLFILE;PTEDCODE;    * Diagnosis Code 
          GOTO      SUMM9999
.
SUMM1900  WRITE     HTMLFILE;PTEDTYPE;    * Diagnosis Type 
          GOTO      SUMM9999
.
SUMM2000  WRITE     HTMLFILE;DPTEDUNQ;    * Unique No
          GOTO      SUMM9999
.
SUMM2100  UNPACK    PTEDDTCD,CCENT,CYEAR,CMON,CDAY  * Date of Coding 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUMM9999
.
SUMM2200  WRITE     HTMLFILE;PTEDOPER;    * Operator Id
          GOTO      SUMM9999
.
SUMM2300  MATCH     SP70,PTEDACDT
          GOTO      SUMM9999 IF EQUAL
          UNPACK    PTEDACDT,CCENT,CYEAR,CMON,CDAY  * Accident Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SUMM9999
.
SUMM2400  MATCH     SP70,PTEDDESC         * Is Free Format Desc blank?
          IF        !@EQUAL
            REP       "#"'",PTEDDESC
            WRITE     HTMLFILE;PTEDDESC;  * No, display Free Format Desc
            GOTO      SUMM9999
          ENDIF
          PACK      PT0DDSC2,SP70,SP70,SP70
          PACK      PT0DDESC,SP70,SP70,SP70
          PACK      KEY9,PTEDCODE         * Diagnosis Code Description
          CALL      RDPTICD1
          IF        OVRCD<>0
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,PT0DDSC2
          IF        !@EQUAL
            REP       "#"'",PT0DDSC2
            WRITE     HTMLFILE;PT0DDSC2;         * use ICD desc 200 chars
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,PT0DDESC
          IF        !@EQUAL
            REP       "#"'",PT0DDESC
            WRITE     HTMLFILE;PT0DDESC;         * use ICD desc 100 chars
            GOTO      SUMM9999
          ENDIF
          MATCH     SP70,DDESC
          IF        !@EQUAL
            REP       "#"'",DDESC
            WRITE     HTMLFILE;DDESC;            * use ICD desc 70 chars
            GOTO      SUMM9999
          ENDIF
          GOTO      SUMM9999
.
SUMM2500  CALL      PREVAD00      * Previous Admission Record for Patient
          GOTO      SUMM9999
.
SUMM2600  CALL      NEXTAD00      * Next Admission Record for Patient
          GOTO      SUMM9999
.
SUMM2700  CALL      CODFLG00      * Coding Check Box unticked flag
          GOTO      SUMM9999
.
SUMM2800  CALL      WRDDIS00      * Output Discharge Ward Description
          GOTO      SUMM9999
.
SUMM2900  PACK      KEY9,PTEDCODE         * Additional Code Requirements
          CALL      RDPTICD1
          COMPARE   ONE,ICDRDVER          * ICD9?
          IF        @EQUAL
            MATCH     "999",PTCNDGPV         * allowing icd9 codes?
            GOTO      SUMM9999 IF EQUAL      
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      SUMM9999            
          ENDIF
.
          IF        OVRCD=0
            WRITE     HTMLFILE;PT0DACRQ;
          ELSE
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
          ENDIF
          GOTO      SUMM9999
.
SUMM3000  MATCH     SP70,PTEDOSET
          GOTO      SUMM9999 IF EQUAL
          GOTO      SUMM9999 IF EOS
.
          WRITE     HTMLFILE;PTEDOSET;      * Diagnosis onset type
          GOTO      SUMM9999
.
SUMM3100  CALL      DEDI0000                * Display ICD10 edition
          GOTO      SUMM9999
.
.                                           * Display Procedure Clinician
SUMM3200  UNPACK    DIM127,DIM1,KEY1,DIM127 * 0=Doc.Code  1=Doc.Name  *I-240103
          MATCH     "1",KEY1
          IF        !@EQUAL
            WRITE     HTMLFILE;PTEOCLIN     * Display Doctor Code
            GOTO      SUMM9999
          ENDIF
.
          PACK      KEY10,PTEOCLIN,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          IF        OVRCD=1
            GOTO      SUMM9999
          ENDIF
          STRIP     PMHCTITL
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          RESET     PMHCTITL
          RESET     PMHCGNAM
          RESET     PMHCSNAM
          CALL      DOCNM000
....      PACK      VARIABLE,DOCFNAME
          WRITE     HTMLFILE;DOCFNAME     * Display Doctor Code
.
          GOTO      SUMM9999
.
SUMM3300  WRITE     HTMLFILE;DDATEDIS;      * DDATE Display (blank if not disch)
          GOTO      SUMM9999
.
SUMM3400  WRITE     HTMLFILE;ADNODAYS;      * Current LOS from Admission to ?
          GOTO      SUMM9999
.
SUMM3500  WRITE     HTMLFILE;PTEDCCFL;      * Contract care flag
          GOTO      SUMM9999
.
SUMM3600  WRITE     HTMLFILE;PTEOCCFL;      * Contract care flag
          GOTO      SUMM9999
.
SUMM3700  WRITE     HTMLFILE;PTEDDCID;      * Diagnosis cluster id
          GOTO      SUMM9999
.
SUMM9999  RETURN
.******************************************************************************
.*                                  CTBH0000              Called by: DIDV0000 *
.*                          Calculate Total Bed Hours                         *
.******************************************************************************
CTBH0000  MOVE      ZERO,TOTBEDHR           * Clear total bed hours
          MOVE      ZERO,FORM12
.
          MOVE      CURRDATE,KEY8
          MATCH     SP8,DDATE
          IF        !@EQUAL
            MOVE      DDATE,KEY8
          ENDIF
          MATCH     ADATE,KEY8
          GOTO      CTBH1000 IF EQUAL       * Sameday patient, only calc hours
.
          MOVE      ZERO,NBRDAYS
          MOVE      ADATE,FROMDATE          * From date
          MOVE      KEY8,TODATE             * To date
          CALL      RTIODAYS                * Calculate total bed days
          COMPARE   NBRDAYS,ZERO
          GOTO      CTBH9000 IF NOT LESS    * 0 >= number of days
.
          ASSIGN    NBRDAYS*1440,FORM12     * Total minutes for days
.
CTBH1000  UNPACK    ATIME,CHOUR,ANS,CMIN
          MOVE      CHOUR,IHOUR
          MOVE      CMIN,IMIN
          ASSIGN    (IHOUR*60)+IMIN,FORM5
.
          MATCH     SP8,DDATE
          IF        @EQUAL
            CLOCK     TIME,CTIMEIS
            UNPACK    CTIMEIS,CHOUR,DIM1,CMIN,DIM2
          ELSE
            UNPACK    DTIME,CHOUR,DIM1,CMIN,DIM2
          ENDIF
          MOVE      CHOUR,IHOUR
          MOVE      CMIN,IMIN
          ASSIGN    ((IHOUR*60)+IMIN)-FORM5,FORM5
.
          ASSIGN    (FORM5+FORM12)/60,FORM12P2 * Total bed hours
          ASSIGN    (FORM12P2*SIXTY),FORM12
          IF        FORM12%60<>0
            ADD       ONE,FORM12P2            * Round up mins to 1 hr
          ENDIF
          MOVE      FORM12P2,TOTBEDHR        * Total bed hours
.
CTBH9000  MOVE      ZERO,EXIT
CTBH9999  RETURN
.--------------------------------------------------------------------------
.   Retrive Primary Site - first C coded Diagnosis found on PATCANFD
.   0=Desc 1=Code 
.--------------------------------------------------------------------------
GETPRM00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG 
.
          CALL      FNDPRM00                * find unregistered Primary Cancer
          BRANCH    EXIT,GETPRM99
.
GETPRM40  BRANCH    VIEWFLAG,GETPRM50
.
          WRITE     HTMLFILE;PTEDDESC;      * Output Description
          GOTO      GETPRM99
.
GETPRM50  WRITE     HTMLFILE;PTEDCODE;      * Output Code
          GOTO      GETPRM99
.
GETPRM99  RETURN
.--------------------------------------------------------------------------
.                                   FNDPRM00
.   Find first Primary Code that has not been Registered on "patcrdaf"
.   Save the primary cancer code in variable PRIMCANC
.   Save the first secondary cancer that is before the primary cancer in
.   variable SECBCANC
.--------------------------------------------------------------------------
FNDPRM00  MOVE      ZERO,EXIT
          MOVE      SP70,SECBCANC      * Secondary before primary cancer code
          MOVE      SP70,PRIMCANC      * Primary cancer code
.
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1                * position on Episode disease record
FNDPRM10  CALL      RKPTECD1                * read Episode disease record
          BRANCH    OVRCD,FNDPRM90
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      FNDPRM90 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      FNDPRM90 IF NOT EQUAL   * Different episode no
.
.                   * Check if this is a Cancer Code - must be on "patcanaf"
.                   * and not in Metastatic range (C77.0 to C80.9 )
.
          PACK      KEY9,PTEDCODE,SP70
          CALL      RDPTCAN1
          BRANCH    OVRCD,FNDPRM10          * Cancer Code?
.
          MATCH     METC770,PTEDCODE        * Code outside Metastatic range ?
          IF        !@LESS
            MOVE      PTEDCODE,KEY6
            MATCH     KEY6,METC7990                                   *C-237278
            GOTO      FNDPRM20 IF LESS
.
            MATCH    SP70,SECBCANC
            IF       @EQUAL
              MOVE     PTEDCODE,SECBCANC * Save secondary before primary cancer
            ENDIF
.
            GOTO      FNDPRM10              * try next record
          ENDIF
.
.                   * Check this Cancer code has been registered for Admission
.
FNDPRM20  CALL      FNDDCN00
.
          MOVE      ZERO,CANDSC02
          PACK      KEY25,ADMISSNO,PTEDCODE,SP20
          CALL      RSPTCRD1
FNDPRM30  CALL      RKPTCRD1
          BRANCH    OVRCD,FNDPRM95
.
          MATCH     ADMISSNO,DPTCDDAD
          GOTO      FNDPRM95 IF NOT EQUAL   * not found - must be new Primary
          MATCH     PTEDCODE,PTCDPRMM
          GOTO      FNDPRM95 IF NOT EQUAL   * not found - must be new Primary
.
          ADD       ONE,CANDSC02
.
          COMPARE   CANDSC01,CANDSC02
          GOTO      FNDPRM30 IF NOT EQUAL          
.
          MOVE      SP70,SECBCANC      * Clear secondary before primary cancer 
          MOVE      SP70,PRIMCANC      * Clear primary cancer code
          GOTO      FNDPRM10           * read next if code is registered
.
FNDPRM90  MOVE      ONE,EXIT
          GOTO      FNDPRM99
.
FNDPRM95  MOVE      PTEDCODE,PRIMCANC       * Save primary cancer code
          GOTO      FNDPRM99
.
FNDPRM99  RETURN
.--------------------------------------------------------------------------
.   Display ICD Code & Description
.   0=Desc 1=Code 
.--------------------------------------------------------------------------
DISICD00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG 
.
          PACK      PT0DDSC2,SP70,SP70,SP70
          PACK      PT0DDESC,SP70,SP70,SP70
          PACK      KEY9,ICDCODE,SP70
          CALL      RDPTICD1 
          BRANCH    OVRCD,DISICD99
          COMPARE   ONE,ICDRDVER                 * ICD9?
          IF        @EQUAL
            MATCH     "999",PTCNDGPV             * ICD9 is wanted
            GOTO      DISICD99 IF NOT EQUAL
          ENDIF

          BRANCH    VIEWFLAG,DISICD10

          MATCH     SP70,PT0DDSC2
          IF        !@EQUAL
            WRITE     HTMLFILE;PT0DDSC2;         * use ICD desc 200 chars
            GOTO      DISICD99
          ENDIF
          MATCH     SP70,PT0DDESC
          IF        !@EQUAL
            WRITE     HTMLFILE;PT0DDESC;         * use ICD desc 100 chars
            GOTO      DISICD99
          ENDIF
          MATCH     SP70,DDESC
          IF        !@EQUAL
            WRITE     HTMLFILE;DDESC;            * use ICD desc 70 chars
            GOTO      DISICD99
          ENDIF
          GOTO      DISICD99
.
DISICD10  WRITE     HTMLFILE;ICDCODE;    * Output Code
          GOTO      DISICD99
.
DISICD99  RETURN
.--------------------------------------------------------------------------
.   Retrive Histological Site - Get first Morphology Code in patecdaf 
.--------------------------------------------------------------------------
GETMOR00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG 
.
          CALL      FNDPRM00                * find unregistered Primary Cancer
          BRANCH    EXIT,GETMOR99
.
GETMOR10  CALL      RKPTECD1                * read next Episode disease record
          BRANCH    OVRCD,GETMOR99
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      GETMOR99 IF NOT EQUAL   * Different admin no ? - then finish
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      GETMOR99 IF NOT EQUAL   * Different episode no ?

.                   *  Validate Code - check if its a Morphology Code.
.
          PACK      KEY9,PTEDCODE,SP70
          CALL      RDPTICD1
          BRANCH    OVRCD,GETMOR10       
          COMPARE   ONE,ICDRDVER            * ICD9?
          GOTO      GETMOR10 IF EQUAL
.
          MATCH     "4",PT0DACRQ            * Morphology Code
          IF        !@EQUAL
            MATCH     "1",MRCNMORP                         * start    *C-260916
            GOTO      GETMOR10 IF EQUAL     * if "no checks" find a Morphology
            GOTO      GETMOR99              * no Morphologys after Primary
          ENDIF
.
.                                           * a Morphology has been found
          MATCH     "1",MRCNMORP            * if "no checks" then bypass this
          IF        !@EQUAL
.                   * Check this Morphology code is not registered for a Cancer
            PACK      KEY25,ADMISSNO,ZED20
            CALL      RSPTCRD1
GETMOR20    CALL      RPPTCRD1
            BRANCH    OVRCD,GETMOR30
.         
            MATCH     ADMISSNO,DPTCDDAD     
            GOTO      GETMOR30 IF NOT EQUAL 
            MATCH     PTEDCODE,PTCDHTYP
            GOTO      GETMOR20 IF NOT EQUAL
            GOTO      GETMOR10              * bypass if code has been registered
          ENDIF                                            * end      *C-260916
.
GETMOR30  BRANCH    VIEWFLAG,GETMOR40
.
          WRITE     HTMLFILE;PTEDDESC;    * Output Description 
          GOTO      GETMOR99
.
GETMOR40  WRITE     HTMLFILE;PTEDCODE;    * Output Code
.
GETMOR99  RETURN
.--------------------------------------------------------------------------
.   Finds the first Cancer Code Found and then gets next 3 C coded codes    
.   METASTIC 1=Site-1 2=Site-2 3=Site-3 -new- 4=Site-4, 5=Site-5, 6=Site-6
.   VIEWFLAG 0=Desc 1=Code                           * major revamp   *C-208570
.--------------------------------------------------------------------------
GETMET00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,METASTIC
          MOVE      KEY1,METASTIC 
.
          UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG 
.
          MOVE      ZERO,EPSFLAG
          MOVE      ZERO,COUNT   
          MOVE      ZERO,SECBFLAG      * Clear seconday before primary loop flag
.
          CALL      FNDPRM00                * find unregistered Primary Cancer
          BRANCH    EXIT,GETMET99
.
GETMET10  CALL      RKPTECD1                * read next Episode disease record
          BRANCH    OVRCD,GETMET50
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      GETMET50 IF NOT EQUAL   * Different admin no ? - then finish
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      GETMET50 IF NOT EQUAL   * Different episode no ?
.
GETMET15  CMATCH    "M",PTEDCODE            * if this is Morphology (rough test)
          GOTO      GETMET10 IF EQUAL       * - then bypass it
.
          IF        SECBFLAG=1
            MATCH     PTEDCODE,PRIMCANC       
            GOTO      GETMET99 IF EQUAL       * Exit when we get to the primary
          ENDIF
.                                          
GETMET20  PACK      KEY9,PTEDCODE,SP70
          CALL      RDPTCAN1                * finish if this is not a Cancer
          BRANCH    OVRCD,GETMET10
.
.                                           * finish if this is Primary Cancer -
.                                           * not in range "C77.0" to "C80.9 "
          MOVE      PTEDCODE,KEY6
.
          MATCH     METC770,KEY6
          GOTO      GETMET10 IF LESS
.
          MATCH     KEY6,METC7990                                     *C-237278
          GOTO      GETMET10 IF LESS
.                                           * find required Metastatic Code -
.                                           * must be in range (C77.0 to C80.9 )
          ADD       ONE,COUNT
          COMPARE   METASTIC,COUNT
          GOTO      GETMET10 IF LESS
.
          IF        COUNT = METASTIC
            IF        VIEWFLAG = 1
              WRITE     HTMLFILE;PTEDCODE;  * Output Code
            ELSE
              WRITE     HTMLFILE;PTEDDESC;  * Output Description
            ENDIF
          ENDIF
          GOTO      GETMET99
.
GETMET50  BRANCH    SECBFLAG,GETMET99  * Already processed
.
          MATCH     SP70,SECBCANC      * Any secondary before primary cancer
          GOTO      GETMET99 IF EQUAL  * if not we are finished
.
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1                * position on Episode disease record
GETMET60  CALL      RKPTECD1                * read Episode disease record
          BRANCH    OVRCD,GETMET99
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      GETMET99 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      GETMET99 IF NOT EQUAL   * Different episode no
.
          MATCH     SECBCANC,PTEDCODE
          GOTO      GETMET60 IF NOT EQUAL
.
          MOVE      ONE,SECBFLAG       * Set flag to say we are on the secondary
          GOTO      GETMET15           * before primary loop
.
GETMET99  RETURN
.------------------------------------------------------------
. Table of Cancer Registrations for an Admission
.------------------------------------------------------------
REGTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      REGHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY25,ADMISSNO,SP70
          CALL      RSPTCRD1
REGTB100  CALL      RKPTCRD1
          BRANCH    OVRCD,REGTB999
.
          MATCH     ADMISSNO,DPTCDDAD
          GOTO      REGTB999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REGTB100
          ENDIF
.
          CALL      REGRW000    * Display Locations Mantenance Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      REGTB100 IF NOT EQUAL
.
REGTB999  RETURN
.------------------------------------------------------------
. Cancer Reagistration Table Details (TABLE HEADING)
.------------------------------------------------------------
REGHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Reg No.</td>":
                               "<td class=HeadingCell>":
                               "Primary Site</td>":
                               "<td class=HeadingCell>":
                               "Histological Site</td>":
                               "<td class=HeadingCell>":
                               "Date Registered</td>":
                             "</tr>"
.
REGHD999  RETURN
.------------------------------------------------------------
. Cancer Registrations (TABLE ROW)
.------------------------------------------------------------
REGRW000  PACK      KEY9,PTCDPRMM,SP70 
          CALL      RDPTICD1
          MOVE      "&nbsp;",KEY70
          IF        OVRCD <> 1
            MOVE      DDESC,KEY70           * Primary Site Description
            IF        ICDRDVER = 1
              MATCH     "999",PTCNDGPV      * using icd9?
              IF        !@EQUAL
                MOVE      "&nbsp;",KEY70    * not using icd9
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY9,PTCDHTYP,SP70 
          CALL      RDPTICD1
          MOVE      "&nbsp;",ICDCDESC
          IF        OVRCD <> 1
            MOVE      DDESC,ICDCDESC        * Histological Site Description
            IF        ICDRDVER = 1
              MATCH     "999",PTCNDGPV      * using icd9?
              IF        !@EQUAL
                MOVE      "&nbsp;",ICDCDESC * not using icd9
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      " n/a",KEY11
          MATCH     SP10,PTCDDTEX
          IF        !@EQUAL
            UNPACK    PTCDDTEX,CCENT,CYEAR,CMON,CDAY    * Date Extracted  
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",DPTCDCNR
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&ptcrd008=",PTCDPRMM:
                             "&ptcrd002=",DPTCDCNR,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PTCDCNRG,"</td><td>",PTCDPRMM,"-",KEY70,"</td>":
                             "<td>",PTCDHTYP,"-",ICDCDESC,"</td>":
                             "<td>",KEY11,"</td>":
                             "</tr>";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",DPTCDCNR
.
REGRW999 RETURN
.------------------------------------------------------------
. Table of Cancer Registrations for an Admission
.------------------------------------------------------------
REGLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RSPTCRG2
REGLST10  CALL      RKPTCRG2
          BRANCH    OVRCD,REGLST99
.
          MATCH     URNUMBER,PTCRURNO
          GOTO      REGLST99 IF NOT EQUAL
.
          PACK      KEY8,PTCRADNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,REGLST10
.
          PACK      KEY8,PTCRADNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,REGLST10
.
          PACK      KEY8,PTCRADNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,REGLST10
.
          MOVE      DDATE,ICDRDDTE       * Used for reading ICD files
.
          MOVE      ZERO,CODESTAT
          MATCH     SP8,ACODDTE
          IF        !@EQUAL
            MOVE      ONE,CODESTAT       * coded
          ENDIF
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,NEWPNAME
          ELSE
            CALL      CODRID00           * Get coder ID
          ENDIF
.
          MOVE      "&nbsp;",KEY70
          PACK      KEY9,PTCRPRIM,SP70 
          CALL      RDPTICD1
          IF        OVRCD <> 1
            MOVE      " - ",KEY3
            PACK      KEY70,PTCRPRIM,KEY3,DDESC
            IF        ICDRDVER = 1
              MATCH     "999",PTCNDGPV      * using icd9?
              IF        !@EQUAL
                MOVE      "&nbsp;",KEY70    * not using icd9
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "&nbsp;",ICDCDESC
          PACK      KEY9,PTCRHIST,SP70 
          CALL      RDPTICD1
          IF        OVRCD <> 1
            MOVE      " - ",KEY3
            PACK      ICDCDESC,PTCRHIST,KEY3,DDESC
            IF        ICDRDVER = 1
              MATCH     "999",PTCNDGPV      * using icd9?
              IF        !@EQUAL
                MOVE      "&nbsp;",ICDCDESC * not using icd9
              ENDIF
            ENDIF
          ENDIF
.
.  Read Cancer Detials File get Extraction Date from most recent record
.
          MOVE      SP70,PTCDDTEX         * Extraction Date 
          PACK      KEY25,DPTCRADN,Z70    
          CALL      RSPTCRD1
          CALL      RPPTCRD1
          BRANCH    OVRCD,REGLST20
.
          MATCH     DPTCRADN,DPTCDDAD     * Match on Admission No
          GOTO      REGLST20 IF NOT EQUAL
.
REGLST20  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       " 0",PVIDATE
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PVIBILL,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",KEY70,"#",":
                             "#"",ICDCDESC,"#",":
                             "#"",PTCDDTEX,"#",":
                             "#"",ACODDTE,"#",":
                             "#"",NEWPNAME,"#")"
.
          GOTO      REGLST10 
.
REGLST99  RETURN
.
.*************************************************************************
.  Get the coder id for this cancer registration
.*************************************************************************
CODRID00  MOVE      ONE,PTEDEPNO
          MOVE      ONE,PTEDCNT
          PACK      KEY13,PTCRADNO,PTEDEPNO,PTEDCNT,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,CODRID20
.
          MATCH     SP70,PTEDUSID         * Web user id
          GOTO      CODRID05 IF NOT EQUAL
.
          MATCH     SP70,PTEDOPER         * user passcode
          GOTO      CODRID20 IF EQUAL
.
          PACK      KEY14,PTEDOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,CODRID20
.
          MATCH     PTEDOPER,WBSEPCD
          GOTO      CODRID20 IF NOT EQUAL
.
          MOVE      WBSEUID,PTEDUSID
.
CODRID05  PACK      KEY10,PTEDUSID,SP70   * Read Security File
          CALL      RDWBSE1
          BRANCH    OVRCD,CODRID20
.
          MOVE      WBSENAM,NEWPNAME
          GOTO      CODRID99
.
.         Check episode operation coding
.
CODRID20  CALL      RDPTECO1
          BRANCH    OVRCD,CODRID99
.
          MATCH     SP70,PTEOUSID         * Web user id
          GOTO      CODRID25 IF NOT EQUAL
.
          MATCH     SP70,PTEOOPER         * user passcode
          GOTO      CODRID99 IF EQUAL
.
          PACK      KEY14,PTEOOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,CODRID99
.
          MATCH     PTEOOPER,WBSEPCD
          GOTO      CODRID99 IF NOT EQUAL
.
          MOVE      WBSEUID,PTEOUSID
.
CODRID25  PACK      KEY10,PTEOUSID,SP70  * Read Security File
          CALL      RDWBSE1
          BRANCH    OVRCD,CODRID99
.
          MOVE      WBSENAM,NEWPNAME
          GOTO      CODRID99
.
CODRID99  RETURN
.-----------------------------------------------------------
. Link to Next Group of ID's
.-----------------------------------------------------------
NEXTRG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"mrtweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NEXTRG99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of ID's
.-------------------------------------------------------------
PREVRG00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"mrtweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PREVRG99  RETURN
.**********************************************************************
.   Read Tranfer file and get ICU/CCU/NCU/SCN
.   Writes var ICUBED if Specific Bed type is found. 
.   0- ICU Bed Type, 1- NCU Bed Type, 2- CCU Bed Type, 3- SCN Bed Type
.**********************************************************************
ICUBED00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG 
.
          MOVE      ZERO,ICUBED 
.
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
ICUBED10  CALL      RDKTRAN2
          BRANCH    OVRCD,ICUBED90
.
          MATCH     DTADMN,ADMISSNO        * Admission No?
          GOTO      ICUBED90 IF NOT EQUAL
.
          PACK      KEY5,ANSB,ANST,TRBTYP
          CALL      RDCODE1
          BRANCH    OVRCD,ICUBED10
.
          MOVE      ZERO,ICUFLAG
          MOVE      ZERO,ICUFLAG2
          MOVE      TCINDC3,ICUFLAG
          MOVE      TCINDC9,ICUFLAG2
.
.   Check for ICU,CCU,NCU,SCN Bed type?
.
          BRANCH    VIEWFLAG,ICUBED20,ICUBED30,ICUBED40
.
          IF        ICUFLAG=FIVE
            MOVE      ONE,ICUBED
            GOTO      ICUBED90   * ICU Bed Type Found!
          ENDIF
          GOTO      ICUBED10
.
ICUBED20  IF        ICUFLAG=SEVEN
            MOVE      ONE,ICUBED
            GOTO      ICUBED90   * NCU Bed Type Found!
          ENDIF
          GOTO      ICUBED10
.
ICUBED30  IF        ICUFLAG=FOUR
            MOVE      ONE,ICUBED
            GOTO      ICUBED90   * CCU Bed Type Found!
          ENDIF
          GOTO      ICUBED10
.
ICUBED40  IF        ICUFLAG2=FOUR
            MOVE      ONE,ICUBED
            GOTO      ICUBED90   * SCN Bed Type Found!
          ENDIF
          GOTO      ICUBED10
.
ICUBED90  WRITE     HTMLFILE;ICUBED;
ICUBED99  RETURN
+
.******************************************************************************
.*                                  CPSY0000                                  *
.*                   Check For Psychiatric care (use category BT)             *
.******************************************************************************
CPSY0000  PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
CPSY1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CPSY9000
.         
          MATCH     DTADMN,ADMISSNO          * Admission No?
          GOTO      CPSY9000 IF NOT EQUAL  
.         
          MATCH     SP3,TRBTYP               
          GOTO      CPSY1000 IF EQUAL        * Dont allow blank codes
.
          PACK      KEY5,ANSB,ANST,TRBTYP    * first check for any psych days
          CALL      RDCODE1
          BRANCH    OVRCD,CPSY1000
.
          MATCH     ANSA,TCINDC3
          GOTO      CPSY9500 IF EQUAL
.
          MATCH     ANSD,TCINDC3
          GOTO      CPSY9500 IF EQUAL
.
          GOTO      CPSY1000                 * next tran record
.
CPSY9000  WRITE     HTMLFILE;ZERO;           * patient has no psych care
          GOTO      CPSY9999
.
CPSY9500  WRITE     HTMLFILE;ONE;            * patient has psych care
          GOTO      CPSY9999
.
CPSY9999  RETURN
+
.**********************************************************************
.                        ****** NEONAT00 ******
.  Display Noenate flashing Siron Indicator value    
.**********************************************************************
NEONAT00  PACK      KEY8,ADMISSNO,SP70  * Read for Admission Data
          CALL      RDMISS1
          BRANCH    OVRCD,MRTS9999
.
          MOVE      ADATE,AGEDATE         * Now using Admission Date 
          CALL      CALCAGE               * Calculate age
.
          MOVE      PTCNBAGE,NOOFDAYS
          CALL      CHLPYR00              * Check if leap year
          IF        PSAGEDAY < NOOFDAYS
            IF        PSAGEDAY < TWENTY8 
              WRITE     HTMLFILE;"1";       * Display neonatal Patient
            ELSE
              MOVE      ABWGHT,F6       * Weight must be btw 125g & 2499g  
              IF        F6 > 124 & F6 < 2500 
                WRITE     HTMLFILE;"1";     * Display neonatal Patient
              ELSE
                WRITE     HTMLFILE;"0";     * Do not Display Neonatal Patient
              ENDIF
            ENDIF
          ENDIF
.
NEONAT99  RETURN
.**********************************************************************
.                 ****** WRDDIS00 ******
. Output Ward description
.**********************************************************************
WRDDIS00  IF        ASTAT <> 3
            WRITE     HTMLFILE;"Patient is not Discharged";
            GOTO      WRDDIS99
          ENDIF
          PACK      KEY6,PTDSDWRD,SP70 
          CALL      RDWARD1
          BRANCH    OVRCD,WRDDIS90
.
          WRITE     HTMLFILE;WBDESC;    * description 
          GOTO      WRDDIS99
.
WRDDIS90  WRITE     HTMLFILE;"Invalid Ward Code";
WRDDIS99  RETURN
.----------------------------------------------------------------
.                         PREVAD00  
.  Previous Admission Record for Patient
.----------------------------------------------------------------
PREVAD00  MOVE      ZERO,EPSNUMBR 
          MOVE      ADMISSNO,VISITNUM
.
          PACK      KEY24,URNUMBER,ADMISDTE,ADMISSNO,Z70
          CALL      RSPTVIS2
PREVAD10  CALL      RPPTVIS2
          BRANCH    OVRCD,PREVAD80
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PREVAD80 IF NOT EQUAL              
.
          MATCH     ADMISSNO,DPVIBILL
          GOTO      PREVAD10 IF EQUAL           * Don't want same Admission no 
.
          COMPARE   THREE,PVITYPE    
          GOTO      PREVAD10 IF NOT EQUAL      
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PREVAD10
.
          COMPARE   "3",ASTAT                   * Discharged only
          GOTO      PREVAD10 IF NOT EQUAL
.
          CALL      RDPMVX11
          BRANCH    OVRCD,PREVAD10
.
          MOVE      PVIURNO,URNUMBER
          MOVE      DPVIBILL,VISITNUM
          CALL      GETEPS00         * Get Episode No for Admission record 
          MATCH     " 0",EPSNUMBR
          IF        @EQUAL
            MOVE      ONE,EPSNUMBR    * Set to Default to 1
          ENDIF
.
          IF        IBCNMHOS <> 1
            GOTO      PREVAD90
          ENDIF
.
. Centralised coding
.
          MATCH     "1",MRCNCCOD               * Using centralise coding
          GOTO      PREVAD50 IF EQUAL
.
          PACK      KEY10,USERID,SP70          * Re read logged in user to
          CALL      RDWBSE1                    * get hospital
.
          MATCH     WBSEHOSP,PMVXMHOS          * Only show visits for logged
          GOTO      PREVAD10 IF NOT EQUAL
          GOTO      PREVAD90
.
PREVAD50  PACK      KEY13,USERID,SP70              * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
            CALL      RDMLSEC1
            GOTO      PREVAD10 IF NOT EQUAL
          ENDIF
.
          GOTO      PREVAD90
.
PREVAD80  MOVE      EPSCD001,EPSNUMBR
          GOTO      PREVAD95
.
PREVAD90  REP       " +",URNUMBER
          REP       " +",VISITNUM
          REP       " +",EPSNUMBR
.
          WRITE     HTMLFILE;"mrtweb02.pbl":
                                 "?reportno=03":
                                 "&template=001":
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",VISITNUM:
                                 "&epscd001=",EPSNUMBR:
                                 "&admisdte=",PVIDATE;
.
          REP       "+ ",URNUMBER
          REP       "+ ",VISITNUM
          REP       "+ ",EPSNUMBR
.
.  Now do reads on current admission as not to lose details for following 
.  profield output tags
.
PREVAD95  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,PREVAD99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PREVAD99
.
PREVAD99  RETURN
.----------------------------------------------------------------
.                         NEXTAD00  
.  Previous Admission Record for Patient
.----------------------------------------------------------------
NEXTAD00  MOVE      ZERO,EPSNUMBR 
          MOVE      ADMISSNO,VISITNUM
.
          PACK      KEY24,URNUMBER,ADMISDTE,ADMISSNO,SP70
          CALL      RSPTVIS2
NEXTAD10  CALL      RKPTVIS2
          BRANCH    OVRCD,NEXTAD80
.
          MATCH     URNUMBER,PVIURNO
          GOTO      NEXTAD80 IF NOT EQUAL              
.
          MATCH     ADMISSNO,DPVIBILL
          GOTO      NEXTAD10 IF EQUAL    * Don't want same ADMISSNO          
.
          COMPARE   THREE,PVITYPE    
          GOTO      NEXTAD10 IF NOT EQUAL              
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,NEXTAD10
.
          COMPARE   "3",ASTAT                   * Discharged only
          GOTO      NEXTAD10 IF NOT EQUAL              
.
          CALL      RDPMVX11
          BRANCH    OVRCD,NEXTAD10
.
          MOVE      PVIURNO,URNUMBER
          MOVE      DPVIBILL,VISITNUM
          CALL      GETEPS00         * Get Episode No for Admission record 
          MATCH     " 0",EPSNUMBR
          IF        @EQUAL
            MOVE      ONE,EPSNUMBR   * Set to Default to 1
          ENDIF
.
          IF        IBCNMHOS <> 1
            GOTO      NEXTAD90
          ENDIF
.
. Centralised coding
.
          MATCH     "1",MRCNCCOD               * Using centralise coding
          GOTO      NEXTAD50 IF EQUAL
.
          PACK      KEY10,USERID,SP70          * Re read logged in user to
          CALL      RDWBSE1                    * get hospital
.
          MATCH     WBSEHOSP,PMVXMHOS          * Only show visits for logged
          GOTO      NEXTAD10 IF NOT EQUAL
          GOTO      NEXTAD90
.
NEXTAD50  PACK      KEY13,USERID,SP70              * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
            CALL      RDMLSEC1
            GOTO      NEXTAD10 IF NOT EQUAL
          ENDIF
.
          GOTO      NEXTAD90
.
NEXTAD80  MOVE      EPSCD001,EPSNUMBR
          GOTO      NEXTAD95
.
NEXTAD90  REP       " +",URNUMBER
          REP       " +",VISITNUM
          REP       " +",EPSNUMBR
.
          WRITE     HTMLFILE;"mrtweb02.pbl":
                                 "?reportno=03":
                                 "&template=001":
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",VISITNUM:
                                 "&epscd001=",EPSNUMBR:
                                 "&admisdte=",PVIDATE;
.
          REP       "+ ",URNUMBER
          REP       "+ ",VISITNUM
          REP       "+ ",EPSNUMBR
.
.  Now do reads on current admission as not to lose details for following 
.  profield output tags
.
NEXTAD95  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,NEXTAD99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,NEXTAD99
.
NEXTAD99  RETURN
.----------------------------------------------------------------
.  Get a Patients first existing Episode for this admission no.
.  Else return " 0" in EPSNUMBR
.----------------------------------------------------------------
GETEPS00  MOVE      SP70,EPSNUMBR  * Episode No - Return Variable
          MOVE      ZERO,ECDFLAG   * Diagnosis Episode Flag
          MOVE      ZERO,ECOFLAG   * Procedure Episode Flag
.
          PACK      KEY13,VISITNUM,SP70   * Check Diagnosis Coding file
          CALL      RSPTECD1
GETEPS10  CALL      RKPTECD1
          IF        OVRCD=1
            MOVE      ONE,ECDFLAG
            GOTO      GETEPS20
          ENDIF
.
          MATCH     VISITNUM,DPTEDADM    * Check for Admission No 
          IF        !@EQUAL
            MOVE      ONE,ECDFLAG
            GOTO      GETEPS20
          ENDIF
.
          MATCH     SP70,PTEDCODE   
          IF        !@EQUAL
            MOVE      PTEDEPNO,EPSNUMBR  * Only need First Episode found!
            GOTO      GETEPS99
          ENDIF
.
GETEPS20  PACK      KEY13,VISITNUM,SP70   * Check Procedures Coding File
          CALL      RSPTECO1
GETEPS21  CALL      RKPTECO1
          IF        OVRCD=1
            MOVE      ONE,ECOFLAG
            GOTO      GETEPS90
          ENDIF
.
          MATCH     VISITNUM,DPTEOADM    * Check for Admission No 
          IF        !@EQUAL
            MOVE      ONE,ECOFLAG
            GOTO      GETEPS90
          ENDIF
.
          MATCH     SP70,PTEOCODE   
          IF        !@EQUAL
            MOVE      PTEOEPNO,EPSNUMBR  * Only need First Episode found
            GOTO      GETEPS99
          ENDIF
.
          IF        ECDFLAG=1 
            GOTO    GETEPS21
          ELSE  
            GOTO    GETEPS10
          ENDIF
.
GETEPS90  MATCH     SP70,EPSNUMBR    * If nothing is found then default values
          IF        @EQUAL
            RESET     EPSNUMBR
            MOVE      " 0",EPSNUMBR
          ENDIF
.
GETEPS99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of Episode numbers for a given Admission
.                   ******** SELEPS00 ********
.----------------------------------------------------------------
SELEPS00  MOVE      ZERO,F2
          REPEAT
            ADD       ONE,F2
            MOVE      ZERO,EPSSLIST[F2]
          UNTIL     F2 = 99
.
          MOVE      " 1",DIM2               * Check Disease Coding    *C-240107
          PACK      KEY13,ADMISSNO,DIM2,SP70
          CALL      RSPTECD1
SELEPS10  CALL      RKPTECD1
          BRANCH    OVRCD,SELEPS20
.
          MATCH     ADMISSNO,DPTEDADM       * Check for Admission No
          GOTO      SELEPS20 IF NOT EQUAL
.
          MATCH     SP70,PTEDCODE
          IF        !@EQUAL
            MOVE      ONE,EPSSLIST[PTEDEPNO]
          ENDIF
          GOTO      SELEPS10
.
.
SELEPS20  MOVE      " 1",DIM2               * Check Oper Coding File  *C-240107
          PACK      KEY13,ADMISSNO,DIM2,SP70
          CALL      RSPTECO1
SELEPS30  CALL      RKPTECO1
          BRANCH    OVRCD,SELEPS50
.
          MATCH     ADMISSNO,DPTEOADM       * Check for Admission No
          GOTO      SELEPS50 IF NOT EQUAL
.
          MATCH     SP70,PTEOCODE
          IF        !@EQUAL
            MOVE      ONE,EPSSLIST[PTEOEPNO]
          ENDIF
          GOTO      SELEPS30
.
.
SELEPS50  MOVE      ZERO,F2
          REPEAT
            ADD       ONE,F2
            IF        EPSSLIST[F2] = 1
              MOVE      F2,KEY2
              IF        F2 = EPSCD001
                WRITE     HTMLFILE;"<option value=#"",KEY2,"#" selected>":
                                    KEY2,"</option>"
              ELSE
.               * only one Episode is in the select list if LOCKEPNO equals 1
                IF        LOCKEPNO <> 1
                  WRITE     HTMLFILE;"<option value=#"",KEY2,"#">":
                                      KEY2,"</option>"
                ENDIF
              ENDIF
            ENDIF
          UNTIL     F2 = 99
.
SELEPS99  RETURN
+
.******************************************************************************
.*                                  GDRG0000                                  *
.*                              Get The DRG Code                              *
.******************************************************************************
GDRG0000  MATCH     SP8,DDATE
          GOTO      GDRG9000 IF EQUAL       * Patient not discharged
.                                                                    *I-0852793
          MATCH     PTCNE120,DDATE          * disc.date > DRG 12.0 effect.date?
          IF        !@LESS
            MOVE      DRG120,DRGVERS        * Use 12.0 DRG version    
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNE110,DDATE          * disc.date > DRG 11.0 effect.date?
          IF        !@LESS
            MOVE      DRG110,DRGVERS        * Use 11.0 DRG version    
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNE100,DDATE          * disc.date > DRG 10.0 effect.date?
          IF        !@LESS
            MOVE      DRG100,DRGVERS        * Use 10.0 DRG version    
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED90,DDATE          * disc.date > DRG 9.0 effect.date?
          IF        !@LESS
            MOVE      DRG090,DRGVERS        * Use 9.0 DRG version    
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED80,DDATE          * disc.date > DRG 8.0 effect.date?
          IF        !@LESS
            MOVE      DRG080,DRGVERS        * Use 8.0 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED70,DDATE          * disc.date > DRG 7.0 effect.date?
          IF        !@LESS
            MOVE      DRG070,DRGVERS        * Use 7.0 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED62,DDATE          * disc.date > DRG 6.2 effect.date?
          IF        !@LESS
            MOVE      DRG062,DRGVERS        * Using 6.2 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED60,DDATE          * disc.date > DRG 6.0 effect.date?
          IF        !@LESS
            MOVE      DRG060,DRGVERS        * Using 6.0 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED52,DDATE          * disc.date > DRG 5.2 effect.date?
          IF        !@LESS
            MOVE      DRG052,DRGVERS        * Using 5.2 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED51,DDATE          * disc.date > DRG 5.1 effect.date?
          IF        !@LESS
            MOVE      DRG051,DRGVERS        * Using 5.1 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED50,DDATE          * disc.date > DRG 5.0 effect.date?
          IF        !@LESS
            MOVE      DRG050,DRGVERS        * Using 5.0 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED42,DDATE          * disc.date > DRG 4.2 effect.date?
          IF        !@LESS
            MOVE      DRG042,DRGVERS        * Using 4.2 DRG version
            GOTO      GDRG1000
          ENDIF
.
          MATCH     PTCNED41,DDATE          * disc.date > DRG 4.1 effect.date?
          IF        !@LESS
            MOVE      DRG041,DRGVERS        * Using 4.1 DRG version
            GOTO      GDRG1000
          ENDIF
.
          GOTO      GDRG9000
.
GDRG1000  PACK      KEY13,AADMNO,EPSCD001,DRGVERS
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,GDRG9000
.
          GOTO      GDRG9999
.
GDRG9000  MOVE      SP4,DDRGCODE            * no DRG found
GDRG9999  RETURN
+
.------------------------------------------------------------
.                     DRG Details  
.      0.Description, 1.Code, 2.Low Trim, 3.High Trim 
.      INPUT PARAMETER : DDRGCODE
.------------------------------------------------------------
DISDRG00  UNPACK    DIM127,DIM1,KEY1,DIM127   
          MOVE      KEY1,F1 
.
          MATCH     SP70,DDRGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
            GOTO      DISDRG99
          ENDIF
.
          PACK      KEY4,DDRGCODE,SP70
          PACK      KEY7,KEY4,DRGVER,SP10   * from DRGVERZ or DRGVERHF *C-147943
          CALL      RDPTDGW1
          IF        OVRCD <> 0
            PACK      KEY7,KEY4,LAST,SP10   * otherwise get lastest description
            CALL      RSPTDGW1
            CALL      RPPTDGW1
            BRANCH    OVRCD,DISDRG90
            MATCH     PTDWDRGC,KEY4         * the same DRG code ?     *I-137125
            GOTO      DISDRG90 IF NOT EQUAL                           *I-137125
          ENDIF
.
          BRANCH    F1,DISDRG10,DISDRG20,DISDRG30
          STRIP     PTDWDESC
          WRITE     HTMLFILE;*+,PTDWDESC,SP1; * Description
          RESET     PTDWDESC
          GOTO      DISDRG99
.
DISDRG10  WRITE     HTMLFILE;PTDWDRGC;  * Code
          GOTO      DISDRG99
.
DISDRG20  WRITE     HTMLFILE;PTDWLOWT;  * Low Trim
          GOTO      DISDRG99
.
DISDRG30  WRITE     HTMLFILE;PTDWHIGH;  * High Trim
          GOTO      DISDRG99
.
DISDRG90  IF        F1 = ZERO
            WRITE     HTMLFILE;"DRG description not found";
          ENDIF
          IF        F1 = ONE 
            WRITE     HTMLFILE;"DRG code not found";
          ENDIF
          IF        F1 > ONE
            WRITE     HTMLFILE;"DRG weightings record not found";
          ENDIF
          GOTO      DISDRG99
.
DISDRG99  RETURN
.------------------------------------------------------------
.           **** WIES Details by discharge date ****
. 0.LOS, 1.Low Trim, 2.High Trim 
. INPUT PARAMETER : DDRGCODE
.------------------------------------------------------------
WIES0000  UNPACK    DIM127,DIM1,KEY1,DIM127   
          MOVE      ZERO,VIEWFLAG 
          MOVE      KEY1,VIEWFLAG
.
          CALL      CLPATDSC                                          *I-241939
          PACK      DDATE,CCC,CYY,CMM,CDD                             *I-241939
          PACK      KEY8,ADMISSNO,SP70  * Patient must be discharged!
          CALL      RDDSCH1
          IF        MRCNEPSC <> 1
            BRANCH    OVRCD,WIES9000
          ENDIF
...
.--------------------------------------------------------------------
...       if using NWAU and the discharge date is after the NWAU
...          go live date, then use NWAU 2022 - N22.
...       If using 10.0 Grouper then:                                 *I-0893634
...          If Discharge date >= 2020/07/01 use WIES27.
...       If using 10.0 Grouper then:                                 *I-0880255
...          If Discharge date >= 2019/07/01 use WIES26.
...       If using 9.0 Grouper then:                                  *I-0852793
...          If Discharge date >= 2019/07/01 use WIES26.
...          If Discharge date >= 2018/07/01 use WIES25.
...       If using 8.0 Grouper then:                                  *I-0842626
...          If Discharge date >= 2017/07/01 use WIES24.
...          If Discharge date >= 2016/07/01 use WIES23.
...       If using 7.0 Grouper then:                                  *I-284669
...          If Discharge date >= 2015/07/01 use WIES22.
...          If Discharge date >= 2014/07/01 use WIES21.
...          If Discharge date >= 2013/07/01 use WIES20.
...          If Discharge date >= 2012/07/01 use WIES19.
...          If Discharge date >= 2011/07/01 use WIES18.
...          If Discharge date >= 2010/07/01 use WIES17.
...          If Discharge date >= 2009/07/01 use WIES16.
...          If Discharge date >= 2008/07/01 use WIES15.
...       If using 6.2 Grouper then:                                  *I-267797
...          If Discharge date >= 2012/07/01 use WIES19.
...          If Discharge date >= 2011/07/01 use WIES18.
...          If Discharge date >= 2010/07/01 use WIES17.
...          If Discharge date >= 2009/07/01 use WIES16.
...          If Discharge date >= 2008/07/01 use WIES15.
...       If using 6.0 Grouper then:                                  *I-197814
...          If Discharge date >= 2012/07/01 use WIES19.
...          If Discharge date >= 2011/07/01 use WIES18.
...          If Discharge date >= 2010/07/01 use WIES17.
...          If Discharge date >= 2009/07/01 use WIES16.
...          If Discharge date >= 2008/07/01 use WIES15.
...       If using 5.2 Grouper then:
...          If Discharge date >= 2008/07/01 use WIES15.
...          If Discharge date >= 2007/07/01 use WIES14.
...       If using 5.1 Grouper then:
...          If Discharge date >= 2006/07/01 use WIES13.
...       If using 5.0 Grouper then:
...          If Discharge date >= 2004/07/01 use WIES12.
...          else If Discharge date >= ICD10v4 Cutover use WIES12 
...                                    ( go-live earlier than 2004/07/01)
...            else use WIES11.
...
...       If using 4.2 Grouper then:
...            use WIES11.
...
...       Anything other use WIES12
.--------------------------------------------------------------------
.
WIES1000  MOVE     SP1,KEY1
          MATCH     SP70,DDRGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
            GOTO      WIES9999
          ENDIF
.
          MATCH     "1",PTCNUABF             * Check if using ABF
          IF        @EQUAL
            CALL      LCNT0000               * Check for a valid contract id
.
            MATCH     SP70,CONTRCID          * Valid contract
            GOTO      WIES6200 IF NOT EQUAL     
          ELSE
.           Using NWAU and discharge after go live date use NWAU 2022 - N22
            MATCH     "1",MRCNUNWA       * Grouping Products to return NWAU
            IF        @EQUAL
              MATCH     MRCNENWA,DDATE   * Use NWAU for discharges after date
              GOTO      WIES5200 IF NOT LESS
            ENDIF
          ENDIF
.
.         * Check DRG version. For 12.0 - WIES27-11?                  * 0956210
          MATCH     DRG120,PTCNDGPV         * 12.0 DRG
          GOTO      WIES1030 IF EQUAL
.                                                                     *I-0852793
.         * Check DRG version. For 11.0 - WIES27-11?                  * 0917793
          MATCH     DRG110,PTCNDGPV         * 11.0 DRG
          GOTO      WIES1030 IF EQUAL
.                                                                     *I-0852793
.         * Check DRG version. For 10.0 - WIES27-11?                  * 0880255
          MATCH     DRG100,PTCNDGPV         * 10.0 DRG
          GOTO      WIES1030 IF EQUAL
.                                                                     *I-0852793
.         * Check DRG version. For 9.0 - WIES25-11?
          MATCH     DRG090,PTCNDGPV         * 9.0 DRG
          GOTO      WIES1030 IF EQUAL
.                                                                     *I-284669
.         * Check DRG version. For 8.0 - WIES24,23,22,21,20,19,18,17,16,15,14,13
          MATCH     DRG080,PTCNDGPV         * 8.0 DRG
          GOTO      WIES1040 IF EQUAL
.
.         * Check DRG version. For 7.0 - WIES22,21,20,19,18,17,16,15,14,13,12,11
          MATCH     DRG070,PTCNDGPV         * 7.0 DRG
          GOTO      WIES1050 IF EQUAL
.                                                                     *I-267797
.         * Check DRG version. For 6.2 - WIES 19,18,17,16,15,14,13,12,11,10
          MATCH     DRG062,PTCNDGPV         * 6.2 DRG
          GOTO      WIES1050 IF EQUAL
.                                                                     *I-197814
.         * Check DRG version. For 6.0 - WIES 19,18,17,16,15,14,13,12,11,10
          MATCH     DRG060,PTCNDGPV         * 6.0 DRG (01/07/2011)
          GOTO      WIES1050 IF EQUAL
.                                                                     *I-137125
.         * Check DRG version. For 5.2 - support WIES 15,14,13,12,11,10
          MATCH     DRG052,PTCNDGPV         * 5.2 DRG (01/07/2008)
          GOTO      WIES1060 IF EQUAL
.
.         * Check DRG version. For 5.1 only support WIES 13,12,11,10    *I-51504
          MATCH     DRG051,PTCNDGPV         * 5.1 DRG (01/07/2006)
          GOTO      WIES1070 IF EQUAL
.
.         * Check DRG version. For 5.0 only support WIES 12,11,10      *I-51504
          MATCH     DRG050,PTCNDGPV         * 5.0 DRG (01/07/2004)
          GOTO      WIES1080 IF EQUAL
.
.         * Check DRG version. For 4.2 only support WIES 11,10,9       *I-51504
          MATCH     DRG042,PTCNDGPV         * 4.2 DRG
          GOTO      WIES1090 IF EQUAL
.
          GOTO      WIES1200                * default to WIES12.
.
.        --------------------- Check WIES 26
.
WIES1030  MATCH     "20200701",DDATE      * 20/21 Fin year (DRG 10.0)
          IF        !@LESS
            GOTO      WIES2700            * using WIES27
          ENDIF
.
          MATCH     "20190701",DDATE      * 19/20 Fin year (DRG 9.0 DRG 10.0)
          IF        !@LESS
            GOTO      WIES2600            * using WIES26
          ENDIF
.
.        --------------------- Check WIES 25
.
          MATCH     "20180701",DDATE      * 18/19 Fin year (DRG 9.0 DRG 10.0)
          IF        !@LESS
            GOTO      WIES2500            * using WIES25
          ENDIF
.
.        --------------------- Check WIES 24,23
.
WIES1040  MATCH     "20170701",DDATE      * 17/18 Fin year (DRG 8.0)
          IF        !@LESS
            GOTO      WIES2400            * using WIES24
          ENDIF
.
          MATCH     "20160701",DDATE      * 16/17 Fin year (DRG 8.0)
          IF        !@LESS
            GOTO      WIES2300            * using WIES23
          ENDIF
.
.        --------------------- Check WIES 22,21,20,19,18,17,16,15,14,13,12,11,10
.
WIES1050  MATCH     "20150701",DDATE      * 15/16 Fin year (DRG 7.0)
          IF        !@LESS
            GOTO      WIES2200            * using WIES22
          ENDIF
          MATCH     "20140701",DDATE      * 14/15 Fin year (DRG 7.0)
          IF        !@LESS
            GOTO      WIES2100            * using WIES21
          ENDIF
          MATCH     "20130701",DDATE      * 13/14 Fin year (DRG 7.0)
          IF        !@LESS
            GOTO      WIES2000            * using WIES20
          ENDIF
          MATCH     "20120701",DDATE      * 12/13 Fin year (DRG 6.0 6.2)
          IF        !@LESS
            GOTO      WIES1900            * using WIES19
          ENDIF
          MATCH     "20110701",DDATE      * 11/12 Fin year (DRG 6.0 6.2)
          IF        !@LESS
            GOTO      WIES1800            * using WIES18
          ENDIF
          MATCH     "20100701",DDATE      * 10/11 Fin year
          IF        !@LESS
            GOTO      WIES1700            * using WIES17
          ENDIF
          MATCH     "20090701",DDATE      * 09/10 Fin year
          IF        !@LESS
            GOTO      WIES1600            * using WIES16
          ENDIF
.
WIES1060  MATCH     "20080701",DDATE      * 08/09 Fin year (DRG 5.2 6.0 6.2)
          IF        !@LESS
            GOTO      WIES1500            * using WIES15
          ENDIF
          MATCH     "20070701",DDATE      * 07/08 Fin year
          IF        !@LESS
            GOTO      WIES1400            * using WIES14
          ENDIF
.
WIES1070  MATCH     "20060701",DDATE      * 06/07 Fin year (DRG 5.1 5.2 6.0 6.2)
          IF        !@LESS
            GOTO      WIES1300            * using WIES13
          ENDIF
          MATCH     "20040701",DDATE      * 04/05 Fin year
          IF        !@LESS
            GOTO      WIES1200            * using WIES12
          ENDIF
          MATCH     PTCNGDV5,DDATE        * 05/06 ICD10 Ed.5 go-live
          IF        !@LESS
            GOTO      WIES1200            * using WIES12
          ENDIF
          MATCH     PTCNGDV4,DDATE        * 04/05 ICD10 Ed.4 cutover
          IF        !@LESS
            GOTO      WIES1200            * using WIES12
          ENDIF
          GOTO      WIES1100              * default to WIES11
.
.                                                          ** Older stuff
WIES1080  MATCH     "20040701",DDATE      * 04/05 Fin year (DRG 5.0
          IF        !@LESS
            GOTO      WIES1200            * using WIES12 (5.0 DRG)
          ENDIF
          MATCH     PTCNGDV4,DDATE        * 04/05 ICD10 cutover early
          IF        !@LESS
            GOTO      WIES1200            * using WIES12 (5.0 DRG)
          ENDIF
          GOTO      WIES1100              * default to WIES11 (5.0 DRG)
.
.         * Check DRG version. For 4.2 only support WIES 11,10,9       *I-51504
WIES1090  MATCH     "20030701",DDATE      * 03/04 Fin year
          IF        !@LESS
            GOTO      WIES1100            * using WIES11 (4.2 DRG)
          ENDIF
.
          GOTO      WIES1200                * default to WIES12.
.
.
.     ***** WIES 11 *****                                              *I-902B1
.
WIES1100  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT111
          BRANCH    OVRCD,WIES9005
.
          BRANCH    VIEWFLAG,WIES1101,WIES1102,WIES9999,WIES9999,WIES1105
.
          WRITE     HTMLFILE;PT11ILOS;  * LOS
          GOTO      WIES9999
.
WIES1101  WRITE     HTMLFILE;PT11LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1102  WRITE     HTMLFILE;PT11HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1105  WRITE     HTMLFILE;PT11DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 12 *****                                              *I-51504
.
WIES1200  PACK      KEY4,DDRGCODE,SP70
          MATCH     "20050701",DDATE
          IF        !@LESS
            CALL      RDPT12B1
            BRANCH    OVRCD,WIES9007
          ELSE
            CALL      RDPT121
            BRANCH    OVRCD,WIES9006
          ENDIF
.
          BRANCH    VIEWFLAG,WIES1201,WIES1202,WIES1203,WIES1204,WIES1205
.
          WRITE     HTMLFILE;PT12ILOS;  * LOS
          GOTO      WIES9999
.
WIES1201  WRITE     HTMLFILE;PT12LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1202  WRITE     HTMLFILE;PT12HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1203  WRITE     HTMLFILE;PT12TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1204  WRITE     HTMLFILE;PT12TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1205  WRITE     HTMLFILE;PT12DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 13 *****
.
WIES1300  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT131
          BRANCH    OVRCD,WIES9008
.
          BRANCH    VIEWFLAG,WIES1301,WIES1302,WIES1303,WIES1304,WIES1305
.
          WRITE     HTMLFILE;PT13ILOS;  * LOS
          GOTO      WIES9999
.
WIES1301  WRITE     HTMLFILE;PT13LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1302  WRITE     HTMLFILE;PT13HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1303  WRITE     HTMLFILE;PT13TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.         
WIES1304  WRITE     HTMLFILE;PT13TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1305  WRITE     HTMLFILE;PT13DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 14 *****
.
WIES1400  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT141
          BRANCH    OVRCD,WIES9009
.
          BRANCH    VIEWFLAG,WIES1401,WIES1402,WIES1403,WIES1404,WIES1405
.
          WRITE     HTMLFILE;PT14ILOS;  * LOS
          GOTO      WIES9999
.
WIES1401  WRITE     HTMLFILE;PT14LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1402  WRITE     HTMLFILE;PT14HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1403  WRITE     HTMLFILE;PT14TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.         
WIES1404  WRITE     HTMLFILE;PT14TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1405  WRITE     HTMLFILE;PT14DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 15 *****
.
WIES1500  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT151
          BRANCH    OVRCD,WIES9010
.
          BRANCH    VIEWFLAG,WIES1501,WIES1502,WIES1503,WIES1504,WIES1505
.
          WRITE     HTMLFILE;PT15ILOS;  * LOS
          GOTO      WIES9999
.
WIES1501  WRITE     HTMLFILE;PT15LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1502  WRITE     HTMLFILE;PT15HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1503  WRITE     HTMLFILE;PT15TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1504  WRITE     HTMLFILE;PT15TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1505  WRITE     HTMLFILE;PT15DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 16 *****
.
WIES1600  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT161
          BRANCH    OVRCD,WIES9011
.
          BRANCH    VIEWFLAG,WIES1601,WIES1602,WIES1603,WIES1604,WIES1605
.
          WRITE     HTMLFILE;PT16ILOS;  * LOS
          GOTO      WIES9999
.
WIES1601  WRITE     HTMLFILE;PT16LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1602  WRITE     HTMLFILE;PT16HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1603  WRITE     HTMLFILE;PT16TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1604  WRITE     HTMLFILE;PT16TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1605  WRITE     HTMLFILE;PT16DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 17 *****
.
WIES1700  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT171
          BRANCH    OVRCD,WIES9012
.
          BRANCH    VIEWFLAG,WIES1701,WIES1702,WIES1703,WIES1704,WIES1705
.
          WRITE     HTMLFILE;PT17ILOS;  * LOS
          GOTO      WIES9999
.
WIES1701  WRITE     HTMLFILE;PT17LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1702  WRITE     HTMLFILE;PT17HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1703  WRITE     HTMLFILE;PT17TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1704  WRITE     HTMLFILE;PT17TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1705  WRITE     HTMLFILE;PT17DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 18 *****
.
WIES1800  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT181
          BRANCH    OVRCD,WIES9013
.
          BRANCH    VIEWFLAG,WIES1801,WIES1802,WIES1803,WIES1804,WIES1805
.
          WRITE     HTMLFILE;PT18ILOS;  * LOS
          GOTO      WIES9999
.
WIES1801  WRITE     HTMLFILE;PT18LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1802  WRITE     HTMLFILE;PT18HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1803  WRITE     HTMLFILE;PT18TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1804  WRITE     HTMLFILE;PT18TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1805  WRITE     HTMLFILE;PT18DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 19 *****
.
WIES1900  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT191
          BRANCH    OVRCD,WIES9014
.
          BRANCH    VIEWFLAG,WIES1901,WIES1902,WIES1903,WIES1904,WIES1905
.
          WRITE     HTMLFILE;PT19ILOS;  * LOS
          GOTO      WIES9999
.
WIES1901  WRITE     HTMLFILE;PT19LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1902  WRITE     HTMLFILE;PT19HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES1903  WRITE     HTMLFILE;PT19TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES1904  WRITE     HTMLFILE;PT19TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES1905  WRITE     HTMLFILE;PT19DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 20 *****
.
WIES2000  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT201
          BRANCH    OVRCD,WIES9015
.
          BRANCH    VIEWFLAG,WIES2001,WIES2002,WIES2003,WIES2004,WIES2005
.
          WRITE     HTMLFILE;PT20ILOS;  * LOS
          GOTO      WIES9999
.
WIES2001  WRITE     HTMLFILE;PT20LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2002  WRITE     HTMLFILE;PT20HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2003  WRITE     HTMLFILE;PT20TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2004  WRITE     HTMLFILE;PT20TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2005  WRITE     HTMLFILE;PT20DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 21 *****
.
WIES2100  PACK      KEY4,DDRGCODE,SP70
          CALL      RDPT211
          BRANCH    OVRCD,WIES9016
.
          BRANCH    VIEWFLAG,WIES2101,WIES2102,WIES2103,WIES2104,WIES2105
.
          WRITE     HTMLFILE;PT21ILOS;  * LOS
          GOTO      WIES9999
.
WIES2101  WRITE     HTMLFILE;PT21LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2102  WRITE     HTMLFILE;PT21HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2103  WRITE     HTMLFILE;PT21TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2104  WRITE     HTMLFILE;PT21TSDW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2105  WRITE     HTMLFILE;PT21DRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 22 *****
.
WIES2200  MOVE      "022",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9017
.
          BRANCH    VIEWFLAG,WIES2201,WIES2202,WIES2203,WIES2204,WIES2205
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2201  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2202  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2203  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2204  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2205  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 23 *****
.
WIES2300  MOVE      "023",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9018
.
          BRANCH    VIEWFLAG,WIES2301,WIES2302,WIES2303,WIES2304,WIES2305
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2301  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2302  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2303  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2304  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2305  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 24 *****
.
WIES2400  MOVE      "024",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9019
.
          BRANCH    VIEWFLAG,WIES2401,WIES2402,WIES2403,WIES2404,WIES2405
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2401  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2402  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2403  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2404  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2405  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 25 *****
.
WIES2500  MOVE      "025",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9020
.
          BRANCH    VIEWFLAG,WIES2501,WIES2502,WIES2503,WIES2504,WIES2505
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2501  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2502  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2503  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2504  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2505  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 26 *****
.
WIES2600  MOVE      "026",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9022
.
          BRANCH    VIEWFLAG,WIES2601,WIES2602,WIES2603,WIES2604,WIES2605
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2601  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2602  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2603  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2604  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2605  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** WIES 27 *****
.
WIES2700  MOVE      "027",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9022
.
          BRANCH    VIEWFLAG,WIES2701,WIES2702,WIES2703,WIES2704,WIES2705
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES2701  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2702  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES2703  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES2704  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES2705  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.     ***** NWAU 2022 *****
.
WIES5200  MOVE      "N22",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES9023
.
          BRANCH    VIEWFLAG,WIES5201,WIES5202,WIES5203,WIES5204,WIES5205
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES9999
.
WIES5201  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES5202  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES5203  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES5204  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES9999
.
WIES5205  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES9999
.
.
.     ***** ABF *****
.
WIES6200  PACK      KEY10,CONTRCID,DDRGCODE,SP70
          CALL      RSPMPWA1
          BRANCH    OVRCD,WIES9024
.
          BRANCH    VIEWFLAG,WIES6201,WIES6202,WIES6203,WIES6204,WIES6205
.
          WRITE     HTMLFILE;PMPWALOS;  * LOS
          GOTO      WIES9999
.
WIES6201  WRITE     HTMLFILE;PMPWLOWB;  * Low Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES6202  WRITE     HTMLFILE;PMPWUPPB;  * High Inliner Boundary Point(days)
          GOTO      WIES9999
.
WIES6203                                * Total Inlier Multiday Weight
          GOTO      WIES9999
.
WIES6204                                * Total Same Day Weight
          GOTO      WIES9999
.
WIES6205  WRITE     HTMLFILE;PMPWDRGD;  * DRG Description
          GOTO      WIES9999

.
.         Error handling
.
WIES9000  WRITE     HTMLFILE;"Patient is not Discharged!";
          GOTO      WIES9999
.
...WIES9001  WRITE     HTMLFILE;"DRG Code not found on patvw7af!";     *D-51504
...          GOTO      WIES9999                                        *D-51504
.
WIES9002  WRITE     HTMLFILE;"DRG Code not found on patvw8af!";
          GOTO      WIES9999
.
WIES9003  WRITE     HTMLFILE;"DRG Code not found on patvw9af!";
          GOTO      WIES9999
.
WIES9004  WRITE     HTMLFILE;"DRG Code not found on patw10af!";
          GOTO      WIES9999
.
WIES9005  WRITE     HTMLFILE;"DRG Code not found on patw11af!";        *I-902B1
          GOTO      WIES9999                                           *I-902B1
.
WIES9006  WRITE     HTMLFILE;"DRG Code not found on patw12af!";        *I-51504
          GOTO      WIES9999                                           *I-51504
.
WIES9007  WRITE     HTMLFILE;"DRG Code not found on patw12bf!";
          GOTO      WIES9999 
.
WIES9008  WRITE     HTMLFILE;"DRG Code not found on patw13af!";
          GOTO      WIES9999 
.
WIES9009  WRITE     HTMLFILE;"DRG Code not found on patw14af!";
          GOTO      WIES9999 
.
WIES9010  WRITE     HTMLFILE;"DRG Code not found on patw15af!";
          GOTO      WIES9999 
.
WIES9011  WRITE     HTMLFILE;"DRG Code not found on patw16af!";
          GOTO      WIES9999
.
WIES9012  WRITE     HTMLFILE;"DRG Code not found on patw17af!";
          GOTO      WIES9999
.
WIES9013  WRITE     HTMLFILE;"DRG Code not found on patw18af!";        
          GOTO      WIES9999                                     
.
WIES9014  WRITE     HTMLFILE;"DRG Code not found on patw19af!";
          GOTO      WIES9999
.
WIES9015  WRITE     HTMLFILE;"DRG Code not found on patw20af!";
          GOTO      WIES9999
.
WIES9016  WRITE     HTMLFILE;"DRG Code not found for WIES 21";
          GOTO      WIES9999
.
WIES9017  WRITE     HTMLFILE;"DRG Code not found for WIES 22";
          GOTO      WIES9999
.
WIES9018  WRITE     HTMLFILE;"DRG Code not found for WIES 23";
          GOTO      WIES9999
.
WIES9019  WRITE     HTMLFILE;"DRG Code not found for WIES 24";
          GOTO      WIES9999
.
WIES9020  WRITE     HTMLFILE;"DRG Code not found for WIES 25";
          GOTO      WIES9999
.
WIES9021  WRITE     HTMLFILE;"DRG Code not found for WIES 26";
          GOTO      WIES9999
.
WIES9022  WRITE     HTMLFILE;"DRG Code not found for WIES 27";
          GOTO      WIES9999
.
WIES9023  WRITE     HTMLFILE;"DRG Code not found for NWAU 2022";
          GOTO      WIES9999
.
WIES9024  WRITE     HTMLFILE;"DRG Code not found for ABF contract";
          GOTO      WIES9999
.
WIES9999  RETURN
.*************************************************************************
.  Out put Coder ID:  0.Date 1.Time  
.*************************************************************************
CODUSR00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
.
          MOVE      ONE,PTEDEPNO
          MOVE      ONE,PTEDCNT
          PACK      KEY13,ADMISSNO,PTEDEPNO,PTEDCNT,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,CODUSR20
.
          MATCH     SP70,PTEDUSID         * Web user id
          GOTO      CODUSR05 IF NOT EQUAL
.
          MATCH     SP70,PTEDOPER         * user passcode
          GOTO      CODUSR20 IF EQUAL
.
          PACK      KEY14,PTEDOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3 
          BRANCH    OVRCD,CODUSR20
.
          MATCH     PTEDOPER,WBSEPCD
          GOTO      CODUSR20 IF NOT EQUAL
.
          MOVE      WBSEUID,PTEDUSID
.
CODUSR05  PACK      KEY10,PTEDUSID,SP70   * Read Security File
          CALL      RDWBSE1 
          IF        OVRCD=1
            MOVE      PTEDUSID,WBSENAM
          ENDIF
.
          BRANCH    F1,CODUSR10
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR10  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
.         Check episode operation coding
.
CODUSR20  CALL      RDPTECO1
          BRANCH    OVRCD,CODUSR40
.
          MATCH     SP70,PTEOUSID         * Web user id
          GOTO      CODUSR25 IF NOT EQUAL
.
          MATCH     SP70,PTEOOPER         * user passcode
          GOTO      CODUSR40 IF EQUAL
.
          PACK      KEY14,PTEOOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,CODUSR40
.
          MATCH     PTEOOPER,WBSEPCD
          GOTO      CODUSR40 IF NOT EQUAL
.
          MOVE      WBSEUID,PTEOUSID
.
CODUSR25  PACK      KEY10,PTEOUSID,SP70  * Read Security File
          CALL      RDWBSE1 
          BRANCH    OVRCD,CODUSR40
.
          BRANCH    F1,CODUSR30
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR30  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
.   if operation/disease coding record doesn't exist, use current user
.
CODUSR40  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1 
          BRANCH    F1,CODUSR50,CODUSR99    * Exit if .2 tag
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR50  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
CODUSR99  RETURN
.------------------------------------------------------------
.                         CODFLG00
. Coding Check Box unticked flag
.------------------------------------------------------------
CODFLG00  MOVE      ZERO,ECDFLAG
.
          PACK      KEY13,ADMISSNO,EPSCD001,Z70
          CALL      RSPTECD1
          CALL      RPPTECD1
          IF        OVRCD=1
            MOVE      ONE,ECDFLAG
            GOTO      CODFLG10
          ENDIF
.
          MATCH     ADMISSNO,DPTEDADM
          IF        !@EQUAL
            MOVE      ONE,ECDFLAG
            GOTO      CODFLG10
          ENDIF
.
.         Check episode operation coding
.
CODFLG10  PACK      KEY13,ADMISSNO,EPSCD001,Z70 
          CALL      RSPTECO1
          CALL      RPPTECO1
          IF        OVRCD=1
            IF        ECDFLAG=1  
              GOTO      CODFLG90
            ENDIF
          ENDIF
.
          MATCH     ADMISSNO,DPTEOADM
          IF        !@EQUAL
            IF        ECDFLAG=1  
              GOTO      CODFLG90
            ENDIF
          ENDIF

          WRITE     HTMLFILE;"0";
          GOTO      CODFLG99
.
CODFLG90  WRITE     HTMLFILE;"1";
CODFLG99  RETURN
.
.------------------------------------------------------------
. Coding Date & Time      
. 0.Date 1.Time  
.------------------------------------------------------------
CODDAT00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
          MOVE      ZERO,ECDFLAG   * Diagnosis Episode Flag
          UNPACK    SP70,HIGHDATT,KEY20
.                                                         ( start )   *C-228354
          PACK      KEY13,ADMISSNO,EPSCD001,SP20
          CALL      RSPTECD1
CODDAT05  CALL      RKPTECD1
          BRANCH    OVRCD,CODDAT10
.
          MATCH     ADMISSNO,DPTEDADM       * same Admission ?
          GOTO      CODDAT10 IF NOT EQUAL
          COMPARE   EPSCD001,PTEDEPNO       * same Episode ?
          GOTO      CODDAT10 IF NOT EQUAL
.
          PACK      DIM13,PTEDDTCD,PTEDTIME,SP70
.
          MATCH     DIM13,HIGHDATT
          IF        @LESS
            PACK      HIGHDATT,PTEDDTCD,PTEDTIME,SP70
            PACK      KEY20,DPTEDADM,DPTEDEPN,DPTEDCNT,SP20
          ENDIF
          GOTO      CODDAT05
.
CODDAT10  MATCH     SP8,HIGHDATT
          IF        @EQUAL
            MOVE      ONE,ECDFLAG
            UNPACK    SP70,PTEDDTCD,PTEDCODE,DPTEDCNT,PTEDTIME
          ELSE
            PACK      KEY13,KEY20
            CALL      RDPTECD1              * read Disease with highest date
          ENDIF
.
.         Check episode operation coding
.
CODDAT20  UNPACK    SP70,HIGHDATT,KEY20
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1
CODDAT25  CALL      RKPTECO1
          BRANCH    OVRCD,CODDAT30
.
          MATCH     ADMISSNO,DPTEOADM       * same Admission ?
          GOTO      CODDAT30 IF NOT EQUAL
          COMPARE   EPSCD001,PTEOEPNO       * same Episode ?
          GOTO      CODDAT30 IF NOT EQUAL
.
          PACK      DIM13,PTEODTCD,PTEOTIME,SP70
.
          MATCH     DIM13,HIGHDATT
          IF        @LESS
            PACK      HIGHDATT,PTEODTCD,PTEOTIME,SP70
            PACK      KEY20,DPTEOADM,DPTEOEPN,DPTEOCNT,SP20
          ENDIF
          GOTO      CODDAT25
.
CODDAT30  MATCH     SP8,HIGHDATT
          IF        @EQUAL
            UNPACK    SP70,PTEODTCD,PTEOCODE,DPTEOCNT,PTEOTIME
            IF        ECDFLAG=1
              GOTO      CODDAT60
            ELSE
              MOVE      PTEDDTCD,F8         * Set Disease Date
              MOVE      PTEDTIME,KEY5       * Set Disease Time
              GOTO      CODDAT45
            ENDIF
          ELSE
            PACK      KEY13,KEY20
            CALL      RDPTECO1              * read Procedure with highest date
          ENDIF
.                                           * end of changes for      *C-228354
.
CODDAT40  MATCH     PTEDDTCD,PTEODTCD
          IF        @EQUAL
            MATCH     PTEDTIME,PTEOTIME
            IF        @LESS          
              MOVE      PTEDDTCD,F8       * Set Disease Date
              MOVE      PTEDTIME,KEY5     * Set Disease Time
              GOTO      CODDAT45
            ELSE
              MOVE      PTEODTCD,F8       * Set Procedure Date
              MOVE      PTEOTIME,KEY5     * Set Procedure Time
              GOTO      CODDAT45
            ENDIF
          ENDIF
.
          MATCH     PTEDDTCD,PTEODTCD
          IF        @LESS          
            MOVE      PTEDDTCD,F8       * Set Disease Date
            MOVE      PTEDTIME,KEY5     * Set Disease Time
          ELSE         
            MOVE      PTEODTCD,F8       * Set Procedure Date
            MOVE      PTEOTIME,KEY5     * Set Procedure Time
          ENDIF
.
CODDAT45  COMPARE   ZERO,F8       * Check if F8 has anything init?
          GOTO      CODDAT60 IF EQUAL  
.
          MOVE      F8,KEY8      * Set Date as Dim variable
.
          BRANCH    F1,CODDAT50
.
          REP       " 0",KEY8    
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CODDAT99
.
CODDAT50  WRITE     HTMLFILE;KEY5;
          GOTO      CODDAT99

.       if operation/disease coding record doesn't exist, use current date/time
.
CODDAT60  BRANCH    DISPDTTM,CODDAT99
          BRANCH    F1,CODDAT70
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY4,CCC,CYY
          REP       " 0",KEY4
          MOVE      CDD,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;KEY2,SP1,MTHNAM3,SP1,KEY4;
          GOTO      CODDAT99
.
CODDAT70  WRITE     HTMLFILE;CTIMEIS;
          GOTO      CODDAT99
.
CODDAT99  RETURN
.------------------------------------------------------------
. Automatic Coding Template
.------------------------------------------------------------
CODTMP00  PACK      KEY4,SP70
          CALL      RSMRTHD1
CODTMP10  CALL      RKMRTHD1
          BRANCH    OVRCD,CODTMP99
.
          WRITE     HTMLFILE;"<option value=#"",MRTHTMID,"#"> ":
                             MRTHDESC," </option> "
          GOTO      CODTMP10
.
CODTMP99  RETURN
.------------------------------------------------------------
. Table of Episode Diagnosis Codes 
.------------------------------------------------------------
TDTTB000  MOVE      HUNDRED,CODCOUNT   * Cgi counter/var set to have 3 chars 
          MOVE      ZERO,COUNTER3                                     *C-240107
          MOVE      ZERO,SWAPFLG
          MOVE      ONE,SORTBUTT
          MOVE      ONE,CDCIDBUT
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DIM1,DIM127
.
          MOVE      ZERO,VIEWCCFL
          MOVE      DIM1,VIEWCCFL       * Displaying Contract care flag
.
          CALL      TDTHD000          * Display Heading
.
          IF        MRCNEPSC=1
            IF        EPSCD001=ZERO
              MOVE      ONE,EPSCD001
            ENDIF
            PACK      KEY13,ADMISSNO,EPSCD001,SP70
          ELSE
            MOVE      ONE,EPSCD001
            PACK      KEY13,ADMISSNO,EPSCD001,SP70
          ENDIF
          CALL      RSPTECD1
TDTTB100  CALL      RKPTECD1
          BRANCH    OVRCD,TDTTB900
.
          MATCH     ADMISSNO,DPTEDADM
          GOTO      TDTTB900 IF NOT EQUAL 
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      TDTTB900 IF NOT EQUAL 
.
          CALL      TDTRW000  * Display Row
          GOTO      TDTTB100 
.
TDTTB900  IF        SWAPFLG=0
            WRITE     HTMLFILE;"<input type=hidden name=prfix001 value='P'>";
          ENDIF
.
TDTTB999  RETURN
.------------------------------------------------------------
.------------------------------------------------------------
TDTHD000  MATCH     "999",PTCNDGPV
          IF        @EQUAL
            MOVE      "ICD",DIM5
            SQUEEZE   DIM5
          ELSE
            MOVE      "ICD10",DIM5
          ENDIF          
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td class=HeadingCell width=10%>":
                       DIM5,SP1,"Diagnosis Code</td>":
                       "<td class=HeadingCell width=29%>Description</td>":
                       "<td class=HeadingCell width=15%>":
                       "Contracted Care Flag</td>"
          ELSE
            WRITE     HTMLFILE;"<tr><td class=HeadingCell width=10%>":
                       DIM5,SP1,"Diagnosis Code</td>":
                       "<td class=HeadingCell width=45%>Description</td>"
          ENDIF
.
          COMPARE   ONE,PTCNEDTE  * Displaying Accident Dates
          IF        @EQUAL
          WRITE     HTMLFILE;"<td class=HeadingCell width=7%>Accident Date</td>"
          ENDIF
.
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id & ICD10 ED 13
          IF        @EQUAL
            MATCH     PTCNGDX3,DDATE   * disc.date > ICD10 ED 13 Go live?
            IF        !@LESS
              WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                                 "Cluster ID</td>"
            ENDIF
          ENDIF
.
          MATCH     PTCNED80,DDATE          * disc.date > DRG 8.0 effect.date?
          IF        !@LESS
            WRITE     HTMLFILE;"<td class=HeadingCell width=5%>DCL</td>"
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell width=5%>CCL</td>"
          ENDIF
.
          IF        PTCNHDPS>0
            WRITE     HTMLFILE;"<td class=HeadingCell width=12%>Onset Type</td>"
          ENDIF
.
         WRITE     HTMLFILE;"<td class=HeadingCell width=20%>Sequence</td></tr>"
.
TDTHD999  RETURN
.------------------------------------------------------------
. Diagnosis Codes (TABLE ROW)
.------------------------------------------------------------
TDTRW000  ADD       ONE,CODCOUNT 
.
          PACK      DISP200,SP70,SP70,SP70
          PACK      PT0DDSC2,SP70,SP70,SP70
          PACK      PT0DDESC,SP70,SP70,SP70
.
          PACK      KEY9,PTEDCODE,SP70
          CALL      RDPTICD1                * Read ICD disease record
          IF        OVRCD=0
            MATCH     SP70,PT0DDSC2
            IF        !@EQUAL
              PACK      DISP200,PT0DDSC2,SP70,SP70,SP70    * 200 chars
            ELSE
              MATCH     SP70,PT0DDESC
              IF        !@EQUAL
                PACK      DISP200,PT0DDESC,SP70,SP70       * 100 chars
              ELSE
                PACK      DISP200,DDESC,SP70               * 70 chars
              ENDIF
            ENDIF
          ELSE
            MOVE      "Invalid - Code Not Found",DISP200
          ENDIF
.
          MATCH     SP70,PTEDDESC           * Is Free Format Desc blank?
          IF        !@EQUAL
            MOVE      PTEDDESC,DISP200      * No, use free format desc.
          ENDIF
.
. Check if there is another record thus increment next CGI field number else
. if OVERCONDS stay on current CGI. Note this is for TABING through Prefixs
. on Summary Screen(IN HTML CODE!!)
.
          PACK      SAVKEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70  * Save curr key
.
          ADD       ONE,PTEDCNT  * Increment for next record 
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          CALL      RDPTECD1              * Read for next record?
          IF        OVRCD=0
            MOVE      PTEDCNT,FORM3   * set Tab for next CGI var
            ADD       HUNDRED,FORM3
          ELSE 
            MOVE      CODCOUNT,FORM3   * Last Record so stay this input
          ENDIF
.
.  Now position back on correct Record
.
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECD1
.
.         MATCH     "1",PTEDDRGD   * Is Code a DRG Driver Code?
.         IF        @EQUAL
.           MOVE      "LeaveCell",KEY9  * Set Class (Row Color) 
.         ELSE
.           MOVE      SP70,KEY9
.         ENDIF 
.
          MATCH     "1",PTEDDRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TDTRW300
          ENDIF
.
          MATCH     "3",PTEDDRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TDTRW300
          ENDIF
.
          MATCH     "5",PTEDDRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TDTRW300
          ENDIF
.
          MATCH     "9",PTEDDRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TDTRW300
          ENDIF
.
          MOVE      SP70,KEY9
.
TDTRW300  CALL      CHCKA000       * Check if Displaying Accident Dates  
.
TDTRW400  WRITE     HTMLFILE;"<tr><td nowrap class=",KEY9,">":
                             "<A HREF='javascript:ShowCods03":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&diopc001=",PTEDCODE:
                             "&ptecd001=",PTEDADMN:
                             "&ptecd002=",PTEDEPNO:
                             "&ptecd003=",PTEDCNT,"#")'>":
                             "<img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             "<input type=text size=1 class=Mandatory ":
                             "maxlength=1 title=#"Prefix#" name=dspre":
                             CODCOUNT," value=#"",PTEDTYPE,"#"": 
                             " onKeyUp='DisPrefix(dspre",CODCOUNT,",dspre":
                             FORM3,",#"",PTEDCODE,"#",#"":
                             PTEDEPNO,"#",#"",PTEDCNT,"#");'":
                             "onfocus='SetBlank(dspre",CODCOUNT,");'>":
                             PTEDCODE,"</td>":
                             "<td class=",KEY9,">",DISP200,"</td>"
.
          MOVE      PTEDCCFL,DIM2
          CALL      GTCCFL00
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=",KEY9,">",DIM50,"</td>"
          ENDIF
.
          COMPARE   ONE,PTCNEDTE * Displaying Accident Dates
          IF        @EQUAL
            COMPARE   ONE,ACDNTFLG * Outputing Accident Date
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=",KEY9,">",ACCIDATE,"</td>"
            ELSE 
              WRITE     HTMLFILE;"<td class=",KEY9,">&nbsp;</td>"
            ENDIF
          ENDIF
.
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id & ICD10 ED 13
          GOTO      TDTRW600 IF NOT EQUAL
.
          MATCH     PTCNGDX3,DDATE   * disc.date > ICD10 ED 13 Go live?
          GOTO      TDTRW600 IF LESS
.
          MOVE      "Readonly",DCIDCLAS          * Not required - Grey
.
          MATCH     "1",PT0DCARQ                 * Required - Blue
          IF        @EQUAL
            MOVE      "Mandatory",DCIDCLAS
          ENDIF
.
          MATCH     "2",PT0DCARQ                 * Maybe - Green
          IF        @EQUAL
            MOVE      "GreenBackground",DCIDCLAS
          ENDIF
.
          MATCH     SP70,PTEDDCID
          IF        @EQUAL
            PACK      SVVKEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
            PROC      DFDCID00                   * Set Clister id if blank
            MOVE      NEWWDCID,PTEDDCID          * Set returned new cluster id
          ENDIF
.
          WRITE     HTMLFILE;"<td class=",KEY9," width=15%>":

                             "<input type=hidden ":
                             " name=#"clusk",CODCOUNT,"#"":
                             " id=#"clusk",CODCOUNT,"#"":
                             " value=#"",PTEDADMN,PTEDEPNO,PTEDCNT,"#">":

                             "<input type=text size=2 maxlength=2 readonly":
                             " name=#"clusa",CODCOUNT,"#"":
                             " id=#"clusa",CODCOUNT,"#"":
                             " value=#"",PTEDDCID,"#"":
                             " class=#"",DCIDCLAS,"#"":
                             " alt=#"Cluster ID#" title=#"Cluster ID#"":
                             " onchange=#"InputCluster(",CODCOUNT,");#">"
.
          WRITE     HTMLFILE;"&nbsp;<img src=../images/MoveIcon.gif":
                             " alt=#"Assign Cluster ID#"":
                             " title=#"Assign Cluster ID#"":
                             " class=Icon":
                             " onclick=#"AssignNextCluster(",CODCOUNT:
                             ");#">"
.
          WRITE     HTMLFILE;"&nbsp;<select name=#"clusb",CODCOUNT,"#"":
                             " id=#"clusb",CODCOUNT,"#"":
                             " class=#"Select40#"":
                             " title=#"Select Cluster ID#"":
                             " onfocus=#"GenerateClusterSel(",CODCOUNT,");#"":
                             " onchange=#"SelectCluster(this,",CODCOUNT,");#">":
                             " <option></option>":
                             " <option value=#"",PTEDDCID,"#" selected>":
                               PTEDDCID,"</option>":
                             " </select>";
.
          WRITE     HTMLFILE;"&nbsp;<img src=../images/ChronicDCID.gif ":
                             " alt=#"Assign Chronic Condition#"":
                             " title=#"Assign Chronic Condition#"":
                             " class=Icon":
                             " onclick=#"AssignChronic(",CODCOUNT,");#">"
.
          WRITE     HTMLFILE;"<img src=../images/erase.gif":
                             " alt=#"Delete Cluster ID#"":
                             " title=#"Delete Cluster ID#"":
                             " class=Icon":
                             " onclick=#"DeleteCluster(",CODCOUNT,");#">"
.
          IF        CDCIDBUT=1
            WRITE     HTMLFILE;"<input type=button class=#"SmallButton#"":
                               " value=#"Clear All#"":
                               " onclick=#"DeleteAllClusters();#">"
            MOVE      ZERO,CDCIDBUT
          ENDIF
          WRITE     HTMLFILE;"</td>"
.
TDTRW600  WRITE     HTMLFILE;"<td class=",KEY9,">",PTEDCCCL,"</td>"
.
          IF        PTCNHDPS>0
            WRITE     HTMLFILE;"<input type=hidden name=onsty",CODCOUNT:
                               " value=",PTEDOSET,">":
                               "<td id=d_onsty",CODCOUNT," class=",KEY9,">":
                               PTEDOSET,"</td>"
          ENDIF
.
          ADD       ONE,COUNTER3
          COMPARE   ONE,COUNTER3
          IF        @EQUAL
            MOVE      ONE,SWAPFLG
            WRITE     HTMLFILE;"<input type=hidden name=prfix001":
                               " value='",PTEDTYPE,"'>";
          ENDIF
          WRITE     HTMLFILE;"<input type=hidden name=dscod",CODCOUNT:
                             " value='",PTEDCODE,"'>";
.
          CALL      DISSEQ00  * Diagnosis Sequance Selection List
.
          MOVE      PTEDCNT,SORTSEQN
          REP       " 0",SORTSEQN
          WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif": 
                             " id=#"movbtn",SORTSEQN,"#"":
                             " name=#"movbtn",SORTSEQN,"#"":
                             " onclick=#"MoveRec03('",PTEDADMN:
                             "','",PTEDEPNO,"','",PTEDCNT,"','M','D','":    
                             COUNTER3,"',this)#" ":
                             " alt='Move Record' title='Move Record'":
                             " class=Icon>":
                             "<img src=../images/SwapIcon.gif":
                             " id=#"swpbtn",SORTSEQN,"#"":
                             " name=#"swpbtn",SORTSEQN,"#"":
                             " onclick=#"MoveRec03('",PTEDADMN:
                             "','",PTEDEPNO,"','",PTEDCNT,"','S','D','":   
                             COUNTER3,"',this)#" ":
                             " alt='Swap Record' title='Swap Record'":
                             " class=Icon>";
.
          IF        SORTBUTT=1
            WRITE     HTMLFILE;"&nbsp;<input type=button class=#"button#"":
                               " value=#"Sort#"  id=#"SortDisButton#"":
                               " onclick=#"PostSort03('D');#">";
            MOVE      ZERO,SORTBUTT
          ENDIF
.
          PACK      SORTKY16,PTEDADMN,PTEDEPNO,PTEDCNT,PTEDCNT,SP70
.
          WRITE     HTMLFILE;"<input type=#"hidden#" name=#"seqdi",SORTSEQN:
                            "#" id=#"seqdi",SORTSEQN,"#" value='",SORTKY16,"'>"
.
          WRITE     HTMLFILE;"</td></tr>"
.
TDTRW999  RETURN
.
.-----------------------------------------------------------------------------
. Getthe contract acre flag description
.-----------------------------------------------------------------------------
GTCCFL00  MOVE      DIM2,DIM50
          MATCH     "01",DIM2
          IF        @EQUAL
            MOVE      CCFLAG01,DIM50
          ELSE
            MATCH     "02",DIM2
            IF        @EQUAL
              MOVE      CCFLAG02,DIM50
            ENDIF
          ENDIF
.
GTCCFL99  RETURN
.
.-----------------------------------------------------------------------------
. Displaying Accident Dates for E codes?
.-----------------------------------------------------------------------------
CHCKA000  MOVE      ZERO,ACDNTFLG  * Displaying Accident Date Flag 
          MOVE      ZERO,ACDNTMND  * Non Mandatory Accident Date Flag
.         
          COMPARE   ONE,PTCNEDTE   * Displaying Accident Dates for E codes?
          GOTO      CHCKA999 IF NOT EQUAL 
.
          MOVE      ZERO,FORM1
          MOVE      PT0DACRQ,FORM1
          IF        FORM1=2 | FORM1=6 | FORM1=7 | FORM1=8
            MOVE      ONE,ACDNTFLG
            GOTO      CHCKA900
          ENDIF
.
          MATCH     "P",PT0DACRQ
          IF        @EQUAL
            MOVE      ONE,ACDNTFLG
            IF        PTCNHDPS=1
              MOVE      ONE,ACDNTMND  * Non Mandatory Accident Date Flag
            ENDIF
            GOTO      CHCKA900
          ENDIF
.
          MATCH     "A",PT0DACRQ
          IF        @EQUAL
            MOVE      ONE,ACDNTFLG
            IF        PTCNHDPS=1
              MOVE      ONE,ACDNTMND  * Non Mandatory Accident Date Flag
            ENDIF
            GOTO      CHCKA900
          ENDIF
          GOTO      CHCKA999
.
CHCKA900  MOVE      SP70,ACCIDATE   
          MATCH     SP70,PTEDACDT
          IF        !@EQUAL
            UNPACK    PTEDACDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
CHCKA999  RETURN
.------------------------------------------------------------
. Table of Medical Record Procedure Codes
.------------------------------------------------------------
TOPTB000  MOVE      HUNDRED,CODCOUNT    * Cgi counter/var set to have 3 chars
          MOVE      ZERO,COUNTER3                                     *C-240107
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,VIEWFLAG
          MOVE      KEY1,VIEWFLAG       * Displaying Operation Date & Time 
          MOVE      ZERO,VIEWCCFL
          MOVE      DIM1,VIEWCCFL       * Displaying Contract care flag
          MOVE      ONE,SORTBUTT
          MOVE      ZERO,CLINREQD       * Clinician required ind.
          MOVE      ZERO,DATEREQD       * Date required ind. for Principal Proc
          MOVE      ZERO,TIMEREQD       * Time required ind. for Principal Proc
.
.                                       * read display parameters
          READ      CONTROLF,NINTY7;*174,MRCNCLIN                     *I-240103
          READ      CONTROLF,FIFTY9;*85,CMORBDTM,*218,PTMORBDT        *I-240103
.
          CALL      TOPHD000            * set up column headings
.                                       * set "Episode Coding in single screen"
          IF        MRCNEPSC=1
            IF        EPSCD001=ZERO
              MOVE      ONE,EPSCD001
            ENDIF
            PACK      KEY13,ADMISSNO,EPSCD001,SP70
          ELSE
            MOVE      ONE,EPSCD001
            PACK      KEY13,ADMISSNO,EPSCD001,SP70
          ENDIF
          CALL      RSPTECO1
TOPTB100  CALL      RKPTECO1
          BRANCH    OVRCD,TOPTB999
.
          MATCH     ADMISSNO,DPTEOADM
          GOTO      TOPTB999 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      TOPTB999 IF NOT EQUAL
.
.                                           * Primary Op Date Only (first Proc)
TOPTB200  IF        PTMORBDT = 3 & PTEOCNT = 1
            MOVE      SP10,PT0ODTMN
            MOVE      PTEOCODE,KEY9         * Read ICD Code to check Date/Time
            CALL      RDPTICO1              * flag for "non-Mandatory"
.
            MATCH     SP10,PTEOCLIN         * check Clinician on Primary Proc.
            IF        @EQUAL
              MATCH     "0",MRCNCLIN        * 0=NotUsed 1=Displayed 2=Mandatory
              IF        !@EQUAL
                MOVE      "1",CLINREQD      * Clinician reqd for Primary Proc.
              ENDIF
            ENDIF
.
.                                       * check for "Primary Op Date only Mand"
            IF        PTMORBDT = 3
              MATCH     SP10,PTEODATE
              IF        @EQUAL
                MOVE      "1",DATEREQD        * Date reqd for Primary Proc.
              ENDIF
.
...           MATCH     "1",PT0ODTMN         * ICD10 Code Mandatory=0 NonMan.=1
...           IF        !@EQUAL
...            MOVE      "1",DATEREQD        * Date reqd for Primary Proc.
...           ENDIF
            ENDIF
          ENDIF
.
TOPTB300  CALL      TOPRW000  * Display Locations Mantenance Table Details Row
          GOTO      TOPTB100 
.
TOPTB999  RETURN
.------------------------------------------------------------
. Procedure Header Row
.------------------------------------------------------------
TOPHD000  CLEAR     VARLONG
          APPEND    "<tr><td class=HeadingCell width=10%>",VARLONG 
          APPEND    "ICD10 Procedure Code</td>",VARLONG 
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            APPEND    "<td class=HeadingCell width=30%>",VARLONG
            APPEND    "Description</td>",VARLONG 
            APPEND    "<td class=HeadingCell width=15%>",VARLONG
            APPEND    "Contracted Care Flag</td>",VARLONG
          ELSE
            APPEND    "<td class=HeadingCell width=45%>",VARLONG
            APPEND    "Description</td>",VARLONG
          ENDIF 
          APPEND    "<td class=HeadingCell width=3%>Block</td>",VARLONG 
          REP       " 0",MRCNCLIN
          MATCH     "0",MRCNCLIN
          IF        !@EQUAL
            APPEND    "<td class=HeadingCell width=10%>Clinician</td>",VARLONG 
          ENDIF
          COMPARE    "1",PTMORBDT
          IF        !@EQUAL
            APPEND    "<td class=HeadingCell width=5%>Date</td>",VARLONG 
          ENDIF
          COMPARE    "2",CMORBDTM
          IF        !@EQUAL
            APPEND    "<td class=HeadingCell width=5%>Time</td>",VARLONG 
          ENDIF
          APPEND    "<td class=HeadingCell width=15%>",VARLONG
          APPEND    "Sequence</td></tr>",VARLONG 
.
          RESET     VARLONG 
          WRITE     HTMLFILE;VARLONG 
.
TOPHD999  RETURN
.------------------------------------------------------------
. Procedure Code Row
.------------------------------------------------------------
TOPRW000  ADD       ONE,CODCOUNT
.
          PACK      DISP200,SP70,SP70,SP70
          PACK      PT0ODSC2,SP70,SP70,SP70
          PACK      PT0ODESC,SP70,SP70,SP70
.
          PACK      KEY9,PTEOCODE,SP70
          CALL      RDPTICO1            * Read ICD10 Procedure record
          IF        OVRCD=0
            MATCH     SP70,PT0ODSC2
            IF        !@EQUAL
              PACK      DISP200,PT0ODSC2,SP70,SP70,SP70    * 200 chars
            ELSE
              MATCH     SP70,PT0ODESC
              IF        !@EQUAL
                PACK      DISP200,PT0ODESC,SP70,SP70       * 100 chars
              ELSE
                PACK      DISP200,ODESC,SP70               * 70 chars
              ENDIF
            ENDIF
          ELSE
            MOVE      "Invalid - Code Not Found",DISP200
          ENDIF
.
          MATCH     SP70,PTEODESC           * Is Free Format Desc blank?
          IF        !@EQUAL
            MOVE      PTEODESC,DISP200        * No, use this description
          ENDIF
.
. Check if there is another record thus increment next CGI field number else
. if OVERCONDS stay on current CGI. Note this is for TABing through Prefixs
. on Summary Screen(IN HTML CODE!!)
.
          PACK      SAVKEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70  * Save curr key
.
          ADD       ONE,PTEOCNT  * Increment for next record
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT,SP70
          CALL      RDPTECO1              * Read for next record?
          IF        OVRCD=0
            MOVE      PTEOCNT,FORM3   * set Tab for next CGI var
            ADD       HUNDRED,FORM3
          ELSE
            MOVE      CODCOUNT,FORM3   * Last Record so stay this input
          ENDIF
.
.  Now position back on correct Record
.
          MOVE      SAVKEY13,KEY13
          CALL      RDPTECO1
.
.         MATCH     "1",PTEODRGD   * Is Code a DRG Driver Code?
.         IF        @EQUAL
.           MOVE      "LeaveCell",KEY9  * Set Class (Row Color) 
.         ELSE
.           MOVE      SP70,KEY9
.         ENDIF 
.
          MATCH     "1",PTEODRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TOPRW100
          ENDIF
.
          MATCH     "3",PTEODRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TOPRW100
          ENDIF
.
          MATCH     "5",PTEODRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TOPRW100
          ENDIF
.
          MATCH     "9",PTEODRGD   * Is Code a DRG Driver Code?
          IF        @EQUAL
            MOVE      "LeaveCell",KEY9  * Set Class (Row Color)
            GOTO      TOPRW100
          ENDIF
.
          MOVE      SP70,KEY9
.
.
TOPRW100  MATCH     "0",MRCNCLIN            * Operating Clinician
          GOTO      TOPRW110 IF EQUAL
.
          MOVE      "&nbsp;",DOCFNAME
          PACK      KEY10,PTEOCLIN,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          BRANCH    OVRCD,TOPRW110
.
          STRIP     PMHCTITL
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          RESET     PMHCTITL
          RESET     PMHCGNAM
          RESET     PMHCSNAM
          CALL      DOCNM000                * result in DOCFNAME
.
TOPRW110  COMPARE   "1",PTMORBDT            * Operation Date
          GOTO      TOPRW120 IF EQUAL
.
          MOVE      "&nbsp;",KEY11
          MOVE      SP70,KEY11A
          MATCH     SP70,PTEODATE
          GOTO      TOPRW120 IF EQUAL
.
          UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          PACK      KEY11A,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
TOPRW120  COMPARE   "2",CMORBDTM            * Operation Times
          GOTO      TOPRW200 IF EQUAL
.
          MATCH     SP10,PTEOSTTM
          IF        @EQUAL
            MOVE      SP5,PTEOSTTM
          ENDIF
          MATCH     SP10,PTEOEDTM
          IF        @EQUAL
            MOVE      SP5,PTEOEDTM
          ENDIF
.
TOPRW200  WRITE     HTMLFILE;"<tr><td nowrap class=",KEY9,">":
                             "<A HREF='javascript:ShowCods03":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&diopc001=",PTEOCODE:
                             "&ptecd001=",DPTEOADM:
                             "&ptecd002=",PTEOEPNO:
                             "&ptecd003=",PTEOCNT,"#")'>":
                             "<img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             "<input type=text size=1 class=Mandatory ":
                             "maxlength=1 title=#"Prefix#" name=oppre":
                             CODCOUNT," value=#"",PTEOTYPE,"#"":
                             " onKeyUp='OprPrefix(oppre",CODCOUNT,",oppre":
                             FORM3,",#"",PTEOCODE,"#",#"":
                             PTEOEPNO,"#",#"",PTEOCNT,"#");'":
                             "onfocus='SetBlank(oppre",CODCOUNT,");'>":
                             PTEOCODE,"</td>":
                             "<td class=",KEY9,">",DISP200,"</td>"
.
          MOVE      PTEOCCFL,DIM2
          CALL      GTCCFL00
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=",KEY9,">",DIM50,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td class=",KEY9,">",PT0OBLKN,"</td>"
.
TOPRW250  MATCH     "0",MRCNCLIN            * Operating Clinician
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td class=",KEY9,">",DOCFNAME,"</td>"
          ENDIF
.
TOPRW260  COMPARE   "1",PTMORBDT            * Operation Date
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td class=",KEY9,">",KEY11,"</td>"
          ENDIF
.
TOPRW270  COMPARE   "2",CMORBDTM            * Operation Times
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td class=",KEY9,">",PTEOSTTM,"&nbsp;":
                               "&nbsp;",PTEOEDTM,"</td>"
          ENDIF
.
TOPRW280  WRITE     HTMLFILE;"<input type=hidden name=prcod",CODCOUNT:
                             " value='",PTEOCODE,"'>"
.
          WRITE     HTMLFILE;"<input type=hidden name=prcdt",CODCOUNT:
                             " value='",KEY11A,"'>"
          WRITE     HTMLFILE;"<input type=hidden name=prcst",CODCOUNT:
                             " value='",PTEOSTTM,"'>"
          WRITE     HTMLFILE;"<input type=hidden name=prcet",CODCOUNT:
                             " value='",PTEOEDTM,"'>"
          WRITE     HTMLFILE;"<input type=hidden name=dtman",CODCOUNT:
                             " value='",PT0ODTMN,"'>"
.
TOPRW300  ADD       ONE,COUNTER3
          CALL      OPRSEQ00    * Procedure Sequence List
.
          MOVE      PTEOCNT,SORTSEQN
          REP       " 0",SORTSEQN
          WRITE     HTMLFILE;"<img src=../images/MoveIcon.gif":
                             " id=#"movbtn",SORTSEQN,"#"":
                             " name=#"movbtn",SORTSEQN,"#"":
                             " onclick=#"MoveRec03('",DPTEOADM:
                             "','",PTEOEPNO,"','",PTEOCNT,"','M','O','":
                             COUNTER3,"',this);#" ":
                             " alt='Move Record' title='Move Record'":
                             " class=Icon>":
                             "<img src=../images/SwapIcon.gif": 
                             " id=#"swpbtn",SORTSEQN,"#"":
                             " name=#"swpbtn",SORTSEQN,"#"":
                             " onclick=#"MoveRec03('",DPTEOADM:
                             "','",PTEOEPNO,"','",PTEOCNT,"','S','O','":
                             COUNTER3,"',this)#" ":
                             " alt='Swap Record' title='Swap Record'":
                             " class=Icon>";
.
          IF        SORTBUTT=1
            WRITE     HTMLFILE;"&nbsp;<input type=button class=#"button#"":
                               " value=#"Sort#" id=#"SortOprButton#"":
                               " onclick=#"PostSort03('O');#">";
            MOVE      ZERO,SORTBUTT
          ENDIF
.
          PACK      SORTKY16,PTEOADMN,PTEOEPNO,PTEOCNT,PTEOCNT,SP70
.
          WRITE     HTMLFILE;"<input type=#"hidden#" name=#"seqop",SORTSEQN:
                            "#" id=#"seqop",SORTSEQN,"#" value='",SORTKY16,"'>"
.
          WRITE     HTMLFILE;"</td></tr>"
.
          GOTO      TOPRW999           
.
TOPRW999  RETURN
.
.-------------------------------------------------------------------------
.             Displays drop down list of Diagnosis sequences
.   INPUT: KEY9 - Row Class(Color!)
.-------------------------------------------------------------------------
DISSEQ00  MOVE      PTEDADMN,KEY8      * Admission no.
          MOVE      PTEDEPNO,KEY2      * Episode No.
          MOVE      PTEDCNT,EPSCOUNT   * Episode Unique Counter
.
          WRITE     HTMLFILE;"<td class=",KEY9,"><select name=dummyd ":
                           "onchange=#"setSeq03(this);setcount(",COUNTER3,");":
                           "setSort03('D','",PTEDCNT,"',this);#">"
.
          PACK      KEY13,KEY8,KEY2,SP70
          CALL      RSPTECD1
DISSEQ10  CALL      RKPTECD1
          BRANCH    OVRCD,DISSEQ90
.
          MATCH     DPTEDADM,KEY8           * Admissno No.
          GOTO      DISSEQ90 IF NOT EQUAL
.
          MATCH     DPTEDEPN,KEY2           * Episode No. 
          GOTO      DISSEQ90 IF NOT EQUAL
.
          MATCH     DPTEDCNT,EPSCOUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PTEDCNT,"#" selected>":
                               PTEDCNT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PTEDCNT,"#">":
                               PTEDCNT,"</option>"
          ENDIF
          GOTO      DISSEQ10
.
DISSEQ90  WRITE     HTMLFILE;"</select>"
          PACK      KEY13,KEY8,KEY2,EPSCOUNT,SP70
          CALL      RDPTECD1
.
DISSEQ99  RETURN
.-------------------------------------------------------------------------
.             Displays drop down list of Procedure sequences
.-------------------------------------------------------------------------
OPRSEQ00  MOVE      PTEOADMN,KEY8      * Admission no.
          MOVE      PTEOEPNO,KEY2      * Episode No.
          MOVE      PTEOCNT,EPSCOUNT   * Episode Unique Counter
.
          WRITE     HTMLFILE;"<td class=",KEY9,"><select name=dummyo ":
                           "onchange=#"setSeq03(this);setcount(",COUNTER3,");":
                           "setSort03('O','",PTEOCNT,"',this);#">"
.
          PACK      KEY13,KEY8,KEY2,SP70
          CALL      RSPTECO1
OPRSEQ10  CALL      RKPTECO1
          BRANCH    OVRCD,OPRSEQ90
.
          MATCH     DPTEOADM,KEY8           * Admissno No.
          GOTO      OPRSEQ90 IF NOT EQUAL
.
          MATCH     DPTEOEPN,KEY2           * Episode No. 
          GOTO      OPRSEQ90 IF NOT EQUAL
.
          MATCH     DPTEOCNT,EPSCOUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PTEOCNT,"#" selected>":
                               PTEOCNT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PTEOCNT,"#">":
                               PTEOCNT,"</option>"
          ENDIF
          GOTO      OPRSEQ10
.
OPRSEQ90  WRITE     HTMLFILE;"</select>"
          PACK      KEY13,KEY8,KEY2,EPSCOUNT,SP70
          CALL      RDPTECO1
.
OPRSEQ99  RETURN
.------------------------------------------------------------------------------
.         Medical Record Merge
.------------------------------------------------------------------------------
MRMERG00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      MRMERG50 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      MRMERG20 IF EQUAL
.
          MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRMERG99
.
MRMERG20  CALL      MRGEUR00     * Merge U/R
          GOTO      MRMERG99
.
MRMERG50  CLEAR     WEBTITLE
          MOVE      "Medical Record Merge",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEDCOD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRMERG99
.
MRMERG99  RETURN
+
.------------------------------------------------------------------------------
.*                               MRGEUR00                                   
.*           Loop through all the records for the old U/R                   
.*           in the tracking master file, and update them with the             
.*           new U/R.                                                          
.------------------------------------------------------------------------------
MRGEUR00  MOVE      ZERO,ERRORFLG 
          MOVE      ZERO,FORM3
          PACK      KEY20,OLDURNUM,SP20                               *C-240724
          CALL      RSMRMAS1                 * position in file
MRGEUR10  CALL      RKMRMAS1                 * read next record
          BRANCH    OVRCD,MRGEUR90           * eof - finished
.
          MATCH     MRMAURNO,OLDURNUM        * same U/R number still ?
          GOTO      MRGEUR90 IF NOT EQUAL    * no - finished
. 
          ADD       ONE,FORM3                * array number 
.                                            * Save position in file
          PACK      SAVKEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
.
          MATCH     "1",NEWDELFL[FORM3]
          IF        @EQUAL
            PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
            CALL      DETMAS1   * Delete this medical record
            CALL      DELHIS00  * Delete MR History Details record for Med key
            CALL      DELREQ00  * Delete Request Details record for Med key
            CALL      DELVIS00  * Delete Visit Details record for Med key
            CALL      DELRES00  * Delete Reservation Details record for Med key
          ELSE
            IF        WAHEALTH=1
              PACK      KEY10,USERID,SP70  * If Wahealth only merge record from
              CALL      RDWBSE1            * the users logged in hospital
              IF        OVRCD <> 1
                MATCH     WBSEHOSP,MRMAHHOS
                GOTO      MRGEUR10 IF NOT EQUAL
              ENDIF
            ENDIF
.
            CALL      UPDT0000              * Update Tracking Master File
          ENDIF
.
          MOVE      SAVKEY20,KEY20          * restore position in file
          CALL      RSMRMAS1
. 
          GOTO      MRGEUR10                * get next record
.
MRGEUR90  IF        ERRORFLG = 1
            MOVE      "Not all records merged duplicates found.",WEBTITLE
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Merge Completed.",WEBTITLE
            MOVE      ZERO,EXIT
          ENDIF
.
MRGEUR99  RETURN
.---------------------------------------------------------------------------
. Delete History Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELHIS00  PACK      KEY26,MRMAKEY,SP70
          CALL      RSMRHIS1 
          CALL      RKMRHIS1 
          BRANCH    OVRCD,DELHIS99
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      DELHIS99 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1 
.
          GOTO      DELHIS00          
.
DELHIS99  RETURN
.---------------------------------------------------------------------------
. Delete Request Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELREQ00  PACK      KEY20,MRMAKEY,SP70
DELREQ10  CALL      RSMRRQD2 
          CALL      RKMRRQD2 
          BRANCH    OVRCD,DELREQ99
.
          MATCH     MRMAKEY,MRRDRKEY
          GOTO      DELREQ99 IF NOT EQUAL
.
          PACK      KEY20,MRRDRKEY,MRRDRQNO,SP70
          CALL      DEMRRQD2 
.
          GOTO      DELREQ10          
.
DELREQ99  RETURN
.---------------------------------------------------------------------------
. Delete MR Visit Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELVIS00  PACK      KEY18,MRMAKEY,SP70
DELVIS10  CALL      RSMRVS2 
          CALL      RKMRVS2 
          BRANCH    OVRCD,DELVIS99
.
          MATCH     MRMAKEY,MRVSMKEY
          GOTO      DELVIS99 IF NOT EQUAL
.
          PACK      KEY18,MRVSMKEY,MRVSVSNO,SP70
          CALL      DEMRVS2 
.
          GOTO      DELVIS10          
.
DELVIS99  RETURN
.---------------------------------------------------------------------------
. Delete MR Visit Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELRES00  PACK      KEY23,MRMAKEY,SP70
DELRES10  CALL      RSMRRES1 
          CALL      RKMRRES1 
          BRANCH    OVRCD,DELRES99
.
          MATCH     MRMAKEY,MRRSKEY
          GOTO      DELRES99 IF NOT EQUAL
.
          PACK      KEY23,MRRSKEY,MRRSDATE,MRRSTIME,SP70
          CALL      DERESV1 
.
          CALL      DELRES10          
.
DELRES99  RETURN
.------------------------------------------------------------------------------
.*                           UPDT0000                                 *
.*                  Update New Details in mrtmasaf                    *
.* Requires: Valid read on old mrtmasaf record                        *
.*           NEWURNUM - new u/r number                                *
.*           OLDURNUM - old u/r number                                *
.*           HOMHOSPT - new home hospital                             *
.*           HOMLOCAT - new home location                             *
.*           DOCTYPE - new document type                              *
.*           VOLUMNUM - new volume number                             *
.* Returns: EXIT   0 = valid update                                   *
.*                 1 = unable to update                               *
.------------------------------------------------------------------------------
UPDT0000  MOVE      NEWLOCAT[FORM3],HOMLOCAT
          MATCH     SP70,HOMLOCAT
          GOTO      UPDT9999 IF EQUAL
.
          MOVE      NEWHOSPT[FORM3],HOMHOSPT
          MOVE      NEWTYPDC[FORM3],DOCTYPE
          MOVE      NEWVOLUM[FORM3],VOLUMNUM
          SQUEEZE   VOLUMNUM
          MOVE      VOLUMNUM,FORM2            * load new volume number
.
.                                                                     *C-240724
          PACK      KEY20,NEWURNUM,HOMHOSPT,HOMLOCAT,DOCTYPE,FORM2
          CALL      RDMRMAS1                     * new record already on file ?
          BRANCH    OVRCD,UPDT1000               * no                  *C-56959
.
          CALL      UPLV0000                                           *I-56959
.
          MOVE      ONE,ERRORFLG
.
          GOTO      UPDT9999
.                                                                     *C-240724
UPDT1000  PACK      KEY20,OLDURNUM,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN
          CALL      RDMRMAS1                     * reposition on old record
          BRANCH    OVRCD,UPDT9999
.
          MOVE      NEWURNUM,MRMAURNO            * load new U/R number
          MOVE      HOMHOSPT,MRMAHHOS            * load new home hospital
          MOVE      HOMLOCAT,MRMAHLOC            * load new home location
          MOVE      DOCTYPE,MRMADOTY             * load new type of document
          SQUEEZE   VOLUMNUM
          MOVE      VOLUMNUM,MRMAVOLN            * load new volume number
.
.                                                                     *C-240724
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS1                     * update record
          MOVE      ZERO,EXIT
.
UPDT9999  RETURN
.------------------------------------------------------------------------------
MRDET000  BRANCH    FLDITMNO,MRDET010,MRDET020,MRDET030,MRDET040,MRDET050:
                             MRDET060,MRDET070,MRDET080,MRDET090,MRDET100:
                             MRDET110,MRDET120,MRDET130
          GOTO      MRDET999
.
MRDET010  WRITE     HTMLFILE;OLDURNUM
          GOTO      MRDET999
.
MRDET020  WRITE     HTMLFILE;OLDPNAME
          GOTO      MRDET999
.
MRDET030  WRITE     HTMLFILE;OLDBDATE
          GOTO      MRDET999
.
MRDET040  WRITE     HTMLFILE;OLDPTAGE
          GOTO      MRDET999
.
MRDET050  WRITE     HTMLFILE;NEWURNUM
          GOTO      MRDET999
.
MRDET060  WRITE     HTMLFILE;NEWPNAME
          GOTO      MRDET999
.
MRDET070  WRITE     HTMLFILE;NEWBDATE
          GOTO      MRDET999
.
MRDET080  WRITE     HTMLFILE;NEWPTAGE
          GOTO      MRDET999
.
MRDET090  CALL      MRCU0000                * Medical Record Update Table
          GOTO      MRDET999
.
MRDET100  CALL      MRCD0000                * Medical Record Display Table
          GOTO      MRDET999
.
MRDET110  WRITE     HTMLFILE;OLDPTSEX
          GOTO      MRDET9999
.
MRDET120  WRITE     HTMLFILE;NEWPTSEX
          GOTO      MRDET9999
. 
MRDET130  CALL      MRDS0000                * Display U/R to keep record Table
          GOTO      MRDET999
.
MRDET999  RETURN 
.------------------------------------------------------------------------------
. Medical Record Display Table
.------------------------------------------------------------------------------
MRCD0000  WRITE     HTMLFILE;"<tr><td class=HeadingCell>Home Location</td>":
                                 "<td class=HeadingCell>Type of Document</td>":
                                 "<td class=HeadingCell> Volume</td></tr>"
.
          PACK      KEY20,OLDURNUM,SP70                               *C-240724
          CALL      RSMRMAS1
MRCD1000  CALL      RKMRMAS1
          BRANCH    OVRCD,MRCD9999
.
          MATCH     OLDURNUM,MRMAURNO
          GOTO      MRCD9999 IF NOT EQUAL
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          UNPACK    SP70,MRLODESC,HOMELOCA
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
....        MATCH     MRMAOHOS,MRMAHHOS
....        IF        !@EQUAL
....          PACK      KEY30,OBR,MRMAOHOS,CBR,SP20
....          APPEND    KEY30,KEY70
....        ENDIF
            RESET     KEY70
          ENDIF     
          MOVE      KEY70,HOMELOCA                          * end     *I-240724
.
          WRITE     HTMLFILE;"<tr><td>",HOMELOCA,"&nbsp;</td>":
                                "<td>",KEY20,"</td>":
                                "<td align=center>",DMRMAVOL,"</td></tr>"
          GOTO      MRCD1000

MRCD9999  RETURN 
.------------------------------------------------------------------------------
. Medical Record Update Table
.------------------------------------------------------------------------------
MRCU0000  BRANCH    WAHEALTH,MRCU5000       * WaHealth format at MRCU5000
.
          WRITE     HTMLFILE;"<tr><td width=100% class=HeadingCell ":
                             " align=center colspan=8>";
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;" NHI (no longer required) Existing Records";
          ELSE
            WRITE     HTMLFILE;" U/R (no longer required) Existing Records";
          ENDIF
          WRITE     HTMLFILE;" to be merged</td>":
                             "</tr><tr><td width=19% class=HeadingCell>":
                             " Home Location</td>":
                             "<td width=19% class=HeadingCell>":
                             " Type of Document</td>":
                             "<td width=10% class=HeadingCell>":
                             " Volume</td>"
          IF        IBCNMHOS = 1
            WRITE     HTMLFILE;"<td width=18% class=HeadingCell>":
                               "Home Hospital</td>" 
          ENDIF
          WRITE     HTMLFILE;"<td width=18% class=HeadingCell>":
                             "Home Location</td>":
                             "<td width=18% class=HeadingCell>":
                             "Type of Document</td>":
                             "<td width=10% class=HeadingCell>":
                             "Volume</td>":
                             "<td width=6% class=HeadingCell>":
                             "Delete</td></tr>"
.
          MOVE      ZERO,FORM3
          PACK      KEY20,OLDURNUM,SP70                               *C-240724
          CALL      RSMRMAS1
MRCU1000  CALL      RKMRMAS1
          BRANCH    OVRCD,MRCU9999
.
          MATCH     OLDURNUM,MRMAURNO
          GOTO      MRCU9999 IF NOT EQUAL
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          UNPACK    SP70,MRLODESC,HOMELOCA
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
            RESET     KEY70
          ENDIF     
          MOVE      KEY70,HOMELOCA                          * end     *I-240724
.
          ADD       ONE,FORM3
          MOVE      FORM3,ENO3
          REP       " 0",ENO3
.
          WRITE     HTMLFILE;"<tr><td>",HOMELOCA,"&nbsp;</td>":
                                "<td>",KEY20,"</td>":
                                "<td align=center>",DMRMAVOL,"</td>"
.
          IF        IBCNMHOS = 1
            WRITE    HTMLFILE;"<td><select name=newhs",ENO3," id=newhs",ENO3:
                              " onchange=":
                              "#"SetHomeLocn('",ENO3,"');#">":
                              "<option></option>"
            MOVE      MRMAHHOS,SELHOSP
            CALL      HSEL0000
            WRITE     HTMLFILE;"</select></td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td><input type=hidden name=d_newlc",ENO3:
                             " id=d_newlc",ENO3:
                             " value=#"",MRMAHLOC,"#">":
                             "<select name=newlc",ENO3," id=newlc",ENO3,">"
...       CALL      LOCSEL00
          WRITE     HTMLFILE;"</select></td>"
.
          WRITE     HTMLFILE;"<td><select name=newtp",ENO3:
                             " id=newtp",ENO3,">"
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      CODSEL00
          WRITE     HTMLFILE;"</select></td>"
.
          WRITE     HTMLFILE;"<td align=center><input type=text ":
                    "value=",DMRMAVOL," size=3 class=#"Integer#"":
                    " maxlength=2 name=newvl",ENO3," id=newvl",ENO3,"></td>";
.
          WRITE     HTMLFILE;"<td align=center><input type=checkbox ":
                    "value=1 name=newdf",ENO3," id=newdf",ENO3,"></td></tr>";
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#">":
                             "SetHomeLocn(#"",ENO3,"#");":
                             "</script>"
.
          GOTO      MRCU1000
.
.
MRCU5000  WRITE     HTMLFILE;"<tr><td width=100% class=HeadingCell ":
                             " align=center colspan=8>":
                             " U/R (no longer required) Existing Records":
                             " to be merged</td></tr>":
                             "<tr><td width=15% class=HeadingCell>":
                             " Home Hospital</td>":
                             "<td width=20% class=HeadingCell>":
                             " Home Location</td>":
                             "<td width=10% class=HeadingCell>":
                             " Document Type</td>":
                             "<td width=8% class=HeadingCell>":
                             " Volume</td>":
                             "<td width=25% class=HeadingCell>":
                             " Current Locaton</td>":
                             "<td width=10% class=HeadingCell>":
                             " Status</td>":
                             "<td width=11% class=HeadingCell>":
                             "Delete</td>":
                             "<td width=1% class=HeadingCell>":
                             "&nbsp;</td>":
                             "</tr>"
.
          MOVE      ZERO,FORM3
          PACK      KEY20,OLDURNUM,SP70
          CALL      RSMRMAS1
MRCU6000  CALL      RKMRMAS1
          BRANCH    OVRCD,MRCU9999
.
          MATCH     OLDURNUM,MRMAURNO
          GOTO      MRCU9999 IF NOT EQUAL
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.                                                * Home Hospital
          UNPACK    SP70,HOMEHOSP,HOMELOCA
          PACK      KEY3,MRMAHHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD <> 1
            MOVE      PTHSNAME,HOMEHOSP
          ENDIF
.                                                * Home Location
          UNPACK    SP70,MRLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10
          CALL      RDMRLOC1
          MOVE      MRLODESC,HOMELOCA
.
.                                                * Current Location
          MOVE      SP70,MRLODESC
          MOVE      SP70,CURRLOCA
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          CLEAR     KEY70
          PACK      KEY70,OBB,MRMACHOS,CBB
          ENDSET    KEY70
          APPEND    MRLODESC,KEY70
          RESET     KEY70
....      MOVE      KEY70,CURRLOCA
.
          CALL      ITRN0000                     * Check if in transit 
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      CURRLOCA,INTRANST,KEY70
          ELSE
            MOVE      KEY70,CURRLOCA
          ENDIF
.                                                * Status
          MOVE      "&nbsp;",CURRSTAT
          MOVE      "RS",CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CURRSTAT

          ADD       ONE,FORM3
          MOVE      FORM3,ENO3
          REP       " 0",ENO3
.
          WRITE     HTMLFILE;"<tr><td> &nbsp;",HOMEHOSP:
               "<input type=hidden name=newhs",ENO3," id=newhs",ENO3:
                             " value=",MRMAHHOS,"></td>":
                             "<td> &nbsp;",HOMELOCA,"</td>":
                             "<td> &nbsp;",KEY20:
               "<input type=hidden name=newtp",ENO3," id=newtp",ENO3:
                             " value=",MRMADOTY,"></td>":
                             "<td> &nbsp; &nbsp; &nbsp;",DMRMAVOL:
               "<input type=hidden name=newvl",ENO3," id=newvl",ENO3:
                             " value=",DMRMAVOL,"></td>":
                             "<td> &nbsp;",CURRLOCA:
               "<input type=hidden name=newlc",ENO3," id=newlc",ENO3:
                             " value=",MRMAHLOC,"></td>":
                             "<td> &nbsp;",CURRSTAT,"</td>";
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * logged in hospital
          IF        OVRCD <> 1
            MATCH     WBSEHOSP,MRMAHHOS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;<input type=checkbox ":
                        "value=1 name=newdf",ENO3," id=newdf",ENO3:
                        "></td></tr>"
            ENDIF
          ENDIF
.
.
          GOTO      MRCU6000
.
MRCU9999  RETURN 
.------------------------------------------------------------------------------
. Medical Record Update Table
.------------------------------------------------------------------------------
MRDS0000  BRANCH    WAHEALTH,MRDS5000       * WaHealth format at MRDS5000
.
          WRITE     HTMLFILE;"<tr><td width=100% class=HeadingCell ":
                                " align=center colspan=5>";
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;" NHI (to keep) Existing Records </td></tr>";
          ELSE
            WRITE     HTMLFILE;" U/R (to keep) Existing Records </td></tr>";
          ENDIF
          WRITE     HTMLFILE;"<tr><td width=19% class=HeadingCell>":
                                " Home Location</td>":
                                "<td width=19% class=HeadingCell>":
                                " Type of Document</td>":
                                "<td width=10% class=HeadingCell align=center>":
                                " Volume</td>":
                                "<td width=20% class=HeadingCell>":
                                "Current Location</td>":
                                "<td width=32% class=HeadingCell>":
                                "Status</td></tr>"
.
          MOVE      ZERO,FORM3
          PACK      KEY20,NEWURNUM,SP70                               *C-240724
          CALL      RSMRMAS1
MRDS1000  CALL      RKMRMAS1
          BRANCH    OVRCD,MRDS9999
.
          MATCH     NEWURNUM,MRMAURNO
          GOTO      MRDS9999 IF NOT EQUAL
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.                                                * Home Location
          UNPACK    SP70,MRLODESC,HOMELOCA
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMAHHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
            RESET     KEY70
          ENDIF     
          MOVE      KEY70,HOMELOCA                          * end     *I-240724
.                                                * Current Location
          MOVE      SP70,MRLODESC
          MOVE      SP70,CURRLOCA
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          PACK      KEY70,MRLODESC,SP70                     * start   *I-240724
          IF        IBCNMHOS = 1
            CLEAR     KEY70
            PACK      KEY70,OBB,MRMACHOS,CBB
            ENDSET    KEY70
            APPEND    MRLODESC,KEY70
            RESET     KEY70
          ENDIF     
.
          CALL      ITRN0000                     * Check if in transit 
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      CURRLOCA,INTRANST,KEY70
          ELSE
            MOVE      KEY70,CURRLOCA
          ENDIF
.
          MOVE      "&nbsp;",CURRSTAT
          MOVE      "RS",CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CURRSTAT
.
          WRITE     HTMLFILE;"<tr><td>",HOMELOCA,"&nbsp;</td>":
                                "<td>",KEY20,"</td>":
                                "<td align=center>",DMRMAVOL,"</td>":
                                "<td>",CURRLOCA,"&nbsp;</td>":
                                "<td>",CURRSTAT,"</td></tr>"
          GOTO      MRDS1000
.
.
.                                           * separate routine for WaHealth
MRDS5000  WRITE     HTMLFILE;"<tr><td width=100% class=HeadingCell ":
                                " align=center colspan=8>":
                                " U/R (to keep) Existing Records </td></tr>":
                                "<tr><td width=15% class=HeadingCell>":
                                " Home Hospital</td>":
                                "<td width=20% class=HeadingCell>":
                                " Home Location</td>":
                                "<td width=10% class=HeadingCell>":
                                " Document Type</td>":
                                "<td width=8% class=HeadingCell>":
                                " Volume</td>":
                                "<td width=25% class=HeadingCell>":
                                "Current Location</td>":
                                "<td width=10% class=HeadingCell>":
                                "Status</td>":
                                "<td width=9% class=HeadingCell>":
                                "&nbsp;</td>":
                                "<td width=3% class=HeadingCell>":
                                "&nbsp;</td></tr>"
.
          MOVE      ZERO,FORM3
          PACK      KEY20,NEWURNUM,SP70                               *C-240724
          CALL      RSMRMAS1
MRDS6000  CALL      RKMRMAS1
          BRANCH    OVRCD,MRDS9999
.
          MATCH     NEWURNUM,MRMAURNO
          GOTO      MRDS9999 IF NOT EQUAL
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.                                                * Home Hospital
          UNPACK    SP70,HOMEHOSP,HOMELOCA
          PACK      KEY3,MRMAHHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD <> 1
            MOVE      PTHSNAME,HOMEHOSP
          ENDIF
.                                                * Home Location
          UNPACK    SP70,MRLODESC
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10  * read MR Location
          CALL      RDMRLOC1
          MOVE      MRLODESC,HOMELOCA
.
.                                                * Current Location
          MOVE      SP70,MRLODESC
          MOVE      SP70,CURRLOCA
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
.
          CLEAR     KEY70
          PACK      KEY70,OBB,MRMACHOS,CBB
          ENDSET    KEY70
          APPEND    MRLODESC,KEY70
          RESET     KEY70
.
          CALL      ITRN0000                     * Check if in transit
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      CURRLOCA,INTRANST,KEY70
          ELSE
            MOVE      KEY70,CURRLOCA
          ENDIF
.
.                                                * Status
          MOVE      "&nbsp;",CURRSTAT
          MOVE      "RS",CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CURRSTAT
.
          WRITE     HTMLFILE;"<tr><td> &nbsp;",HOMEHOSP,"</td>":
                                "<td> &nbsp;",HOMELOCA,"</td>":
                                "<td> &nbsp;",KEY20,"</td>":
                                "<td> &nbsp; &nbsp; &nbsp;",DMRMAVOL,"</td>":
                                "<td> &nbsp;",CURRLOCA,"&nbsp;</td>":
                                "<td> &nbsp;",CURRSTAT,"</td>":
                                "<td> &nbsp;</td></tr>"
          GOTO      MRDS6000
.
MRDS9999  RETURN
.------------------------------------------------------------------------------
. Medical Record Master Details
.------------------------------------------------------------------------------
MRMF0000 BRANCH     FLDITMNO,MRMF0100,MRMF0200,MRMF0300,MRMF0400,MRMF0500:
                             MRMF0600,MRMF0700,MRMF0800,MRMF0900
         GOTO       MRMF9999
.
MRMF0100 WRITE      HTMLFILE;MRMAURNO
         GOTO       MRMF9999
.
MRMF0200 WRITE      HTMLFILE;MRMAHLOC
         GOTO       MRMF9999
.
MRMF0300 WRITE      HTMLFILE;MRMADOTY
         GOTO       MRMF9999
.
MRMF0400 WRITE      HTMLFILE;MRMAVOLN
         GOTO       MRMF9999
.
MRMF0500 WRITE      HTMLFILE;MRMASTAT
         GOTO       MRMF9999
.
MRMF0600 WRITE      HTMLFILE;MRMACOMM
         GOTO       MRMF9999
.
MRMF0700 WRITE      HTMLFILE;MRMAKEY
         GOTO       MRMF9999
.
MRMF0800 WRITE      HTMLFILE;MRMACLOC
         GOTO       MRMF9999
.
MRMF0900 WRITE      HTMLFILE;MRMAFILM
         GOTO       MRMF9999
.
MRMF9999 RETURN 
.------------------------------------------------------------------------------
.  Outputs a selection list of New Locations
.                   ******** LOCSEL00 ********
.------------------------------------------------------------------------------
LOCSEL00  PACK      KEY7,SP70                                         *C-240724
....      CALL      RSMRLOC1
....EL10  CALL      RKMRLOC1
....      BRANCH    OVRCD,LOCSEL99
....
....      MATCH     MRLOTYPE,MRCNHMTY     * Only home locations
....      GOTO      LOCSEL10 IF NOT EQUAL
....
.....     MATCH     MRMAHLOC,MRLOCODE    * Default Medical Records Location
....      IF        @EQUAL
....        MATCH     SP10,MRMAHHOS
....        GOTO      LOCSEL11 IF NOT EQUAL
....        WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
....                             MRLODESC,"</option>"
....      ELSE
....EL11    IF        IBCNMHOS = 1
....          MATCH     WBSEHOSP,MRLOHOSP
....          GOTO      LOCSEL10 IF NOT EQUAL
....        ENDIF
....        WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
....                             MRLODESC,"</option>"
....      ENDIF 
....
....      GOTO    LOCSEL10
....
LOCSEL99  RETURN
.---------------------------------------------------------------------
.  Output a selection list of MRT Locations for the ICD coding screen
.  Using the hospital ID DEFLTHOS and location DEFLTLOC
.---------------------------------------------------------------------
SELLOC00  PACK      KEY7,DEFLTHOS,SP70
          CALL      RSMRLOC1
SELLOC10  CALL      RKMRLOC1
          BRANCH    OVRCD,SELLOC99
.
          COMPARE   "1",MRLOSTAT
          GOTO      SELLOC10 IF EQUAL
.
          MATCH     DEFLTHOS,MRLOHOSP
          GOTO      SELLOC99 IF NOT EQUAL
.
          MATCH     DEFLTLOC,MRLOCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
                                 MRLODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">":
                                 MRLODESC,"</option>"
          ENDIF
.
          GOTO    SELLOC10
.
SELLOC99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of New Locations - No default
.                   ******** SELSTA00 ********
.----------------------------------------------------------------
SELSTA00  MOVE      SIX,F3          * Set Type to Cancer Registration
          MOVE      F3,DIM3
          PACK      KEY9,DIM3,SP70
          CALL      RSIBTH2 
SELSTA10  CALL      RKIBTH2 
          BRANCH    OVRCD,SELSTA99
.
          MATCH     DIM3,IBTHSTYP      * Check Stationary Type  
          GOTO      SELSTA99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">":
                               IBTHDESC,"</option>"
.
          GOTO    SELSTA10
.
SELSTA99  RETURN
.-------------------------------------------------------------------------------
. Write patodcaf/patmi1af records if required (NZ)
.-------------------------------------------------------------------------------
SAVODC00  RESET     NMDSRESB
          MATCH     SP70,NMDSRESB           * No change required
          GOTO      SAVODC99 IF EQUAL
.
          MOVE      ADMISSNO,KEY8           * Read in current admission
          CALL      RDMISS1
          BRANCH    OVRCD,SAVODC20
.
          MOVE      NMDSRESB,AELIG          * update resubmit flag
          CALL      UPMISS1
. 
SAVODC20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDODCA1                 * Read an opr/changes file rec
          BRANCH    OVRCD,SAVODC50
.
          CALL      DEODCA1                 * Delete an opr/changes file rec
.
SAVODC50  MOVE      AADMNO,PTODADMN         * Admin no
          CALL      IBACLOCK
          PACK      PTODDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTODDATE
          MOVE      ZERO,PTODSENT           * Sent in EDI extract flag - no
.
          PACK      KEY8,PTODADMN
          CALL      WRODCA1                 * Write an opr/changes file rec
.
SAVODC99  RETURN
+
.-------------------------------------------------------------------------------
. Save Medical Record Movement
.-------------------------------------------------------------------------------
SAVMVE00  RESET     MRTME003              * Do we have a movement selected?
          MATCH     SP70,MRTME003
          GOTO      SAVMVE99 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1               * Is there a linked MR for this visit 
          BRANCH    OVRCD,SAVMVE99
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2              * Read MR linked to this visit
          BRANCH    OVRCD,SAVMVE99
.
          MOVE      SP70,LASTREAS         * Last movement reason
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1              * Read last history record
          BRANCH    OVRCD,SAVMVE10
.
          MATCH     MRMAKEY,MRHIKEY       * Correct history record
          GOTO      SAVMVE10 IF NOT EQUAL
.
          MOVE      MRHIREAS,LASTREAS     * Save last movement reason
.
. Only move the MR if the location or reason has changed
.
SAVMVE10  MATCH     MRMACHOS,MRTME019     * Has current hospital changed
          GOTO      SAVMVE15 IF NOT EQUAL 
.
          MATCH     MRMACLOC,MRTME003     * Has current location changed 
          GOTO      SAVMVE15 IF NOT EQUAL 
.
          MATCH     LASTREAS,MRTME005     * Has the movement reason changed
          GOTO      SAVMVE99 IF EQUAL     * Exit no movement required
.
SAVMVE15  CALL      CLMRTHIS             * clear History Record
          MOVE      MRMAKEY,MRHIKEY      * Key to History Table
          PACK      MRHIDATE,CCC,CYY,CMM,CDD
          REP       " 0",MRHIDATE        * Date of Movement
          MOVE      CTIMEIS,MRHITIME     * Time of Movement
.
          MOVE      MRTME005,MRHIREAS    * Movement Reason
          MOVE      MRTME019,MRHIDHOS    * Destination hospital
          MOVE      MRTME003,MRHILOC     * Destination Location of Rec
          CALL      CALDUE00             * Calculate Due Date
          CALL      CALSTA00             * Get Status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MOVE      WBSEUID,MRHIUSID     * Web User Id
.
SAVMVE20  PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            PACK      KEY26,MRMAKEY,MRHIDATE,MRHITIME,SP70
            CALL      WRMRHIS1
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
            PACK      KEY10,MRMAKEY,SP70
            CALL      RDMRMAS2            * Updates the current loc
            MOVE      MRHIDHOS,MRMACHOS                               *I-240724
            MOVE      MRHILOC,MRMACLOC
            CALL      IBACLOCK
            PACK      MRMADTUP,CCC,CYY,CMM,CDD
            REP       " 0",MRMADTUP
            MOVE      CTIMEIS,MRMATMUP
            MOVE      WBSEUID,MRMAUUID
            CALL      UPMRMAS2
          ENDIF
.
          GOTO      SAVMVE99
.
SAVMVE99  RETURN
.
.-------------------------------------------------------------------------------
. Calculate Due Date - returns MRHIDDUE
.-------------------------------------------------------------------------------
CALDUE00  MOVE      SP70,MRHIDDUE
.
          PACK      KEY4,MRHIREAS,SP70
          CALL      RDMRMOV1            * Get Borrowing Period
          BRANCH    OVRCD,CALDUE99
.
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY  * Date of Movement
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       MRMOPERD,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      MRHIDDUE,CC,YY,MM,DD           * Calculated Due Date
          REP       " 0",MRHIDDUE
.
CALDUE99  RETURN
.-------------------------------------------------------------------------------
. Calculate Status - returns MRHISTAT
.-------------------------------------------------------------------------------
CALSTA00  PACK      KEY7,MRMACHOS,MRMACLOC,SP70                       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CALSTA99
.
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT   * 1-Out
          ELSE
            MOVE      TWO,MRHISTAT   * 2-In
          ENDIF
.
CALSTA99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 10 - Medical Record Movement Maintenance
.-------------------------------------------------------------------------------
STMOE000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMOE001,STMOE002,STMOE003,STMOE004,STMOE005,STMOE006:
                       STMOE007,STMOE008,STMOE009,STMOE010,STMOE011,STMOE012:
                       STMOE013,STMOE014,STMOE015,STMOE016,STMOE017,STMOE018:
                       STMOE019,STMOE020
.
          GOTO      STMOE999
.
STMOE001  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME001 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME001,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME001
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE002  MOVE      QRYDATA,MRTME002
          GOTO      STMOE999
.
STMOE003  MOVE      QRYDATA,MRTME003
          PACK      MRTME003,MRTME003,SP70
          GOTO      STMOE999
.
STMOE004  MOVE      QRYDATA,MRTME004
          PACK      MRTME004,MRTME004,SP70
          GOTO      STMOE999
.
STMOE005  MOVE      QRYDATA,MRTME005
          PACK      MRTME005,MRTME005,SP70
          GOTO      STMOE999
.
STMOE006  MOVE      QRYDATA,MRTME006
          GOTO      STMOE999
.
STMOE007  PACK      QRYDATA,QRYDATA,SP30
          UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted date
          MATCH     SP70,KEY3
          IF        @EQUAL
            MOVE      QRYDATA,MRTME007 * Do not change date format = (CCYYMMDD)
          ELSE
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      MRTME007,CCENT,CYEAR,CMON,CDAY
              REP       " 0",MRTME007
            ENDIF
          ENDIF
          GOTO      STMOE999
.
STMOE008  MOVE      QRYDATA,MRTME008
          GOTO      STMOE999
.
STMOE009  MOVE      QRYDATA,MRTME009
          GOTO      STMOE999
.
STMOE010  MOVE      QRYDATA,MRTME010
          GOTO      STMOE999
.
STMOE011  MOVE      QRYDATA,MRTME011
          GOTO      STMOE999
.
STMOE012  MOVE      QRYDATA,MRTME012
          GOTO      STMOE999
.
STMOE013  MOVE      QRYDATA,MRTME013
          GOTO      STMOE999
.
STMOE014  MOVE      QRYDATA,MRTME014
          GOTO      STMOE999
.
STMOE015  MOVE      QRYDATA,MRTME015
          GOTO      STMOE999
.
STMOE016  MOVE      QRYDATA,MRTME016
          GOTO      STMOE999
.
STMOE017  MOVE      QRYDATA,MRTME017        * new Home Location
          PACK      MRTME017,MRTME017,SP70
          GOTO      STMOE999
.
STMOE018  MOVE      QRYDATA,MRTME018
          GOTO      STMOE999
.
STMOE019  PACK      MRTME019,QRYDATA,SP70  * Destination Hospital
          GOTO      STMOE999
.
STMOE020  MOVE      QRYDATA,MRTME020        * Home Hospital
          GOTO      STMOE999

STMOE999  RETURN
.******************************************************************************
.*                                 WPEI0000                                   *
.*                        Write A Record To patpeiaf                          *
.******************************************************************************
WPEI0000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WPEI9999 IF NOT EQUAL   * Not in Victoria
.
          COMPARE   THREE,ASTAT
          GOTO      WPEI9000 IF NOT EQUAL   * Not discharged
.
          MATCH     CHCSDTE,DDATE
          GOTO      WPEI9000 IF LESS        * Discharge date < start HDP date
.
          MATCH     CHCSST,ADATE
          GOTO      WPEI9000 IF NOT LESS    * Adm date >= PRS2 extract start dte
.
          PACK      KEY16,SP8,AADMNO,TWO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          PACK      KEY16,CHCSST,AADMNO,TWO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          MOVE      SP8,PTPESTDT
          MOVE      AADMNO,PTPEADMN
          MOVE      TWO,PTPESTAT
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
WPEI1000  CALL      RDKCODE1                  record
          BRANCH    OVRCD,WPEI2000
.
          MATCH     "RN",TCODE
          GOTO      WPEI2000 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      WPEI1000 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
WPEI2000  MOVE      PASSCODE,PTPEOPER
          PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
WPEI9000  MOVE      ZERO,EXIT
WPEI9999  RETURN
+
.******************************************************************************
.*                                 UPLV0000                          *I-56959 *
.*                        Update records in mrtvisaf                          *
.*                Link medical record visits to dest med record               *
.******************************************************************************
UPLV0000  MOVE      MRMAKEY,DIM10
.
          MOVE      SAVKEY20,KEY20                                    *C-240724
          CALL      RDMRMAS1
          BRANCH    OVRCD,UPLV9999
.
          PACK      KEY18,MRMAKEY,SP70
          CALL      RSMRVS2
UPLV0100  CALL      RKMRVS2
          BRANCH    OVRCD,UPLV9999
.
          MATCH     MRMAKEY,MRVSMKEY
          GOTO      UPLV9999 IF NOT EQUAL
.
          MOVE      DIM10,MRVSMKEY
          CALL      UPMRVS2
.
          PACK      KEY18,MRMAKEY,SP70
          CALL      RSMRVS2
          GOTO      UPLV0100
.
UPLV9999  RETURN
.
.------------------------------------------------------------
. Hospital Selection - List of Hospitals allowed to User
.------------------------------------------------------------
HSEL0000  MOVE      ZERO,EXIT
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     SELHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
.
HSEL9999  RETURN
.------------------------------------------------------------
. Display Coding Comments
.------------------------------------------------------------
DCMT0000  MOVE      "004",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
DCMT1000  CALL      RKVSCMT1
          BRANCH    OVRCD,DCMT9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      DCMT9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      DCMT9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      DCMT1000
.
DCMT9999  RETURN
.
.------------------------------------------------------------
. Check if Coding Comments exist. 
.------------------------------------------------------------
.
CCCHK000  MOVE      "004",KEY3
          PACK      KEY17,ADMISSNO,KEY3,SP70
          CALL      RSVSMDT1
          CALL      RKVSMDT1
          BRANCH    OVRCD,CCCHK998
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      CCCHK998 IF NOT EQUAL
.
          MATCH     KEY3,VSMDTYPE
          GOTO      CCCHK998 IF NOT EQUAL
.
          WRITE     HTMLFILE;"1";
          GOTO      CCCHK999  
.
CCCHK998  WRITE     HTMLFILE;"0";
.
CCCHK999  RETURN
.
.------------------------------------------------------------
. Check if Coding Comments exist from viscmtaf.
.------------------------------------------------------------
CVSCM000  MOVE      "004",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,CVSCM998
.
          MATCH     ADMISSNO,VSCTVIST
          GOTO      CVSCM998 IF NOT EQUAL
.
          MATCH     KEY3,VSCTTYPE
          GOTO      CVSCM998 IF NOT EQUAL
.
          WRITE     HTMLFILE;"1";
          GOTO      CVSCM999
.
CVSCM998  WRITE     HTMLFILE;"0";
.
CVSCM999  RETURN
.
.------------------------------------------------------------
. Check if Mechanical Ventilation exists. 
.------------------------------------------------------------
CKMV0000  MOVE      ZERO,FORM1
          PACK      KEY27,ADMISSNO,SP70
          CALL      RSPTVEN1
CKMV1000  CALL      RKPTVEN1
          BRANCH    OVRCD,CKMV9000
          MATCH     ADMISSNO,PTVEVISN
          GOTO      CKMV9000 IF NOT EQUAL
          MOVE      ONE,FORM1
CKMV9000  WRITE     HTMLFILE;FORM1;
CKMV9999  RETURN
+
.------------------------------------------------------------
. Display Coding Comments (NEW)
.------------------------------------------------------------
CODCOM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
.
          MOVE      "004",NOTEFILT
          PACK      KEY17,ADMISSNO,NOTEFILT,SP70
          CALL      RSVSMDT1
CODCOM10  CALL      RKVSMDT1
          BRANCH    OVRCD,CODCOM99          
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      CODCOM99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE              * Coding Comment Type
          GOTO      CODCOM99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          BRANCH    F1,CODCOM98
          GOTO      CODCOM10 IF EQUAL
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          WRITE     HTMLFILE;CDAY,"/",CMON,"/",CCENT,CYEAR,"&nbsp;";
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            STRIP     WBSENAM
            WRITE     HTMLFILE;*+,WBSENAM,"&nbsp;";   * The *+, will not
          ELSE                                        * output past LL
            STRIP     VSMDUSER
            WRITE     HTMLFILE;*+,VSMDUSER,"&nbsp;";
          ENDIF
.
          CALL        VSNOTE00
          GOTO        CODCOM10
.
CODCOM98  WRITE       HTMLFILE;"1";
.
CODCOM99  RETURN
.
.--------------------------------------------------------------------
. Visit note display
.--------------------------------------------------------------------
VSNOTE00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSNOTE10  CALL      RKVSMTX1
          BRANCH    OVRCD,VSNOTE99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          WRITE     HTMLFILE;*+,VSMTCMNT      * The *+, will not output past LL
.
          GOTO      VSNOTE10
.
VSNOTE99  RETURN
+
.--------------------------------------------------------------------
. Returns Coding Comments in descending order. Ignore delete comments
.--------------------------------------------------------------------
CODCMT00  MOVE      "004",NOTEFILT
          PACK      KEY17,ADMISSNO,NOTEFILT,Z70
          CALL      RSVSMDT1
CODCMT10  CALL      RPVSMDT1
          BRANCH    OVRCD,CODCMT99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      CODCMT99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE              * Coding Comment Type
          GOTO      CODCMT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT
          GOTO      CODCMT10 IF EQUAL
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          WRITE     HTMLFILE;CDAY,"/",CMON,"/",CCENT,CYEAR,"&nbsp;";
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            STRIP     WBSENAM
            WRITE     HTMLFILE;*+,WBSENAM,"&nbsp;";   * The *+, will not
          ELSE                                        * output past LL
            STRIP     VSMDUSER
            WRITE     HTMLFILE;*+,VSMDUSER,"&nbsp;";
          ENDIF
.
          CALL        VSNOTE00
          GOTO        CODCMT10
.
CODCMT99  RETURN
+
.-------------------------------------------------------------------------------
.                         ******* PRVDSN00 ********
.    Copy the selected discharge coding record for this patient?
.    First read the visit file by UR and then check Discharge file for
.    this admission
.-------------------------------------------------------------------------------
PRVDSN00  MOVE      ZERO,EXIT
          MOVE      ZERO,EPSNUMBR
          MOVE      ADMISSNO,VISITNUM     * Visit no save variable
.
.         Read admission record and save the admission date for OPRCPY00
.
          PACK      VISITDAT,SP70
          PACK      DISCHDAT,SP70
          PACK      KEY8,ADMISSNO,SP70      * Read admission record
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      ADATE,VISITDAT        * Save admission date
            IF        ASTAT=3
              CALL      RDDSCH1               * discharge record on file ?
              IF        OVRCD=0
                MOVE      DDATE,DISCHDAT      * Save discharged date
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,CPYADMNO,SP70
          CALL      RDPTVISA1
          BRANCH    OVRCD,PRVDSN90
.
          PACK      KEY8,DPVIBILL,SP70 * Read Discharge File for a valid record
          CALL      RDADSCH1
          BRANCH    OVRCD,PRVDSN90     * Record not found read next visit
.
          PACK      KEY8,DPVIBILL,SP70 * Read Admission File for a valid record
          CALL      RDMISS1            * and check ACODDTE if blank?
          BRANCH    OVRCD,PRVDSN90     * Record not found read next visit
.
.   Check for an existing episode with Coding for this patient
.
          MOVE      DPVIBILL,VISITNUM  * Set for GETEPS00 & Last Visit found
          CALL      GETEPS00           * Get first existing pisodes with Coding
          MATCH     " 0",EPSNUMBR
          GOTO      PRVDSN90 IF EQUAL  * No Episode found for this Admission
.
.   Clear the current Episode we are copying to.
.
          CALL      DELLCK00  * Delete Diagnosis Lock Record if found
          CALL      DELECD00  * Delete all records from Diagnosis Coding file
          CALL      DELECO00  * Delete all records from Procedure Coding file
          CALL      CLRCHC00  * clear "Date Episode Coding Complete" in PATCHCof
.
.   Read and Copy the Previous Discharge Episode
.
          PACK      SAVKEY13,VISITNUM,EPSNUMBR,SP70
          CALL      OPRCPY00  * Copy Procedures Episode File
.
          PACK      SAVKEY13,VISITNUM,EPSNUMBR,SP70
          CALL      DISCPY00  * Copy Diagnosis Episode File
.
          GOTO      PRVDSN99
.
PRVDSN90  MOVE      "No Prevous Discharge Details Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVDSN99
.
PRVDSN99  RETURN
.
.------------------------------------------------------------
. Display ICD10 edition on coding summary screen
.------------------------------------------------------------
DEDI0000  MOVE      SP70,CODINGED
.
          MATCH     SP70,ICDRDDTE           * Is Date blank?
          IF        @EQUAL | @EOS
            PACK      ICDRDDTE,CCC,CYY,CMM,CDD  * Yes, use current date
            REP       " 0",ICDRDDTE
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV2       * is Ed.2 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "2",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV3       * is Ed.3 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "3",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV4       * is Ed.4 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "4",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV5       * is Ed.5 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "5",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV6       * is Ed.6 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "6",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV7       * is Ed.7 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "7",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV8       * is Ed.8 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "8",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV9       * is Ed.9 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "9",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDVX       * is Ed.10 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "10",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX1       * is Ed.11 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "11",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX2       * is Ed.12 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "12",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX3       * is Ed.13 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "13",CODINGED
          ENDIF
.
          WRITE     HTMLFILE;CODINGED;
.
DEDI9999  RETURN
.
.------------------------------------------------------------
. Save ICD10 edition to CODINGED variable        
.------------------------------------------------------------
SVIC0000  MOVE      SP70,CODINGED
.
          MATCH     SP70,ICDRDDTE           * Is Date blank?
          IF        @EQUAL | @EOS
            PACK      ICDRDDTE,CCC,CYY,CMM,CDD  * Yes, use current date
            REP       " 0",ICDRDDTE
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV2       * is Ed.2 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "2",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV3       * is Ed.3 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "3",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV4       * is Ed.4 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "4",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV5       * is Ed.5 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "5",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV6       * is Ed.6 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "6",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV7       * is Ed.7 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "7",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV8       * is Ed.8 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "8",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDV9       * is Ed.9 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "9",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDVX       * is Ed.10 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "10",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX1       * is Ed.11 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "11",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX2       * is Ed.12 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "12",CODINGED
          ENDIF
.
          MATCH     ICDRDDTE,PTCNGDX3       * is Ed.13 alive & active
          IF        (@EQUAL | @LESS)
            MOVE      "13",CODINGED
          ENDIF
.
SVIC9999  RETURN
.
.
.-------------------------------------------------------------------------------
. Get the episode number of the next uncoded epsiode for this visit
.-------------------------------------------------------------------------------
NEPS0000  MOVE      ZERO,CCARFLAG         * Set care type change flag to no
          IF        ASTAT=3
            MOVE      ONE,EPSCD001        * If discharged ther will be an 
            MOVE      DPVIBILL,LASTVIST   * episode one. Set for CHKEPS00
            MOVE      EPSCD001,VALDEPIS
.
            CALL      CHKEPS00            * Check if coding exists for episode 
            COMPARE   ONE,EPSFLAG         * one 
            GOTO      NEPS8000 IF EQUAL   * Episode one not coded so select it
          ENDIF
.
          PACK      KEY26,DPVIBILL,SP70
          CALL      RDSCHCO2
NEPS1000  CALL      RDKCHCO2
          BRANCH    OVRCD,NEPS9000
.
          MATCH     DPVIBILL,DCHADMN
          GOTO      NEPS9000 IF NOT EQUAL
.
          MOVE      ONE,CCARFLAG       * Set care type change flag to yes
.
          MATCH     " 1",CHEPISNO      * Skip episde one
          GOTO      NEPS1000 IF EQUAL
      
          MOVE      CHEPISNO,EPSCD001
          MOVE      EPSCD001,VALDEPIS
.
          CALL      CHKEPS00            * Check if Patient has existing Episodes
          COMPARE   ONE,EPSFLAG
          GOTO      NEPS1000 IF NOT EQUAL
.
          MOVE      EPSNUMBR,EPSCD001      
.
NEPS8000  MOVE      ZERO,EXIT
          GOTO      NEPS9999
.
NEPS9000  IF        ASTAT=3 & CCARFLAG=1
            ADD       ONE,EPSCD001        * Create discharge phantom episode 
            MOVE      EPSCD001,VALDEPIS   * if there was a care type change
            CALL      CHKEPS00            * Check if coding exists for 
            COMPARE   ONE,EPSFLAG         * phantom episode
            IF        @EQUAL
              MOVE      ZERO,EXIT       * Phantom episode not coded so select it
              GOTO      NEPS9999
            ENDIF
          ENDIF
.
          MOVE      ONE,EXIT          * Skip visit no uncoded episodes
          GOTO      NEPS9999
.
NEPS9999  RETURN
.
.*****************************************************************************
.*  WRWATR00
.*  Procedure to write to the WA triggers table if required
.*****************************************************************************
          DEFPROC   WRWATR00
.         
          INC       PMSWTRFD/INC
          INC       PATMI1FD/INC
.         
          COMPARE   SIX,PTCNHDPS           * If not WA - exit
          GOTO      WRWATR99 IF NOT EQUAL  
.         
          OPEN      PMSWTRA1,"pmswtraf"
          OPEN      PATMI1A1,"patmi1af"
.         
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,WRWATR99
.         
          COMPARE   THREE,ASTAT
          GOTO      WRWATR99 IF NOT EQUAL
.
WRWATR10  PACK      KEY19,WBSEHOSP,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      WRWATR99    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,WBSEHOSP,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
          GOTO      WRWATR99
.
          INC       PATMI1IO/INC
          INC       PMSWTRIO/INC
          INC       IBAOVRIO/INC
.
WRWATR99  CLOSE     PMSWTRA1
.
          ENDPROC
+
.---------------------------------------------------------------------------
. Check if this MR is in transit to the current location
.---------------------------------------------------------------------------
ITRN0000  MOVE      SP70,INTRANST
.
          MATCH     "1",MRCNTREC                 * System Using Tracking Receipt
          GOTO      ITRN9999 IF NOT EQUAL
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                     * Read last history record
          BRANCH    OVRCD,ITRN9999
.
          MATCH     MRMAKEY,MRHIKEY              * Correct MR history record
          GOTO      ITRN9999 IF NOT EQUAL
.
          MATCH     MRMACHOS,MRHIDHOS            * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current hospital
.
          MATCH     MRMACLOC,MRHILOC             * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current location
.
          MATCH     "1",MRHIRCST                 * In Transit
          GOTO      ITRN9999 IF NOT EQUAL
.
          MOVE      "<font color=red>(T)</font>",INTRANST
.
ITRN9999  RETURN
+
.---------------------------------------------------------------------------
.  Get unplanned readmission
.---------------------------------------------------------------------------
GETUNR00  MOVE      SP70,UNPLREAD
          MOVE      SP70,DIM1
.
          MATCH     SP70,ATYPE
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSX,TCINDC14
              GOTO      GETUNR99 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,GETUNR50
.
          MATCH     ANSA,TMOVE
          GOTO      GETUNR50 IF NOT EQUAL
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,GETUNR50
.
          MATCH     SP70,WCLASS
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSC,ANSG,WCLASS,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              UNPACK    PTCDASC3,DIM1
              MATCH     ANSX,DIM1
              GOTO      GETUNR99 IF EQUAL
            ENDIF
          ENDIF
.
GETUNR50  PACK      SAVEKEY8,DADMNO,SP70
          MOVE      ADATE,ORGDDATE
.
          MATCH     SP70,DURNO
          IF        @EQUAL | @EOS
            PACK      KEY24,URNUMBER,DDATE,SP70
          ELSE
            PACK      KEY24,DURNO,DDATE,DADMNO,SP70
          ENDIF
.
          CALL      RDADSCH3
          CALL      RDPDSCH3
          BRANCH    OVRCD,GETUNR90
.
          MATCH     URNUMBER,DURNO
          GOTO      GETUNR90 IF NOT EQUAL
.
          MOVE      DDATE,PRVDDATE
.
          DAYSEP    PRVDDATE,ORGDDATE,FORM5
.
          COMPARE   FORM5,TWENTY8
          GOTO      GETUNR90 IF LESS
.
          MOVE      ONE,UNPLREAD
.
GETUNR90  MOVE      SAVEKEY8,KEY8
          CALL      RDDSCH1
.
GETUNR99  RETURN
.
.---------------------------------------------------------------------------
.  Find Cancer Diseases Code Number
.---------------------------------------------------------------------------
FNDDCN00  PACK      SAVKEY13,PTEDADMN,PTEDEPNO,PTEDCNT,SP70
          PACK      SAVKEY8,PTEDADMN,SP70
          PACK      SAVKEY2,PTEDEPNO,SP70
          PACK      SAVKEY3,PTEDCNT,SP70
          PACK      SAVKEY9,PTEDCODE,SP70
          MOVE      ZERO,CANDSC01
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,SP70
          CALL      RSPTECD1
FNDDCN10  CALL      RKPTECD1
          BRANCH    OVRCD,FNDDCN90
.
          MATCH     SAVKEY8,DPTEDADM
          GOTO      FNDDCN90 IF NOT EQUAL
.
          MATCH     SAVKEY2,DPTEDEPN
          GOTO      FNDDCN90 IF NOT EQUAL
.
          MATCH     SAVKEY9,PTEDCODE
          GOTO      FNDDCN10 IF NOT EQUAL 
.
          ADD       ONE,CANDSC01
.
          MATCH     SAVKEY3,DPTEDCNT
          GOTO      FNDDCN10 IF NOT EQUAL
.
FNDDCN90  PACK      KEY13,SAVKEY13,SP70
          CALL      RDPTECD1
.
FNDDCN99  RETURN
+
.------------------------------------------------------------
. Errors Generated by CCA Interface
.------------------------------------------------------------
ERRCCA00  COMPARE   TWO,MRCNGRUP
          GOTO      ERRCCA95 IF NOT EQUAL        * using CCA interface?
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ERRCCA05
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8   * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,ERRCCA05
.
ERRCCA05  CALL      CURPER00   * Set Current Periods
          CALL      CALCDT00   * Calc Next and Last Periods
.
          CALL      CLCCAERR
          MATCH     SP70,CCAERRKY
          GOTO      ERRCCA10 IF EQUAL
          PACK      KEY24,CCAERRKY,SP70
          CALL      RDMRCIE1
          IF        OVRCD=1
            CALL      CLCCAERR
          ELSE
            MOVE      "1",MRCEPROC
            MOVE      USERID,MRCEUFAP
            MOVE      CURRDATE,MRCEDFAP
            MOVE      CTIMEIS,MRCETFAP
            CALL      UPMRCIE1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      ERRCCA99
.
ERRCCA10  MOVE      "CCA to webPAS Interface Errors",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ERRCCA99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      ERRCCA99
.
ERRCCA95  MOVE      "Not using CCA interface.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ERRCCA99
.
ERRCCA99  RETURN
+
.------------------------------------------------------------
. Clear CCA Error Fields
.------------------------------------------------------------
CLCCAERR  MOVE      SP70,MRCEDATE
          MOVE      SP70,MRCETIME
          MOVE      SP70,MRCEURNO
          MOVE      SP70,MRCEVISN
          MOVE      SP70,MRCEFNAM
          MOVE      SP70,MRCEERRM
          MOVE      SP70,MRCEPROC
          MOVE      SP70,MRCEUFAP
          MOVE      SP70,MRCEDFAP
          MOVE      SP70,MRCETFAP
          MOVE      SP70,MRCESPAR
          RETURN
+
.--------------------------------------------------------------------------
.                Selection List of Reasons
.  .0 = List of Reason of Admission with match on CGI parameter
.  .1 = Defualt Selected to Admission
.  .2 = List of reasons with type,reason indicators and usage indicators
.  .3 = Defualt Selected to Admission
.       List of reasons with type,reason indicators and usage indicators
.--------------------------------------------------------------------------
SELREA00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        F1=1 | F1=3
            MOVE      "A   ",SELECTED
          ELSE
            MOVE      MRTME005,SELECTED
          ENDIF
.
          PACK      KEY4,SP70
          CALL      RSMRMOV1
SELREA10  CALL      RKMRMOV1
          BRANCH    OVRCD,SELREA99
.
          COMPARE   ONE,MRMOSTAT            * Active?
          GOTO      SELREA10 IF EQUAL
.
          IF        F1=2 | F1=3
            PACK      KEY30,QUOTE,MRMOREAS,MRMOTYPE,MRMOINDC,MRMOUSAG:
                            MRMOPERD,QUOTE
          ELSE
            PACK      KEY30,QUOTE,MRMOREAS,SP5,QUOTE
          ENDIF
.
          MATCH     MRMOREAS,SELECTED
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               MRMODESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY30,">",MRMODESC,"</option>"
          ENDIF
          GOTO      SELREA10
.
SELREA99  RETURN
+
.---------------------------------------------------------------
.   Return Disease Episode Unique Counter
.   Required  - VALDCODE - MRT Location Code
.   Returns   = 0 = Not mandatory. 1 = mandatory
.---------------------------------------------------------------
REASNM00  CALL      XMLHED00
          BRANCH    EXIT,REASNM99
.
          MOVE      ZERO,F1                 * Reason not mandatory
.
          PACK      KEY7,VALDCODE,SP70
          CALL      RDMRLOC1                * Read Location                
          BRANCH    OVRCD,REASNM90
.
          MATCH     SP70,MRLOTYPE           * Any location type
          GOTO      REASNM90 IF EQUAL
.
          PACK      KEY5,ANSL,ANST,MRLOTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,REASNM90
.
          MATCH     ANSM,TCINDC3
          GOTO      REASNM90 IF NOT EQUAL
.
          MOVE      ONE,F1                  * Reason Mandatory
.
REASNM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1,"|":
                             "</RETURN_VALUE>"
.
REASNM98  CALL      XMLEND00
REASNM99  RETURN
+
.---------------------------------------------------------------
.   Return whether HONOS data exists on mehhonaf
.   Required  - VALDCODE - Admission Number
.   Returns   = 0 = No data. 1 = Data exists.
.---------------------------------------------------------------
HONDET00  CALL      XMLHED00
          BRANCH    EXIT,HONDET99
.
          MOVE      ZERO,F1                 * no data on mehhonaf
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      MEHHONA3,"mehhonaf"
          TRAPCLR   IO
          BRANCH    OVRCD,HONDET90
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSMHHON3
HONDET10  CALL      RPMHHON3                * read most recent Honos
          BRANCH    OVRCD,HONDET90
.
          MATCH     ADMISSNO,MHHNVISN
          GOTO      HONDET90 IF NOT EQUAL
.
          MATCH     "1",MHHNACTV            * is this Active (1=Active) ?
          GOTO      HONDET10 IF NOT EQUAL
.
          MOVE      ONE,F1                  * Data exists on mehhonaf
.
HONDET90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1,"|":
                             "</RETURN_VALUE>"
.
HONDET98  CALL      XMLEND00
HONDET99  RETURN
+
.------------------------------------------------------------
. Display webCodefinder Input Tag
.------------------------------------------------------------
DWCI0000  PACK      WCFINPFN,ENCINP,URNUMBER,ADMISSNO,SP70
          REP       " 0",WCFINPFN
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ENCFILEF,WCFINPFN
          TRAPCLR   IO
          BRANCH    OVRCD,DWCI9999
.
DWCI1000  READ      ENCFILEF,SEQ;CODELINE
          GOTO      DWCI9000 IF OVER
          WRITE     HTMLFILE;CODELINE
          GOTO      DWCI1000
.
DWCI9000  CLOSE     ENCFILEF
DWCI9999  RETURN
+
.------------------------------------------------------------
. Get webCodefinder Output Tag
.------------------------------------------------------------
GETENC00  MOVE      ".txt",KEY4
          PACK      WCFOUTFN,ENCOUT,URNUMBER,ADMISSNO,KEY4,SP70
          REP       " 0",WCFOUTFN
          PREP      ENCOUTAF,WCFOUTFN
          WRITE     ENCOUTAF,SEQ;QRYDATA
.
GETENC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETENC99 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETENC80 IF NOT EQUAL
          WRITE     ENCOUTAF,SEQ;QRYDATA
          GOTO      GETENC10
.
GETENC80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETENC99  RETURN
+
.------------------------------------------------------------
. Web Codefinder Remote Scripting routines
.------------------------------------------------------------
WCREMT00  CALL      XMLHED00
          BRANCH    EXIT,WCREMT99
.
          BRANCH    VALDTYPE,WCREMT10,WCREMT20,WCREMT30
          GOTO      WCREMT98
.
WCREMT10  CALL      DELWCF00           * Delete Web Codefinder input file
          GOTO      WCREMT98
.
WCREMT20  CALL      CHKWCF00           * Check Web Codefinder input file exists
          GOTO      WCREMT98
.
WCREMT30  CALL      UPDCID00           * Update diagnosis DCID
          GOTO      WCREMT98
.
WCREMT98  CALL      XMLEND00
WCREMT99  RETURN
+
.------------------------------------------------------------
. Delete Web Codefinder input file for UR/Admission
.------------------------------------------------------------
DELWCF00  PACK      WCFINPFN,ENCINP,URNUMBER,ADMISSNO,SP70
          REP       " 0",WCFINPFN
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ENCFILEF,WCFINPFN
          TRAPCLR   IO
          BRANCH    OVRCD,DELWCF91
.
          CLOSE     ENCFILEF,DELETE
.
DELWCF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>0</RETURN_VALUE>"
          GOTO      DELWCF99
.
DELWCF91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"
          GOTO      DELWCF99
.
DELWCF99  RETURN
+
.------------------------------------------------------------
. Check if Web Codefinder input file exists for UR/Admission
.------------------------------------------------------------
CHKWCF00  PACK      WCFINPFN,ENCINP,URNUMBER,ADMISSNO,SP70
          REP       " 0",WCFINPFN
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ENCFILEF,WCFINPFN
          TRAPCLR   IO
          BRANCH    OVRCD,CHKWCF91
.
CHKWCF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"
          GOTO      CHKWCF99
.
CHKWCF91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>0</RETURN_VALUE>"
          GOTO      CHKWCF99
.
CHKWCF99  RETURN
+
.------------------------------------------------------------
. Update diagnosis records diagnosis cluster id 
.------------------------------------------------------------
UPDCID00  PACK      KEY13,ADMISSNO,PTECD002,PTECD003,SP70
          CALL      RDPTECD1              * Episode diagnosis file record
          BRANCH    OVRCD,UPDCID90
.
          SQUEEZE   CLUSTERV
          PACK      PTEDDCID,CLUSTERV,SP70
.
          CALL      UPPTECD1              * Update an eps diag coding file rec
.
.  Outputting Dummy Info so that Remote scripting does not fall over
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ADMISSNO,"|":
                             "</RETURN_VALUE>"
.
          GOTO      UPDCID99
.
UPDCID90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Record Not Found! ":
                             "</RETURN_VALUE>"
.
UPDCID99  RETURN
+
.------------------------------------------------------------
. Get Proceduralist opseclin
.------------------------------------------------------------
GPR10000  UNPACK    DIM127,DIM1,KEY1,DIM127
.
          MOVE      ONE,MMRECN
          PACK      KEY11,ADMISSNO,MMRECN,SP70
          CALL      RDMMBS1
          IF        OVRCD = 0
            GOTO      GPR13000
          ENDIF
.
. No MBS, get the 1st oprdetaf row
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
GPR12000  CALL      RKOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,GPR19999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      GPR19999 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      GPR12000 IF EQUAL
.
          GOTO      GPR14000
.
GPR13000  PACK      KEY10,PTMMOPID,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,GPR19999
.
GPR14000  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,GPR19999
.
          MATCH     SP70,OPSECLIN
          GOTO      GPR19999 IF EQUAL
          GOTO      GPR19999 IF EOS
.
          PACK      KEY10,OPSECLIN,SP70     * Get Doctors full name
.
          COMPARE   ZERO,OPCNCLSU           * Using clinic or surgeon
          IF        @EQUAL
            PACK      KEY6,OPSECLIN,SP70
            CALL      RDOPCLI1
            IF        OVRCD=0
              PACK      KEY10,OPCLDOCT,SP70
            ENDIF
          ENDIF
.
          CALL      RDPMHCP1
          BRANCH    OVRCD,GPR19999
.
          MATCH     "1",KEY1
          IF         @EQUAL
            WRITE     HTMLFILE;PMHCHCPC;
            GOTO      GPR19999
          ENDIF
.
          MATCH     "2",KEY1
          IF         @EQUAL
            MOVE      SP70,DOCFNAME
            STRIP     PMHCTITL
            STRIP     PMHCGNAM
            STRIP     PMHCSNAM
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            RESET     PMHCTITL
            RESET     PMHCGNAM
            RESET     PMHCSNAM
            CALL      DOCNM000
.
            WRITE     HTMLFILE;DOCFNAME;
            GOTO      GPR19999
          ENDIF
.
GPR19999  RETURN
+
.------------------------------------------------------------
. Get Proceduralist opsedcc1
.------------------------------------------------------------
GPR20000  UNPACK    DIM127,DIM1,KEY1,DIM127
.
          MOVE      ONE,MMRECN
          PACK      KEY11,ADMISSNO,MMRECN,SP70
          CALL      RDMMBS1
          IF        OVRCD = 0
            GOTO      GPR23000
          ENDIF
.
. No MBS, get the 1st oprdetaf row
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
GPR22000  CALL      RKOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,GPR29999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      GPR29999 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      GPR22000 IF EQUAL
.
          GOTO      GPR24000
.
GPR23000  PACK      KEY10,PTMMOPID,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,GPR29999
.
GPR24000  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,GPR29999
.
          MATCH     SP70,OPSEDCC1
          GOTO      GPR29999 IF EQUAL
          GOTO      GPR29999 IF EOS
.
          PACK      KEY10,OPSEDCC1,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          BRANCH    OVRCD,GPR29999
.
          MATCH     "1",KEY1
          IF         @EQUAL
            WRITE     HTMLFILE;PMHCHCPC;
            GOTO      GPR19999
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            MOVE      SP70,DOCFNAME
            STRIP     PMHCTITL
            STRIP     PMHCGNAM
            STRIP     PMHCSNAM
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            RESET     PMHCTITL
            RESET     PMHCGNAM
            RESET     PMHCSNAM
            CALL      DOCNM000
.
            WRITE     HTMLFILE;DOCFNAME;
            GOTO      GPR19999
          ENDIF
.
GPR29999  RETURN
.
.--------------------------------------------------------------------------
. Get defaulting Surgeon from Theatre Case (oprtsmaf.OPTSSCDE)
.--------------------------------------------------------------------------
GPR30000  UNPACK    DIM127,DIM1,KEY1,DIM127
.
          MOVE      ONE,MMRECN
          PACK      KEY11,ADMISSNO,MMRECN,SP70
          CALL      RDMMBS1
          IF        OVRCD = 0
            GOTO      GPR33000
          ENDIF
.
. No MBS, get the 1st oprdetaf row
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
GPR32000  CALL      RKOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,GPR39999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      GPR39999 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      GPR32000 IF EQUAL
.
GPR32100  MOVE      " 0",DIM2
.
          MOVE      "1",DIM1
          PACK      KEY35,OPDAUNIQ,DIM1,DIM2,Z70
          CALL      RSOPTSM1
GPR32200  CALL      RPOPTSM1
          BRANCH    OVRCD,GPR39999
.
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      GPR39999 IF NOT EQUAL
.
          MATCH     DIM1,OPTSTMNO
          GOTO      GPR39999 IF NOT EQUAL
.
          MATCH     DIM2,DOPTSSIN
          GOTO      GPR32200 IF NOT EQUAL
.
          MATCH     OPDADATE,OPTSSDAT
          GOTO      GPR32200 IF NOT EQUAL
.
          MOVE      OPTSSTIM,DIM4                * Match hour/min only
          MATCH     OPDAEXPS,DIM4
          GOTO      GPR32200 IF NOT EQUAL
.
          MATCH     SP70,OPTSSCDE
          GOTO      GPR39999 IF EQUAL
          GOTO      GPR39999 IF EOS
.
          GOTO      GPR36000
.
GPR33000  PACK      KEY10,PTMMOPID,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,GPR39999
.
GPR34000  MOVE      " 0",DIM2
          PACK      KEY35,PTMMOPID,PTMMTMNO,DIM2,Z70
          CALL      RSOPTSM1
GPR34200  CALL      RPOPTSM1
          BRANCH    OVRCD,GPR39999
.
          MATCH     PTMMOPID,OPTSUNID
          GOTO      GPR39999 IF NOT EQUAL
.
          MATCH     PTMMTMNO,OPTSTMNO
          GOTO      GPR39999 IF NOT EQUAL
.
          MATCH     DIM2,DOPTSSIN
          GOTO      GPR34200 IF NOT EQUAL
.
          MATCH     OPDADATE,OPTSSDAT
          GOTO      GPR34200 IF NOT EQUAL
.
          MOVE      OPTSSTIM,DIM4                * Match hour/min only
          MATCH     OPDAEXPS,DIM4
          GOTO      GPR34200 IF NOT EQUAL
.
          MATCH     SP70,OPTSSCDE
          GOTO      GPR39999 IF EQUAL
          GOTO      GPR39999 IF EOS
.
GPR36000  PACK      KEY10,OPTSSCDE,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          BRANCH    OVRCD,GPR39999
.
          MATCH     "1",KEY1
          IF         @EQUAL
            WRITE     HTMLFILE;PMHCHCPC;
            GOTO      GPR39999
          ENDIF
.
          MATCH     "2",KEY1
          IF         @EQUAL
            MOVE      SP70,DOCFNAME
            STRIP     PMHCTITL
            STRIP     PMHCGNAM
            STRIP     PMHCSNAM
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            RESET     PMHCTITL
            RESET     PMHCGNAM
            RESET     PMHCSNAM
            CALL      DOCNM000
.
            WRITE     HTMLFILE;DOCFNAME;
            GOTO      GPR39999
          ENDIF
.
GPR39999  RETURN
.
.-----------------------------------------------------------
. Write EDWARD cancer registration delete record
.------------------------------------------------------------
WEDC0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDC9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDC9999 IF EQUAL
.
          MOVE      ADMISSNO,PMAWVISN
          MOVE      "21 ",PMAWTYPE
          PACK      PMAWOLDV,PTCDPRMM,SP70,SP70,SP70,SP70 * Cancer code
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          CLOCK     TIME,PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDC9999  RETURN
.
.*******************************************************************************
.         Look for a Contract ID for the DRG Code
.*******************************************************************************
LCNT0000  PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LCNT9000
.
          MATCH     "A",TCINDC2
          GOTO      LCNT9000 IF NOT EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,LCNT9000
.
          MOVE      ADATE,CEFFDATE         * default to admission date
          IF        ASTAT=3
            MOVE      DDATE,KEY8           * Discharged date
          ELSE
            PACK      KEY8,CCC,CYY,CMM,CDD * Use Current date
            REP       " 0",KEY8
          ENDIF
          LOAD      CEFFDATE,CNTRCEFR,ADATE,KEY8
.
          OPEN      PMSPWAA1,"pmspwaaf"
          OPEN      PMSPWAA2,"pmspwaaf"
.
          PACK      KEY10,DDRGCODE,SP70
          CALL      RSPMPWA2
LCNT1000  CALL      RKPMPWA2
          BRANCH    OVRCD,LCNT9000
.
          MATCH     PMPWDRGC,DDRGCODE
          GOTO      LCNT9000 IF NOT EQUAL     * Different DRG Code
.
          MOVE      PMPWCNTR,KEY6
          CALL      VALCONTR                 * Validate Contract ID
          BRANCH    EXIT,LCNT1000
.
          MOVE      PMPWCNTR,CONTRCID        * Yes found a valid contract
.
          GOTO      LCNT9999
.
LCNT9000  MOVE      SP70,CONTRCID            * No valid contract
.
LCNT9999  RETURN
.
.-----------------------------------------------------------------
. Get post discharge Comments from input comment TextArea and
. write them to the temporary file for updating to the database
.-----------------------------------------------------------------
PDSCCM00  PREP      DISCOMAF,DISCOMNM
          GOTO      PDSCCM20
.
PDSCCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      PDSCCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      PDSCCM80 IF NOT EQUAL
.
PDSCCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      PDSCCM10 IF EOS
.
          ADD       ONE,PDISCLIN
          WRITE     DISCOMAF,SEQ;QRYDATA
          COMPARE   "99",PDISCLIN
          GOTO      PDSCCM99 IF EQUAL
.
          GOTO      PDSCCM10
.
PDSCCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
PDSCCM99  RETURN
.
.-------------------------------------------------------------------------------
.  Set Parameters Medical Record Post Discharge
.-------------------------------------------------------------------------------
MSCOM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,MSCOM001,MSCOM002,MSCOM003,MSCOM004,MSCOM005,MSCOM006:
                       MSCOM007,MSCOM008
.
          GOTO      MSCOM999
.
MSCOM001  PACK      MSCOM001,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM002  PACK      MSCOM002,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM003  PACK      MSCOM003,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM004  PACK      MSCOM004,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM005  PACK      MSCOM005,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM006  PACK      MSCOM006,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM007  PACK      MSCOM007,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM008  PACK      MSCOM008,QRYDATA,SP70
          GOTO      MSCOM999
.
MSCOM999  RETURN
.
.-------------------------------------------------------------------------------
.  Set Parameters Medical Record Post Discharge
.-------------------------------------------------------------------------------
PDSCOM00  IF        PDCOMFLG <> 1
            GOTO      PDSCOM99
          ENDIF 
.
          PACK      KEY21,ADMISSNO,MSCOM007,MSCOM008,SP70
          CALL      RDMRPSH1
          BRANCH    OVRCD,PDSCOM50  
.
          CALL      MOVMIS00
          CALL      UPMRPSH1
          GOTO      PDSCOM99
.
PDSCOM50  CALL      CLMRTPSH
          MOVE      ADMISSNO,DMRPSADM 
          MOVE      ADMISSNO,MRPSADMN       
          MATCH     SP70,MSCOM007
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMRPDS1
            IF        OVRCD=0
              MOVE      MRPDDATE,MRPSDATE
              MOVE      MRPDTIME,MRPSTIME
            ELSE 
              CALL      IBACLOCK
              CLOCK     TIME,CTIMEIS
              PACK      MRPSDATE,CCC,CYY,CMM,CDD
              REP       " 0",MRPSDATE
              MOVE      CTIMEIS,MRPSTIME
            ENDIF
          ELSE
            MOVE      MSCOM007,MRPSDATE
            MOVE      MSCOM008,MRPSTIME
          ENDIF
.
          CALL      MOVMIS00
          CALL      WRMRPSH1         * Write Record
. 
PDSCOM99  RETURN
.
.-------------------------------------------------------------------------------
. Move post discharge missing details 1-5
.-------------------------------------------------------------------------------
MOVMIS00  MOVE      ZERO,OVRCD		  
          TRAP      OVERCOND IF IO	      
          OPEN      DISCOMAF,DISCOMNM		
          TRAPCLR   IO		  
          BRANCH    OVRCD,MOVMIS99	      
.
          MOVE      ZERO,F1
          WHILE     F1 < 5 
            ADD       ONE,F1
            MOVE      SP70,DISCOMAR[F1]
          DO
          MOVE      ZERO,F1
.	    
MOVMIS20  READ      DISCOMAF,SEQ;DISCCOMM
          GOTO      MOVMIS50 IF OVER		
.	  
          PACK      BLANK80,SP70,SP70   
          MATCH     BLANK80,DISCCOMM
          GOTO      MOVMIS20 IF EQUAL
.
          ADD       ONE,F1
          MOVE      DISCCOMM,DISCOMAR[F1]
.
          IF        F1 = 5
            GOTO      MOVMIS50
          ENDIF
.
          GOTO      MOVMIS20
.      
MOVMIS50  MOVE      DISCOMAR[1],MRPSFTM1
          MOVE      DISCOMAR[2],MRPSFTM2
          MOVE      DISCOMAR[3],MRPSFTM3
          MOVE      DISCOMAR[4],MRPSFTM4
          MOVE      DISCOMAR[5],MRPSFTM5
.
MOVMIS98  CLOSE     DISCOMAF,DELETE
          MOVE      ZERO,EXIT
.
MOVMIS99  RETURN
.
.-------------------------------------------------------------------------------
. Save PDT Status
.-------------------------------------------------------------------------------
SAVSTS00  MATCH     "1",MRSTSFLG
          GOTO      SAVSTS99 IF NOT EQUAL     
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMRPDS1
          BRANCH    OVRCD,SAVSTS99
.
          MOVE      PTECD008,MRPDSTAT 
          CALL      UPMRPDS1
.
SAVSTS99  RETURN
+
.------------------------------------------------------------------------------
.         AMHCC (Australian Mental Health Care Classification)
.------------------------------------------------------------------------------
MHCC0000  CALL      CLVISXDC
          CALL      MVVISXDC
.
          MOVE      "004",VSXDTYDA           * 004 = AMHCC End code
          PACK      KEY11,ADMISSNO,VSXDTYDA,SP70
          CALL      RDVSXDC1
          IF        OVRCD=0
            PACK      VSXDVAL1,VSXDC003,SP70   * AHMCC End code
            MOVE      VSXDC043,VSXDDAT1        * Coded date
            PACK      VSXDTXT1,VSXDC023,SP70   * Coding Method
            MOVE      VSXDC063,VSXDDELT        * Delete record
            MATCH     "1",VSXDDELT
            IF        @EQUAL
              MOVE      USERID,VSXDUCID        * record data completed
              PACK      VSXDUCDT,CCC,CYY,CMM,CDD
              REP       " 0",VSXDUCDT
              MOVE      CTIMEIS,VSXDUCTM
            ELSE
              UNPACK    SP70,VSXDUCID,VSXDUCDT,VSXDUCTM
            ENDIF
.
            MOVE      USERID,VSXDUUSR          * updated record
            PACK      VSXDUDAT,CCC,CYY,CMM,CDD
            REP       " 0",VSXDUDAT
            MOVE      CTIMEIS,VSXDUTIM
            CALL      UPVSXDC1
          ELSE
            MOVE      ADMISSNO,VSXDVISN        * Admission number
            MOVE      "004",VSXDTYDA           * 004 = AMHCC End code
            MOVE      VSXDC003,VSXDVAL1        * AHMCC End code
            MOVE      VSXDC043,VSXDDAT1        * Coded date
            PACK      VSXDTXT1,VSXDC023,SP70   * Coding Method
            MOVE      VSXDC063,VSXDDELT        * Delete record
            MATCH     "1",VSXDDELT
            IF        @EQUAL
              MOVE      USERID,VSXDUCID        * record data completed
              PACK      VSXDUCDT,CCC,CYY,CMM,CDD
              REP       " 0",VSXDUCDT
              MOVE      CTIMEIS,VSXDUCTM
            ENDIF
.
            PACK      VSXDCDAT,CCC,CYY,CMM,CDD * created record
            REP       " 0",VSXDCDAT
            MOVE      CTIMEIS,VSXDCTIM
            MOVE      USERID,VSXDCUSR
            CALL      WRVSXDC1
          ENDIF
.
MHCC9999  RETURN
+
.----------------------------------------------------------------------------
. Read the relevant records and broadcast an HL7 update visit message (A08)
.----------------------------------------------------------------------------
BVISUP00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                      * get discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * get last tran record
          BRANCH    OVRCD,BVISUP99               * eof - finish
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      BVISUP99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast change admission details
.
BVISUP99  RETURN
+
.----------------------------------------------------------------------------
. Calculate length of stay based on VAED rules
.----------------------------------------------------------------------------
.
DTHPDY00  MATCH     ADATE,DDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"1";      * Same Day Admission
          ELSE
            MOVE      ZERO,EPSNOLOS
            DAYSEP    ADATE,DDATE,EPSNOLOS   * No of Admitted Days
            PACK      KEY30,ADMISSNO,SP70    * Read Leave Details
            CALL      RDSTRAN2
DTHPDY10    CALL      RDKTRAN2
            BRANCH    OVRCD,DTHPDY90         * No Leave
.
            MATCH     DTADMN,ADMISSNO        * No more visit records
            GOTO      DTHPDY90 IF NOT EQUAL
.
            MATCH     "D",TMOVE              * Discharge Movement
            GOTO      DTHPDY90 IF EQUAL
.
            MATCH     "L",TMOVE              * Start Day Leave
            IF        @EQUAL
              PACK      LVSTDTE,TDATE,SP70
            ENDIF
.
            MATCH     "R",TMOVE              * Return from leave day
            IF        @EQUAL
              MATCH     LVSTDTE,TDATE
              IF        !@EQUAL
                MOVE      ZERO,LEAVDAY
                DAYSEP    LVSTDTE,TDATE,LEAVDAY
                MATCH     LVSTDTE,ADATE
                IF        @EQUAL
                  SUB       ONE,LEAVDAY
                ENDIF
                SUB         LEAVDAY,EPSNOLOS
              ENDIF
            ENDIF
.           
            GOTO      DTHPDY10
DTHPDY90    WRITE     HTMLFILE;EPSNOLOS;
          ENDIF
DTHPDY99  RETURN       
.
+
.-------------------------------------------------------------------------------
.                        ****** GNDRG000 ******
.     Get Health Fund DRG and Version of ICD Coding - Medical RecorD
.-------------------------------------------------------------------------------
GNDRG000  MOVE      SP10,KEY3
          CALL      GTDRG000        * Get Grouper Version - returns it in KEY3
          MOVE      KEY3,DRGVERZ    * safer than KEY3
.
          UNPACK    SP30,PTHFGRPV,DRGVERHF,DRGCODHF
          MATCH     "1",PTCNDGED
          IF        @EQUAL
.
.           Determine DRG Version using NEW 'Effective DRG' table

            MATCH     SP6,AFUNDH
            IF        !@EQUAL
              CALL      GHFDRG00              * Get Health Fund DRG version
              IF        EXIT=0
                PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
                CALL      RDPTPGR1
                IF        OVRCD=0
                  MOVE      PTPGNDRG,DRGCODHF
                  MOVE      KEY3,DRGVERHF
                ENDIF
              ELSE
                PACK    KEY8,ADMISSNO,SP70
                CALL    RDDSCH1
                IF      OVRCD=0
                  MOVE    PTDSDDRG,DRGCODHF
                  MOVE    PTDSVOGU,DRGVERHF
                ENDIF
              ENDIF
            ELSE
              CALL      GCLDRG00            * Get Claim Code DRG version
              IF        EXIT=1
                CALL      GSTDRG00          * Get State/System DRG version
.               IF        EXIT=1
.                 MOVE      PTCNDGPV,KEY3   * Use System Default DRG instead
.               ENDIF
              ENDIF
.
              PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
              CALL      RDPTPGR1
              IF        OVRCD=0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      KEY3,DRGVERHF
              ENDIF
            ENDIF
.
          ELSE
.           Determine DRG Version (via Health Fund/Claim Code/System Default)
.
            MATCH     SP6,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
              CALL      RDFUND1       * Read a health fund file record
              PACK      KEY13,ADMISSNO,EPSCD001,PTHFGRPV,SP70
              CALL      RDPTPGR1             * Read Grouper Details
              IF        OVRCD = 0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      PTHFGRPV,DRGVERHF
              ELSE
                PACK    KEY8,ADMISSNO,SP70
                CALL    RDDSCH1
                IF      OVRCD = 0
                  MOVE    PTDSDDRG,DRGCODHF
                  MOVE    PTDSVOGU,DRGVERHF
                ENDIF
              ENDIF
            ELSE
              PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      PTCNDGPV,KEY3
              ELSE
                MATCH     SP3,PTCDGRPV
                IF        @EQUAL
                  MOVE      PTCNDGPV,KEY3
                ELSE
                  MOVE      PTCDGRPV,KEY3
                ENDIF
              ENDIF
.
              PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
              CALL      RDPTPGR1
              IF        OVRCD=0
                MOVE      PTPGNDRG,DRGCODHF
                MOVE      KEY3,DRGVERHF
              ENDIF
            ENDIF
          ENDIF
          GOTO     GNDRG999
.
GNDRG999  RETURN
+
.-------------------------------------------------------------------------------
.                        ****** GHDRG00 ******
.     Get National DRG and Version of ICD Coding - Medical RecorD
.-------------------------------------------------------------------------------
GHDRG000  UNPACK    SP30,PTHFGRPV,DRGVERHS,DRGCODHS
          MATCH     "1",PTCNDGED
          IF        @EQUAL
.
.           Determine DRG Version using NEW 'Effective DRG' table
.
            CALL      GSTDRG00              * Get State/System DRG version
.           IF        EXIT=1
.             MOVE     PTCNDGPV,KEY3        * Use System Default DRG instead
.           ENDIF
.
            PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
            CALL      RDPTPGR1
            IF        OVRCD=0
              MOVE      KEY3,DRGVERHS
              MOVE      PTPGNDRG,DRGCODHS
            ELSE
              PACK    KEY8,ADMISSNO,SP70
              CALL    RDDSCH1
              IF        OVRCD=0
                MOVE    PTDSVOGU,DRGVERHS
                MOVE    PTDSDDRG,DRGCODHS
              ENDIF
            ENDIF
.
          ELSE
.
.           Determine DRG Version (via Health Fund/Claim Code/System Default)
.
            PACK      KEY13,ADMISSNO,EPSCD001,PTCNDGPV,SP70
            CALL      RDPTPGR1               * Read Grouper Details
            IF        OVRCD = 0
              MOVE      PTCNDGPV,DRGVERHS
              MOVE      PTPGNDRG,DRGCODHS
            ELSE
              PACK    KEY8,ADMISSNO,SP70
              CALL    RDDSCH1
              IF      OVRCD = 0
                MOVE    PTDSVOGU,DRGVERHS
                MOVE    PTDSDDRG,DRGCODHS
              ENDIF
            ENDIF
.
          ENDIF
.
          GOTO     GHDRG999
.
GHDRG999  RETURN
.
.-------------------------------------------------------------------------------
. Set unclustered diagnosis cluster id values in patecdaf.pteddcid
.-------------------------------------------------------------------------------
UNDCID00  MATCH     "1",MRCNDCID             * Using Diagnosis Cluster Id
          GOTO      UNDCID99 IF NOT EQUAL
.
          MATCH     PTCNGDX3,DDATE           * disc.date > ICD10 ED 13 Go live?
          GOTO      UNDCID99 IF LESS
.
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECD1                 * read patecdaf Diagnosis file
UNDCID10  CALL      RKPTECD1
          BRANCH    OVRCD,UNDCID99
.
          MATCH     ADMISSNO,DPTEDADM        * Correct admission
          GOTO      UNDCID99 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTEDEPNO        * Correct episode
          GOTO      UNDCID99 IF NOT EQUAL
.
          MATCH     SP70,PTEDDCID            * Skip if DCID populated
          GOTO      UNDCID10 IF NOT EQUAL
.
          MOVE      "8 ",PTEDDCID            * Not clustered
.
          CALL      UPPTECD1                 * Update
.
          GOTO      UNDCID10
.
UNDCID99  RETURN
+
.*****************************************************************************
.* DFDCID00
.* Set a default cluser id value if blank                      
.  Required SVVKEY13 - patecdaf index 1 ley
.  Returns NEWWDCID - new allocated DCID value:wq
.*****************************************************************************
          DEFPROC   DFDCID00
.
          INC       PATECDFD/INC
.
          OPEN      PATECDA1,"patecdaf"
.
          MOVE      SP70,NEWWDCID              * Clear new cluster id
.
          PACK      KEY13,SVVKEY13,SP70
          CALL      RDPTECD1
          BRANCH    OVRCD,DFDCID99
.
          MATCH     SP70,PTEDDCID              * Exit if not blank
          GOTO      DFDCID99 IF NOT EQUAL
.
          MATCH     ANSU,PTEDCODE              * U prefix
          IF        @EQUAL
            UNPACK    PTEDCODE,D1,D2
            MOVE      ZERO,F2
            SQUEEZE   D2
            MOVE      D2,F2                   * U78 to U88 range
            IF        F2 >= 78 & F2 <=88
              MOVE      "0 ",PTEDDCID         * Assign chronic
              MOVE      PTEDDCID,NEWWDCID     * Return new cluster id
              CALL      UPPTECD1
              GOTO      DFDCID99
            ENDIF
          ENDIF
.
          MOVE      "8 ",PTEDDCID             * Assign unclusterd
          MOVE      PTEDDCID,NEWWDCID     * Return new cluster id
          CALL      UPPTECD1
.
          GOTO      DFDCID99
.
          INC       PATECDIO/INC
          INC       IBAOVRIO/INC
.
DFDCID99  CLOSE     PATECDA1
.
          ENDPROC

+
.------------------------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       CLPATICU
          INC       WEBDATCD
          INC       DGCLICAC
          INC       GTIHINUM
          INC       OPRECOVT
          INC       PMIGTNID
          INC       PATDEFCL                * routine DCLM0000
.
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       APSMASIO/INC
          INC       PATVADIO/INC
          INC       PATDADIO/INC
          INC       PATODCIO/INC
          INC       PATALRIO/INC
          INC       PATCANIO/INC
          INC       PATCRGIO/INC
          INC       PATCRDIO/INC
          INC       PATCRDTM
          INC       PMSCDGIO/INC
          INC       PATCMCIO/INC
          INC       PATECMIO/INC   
          INC       PATDO1IO/INC   * Doctor File
          INC       PATDGWIO/INC
          INC       PATDSCIO/INC
          INC       PATITMIO/INC
          INC       PATTRNIO/INC
          INC       PATMA1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSIHIIO/INC   * IHI Details
          INC       PMSPX2IO/INC
          INC       PATMMBIO/INC
          INC       PATMI1IO/INC
          INC       PATPEIIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PMSVMTIO/INC
          INC       PATWR1IO/INC
          INC       OPRCLIIO/INC
          INC       OPRDEAIO/INC
          INC       OPRARDIO/INC
          INC       OPRSRGIO/INC
          INC       OPRSESIO/INC
          INC       OPRTSMIO/INC
          INC       OUTSITIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCFAIO/INC
          INC       PMSCIDIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATIN1IO/INC
          INC       PATPR1IO/INC
          INC       PATPGRIO/INC
          INC       PATCHCIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PMSWTRIO/INC
          INC       PATNIDIO/INC
          INC       MRTCAHIO/INC
          INC       MRTCADIO/INC
          INC       MRTAUCIO/INC
          INC       MRTCIEIO/INC
          INC       MRTMASIO/INC
          INC       MRTHISIO/INC
          INC       MRTMOVIO/INC
          INC       MRTLOCIO/INC
          INC       MRTPDSIO/INC
          INC       MRTPSHIO/INC
          INC       MRTRQDIO/INC
          INC       MRTRESIO/INC
          INC       MRTVISIO/INC
          INC       MRTTHDIO/INC
          INC       MRTTDTIO/INC
          INC       PATRE1IO/INC
          INC       IBATMDIO/INC
          INC       VALDIOPS
          INC       VISCODTM
.
.  For Grouper
.
          INC       WEBGROUP                * Grouper logic (was PAT41GRP)
          INC       PATWIS11                * WIES11                   *I-902B1
          INC       PATWIS12                * WIES12                   *I-51504
          INC       PATWIS13                * WIES13
          INC       PATWIS14                * WIES14
          INC       PATWIS15                * WIES15
          INC       PATWIS16                * WIES16
          INC       PATWIS17                * WIES17
          INC       PATWIS18                * WIES18
          INC       PATWIS19                * WIES19
          INC       PATWIS20                * WIES20
          INC       PATWIS21                * WIES21
          INC       WIESCALC                * WIES
          INC       NHOSPDAY
          INC       RTIODAYS
          INC       RHIHDAYS                * Calc. Hosp In Home Days  *I-902B1
          INC       PATGNFEE
          INC       PATM10T9                * Map ICD10 to ICD9 codes
          INC       PATGILOS
          INC       GETCHSCR
          INC       PATIPERH
          INC       VISXDCTM
          INC       PATASFIO/INC
          INC       PATCDEIO/INC
          INC       PATHLFIO/INC
          INC       PATHSPIO/INC
          INC       PATBFEIO/INC
          INC       PATW11IO/INC            * WIES11 IO                *I-902B1
          INC       PATW12IO/INC            * WIES12 IO                *I-51504
          INC       PTW12BIO/INC            * WIES12B IO
          INC       PATW13IO/INC            * WIES13 IO
          INC       PATW14IO/INC            * WIES14 IO
          INC       PATW15IO/INC            * WIES15 IO
          INC       PATW16IO/INC            * WIES16 IO
          INC       PATW17IO/INC            * WIES17 IO
          INC       PATW18IO/INC            * WIES18 IO
          INC       PATW19IO/INC            * WIES19 IO
          INC       PATW20IO/INC            * WIES20 IO
          INC       PATW21IO/INC            * WIES21 IO
          INC       PATWIEIO/INC            * WIES   IO
          INC       PATRDCIO/INC
          INC       PATCMPIO/INC   * Complex mapping file
          INC       PATCMXIO/INC
          INC       PATIPEIO/INC
          INC       PATVENIO/INC
          INC       PMSADWIO/INC
          INC       MEHDLSIO/INC
          INC       MEHHONIO/INC
          INC       VISXDCIO/INC
          INC       MLTSECIO/INC
          INC       VISCMTIO/INC
          INC       VISCODIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       PMSABFIO/INC
          INC       PATINVIO/INC
          INC       PATONHIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSPWAIO/INC
.
          INC       CLVISXDC
          INC       CLMRTHIS
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPATDSC
          INC       CLPATCHC
          INC       CLOPRDEA
          INC       CLOPRSES
          INC       CLOPRTSM
          INC       CLMRTPDS
          INC       CLMRTPSH 
          INC       PATMASTM
          INC       CLPATMIS
          INC       CLPATRE1
          INC       CLPMSPX2
          INC       DGCLICRM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATDSCTM
          INC       GETDRG 
          INC       CALCAGE
          INC       MRTCAHTM
          INC       MRTCADTM
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       GETALTID
          INC       VALCMXFN
          INC       VALCONTR
          INC       GETCNEFF
          INC       PATCRSFP
          INC       GETEFDRG           * Get Effective DRG Version
          INC       TFILENAM 
          INC       PATADTYP

