. --------------------------------------------------------------------------
. Program       : OPRWEB01
.
. Function      : Theatre Information Server
.
. Modifications  :
. ---------------------------------------------------------------------------
. V12.00.06 05/11/2025  Thanh T        TSK 0937505
.           Fixed issue with extend procedure description not update when
.           comments field is not entered
. V12.00.05 13/10/2025  Ebon Clements  TSK 0962780
.           Added using clinic or surgeon parameter OPCNCLSU test to get
.           surgeon name - GSURNS00
. V12.00.04 23/09/2025  Thanh T        TSK 0937505
.           Added GTEXDS00 and AUEXDS00 for extended procedure description
. V12.00.03 18/08/2025  Alina Bhari    TSK 0965023
.           Recompiled for changes to OPRSESIO      
.           converted form(OPSESUSP) to DIM (DOPSESUS) for read and write
. V12.00.02 31/07/2025  Ebon Clements  TSK 0964747
.           Recompiled for OPWEBCAN - ESIS ASA Score
. V12.00.01 19/05/2025  Ebon Clements    TSK 0960463
.           Recompiled for UPEADMVS - eAdmission document update by
. V11.05.10 02/05/2025  PJ Le Febour    TSK 0952536a
.           VALITM30 - replace TDESC with PTCDLDES(long description)
. V11.05.09 16/04/2025  PJ Le Febour    TSK 0958055 
.           recomplied for BOKRECTM                   
. V11.05.08 10/04/2025  Thanh T         TSK 0943212 
.           Changed COMCAS00 to get Anaesthetic Type
. V11.05.07 31/03/2025  PJ Le Febour    TSK 0952536
.           VALITM30 - added extract of PTITTCER
. V11.05.06 24/03/2025  Davin           TSK 0956210
.           Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)
. V11.05.05 18.03.2025  DA Sarkies     Task 0955909
.           Recompiled for OPWEBCAN
. V11.05.04 06/03/2025  Thanh T         TSK 0943212
.           Added UPRQC000 to update theatre request comments
. V11.05.03 10/02/2025  Thanh T         TSK 0943212
.           Added Theatre Request Enhancement
. V11.05.02 20.12.2024  DA Sarkies      TSK 0954547
.           Recompiled for OPRABITM
. V11.05.01 14/11/2024  PJ Le Febour   Task 0953102
.           added id=blbox id=blurn id=bladm id=blcas id=blunq id=bltem
. V11.04.12 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.11 09/07/2024 Ebon Clements   TSK 0948746
.           Added anaesthetic type heading to emergency theatre list
.           heading - CSTBHD00
. V11.04.10 03/07/2024 Nikitha B       TSK 0948746
.           Added LOS header for session type EMRSTYPE='E' in CSTBHD00 and 
.           blank space for LOS in APTHRQ00.
. V11.04.09 27.06.2024 DA Sarkies      TSK 0948535
.           Recompiled for PATMSXTM
. V11.04.08 12/06/2024 Nikitha B       TSK 0947196
.           Added LOS column header - CLST3200 tag to display LOS for STV.
. V11.04.07 10/05/2024 Jacob Jackson   TSK 0946065
.           Fix server output for MISC0400
. V11.04.06 09/05/2024 Thanh T         TSK 0935728
.           Added hospid when calling RDOPDPH1, RDOPTRA1
. V11.04.05 04/03/2024 PJ Le Febour    TSK 0929044dc
.           REWOEC00 - populate WBOCCUID with USERID
.           SEWOEC00 - populate WBOCCUID with USERID
.           SEBOEC00 - populate WBOCCUID with USERID
.           FOEW0000 - populate WBOCUDTE WBOCUTIM WBOCUUID before WRWBOEC1
.           REWOEC00 - populate WBOCUDTE WBOCUTIM WBOCUUID before WRWBOEC1
.                      populate WBOCUDTE WBOCUTIM WBOCUUID before UPWBOEC1
.           HOEW0000 - populate WBOCUDTE WBOCUTIM WBOCUUID before UPWBOEC1
. V11.04.04 06/01/2024 PJ Le Febour    TSK 0913112a
.           only display description for Anaesthetic Type (CAT OA)OPDAANAE 
. V11.04.03 05/01/2024 PJ Le Febour    TSK 0913112
.           added Anaesthetic Type (CAT OA)OPDAANAE - Theatre SessionCaseList
. V11.04.02 11/12/2023 Thanh T         TSK 0935728
.           Recompiled for OPRQUEFD changes
. V11.04.01 30/11/2023  Ebon Clements  TSK 0925492
.           Recompile for BEDBDPRO - Multiple theatre bookings per admission
. V11.03.18 16/11/2023  J.Tan          TSK 0938426
.           Mod Auto Operating team preference (AAUPRF00) to check fo OPCNCLSU
. V11.03.17 15/08/2023  Alina Bhari    TSK 0933594
.           Fixed the issue on add & update to category P value of new booking
.           in theatre. Commented out FIRSTBOK in field BKRECLSS in MVBOK000  
. V11.03.16 10/08/2023  Nikitha B      TSK 0935669
.           Recompiled for OPWEBCAN
. V11.03.15 03/08/2023  Ebon Clements  TSK 0935730
.           Pack KEY22 before call to OPMVSBOK - UPDTIM90, REOCS500
. V11.03.14 01/08/2023  Peter Vela     TSK 0927262
.           Recompiled for FHRDATCD
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
. V11.03.13 28/07/2023  Ebon Clements      TSK 0935527
.           Recompiled for OPRQUEFD - Theatre booking hospital
. V11.03.12 28/06/2023  Ebon Clements      TSK 0934306
.           Fixed KEY26 pack for doctors selection list - DOCSEL30
. V11.03.11 07/06/2023  Nikitha B          TSK 0928527
.           Display Planned Length of stay - CASTAB00
.           Added LOS column header - CSTBHD00,CLST3100 tag to display LOS. 
. V11.03.10 01/06/2023  Peter Vela         TSK 0927262
.           ClinicalAide FHIR api
.           Added bundle functionality for Appointment resource in TDET5500
.           Added Subject include FHRSUBIN functionality
.           Added Participant include FHRPARIN functionality
.           Added Location include FHRLOCIN functionality
. V11.03.09 31/05/2023  Ebon Clements      TSK 0933254
.           Added session hospital to case keys unpack - REBOOK00, CHGDU000
.           30/05/2023  Peter Vela         TSK 0927262
.           Increased FHRAPPID to DIM 26
. V11.03.08 30/05/2023  Ebon Clements      TSK 0933061
.           Fixed KEY22 CASEKEYS populating for case move - CASMOV00
. V11.03.07 17/05/2023  Ebon Clements      TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.06 19.04.2023  Ebon Clements      TSK 0909393
.           Fixed theatre selection list multi hospital GOTO test - OSEL0000
. V11.03.05 13.04.2023  DA Sarkies         TSK 0909393
.           Added Hospital Values to the Session Search Frame
. V11.03.04 09/02/2023  Ebon Clements      TSK 0909393 0908349               
.           Added SAVOHOSP
.           Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
.           Added SUPRLEVL tag
. V11.03.03 23/01/2023  Thanh T.           TSK 0919770                       
.           Changed WRTPRF00, WRTPRA00 to cater for adding Hospital field
.           changes
. V11.03.02 21.11.2022 DA Sarkies    TSK 0896400
.           Directed the doctor list generation in UNTSEL00 to DOCSSL00
. V11.03.01 15/11/2022 J.Tan  Task 0926814
.           Recompiled for OPTHCMPL - checking for Abandoned case
. V11.02.21 31/10/2022  J.Tan          Task 0923205
.           Added check to DOCSSL00 to check if a Dr is active
. V11.02.20 31/10/2022  J.Tan          Task 0923205
.           Mod UPDNZP00 - removed checking for Pre-admission
. V11.02.19 03/10/2022  Ebon Clements  Task 0908349
.           Added SHOWVIEW cgi. Added Tourniquet tags
. V11.02.18 13/09/2022  Jill Parkinson Task 0924197
.           Added move zero,ovrcd before setting AAEFLAG 
. V11.02.17 26/08/2022  Ebon Clements  TSK 0904278
.           Added provisional Items 4/5/6 tags for report 11 OCAS0000 
. V11.02.16 25/08/2022  Jill Parkinson Task 0923872
.           Added WCHC0000 to write an 09 to watchaaf when merging bookings
. V11.02.15 24/08/2022  Ebon Clements  TSK 0904278
.           Added provisional Items 4/5/6 opdea049 to opdea051 to SETDEA00
.           Added SAVPRV4, SAVPRV5 and SAVPRV6
. V11.02.14 22/08/2022  Jacob Jackson  TSK 0923405
.           Recompiled for OPWEBCAN I*D suppression changes
. V11.02.13 03.08.2022  Peter Vela         0884414
.           Fixed Health Fund, Health Table and Health Fund Membership Number
.           assignment in STEB0000
.           Fixed PTCNOECW validation in GNXOEW00, GNXOEB00
.           Added functionality to update PMI in ADDBOK00 and POSEDT00 for 
.           Theatre Booking OECW
. V11.02.12 28.07.2022  Bella Turco    TSK 0922748
.           Fixed I*C error caused by WEBOECAF reads (RSWBOEC1) 
. V11.02.11 27.07.2022  Ebon Clements  TSK 0921887
.           Added duplicate case number error to merge booking - BOKMER20
. V11.02.10 21.07.2022  DA Sarkies         0904278
.           Added codes to write/read for provisional Items 4/5/6            
. V11.02.09 05/07/2022  Peter Vela         0884414
.           Added Free Format OECW functionality to Theatre Booking only OECW
. V11.02.08 29.06.2022  DA Sarkies     TSK 0919888
.           Moved the form into the <td>'s
. V11.02.07 06/06/2022  Davin S        TSK 0908745
.           Recompiled for DGCLIS12 - added additional read on pmsqpt
. V11.02.06 27.05.2022  Jacob Jackson  TSK 0918521
.           Ensure only creation date/time/user fields is written to when a
.           booking is created, and not the update fields
. V11.02.05 10.05.2022  Jacob Jackson  TSK 0918521
.           Fix issue where creation date/time/user would be overwritten when a
.           booking was updated 
.           12.05.2022  DA Sarkies     TSK 0904278
.           Added cgi variables for extra icd codes                             
.           13/05/2022  J.Tan           TSK 0904080
.           Mod VALITM10 to check invalid MBS item for blank item description
. V11.02.04 12.04.2022  DA Sarkies     TSK 0900695
.           Added check to ADDMED00 and EDTBOK00 to see if booking cancelled for
.           update and display error if it is.
. V11.02.03 31/03/2022  Davin          TSK 0917793
.           Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)
. V11.02.02 24.02.2022  DA Sarkies       TSK 0889899
.           Recompiled for WATTRETM and WATDETTM
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.01.16 17/01/2022  Sunny          TSK 0906290 
.           Added SLST2200 - (Cat. YD) Surgery Type filter
. V11.01.15 13/09/2021  Ebon Clements  TSK 0910279 
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op Ward 
. V11.01.14 27/08/2021  Ebon Clements  TSK 0910383
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op / Expected Ward
. V11.01.13 25/08/2021  Ebon Clements  TSK 0898459                        
.           Recompiled for OPWEBCAN - Pre assessment date/time
. V11.01.12 12/07/2021  J.Tan          TSK 0888546                        
.           Mod to PROCFLAG for NZ multiple theatre booking
.           23/07/2021  Thanh T.       TSK 0895165
.           Recompiled for OPRARDTM changes
. V11.01.11 22/07/2021  Ebon Clements  TSK 0909330
.           Recompiled for BEDBDPRO - Post op ward
. V11.01.10 09/07/2021  Thanh T        TSK 0905755
.           Recompiled as BEDBDPRO changes
. V11.01.09 05.07.2021  DA Sarkies     TSK 0875496
.           Added test to see if visit entry exists in Mental Health DB.
. V11.01.08 16/06/2021  Peter Vela     TSK 0907653
.           Commented out functionality for clearing out PTELCMPL
.           in POSEDT80
. V11.01.07 15/06/2021  Peter Vela     TSK 0907653
.           Moved clear of PTELCMPL to inside OEC section in POSEDT80
. V11.01.06 08/06/2021  J.Tan          TSK 0888546                        
.           Added PROCFLAG for NZ multiple theatre booking
. V11.01.05 03/06/2021  Ebon Clements  TSK 0886820                        
.           Added dispwkno to NEXT0000 and PREV0000
. V11.01.04 27/04/2021  Thanh T        TSK 0895165                        
.           Recompiled for OPRARDFD changes                               
. V11.01.03 23/03/2021  Ebon Clements   TSK 0886820
.           Increased WEEKCYCL to a DIM 10
. V11.01.02 03/03/2021  Ebon Clements   TSK 0886820
.           Added display week cycle number menu cgi variable - dispwkno
.           Added theatre week cycle number display functionality - WKCN0000
. V11.01.01 17/02/2021  J.Tan           TSK 0888639
.           Changed Counter PATMMBFD/OPRPMBFD to DIM 3
. V11.00.13 09/12/2020  Thanh T        TSK 0872840
.           Recompiled as PMSPX2TM changes
. V11.00.12 26/11/2020  Peter Vela       TSK 0884414
.           Added validation for Presenting Illness/Extra MBS Codes
.           in ECLOEC00
. V11.00.11 28/09/2020  Peter Vela       TSK 0894526
.           Added delete OPRPRF records to POSEDT00
. V11.00.10 31/08/2020  Peter Vela       TSK 0895969
.           Added WebServices OECW
. V11.00.09 05/08/2020  Ebon Clements  Task 0890860
.           Fixed template 4 test to not display cancelled sessions - SESTAB00
.           31/07/2020  Peter Vela     Task 0884414
.           Added Multiple MBS OEC generation
.           Added update to PMVXPOEC in ECLOEC00
.           Added UPDATE to BKRXUDF5 in ADDBOK30
.           Changed branch to update pmsvx1 in UPEMSEC00 
. V11.00.08 18/05/2020  Peter Vela     Task 0871644
.           Added updates to oprprfaf in WRTPRF00
.           Added CHKGAS00
. V11.00.07 27/04/2020  Ebon Clements  TSK 0850105
.           Added procedure calls PMSCURTH - Theatre status in patient header
. V11.00.06 22/04/2020  Ebon Clements    TSK 0850105   
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.05 17/04/2020  J.Tan          TSK 0838262
.           Fixed VALITM - MBS effective dates
. V11.00.04 V10.15.11 02/04/2020  Peter Vela     Task 0871644
.           Fixed writes to preferences table oprprfaf
.           Added &nbsp after Requisitions indicator display in CASTAB00
.           and COMCAS00
. V11.00.03 19/03/2020  Peter Vela     TSK 0889143
.           Recompiled for WATLETFD
. V11.00.02 13/03/2020  Thanh T        TSK 0838262
.           Recompiled for OPRSESTM changes
.           16/03/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
. V11.00.01 26/02/2020  Ebon Clements  Task 0888833
.           Added VSCMTLIN to CLRPAR00 and set to ZERO
. V10.15.09 11/02/2020  Jill Parkinson Task 0885010
.           Recompiled for OPWEBCAN 16 as well as 05 to watchaaf for removals
. V10.15.08 07/02/2020 Peter Vela        Task 0871644
.           Added tags for Bulk Print Requisitions CLST0000
.           Added Tray validation to WRTPRA00
. V10.15.07 09/12/2019 Peter Vela        Task 0871644
.           Added Auto Add/Update to Operation Team Preferences
.           Recompiled for OPRREQTM
. V10.15.06 09/12/2019  Ebon Clements    TSK 0884801
.           Added sesskeys session read validation - CASLST00 WEBELM00
.           Added redirect to the new sesskeys after the start time has
.           changed - ADJTME00
. V10.15.05 28/11/2019  Peter Vela       TSK 0871644
.           Recompiled for OPRREQFD 
. V10.15.04 18/11/2019  Ebon Clements    TSK 0884514
.           Added semicolon to end of NOOFDAYS tag - CLST0500
. V10.15.03 18/10/2019  Ebon Clements    TSK 0880973
.           Reversed V10.14.19 changes
. V10.15.02 13/10/2019  Ebon Clements    TSK 0880973
.           Fixed booking to pre admission adiag update PTCNUBAP=4 - UPADM000
. V10.15.01 14/10/2019  Ebon Clements    TSK 0874701
.           Added update of bokrc1af at ADDBOK20 because the next call to
.           UPDMIS00 re reads bokrc1af and the new cgi values are lost
. V10.14.17 26/09/2019  Sunny            TSK 0846427 
.           1)Fixed TDCMC000 to make the button display red if more 
.             than 1 line exists.
.           2)Fixed TDCML999 to display Day Comments from the hospital user is 
.             logged in.
. V10.14.16 18/09/2019  Richa Phogat     TSK 0867693
.           Recompiled for WLHISSUB
. V10.14.15 18/09/2019  Peter Vela       TSK 0876713
.           Added move "06" to WTWMBSCD in SESMOV00
. V10.14.14 19/08/2019  Richa Phogat     TSK 0871656
.           Added condition under UPADM000 when PTCNUBAP=5
. V10.14.13 13/08/2019  Davin            TSK 0879635
.           Added read of PMI details prior to calling DGCLIUWL
. V10.14.12 16/07/2019  Tracey Nguyen   TSK 0846427
.           1)New CGI variables to display current date theatre
.             comments - DISPDAYC,DAYCMCNT
.           2)New tags MISC0310, MISC0320, MISC0330
. V10.14.11 02/07/2019  Don Nguyen       TSK 0875271
.           Modified UPFST000 (Amend Theatre Fasting Times) to also update
.           the admission time for a pre-admission.
. V10.14.10 14/06/2019  Thanh T.         TSK 0871735
.           Changed ADDBOK30 to call UPBKREC1 to update bokrc1af for
.           BKRESTAT=1 and BKRECANC=SPACE when BKRESTAT=2 (Cancelled)
. V10.14.09 27/05/2019  Peter Vela       TSK 0873395
.           Initialise SAVEBCAN before WRTHIS00 in ADDBOK00
. V10.14.08 24/05/2019  Peter Vela       TSK 0872587
.           Recompiled for OPMAKBOK
. V10.14.07 20/05/2019  Ebon Clements     TSK 0874508
.           Added read of Waiting list Outpatient Link PAC - PADM0000
. V10.14.06 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
. V10.14.05  28/03/2019  Peter Vela       TSK 0839663
.            Recompiled for OPRSESTM
.            20/03/2019  J.Tan            TSK 0857392
.            Changed RCP Transaction count from DIM3 to DIM5
.            27/03/2019  Jill Parkinson Task 0863524 
.            Changed to use new index for oprsemaf to check if session locked
. V10.14.04 07/03/2019  Peter Vela     TSK 0863050
.           Added CLPMSELF to FOEC0000
. V10.14.03 04/03/2019  Peter Vela     TSK 0839663
.           Added new tag for OPAVAVER in MISC0000
. V10.14.02 27/02/2019  Ken Bell       TSK 0869548
.           Recompiled for PATCLMTM
. V10.14.01 22/02/2019  Peter Vela     TSK 0870780
.           Added elegibilty number validation in FOEC0000
.           25/02/2019  Jill Parkinson Tsk 0870881
.           Recompiled for OPWEBCAN, write of watchaaf for wl removals
. V10.13.15 11/01/2019  J.Tan          TSK 0864310
.           Fixed UNTSEL00 validating doctor code
. V10.13.14 10/01/2019  Richa Phogat   TSK 0868852
.           Added Session type description for Cat TU (TUTYPDES) under SESDET20
.           and SESROW00
. V10.13.13 09/01/2019  Thanh T.       TSK 0863964
.           Added TDET3100
. V10.13.12 08/11/2018  Davin          TSK 0862119
.           Added HL7 I13 W/L trigger 14 for booking transfer (SESMOV00)
.           Added HL7 I13 W/L trigger 15 for booking update (UPDDEA00)
. V10.13.11 18/10/2018  Richa Phogat   TSK 0864240
.           Recompiled for OPWEBCAN
. V10.13.10 23/10/2018  Tracey Nguyen  TSK 0859743
.           Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
. V10.13.09 18/10/2018  Richa Phogat   TSK 0863284
.           Recompiled for OPWEBTRN - Updated PVIDOCT under  pre-admission
. V10.13.08 11/10/2018  Jill Parkinson Task 0863557
.           Added call to WCHB0000 when transferring a booking
. V10.13.07 11/10/2018  Ania P           TSK 0859769
.           Added TDET2900-3000
. V10.13.06 26/09/2018  Steve Armstrong  TSK 0863502
.           Added read of PMI details prior to calling DGCLIUWL in POSCAN00.
. V10.13.05 24/09/2018  Don Nguyen     TSK 0863852
.           Recompiled for OPWEBTRN - Added pre-admission check around
.           HL7 trigger DGCLICCP.
. V10.13.04 19/09/2018  J.Tan           TSK 0863727
.           Added Restrictive Override code
. V10.13.03 28/08/2018  Nicole Torrisi  TSK 0861086
.           Changed to check for Z70 before setting BKDIDES1-6
.           Fixed day comment exists test - DAYC0000
.           28/08/2018  Ebon Clements   TSK 0853101
.           Fixed day comment exists test - DAYC0000
.           21/08/2017  J.Tan        TSK 0859742
.           Added ECLIPSE new fields from pmsmtiaf
. V10.13.02 03/08/2018  Tracey Nguyen  TSK 0845646
.           Removed MISC0300 and MISC0301 as they are no longer required
. V10.13.01 02/08/2018  Ebon Clements    TSK 0853101
.           Added hospital to theatre comments key - oprcomaf
. V10.12.26 12/07/2018  Steve Armstrong  TSK 0854797
.           Added check on HL7 A08 Broadcast message (HL7TRGID = 2)
.           to not trigger if Theatre Booking is cancelled.
. V10.12.25 09/07/2018  Tracey Nguyen  TSK 0845646
.           1) Added MISC0290 to check for visits with Post Discharge coding
.           2) Added MISC0300 to check for visits with a Booking
.           3) Added call to MISC0000 in PROFLD89
. V10.12.24 06/07/2018  Don Nguyen     TSK 0857683
.           Added HL7 A08 trigger (DGCLICCP) in UPDMIS00 - Update Pre-Admission.
.           Recompiled for changes to OPWEBTRN - Added DGCLICCP call for a
.           theatre booking transfer (TBTRN000) to broadcast a "A08" HL7
.           message when updating a Pre-Admission record.
.           Added DGCLICCP - HL7 Broadcast Pre-Admission Change.
. V10.12.23 05/07/2018  Thanh T        TSK 0857684
.           Recompiled for PATMISTM changes
. V10.12.22 05/07/2018  Jill Parkinson Task 0859519
.           Added move of HWDSOUR,OPDAASRC
. V10.12.21 04/07/2018  Ebon Clements  TSK 0858571
.           Modified POSCAN00 (Post Cancel Case) to not send a HL7
.           Update WL Entry (DGCLIUWL) if not linked to a WL procedure. 
. V10.12.20 02/07/2018  Jill Parkinson TSK 0859389
.           Corrected setting of FIRSTBOK            
.           02/07/2018  Don Nguyen     TSK 0859256
.           Modified POSCAN00 (Post Cancel Case) to read corresponding
.           WL Patient Procedures record before DGCLIUWL (HL7 Update WL Entry).
.           02/07/2018  Ebon Clements  TSK 0845295
.           Set KEY19 - CASEKEYS prior to eReferral update - UPEREFVS
. V10.12.19 26/06/2018  Ebon Clements  TSK 0845295
.           Recompiled for OPWEBCAN - eRefrral update
. V10.12.18 19/06/2018  Ebon Clements  TSK 0845588
.           Recompiled for OPMAKBOK - Fasting dates
. V10.12.17 19/06/2018  Richa Phogat   TSK 0850937
.           Added RDWTTX11 under EDTBOK00
. V10.12.16 15/06/2018  Jill Parkinson TSK 0858451 (0858171)
.           Recompiled for OPTHETAT
. V10.12.15 05/06/2018  Richa Phogat   TSK 0850937
.           Added field 'PACAFLAG'
. V10.12.14 05/06/2018  Thanh T.       TSK 0857774
.           Fixed the problem with patient waiting list status not getting
.           changed to unscheduled when the booking cancelled and patient
.           is returned to waiting list.
.           Added 'MOVE OPDAADMN,SAVADMN' to POSCAN00 for CANREC00
. V10.12.13 14/05/2018  Peter Vela     TSK 0851006
.           Added functionality fro Theatre Usage
. V10.12.12 30/04/2018  Richa Phogat   TSK 0843171
.           Recompiled for OPRCASTM, BOKRX1TM, OPMAKBOK
.           Added field SAVPOWD, SAVTYPP & SAVTYCL. Added code to save
.           few fields data in OPRDEAFD, BOKRC1FD & BOKRX1FD depending upon 
.           certain conditions
.           01/05/2018  Jill Parkinson 
.           Added CHKFB000, field FIRSTBOK 
. V10.12.11 04/05/2018  Jill Parkinson TSK 0441670
.           Recompiled for OPWEBCAN - write to watchaaf when cancelling
. V10.12.10 23/04/2018  Ebon Clements  TSK 0845588
.           Added fasting date functionality
. V10.12.09 13/04/2018  J.Tan          TSK 0310703
.           Merge booking to admission to update invoice pending for Public Hosp
. V10.12.08 05/04/2018  Thanh T.       TSK 0854778
.           Recompiled for OPWEBTRN
. V10.12.07 20/03/2018  Peter Vela     TSK 0842991
.           Recompiled for OPRSESTM
. V10.12.06 02/03/2018  Ken Bell       TSK 0851092
.           Added Hospital Code for Recovery Closed table for Multi-Hospital
. V10.12.05 19/02/2018  Jill Parkinson TSK 0846170
.           Added write of booking to watchaaf
. V10.12.04 05/02/2018  Ken Bell       TSK 0850772
.           Applying Admission Source update to the Pre-Admission
. V10.12.03 31/01/2018  Ebon Clements  TSK 0845295
.           Added eReferral functionality
. V10.12.02 31/01/2018  Thanh Tieu     TSK 0851375
.           Recompiled as OPRCASTM changed
. V10.12.01 27/01/2018  J.Tan          Task 0844301
.           Added Extra MBS Codes
. V10.11.20 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
.           28/11/2017  Ania P         TSK 0847925
.           Recompiled for OPHISSUB
. V10.11.19 23/11/2017  Davin          TSK 0846231
.           Recompiled for OPRPMBFD - added oppmrefn
. V10.11.18 03/11/2017  J.Tan          TSK 0838821
.           Recompiled for OPWEBTRN- to update Surgeon/Consultant
. V10.11.17 11.10.2017  B.G.Ackland    TSK 0835482 
.           Change FHIR Include for Appointment
. V10.11016 25/10/2017  Ania P         TSK 0841602
.           Added fromwait/FROMWAIT
. V10.11.15 16/10/2017  Thanh T.       TSK 0846191                        
.           Recomplied for OPTHETAT                                         
. V10.11.14 13.10.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Expected Duration in munitesDuration Attribute of the Appointment
. V10.11.13 10/10/2017  Ania P         TSK 0841602
.           Added output for user defined category
. V10.11.12 02.10.2017  B.G.Ackland    TSK 0835482 
.           Change FHIR Status Output to standards code set
.           Change FHIR Output Remove serviceCategory output
. V10.11.11 25/09/2017  Peter Vela     TSK 0308822
.           Added ONCLNKIN validation in PBDM5000
. V10.11.10 25/09/2017  Richa Phogat   TSK 0845445
.           Updated OSEL0000 to display only the theatres in the dropdown list
.           which are logged in a Hospital
. V10.11.09 20/09/2017 J.Tan           TSK 0843725
.           Added OPERDES4,OPERDES5, OPERDES6
. V10.11.08 11/09/2017  Ania P         TSK 0837582
.           Added PTCNUBAP=4 to UPBKD00
. V10.11.07 24/08/2017  Davin          TSK 0837617
.           Added new I13 message trigger for Update Waiting List (DGCLIUWL)
.           25/08/2017 J.Tan           TSK 0843725
.           Added tags for OPDADES4,OPDADES5,OPDADES6
. V10.11.06 08/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.05 09/08/2017  Ebon Clements  TSK 0843373
.           Fixed I * A on OPRSESAF - SESMOV00 REBOOK00
. V10.11.04 08/08/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
. ---------------------------------------------------------------------------
. V10.10.14 29/06/2017  J.Tan          TSK 0837660
.           Fixed the heading for Complications screen
. V10.10.13 29/06/2017  Ebon Clements  TSK 0840839
.           Don't process transfer source if TRNSFSRC is Z70
. V10.10.12 27/06/2017  Nicole Torrisi TSK 0840839
.           Added check on Z70 when referencing TRNSFSRC
. V10.10.11 31/05/2017  J.Tan          TSK 0837660
.           Added Theatre Full Time Out,Complications,Antibiotics
. V10.10.10 31/05/2017  Ebon Clements  TSK 0815569
.           Read transfer source in get current admission  - CURI0000
. V10.10.09 15/05/2017  Ebon Clements  TSK 0815569
.           Added transfer source functionality - ADTD0000
. V10.10.08 01/05/2017  Don Nguyen     TSK 0832089
.           Modified DOCTSL00 to use temp file for sorted list.
.           Modified DOCSEL00 to call DOCSSL00 instead.
.           Added DOCSSL00 - Doctor Select List (sorted by name).
. V10.10.07 27/04/2017  Peter Vela     TSK 0813019
.           Corrected setting of status for Abandoned cases
. V10.10.06 27/04/2017  Don Nguyen     TSK 0836033
.           Added call to UPDMIS00 in ADDBOK00 to clear Pre-admission movement 
.           indicator.
. V10.10.05 26/04/2017 Ebon Clements   TSK 0833053
.           Removed lock of pmi master file - CONUPD00 & CASUPD00
. V10.10.04 24/04/2017 Ania P          TSK 0813019
.           Corrected setting of status for Abandoned cases
. V10.10.03 20/04/2017 Ebon Clements  TSK 0834035                   
.           Modified ADDBOK00 to also update PMVXPOWD/PMVXPOBD for current adm.
. V10.10.02 22/03/2017 Richa Phogat   TSK 0832066                   
.           Changed DVA Card Number to be collected from PMCDCNUM.PMSCCDFD 
.           instead of PREPAT.PMIMA1FD 
.           30/03/2017  Don Nguyen     TSK 0829654
.           Modified POSEDT00 to also update PMVXPOWD/PMVXPOBD for current adm.
.           Recompiled for BEDBDPRO (BEDBDVCD - Modified BBAD0000 to populate
.           PMBDEWRD & PMBDEBED with Post Op Ward/Bed).
.           29/03/2017 Tracey Nguyen   TSK 0833454
.           Recompiled for PATATRTD/PATATRTM
.           28/03.2017 Ania P         TSK 0813019
.           Output of Abandoned Case Status
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
. V10.09.07 14/02/2017  Peter Vela     TSK 0830794
.           Mods updateparent in GETLNK00  to pass on Session Finalisation date
. V10.09.06 16/01/2017 Davin           TSK 0814742
.           Recompiled for VISCODTM - mods to selection list output
. V10.09.05 12/01/2017  Jill Parkinson TSK 0830045
.           Added checking for Using Hospital Security before selecting current
.           admissions in CURI0000 to stop selecting visits in other hospitals
. V10.09.04 03/01/2017  Jill Parkinson TSK 08322329  
.           Added output of pmwxpord
. V10.09.03 28/12/2016  Jill Parkinson TSK 0828192   
.           Added clear of BKREINDC and PTMIDMOV so medical records appear on
.           pulling lists when patients have the admission/booking date changed
. V10.09.02 22/12/2016  Davin             TSK 0814504
.           Call update diet details (UNUT0000) @ ADDBOK00/ADDMED00/POSEDT00
. V10.09.01 02/12/2016  Jill Parkinson TSK 0822329   
.           Added ACC Purchase order - written to pmswx1af
. V10.08.18 25/10/2016  Davin             TSK 0814504
.           Update diet tables with new date if booking changes (UNUT0000)
.           Added extra diet details for UNUT0000 (UPCAT000/catcomaf)
. V10.08.17 19/10/2016  Peter Vela        TSK 0827811
.           Recompiled for CLPMSOEC
. V10.08.16 10/10/2016  Ania P            CAR 319994
.           Added disability alert flag
.           10/10/2016  Peter Vela        TSK 0322550
.           Display 3 Full Descriptions in APTHRW00
. V10.08.15 27/09/2016  J.Tan             TSK 0320582
.           Mods SessionLink to pass on Session Finalisation date
. V10.08.14 07/09/2016  J.Tan             TSK 0823259
.           Mods WRNZP000 to update Claim code with the keyin Claim code
. V10.08.13 08/08/2016  Davin             TSK 0321234
.           Added Chronic Condition Alert (PMPXSN11)
. V10.08.12 08/08/2016  Ebon Clements     TSK 0814336
.           Update session comments when adjusting start times - UPDCOM00
. V10.08.11 25/07/2016  Ania P            CAR 320468
.           Recompile for PATNAMCD
. V10.08.10 20/07/2016  Ebon Clements     TSK 0312728
.           Only allow update of PACU bay if arrived - CASTAB00
. V10.08.09 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.08 07/07/2016  Jill Parkinson TSK 0821022
.           Recompiled for OPRCASTM - sp1 output after diagnosis fields
. V10.08.07 05/07/2016  Peter Vela     TSK 0821439
.           Added read to WEBTPL in CASITM10 before WEBHED00
. V10.08.06 27/06/2016  Ebon Clements  TSK 0312728
.           Added bay output to theatre list -  SHOWRBAY in CASTAB00
. V10.08.05 09.06.2016  Ebon Clements  TSK 0308881
.           Added recovery closed tag - RCLS0000
. V10.08.04 23/05/2016 Peter Vela     TSK 0321157
.           Added Theatre CheckList functionality
.           24/05/2016 Nicole Torrisi TSK 0816860
.           Changed CASITM94 to check Ind 3 of OPDACANC code to determine if
.           patient has been cancelled or transferred and CASITM00 to check 
.           cancelled/transferred on supervisor screen
. V10.08.03 20/05/2016 Jill Parkinson TSK 0818251
.           Added cgi NOBKDES2 to allow bkdedes2 to not overwrite adiag2
. V10.08.02 14/04/2016  Ebon Clements   TSK 0313944
.           Added medical history received cgi OPDEA042
. V10.08.01 01/04/2016  Steve Armstrong TSK 0321157
.           Recompiled for changes to OPRPOCFD
. ---------------------------------------------------------------------------
. V10.07.09 17/03/2016  Peter Vela TSK 0812866
.           Added cancel record to SESMOV00 oprhisaf
. V10.07.08 16/03/2016  Peter Vela TSK 0812866
.           Fixed write to oprhisaf in SESMOV00
. V10.07.07 04.02.2016  B.G.Ackland
.           Theatre Tracking Map Condition Update
. V10.07.06 17/11/2015  Ebon Clements  CAR 322575
.           Fixed replace space with plus in URNUMBER - ADDMED00
. V10.07.05 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO and WATTX1TM
. V10.07.04 16/10/2015  Jill Parkinson CAR 315640
.           Fixed incorrect GOTO in docsel00
. V10.07.03 15/10/2015 Ania P         CAR 316632
.           Added code to allow for redirect that is not hard coded
. V10.07.02 15/10/2015  Jill Parkinson CAR 315640
.           Added output of doctcode in docsel00 so doctor in use is always
.           displayed - even if it is not setup in watvwlaf
. V10.07.01 15/10/2015  Ebon Clements  CAR 316638
.           Added cancelled/tranferred status display - PATSTS00
. V10.06.34 04/09/2015  Peter Vela       CAR 319529
.           Added new tag for CASTAB00 in CLST2400
. V10.06.33 28/08/2015  Steve Armstrong  CAR 311864
.           Recompiled for changes to OPWEBCAN
. V10.06.32 20/08/2015  Ania P        CAR 320802
.           Recompiled for OPRSRGTM
.           20/08/2015  Ania P        CAR 316632
.           Added changes to redirects when NEXTPAGE=8
. V10.06.31 18.08.2015  Ania P        CAR 316632 
.           Added PROFL982 
. V10.06.30 06.08.2015  B.G.Ackland   CAR 320470 
.           Remove PATBMHAF table updates
.           Restrict Number of Records Written to PATBMDAF to 12 weeks
. V10.06.29 17/08/2015 Peter Vela     CAR 319842
.           Fixed GotoUR() in COMCAS00
. V10.06.28 07/08/2015 Peter Vela     CAR 319782
.           Updated Theatre Request gender and DOB in THRQ4000
. V10.06.27 28/07/2015 Nicole Torrisi CAR 319445
.           Fix redirect from Day Session Case List
. V10.06.26 24/07/2015 Peter Vela     CAR 319066
.           Added disability icons to CASTAB00
. V10.06.25 21/07/2015 Peter Vela     CAR 319622
.           Removed clock stop parameter functionality in APTHRW00
. V10.06.24 20/07/2015 Peter Vela     CAR 310149
.           Added read to BOKRX1 in ADDBOK10 
. V10.06.23 17/07/2015 Peter Vela     CAR 319262
.           Fixed age calculation in APTHRW00
. V10.06.22 16/07/2015 Peter Vela     CAR 319529
.           Fixed MBS Codes and Description validation and assignment
.           in UPRQ1000
.           Fixed Alerts in APTHRW00
. V10.06.21 08/07/2015 Peter Vela     CAR 318866
.           Fixed nz finalisation validation in CASSEL10
. V10.06.20 08/07/2015  Peter Vela        CAR 319120
.           Changed validation for OPARTIRD and OPARTIRF to OPSGTIDR in
.           CASTAB00 and COMCAS00
. V10.06.19 07/07/2015  Peter Vela        CAR 319096
.           Fixed theatre request temp file sorting functionality in
.           APTHRQ00
. V10.06.18 07/07/2015  Peter Vela        CAR 319086
.           Added validation for emergency session at the top of the loop in 
.           CASTAB20 when OPCNUTRA = 1
. V10.06.17 01/07/2015  Peter Vela        CAR 317968
.           Added Operation Description for stv in CSTBHD00 
.           Added default functionality for OPDATHET from theatre request in 
.           SETDEA00
.           Changed validation for OPARTETC to OPARTIRD or OPARTIRF in
.           CASTAB20
. V10.06.16 01/07/2015  Peter Vela        CAR 318205
.           Commented out business rules to update booking request clock start
.           date and time in UPRQ1000
. V10.06.15 25/06/2015  Steve Armstrong   CAR 318558
.           Recompiled for changes to BOKQUEFD & BOKQUEIO
. V10.06.14 24/06/2015  Don Nguyen    CAR 318454
.           Recompiled for OPRSESTM - Added OPSES078 in MOVSES00
. V10.06.13 04/06/2015 Peter Vela     CAR 317611
.           Added Theatre Desc and Consent Obtained / Status to
.           APTHRW00
. V10.06.12 26/05/2015 Peter Vela     CAR 312771
.           Added 0 minutes to Duration column APTHRW00
. V10.06.11 01/05/2015 Peter Vela     CAR 312771
.           Added Theatre Request Approvals
. V10.06.10 20/05/2015 Patrick Adair  CAR 315904
.           Call CLPATMIS when read is not for same URNUMBER
. V10.06.09 13/05/2015  Don Nguyen    CAR 299117
.           Added call to OPTHCMPL for REBOOK00 (Patient re-booking)
. V10.06.08 05/05/2015  Don Nguyen    CAR 299117
.           Recompiled for OPMAKBOK - clear OPDAACPD & OPDARICM before write
. V10.06.07 22/04/2015  Don Nguyen    CAR 299117
.           Modified POSCAN00 to update patient visit theatre complete OPTHCMPL
. V10.06.06 02.04/2015 B.G.Ackland    CAR 312482
.           Recompiled for UPEADMVS Online Preadmission Changes
. V10.06.05 25/03/2015  Jill Parkinson CAR 314522
.           Re wrote REOCS000 so it calls MVSBOK00 instead of deleting oprdetaf
. V10.06.04 17/03/2015  Davin         CAR 311669      HDP 2015/16
.           Add PTCNGDV9 for ICD10 Ed.9 Go-live Date (Sect.110 Pos.77)
. V10.06.03 13/03/2015  Jill Parkinson CAR 229545
.           Added check for BOOKFLAG around DEBKREC1 in BOKMER00
. V10.06.02 12/03/2015  Steve Armstrong  CAR 314108
.           Removed reference to PATCGPFD (No Longer in use)
. V10.06.01 11/03/2015  J.Tan          CAR 314106
.           Changed BKREC024 from DIM8 to DIM10
. ---------------------------------------------------------------------------
. V10.05.29 26/02/2015  Ebon Clements  CAR 313396
.           Move one to exit after WEBERR00 - CHKPRE00
. V10.05.28 06/02/2015  Peter Vela     CAR 307833
.           Added Clock Start Date/Time to CASTAB00
. V10.05.27 03/02/2015  Ebon Clements  CAR 308437
.           Recompiled for IBAWEBDF - HTMLLINK length increase
.           Changed NEXTLINK from a DIM 127 to DIM 227
.           30/01/2015  Patrick Adair  CAR 308918
.           Added Fasting Time Data Collection
.           30/01/2015  Peter Vela     CAR 310302
.           Recompiled for BOKRQ1TM
. V10.05.26 19/01/2015  Ebon Clements  CAR 310516
.           Added trap around write of oprdetaf in re order session - REOCS000
.           Removed port number from temp file - TMPDETA1
. V10.05.25 16/01/2015  Don Nguyen     CAR 311098
.           Added VALCRO00 - Validate if case reorder required
. V10.05.24 06/01/2015  Jill Parkinson CAR 310307
.           Added CLBOKRQ1 in CASTAB00
. V10.05.23 17/12/2014  Peter Vela     CAR 304784
.           Recompiled for WATDETTM
. V10.05.23 17/12/2014  Peter Vela     CAR 304784
.           Recompiled for WATDETTM
.           Recompiled for OPWEBTRN
. V10.05.22 16/12/2014  Peter Vela     CAR 310143
.           Recompiled for BOKRC1TM
. V10.05.21 09/12/2014  Peter Vela     CAR 307865
.           Removed check for deceased patient in THRQ5000
. V10.05.20 08/12/2014  Peter Vela     CAR 307790
.           Added functionality for FILTSETY session type
. V10.05.19 03/12/2014  Jill Parkinson CAR 306468
.           Added error in SESMOV00 if case is already cancelled or
.           does not exist
.           02/12/2014  Peter Vela     CAR 308859
.           Recompiled for BOKRQ1TM
.           Added Consent Obtained to CSTBHD00
. V10.05.18 01/12/2014  Peter Vela     CAR 308906
.           Added admission record validation in PBDM0000
.           01/12/2014  Peter Vela     CAR 307843
.           Fixed delete theatre request functionality in THRQ3000
. V10.05.17 26/11/2014  Peter Vela     CAR 308906
.           Validate PTBDSTAT in UPPBMN00
. V10.05.16 24/11/2014  J.Tan          CAR 304284
.           Recompiled for OPWEBTRN - to update Extra MBS
. V10.05.15 18/11/2014  Peter Vela     CAR 307781
.           Added validation for OPCNTRCS in CASTAB21
. V10.05.14 17/11/2014  Davin          CAR 307766
.           Recompiled for BOKRQ1TM - fixed alert image display
. V10.05.13 12/11/2014  Ebon Clements  CAR 307967
.           Fixed check theatre date is prior to discharge date - CASITM06
. V10.05.12 07/11/2014  Ebon Clements  CAR 307967
.           Check theatre date is prior to discharge date - CASITM06
. V10.05.11 07/11/2014  Davin          CAR 307029
.           Only display active waiting list consultants (untsel00)
. V10.05.10 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESTM - Added OSES8300-OSES8900
. V10.05.09 22.10.2014  Ebon Clements  CAR 299130
.           Call bed board update for merge theatre booking - BOKMER75
.           16/10/2014  J.Tan          CAR 304284
.           Added Extra provisional MBS Codes
. V10.05.08 14/10.2014  Peter Vela     CAR 301518
.           Recompiled for UPEADMVS
. V10.05.07 01.10.2014  Ania P         CAR 298084
.           Fixed ordering using Update button
. V10.05.06 19/09/2014  Jill Parkinson CAR4042881
.           Recompiled for OPWEBPST - correct websecaf read after DWLPC000
. V10.05.05 11.09.2014  Patrick Adair  CAR 241461
.           Allow booking of Deceased Patients into Theatre
.           18.04.2014  J.Tan          CAR 302391
.           Recompiled for BOKRQ1TM
. V10.05.04 04.09.2014  Ania P         CAR 298084
.           Changed output of buttons in CASSEL10
. V10.05.03 28/08/2014  Peter Vela     CAR 304288
.           Re-read websecaf in VEWCOM00 with original userid
. V10.05.02 15/08/2014  Jill Parkinson CAR 299980
.           Added calls to OPTHETAT to write new theatre audit records
.           13/08/2014  Jill Parkinson CAR 304796
.           Added call to UPDMIS00 in ADDMED00
.           Added call to UPADM000 in ADDMED00
.           11/08/2014  Don Nguyen     CAR 297774
.           Recompiled for changes to PMSBRQFD/IO
.           04/08/2014  Peter Vela     CAR 302164
.           Added PMMIRBRS - Rebate Reason CAT Rr
.           31/07/2014  Ebon Clements  CAR 283332
.           Added cgi vars OPDEA040 and OPDEA041, Added vars SAVPCOM to SAVAPRC
.           31/07/2014  Peter Vela     CAR 299131
.           Added new bokrx1 fields to CLBOK000
. V10.05.01 24/07/2014  Ebon Clements  CAR 303282
.           Added anaesthetic started test for patient in theatre - CASSTS10
. V10.04.13 19/06/2014  Jill Parkinson CAR 273374
.           Added check of OPSRTISS to set status to 'Theatre' in PATSTS00
. V10.04.12 21/05/2014  Jill Parkinson CAR 301137
.           Mods to show ALRTIMG2 and ALRTIMG3 in CASTAB00
. V10.04.11 08/05/2014  Peter Vela      CAR 279020
.           Added missing bokrx1af fields to CLBOK000
. V10.04.10 26/04/2014  Peter Vela      CAR 292257
.           Added OEC Store Details of Request
. V10.04.09 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.08 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.07 27/03/2014  Jill Parkinson CAR 298114
.           Added comnflag to allow multiple comments fields into OPCOMFIL
. V10.04.06 28/02/2014  Jill Parkinson CAR 293804
.           Commented out 7 day check from CURI4500 to match CHKVIS00
. V10.04.05 18/02/2014  Peter Vela     CAR 218689
.           Move spaces into OPDAREQN before WROPDEA1
.           Added Theatre Requests
. V10.04.04 06/02/2014  Patrick Adair  CAR 293445/293780
.           Recompiled for changes to UPEADMVS
. V10.04.03 17/01/2014  J.Tan        CAR 295008
.           Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.           20/01/2014  J.Tan        CAR 249828
.           Added PMMIPMBS - Patient MBS Team and Counter
. V10.04.02 31/12/2013  Don Nguyen     CAR 294389
.           Recompiled for changes to WATLETFD & WATLETIO
. V10.04.01 16/12/2013  Peter Vela     CAR 156094
.           Added Finalisation validation for IBA_NZ in CASSEL10
.--------------------------------------------------------------------------
. V10.03.49 04/12/2013  Don Nguyen     CAR 281940
.           Fixed bug in UPPBMN00 where FORM3 wasn't initialised before used.
.           Also fixed same issue in GTTOTM00 and GNXOEC00.
. V10.03.48 03/12/2013  Jill Parkinson CAR 263655
.           Fixed compare of 3,PTCNHDPS to THREE,PTCNHDPS for oracle in VALVIS00
. V10.03.47 25/11/2013  Ebon Clements  CAR 293747
.           Recompiled for OPWEBCAN - Write cancel pre admission record
. V10.03.46 28/10/2013  Patrick Adair  CAR 201234
.           Recompiled for changes to WLHISSUB
.           23/10/2013  Patrick Adair  CAR 258134
.           Confirm Admission date = Scheduled Admission Date (VALVIS00)
. V10.03.45 22/10/2013  Ania P         CAR 263655
.           Added USEWATMT
. V10.03.44 07/10/2013  Jill Parkinson CAR 280284
.           Added calls to CLWATDET and check for blank WMURNO in WCHB0000
. V10.03.43 04/10/2013  Patrick Adair  CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.42 03/10/2013  B.G.Ackland    CAR 292275
.           Ignore Cancelled Appointments in Theatre List by Cases for Mobility CASS0000
. V10.03.41 30/09/2013  Peter Vela     CAR 291974
.           Recompiled for WATTX1TM - Added validations for Start and End date
.           in HCPHOS00
. V10.03.40 25/09/2013  Jill Parkinson CAR 260982
.           Added CASEUNIQ to EDTBOK00
. V10.03.39 12/09/2013  Ebon Clements  CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.38 12/09/2013  Ania P         CAR 289775
.           Added tag and variable svmpflag
. V10.03.37 29/08/2013  Don Nguyen     CAR 178866
.           Recompiled for changes in OPWEBTRN
. V10.03.36 19/08/2013  Don Nguyen     CAR 178866
.           Recompiled for changes in OPWEBTRN
. V10.03.35 19/08/2013  Jill Parkinson CAR 280284
.           Added call to CLWATDET in CASCAN00 (before OPDAPROC check)
. V10.03.34 06/08/2013  Patrick Adair  CAR 289877
.           Recompiled for OPRCASTM after eAdmission changes "disappeared"
. V10.03.33 30/07/2013  Patrick Adair  CAR 289389
.           Updated to cater for new documents workflow requirements
. V10.03.32 26/07/2013  Steve Armstrong  CAR 287787
.           Recompiled for changes to DGCLICUA.
. V10.03.31 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.30 02.07.2013  B.G.Ackland    CAR 286386
.           New Tag for Theatre Case List by Session in
.           t.addRow Javascript Format
. V10.03.29 06/06/2013  Jill Parkinson CAR 260982
.           Recompiled for OPWEBTRN - opdastat/bkrestat when transferring to a
.           new booking
. V10.03.28 29/05/2013  Patrick Adair     CAR 285158
.           Updated eAdmission Pending Header Status to booked
. V10.03.27 31/05/2013  Davin         CAR 284420      HDP 2013/14
.           Add PTCNGDV8 for ICD10 Ed.8 Go-live Date (Sect.110 Pos.69)
. V10.03.26 28/05/2013  Jill Parkinson   CAR 285919
.           Recompiled for OPMAKBOK - corrected opdaprov in DEAI0000
. V10.03.25 28/05/2013  Peter Vela        CAR 261630
.           Removed port number from temp file name
. V10.03.24 27/05/2013  Patrick Adair     CAR 285158
.           Added ADMISNID for eAdmission in MISC0000
. V10.03.23 14/05/2013  Jill Parkinson CAR 275462
.           Recompiled for OPWEBTRN - only update adocta if preadmission
. V10.03.22 08/05/2013  Ania P         CAR 284957
.           Recompiled for WATTX1TM
. V10.03.21 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.20 16/04/2013  Ebon Clements  CAR 223175
.           Added unscheduled WL edit check to add new booking - ADDBOK00
. V10.03.19 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.18 26/03/2013  Patrick Adair  CAR 281548
.           Replaced inline CLBOK000 code with included routine CLBOKRC1
. V10.03.17 21/03/2013  J.Tan          CAR 282671
.           Added oppmserv
. V10.03.16 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.15 01/03/2013  J.Tan          CAR 256497
.           Fixed 'Merge Booking' to move Implant/Misc. to Link Visit (UMTI000)
. V10.03.14 25/02/2013  Ania P          CAR 281021
.           Removed unnecessary modification of constants.
. V10.03.13 14/08/2012  Patrick Adair   CAR 253988
.           recompiled to pick up BOKRECTM changes
. V10.03.12 25/07/2012  Jill Parkinson  CAR 267416
.           Added read of wattr1af before call to WCHB0000
. V10.03.11 19/07/2012  Steve Armstrong  CAR 268870
.           Recompiled for changes to PATCOMN2
. V10.03.10 17/07/2012  Peter Vela     CAR 263394
.           Recompiled for OPWEBCAN
. V10.03.09 09/07/2012 Steve Armstrong   CAR 267675
.           Recompiled for changes to PATCOMN2.
. V10.03.08 10/05/2012 Peter Vela        CAR 232137
.           Recompiled for BEDBDVCD
. V10.03.07 11/04/2012 Sandra Barcham    CAR 235919
.           Clear OPARUYN1 and OPARUYN2 in routine CLARD000
. V10.03.06 16/03/2012  Jill Parkinson   CAR 243341
.           Recompiled for BOKRX1TM - bkrxudf5 for intended stay
. V10.03.05 16/03/2012  Ebon Clements    CAR 220010
.           Clear ED linked visit number on cancel pre admission - UNEMR000
. V10.03.04 21/02/2012  Jill Parkinson   CAR 259918
.           Recompiled for OPWEBTRN - update nzpspraf when transferring
. V10.03.03 15/02/2012  Davin          CAR 256006
.           Recompiled for changes to WATQUEFD
. V10.03.02 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.01 18/12/2011  Nicole Torrisi   CAR 246185
.           Added output of Admission Details (MISF0000) to report 4
. V10.02.17 04/11/2011  Steve Armstrong  CAR 254751
.           Recompiled for changes to OPRQUEFD
. V10.02.16 30/10/2011  Nicole Torrisi CAR 236736
.           Changed DOCSEL00 to output in Surname order
. V10.02.15 21/10/2011  Jill Parkinson   CAR 253673
.           Recompiled for OPWEBCAN - not to delete pmsv1af
. V10.02.14 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.13 30/09/2011  Jill Parkinson CAR 248486
.           Recompiled for IBAWEBCD - Restrict hospital access
. V10.02.12 21/09/2011  Steve Armstrong   CAR 251515
.           Recompiled for changes to WATQUEFD.
. V10.02.11 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.10 24/08/2011  Jill Parkinson CAR 222655
.           Fixed ouput of user for wl comments
. V10.02.09 19/08/2011  Ebon Clements  CAR 234855
.           Added scheduled adm date change to data integrity audit
. V10.02.08 18/08/2011  Ebon Clements  CAR 234853
.           Added reason for scheduled adm date change to data integrity audit
. V10.02.07 13/08/2011  Jill Parkinson CAR 222655
.           Added new tag for WL comments on watmtxaf
. V10.02.06 11/08/2011  Jill Parkinson CAR 243296
.           Recompiled for new bokrx1af fields
. V10.02.05 13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.04 22/06/2011  Steve Armstrong   CAR 240722
.           Recompiled for changes to PATLOCFD.
.           Mods to cater for changes to PATGSRFD:
.                - GSRSNAM & GSRGNAM extended to 30 chars.
.                - PTGSGNM2 added.
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
. V10.02.03 29/06/2011  Peter McMullen CAR 2340725 WA Health
.           Add WSEL0000 routine called by WATTX1TM
. V10.02.02 10/05/2011  Davin          CAR 239539 WA Health
.           Recompiled for LSTALERT - added ALRTIMG2,ALRTIMG3,ALRTIMGT
. V10.02.01 31/03/2011  Peter Vela     CAR 232054
.           Added Free Format OEC for bookings
.           22/03/2011  Jill Parkinson CAR 239574
.           Increased size of SCHDPRNT
.--------------------------------------------------------------------------
. V10.01.08 23/02/2011  Jill Parkinson CAR 222655
.           Added pack of NZSPUNTH with OPDAUNIQ
. V10.01.07 19/01/2011  Jill Parkinson CAR 234014
.           Increased sizes of BKREC036 and BKREC037
. V10.01.06 11/01/2011  Ebon Clements  CAR 215701
.           Recompiled for BEDBDVCD -  H/F stepdown
. V10.01.05 11/01/2011  Jill Parkinson CAR 234014
.           Increased lengths of descriptions
. V10.01.04 06/01/2011  Jill Parkinson CAR 233088
.           Added update of pmvxfndm
. V10.01.03 22/12/2010  Peter Vela     CAR 215424
.           Added tag for case abandoned
. V10.01.02 18/11/2010  Jill Parkinson CAR 233952
.           Recompiled for OPWEBTRN - changing of adate
. V10.01.01 28/10/2010  Jill Parkinson CAR 232208
.           Fixed UPDDIA00 to do a full read of bokdiaaf before updating
. V10.00.15 06/10/2010  Ebon Clements  CAR 231396
.           Recompiled for BEDBDVCD - Post op records expected ward/bed
. V10.00.14 02/09/2010  Jill Parkinson   CAR 222489
.           Added clear of BKRXDIET and BKRXTRAN
.           Added CHCKOVER to check if slot already booked
. V10.00.13 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.12 18/08/2010 Saroeun Soeur     CAR 218727
.           recomplied for OPRAAETM
. V10.00.11 17/08/2010 Davin S           CAR 216360
.           Recompiled for OPRCASTM
. V10.00.10 12/08/2010 SAroeun Soeur     CAR 218727
.           set flag around opraae subroutines
. V10.00.09 09/08/2010 Saroeun Soeur     CAR 218727
.           set IO TRAP on opraaeaf file - AAEFLAG
. V10.00.08 29/07/2010 Saroeun Soeur     CAR 218727
.            created UPDATEDE to store intubation details
. V10.00.07 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.06 16/06/2010  J.Tan          CAR 217811
.           Mods Transfer booking - checking if patient in theatre
. V10.00.05 15/06/2010  J.Tan          CAR 217811
.           Recompiled for OPWEBTRN -only updating ALACDTE if no invoice printed
. V10.00.04 12/05/2010  Jill Parkinson CAR 218926
.           Recompiled for OPRCASTM
. V10.00.03 05/05/2010  Peter Vela     CAR 218135
.           Added validation for cancelled sessions in SESTAB00
.           for oprweb0102003.html
. V10.00.02 21/04/2010  Saroeun Soeur  CAR 196071
.           Recompiled for OPRCASTM
. V10.00.01 19/03/2010  Steve Armstrong    CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.           12/03/2010  Mike Laming    CAR 200963
.           Add Alerts Column to Case List in CASTAB00 - uses module LSTALERT
.           16/02/2009  Jill Parkinson CAR 157639
.           Mods to not delete bokrc1af records when merging if other bookings
.           exist
.--------------------------------------------------------------------------
. V9.12.25  04/02/2010  Jill Parkinson CAR 214072
.           Mods to output PTITDESC instead of IDESC in VALITM00
. V9.12.24  27/01/2010  Jill Parkinson CAR 212482
.           Mods to use DEFTVIEW
. V9.12.23  27/01/2010  Jill Parkinson CAR 210976
.           Added CLWATDET in EDTBOK00
. V9.12.22  20/01/2010  Ebon Clements  CAR 208543
.           Recompiled for OPWEBTRN - cancellation date on transfer booking
. V9.12.21  11/12/2009  Ebon Clements  CAR 210196
.           Recompiled for OPRSESTM - Default start/end time for duration
. V9.12.20  10/12/2009  Jill Parkinson CAR 187587
.           Added redirect for automatic transfers for sportsmed
. V9.12.19  02/12/2009  Jill Parkinson CAR 204527
.           Added CHKBK000 - booking, WL and Preadmission flags
. V9.12.18  03/12/2009  Ebon Clements  CAR 204362
.           Recompiled for BEDBDPRO - Clear post op ward
. V9.12.17  01/12/2009  Saroeun Soeur  CAR 164870
.           WATDET00
.         added move waiting list procedure 2 and 3 to theatre procedure 2 and 3
. V9.12.16  26/11/2009  Saroeun Soeur  CAR 164870
.           WATDET00 - nz to flow waiting list admission source to booking
. V9.12.15  12/11/2009  Jill Parkinson CAR 210088
.           Added clear of BKREINDC and other missing fields
. V9.12.14  11/11/2009  Ebon Clements  CAR 208991
.           Recompiled for BEDBDVCD - Post op expected due date
. V9.12.13  09/11/2009  Davin          CAR 208349
.           Recompiled for DGCLICUB - check correct parameter to trigger CUB
. V9.12.12  27/10/2009  Davin          CAR 207399
.           Recompiled for OPWEBPST - default watmesaf comments to oprdedaf
. V9.12.11  15/10/2009   Saroeun Soeur CAR 207907
.           fixed redirect on new medical booking ADDMED00 - DOBKINDC
. V9.12.10  17/09/2009   Jill Habasque CAR 206242
.           Removed update of adiag in UPDMIS00
. V9.12.09  07/09/2009   Peter Vela    CAR 196071
.           Move spaces to WTTXANAE before write
. V9.12.08  02/09/2009   Jill Habasque CAR 203858
.           Moved setting of BKRESTAT to zero in ADDMED00 only for adding
. V9.12.07  25/08/2009   Peter Vela    CAR 204354
.           Update AMBS in UPMSEC00
. V9.12.06  19/08/2009   Jill Habasque CAR 199583
.           Mods to update ptmxlga - Used for ECT count other facility
. V9.12.05  11/08/2009   Peter Vela    CAR 203491
.           Added redirect indicator for Day Oncology New Booking screen
.           ADDMED00
. V9.12.04  23/07/2009   Saroeun Soeur CAR 152624
.           ADDMED00 - redirect to patweb98 with new addmission number
.           on new medical booking
. V9.12.02  08/07/2009  Jill Habasque  CAR 195238
.           Really added call to UPADM000 after ADDBOK00
. V9.12.02  24/06/2009  Ebon Clements  CAR 199232
.           Recompiled for BEDBDVCD
. V9.12.01  12/05/2009  Ebon Clements CAR 195390
.           Added missing bokrx1af fields to CLBOK000
. V9.11.19  28/04/2009  Saroeun Soeur CAR 191623
.           Added check to see if patient has any alerts
.           display the alert folder icon if so, else normal folder
. V9.11.18  08/04/2009  Peter Vela    CAR 183976
.           Added Multihospital for OEC write to PMSOECFD
. V9.11.17  08/04/2009  Saroeun Soeur CAR 172943
.           Added format to name control by patient global parameter
. V9.11.16  08/04/2009  Peter Vela    CAR 183976
.           Added PTVIS111 PMVXPILC Presenting Illness Code for OEC
. V9.11.15  07/04/2009  Jill Habasque CAR 182606
.           Fixed update of PTMIXWRD in UPADM00
. V9.11.14  07/04/2009  Jill Habasque CAR 182606
.           Mods to use ptcndwaw
. V9.11.13  31/03/2009  Ebon Clements CAR 176252
.           Changed to read ICD10 when using OPCNCODE
. V9.11.12  12/03/2009  Peter Vela     CAR 183976
.           Added Eclipse OEC functionality
. V9.11.11  23/01/2009  Ebon Clements  CAR 187713
.           Added CLINCODE tag to CLST0000
. V9.11.10  20/01/2009  Ebon Clements  CAR 184639
.           Allow case number updates for sessions in the past -  CASSEL00
. V9.11.09  12/01/2009  Ebon Clements  CAR 174080
.           Added post of bed to UPADM000
. V9.11.08  06/01/2009  Jill Habasque  CAR 186521
.           Added call to UPADM000 after ADDBOK00
. V9.11.07  24/12/2008  Peter McMullen CAR 178013
.           Recompiled for OPWEBTRN
. V9.11.06  11/12/2008  Ebon Clements  CAR 174080
.           Recompiled for BEDBDVCD - Post op bed
. V9.11.05  26/11/2008  Ebon Clements  CAR 174057
.           Added bed board functionality
. V9.11.04  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.03  27/10/2008  Ebon Clements CAR 181511
.           Changed name of TMPDETA1 to 8 characters opwb01XX not opweb01XX
. V9.11.02  21/10/2008  Ebon Clements CAR 161858
.           Added day, special comments, theatre code and assistant to SESROW00
. V9.11.01  20/10/2008  Ebon Clements CAR 161841
.           Added anaesthetist/assistant tags - DANA0000 - DASS0000
. V9.10.17  24/09/2008  J.Tan         CAR 164513
.           Mods to update ADIAG from update booking screen for pre-admission
. V9.10.16  03/09/2008  Davin         CAR 147323
.           Send hl7 message for new bookings (added call DGCLIS12)
.           Send hl7 message for upd bookings (added call DGCLIS14)
.           Send hl7 message for del bookings (added call DGCLIS15)
. V9.10.15  03/09/2008 Ebon Clements CAR 176184
.           Recompiled for OPMVSBOK - Check for cancelled status
. V9.10.14  03/09/2008 Jill Habasque CAR 164652
.           Mods to update AMBS with OPERPRV1
. V9.10.13  02/09/2008 Jill Habasque CAR 164652
.           Mods to update ADIAG1 with OPERDES1 and ADIAG2 with OPERDES2
. V9.10.12  13/08/2008 Jill Habasque CAR 175727
.           Removed check for within 7 days for preadmissions
. V9.10.11  13/08/2008 Jill Habasque CAR 175727
.           Recompiled for OPWEBCAN - WTENEVDT for updating cancelled bookings
. V9.10.10  12/08/2008 Ebon Clements CAR 175172
.           Fixed CURI0000 selection of default pre admission
. V9.10.09  22/07/2008 Jill Habasque CAR 170825
.           Mods to not output cancelled sessions as available to transfer to
. V9.10.08  21/07/2008  Ebon Clements CAR 174229
.           Added created by fields to TMPDETA1 to retain creation details
. V9.10.07  17/07/2008  Jill Habasque CAR 164652
.           Added UPADM000 - update preadmission with booking details
. V9.10.06  11/07/2008  Jill Habasque CAR 170189
.           Mods to only update oprsesaf.opsetimb once when changing durations
. V9.10.05  27/06/2008  Ebon Clements CAR 171757
.           Added write to admission comments functionality
. V9.10.04  23/06/2008  Jill Habasque CAR 171286
.           Recompiled for OPRCASTM - use of opcncode
. V9.10.03  19/05/2008  Jill Habasque  CAR 163231
.           Added CHGDU000 -update following start times after changing duration
. V9.10.02  19/05/2008  Ebon Clements CAR 162051
.           Recompiled for BOKRECTM - BKREDOFR
. V9.10.01  15/05/2008  Jill Habasque CAR 161608
.           Recompiled for IBAWEBCD and PATCODTM - patcodes long description
.           05/05/2008  J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.09.31  23/04/2008  Ebon Clements CAR 166952
.           Added unlock of U/R to Merge booking to admission - CASUPD80
. V9.09.30  11/04/2008  Ebon Clements CAR 165178
.           Set PMVXATCP to no if adding additional bookings for an admission
. V9.09.29  27/03/2008  Ebon Clements CAR 164228
.           Added BKREEATY to CLBOK000
. V9.09.28  27/02/2008  Jill Habasque CAR 161392
.           Added read of wattr1af in EDTBOK00
. V9.09.27  19/02/2008 Jill Habasque CAR 157574
.           Added write to bokunqaf
. V9.09.26  08/02/2008  Ebon Clements CAR 149100
.           Added new doctor type filter doctortp(Cat DT) for anaesthetist list
. V9.09.25  04/02/2008  Ebon Clements CAR 152783
.           Added OPCNTPAT - Highlight today patient on theatre list CASTAB00
. V9.09.24  23/01/2008  Jill Habasque CAR 159264
.           Recompiled for OPWEBCAN - added SAVEPREV
. V9.09.23  10/01/2008  Peter McMullen CAR 137632
.           Added booking status to usage column for oprweb0103003
. V9.09.22  09/01/2008  Jill Habasque CAR 158212
.           Added call to BKSEL000 - cat BK selection list with HDP=THE
. V9.09.21  20/12/2007  Jill Habasque     CAR 126282
.           Added update of update date/time to oprdetaf
. V9.09.20  06/12/2007  Jill Habasque     CAR 153381
.           Moved clear of oprdetaf to CLOPRDEA
. V9.09.19  05/12/2007  Ebon Clements     CAR 150315
.           Added jregform cgi
. V9.09.18  04/12/2007  Steve Armstrong   CAR 155887
.           Mods to clear waiting list variables before writing to bokqueaf.
.           Recompiled for changes to DGCLICUB.
. V9.09.17  14/11/2007  Jill Habasque CAR 151455
.           Added move of SP70 to OPDACDAT when reinstating a booking
.           Added CHKES000 to delete a postponement
. V9.09.16  12/11/2007  Jill Habasque CAR 154184
.           Recompiled for BOKRX1TM - post op ward hospital check
. V9.09.15  07/11/2007  Jill Habasque CAR 135913
.           Recompiled for OPWEBTRN - check for newexdat to wtenevdt
.           07/11/2007  Jill Habasque CAR 152619
.           Recompiled for OPWEBCAN - added UPESCN00
. V9.09.14  23/10/2007  Jill Habasque CAR 147135
.           Added REDPAR00 - parent redirect
.           15/10/2007  Jill Habasque CAR 151283
.           Moved PTHV0000 to be before NEWBOK50, fixed clear oprdetaf pthv0000
.           12/10/2007  Jill Habasque CAR 150324
.           Added CHRFL000 - Check for referral
. V9.09.13  28/09/2007  Ebon Clements CAR 151291
.           Recompiled for OPWEBSTT - Case from
. V9.09.12  06/09/2007  Peter Vela      CAR 148954
.           Added functionality for patient admission multiple regime codes.
.           Added functionality for medical booking update of bed management
.           table.
. V9.09.11  21/09/2007  Jill Habasque CAR 150323
.           Recompiled for BOKRX1TM - added UDF times
. V9.09.10  21/09/2007  Jill Habasque CAR 150330
.           Added calculation and output of TIMELEFT
. V9.09.09  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
.           14/09/2007  Jill Habasque CAR
.           Added CHKPRE00 - Medical bookings linked to a preadmission
. V9.09.08  06/09/2007  Ebon Clements CAR 149099
.           Added multi hospital test to DOCSEL00
. V9.09.07  27/08/2007  Peter Vela   CAR 147747
.           Added variables for PATCOMN2 Cabrini Health UR format
. V9.09.06  24/08/2007  Jill Habasque CAR 148591
.           Added delete of Reason for change set sad if indicator 1 A
. V9.09.05  22/08/2007  Jill Habasque CAR 148317
.           Added calls to GETSET00
. V9.09.04  24/07/2007  Jill Habasque  CAR 145779
.           Moved call to PTHV0000 in NEWBOK00
. V9.09.03  20/07/2007  Ebon Clements  CAR 145544
.           Recompiled for OPRSESTM - display theatres with no hospital
.           Don't do multi hospital test on theatre list if act
. V9.09.02  05/07/2007  Jill Habasque  CAR 141909
.           Added update of BKRESTAT and OPDASTAT when merging bookings/adms
. V9.09.01  20/06/2007  Jill Habasque  CAR 143141
.           Added pack of WTENWEBC in WSAD0000
. V9.08.18  19/06/2007  Jill Habasque  CAR 131266
.           Added check for merged UR
. V9.08.17  24/05/2007  Jill Habasque  CAR 135913
.           Mods to UPESIS00 to use confirmed admission as event date
. V9.08.16  17/05/2007  Peter Vela     CAR 137911
.           Added MAIN3100 Reorder Case Numbers routine
. V9.08.15  16/05/2007  Peter Vela     CAR 137967
.           Modified UNUSG000 to update opseactd.oprsesaf
. V9.08.14  02/05/2007  Jill Habasque  CAR 125135
.           Fixed PTHV0000 to use OPDAUNIQ
. V9.08.13  28/03/2007  Peter Vela     CAR 124557
.           Added Stationery Template function for type 18 Theatre Form
.           03/04/2007  Neelkamal Pyla CAR 109322
.           Added code to CASTAB00 to display Requisition Indicator 'R' in the
.           Usage Column
. V9.08.12  05/03/2007  Peter Vela    CAR 135233
.           Added tag for OPRAVEFD.OPAVAVER operation duration average
. V9.08.11  20/02/2007  Peter Vela    CAR 126014
.           Modified Unplanned Return to Theatre functionality
. V9.08.10  22/02/2007  Jill Habasque CAR 120004
.           Mods to write to nzpspraf if booking a currently admitted patient
. V9.08.09  20/02/2007  Jill Habasque CAR 120004
.           Mods for OPCNCPOD to allow 2
. V9.08.08  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
. V9.08.10  31/01/2007  Ebon Clements CAR 130805
.           Added enquiry list option to CASTAB00
. V9.08.06  12/12/2006  Jill Habasque CAR 127846
.           Added error if linking a visit to the same visit number
. V9.08.05  30/11/2006  Peter Vela    CAR 126014
.           Added tag for PMVXUVTH in MISC0000
.           Added submit of ptvis079 (PMVXUVTH.PMSVX1FD)
. V9.08.04  01/11/2006  Jill Habasque CAR 123020
.           Added check for discharge visit over session date in CURI0000
. V9.08.03  23/10/2006  Peter Vela    CAR 118228
.           Recompiled for OPMAKBOK
. V9.08.02  20/10/2006  Ebon Clements CAR 120991
.           Recompiled for BOKRECTM - referring gp tag
. V9.08.01  02/10/2006  Ebon Clements CAR 119992
.           Added multi hospital tests to theatre lists
. V9.07.04  20/09/2006  Peter Vela    CAR 118228
.           Recompiled for OPRRALFD
. V9.07.03  19/09/2006  Mike Laming   CAR 111288
.           Move routine CLWATDET out of here into WATDETTM
. V9.07.02  14/09/2006  Jill Habasque
.           Mods for OPCNCLSU in SESTAB00
. V9.07.01  27/07/2006  Jill Habasque CAR 109355
.           Recompiled for OPWEBTRN - NBRS "06" record
. V9.06.01  30/05/2006  J.Tan         CAR 103697
.           Added day comments
. V9.05.02  07/04/2006  Mike Laming   CAR 96147
.           Re-compiled for OPWEBTRN - Add OPRDEDFD to Transfer Booking data
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
.           15/03/2006  Jill Habasque CAR 77026
.           Added UPESIS00 to write delete records when changing sched adm date
. V9.05.B03 25/01/2006  Peter Vela    CAR 89644
.           Added updates to BKRXCRDT, BKRXCRTM, BKRXWEBC at ADDBOK30
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.32  30/11/2005  Jill Habasque CAR 86409
.           Recompiled for OPWEBCAN
. V9.04.31  15/11/2005  Jill Habasque CAR 84884
.           Added check for OPCNCLSU in SESROW00
. V9.04.30  11/11/2005  Peter Vela    CAR 80156
.           Recompiled for OPRCASTM
. V9.04.29  08/11/2005  Jill Habasque CAR 51483
.           Recompiled for OPWEBTRN
. V9.04.28  04/11/2005  Jill Habasque CAR 58656
.           Added BOKMER00 and VALVIS00
. V9.04.27  26/10/2005  Mike Laming   CAR 52354
.           Change all calls to WTRE0000 to WTDE0000 in line with changes to
.           include module WATDETTM - re-compile for WATDETTM
. V9.04.26  07/10/2005  Ebon Clements CAR 78951
.           Added check for deposits when cancelling a bookings pre admission
. V9.04.25  04/10/2005  Peter Vela    CAR 77448
.           Created oprweb0102001.html for qld (Doctor specific Surgeon Theatre
.           Summary) SLST0000, SESTAB00
.           28/09/2005  Mike Laming   CAR 65745
.           Add OPDACSST (Consent Obtained) & OPDACSDT (Consent Changed Date)
. V9.04.24  23/09/2005  Peter Vela    CAR 76782
.           Enabled update of theatre booking cancellation date POSCON00
. V9.04.23  20/09/2005  Jill Habasque CAR 76240
.           Commented out check for cancelled bookings in CAND0450
. V9.04.22  15/09/2005  Jill Habasque CAR 70497
.           Recompiled for OPWEBAN - update of cancelled bookings for watesnaf
. V9.04.21  14/09/2005  Ebon Clements CAR 76051
.           Set manually added record to no before write to watesnaf
. V9.04.20  13/09/2005  Jill Habasque CAR 76011
.           Recompiled for OPWEBCAN - fixed check for WL
.           13/09/2005  Jill Habasque CAR 75973
.           Recompiled for BOKRECTM - fixed output of bkreaccm
. V9.04.19  07/09/2005  Jill Habasque CAR 71547
.           Recompiled for OPWEBCAN - Fixed event date for cancellations
. V9.04.18  05/09/2005  Ebon Clements CAR 73209
.           Recompiled for OPRSESTM - Session usage default times
. V9.04.17  16/08/2005  Jill Habasque CAR 70633
.           Recompiled for OPWEBCAN - added check for WL patient
. V9.04.16  21/07/2005  Jill Habasque CAR 62513
.           Added check for deceased patients
. V9.04.15  08/06/2005  Jill Habasque CAR 60165
.           Added write of WTENSADI
. V9.04.14  06/06/2005  Ebon Clements CAR 62543
.           Recompiled for OPRSESTM - new doctor tag
. V9.04.13  16/05/2005  Jill Habasque CAR 61176
.           Mods to output clinic description (opcldesc) if no doctor
. V9.04.12  18/03/2005  Guomin Fu     CAR 59532
.           Recompiled for OPRSESTM
.           16/03/2005  Lina Vo       CAR 56404
.           Recompiled for OPRSRGFD, TD & TM
. V9.04.11  07/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
.           25/02/2005  Lina Vo       CAR 56404
.           Changed index size of oprprfaf. Changed OPERPREF to DIM 15.
.           Recompiled for OPRSESFD, IO & TM, OPRSRGTM & TD, OPRITEFD & IO.
.           Changed OPRDPAFD to OPRDPFFD.
. V9.04.10  19/01/2005  Jill Habasque CAR 56541
.           Added output of booking flag (OPRWEB01.08.403)
. V9.04.09  11/01/2005  Lina Vo       CAR 50670
.           Recompiled for IBAWEBCD for print labels.
. V9.04.08  09/12/2004  Jill Habasque CAR 54731
.           Added write to watesnaf
. V9.04.07  29/11/2004  J.Tan   CAR 55470
.           Mods to write to oprpmb file when updating mbs items on booking upd.
. V9.04.06  30/11/2004  Ebon Clements CAR 54801
.           Changed read of oprdetaf in CASITM00 to use the correct index.
.           Caseuniq should use index 3 not index 1
. V9.04.05  22/11/2004  Mike Laming   CAR 55002
.           Recompile for OPCHGSTT - fix "change start time" I*D
. V9.04.04  18/11/2004 Jill Habasque    CAR 55241
.           Fixed RAOPDEA in REBOOK00 and UPDDEA00
. V9.04.03  16/11/2004 Lina Vo          CAR 54962
.           Recompile for OPWEBTRN - save full description when transfered
. V9.04.02  08/11/2004 Lina Vo          CAR 54900
.           Recompile for OPWEBTRN,OPWEBCAN & OPMVSBOK.
.           Added Update Booking Start Time to CASUPD00.
.           Added Report 19 - Adjust subsequent start times
.           05/11/2004 Lina Vo          CAR 54237
.           Recompile for OPMVSBOK
.           Changed program to do a read of oprdetaf before updating
.           to reduce chances of I*U problems
. V9.04.01  11/08/2004 Peter Vela      CAR 50678
.           Added OPCNSCOM - Using Session Based Comments?
.           Added red button indicator for session based comments
. V9.03.17  03/08/2004 Lina Vo         CAR 52289
.           Added Unusage a Patient  session to CASUPD00 (report 5).
. V9.03.16  30/06/2004 Sylvek Litewka  CAR 51048
.           Modified procedure CASITM00 to default TEAMNUMB to 1 if it is blank.
. V9.03.15  17/06/2004 Peter Vela      CAR 49016
.           2004 Stat Changes PRS/2
.           Recompiled for PMSPX2TM
. V9.03.14  26/03/2004 Peter Vela      CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.13  26/03/2004 Ebon Clements   CAR 18703
.           Added transfer source validation
.           17/03/2004 Peter Vela      CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name
.           format) for sort lists.
. V9.03.12  19/12/2003 J.Tan   CAR 44093
.           Replaced patcashf with comdepaf
. V9.03.11  11/12/2003 Peter Vela      CAR 40355
.           Recompiled for PATNAMCD
. V9.03.10  15/10/2003 Sylvek Litewka  CAR 43963
.           Modified procedure OSEL0000 to exclude inactive theatres from
.           selection list.
. V9.03.09  10/10/2003 Sandra Barcham  CAR 43422
.           Recompiled for OPWEBPST
. V9.03.08  30/09/2003 Jill Habasque   CAR 42868
.           Recompiled for OPWEBCAN
.           CAR 42956 - Fixed update of bkrestat
. V9.03.07  29/09/2003 Jill Habasque   CAR 42833
.           Added write of BKRXASRC
. V9.03.06  22/08/2003 Jill Habasque   CAR 41815
.           Recompiled for OPMAKBOK
. V9.03.05  14/08/2003 Jill Habasque   CAR 41815
.           Fixed read/write/updates of bokdiaaf, changed to allow status 1,2,4
. V9.03.04  29/07/2003 Sylvek Litewka  CAR 38345/41805
.           Modified procedure PATSTS00 to display a "RIP" prefix in patient
.           status where required.
.           22/07/2003 Jill Habasque   CAR 21760
.           Mods for new index on bokdiaaf
. V9.03.03  29/05/2003 Sylvek Litewka  CAR 39213
.           Added processing for "oprpocaf" (Pre-Operative/Arrival Check List
.           file).
. V9.03.02  21/05/2003 Ebon Clements  CAR 39159
.           Changed report 26 move case to use a standard redirect process.
.           Changed booking update to only update the theatre if it is blank
. V9.03.01  06/05/2003  Jill Habasque SRF 37661
.           Recompiled for OPWEBCAN - delete of patvisaf when cancelling
.---------------------------------------------------------------------------
. V9.02.68  02/05/2003 Jill Habasque SRF 35150
.           Added output of PTCNHDPS
. V9.02.67  10/04/2003 Jill Habasque SRF 22674
.           Recompiled for WLHISSUB
. V9.02.66  07/04/2003 Jill Habasque SRF 37850
.           Added cpadm004 - transfer source
. V9.02.65  04/03/2003 Jill Habasque SRF 37938
.           Recompiled for GENBOKNO and OPWEBPST
. V9.02.64  03/04/2003 J.Tan  srf 37621
.           Default claim code from W/L
. V9.02.63  01/04/2003 Ebon Clements SRF 37754
.           Changed UPCOM000 to not save blank comment lines
. V9.02.62  18/03/2003 Jill Habasque SRF 36865
.           Added update of OPDATHET when transferring
.           14/03/2003 Ebon Clements SRF 21034
.           Recompiled for new variable OPDAUNIT added to OPRDEAFD
.           11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
.           13/03/2003 Jill Habasque SRF 21715
.           Recompiled for OPWEBTRN
. V9.02.61  31.01.2003  Jill Habasque  SRF 34660
.           Added move of one to NBRFLAG
. V9.02.60  13.01.2003  Jill Habasque  SRF 35176
.           Added read of bokrc1af in addbok10 if admisnum is set to stop
.           clearing of bkreproc and bkrecnt
. V9.02.59  13.12.2002 Sylvek Litewka  SRF 34523
.           Added variable CPADM008 (Waiting List Removal Date).
. V9.02.58  13.11.2002 Jill Habasque SRF 23893
.           Recompiled for OPWEBCAN
. V9.02.57  09.10.2002 Peter Vela    SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.56  27.09.2002 Ebon Clements SRF 20551
.           Recompiled for OPRSESTM - session status display tag
. V9.02.55  17.09.2002 Jill Habasque SRF 20520
.           Added check for zero number of days to lock session
. V9.02.54  22.08.2002 Ebon Clements SRF 21377
.           Changed CASTAB00 to display the procedure description from the
.           theatre details if it is not blank.
. V9.02.53  22.07.2002 Ebon Clements SRF 19440
.           Added OPCNCPOD to ADDBOK00 to copy the booking full description
.           to the surgery details
. V9.02.52  19.07.2002 Ebon Clements SRF 19613
.           Changed CASITM00 to allow update of case details if the patient
.           has an ASTAT of Admitted,On Leave or Dischraged
.           18.07.2002 Ebon Clements SRF 19934
.           Changed ADDBOK00 to use WMBOOK as the booking number for w/list
.           bookings not generate a new number.
. V9.02.51  10.07.2002 Ebon Clements SRF 18421 19408
.           Recompiled for OPWEBPST - OPPSTBOK to use BKREBOOK to update the
.           admission dates not AADMNO
.           Changed SESTAB00 to display overbooked sessions in session
.           search and display percentage booked
. V9.02.50  09.07.2002 Ebon Clements SRF 17676
.           Recompiled for WLHISSUB
. V9.02.49  06.07.2002 Jill Habasque SRF 19273
.           Recompiled for PATCOMN2
. V9.02.48  29.06.2002 Ebon Clements SRF 19105
.           Recompiled for sigpipe trap
. V9.02.47  27.06.2002 Jill Habasque SRF 19095
.           Fixed error for session is locked message
. V9.02.46  20.06.2002 Ebon Clements SRF 18728
.           Added trap if sigpipe
. V9.02.45  31.05.2002 Ebon Clements SRF 18229
.           Added trap if sigpipe
. V9.02.44  16.05.2002 Jill Habasque SRF 17735
.           Commented out call to OPUPDPMI
.           17.05.2002 Jill Habasque SRF 17739
.           Fixed UPDMIS00 to use bkreedat and bkreatim
.           17.05.2002 Jill Habasque SRF 17722
.           Fixed UPDMIS00 to only update the visit file if preadmitted
. V9.02.43  15.05.2002 Jill Habasque SRF 17563
.           Added clear of PREAD002,PREAD003,CPADM002 and CPADM003
. V9.02.42  09.05.2002 Ebon Clements
.           Recompiled for OPWEBTRN - Fixed adate it was being given a
.           6 characters value not 8
. V9.02.41  06.05.2002 Ebon Clements
.           Added a read of OPRSESFD in POSEDT00 so the correct
.           theatre is set for the update of OPRDEAFD
.           Changed PATADMDT to be set up in correct format by setpar
. V9.02.40  29.04.2002 Jill Habasque
.           Added call to CPBKRX00 in clrpar00
. V9.02.39  22.04.2002 Jill Habasque
.           Recompiled for OPWEBPST
. V9.02.38  21.04.2002 Jill Habasque
.           Added check for OPCNCLSU
. V9.02.37  19.04.2002 Jill Habasque 3573
.           Recompiled for OPWEBCAN
. V9.02.36  15.04.2002 Ebon Clements
.           Removed functionality for printing theatre forms
. V9.02.35  09.04.2002 Ebon Clements
.           Add functionality for printing theatre forms
. V9.02.34  09.04.2002 Ashwin
.           Add functionality for Rebooking a patient and Supervisor level
. V9.02.33  28.03.2002 Ashwin
.           Add Theatre in Case List and functionality for Change Theatre
. V9.02.32  18.03.2002 Jill Habasque 2814
.           Commented out update of WMDATE3 in ADDBOK00
. V9.02.31  14.03.2002 Ashwin
.           Recompiled for OPWEBCAN
. V9.02.30  06.03.2002 Ashwin
.           Fix Operation description display
. V9.02.29  28.02.2002 Ashwin
.           Display Cancelled Sessions and Status
.           22.02.2002 Jill Habasque
.           Added move of BKREC034 to bkrebkdt to allow backdating
. V9.02.28  14.02.2002 Kuldeep
.           Modify for CMBS code in theatre session case list
. V9.02.27  06.02.2002 Ebon Clements
.           Recompiled for OPWEBCAN - clear expected due date in cancel booking
. V9.02.26  02.02.2002 Ebon Clements
.           Recompiled for WLHISSUB effective date set
.           05.02.2002 Ashwin
.           Change the sequence of Exit and ICU
.           05.02.2002 Kuldeep
.           Change for patient folder
. V9.02.25  25.01.2002  Kuldeep
.           Default admitting point
. V9.02.24  24.01.2002  Ashwin,Kuldeep
.           Modify for No. of days lock,Surgeon List,Recovery & Procedure
.           Description,Anaesthetist List
. V9.02.23  17.01.2002  Ashwin,Kuldeep
.           Modify link for Transfer Booking,Don't display cancelled session
. V9.02.22  09.01.2002  Ashwin
.           Fix Theatre Case List,Recovery Status
. V9.02.21  20.12.2001  Ashwin,Kuldeep
.           Remote scripting for MBS Code,Modify Doctor selection,Check for
.           patient admitted status,Default eqpt 3,case list to monthly,Avoid
.           future date and after recovery detail updation
. V9.02.20  13.12.2001  Ebon Clements
.           Recompiled for OPWEBPST so that the confirmed operation date is
.           not hard coded to today
. V9.02.19  13.12.2001  Ashwin
.           Fix to update case details in Session case list and Change the
.           surgeon unit category to ST
. V9.02.18  06.12.2001  Ashwin
.           Fix New Booking for Inpatient admission no.
. V9.02.17  04.12.2001  B.G.Ackland
.           Cancel Booking to Update W/L
. V9.02.16  03.12.2001  B.G.Ackland
.           Write Waiting List History
. V9.02.15  28.11.2001  Ashwin
.           Add Equipment Required 3.
. V9.02.14  22.11.2001  Ashwin
.           Change the sequence of display of current status and Fix for theatre
.           case change
. V9.02.13  15.11.2001  Raghunandan Surve, Ashwin - HPS
.           Fixed Confirmd Operation date And date the booking was made
.           Defaulted admission date,time
. V9.02.12  09.11.2001  Ashwin
.           Add Status to the Theatre Case List and Theatre case summary
.           and check for Inpatient Admission Number
. V9.02.11  08.11.2001  Ashwin
.           Default values for Doctor and Unit for Waiting List
.           08/11/2001  Mike Laming
.           Rename DGCLIUPM to DGCLICUP
. V9.02.10  30.10.2001  Raghu Surve -HPS
.           Fixed Case No. Update problem for overbooked Theatres
. V9.02.09  19.10.2001  Raghu Surve -HPS
.           Fixed to give a warning if theatre is overbooked
. V9.02.08  01.10.2001  Ashwin - HPS
.           Add routine for the Unit/Consultant Theatre Search for waiting list
. V9.02.07  14/09/2001  Mike Laming   RCH/SVHM
.           Activate Datagate API (see below V9.02.02)
. V9.02.06  13/09/2001  Rahul Gupta HPS
.           Modified New Booking form to Default Waiting List fields
. V9.02.05  08/09/2001  Kuldeep Singh HPS
.           Redirection check for Waiting list module.
. V9.02.04  08/09/2001  Glenn Saunders
.           Changes keys for reads to patgsrn to reflect enhanced indexes.
. V9.02.03  04/09/2001   B.G.Ackland
.           Fixed for Clinic Access
. V9.02.02  30/08/2001   Ashwin - HPS
.           Fixed for the New Booking for Theatre in ADDBOK00
. V9.02.02  29/08/2001   Mike Laming    RCH/SVHM
.           Add Datagate API for Pre-Admit Booking (DGCLICUB)
. --------- Commented out until theory can be resolved. (30/08/01)
. V9.02.01  24.08.2001 HPSODC
.           Modified for Waiting List Extn.
. V9.01.04  19.08.2001 HPS
.           Modified Full Description field and update booking.
. V9.01.03  16.08.2001 HPS-ODC
.           Modified for CLWATDET for clearing WMCODE
. V9.01.02  14.08.2001 Ashwin - HPS
.           Modified for Ward Description.
. V9.01.01  08.08.2001 Sachin -HPS & J.Tan
.           Added Code in SETPAR00 for Comments
.           Recompiled for PATMASTM.
. V9.00.02  06.08.2001 Ashwin - HPS
.           Added code for clearing file variables in WATTR1FD and BOKREC
. V9.00.01  30.07.2001 HPS
.           Modified for Proj-2001
. V9.00.B04 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 05.06.2001 Dean Cramer
.           New variables in OPRDEAFD
.           31.05.2001 Bronko Sosic
.           Changes as per Spec for OPRWEB01 with waiting lists
.------------------------------------------------------------------------------
.                 V5.10.B05 17.04.2001 Glenn Saunders
.                           Remove references to PATSUR file (old surname file)
.                           Replace WEBCOMN2 with PATCOMN2 (now web-verted)
.                 V5.09.04  22.03.2001 B.G.Ackland
.                           Add Link to Results from Doctors List
.                 V5.09.03  15/01/2001 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.09.02  04/01/2001 Pat Dirito
.                           Recompiled for OPUPDPMI
.                           09.01.2001 Katie Nelson
.                           Added control cache header
.                 V5.08.06  28/09/2000 Bronko Sosic
.                           Recompiled for PATMASTM / PATMISTM
.                 V5.08.05  16/08/2000  Caleb Sharman
.                           Changed Health Fund variables to be 8 chars
.                 V5.08.04  16.06.2000 B.G.Ackland
.                           Change Booking Link
.                 V5.08.02  07.06.2000 B.G.Ackland
.                           Recompiled for PATMASTM
.                 V5.08.01  25/05/2000 Pat Dirito
.                           Recompiled for PATMASTM
.                 V5.07.03  03/04/2000 Bronko Sosic
.                           Removed bgcolour from server
.                 V5.07.02  28/03/2000 Katie Nelson
.                           Brian added CLINCODE and recompiled for includes.
.                 V5.07.01  02/02/2000 Steven Watkins
.                           Recompiled for PATMASTM / PATMISTM
.                 V5.07.00  24.11.1999 Pat Dirito
.                           Recompiled for OPRSESTM
.------------------------------------------------------------
.                 V6.04.01 16.12.1997 B.G.Ackland
.                 V6.04.02 12.01.1998 B.G.Ackland
.                          Change Output Format for Lists
.                 V6.04.03 13.01.1998 B.G.Ackland
.                          Fix Error on Suspension of Session
.                 V6.04.04 13.01.1998 B.G.Ackland
.                          Fix Suspension of Session
.                 V6.04.05 13.02.1998 B.G.Ackland
.                          Fix Check on Usage for Cancel and Change
.                 V6.04.06 23.03.1998 B.G.Ackland
.                          New Template Body Processing
.                 V6.04.07 01.01.1998 B.G.Ackland
.                          New Standard Includes
.                 V6.04.08 22.04.1998 B.G.Ackland
.                          Open Previous Address File
.                 V6.04.09 02.07.1998 K.C.Nelson
.                          Modified code to standard web server program.
.
.------------------------------------------------------------
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       FHRDATDF
.
          INC       IBAPOLFD/INC
          INC       APSMASFD/INC
          INC       ACCDIAFD/INC
          INC       EMRICDFD/INC
          INC       WATTX1TD/INC
          INC       BOKBUDFD/INC
          INC       BOKDIAFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       MEHVI1FD/INC
          INC       BOKRX1TD/INC
          INC       BOKRQ1FD/INC
          INC       BOKRQ1TD/INC
          INC       BOKRAUFD/INC
          INC       CATCOMFD/INC
          INC       COMDEPFD/INC
          INC       COMERHFD/INC
          INC       EMRVISFD/INC
          INC       IBALPCFD/INC   * Print file for labels and forms
          INC       MEHLERFD/INC
          INC       MLTHCPFD/INC
          INC       MRTMASFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       NZPSPRTD/INC
          INC       NZPSPRFD/INC
          INC       OPR001FD/INC
          INC       OPRABIFD/INC
          INC       OPRABITD/INC
          INC       OPRARDTD/INC
          INC       OPRAVEFD/INC
          INC       OPRARDFD/INC
          INC       OPRCBDFD/INC 
          INC       OPRCLIFD/INC     * Added for OPRSESTN Recompile
          INC       OPRCONFD/INC
          INC       OPRCOMFD/INC                                       *I-50678
          INC       OPRCPIFD/INC
          INC       OPRCPITD/INC
          INC       OPRDEAFD/INC
          INC       OPRDEBFD/INC
          INC       OPRDECFD/INC
          INC       OPRDEDFD/INC
          INC       OPRDPHFD/INC
          INC       OPREXPFD/INC
          INC       OPRHISFD/INC
          INC       OPRITEFD/INC
          INC       OPRNURFD/INC
          INC       OPROPRFD/INC
          INC       OPRPMBFD/INC
          INC       OPRPOCFD/INC
          INC       OPRPOCTD/INC
          INC       OPRPRFFD/INC
          INC       OPRRALFD/INC
          INC       OPRRCIFD/INC
          INC       OPRREQFD/INC
          INC       OPRSEMFD/INC
          INC       OPRSESFD/INC
          INC       OPRSESTD/INC
          INC       OPRSRGFD/INC
          INC       OPRTQEFD/INC
          INC       OPRWCNFD/INC
          INC       BOKUNQFD/INC
          INC       OPRSRGTD/INC
          INC       OPRTSMFD/INC
          INC       OPRTRAFD/INC
          INC       OPRTPSFD/INC
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATAM1FD/INC
          INC       PATASFFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATBMDFD/INC
          INC       PATCALAG/INC
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATDADFD/INC
          INC       PATDGWFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC                                     *T0845646
          INC       PATELGFD/INC                                     *T0845646
          INC       PATFN1FD/INC
          INC       PATGSRFD/INC
          INC       PATHSPFD/INC
          INC       PATICOFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATLOCFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATMMBFD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATPA1FD/INC
          INC       PATPNIFD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATRGMFD/INC
          INC       PATTRNFD/INC
          INC       PATUNAFD/INC
          INC       PATURAFD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PMSALNFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCEXFD/INC
          INC       PMSCCDFD/INC
          INC       PMSCURFD/INC
          INC       PMSELFFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSMTIFD/INC            * Misc.theatre item table
          INC       PMSNUTFD/INC
          INC       PMSOECFD/INC
          INC       PMSOECTD/INC
          INC       PMSOESFD/INC
          INC       PMSOESTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSREGFD/INC
          INC       PMSRFLFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSVX1FD/INC
          INC       PMSWX1FD/INC
          INC       PMSCTCFD/INC
          INC       PATEORFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWVEFD/INC
          INC       RESLNKFD/INC

          INC       SCRMASFD/INC
          INC       WATCHAFD/INC
          INC       WATHISFD/INC
          INC       WATLETFD/INC
          INC       WATMESFD/INC
          INC       WATOPAFD/INC
          INC       WATPACFD/INC
          INC       WATPROFD/INC
          INC       WATRTDFD/INC
          INC       WATESNFD/INC
          INC       WATESEFD/INC
          INC       WATTR1FD/INC
          INC       WATMHDFD/INC
          INC       WATMTXFD/INC
          INC       WATTX1FD/INC
          INC       WATVWLFD/INC
          INC       WATCONFD/INC
          INC       WEBOECFD/INC
          INC       WEBOESFD/INC
          INC       WEBELFFD/INC
          INC       WEBOECTD/INC
          INC       WEBOESTD/INC
          INC       VISCODFD/INC
          INC       VISCODTD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       OPRAAETD/INC
          INC       OPRAAEFD/INC
          INC       OPRMBSFD/INC
          INC       TFILEVAR/INC
          INC       PATMISTD/INC
.
.
OPCOMFIL  FILE      ASCII,FIXED=128
.
EXPCMTFI  FILE      ASCII,FIXED=128
EXPCMTNM  DIM       8
EXPCMTFL  FORM      1
.
XPCOMFIL  FILE      ASCII,FIXED=128
XPCOMFNM  DIM       8
XPCOMLIN  DIM       70
XPCOMTYP  DIM       3
XPCOMCNT  FORM      3
.
YPCOMFIL  FILE      ASCII,FIXED=128
YPCOMFNM  DIM       8
YPCOMLIN  DIM       70
YPCOMTYP  DIM       3
YPCOMCNT  FORM      3
.
ZPCOMFIL  FILE      ASCII,FIXED=128
ZPCOMFNM  DIM       8
ZPCOMLIN  DIM       70
ZPCOMTYP  DIM       3
ZPCOMCNT  FORM      3
.
TMPREOR1  IFILE SQL, FIXED=22, KEY="U14-21,11-13,1-10"
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TMPUNIQ   DIM       10       10       1        Unique id for theatre booking
TMPCASE   DIM       3        3        11       Original Case Number
TMPSTART  DIM       8        8        14       Start time - based on OPCNFTIM
.
.End of record                         22
.
TMPREOR2  IFILE SQL, FIXED=30, KEY="U1-3,4-11,12-19,20-29"
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TMPFPRIO  DIM       3        3        1        Theatre Requests Priority
TMPFCSDT  DIM       8        8        4        Theatre Requests Clock Start Date
TMPFCSTM  DIM       8        8        12       Theatre Requests Clock Start Time
TMPFREQN  DIM       10       10       20       Theatre Requests Request Number
.
.End of record                        30
.
.
. Temp file for Consultant Name/Code
. ==================================
TMPCIND1  IFILE SQL, FIXED=57, KEY="U1-50,51-56"
.
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TMPFCNAM  DIM        50        50          1   Consultant Name
TMPFCCOD  DIM         6         6         51   Consultant Code
.
.End of record                            57
.
.
. **** old temp table below, no longer used ****
TMPDETA1  IFILE SQL, FIXED=560, KEY="U493-500,501-508,1-8,9-13,14-19,20-20,21-23"
.
. NAME    TYPE   LENGTH  PHYSICAL START LOC.   DESCRIPTION
. ----    ----   ------  -------- ----------   -----------
TMPDATE   DIM       8        8        1        Session Date (CCYYMMDD)
TMPTIME   DIM       5        5        9        Start Time (HH:MM)
TMPCLIN   DIM       6        6        14       Clinic/Surgeon
DTMPSTA   DIM       1        1        20       Booking Status
.                                                0 = Booked
.                                                1 = Preadmitted
.                                                2 = Admitted
.                                                3 = Cancelled
.                                                4 = Discharged
.TMPCASE   DIM       3        3        21       Case Number
TMPADMN   DIM       8        8        24       Admission Number
.
.TMPUNIQ   DIM       10       10       32       Unique id for theatre booking
TMPEXPS   DIM       5        5        42       Expected Start Time
TMPEXPD   FORM      4        3        47       Expected Duration (min)
TMPANAE   DIM       3        3        50       Anaesthetic Code (Cat. OA )
TMPTYPE   DIM       3        3        53       Operation Type   (Cat. OY )
TMPTRAN   DIM       3        3        56       Transport Code   (Cat. OR )
TMPUSR1   DIM       3        3        59       User Defined 1 (Category Y6)
TMPUSR2   DIM       3        3        62                    2 (Category Y7)
TMPUSR3   DIM       3        3        65                    3 (Category Y8)
TMPUSR4   DIM       3        3        68                    4 (Category Y9)
TMPWAIT   DIM       1        1        71       Waiting Lists (Y/N)
TMPPROV   DIM       9        9        72       Provisional item # 1 ( MBS or
.                                              ICD9CM)
TMPPRV2   DIM       9        9        81       Provisional item # 2 ( MBS or
.                                              ICD9CM)
TMPPRV3   DIM       9        9        90       Provisional item # 3 ( MBS or
.                                              ICD9CM)
TMPDES1   DIM       80       80       99      Operation description line 1
TMPDES2   DIM       80       80       179                                2
TMPDES3   DIM       80       80       259                                3
TMPCOMM   DIM       40       40       339       Comments
TMPCANC   DIM       3        3        379      Cancellation Code (Category SC)
TMPTHET   DIM       6        6        382      Operating Room Code
TMPPRE1   DIM       5        5        388      Pre-operative time 1 (HH:MM)
TMPPRE2   DIM       5        5        393      Pre-operative time 2 (HH:MM)
TMPPRE3   DIM       5        5        398      Pre-operative time 3 (HH:MM)
TMPPRE4   DIM       5        5        403      Pre-operative time 4 (HH:MM)
TMPPRE5   DIM       5        5        408      Pre-operative time 5 (HH:MM)
TMPPOS1   DIM       5        5        413      Post-operative time 1 (HH:MM)
TMPPOS2   DIM       5        5        418      Post-operative time 2 (HH:MM)
TMPPOS3   DIM       5        5        423      Post-operative time 3 (HH:MM)
TMPPOS4   DIM       5        5        428      Post-operative time 3 (HH:MM)
TMPTDUR   FORM      4        3        433      Actual duration in theatre (mins)
TMPKNOW   DIM       3        3        436      Known Infection (Category OK)
TMPCDAT   DIM       8        8        439      Cancellation Date
TMPEQR1   DIM       3        3        447      Equipment Required 1(Category XE)
TMPEQR2   DIM       3        3        450      Equipment Required 2(Category XE)
TMPLEQR   DIM       3        3        453      Loan Equip. Required(Category XO)
TMPEQR3   DIM       3        3        456      Equipment Required 3(Category XE)
TMPUNIT   DIM       3        3        459      Specialty/Unit (Category ST)
TMPDURNO  DIM       8        8        462      UR Number
TMPPROC   DIM       9        9        470      WL Procedure Code(watproaf)
TMPCONT   DIM       2        2        479      WL Procedure Count
TMPASRC   DIM       3        3        481      Admission Source
TMPCSST   DIM       1        1        484      Consent Obtained (N=No, Y=Yes)
TMPCSDT   DIM       8        8        485      Consect Changed Date (ccyymmdd)
TMPTIPS   DIM       8        8        493      Prep Start
TMPTISS   DIM       8        8        501      Surgery Start
TMPCRDT   DIM       8        8        509      Date record created (ccyymmdd)
TMPCTIM   DIM       8        8        517      Time record created (hh:mm:ss)
TMPWEBC   DIM       10       10       525      WEB User Id rec.creator(websecaf)
TMPSPAR   DIM       25       25       535      Spare
.
.End of record                        560
.
.Redifined forms for key
.-----------------------
.
TMPSTAT   FORM      1        2        1       Booking Status
.
. LOCAL VARIABLES
. ---------------
.
ACCPORDN  DIM       20
ACTION    DIM       1
ADDWLFLG  FORM      1
ADJSTART  FORM      1   * Check Box
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
CURRDATX  DIM       8
ADJTIME   FORM      5
ADMISNID  DIM       20
ADMISNUM  DIM       8
ALRTLINK  DIM       127                                               *I-200963
ALRTIMGE  DIM       127                                               *I-200963
ALRTIMG2  DIM       127
ALRTIMG3  DIM       127
ALRTIMG4  DIM       127
ALRTIMGT  DIM       250
ANAFNAME  DIM       50
ASSFNAME  DIM       50
ATYPDESC  DIM       25
ANAECODE  DIM       10
ARDATDSC  DIM       24
AUDTREQN  DIM       27
AUTOPREF  DIM       1
.
BARIMAGE  DIM       40
BARWIDTH  FORM      3
BOOKFLAG  FORM      1
BOKRDATE  DIM       24
BOKAUDSC  DIM       40
WAITFLAG  FORM      1
PENDSDAT  DIM       8
PREAFLAG  FORM      1
PROCFLAG  FORM      1
BKREC001  DIM       20       20       17  Surname
BKREC002  DIM       6         6       39  Attending Doctor
BKREC003  DIM       6         6       45  Referring Doctor
BKREC004  DIM       12        8       51  Expected due date (CCYYMMDD)
BKREC005  DIM       8         8       59  Expected assessment time
BKREC006  DIM       12        8       67  Pre-assessment date
BKREC007  DIM       8         8       75  Pre-assessment time
BKREC008  DIM       3         3       91  Booking type (Cat "BK")
BKREC009  DIM       3         3       94  Cancellation reason (Cat "BC")
BKREC010  DIM       1         1       99  Benefit fund member (Y/N/U)
BKREC011  DIM       1         1      100  Previous inpatient (Y/N/U)
BKREC012  DIM       3         3      101  Preferred accommodation (Cat BP)
BKREC013  DIM       9         9      104  Waiting list procedure code
BKREC014  DIM       2         2      113  Waiting list procedure count
BKREC015  DIM       3         3      115  Expected ward
BKREC016  DIM       8         5      118  Maternity admission number
BKREC017  DIM       1         1      123  Deposit paid (Y/N) Matern only
BKREC018  DIM       3         3      124  Expected bed
BKREC019  DIM       3         3      127  Patient Cat./Adm Class. (Cat P)
BKREC020  DIM       3         3      130  Adm Type/Pat. Class (Cat A)
BKREC021  DIM       3         3      133  Department (Cat AC)
BKREC022  DIM       6         6      136  Associated Doctor
BKREC023  DIM       3         3      142  Claim type (Cat CL)
BKREC024  DIM       10        10     145  Referring GP
BKREC025  DIM       6         6      155  GP Practice code
BKREC026  DIM       20        20     161  GPFH Approval Number
BKREC027  DIM       3         3      181  Resident Status (Cat T)
BKREC028  DIM       3         3      184  Elective Admission Type  (Cat CC)
BKREC029  DIM       20        20     187  ECR Approval Number
BKREC030  DIM       2         2      207  GP Practice count
BKREC031  DIM       3         3      209  District of Residence (Cat DA)
BKREC032  DIM       4         4      212  Operator who made I/P Booking
BKREC033  DIM       3         3      216  Expected Length of Stay (Days)
BKREC034  DIM       12        12     219  Booking date (ccyymmdd)
BKREC035  DIM       9          Diagnosis code
BKREC036  DIM       80         Diagnosis description 1
BKREC037  DIM       80         Diagnosis description 2
BKREC038  DIM       80         Booking comments
BOOKDATE  FORM      8
BTYPDESC  DIM       25
BKTHVICK  DIM       8
.
COMLINE1  DIM       99
COMLINE2  DIM       100
CANADMIS  DIM       1   * Cancel Admission
CANCDESC  DIM       20
CASECNT   FORM      3
CASECTR   FORM      3
CASEKEYS  DIM       26
CASEUNIQ  DIM       10
CALDAYS   FORM      8
CENDTME   DIM       5
CHARNUM   FORM      3
CHGSCHED  FORM      1
CHKBLOCK  FORM      1   * Check Box
CHCKOVER  DIM       1
CLINCODE  DIM       6
CLCKSIND  DIM       1
COMMCNT   FORM      3
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
COMFILAP  INIT      "COMADM"
COMNFLAG  FORM      1
CPADM002  DIM       1       * Return to WL
CPADM003  DIM       3       * Removal Reason
CPADM004  DIM       5       * Transfer Source
CPADM008  DIM       8       * Removal Date
CTYPDESC  DIM       25
CURRCASE  FORM      3
CURRDATE  FORM      8
CURRENTA  FORM      1
CURSTATS  DIM       21       * Patient Status Description
.
.
DATE      DIM       8
RQDATDSC  DIM       24
RQDATSTR  DIM       11
CNDATDSC  DIM       24
CNUSRDSC  DIM       30
CSDATDSC  DIM       24
CSDATSTR  DIM       11
CURRDATD  DIM       8                       * Current date           *T0846427
DAYSOPEN  FORM      2
DEADFLAG  FORM      1
DESCUC03  DIM       20
DELETERC  INIT      "DELETE"
DEFTVIEW  DIM       1
DFLTWARD  DIM       3
DIM1A     DIM       1
DIM3      DIM       3
DIM3CNTR  DIM       3
DIM5      DIM       5
DIM8      DIM       8
DIM9      DIM       9
DIM9PRIM  DIM       9
DIM10     DIM       10
DIM15     DIM       15
DIM20     DIM       20
DIM100    DIM       100
DISPSUR   DIM       8                          * Display Saved U/R Number
DISPMUR   DIM       8                          * Display Merged U/R Number
DISPPBOK  FORM      4                    * Display % booked
DISPTEAM  FORM      1
DISPDAYC  FORM      1           *Display Todays theatre comments     *T0846427
DISPSDAT  DIM       20
DISPWKNO  FORM      1           * Display week number on theatre lists
DAYCMCNT  FORM      3           *Current date comment line count     *T0846427
DOBKINDC  DIM       1
DOCTTYPE  DIM       3
DOCTORTP  DIM       3
DOCTSPFC  FORM      1
DSPOECST  DIM       70
DSWOECST  DIM       70
AAEFLAG   FORM      1
.
EREFRLID  DIM       20
EXPDSDTE  DIM       8        * Calculated Expected Discharge Date
EXPDSTME  DIM       5        * Calculated Expected Discharge Time
EMRSTYPE  DIM       1
EMRSINDC  DIM       1
EQUIDES1  DIM       20
EQUIDES2  DIM       20
EQUIDES3  DIM       20
EXTRPROV  DIM       9
EXTRPRV2  DIM       9
EXTRPRV3  DIM       9
EXTRPRV4  DIM       9
EXTRPRV5  DIM       9
.
EXTIM001  DIM       8
.
FRSTADOC  DIM       6
FRATR010  DIM       3
F2A       FORM      2
FNAMEA    DIM       8
FNAMEB    DIM       8
FNAMEC    DIM       8
FFOECIND  DIM       1
FOUNDCNT  FORM      1
FILHIGH   FORM      3
FILHIGHT  DIM       12
FILWIDTH  DIM       10
FILTLOCN  DIM       3
FILTPRIO  DIM       3
FILTSTAT  DIM       1
FILTSETY  DIM       1
FIRSTBOK  DIM       1
FOLDERSF  DIM       3                       * Folder Icon Suffix
FORM3A    FORM      3
FORM4D    FORM      4
FORM5     FORM      5
FORM10    FORM      10
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
FRMTDATE  DIM       12
FROMWAIT  DIM       1
.
HAATR010  DIM       3
HBWAIT    FORM      1          * S27/P46 - Waiting Lists (1=ON,  2=OFF)BOKCONFD
HOUR      DIM       2
HYPHEN    INIT      "-"
.
IIATR010  DIM       3
INVADMNO  DIM       8
JREGFORM  DIM       2
KEY26A    DIM       26
KEY3A     DIM       3
.
LOCATION  DIM       3
LOSDINDC  FORM      1
LOOPCNTR  FORM      1
LINKTYPE  FORM      1
LINKVIST  DIM       8
LSTCASE   FORM      3
LABELTYP  DIM       11
LASTITEM  FORM      3
LOCNDESC  DIM       50
.
MBSDESC   DIM       40
MIN       DIM       2
MVTOCASE  DIM       3
MRGEFLAG  FORM      1
.
NEWADMN   DIM       8
NEWEXDAT  DIM       8        * NEW Expected Due Time
NEWEXTIM  DIM       8        * NEW Expected Due Time
NEWSESSI  DIM       22
NEXTLINK  DIM       227
NEXTPAGE  FORM      3
NMPNUMB   DIM       20
NOBKDES2  DIM       1
NODAYS    FORM      5
NOOFDAYS  FORM      3
NBRDAYS   FORM      4
NOTEFILT  DIM       3
NOTEORDR  FORM      1
NEWBOKRQ  DIM       1
.
OECMINDC  DIM       1
OECWINDC  FORM      1
ONCLNKIN  DIM       1
OLDADATE  DIM       8
ORIGEDAT  DIM       8
OPCOMCNT  FORM      3
OPCOMFNM  DIM       8
OPCOMLIN  DIM       70
OPCOMTYP  DIM       3
OLDADMN   DIM       8
OLDUNIQ   DIM       10
OPDEA001  DIM       5       * Expected Start Time
OPDEA002  DIM       10      * Expected Duration (min)
OPDEA003  DIM       3       * Anaesthetic Code (Cat. OA )
OPDEA004  DIM       3       * Operation Type   (Cat. OY )
OPDEA005  DIM       3       * Transport Code   (Cat. OR )
OPDEA006  DIM       3       * User Defined 1 (Category Y6)
OPDEA007  DIM       3       *              2 (Category Y7)
OPDEA008  DIM       3       *              3 (Category Y8)
OPDEA009  DIM       3       *              4 (Category Y9)
OPDEA010  DIM       1       * Waiting Lists (Y/N)
OPDEA011  DIM       9       * Provisional item # 1 ( MBS or
OPDEA012  DIM       9       * Provisional item # 2 ( MBS or
OPDEA013  DIM       9       * Provisional item # 3 ( MBS or
OPDEA014  DIM       80      * Operation description line 1
OPDEA015  DIM       80      *                           2
OPDEA016  DIM       80      *                           3
OPDEA017  DIM       40      * Comments
OPDEA018  DIM       3       * Cancellation Code (Category SC)
OPDEA019  DIM       6       * Operating Room Code
OPDEA020  DIM       5       * Pre-operative time 1 (HH:MM)
OPDEA021  DIM       5       * Pre-operative time 2 (HH:MM)
OPDEA022  DIM       5       * Pre-operative time 3 (HH:MM)
OPDEA023  DIM       5       * Pre-operative time 4 (HH:MM)
OPDEA024  DIM       5       * Pre-operative time 5 (HH:MM)
OPDEA025  DIM       5       * Post-operative time 1 (HH:MM)
OPDEA026  DIM       5       * Post-operative time 2 (HH:MM)
OPDEA027  DIM       5       * Post-operative time 3 (HH:MM)
OPDEA028  DIM       5       * Post-operative time 3 (HH:MM)
OPDEA029  DIM       10      * Actual duration in theatre (mins)
OPDEA030  DIM       3       * Known Infection (Category OK)
OPDEA031  DIM       8       * Cancellation Date
OPDEA032  DIM       3       * Equipment Required 1(Category XE)
OPDEA033  DIM       3       * Equipment Required 2(Category XE)
OPDEA034  DIM       3       * Loan Equip. Required(Category XO)
OPDEA035  DIM       3       * Equipment Required 3(Category XE)
OPDEA036  DIM       3       * Specialty/Unit (Category ST)
OPDEA037  DIM       3       * Admission Source
OPDEA038  DIM       1       * Consent Obtained (N=No Y=Yes)
OPDEA039  DIM       11      * Consent Changed Date
OPDEA040  DIM       8       * Fasting Time
OPDEA041  DIM       1       * Adm Paperwork received
OPDEA042  DIM       1       * Medical History Received
OPDEA043  DIM       1       * Prosthetic Items Complete
OPDEA044  DIM       80      * Operation description line 4
OPDEA045  DIM       80      * Operation description line 5
OPDEA046  DIM       80      * Operation description line 6
OPDEA047  DIM       11      * Fasting Date Food (CCYYMMDD)
OPDEA048  DIM       11      * Fasting Date Fluid (CCYYMMDD)
OPDEA049  DIM       9       * Provisional Item # 4 (MBS or
OPDEA050  DIM       9       * Provisional Item # 5 (MBS or
OPDEA051  DIM       9       * Provisional Item # 6 (MBS or 
.
OLDEXPD   FORM      4
OPERANAE  DIM       3       * Anaesthetic Code (Cat. OA )
OPERCANC  DIM       3       * Cancellation Code (Category SC)
OPERCOMM  DIM       40      * Comments
OPERDES1  DIM       80      * Operation description line 1
OPERDES2  DIM       80      *                            2
OPERDES3  DIM       80      *                            3
OPERDES4  DIM       80      *                            4
OPERDES5  DIM       80      *                            5
OPERDES6  DIM       80      *                            6
OPEREXPD  FORM      4       * Expected Duration (min)
OPERKNOW  DIM       3       * Known Infection (Category OK)
OPERPLOS  DIM       1       * Planned Length of Stay
OPERPREF  DIM       15      * Doctors Operation Preference
OPERPRV1  DIM       9       * Provisional item # 1 ( MBS or ICD9)
OPERPRV2  DIM       9       * Provisional item # 2 ( MBS or ICD9)
OPERPRV3  DIM       9       * Provisional item # 3 ( MBS or ICD9)
OPERPRV4  DIM       9       * Provisional item # 4 ( MBS or ICD9)
OPERPRV5  DIM       9       * Provisional item # 5 ( MBS or ICD9)
OPERPRV6  DIM       9       * Provisional item # 6 ( MBS or ICD9)
OPERPRV7  DIM       9       * Provisional item # 7 ( MBS or ICD9)
OPERPRV8  DIM       9       * Provisional item # 8 ( MBS or ICD9)
OPERPRV9  DIM       9       * Provisional item # 9 ( MBS or ICD9)
OPERPR10  DIM       9       * Provisional item # 10( MBS or ICD9)
OPERPR11  DIM       9       * Provisional item # 11( MBS or ICD9)
OPERPR12  DIM       9       * Provisional item # 12( MBS or ICD9)
OPERPR13  DIM       9       * Provisional item # 13( MBS or ICD9)
OPERPR14  DIM       9       * Provisional item # 14( MBS or ICD9)
OPERPR15  DIM       9       * Provisional item # 15( MBS or ICD9)
OPERPR16  DIM       9       * Provisional item # 16( MBS or ICD9)
OPERPR17  DIM       9       * Provisional item # 17( MBS or ICD9)
OPERPR18  DIM       9       * Provisional item # 18( MBS or ICD9)
OPERPR19  DIM       9       * Provisional item # 19( MBS or ICD9)
OPERPR20  DIM       9       * Provisional item # 20( MBS or ICD9)
OPERPR21  DIM       9       * Provisional item # 21( MBS or ICD9)
OPERPR22  DIM       9       * Provisional item # 22( MBS or ICD9)
OPERPR23  DIM       9       * Provisional item # 23( MBS or ICD9)
OPERPR24  DIM       9       * Provisional item # 24( MBS or ICD9)
OPERPR25  DIM       9       * Provisional item # 25( MBS or ICD9)
OPERPR26  DIM       9       * Provisional item # 26( MBS or ICD9)
OPERPR27  DIM       9       * Provisional item # 27( MBS or ICD9)
OPERPR28  DIM       9       * Provisional item # 28( MBS or ICD9)
OPERPR29  DIM       9       * Provisional item # 29( MBS or ICD9)
OPERPR30  DIM       9       * Provisional item # 30( MBS or ICD9)
.
OPERTHET  DIM       6       * Operating Room Code
OPERTRAN  DIM       3       * Transport Code   (Cat. OR )
OPERTYPE  DIM       3       * Operation Type   (Cat. OY )
OPERUSR1  DIM       3       * User Defined 1 (Category Y6)
OPERUSR2  DIM       3       *              2 (Category Y7)
OPERUSR3  DIM       3       *              3 (Category Y8)
OPERUSR4  DIM       3       *              4 (Category Y9)
OPHIS001  DIM       3                    * Transfer Reason(HPSI)
ORIGCANC  DIM       3        * Saved original theatre cancellation reason
OPRWEBSR  FORM      1        * Set to 1 for OPRWEB01, used in OPRSESTM as
.                            * OPRWEB01 uses doctor/surgeon & and OPRWEB05
.                            * may use Clinic Code.
OPTSFDAT  DIM       11
OPPTDESC  DIM       18                      * staff type
STAFFNAM  DIM       50                      * staff name
OPTDESC0  INIT      "Operating Surgeon"
OPTDESC1  INIT      "Doctor"
OPTDESC2  INIT      "Nurse"
OPTDESC3  INIT      "Other"
.
SAVFPRIM  DIM       9
SHOWVIEW  DIM       5       * Show view cgi for expanding theatre view
.
PACAFLAG  DIM       4       * Menuflag
PTMSX003  DIM       4
PATADDR1  DIM       25      * Address Line 1
PATADDR2  DIM       25      * Address Line 2
PATADDR3  DIM       15      * Address Line 3
PATADMDT  DIM       8       * Date of Admission
PATBIRDT  DIM       11      * Date of Birth DD MMM YYYY
PATBUSPH  DIM       12      * Phone Business
PATCANAD  DIM       3   * Reason for Admission Cancellation
PATCANTH  DIM       3   * Reason for Theatre Cancellation
PATCLAIM  DIM       3       * Claim Code
PATCOBIR  DIM       3       * Country of Birth
PATGENDE  DIM       1       * Gender M or F
PATGNAME  DIM       25      * Given Name
PATHFUND  DIM       6       * Health Fund
PATHOMPH  DIM       12      * Phone Private
PATMEDIC  DIM       10      * Medicare Number
PATMSTAT  DIM       3       * Marital Status
PATOCCUP  DIM       14      * Occupation
PATPAYOR  DIM       9       * Payor (Health Fund 6, Claim Code 3)
PATPENEX  DIM       4       * Pension Expiry
PATPENSI  DIM       15      * Pension Number
PATPOSTC  DIM       4       * Post Code
PATRELIG  DIM       3       * Religon
PATRSTAT  DIM       3       * Resident Status
PATSNAME  DIM       20      * Surname
PATTITLE  DIM       4       * Title
PERSBOOK  FORM      4.2                  * % Booked
PPATR006  DIM       6
PREAD002  DIM       1       * Cancel preadmission
PREAD003  DIM       3       * Preadmission cancellation reason
PRIODESC  DIM       20
PRIOASSN  FORM      6
PRIOASC1  DIM       6
PRIOASSD  DIM       6
PRIOCNTR  FORM      3
PRIOCNTD  DIM       3
PRIOHEQV  DIM       4
PRATR010  DIM       3
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PTELG014  DIM       1       * Subject to Pre-Existing Ailment
PTELG033  DIM       1       * Emergency Admission (1=Yes)
PTMIS001  DIM       8       * Patient Admission Date (adate)
PTMIS002  DIM       8       * Patient Admission Time (atime)
PTMIS013  DIM       6       * Admission health fund (afundh)
PTMIS014  DIM       8       * Admission health fund table (afndtb)
PTMIS015  DIM       19      * Admission health fund Membership No (afndmm)
PTMIS020  DIM       50      * Admitting Diagnoses line 1 (adiag1)
PTMIS027  DIM       3       * Claim Code (Cat CL) (aclaim)
PTMIS030  DIM       3       * Expected length of Stay (astay)
PTVIS043  DIM       3       * Intend Stay of Duration (pmvxidus)
PTVIS076  DIM       3       * Discharge Intention Cat KN (pmvxudin)
PTVIS079  DIM       3       * Unplanned Visit To Theatre
PTVIS111  DIM       3       * Presenting Illness Code Cat il OEC
PTHVFLAG  FORM      1
.
PTRGM001  DIM       10
PTRGM002  DIM       10
PTRGM003  DIM       10
.
.  Free Format OEC cgi variables
.
PTELF001  DIM       8      * U/R Number
PTELF002  DIM       1      * Patient OEC Consent
PTELF003  DIM       4      * Title
PTELF004  DIM       40     * Patient First Name
PTELF005  DIM       40     * Patient Second Name
PTELF006  DIM       40     * Health Fund Given Name
PTELF007  DIM       40     * Health Fund Surname
PTELF008  DIM       1      * Gender
PTELF009  DIM       8      * Date of Birth
PTELF010  DIM       8      * Expected Admission Date
PTELF011  DIM       3      * Intended Stay
PTELF012  DIM       3      * Planned LOS
PTELF013  DIM       3      * Discharge Intention
PTELF014  DIM       1      * PEA Indicator
PTELF015  DIM       1      * Emergency Admission
PTELF016  DIM       3      * Presenting Illness Code
PTELF017  DIM       9      * Presenting Illness MBS
PTELF018  DIM       3      * Claim Type
PTELF019  DIM       6      * Health Fund
PTELF020  DIM       8      * Health Fund Table
PTELF021  DIM       19     * Health Fund Membership Number
PTELF022  DIM       50     * Diagnosis
PTELF023  DIM       9      * Service Code 1
PTELF024  DIM       9      * Service Code 2
PTELF025  DIM       9      * Service Code 3
PTELF026  DIM       9      * Service Code 4
PTELF027  DIM       9      * Service Code 5
.
PTELF028  DIM       3      * Service Code Quantity 1
PTELF029  DIM       3      * Service Code Quantity 2
PTELF030  DIM       3      * Service Code Quantity 3
PTELF031  DIM       3      * Service Code Quantity 4
PTELF032  DIM       3      * Service Code Quantity 5
.
PTELF033  DIM       10     * Repatriation Number
PTELF034  DIM       1      * Gender
.
REASFC06  DIM       3
REASFC08  DIM       3
ROWCLASS  DIM       20
REQUESTN  DIM       10
.
SAVEANUR  DIM       6
SAVECLIN  DIM       6       * clinic / surgeon save variable    
SAVELINE  FORM      3       * line number save variable         
SAVETEXT  DIM       70      * text save variable                
SAVEHOSP  DIM       3       * Hospital
.
SKEY9     DIM       9
SKEY14    DIM       14
SKEY16    DIM       16
SAVANAE   DIM       3
SAVASRC   DIM       3
SAVASTA   DIM       1
SAVBOKNO  DIM       8
SAVCANC   DIM       3
SAVCASE   DIM       3
SAVCCAS   DIM       3
SAVCLIN   DIM       6
SAVCODE   DIM       3
SAVCOMM   DIM       40
SAVCSTA   DIM       1
SAVCSST   DIM       1
SAVCSDT   DIM       8
SAVDATE   DIM       8
SAVDES1   DIM       80
SAVDES2   DIM       80
SAVDES3   DIM       80
SAVDIM3   DIM       3
SAVEADMN  DIM       8
SAVEBRQN  DIM       8
SAVECASE  DIM       3
SAVEPREV  DIM       9
SAVEDATE  DIM       8
SAVEEXPD  FORM      4
SAVETIME  DIM       5
SAVELOSM  DIM       5
SAVELOSD  DIM       3
SAVEQR1   DIM       3
SAVEQR2   DIM       3
SAVEQR3   DIM       3
SAVEVDT   DIM       8
SAVEXPS   DIM       5
SAVEURNO  DIM       8
SAVKEY11  DIM       11
SAVKEY16  DIM       16
SAVKEY18  DIM       18
SAVKEY19  DIM       19
SAVKEY20  DIM       20
SAVKEY22  DIM       22
SAVKEY23  DIM       23
SAVKEY26  DIM       26
SAVKNOW   DIM       3
SAVLEQR   DIM       3
SAVOCDAT  DIM       8
SAVPOS1   DIM       5
SAVPOS2   DIM       5
SAVPOS3   DIM       5
SAVPOS4   DIM       5
SAVPRE1   DIM       5
SAVPRE2   DIM       5
SAVPRE3   DIM       5
SAVPRE4   DIM       5
SAVPRE5   DIM       5
SAVPRV1   DIM       9
SAVPRV2   DIM       9
SAVPRV3   DIM       9
SAVPOWD   DIM       3
SAVTYPP   DIM       3
SAVTYCL   DIM       3
SAVDTFF   DIM       8
SAVDTFL   DIM       8
SAVPRV4   DIM       9
SAVPRV5   DIM       9
SAVPRV6   DIM       9
SAVOHOSP  DIM       3
.
.
SAVSESS   DIM       22
SAVSTAT   FORM      1
SAVTDUR   FORM      4
SAVTHET   DIM       6
SAVTIME   DIM       5
SAVTRAN   DIM       3
SAVTYPE   DIM       3
SAVUNIQ   DIM       10
SAVUNIT   DIM       3
SAVURNO   DIM       8
SAVPROC   DIM       9
SAVCONT   DIM       2
SAVCRDT   DIM       8
SAVCTIM   DIM       8
SAVWEBC   DIM       10
SAVUDAT   DIM       8
SAVUTIM   DIM       8
SAVWEBU   DIM       10
SAVUSR1   DIM       3
SAVUSR2   DIM       3
SAVUSR3   DIM       3
SAVUSR4   DIM       3
SAVWAIT   DIM       1
SAVTXWRD  DIM       3
.
SAVPCOM   DIM       1
SAVVUN1   DIM       10
SAVVUN2   DIM       10
SAVPHMN   DIM       10
SAVREQN   DIM       10
SAVDES4   DIM       80
SAVDES5   DIM       80
SAVDES6   DIM       80
SAVFAST   DIM       8
SAVAPRC   DIM       1
SAVMHRC   DIM       1
.
SCHDPRNT  DIM       6
SCHDCOPY  FORM      3       * No of Copies
SESSDATE  DIM       10    Session Date
SESSFILL  FORM      3.1   Fill Percentage for Session
SESSKEYS  DIM       22
SESSTIME  DIM       5       * Session Start Time
SHOCNSNT  FORM      1
SHOOPDES  FORM      1
SHOWBLRQ  FORM      1
SHOWRBAY  FORM      1
SHOWPLOS  FORM      1
SHOWSURG  FORM      1
SHOWDAYD  FORM      1
SHOWDISB  FORM      1
SHOWENQY  FORM      1
SHOWFLAG  FORM      1
SHOWREFD  FORM      1
SRGEXIST  FORM      1
STARTIME  DIM       5
STATNCOD  DIM       6
STYPDES   DIM       25
TUTYPDES  DIM       25
STRTTIME  DIM       8
SUBSYSKY  DIM       50
SUPRLEVL  DIM       1     * Update Type
SUPERLEV  DIM       1     * Supervisor
SURFNAME  DIM       50
SVMPFLAG  DIM       1     * Is site svmp? (1=yes, 0=no)
.
TABLVIEW  DIM       1
TADTTYPE  DIM       3  * Theatre Audit type
TEAMNUMB  DIM       1
TEMPCNTR  FORM      3
TEMPCNT1  FORM      3
TEMPCND1  DIM       3
TESTDATE  DIM       8
THETDATE  DIM       11
THETTIME  DIM       5
THETFLAG  FORM      1
THETOPER  DIM       6
THETSTAT  DIM       30
THETARRD  DIM       8
THETARRT  DIM       8
THETCOMP  DIM       8
THETRQIN  DIM       1
THETRQVL  DIM       6
THISCAS   FORM      3
THRQBKTY  DIM       3
TILDA40   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
TIME      DIM       5
TIMELEFT  FORM      5
TOTALCOM  FORM      3     Comment count. Multi->Single comment conversion
TRANREAS  DIM       3
TRNSCODE  DIM       5                       * transfer source code
TRNSDATE  DIM       8                       * transfer source date
TRNSFSRC  DIM       5                * cgi param for Transfer Source
TFRSRCE   DIM       5                * temporary Transfer Source code variable
.
UPDATATR  DIM       1
UPDOPCPI  DIM       1
UPDOPABI  DIM       1
UPCANBOK  FORM      1
UPDATEBK  DIM       1
UPDATEDA  FORM      1
UPDATEDB  FORM      1
UPDATEDC  FORM      1
UPDATEDD  FORM      1
UPDATEDE  FORM      1
UPDATEDF  FORM      1
UPDATEDG  FORM      1
UPDATEDH  FORM      1
UPDATEDI  FORM      1
UPDTTYPE  DIM       1     * Update Type
UPDATDOC  FORM      1
UPDFLD06  DIM       3
UPDFLD08  DIM       3
UPDVALRQ  DIM       40
UPPBRAUB  DIM       1
.UVTHINDI  DIM       1
URCHKDGT  FORM      4
URWTARAY  INIT      "234567"
URNLNGTH  FORM      2
URCHKPRD  FORM      2
URNOWGHT  FORM      1
USEINVAD  FORM      1
USEWATMT  FORM      1      * Using new watmhdaf+watmtxaf tables?
UNITDESC  DIM       20
USERDF01  DIM       100
USERDF02  DIM       100
USERDF03  DIM       100
USERDF04  DIM       100
USERDF05  DIM       100
USERDF06  DIM       100
USERDF07  DIM       100
USERDF08  DIM       100
USERDF09  DIM       100
USERDF10  DIM       100
.
VALDCODE  DIM       127
VALDEDAT  DIM       8
VALDURNO  DIM       8
VALDUNIQ  DIM       10
VISDHOSP  DIM       50
VISFOUND  FORM      1
.
WATHI002  DIM       8      * Date of change
WATTR001  DIM       9       9         9   Procedure Code
WATTR002  DIM       5       **       20   Procedure Time (Minutes)
WATTR003  DIM       50     50        24   Procedure Description
WATTR004  DIM       40     40        74   Reason/Diagnosis for Procedure
WATTR005  DIM       1       1       114   Procedure Status
WATTR006  DIM       12      8       115   Date on List (ccyymmdd)
WATTR007  DIM       12      8       123   Date of Last Review (ccyymmdd) /
WATTR008  DIM       12      8       131   Scheduled Admit. Date (ccyymmdd)
WATTR009  DIM       12      8       139   Removal Date (ccyymmdd)
WATTR010  DIM       3       3       147   Removal Reason (Category WR/BC)
WATTR011  DIM       3       3       150   Unit/Clinic (Category WU)
WATTR012  DIM       6       6       153   Attending Doctor
WATTR013  DIM       5       **      159   Estimated Stay (Days)
WATTR014  DIM       3       3       163   Priority (Category TP)
WATTR015  DIM       3       3       166   Short Notice (Category WS)
WATTR016  DIM       3       3       169   Resident Status (Category T)
WATTR017  DIM       3       3       172   Cat "A"  - dunno what desc is ????
WATTR018  DIM       3       3       175   User Defined 1 (Category W1)
WATTR019  DIM       3       3       178   User Defined 2 (Category W2)
WATTR020  DIM       3       3       181   User Defined 3 (Category W3)
WATTR021  DIM       3       3       184   User Defined 4 (Category W4)
WATTR022  DIM       12      8       202   Re-Assessment Date (ccyymmdd)
WATTR023  DIM       12      8       210   Deferred or Staged Adm Date
WATTR024  DIM       3       3       224   Patient Cat/Adm Class (Cat P)
WATTR025  DIM       12      8       227   Decision to Admit Date
WATTR026  DIM       3       3       235   Administrative Category  "CL"
WATTR027  DIM       12      8       238   Guaranteed Admission Date
WATTR028  DIM       12      8       246   Do Not Admit Before Date
WATTR029  DIM       3       3       254   Elective Admission Type  "CC"
WATTR030  DIM       3       3       257   Admission Category   "WA"
WATTR031  DIM       20      20      260   ECR Approval Number
WATTR032  DIM       20      20      280   GPFH Approval Number
WATTR033  DIM       8       8       300   Referring GP
WATTR034  DIM       6       6       308   GP Practice code
WATTR035  DIM       2       2       330   GP Practice count
WATTR036  DIM       3       3       332   District of Residence (Cat DA)
WATTR037  DIM       4       4       335   Operator who added proc to W/L
WATTR038  DIM       3       3       339   Intended Hospital (pathspaf)
WATTR039  DIM       1       1       342   Validation Letter Sent Flag (Y/N)
WATTR040  DIM       9       9       343   Procedure Code 2
WATTR041  DIM       9       9       352   Procedure Code 3
WATTR042  DIM       12      8       361   Prev Dec. to Admit Date (Tert. Ref)
WATTR043  DIM       3       3       369   User Defined 5 (Category X5)
WATTR044  DIM       3       3       372   User Defined 6 (Category X6)
WATTR045  DIM       3       3       375   User Defined 7 (Category X7)
WATTR046  DIM       3       3       378   User Defined 8 (Category X8)
WATTR047  DIM       6       6       381   Patient Rank
WATTR048  DIM       3       3       387   Source of Referral (S)
WATTRKEY  DIM       19
.
PREVPSTM  DIM       8
PREVSSTM  DIM       8
.
OPTHVISN  DIM       8        * Visit number used by OPTHCMPL proc call
OPTHRICM  DIM       3        * Reason Incomplete used by OPTHCMPL proc call
.
VSTXUNIQ  FORM      3
QRYDATA1  DIM       240
.
.
. PROGRAM CONSTANTS
. -----------------
CODEST    INIT      "ST"
CODETU    INIT      "TU"
DELESN    INIT      "DELETE"
SAVEALIA  FORM      "0"
STAPRFIX  INIT      "RIP - " * Prefix for Patient Status
.
CATOC     INIT      "oc"
CATCT     INIT      "ct"
CATrp     INIT      "rp"
CATT      INIT      "T "
CATAC     INIT      "AC"
CATFS     INIT      "FS"
CATPV     INIT      "PV"
CATTC     INIT      "tc"
OADESC    DIM       25
REPUNIQ   INIT      "yzxywxvwuvtustrsqrpqopnomnlmkljkijhighfgefdecdbcab"
BOKAUDS1  INIT      "Add"
BOKAUDS2  INIT      "Update"
BOKAUDS3  INIT      "Deleted Request"
BOKAUDS4  INIT      "Booked/Scheduled"
BOKAUDS5  INIT      "Cancelled Scheduled Bookings"
BOKAUDS6  INIT      "Allocated UR"
BOKAUDS7  INIT      "Clock Start Updated"
BOKAUDS8  INIT      "Approved"
CORSP001  DIM       100
CORSP003  DIM       3
MAGNETSS  DIM       10
LOOPDAYS  FORM      3
.
DIM30     DIM       30
OYDESC    DIM       20
STDESC    DIM       20
SURGNAME  DIM       30
SURGNAM1  DIM       50
ANAENAME  DIM       30
.FHRDASH   INIT      "-"
.FHRPATID  DIM       8
FHRAPPID  DIM       26
FHRSUBIN  FORM      1      * _include=Appointment:subject
FHRLOCIN  FORM      1      * _include=Appointment:location
FHRPARIN  FORM      1      * _include=Appointment:participant
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.FHRSTAT   DIM       15
SESSFLAG  FORM      1
DIM6      DIM       6
.
ENDDWEEK  DATE      8
ROTATION  FORM      2
STRTWEEK  DATE      8
WEEKCYCL  DIM       10
WEEKNUMB  FORM      3
.
.***********************************************************************
PRGID     INIT      "OPRWEB01"
PRGNAM    INIT      "Theatre Information Server"
VERSION   INIT      "V12.01.00"
.***********************************************************************
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
          CALL      IBACLOCK
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100,MAIN3200,MAIN3300,MAIN3400,MAIN3500:
                             MAIN3600
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      ANALST00   * Session List by Anaesthetist
          GOTO      MAIN1000
.
MAIN1200  CALL      SESLST00   * Session List by Doctor
          GOTO      MAIN1000
.
MAIN1300  CALL      CASLST00   * Case List for a Session
          GOTO      MAIN1000
.
MAIN1400  CALL      CASITM00   * Case Details
          GOTO      MAIN1000
.
MAIN1500  CALL      CASUPD00
          BRANCH    EXIT,MAIN1000
..          CALL      WINCLS00
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      CONUPD00    * Tracking Map View Condition Update
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      ADDMED00    * Add Medical Booking
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      CASCAN00    * Show Booking Cancelation Form
          GOTO      MAIN1000
.
MAIN1900  CALL      NEWBOK00    * Show New Booking Form
          GOTO      MAIN1000
.
MAIN2000  CALL      ADDBOK00    * Post New Booking Details
          GOTO      MAIN1000
.
MAIN2100  CALL      EDTBOK00    * Edit Booking Details
          GOTO      MAIN1000
.
MAIN2200  CALL      POSEDT00
          BRANCH    EXIT,MAIN1000
          MATCH     SP70,UPDATEBK
          IF        !@EQUAL
            CALL     RSAVED00
...         IF       NEXTPAGE=8
...           CALL     NXTPAG00
...         ENDIF
            GOTO     MAIN1000
          ENDIF
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      POSCAN00    * Post Cancel theatre case
          GOTO      MAIN1000
.
MAIN2400  CALL      SHWCAS00
          GOTO      MAIN1000
.
MAIN2500  CALL      SESMOV00
          BRANCH    EXIT,MAIN1000
          COMPARE   "1",NEXTPAGE
          IF        @EQUAL
            CLEAR     REDIRECT
            APPEND    "oprweb06.pbl?reportno=12&template=001&casekeys=",REDIRECT
            REP       " +",CASEKEYS
            APPEND    CASEKEYS,REDIRECT
            REP       "+ ",CASEKEYS
            RESET     REDIRECT
            CALL      NXTPAG00
            GOTO      MAIN1000
          ENDIF
          IF        NEXTPAGE=6
            CALL      NXTPAG00
            GOTO      MAIN1000
          ENDIF
          REP       " +",CASEKEYS
          CLEAR     HTMLLINK
          APPEND    "oprweb01.pbl?reportno=4&template=001&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          RESET     HTMLLINK
          CALL      WINRDT00
          GOTO      MAIN1000
.
MAIN2600  CALL      CASMOV00
          MOVE      CASEKEYS,SESSKEYS
.
          CLEAR     REDIRECT
          APPEND    "oprweb01.pbl?reportno=3&template=",REDIRECT
          APPEND    TEMPLATE,REDIRECT
          APPEND    "&sesskeys=",REDIRECT
          APPEND    SESSKEYS,REDIRECT
          RESET     REDIRECT
.
          CALL      RDIREC00
          GOTO      MAIN1000
.
MAIN2700  CALL      VALITM00
          GOTO      MAIN1000
.
MAIN2800  CALL      REBOOK00
          GOTO      MAIN1000
.
MAIN2900  CALL      ADJTME00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      VALVIS00
          GOTO      MAIN1000
.
MAIN3100  CALL      REOCS000
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3200  CALL      THRQ0000
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3300  CALL      VALCRO00      * Validate if session case reorder required
          GOTO      MAIN1000
.
MAIN3400  CALL      UPFST000      * Update Fasting Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3500  CALL      COMPL000      * Complications Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3600  CALL      ANTIB000      * Antibiotics Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
. Shutdown & Exit Server
.==============================
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output HTML Error File & go back 2 pages
.------------------------------------------------------------
WEBER200  CALL      OPENHTML
          BRANCH    EXIT,WEBER295
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    if(self.name==#"PopUpFrame#");":
                             "    alert(#"",WEBTITLE,"#");":
                             "    opener.history.go(-2);":
                             "    self.close;":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBER299
.
WEBER295  DISPLAY   "*** Fifo Not Found ***"
.
WEBER299  RETURN
.******************************************************************************
.*                       Output Next Page Based on CGI Parameter nextpage      *
.******************************************************************************
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00                * Redirect Parent Content Page
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00                * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      WINBAK00                * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00                * Redirect Content Page
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      REDPAR00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      REDPPR00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      CLOFRM00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.******************************************************************************
.*                      Redirect Content URL                                  *
.******************************************************************************
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script><script>":
                             " redirectTopContent(#"",REDIRECT,"#"); ":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.******************************************************************************
.*                         Goes back One page                                 *
.******************************************************************************
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "          alert(#"",WEBTITLE,"#");":
                             "          self.close();":
                             "          opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
GOBACK99  RETURN
.*****************************************************************************
.*        Close Window and Goback to previous page                           *
.******************************************************************************
WINBAK00  CALL      OPENHTML
          BRANCH    EXIT,WINBAK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                        "   self.close();":
                        "   window.history.go(-2);":
                        "}":
                        "</script>";
          CALL      CLOSHTML
.
WINBAK99  RETURN
.*****************************************************************************
.*        Close Window or Frame and Goto New Location                         *
.******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             "  redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
          CALL      CLOSHTML
.
WINPAR99  RETURN
.------------------------------------------------------------------------------
. PREDIR00 - Redirect Parent URL
.------------------------------------------------------------------------------
.
REDPAR00  CALL      OPENHTML
          BRANCH    EXIT,REDPAR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      REDPAR99
.
REDPAR90  DISPLAY   "*** Fifo Not Found ***"
.
REDPAR99  RETURN
+
.------------------------------------------------------------------------------
. REDPPR00 - Redirect Parent Parent URL
.------------------------------------------------------------------------------
.
REDPPR00  CALL      OPENHTML
          BRANCH    EXIT,REDPPR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      REDPPR99
.
REDPPR90  DISPLAY   "*** Fifo Not Found ***"
.
REDPPR99  RETURN
.------------------------------------------------------------
. Process Fields from WEBBOD00
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD99:
                             PROFLD99,PROFLD70,PROFLD80,PROFLD90,PROFLD99:
                             PROFL110,PROFLD99,PROFLD99,PROFL140,PROFLD99:
                             PROFLD99,PROFLD99,PROFLD99,PROFL190,PROFLD99:
                             PROFLD99,PROFL220,PROFLD99,PROFL240,PROFL250:
                             PROFL260
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
.
PROFLD11  CALL      ALST0000
          GOTO      PROFLD99
.
PROFLD12  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD13  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23
.
PROFLD21  CALL      SLST0000
          GOTO      PROFLD99
.
PROFLD22  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD23  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33
.
PROFLD31  CALL      CLST0000
          GOTO      PROFLD99
.
PROFLD32  CALL      OSES0000
          GOTO      PROFLD99
.
PROFLD33  CALL      BKRQ0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45:
                             PROFLD46,PROFLD47,PROFLD48,PROFLD49,PROFLD50
.
PROFLD41  CALL      MASF0000        * Masterfile Details     PATMAS or PATPRA
          GOTO      PROFLD99
.
PROFLD42  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFLD43  CALL      BREC0000        * Booking Record          BOKREC
          GOTO      PROFLD99
.
PROFLD44  CALL      OSES0000        * Session Details         OPRSES
          GOTO      PROFLD99
.
PROFLD45  CALL      OPAR0000        * Operate Arival & Recov  OPRARD
          GOTO      PROFLD99
.
PROFLD46  CALL      BKRX0000        * Booking Extention       BOKRX1
          GOTO      PROFLD99
.
PROFLD47  CALL      TDET0000        * Other Theatre Details
          GOTO      PROFLD99
.
PROFLD48  CALL      OPSG0000        * Theatre Surgical detailS
          GOTO      PROFLD99
.
PROFLD49  CALL      OPPP0000        * Pre-Operative Checklist details
          GOTO      PROFLD99
.
PROFLD50  CALL      OPPA0000        * Arrival Checklist details
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74
.
PROFLD71  CALL      MASF0000        * Masterfile Details     PATMAS or PATPRA
          GOTO      PROFLD99
.
PROFLD72  CALL      BREC0000
          GOTO      PROFLD99
.
PROFLD73  CALL      BKRX0000
          GOTO      PROFLD99
.
PROFLD74  CALL      MISC0000
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82,PROFLD83,PROFLD84,PROFLD85:
                             PROFLD86,PROFLD87,PROFLD88,PROFLD89
.
PROFLD81  CALL      CCAS0000
          GOTO      PROFLD99
.
PROFLD82  CALL      MASF0000        * Masterfile Details     PATMAS or PATPRA
          GOTO      PROFLD99
.
PROFLD83  CALL      OCAS0000
          GOTO      PROFLD99
.
PROFLD84  CALL      OSES0000
          GOTO      PROFLD99
.
PROFLD85  CALL      CAND0000
          GOTO      PROFLD99
.
PROFLD86  CALL      BREC0000        * Booking Record          BOKREC
          GOTO      PROFLD99
.
PROFLD87  CALL      WTDE0000
          GOTO      PROFLD99
.
PROFLD88  CALL      BKRQ0000
          GOTO      PROFLD99
.
PROFLD89  CALL      MISC0000                                       *T0845646
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95:
                             PROFLD96,PROFLD97,PROFLD98,PROFL981,PROFL982
.
PROFLD91  CALL      MASF0000        * Masterfile Details     PATMAS or PATPRA
          GOTO      PROFLD99
.
PROFLD92  CALL      NCAS0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFLD93  CALL      OSES0000        * Session
          GOTO      PROFLD99
.
PROFLD94  CALL      WTDE0000        * Waiting List Fields     (WATDETTM)
          GOTO      PROFLD99
.
PROFLD95  CALL      WTTX0000        * Waiting List Fields     WATTX1
          GOTO      PROFLD99
.
PROFLD96  CALL      BKRX0000        * Booking Extention       BOKRX1
          GOTO      PROFLD99
.
PROFLD97  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFLD98  CALL      MISF0000        * Patient Admission       PATMI1
          GOTO      PROFLD99
.
PROFL981  CALL      MISC0000        * Miscellaneous fields
          GOTO      PROFLD99
.
PROFL982  CALL      BREC0000
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113,PROFL114,PROFL115:
                             PROFL116,PROFL117,PROFL118,PROFL119,PROFL120
.
PROFL111  CALL      MCAS0000
          GOTO      PROFLD99
.
PROFL112  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL113  CALL      MASF0000        * Masterfile Details     PATMASA
          GOTO      PROFLD99
.
PROFL114  CALL      NCAS0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFL115  CALL      WTTX0000        * Waiting List extn
          GOTO      PROFLD99
.
PROFL116  CALL      WTDE0000        * Waiting List Fields     (WATDETTM)
          GOTO      PROFLD99
.
PROFL117  CALL      BKRX0000        * Booking Extention       BOKRX1
          GOTO      PROFLD99
.
PROFL118  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFL119  CALL      BREC0000        * Booking Record          BOKREC
          GOTO      PROFLD99
.
PROFL120  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142,PROFL143,PROFL144
.
PROFL141  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL142  CALL      OCAS0000
          GOTO      PROFLD99
.
PROFL143  CALL      BREC0000
          GOTO      PROFLD99
.
PROFL144  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL190  BRANCH    FLDSETNO,PROFL191,PROFL192,PROFL193,PROFL194,PROFL195
.
PROFL191  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL192  CALL      OCAS0000
          GOTO      PROFLD99
.
PROFL193  CALL      BREC0000
          GOTO      PROFLD99
.
PROFL194  CALL      OSES0000
          GOTO      PROFLD99
.
PROFL195  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL220  BRANCH    FLDSETNO,PROFL221,PROFL222,PROFL223,PROFL224,PROFL225
.
PROFL221  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL222  CALL      BKRQ0000
          GOTO      PROFLD99
.
PROFL223  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL224  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL225  CALL      CLST0000
          GOTO      PROFLD99
.
PROFL240  BRANCH    FLDSETNO,PROFL241,PROFL242,PROFL243,PROFL244,PROFL245
.
PROFL241  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFL242  CALL      BREC0000        * Booking Record          BOKREC
          GOTO      PROFLD99
.
PROFL243  CALL      MISC0000        * Miscellaneous fields
          GOTO      PROFLD99
.
PROFL244  CALL      MASF0000        * Masterfile Details     PATMAS or PATPRA
          GOTO      PROFLD99
.
PROFL245  CALL      OSES0000        * Session Details
          GOTO      PROFLD99
.
PROFL250  BRANCH    FLDSETNO,PROFL251,PROFL252,PROFL253,PROFL254
.
PROFL251  CALL      MASF0000        * Patient Master
          GOTO      PROFLD99
.
PROFL252  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFL253  MATCH     "1",UPDOPCPI
          GOTO      PROFLD99 IF NOT EQUAL
.
          CALL      OPCI0000        * Theatre Complications   OPRCPI
          GOTO      PROFLD99
.
PROFL254  MATCH     "1",UPDOPCPI
          GOTO      PROFLD99 IF NOT EQUAL
.
          CALL      TCOM0000
          GOTO      PROFLD99
.
PROFL260  BRANCH    FLDSETNO,PROFL261,PROFL262,PROFL263,PROFL264
.
PROFL261  CALL      MASF0000        * Patient Master
          GOTO      PROFLD99
.
PROFL262  CALL      ODET0000        * Case Details            OPRDEA
          GOTO      PROFLD99
.
PROFL263  MATCH     "1",UPDOPABI
          GOTO      PROFLD99 IF NOT EQUAL
.
          CALL      OPAI0000        * Antibiotics OPRABI
          GOTO      PROFLD99
.
PROFL264  MATCH     "1",UPDOPABI
          GOTO      PROFLD99 IF NOT EQUAL
.
          CALL      TABI0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. Theatre complications
.------------------------------------------------------------
TCOM0000  BRANCH    FLDITMNO,TCOM0010,TCOM0020

          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      TCOM9999
.
TCOM0010  CALL      COMLST00        * list of Theatre complications
          GOTO      TCOM9999
.
TCOM0020  WRITE     HTMLFILE;VALDUNIQ;
          GOTO      TCOM9999
.
TCOM9999  RETURN
+
.------------------------------------------------------------
. Display Table of Theatre complications
.---------------------------------------------------------------------
COMLST00  MATCH     "1",UPDOPCPI
          GOTO      COMLST99 IF NOT EQUAL
.
          CALL      CMHED000      * Output Table Heading
          PACK      KEY31,OPDAUNIQ,Z70
          CALL      RSOPCPI2
COMLST10  CALL      RPOPCPI2
          BRANCH    OVRCD,COMLST99
          MATCH     OPDAUNIQ,OPCIUNIQ
          GOTO      COMLST99 IF NOT EQUAL
.
          MATCH     "1",OPCIDELT
          GOTO      COMLST10 IF EQUAL      * Deleted
.
          MATCH     OPCICDAT,SP70
          IF        @EQUAL
            MOVE     "&nbsp",OPCICDAT
          ENDIF
.
          MOVE     "&nbsp",KEY20
          MOVE     "cM",KEY2
          PACK     KEY5,KEY2,OPCICOMP      * Complications
          CALL     RDCODE1
          IF       OVRCD=0
            MOVE     TDESC,KEY20
          ENDIF
.
          UNPACK   OPCICDAT,CCENT,CYEAR,CMON,CDAY
          MOVE     CMON,F2
          LOAD     MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK     FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          PACK     OPCICOMM,OPCICOMM,SP70,SP70,SP70
          UNPACK   OPCICOMM,KEY99                 * display first line only
          WRITE    HTMLFILE;"<tr>":
                            "<td width=20% nowrap><a href=#"":
                            "javascript:UpdateCompl('",OPCIUNIQ:
                            "','",OPCICOMP,"','",OPCICNTR,"')#">":
                            "<img src=../images/MaintenanceIcon.gif ":
                            "hspace=4 border=0 align=absmiddle></a>":
                            KEY20,"</td>":
                            "<td width=15%>&nbsp;",FRMTDATE,"</td>":
                            "<td width=15%>&nbsp;",OPCICTIM,"</td>":
                            "<td>&nbsp;",KEY99,"</td>":
                            "<td width=5% nowrap><a href=#"":
                            "javascript:DelCompl('",OPCIUNIQ:
                            "','",OPCICOMP,"','",OPCICNTR,"')#">":
                            "<img src=../images/DeleteIcon.gif ":
                            "#")>":
                            "</td></tr>"
.
          GOTO      COMLST10
.
COMLST99  RETURN
+
.------------------------------------------------------------
. Complications (TABLE HEADING)
.------------------------------------------------------------
CMHED000  WRITE     HTMLFILE;"<tr>":
                           "<td class=HeadingCell>Complication</td>":
                           "<td class=HeadingCell>Date</td>":
                           "<td class=HeadingCell>Time</td>":
                           "<td class=HeadingCell>Comments</td>":
                           "<td class=HeadingCell>Delete</td>":
                           "</tr>"
CMHED999  RETURN
+
.------------------------------------------------------------
. Antibiotics
.------------------------------------------------------------
TABI0000  BRANCH    FLDITMNO,TABI0010,TABI0020

          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      TABI9999
.
TABI0010  CALL      ANTLST00        * list of Theatre complications
          GOTO      TABI9999
.
TABI0020  WRITE     HTMLFILE;VALDUNIQ;
          GOTO      TABI9999
.
TABI9999  RETURN
+
.------------------------------------------------------------
. Display Table of Antibiotics
.---------------------------------------------------------------------
ANTLST00  MATCH     "1",UPDOPABI
          GOTO      ANTLST99 IF NOT EQUAL
.
          CALL      ABHED000      * Output Table Heading
          PACK      KEY31,OPDAUNIQ,Z70
          CALL      RSOPABI2
ANTLST10  CALL      RPOPABI2
          BRANCH    OVRCD,ANTLST99
          MATCH     OPDAUNIQ,OPAIUNIQ
          GOTO      ANTLST99 IF NOT EQUAL
.
          MATCH     "1",OPAIDELT
          GOTO      ANTLST10 IF EQUAL      * Deleted
.
          MATCH     OPAICDAT,SP70
          IF        @EQUAL
            MOVE     "&nbsp",OPAICDAT
          ENDIF
.
          MOVE     "&nbsp",KEY20
          MATCH    SP70,OPAIANTB
          IF       !@EQUAL
            MOVE     "ab",KEY2
            PACK     KEY5,KEY2,OPAIANTB      * Antibiotic code (Cat ab)
            CALL     RDCODE1
            IF       OVRCD=0
              MOVE     TDESC,KEY20
            ENDIF
          ENDIF
.
          MOVE     "&nbsp",DIM20
          MATCH    SP70,OPAIPANT
          IF       !@EQUAL
            MOVE     "ab",KEY2
            PACK     KEY5,KEY2,OPAIPANT      * Prophylactic Antibiotic code
            CALL     RDCODE1
            IF       OVRCD=0
              MOVE     TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE     "&nbsp;",TDESC
          MATCH    SP70,OPAITUNK
          IF       !@EQUAL
            MOVE     "tu",KEY2
            PACK     KEY5,KEY2,OPAITUNK      * Time Unknown Code
            CALL     RDCODE1
          ENDIF
.
          WRITE    HTMLFILE;"<tr>":
                            "<td width=20% nowrap><a href=#"":
                            "javascript:UpdateAntib('",OPAIUNIQ:
                            "','",OPAIANTB,"','",OPAICNTR,"')#">":
                            "<img src=../images/MaintenanceIcon.gif ":
                            "hspace=4 border=0 align=absmiddle></a>":
                            KEY20,"</td>":
                            "<td width=15%>&nbsp;",DIM20,"</td>":
                            "<td width=15%>&nbsp;",OPAITGIV,"</td>":
                            "<td width=15%>&nbsp;",TDESC,"</td>":
                            "<td width=5% nowrap><a href=#"":
                            "javascript:DelAntib('",OPAIUNIQ:
                            "','",OPAIANTB,"','",OPAICNTR,"')#">":
                            "<img src=../images/DeleteIcon.gif>":
                            "</td></tr>"
.
          GOTO      ANTLST10
.
ANTLST99  RETURN
+
.------------------------------------------------------------
. Antibiotics (TABLE HEADING)
.------------------------------------------------------------
ABHED000  WRITE     HTMLFILE;"<tr>":
                           "<td class=HeadingCell>Antibiotic</td>":
                           "<td class=HeadingCell>Prophylactic Antibiotic</td>":
                           "<td class=HeadingCell>Time Given</td>":
                           "<td class=HeadingCell>Time Unknown</td>":
                           "<td class=HeadingCell>Delete</td>":
                           "</tr>"
ABHED999  RETURN
+
.------------------------------------------------------------
. Miscellaneous fields
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0010,MISC0020,MISC0030,MISC0040,MISC0050:
                             MISC0060,MISC0070,MISC0080,MISC0090,MISC0100:
                             MISC0110,MISC0120,MISC0130,MISC0140,MISC0150:
                             MISC0160,MISC0170,MISC0180,MISC0190,MISC0200:
                             MISC0210,MISC0220,MISC0230,MISC0240,MISC0250:
                             MISC0260,MISC0270,MISC0280,MISC0290,MISC0300:
                             MISC0310,MISC0320,MISC0330,MISC0340,MISC0350:
                             MISC0360,MISC0370,MISC0380,MISC0390,MISC0400:
                             MISC0410,MISC0420,MISC0430,MISC0440,MISC0450:
                             MISC0460,MISC0470,MISC0480,MISC0490,MISC0500:
                             MISC0510,MISC0520,MISC0530,MISC0540,MISC0550:
                             MISC0560,MISC0570,MISC0580,MISC0590
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      MISC9999
.
MISC0010  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          WRITE     HTMLFILE;PTCNHDPS;
          GOTO      MISC9999
.
MISC0020  CALL      CHKVIS00        * check for admissions
          GOTO      MISC9999
.
MISC0030  CALL      CASSLT00        * Case list selections
          GOTO      CLST9999
.
MISC0040  WRITE     HTMLFILE;OPCNASTD;
          GOTO      MISC9999
.
MISC0050  WRITE     HTMLFILE;OPCNASLN;
          GOTO      MISC9999
.
MISC0060  WRITE     HTMLFILE;PMVXUVTH;
          GOTO      MISC9999
.
MISC0070  WRITE     HTMLFILE;PTHVFLAG;
          GOTO      MISC9999
.
MISC0080  COMPARE   ZERO,OPAVAVER
          GOTO      MISC9999 IF EQUAL
.
          WRITE     HTMLFILE;OPAVAVER;
          GOTO      MISC9999
.
MISC0090  CALL      GETRGM00
          GOTO      MISC9999
.
MISC0100  CALL      CHRFL000              * check if referral required
          GOTO      MISC9999
.
MISC0110  MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      BKSEL000
          GOTO      BREC9999
.
MISC0120  CALL      VICMNT00
          GOTO      MISC9999
.
MISC0130  CALL      DANA0000              * Display anaesthetist 1 & 2
          GOTO      MISC9999
.
MISC0140  CALL      DASS0000
          GOTO      MISC9999              * Display assistant 1 & 2
.
MISC0150  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      MISC9999
.
MISC0160  WRITE     HTMLFILE;WAITFLAG;
          GOTO      MISC9999
.
MISC0170  WRITE     HTMLFILE;PREAFLAG;
          GOTO      MISC9999
.
MISC0180  MOVE      ZERO,NOTEORDR
          CALL      VEWCOM00
          GOTO      MISC9999
.
MISC0190  MOVE      ONE,NOTEORDR
          CALL      VEWCOM00
          GOTO      MISC9999
.
MISC0200  WRITE     HTMLFILE;ADMISNID;
          GOTO      MISC9999
.
MISC0210  WRITE     HTMLFILE;THRQBKTY;
          GOTO      MISC9999
.
MISC0220  WRITE     HTMLFILE;VALDUNIQ;
          GOTO      MISC9999
.
MISC0230  MOVE      "&nbsp;",SURFNAME
          PACK      KEY10,VALDUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,MISC0239
.
          MOVE      OPDACLIN,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            GOTO      MISC0238
          ENDIF
.
          MOVE      OPDACLIN,KEY6
          CALL      RDOPCLI1
          MOVE      OPCLDOCT,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,MISC0239
.
MISC0238  CALL      DOCNAM00
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,SURFNAME
          GOTO      MISC0239
.          
MISC0239  WRITE     HTMLFILE;SURFNAME;
          GOTO      MISC9999
.
MISC0240  WRITE     HTMLFILE;PMWXPORD;
          GOTO      MISC9999
.
MISC0250  CALL      VISCMA00
          GOTO      MISC9999
.
MISC0260  MOVE      "S ",CATEGORY
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      DIM3,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                         WMUDEF6,WMUDEF7,WMUDEF8
          MOVE      DIM3,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0270  WRITE     HTMLFILE;FROMWAIT;
          GOTO      MISC9999
.
MISC0280  WRITE     HTMLFILE;EREFRLID;      * eReferral ID
          GOTO      MISC9999
.
.                                                               *T0845646-Start
.------- Visit with Post Discharge Coding will be identified as those where
.------- the Pre-admission number being cancelled has a record in either
.------- of the Post Discharge Coding tables, "patecdaf.dptedadm" or
.------- "patecoaf.dpteoadm"
MISC0290  OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          PACK      KEY13,AADMNO,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1                             * patecdaf
          BRANCH    OVRCD,MISC0291
          MATCH     DPTEDADM,DAADMNO
          GOTO      MISC0291 IF NOT EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      MISC0292
.
MISC0291  PACK      KEY13,AADMNO,SP70
          CALL      RSPTECO1
          CALL      RKPTECO1                            * patecoaf
          BRANCH    OVRCD,MISC0292
          MATCH     DPTEOADM,DAADMNO
          GOTO      MISC0292 IF NOT EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      MISC0292
.
MISC0292  CLOSE     PATECDA1
          CLOSE     PATECOA1
          GOTO      MISC9999                                      *T0845646-End
.
MISC0300  MATCH     "1",OPCNOPAV
          GOTO      MISC9999 IF NOT EQUAL
.
          COMPARE   ZERO,OPAVAVER
          GOTO      MISC9999 IF EQUAL
.
          WRITE     HTMLFILE;OPAVAVER;
          GOTO      MISC9999
.
MISC0310  CALL      TDCML000               *Output current date      *T0846427
          GOTO      MISC9999               *comment line1
.
MISC0320  WRITE     HTMLFILE;DISPDAYC;     *Display Day comments     *T0846427
          GOTO      MISC9999               *flag
.
MISC0330  CALL      TDCMC000               *Current date comment     *T0846427
          GOTO      MISC9999               *lines count
.
MISC0340  WRITE     HTMLFILE;PMVXIDUS;     
          GOTO      MISC9999
.
MISC0350  WRITE     HTMLFILE;PMVXUDIN;
          GOTO      MISC9999
.
MISC0360  WRITE     HTMLFILE;PTELSPEA;
          GOTO      MISC9999
.
MISC0370  WRITE     HTMLFILE;PTELEADM;
          GOTO      MISC9999
.
MISC0380  WRITE     HTMLFILE;PMVXPILC;
          GOTO      MISC9999
.
MISC0390  WRITE     HTMLFILE;DISPWKNO;
          GOTO      MISC9999
.
MISC0400  MOVE      ZERO,F1                         * Check if MH visit 

          MATCH     SP70,ADMISSNO                   * Non-MH if no Admiss No
          GOTO      MISC0405 IF EQUAL

          PACK      KEY8,ADMISSNO,SP70              
          CALL      RDMHVIS1
          BRANCH    OVRCD,MISC0405
          MOVE      ONE,F1
.
          GOTO      MISC9999
.
MISC0405  WRITE     HTMLFILE;F1;
          GOTO      MISC9999
.
MISC0410  GOTO      MISC9999
.
MISC0420  WRITE     HTMLFILE;WBEFISTY;
          GOTO      MISC9999
.
MISC0430  WRITE     HTMLFILE;WBEFDINT;
          GOTO      MISC9999
.
MISC0440  WRITE     HTMLFILE;WBEFDIAG;
          GOTO      MISC9999
.
MISC0450  WRITE     HTMLFILE;WBEFPEAI;
          GOTO      MISC9999
.
MISC0460  WRITE     HTMLFILE;WBEFEMAD;
          GOTO      MISC9999
.
MISC0470  WRITE     HTMLFILE;WBEFEMAD;
          GOTO      MISC9999
.
MISC0480  WRITE     HTMLFILE;WBEFHFND;
          GOTO      MISC9999
.
MISC0490  WRITE     HTMLFILE;WBEFHFNT;
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;WBEFHFMN;
          GOTO      MISC9999
.
MISC0510  WRITE     HTMLFILE;WBEFPLOS;
          GOTO      MISC9999
.
MISC0520  WRITE     HTMLFILE;WBEFOECC;
          GOTO      MISC9999
.
MISC0530  WRITE     HTMLFILE;WBEFPRIC;
          GOTO      MISC9999
.
MISC0540  WRITE     HTMLFILE;WBEFPRIM;
          GOTO      MISC9999
.
MISC0550  WRITE     HTMLFILE;WBEFSNAM;
          GOTO      MISC9999
.
MISC0560  WRITE     HTMLFILE;WBEFFNAM;
          GOTO      MISC9999
.
MISC0570  WRITE     HTMLFILE;WBEFBDAT;
          GOTO      MISC9999
.
MISC0580  WRITE     HTMLFILE;WBEFGEND;
          GOTO      MISC9999
.
MISC0590  WRITE     HTMLFILE;WBEFCLTY;
          GOTO      MISC9999
.
MISC9999  RETURN
.
.------------------------------------------------------------------------------
. List current date theatre comments for line 1                      *T0846427
.------------------------------------------------------------------------------
TDCML000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCML999 IF NOT EQUAL    *No, exit
.
          MOVE      SP70,OPCMTEXT
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATD,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATD
.
          PACK      KEY25,CURRDATD,SP70
          CALL      RSOPCOM1
TDCML100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCML999
.
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital 
          GOTO      TDCML100 IF NOT EQUAL
.
          MATCH     CURRDATD,OPCMDATE        * same date
          GOTO      TDCML999 IF NOT EQUAL
.
          COMPARE   ONE,OPCMLINE             *First line?
          GOTO      TDCML999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPCMTEXT;       *Output first line
          GOTO      TDCML999
.
TDCML999  RETURN
.
.------------------------------------------------------------------------------
. Count current date theatre comments                                *T0846427
.------------------------------------------------------------------------------
TDCMC000  COMPARE   ONE,OPCNSCOM             *Using session based comments?
          GOTO      TDCMC999 IF NOT EQUAL    *No, exit
.
          MOVE      ZERO,DAYCMCNT            *Current date comment line count
.
          CALL      IBACLOCK                 *Current date
          PACK      CURRDATD,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATD
.
          PACK      KEY25,CURRDATD,SP70
          CALL      RSOPCOM1
TDCMC100  CALL      RKOPCOM1
          BRANCH    OVRCD,TDCMC300
.        
          MATCH     WBSEHOSP,OPCMHOSP        * same hospital
          GOTO      TDCMC100 IF NOT EQUAL
.
          MATCH     CURRDATD,OPCMDATE
          GOTO      TDCMC300 IF NOT EQUAL
.
          ADD       ONE,DAYCMCNT
          GOTO      TDCMC100
.
TDCMC300  WRITE     HTMLFILE;DAYCMCNT;       *Output line count
          GOTO      TDCMC999
.
TDCMC999  RETURN
.
.---------------------------------------------------------------------
. Display View only of Waiting list comments
.---------------------------------------------------------------------
VEWCOM00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          MOVE      WATTRKEY,DIM19
          IF        NOTEORDR=0
            PACK      KEY28,DIM19,NOTEFILT,Z70
          ELSE
            PACK      KEY28,DIM19,NOTEFILT,SP70
          ENDIF
.
          CALL      RSWTMHD1
VEWCOM10  IF        NOTEORDR=0
            CALL      RPWTMHD1
          ELSE
            CALL      RKWTMHD1
          ENDIF
          BRANCH    OVRCD,VEWCOM99
.
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
          MATCH     WATTRKEY,KEY19
          GOTO      VEWCOM99 IF NOT EQUAL
.
          MATCH     NOTEFILT,WTMHTYPE
          GOTO      VEWCOM99 IF NOT EQUAL
.
          MATCH     WTMHDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FRMTDATE
            GOTO     VEWCOM40
          ENDIF
.
          UNPACK    WTMHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VEWCOM40  MATCH     "1",WTMHDELT
          IF        @EQUAL
            GOTO       VEWCOM10
          ENDIF
.
          REP       " +",WATTRKEY
          REP       " +",WTMHTYPE
          REP       " +",WTMHNOTE
.
          MOVE      WATTRKEY,DIM19
          WRITE     HTMLFILE;FRMTDATE,SP1,WTMHTIME," - ";
.
          PACK      KEY10,WTMHUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM
          ELSE
            WRITE     HTMLFILE;WTMHUSER
          ENDIF
.
          REP       "+ ",WATTRKEY
          REP       "+ ",WTMHTYPE
          REP       "+ ",WTMHNOTE
.
          CALL      WLCOMM00
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
.
          GOTO      VEWCOM10
.
VEWCOM99  RETURN
.
.--------------------------------------------------------------------
. WL Comment Display
.--------------------------------------------------------------------
WLCOMM00  PACK      KEY31,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RSWTMTX1
WLCOMM10  CALL      RKWTMTX1
          BRANCH    OVRCD,WLCOMM99
.
          MATCH     WTMHURNO,WTMTURNO
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHPROC,WTMTPROC
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHPCNT,WTMTPCNT
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHTYPE,WTMTTYPE
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHNOTE,WTMTNOTE
          GOTO      WLCOMM99 IF NOT EQUAL
.
          WRITE     HTMLFILE;WTMTCMNT
          GOTO      WLCOMM10
.
WLCOMM99  RETURN
.
.------------------------------------------------------------
. Check for Admissions
.------------------------------------------------------------
CHKVIS00  MOVE      ZERO,VISFOUND
          MOVE      ZERO,NODAYS
.
. --- check for preadmissions ---
.
          PACK      KEY17,URNUMBER,ONE,Z70
          CALL      RSPTMI18
CHKVIS10  CALL      RPPTMI18
          BRANCH    OVRCD,CHKVIS15
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CHKVIS15
          ENDIF
.
          COMPARE   ONE,ASTAT
          GOTO      CHKVIS15 IF NOT EQUAL
.
.....     MATCH     ADATE,OPSEDATE
.....     GOTO      CHKVIS10 IF LESS
.
.....     DAYSEP    ADATE,OPSEDATE,NODAYS
.....     COMPARE   NODAYS,SEVEN
.....     GOTO      CHKVIS10 IF LESS
.
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
          GOTO      CHKVIS10
.
. --- check for current admissions before session date ---
.
CHKVIS15  PACK      KEY17,URNUMBER,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,CHKVIS20
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CHKVIS20
          ENDIF
.
          COMPARE   TWO,ASTAT
          GOTO      CHKVIS20 IF NOT EQUAL
.
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
. --- check for on leave admissions before session date ---
.
CHKVIS20  PACK      KEY17,URNUMBER,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,CHKVIS25
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CHKVIS25
          ENDIF
.
          COMPARE   FOUR,ASTAT
          GOTO      CHKVIS25 IF NOT EQUAL
.
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
. --- check for discharged admissions within session date ---
.
CHKVIS25  PACK      KEY17,URNUMBER,THREE,Z70
          CALL      RSPTMI18
CHKVIS30  CALL      RPPTMI18
          BRANCH    OVRCD,CHKVIS99
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CHKVIS99
          ENDIF
.
          COMPARE   THREE,ASTAT
          GOTO      CHKVIS99 IF NOT EQUAL
.
          MATCH     ADATE,OPSEDATE
          GOTO      CHKVIS30 IF LESS
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CHKVIS30
.
          MATCH     OPSEDATE,DDATE
          GOTO      CHKVIS99 IF LESS
.
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
CHKVIS99  WRITE     HTMLFILE;VISFOUND;
          RETURN
+
.------------------------------------------------------------
.  Case Selection List
.------------------------------------------------------------
CASSLT00  MOVE      ONE,SAVECASE
          MOVE      ONE,LSTCASE
.
          PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,Z70
          CALL      RSOPDEA5
CASSLT05  CALL      RPOPDEA5                * prev read on details file
          BRANCH    OVRCD,CASSLT10          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
.
          GOTO      CASSLT10 IF NOT EQUAL   * different sessio
          COMPARE   THREE,OPDASTAT
          GOTO      CASSLT05 IF EQUAL       * different sessio
.
          MOVE      OPDACASE,LSTCASE
.
CASSLT10  PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,SP20
          CALL      RSOPDEA5
CASSLT20  CALL      RKOPDEA5                * next read on details file
          BRANCH    OVRCD,CASSLT80          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      CASSLT80 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASSLT20 IF EQUAL
.
          MOVE      OPDACASE,SAVECASE
.
CASSLT80  MOVE      ONE,CASECNT
          MOVE      SAVECASE,CASECNT
.
CASSLT85  WRITE     HTMLFILE;"<option value='",CASECNT,"'>",CASECNT,"</option>"
          ADD       ONE,CASECNT
          COMPARE   CASECNT,LSTCASE
          GOTO      CASSLT85 IF NOT LESS
.
CASSLT99  RETURN
+
.------------------------------------------------------------
. Check for Booking/Waiting List/Theatre records - output indicator
.------------------------------------------------------------
CAND0000  BRANCH    FLDITMNO,CAND0100,CAND0200,CAND0300,CAND0400
.
CAND0100  MOVE      OPDAUNIQ,SAVUNIQ
          MOVE      ADMISSNO,KEY8             * Output preadmission indicator
          CALL      RDMISS1
          BRANCH    OVRCD,CAND9999
          COMPARE   ONE,ASTAT
          GOTO      CAND9999 IF NOT EQUAL
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
CAND0150  CALL      RKOPDEA2
          BRANCH    OVRCD,CAND0160
          MATCH     ADMISSNO,OPDAADMN
          GOTO      CAND0160 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CAND0150 IF EQUAL
.
          MATCH     OPDAUNIQ,SAVUNIQ
          GOTO      CAND0170 IF NOT EQUAL
          GOTO      CAND0150
.
CAND0160  WRITE     HTMLFILE;ONE;
.
CAND0170  PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          GOTO      CAND9999
.
CAND0200  COMPARE   HBWAIT,ONE
          GOTO      CAND9999 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROC
          GOTO      CAND9999 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CAND9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      CAND9999
.
CAND0300  MOVE      OPDAUNIQ,SAVUNIQ
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
CAND0350  CALL      RKOPDEA2
          BRANCH    OVRCD,CAND0360
          MATCH     ADMISSNO,OPDAADMN
          GOTO      CAND0360 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CAND0350 IF EQUAL
.
          MATCH     OPDAUNIQ,SAVUNIQ
          GOTO      CAND0370 IF NOT EQUAL
          GOTO      CAND0350
.
CAND0360  WRITE     HTMLFILE;ONE;
.
CAND0370  PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          GOTO      CAND9999
.
CAND0400  COMPARE   HBWAIT,ONE
          GOTO      CAND9999 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROC
          GOTO      CAND9999 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CAND9999
.
          PACK      SAVKEY19,KEY19,SP70
.
          MOVE      OPDAUNIQ,SAVUNIQ
          PACK      KEY29,URNUMBER,SP70
          CALL      RSOPDEA4
CAND0450  CALL      RKOPDEA4
          BRANCH    OVRCD,CAND0470
          MATCH     URNUMBER,OPDAURNO
          GOTO      CAND0470 IF NOT EQUAL
.
.....     COMPARE   THREE,OPDASTAT
.....     GOTO      CAND0450 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          MATCH     SAVKEY19,KEY19
          GOTO      CAND0450 IF NOT EQUAL
.
CAND0460  WRITE     HTMLFILE;ONE;
.
CAND0470  PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          GOTO      CAND9999
.
CAND9999  RETURN
.
.------------------------------------------------------------
. Validate Item
.------------------------------------------------------------
VALITM00  CALL      XMLHED00
          BRANCH    EXIT,VALITM99
VALITM01  PACK      KEY9,VALDCODE,SP70
          PACK      VALDEDAT,VALDEDAT,SP70
          PACK      KEY17,KEY9,VALDEDAT,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,VALITM10
          GOTO      VALITM20
.
VALITM10  PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,VALITM20
.
          MATCH     VALDCODE,OPDAPROV
          GOTO      VALITM12 IF NOT EQUAL
.
          MATCH     SP70,OPDADES1
          GOTO      VALITM12 IF EQUAL
.
          MOVE      OPDADES1,IDESC
          GOTO      VALITM30
.
VALITM12  MOVE      ONE,OVRCD
.
VALITM20  BRANCH    WKITINAC,VALITM91
          BRANCH    WKITEXDT,VALITM92         * Out of range
          BRANCH    OVRCD,VALITM90
.
          MOVE      "cr",CATEGORY
          MOVE      PTITTCER,CODE
          CALL      GETCOD00
.
          MATCH     "R",TCINDC2
          IF        !@EQUAL
           PACK      PTCDLDES,SP70
          ENDIF
.
VALITM30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTITDESC,"|",QIAMT,"|",PTCDLDES:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Item Code - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Item Inactive  - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "This MBS Item ",KEY9," is not active for the ":
                             "date range selected":
                             "</RETURN_VALUE>"
          GOTO      VALITM98

VALITM98  CALL      XMLEND00
VALITM99  RETURN
+
.------------------------------------------------------------
. Validate if session case reorder is required
.------------------------------------------------------------
VALCRO00  CALL      XMLHED00
          BRANCH    EXIT,VALCRO99
.
          MOVE      SP70,PREVPSTM
.
          PACK      KEY26,SESSKEYS,SP70
          CALL      RSOPDEA5
VALCRO10  CALL      RKOPDEA5
          BRANCH    OVRCD,VALCRO90
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      VALCRO90 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      VALCRO10 IF EQUAL
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
          ENDIF
.
          MOVE      SP70,DIM8
          LOAD      DIM8,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                  OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                  OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                  OPARTIDP,OPARTETC
.
          MATCH     SP8,DIM8
          GOTO      VALCRO10 IF EQUAL
.
          MATCH     DIM8,PREVPSTM
          GOTO      VALCRO10 IF EQUAL
          GOTO      VALCRO91 IF NOT LESS    * reorder required
.
          PACK      PREVPSTM,DIM8  * Prev Start Time
.
          GOTO      VALCRO10
.
VALCRO90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>"
          GOTO      VALCRO98
.
VALCRO91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:
                             "</RETURN_VALUE>"
          GOTO      VALCRO98
.
VALCRO98  CALL      XMLEND00
VALCRO99  RETURN
+
.------------------------------------------------------------
. Amend Theatre Fasting Times
.------------------------------------------------------------
UPFST000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      UPFST800 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      UPFST200 IF EQUAL
.
          GOTO      UPFST900
.
.         ************ UPDATE FORMACTION **********
.
UPFST200  PACK      KEY10,VALDUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,UPFST999
.
          MATCH     Z70,OPDEA040
          IF        !@EQUAL
            MOVE      OPDEA040,OPDAFAST
          ENDIF
.
          MATCH     Z70,OPDEA024
          IF        !@EQUAL
            MOVE       OPDEA024,OPDAPRE5
          ENDIF
.
          MATCH     Z70,OPDEA047
          IF        !@EQUAL
            MATCH     SP70,OPDEA047
            IF        !@EQUAL
              UNPACK    OPDEA047,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDADTFF,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDADTFF
            ELSE
              MOVE      SP8,OPDADTFF
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA048
          IF        !@EQUAL
            MATCH     SP70,OPDEA048
            IF        !@EQUAL
              UNPACK    OPDEA048,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDADTFL,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDADTFL
            ELSE
              MOVE      SP8,OPDADTFL
            ENDIF
          ENDIF
.
          CALL      UPOPDEA3
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,UPFST999
.
          MATCH     Z70,BKREC005
          IF        !@EQUAL
            MOVE       BKREC005,BKREATIM
          ENDIF
.
          CALL      UPBKREC1
.
.         Update the admission time (Pre-admission only)
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPFST290
.
          COMPARE   ONE,ASTAT
          GOTO      UPFST290 IF NOT EQUAL   * Not a pre-admission
.
          MATCH     BKREEDAT,ADATE
          GOTO      UPFST290 IF NOT EQUAL   * Not same date
.
          MOVE      BKREATIM,ATIME
.
          CALL      UPMISS1
.
UPFST290  MOVE      "002",TADTTYPE
          PROC      OPTHETAT           * write audit
.
UPFST299  MOVE      ZERO,EXIT
          GOTO      UPFST999
.
.         ************ DISPLAY FORMACTION **********
.
UPFST800  PACK      KEY10,VALDUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,UPFST999
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,UPFST999
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPFST999
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1 
          IF        OVRCD=1
            CALL      CLOPRSES
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (",WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,UPFST999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      UPFST999
.
UPFST900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPFST999

UPFST999  RETURN
+
.------------------------------------------------------------
. Complications
.------------------------------------------------------------
COMPL000  MATCH     "1",UPDOPCPI
          GOTO      COMPL999 IF NOT EQUAL
.
          CALL      CLOPRDEA
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      COMPL850
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,COMPL900
          ENDIF
          PACK      OPCPI001,OPDAUNIQ,SP70
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      COMPL800 IF EQUAL
.
          MATCH     "A",UPDTTYPE           * Add/Update Formaction
          GOTO      COMPL100 IF EQUAL
.
          MATCH     "U",UPDTTYPE           * Update Formaction
          GOTO      COMPL200 IF EQUAL
.
          MATCH     "D",UPDTTYPE           * Delete Formaction
          GOTO      COMPL300 IF EQUAL
.
          GOTO      COMPL940
.
.         ************ ADD FORMACTION **********
. 
COMPL100  MOVE      ONE,F2
          PACK      KEY15,OPCPI001,OPCPI002,Z70
          CALL      RSOPCPI1
          CALL      RPOPCPI1
          BRANCH    OVRCD,COMPL120
.
          MATCH     OPCPI001,OPCIUNIQ     * Same unique ID
          GOTO      COMPL120 IF NOT EQUAL
.
          MOVE      OPCICNTR,F2
          ADD       ONE,F2
COMPL120  MOVE      F2,OPCICNTR           * Next counter
          PACK      KEY15,OPCPI001,OPCPI002,OPCICNTR
          CALL      RDOPCPI1
          IF        OVRCD=1
            CALL      CLOPRCPI
            PACK      COMLINE1,COMLINE1,SP70
            PACK      COMLINE2,COMLINE2,SP70
            PACK      OPCPI004,COMLINE1,SP1,COMLINE2,SP70,SP70,SP70
            CALL      MVOPRCPI
            MOVE      F2,OPCICNTR           * Next counter
.
            MOVE      WBSEUID,OPCICUID
            CALL      IBACLOCK
            PACK      OPCICDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPCICDAT
            CLOCK     TIME,OPCICTIM
            CALL      WROPCPI1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      COMPL980
.
.         ************ UPDATE FORMACTION **********
.
COMPL200  PACK      KEY15,OPCPI001,OPCPI002,OPCPI003,SP70
          CALL      RDOPCPI1
          BRANCH    OVRCD,COMPL200                  * doesn't exist
.
          PACK      COMLINE1,COMLINE1,SP70
          PACK      COMLINE2,COMLINE2,SP70
          PACK      OPCPI004,COMLINE1,SP1,COMLINE2,SP70,SP70,SP70
          CALL      MVOPRCPI
.
          MOVE      WBSEUID,OPCIUUID
          CALL      IBACLOCK
          PACK      OPCIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPCIUDAT
          CLOCK     TIME,OPCIUTIM
.
          CALL      UPOPCPI1
.
          MOVE      ZERO,EXIT
          GOTO      COMPL980
.
.         ************ DELETE FORMACTION **********
.
COMPL300  PACK      KEY15,OPCPI001,OPCPI002,OPCPI003,SP70
          CALL      RDOPCPI1
          BRANCH    OVRCD,COMPL910
.
          MOVE      "1",OPCIDELT            * Deleted flag
          MOVE      WBSEUID,OPCIUDEL        * record deleted by
.
          MOVE      WBSEUID,OPCIUUID
          CALL      IBACLOCK
          PACK      OPCIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPCIUDAT
          CLOCK     TIME,OPCIUTIM
          CALL      UPOPCPI1
.
          MOVE      ZERO,EXIT
          GOTO      COMPL980
.
.         ************ DISPLAY FORMACTION **********
.
COMPL800  MOVE      ZERO,EXIT
          PACK      KEY15,OPCPI001,OPCPI002,OPCPI003
          CALL      RDOPCPI1
          IF        OVRCD=1
            CALL      CLOPRCPI
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Complications Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,COMPL999
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL840  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL850  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL900  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL910  MOVE      "Complications does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL940  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      COMPL999
.
COMPL980  MOVE      ZERO,EXIT
COMPL999  RETURN
+
.------------------------------------------------------------
. Antibiotics 
.------------------------------------------------------------
ANTIB000  MATCH     "1",UPDOPABI
          GOTO      ANTIB999 IF NOT EQUAL
.
          CALL      CLOPRDEA
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      ANTIB850
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,ANTIB900
          ENDIF
          PACK      OPABI001,OPDAUNIQ,SP70
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      ANTIB800 IF EQUAL
.
          MATCH     "A",UPDTTYPE           * Add/Update Formaction
          GOTO      ANTIB100 IF EQUAL
.
          MATCH     "U",UPDTTYPE           * Update Formaction
          GOTO      ANTIB200 IF EQUAL
.
          MATCH     "D",UPDTTYPE           * Delete Formaction
          GOTO      ANTIB300 IF EQUAL
.
          GOTO      ANTIB940
.
.         ************ ADD FORMACTION **********
.
ANTIB100  MOVE      ONE,F2
          PACK      KEY15,OPABI001,OPABI002,Z70
          CALL      RSOPABI1
          CALL      RPOPABI1
          BRANCH    OVRCD,ANTIB120
.
          MATCH     OPABI001,OPAIUNIQ     * Same unique ID
          GOTO      ANTIB120 IF NOT EQUAL
.
          MOVE      OPAICNTR,F2
          ADD       ONE,F2
ANTIB120  MOVE      F2,OPAICNTR           * Next counter
          PACK      KEY15,OPABI001,OPABI002,OPAICNTR
          CALL      RDOPABI1
          IF        OVRCD=1
            CALL      CLOPRABI
            PACK      COMLINE1,COMLINE1,SP70
            PACK      COMLINE2,COMLINE2,SP70
            PACK      OPABI008,COMLINE1,SP1,COMLINE2,SP70,SP70,SP70
            CALL      MVOPRABI
.
            MOVE      F2,OPAICNTR           * Next counter
            MOVE      WBSEUID,OPAICUID
            CALL      IBACLOCK
            PACK      OPAICDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPAICDAT
            CLOCK     TIME,OPAICTIM
            CALL      WROPABI1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ANTIB980
.
.         ************ UPDATE FORMACTION **********
.
ANTIB200  PACK      KEY15,OPABI001,OPABI002,OPABI003,SP70
          CALL      RDOPABI1
          BRANCH    OVRCD,ANTIB200                  * doesn't exist
.
          PACK      COMLINE1,COMLINE1,SP70
          PACK      COMLINE2,COMLINE2,SP70
          PACK      OPABI008,COMLINE1,SP1,COMLINE2,SP70,SP70,SP70
          CALL      MVOPRABI
.
          MOVE      WBSEUID,OPAIUUID
          CALL      IBACLOCK
          PACK      OPAIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPAIUDAT
          CLOCK     TIME,OPAIUTIM
          CALL      UPOPABI1
.
          MOVE      ZERO,EXIT
          GOTO      ANTIB980
.
.         ************ DELETE FORMACTION **********
.
ANTIB300  PACK      KEY15,OPABI001,OPABI002,OPABI003,SP70
          CALL      RDOPABI1
          BRANCH    OVRCD,ANTIB910
.
          MOVE      "1",OPAIDELT            * Deleted flag
          MOVE      WBSEUID,OPAIUDEL        * record deleted by
.
          MOVE      WBSEUID,OPAIUUID
          CALL      IBACLOCK
          PACK      OPAIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPAIUDAT
          CLOCK     TIME,OPAIUTIM
          CALL      UPOPABI1
.
          MOVE      ZERO,EXIT
          GOTO      ANTIB980
.
.         ************ DISPLAY FORMACTION **********
.
ANTIB800  MOVE      ZERO,EXIT
          PACK      KEY15,OPABI001,OPABI002,OPABI003
          CALL      RDOPABI1
          IF        OVRCD=1
            CALL      CLOPRABI
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Antibiotics Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ANTIB999
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB840  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB850  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB900  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB910  MOVE      "Antibiotics does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB940  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANTIB999
.
ANTIB980  MOVE      ZERO,EXIT
ANTIB999  RETURN
+
.------------------------------------------------------------
. Select Doctor Based on Supervision Level Code
.------------------------------------------------------------
DOCSEL00  MATCH     SP70,DOCTTYPE
          GOTO      DOCSEL30 IF EQUAL
.
          CALL      DOCSSL00           * Doctor Selection List (sorted by name)
          GOTO      DOCSEL99
.
.          MATCH     SP70,DOCTCODE
.          IF        !@EQUAL
.            PACK      KEY6,DOCTCODE,SP70
.            CALL      RDDOCT1
.            BRANCH    OVRCD,DOCSEL05
.
.            WRITE     HTMLFILE;"<option value=",DOCTCODE," selected>":
.                               DSNAME,COMMA,DGNAME,"</option>"
.          ENDIF
.
.DOCSEL05  PACK      KEY9,DOCTTYPE,SP70
.          CALL      RSWTVWL2
.DOCSEL10  CALL      RKWTVWL2
.          BRANCH    OVRCD,DOCSEL99
.          MATCH     DOCTTYPE,WTVWLTYP
.          GOTO      DOCSEL99 IF NOT EQUAL
.
.          PACK      KEY6,WTVWCONS,SP70
.          CALL      RDDOCT1
.          BRANCH    OVRCD,DOCSEL10
.
.          IF        IBCNMHOS=1
.            MATCH    "1",PTDOHOSS
.            IF       @EQUAL
.              PACK     KEY13,WBSEHOSP,DCODE,SP70
.              CALL     RDMLHCP1
.              BRANCH   OVRCD,DOCSEL10
.            ELSE
.              MATCH    "1",PTCNMHCP         * Only show matching hospitals
.              GOTO     DOCSEL10 IF EQUAL
.            ENDIF
.          ENDIF
.
.          COMPARE   "0",DRSTAT
.          GOTO      DOCSEL10 IF NOT EQUAL
.
.          MATCH     DOCTCODE,WTVWCONS
.          IF        @EQUAL
.            GOTO      DOCSEL10   * already output first
.          ELSE
.            WRITE     HTMLFILE;"<option value=",WTVWCONS,">":
.                               DSNAME,COMMA,DGNAME,"</option>"
.          ENDIF
.          GOTO      DOCSEL10
.
DOCSEL30  PACK      KEY26,SP70
          CALL      RDSDOCT2
DOCSEL31  CALL      RDKDOCT2
          BRANCH    OVRCD,DOCSEL99
.
          IF        IBCNMHOS=1
            MATCH    "1",PTDOHOSS
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,DCODE,SP70
              CALL     RDMLHCP1
              BRANCH   OVRCD,DOCSEL31
            ELSE
              MATCH    "1",PTCNMHCP         * Only show matching hospitals
              GOTO     DOCSEL31 IF EQUAL
            ENDIF
          ENDIF
.
          COMPARE   "0",DRSTAT
          GOTO      DOCSEL31 IF NOT EQUAL
.
          MATCH     DOCTCODE,DCODE
          IF        @EQUAL
             WRITE     HTMLFILE;"<option value=",DCODE," selected>":
                             DSNAME,COMMA,DGNAME,"</option>"
          ELSE
             WRITE     HTMLFILE;"<option value=",DCODE,">":
                             DSNAME,COMMA,DGNAME,"</option>"
          ENDIF
          GOTO      DOCSEL31
.
DOCSEL99 RETURN
+
.------------------------------------------------------------------------------
. Doctor Select List - Sorted by doctor surname (using temp file)
.------------------------------------------------------------------------------
DOCSSL00  CALL      CRTMPC00           * Create temp file (FNAMEC)
.
          PACK      KEY9,DOCTTYPE,SP70
          CALL      RSWTVWL2
DOCSSL10  CALL      RKWTVWL2
          BRANCH    OVRCD,DOCSSL20
.
          MATCH     DOCTTYPE,WTVWLTYP
          GOTO      DOCSSL20 IF NOT EQUAL
.
          COMPARE   ZERO,WTVWSTAT
          GOTO      DOCSSL10 IF NOT EQUAL    * active only (TSK 0896400)
.
          PACK      KEY6,WTVWCONS,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,DOCSSL10
.
          IF        IBCNMHOS=1
            MATCH    "1",PTDOHOSS
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,DCODE,SP70
              CALL     RDMLHCP1
              BRANCH   OVRCD,DOCSSL10
            ELSE
              MATCH    "1",PTCNMHCP         * Only show matching hospitals
              GOTO     DOCSSL10 IF EQUAL
            ENDIF
          ENDIF
.
          COMPARE   "0",DRSTAT
          GOTO      DOCSSL10 IF NOT EQUAL
.
          STRIP     DSNAME
          STRIP     DGNAME
.
          PACK      TMPFCNAM,DSNAME,COMMA,SP1,DGNAME,SP70
          PACK      TMPFCCOD,WTVWCONS,SP70
.
          PACK      KEY57,TMPFCNAM,TMPFCCOD,SP70
          CALL      RATMPFC1
          IF        OVRCD=1
            CALL      WRTMPFC1
          ENDIF
.
          GOTO      DOCSSL10
.
.
.         Now we load from our temp file...
.
DOCSSL20  PACK      KEY57,SP70
          CALL      RSTMPFC1
DOCSSL21  CALL      RKTMPFC1
          BRANCH    OVRCD,DOCSSL90
.
          MATCH     DOCTCODE,TMPFCCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",TMPFCCOD," selected>":
                               TMPFCNAM,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",TMPFCCOD,">":
                               TMPFCNAM,"</option>"
          ENDIF
.
          GOTO      DOCSSL21
.
DOCSSL90  CALL      KLTMPC00           * Kill temp file (FNAMEC)
DOCSSL99  RETURN
+
.*****************************************************************************
.*        Create Tempfile (FNAMEC)                                           *
.*****************************************************************************
CRTMPC00  CALL      KLTMPC00           * Kill temp file
.
          CLEAR     DIM100
          APPEND    "isbuild ",DIM100
          APPEND    FNAMEC,DIM100
          APPEND    " 57 U1-50,51-56",DIM100
          RESET     DIM100
          EXECUTE   DIM100,TASKID
          OPEN      TMPCIND1,FNAMEC
.
          PACK      KEY57,SP70
          CALL      RSTMPFC1
CRTMPC10  CALL      RKTMPFC1
          BRANCH    OVRCD,CRTMPC99
.
          CALL      DETMPFC1
          GOTO      CRTMPC10
.
CRTMPC99  RETURN
+
.*****************************************************************************
.*        Kill Tempfile (FNAMEC)                                             *
.*****************************************************************************
KLTMPC00  CLOSE     TMPCIND1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEC,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KLTMPC99  RETURN
+
.*****************************************************************************
.*        Tempfile I/O Subroutines (FNAMEC)                                  *
.*****************************************************************************
RATMPFC1  MOVE      ZERO,OVRCD
          RESET     KEY57
          READ      TMPCIND1,KEY57;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPFC1  RESET     KEY57
          READ      TMPCIND1,KEY57;;
          RETURN
.
RKTMPFC1  MOVE      ZERO,OVRCD
          READKS    TMPCIND1;TMPFCNAM,TMPFCCOD
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPFC1  RESET     KEY57
          WRITE     TMPCIND1,KEY57;TMPFCNAM,TMPFCCOD
          RETURN
.
DETMPFC1  RESET     KEY57
          DELETE    TMPCIND1,KEY57
          RETURN
+
.------------------------------------------------------------
. Select Doctor Based on Supervision Level Code
.------------------------------------------------------------
DOCTSL00  CALL      CRTMPC00           * Create temp file (FNAMEC)
.
          PACK      KEY6,SP70
          CALL      RDSDOCT1
DOCTSL10  CALL      RDKDOCT1
          BRANCH    OVRCD,DOCTSL20
.
          IF        IBCNMHOS=1
            MATCH    "1",PTDOHOSS
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,DCODE,SP70
              CALL     RDMLHCP1
              BRANCH   OVRCD,DOCTSL10
            ELSE
              MATCH    "1",PTCNMHCP         * Only show matching hospitals
              GOTO     DOCTSL10 IF EQUAL
            ENDIF
          ENDIF
.
          COMPARE   "0",DRSTAT
          GOTO      DOCTSL10 IF NOT EQUAL
.
          MATCH     SP70,DOCTORTP           * Check doctor type
          GOTO      DOCTSL11 IF EQUAL
.
          MATCH     DOCTORTP,DRTYPE
          GOTO      DOCTSL11 IF EQUAL
.
          MATCH     DOCTORTP,DRTYPE2
          GOTO      DOCTSL11 IF EQUAL
.
          MATCH     DOCTORTP,DRTYPE3
          GOTO      DOCTSL11 IF EQUAL
.
          MATCH     DOCTORTP,DRTYPE4
          GOTO      DOCTSL11 IF EQUAL
.
          MATCH     DOCTORTP,DRTYPE5
          GOTO      DOCTSL11 IF EQUAL
.
          GOTO      DOCTSL10
.
DOCTSL11  STRIP     DSNAME
          STRIP     DGNAME
.
          PACK      TMPFCNAM,DSNAME,COMMA,SP1,DGNAME,SP70
          PACK      TMPFCCOD,DCODE,SP70
.
          PACK      KEY57,TMPFCNAM,TMPFCCOD,SP70
          CALL      RATMPFC1
          IF        OVRCD=1
            CALL      WRTMPFC1
          ENDIF
.
.         MATCH     DOCTCODE,DCODE
.         IF        @EQUAL
.            WRITE     HTMLFILE;"<option value=",DCODE," selected>":
.                            DSNAME,COMMA,DGNAME,"</option>"
.         ELSE
.            WRITE     HTMLFILE;"<option value=",DCODE,">":
.                            DSNAME,COMMA,DGNAME,"</option>"
.         ENDIF
.
          GOTO      DOCTSL10
.
.
.         Now we load from our temp file...
.
DOCTSL20  PACK      KEY57,SP70
          CALL      RSTMPFC1
DOCTSL21  CALL      RKTMPFC1
          BRANCH    OVRCD,DOCTSL90
.
          MATCH     DOCTCODE,TMPFCCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",TMPFCCOD," selected>":
                               TMPFCNAM,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",TMPFCCOD,">":
                               TMPFCNAM,"</option>"
          ENDIF
.
          GOTO      DOCTSL21
.
DOCTSL90  CALL      KLTMPC00           * Kill temp file (FNAMEC)
DOCTSL99  RETURN
+
.------------------------------------------------------------
.DOCSEL00  MATCH     SP70,DOCTTYPE
.          GOTO      DOCSEL90 IF EQUAL
.          PACK      KEY29,DOCTTYPE,SP70
.          CALL      RDSDOCT3
.DOCSEL10  CALL      RDKDOCT3
.          BRANCH    OVRCD,DOCSEL99
.          MATCH     DOCTTYPE,DALEVEL
.          GOTO      DOCSEL99 IF NOT EQUAL
.          MOVE      DGNAME,ANS
.          MATCH     DOCTCODE,DCODE
.          IF        @EQUAL
.            WRITE     HTMLFILE;"<option value=",DCODE," selected>":
.                               DSNAME,COMMA,ANS,"</option>"
.          ELSE
.            WRITE     HTMLFILE;"<option value=",DCODE,">":
.                               DSNAME,COMMA,ANS,"</option>"
.          ENDIF
.          GOTO      DOCSEL10
..
.DOCSEL90  PACK      KEY6,SP70
.          CALL      RDSDOCT1
.DOCSEL91  CALL      RDKDOCT1
.          BRANCH    OVRCD,DOCSEL99
.          MOVE      DGNAME,ANS
.          MATCH     DOCTCODE,DCODE
.          IF        @EQUAL
.             WRITE     HTMLFILE;"<option value=",DCODE," selected>":
.                             DSNAME,COMMA,ANS,"</option>"
.          ELSE
.             WRITE     HTMLFILE;"<option value=",DCODE,">":
.                             DSNAME,COMMA,ANS,"</option>"
.          ENDIF
.          GOTO      DOCSEL91
..
.DOCSEL99 RETURN
+
.------------------------------------------------------------
. Select Doctor Based on Supervision Level Code
.------------------------------------------------------------
UNTSEL00  MATCH     SP70,DOCTTYPE
          GOTO      UNTSEL90 IF EQUAL
.
          CALL      DOCSSL00           * Doctor Selection List (sorted by name)
          GOTO      UNTSEL99
.
.         PACK      KEY9,DOCTTYPE,SP70
.         CALL      RSWTVWL2
.UNTSEL10  CALL      RKWTVWL2
.         BRANCH    OVRCD,UNTSEL99
.         MATCH     DOCTTYPE,WTVWLTYP
.         GOTO      UNTSEL99 IF NOT EQUAL
.
.         COMPARE   ZERO,WTVWSTAT
.         GOTO      UNTSEL10 IF NOT EQUAL        * active only (CAR 307029)
.
.         PACK      KEY6,WTVWCONS,SP70
.         CALL      RDDOCT1
.         BRANCH    OVRCD,UNTSEL10
.
.         MOVE      DGNAME,ANS
.         MATCH     DOCTCODE,WTVWCONS
.         IF        @EQUAL
.           WRITE     HTMLFILE;"<option value=",WTVWCONS," selected>":
.                              DSNAME,COMMA,ANS,"</option>"
.         ELSE
.           WRITE     HTMLFILE;"<option value=",WTVWCONS,">":
.                              DSNAME,COMMA,ANS,"</option>"
.         ENDIF
.         GOTO      UNTSEL10
.
UNTSEL90  MATCH     SP70,DOCTCODE
          GOTO      UNTSEL99 IF EQUAL
          CALL      RDDOCT1
          BRANCH    OVRCD,UNTSEL99
          MOVE      DGNAME,ANS
          WRITE     HTMLFILE;"<option value=",WTVWCONS," selected>":
                             DSNAME,COMMA,ANS,"</option>"
.
UNTSEL99 RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00    * Open Files in (PATMASTM)
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      OPRSEMA1,"oprsemaf"
          OPEN      OPRRALA1,"oprralaf"
          OPEN      OPRREQA1,"oprreqaf"
          OPEN      OPRCBDA1,"oprcbdaf"
          OPEN      OPRITEA1,"opriteaf"
          OPEN      OPRITEA2,"opriteaf"
          OPEN      OPRITEA3,"opriteaf"
          OPEN      WATOPAA1,"watopaaf"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATPACA1,"watpacaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATELGA1,"patelgaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A3,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATDO1A2,"patdo1af"
          OPEN      PATDO1A3,"patdo1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATFN1A2,"patfn1af"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PATWC1A1,"patwc1af"
.
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA3,"patatraf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATPA1A1,"patpa1af"
          OPEN      PATUNAA1,"patunaaf"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PMSOECA1,"pmsoecaf"
          OPEN      PMSOESA1,"pmsoesaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PMSRFLA1,"pmsrflaf"
          OPEN      SCRMASA1,"scrmasaf"
          OPEN      OPREXPA1,"oprexpaf"
          OPEN      OPREXPA2,"oprexpaf"
          OPEN      OPRRCIA1,"oprrciaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      BOKUNQA1,"bokunqaf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      OPRNURA2,"oprnuraf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSESA6,"oprsesaf"
          OPEN      OPRPRFA1,"oprprfaf"
          OPEN      OPRDPHA1,"oprdphaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA4,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
          OPEN      OPRDETB1,"oprdetbf"
          OPEN      OPRDETC1,"oprdetcf"
          OPEN      OPRDEDA1,"oprdedaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCOMA1,"oprcomaf"                                *I-50678
          OPEN      OPRCOMA2,"oprcomaf"
.
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPRTRYA1,"oprtryaf"
          OPEN      OPRTPSA1,"oprtpsaf"
          OPEN      OPRPMBA1,"oprpmbaf"
          OPEN      OPRPOCA1,"oprpocaf"
          OPEN      OPRTQEA1,"oprtqeaf"
          OPEN      OPRMBSA1,"oprmbsaf"
          OPEN      OPRWCNA2,"oprwcnaf"
.
          OPEN      WATCHAA1,"watchaaf"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATESNA5,"watesnaf"
          OPEN      WATMHDA1,"watmhdaf"
          OPEN      WATMTXA1,"watmtxaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATRTDA1,"watrtdaf"
          OPEN      WATHISA1,"wathisaf"
          OPEN      WATVWLA2,"watvwlaf"
          OPEN      WATMESA1,"watmesaf"
          OPEN      BOKRQ1A1,"bokrq1af"
          OPEN      BOKRQ1A2,"bokrq1af"
          OPEN      BOKRQ1A3,"bokrq1af"
          OPEN      BOKRQ1A4,"bokrq1af"
          OPEN      BOKRQ1A5,"bokrq1af"
          OPEN      BOKRAUA1,"bokrauaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      BOKRC1A7,"bokrc1af"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATBMDA1,"patbmdaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATBMDA3,"patbmdaf"
          OPEN      PATBMDA4,"patbmdaf"
          OPEN      PMSELFA1,"pmselfaf"
          OPEN      PMSELFA2,"pmselfaf"
          OPEN      PMSELFA3,"pmselfaf"
          OPEN      PMSELFA4,"pmselfaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      VISCODA1,"viscodaf"
.
          OPEN      PATINVR3,"patinvrf" * Open the invoice file
          OPEN      PATLOCA1,"patlocaf" * Open the Inpatient Location file
.
          MOVE      ZERO,UPDOPCPI
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRCPIA1,"oprcpiaf"
          TRAPCLR   IO
          IF        OVRCD=0
            TRAP      OVERCOND IF IO
              OPEN      OPRCPIA2,"oprcpiaf"
            TRAPCLR   IO
            IF        OVRCD=0
              MOVE      ONE,UPDOPCPI
            ENDIF
          ENDIF
.
          MOVE      ZERO,UPDOPABI
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRABIA1,"oprabiaf"
          TRAPCLR   IO
          IF        OVRCD=0
            TRAP      OVERCOND IF IO
              OPEN      OPRABIA2,"oprabiaf"
            TRAPCLR   IO
            IF        OVRCD=0
              MOVE      ONE,UPDOPABI
            ENDIF
          ENDIF
.
          READ      CONTROLF,TWENTY7;*46,HBWAIT
          READ      CONTROLF,FORTY;*112,OPCNCODE
.
          READ      CONTROLF,FORTY;*43,OPCNAUDA,OPCNAUDB,*46,OPCNAUDD:
                                   *61,OPCNAUDS,OPCNAUDT
          READ      CONTROLF,FORTY2;*28,OPCNFULL,*90,OPCNASTD,*119,OPCNASLN:
                                    *133,OPCNMIND,*235,OPCNFTIM,*237,OPCNTTIM
          READ      CONTROLF,TEN9;*208,CPMIAD
          READ      CONTROLF,FORTY;*55,OPCNAUDM,*61,OPCNAUDS,*111,OPCNCLSU
          READ      CONTROLF,FORTY2;*93,OPCNCLSH,*118,OPCNCMBD,*241,OPCNSCOM:
                                    *249,OPCNTPAT
          READ      CONTROLF,THIRTY7;*137,HWDSOUR
          READ      CONTROLF,FIFTY9;*220,PTCNUADT
          READ      CONTROLF,SIXTY8;*244,OPCNCPOD,*245,OPCNDSAS,*247,OPCNDSAE
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND05;*216,PTCNDWAW
          READ      CONTROLF,HUND10;*246,PTCNMHCP
          READ      CONTROLF,HUND12;*101,PTCNUFFR
          READ      CONTROLF,HUND13;*29,OPCNTRCS,*31,OPCNUTRA,*41,OPCNOPAV:
                                    *66,OPCNPTMC
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,HUND23;*209,PTCNUTOM,*210,PTCNUESD
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*71,PTCNOECW,*72,PTCNOECE
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      MLTHCPA1,"mlthcpaf"
          OPEN      MLTHCPA2,"mlthcpaf"
          OPEN      MEHVI1A1,"mehvi1af"
.
          IF        CPMIAD=1
            OPEN      PATURAD1,"paturadf"
          ENDIF
          IF        OPCNAUDB<>1
            OPEN      OPRAUDDA,"opraudda"
          ENDIF
          IF        OPCNAUDS<>1
            OPEN      OPRAUDSE,"opraudse"
          ENDIF
.
          MOVE      ONE,OPRWEBSR      * Assigned to 1 = OPRWEB01
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRAVEA1,"opraveaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PMSALNA1,"pmsalnaf"
          CALL      OPICO1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
            OPEN      OPRAAE11,"opraaeaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ZERO,AAEFLAG
          ELSE
            MOVE      ONE,AAEFLAG
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,OPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,EXPCMTNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,XPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,YPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,ZPCOMFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEA         * Re-order cases temp file
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEB         * Re-order theare requests display
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEC         * temp file for Doctor/Consultant
.
          MOVE      ONE,OECWINDC
          MATCH     "1",PTCNOECW
          IF         @EQUAL
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBOECA1,"weboecaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBOESA1,"weboesaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA1,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA5,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,CASEUNIQ
          MOVE      SP70,CORSP001
          MOVE      SP70,CORSP003
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,SUPRLEVL
          MOVE      SP70,SUPERLEV
          MOVE      SP70,UPDATATR
          MOVE      SP70,UPDATEBK
          MOVE      SP70,TEAMNUMB
          MOVE      SP70,SAVEURNO
          MOVE      SP70,DEFTVIEW
          MOVE      ZERO,BOOKFLAG
          MOVE      ZERO,WAITFLAG
          MOVE      SP70,NOBKDES2
          MOVE      ZERO,PREAFLAG
          MOVE      ZERO,SHOWDAYD
          MOVE      ZERO,SHOWRBAY
          MOVE      ZERO,SHOWPLOS
          MOVE      ZERO,SHOWSURG
.
          MOVE      ZERO,SHOWBLRQ
          MOVE      Z70,ACCPORDN
          MOVE      "000",TEMPLATE
          MOVE      TWO,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          PACK      NEXTLINK,SP70,SP70,SP70,SP70
          MOVE      ZERO,UPDATEDA
          MOVE      ZERO,UPDATEDB
          MOVE      ZERO,UPDATEDC
          MOVE      ZERO,UPDATEDD
          MOVE      ZERO,UPDATEDE
          MOVE      ZERO,UPDATEDF
          MOVE      ZERO,UPDATEDG
          MOVE      ZERO,UPDATEDH
          MOVE      ZERO,UPDATEDI
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,SHOWFLAG
          MOVE      ZERO,SHOWREFD
          MOVE      ZERO,DISPTEAM
          MOVE      SP70,JREGFORM
          MOVE      SP70,DOBKINDC
          MOVE      SP70,CHCKOVER
          MOVE      SP70,SVMPFLAG
          MOVE      ZERO,USEWATMT
          MOVE      ZERO,COMNFLAG
          MOVE      ZERO,DEADFLAG
          MOVE      Z70,FIRSTBOK
.
          MOVE      SP70,DOCTCODE
          MOVE      SP70,DOCTTYPE
          MOVE      SP70,DOCTORTP
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,SESSKEYS
          MOVE      SP70,NEWSESSI
          MOVE      SP70,TRANREAS
          MOVE      SP70,CASEKEYS
          MOVE      SP70,MVTOCASE
          MOVE      SP70,SAVECASE
          MOVE      SP70,ADMISNUM
          MOVE      ZERO,CHKBLOCK
          MOVE      ZERO,ADJSTART
          MOVE      ZERO,UPDATDOC
          MOVE      ZERO,CURRCASE
          MOVE      ZERO,DURATION
          MOVE      SP70,INVADMNO
          MOVE      ZERO,USEINVAD
          MOVE      SP70,ADMISNID
.
          MOVE      Z70,OPDEA001
          MOVE      Z70,PATCLAIM
          MOVE      Z70,OPDEA002
          MOVE      Z70,OPDEA003
          MOVE      Z70,OPDEA004
          MOVE      Z70,OPDEA005
          MOVE      Z70,OPDEA006
          MOVE      Z70,OPDEA007
          MOVE      Z70,OPDEA008
          MOVE      Z70,OPDEA009
          MOVE      Z70,OPDEA010
          MOVE      Z70,OPDEA011
          MOVE      Z70,OPDEA012
          MOVE      Z70,OPDEA013
          MOVE      Z70,OPDEA014
          MOVE      Z70,OPDEA015
          MOVE      Z70,OPDEA016
          MOVE      Z70,OPDEA017
          MOVE      Z70,OPDEA018
          MOVE      Z70,OPDEA019
          MOVE      Z70,OPDEA020
          MOVE      Z70,OPDEA021
          MOVE      Z70,OPDEA022
          MOVE      Z70,OPDEA023
          MOVE      Z70,OPDEA024
          MOVE      Z70,OPDEA025
          MOVE      Z70,OPDEA026
          MOVE      Z70,OPDEA027
          MOVE      Z70,OPDEA028
          MOVE      Z70,OPDEA029
          MOVE      Z70,OPDEA030
          MOVE      Z70,OPDEA031
          MOVE      Z70,OPDEA032
          MOVE      Z70,OPDEA033
          MOVE      Z70,OPDEA034
          MOVE      Z70,OPDEA035
          MOVE      Z70,OPDEA036
          MOVE      Z70,OPDEA037
          MOVE      Z70,OPDEA038
          MOVE      Z70,OPDEA039
          MOVE      Z70,OPDEA040
          MOVE      Z70,OPDEA041
          MOVE      Z70,OPDEA042
          MOVE      Z70,OPDEA043
          MOVE      Z70,OPDEA044
          MOVE      Z70,OPDEA045
          MOVE      Z70,OPDEA046
          MOVE      Z70,OPDEA047
          MOVE      Z70,OPDEA048
          MOVE      Z70,OPDEA049
          MOVE      Z70,OPDEA050
          MOVE      Z70,OPDEA051
.
          MOVE      Z70,REASFC06
          MOVE      Z70,REASFC08
          MOVE      Z70,UPDFLD06
          MOVE      Z70,UPDFLD08
          MOVE      Z70,OPHIS001   * Transfer Reason
.
          MOVE      Z70,PTMSX003   * ptmxlga - used for ECT other hospital
          MOVE      Z70,PATTITLE   * Title
          MOVE      Z70,PATSNAME   * Surname
          MOVE      Z70,PATGNAME   * Given Name
          MOVE      Z70,PATADDR1   * Address Line 1
          MOVE      Z70,PATADDR2   * Address Line 2
          MOVE      Z70,PATADDR3   * Address Line 3
          MOVE      Z70,PATPOSTC   * Address Post Code
          MOVE      Z70,PATBUSPH   * Business Phone
          MOVE      Z70,PATHOMPH   * Home Phone
          MOVE      Z70,PATGENDE   * Gender
          MOVE      Z70,PATMSTAT   * Marital Status
          MOVE      Z70,PATBIRDT   * Birth Date
          MOVE      Z70,PATCOBIR   * Country of Birth
          MOVE      Z70,PATRELIG   * Religion
          MOVE      Z70,PATRSTAT   * Resident Status
          MOVE      Z70,PATOCCUP   * Occupation
          MOVE      Z70,PATMEDIC   * Medicare No
          MOVE      Z70,PATPENSI   * Pension No
          MOVE      Z70,PATPENEX   * Pension Exp Date
          MOVE      Z70,PATHFUND   * Patient Health Fund
          MOVE      Z70,PATPAYOR   * Payor
          MOVE      Z70,PATADMDT   * Admission Date
.
          MOVE      "9999",OPEREXPD  * Operation Duration
          MOVE      Z70,OPERANAE  * Anaesthetic Code (Cat. OA )
          MOVE      Z70,OPERTYPE  * Operation Type   (Cat. OY )
          MOVE      Z70,OPERTRAN  * Transport Code   (Cat. OR )
          MOVE      Z70,OPERPLOS  * Planned Length of Stay
          MOVE      Z70,OPERUSR1  * User Defined 1 (Category Y6)
          MOVE      Z70,OPERUSR2  *              2 (Category Y7)
          MOVE      Z70,OPERUSR3  *              3 (Category Y8)
          MOVE      Z70,OPERUSR4  *              4 (Category Y9)
          MOVE      Z70,OPERPRV1  * Provisional item # 1 ( MBS or ICD9)
          MOVE      Z70,OPERPRV2  * Provisional item # 2 ( MBS or ICD9)
          MOVE      Z70,OPERPRV3  * Provisional item # 3 ( MBS or ICD9)
          MOVE      Z70,OPERPRV4  * Provisional item # 4 ( MBS or ICD9)
          MOVE      Z70,OPERPRV5  * Provisional item # 5 ( MBS or ICD9)
          MOVE      Z70,OPERPRV6  * Provisional item # 6 ( MBS or ICD9)
          MOVE      Z70,OPERPRV7  * Provisional item # 7 ( MBS or ICD9)
          MOVE      Z70,OPERPRV8  * Provisional item # 8 ( MBS or ICD9)
          MOVE      Z70,OPERPRV9  * Provisional item # 9 ( MBS or ICD9)
          MOVE      Z70,OPERPR10  * Provisional item # 10( MBS or ICD9)
          MOVE      Z70,OPERPR11  * Provisional item # 11( MBS or ICD9)
          MOVE      Z70,OPERPR12  * Provisional item # 12( MBS or ICD9)
          MOVE      Z70,OPERPR13  * Provisional item # 13( MBS or ICD9)
          MOVE      Z70,OPERPR14  * Provisional item # 14( MBS or ICD9)
          MOVE      Z70,OPERPR15  * Provisional item # 15( MBS or ICD9)
          MOVE      Z70,OPERPR16  * Provisional item # 16( MBS or ICD9)
          MOVE      Z70,OPERPR17  * Provisional item # 17( MBS or ICD9)
          MOVE      Z70,OPERPR18  * Provisional item # 18( MBS or ICD9)
          MOVE      Z70,OPERPR19  * Provisional item # 19( MBS or ICD9)
          MOVE      Z70,OPERPR20  * Provisional item # 20( MBS or ICD9)
          MOVE      Z70,OPERPR21  * Provisional item # 21( MBS or ICD9)
          MOVE      Z70,OPERPR22  * Provisional item # 22( MBS or ICD9)
          MOVE      Z70,OPERPR23  * Provisional item # 23( MBS or ICD9)
          MOVE      Z70,OPERPR24  * Provisional item # 24( MBS or ICD9)
          MOVE      Z70,OPERPR25  * Provisional item # 25 ( MBS or ICD9)
          MOVE      Z70,OPERPR26  * Provisional item # 26 ( MBS or ICD9)
          MOVE      Z70,OPERPR27  * Provisional item # 27 ( MBS or ICD9)
          MOVE      Z70,OPERPR28  * Provisional item # 28 ( MBS or ICD9)
          MOVE      Z70,OPERPR29  * Provisional item # 29 ( MBS or ICD9)
          MOVE      Z70,OPERPR30  * Provisional item # 30 ( MBS or ICD9)
.
          MOVE      Z70,OPERDES1  * Operation description line 1
          MOVE      Z70,OPERDES2  *                            2
          MOVE      Z70,OPERDES3  *                            3
          MOVE      Z70,OPERDES4  *                            4
          MOVE      Z70,OPERDES5  *                            5
          MOVE      Z70,OPERDES6  *                            6
          MOVE      Z70,OPERCOMM  * Comments
          MOVE      Z70,OPERCANC  * Cancellation Code (Category SC)
          MOVE      Z70,OPERTHET  * Operating Room Code
          MOVE      Z70,OPERKNOW  * Known Infection (Category OK)
          MOVE      Z70,OPERPREF  * Doctors Operation Preference
.
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,NEXTPAGE
          MOVE      SP70,PATCANTH
          MOVE      ZERO,CANADMIS
          MOVE      SP70,PATCANAD
.
          MOVE      Z70,BKREC001
          MOVE      Z70,BKREC002
          MOVE      Z70,BKREC003
          MOVE      Z70,BKREC004
          MOVE      Z70,BKREC005
          MOVE      Z70,BKREC006
          MOVE      Z70,BKREC007
          MOVE      Z70,BKREC008
          MOVE      Z70,BKREC009
          MOVE      Z70,BKREC010
          MOVE      Z70,BKREC011
          MOVE      Z70,BKREC012
          MOVE      Z70,BKREC013
          MOVE      Z70,BKREC014
          MOVE      Z70,BKREC015
          MOVE      Z70,BKREC016
          MOVE      Z70,BKREC017
          MOVE      Z70,BKREC018
          MOVE      Z70,BKREC019
          MOVE      Z70,BKREC020
          MOVE      Z70,BKREC021
          MOVE      Z70,BKREC022
          MOVE      Z70,BKREC023
          MOVE      Z70,BKREC024
          MOVE      Z70,BKREC025
          MOVE      Z70,BKREC026
          MOVE      Z70,BKREC027
          MOVE      Z70,BKREC028
          MOVE      Z70,BKREC029
          MOVE      Z70,BKREC030
          MOVE      Z70,BKREC031
          MOVE      Z70,BKREC032
          MOVE      Z70,BKREC033
          MOVE      Z70,BKREC034
          MOVE      Z70,BKREC035
          MOVE      Z70,BKREC036
          MOVE      Z70,BKREC037
          MOVE      Z70,BKREC038
.
          CALL      CPBKRX00
.
          MOVE      SP70,WATTRKEY
          MOVE      Z70,WATTR001
          MOVE      Z70,WATTR002
          MOVE      Z70,WATTR003
          MOVE      Z70,WATTR004
          MOVE      Z70,WATTR005
          MOVE      Z70,WATTR006
          MOVE      Z70,WATTR007
          MOVE      Z70,WATTR008
          MOVE      Z70,WATTR009
          MOVE      Z70,WATTR010
          MOVE      Z70,WATTR011
          MOVE      Z70,WATTR012
          MOVE      Z70,WATTR013
          MOVE      Z70,WATTR014
          MOVE      Z70,WATTR015
          MOVE      Z70,WATTR016
          MOVE      Z70,WATTR017
          MOVE      Z70,WATTR018
          MOVE      Z70,WATTR019
          MOVE      Z70,WATTR020
          MOVE      Z70,WATTR021
          MOVE      Z70,WATTR022
          MOVE      Z70,WATTR023
          MOVE      Z70,WATTR024
          MOVE      Z70,WATTR025
          MOVE      Z70,WATTR026
          MOVE      Z70,WATTR027
          MOVE      Z70,WATTR028
          MOVE      Z70,WATTR029
          MOVE      Z70,WATTR030
          MOVE      Z70,WATTR031
          MOVE      Z70,WATTR032
          MOVE      Z70,WATTR033
          MOVE      Z70,WATTR034
          MOVE      Z70,WATTR035
          MOVE      Z70,WATTR036
          MOVE      Z70,WATTR037
          MOVE      Z70,WATTR038
          MOVE      Z70,WATTR039
          MOVE      Z70,WATTR040
          MOVE      Z70,WATTR041
          MOVE      Z70,WATTR042
          MOVE      Z70,WATTR043
          MOVE      Z70,WATTR044
          MOVE      Z70,WATTR045
          MOVE      Z70,WATTR046
          MOVE      Z70,WATTR047
          MOVE      Z70,WATTR048
          MOVE      SP70,VALDCODE
          MOVE      SP70,VALDEDAT
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDUNIQ
          MOVE      ZERO,ADDWLFLG
          MOVE      Z70,WATHI002
          MOVE      SP70,SAVBMDT
          MOVE      ZERO,CURRENTA
          MOVE      Z70,PTELG014
          MOVE      Z70,PTELG033
          MOVE      Z70,PTMIS001
          MOVE      Z70,PTMIS002
          MOVE      Z70,PTMIS013
          MOVE      Z70,PTMIS014
          MOVE      Z70,PTMIS015
          MOVE      Z70,PTMIS020
          MOVE      Z70,PTMIS027
          MOVE      Z70,PTMIS030
          MOVE      Z70,PTVIS043
          MOVE      Z70,PTVIS076
          MOVE      SP70,PTVIS079
          MOVE      Z70,PTVIS111
          MOVE      Z70,BOKRX039
.          MOVE      SP70,UVTHINDI
.
.         CLEAR     OPCOMFNM
.         APPEND    "OPWB01",OPCOMFNM
.         APPEND    PORT,OPCOMFNM
.         RESET     OPCOMFNM
.         REP       " 0",OPCOMFNM
.         PREP      OPCOMFIL,OPCOMFNM
.
          CALL      CPOPAR00
          CALL      CPOPPO00
.
          MOVE      SP70,CPADM002
          MOVE      SP70,CPADM003
          MOVE      SP70,CPADM004
          MOVE      SP70,CPADM008
          MOVE      SP70,PREAD002
          MOVE      SP70,PREAD003
.
          MOVE      Z70,LINKVIST
.
          MOVE      SP70,SCHDPRNT
          MOVE      SP70,STATNCOD
.
          PACK      PTRGM001,SP70
          PACK      PTRGM002,SP70
          PACK      PTRGM003,SP70
.
          MOVE      ZERO,LASTITEM
          MOVE      ZERO,VSCMTFLG
.
          CALL      COPRAA00
.
          MOVE      SP70,FFOECIND
.
          MOVE      SP70,PTELF001
          MOVE      SP70,PTELF002
          MOVE      SP70,PTELF003
          MOVE      SP70,PTELF004
          MOVE      SP70,PTELF005
          MOVE      SP70,PTELF006
          MOVE      SP70,PTELF007
          MOVE      SP70,PTELF008
          MOVE      SP70,PTELF009
          MOVE      SP70,PTELF010
          MOVE      SP70,PTELF011
          MOVE      SP70,PTELF012
          MOVE      SP70,PTELF013
          MOVE      SP70,PTELF014
          MOVE      SP70,PTELF015
          MOVE      SP70,PTELF016
          MOVE      SP70,PTELF017
          MOVE      SP70,PTELF018
          MOVE      SP70,PTELF019
          MOVE      SP70,PTELF020
          MOVE      SP70,PTELF021
          MOVE      SP70,PTELF022
          MOVE      SP70,PTELF023
          MOVE      SP70,PTELF024
          MOVE      SP70,PTELF025
          MOVE      SP70,PTELF026
          MOVE      SP70,PTELF027
.
          MOVE      SP70,PTELF028
          MOVE      SP70,PTELF029
          MOVE      SP70,PTELF030
          MOVE      SP70,PTELF031
          MOVE      SP70,PTELF032
.
          MOVE      SP70,PTELF033
          MOVE      SP70,PTELF034
.
          MOVE      SP70,PACAFLAG
          MOVE      SP70,THRQBKTY
.
          CALL      CLRREQ00
.
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTLOCN
          MOVE      SP70,FILTPRIO
          MOVE      ZERO,TABLVIEW
          MOVE      SP70,AUDTREQN
          MOVE      SP70,REQUESTN
          MOVE      SP70,BKTHVICK
          MOVE      SP70,FILTSETY
.
          MOVE      SP70,UPPBRAUB
          MOVE      SP70,THETRQIN
          MOVE      SP70,THETRQVL
.
          PACK      USERDF01,Z70,Z70
          PACK      USERDF02,Z70,Z70
          PACK      USERDF03,Z70,Z70
          PACK      USERDF04,Z70,Z70
          PACK      USERDF05,Z70,Z70
          PACK      USERDF06,Z70,Z70
          PACK      USERDF07,Z70,Z70
          PACK      USERDF08,Z70,Z70
          PACK      USERDF09,Z70,Z70
          PACK      USERDF10,Z70,Z70
.
          CALL      CLRATR00 
          MOVE      SP70,HAATR010
          MOVE      SP70,IIATR010
          MOVE      SP70,PPATR006
          MOVE      SP70,PRATR010
          MOVE      SP70,FRATR010
.
          CALL      CPVSCO00
          CALL      CLPMSWX1
          CALL      CLRCPI00
          CALL      CLRABI00
.
          MOVE      SP70,OLDADATE
          MOVE      Z70,TRNSFSRC
          PACK      COMLINE1,SP70,SP70
          PACK      COMLINE2,SP70,SP70
          MOVE      SP70,ONCLNKIN
          MOVE      SP70,FROMWAIT
          MOVE      SP70,EREFRLID
.
          MOVE      SP70,EXTRPROV
          MOVE      SP70,EXTRPRV2
          MOVE      SP70,EXTRPRV3
          MOVE      SP70,EXTRPRV4
          MOVE      SP70,EXTRPRV5

          MOVE      ZERO,DISPDAYC                *T0846427
          MOVE      ZERO,DAYCMCNT                *T0846427
          MOVE      SP70,AUTOPREF
          MOVE      ZERO,VSCMTLIN
          MOVE      ZERO,DISPWKNO
          MOVE      ZERO,PROCFLAG
          MOVE      SP70,OECMINDC
          MOVE      "11111",SHOWVIEW
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
.
          MOVE      SP70,NEWBOKRQ
.
          MOVE      ZERO,EXPCMTFL
.
CLRPAR99  RETURN
.
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "caseuniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEUNIQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "teamnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEAMNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn=",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nobkdes2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOBKDES2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprlevl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRLEVL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPERLEV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispteam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPTEAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextlink=",QRYNAME
          IF        @EQUAL
            PACK      NEXTLINK,QRYDATA,SP70,SP70,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deadflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEADFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "useinvad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEINVAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisnum=",QRYNAME
          IF        @EQUAL
            PACK      ADMISNUM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "firstbok=",QRYNAME
          IF        @EQUAL
            PACK      FIRSTBOK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opcom",QRYNAME
          IF        @EQUAL
            CALL      OPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extprcmt",QRYNAME
          IF        @EQUAL
            CALL      GTEXDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xpcom",QRYNAME
          IF        @EQUAL
            CALL      XPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ypcom",QRYNAME
          IF        @EQUAL
            CALL      YPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "zpcom",QRYNAME
          IF        @EQUAL
            CALL      ZPCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctortp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTORTP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            PACK      DEFTVIEW,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmsx003=",QRYNAME
          IF        @EQUAL
            PACK      PTMSX003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chkblock=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHKBLOCK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckover=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHCKOVER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "currenta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CURRENTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adjstart=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADJSTART
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatdoc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATDOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "currcase=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CURRCASE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "duration=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DURATION
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm008=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11         * Change Date format
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      CPADM008,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CPADM008
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pread002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREAD002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pread003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREAD003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newsessi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWSESSI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranreas=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvtocase=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MVTOCASE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patcanth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCANTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdedat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,VALDEDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDURNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valduniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDUNIQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patcanad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCANAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "canadmis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CANADMIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admcommt=",QRYNAME
          IF        @EQUAL
.   Comments ????
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattrkey=",QRYNAME
          IF        @EQUAL
            PACK      WATTRKEY,QRYDATA,SP70,SP70
            UNPACK    WATTRKEY,KEY17
            MATCH     SP70,KEY17
            IF        @EQUAL
              MOVE      SP70,WATTRKEY
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattr",QRYNAME
          IF        @EQUAL
            CALL      WATTRSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkrec",QRYNAME
          IF        @EQUAL
            CALL      BKRECSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bokrx",QRYNAME
          IF        @EQUAL
            CALL      SPBKRX00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pat",QRYNAME
          GOTO      SETPAR10 IF EQUAL
.
          MATCH     "opard",QRYNAME
          IF        @EQUAL
            CALL      SPOAR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppop",QRYNAME
          IF        @EQUAL
            CALL      SPPOP000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppoa",QRYNAME
          IF        @EQUAL
            CALL      SPPOA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppoi",QRYNAME
          IF        @EQUAL
            CALL      SPPOI000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppos",QRYNAME
          IF        @EQUAL
            CALL      SPPOS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppoo",QRYNAME
          IF        @EQUAL
            CALL      SPPOO000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oppor",QRYNAME
          IF        @EQUAL
            CALL      SPPOR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opdea",QRYNAME
          IF        @EQUAL
            CALL      SEDEA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operexpd=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,OPEREXPD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operanae=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERANAE
            PACK      OPERANAE,OPERANAE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opertype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERTYPE
            PACK      OPERTYPE,OPERTYPE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opertran=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERTRAN
            PACK      OPERTRAN,OPERTRAN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operusr1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERUSR1
            PACK      OPERUSR1,OPERUSR1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operusr2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERUSR2
            PACK      OPERUSR2,OPERUSR2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operusr3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERUSR3
            PACK      OPERUSR3,OPERUSR3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operusr4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERUSR4
            PACK      OPERUSR4,OPERUSR4,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV1
            PACK      OPERPRV1,OPERPRV1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV2
            PACK      OPERPRV2,OPERPRV2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV3
            PACK      OPERPRV3,OPERPRV3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV4
            PACK      OPERPRV4,OPERPRV4,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV5
            PACK      OPERPRV5,OPERPRV5,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv6=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV6
            PACK      OPERPRV6,OPERPRV6,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv7=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV7
            PACK      OPERPRV7,OPERPRV7,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv8=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV8
            PACK      OPERPRV8,OPERPRV8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operprv9=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPRV9
            PACK      OPERPRV9,OPERPRV9,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr10=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR10
            PACK      OPERPR10,OPERPR10,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr11=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR11
            PACK      OPERPR11,OPERPR11,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr12=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR12
            PACK      OPERPR12,OPERPR12,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr13=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR13
            PACK      OPERPR13,OPERPR13,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr14=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR14
            PACK      OPERPR14,OPERPR14,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr15=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR15
            PACK      OPERPR15,OPERPR15,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr16=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR16
            PACK      OPERPR16,OPERPR16,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr17=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR17
            PACK      OPERPR17,OPERPR17,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr18=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR18
            PACK      OPERPR18,OPERPR18,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr19=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR19
            PACK      OPERPR19,OPERPR19,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr20=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR20
            PACK      OPERPR20,OPERPR20,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr21=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR21
            PACK      OPERPR21,OPERPR21,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr22=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR22
            PACK      OPERPR22,OPERPR22,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr23=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR23
            PACK      OPERPR23,OPERPR23,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr24=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR24
            PACK      OPERPR24,OPERPR24,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr25=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR25
            PACK      OPERPR25,OPERPR25,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr26=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR26
            PACK      OPERPR26,OPERPR26,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr27=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR27
            PACK      OPERPR27,OPERPR27,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr28=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR28
            PACK      OPERPR28,OPERPR28,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr29=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR29
            PACK      OPERPR29,OPERPR29,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpr30=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPR30
            PACK      OPERPR30,OPERPR30,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES1
            PACK      OPERDES1,OPERDES1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES2
            PACK      OPERDES2,OPERDES2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES3
            PACK      OPERDES3,OPERDES3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES4
            PACK      OPERDES4,OPERDES4,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES5
            PACK      OPERDES5,OPERDES5,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operdes6=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERDES6
            PACK      OPERDES6,OPERDES6,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opercomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERCOMM
            PACK      OPERCOMM,OPERCOMM,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opercanc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERCANC
            PACK      OPERCANC,OPERCANC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operthet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERTHET
            PACK      OPERTHET,OPERTHET,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operknow=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERKNOW
            PACK      OPERKNOW,OPERKNOW,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "operpref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPERPREF
            PACK      OPERPREF,OPERPREF,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ophis001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPHIS001
            GOTO      SETPAR99
          ENDIF
.
SETPAR10  MATCH     "pattitle=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATTITLE
            PACK      PATTITLE,PATTITLE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patsname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATSNAME
            PACK      PATSNAME,PATSNAME,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patgname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATGNAME
            PACK      PATGNAME,PATGNAME,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataddr1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATADDR1
            PACK      PATADDR1,PATADDR1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataddr2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATADDR2
            PACK      PATADDR2,PATADDR2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataddr3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATADDR3
            PACK      PATADDR3,PATADDR3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpostc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPOSTC
            PACK      PATPOSTC,PATPOSTC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patbusph=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATBUSPH
            PACK      PATBUSPH,PATBUSPH,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pathomph=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATHOMPH
            PACK      PATHOMPH,PATHOMPH,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patgende=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATGENDE
            PACK      PATGENDE,PATGENDE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patmstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATMSTAT
            PACK      PATMSTAT,PATMSTAT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patbirdt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATBIRDT
            PACK      PATBIRDT,PATBIRDT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patcobir=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCOBIR
            PACK      PATCOBIR,PATCOBIR,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patrelig=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATRELIG
            PACK      PATRELIG,PATRELIG,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patrstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATRSTAT
            PACK      PATRSTAT,PATRSTAT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patoccup=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATOCCUP
            PACK      PATOCCUP,PATOCCUP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patmedic=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATMEDIC
            PACK      PATMEDIC,PATMEDIC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpensi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPENSI
            PACK      PATPENSI,PATPENSI,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpenex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPENEX
            PACK      PATPENEX,PATPENEX,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pathfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATHFUND
            PACK      PATHFUND,PATHFUND,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpayor=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPAYOR
            PACK      PATPAYOR,PATPAYOR,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patadmdt=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      PATADMDT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patclaim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCLAIM
            PACK      PATCLAIM,PATCLAIM,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatatr=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATATR
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedb=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDB
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedd=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDD
           GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatede=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedf=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDF
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedg=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDG
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedh=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDH
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatedi=",QRYNAME
          IF       @EQUAL
           MOVE      QRYDATA,UPDATEDI
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "updatebk=",QRYNAME
          IF       @EQUAL
           PACK      QRYDATA,QRYDATA,SP70
           MOVE      QRYDATA,UPDATEBK
           GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      WATHI002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "linkvist=",QRYNAME
          IF       @EQUAL
           PACK      QRYDATA,QRYDATA,SP70
           MOVE      QRYDATA,LINKVIST
           GOTO      SETPAR99
          ENDIF
.
          MATCH    "ptelg014=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTELG014
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptelg033=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTELG033
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis001=",QRYNAME
          IF       @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTMIS001,CCENT,CYEAR,CMON,CDAY
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis002=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS002
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis013=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS013
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis014=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS014
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis015=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS015
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis020=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS020
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis027=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS027
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptmis030=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTMIS030
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptvis043=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTVIS043
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptvis076=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTVIS076
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptvis079=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTVIS079
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "ptvis111=",QRYNAME
          IF       @EQUAL
            MOVE     QRYDATA,PTVIS111
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "pmsoc",QRYNAME
          IF        @EQUAL
            CALL      SPMOC000
            CALL      SWBOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oes0",QRYNAME
          IF        @EQUAL
            CALL      SPMOS000
            CALL      SWBOS000
            GOTO      SETPAR99
          ENDIF
.
.          MATCH    "uvthindi=",QRYNAME
.          IF       @EQUAL
.            MOVE     QRYDATA,UVTHINDI
.            GOTO     SETPAR99
.          ENDIF
.
          MATCH     "schdprnt",QRYNAME
          IF        @EQUAL
            PACK      SCHDPRNT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod",QRYNAME
          IF        @EQUAL
            PACK      STATNCOD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm",QRYNAME
          IF        @EQUAL
            CALL      SPRGM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "jregform",QRYNAME
          IF        @EQUAL
            PACK      JREGFORM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
            MOVE      ONE,VSCMTFLG
          ENDIF
.
          MATCH     "dobkindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOBKINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opraa",QRYNAME
          IF        @EQUAL
            CALL      SOPR0000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ffoecind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FFOECIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptelf",QRYNAME
          IF        @EQUAL
            CALL      STELF000              * Set free format oec fields
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasfc06=",QRYNAME
          IF        @EQUAL
            PACK      REASFC06,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasfc08=",QRYNAME
          IF        @EQUAL
            PACK      REASFC08,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updfld06=",QRYNAME
          IF        @EQUAL
            PACK      UPDFLD06,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updfld08=",QRYNAME
          IF        @EQUAL
            PACK      UPDFLD08,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisnid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "svmpflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SVMPFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "usewatmt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEWATMT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkreq",QRYNAME
          IF        @EQUAL
            CALL      SBKREQ00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thrqbkty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THRQBKTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtprio=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTPRIO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtlocn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTLOCN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtsety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tablview=",QRYNAME
          IF        @EQUAL
            PACK      TABLVIEW,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "audtreqn=",QRYNAME
          IF        @EQUAL
            PACK      AUDTREQN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestn=",QRYNAME
          IF        @EQUAL
            PACK      REQUESTN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkthvick=",QRYNAME
          IF        @EQUAL
            PACK      BKTHVICK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uppbraub=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPPBRAUB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thetrqin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THETRQIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thetrqvl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THETRQVL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opd13",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY5,KEY3
            MOVE      KEY3,F3
            STORE     QRYDATA,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                                 USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "haatr010=",QRYNAME
          IF        @EQUAL
            PACK      HAATR010,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "iiatr010=",QRYNAME
          IF        @EQUAL
            PACK      IIATR010,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ppatr006=",QRYNAME
          IF        @EQUAL
            PACK      PPATR006,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pratr010=",QRYNAME
          IF        @EQUAL
            PACK      PRATR010,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fratr010=",QRYNAME
          IF        @EQUAL
            PACK      FRATR010,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vscdcatg",QRYNAME
          IF        @EQUAL
            CALL      SVSCAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vscdcode",QRYNAME
          IF        @EQUAL
            CALL      SVSCOD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            PACK      TRNSFSRC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "comline1=",QRYNAME
          IF        @EQUAL
            PACK      COMLINE1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "comline2=",QRYNAME
          IF        @EQUAL
            PACK      COMLINE2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opcpi",QRYNAME
          IF        @EQUAL
            CALL      SOPCPI00
          ENDIF
.
          MATCH     "opabi",QRYNAME
          IF        @EQUAL
            CALL      SOPABI00
          ENDIF
.
          MATCH     "onclnkin=",QRYNAME
          IF        @EQUAL
            PACK      ONCLNKIN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fromwait=",QRYNAME
          IF        @EQUAL
            PACK      FROMWAIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EREFRLID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pacaflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PACAFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprov=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPROV,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv2=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV2,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv3=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV3,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv4=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV4,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv5=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV5,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispdayc=",QRYNAME                    *T0846427
          IF        @EQUAL
            MOVE      QRYDATA,DISPDAYC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "autopref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUTOPREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispwkno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPWKNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oecmindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OECMINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showview=",QRYNAME
          IF        @EQUAL
            PACK      SHOWVIEW,QRYDATA,SP70
            REP       " 0",SHOWVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newbokrq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBOKRQ
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
.
SEDEA000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,OPDEA001,OPDEA002,OPDEA003,OPDEA004,OPDEA005:
                               OPDEA006,OPDEA007,OPDEA008,OPDEA009,OPDEA010:
                               OPDEA011,OPDEA012,OPDEA013,OPDEA014,OPDEA015:
                               OPDEA016,OPDEA017,OPDEA018,OPDEA019,OPDEA020:
                               OPDEA021,OPDEA022,OPDEA023,OPDEA024,OPDEA025:
                               OPDEA026,OPDEA027,OPDEA028,OPDEA029,OPDEA030:
                               OPDEA031,OPDEA032,OPDEA033,OPDEA034,OPDEA035:
                               OPDEA036,OPDEA037,OPDEA038,OPDEA039,OPDEA040:
                               OPDEA041,OPDEA042,OPDEA043,OPDEA044,OPDEA045:
                               OPDEA046,OPDEA047,OPDEA048,OPDEA049,OPDEA050:
                               OPDEA051
          MOVE       ONE,UPDATEDA
.
SEDEA999  RETURN
.------------------------------------------------------------
. Set Input Comments
.------------------------------------------------------------
OPCOM000  COMPARE   ZERO,COMNFLAG
          IF        @EQUAL
            PREP      OPCOMFIL,OPCOMFNM
            MOVE      ONE,COMNFLAG
          ENDIF
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     OPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     OPCOMFIL,SEQ;QRYDATA
.
OPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      OPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      OPCOM800 IF NOT EQUAL
.
          MATCH     SP70,QRYDATA
          GOTO      OPCOM100 IF EQUAL            * Do not save blank lines
          GOTO      OPCOM100 IF EOS              * Do not save blank lines
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     OPCOMFIL,SEQ;QRYDATA
          GOTO      OPCOM100
.
OPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
OPCOM999  RETURN
.
.-----------------------------------------------------------------------------
. Get Comments from input comment TextArea and write them to the temporary
. file for updating to the database
.-----------------------------------------------------------------------------
GTEXDS00  COMPARE   ZERO,EXPCMTFL
          IF        @EQUAL
            PREP      EXPCMTFI,EXPCMTNM
            MOVE      ONE,EXPCMTFL
          ENDIF
.
          MOVE      "024",KEY3
          WRITE     EXPCMTFI,SEQ;"%START:",KEY3
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     EXPCMTFI,SEQ;QRYDATA
.
GTEXDS10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read file sequentially
          GOTO      GTEXDS99 IF OVER             * If end of file
.
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GTEXDS80 IF NOT EQUAL
.
          MATCH     SP70,QRYDATA
          GOTO      GTEXDS10 IF EQUAL            * Do not save blank lines
          GOTO      GTEXDS10 IF EOS              * Do not save blank lines
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     EXPCMTFI,SEQ;QRYDATA
          GOTO      GTEXDS10
.
GTEXDS80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
.
GTEXDS99  RETURN
.
.----------------------------------------------------------------------------
. Update Extend Procedure Descriptions. First delete all existing old data
. and then add the new data
.----------------------------------------------------------------------------
AUEXDS00  COMPARE   ONE,EXPCMTFL
          GOTO      AUEXDS99 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EXPCMTFI,EXPCMTNM
          TRAPCLR   IO
          BRANCH    OVRCD,AUEXDS99
.
AUEXDS10  READ      EXPCMTFI,SEQ;OPCOMLIN
          GOTO      AUEXDS99 IF OVER
.
          MATCH     "%START:",OPCOMLIN
          GOTO      AUEXDS30 IF NOT EQUAL
.
          UNPACK    OPCOMLIN,D7,OPCOMTYP
          CALL      CLCOM000
.
          MOVE      ZERO,OPCOMCNT
          GOTO      AUEXDS10
.
AUEXDS30  MATCH     SP70,OPCOMLIN
          GOTO      AUEXDS10 IF EQUAL       * Do not save blank lines
          GOTO      AUEXDS10 IF EOS         * Do not save blank lines
.
          ADD       ONE,OPCOMCNT
.
          MOVE      OPDAUNIQ,OPDDUNIQ
          MOVE      OPCOMTYP,OPDDTYPE
          MOVE      OPCOMCNT,OPDDLINE
          MOVE      OPCOMLIN,OPDDDATA
          MOVE      SP70,OPDDSPA
.
          CALL      WROPDED1
.
          GOTO      AUEXDS10
.
AUEXDS99  RETURN
.
WRCOM000  MOVELPTR  QRYDATA,F3
          IF        F3<=CHARNUM
            SFORMAT   VAR,127
            MOVE      "70",CHARNUM
            GOTO      WRCOM999
          ENDIF
          SFORMAT   VAR,CHARNUM
          UNPACK    QRYDATA,VAR,QRYDATA
          WRITE     OPCOMFIL,SEQ;VAR
          SFORMAT   VAR,127
          MOVELPTR  QRYDATA,F3
          SFORMAT   VAR,F3
          MOVE      QRYDATA,VAR
          WRITE     OPCOMFIL,SEQ;VAR;
          SFORMAT   VAR,127
          ASSIGN    70-F3,CHARNUM
WRCOM999  RETURN
.------------------------------------------------------------
. Update Comments
.------------------------------------------------------------
UPCOM000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPCOMFIL,OPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCOM999
.
UPCOM100  READ      OPCOMFIL,SEQ;OPCOMLIN
          GOTO      UPCOM999 IF OVER
          MATCH     "%START:",OPCOMLIN
          IF        @EQUAL
            UNPACK    OPCOMLIN,KEY7,OPCOMTYP
            CALL      CLCOM000
            MOVE      ZERO,OPCOMCNT
            GOTO      UPCOM100
          ENDIF
UPCOM110  ADD       ONE,OPCOMCNT
          PACK      KEY16,OPDAUNIQ,OPCOMTYP,OPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCOM110 IF EQUAL
.
          MOVE      OPCOMLIN,OPDDDATA
          MATCH     SP70,OPDDDATA
          GOTO      UPCOM100 IF EQUAL       * Do not save blank lines
          GOTO      UPCOM100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCOM100
.
UPCOM999  RETURN
.------------------------------------------------------------
. Clear Comments
.------------------------------------------------------------
CLCOM000  PACK      KEY16,OPDAUNIQ,OPCOMTYP,SP70
          CALL      RSOPDED1
CLCOM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCOM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCOM999 IF NOT EQUAL
          MATCH     OPDDTYPE,OPCOMTYP
          GOTO      CLCOM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCOM100
CLCOM999  RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
WATTRSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATTR001,WATTR002,WATTR003,WATTR004,WATTR005:
                               WATTR006,WATTR007,WATTR008,WATTR009,WATTR010:
                               WATTR011,WATTR012,WATTR013,WATTR014,WATTR015:
                               WATTR016,WATTR017,WATTR018,WATTR019,WATTR020:
                               WATTR021,WATTR022,WATTR023,WATTR024,WATTR025:
                               WATTR026,WATTR027,WATTR028,WATTR029,WATTR030:
                               WATTR031,WATTR032,WATTR033,WATTR034,WATTR035:
                               WATTR036,WATTR037,WATTR038,WATTR039,WATTR040:
                               WATTR041,WATTR042,WATTR043,WATTR044,WATTR045:
                               WATTR046,WATTR047,WATTR048
          RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
BKRECSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,BKREC001,BKREC002,BKREC003,BKREC004,BKREC005:
                               BKREC006,BKREC007,BKREC008,BKREC009,BKREC010:
                               BKREC011,BKREC012,BKREC013,BKREC014,BKREC015:
                               BKREC016,BKREC017,BKREC018,BKREC019,BKREC020:
                               BKREC021,BKREC022,BKREC023,BKREC024,BKREC025:
                               BKREC026,BKREC027,BKREC028,BKREC029,BKREC030:
                               BKREC031,BKREC032,BKREC033,BKREC034,BKREC035:
                               BKREC036,BKREC037,BKREC038
          RETURN
.------------------------------------------------------------
. Session List
.------------------------------------------------------------
SESLST00  MATCH     SP70,WATTRKEY
          IF        @EQUAL
            CALL      CLWATDET
          ELSE
            MOVE      WATTRKEY,KEY19
            CALL      RDTREA1
            IF        OVRCD=0
              MOVE      WMURNO,URNUMBER
              MOVE      WMDOCTOR,DOCTCODE
              MOVE      WMUNIT,DOCTTYPE
            ENDIF
          ENDIF
.
          MOVE      DOCTCODE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            CALL     CLRDOC00
          ELSE
            GOTO     SESLST10
          ENDIF
.
SESLST10  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Surgeon Theatre Summary",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,SESLST99
.
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      SESLST99
.
SESLST99  RETURN
.------------------------------------------------------------
. Session List Display Options
.------------------------------------------------------------
SLST0000  BRANCH    FLDITMNO,SLST0100,SLST0200,SLST0300,SLST0400:
                             SLST0500,SLST0600,SLST0700,SLST0800:
                             SLST0900,SLST1000,SLST1100,SLST1200:
                             SLST1300,SLST1400,SLST1500,SLST1600:
                             SLST1700,SLST1800,SLST1900,SLST2000:
                             SLST2100,SLST2200
.
SLST0100  CALL      NEXT0000
          GOTO      SLST9999
.
SLST0200  CALL      PREV0000
          GOTO      SLST9999
.
SLST0300  CALL      CURSTD00
          GOTO      SLST9999
.
SLST0400  CALL      CUREND00
          GOTO      SLST9999
.
SLST0500  CALL      CURYR000
          GOTO      SLST9999
.
SLST0600  CALL      CURMON00
          GOTO      SLST9999
.
SLST0700  CALL      SELV0000
          GOTO      SLST9999
.
SLST0800  MOVE      ZERO,LINKTYPE
          MOVE      ZERO,DOCTSPFC
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      SLST9999
.
SLST1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      SLST9999
.
SLST1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      SLST9999
.
SLST1200  CALL      DOCSEL00
          GOTO      SLST9999
.
SLST1300  MOVE      "ST",CATEGORY
          MOVE      DOCTTYPE,CODE
          CALL      CODSEL00
          GOTO      SLST9999
.
SLST1400  MOVE      ONE,LINKTYPE
          MOVE      ZERO,DOCTSPFC
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST1500  MOVE      "WU",CATEGORY
          MOVE      DOCTTYPE,CODE
          CALL      CODSEL00
          GOTO      SLST9999
.
SLST1600  CALL      UNTSEL00
          GOTO      SLST9999
.
SLST1700  MOVE      TWO,LINKTYPE
          MOVE      ZERO,DOCTSPFC
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST1800  MOVE      ZERO,LINKTYPE
          MOVE      ONE,DOCTSPFC
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST1900  PACK      KEY10,WBSEDOC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;DOCFNAME;
          ELSE
            WRITE     HTMLFILE;WBSEDOC;
          ENDIF
          GOTO      SLST9999
.
SLST2000  WRITE     HTMLFILE;FILTSETY;
          GOTO      SLST9999
.
SLST2100  MOVE      THREE,LINKTYPE
          MOVE      ZERO,DOCTSPFC
          CALL      SESTAB00
          GOTO      SLST9999
.
SLST2200  MOVE      FILTLOCN,CODE           * Surgery Type filter
          MOVE      "YD",CATEGORY
          CALL      CODITM00
          GOTO      SLST9999
.
SLST9999  RETURN
.------------------------------------------------------------
. Calculate Bar for Session
.------------------------------------------------------------
CALBAR00  MOVE      "../images/oprweb01_nm.gif",BARIMAGE
          MOVE      "10",FILHIGH
          ASSIGN    OPSETIMB/OPSEDURA*100.0,SESSFILL
          ASSIGN    OPSETIMB/OPSEDURA*120,F3
          IF        F3>120
            MOVE      "../images/oprweb01_ot.gif",BARIMAGE
            MOVE      "120",F3
          ENDIF
          IF        F3=0
            MOVE      ONE,F3
            MOVE      "1",FILHIGH
          ENDIF
          MOVE      F3,KEY3
          MOVE      F3,BARWIDTH
          SQUEEZE   KEY3
          CLEAR     FILWIDTH
          APPEND    "WIDTH=",FILWIDTH
          APPEND    KEY3,FILWIDTH
          RESET     FILWIDTH
.
          MOVE      FILHIGH,KEY3
          SQUEEZE   KEY3
          CLEAR     FILHIGHT
          APPEND    "HEIGHT=",FILHIGHT
          APPEND    KEY3,FILHIGHT
          RESET     FILHIGHT
          RETURN
.------------------------------------------------------------
. Output Session List Table
.------------------------------------------------------------
SESTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,F3
.
          PACK      KEY22,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPSES1
SESTAB10  CALL      RKOPSES1
          BRANCH    OVRCD,SESTAB90
.
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      SESTAB90 IF NOT EQUAL
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      SESTAB90 IF LESS
.
          MATCH     "3",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MATCH     "003",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MATCH     "4",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MATCH     "004",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MATCH     "5",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MATCH     "005",TEMPLATE
          IF        @EQUAL
            COMPARE   ZERO,OPSESTAT
            GOTO      SESTAB10 IF EQUAL
          ENDIF
.
          MOVE      OPSECLIN,KEY6
          COMPARE   ZERO,OPCNCLSU
          IF        @EQUAL
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,KEY6
            ENDIF
          ENDIF
.
          COMPARE   ONE,DOCTSPFC
          IF        @EQUAL
            MATCH     WBSEDOC,KEY6
            GOTO      SESTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DOCTTYPE
          IF        !@EQUAL
            MATCH     DOCTTYPE,OPSETYPE
            GOTO      SESTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,KEY6
            GOTO      SESTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSETY
          IF        !@EQUAL
            MATCH     SP70,OPSESTYP
            IF        !@EQUAL
              PACK      KEY5,ANST,ANSU,OPSESTYP
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     FILTSETY,TCINDC1
                GOTO      SESTAB10 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTLOCN
          IF        !@EQUAL
             MATCH     FILTLOCN,OPSEDGSI
             GOTO      SESTAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      ZERO,PERSBOOK
          ASSIGN    OPSETIMB,PERSBOOK
          DIV       OPSEDURA,PERSBOOK       * Calc % Booked
          MULT      HUNDRED,PERSBOOK
          MOVE      PERSBOOK,DISPPBOK
          IF        PERSBOOK > 100
            MOVE      HUNDRED,DISPPBOK
          ENDIF
.
          COMPARE   TWO,LINKTYPE
          IF        @EQUAL
..         COMPARE   ONE,OPSESUSP         * Suspended
..         GOTO      SESTAB10 IF EQUAL
..         MOVE      OPSEDURA,F6          * Check for time avalibale in session
..         SUB       OPSETIMB,F6
..         COMPARE   F6,OPDAEXPD
..         GOTO      SESTAB10 IF NOT LESS
           SUB       OPSETIMB,OPSEDURA     * For Avail Op Min Display
          ENDIF
.
          CALL      SESDET00    * Get Display Details for Session
          CALL      SESROW00    * Display Table Row
          GOTO      SESTAB10    * Read Next
.
SESTAB90
SESTAB99  RETURN
.------------------------------------------------------------
. Output Session List (TABLE ROW)
.------------------------------------------------------------
SESROW00  CALL      CALBAR00     * Calculate Bar
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          CALL      GETLNK00                    * Generate HTML Link
.
          MOVE      OPSECLIN,KEY6
          COMPARE   ZERO,OPCNCLSU
          IF        @EQUAL
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,KEY6
            ENDIF
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            MOVE      DOCFNAME,SURFNAME
          ELSE
            MOVE      "&nbsp;",SURFNAME
            MOVE      OPCLDESC,SURFNAME
          ENDIF
.
          MOVE      ZERO,TIMELEFT
          ASSIGN    OPSEDURA-OPSETIMB,TIMELEFT
.
          CALL      GASS0000                    * Get first assistant name
.
          CALL      WKCN0000                * Week cycle number
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPSDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,OPSETIME,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",#"":
                                           OPSEDATE,OPSETIME,"#",#"":     *1
                                           SURFNAME,"#",#"":              *2
                                           ANAFNAME,"#",#"":              *3
                                           KEY80,"#",#"":                 *4
                                           STYPDES,"#",#"":               *5
                                           OPSESUSP,"#",#"":              *6
                                           BARWIDTH,"#",#"":              *7
                                           OPSEDURA,"#",#"":              *8
                                           OPSETIMB,"#",#"":              *9
                                           OPSEACTD,"#",#"":              *10
                                           DISPPBOK,"%","#",#"":          *11
                                           TIMELEFT,"#",#"":              *12
                                           DAYNAM3,"#",#"":               *13
                                           OPSESPI1,OPSESPI2,"#",#"":     *14
                                           OPSETHET,"#",#"":              *15
                                           ASSFNAME,"#",#"":              *16
                                           TUTYPDES,"#",#"":              *17
                                           WEEKCYCL,"#",#"":              *18
                                           DISPSDAT,WEEKCYCL,"#");"       *19
.
          RETURN
.------------------------------------------------------------
. Determine HTML Link
.------------------------------------------------------------
GETLNK00  BRANCH    LINKTYPE,GETLNK10,GETLNK20,GETLNK30
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&sesskeys=",HTMLLINK
          APPEND    OPSEHOSP,HTMLLINK
          APPEND    OPSEDATE,HTMLLINK
          APPEND    OPSETIME,HTMLLINK
          APPEND    OPSECLIN,HTMLLINK
          RESET     HTMLLINK
          GOTO      GETLNK99
.
GETLNK10  CLEAR     HTMLLINK
          APPEND    "javascript:SessionLink('",HTMLLINK
          APPEND    OPSEHOSP,HTMLLINK
          APPEND    OPSEDATE,HTMLLINK
          APPEND    OPSETIME,HTMLLINK
          APPEND    OPSECLIN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPSEFIND,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          GOTO      GETLNK99
.
GETLNK20  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          REP       " 0",CDAY
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY19,OPSEDATE,OPSETIME,OPSECLIN
          LOAD      DAYNAM3,OPSEDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      " Time ",D6
          MOVE      "Available",D9
          PACK      KEY42,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,D6:
                    OPSETIME,SP1,D9,SP1,OPSEDURA
          CLEAR     HTMLLINK
          APPEND    "javascript:updateParent('",HTMLLINK
          APPEND    OPSEHOSP,HTMLLINK
          APPEND    OPSEDATE,HTMLLINK
          APPEND    OPSETIME,HTMLLINK
          APPEND    OPSECLIN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY42,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          GOTO      GETLNK99
.
GETLNK30  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          REP       " 0",CDAY
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY19,OPSEDATE,OPSETIME,OPSECLIN
          LOAD      DAYNAM3,OPSEDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      " Time ",D6
          MOVE      "Available",D9
          PACK      KEY42,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,D6:
                    OPSETIME,SP1,D9,SP1,OPSEDURA
          CLEAR     HTMLLINK
          APPEND    "javascript:updateParent('",HTMLLINK
          APPEND    OPSEHOSP,HTMLLINK
          APPEND    OPSEDATE,HTMLLINK
          APPEND    OPSETIME,HTMLLINK
          APPEND    OPSECLIN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY42,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPSEFIND,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          GOTO      GETLNK99
.
GETLNK99  RETURN
.------------------------------------------------------------
. Get Details for Session
.------------------------------------------------------------
SESDET00  UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,SESSDATE
          MOVE      OPSECLIN,CLINCODE
          MOVE      OPSECLIN,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            MOVE      DOCFNAME,SURFNAME
          ELSE
            MOVE      "&nbsp;",SURFNAME
            MOVE      OPCLDESC,SURFNAME
          ENDIF
.
          MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            MOVE      DOCFNAME,ANAFNAME
          ELSE
            MOVE      "&nbsp;",ANAFNAME
          ENDIF
.
          COMPARE   ZERO,OPSESTAT
          GOTO      SESDET10 IF NOT EQUAL
          PACK      KEY5,ANSO,ANSC,OPSECANC
          CALL      RDCODE1
          BRANCH    OVRCD,SESDET20
.
          CLEAR     KEY80
          APPEND    "<font color=red>",KEY80
          APPEND    OPSETHET,KEY80
          APPEND    "</font>",KEY80
          APPEND    "- C - ",KEY80
          APPEND    TDESC,KEY80
          RESET     KEY80
          MOVE      SP70,TDESC
          GOTO      SESDET20
.
SESDET10  MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            MOVE      OPRMDESC,NAME35
            CALL      NAMSTR00
            RESET     DISPNAME
            PACK      KEY80,DISPNAME,SP70
          ELSE
            MOVE      "&nbsp;",KEY80
          ENDIF
SESDET20  MOVE      "&nbsp;",STYPDES
          PACK      KEY5,CODEST,OPSETYPE           * Session Type (Cat ST)
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,STYPDES
          ENDIF
.
          MOVE      "&nbsp;",TUTYPDES              * Session type (Cat TU)
          MATCH     SP70,OPSESTYP
          IF        !@EQUAL
            PACK      KEY5,CODETU,OPSESTYP
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,TUTYPDES
            ENDIF
          ENDIF
          RETURN
.------------------------------------------------------------
. Move Case to location
.------------------------------------------------------------
CASMOV00  PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,CASMOV99
.
          CALL      WEBAUD00
.
          SQUEEZE   MVTOCASE
          MOVE      MVTOCASE,F3
          MOVE      F3,CASETO
          MOVE      OPDACASE,CASEFROM
          MATCH     CASEFROM,CASETO
          GOTO      CASMOV99 IF EQUAL
          MOVE      CASEKEYS,KEY22
          CALL      OPMVSBOK
CASMOV99  RETURN
.------------------------------------------------------------
. Case List 1
.------------------------------------------------------------
CASLST00  MATCH     SP70,SESSKEYS
          IF        !@EQUAL & !@EOS
            PACK      KEY22,SESSKEYS,SP70   * Check session is valid, as the
            CALL      RDOPSES1              * start time might have changed
            BRANCH    OVRCD,CASLST90
          ENDIF
.
          CALL      GETSES00
.
          MOVE      ZERO,NOOFDAYS
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,CURRDATE
          MOVE      OPSEDATE,BOOKDATE
          CLEAR     WEBTITLE
          APPEND    "Theatre Case List for ",WEBTITLE
          APPEND    SESSDATE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,CASLST99
.
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      CASLST99
.
CASLST90  CLEAR     WEBTITLE
          APPEND    "Invalid Theatre Session - The start time",WEBTITLE
          APPEND    " has changed. Please reselect a session.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBELM00                * redirect to modules home page
.
CASLST99  RETURN
.
.------------------------------------------------------------
. Output HTML Error and reload the modules home page
.------------------------------------------------------------
WEBELM00  CALL      OPENHTML
          BRANCH    EXIT,WEBELM99
.
          BRANCH    FHIRTYPE,WEBELM10
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">  ":
                             " alert(#"",WEBTITLE,"#");":
                             " var theURL=getTop().location.pathname;":
                             " getTop().location.href=theURL;":
                             "</script>"
          CALL      CLOSHTML     * End of Document
          GOTO      WEBELM99
.
WEBELM10  CALL      FHRSUC00  * Return FHIR Success
WEBELM99  RETURN
.
.------------------------------------------------------------
.  Case list display options
.------------------------------------------------------------
CLST0000  BRANCH    FLDITMNO,CLST0100,CLST0200,CLST0300,CLST0400,CLST0500:
                             CLST0600,CLST0700,CLST0800,CLST0900,CLST1000:
                             CLST1100,CLST1200,CLST1300,CLST1400,CLST1500:
                             CLST1600,CLST1700,CLST1800,CLST1900,CLST2000:
                             CLST2100,CLST2200,CLST2300,CLST2400,CLST2500:
                             CLST2600,CLST2700,CLST2800,CLST2900,CLST3000:
                             CLST3100,CLST3200
          GOTO      CLST9999
.
CLST0100  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWDISB           * no show disability alerts
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ONE,SHOWSURG            * show Surgeon name 
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST0200  CALL      SESLNK00
          GOTO      CLST9999
.
CLST0300  CALL      NWBKLK00
          GOTO      CLST9999
.
CLST0400  CALL      CASTAC00
          GOTO      CLST9999
.
CLST0500  DAYSEP    CURRDATE,BOOKDATE,NOOFDAYS
          IF        NOOFDAYS<ZERO
            MOVE      ZERO,NOOFDAYS
          ENDIF
          WRITE     HTMLFILE;NOOFDAYS;
          GOTO      CLST9999
.
CLST0600  WRITE     HTMLFILE;OPCNSCOM;                                 *I-50678
          GOTO      CLST9999
.
CLST0700  CALL      SBID0000       * Is there session based comments   *I-50678
          GOTO      CLST9999
.
CLST0800  MOVE      ONE,SHOCNSNT            * show Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWDISB           * no show disability alerts
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST0900  CALL      DAYC0000       * Is there day comments
          GOTO      CLST9999
.
CLST1000  MOVE      ZERO,SHOCNSNT           * show Consent details
          MOVE      ONE,SHOWENQY            * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWDISB           * no show disability alerts
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST1100  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ONE,SHOWREFD            * show Referral details
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWDISB           * no show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST1200  WRITE     HTMLFILE;DISPTEAM;
          GOTO      CLST9999
.
CLST1300  CALL      DTEAM000
          GOTO      CLST9999
.
CLST1400  WRITE     HTMLFILE;CLINCODE;
          GOTO      CLST9999
.
CLST1500  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ONE,SHOWDAYD            * show Day procedure icon
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWDISB           * no show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST1600  CALL      CASS0000
          GOTO      CLST9999
.
CLST1700  MOVE      ONE,SHOCNSNT
          MOVE      ONE,SHOOPDES
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST1800  MOVE      ZERO,SHOCNSNT
          MOVE      ZERO,SHOOPDES
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST1900  MOVE      ZERO,SHOCNSNT
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      COMCAS00
          GOTO      CLST9999
.
CLST2000  MOVE      ONE,SHOCNSNT
          MOVE      ONE,SHOWSURG            * show Surgeon name
          CALL      COMCAS00
          GOTO      CLST9999
.
CLST2100  WRITE     HTMLFILE;OPCNUTRA;
          GOTO      CLST9999
.
CLST2200  PACK      KEY26,SESSKEYS,Z70
          CALL      RSOPDEA5
CLST2210  CALL      RPOPDEA5
          BRANCH    OVRCD,CLST2290
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     KEY22,SESSKEYS
          GOTO      CLST2290 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPDAEXPS;
          GOTO      CLST9999
.
CLST2290  WRITE     HTMLFILE;OPSETIME;
          GOTO      CLST9999
.
CLST2300  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ONE,SHOWDISB            * show show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ONE,SHOWSURG            * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST2400  MOVE      ONE,SHOCNSNT            * show Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ONE,SHOWDISB            * show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST2500  MOVE      OPSEDGSI,LOCATION
          CALL      RCLS0000                * Check if recovery is closed
          GOTO      CLST9999
.
CLST2600  MOVE      ZERO,SHOCNSNT
          MOVE      ONE,SHOOPDES
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST2700  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ONE,SHOWDISB            * no show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ONE,SHOWSURG            * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST2800  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ONE,SHOWDISB            * show show disability alerts
          MOVE      ZERO,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST2900  MOVE      ZERO,SHOCNSNT
          MOVE      ZERO,SHOOPDES
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ONE,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST3000  MOVE      ZERO,SHOCNSNT           * no Consent details
          MOVE      ZERO,SHOWENQY           * show as enquiry only
          MOVE      ZERO,SHOWDAYD           * no show day procedure link
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ONE,SHOWDISB            * no show disability alerts
          MOVE      ONE,SHOWBLRQ
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CASTAB00
          GOTO      CLST9999
.
CLST3100  MOVE      ZERO,SHOCNSNT
          MOVE      ONE,SHOOPDES
          MOVE      ONE,SHOWRBAY            * show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ONE,SHOWPLOS            * show LOS column header counter
          MOVE      ONE,SHOWSURG            * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST3200  MOVE      ONE,SHOCNSNT
          MOVE      ONE,SHOOPDES
          MOVE      ZERO,SHOWRBAY           * no show recovery bay
          MOVE      ZERO,SHOWBLRQ
          MOVE      ONE,SHOWPLOS            * show LOS column header counter
          MOVE      ZERO,SHOWSURG           * show Surgeon name
          CALL      CSTBHD00
          GOTO      CLST9999
.
CLST9999  RETURN
.------------------------------------------------------------
. Is there Day Comments?
.------------------------------------------------------------
DAYC0000  MOVE      ZERO,F1
          PACK      KEY25,OPSEHOSP,OPSEDATE,SP70
          CALL      RSOPCOM2
          CALL      RKOPCOM2
          BRANCH    OVRCD,DAYC5000          * end of file
.
          MATCH     OPSEHOSP,OPCMHOSP       * hospital code
          GOTO      DAYC5000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DAYC5000 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME           * blank time?
          GOTO      DAYC5000 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN           * blank clinic / surgeon?
          GOTO      DAYC5000 IF NOT EQUAL
.
          GOTO      DAYC8000
.
DAYC5000  PACK      KEY25,SP3,OPSEDATE,SP70
          CALL      RSOPCOM2
          CALL      RKOPCOM2
          BRANCH    OVRCD,DAYC9000          * end of file
.
          MATCH     SP70,OPCMHOSP           * hospital code
          GOTO      DAYC9000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      DAYC9000 IF NOT EQUAL
.
          MATCH     SP70,OPCMTIME           * blank time?
          GOTO      DAYC9000 IF NOT EQUAL
.
          MATCH     SP70,OPCMCLIN           * blank clinic / surgeon?
          GOTO      DAYC9000 IF NOT EQUAL
.
DAYC8000  MOVE      ONE,F1                  * Comments exist
.
DAYC9000  WRITE     HTMLFILE;F1;
.
DAYC9999  RETURN
+
.------------------------------------------------------------
.   Session list link
.------------------------------------------------------------
SESLNK00  PACK      KEY22,SESSKEYS,SP70
.
          UNPACK    KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          UNPACK    OPDADATE,KEY6,KEY2
          PACK      PREFDATE,KEY6,ZERO,ONE
          PACK      PRELDATE,KEY6,THREE,ONE
          PACK      SESSKEYS,SESSKEYS,SP70
          REP       " +",SESSKEYS
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          WRITE     HTMLFILE;LINKPRG,".pbl?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE;
SESLNK99  RETURN
.------------------------------------------------------------
.  New booking link
.------------------------------------------------------------
NWBKLK00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          BRANCH    OPSESUSP,NWBKLK90
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     KEY8,OPSEDATE
          GOTO      NWBKLK95 IF LESS
          WRITE     HTMLFILE;"location.href='",LINKPRG,".pbl?":
                             "reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&sesskeys=",SESSKEYS,"'";
          GOTO      NWBKLK99
.
NWBKLK90  WRITE     HTMLFILE;"alert('Session Suspended');";
          GOTO      NWBKLK99
.
NWBKLK95  WRITE     HTMLFILE;"alert('Session in Past');";
          GOTO      NWBKLK99
.
NWBKLK99  RETURN
.------------------------------------------------------------
. case list table
.------------------------------------------------------------
CASTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,EMRSINDC,DIM127
          UNPACK    DIM127,D1,OPERPLOS,DIM127
.
          MOVE      ZERO,PRIOCNTR
          MOVE      ZERO,TEMPCNTR
          MOVE      ZERO,TEMPCNT1
          MOVE      SP70,TEMPCND1
.
          CALL      CASRED00
.
CASTAB10  PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,SP70
          CALL      RSOPDEA5
CASTAB20  CALL      RKOPDEA5                * next read on details file
          BRANCH    OVRCD,CASTAB90          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      CASTAB90 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASTAB20 IF EQUAL       * different sessio
.
          MOVE      SP70,EMRSTYPE                       * Check to see if this
          MATCH     SP70,OPSESTYP                       * is an emergency sess
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANST,ANSU,OPSESTYP
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,EMRSTYPE
            ENDIF
          ENDIF
.
          MATCH     "1",OPCNUTRA
          IF        @EQUAL
            MATCH     ANSE,EMRSTYPE
            IF        @EQUAL
.              PACK      KEY10,OPDAUNIQ,SP70
.              CALL      RDOPARD1
.              IF        OVRCD=0
..               MATCH     SP70,OPARTETC
..               GOTO      CASTAB20 IF NOT EQUAL
.                MATCH     SP70,OPARTIRD
.                GOTO      CASTAB20 IF NOT EQUAL
.                MATCH     SP70,OPARTIRF
.                GOTO      CASTAB20 IF NOT EQUAL
.              ENDIF
.
              PACK      KEY11,OPDAUNIQ,ONE,SP70
              CALL      RDOPSRG1
              IF        OVRCD=0
                 MATCH    SP70,OPSGTIDR
                 GOTO      CASTAB20 IF NOT EQUAL
              ENDIF
.
            ENDIF
          ENDIF
.
          ADD       ONE,TEMPCNTR
          MOVE      TEMPCNTR,TEMPCNT1
          ADD       HUNDRED,TEMPCNT1
          MOVE      TEMPCNT1,TEMPCND1
          REP       " 0",TEMPCND1
.
          CALL      CASDET00    * Get Display Details for Case
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      LSTALR00    * Patient Alerts (in LSTALERT.PBL)    *I-200963
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          REP       " +",CASEKEYS
          CALL      PATNAM00                * HPS-ODC Starts
.
          PACK      KEY18,OPDAADMN,OPDAUNIQ,SP70
          CALL      RDBKDIA1
          IF        OVRCD=1
            MOVE      SP70,BKDIDES1
            MOVE      SP70,BKDIDES2
            MOVE      SP70,BKDIDES3
            MOVE      SP70,BKDIDES4
            MOVE      SP70,BKDIDES5
            MOVE      SP70,BKDIDES6
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
.
          MOVE      SP70,ROWCLASS
          MATCH     "1",OPCNTPAT
          IF        @EQUAL
            MATCH     OPDACRDT,OPDADATE
            IF        @EQUAL
              MOVE      "class=TableRowYellow",ROWCLASS
            ENDIF
          ENDIF
.
.         MOVE      SP70,EMRSTYPE                       * Check to see if this
.         MATCH     SP70,OPSESTYP                       * is an emergency sess
.         IF        !@EQUAL & !@EOS
.           PACK      KEY5,ANST,ANSU,OPSESTYP
.           CALL      RDCODE1
.           IF        OVRCD=0
.             MOVE      TCINDC1,EMRSTYPE
.           ENDIF
.         ENDIF
.
          CALL      CLBOKRQ1
          MATCH     SP70,OPDAREQN                       * Get theatre req rec
          IF        !@EQUAL & !@EOS
            PACK      KEY10,OPDAREQN,SP70
            CALL      RDBKRQ11
.
          ENDIF
.
          MOVE      SP70,PRIOASSN                       * Get priority
          MOVE      SP70,PRIOHEQV
          MOVE      SP70,PRIOASC1
          MOVE      BKRQPRIO,PRIODESC
          MATCH     SP70,BKRQPRIO
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CATrp,BKRQPRIO,SP70
            CALL      RDCODE1
            IF        OVRCD=0
               ASSIGN    (TCFORM6*60),PRIOASSN             * Convert into min
               MOVE      PRIOASSN,PRIOASSD
               LJUSTIFY  PRIOASSD
               MOVE      THCSCOD,PRIOHEQV
               MOVE      PTCDASC1,PRIOASC1
            ENDIF
          ENDIF
.
          ADD       ONE,PRIOCNTR
          MOVE      PRIOCNTR,PRIOCNTD
          REP       " 0",PRIOCNTD
.
          WRITE     HTMLFILE;"<TR ",ROWCLASS,">";
.
          MATCH     "1",EMRSINDC                      * Display Priority
          IF        @EQUAL
            MATCH     ANSE,EMRSTYPE
            IF        @EQUAL
.
              MATCH     SP70,PRIOASC1
              IF        !@EQUAL
               WRITE     HTMLFILE;"<TD ALIGN=CENTER BGCOLOR='##",PRIOASC1,"'>";
              ELSE
               WRITE     HTMLFILE;"<TD ALIGN=CENTER>";
              ENDIF
.
CASTAB21      MATCH     SP70,BKRQREQN
              IF        !@EQUAL & !@EOS
                REP       " +",BKRQREQN
                REP       " +",BKRQURNO
                REP       " +",BKRQVISN
.
                WRITE     HTMLFILE;PRIODESC:
                          "<A HREF=javascript:UpdateTheatreRequest('":
                          BKRQREQN,"','",BKRQURNO,"','",BKRQVISN,"')>":
                          "<img src=../images/EditIcon.gif hspace=4 ":
                          "border=0></a>":
                          "<input type=hidden":
                          " name=priod",PRIOCNTD," value='",PRIOASSD,"'>":
                          "<input type=hidden":
                          " name=priov",PRIOCNTD," value='",PRIOHEQV,"'>":
                          "<input type=hidden":
                          " name=pridt",PRIOCNTD," value='",BKRQCSDT,"'>":
                          "<input type=hidden":
                          " name=pritm",PRIOCNTD," value='",BKRQCSTM,"'>";
.
                REP       "+ ",BKRQREQN
                REP       "+ ",BKRQURNO
                REP       "+ ",BKRQVISN
.
                MOVE      SP70,THETCOMP
                PACK      KEY10,OPDAUNIQ,SP70
                CALL      RDOPARD1
                IF        OVRCD=1
                  CALL      CLOPRARD
                ENDIF
.
                MOVE      ZERO,FORM2
                MOVE      OPCNTRCS,FORM2
.
                LOAD      THETCOMP,FORM2,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                         OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                         OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                         OPARTIDP,OPARTETC
.
                WRITE     HTMLFILE;"<input type=hidden":
                          " name=pritc",PRIOCNTD," value='",THETCOMP,"'>";
.
              ENDIF
              WRITE     HTMLFILE;"&nbsp;</TD>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<TD ALIGN=CENTER>";
.
          IF        SHOWENQY<>1
            WRITE     HTMLFILE;"<A HREF=#"javascript:EditStartTime('":
                               CASEKEYS,"')#">":
                               "<img src=../images/EditIcon.gif hspace=4 ":
                               "border=0 align=#"right#"></a>";
          ENDIF
.
          WRITE     HTMLFILE;OPDAEXPS;
.
          MATCH     "1",OPCNUTRA
          IF        @EQUAL
            MATCH     ANSE,EMRSTYPE
            IF        @EQUAL
              WRITE     HTMLFILE;"<input type=hidden value='",OPDAEXPS,"'>";
              WRITE     HTMLFILE;"<input type=hidden value='",OPDAEXPD,"'>";
              WRITE     HTMLFILE;"<input type=hidden value='",OPSEBRKT,"'>";
              WRITE     HTMLFILE;"<input type=hidden value='",OPSEPREP,"'>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</TD>";
.
          IF        SHOWREFD<>1
            WRITE     HTMLFILE;"<TD ALIGN=CENTER>",OPDAEXPD," min</TD>";
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
          WRITE     HTMLFILE;"<td nowrap height=30>":
                             "<A HREF=",LINKPRG,".pbl?":
                             "reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",CASEKEYS,">"
.
.                                                          * start    *D-200963
....    Check if patient has an Alert, if they do display folder with alert icon
....      PACK      KEY16,URNUMBER,SP70
....      CALL      RSPMALN1
....      CALL      RKPMALN1
....      BRANCH    OVRCD,CASTAB22
....      MATCH     PMANURNO,URNUMBER
....      GOTO      CASTAB22 IF NOT EQUAL
....      WRITE    HTMLFILE;"<img src=../images/FolderAlert.gif class=Icon></a>"
....      GOTO      CASTAB23
.                                                          * end      *D-200963
.
CASTAB22  WRITE     HTMLFILE;"<img src=../images/PatientFolder",FOLDERSF,".gif":
                               " class=Icon></a>"
.
CASTAB23  WRITE     HTMLFILE;"&nbsp;",FORMATNM,"</TD>";
.
          MATCH     "1",OPERPLOS                   * display Planned LOS
          IF        @EQUAL            
            IF       OPDASTAT=0
              PACK      KEY8,OPDAADMN,SP70         * display Booked LOS
              CALL      RDBKREC1
              IF        OVRCD=1
                WRITE     HTMLFILE;"<td ALIGN=CENTER>&nbsp;</td>";
              ELSE 
                WRITE     HTMLFILE;"<td ALIGN=CENTER>",DBKREELO,"</td>";
              ENDIF
            ELSE
              PACK      KEY8,OPDAADMN,SP70  * display Pre-Adm,Adm,Discharge LOS
              CALL      RDMISS1
              IF        OVRCD=1
                WRITE     HTMLFILE;"<td ALIGN=CENTER>&nbsp;</td>";
              ELSE
                IF        OPDASTAT=1 | OPDASTAT=2 | OPDASTAT=4
                  WRITE     HTMLFILE;"<td ALIGN=CENTER>",ASTAY,"</td>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          IF        SHOWDISB=1
.
            CALL      ALRDIS00
.
          ELSE
.                                           * set up Alerts Column    *I-200963
            STRIP     ALRTIMGE
            STRIP     ALRTIMG2
            STRIP     ALRTIMG3
            STRIP     ALRTIMG4
            PACK      ALRTIMGT,ALRTIMGE,ALRTIMG2,ALRTIMG3,ALRTIMG4,SP70
.
            MATCH     SP70,ALRTIMGT           * returned from LNKALERT.PBL
            IF        @EQUAL
              WRITE     HTMLFILE;"<td> &nbsp; ";
            ELSE
             WRITE     HTMLFILE;"<td><A HREF=#"",ALRTLINK,"#">",ALRTIMGT;
            ENDIF
            WRITE      HTMLFILE;"</td>";
.                                           *                   end   *I-200963
          ENDIF
.
          IF        SHOWREFD<>1
            WRITE     HTMLFILE;"<TD>",OPDAADMN,"</TD>";
          ENDIF
.
          MATCH     SP70,OPDADES1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<TD>",OPDADES1," ",OPDADES2:
                               " ",OPDADES3,"&nbsp;</TD>";
          ELSE
.           MATCH     SP70,BKDIDES1
.           IF        !@EQUAL
              WRITE     HTMLFILE;"<TD>",BKDIDES1," ",BKDIDES2:
                               " ",BKDIDES3,"&nbsp;</TD>";
.           ELSE
.             WRITE     HTMLFILE;"<TD>",BKRXUFF1," ",BKRXUFF2:
.                              " ",BKRXUFF3,"&nbsp;</TD>";
.           ENDIF
          ENDIF
.                                           * HPS-ODC Ends
          BRANCH    SHOWREFD,CASTAB60
.
          PACK      KEY36,OPDAUNIQ,SP70
          CALL      RSOPREQ1
          CALL      RKOPREQ1
          BRANCH    OVRCD,CASTAB25
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      CASTAB25 IF NOT EQUAL
.
.0953102  WRITE     HTMLFILE;"<TD>","&nbsp;","R","&nbsp;</TD>";      *0953102
          GOTO      CASTAB27
.
CASTAB25  GOTO      CASTAB27
.                                          * Anaesthetic Type
CASTAB27  MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OADESC
          WRITE     HTMLFILE;"<TD>",OADESC,"&nbsp;</TD>";
          GOTO      CASTAB30

CASTAB30  WRITE     HTMLFILE;"<TD>","&nbsp;";
          MOVE      SP70,KEY3
          BRANCH    OPDASTAT,CASTAB31,CASTAB32,CASTAB33,CASTAB34
          GOTO      CASTAB35
CASTAB31  MOVE      "Pre",KEY3
          GOTO      CASTAB35
CASTAB32  MOVE      "Adm",KEY3
          GOTO      CASTAB35
CASTAB33  MOVE      "Can",KEY3
          GOTO      CASTAB35
CASTAB34  MOVE      "Dis",KEY3
          GOTO      CASTAB35
.
CASTAB35  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<img src=#"../images/UsageIcon.gif#">&nbsp;":
                               KEY3;
          ELSE
            CALL      CLOPRARD
            WRITE     HTMLFILE;KEY3;
          ENDIF
.
          IF        SHOWDAYD=1
            IF        OPDASTAT=2|OPDASTAT=4
              WRITE     HTMLFILE;"<A HREF=oprweb06.pbl?":
                                "reportno=12":
                                "&template=001":
                                "&casekeys=",CASEKEYS,">":
                                "<img src=../images/EditIcon.gif hspace=4 ":
                                "border=0 align=#"right#"></a>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</TD>";
          PACK      KEY6,OPDATHET,SP70
          CALL      RDOPOPR1
          MATCH     SP70,OPDATHET
          IF        @EQUAL
            WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          ELSE
            WRITE     HTMLFILE;"<TD>",OPRMDESC,"</TD>";
          ENDIF
.
. Surgeon
.
          IF        SHOWSURG = 1
            CALL      GSURNS00  
            WRITE     HTMLFILE;"<TD>",DOCFNAME,"</TD>"
          ENDIF
.
          CALL      CASSEL00       * Case Selectio List
.
          CALL      PATSTS00       * Patient Status
.
          MOVE      "No ",DIM3     * Consent Status
          MATCH     "Y",OPDACSST
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
          MATCH     SP70,CURSTATS
          IF        !@EQUAL
            IF        SHOCNSNT = 1
              MATCH     "Abandoned",CURSTATS
              IF        @EQUAL
                WRITE     HTMLFILE;"<td style='color:red;'>",DIM3,"    /",CURSTATS,"</td>"
              ELSE
                WRITE     HTMLFILE;"<td>",DIM3,"    /",CURSTATS,"</td>"
              ENDIF
            ELSE
              MATCH     "Abandoned",CURSTATS
              IF        @EQUAL
                WRITE     HTMLFILE;"<td style='color:red;'>",CURSTATS,"</td>"
              ELSE
                WRITE     HTMLFILE;"<td>",CURSTATS,"</td>"
              ENDIF
            ENDIF
          ELSE
            IF        SHOCNSNT = 1
              WRITE     HTMLFILE;"<td>",DIM3,"&nbsp;</td>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>"
            ENDIF
          ENDIF
.
          MATCH     "1",EMRSINDC
          IF        @EQUAL
            MATCH     ANSE,EMRSTYPE
            IF        @EQUAL
              WRITE     HTMLFILE;"<TD ALIGN=CENTER>";
              MATCH     SP70,BKRQCDAT
              IF        !@EQUAL & !@EOS
                UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                     NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                   " at ",BKRQCTIM
              ENDIF
              WRITE     HTMLFILE;"<br>";
              MATCH     SP70,BKRQCSDT
              IF        !@EQUAL & !@EOS
                UNPACK    BKRQCSDT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                     NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                   " at ",BKRQCSTM
              ENDIF
              WRITE     HTMLFILE;"&nbsp;</TD>";
.
              WRITE     HTMLFILE;"<TD ALIGN=CENTER>";
.
              WRITE     HTMLFILE;"&nbsp;</TD>";
            ENDIF
          ENDIF
.
          IF        SHOWRBAY=1
            MOVE      "oc",CATEGORY
            MOVE      OPARUC03,CODE
            CALL      GETCOD00
.
            REP       " +",CASEKEYS
            MATCH     SP70,TDESC 
CASTAB53    IF        @EQUAL
              MATCH     SP70,OPARUNID
              IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ELSE
                WRITE     HTMLFILE;"<td>":
                                   "<img src=../images/EditIcon.gif ":
                                   "class=Icon onclick=UpdatePACU('":
                                   CASEKEYS,"');></td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>":
                                 "<a href=javascript:UpdatePACU('",CASEKEYS:
                                 "');>",TDESC,"</a></td>";
            ENDIF
            REP       "+ ",CASEKEYS
          ENDIF
.
          IF        SHOWBLRQ=1
              WRITE     HTMLFILE;"<td>";
.
              WRITE     HTMLFILE;"<input type=checkbox":
                                 " name=blbox id=blbox",TEMPCND1," value='1' checked>";
.
              WRITE     HTMLFILE;"</td>";
.
              WRITE     HTMLFILE;"<input type=hidden name=blurn id=blurn",TEMPCND1:
                                 " value=#"",OPDAURNO,"#">":
                                 "<input type=hidden name=bladm id=bladm",TEMPCND1:
                                 " value=#"",OPDAADMN,"#">":
                                 "<input type=hidden name=blcas id=blcas",TEMPCND1:
                                 " value=#"",CASEKEYS,"#">":
                                 "<input type=hidden name=blunq id=blunq",TEMPCND1:
                                 " value=#"",OPDAUNIQ,"#">":
                                 "<input type=hidden name=bltem id=bltem",TEMPCND1:
                                 " value=#"1#">";
.
          ENDIF
.
          WRITE     HTMLFILE;"</TR>"
          GOTO      CASTAB20
.
CASTAB60  PACK      KEY26,OPDAURNO,OPSECLIN,Z70
          CALL      RSPMRFL1
          CALL      RPPMRFL1
          BRANCH    OVRCD,CASTAB65
.
          MATCH     URNUMBER,PMRFURNO
          GOTO      CASTAB65 IF NOT EQUAL
.
          MATCH     OPSECLIN,PMRFCONS
          GOTO      CASTAB65 IF NOT EQUAL
.
          MATCH     PMRFEXPD,OPSEDATE
          GOTO      CASTAB65 IF NOT LESS
.
          PACK      KEY10,PMRFCONS,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
          UNPACK    PMRFEXPD,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",CPCDATE,"&nbsp;</td>":
                             "<td>",PMRFRFGP,"&nbsp;</td>";
          GOTO      CASTAB70
.
CASTAB65  WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
CASTAB70  MATCH     SP70,BKRXUDD1
          IF        !@EQUAL
            UNPACK    BKRXUDD1,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;"
          ENDIF
.
          MATCH     SP70,BKRXUDT1
          IF        !@EQUAL
            WRITE     HTMLFILE;" at ",BKRXUDT1,"</td>";
          ELSE
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",BKRXUFF4,"&nbsp;</td>";
.
          IF        SHOWRBAY=1
            MOVE      "oc",CATEGORY
            MOVE      OPARUC03,CODE
            CALL      GETCOD00
.
            REP       " +",CASEKEYS
            MATCH     SP70,TDESC
            IF        @EQUAL
              MATCH     SP70,OPARUNID
CASTAB73      IF        @EQUAL
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ELSE
                WRITE     HTMLFILE;"<td>":
                                   "<img src=../images/EditIcon.gif ":
                                   "class=Icon onclick=UpdatePACU('":
                                   CASEKEYS,"');></td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>":
                                 "<a href=javascript:UpdatePACU('",CASEKEYS:
                                 "');>",TDESC,"</a></td>";
            ENDIF
            REP       "+ ",CASEKEYS
          ENDIF
.
          GOTO      CASTAB20
.
CASTAB90  MATCH     "1",OPCNUTRA
          GOTO      CASTAB99 IF NOT EQUAL
.
          MATCH     "1",EMRSINDC
          GOTO      CASTAB99 IF NOT EQUAL
.
          MATCH     ANSE,EMRSTYPE
          GOTO      CASTAB99 IF NOT EQUAL
.
          CALL      APTHRQ00
.
CASTAB99  RETURN
.------------------------------------------------------------
. Output Case Selection List
.------------------------------------------------------------
CASSEL00
....      PACK      KEY8,CCC,CYY,CMM,CDD
....      REP       " 0",KEY8
....      MATCH     KEY8,OPSEDATE
....      GOTO      CASSEL90 IF LESS
.
          CALL      CASSTS00      * Patient In Theatre
          BRANCH    EXIT,CASSEL90 * Yes Can't Move
.
.         BRANCH    OPSESUSP,CASSEL90
.
          COMPARE   ONE,SHOWENQY            * Show as enquiry page
          GOTO      CASSEL90 IF EQUAL
.
          MOVE      OPDACASE,DIM3
          REP       " 0",DIM3
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          WRITE     HTMLFILE;"<td><form action=oprweb01.pbl ":
                               "method=post name=movecas_",DIM3,">":
                             "<input type=hidden name=reportno ":
                              "value=#"16#">":
                             "<input type=hidden name=template ":
                              "value=#"",KEY3,"#">":
                             "<input type=hidden name=casekeys ":
                              "value=#"",CASEKEYS,"#">":
                             "<select name=mvtocase size=1>"
          MOVE      OPDACASE,THISCAS
          MOVE      SAVECASE,CASECNT
CASSEL10  IF        CASECNT=THISCAS
            WRITE     HTMLFILE;"<option selected>",CASECNT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option>",CASECNT,"</option>"
          ENDIF
          ADD       ONE,CASECNT
          COMPARE   CASECNT,LSTCASE
          GOTO      CASSEL10 IF NOT LESS
.
          IF        PTCNHDPS=ONE
            WRITE     HTMLFILE;"</select><input type=button name=B1 ":
                      "onclick='":
                      "UpdateCaseNo(document.movecas_",DIM3,");' ":
                      "value=Update></form></td>"
          ELSE
            WRITE     HTMLFILE;"</select><input type=button name=B1":
                      " value=Update ":
                      "onClick='CheckFin(document.movecas_",DIM3,");'>":
                      "</form></td>"
          ENDIF
.
          GOTO      CASSEL99
.
CASSEL90  WRITE     HTMLFILE;"<td align=center>",OPDACASE,"</TD>"
.
CASSEL99  RETURN
.-----------------------------------------------------------------------------
CASRED00  MOVE      SP70,MVTOCASE
          MOVE      SP70,SAVECASE
          PACK      KEY22,SESSKEYS,SP70
.
          MOVE      KEY22,SESSKEYS
          PACK      KEY26,KEY22,Z70
          CALL      RSOPDEA5
CASRED05  CALL      RPOPDEA5                * prev read on details file
          BRANCH    OVRCD,CASRED10          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      CASRED10 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASRED05 IF EQUAL       * different sessio
.
          MOVE      OPDACASE,LSTCASE
.
CASRED10  PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,SP20
          CALL      RSOPDEA5
CASRED20  CALL      RKOPDEA5                * next read on details file
          BRANCH    OVRCD,CASRED99          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
.
          GOTO      CASRED99 IF NOT EQUAL   * different sessio
          COMPARE   THREE,OPDASTAT
          GOTO      CASRED20 IF EQUAL
.
          CALL      CASSTS00
          IF        EXIT=0
            MATCH     SP70,MVTOCASE
            IF        @EQUAL
              MOVE      OPDACASE,MVTOCASE
            ENDIF
          ELSE
            MATCH     SP70,MVTOCASE
            IF        !@EQUAL
              PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                                 OPDACASE
              CALL      CASMOV00
              MOVE      SP70,MVTOCASE
              MOVE      CASEKEYS,KEY26
              CALL      RSOPDEA5
            ENDIF
          ENDIF
          GOTO      CASRED20
.
CASRED99  RETURN
.----------------------------------------------------------------------------
. Check the Case Status
.-----------------------------------------------------------------------------
CASSTS00  MOVE      ZERO,EXIT
          PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          BRANCH    OVRCD,CASSTS10
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      CASSTS10 IF NOT EQUAL
.
          MATCH     SP70,OPSGTIPS          * Check whether patient in theatre
          GOTO      CASSTS90 IF NOT EQUAL
.
CASSTS10  PACK      KEY10,OPDAUNIQ         * Check if anaesthetic has started
          CALL      RDOPARD1               * if so patient is in theatre
          IF        OVRCD<>1
            MATCH     SP70,OPARANAS
            GOTO      CASSTS90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SAVECASE
          GOTO      CASSTS20 IF NOT EQUAL
          MOVE      OPDACASE,SAVECASE
.
CASSTS20  MOVE      ZERO,EXIT
          GOTO      CASSTS99
.
CASSTS90  MOVE      ONE,EXIT
CASSTS99  RETURN
.-----------------------------------------------------------------------------
. Current Status of Patient
.-----------------------------------------------------------------------------
PATSTS00  MOVE      SP70,CURSTATS
          COMPARE   THREE,OPDASTAT
          GOTO      PATSTS05 IF NOT EQUAL
.
          MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Transferred",CURSTATS
          ELSE
            MOVE      "Cancelled",CURSTATS
          ENDIF
          GOTO      PATSTS99
.
PATSTS05  PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,PATSTS99
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Holding",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Anaes",CURSTATS
            ENDIF
          ENDIF
.
PATSTS10  PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,PATSTS99
.
.          MATCH     "1",OPSGUY05
.          IF        @EQUAL
.            MOVE      "Abandoned",CURSTATS
.            GOTO      PATSTS99
.          ENDIF
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Theatre",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPSGTISS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Theatre",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIDP
          IF        !@EQUAL
            MOVE      "Ready To Depart",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,CURSTATS              * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",CURSTATS      * Yes, set status to "Deceased"
            ELSE
              MOVE      CURSTATS,DIM15           * No, save current status
              PACK      CURSTATS,STAPRFIX,DIM15  * Build new status with prefix
            ENDIF
          ENDIF
.
PATSTS99  RETURN
.------------------------------------------------------------
. Get Session Header Details
.------------------------------------------------------------
GETSES00  PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,GETSES99
.
          CALL      SESDET00
GETSES99  RETURN
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
CASDET00  PACK      KEY8,OPDAADMN,SP70
          MOVE      OPDAADMN,ADMISSNO
          CALL      GURN0000
          BRANCH    EXIT,CASDET99
          MATCH     "0       ",AURNO
          GOTO      CASDET05 IF EQUAL   * have a UR number
          MATCH     "       0",AURNO
          GOTO      CASDET05 IF EQUAL   * have a UR number
          MATCH     "        ",AURNO
          GOTO      CASDET10 IF NOT EQUAL   * have a UR number
.
.         on pre-admission file
.
CASDET05  PACK      KEY8,OPDAADMN,SP70      * visit number
          CALL      RDPRAM1
          BRANCH    OVRCD,CASDET10          * invalid visit number
.
          MOVE      ZERO,PURNO
          MOVE      PURNO,URNUMBER
          GOTO      CASDET99                * valid patient
.
.         on master file
.
CASDET10  PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CASDET99          * invalid UR number
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PURNO,URNUMBER
.
CASDET99  RETURN
.******************************************************************************
.                   GURN0000
.    Given the admission number in KEY8/KEY6 this gets the UR number from
.    either the admission or booking master file.
.    Returns : AURNO
.    Routine by Bill Dew 14/03/90
.*******************************************************************************
GURN0000  CALL      RDMISS1                 * read admission file
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
GURN5555  CALL      RDBKREC1                * read booking records file
          BRANCH    OVRCD,GURN9990
          MOVE      BKREURNO,AURNO
.
          CALL      RDBKRX11
          BRANCH    OVRCD,GURN9990
          MOVE      ZERO,EXIT               * a valid admission number
          GOTO      GURN9999
.
GURN9990  MOVE      ZERO,EXIT               * an invalid admission number
.
GURN9999  RETURN
.------------------------------------------------------------
. New Booking
.------------------------------------------------------------
NEWBOK00  CALL      CHKBK000                * check if other bookings exist
.
          PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,NEWBOK99
.
          CALL      SESDET00
.
          CALL      CLBOK000
          CALL      CLOPRDEA
          MATCH     SP70,ADMISSNO
          GOTO      NEWBOK10 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOK000
          ENDIF
          GOTO      NEWBOK20
.
NEWBOK10  CALL      CLBOK000
          CALL      CLOPRDEA
.
NEWBOK20  MATCH     SP70,WATTRKEY
          IF        !@EQUAL
            CALL      WATDET00   * Get Waiting List Defaults
          ELSE
            CALL      CLWATDET   * Clear Waiting List Feilds
            CALL      CLWATTX1   * Clear Waiting List Feilds
          ENDIF
.
          PACK      KEY15,WMCODE,CLINCODE,SP70
          CALL      RDOPAVE1
          IF        OVRCD=1
            PACK      KEY15,WMCODE,SP70
            CALL      RDOPAVE1
            IF        OVRCD=1
              CALL      CLOPAV00
            ENDIF
          ENDIF
.
          MATCH     SP70,URNUMBER
          GOTO      NEWBOK30 IF NOT EQUAL
          CALL      CLPATMAS
          CALL      CLPMSPX2
          CALL      CLPATMIS
          GOTO      NEWBOK50
.
NEWBOK30  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,NEWBOK94
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      NEWBOK30
          ENDIF
.
          IF          DEADFLAG=0
            BRANCH      PCEASE,NEWBOK93
          ENDIF
.
. Read Admission file PATMI1 to check for an existing admission number
.
          CALL      CURI0000
          MOVE      SP70,DIM10
          CALL      PTHV0000
.
          MATCH     SP70,WATTRKEY
          IF        !@EQUAL
            CALL      WATDET00   * Get Waiting List Defaults
          ELSE
            CALL      CLWATDET   * Clear Waiting List Feilds
            CALL      CLWATTX1   * Clear Waiting List Feilds
          ENDIF
.
NEWBOK50  MOVE      "New Theatre Booking",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,NEWBOK99
.
          CALL      WEBBOD00
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00
          GOTO      NEWBOK99
.
NEWBOK91  MOVE      "Invalid Theatre Session",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK92  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK93  * MOVE      "Patient is Deceased",WEBTITLE
          CALL      BKDC0000
          MOVE      ONE,EXIT
          GOTO      NEWBOK99
.
NEWBOK94  MOVE      "Invalid Patient UR",WEBTITLE
          CALL      WEBERR00
          GOTO      NEWBOK99
.
NEWBOK99  RETURN
.------------------------------------------------------------------------
. BKDC0000 - Output HTML Error File for Organ Procurement Admissions Only
.------------------------------------------------------------------------
BKDC0000  CALL      OPENHTML
          BRANCH    EXIT,BKDC9500
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "oprweb01.pbl?reportno=09&template=002&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&sesskeys=",REDIRECT
          APPEND    SESSKEYS,REDIRECT
          APPEND    "&deadflag=1",REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else {";
.
          WRITE     HTMLFILE;" if(confirm('Warning: Patient is Deceased.\n":
                             "Click OK to continue with booking')) {":
                             " location.href=#"",REDIRECT,"#"}":
                             " else { history.go(-1)}}";
.
          WRITE     HTMLFILE;"}":
                             "</script>"
.
          CALL      CLOSHTML
          GOTO      BKDC9900
.
BKDC9500  DISPLAY   "*** Fifo Not Found ***"
.
BKDC9900  RETURN
.------------------------------------------------------------
. Check if other booking already exist
.------------------------------------------------------------
CHKBK000  MOVE      ZERO,WAITFLAG
          MOVE      ZERO,PREAFLAG
          MOVE      ZERO,BOOKFLAG
.
          OPEN      BOKRC1A6,"bokrc1af"
          PACK      KEY16,URNUMBER,SP20
          CALL      RSBKREC6
CHKBK100  CALL      RKBKREC6
          BRANCH    OVRCD,CHKBK500
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CHKBK500 IF NOT EQUAL
.
          COMPARE   ONE,BKRESTAT
          GOTO      CHKBK100 IF NOT LESS
.
          MOVE      ONE,BOOKFLAG
.
CHKBK500  PACK      KEY19,URNUMBER,SP20
          OPEN      WATTR1A1,"wattr1af"
          CALL      RDSTREA1
CHKBK600  CALL      RDKTREA1
          BRANCH    OVRCD,CHKBK700          * no procedures
.
          MATCH     URNUMBER,WMURNO
          GOTO      CHKBK700 IF NOT EQUAL   * no procedures
.
          COMPARE   "1",WMSTAT
          GOTO      CHKBK600 IF NOT EQUAL   * not a valid status
.
          MOVE      ONE,WAITFLAG
.
CHKBK700  PACK      KEY17,URNUMBER,ONE,SP20
          CALL      RSPTMI18
CHKBK800  CALL      RKPTMI18
          BRANCH    OVRCD,CHKBK999
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CHKBK999
          ENDIF
.
          COMPARE   "1",ASTAT
          GOTO      CHKBK999 IF NOT EQUAL
.
          MOVE      ONE,PREAFLAG
.
CHKBK999  RETURN
+
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.------------------------------------------------------------
. Check by U/R if admitted
.------------------------------------------------------------
CURI0000  CALL      CLPMSVX1
          PACK      KEY17,PURNO,TWO,SP20
          CALL      RSPTMI18
CURI1000  CALL      RKPTMI18
          BRANCH    OVRCD,CURI2000          * not on file
.
          MATCH     PURNO,AURNO           * same U/R Number?
          GOTO      CURI2000 IF NOT EQUAL   * No
.
          COMPARE   TWO,ASTAT
          GOTO      CURI2000 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PTCNUHSC
            IF        @EQUAL
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CURI9999 IF NOT EQUAL
            ENDIF
            MATCH     SP3,PMVXAPWD
            IF        !@EQUAL
              MOVE      PMVXAPWD,BKRXADWD
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          MOVE      AADMNO,ADMISSNO
          GOTO      CURI9999
.
CURI2000  PACK      KEY17,PURNO,FOUR,SP20
          CALL      RSPTMI18
CURI2500  CALL      RKPTMI18
          BRANCH    OVRCD,CURI3000          * not on file
.
          MATCH     PURNO,AURNO           * same U/R Number?
          GOTO      CURI3000 IF NOT EQUAL   * No
.
          COMPARE   FOUR,ASTAT
          GOTO      CURI3000 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PTCNUHSC
            IF        @EQUAL
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CURI9999 IF NOT EQUAL
            ENDIF
            MATCH     SP3,PMVXAPWD
            IF        !@EQUAL
              MOVE      PMVXAPWD,BKRXADWD
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          MOVE      AADMNO,ADMISSNO
          GOTO      CURI9999
.
. --- check for discharged admissions within session date ---
.
CURI3000  PACK      KEY17,URNUMBER,THREE,Z70
          CALL      RSPTMI18
CURI3500  CALL      RPPTMI18
          BRANCH    OVRCD,CURI4000
.
          MATCH     URNUMBER,AURNO
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CURI4000
          ENDIF
.
          COMPARE   THREE,ASTAT
          GOTO      CURI4000 IF NOT EQUAL
.
          MATCH     ADATE,OPSEDATE
          GOTO      CURI4000 IF LESS
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CURI4000
.
          MATCH     OPSEDATE,DDATE
          GOTO      CURI4000 IF LESS
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PTCNUHSC
            IF        @EQUAL
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CURI9999 IF NOT EQUAL
            ENDIF
            MATCH     SP3,PMVXAPWD
            IF        !@EQUAL
              MOVE      PMVXAPWD,BKRXADWD
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          MOVE      AADMNO,ADMISSNO
          GOTO      CURI9999
.
CURI4000  PACK      KEY17,PURNO,ONE,SP20
          CALL      RSPTMI18
CURI4500  CALL      RKPTMI18
          BRANCH    OVRCD,CURI9999          * not on file
.
          MATCH     PURNO,AURNO           * same U/R Number?
          IF        !@EQUAL
            CALL      CLPATMIS
            GOTO      CURI9999
          ENDIF
          GOTO      CURI9999 IF NOT EQUAL   * No
.
          COMPARE   ONE,ASTAT
          GOTO      CURI9999 IF NOT EQUAL
.
          MATCH     ADATE,OPSEDATE
          GOTO      CURI4500 IF LESS
.
...       DAYSEP    ADATE,OPSEDATE,NODAYS
...       COMPARE   NODAYS,SEVEN
...       GOTO      CURI4500 IF LESS
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PTCNUHSC
            IF        @EQUAL
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CURI9999 IF NOT EQUAL
            ENDIF
            MATCH     SP3,PMVXAPWD
            IF        !@EQUAL
              MOVE      PMVXAPWD,BKRXADWD
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          MOVE      AADMNO,ADMISSNO
          GOTO      CURI9999
.
CURI9999  RETURN
.------------------------------------------------------------
. Get Waiting List Defaults
.------------------------------------------------------------
WATDET00  MOVE      WATTRKEY,KEY19
          CALL      RDTREA1
          IF        OVRCD=0
            MOVE      WMURNO,URNUMBER
            MOVE      WMCODE,OPDAPROV
            MOVE      WTWMPRO2,OPDAPRV2
            MOVE      WTWMPRO3,OPDAPRV3
            MOVE      WMTIME,OPDAEXPD
            MOVE      WMUNIT,BKREDEPT
            MOVE      WMDATE3,BKREEDAT
            MOVE      WMSTAY,BKREELOS
            PACK      KEY8,WMBOOK,SP20      * get ACC purchase order no
            CALL      RDPMWX11
            IF        OVRCD=1
              CALL      CLPMSWX1
            ENDIF
          ELSE
            CALL      CLWATDET
          ENDIF
.
          CALL      RDWTTX11
          IF        OVRCD=0
            MOVE      WTTXADMW,BKRXADWD
            MOVE      WTTXPOWD,BKRXPOWD
            MOVE      WTTXPSTY,BKRXPSTY
            MOVE      WTTXEQR1,OPDAEQR1
            MOVE      WTTXEQR2,OPDAEQR2
            MOVE      WTTXEQR3,OPDAEQR3
            MOVE      WTTXLEQR,OPDALEQR
.
            IF        PTCNHDPS=1
              READ      CONTROLF,THIRTY7;*236,WTCNBRSR
              LOAD      BKRXASRC,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4:
                                 WMUDEF5,WMUDEF6,WMUDEF7,WMUDEF8
              MOVE      BKRXASRC,OPDAASRC
            ELSE
              MOVE      HWDSOUR,BKRXASRC
              MOVE      HWDSOUR,OPDAASRC
            ENDIF
.
            MOVE      WTTXCTYP,BKRECLMT
          ELSE
            CALL      CLWATTX1
          ENDIF
          RETURN
.------------------------------------------------------------
. Add a new Booking
.------------------------------------------------------------
ADDBOK00  MOVE      ZERO,PROCFLAG
          MOVE      ZERO,FRSTADOC
          PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1     * Read Session Information
          BRANCH    OVRCD,ADDBOK91
.
          UNPACK    WATTRKEY,KEY17
          MATCH     SP70,KEY17
          IF        @EQUAL
            MOVE      SP70,WATTRKEY
            CALL      CLWATDET
            GOTO      ADDBOK10
          ENDIF
.
          MOVE      WATTRKEY,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,ADDBOK95
.
          COMPARE   ONE,WMSTAT              * Only allow bookings on
          GOTO      ADDBOK96 IF NOT EQUAL   * unscheduled WL records
.
          MOVE      WATTRKEY,KEY19
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          CALL      SAVHIS00
.
ADDBOK10  PACK      CURSESS,SESSKEYS,SP70
          UNPACK    SESSKEYS,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          CALL      CALDEF00     * Calculate Default Start Time
          CALL      CLOPRDEA     *  Clear Fields in Operation Details
          PACK      OPDAEXPS,CHOUR,COLON,CMIN
.
          CALL      SETDEA00     *  Clear & Set Fields in Operaion Details
          BRANCH    EXIT,ADDBOK94
.
          CALL      CLPMI000     *  Clear Fields in Masterfile
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            CALL      CLPATMAS
          ELSE
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
          ENDIF
          CALL      SETMAS00     *  Set Fields in MasterFile
          BRANCH    EXIT,ADDBOK99
.
          CALL      CLBOK000     *  Clear Fields in Masterfile
          MOVE      ONE,FIRSTBOK
          MATCH     SP70,ADMISNUM
          IF        !@EQUAL
            PACK      KEY8,ADMISNUM
            CALL      RDBKREC1
            IF        OVRCD=1
              CALL      CLBOK000
            ELSE
              MOVE      BKREADOC,FRSTADOC
              MOVE      ZERO,FIRSTBOK
              CALL      RDBKRX11
              IF        OVRCD=1
                CALL      CLBOKRX1
              ENDIF
            ENDIF
            CALL      RDMISS1
            IF        OVRCD=1
              CALL      CLPATMIS
            ENDIF
            MOVE      ADATE,OLDADATE             * save date for diet info
          ENDIF
.                                              
          CALL      SETBOK00     *  Set Booking Record Fields
          BRANCH    EXIT,ADDBOK99
.
          MOVE      OPSEDATE,BKREADAT
          PACK      BKREBKDT,CCC,CYY,CMM,CDD
          REP       " 0",BKREBKDT
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        @EQUAL
              MOVE      SP70,BKREBKDT
            ELSE
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
.
          PACK      CURSESS,SESSKEYS,SP70
..          CALL      CKOVRLAP     * Check Overlap
..          BRANCH    EXIT,ADDBOK92
.
          IF        OPCNCPOD=0
            GOTO      ADDBOK15
          ENDIF
.
          MATCH     Z70,OPERDES1
          IF        !@EQUAL
            MOVE      OPERDES1,OPDADES1
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      ADDBOK12 IF NOT EQUAL
.
          MATCH     SP70,OPDADES1
          GOTO      ADDBOK12 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV1
          GOTO      ADDBOK12 IF EQUAL
.
          PACK      KEY9,OPERPRV1,SP70
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD<>1
              PACK      OPDADES1,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD<>1
              PACK      OPDADES1,ODESC
            ENDIF
          ENDIF
.
ADDBOK12  MATCH     Z70,OPERDES2
          IF        !@EQUAL
            MOVE      OPERDES2,OPDADES2
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      ADDBOK13 IF NOT EQUAL
.
          MATCH     SP70,OPDADES2
          GOTO      ADDBOK13 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV2
          GOTO      ADDBOK13 IF EQUAL
.
          PACK      KEY9,OPERPRV2,SP70
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD<>1
              PACK      OPDADES2,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD<>1
              PACK      OPDADES2,ODESC
            ENDIF
          ENDIF
.
ADDBOK13  MATCH     Z70,OPERDES3
          IF        !@EQUAL
            MOVE      OPERDES3,OPDADES3
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      ADDBOK14 IF NOT EQUAL
.
          MATCH     SP70,OPDADES3
          GOTO      ADDBOK14 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV3
          GOTO      ADDBOK14 IF EQUAL
.
          PACK      KEY9,OPERPRV3,SP70
          IF        OPCNCODE=1
            PACK      KEY17,KEY9,SP70
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD<>1
              PACK      OPDADES3,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD<>1
              PACK      OPDADES3,ODESC
            ENDIF
          ENDIF
.
ADDBOK14  MATCH     Z70,OPERDES4
          IF        !@EQUAL
            MOVE      OPERDES4,OPDADES4
          ENDIF
          MATCH     Z70,OPERDES5
          IF        !@EQUAL
            MOVE      OPERDES5,OPDADES5
          ENDIF
          MATCH     Z70,OPERDES6
          IF        !@EQUAL
            MOVE      OPERDES6,OPDADES6
          ENDIF
.
ADDBOK15  MATCH     SP70,ADMISNUM
          IF        !@EQUAL
            MOVE      ADMISNUM,BKREBOOK
            MOVE      ZERO,BKRESTAT
            LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR,THREE,TWO
            GOTO      ADDBOK20
          ENDIF
.
          UNPACK    WATTRKEY,KEY17               * If booked from W/List use
          MATCH     SP70,KEY17                   * wmbook as the booking number
          IF         !@EQUAL
            MOVE      WMBOOK,BKREBOOK
            GOTO      ADDBOK20
          ENDIF
.
          CALL      NRBK0000     * Get Next Booking Record
          BRANCH    EXIT,ADDBOK93
.
ADDBOK20  MOVE      BKREBOOK,OPDAADMN       * set up visit number
          PACK      KEY8,OPDAADMN,SP70
          CALL      RABKREC1                * see if it exists
          BRANCH    OVRCD,ADDBOK22          * no record
.
.         For multi theatre booking, do not overwrite bkreadoc from the new
.         theatre booking
.
          IF        CFEETYP=5
            MATCH     SP70,ADMISNUM
            IF        !@EQUAL
              IF        ASTAT=1 | ASTAT=2
                MATCH     SP70,FRSTADOC
                IF        !@EQUAL
                  MOVE      FRSTADOC,BKREADOC * restore the original Att.doctor
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      UPBKREC1                * update booking details
.
ADDBOK22  CALL      UPDMIS00     * Update Admission Date/Time (preadmits only)
          CALL      NBPF0000     * Post Details
.
          CALL      CPROC000     * Check multiple procedures with diff.uniq id
          CALL      CPMB0000     * Check/Post Extra MBS Codes
.
          CALL      WRNZP000     * write to nzprivate procedure table
          CALL      UPDDIA00
          CALL      UPCOM000
          CALL      AUEXDS00     * Write new Extended Procedure Desc
.
          MOVE      OPDAUNIQ,OPPRUNIQ
          MOVE      ONE,OPPRTEAM
          MOVE      OPERPREF,OPPRPREF
          MATCH     Z70,OPERPREF
          IF        @EQUAL
            MOVE      SP70,OPPRPREF
          ENDIF
          MOVE      OPDACLIN,OPPRDCOD
.
          MOVE      SP70,OPPRSPAR
          PACK      KEY32,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,SP70
          CALL      RAOPPRF1
          IF        OVRCD=0
            CALL      UPOPPRF1
          ELSE
            MOVE      ZERO,OPPRPQTY
            CALL      WROPPRF1
          ENDIF
.
          CALL      AAUPRF00
.
          MATCH     SP70,WATTRKEY
          GOTO      ADDBOK30 IF EQUAL
.
          MOVE      WATTRKEY,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,ADDBOK95
.
          MOVE      WMURNO,URNUMBER
          MOVE      TWO,WMSTAT
          LOAD      WMSTAT,OPDASTAT,THREE,FOUR,ONE,FIVE
          MOVE      "01",WTWMBSCD                * Add Booking code
          SQUEEZE   BKREC033
          MOVE      BKREC033,WMSTAY
          MOVE      BKREBOOK,WMBOOK
.
          CALL      UPTREA1
.
          MOVE      WATTRKEY,KEY19
          CALL      RDWTTX11
          IF        OVRCD=0
            CLOCK     TIME,WTTXLUPT
            PACK      WTTXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",WTTXLUPD
            MOVE      USERID,WTTXWEBU   *  WEB User Id rec. updater
            MOVE      BOKRX003,WTTXADMW
            CALL      UPWTTX11
          ELSE
            CALL      CLWATTX1
            UNPACK    WATTRKEY,WTTXURNO,WTTXPCOD,WTTXPCNT
            CLOCK     TIME,WTTXLUPT
            PACK      WTTXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",WTTXLUPD
            CLOCK     TIME,WTTXCTIM
            PACK      WTTXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WTTXCDTE
            MOVE      USERID,WTTXWEBC   *  WEB User Id rec. updater
            MOVE      USERID,WTTXWEBU   *  WEB User Id rec. updater
            MOVE      BOKRX003,WTTXADMW
            MOVE      SP70,WTTXANAE
            CALL      WRWTTX11
          ENDIF
.
          MOVE      "01",WTWMBSCD                * Add Booking code
          MOVE      BKREADAT,SAVDBFT
          MOVE      BKREBKDT,SAVBMDT
          MOVE      SP70,SAVEBCAN
          MOVE      ONE,NBRFLAG
          MOVE      ZERO,ADDWLFLG
          CALL      WRTHIS00            * Write History to W/L
.
          PACK      WTENEVDT,BKREBKDT   * Write ESIS Intra Episode Record
          PACK      WTENEVAL,BKREEDAT
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          MOVE      ANSS,WTENETYP
          PACK      WTENSADI,OPDAUNIQ
          CALL      WSAD0000
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      NINE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
ADDBOK30  MOVE      BKREBOOK,BKRXBNUM
          IF        PROCFLAG=0
            MOVE      OPERDES1,BKRXUFF1
          ENDIF
          MOVE      OPERDES2,BKRXUFF2
          MOVE      OPERDES3,BKRXUFF3
          MOVE      OPDAASRC,BKRXASRC
          MOVE      BOKRX003,BKRXADWD
.         MOVE      WTTXADMW,BKRXADWD
.
          MATCH     "1",BOKRX039
          IF        @EQUAL
            MOVE      BOKRX011,BKRXUDF5
          ENDIF
.
          PACK      BKRXCRDT,CCC,CYY,CMM,CDD
          REP       " 0",BKRXCRDT
.
          CLOCK     TIME,BKRXCRTM
          MOVE      WBSEUID,BKRXWEBC
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RABKRX11
          IF        OVRCD=1
            CALL      WRBKRX11
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUB             * Pass Pre-Ad Booking to DG I-90202
          ELSE
            CALL     UPBKRX11
          ENDIF
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RABKREC1
          IF        OVRCD = 0
            IF        BKRESTAT = 2
              MOVE      SP70,BKRECANC
              MOVE      ONE,BKRESTAT
              CALL      UPBKREC1
            ENDIF
          ENDIF
.
          CALL      WEBAUD00     * Update WEB Booking Audit File
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PMVXATCP
            IF        @EQUAL
              MOVE      ZERO,PMVXATCP       * Set All theatre charges posted to
              CALL      UPPMVX11            * no if adding additional bookings
            ENDIF                           * for this admission
          ENDIF
.
.         We want to update the Post Op Ward/Bed in Visit Extension file also
.         for current admission...
.
          COMPARE   TWO,ASTAT
          GOTO      ADDBOK40 IF NOT EQUAL
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,ADDBOK40
.
          MATCH     Z70,BOKRX002
          IF        !@EQUAL
.           MATCH     "1",FIRSTBOK
.           IF        @EQUAL
              PACK      PMVXPOWD,BKRXPOWD,SP70
.           ELSE
.             PACK      PMVXPOWD,OPDAPOWD,SP70
.           ENDIF
          ENDIF
.
          MATCH     Z70,BOKRX038
          IF        !@EQUAL
            PACK      PMVXPOBD,BKRXPOBD,SP70
          ENDIF
.
          CALL      UPPMVX11
.
ADDBOK40  MOVE      BKREBOOK,ADMISSNO
          PROC      BBUP0000                * Bed Board
          CALL      ADTD0000                * update Transfer Dest. file
.
          MATCH     SP70,ADMISNUM           * Eclipse OEC
          IF        !@EQUAL
.
            PACK      KEY8,ADMISNUM,SP70     * Update pmsvx1af.pmvxpoec
            CALL      RDPMVX11               * OEC Consent
            IF        OVRCD=0
              MATCH     Z70,PTVIS111
              IF        !@EQUAL
                MOVE      PTVIS111,PMVXPILC
              ENDIF
              CALL      UPPMVX11
            ENDIF
.
            MATCH     "1",BOKRX039           * Update patmi1af and patvisaf
            IF        @EQUAL
              CALL      UPMSEC00
            ENDIF
.                                            * Update/Write to patelgaf,pmsoecaf
            CALL      ECLOEC00               * pmsoesaf
.
          ELSE
.
            CALL      FBOOEC00               * FFormat OECW Theatre Booking Only
.
          ENDIF
.
          MATCH     ADMISNID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      SEVEN,KEY1
            MOVE      ADMISSNO,KEY8
            PROC      UPEADMVS                 * Update eAdmssion Details
          ENDIF
.
          MATCH     EREFRLID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      " 7",KEY2              * Added as Booking
            MOVE      ADMISSNO,KEY8
            PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
            PROC      UPEREFVS               * Update eReferral Details
          ENDIF
.
          MATCH     CORSP001,SP70
          IF        !@EQUAL
            MOVE      ONE,F1
            MOVE      ADMISSNO,KEY8
            PROC      UPEADMVS                 * Update eAdmssion Details
          ENDIF
.
.          MATCH     "1",UVTHINDI
.          IF        @EQUAL
.            PACK      KEY8,ADMISNUM,SP70
.            CALL      RDPMVX11
.            IF        OVRCD=0
.              MOVE      PTVIS079,PMVXUVTH
.              CALL      UPPMVX11
.            ENDIF
.          ENDIF
.
. redirection check for waiting list and theatre
.
          IF        NEXTPAGE=8
            MATCH   SP70,REDIRECT
            IF      !@EQUAL
              MOVE    REDIRECT,HTMLLINK
            ENDIF
          ELSE
            MATCH     SP70,WATTRKEY
            IF        @EQUAL
              MOVE      NEXTLINK,HTMLLINK
            ELSE
              CLEAR     HTMLLINK
              APPEND    "watweb01.pbl?reportno=2&template=1&casekeys=",HTMLLINK
              APPEND    CASEKEYS,HTMLLINK
              RESET     HTMLLINK
            ENDIF
          ENDIF
.
          MATCH     SP70,ADMISNUM
          IF        @EQUAL
            MOVE      "New Theatre Booking Created",WEBTITLE
          ELSE
            MATCH     "1",BOKRX039
            IF        @EQUAL
              MOVE      "Theatre Booking and OEC Request Created",WEBTITLE
            ELSE
              MOVE      "Theatre Booking Created",WEBTITLE
            ENDIF
          ENDIF
.
ADDBOK80  CALL      UPADM000
          CALL      UNUT0000                * Nutrition record update
          CALL      UPRQ1000                * Booking theatre request
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,DBKREBOO,SP70
            CALL      WRPORD00          * write ACC purchase order
          ENDIF
.
          CALL      UPDMAS00
.
          CALL      WINNXT00
          GOTO      ADDBOK99
.
ADDBOK90  MOVE      "Invalid Update - Name Fields Required",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK91  MOVE      "Invalid Update - No Session",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK92  MOVE      "Invalid Update - Overlap",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK93  MOVE      "Invalid Update - No Booking",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK94  MOVE      "Clear & Set Operation Fail",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK95  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK96  MOVE      "Invalid Waiting List Status",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDBOK99
.
ADDBOK99  CLOSE     OPCOMFIL,DELETE
          CLOSE     EXPCMTFI,DELETE
          RETURN
.------------------------------------------------------------
WSAD0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      WSAD9999 IF NOT EQUAL
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENWEBC,USERID,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
WSAD9999  RETURN
.
.-----------------------------------------------------------------
.         Check for multiple procedures with different uniq.id         
.-----------------------------------------------------------------
CPROC000  MOVE      ZERO,PROCFLAG
.
          COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      CPROC999 IF NOT EQUAL
.
          MOVE      SP70,KEY10
          PACK      KEY11,OPDAADMN,SP70
          CALL      RSNZSPR1
CPROC100  CALL      RKNZSPR1
          BRANCH    OVRCD,CPROC999
.
          MATCH     OPDAADMN,NZSPADMN
          GOTO      CPROC999 IF NOT EQUAL
.
          MATCH     SP70,NZSPUNTH
          GOTO      CPROC100 IF EQUAL
.
          MATCH     NZSPUNTH,OPDAUNIQ
          GOTO      CPROC100 IF EQUAL
.
          MOVE      ONE,PROCFLAG          * multiple theatre booking
.
CPROC999  RETURN
+
.-----------------------------------------------------------------
.  Update Diagnosis Defaults
.-----------------------------------------------------------------
UPDDIA00  MOVE      BKREBOOK,BKDIBOOK       * set booking number
          MOVE      OPDAUNIQ,BKDIUNIQ       * set unique number
          PACK      KEY18,BKDIBOOK,BKDIUNIQ,SP70
          CALL      RDBKDIA1
          IF        OVRCD=1
            CALL      CLBOKDIA
          ENDIF
          IF        OPCNCMBD=1
            MATCH     Z70,OPERDES1
            IF        !@EQUAL
              MOVE      OPERDES1,BKDIDES1
            ENDIF
            MATCH     Z70,OPERDES2
            IF        !@EQUAL
              MOVE      OPERDES2,BKDIDES2
            ENDIF
            MATCH     Z70,OPERDES3
            IF        !@EQUAL
              MOVE      OPERDES3,BKDIDES3
            ENDIF
            MATCH     Z70,OPERDES4
            IF        !@EQUAL
              MOVE      OPERDES4,BKDIDES4
            ENDIF
            MATCH     Z70,OPERDES5
            IF        !@EQUAL
              MOVE      OPERDES5,BKDIDES5
            ENDIF
            MATCH     Z70,OPERDES6
            IF        !@EQUAL
              MOVE      OPERDES6,BKDIDES6
            ENDIF
          ENDIF
          MOVE      BKREBOOK,BKDIBOOK       * set booking number
          MOVE      OPDAUNIQ,BKDIUNIQ       * set unique number
          PACK      KEY18,BKDIBOOK,BKDIUNIQ,SP70
          CALL      RABKDIA1
          IF        OVRCD=1
            CALL      WRBKDIA1
          ELSE
            CALL      UPBKDIA1                * update file
          ENDIF
UPDDIA99  RETURN
.
.------------------------------------------------------------
.         Checking extra MBS Codes
.------------------------------------------------------------
CPMB0000  CALL      DMBS0000            * Delete current existing Extra MBS
          MOVE      ZERO,FORM3
.
          MOVE      ZERO,F2
CPMB1000  ADD       ONE,F2
          COMPARE   "28",F2
          GOTO      CPMB9999 IF NOT LESS
.
          MOVE      SP70,KEY9
          LOAD      KEY9,F2,OPERPRV4,OPERPRV5:
                            OPERPRV6,OPERPRV7,OPERPRV8,OPERPRV9,OPERPR10:
                            OPERPR11,OPERPR12,OPERPR13,OPERPR14,OPERPR15:
                            OPERPR16,OPERPR17,OPERPR18,OPERPR19,OPERPR20:
                            OPERPR21,OPERPR22,OPERPR23,OPERPR24,OPERPR25:
                            OPERPR26,OPERPR27,OPERPR28,OPERPR29,OPERPR30
.
          MATCH     Z70,KEY9
          GOTO      CPMB1000 IF EQUAL
.
          MATCH     SP70,KEY9
          GOTO      CPMB1000 IF EQUAL
.
          ADD       ONE,FORM3
          CALL      WRMB0000
          GOTO      CPMB1000
.
CPMB9999  RETURN
+
.------------------------------------------------------------
.         Write extra MBS codes
.------------------------------------------------------------
WRMB0000  MOVE      OPDAUNIQ,OPMBUNIQ
          MOVE      FORM3,OPMBCNTR
          PACK      KEY13,OPMBUNIQ,OPMBCNTR,SP70
          CALL      RAOPMBS1
          IF        OVRCD=1
            MOVE      KEY9,OPMBMBSI
            MOVE      WBSEUID,OPMBCUID
            CALL      IBACLOCK
            PACK      OPMBCDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPMBCDAT
            CLOCK     TIME,OPMBCTIM
            PACK      OPMBSPAR,SP70,SP70
            CALL      WROPMBS1
          ENDIF
WRMB9999  RETURN
+
.------------------------------------------------------------
. Clear Booking Details
.------------------------------------------------------------
CLBOK000  CALL      CLBOKRC1
.
.         clear bokdiaaf variables
.
          MOVE      SP10,BKDICODE
          PACK      BKDIDES1,SP30,SP20
          PACK      BKDIDES2,SP30,SP20
          PACK      BKDIDES3,SP30,SP20
          PACK      BKDIDES4,SP30,SP20
          PACK      BKDIDES5,SP30,SP20
          PACK      BKDIDES6,SP30,SP20
          PACK      BKDICOMM,SP20,SP20
          PACK      BKDIUNIQ,SP20,SP20
.
          MOVE      SP70,BKRXBNUM
          MOVE      SP70,BKRXPOWD
          MOVE      SP70,BKRXADWD
          MOVE      SP70,BKRXCDTE
          MOVE      SP70,BKRXPSTY
          MOVE      SP70,BKRXCNDT
          MOVE      SP70,BKRXUDF1
          MOVE      SP70,BKRXUDF2
          MOVE      SP70,BKRXUDF3
          MOVE      SP70,BKRXUDF4
          MOVE      SP70,BKRXUDF5
          MOVE      SP70,BKRXUDD1
          MOVE      SP70,BKRXUDD1
          MOVE      SP70,BKRXUDD2
          MOVE      SP70,BKRXUDD3
          MOVE      SP70,BKRXUDD4
          MOVE      SP70,BKRXUFF1
          MOVE      SP70,BKRXUFF2
          MOVE      SP70,BKRXUFF3
          MOVE      SP70,BKRXUFF4
          MOVE      SP70,BKRXEDC1
          MOVE      SP70,BKRXEDC2
          MOVE      SP70,BKRXEDC3
          MOVE      SP70,BKRXODTE
          MOVE      SP70,BKRXOPRD
          MOVE      SP70,BKRXCRDT
          MOVE      SP70,BKRXCRTM
          MOVE      SP70,BKRXWEBC
          MOVE      SP70,BKRXLUPD
          MOVE      SP70,BKRXLUPT
          MOVE      SP70,BKRXWEBU
          MOVE      SP70,BKRXASRC
          MOVE      SP70,BKRXBLDT
          MOVE      SP70,BKRXCTTY
          MOVE      SP70,BKRXSGBK
          MOVE      SP70,BKRXFORM
          MOVE      SP70,BKRXCNTM
          MOVE      SP70,BKRXUDT1
          MOVE      SP70,BKRXUDT2
          MOVE      SP70,BKRXPOBD
          MOVE      SP70,BKRXPOEC
          MOVE      SP70,BKRXDIET
          MOVE      SP70,BKRXTRAN
          MOVE      SP70,BKRXATRN
          MOVE      SP70,BKRXANTY
          MOVE      SP70,BKRXESOP
          MOVE      SP70,BKRXEABR
          MOVE      SP70,BKRXAUBY
          MOVE      SP70,BKRXEAID
          MOVE      SP70,BKRXDROR
          MOVE      SP70,BKRXUDF6
          MOVE      SP70,BKRXUDF7
          MOVE      SP70,BKRXPACA
          MOVE      SP70,BKRXSPAR
.
          RETURN
+
.------------------------------------------------------------
. Clear booking diagnosis details
.------------------------------------------------------------
CLBOKDIA  MOVE      SP10,BKDICODE
          PACK      BKDIDES1,SP30,SP20
          PACK      BKDIDES2,SP30,SP20
          PACK      BKDIDES3,SP30,SP20
          PACK      BKDIDES4,SP30,SP20
          PACK      BKDIDES5,SP30,SP20
          PACK      BKDIDES6,SP30,SP20
          PACK      BKDICOMM,SP20,SP20
          PACK      BKDIUNIQ,SP20,SP20
.
          RETURN
+
.------------------------------------------------------------
. Update Web Booking Audit File
.------------------------------------------------------------
WEBAUD00  CLOCK    TIME,CTIMEIS
          READ     CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC
          MOVE     CDD,CDAY
          MOVE     CMM,CMON
          MOVE     CYY,CYEAR
          REP      " 0",CYEAR
          MOVE     CCC,CCENT
          CALL     IBACLOCK
          MOVE     CDD,CDAY
          MOVE     CMM,CMON
          MOVE     CYY,CYEAR
          REP      " 0",CYEAR
          MOVE     CCC,CCENT
.
..          PACK     KEY10,OPDAUNIQ,SP70
..          UNPACK   KEY10,OPWBUNIQ
..          CALL     RDOPWEB1
..          BRANCH   OVRCD,WEBAUD10
..          PACK     OPWBUDAT,CCENT,CYEAR,CMON,CDAY
..          REP      " 0",OPWBUDAT
..          MOVE     CTIMEIS,OPWBUTIM
..          MOVE     PASSCODE,OPWBUPAS
..          CALL     UPOPWEB1
          GOTO     WEBAUD99
.
WEBAUD10
..          PACK     OPWBCDAT,CCENT,CYEAR,CMON,CDAY
..          REP      " 0",OPWBCDAT
..          MOVE     CTIMEIS,OPWBCTIM
..          MOVE     PASSCODE,OPWBCPAS
..          PACK     OPWBUDAT,CCENT,CYEAR,CMON,CDAY
..          REP      " 0",OPWBUDAT
..          MOVE     CTIMEIS,OPWBUTIM
..          MOVE     PASSCODE,OPWBUPAS
..          CALL     WROPWEB1
.
WEBAUD99  RETURN
.------------------------------------------------------------
. Post Cancel Case
.------------------------------------------------------------
POSCAN00  CALL      CLWATDET
.
          MATCH     SP70,CASEUNIQ
          IF        !@EQUAL
            PACK      KEY10,CASEUNIQ,SP70
            CALL      RDOPDEA3
            IF        OVRCD=1
              MOVE      "Case Does Not Exist. Please Contact Hospital",WEBTITLE
              CALL      WEBERR00
              GOTO      POSCAN99
            ELSE
              PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                                 OPDACASE
            ENDIF
          ENDIF
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=1
            MOVE      "Case Does Not Exist. Please Contact Hospital",WEBTITLE
            CALL      WEBERR00
            GOTO      POSCAN99
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,SP10
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          IF        OVRCD=0
            MATCH     OPDAUNIQ,OPDCUNIQ
            IF        @EQUAL
              MOVE      "Usage exists. Please Contact Hospital",WEBTITLE
              CALL      WEBERR00
              GOTO      POSCAN99
            ENDIF
          ENDIF
.
          COMPARE   ONE,CHKBLOCK
          IF        @EQUAL
            UNPACK    CASEKEYS,KEY3,DATE,TIME,KEY6
            UNPACK    DATE,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            DAYSEP    KEY8,DATE,FORM2
            PACK      KEY21,WBSEHOSP,KEY6,WEEKDAY,TIME,OPDATHET,SP70
            CALL      RDOPSEM1
            IF        OVRCD<>1
              MOVE      ZERO,DAYSOPEN
              MOVE      OPSMNDLK,DAYSOPEN
              IF        DAYSOPEN>0
                COMPARE   FORM2,DAYSOPEN
                IF        !@LESS
                  MOVE      "Session is Locked. Contact the Theatre",WEBTITLE
                 CALL      WEBERR00
                 GOTO      POSCAN99
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      CASDET00
.
          MOVE      OPDAADMN,SAVEADMN        * save the admission number
          MOVE      OPDAADMN,SAVADMN
          MOVE      PATCANTH,ACODE
          MOVE      ACODE,DIM3
          MOVE      ACODE,REPLY
          UNPACK    CASEKEYS,CURSESS,KEY1,KEY3
          MOVE      KEY3,CURCASE
          MOVE      KEY1,CURSTAT
.
          MOVE      SP70,ORIGCANC
          MATCH     "3",KEY1                     * If already cancelled
          IF        @EQUAL
            MOVE      OPDACANC,ORIGCANC          * Save original cancellation
          ENDIF                                  * reason for integrity audit
.
          CALL      CTRN0000                     * Check transfer source
          BRANCH    EXIT,POSCAN99
.
          CALL      CDEP0000                     * Check for deposits
          BRANCH    EXIT,POSCAN99
.
...       CALL      DEAREC00           * delete this case from all files ?
          MOVE      ZERO,UPCANBOK
          COMPARE   TWO,BKRESTAT
          IF        @EQUAL
            MOVE      ONE,UPCANBOK
          ENDIF
.
          MOVE      OPDEA031,DIM8      * cancellation date
          CALL      CANDEA00           * cancel oprdeafd
          CALL      CANREC00           * cancel bokrecfd
.
          IF        EXIT=1
            MOVE      "Unable to Cancel. Please Contact Hospital",WEBTITLE
            MOVE      REDIRECT,HTMLLINK
            CALL      WEBERR00
            GOTO      POSCAN99
          ENDIF
.
          MATCH     SP70,OPDAPROC      * WL Procedure Code?
          GOTO      POSCAN50 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          IF        OVRCD=1
            CALL      CLWATDET
          ENDIF
.
.         Get the PMI details for the HL7 broadcast message (TSK 0863502)
.
          MOVE      OPDAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,POSCAN50
.
          CALL      CLPMSPX2
          MOVE      OPDAURNO,KEY8
          CALL      RDPMPX21
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
POSCAN50  MOVE      SP70,SAOPCHGD
          MOVE      THREE,OPHITCHG
          CALL      WOPHIS00           * write a history record
.
          MOVE      BKREBOOK,ADMISSNO
          PROC      BBUP0000           * Bed Board
          CALL      UNEMR000           * clear linked IP visit from ED
.
          CALL      WCHA0000           * Data integrity audit
.
          CALL      CANRQ100
.
.         Update patient visit theatre complete status...
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,POSCAN80
.
          MOVE      PMVXVISN,OPTHVISN
          PROC      OPTHCMPL                * Validate theatre charges complete
          IF        EXIT=1
            MOVE      ONE,PMVXATCP          * Update charges posted for visit
            MOVE      SP70,PMVXTICM         * Clear reason incomplete
            MOVE      "018",TADTTYPE        * Theatre complete audit record
          ELSE
            MOVE      ZERO,PMVXATCP         * Theatre charges incomplete
            MOVE      OPTHRICM,PMVXTICM     * Update reason
            MOVE      "019",TADTTYPE        * Theatre incomplete audit record
          ENDIF
.
          CALL      UPPMVX11
.
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
          PROC      OPTHETAT                * write audit
.
POSCAN80
.
.         CALL      WINCLS00
          MOVE      REDIRECT,HTMLLINK
          CALL      WINRDT00
.
POSCAN99  RETURN
.------------------------------------------------------------
. Redirect Page
.------------------------------------------------------------
WINRDT00  CALL      OPENHTML
          BRANCH    EXIT,WINRDT99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",HTMLLINK,"#");":
                             "}":
                             " else { ":
                             "  parent.location.href=#"",HTMLLINK,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINRDT99  RETURN
.------------------------------------------------------------
. Redirect Page
.------------------------------------------------------------
WEBRDT00
.
WEBRDT99  RETURN
.------------------------------------------------------------
. Show Booking Details
.------------------------------------------------------------
SHWCAS00  MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      SHWCAS85
.
...         PACK      KEY31,ADMISSNO,ZERO,SP70
...         CALL      RSOPDEA2
...         CALL      RKOPDEA2
...         BRANCH    OVRCD,SHWCAS90
...         MATCH     ADMISSNO,OPDAADMN
...         GOTO      SHWCAS90 IF NOT EQUAL
...         PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,SHWCAS90
          ENDIF
.
          CALL      CASDET00              * Get Case Details
.
          PACK      SESSKEYS,CASEKEYS,SP70
          PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,SHWCAS90
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (",WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SHWCAS99
          CALL      WEBBOD00
          CALL      WEBEND00
.
          GOTO      SHWCAS99
.
SHWCAS85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWCAS99
.
SHWCAS90  MOVE      "Invalid Case Access",WEBTITLE
          CALL      WEBERR00
          GOTO      SHWCAS99
.
SHWCAS99  RETURN
.------------------------------------------------------------
. Edit Booking
.------------------------------------------------------------
EDTBOK00  MATCH     SP70,CASEUNIQ
          IF        !@EQUAL
            PACK      KEY10,CASEUNIQ,SP70
            CALL      RDOPDEA3
            IF        OVRCD=1
              GOTO      EDTBOK85
            ELSE
              PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                                 OPDACASE
            ENDIF
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      EDTBOK85
.
...         PACK      KEY31,ADMISSNO,ZERO,SP70
...         CALL      RSOPDEA2
...         CALL      RKOPDEA2
...         BRANCH    OVRCD,EDTBOK95
...         MATCH     ADMISSNO,OPDAADMN
...         GOTO      EDTBOK95 IF NOT EQUAL
...         PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,EDTBOK95
.
            MOVE      ZERO,F3
            MOVE      TEMPLATE,F3
            IF        F3=2
              CALL      CASSTS00      * Patient In Theatre?
              BRANCH    EXIT,EDTBOK96 * Yes, can't Transfer
            ENDIF
          ENDIF
.
. * set a flag if this is the first booking for this admission *
          CALL      CHKFB000
.
          CALL      CLWATDET
          CALL      CLWATOPA
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          CALL      RDBKRX11
          MOVE      BKREDEPT,WMUNIT
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          CALL      CASDET00
          BRANCH    EXIT,EDTBOK99
.
          PACK      SESSKEYS,CASEKEYS,SP70
.
          CALL      GETSES00  * Session Details
.
          MOVE      ZERO,NOOFDAYS
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,CURRDATE
          MOVE      OPSEDATE,BOOKDATE
.
          CALL      SETFLD00
          CALL      SPMB0000              * set Provisional MBS
.
          MOVE      OPDAUNIQ,DIM10
          CALL      PTHV0000
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,EDTBOK95
.
          MATCH     SP70,OPDAPROC
          GOTO      EDTBOK80 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,EDTBOK80
          CALL      RDWTTX11
          BRANCH    OVRCD,EDTBOK80
.
          CALL      PADM0000           * check for outpatient PAC link
.
EDTBOK80  PACK      KEY8,OPDAADMN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDPTELG1
          IF        OVRCD=1
            CALL      CLPATELG
          ENDIF
.
          MATCH     "1",PTCNOECW
          IF        @EQUAL
            PACK      KEY11,OPDAADMN,Z70
            CALL      RSWBOEC1
            CALL      RPWBOEC1
            IF        OVRCD=ONE
              CALL      CLWEBOEC
            ELSE
              MATCH     OPDAADMN,WBOCVISN
              IF        !@EQUAL
                CALL      CLWEBOEC
              ENDIF
            ENDIF
.
            PACK      KEY19,OPDAADMN,Z70
            CALL      RSWBELF5
            CALL      RPWBELF5
            IF        OVRCD=ONE
              CALL      CLWEBELF
            ELSE
              MATCH     OPDAADMN,WBEFVISN
              IF        !@EQUAL
                CALL      CLWEBELF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "001",TEMPLATE
          IF        @EQUAL
            MATCH     "3",DOPDASTA
            GOTO      EDTBOK86 IF EQUAL
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (Theatre Booking Details)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,EDTBOK99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      EDTBOK99
.
EDTBOK85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          GOTO      EDTBOK99
.
EDTBOK86  MOVE      "Error: Booking Cancelled",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
EDTBOK95  MOVE      "Invalid Case",WEBTITLE
          CALL      WEBERR00
          GOTO      EDTBOK99
.
EDTBOK96  MOVE      "Transfer Invalid - Theatre Utilization Complete",WEBTITLE
          CALL      WEBERR00
          GOTO      EDTBOK99
.
EDTBOK99  RETURN
.---------------------------------------------------------------------
.         Check if this is the first booking for this admission number
.---------------------------------------------------------------------
CHKFB000  PACK      SAVUNIQ,OPDAUNIQ,SP70
          PACK      SAVEADMN,OPDAADMN,SP70
          PACK      KEY31,OPDAADMN,SP70
          CALL      RSOPDEA2
CHKFB010  CALL      RKOPDEA2
          BRANCH    OVRCD,CHKFB900
.
          MATCH     OPDAADMN,SAVEADMN
          GOTO      CHKFB900 IF NOT EQUAL
.
          MATCH     "3",OPDACASE
          GOTO      CHKFB010 IF EQUAL
.
. * found first case - is it this unique id
          MATCH     OPDAUNIQ,SAVUNIQ
          IF        @EQUAL
            MOVE      ONE,FIRSTBOK
          ENDIF
          GOTO      CHKFB900
.
.
. * re-read original case
CHKFB900  PACK      KEY10,SAVUNIQ,SP70
          CALL      RDOPDEA3
          IF        OVRCD=1
            GOTO      CHKFB999
          ENDIF
.
CHKFB999  RETURN
+
.------------------------------------------------------------
.         Store Provisional MBS to variables
.------------------------------------------------------------
SPMB0000  UNPACK    SP70,OPERPRV4,OPERPRV5,OPERPRV6,OPERPRV7,OPERPRV8
          UNPACK    SP70,OPERPRV9,OPERPR10,OPERPR11,OPERPR12,OPERPR13
          UNPACK    SP70,OPERPR14,OPERPR15
          UNPACK    SP70,OPERPR16,OPERPR17,OPERPR18,OPERPR19,OPERPR20
          UNPACK    SP70,OPERPR21,OPERPR22,OPERPR23,OPERPR24,OPERPR25
          UNPACK    SP70,OPERPR26,OPERPR27,OPERPR28,OPERPR29,OPERPR30
.
          MOVE      ZERO,FORM2
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
SPMB1000  CALL      RKOPMBS1
          BRANCH    OVRCD,SPMB9999
.
          MATCH     OPMBUNIQ,OPDAUNIQ
          GOTO      SPMB9999 IF NOT EQUAL
.
          ADD       ONE,FORM2
          STORE     OPMBMBSI,FORM2,OPERPRV4,OPERPRV5:
                                   OPERPRV6,OPERPRV7,OPERPRV8,OPERPRV9,OPERPR10:
                                   OPERPR11,OPERPR12,OPERPR13,OPERPR14,OPERPR15:
                                   OPERPR16,OPERPR17,OPERPR18,OPERPR19,OPERPR20:
                                   OPERPR21,OPERPR22,OPERPR23,OPERPR24,OPERPR25:
                                   OPERPR26,OPERPR27,OPERPR28,OPERPR29,OPERPR30
          COMPARE   "27",FORM2
          GOTO      SPMB1000 IF LESS

SPMB9999  RETURN
+
.------------------------------------------------------------
. Set Fields for Modifications
.------------------------------------------------------------
SETFLD00  MOVE      PTITL,PATTITLE
          MOVE      PSNAME,PATSNAME
          MOVE      PGNAME,PATGNAME
          MOVE      PADD1,PATADDR1
          MOVE      PADD2,PATADDR2
          MOVE      PSUBRB,PATADDR3
          MOVE      PPOST,PATPOSTC
          MOVE      PTELEB,PATBUSPH
          MOVE      PTELEP,PATHOMPH
          MOVE      PSEX,PATGENDE
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PATBIRDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          MOVE      PMSTAT,PATMSTAT
          MOVE      PCONT,PATCOBIR
          MOVE      PREG,PATRELIG
          MOVE      PTYPE,PATRSTAT
          MOVE      POCCUP,PATOCCUP
          MOVE      PMEDI,PATMEDIC
          MOVE      PPENNO,PATPENSI
          MOVE      PPNDTE,PATPENEX
          MOVE      PFUNDH,PATHFUND
          MOVE      BKRECLMT,PATCLAIM
          PACK      PATPAYOR,PATHFUND,PATCLAIM,SP70
          PACK      PATADMDT,BKREEDAT,SP70
          MOVE      OPDAEXPD,OPEREXPD
          MOVE      OPDAANAE,OPERANAE
          MOVE      OPDATYPE,OPERTYPE
          MOVE      OPDATRAN,OPERTRAN
          MOVE      OPDAUSR1,OPERUSR1
          MOVE      OPDAUSR2,OPERUSR2
          MOVE      OPDAUSR3,OPERUSR3
          MOVE      OPDAUSR4,OPERUSR4
          MOVE      OPDAPROV,OPERPRV1
          MOVE      OPDAPRV2,OPERPRV2
          MOVE      OPDAPRV3,OPERPRV3
.
          MOVE      BKRXUFF1,OPERDES1
          MOVE      BKRXUFF2,OPERDES2
          MOVE      BKRXUFF3,OPERDES3
          MOVE      OPDACOMM,OPERCOMM
          MOVE      OPDAKNOW,OPERKNOW
          MOVE      OPDAEQR1,OPDEA032                  * HPS01I
          MOVE      OPDAEQR2,OPDEA033                  * HPS01I
          MOVE      OPDALEQR,OPDEA034                  * HPS01I
          MOVE      OPDAEQR3,OPDEA035                  * HPS01I
.
          MOVE      SP70,OPERPREF
          PACK      KEY32,OPDAUNIQ,ONE,SP70
          CALL      RSOPPRF1
          CALL      RKOPPRF1
          BRANCH    OVRCD,SETFLD99
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      SETFLD99 IF NOT EQUAL
          MOVE      OPPRPREF,OPERPREF
.
SETFLD99  RETURN
.------------------------------------------------------------
. Cancel Booking
.------------------------------------------------------------
CASCAN00  MOVE      SP70,THETCOMP
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      CASCAN85
.
...         PACK      KEY31,ADMISSNO,ZERO,SP70
...         CALL      RSOPDEA2
...         CALL      RKOPDEA2
...         BRANCH    OVRCD,CASCAN95
...         MATCH     ADMISSNO,OPDAADMN
...         GOTO      CASCAN95 IF NOT EQUAL
...         PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,CASCAN95
            MOVE      OPDAADMN,ADMISSNO
          ENDIF
.
          CALL      CLWATDET
          MATCH     SP70,OPDAPROC
          IF        !@EQUAL
            PACK      KEY19,URNUMBER,OPDAPROC,OPDACONT,SP70
            CALL      RDTREA1
            IF        OVRCD=1
              CALL      CLWATDET
            ENDIF
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
          MATCH     OPDAUNIQ,OPSGUNID
          IF        !@EQUAL
            CALL      CLOPRSRG
          ENDIF
.
          CALL      CASDET00
.
          PACK      SESSKEYS,CASEKEYS,SP70
.
          CALL      GETSES00  * Session Details
.
          MOVE      ZERO,NOOFDAYS
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,CURRDATE
          MOVE      OPSEDATE,BOOKDATE
.
          CALL      SETFLD00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      CLBOKRQ1
          MATCH     SP70,OPDAREQN
          IF        !@EQUAL & !@EOS
            PACK      KEY10,OPDAREQN,SP70
            CALL      RDBKRQ11
            IF        OVRCD=1
              CALL      CLBOKRQ1
            ELSE
              PACK     KEY10,OPDAUNIQ,SP70
              CALL     RDOPARD1
              IF        OVRCD=1
                CALL      CLOPRARD
              ENDIF
.
              MOVE     ZERO,FORM2
              MOVE     OPCNTRCS,FORM2
.
              LOAD     THETCOMP,FORM2,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                      OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                      OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                      OPARTIDP,OPARTETC
            ENDIF
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (Cancel Booking)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,CASCAN99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      CASCAN99
.
CASCAN85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          GOTO      CASCAN99
.
CASCAN95  MOVE      "Invalid Case",WEBTITLE
          CALL      WEBERR00
          GOTO      CASCAN99
.
CASCAN99  RETURN
+
.------------------------------------------------------------
. Move Session
.------------------------------------------------------------
SESMOV00  MATCH     SP70,NEWSESSI
          GOTO      SESMOV80 IF EQUAL
          MATCH     Z70,PATADMDT
          GOTO      SESMOV82 IF EQUAL
          MATCH     SP70,PATADMDT
          GOTO      SESMOV82 IF EQUAL
          MATCH     SP70,CASEKEYS
          GOTO      SESMOV84 IF EQUAL
          MATCH     NEWSESSI,CASEKEYS
          GOTO      SESMOV99 IF EQUAL
.
          PACK      KEY22,NEWSESSI,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,SESMOV89
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,SESMOV86
.
. ***** don't allow a cancelled case to be moved ****
          COMPARE   THREE,OPDASTAT
          GOTO      SESMOV88 IF EQUAL
.
          MOVE      SP70,SAOPCHGD
          MOVE      THREE,OPHITCHG
          CALL      WOPHIS00     * write a history record
.
          CALL      TBTRN000     * Perform Transfer
.
.         MOVE      OPHIS001,SAOPCHGD        * HPSI
.         CALL      WOPHIS00                 * HPSI
.
. Read new session details with new CASEKEYS from TBTRN000
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,SESMOV80
.
          MOVE      TRANREAS,SAOPCHGD
          MOVE      TWO,OPHITCHG
          CALL      WOPHIS00     * write a history record
.
          MOVE      BKREBOOK,ADMISSNO
          PROC      BBUP0000              * Bed Board
.
          MATCH     SP70,OPDAPROC
          IF        !@EQUAL
            PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
            CALL      RDTREA1
            IF        OVRCD<>1
.
              MOVE      "06",WTWMBSCD
              CALL      UPTREA1
.
              CALL      WCHB0000            * Data integrity audit
.
              PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
              CALL      RDWTTX11
              IF        OVRCD=1
                CALL      CLWATTX1
              ENDIF
.
.             Get the PMI details for the HL7 broadcast message (TSK 0879635)
.
              MOVE      OPDAURNO,KEY8
              CALL      RDMAST1
              BRANCH    OVRCD,SESMOV70
.
              CALL      CLPMSPX2
              MOVE      OPDAURNO,KEY8
              CALL      RDPMPX21
.
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TEN4,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLIUWL            * HL7 - Update Waiting List Entry
            ENDIF
          ENDIF
.
SESMOV70  MOVE      ZERO,EXIT
          GOTO      SESMOV99
.
SESMOV80  MOVE      "ERROR - New Session Not Specified. ",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV82  MOVE      "ERROR - New Admission Date Required. ",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV84  MOVE      "ERROR - Case Not Identified. ",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV86  MOVE      "Case Does Not Exist.",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV88  MOVE      "ERROR - Case Is Cancelled. ",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV89  MOVE      "ERROR - New Session Not Found. ",WEBTITLE
          CALL      WEBERR00
          GOTO      SESMOV90
.
SESMOV90  MOVE      ONE,EXIT
.
SESMOV99  RETURN
.------------------------------------------------------------
. Post Edit Changes
.------------------------------------------------------------
POSEDT00  MOVE      SP70,SAVEEXPD
          MOVE      ZERO,PROCFLAG
          MATCH     SP70,CASEUNIQ
          IF        !@EQUAL
            PACK      KEY10,CASEUNIQ,SP70
            CALL      RDOPDEA3
            IF        OVRCD=1
              MOVE      "Case Does Not Exist. Please Contact Hospital",WEBTITLE
              CALL      WEBERR00
              GOTO      POSEDT90
            ELSE
              PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                                 OPDACASE
            ENDIF
          ENDIF
.
          PACK      KEY26,CASEKEYS,SP70
          UNPACK    CASEKEYS,CURSESS,ANS,KEY3
          CALL      RDOPDEA1
          IF        OVRCD=1
            MOVE      "Case Does Not Exist. Please Contact Hospital",WEBTITLE
            CALL      WEBERR00
            GOTO      POSEDT90
          ENDIF
.
          MOVE      OPDAEXPD,SAVEEXPD
.
          PACK      KEY22,CASEKEYS,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            MOVE      "Session Does Not Exist. Please Contact Hospital",WEBTITLE
            CALL      WEBERR00
            GOTO      POSEDT90
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,SP10
          CALL      RSOPDEC1
          CALL      RKOPDEC1
          IF        OVRCD=0
            MATCH     OPDAUNIQ,OPDCUNIQ
            IF        @EQUAL
              MOVE      "Usage exists. Please Contact Hospital",WEBTITLE
              CALL      WEBERR00
              GOTO      POSEDT90
            ENDIF
          ENDIF
.
          READ      CONTROLF,TEN9;*208,CPMIAD
.
          CALL      CASDET00   * Read Current Details
          MOVE      OPDAEXPD,OLDEXPD
          MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PURNO,GSRURNO
          MOVE      OPDAADMN,GSRBILL
          MOVE      THREE,GSRSYS
          CALL      SOUNDEX
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1
.
          CALL      SETMAS00   * Set Masterfile Details
          BRANCH    EXIT,POSEDT90
          CALL      SETDEA00   * Set Operation Details
          BRANCH    EXIT,POSEDT90
.
          PACK      WMURNO,SP70
          PACK      WMCODE,SP70
          MOVE      ZERO,WMCNT
.
          MATCH     SP70,OPDAPROC
          GOTO      POSEDT05 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          IF        OVRCD=1
            CALL      CLWATDET
          ENDIF
.
POSEDT05  MOVE      ZERO,CHGSCHED
          MOVE      SP70,ORIGEDAT
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      BKREEDAT,OLDADATE             * save date for diet info
            CALL      SETBOK00
            CALL      UPBKREC1
.
            CALL      UNUT0000                * Nutrition record update
.
            CALL      WCHB0000           * Data integrity audit
.
            CALL      RDBKRX11
            BRANCH    OVRCD,POSEDT10
            CLOCK     TIME,BKRXLUPT
            PACK      BKRXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",BKRXLUPD
            MOVE      USERID,BKRXWEBU   *  WEB User Id rec. updater
            CALL      SETBOK00
            MOVE      OPDAADMN,BKRXBNUM
            MOVE      OPERDES1,BKRXUFF1
            MOVE      OPERDES2,BKRXUFF2
            MOVE      OPERDES3,BKRXUFF3
            CALL      UPBKRX11
.
            IF        CHGSCHED=1
              MOVE      "016",TADTTYPE
              PROC      OPTHETAT           * write audit if sched. adm changed
            ENDIF
          ENDIF
.
POSEDT10  CALL      UPDMIS00   * Update Admission
          CALL      UNUT0000                * Nutrition record update
.          CALL      UPDVX100   * Update Visit Extension file
          CALL      UPESIS00   * Update ESIS details
.
          MATCH     ADMISNID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      SEVEN,KEY1
            MOVE      ADMISSNO,KEY8
            PROC      UPEADMVS             * Update eAdmssion Details
          ENDIF
.
          MATCH     EREFRLID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      " 7",KEY2              * Added as Booking
            MOVE      ADMISSNO,KEY8
            PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
            PROC      UPEREFVS               * Update eReferral Details
          ENDIF
.
          MATCH     CORSP001,SP70
          IF        !@EQUAL
            MOVE      ONE,F1
            MOVE      ADMISSNO,KEY8
            PROC      UPEADMVS                 * Update eAdmssion Details
          ENDIF
.
.         CALL      OPUPDPMI   * Update Master Details
.
          COMPARE   ZERO,OPCNCPOD
          GOTO      POSEDT50 IF EQUAL
.
          MATCH     Z70,OPERDES1
          IF        !@EQUAL
            MOVE      OPERDES1,OPDADES1
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      POSEDT20 IF NOT EQUAL
.
          MATCH     SP70,OPDADES1
          GOTO      POSEDT20 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV1
          GOTO      POSEDT20 IF EQUAL
.
          PACK      KEY9,OPERPRV1,SP70
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD              * Read MBS code file
          IF        OVRCD<>1
            PACK      OPDADES1,IDESC
          ENDIF
.
POSEDT20  MATCH     Z70,OPERDES2
          IF        !@EQUAL
            MOVE      OPERDES2,OPDADES2
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      POSEDT30 IF NOT EQUAL
.
          MATCH     SP70,OPDADES2
          GOTO      POSEDT30 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV2
          GOTO      POSEDT30 IF EQUAL
.
          PACK      KEY9,OPERPRV2,SP70
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD              * Read MBS code file
          IF        OVRCD<>1
            PACK      OPDADES2,IDESC
          ENDIF
.
POSEDT30  MATCH     Z70,OPERDES3
          IF        !@EQUAL
            MOVE      OPERDES3,OPDADES3
          ENDIF
.
          COMPARE   TWO,OPCNCPOD
          GOTO      POSEDT40 IF NOT EQUAL
.
          MATCH     SP70,OPDADES3
          GOTO      POSEDT40 IF NOT EQUAL
.
          MATCH     SP70,OPERPRV3
          GOTO      POSEDT40 IF EQUAL
.
          PACK      KEY9,OPERPRV3,SP70
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD              * Read MBS code file
          IF        OVRCD<>1
            PACK      OPDADES3,IDESC
          ENDIF
.
POSEDT40  MATCH     Z70,OPERDES4
          IF        !@EQUAL
            MOVE      OPERDES4,OPDADES4
          ENDIF
.
          MATCH     Z70,OPERDES5
          IF        !@EQUAL
            MOVE      OPERDES5,OPDADES5
          ENDIF
.
          MATCH     Z70,OPERDES6
          IF        !@EQUAL
            MOVE      OPERDES6,OPDADES6
          ENDIF
.
POSEDT50  CALL      UPDDEA00   * Update Operation Details
          CALL      UPDDIA00   * Update Diagnosis Defaults
.
          CALL      UPDTIM00   * Update Operation Times
          BRANCH    EXIT,POSEDT99
.
.
          CALL      DELPRF00
          CALL      UPDPRF00   * Update Preference
          CALL      AAUPRF00
.
          CALL      UPCOM000   * Update comments table
          CALL      AUEXDS00   * Write new Extended Procedure Desc
.
          CALL      WEBAUD00   * Update Audit
.
          COMPARE   OPEREXPD,SAVEEXPD
          IF        !@EQUAL
            CALL      CHGDU000
          ENDIF
.
          CALL      UPADM000             * update admission details with booking
          CALL      UNUT0000                * Nutrition record update
.
.
.         We want to update the Post Op Ward/Bed in Visit Extension file also
.         for current admission...
.
          COMPARE   TWO,ASTAT
          GOTO      POSEDT80 IF NOT EQUAL
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,POSEDT80
.
          MATCH     Z70,BOKRX002
          IF        !@EQUAL
.           MATCH     "1",FIRSTBOK
.           IF        @EQUAL
              PACK      PMVXPOWD,BKRXPOWD,SP70
.           ELSE
.             PACK      PMVXPOWD,OPDAPOWD,SP70
.           ENDIF
          ENDIF
.
          MATCH     Z70,BOKRX038
          IF        !@EQUAL
            PACK      PMVXPOBD,BKRXPOBD,SP70
          ENDIF
.
          CALL      UPPMVX11
.
POSEDT80  MOVE      BKREBOOK,ADMISSNO
          PROC      BBUP0000             * Bed Board
          CALL      ADTD0000             * update Transfer Dest. file
.
          IF        PTCNHDPS=1
            CALL      WRPORD00          * write/update ACC Purchase Order number
          ENDIF
.
          MATCH     SP70,ADMISNUM           * Eclipse OEC
          IF        !@EQUAL
.
.           MOVE      BKREBOOK,KEY8
.           CALL      RDPTELG1
.           IF        OVRCD=0
.             MOVE      SP70,PTELCMPL
.             CALL      UPPTELG1
.           ENDIF
.
            PACK      KEY8,ADMISNUM,SP70     * Update pmsvx1af.pmvxpoec
            CALL      RDPMVX11               * OEC Consent
            IF        OVRCD=0
              MATCH     Z70,PTVIS111
              IF        !@EQUAL
                MOVE      PTVIS111,PMVXPILC
              ENDIF
              CALL      UPPMVX11
            ENDIF
.
            MATCH     "1",BOKRX039           * Update patmi1af and patvisaf
            IF        @EQUAL
              CALL      UPMSEC00
            ENDIF
.                                            * Update/Write to patelgaf,pmsoecaf
            CALL      ECLOEC00               * pmsoesaf
.
          ELSE
.
            CALL      FBOOEC00               * FFormat OECW Theatre Booking Only
.
          ENDIF
.
          CALL      UPDMAS00
.
          MOVE      ZERO,EXIT
          GOTO      POSEDT99
.
POSEDT90  MOVE      ONE,EXIT
.
POSEDT99  CLOSE     OPCOMFIL,DELETE
          CLOSE     EXPCMTFI,DELETE
          RETURN
.------------------------------------------------------------
. Update Preference
.------------------------------------------------------------
UPDPRF00  MATCH     Z70,OPERPREF
          GOTO      UPDPRF99 IF EQUAL
          PACK      KEY32,OPDAUNIQ,ONE,SP70
          CALL      RSOPPRF1
          CALL      RKOPPRF1
          BRANCH    OVRCD,UPDPRF50
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      UPDPRF50 IF NOT EQUAL
          MATCH     OPPRPREF,OPERPREF
          GOTO      UPDPRF99 IF EQUAL
          MOVE      OPERPREF,OPPRPREF
          CALL      UPOPPRF1
          GOTO      UPDPRF99
.
UPDPRF50  MOVE      OPDAUNIQ,OPPRUNIQ
          MOVE      ONE,OPPRTEAM
          MOVE      OPERPREF,OPPRPREF
          MOVE      OPERSURG,OPPRDCOD
          MOVE      SP70,OPPRSPAR
          PACK      KEY32,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,SP70
          CALL      RAOPPRF1
          IF        OVRCD=1
            MOVE      ZERO,OPPRPQTY
            CALL      WROPPRF1
          ENDIF
.
UPDPRF99  RETURN
.----------------------------------------------------------------------
. Update the patmi1af file if the patients are pre-admission
.----------------------------------------------------------------------
UPDMIS00  MOVE      OPDAADMN,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPDMIS10
          COMPARE   ONE,ASTAT
          GOTO      UPDMIS99 IF NOT EQUAL   * Not preadmission
.
          MATCH     BKREEDAT,ADATE
          IF        !@EQUAL
            MOVE      BKREEDAT,ADATE
            MOVE      SP70,PTMIDMOV  * clear med rec moved if date changed
          ENDIF
.
          MOVE      BKREATIM,ATIME
          MOVE      ADATE,ALACDTE
.
          CALL      UPMISS1
          CALL      UPDNZP00                * Update NZ Procedure desc.
.
UPDMIS10  PACK      KEY8,OPDAADMN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,UPDMIS99
          MOVE      BKREEDAT,PVIDATE        * update visit date
          CALL      UPVISA1
.
.
.         Broadcast HL7 message (A08) for Pre-Admission Change
.
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          CALL      RDPTRES1                * PRA record on file ?
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          CALL      CLPATTRN                * clear transfer details
          CALL      CLPATDSC                * clear discharge details
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCP                * Broadcast Pre-Admission Change
.
UPDMIS99  RETURN
+
.******************************************************************************
.*  Update NZ Procedure if required                                           *
.******************************************************************************
UPDNZP00  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      UPDNZP99 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,SP1,SP1,ONE,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,UPDNZP99
.
.         BRANCH    ASTAT,UPDNZP99
.
          MATCH     Z70,OPERDES1
          IF        !@EQUAL
            PACK      NZSPPDES,OPERDES1,SP70
            CALL      UPNZSPR1
          ENDIF
.
UPDNZP99   RETURN
+
.------------------------------------------------------------
. Set up Booking Record Details
.------------------------------------------------------------
SETBOK00  CALL      MVBOK000
          CALL      MVBKRX00
.
          MATCH     Z70,PATADMDT
          IF        !@EQUAL
            MATCH     PATADMDT,BKREEDAT
            IF        !@EQUAL
              MOVE      ONE,CHGSCHED
              MOVE      BKREEDAT,ORIGEDAT
              MOVE      SP70,BKREINDC  * clear med rec moved if date changed
            ENDIF
            MOVE      PATADMDT,BKREEDAT    * Expected Admission Date
          ENDIF
.
          MATCH     Z70,PATPAYOR
          IF        !@EQUAL
            UNPACK    PATPAYOR,PATHFUND,PATCLAIM
          ENDIF
.
          MATCH     SP70,URNUMBER
          IF        !@EQUAL
            PACK      BKREURNO,SP70
            PACK      BKREURNO,URNUMBER,SP70
          ENDIF
.
          MATCH     Z70,PATCLAIM
          IF        !@EQUAL
            MATCH     "1",FIRSTBOK
            IF        @EQUAL
              MOVE      PATCLAIM,BKRECLMT    * Claim Code
            ENDIF
          ENDIF
.
          MATCH     PATSNAME,Z70
          IF        !@EQUAL
            MOVE      PATSNAME,BKRESNAM
          ENDIF
.
          MATCH     SP70,WATTRKEY
          IF        !@EQUAL
            MOVE      WMCODE,BKREPROC
            MOVE      WMCNT,BKRECNT
          ENDIF
.
SETBOK99  RETURN
.------------------------------------------------------------
. Setup Details Record
.------------------------------------------------------------
SETDEA00  MOVE      ZERO,EXIT
          COMPARE   "9999",OPEREXPD
          IF        !@EQUAL
            MOVE      OPEREXPD,OPDAEXPD
          ENDIF
.
          MATCH     OPERANAE,Z70
          IF        !@EQUAL
            MOVE      OPERANAE,OPDAANAE
          ENDIF
.
          MATCH     OPERTYPE,Z70
          IF        !@EQUAL
            MOVE      OPERTYPE,OPDATYPE
          ENDIF
.
          MATCH     OPERTRAN,Z70
          IF        !@EQUAL
            MOVE      OPERTRAN,OPDATRAN
          ENDIF
.
          MATCH     OPERUSR1,Z70
          IF        !@EQUAL
            MOVE      OPERUSR1,OPDAUSR1
          ENDIF
.
          MATCH     OPERUSR2,Z70
            IF        !@EQUAL
            MOVE      OPERUSR2,OPDAUSR2
          ENDIF
.
          MATCH     OPERUSR3,Z70
          IF        !@EQUAL
            MOVE      OPERUSR3,OPDAUSR3
          ENDIF
.
          MATCH     OPERUSR4,Z70
          IF        !@EQUAL
            MOVE      OPERUSR4,OPDAUSR4
          ENDIF
.
          MATCH     BOKRX002,Z70
          IF        !@EQUAL
            MOVE      BOKRX002,OPDAPOWD
          ENDIF
.
          MATCH     PATCLAIM,Z70
          IF        !@EQUAL
            MOVE      PATCLAIM,OPDACTYP
          ENDIF
.
          MATCH     BKREC019,Z70
          IF        !@EQUAL
            MOVE      BKREC019,OPDAATYP
          ENDIF
.
          MATCH     OPERPRV1,Z70
          IF        !@EQUAL
            MOVE      OPERPRV1,OPDAPROV
          ENDIF
.
          MATCH     OPERPRV2,Z70
          IF        !@EQUAL
            MOVE      OPERPRV2,OPDAPRV2
          ENDIF
.
          MATCH     OPERPRV3,Z70
          IF        !@EQUAL
            MOVE      OPERPRV3,OPDAPRV3
          ENDIF
.
.         MATCH     OPERDES1,Z70
.         IF        !@EQUAL
.           MOVE      OPERDES1,OPDADES1
.         ENDIF
.
.         MATCH     OPERDES2,Z70
.         IF        !@EQUAL
.           MOVE      OPERDES2,OPDADES2
.         ENDIF
.
.         MATCH     OPERDES3,Z70
.         IF        !@EQUAL
.           MOVE      OPERDES3,OPDADES3
.         ENDIF
.
          MATCH     OPERCOMM,Z70
          IF        !@EQUAL
            MOVE      OPERCOMM,OPDACOMM
          ENDIF
.
          MATCH     OPERKNOW,Z70
          IF        !@EQUAL
            MOVE      OPERKNOW,OPDAKNOW
          ENDIF
.
. HPS Code Starts Here
          MATCH     Z70,OPDEA032
          IF        !@EQUAL
            MOVE       OPDEA032,OPDAEQR1
          ENDIF
.
          MATCH     Z70,OPDEA033
          IF        !@EQUAL
            MOVE       OPDEA033,OPDAEQR2
          ENDIF
.
          MATCH     Z70,OPDEA034
          IF        !@EQUAL
            MOVE       OPDEA034,OPDALEQR
          ENDIF
.
          MATCH     Z70,OPDEA035
          IF        !@EQUAL
            MOVE       OPDEA035,OPDAEQR3
          ENDIF
.
          MATCH     Z70,OPDEA036
          IF        !@EQUAL
            MOVE       OPDEA036,OPDAUNIT
          ENDIF
.
          MATCH     Z70,OPDEA037
          IF        !@EQUAL
            MOVE       OPDEA037,OPDAASRC
          ENDIF
.
          MATCH     Z70,OPDEA038
          IF        !@EQUAL
            CMOVE      OPDEA038,OPDACSST
          ENDIF
.
          MATCH     Z70,OPDEA039
          IF        !@EQUAL
            MATCH     SP70,OPDEA039
            IF        !@EQUAL
              UNPACK    OPDEA039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDACSDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDACSDT
            ELSE
              MOVE      SP8,OPDACSDT
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA040
          IF        !@EQUAL
            MOVE      OPDEA040,OPDAFAST
          ENDIF
.
          MATCH     Z70,OPDEA024
          IF        !@EQUAL
            MOVE       OPDEA024,OPDAPRE5
          ENDIF
.
          MATCH     Z70,OPDEA041
          IF        !@EQUAL
            MOVE      OPDEA041,OPDAAPRC
          ENDIF
.
          MATCH     Z70,OPDEA042
          IF        !@EQUAL
            MOVE      OPDEA042,OPDAMHRC
          ENDIF
.
          COMPARE   TEN2,REPORTNO           * Update theatre booking
          IF        @EQUAL
            MATCH     SP70,OPDATHET
            IF        @EQUAL
              MATCH     "1",THETRQIN
              IF        !@EQUAL
                MOVE      OPSETHET,OPDATHET   * In update bookings function only
              ENDIF
            ENDIF                           * update the theatre if it is blank
          ELSE
            MATCH     "1",THETRQIN
            IF         @EQUAL
              MOVE      THETRQVL,OPDATHET
            ELSE
              MOVE      OPSETHET,OPDATHET
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA047
          IF        !@EQUAL
            MATCH     SP70,OPDEA047
            IF        !@EQUAL
              UNPACK    OPDEA047,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDADTFF,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDADTFF
            ELSE
              MOVE      SP8,OPDADTFF
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA048
          IF        !@EQUAL
            MATCH     SP70,OPDEA048
            IF        !@EQUAL
              UNPACK    OPDEA048,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDADTFL,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDADTFL
            ELSE
              MOVE      SP8,OPDADTFL
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA049
          IF        !@EQUAL
            MOVE      OPDEA049,OPDAPRV4
          ENDIF
.
          MATCH     Z70,OPDEA050
          IF        !@EQUAL
            MOVE      OPDEA050,OPDAPRV5
          ENDIF
.
          MATCH     Z70,OPDEA051
          IF        !@EQUAL
            MOVE      OPDEA051,OPDAPRV6
          ENDIF
.
SETDEA99  RETURN
.------------------------------------------------------------
. Check for Mandatory Fields & Set Masterfile Details
.------------------------------------------------------------
SETMAS00  MATCH     PATTITLE,Z70
          IF        !@EQUAL
            MOVE      PATTITLE,PTITL
          ENDIF
.
          MATCH     PATSNAME,Z70
          IF        !@EQUAL
            MATCH     SP70,PATSNAME
            IF        @EQUAL
              MOVE      "Invalid Update - Surname Required",WEBTITLE
              CALL      WEBERR00
              GOTO      SETMAS90
            ENDIF
            MOVE      PATSNAME,PSNAME
          ENDIF
.
          MATCH     PATGNAME,Z70
          IF        !@EQUAL
            MATCH     SP70,PATGNAME
            IF        @EQUAL
              MOVE      "Invalid Update - Given Name Required",WEBTITLE
              CALL      WEBERR00
              GOTO      SETMAS90
            ENDIF
            MOVE      PATGNAME,PGNAME
          ENDIF
.
          MATCH     PATADDR1,Z70
          IF        !@EQUAL
            MOVE      PATADDR1,PADD1
          ENDIF
.
          MATCH     PATADDR2,Z70
          IF        !@EQUAL
            MOVE      PATADDR2,PADD2
          ENDIF
.
          MATCH     PATADDR3,Z70
          IF        !@EQUAL
            MOVE      PATADDR3,PSUBRB
          ENDIF
.
          MATCH     PATPOSTC,Z70
          IF        !@EQUAL
            MOVE      PATPOSTC,PPOST
          ENDIF
.
          MATCH     PATBUSPH,Z70
          IF        !@EQUAL
            MOVE      PATBUSPH,PTELEB
          ENDIF
.
          MATCH     PATHOMPH,Z70
          IF        !@EQUAL
            MOVE      PATHOMPH,PTELEP
          ENDIF
.
          MATCH     PATGENDE,Z70
          IF        !@EQUAL
            MOVE      PATGENDE,PSEX
          ENDIF
.
          MATCH     PATBIRDT,Z70
          IF        !@EQUAL
            UNPACK    PATBIRDT,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00        * Set CMON from MTHNAM3
            PACK      PBDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PBDATE
          ENDIF
.
          MATCH     PATMSTAT,Z70
          IF        !@EQUAL
            MOVE      PATMSTAT,PMSTAT
          ENDIF
.
          MATCH     PATCOBIR,Z70
          IF        !@EQUAL
            MOVE      PATCOBIR,PCONT
          ENDIF
.
          MATCH     PATRELIG,Z70
          IF        !@EQUAL
            MOVE      PATRELIG,PREG
          ENDIF
.
          MATCH     PATRSTAT,Z70
          IF        !@EQUAL
            MOVE      PATRSTAT,PTYPE
          ENDIF
.
          MATCH     PATOCCUP,Z70
          IF        !@EQUAL
            MOVE      PATOCCUP,POCCUP
          ENDIF
.
          MATCH     PATMEDIC,Z70
          IF        !@EQUAL
            MOVE      PATMEDIC,PMEDI
          ENDIF
.
          MATCH     PATPENSI,Z70
          IF        !@EQUAL
            MOVE      PATPENSI,PPENNO
          ENDIF
.
          MATCH     PATPENEX,Z70
          IF        !@EQUAL
            MOVE      PATPENEX,PPNDTE
          ENDIF
.
          MATCH     Z70,PATPAYOR
          IF        !@EQUAL
            UNPACK    PATPAYOR,PATHFUND,PATCLAIM
          ENDIF
.
          MATCH     PATHFUND,Z70
          IF        !@EQUAL
            MOVE      PATHFUND,PFUNDH
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      SETMAS99
.
SETMAS90  MOVE      ONE,EXIT
SETMAS99  RETURN
.----------------------------------------------------------------------
. Update Operation Details
.----------------------------------------------------------------------
UPDDEA00  CALL      VINN0000                * save deafd records
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          MOVE      TWO,AUDIFLAG        * before change audit
          CALL      AUDEA000            * write record audit
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=0
            CALL      CHKMBS00          * Check if mbs codes been added
          ENDIF
          CALL      DEAI0000            * restore new keyed in values
.
          PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                          OPDACASE,SP70
          MATCH     KEY26,CASEKEYS
          IF        !@EQUAL
            CALL      RAOPDEA1          * key has changed
            IF        OVRCD=1
              PACK      KEY26,CASEKEYS,SP70
              CALL      RAOPDEA1
              BRANCH    OVRCD,UPDDEA99
              PACK      KEY23,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
            ELSE
              GOTO      UPDDEA99
            ENDIF
          ENDIF
.
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1            * update DEAFD
          CALL      DMBS0000            * Delete current existing Extra MBS
          CALL      WMBS0000            * Write extra MBS to oprmbsaf file
.
          MOVE      "002",TADTTYPE
          PROC      OPTHETAT            * write to theatre audit
.
          MOVE      THREE,AUDIFLAG      * after change audit
          CALL      AUDEA000            * write record audit
.
.         Only send update HL7 message if not cancelled
.
          IF        OPDASTAT <> 3
            MOVE      TWO,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14            * send update booking message
          ENDIF
.
          MATCH     SP70,OPDAPROC
          IF        !@EQUAL
            PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
            CALL      RDTREA1
            IF        OVRCD<>1
              CALL      WCHB0000            * Data integrity audit
.
              PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
              CALL      RDWTTX11
              IF        OVRCD=1
                CALL      CLWATTX1
              ENDIF
.
.             Get the PMI details for the HL7 broadcast message
.
              MOVE      OPDAURNO,KEY8
              CALL      RDMAST1
              BRANCH    OVRCD,UPDDEA99
.
              CALL      CLPMSPX2
              MOVE      OPDAURNO,KEY8
              CALL      RDPMPX21
.
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TEN5,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLIUWL            * HL7 - Update Waiting List Entry
            ENDIF
          ENDIF
.
UPDDEA99  RETURN
+
.------------------------------------------------------------
. Update Time
.------------------------------------------------------------
UPDTIM00  COMPARE   OLDEXPD,OPDAEXPD        * check if duration was changed
          GOTO      UPDTIM99 IF EQUAL       * No
.
          PACK      KEY22,CURSESS,SP20
          CALL      RDOPSES1           * get session book time
          BRANCH    OVRCD,UPDTIM91
.
          MOVE      TWO,AUDIFLAG       * before change audit
          CALL      AUSES000           * write audit
          SUB       OLDEXPD,OPSETIMB   * Subtract the old duration
          ADD       OPDAEXPD,OPSETIMB  * Add new duration to session book time
          CALL      UPOPSES1           * update book time
          MOVE      THREE,AUDIFLAG     * after change audit
          CALL      AUSES000           * write audit
.
          PACK      KEY19,CURSESS,SP20
          CALL      OPCHKFUL           * check if session is full
          BRANCH    EXIT,UPDTIM10      * exit=1 session is not full
.
          CALL      OPSUSPND           * suspend session
          GOTO      UPDTIM90
.
UPDTIM10  CALL      OPUNSPND           * unsuspend session
          DISPLAY   *P37:6,SP10;
.
UPDTIM90  MOVE      OPDACASE,CASEFROM
          MOVE      CASEFROM,CASETO
          MOVE      CASEKEYS,KEY22
          CALL      OPMVSBOK
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          GOTO      UPDTIM99
.
UPDTIM91  MOVE      "Session Record Does not Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTIM99
.
UPDTIM99  RETURN
+
.------------------------------------------------------------
. Delete existing extra MBS in oprmbsaf file
.------------------------------------------------------------
DMBS0000  PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
          CALL      RKOPMBS1
          BRANCH    OVRCD,DMBS9999
.
          MATCH     OPMBUNIQ,OPDAUNIQ
          GOTO      DMBS9999 IF NOT EQUAL
.
          PACK      KEY13,OPMBUNIQ,OPMBCNTR,SP70
          CALL      DEOPMBS1              * Delete old Patient MBS
          GOTO      DMBS0000
.
DMBS9999  RETURN
+
.------------------------------------------------------------
. Write extra MBS to oprmbsaf file
.------------------------------------------------------------
WMBS0000  MOVE      ZERO,F2
          MOVE      ZERO,FORM3
WMBS1000  ADD       ONE,F2
          COMPARE   "28",F2
          GOTO      WMBS9999 IF NOT LESS
.
          LOAD      KEY9,F2,OPERPRV4,OPERPRV5:
                            OPERPRV6,OPERPRV7,OPERPRV8,OPERPRV9,OPERPR10:
                            OPERPR11,OPERPR12,OPERPR13,OPERPR14,OPERPR15:
                            OPERPR16,OPERPR17,OPERPR18,OPERPR19,OPERPR20:
                            OPERPR21,OPERPR22,OPERPR23,OPERPR24,OPERPR25:
                            OPERPR26,OPERPR27,OPERPR28,OPERPR29,OPERPR30

          MATCH     SP70,KEY9
          GOTO      WMBS1000 IF EQUAL
          MATCH     Z70,KEY9
          GOTO      WMBS1000 IF EQUAL
.
          ADD       ONE,FORM3
          MOVE      OPDAUNIQ,OPMBUNIQ
          MOVE      FORM3,OPMBCNTR
          PACK      KEY13,OPMBUNIQ,OPMBCNTR,SP70
          CALL      RAOPMBS1
          IF        OVRCD=1
            MOVE      KEY9,OPMBMBSI
            MOVE      WBSEUID,OPMBCUID
            CALL      IBACLOCK
            PACK      OPMBCDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPMBCDAT
            CLOCK     TIME,OPMBCTIM
            PACK      OPMBSPAR,SP70,SP70
            CALL      WROPMBS1
          ENDIF
          GOTO      WMBS1000
.
WMBS9999  RETURN
+
.------------------------------------------------------------
. Check if MBS codes had been added
.------------------------------------------------------------
CHKMBS00  PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKMBS99
.
.         Check if any MBS item been billed
.
          MOVE      OPDAADMN,PMMIVISN
          PACK      KEY14,PMMIVISN,SP20
          CALL      RSPMMTI1
CHKMBS10  CALL      RKPMMTI1
          BRANCH    OVRCD,CHKMBS50          * no (more) details for admission
.
          MATCH     PMMIVISN,OPDAADMN       * get admission number as form
          GOTO      CHKMBS50 IF NOT EQUAL
.
          MATCH     PMMIUNIQ,OPDAUNIQ
          GOTO      CHKMBS10 IF NOT EQUAL   * different admission
          GOTO      CHKMBS99
.
CHKMBS50
.         CALL      CHGMBS00                * Update MBS Code
.
CHKMBS99  RETURN
+
.------------------------------------------------------------
. Change MBS codes, update oprpmbaf file
.------------------------------------------------------------
CHGMBS00  MOVE      ONE,OPPMTMNO
          PACK      KEY14,OPDAUNIQ,OPPMTMNO,SP70
          CALL      RSOPPMB1
          CALL      RKOPPMB1
          BRANCH    OVRCD,CHGMBS20
.
          MATCH     OPDAUNIQ,OPPMUNID
          GOTO      CHGMBS20 IF NOT EQUAL
.
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR,SP70
          CALL      DEOPPMB1              * Delete old Patient MBS
          GOTO      CHGMBS00
.
CHGMBS20  MOVE      ZERO,F3
CHGMBS30  ADD       ONE,F3
          COMPARE   "31",F3
          GOTO      CHGMBS99 IF NOT LESS
.
          LOAD      KEY9,F3,OPERPRV1,OPERPRV2,OPERPRV3,OPERPRV4,OPERPRV5:
                            OPERPRV6,OPERPRV7,OPERPRV8,OPERPRV9,OPERPR10:
                            OPERPR11,OPERPR12,OPERPR13,OPERPR14,OPERPR15:
                            OPERPR16,OPERPR17,OPERPR18,OPERPR19,OPERPR20:
                            OPERPR21,OPERPR22,OPERPR23,OPERPR24,OPERPR25:
                            OPERPR26,OPERPR27,OPERPR28,OPERPR29,OPERPR30

          MATCH     Z70,KEY9
          GOTO      CHGMBS30 IF EQUAL
          MATCH     SP70,KEY9
          GOTO      CHGMBS30 IF EQUAL
.
          MOVE      F3,OPPMCNTR
          MOVE      ONE,OPPMTMNO
          MOVE      ONE,F4
          MOVE      F4,OPPMSERV           * Quantity
          MOVE      KEY9,OPPMCMBS
          MOVE      OPDAUNIQ,OPPMUNID
          MOVE      ZERO,OPPMGSTA
          MOVE      SP70,OPPMGSTC
          PACK      OPPMSPAR,SP70
.
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR
          CALL      WROPPMB1
          GOTO      CHGMBS30
.
CHGMBS99  RETURN
+
.------------------------------------------------------------
. Session List by Anaestestist
.------------------------------------------------------------
ANALST00  MATCH     "1",DEFTVIEW
          IF        @EQUAL
            MATCH     SP70,DOCTCODE
            IF        @EQUAL
              PACK      DOCTCODE,WBSEDOC
            ENDIF
          ENDIF
.
          MOVE      DOCTCODE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            CALL      CLRDOC00
          ENDIF
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Anaesthetists Theatre Summary",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ANALST99
.
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      ANALST99
.
ANALST95  MOVE      "Invalid Anaesthetist Doctor Code",WEBTITLE
          CALL      WEBERR00
.
ANALST99  RETURN
.------------------------------------------------------------
. Patient Admission by Date
.------------------------------------------------------------
ALST0000  BRANCH    FLDITMNO,ALST0100,ALST0200,ALST0300,ALST0400:
                             ALST0500,ALST0600,ALST0700,ALST0800:
                             ALST0900,ALST1000,ALST1100,ALST1200:
                             ALST1300,ALST1400,ALST1500,ALST1600:
                             ALST1700
.
ALST0100  CALL      NEXT0000
          GOTO      ALST9999
.
ALST0200  CALL      PREV0000
          GOTO      ALST9999
.
ALST0300  CALL      CURSTD00
          GOTO      ALST9999
.
ALST0400  CALL      CUREND00
          GOTO      ALST9999
.
ALST0500  CALL      CURYR000
          GOTO      ALST9999
.
ALST0600  CALL      CURMON00
          GOTO      ALST9999
.
ALST0700  CALL      SELV0000
          GOTO      ALST9999
.
ALST0800  CALL      ANATAB00
          GOTO      ALST9999
.
ALST0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      ALST9999
.
ALST1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      ALST9999
.
ALST1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ALST9999
.
ALST1200  CALL      DOCSEL00
          GOTO      ALST9999
.
ALST1300  MOVE      "ST",CATEGORY
          MOVE      DOCTTYPE,CODE
          CALL      CODSEL00
          GOTO      ALST9999
.
ALST1400  CALL      UNTSEL00
          GOTO      ALST9999
.
ALST1500  MOVE      "DT",CATEGORY
          BRANCH    SHOWFLAG,ALST1550
.
          CALL      DEFA0000
.
ALST1550  MOVE      DOCTORTP,CODE
          CALL      CODSEL00
          GOTO      ALST9999
.
ALST1600  CALL      DOCTSL00
          GOTO      ALST9999
.
ALST1700  CALL      CASL0000
          GOTO      ALST9999
.
ALST9999  RETURN
.------------------------------------------------------------------------
. Other Theatre details
.------------------------------------------------------------------------
TDET0000  BRANCH    FLDITMNO,TDET0100,TDET0200,TDET0300,TDET0400,TDET0500:
                             TDET0600,TDET0700,TDET0800,TDET0900,TDET1000:
                             TDET1100,TDET1200,TDET1300,TDET1400,TDET1500:
                             TDET1600,TDET1700,TDET1800,TDET1900,TDET2000:
                             TDET2100,TDET2200,TDET2300,TDET2400,TDET2500:
                             TDET2600,TDET2700,TDET2800,TDET2900,TDET3000:
                             TDET3100,TDET3200,TDET3300,TDET3400,TDET3500:
                             TDET3600,TDET3700,TDET3800,TDET3900,TDET4000:
                             TDET4100,TDET4200,TDET4300,TDET4400,TDET4500:
                             TDET4600,TDET4700,TDET4800,TDET4900,TDET5000:
                             TDET5100,TDET5200,TDET5300,TDET5400,TDET5500
.
TDET0100  CALL      PATSTS00                     * Patient Status
          WRITE     HTMLFILE;CURSTATS
          GOTO      TDET9999
.
TDET0200  WRITE     HTMLFILE;OPCNMIND;           * Minutes Delayed (Arrival)
          GOTO      TDET9999
.
TDET0300  COMPARE   THREE,OPDASTAT
          IF        !@EQUAL
            MOVE      Z70,OPDACANC
          ENDIF
.
          MOVE      "SC",CATEGORY                * Cancellation Reason
          MOVE      OPDACANC,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0400  PACK      KEY35,OPDAUNIQ,ONE,SP1,ZERO,Z70
          CALL      RSOPTSM1
          CALL      RPOPTSM1
          IF        OVRCD=1
            MOVE      SP70,OPTSSCDE
          ENDIF
          MATCH     OPDAUNIQ,OPTSUNID
          IF        !@EQUAL
            MOVE      SP70,OPTSSCDE
          ENDIF
          MOVE      OPTSSCDE,DOCTCODE
          CALL      DOCDET00
          GOTO      TDET9999
.
TDET0500  CALL      OSEL0000
          GOTO      TDET9999
.
TDET0600  MOVE      "KB",CATEGORY
          MOVE      PMVXUVTH,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET0700  WRITE     HTMLFILE;JREGFORM;
          GOTO      TDET9999
.
TDET0800  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OPRA0000
          GOTO      TDET9999
.
TDET0900  MATCH     "1",OPSGUY05
          IF       @EQUAL
            WRITE     HTMLFILE;"Abandoned";
          ENDIF
          GOTO      TDET9999
.
TDET1000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      MISF0000
          GOTO      TDET9999
.
TDET1100  WRITE     HTMLFILE;SVMPFLAG;
          GOTO      TDET9999
.
. Return Specified Type and Line of Comments
. Condition Free Text Field in Theatre Map
.  Type 013   - Theatre Map Fields
.  Line 1     - Location
.  Line 2-9   - Free text fields 1 - 8
.
TDET1200  UNPACK    DIM127,D1,OPDDTYPE,D1,OPDDLINE,DIM127
          MOVE      OPDDLINE,F3
          MOVE      F3,OPDDLINE
          PACK      KEY16,OPDAUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      RDOPDED1
          IF        OVRCD=0
            STRIP     OPDDDATA
            WRITE     HTMLFILE;OPDDDATA;
          ENDIF
          GOTO      TDET9999
.
. Magnetic Buttons on Theatre Conditional  (Arrival/Departure Yes/No User Defined)
.
TDET1300  PACK      MAGNETSS,OPARUY01,OPARUY02,OPARUY03,OPARUY04,OPARUY05:
                             OPARUY06,OPARUY07,OPARUY08,OPARUY09,OPARUY10
          WRITE     HTMLFILE;MAGNETSS;
          GOTO      TDET9999
.
TDET1400  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "13",ATTYPIND      * Attr Type 13 ('Hearing Aids')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          LJUSTIFY  ATCODVAL
.          WRITE     HTMLFILE;ATCODVAL;
.
          MOVE      "1D",CATEGORY      
          MOVE      ATCODVAL,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET1500  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "12",ATTYPIND      * Attr Type 12 ('Implants Instu')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          LJUSTIFY  ATCODVAL
.          WRITE     HTMLFILE;ATCODVAL;
.
          MOVE      "1c",CATEGORY       
          MOVE      ATCODVAL,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET1600  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "11",ATTYPIND      * Attr Type 11 ('Patient Pregnant')
          MOVE      "1",ATVALIND       * Attribute Value Field 1
          CALL      GETAVV00           * Get Attribute Value Field value
          WRITE     HTMLFILE;ATVALVAL;
          GOTO      TDET9999
.
TDET1700  CALL      VISITM00
          GOTO      TDET9999
.
TDET1800  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "6",ATTYPIND       * Attr Type 6 ('Pressure Injury Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          LJUSTIFY  ATCODVAL
.          WRITE     HTMLFILE;ATCODVAL;
.
          MOVE      "1a",CATEGORY
          MOVE      ATCODVAL,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET1900  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "5",ATTYPIND       * Attr Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          LJUSTIFY  ATCODVAL
.          WRITE     HTMLFILE;ATCODVAL;
.
          MOVE      "1A",CATEGORY
          MOVE      ATCODVAL,CODE
          CALL      CODITM00
          GOTO      TDET9999
.
TDET2000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OPPI0000
          GOTO      TDET9999
.
TDET2100  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OPPS0000
          GOTO      TDET9999
.
TDET2200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OPPO0000
          GOTO      TDET9999
.
TDET2300  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      OPPR0000
          GOTO      TDET9999
.
TDET2400  MOVE      CASEKEYS,FHRAPPID
          REP       " -",FHRAPPID
          CALL      SETC0000
          CALL      RESAPP00     * Output FHIR Resource for Selected CASEKEYS
          GOTO      TDET9999
.
TDET2500  WRITE     HTMLFILE;SRGEXIST;
          GOTO      TDET9999
.
TDET2600  MOVE      ZERO,F1
          PACK      KEY12,OPDAUNIQ,SP70
          CALL      RSOPCBD1
TDET2610  CALL      RKOPCBD1
          BRANCH    OVRCD,TDET2620
.
          MATCH     OPCBUNIQ,OPDAUNIQ
          GOTO      TDET2620 IF NOT EQUAL
          MATCH     "1",OPCBDELT            * Deleted?
          GOTO      TDET2610 IF EQUAL
.
          MOVE      ONE,F1
TDET2620  WRITE     HTMLFILE;F1;
          GOTO      TDET9999
.
TDET2700  WRITE     HTMLFILE;OPSGDCK1;
          GOTO      TDET9999
.
TDET2800  WRITE     HTMLFILE;OPSGDCK2;
          GOTO      TDET9999
.
TDET2900  PACK      KEY8,OPDAADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
            GOTO      TDET9999
          ENDIF
.
          MATCH     SP70,DDATE
          GOTO      TDET9999 IF EQUAL
          GOTO      TDET9999 IF EOS
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TDET9999
.
TDET3000  PACK      KEY8,OPDAADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
            GOTO      TDET9999
          ENDIF
.
          WRITE     HTMLFILE;DTIME;
          GOTO      TDET9999
.
TDET3100  CALL      WTPACM00
          GOTO      TDET9999
.
TDET3200  WRITE     HTMLFILE;OPDAPRV4;
          GOTO      TDET9999
.
TDET3300  WRITE     HTMLFILE;OPDAPRV5;
          GOTO      TDET9999
.
TDET3400  WRITE     HTMLFILE;OPDAPRV6;
          GOTO      TDET9999
.
TDET3500  WRITE     HTMLFILE;SHOWVIEW;
          GOTO      TDET9999
.
TDET3600  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      TDET9999
.
TDET3700  MOVE      ONE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      TDET9999
.
TDET3800  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      TDET9999
.
TDET3900  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      TDET9999
.
TDET4000  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      TDET9999
.
TDET4100  MOVE      TWO,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      TDET9999
.
TDET4200  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      TDET9999
.
TDET4300  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      TDET9999
.
TDET4400  MOVE      THREE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      TDET9999
.
TDET4500  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      TDET9999
.
TDET4600  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      TDET9999
.
TDET4700  MOVE      FOUR,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      TDET9999
.
TDET4800  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCNTR;
          GOTO      TDET9999
.
TDET4900  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQATIM;
          GOTO      TDET9999
.
TDET5000  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQRTIM;
          GOTO      TDET9999
.
TDET5100  MOVE      FIVE,F1
          CALL      TOUR0000
          WRITE     HTMLFILE;OPTQCOMM;
          GOTO      TDET9999
.
TDET5200  CALL      STAF0000
          GOTO      TDET9999
.
TDET5300  WRITE     HTMLFILE;SUPERLEV;
          GOTO      TDET9999
.
TDET5400  WRITE     HTMLFILE;SUPRLEVL;
          GOTO      TDET9999
.
TDET5500  MOVE      CASEKEYS,FHRAPPID
          REP       " -",FHRAPPID
          CALL      SETC0000
.
          MOVE      CASEKEYS,FHRAPPID
          REP       " -",FHRAPPID
          ADD       ONE,DISNUMB
          WRITE     HTMLFILE;*+," {":
                                " #"fullUrl#": #"%BASEURL/Appointment/THE-",FHRAPPID,"#",":
                                  " #"resource#": ";
.
          CALL      RESAPP00     * Output FHIR Resource for Selected CASEKEYS
.
          WRITE     HTMLFILE;*+,"}";
.
.
          IF        FHRSUBIN=1
.
            PACK      FHRPATID,URNUMBER
            SQUEEZE   FHRPATID
.
            WRITE     HTMLFILE;*+,",{":
                                  " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
.  
            CALL      RESPAT00
.
            WRITE     HTMLFILE;*+,"}"
          ENDIF
.
          IF        FHRPARIN=1
.
            PACK      SURGNAME,SURGNAME,SP70
            MATCH     SP70,SURGNAME
            IF        !@EQUAL
              STRIP     SURGNAME
.
              MATCH     SP70,OPDACLIN
              GOTO      TDET5550 IF EQUAL
              GOTO      TDET5550 IF EOS
.
              PACK      KEY6,OPDACLIN,SP70
              CALL      RDDOCT1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Practitioner/HCP-",OPDACLIN,"#",":
                                        " #"resource#": ";
.
                CALL      RESPRA00
.
                WRITE     HTMLFILE;*+,"}"
.
              ELSE
.
                PACK      KEY6,OPDACLIN,SP70
                CALL      RDOPCLI1
                BRANCH    OVRCD,TDET5550
.
                PACK      KEY6,OPCLDOCT,SP70
                CALL      RDDOCT1
                IF        OVRCD=0
.
                  WRITE     HTMLFILE;*+,",{":
                                        " #"fullUrl#": #"%BASEURL/Practitioner/HCP-",OPDACLIN,"#",":
                                          " #"resource#": ";
.
                  CALL      RESPRA00
.
                  WRITE     HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
TDET5550    PACK      ANAENAME,ANAENAME,SP70
            MATCH     SP70,ANAENAME
            IF        !@EQUAL
              STRIP     ANAENAME
.
              MATCH     SP70,OPSEANAE
              GOTO      TDET5560 IF EQUAL
              GOTO      TDET5560 IF EOS
.
              PACK      KEY6,OPSEANAE,SP7
              CALL      RDDOCT1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Practitioner/HCP-",OPSEANAE,"#",":
                                        " #"resource#": ";
.
                CALL      RESPRA00
.
                WRITE     HTMLFILE;*+,"}"
.
              ENDIF
. 
            ENDIF
.
          ENDIF
.
TDET5560  IF        FHRLOCIN=1
.
            MATCH     SP70,OPDATHET
            IF        !@EQUAL
              PACK      KEY6,OPDATHET,SP70
              CALL      RDOPOPR1
              IF        OVRCD=0
.
                PACK      FHRLOCC,OPDATHET
                SQUEEZE   FHRLOCC
.
                WRITE     HTMLFILE;*+,",{":
                                      " #"fullUrl#": #"%BASEURL/Location/Theatre-",FHRLOCC,"#",":
                                        " #"resource#": ";
.
                CALL      RESLOC00
.
                WRITE     HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          GOTO      TDET9999
.
.
TDET9999  RETURN
+
.------------------------------------------------------------
. Table of staff members
.------------------------------------------------------------
STAF0000  MATCH     "0",TEAMNUMB
          IF        @EQUAL
            MOVE      "1",TEAMNUMB
          ENDIF
.
          PACK      KEY35,OPDAUNIQ,TEAMNUMB,SP70
          CALL      RSOPTSM1
STAF0100  CALL      RKOPTSM1
          BRANCH    OVRCD,STAF9999
.
          MATCH     OPTSUNID,OPDAUNIQ
          GOTO      STAF9999 IF NOT EQUAL
          MATCH     OPTSTMNO,TEAMNUMB
          GOTO      STAF9999 IF NOT EQUAL
.
          MOVE      SP70,STAFFNAM
          MOVE      SP70,OPPTDESC
          IF        OPTSSIND=0
            MOVE      OPTDESC0,OPPTDESC
            GOTO      STAF0150
           ENDIF
          IF        OPTSSIND=1
            MOVE      OPTDESC1,OPPTDESC
            GOTO      STAF0150
           ENDIF
          IF        OPTSSIND=2
            MOVE      OPTDESC2,OPPTDESC
            GOTO      STAF0150
          ENDIF
          IF        OPTSSIND=3
            MOVE      OPTDESC3,OPPTDESC
            GOTO      STAF0150
          ENDIF
.
STAF0150  IF        OPTSSIND=0 | OPTSSIND=1
            GOTO      STAF0151
          ENDIF
          IF        OPTSSIND=2
            GOTO      STAF0152
          ENDIF
          IF        OPTSSIND=3
            GOTO      STAF0155
          ENDIF
          GOTO      STAF0200
.
.         Staff Type: Operating Surgeon(0)/Doctor(1)
STAF0151  PACK      KEY6,OPTSSCDE,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,STAF0200
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,STAFFNAM
          STRIP     STAFFNAM
          GOTO      STAF0200
.
.         Staff Type: Nurse
STAF0152  MATCH     "1",OPCNURSE                 * Use pmshcpaf for OT Nurse?
          GOTO      STAF0153 IF EQUAL            * Yes
.
.         CONTROLF.OPCNURSE = 0 - Use oprnuraf for OT Nurse
          PACK      KEY6,OPTSSCDE,SP70
          CALL      RDOPNUR1
          BRANCH    OVRCD,STAF0200
          STRIP     OPNRGNAM
          STRIP     OPNRSNAM
          CLEAR     STAFFNAM
          APPEND    OPNRGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    OPNRSNAM,STAFFNAM
          RESET     STAFFNAM
          GOTO      STAF0200
.
.         CONTROLF.OPCNURSE = 1 - Use pmshcpaf for OT Nurse
STAF0153  PACK      KEY10,OPTSSCDE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,STAF0200
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          CLEAR     STAFFNAM
          APPEND    PMHCGNAM,STAFFNAM
          APPEND    SP1,STAFFNAM
          APPEND    PMHCSNAM,STAFFNAM
          RESET     STAFFNAM
          GOTO      STAF0200
.
.         Staff Type: Other
STAF0155  PACK      KEY10,OPTSSCDE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,STAF0200
          MOVE      PMHCSNAM,FMTSNAME
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCTITL,FMTTITLE
          CALL      DOCNM000
          MOVE      DOCFNAME,STAFFNAM
          STRIP     STAFFNAM
          GOTO      STAF0200
.
STAF0200  MOVE      SP70,DIM19
          MATCH     SP70,OPTSSTYP
          GOTO      STAF2500 IF EQUAL
.
          IF        OPTSSIND=0 | OPTSSIND=1
            MOVE      "OP",CATEGORY
            GOTO      STAF2400
          ENDIF
          IF        OPTSSIND=2
            MOVE      "ON",CATEGORY
            GOTO      STAF2400
          ENDIF
          IF        OPTSSIND=3
            MOVE      "OF",CATEGORY
            GOTO      STAF2400
          ENDIF
          GOTO      STAF2500
.
STAF2400  MOVE      OPTSSTYP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MOVE      TDESC,DIM19
          ENDIF
.
STAF2500  WRITE     HTMLFILE;"<tr>":
                             "<td class=DataLabel width=10%>Staff</td>":
                             "<td class=DataField>",DIM19,"</td>":
                             "<td class=DataLabel width=10%>Name</td>":
                             "<td class=DataField>",STAFFNAM,"</td>":
.......                      "<td class=DataField>",OPPTDESC,"</td>":
                             "<td class=DataLabel width=10%>Start Time</td>":
                             "<td class=DataField>",OPTSSTIM,"</td>":
                             "<td class=DataLabel width=10%>End Time</td>":
                             "<td class=DataField>",OPTSETIM,"</td>":
                             "<tr>"

          GOTO      STAF0100
.
STAF9999  RETURN
+
.------------------------------------------------------------
. Operating Room/Theatre Code Selection
.------------------------------------------------------------
OSEL0000  PACK      KEY6,SP70
          CALL      RSOPOPR1
OSEL0100  CALL      RKOPOPR1
          BRANCH    OVRCD,OSEL9999
.
          COMPARE   ONE,OPRMSTAT            * Is theatre inactive?
          GOTO      OSEL0100 IF EQUAL       * Yes, do not display
.
          MOVE      OPRMDESC,KEY35
          PACK      KEY8,QUOTE,OPRMROOM,QUOTE
          MATCH     OPDATHET,OPRMROOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               KEY35,"</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,OPRMHOSP
              IF        !@EQUAL
                MATCH     OPSEHOSP,OPRMHOSP
                GOTO      OSEL0100 IF NOT EQUAL
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY8,">",KEY35,"</option>"
          ENDIF
          GOTO      OSEL0100
.
OSEL9999  RETURN
.-----------------------------------------------------------
. Next Day, Week, Month
.-----------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",DOCTCODE
          REP       " +",DOCTTYPE
          REP       " +",DOCTORTP
          REP       " +",FILTSETY
          REP       " +",FILTLOCN
          WRITE     HTMLFILE;"oprweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&docttype=",DOCTTYPE:
                             "&doctcode=",DOCTCODE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&doctortp=",DOCTORTP:
                             "&showflag=",SHOWFLAG:
                             "&filtsety=",FILTSETY:
                             "&filtlocn=",FILTLOCN:
                             "&dispwkno=",DISPWKNO;
          REP       "+ ",DOCTCODE
          REP       "+ ",DOCTTYPE
          REP       "+ ",DOCTORTP
          REP       "+ ",FILTSETY
          REP       "+ ",FILTLOCN
          RETURN
.-----------------------------------------------------------
. Previous Day, Week, Month
.-----------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",DOCTCODE
          REP       " +",DOCTTYPE
          REP       " +",DOCTORTP
          REP       " +",FILTLOCN
          REP       " +",FILTSETY
          WRITE     HTMLFILE;"oprweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&docttype=",DOCTTYPE:
                             "&doctcode=",DOCTCODE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&doctortp=",DOCTORTP:
                             "&showflag=",SHOWFLAG:
                             "&filtsety=",FILTSETY:
                             "&filtlocn=",FILTLOCN:
                             "&dispwkno=",DISPWKNO;
          REP       "+ ",DOCTCODE
          REP       "+ ",DOCTTYPE
          REP       "+ ",DOCTORTP
          REP       "+ ",FILTLOCN
          REP       "+ ",FILTSETY
          RETURN
.------------------------------------------------------------
. Output Session List Table
.------------------------------------------------------------
ANATAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,F3
          PACK      KEY22,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPSES1
ANATAB10  CALL      RKOPSES1
          BRANCH    OVRCD,ANATAB90
.
          MATCH     WBSEHOSP,OPSEHOSP
          GOTO      ANATAB90 IF NOT EQUAL
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      ANATAB90 IF LESS
.
          MATCH     SP70,DOCTTYPE
          IF        !@EQUAL
            MATCH     DOCTTYPE,OPSETYPE
            GOTO      ANATAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,OPSEANAE
            GOTO      ANATAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      OPSECLIN,KEY6
          COMPARE   ZERO,OPCNCLSU
          IF        @EQUAL
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,KEY6
            ENDIF
          ENDIF
.
          CALL      SESDET00    * Get Display Details for Session
          CALL      ANAROW00    * Display Table Row
          GOTO      ANATAB10    * Read Next
.
ANATAB90
ANATAB99  RETURN
.------------------------------------------------------------
. Output Sessinos List (TABLE ROW)
.------------------------------------------------------------
ANAROW00  CALL      CALBAR00     * Calculate Bar
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          CALL      WKCN0000                * Week cycle number
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPSDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,OPSETIME,SP70
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&sesskeys=",HTMLLINK
          APPEND    OPSEHOSP,HTMLLINK
          APPEND    OPSEDATE,HTMLLINK
          APPEND    OPSETIME,HTMLLINK
          APPEND    OPSECLIN,HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",#"":
                                           OPSEDATE,OPSETIME,"#",#"":
                                           SURFNAME,"#",#"":
                                           ANAFNAME,"#",#"":
                                           KEY80,"#",#"":
                                           STYPDES,"#",#"":
                                           OPSESUSP,"#",#"":
                                           BARWIDTH,"#",#"":
                                           OPSEDURA,"#",#"":
                                           OPSETIMB,"#",#"":
                                           OPSEACTD,"#",#"":         * 10
                                           WEEKCYCL,"#",#"": 
                                           DISPSDAT,WEEKCYCL,"#");"
ANAROW99  RETURN
.
.------------------------------------------------------------
. Case list table
.------------------------------------------------------------
CASTAC00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center>Time</TD>":
                             "<td class=HeadingCell align=center>Duration</TD>":
                             "<td class=HeadingCell>Name</TD>":
                             "<td class=HeadingCell>Operation</TD>":
                             "<td class=HeadingCell>Anaesthetic</td>":
                             "</tr>"
.
          PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,ZERO,Z70
          CALL      RSOPDEA1
          CALL      RPOPDEA1                * prev read on details file
          BRANCH    OVRCD,CASTAC05          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      CASTAC05 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASTAC05 IF EQUAL       * different sessio
.
          MOVE      OPDACASE,LSTCASE
.
CASTAC05  PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,ZERO,SP20
          CALL      RSOPDEA1
CASTAC10  CALL      RKOPDEA1                * next read on details file
          BRANCH    OVRCD,CASTAC90          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      CASTAC90 IF NOT EQUAL   * different sessio
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASTAC90 IF EQUAL   * different sessio
.
          CALL      CASDET00    * Get Display Details for Case
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          REP       " +",CASEKEYS
.
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
          WRITE     HTMLFILE;"<TR >":
                             "<TD ALIGN=CENTER>",OPDAEXPS,"</TD>":
                             "<TD ALIGN=CENTER>",OPDAEXPD," min</TD>":
                             "<td nowrap hieght=30>":
                             "<A HREF=",LINKPRG,".pbl?":
                             "reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",CASEKEYS,">":
                             "<IMG SRC=../images/PatientFolder.gif ":
                             "class=Icon></a>&nbsp;":
                             "  ",FORMATNM,"</TD>":
                             "<TD>",OPDADES1," ",OPDADES2:
                             " ",OPDADES3,"&nbsp;</TD>":
                             "<TD>",TDESC,"</TD></TR>"
          GOTO      CASTAC10
CASTAC90
CASTAC99  RETURN
.------------------------------------------------------------
. Show Booking Details
.------------------------------------------------------------
CASITM00  MATCH     SP70,TEAMNUMB      * Is Team number balnk?
          IF        @EQUAL
            MOVE      "1",TEAMNUMB     * Default to 1. Used by ODET4800 tag.
          ENDIF
.
          MATCH     SP70,INVADMNO
          IF        !@EQUAL
            CALL      OHVIS000
          ENDIF
.
          CALL      CLOPRDEA
          MATCH     SP70,CASEUNIQ
          IF        !@EQUAL
            PACK      KEY10,CASEUNIQ,SP70
            CALL      RDOPDEA3
            IF        OVRCD=1
              MOVE      "Case Does Not Exist. Please Contact Hospital",WEBTITLE
              CALL      WEBERR00
              GOTO      CASITM90
            ELSE
              PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                                 OPDACASE
            ENDIF
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      CASITM85
.
..          PACK      KEY31,ADMISSNO,ZERO,SP70
..          CALL      RSOPDEA2
..          CALL      RKOPDEA2
..          BRANCH    OVRCD,CASITM90
..          MATCH     ADMISSNO,OPDAADMN
..          GOTO      CASITM90 IF NOT EQUAL
..          PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,CASITM90
          ENDIF
.
          MOVE      ZERO,SRGEXIST
          PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
          MATCH     OPDAUNIQ,OPSGUNID
          IF        !@EQUAL
            CALL      CLOPRSRG
          ELSE
            MOVE      ONE,SRGEXIST 
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL    CLBOK000
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL    CLBOK000
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLARD000
          ENDIF                             * Branch  OVRCD omitted as for new
.                                           *  record read will fail
          IF        AAEFLAG=1
            PACK      KEY30,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,ADMISSNO,SP70
            CALL      RDOPAAE1
            IF        OVRCD=1
              CALL      CLAAE000
            ENDIF
          ENDIF
.
.         Read Pre-Operative Checklist Record
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOP000                * Store Pre-Operative Record data
.
.         Read Arrival Record
          PACK      KEY11,OPDAUNIQ,TWO,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOA000                * Store Arrival Record data
.
.         Read Anaesthesia Record
          PACK      KEY11,OPDAUNIQ,THREE,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOI000                * Store Anaesthesia Record data
.
.         Read Incision Record
          PACK      KEY11,OPDAUNIQ,FOUR,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOS000                * Store Incision Record data
.
.         Read OT Sign Out Record
          PACK      KEY11,OPDAUNIQ,FIVE,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOO000                * Store OT Sign Out Record Data
.
.         Read Rec Room Handover Checklist
          PACK      KEY11,OPDAUNIQ,SIX,SP70
          CALL      RDOPPOC1
          IF        OVRCD=1
            CALL      CLOPPO00              * Clear File variables
          ENDIF
          CALL      STPOR000                * Store Rec Room Handover Checklist
.
.         Full Time Out
.
          MOVE      TEMPLATE,F3
          IF        F3=35
            PACK      KEY11,OPDAUNIQ,SEVEN,SP70
            CALL      RDOPPOC1
            IF        OVRCD=1
              CALL      CLOPPO00              * Clear File variables
            ENDIF
            MOVE      OPPOUT01,SVPOP057
            MOVE      OPPOUY01,SVPOP047       * Store Time out List
            MOVE      OPPOUY02,SVPOP048
            MOVE      OPPOUY03,SVPOP049
.
            PACK      KEY11,OPDAUNIQ,EIGHT,SP70
            CALL      RDOPPOC1
            IF        OVRCD=1
              CALL      CLOPPO00              * Clear File variables
            ENDIF
            UNPACK    SP70,OPPOUT01,OPPOUY01,OPPOUY02,OPPOUY03
            MOVE      SVPOP057,OPPOUT01
            MOVE      SVPOP047,OPPOUY01       * Re store Time out List
            MOVE      SVPOP048,OPPOUY02
            MOVE      SVPOP049,OPPOUY03
.
            CALL      STPOP000                * Store Surgeon Consent
            GOTO      CASITM10
          ENDIF
.
          MOVE      TEMPLATE,F3
          COMPARE   ONE,F3
          GOTO      CASITM10 IF EQUAL
          COMPARE   TEN,F3
          GOTO      CASITM10 IF NOT LESS
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASITM94 IF EQUAL
.
          MATCH     "S",SUPRLEVL
          GOTO      CASITM05 IF EQUAL
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,CASITM05
          MATCH     SP70,OPARTIRF
          GOTO      CASITM92 IF NOT EQUAL
.
CASITM05  PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CASITM91
.
          COMPARE   FOUR,ASTAT                   * Allow update of case details
          GOTO      CASITM06 IF EQUAL            * if patient is on leave
.
          COMPARE   THREE,ASTAT                  * Allow update of case details
          GOTO      CASITM06 IF EQUAL            * if patient is discharged
.
          COMPARE   TWO,ASTAT                    * Allow update of case details
          GOTO      CASITM91 IF NOT EQUAL        * if patient is admitted
.
CASITM06  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     OPDADATE,KEY8
          GOTO      CASITM93 IF LESS
.
          IF        ASTAT=3
            PACK      KEY8,OPDAADMN,SP70
            CALL      RDDSCH1
            BRANCH    OVRCD,CASITM96

            MATCH     OPDADATE,DDATE               * Check case date is prior
            GOTO      CASITM95 IF LESS             * to the discharge date
          ENDIF
.
CASITM10  CALL      CASDET00              * Get Case Details
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPDEA3
          IF        OVRCD=1
            CALL      CLARD000
          ENDIF
.
          PACK      SESSKEYS,CASEKEYS,SP70
          PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,CASITM90
.
          CALL      SESDET00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          PACK      KEY13,PRGID,KEY2,KEY3
          CALL      RDWBTP1
          IF        OVRCD=1
            MOVE      SP70,WBTPDES
          ENDIF
.
          CALL      PATNAA00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (",WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CASITM99
.
          CALL      WEBBOD00   * Templated Case Details
          CALL      WEBEND00
          GOTO      CASITM99
.
CASITM85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM90  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM91  MOVE      "Patient has not been admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM92  MOVE      "Patient in Recovery.Cannot change Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM93  MOVE      "Cannot update for future date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM94  MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Patient has been Transferred",WEBTITLE
          ELSE
            MOVE      "Patient has been Cancelled",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM95  MOVE      "Patient has been discharged prior to case date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM96  MOVE      "Invalid discharge record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASITM99
.
CASITM99  RETURN
.
.------------------------------------------------------------
. Move in Waiting List Details
.------------------------------------------------------------
MVWDET00  MATCH     Z70,WATTR001
          IF        !@EQUAL
            MOVE       WATTR001,WMCODE
          ENDIF
          MATCH     Z70,WATTR002
          IF        !@EQUAL
            SQUEEZE    WATTR002
            MOVE       WATTR002,WMTIME
          ENDIF
          MATCH     Z70,WATTR003
          IF        !@EQUAL
            MOVE       WATTR003,WMDESC
          ENDIF
          MATCH     Z70,WATTR004
          IF        !@EQUAL
            MOVE       WATTR004,WMREASON
          ENDIF
          MATCH     Z70,WATTR005
          IF        !@EQUAL
            SQUEEZE    WATTR005
            MOVE       WATTR005,WMSTAT
          ENDIF
          MATCH     Z70,WATTR006
          IF        !@EQUAL
            MATCH     SP70,WATTR009
            IF        !@EQUAL
              UNPACK    WATTR006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE1,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE1
            ELSE
              MOVE      SP70,WMDATE1
            ENDIF
          ENDIF
          MATCH     Z70,WATTR007
          IF        !@EQUAL
            MATCH     SP70,WATTR007
            IF        !@EQUAL
              UNPACK    WATTR007,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE2,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE2
            ELSE
              MOVE      SP70,WMDATE2
            ENDIF
          ENDIF
          MATCH     Z70,WATTR008
          IF        !@EQUAL
            MATCH     SP70,WATTR008
            IF        !@EQUAL
              UNPACK    WATTR008,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE3,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE3
            ELSE
              MOVE      SP70,WMDATE3
            ENDIF
          ENDIF
          MATCH     Z70,WATTR009
          IF        !@EQUAL
            MATCH     SP70,WATTR009
            IF        !@EQUAL
              UNPACK    WATTR009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE4,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE4
            ELSE
              MOVE      SP70,WMDATE4
            ENDIF
          ENDIF
          MATCH     Z70,WATTR010
          IF        !@EQUAL
            MOVE      WATTR010,WMREMOVE
          ENDIF
          MATCH     Z70,WATTR011
          IF        !@EQUAL
            MOVE      WATTR011,WMUNIT
          ENDIF
          MATCH     Z70,WATTR012
          IF        !@EQUAL
            MOVE      WATTR012,WMDOCTOR
          ENDIF
          MATCH     Z70,WATTR013
          IF        !@EQUAL
            SQUEEZE   WATTR013
            MOVE      WATTR013,WMSTAY
          ENDIF
          MATCH     Z70,WATTR014
          IF        !@EQUAL
            MOVE      WATTR014,WMPTY
          ENDIF
          MATCH     Z70,WATTR015
          IF        !@EQUAL
            MOVE      WATTR015,WMNOTICE
          ENDIF
          MATCH     Z70,WATTR016
          IF        !@EQUAL
            MOVE      WATTR016,WMPTYPE
          ENDIF
          MATCH     Z70,WATTR017
          IF        !@EQUAL
            MOVE      WATTR017,WMPCAT
          ENDIF
          MATCH     Z70,WATTR018
          IF        !@EQUAL
            MOVE      WATTR018,WMUDEF1
          ENDIF
          MATCH     Z70,WATTR019
          IF        !@EQUAL
            MOVE      WATTR019,WMUDEF2
          ENDIF
          MATCH     Z70,WATTR020
          IF        !@EQUAL
            MOVE      WATTR020,WMUDEF3
          ENDIF
          MATCH     Z70,WATTR021
          IF        !@EQUAL
            MOVE      WATTR021,WMUDEF4
          ENDIF
          MATCH     Z70,WATTR022
          IF        !@EQUAL
            UNPACK    WATTR022,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMREAD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMREAD
          ENDIF
          MATCH     Z70,WATTR023
          IF        !@EQUAL
            UNPACK    WATTR023,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMDEDA,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDEDA
          ENDIF
          MATCH     Z70,WATTR024
          IF        !@EQUAL
            MOVE      WATTR024,WTWMCLSS
          ENDIF
          MATCH     Z70,WATTR025
          IF        !@EQUAL
            UNPACK    WATTR025,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMDTAD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDTAD
          ENDIF
          MATCH     Z70,WATTR026
          IF        !@EQUAL
            MOVE      WATTR026,WTWMACAT
          ENDIF
          MATCH     Z70,WATTR027
          IF        !@EQUAL
            UNPACK    WATTR027,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMGADD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMGADD
          ENDIF
          MATCH     Z70,WATTR028
          IF        !@EQUAL
            UNPACK    WATTR028,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMDABD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMDABD
          ENDIF
          MATCH     Z70,WATTR029
          IF        !@EQUAL
            MOVE      WATTR029,WTWMEATY
          ENDIF
          MATCH     Z70,WATTR030
          IF        !@EQUAL
            MOVE      WATTR030,WTWMADMC
          ENDIF
          MATCH     Z70,WATTR031
          IF        !@EQUAL
            MOVE      WATTR031,WTWMECRA
          ENDIF
          MATCH     Z70,WATTR032
          IF        !@EQUAL
            MOVE      WATTR032,WTWMGPFA
          ENDIF
          MATCH     Z70,WATTR033
          IF        !@EQUAL
            MOVE      WATTR033,WTWMRFGP
          ENDIF
          MATCH     Z70,WATTR034
          IF        !@EQUAL
            MOVE      WATTR034,WTWMGPPC
          ENDIF
          MATCH     Z70,WATTR035
          IF        !@EQUAL
            MOVE      WATTR035,WTWMGPPT
          ENDIF
          MATCH     Z70,WATTR036
          IF        !@EQUAL
            MOVE      WATTR036,WTWMDOFR
          ENDIF
          MATCH     Z70,WATTR037
          IF        !@EQUAL
            MOVE      WATTR037,WTWMOPER
          ENDIF
          MATCH     Z70,WATTR038
          IF        !@EQUAL
            MOVE      WATTR038,WTWMIHSP
          ENDIF
          MATCH     Z70,WATTR039
          IF        !@EQUAL
            MOVE      WATTR039,WTWMVLSF
          ENDIF
          MATCH     Z70,WATTR040
          IF        !@EQUAL
            MOVE      WATTR040,WTWMPRO2
          ENDIF
          MATCH     Z70,WATTR041
          IF        !@EQUAL
            MOVE      WATTR041,WTWMPRO3
          ENDIF
          MATCH     Z70,WATTR042
          IF        !@EQUAL
            UNPACK    WATTR042,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTWMTRPA,CCENT,CYEAR,CMON,CDAY
            REP       " 0",WTWMTRPA
          ENDIF
          MATCH     Z70,WATTR043
          IF        !@EQUAL
            MOVE      WATTR043,WMUDEF5
          ENDIF
          MATCH     Z70,WATTR044
          IF        !@EQUAL
            MOVE      WATTR044,WMUDEF6
          ENDIF
          MATCH     Z70,WATTR045
          IF        !@EQUAL
            MOVE      WATTR045,WMUDEF7
          ENDIF
          MATCH     Z70,WATTR046
          IF        !@EQUAL
            MOVE      WATTR046,WMUDEF8
          ENDIF
          MATCH     Z70,WATTR047
          IF        !@EQUAL
            MOVE      WATTR047,WTWMRANK
          ENDIF
          MATCH     Z70,WATTR048
          IF        !@EQUAL
            MOVE      WATTR048,WTWMSRCR
          ENDIF
.
MVWDET99  RETURN
.------------------------------------------------------------
. Move in Booking Details
.------------------------------------------------------------
MVBOK000  MATCH     Z70,BKREC001
          IF        !@EQUAL
            MOVE       BKREC001,BKRESNAM
          ENDIF
          MATCH     Z70,BKREC002
          IF        !@EQUAL
            MOVE       BKREC002,BKREADOC
          ENDIF
          MATCH     Z70,BKREC003
          IF        !@EQUAL
            MOVE       BKREC003,BKRESDOC
          ENDIF
          MATCH     Z70,BKREC004
          IF        !@EQUAL
            MOVE      BKREEDAT,OLDADATE             * save date for diet info
            MATCH     SP70,BKREC004
            IF        @EQUAL
              MOVE      SP70,BKREEDAT
            ELSE
              UNPACK    BKREC004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREEDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREEDAT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC005
          IF        !@EQUAL
            MOVE       BKREC005,BKREATIM
          ENDIF
          MATCH     Z70,BKREC006
          IF        !@EQUAL
            MATCH     SP70,BKREC006
            IF        @EQUAL
              MOVE      SP70,BKREPDAT
            ELSE
              UNPACK    BKREC006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREPDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREPDAT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC007
          IF        !@EQUAL
            MOVE       BKREC007,BKREPTIM
          ENDIF
          MATCH     Z70,BKREC008
          IF        !@EQUAL
            MOVE       BKREC008,BKRETYPE
          ENDIF
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            MOVE       BKREC009,BKRECANC
          ENDIF
          MATCH     Z70,BKREC010
          IF        !@EQUAL
            MOVE       BKREC010,BKREOMEM
          ENDIF
          MATCH     Z70,BKREC011
          IF        !@EQUAL
            MOVE       BKREC011,BKREPREV
          ENDIF
          MATCH     Z70,BKREC012
          IF        !@EQUAL
            MOVE       BKREC012,BKREACCM
          ENDIF
          MATCH     Z70,BKREC013
          IF        !@EQUAL
            MOVE       BKREC013,BKREPROC
          ENDIF
          MATCH     Z70,BKREC014
          IF        !@EQUAL
            SQUEEZE    BKREC014
            MOVE       BKREC014,BKRECNT
          ENDIF
          MATCH     Z70,BKREC015
          IF        !@EQUAL
            MOVE       BKREC015,BKREWARD
          ENDIF
          MATCH     Z70,BKREC016
          IF        !@EQUAL
            SQUEEZE    BKREC016
            MOVE       BKREC016,BKREADMN
          ENDIF
          MATCH     Z70,BKREC017
          IF        !@EQUAL
            MOVE       BKREC017,BKREPREA
          ENDIF
          MATCH     Z70,BKREC018
          IF        !@EQUAL
            MOVE       BKREC018,BKREEBED
          ENDIF
          MATCH     Z70,BKREC019
          IF        !@EQUAL
.            MATCH      "1",FIRSTBOK
.            IF         @EQUAL
              MOVE       BKREC019,BKRECLSS
.            ENDIF
          ENDIF
          MATCH     Z70,BKREC020
          IF        !@EQUAL
            MOVE       BKREC020,BKREATYP
          ENDIF
          MATCH     Z70,BKREC021
          IF        !@EQUAL
            MOVE       BKREC021,BKREDEPT
          ELSE
            MOVE       OPSETYPE,BKREDEPT
          ENDIF
          MATCH     Z70,BKREC022
          IF        !@EQUAL
            MOVE       BKREC022,BKRETDOC
          ENDIF
          MATCH     Z70,BKREC023
          IF        !@EQUAL
            MOVE       BKREC023,BKRECLMT
          ENDIF
.
          MATCH     Z70,BKREC024
          IF        !@EQUAL
            MOVE       BKREC024,BKRERFGP
          ENDIF
          MATCH     Z70,BKREC025
          IF        !@EQUAL
            MOVE       BKREC025,BKREGPPC
          ENDIF
          MATCH     Z70,BKREC026
          IF        !@EQUAL
            MOVE       BKREC026,BKREGPFA
          ENDIF
          MATCH     Z70,BKREC027
          IF        !@EQUAL
            MOVE       BKREC027,BKRERESI
          ENDIF
          MATCH     Z70,BKREC028
          IF        !@EQUAL
            MOVE       BKREC028,BKREEATY
          ENDIF
          MATCH     Z70,BKREC029
          IF        !@EQUAL
            MOVE       BKREC029,BKREECRA
          ENDIF
          MATCH     Z70,BKREC030
          IF        !@EQUAL
            MOVE       BKREC030,BKREGPPT
          ENDIF
          MATCH     Z70,BKREC031
          IF        !@EQUAL
            MOVE       BKREC031,BKREDOFR
          ENDIF
          MATCH     Z70,BKREC032
          IF        !@EQUAL
            MOVE       BKREC032,BKREOPER
          ENDIF
          MATCH     Z70,BKREC033
          IF        !@EQUAL
            MATCH     SP70,BKREC033
            IF        @EQUAL
              MOVE      ZERO,BKREELOS
            ELSE
              SQUEEZE    BKREC033
              MOVE       BKREC033,BKREELOS
            ENDIF
          ENDIF
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        @EQUAL
              MOVE      SP70,BKREBKDT
            ELSE
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC035
          IF        !@EQUAL
            MOVE       BKREC035,BKDICODE
          ENDIF
          MATCH     Z70,BKREC036
          IF        !@EQUAL
            MOVE       BKREC036,BKDIDES1
          ENDIF
          MATCH     Z70,BKREC037
          IF        !@EQUAL
            MOVE       BKREC037,BKDIDES2
          ENDIF
          MATCH     Z70,BKREC038
          IF        !@EQUAL
            MOVE       BKREC038,BKDICOMM
          ENDIF
          RETURN
.-------------------------------------------------------------
. Clear Doctor Details if Code is invalid
.-------------------------------------------------------------
CLRDOC00  MOVE       "~~~~~~",DOCTCODE
          MOVE       "~~~~~~",DCODE
          MOVE       SP70,DTITL
          MOVE       SP70,DGNAME
          MOVE       "Not Specified",DSNAME
          MOVE       SP70,DRTYPE
          MOVE       SP70,DRNAME
          MOVE       SP70,DSADD1
          MOVE       SP70,DSADD2
          MOVE       SP70,DSADD3
          MOVE       SP70,DSADD4
          MOVE       SP70,DSPOST
          MOVE       SP70,DTELES
          MOVE       SP70,DTELEP
          MOVE       ZERO,DPAGER
          MOVE       SP70,DASSOC1
          MOVE       SP70,DASSOC2
          MOVE       SP70,DPROV
          MOVE       SP70,DTELEH
          MOVE       SP70,DHADD1
          MOVE       SP70,DHADD2
          MOVE       SP70,DHADD3
          MOVE       SP70,DHADD4
          MOVE       SP70,DHPOST
          MOVE       SP70,DAFIRST
          MOVE       SP70,DALAST
          MOVE       ZERO,DAYEARS
          MOVE       SP70,DACCRED
          MOVE       SP70,DRTYPE2
          MOVE       SP70,DRTYPE3
          MOVE       SP70,DRTYPE4
          MOVE       SP70,DRTYPE5
          MOVE       ZERO,PTDONHSN
          MOVE       SP70,DBIRTH
          MOVE       ZERO,DHCSCOD
          MOVE       SP70,DALEVEL
          MOVE       ZERO,DRSTAT
          MOVE       SP70,DASPARE
.
CLRDOC99  RETURN
.-----------------------------------------------------------------------
CASUPD00  MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      CASUPD85
.
...         PACK      KEY31,ADMISSNO,ZERO,SP70
...         CALL      RSOPDEA2
...         CALL      RKOPDEA2
...         BRANCH    OVRCD,CASUPD90
...         MATCH     ADMISSNO,OPDAADMN
...         GOTO      CASUPD90 IF NOT EQUAL
...         PACK      CASEKEYS,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE
...         PACK      KEY23,CASEKEYS,SP70
...         CALL      RDOPDEA1
...         BRANCH    OVRCD,CASUPD90
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,CASUPD90
          ENDIF
.
          CALL      CLARD000
          CALL      CASDET00              * Get Case Details
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CASUPD91
.
          MATCH     "T",UPDTTYPE          * Full Time Out
          GOTO      CASUPD60 IF EQUAL
.
          MATCH     "R",UPDTTYPE          * Unusage Case
          GOTO      CASUPD70 IF EQUAL
.
          MATCH     "S",UPDTTYPE          * Change Case Start Time
          GOTO      CASUPD75 IF EQUAL
.
          MATCH     "M",UPDTTYPE         * Merge booking to admission
          GOTO      CASUPD80 IF EQUAL
.
.          MATCH     "B",UPDTTYPE         * Update Booking Details
.          GOTO      CASUPD83 IF EQUAL
.
          IF        UPDATEDA=1
            CALL      MVDEA000
            PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                            OPDACASE,SP70
            CALL      RAOPDEA1
            IF        OVRCD=0
              CALL      IBACLOCK
              PACK      OPDAUDAT,CCC,CYY,CMM,CDD
              REP       " 0",OPDAUDAT
.
              CLOCK     TIME,OPDAUTIM
              MOVE      WBSEUID,OPDAWEBU
.
              CALL      UPOPDEA1
              MOVE      THREE,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLIS14            * send update booking message
            ENDIF
          ENDIF
.
          IF        UPDATEDB=1
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            IF        OVRCD=0
              CALL      MVOPAR00
              MOVE      USERID,OPARUANA
              CALL      UPOPARD1
              CALL      UPCOM000
            ELSE
              UNPACK    KEY10,OPARUNID
              CALL      MVOPAR00
              MOVE      USERID,OPARUANA
              CALL      WROPARD1
              CALL      UPCOM000
            ENDIF
            MOVE      "012",TADTTYPE
            PROC      OPTHETAT                   * write arrival details audit
.
.            CALL      CHKGAS00
.
          ENDIF
.
          IF        AAEFLAG=1
            IF        UPDATEDE=1
              PACK    KEY30,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,ADMISSNO,SP70
              CALL    RDOPAAE1
              IF        OVRCD=1
                CALL      MVOPRA00
                PACK      OPAADATE,OPDADATE
                PACK      OPAATIME,OPDATIME
                PACK      OPAACLIN,OPDACLIN
                PACK      OPAACASE,OPDACASE
                PACK      OPAAADMN,ADMISSNO
                PACK      OPAAADVE,ZERO
                CALL      WROPAAE1
              ELSE
                CALL      MVOPRA00
                CALL      UPOPAAE1
              ENDIF
            ENDIF
          ENDIF
.
          IF        UPDATEDD=1
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            IF        OVRCD=0
              CALL      MVOPAR00
              MOVE      USERID,OPARUIAR
              CALL      UPOPARD1
            ELSE
              UNPACK    KEY10,OPARUNID
              CALL      MVOPAR00
              MOVE      USERID,OPARUIAR
              CALL      WROPARD1
            ENDIF
.
            PACK      KEY11,OPDAUNIQ,ONE,SP70    * Update Pre-Operative record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOP000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      ONE,OPPORTYP
              CALL      MVPOP000
              CALL      WROPPOC1
            ENDIF
.
            PACK      KEY11,OPDAUNIQ,TWO,SP70    * Update Arrival record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOA000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      TWO,OPPORTYP
              CALL      MVPOA000
              CALL      WROPPOC1
            ENDIF
.
            MATCH     "1",UPDATATR
            IF        @EQUAL
              CALL      CLPATATR
              CALL      MVPATATR
.
              MOVE      HAATR010,ATCODVAL
              MOVE      "13",ATTYPIND
              MOVE      "1",ATCODIND
              MOVE      URNUMBER,PTATR001
              MOVE      ADMISSNO,PTATR002
              MOVE      HAATR010,PTATR010
              CALL      UPDACV00
.
              MOVE      IIATR010,ATCODVAL
              MOVE      "12",ATTYPIND
              MOVE      "1",ATCODIND
              MOVE      URNUMBER,PTATR001
              MOVE      ADMISSNO,PTATR002
              MOVE      IIATR010,PTATR010
              CALL      UPDACV00
.
              MOVE      PPATR006,ATVALVAL
              MOVE      "11",ATTYPIND
              MOVE      "1",ATVALIND
              MOVE      URNUMBER,PTATR001
              MOVE      ADMISSNO,PTATR002
              MOVE      PPATR006,PTATR006
              CALL      UPDAVV00
.
              MOVE      PRATR010,ATCODVAL
              MOVE      "6",ATTYPIND
              MOVE      "1",ATCODIND
              MOVE      URNUMBER,PTATR001
              MOVE      ADMISSNO,PTATR002
              MOVE      PRATR010,PTATR010
              CALL      UPDACV00
.
              MOVE      FRATR010,ATCODVAL
              MOVE      "5",ATTYPIND
              MOVE      "1",ATCODIND
              MOVE      URNUMBER,PTATR001
              MOVE      ADMISSNO,PTATR002
              MOVE      FRATR010,PTATR010
              CALL      UPDACV00
.
              CALL      UPCOM000
.
              PACK      VISCODKY,OPPOUNID,ONE,SP70
              CALL      MVVSCO00                * Save visit based coding
            ENDIF
.
. PRINT Pre Operative Checklist Using Stat Temp 18 - Theatre Form
.
            MATCH     SP70,SCHDPRNT
            GOTO      CASUPD50 IF EQUAL
.
            MATCH     SP70,STATNCOD
            GOTO      CASUPD50 IF EQUAL
.
            MOVE      CASEKEYS,SUBSYSKY
            MOVE      ONE,SCHDCOPY
            MOVE      SP70,LABELTYP
            MOVE      SP70,FREETXT1
            MOVE      SP70,FREETXT2
            MOVE      SP70,FREETXT3
            MOVE      SP70,FREETXT4
            MOVE      SP70,FREETXT5
            MOVE      SP70,FREETXT6
            MOVE      SP70,FREETXT7
            CALL      ADDPRN00
.
          ENDIF
.
          IF        UPDATEDF=1
.           PACK      KEY10,OPDAUNIQ,SP70
.           CALL      RDOPARD1
.           IF        OVRCD=0
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      UPOPARD1
.           ELSE
.             UNPACK    KEY10,OPARUNID
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      WROPARD1
.           ENDIF
.
            PACK      KEY11,OPDAUNIQ,THREE,SP70    * Update Anaesthesia record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOI000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      THREE,OPPORTYP
              CALL      MVPOI000
              CALL      WROPPOC1
            ENDIF
.
          ENDIF
.
          IF        UPDATEDG=1
.           PACK      KEY10,OPDAUNIQ,SP70
.           CALL      RDOPARD1
.           IF        OVRCD=0
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      UPOPARD1
.           ELSE
.             UNPACK    KEY10,OPARUNID
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      WROPARD1
.           ENDIF
.
            PACK      KEY11,OPDAUNIQ,FOUR,SP70    * Update Incision record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOS000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      FOUR,OPPORTYP
              CALL      MVPOS000
              CALL      WROPPOC1
            ENDIF
.
            CALL      UPCOM000
            CALL      UPCMX000
            CALL      UPCMY000
            CALL      UPCMZ000
.
          ENDIF
.
          IF        UPDATEDH=1
.           PACK      KEY10,OPDAUNIQ,SP70
.           CALL      RDOPARD1
.           IF        OVRCD=0
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      UPOPARD1
.           ELSE
.             UNPACK    KEY10,OPARUNID
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      WROPARD1
.           ENDIF
.
            PACK      KEY11,OPDAUNIQ,FIVE,SP70    * Update Incision record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOO000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      FIVE,OPPORTYP
              CALL      MVPOO000
              CALL      WROPPOC1
            ENDIF
.
          ENDIF
.
          IF        UPDATEDI=1
.           PACK      KEY10,OPDAUNIQ,SP70
.           CALL      RDOPARD1
.           IF        OVRCD=0
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      UPOPARD1
.           ELSE
.             UNPACK    KEY10,OPARUNID
.             CALL      MVOPAR00
.             MOVE      USERID,OPARUIAR
.             CALL      WROPARD1
.           ENDIF
.
            PACK      KEY11,OPDAUNIQ,SIX,SP70    * Update Incision record
            CALL      RDOPPOC1
            IF        OVRCD=0
              CALL      MVPOR000
              CALL      UPOPPOC1
            ELSE
              CALL      CLOPPO00
              MOVE      OPDAUNIQ,OPPOUNID
              MOVE      SIX,OPPORTYP
              CALL      MVPOR000
              CALL      WROPPOC1
            ENDIF
.
          ENDIF
.
CASUPD50  MATCH     "U",UPDTTYPE
          IF        @EQUAL
.
            MOVE      SP70,SAVEANUR
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            IF        OVRCD=0
              MOVE      OPARANUR,SAVEANUR
              CALL      MVOPAR00
              MOVE      USERID,OPARUIAR
              CALL      UPOPARD1
            ELSE
              UNPACK    KEY10,OPARUNID
              CALL      MVOPAR00
              MOVE      USERID,OPARUIAR
              CALL      WROPARD1
            ENDIF
.
            MOVE     "011",TADTTYPE            * write arrival details audit
            PROC     OPTHETAT
.
            CALL     WOPTSM00
.
          ENDIF
.
          PROC      PMSCURTH              * Update patient header theatre status
.
CASUPD55  MOVE      ZERO,EXIT
          GOTO      CASUPD99
.
CASUPD60  CALL      FTOU0000              * Full Time Out
          MOVE      ZERO,EXIT
          GOTO      CASUPD99
.
.
.  Un-usage a Theatre Booking
.
CASUPD70  CALL      UNUSG000
.
          MOVE      ZERO,EXIT
          GOTO      CASUPD99
.
.  Update Start time and Duration
.
CASUPD75  CALL      MVDEA000
          PACK      KEY26,CASEKEYS,SP70
          CALL      RAOPDEA1
          IF        OVRCD=0
            CALL      IBACLOCK
            PACK      OPDAUDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPDAUDAT
.
            CLOCK     TIME,OPDAUTIM
            MOVE      WBSEUID,OPDAWEBU
.
            CALL      UPOPDEA1
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14            * send update booking message
          ENDIF
.
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      CASUPD99
.
CASUPD80  CALL      BOKMER00          * Merge booking to admission
          GOTO      CASUPD99
.
.CASUPD83  MOVE      ONE,UVTHINDI
.          MOVE      ADMISSNO,OPDAADMN
.          CALL      UPDVX100          * Update Visit Extension File
.          GOTO      CASUPD99
.
CASUPD85  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASUPD99
.
CASUPD90  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASUPD99
CASUPD91  MOVE      "No Patient Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CASUPD99
.
CASUPD99  CLOSE     OPCOMFIL,DELETE
          CLOSE     XPCOMFIL,DELETE
          CLOSE     YPCOMFIL,DELETE
          CLOSE     ZPCOMFIL,DELETE
.
          RETURN
+
.------------------------------------------------------------
. Full Time Out
.------------------------------------------------------------
FTOU0000  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
            CALL      MVOPAR00               * Update Time Out Called At
            MOVE      USERID,OPARUIAR
            CALL      UPOPARD1
          ELSE
            CALL      CLOPRARD
            UNPACK    KEY10,OPARUNID
            CALL      MVOPAR00               * Update Time Out Called At
            MOVE      USERID,OPARUIAR
            CALL      WROPARD1
          ENDIF
.
.         Update Time Out List 1
.
          PACK      KEY11,OPDAUNIQ,SEVEN,SP70
          CALL      RDOPPOC1
          IF        OVRCD=0
            CALL      TOUT0000              * Populate Time Out List 1
            CALL      UPOPPOC1
          ELSE
            CALL      CLOPPO00
            MOVE      OPDAUNIQ,OPPOUNID
            CALL      TOUT0000              * Populate Time Out List 1
            MOVE      SEVEN,OPPORTYP
            CALL      WROPPOC1
          ENDIF
.
.         Update Surgeon Consent
.
          MOVE      Z70,OPPOP057            * Clear Time Out List variables
          MOVE      Z70,OPPOP047
          MOVE      Z70,OPPOP048
          MOVE      Z70,OPPOP049
.
          PACK      KEY11,OPDAUNIQ,EIGHT,SP70
          CALL      RDOPPOC1
          IF        OVRCD=0
            CALL      MVPOP000
            CALL      UPOPPOC1
          ELSE
            CALL      CLOPPO00
            MOVE      OPDAUNIQ,OPPOUNID
            CALL      MVPOP000
            MOVE      EIGHT,OPPORTYP
            CALL      WROPPOC1
          ENDIF
.
          PROC      PMSCURTH           * Update patient header theatre statu
.
FTOU9999  RETURN
+
.------------------------------------------------------------
. Populate Time Out List 1 variables
.------------------------------------------------------------
TOUT0000  MATCH     OPPOP057,Z70
          IF        !@EQUAL
            MOVE      OPPOP057,OPPOUT01
          ENDIF
.
          MATCH     OPPOP047,Z70
          IF        !@EQUAL
            MOVE      OPPOP047,OPPOUY01
          ENDIF
.
          MATCH     OPPOP048,Z70
          IF        !@EQUAL
            MOVE      OPPOP048,OPPOUY02
          ENDIF
.
          MATCH     OPPOP049,Z70
          IF        !@EQUAL
            MOVE      OPPOP049,OPPOUY03
          ENDIF
.
TOUT9999  RETURN
+
.------------------------------------------------------------
. Un-Usage Patient Theatre Booking
.------------------------------------------------------------
UNUSG000  MOVE      SP5,OPDAPRE1            * blank Pre-operative time 1
          MOVE      SP5,OPDAPRE2            * blank Pre-operative time 2
          MOVE      SP5,OPDAPRE3            * blank Pre-operative time 3
          MOVE      SP5,OPDAPRE4            * blank Pre-operative time 4
          MOVE      SP5,OPDAPRE5            * blank Pre-operative time 5
          MOVE      SP5,OPDAPOS1            * blank Post-operative time 1
          MOVE      SP5,OPDAPOS2            * blank Post-operative time 2
          MOVE      SP5,OPDAPOS3            * blank Post-operative time 3
          MOVE      SP5,OPDAPOS4            * blank Post-operative time 4
          MOVE      SP3,OPDAKNOW            * Known Infection
          MOVE      ZERO,FORM4
          MOVE      OPDATDUR,FORM4
          MOVE      ZERO,OPDATDUR           * theatre duration
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD=0
            SUB       FORM4,OPSEACTD
            CALL      UPOPSES1
          ENDIF
.
          PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                          OPDACASE,SP70
          CALL      RAOPDEA1
          IF        OVRCD=0
            CALL      IBACLOCK
            PACK      OPDAUDAT,CCC,CYY,CMM,CDD
            REP       " 0",OPDAUDAT
.
            CLOCK     TIME,OPDAUTIM
            MOVE      WBSEUID,OPDAWEBU
.
            CALL      UPOPDEA1                * update oprdetaf
            MOVE      FIVE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIS14            * send update booking message
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
            CALL      DEOPARD1     * Delete Operating Arrival & Recovery details
          ENDIF
.
UNUSG100  PACK      KEY11,OPDAUNIQ,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          BRANCH    OVRCD,UNUSG200
.
          MATCH     OPSGUNID,OPDAUNIQ
          GOTO      UNUSG200 IF NOT EQUAL
.
          PACK      KEY11,OPSGUNID,OPSGTMNO,SP70
          CALL      DEOPSRG1        * Delete Operating Surgical details
          GOTO      UNUSG100
.
UNUSG200  PACK      KEY35,OPDAUNIQ,SP70
          CALL      RSOPTSM1
          CALL      RKOPTSM1
          BRANCH    OVRCD,UNUSG300
.
          MATCH     OPTSUNID,OPDAUNIQ
          GOTO      UNUSG300 IF NOT EQUAL
.
          PACK      KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT,OPTSSTIM
          CALL      DEOPTSM1        * Delete Theatre Staff Members
          GOTO      UNUSG200
.
UNUSG300  PACK      KEY14,OPDAUNIQ,SP70
          CALL      RSOPPMB1
          CALL      RKOPPMB1
          BRANCH    OVRCD,UNUSG400
.
          MATCH     OPPMUNID,OPDAUNIQ
          GOTO      UNUSG400 IF NOT EQUAL
.
          PACK      KEY14,OPPMUNID,OPPMTMNO,OPPMCNTR,SP70
          CALL      DEOPPMB1        * Delete Patient MBS
          GOTO      UNUSG300
.
UNUSG400  PACK      KEY11,OPDAADMN,SP70
          CALL      RDSMMBS1
          CALL      RDKMMBS1
          BRANCH    OVRCD,UNUSG500
.
          MATCH     DMMADMN,OPDAADMN
          GOTO      UNUSG500 IF NOT EQUAL
.
          PACK      KEY11,MMADMN,MMRECN,SP70
          CALL      DEMMBS1        * Delete Medical Records MBS
          GOTO      UNUSG400
.
UNUSG500  PACK      KEY16,OPDAUNIQ,SP70
          CALL      RSOPDED1
UNUSG510  CALL      RKOPDED1
          BRANCH    OVRCD,UNUSG900
.
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      UNUSG900 IF NOT EQUAL
.
          MATCH     "009",OPDDTYPE  * except Theatre Booking Comments
          GOTO      UNUSG510 IF EQUAL
.
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1        * Delete Operation Comments
          GOTO      UNUSG510
.
UNUSG900  PROC      PMSCURTH           * Update patient header theatre status
.
UNUSG999  RETURN
+
.------------------------------------------------------------
. Move in Operation Details
.------------------------------------------------------------
MVDEA000  MATCH     Z70,OPDEA001
          IF        !@EQUAL
            MOVE       OPDEA001,OPDAEXPS
          ENDIF
          MATCH     Z70,OPDEA002
          IF        !@EQUAL
            SQUEEZE    OPDEA002
            MOVE       OPDEA002,OPDAEXPD
          ENDIF
          MATCH     Z70,OPDEA003
          iF        !@EQUAL
            MOVE       OPDEA003,OPDAANAE
          ENDIF
          MATCH     Z70,OPDEA004
          IF        !@EQUAL
            MOVE       OPDEA004,OPDATYPE
          ENDIF
          MATCH     Z70,OPDEA005
          IF        !@EQUAL
            MOVE       OPDEA005,OPDATRAN
          ENDIF
          MATCH     Z70,OPDEA006
          IF        !@EQUAL
            MOVE       OPDEA006,OPDAUSR1
          ENDIF
          MATCH     Z70,OPDEA007
          IF        !@EQUAL
            MOVE       OPDEA007,OPDAUSR2
          ENDIF
          MATCH     Z70,OPDEA008
          IF        !@EQUAL
            MOVE       OPDEA008,OPDAUSR3
          ENDIF
          MATCH     Z70,OPDEA009
          IF        !@EQUAL
            MOVE       OPDEA009,OPDAUSR4
          ENDIF
          MATCH     Z70,OPDEA010
          IF        !@EQUAL
            MOVE       OPDEA010,OPDAWAIT
          ENDIF
          MATCH     Z70,OPDEA011
          IF        !@EQUAL
            MOVE       OPDEA011,OPDAPROV
          ENDIF
          MATCH     Z70,OPDEA012
          IF        !@EQUAL
            MOVE       OPDEA012,OPDAPRV2
          ENDIF
          MATCH     Z70,OPDEA013
          IF        !@EQUAL
            MOVE       OPDEA013,OPDAPRV3
          ENDIF
          MATCH     Z70,OPDEA014
          IF        !@EQUAL
            MOVE       OPDEA014,OPDADES1
          ENDIF
          MATCH     Z70,OPDEA015
          IF        !@EQUAL
            MOVE       OPDEA015,OPDADES2
          ENDIF
          MATCH     Z70,OPDEA016
          IF        !@EQUAL
            MOVE       OPDEA016,OPDADES3
          ENDIF
          MATCH     Z70,OPDEA017
          IF        !@EQUAL
            MOVE       OPDEA017,OPDACOMM
          ENDIF
          MATCH     Z70,OPDEA018
          IF        !@EQUAL
            MOVE       OPDEA018,OPDACANC
          ENDIF
          MATCH     Z70,OPDEA019
          IF        !@EQUAL
            MOVE       OPDEA019,OPDATHET
          ENDIF
          MATCH     Z70,OPDEA020
          IF        !@EQUAL
            MOVE       OPDEA020,OPDAPRE1
          ENDIF
          MATCH     Z70,OPDEA021
          IF        !@EQUAL
            MOVE       OPDEA021,OPDAPRE2
          ENDIF
          MATCH     Z70,OPDEA022
          IF        !@EQUAL
            MOVE       OPDEA022,OPDAPRE3
          ENDIF
          MATCH     Z70,OPDEA023
          IF        !@EQUAL
            MOVE       OPDEA023,OPDAPRE4
          ENDIF
          MATCH     Z70,OPDEA024
          IF        !@EQUAL
            MOVE       OPDEA024,OPDAPRE5
          ENDIF
          MATCH     Z70,OPDEA025
          IF        !@EQUAL
            MOVE       OPDEA025,OPDAPOS1
          ENDIF
          MATCH     Z70,OPDEA026
          IF        !@EQUAL
            MOVE       OPDEA026,OPDAPOS2
          ENDIF
          MATCH     Z70,OPDEA027
          IF        !@EQUAL
            MOVE       OPDEA027,OPDAPOS3
          ENDIF
          MATCH     Z70,OPDEA028
          IF        !@EQUAL
            MOVE       OPDEA028,OPDAPOS4
          ENDIF
          MATCH     Z70,OPDEA029
          IF        !@EQUAL
            SQUEEZE    OPDEA029
            MOVE       OPDEA029,OPDATDUR
          ENDIF
          MATCH     Z70,OPDEA030
          IF        !@EQUAL
            MOVE       OPDEA030,OPDAKNOW
          ENDIF
          MATCH     Z70,OPDEA031
          IF        !@EQUAL
            MOVE       OPDEA031,OPDACDAT
          ENDIF
          MATCH     Z70,OPDEA032
          IF        !@EQUAL
            MOVE       OPDEA032,OPDAEQR1
          ENDIF
          MATCH     Z70,OPDEA033
          IF        !@EQUAL
            MOVE       OPDEA033,OPDAEQR2
          ENDIF
          MATCH     Z70,OPDEA034
          IF        !@EQUAL
            MOVE       OPDEA034,OPDALEQR
          ENDIF
          MATCH     Z70,OPDEA035
          IF        !@EQUAL
            MOVE       OPDEA035,OPDAEQR3
          ENDIF
          MATCH     Z70,OPDEA038
          IF        !@EQUAL
            CMOVE     OPDEA038,OPDACSST
          ENDIF
.
          MATCH     Z70,OPDEA039
          IF        !@EQUAL
            MATCH     SP70,OPDEA039
            IF        !@EQUAL
              UNPACK    OPDEA039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      OPDACSDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",OPDACSDT
            ELSE
              MOVE      SP8,OPDACSDT
            ENDIF
          ENDIF
.
          MATCH     Z70,OPDEA040
          IF        !@EQUAL
            MOVE      OPDEA040,OPDAFAST
          ENDIF
.
          MATCH     Z70,OPDEA041
          IF        !@EQUAL
            MOVE      OPDEA041,OPDAAPRC
          ENDIF
.
          MATCH     Z70,OPDEA042
          IF        !@EQUAL
            MOVE      OPDEA042,OPDAMHRC
          ENDIF
.
          MATCH     Z70,OPDEA044
          IF        !@EQUAL
            MOVE      OPDEA044,OPDADES4
          ENDIF
.
          MATCH     Z70,OPDEA045
          IF        !@EQUAL
            MOVE      OPDEA045,OPDADES5
          ENDIF
.
          MATCH     Z70,OPDEA046
          IF        !@EQUAL
            MOVE      OPDEA046,OPDADES6
          ENDIF
.
          MATCH     Z70,OPDEA049
          IF        !@EQUAL
            MOVE      OPDEA049,OPDAPRV4
          ENDIF
.
          MATCH     Z70,OPDEA050
          IF        !@EQUAL
            MOVE      OPDEA050,OPDAPRV5
          ENDIF
.
          MATCH     Z70,OPDEA051
          IF        !@EQUAL
            MOVE      OPDEA051,OPDAPRV6
          ENDIF
.
          RETURN
.
CLARD000  MOVE      SP70,OPARUNID  *  Uniqued id for theatre booking
          MOVE      SP70,OPARATIM  *  Arrival Time (HH:MM:SS)
          MOVE      SP70,OPARANUR  *  Admitting Nurse
          MOVE      SP70,OPARRLAT  *  Reason Patient Late (Category Os)
          MOVE      SP70,OPARPCLC  *  Pre-op Check List Complete
          MOVE      SP70,OPARCSFS  *  Consent Form Signed
          MOVE      SP70,OPARMDRE  *  Medical Records
          MOVE      SP70,OPARXRAY  *  X-Ray
          MOVE      SP70,OPARBLEM  *  Bladder Empty
          MOVE      SP70,OPARMUPJ  *  Make Up & Jewelry Removed
          MOVE      SP70,OPARPMED  *  Pre-medication Given
          MOVE      SP70,OPARALCK  *  Allergies checked
          MOVE      SP70,OPARPROT  *  Prothetesis
          MOVE      SP70,OPARUC01  *  User Defined Code 1  (Category oa)
          MOVE      SP70,OPARUC02  *  User Defined Code 2  (Category oa)
          MOVE      SP70,OPARUC03  *  User Defined Code 3  (Category oa)
          MOVE      SP70,OPARUC04  *  User Defined Code 4  (Category oa)
          MOVE      SP70,OPARUC05  *  User Defined Code 5  (Category oa)
          MOVE      SP70,OPARUC06  *  User Defined Code 6  (Category oa)
          MOVE      SP70,OPARUC07  *  User Defined Code 7  (Category oa)
          MOVE      SP70,OPARUC08  *  User Defined Code 8  (Category oa)
          MOVE      SP70,OPARUC09  *  User Defined Code 9  (Category oa)
          MOVE      SP70,OPARUC10  *  User Defined Code 10 (Category oa)
          MOVE      SP70,OPARUY01  *  User Defined Y/N 1
          MOVE      SP70,OPARUY02  *  User Defined Y/N 2
          MOVE      SP70,OPARUY03  *  User Defined Y/N 3
          MOVE      SP70,OPARUY04  *  User Defined Y/N 4
          MOVE      SP70,OPARUY05  *  User Defined Y/N 5
          MOVE      SP70,OPARUT01  *  User Defined Time Field 1
          MOVE      SP70,OPARUT02  *  User Defined Time Field 2
          MOVE      SP70,OPARUT03  *  User Defined Time Field 3
          MOVE      SP70,OPARUT04  *  User Defined Time Field 4
          MOVE      SP70,OPARUT05  *  User Defined Time Field 5
          MOVE      ZERO,OPARUF01  *  User Defined Form Field 1
          MOVE      ZERO,OPARUF02  *  User Defined Form Field 2
          MOVE      ZERO,OPARUF03  *  User Defined Form Field 3
          MOVE      ZERO,OPARUF04  *  User Defined Form Field 4
          MOVE      ZERO,OPARUF05  *  User Defined Form Field 5
          MOVE      SP70,OPARTCAL  *  Time Called For
          MOVE      SP70,OPARUIAR  *  User ID for Arrival (websecaf)
          MOVE      SP70,OPARANAP  *  Anaesthetic Prep Start (HH:MM:SS)
          MOVE      SP70,OPARANAS  *  Anaesthetic Start (HH:MM:SS)
          MOVE      SP70,OPARANAE  *  Anaesthetic End (HH:MM:SS)
          MOVE      SP70,OPARITYP  *  Type of Intubation (category Ot)
          MOVE      SP70,OPARUC11  *  User Defined Code 11 (Category ok)
          MOVE      SP70,OPARUC12  *  User Defined Code 12 (Category ok)
          MOVE      SP70,OPARUC13  *  User Defined Code 13 (Category ok)
          MOVE      SP70,OPARUC14  *  User Defined Code 14 (Category ok)
          MOVE      SP70,OPARUC15  *  User Defined Code 15 (Category ok)
          MOVE      SP70,OPARUC16  *  User Defined Code 16 (Category ok)
          MOVE      SP70,OPARUC17  *  User Defined Code 17 (Category ok)
          MOVE      SP70,OPARUC18  *  User Defined Code 18 (Category ok)
          MOVE      SP70,OPARUC19  *  User Defined Code 19 (Category ok)
          MOVE      SP70,OPARUC20  *  User Defined Code 20 (Category ok)
          MOVE      SP70,OPARUY06  *  User Defined Y/N 6
          MOVE      SP70,OPARUY07  *  User Defined Y/N 7
          MOVE      SP70,OPARUY08  *  User Defined Y/N 8
          MOVE      SP70,OPARUY09  *  User Defined Y/N 9
          MOVE      SP70,OPARUY10  *  User Defined Y/N 10
          MOVE      SP70,OPARUT06  *  User Defined Time Field 6
          MOVE      SP70,OPARUT07  *  User Defined Time Field 7
          MOVE      SP70,OPARUT08  *  User Defined Time Field 8
          MOVE      SP70,OPARUT09  *  User Defined Time Field 9
          MOVE      SP70,OPARUT10  *  User Defined Time Field 10
          MOVE      ZERO,OPARUF06  *  User Defined Form Field 6
          MOVE      ZERO,OPARUF07  *  User Defined Form Field 7
          MOVE      ZERO,OPARUF08  *  User Defined Form Field 8
          MOVE      ZERO,OPARUF09  *  User Defined Form Field 9
          MOVE      ZERO,OPARUF10  *  User Defined Form Field 10
          MOVE      SP70,OPARUANA  *  User ID for Anaesthetic (websecaf)
          MOVE      SP70,OPARTIRF  *  Time in Recovery - Front (HH:MM:SS)
          MOVE      SP70,OPARNUF1  *  Nurse 1 Attending Patient - Front
          MOVE      SP70,OPARNUF2  *  Nurse 2 Attending Patient - Front
          MOVE      SP70,OPARTIRB  *  Time in Recovery - Back (HH:MM:SS)
          MOVE      SP70,OPARNUB1  *  Nurse 1 Attending Patient - Back
          MOVE      SP70,OPARNUB2  *  Nurse 2 Attending Patient - Back
          MOVE      SP70,OPARTIRD  *  Time in Recovery - Day Procedure
          MOVE      SP70,OPARNUD1  *  Nurse 1 Attending Patient - Day
          MOVE      SP70,OPARNUD2  *  Nurse 2 Attending Patient - Day
          MOVE      SP70,OPARTETC  *  Time Exit Theatre Compl. (HH:MM:SS)
          MOVE      SP70,OPARUREC  *  User ID for Recovery (websecaf)
          MOVE      SP70,OPARTEXP  *  Time Patient Died (HH:MM:SS)
          MOVE      SP70,OPARTICU  *  Time Patient Went to ICU (HH:MM:SS)
          MOVE      SP70,OPARRDCD  *  Recovery Delay Code (category Ou)
          MOVE      SP70,OPARTIDP  *  Ready to Depart Time (HH:MM:SS)
          MOVE      SP70,OPARUC21  *  User Defined Code 21 (Category ou)
          MOVE      SP70,OPARUC22  *  User Defined Code 22 (Category ou)
          MOVE      SP70,OPARUC23  *  User Defined Code 23 (Category ou)
          MOVE      SP70,OPARUC24  *  User Defined Code 24 (Category ou)
          MOVE      SP70,OPARUC25  *  User Defined Code 25 (Category ou)
          MOVE      SP70,OPARUC26  *  User Defined Code 26 (Category ou)
          MOVE      SP70,OPARUC27  *  User Defined Code 27 (Category ou)
          MOVE      SP70,OPARUC28  *  User Defined Code 28 (Category ou)
          MOVE      SP70,OPARUC29  *  User Defined Code 29 (Category ou)
          MOVE      SP70,OPARUC30  *  User Defined Code 30 (Category ou)
          MOVE      SP70,OPARUY11  *  User Defined Y/N 11
          MOVE      SP70,OPARUY12  *  User Defined Y/N 12
          MOVE      SP70,OPARUY13  *  User Defined Y/N 13
          MOVE      SP70,OPARUY14  *  User Defined Y/N 14
          MOVE      SP70,OPARUY15  *  User Defined Y/N 15
          MOVE      SP70,OPARUT11  *  User Defined Time Field 11
          MOVE      SP70,OPARUT12  *  User Defined Time Field 12
          MOVE      SP70,OPARUT13  *  User Defined Time Field 13
          MOVE      SP70,OPARUT14  *  User Defined Time Field 14
          MOVE      SP70,OPARUT15  *  User Defined Time Field 15
          MOVE      ZERO,OPARUF11  *  User Defined Form Field 11
          MOVE      ZERO,OPARUF12  *  User Defined Form Field 12
          MOVE      ZERO,OPARUF13  *  User Defined Form Field 13
          MOVE      ZERO,OPARUF14  *  User Defined Form Field 14
          MOVE      ZERO,OPARUF15  *  User Defined Form Field 15
          MOVE      SP70,OPARUYN1  *  User Defined Nurse 1
          MOVE      SP70,OPARUYN2  *  User Defined Nurse 2
          MOVE      SP70,OPARSPAR  *  Spare Variable
          RETURN
.-----------------------------------------------------------------------
. Re-Booking of a patient
.-----------------------------------------------------------------------
REBOOK00  UNPACK    CASEKEYS,KEY23
          MOVE      ZERO,FORM3
          PACK      KEY26,KEY23,Z70
          CALL      RSOPDEA5
REBOOK05  CALL      RPOPDEA5
          BRANCH    OVRCD,REBOOK90
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     KEY26,KEY22
          IF        !@EQUAL
            MOVE      ZERO,FORM3
            GOTO      REBOOK10 IF NOT EQUAL     * First patient in Session
          ENDIF
.
          COMPARE   THREE,OPDASTAT
          GOTO      REBOOK05 IF EQUAL
.
          MOVE      OPDACASE,FORM3
REBOOK10  ADD       ONE,FORM3
          UNPACK    CASEKEYS,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          CALL      CALDEF00     * Calculate Default Start Time
.
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,REBOOK90
.
          PACK      OPDAEXPS,CHOUR,COLON,CMIN
          MOVE      ZERO,OPDASTAT
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          IF        OVRCD<>1
            LOAD      OPDASTAT,ASTAT,ONE,TWO,FOUR,TWO,ZERO
          ENDIF
.
          MOVE      FORM3,OPDACASE
          MOVE      SP70,OPDACANC
          MOVE      OPDACDAT,SAVOCDAT
          MOVE      SP70,OPDACDAT
.
          PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                          OPDACASE,SP70
          MATCH     KEY26,CASEKEYS
          IF        !@EQUAL
            CALL      RAOPDEA1          * key has changed
            IF        OVRCD<>1
              GOTO      REBOOK15
            ELSE
              PACK      KEY26,CASEKEYS,SP70
              CALL      RAOPDEA1
              PACK      KEY26,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT,OPDACASE,SP70
            ENDIF
          ENDIF
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      UPOPDEA1
          MOVE      "009",TADTTYPE
          PROC      OPTHETAT             * write reinstated theatre audit
.
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14            * send update booking message
.
REBOOK15  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1                * get session book time
          IF        OVRCD=0
            MOVE      TWO,AUDIFLAG          * before change audit
            CALL      AUSES000              * write audit
            ADD       OPDAEXPD,OPSETIMB     * Add duration to session book time
            ADD       OPSEPREP,OPSETIMB     * Add patient prep time
            CALL      UPOPSES1              * update book time
            MOVE      THREE,AUDIFLAG        * after change audit
            CALL      AUSES000              * write audit
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,REBOOK90
          COMPARE   TWO,BKRESTAT
          GOTO      REBOOK20 IF NOT EQUAL
          MOVE      ZERO,BKRESTAT
          LOAD      BKRESTAT,OPDASTAT,ONE,THREE,ZERO,FOUR
          CALL      UPBKREC1
.
REBOOK20  PACK      KEY8,OPDAADMN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,REBOOK21
.
          MOVE      PMVXVISN,OPTHVISN
          PROC      OPTHCMPL
          IF        EXIT=1
            MOVE      ONE,PMVXATCP
            MOVE      SP70,PMVXTICM         * Clear reason incomplete
            MOVE      "018",TADTTYPE        * Theatre complete audit record
          ELSE
            MOVE      ZERO,PMVXATCP         * Theatre charges incomplete
            MOVE      "019",TADTTYPE        * Theatre incomplete audit record
          ENDIF
          CALL      UPPMVX11
.
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
          PROC      OPTHETAT
.
REBOOK21  MATCH     SP70,OPDAPROC
          GOTO      REBOOK30 IF EQUAL
.
          PACK      KEY19,URNUMBER,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,REBOOK30
.
          COMPARE   ONE,WMSTAT           * Change status only if Unscheduled
          GOTO      REBOOK30 IF NOT EQUAL
.
          MOVE      BKREBOOK,WMBOOK
          CALL      SAVHIS00
          MOVE      TWO,WMSTAT
          LOAD      WMSTAT,OPDASTAT,THREE,FOUR,ONE,FIVE
          MOVE      BKREADAT,SAVDBFT
          MOVE      BKREBKDT,SAVBMDT
          MOVE      "06",WTWMBSCD        * Rebook Code
          MOVE      ONE,NBRFLAG
          CALL      UPTREA1
.
          MOVE      ZERO,ADDWLFLG
          MOVE      ZERO,NBRFLAG
          CALL      WRTHIS00             * Write Record into History File
          CALL      CHKES000             * Check ESIS Records
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
REBOOK30  MOVE      "Patient has now been returned to Theatre List",WEBTITLE
          UNPACK    CASEKEYS,KEY22
          CLEAR     HTMLLINK
          APPEND    "oprweb01.pbl?reportno=3&template=3&sesskeys=",HTMLLINK
          APPEND    KEY22,HTMLLINK
          RESET     HTMLLINK
          CALL      WINNXT00
          MOVE      ZERO,EXIT
          GOTO      REBOOK99
.
REBOOK90  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REBOOK99
.
REBOOK99  RETURN
.
.------------------------------------------------------------
. Update ESIS for Reinstated Booking
.------------------------------------------------------------
CHKES000  COMPARE   THREE,PTCNHDPS
          GOTO      CHKES999 IF NOT EQUAL   * Not in Victoria
.
          PACK      SAVKEY18,WTWMECNT,ANSP,OPDAUNIQ,SP70
CHKES050  PACK      KEY36,WTWMECNT,ANSP,OPDAUNIQ,SP70
          CALL      RSWTESN5
CHKES100  CALL      RKWTESN5
          BRANCH    OVRCD,CHKES999
.
          MATCH     WTENSADI,OPDAUNIQ
          GOTO      CHKES100 IF NOT EQUAL
.
          PACK      KEY18,WTENUNIQ,WTENETYP,WTENSADI,SP70
          MATCH     KEY18,SAVKEY18
          GOTO      CHKES999 IF LESS
          GOTO      CHKES100 IF NOT EQUAL
.
CHKES200  CALL      IBACLOCK
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          MOVE      ZERO,WTENMANU
.
          MATCH     SP20,WTENEDAT           * has it been sent to HD?
          IF        @EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
            CALL      DEWTESN5
          ELSE
.                                           * already sent to HD
            MOVE      SP8,WTENEDAT          * blank "sent date"
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
            CALL      RAWTESN5
            IF        OVRCD = 1
              PACK      WTENEVAL,DELETERC,SP70
              CALL      WRWTESN5
            ENDIF
          ENDIF
.
CHKES999  RETURN
.-----------------------------------------------------------------------
. Alter booking start time for all subsequent bookings
.-----------------------------------------------------------------------
ADJTME00  MATCH     SP10,UPDTTYPE          * Display
          GOTO      ADJTME80 IF EQUAL
.
          MATCH     "S",UPDTTYPE          * Adjust Subsequent bookings
          GOTO      ADJTME10 IF EQUAL
          GOTO      ADJTME99
.
ADJTME10  PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,ADJTME90
.
          PACK      KEY26,SESSKEYS,CURRCASE,SP70
          CALL      RSOPDEA5
          CALL      RKOPDEA5
          BRANCH    OVRCD,ADJTME91
.
          PACK      KEY26A,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,SP70
          MATCH     KEY26,KEY26A
          GOTO      ADJTME91 IF NOT EQUAL
.
          MOVE      SESSKEYS,CURSESS
          MOVE      CURRCASE,CURCASE
          MOVE      DURATION,ADDDURA
          MOVE      OPSETIME,SESSTIME
.
          CALL      OPCHGSTT
.
          MOVE      OPSEDATE,OPSES001
          MOVE      OPSETIME,OPSES002
          MOVE      OPSECLIN,OPSES003
          MOVE      OPSEHOSP,OPSES074
          CALL      UPDCOM00      * Update Session Based Comments
.
          PACK      SESSKEYS,SESSKEYS,SP70
          PACK      KEY22,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
.
          MATCH     SESSKEYS,KEY22          * Has the session key changed
          GOTO      ADJTME70 IF EQUAL
.
          MATCH     SP70,REDIRECT
          GOTO      ADJTME70 IF EQUAL
.           
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&sesskeys=",REDIRECT
          APPEND    KEY22,REDIRECT
          RESET     REDIRECT
          MOVE      FOUR,NEXTPAGE
.
ADJTME70  MOVE      ZERO,EXIT
          GOTO      ADJTME99
.
ADJTME80  MATCH     SP10,SESSKEYS
          IF        @EQUAL
            PACK      SESSKEYS,CASEKEYS,SP70
          ENDIF
.
          PACK      KEY22,SESSKEYS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,ADJTME90
.
          CALL      SESDET00
.
          MATCH     SP70,CASEKEYS
          IF        @EQUAL
            GOTO      ADJTME85
          ELSE
            PACK      KEY26,CASEKEYS,SP70
            CALL      RDOPDEA1
            BRANCH    OVRCD,ADJTME91
          ENDIF
.
          CALL      CLARD000
          CALL      CASDET00              * Get Case Details
.
.
ADJTME85  CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ADJTME99
.
          CALL      WEBBOD00   * Templated Case Details
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      ADJTME99
.
ADJTME90  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADJTME99
.
ADJTME91  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADJTME99
.
ADJTME92  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADJTME99
.
ADJTME99  RETURN
.
.------------------------------------------------------------
. Update Session Based Comments during session master update
.------------------------------------------------------------
UPDCOM00  MATCH     OPSES002,SESSTIME       * Exit if start time not changed
          GOTO      UPDCOM99 IF EQUAL
.
          PACK      KEY25,OPSES001,OPSES002,OPSES003,SP70
          CALL      RSOPCOM1
UPDCOM02  CALL      RKOPCOM1
          BRANCH    OVRCD,UPDCOM08          * end of file
.
          MATCH     OPSES001,OPCMDATE       * same date
          GOTO      UPDCOM08 IF NOT EQUAL
.
          MATCH     OPSES002,OPCMTIME       * same time?
          GOTO      UPDCOM08 IF NOT EQUAL
.
          MATCH     OPSES003,OPCMCLIN       * same clini / surgeon?
          GOTO      UPDCOM08 IF NOT EQUAL
.
          PACK      KEY25,OPCMDATE,OPCMTIME,OPCMCLIN,OPCMLINE,OPCMHOSP
          CALL      DEOPCOM1
          GOTO      UPDCOM02
.
UPDCOM08  PACK      KEY25,OPSES001,SESSTIME,OPSES003,SP70
          CALL      RSOPCOM1
UPDCOM10  CALL      RKOPCOM1
          BRANCH    OVRCD,UPDCOM99
.
          MATCH     OPSES001,OPCMDATE
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MATCH     SESSTIME,OPCMTIME
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MATCH     OPSES003,OPCMCLIN
          GOTO      UPDCOM99 IF NOT EQUAL
.
          MOVE      OPCMDATE,SAVEDATE
          MOVE      OPCMTIME,SAVETIME
          MOVE      OPCMCLIN,SAVECLIN
          MOVE      OPCMLINE,SAVELINE
          MOVE      OPCMTEXT,SAVETEXT
          MOVE      OPCMHOSP,SAVEHOSP
.
          PACK      KEY25,OPSES001,OPSES002,OPSES003,OPCMLINE,OPSES074
          CALL      RDOPCOM1
          IF        OVRCD=ONE
            MOVE      OPSES001,OPCMDATE
            MOVE      OPSES002,OPCMTIME
            MOVE      OPSES003,OPCMCLIN
            MOVE      SAVELINE,OPCMLINE
            MOVE      SAVETEXT,OPCMTEXT
            MOVE      OPSES074,OPCMHOSP
            MOVE      SP70,OPCMSPAR
            CALL      WROPCOM1
          ELSE
            MOVE      SAVETEXT,OPCMTEXT
            CALL      UPOPCOM1
          ENDIF
.
          PACK     KEY25,SAVEDATE,SAVETIME,SAVECLIN,SAVELINE,SAVEHOSP
          CALL     RDOPCOM1

          GOTO     UPDCOM10
.
UPDCOM99  RETURN
.
.-----------------------------------------------------------------------------
. CTRN0000 - Check transfer source
.-----------------------------------------------------------------------------
CTRN0000  MATCH     Z70,CPADM004                 * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,CPADM004                * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSCODE,CPADM004,SP70
.
          MATCH     Z70,CPADM008                 * No Removal date
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,CPADM008                * No Removal date
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSDATE,CPADM008,SP70
.
CTRN7000  CALL      CVAD0000                     * Validate transfer source
          BRANCH    EXIT,CTRN9999
.
CTRN9000  MOVE      ZERO,EXIT
          GOTO      CTRN9999
.
CTRN9999  RETURN
+
.------------------------------------------------------------
. Is there Session Based Comments?                                     *I-50678
.------------------------------------------------------------
SBID0000  MOVE      ZERO,F1
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPCOM1
SBID1000  CALL      RKOPCOM1
          BRANCH    OVRCD,SBID9000          * end of file
.
          MATCH     OPSEDATE,OPCMDATE       * same date
          GOTO      SBID9000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPCMTIME       * same time?
          GOTO      SBID9000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPCMCLIN       * same clinic / surgeon?
          GOTO      SBID9000 IF NOT EQUAL
.
          MOVE      ONE,F1
.
SBID9000  WRITE     HTMLFILE;F1;
.
SBID9999  RETURN
+
.------------------------------------------------------------
. Create Booking Medical/Maternity
.------------------------------------------------------------
ADDMED00  CALL      CLBOK000
          MOVE      ZERO,PROCFLAG
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ADDMED92
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDMED92
.
          IF        PCEASE=1
            GOTO      ADDMED98                    * Is patient deceased?
          ENDIF
.
          MATCH     SP70,UPDTTYPE
          GOTO      ADDMED70 IF EQUAL
.
          MATCH     Z70,PTMSX003
          IF        !@EQUAL
            PACK      PTMXLGA,PTMSX003
            CALL      UPMAST1
          ENDIF
.
          MATCH     ANSA,UPDTTYPE
          IF        @EQUAL
            MATCH     "1",CHCKOVER
            IF        @EQUAL
              CALL      CHKOV000
              BRANCH    EXIT,ADDMED90
              CALL      CLBOK000
            ENDIF
            MATCH     SP70,ADMISNUM
            IF        !@EQUAL
              CALL      CHKPRE00              * Check for adm/preadmission
              BRANCH    EXIT,ADDMED99
            ELSE
              CALL      NRBK0000                * Get Next Booking Number
            ENDIF
            MOVE      BKREBOOK,AADMNO
            MOVE      BKREBOOK,ADMISSNO
            MOVE      PSNAME,BKRESNAM         * surname
            MOVE      PURNO,BKREURNO          * U/R Number
            MOVE      BKREBOOK,DBKREBOO
.
            MATCH     ADMISNID,SP70
            IF        !@EQUAL
              MOVE      ZERO,F1
              MOVE      SEVEN,KEY1
              MOVE      ADMISSNO,KEY8
              PROC      UPEADMVS             * Update eAdmssion Details
            ENDIF
.
            MATCH     EREFRLID,SP70
            IF        !@EQUAL
              MOVE      ZERO,F1
              MOVE      " 7",KEY2              * Added as Booking
              MOVE      ADMISSNO,KEY8
              PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
              PROC      UPEREFVS               * Update eReferral Details
            ENDIF
.
            MATCH     CORSP001,SP70
            IF        !@EQUAL
              MOVE      ONE,F1
              MOVE      ADMISSNO,KEY8
              PROC      UPEADMVS                 * Update eAdmssion Details
            ENDIF
.
            MATCH     "1",DOBKINDC
            IF        @EQUAL
              CLEAR     REDIRECT
              APPEND    "patweb98.pbl?reportno=1",REDIRECT
              APPEND    "&template=2",REDIRECT
              APPEND    "&urnumber=",REDIRECT
              REP       " +",URNUMBER
              APPEND    URNUMBER,REDIRECT
              APPEND    "&admissno=",REDIRECT
              REP       " +",ADMISSNO
              APPEND    ADMISSNO,REDIRECT
              RESET     REDIRECT
              REP       "+ ",ADMISSNO
              REP       "+ ",URNUMBER
.
              MOVE      "6",NEXTPAGE
              CALL      IBACLOCK                * get current date
              PACK      BKREADAT,CCC,CYY,CMM,CDD
              REP       " 0",BKREADAT           * date of addition
.
              MOVE      "0",BKRESTAT            * Set status equals booked
.
            ENDIF
.
            MATCH       "1",ONCLNKIN
            IF          @EQUAL
              CALL      IBACLOCK                * get current date
              PACK      BKREADAT,CCC,CYY,CMM,CDD
              REP       " 0",BKREADAT           * date of addition
            ENDIF
.
          ENDIF
.
          MATCH     ANSU,UPDTTYPE
          IF        @EQUAL
            MOVE      ADMISSNO,AADMNO
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDBKREC1
            BRANCH    OVRCD,ADDMED93,ADDMED91
            CALL      RDBKRX11
.
            MATCH     ADMISNID,SP70
            IF        !@EQUAL
              MOVE      ZERO,F1
              MOVE      SEVEN,KEY1
              MOVE      ADMISSNO,KEY8
              PROC      UPEADMVS               * Update eAdmssion Details
            ENDIF
.
            MATCH     EREFRLID,SP70
            IF        !@EQUAL
              MOVE      ZERO,F1
              MOVE      " 7",KEY2              * Added as Booking
              MOVE      ADMISSNO,KEY8
              PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
              PROC      UPEREFVS               * Update eReferral Details
            ENDIF
.
            MATCH     CORSP001,SP70
            IF        !@EQUAL
              MOVE      ONE,F1
              MOVE      ADMISSNO,KEY8
              PROC      UPEADMVS                 * Update eAdmssion Details
            ENDIF
          ENDIF
.
          MOVE      SP70,BKRXCNDT
          CALL      MVBOK000                * Move in Booking Details
          CALL      MVBKRX00                * Move in Booking Exnt Details
.
          MATCH     SP70,BKREADOC
          IF        !@EQUAL
            PACK      KEY6,BKREADOC,SP70
            CALL      RDDOCT1
            BRANCH    OVRCD,ADDMED95
            BRANCH    DRSTAT,ADDMED95          * Can not book to inactive doctor
          ENDIF
.
          CALL      IBACLOCK
          PACK      BKREBKDT,CCC,CYY,CMM,CDD
          REP       " 0",BKREBKDT
.
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        !@EQUAL
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
.
          MOVE      DBKREBOO,BKRXBNUM
.
          MATCH     SP70,BKRXCRDT
          IF        !@EQUAL
            PACK      BKRXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",BKRXLUPD
          ENDIF
.
          MATCH     SP70,BKRXCRTM
          IF        !@EQUAL
            CLOCK     TIME,BKRXLUPT
          ENDIF
.
          MATCH     SP70,BKRXWEBC
          IF        !@EQUAL
            MOVE      WBSEUID,BKRXWEBU
          ENDIF
.
          MATCH     SP70,BKRXCRDT
          IF        @EQUAL
            PACK      BKRXCRDT,CCC,CYY,CMM,CDD
          ENDIF
          REP       " 0",BKRXCRDT
.
          MATCH     SP70,BKRXCRTM
          IF        @EQUAL
            CLOCK     TIME,BKRXCRTM
          ENDIF
.
          MATCH     SP70,BKRXWEBC
          IF        @EQUAL
            MOVE      WBSEUID,BKRXWEBC
          ENDIF
.
          MOVE      BKREBOOK,KEY8           * booking number
          CALL      RABKREC1                * Check if already exists
          MATCH     ANSA,UPDTTYPE
          IF        @EQUAL
            COMPARE   ONE,OVRCD
            GOTO      ADDMED91 IF NOT EQUAL   * Already exists or locked
            CALL      WRBKREC1                * write record to booking file
.
            PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
            CALL      RDCODE1          * allow usage if indicator 3=1
            BRANCH    OVRCD,ADDMED10
.
            MATCH     "1",TCINDC3
            IF        @EQUAL
              CALL      WRUSG000         * write theatre usage unique id table
            ENDIF
.
            MATCH     "D",TCINDC5
            IF        @EQUAL
              CALL      WRCPT000         * write to current patient table
            ENDIF
.
            MATCH     "1",FFOECIND
             IF        @EQUAL
              MOVE      "  1",DIM3CNTR
              MOVE      PTELF017,DIM9PRIM
              CALL      FOEC0000
              CALL      FOEW0000
.
              MOVE      PTELF016,SAVDIM3
              MOVE      SP70,PTELF016
.
              MATCH     SP70,EXTRPROV
              IF        !@EQUAL & !@EOS
                MOVE      "  2",DIM3CNTR
                MOVE      EXTRPROV,DIM9PRIM
                CALL      FOEC0000
                CALL      FOEW0000
              ENDIF
.
              MATCH     SP70,EXTRPRV2
              IF        !@EQUAL & !@EOS
                MOVE      "  3",DIM3CNTR
                MOVE      EXTRPRV2,DIM9PRIM
                CALL      FOEC0000
                CALL      FOEW0000
              ENDIF
.
              MATCH     SP70,EXTRPRV3
              IF        !@EQUAL & !@EOS
                MOVE      "  4",DIM3CNTR
                MOVE      EXTRPRV3,DIM9PRIM
                CALL      FOEC0000
                CALL      FOEW0000
              ENDIF
.
              MATCH     SP70,EXTRPRV4
              IF        !@EQUAL & !@EOS
                MOVE      "  5",DIM3CNTR
                MOVE      EXTRPRV4,DIM9PRIM
                CALL      FOEC0000
                CALL      FOEW0000
              ENDIF
.
              MATCH     SP70,EXTRPRV5
              IF        !@EQUAL & !@EOS
                MOVE      "  6",DIM3CNTR
                MOVE      EXTRPRV5,DIM9PRIM
                CALL      FOEC0000
                CALL      FOEW0000
              ENDIF
.
              MOVE      SAVDIM3,PTELF016
.
            ENDIF
.
          ENDIF
.
ADDMED10  MATCH     ANSU,UPDTTYPE
          IF        @EQUAL
            COMPARE   ONE,OVRCD
            GOTO      ADDMED97 IF EQUAL       * Missing record
            CALL      UPBKREC1                * write record to booking file
            PACK      OPDAADMN,DBKREBOO,SP70
            CALL      UPDMIS00   * Update Admission Date/Time (preadmits only)
            CALL      UNUT0000                * Nutrition record update
          ENDIF
          PACK      KEY8,DBKREBOO,SP70
          CALL      RABKRX11
          IF        OVRCD=1
            CALL      WRBKRX11              * write record to booking details
            CALL      CLWATTR1              * I-155887
            CALL      CLWATTX1              * I-155887
            MOVE      SEVEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUB              * DG API Pre-Admis Booking *I-90203
          ELSE
            CALL      UPBKRX11
          ENDIF
.
          CALL      UPVCM000                * Update admission comments
.
          MOVE      ZERO,EXIT
          MATCH     SP9,BKDICODE
          GOTO      ADDMED20 IF NOT EQUAL   * have a code
          MATCH     SP30,BKDIDES1
          GOTO      ADDMED20 IF NOT EQUAL   * have a desc
          MATCH     SP30,BKDIDES2
          GOTO      ADDMED20 IF NOT EQUAL   * have a desc
          MATCH     SP30,BKDICOMM
          GOTO      ADDMED30 IF EQUAL       * dont have comments
.
ADDMED20  MOVE      BKREBOOK,BKDIBOOK       * set booking number
          PACK      BKDIUNIQ,SP9,ONE,SP70   * set unique number
          PACK      KEY18,BKREBOOK,SP9,ONE,SP70  * set booking number
          CALL      RABKDIA1
          IF        OVRCD=0
            CALL      UPBKDIA1                * update file
          ELSE
            CALL      WRBKDIA1                * write details
          ENDIF
.
ADDMED30  CALL      PBDM0000                  * Multiple regimes and bed manage
          MOVE      BKREBOOK,ADMISSNO
          PROC      BBUP0000                  * Bed Board
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,DBKREBOO,SP70
            CALL      WRPORD00          * write ACC purchase order
          ENDIF
.
          CALL      UPADM000                 * Update preadmission if req.
          CALL      UNUT0000                * Nutrition record update
          MOVE      ZERO,EXIT
          GOTO      ADDMED99
.
ADDMED70  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,ADDMED93,ADDMED91
          CALL      RDBKRX11
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDMED94
.
          MATCH     "THE",THCSCOD
          GOTO      ADDMED94 IF EQUAL
.
...       MATCH     SP70,BKREPROC
...       GOTO      ADDMED95 IF NOT EQUAL
.
          MATCH     "001",TEMPLATE
          IF        @EQUAL
            COMPARE   TWO,BKRESTAT         *Checks to see if booking cancelled
            GOTO      ADDMED89 IF EQUAL
          ENDIF
.
          CLEAR     WEBTITLE
          APPEND    "Update Medical Booking",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ADDMED99
.
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED89  MOVE      "Error: Booking is cancelled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED90  MOVE      "Error: Patient already booked for that time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED91  MOVE      "Booking Number in Use",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED93  MOVE      "Invalid Booking Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED94  MOVE      "Invalid Booking Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED95  CLEAR     WEBTITLE
          APPEND    "Can not book a patient with an inactive doctor",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED96  MOVE      "Please update via Waiting List",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED97  MOVE      "Booking Number Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED98  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMED99
.
ADDMED99  CLOSE     COMVISAF,DELETE
          RETURN
.
.------------------------------------------------------------
. Write  booking change audit
.------------------------------------------------------------
WRCB0000  MATCH     SP70,BKREPROC
          GOTO      WRCB9999 IF EQUAL
.
          MATCH     SP70,DBKRECNT
          GOTO      WRCB9999 IF EQUAL
.
          PACK      WTCHURNO,BKREURNO,SP70
          PACK      WTCHPROC,BKREPROC,SP70
          PACK      WTCHPCNT,BKRECNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,ONE,EIGHT,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,DBKREBOO,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCB9999  RETURN
+

.------------------------------------------------------------
. Write a record to appear on the current patient report
.------------------------------------------------------------
WRCPT000  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     BKREEDAT,KEY8
          GOTO      WRCPT999 IF NOT EQUAL
.
          PACK      PMCUDATE,BKREEDAT,SP70
          MOVE      DBKREBOO,PMCUVISN
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "4",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          PACK      PMCUHOSP,SP70
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      PMCUHOSP,PTWDHOSN,SP70
          ENDIF
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPT999  RETURN
+
.*************************************************************************
. Check for existing booking for that date/time ward/bed
.*************************************************************************
CHKOV000  MOVE      ZERO,EXIT
          MATCH     SP70,BKREC015
          GOTO      CHKOV999 IF EQUAL
.
          MATCH     SP70,BKREC018
          GOTO      CHKOV999 IF EQUAL
.
          PACK      TESTDATE,SP70
          UNPACK    BKREC004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      TESTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TESTDATE
.
          PACK      KEY19,BKREC015,TESTDATE,SP70
          CALL      RSBKREC7
CHKOV100  CALL      RKBKREC7
          BRANCH    OVRCD,CHKOV999
.
          MATCH     BKREC015,BKREWARD
          GOTO      CHKOV999 IF NOT EQUAL
.
          MATCH     TESTDATE,BKREEDAT
          GOTO      CHKOV999 IF NOT EQUAL
.
          MATCH     BKREC018,BKREEBED
          GOTO      CHKOV100 IF NOT EQUAL
.
          MATCH     BKREC005,BKREATIM
          GOTO      CHKOV100 IF NOT EQUAL
.
          MOVE      ONE,EXIT
.
CHKOV999  RETURN
.*************************************************************************
. Write unique id to bokunqaf to allow usage to be entered
.*************************************************************************
WRUSG000  MOVE      "42",FORM2              * get previous unique record
          MOVE      " 42",PRXCODE   * System Lock Sector 42
          CALL      GETSLK00        * Get System Lock of Sector 42
          READ      CONTROLF,FORM2;*32,OPCNUNIQ
          ADD       ONE,OPCNUNIQ            * set it to next unique number
          WRITAB    CONTROLF,FORM2;*32,OPCNUNIQ
          CALL      RELSLK00        * Release System Lock of Sector 42
          MOVE      OPCNUNIQ,OPDAUNIQ
.
          PACK      KEY18,BKREBOOK,OPDAUNIQ,SP70
          CALL      RDBKUNQ1
          IF        OVRCD<>1
            GOTO      WRUSG999
          ENDIF
.
          PACK      BKUNVISN,BKREBOOK,SP70
          PACK      BKUNUNIQ,OPDAUNIQ,SP70
          PACK      BKUNLADM,SP70
          PACK      BKUNWEBL,SP70
          PACK      BKUNDATL,SP70
          PACK      BKUNTIML,SP70
          PACK      KEY18,BKUNVISN,BKUNUNIQ,SP70
          CALL      WRBKUNQ1
.
WRUSG999  RETURN
.
.-----------------------------------------------------------------------------
. CDEP0000 - Check if there are deposits for this pre admission
.-----------------------------------------------------------------------------
CDEP0000  MATCH     "Y",PREAD002                 * Cancel pre admission
          GOTO      CDEP8000 IF NOT EQUAL
.
          MOVE      "0",CMDESTAT                 * deposit held
          PACK      KEY26,OPDAADMN,CMDESTAT,SP70 * Check for a deposit
          CALL      RSCMDEP2
CDEP1000  CALL      RKCMDEP2
          BRANCH    OVRCD,CDEP5000
.
          MATCH     OPDAADMN,CMDEADMN
          GOTO      CDEP5000 IF NOT EQUAL
          MATCH     "0",CMDESTAT                 * Deposit held?
          GOTO      CDEP5000 IF NOT EQUAL
.
          GOTO      CDEP9000
.
CDEP5000  PACK      KEY25,OPDAADMN,SP70          * unreleased cash
          CALL      RSRCDTE6
CDEP6000  CALL      RKRCDTE6
          BRANCH    OVRCD,CDEP8000
.
          MATCH     OPDAADMN,RCDTVIST
          GOTO      CDEP8000 IF NOT EQUAL
.
          MATCH     SP70,RCDTRELD               * Unreleased
          GOTO      CDEP6000 IF NOT EQUAL
.
          MATCH     SP70,RCDTRELT
          GOTO      CDEP6000 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CDEP6000
.
          MATCH     "1",RCBNSTAT
          GOTO      CDEP6000 IF EQUAL            * Already cancelled
.
          GOTO      CDEP9100
.
CDEP8000  MOVE      ZERO,EXIT
          GOTO      CDEP9999
.
CDEP9000  MOVE      "Patient has a Released Receipt",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CDEP9999
.
CDEP9100  MOVE      "Patient has an Unreleased Receipt",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CDEP9999
.
CDEP9999  RETURN
.----------------------------------------------------------------
. Validate a visit number and check it is for this U/R number
.----------------------------------------------------------------
VALVIS00  CALL      XMLHED00
          BRANCH    EXIT,VALVIS99
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,VALVIS90
.
          MATCH     PVIURNO,VALDURNO
          GOTO      VALVIS91 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      VALVIS92 IF NOT EQUAL
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VALVIS92
.
          IF        ASTAT=5
            GOTO      VALVIS90
          ENDIF
.
          PACK      KEY10,VALDUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,VALVIS93
.
          MATCH     ADATE,OPDADATE
          GOTO      VALVIS95 IF LESS
.
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,VALVIS94
.
            MATCH     OPDADATE,DDATE
            GOTO      VALVIS95 IF LESS
            GOTO      VALVIS50
          ENDIF
.
          COMPARE   THREE,PTCNHDPS
          GOTO      VALVIS50 IF NOT EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,VALVIS50
.
          PACK      KEY8,OPDAADMN
          CALL      RDBKREC1
          BRANCH    OVRCD,VALVIS50
.
          MATCH     BKREEDAT,ADATE
          GOTO      VALVIS89 IF NOT EQUAL
.
VALVIS50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PVIBILL,"|",PVIURNO:
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Confirmed Admission date for this booking ":
                             "does not match the Inpatient admission date. ":
                             "  Unable to link":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit number - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit for this U/R - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit type for a linked visit":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid booking record":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing discharge record":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Booking outside visit range":
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS98  CALL      XMLEND00
VALVIS99  RETURN
+
.*****************************************************************************
.*        Merge booking with admission record                                *
.*****************************************************************************
BOKMER00  MOVE      ZERO,EXIT
          MOVE      OPDAADMN,SAVBOKNO
          MOVE      ZERO,BOOKFLAG
          PACK      KEY31,SAVBOKNO,SP70
          CALL      RSOPDEA2
BOKMER10  CALL      RKOPDEA2
          BRANCH    OVRCD,BOKMER20
.
          MATCH     CASEUNIQ,OPDAUNIQ
          GOTO      BOKMER10 IF EQUAL
.
          MATCH     OPDAADMN,SAVBOKNO
          GOTO      BOKMER20 IF NOT EQUAL
.
          MOVE      ONE,BOOKFLAG           * other bookings exist for this adm
.
BOKMER20  MATCH     SAVBOKNO,LINKVIST
          GOTO      BOKMER92 IF EQUAL
.
          MATCH     Z70,LINKVIST
          GOTO      BOKMER90 IF EQUAL
.
          PACK      KEY8,LINKVIST,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BOKMER90
.
          IF        ASTAT=5
            GOTO      BOKMER90
          ENDIF
.
          PACK      KEY10,CASEUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,BOKMER91
.
          PACK      SAVKEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                    OPDACASE,SP70
          MOVE      LINKVIST,OPDAADMN                      * Key field
          LOAD      OPDASTAT,ASTAT,ONE,TWO,FOUR,TWO,ZERO   * Key field
.
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          PACK      KEY26,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                          OPDACASE,SP70
... don't check for duplicate if nothing is changing
          MATCH     SAVKEY26,KEY26
          IF        !@EQUAL
            CALL      RAOPDEA1          * Duplicate case check
            IF        OVRCD<>1
              GOTO      BOKMER93
            ENDIF
          ENDIF

          CALL      UPOPDEA3
.
          MOVE      "007",TADTTYPE
          PROC      OPTHETAT                * write to theatre audit
.
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14            * send update booking message
.
          MATCH     SP70,OPDAPROC
          GOTO      BOKMER40 IF EQUAL
.
          CALL      UBOK0000
.
BOKMER40  PACK      KEY8,LINKVIST,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,BOKMER50
          PACK      KEY8,SAVBOKNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,BOKMER55
.
.... do other bookings still exist for old visit - if so don't delete bokrc1af
.
          IF        BOOKFLAG<>1
            CALL      DEBKREC1
          ENDIF
.
          GOTO      BOKMER55
.
BOKMER50  PACK      KEY8,SAVBOKNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,BOKMER55
          MOVE      LINKVIST,BKREBOOK
          MOVE      ZERO,BKRESTAT
          LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR,THREE,TWO
          IF        BOOKFLAG=1
            PACK      KEY8,BKREBOOK,SP70
            CALL      RABKREC1
            IF        OVRCD=1
              CALL      WRBKREC1
            ENDIF
          ELSE
            CALL      UPBKREC1
          ENDIF
.
BOKMER55  PACK      KEY8,LINKVIST,SP70
          CALL      RDBKRX11
          IF        OVRCD<>1
            IF        BOOKFLAG<>1
              PACK      KEY8,SAVBOKNO,SP70
              CALL      DEBKRX11
              GOTO      BOKMER60
            ENDIF
          ENDIF
.
          PACK      KEY8,SAVBOKNO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BOKMER60
          MOVE      LINKVIST,BKRXBNUM
          IF        BOOKFLAG=1
            PACK      KEY8,BKRXBNUM,SP70
            CALL      RABKRX11
            IF        OVRCD=1
              CALL      WRBKRX11
            ENDIF
          ELSE
            CALL      UPBKRX11
          ENDIF
.
BOKMER60  PACK      KEY18,SAVBOKNO,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,BOKMER70
.
          MATCH     SAVBOKNO,DBKDIBOO
          GOTO      BOKMER75 IF NOT EQUAL
          PACK      SAVKEY18,DBKDIBOO,BKDIUNIQ,SP70
.
BOKMER70  MOVE      LINKVIST,BKDIBOOK
          PACK      KEY18,BKDIBOOK,BKDIUNIQ,SP70
          CALL      RABKDIA1
          IF        OVRCD=1
            PACK      KEY18,SAVKEY18
            CALL      RABKDIA1
            CALL      UPBKDIA1
          ENDIF
.
BOKMER75  CALL      UMTI0000                * Update pmsmtiaf if necessary
          CALL      MRQ10000
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA         * Update Bed fees
            CALL      CINVP000              * Check for tobe invoiced
          ENDIF
.
          MOVE      LINKVIST,ADMISSNO
          PROC      BBUP0000           * Bed Board update new IP visit
.
          MOVE      SAVBOKNO,ADMISSNO
          PROC      BBUP0000           * Bed Board update old merged booking
.
          GOTO      BOKMER99
.
BOKMER90  MOVE      "Invalid admission number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKMER99
.
BOKMER91  MOVE      "Invalid theatre booking",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKMER99
.
BOKMER92  MOVE      "Booking numbers match, please select a new visit",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKMER99
.
BOKMER93  CLEAR      WEBTITLE
          APPEND    "Error:  Duplicate case numbers exist in this ",WEBTITLE
          APPEND    "theatre session",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKMER99
.
BOKMER99  RETURN
+
.*****************************************************************************
UBOK0000  PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UBOK9999
          MOVE      WMBOOK,SAVEBOOK
          MOVE      LINKVIST,WMBOOK
          LOAD      WMSTAT,ASTAT,THREE,FOUR,FIVE
          CALL      UPTREA1
          IF        WMSTAT=4
            CALL      SAVHIS00
            MOVE      ZERO,NBRFLAG
            MOVE      "33",WTWMBSCD
            CALL      WRTHIS00
          ENDIF
.
          CALL      WCHC0000   * Write 09 to watchaaf
.
.         Get the PMI details for the HL7 broadcast message
.
          MOVE      OPDAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UBOK9999
.
          CALL      CLPMSPX2
          MOVE      OPDAURNO,KEY8
          CALL      RDPMPX21
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN1,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
UBOK9999  RETURN
+
.*****************************************************************************
.         Update pmsmtiaf file with LINKVIST
.*****************************************************************************
UMTI0000  PACK      KEY14,SAVBOKNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,UMTI9999
.
          MATCH     SAVBOKNO,PMMIVISN
          GOTO      UMTI9999 IF NOT EQUAL
.
          PACK      SKEY14,PMMIVISN,PMMITRAN       * save original key
.
.         Write a record to pmsmtiaf for LINKVIST
.
          MOVE      LINKVIST,PMMIVISN
.
          MOVE      LINKVIST,KEY8
UMTI1000  CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,LINKVIST,PMMITRAN,SP70
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      UMTI1000 IF EQUAL
.
          MOVE      LINKVIST,PMMIVISN
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          CALL      WRPMMTI1
.
          MOVE      SKEY14,KEY14
          CALL      DEPMMTI1
.
          GOTO      UMTI0000
.
UMTI9999  RETURN
+
.*****************************************************************************
.*        Update ESIS details when updating booking                          *
.*****************************************************************************
UPESIS00  COMPARE   ONE,CHGSCHED
          GOTO      UPESIS99 IF NOT EQUAL
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      UPESIS99 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROC
          GOTO      UPESIS99 IF EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UPESIS99
.
.*** check for a set SAD that has not been sent and update with new SAD ***
.
          PACK      KEY36,WTWMECNT,ANSS,OPDAUNIQ,SP70
          CALL      RSWTESN5
UPESIS10  CALL      RKWTESN5
          BRANCH    OVRCD,UPESIS90
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      UPESIS90 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP
          GOTO      UPESIS90 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      UPESIS10 IF NOT EQUAL
.
          PACK      SAVEVDT,WTENEVDT
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD
          REP       " 0",WTENEVDT
          MOVE      PATADMDT,WTENEVAL
          MATCH     PATADMDT,WTENEVDT
          IF        !@LESS
            MOVE      PATADMDT,WTENEVDT
          ENDIF
          MATCH     SAVEVDT,WTENEVDT
          IF        !@EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
            CALL      RAWTESN1
            IF        OVRCD=1
              CALL      UPWTESN5
            ENDIF
          ELSE
            CALL      UPWTESN5
          ENDIF
          GOTO      UPESIS99
.
.*** check for a set SAD that HAS been sent and update with new SAD ***
.
UPESIS90  PACK      KEY36,WTWMECNT,ANSS,OPDAUNIQ,SP70
          CALL      RSWTESN5
UPESIS95  CALL      RKWTESN5
          BRANCH    OVRCD,UPESIS99
.
          MATCH     OPDAUNIQ,WTENSADI
          GOTO      UPESIS99 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP
          GOTO      UPESIS99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          GOTO      UPESIS95 IF EQUAL
.
          MOVE      DELESN,WTENEVAL
          MOVE      SP70,WTENEDAT
.
          PACK      WTENWEBC,USERID
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
          MOVE      PATADMDT,WTENEVAL
          MOVE      SP70,WTENEDAT
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD
          REP       " 0",WTENEVDT
          MATCH     PATADMDT,WTENEVDT
          IF        !@LESS
            MOVE      PATADMDT,WTENEVDT
          ENDIF
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
UPESIS99  RETURN
+
.*****************************************************************************
.*        Update Visit Extension File                                        *
.*****************************************************************************
.UPDVX100  MATCH     "1",UVTHINDI
.          GOTO      UPDVX199 IF NOT EQUAL
.
.          PACK      KEY8,OPDAADMN,SP70
.          CALL      RDPMVX11
.          BRANCH    OVRCD,UPDVX199
.          MOVE      PTVIS079,PMVXUVTH       * update unplanned visit to theatre
.          CALL      UPPMVX11
.
.UPDVX199  RETURN
+
.******************************************************************************
.*  Write NZ Procedure details if required                                    *
.******************************************************************************
WRNZP000  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      WRNZP999 IF NOT EQUAL
.
          MOVE      ZERO,F1
          CALL      CLNZSP00
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,WRNZP999
.
          IF        ASTAT<1 | ASTAT>4
            GOTO      WRNZP999
          ENDIF
.
          PACK      KEY11,DAADMNO,Z70
          CALL      RSNZSPR1
          CALL      RPNZSPR1
          BRANCH    OVRCD,WRNZP010
.
          MATCH     DAADMNO,NZSPADMN
          GOTO      WRNZP010 IF NOT EQUAL
.
          MOVE      NZSPUNIQ,F3
          MOVE      ZERO,F1
          ADD       ONE,F3
          GOTO      WRNZP020
.
WRNZP010  MOVE      ONE,F1
          MOVE      ONE,F3
.
WRNZP020  CALL      CLNZSP00
          PACK      NZSPADMN,DAADMNO,SP70
          PACK      NZSPCLMN,ACLAIM,SP70
          MATCH     Z70,PATCLAIM
          IF        !@EQUAL
            PACK      NZSPCLMN,PATCLAIM,SP70
          ENDIF
          IF        PROCFLAG=1
            PACK      NZSPSURG,OPDACLIN,SP70
            PACK      NZSPANAE,OPSEANAE,SP70
          ELSE
            PACK      NZSPSURG,ADOCTA,SP70
          ENDIF
          PACK      NZSPUNIQ,F3,SP70
          PACK      NZSPCNTR,AFUNDH,SP70
          COMPARE   ONE,F1
          IF        @EQUAL
            MOVE      "1",NZSPPRIM
          ELSE
            MOVE      "0",NZSPPRIM
          ENDIF
.
          CALL      IBACLOCK
          PACK      NZSPCDAT,CCC,CYY,CMM,CDD * Date created
          REP       " 0",NZSPCDAT
          MOVE      ZERO,NZSPINVD
          MOVE      CTIMEIS,NZSPCTIM         * Time created
          PACK      NZSPCUID,WBSEUID,SP70
.
          MOVE      ZERO,NZSPFFEE
          MOVE      ZERO,NZSPHPAY
          MOVE      ZERO,NZSPCPAY
          MOVE      ZERO,NZSPFADJ
          MOVE      ZERO,NZSPHADJ
          MOVE      ZERO,NZSPCADJ
          MOVE      SP70,NZSPCONT
.
          MATCH     SP70,OPDAPROV
          GOTO      WRNZP050 IF EQUAL
.
          MOVE      OPDAPROV,NZSPPROC
          PACK      NZSPPDES,OPDADES1,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      WRNZP040 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      WRNZP040 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROV
          GOTO      WRNZP040 IF EQUAL
.
          PACK      KEY9,OPDAPROV,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
WRNZP040  ADD       ONE,F3
          MOVE      F3,NZSPUNIQ
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
WRNZP050  MOVE      "0",NZSPPRIM
          MOVE      SP70,NZSPCLMN
          MOVE      SP70,NZSPCNTR
          MOVE      SP70,NZSPCPRC
          MOVE      SP70,NZSPAPRV
.
          MATCH     SP70,OPDAPRV2
          GOTO      WRNZP100 IF EQUAL
.
          MOVE      OPDAPRV2,NZSPPROC
          PACK      NZSPPDES,OPDADES2,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      WRNZP100 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      WRNZP100 IF NOT EQUAL
.
          MATCH     SP70,OPDAPRV2
          GOTO      WRNZP100 IF EQUAL
.
          PACK      KEY9,OPDAPRV2,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
          ADD       ONE,F3
          MOVE      F3,NZSPUNIQ
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
WRNZP100  MATCH     SP70,OPDAPRV3
          GOTO      WRNZP999 IF EQUAL
          ADD       ONE,F3
          MOVE      OPDAPRV3,NZSPPROC
          PACK      NZSPPDES,OPDADES3,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      WRNZP150 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      WRNZP150 IF NOT EQUAL
.
          MATCH     SP70,OPDAPRV3
          GOTO      WRNZP150 IF EQUAL
.
          PACK      KEY9,OPDAPRV3,SP70
          PACK      KEY17,KEY9,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
WRNZP150  MOVE      F3,NZSPUNIQ
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
WRNZP999  RETURN
+
.*****************************************************************************
.*        Previous visit to theatre indicator                                *
.*****************************************************************************
PTHV0000  MOVE      ZERO,PTHVFLAG
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
PTHV1000  CALL      RKOPDEA2
          BRANCH    OVRCD,PTHV9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      PTHV9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      PTHV1000 IF EQUAL
.
          MATCH     DIM10,OPDAUNIQ
          GOTO      PTHV2000 IF NOT EQUAL
          GOTO      PTHV1000
.
PTHV2000  MOVE      ONE,PTHVFLAG
.
PTHV9999  CALL      CLOPRDEA
          RETURN
.*****************************************************************************
.         CLOPAV00                                                           *
.*****************************************************************************
CLOPAV00  MOVE      SP70,OPAVCODE
          MOVE      SP70,OPAVDOCT
          MOVE      ZERO,OPAVAVER
          MOVE      SP70,OPAVSPAR
.
CLOPAV99  RETURN
.
.*****************************************************************************
.         REOCS000                                                           *
.*****************************************************************************
REOCS000  MOVE      ZERO,EXIT
          CALL      CRTMP000
.
.. Firstly, loop around all existing oprdetaf records for this session, find
.. out if the procedure has started by using the parameter opcnftim.  Write
.. all records away to a tempfile
          PACK      KEY26,SESSKEYS,SP70
          CALL      RSOPDEA5
REOCS010  CALL      RKOPDEA5
          BRANCH    OVRCD,REOCS500
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      REOCS500 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      REOCS010 IF EQUAL
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
          ENDIF
.
          MOVE      SP70,DIM8
          LOAD      DIM8,OPCNFTIM,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                  OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                  OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                  OPARTIDP,OPARTETC
.
.    *** default value if no times entered yet *****
          MATCH     SP70,DIM8
          IF        @EQUAL
            MOVE      "99:99:99",DIM8
          ENDIF
.
          PACK      TMPUNIQ,OPDAUNIQ,SP70
          PACK      TMPCASE,OPDACASE,SP70
          PACK      TMPSTART,DIM8,SP70
.
          PACK      KEY21,TMPUNIQ,TMPCASE,TMPSTART,SP70
          CALL      RATMPRE1
          IF        OVRCD=1
            CALL      WRTMPRE1
          ENDIF
.
          GOTO      REOCS010
.
.. Secondly,loop around all of the tempfile to find the correct order for the
.. case. All procedures that have a 'started time' based on the parameter will
.. appear first, then any without usage will stay in existing case number order
REOCS500  MOVE      ONE,CASECTR
          PACK      KEY21,SP70
          CALL      RSTMPRE1
REOCS550  CALL      RKTMPRE1
          BRANCH    OVRCD,REOCS900
.
          PACK      CASETO,CASECTR
          ADD       ONE,CASECTR
.
          PACK      KEY10,TMPUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,REOCS550
.
.
          PACK      CASEFROM,OPDACASE,SP70
.
. *** no need to update if the case number is staying the same ****
          MATCH     CASEFROM,CASETO
          GOTO      REOCS550 IF EQUAL
.
. check this theatre booking still belongs to this session
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      REOCS500 IF NOT EQUAL
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE,SP70
          CALL      WEBAUD00
.
          MOVE      CASEKEYS,KEY22
          CALL      OPMVSBOK
.
          GOTO      REOCS550
.
REOCS900  MOVE      ZERO,EXIT
          CLEAR     REDIRECT
          APPEND    "oprweb01.pbl?reportno=3&template=003&sesskeys=",REDIRECT
          APPEND    SESSKEYS,REDIRECT
          RESET     REDIRECT
.
          MOVE      "1",NEXTPAGE
.
          CALL      KTMP0000                * Delete temp file
.
          GOTO      REOCS999
.
REOCS999  RETURN
.
.*****************************************************************************
.*        Tempfile I/O Subroutines                                           *
.*****************************************************************************
RATMPRE1  MOVE      ZERO,OVRCD
          RESET     KEY21
          READ      TMPREOR1,KEY21;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPRE1  RESET     KEY21
          READ      TMPREOR1,KEY21;;
          RETURN
.
RKTMPRE1  MOVE      ZERO,OVRCD
          READKS    TMPREOR1;TMPUNIQ,TMPCASE,TMPSTART
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPRE1  RESET     KEY21
          WRITE     TMPREOR1,KEY21;TMPUNIQ,TMPCASE,TMPSTART
          RETURN
.
DETMPRE1  RESET     KEY21
          DELETE    TMPREOR1,KEY21
          RETURN
.
.*****************************************************************************
.*        Create Tempfile                                                    *
.*****************************************************************************
CRTMP000  CALL      KTMP0000
.
          CLEAR     DIM100
          APPEND    "isbuild ",DIM100
          APPEND    FNAMEA,DIM100
          APPEND    " 22 U14-21,11-13,1-10",DIM100
          RESET     DIM100
          EXECUTE   DIM100,TASKID
          OPEN      TMPREOR1,FNAMEA
.
          PACK      KEY21,SP70
          CALL      RSTMPRE1
CRTMP100  CALL      RKTMPRE1
          BRANCH    OVRCD,CRTMP999
.
          CALL      DETMPRE1
          GOTO      CRTMP100
.
CRTMP999  RETURN
.
.*****************************************************************************
.*        Kill Tempfile                                                      *
.*****************************************************************************
KTMP0000  CLOSE     TMPREOR1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEA,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KTMP9999  RETURN
.
.*****************************************************************************
.* Default the anaesthetist code                                             *
.*****************************************************************************
DEFA0000  PACK      KEY5,ANSD,ANST,SP70
          CALL      RDSCODE1
DEFA1000  CALL      RDKCODE1
          BRANCH    OVRCD,DEFA9999
.
          MATCH     "DT",TCODE
          GOTO      DEFA9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      DEFA1000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,DEFA1000
            ENDIF
          ENDIF
.
          MATCH     ANSA,TCINDC7
          GOTO      DEFA1000 IF NOT EQUAL
.
          MOVE      ACODE,DOCTORTP
.
DEFA9999  RETURN
.
.*****************************************************************************
.*        Check for preadmission/admission                                   *
.*****************************************************************************
CHKPRE00  MOVE      ZERO,EXIT
.
          PACK      KEY8,ADMISNUM,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            GOTO      CHKPRE90
          ENDIF
.
          PACK      KEY8,ADMISNUM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKPRE92
.
          MOVE      ADMISNUM,BKREBOOK
          MOVE      ZERO,BKRESTAT
          LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR,THREE,TWO
          GOTO      CHKPRE99
.
CHKPRE90  MOVE      "Booking already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKPRE99
.
CHKPRE92  MOVE      "Invalid admission ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKPRE99
.
CHKPRE99  RETURN
+
.-------------------------------------------------------------------------
. SPRGM000 - Set Parameters for Admission Multiple Regime Codes
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPRGM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRGM010,SPRGM020,SPRGM030
.
          GOTO      SPRGM910
.
SPRGM010  MOVE      QRYDATA,PTRGM001
          GOTO      SPRGM900
.
SPRGM020  MOVE      QRYDATA,PTRGM002
          GOTO      SPRGM900
.
SPRGM030  MOVE      QRYDATA,PTRGM003
          GOTO      SPRGM900
.
SPRGM900  MOVE      ZERO,EXIT
          GOTO      SPRGM999
.
SPRGM910  MOVE      ONE,EXIT
.
SPRGM999  RETURN
+
.-------------------------------------------------------------------------
. UPPRGM00 - Write Multiple Regime Codes to patrgmaf.
.-------------------------------------------------------------------------
UPPRGM00  MOVE      ONE,F1
.
UPPRGM10
.         LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
          MOVE      AADMNO,PTRGADMN
          PACK      PTRGCNTR,SP1,F1
.         MOVE      WBSEUID,PTRGCUID
.         CALL      IBACLOCK
.         PACK      PTRGCDAT,CCC,CYY,CMM,CDD
.         REP       " 0",PTRGCDAT
.         MOVE      CTIMEIS,PTRGCTIM
.         MOVE      SP70,PTRGSPAR
.
          PACK      KEY10,PTRGADMN,PTRGCNTR,SP70
          CALL      RAPTRGM1
          IF        OVRCD=0
            LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
            CALL      UPPTRGM1
          ELSE
            LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
            MOVE      WBSEUID,PTRGCUID
            CALL      IBACLOCK
            PACK      PTRGCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTRGCDAT
            MOVE      CTIMEIS,PTRGCTIM
            MOVE      SP70,PTRGSPAR
            CALL      WRPTRGM1
          ENDIF
.
          COMPARE   THREE,F1
          GOTO      UPPRGM99 IF EQUAL
          ADD       ONE,F1
          GOTO      UPPRGM10
.
UPPRGM99  RETURN
.-------------------------------------------------------------------------
. GETRGM00 - Get Multiple Regime Code for Admission Number
.-------------------------------------------------------------------------
GETRGM00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGM99
.
          WRITE     HTMLFILE;PTRGREGM;
.
GETRGM99  RETURN
.-----------------------------------------------------------------------------
. PBDM0000 - Process Regimes and Bed Management
.-----------------------------------------------------------------------------
PBDM0000  MATCH     SP70,BKRETYPE                            * Regimes
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,PBDM5000
.
            MATCH     "O",TCINDC1
            GOTO      PBDM5000 IF NOT EQUAL
            CALL      UPPRGM00
          ENDIF
.
PBDM5000  READ      CONTROLF,HUND12;*107,PTCNBMAN
          MATCH     "1",PTCNBMAN
          GOTO      PBDM9999 IF NOT EQUAL
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MATCH     "1",ONCLNKIN
            IF        @EQUAL
              BRANCH    ASTAT,PBDM9000,PBDM9000,PBDM9999,PBDM9000
            ELSE
              BRANCH    ASTAT,PBDM9000,PBDM9999,PBDM9999,PBDM9999
            ENDIF
          ENDIF
.
PBDM9000  CALL      UPPBMN00
.
PBDM9999  RETURN
.-------------------------------------------------------------------------
.UPPBMN00 - Write/update the bed management table
.-------------------------------------------------------------------------
UPPBMN00  PACK      BKREC015,BKREC015,SP70
          PACK      BKREC018,BKREC018,SP70
          MATCH     SP70,BKREC015
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
          MOVE      SP70,SAVEBRQN
          CALL      DELBMD00                   * Remove Old Records
.
          MOVE      ZERO,LOSDINDC              * Write/update patbmdaf
          MOVE      BKREEDAT,SAVEDATE          * Bed management Detail Tab
          MOVE      BKREATIM,SAVETIME          * Length of Stay days
.
          MOVE      ZERO,LOOPDAYS
          SQUEEZE   BKREC033
          MOVE      BKREC033,LOOPDAYS
.
. Restrict to latest 12 weeks to avoid timeout error from old admissions etc.
.
          IF        LOOPDAYS>84
            UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
            ASSIGN    LOOPDAYS-84,ADJDAYS
            CALL      ADJDAT00
            PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      84,LOOPDAYS
          ENDIF
.
UPPBMN30  COMPARE   ZERO,LOOPDAYS
          GOTO      UPPBMN50 IF EQUAL
.
          MOVE      TWO,LOSDINDC
.
          MOVE      BKREC015,PTBDWARD
          MOVE      BKREC018,PTBDWBED
.
          MOVE      SAVEDATE,PTBDDATE
          MOVE      SAVETIME,PTBDADTM
.         MOVE      "    0",PTBDLOSM
          MOVE      LOOPDAYS,PTBDLOSD
          CALL      GTTOTM00
          MOVE      ADJTIME,PTBDLOSM
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "1",PTBDSTAT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            LOAD      PTBDSTAT,ASTAT,TWO,THREE,FOUR,THREE,ONE
          ELSE
            CALL      CLPATMIS
            MOVE      ADMISSNO,AADMNO
          ENDIF
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            CALL      WRPTBMD1
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          SUB       ONE,LOOPDAYS
          UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "00:00",SAVETIME
          GOTO      UPPBMN30
.
.-------------------------------------------------------------------------
.
UPPBMN50  CALL      GTTOTM00                       * Write/update patbmdaf
          COMPARE   ZERO,ADJTIME                   * Bed Management Detail Tab
          GOTO      UPPBMN70 IF EQUAL              * Length of Stay minutes
.
          COMPARE   TWO,LOSDINDC
          IF        @EQUAL
            MOVE      SAVEDATE,PTBDDATE
            MOVE      SAVETIME,PTBDADTM
          ELSE
            MOVE      BKREEDAT,PTBDDATE
            MOVE      BKREATIM,PTBDADTM
            MOVE      ONE,LOSDINDC
          ENDIF
.
          MOVE      BKREC015,PTBDWARD
          MOVE      BKREC018,PTBDWBED
.
          MOVE      ADJTIME,PTBDLOSM
          MOVE      "  0",PTBDLOSD
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "1",PTBDSTAT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            LOAD      PTBDSTAT,ASTAT,TWO,THREE,FOUR,THREE,ONE
          ELSE
            CALL      CLPATMIS
            MOVE      ADMISSNO,AADMNO
          ENDIF
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            CALL      WRPTBMD1
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          MOVE      PTBDDATE,SAVEDATE
.
.-------------------------------------------------------------------------
.
UPPBMN70  COMPARE   ZERO,LOSDINDC                         * Override previous
          GOTO      UPPBMN99 IF EQUAL                     * Records in patbmdaf
.
          MATCH     SP70,BKREC018
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
.
          MOVE      BKREATIM,DIM5
          PACK      KEY30,BKREC015,BKREC018,BKREEDAT,DIM5,SP3,AADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MOVE      PTBDDATE,SAVEDATE
          MOVE      PTBDADTM,SAVETIME
          MOVE      PTBDLOSD,SAVELOSD
          MOVE      PTBDLOSM,SAVELOSM
.
UPPBMN73  CALL      RPPTBMD1
          BRANCH    OVRCD,UPPBMN80
.
          MATCH     BKREC015,PTBDWARD
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     BKREC018,PTBDWBED
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     SAVEDATE,PTBDDATE
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,SAVEDATE
          IF        @LESS
            GOTO      UPPBMN78
          ENDIF
          GOTO      UPPBMN73 IF NOT EQUAL
.
          MATCH     EXPDSTME,SAVETIME
          IF        @EQUAL | @LESS
            GOTO      UPPBMN78
          ENDIF
.
          GOTO      UPPBMN73
.
UPPBMN78  MOVE      ONE,PTBDOVER
          CALL      UPPTBMD1
.
          GOTO      UPPBMN73
.
.-------------------------------------------------------------------------
.
UPPBMN80  PACK      KEY30,BKREC015,BKREC018,AADMNO,Z70    * Override following
          CALL      RSPTBMD3                              * Records in patbmdaf
          CALL      RPPTBMD3
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     ADMISSNO,PTBDADMN
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MOVE      SAVEDATE,STRTDATE
          MOVE      SAVETIME,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      SAVELOSD,ADJDAYS
          CALL      GETEDT00
.
          PACK      KEY30,BKREC015,BKREC018,SAVEDATE,SAVETIME,SP3,ADMISSNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
UPPBMN85  CALL      RKPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     BKREC015,PTBDWARD
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     BKREC018,PTBDWBED
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTBDADMN
          GOTO      UPPBMN85 IF EQUAL
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL | @LESS
            GOTO      UPPBMN88
          ENDIF
.
          GOTO      UPPBMN85
.
UPPBMN88  MOVE      "1",PTBDOVER
          CALL      UPPTBMD1
.
          GOTO      UPPBMN85
.
UPPBMN99  RETURN
.
.-------------------------------------------------------------------------
.DELBMN00 - Delete old patbmdaf records
.-------------------------------------------------------------------------
DELBMD00  MOVE      SP70,SAVEBRQN
          PACK      KEY30,AADMNO,SP70
          CALL      RSPTBMD2
DELBMD10  CALL      RKPTBMD2
          BRANCH    OVRCD,DELBMD99
          MATCH     ADMISSNO,PTBDADMN
          GOTO      DELBMD99 IF NOT EQUAL
          MOVE      PTBDBRQN,SAVEBRQN
          PACK      KEY30,PTBDADMN,PTBDDATE,PTBDADTM,PTBDWARD,PTBDWBED,PTBDOPPE,SP70
          CALL      DEPTBMD2
          GOTO      DELBMD10
.
DELBMD99  RETURN
.-------------------------------------------------------------------------
.GTTOTM00 - Get total time for regime codes
.-------------------------------------------------------------------------
GTTOTM00  MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
GTTOTM10  COMPARE   F1,FOUR
          GOTO      GTTOTM99 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      GTTOTM10
.
GTTOTM99  RETURN
.
.-------------------------------------------------------------------------
.GETEDT00 - Get Expected Discharge Date and Time
.-------------------------------------------------------------------------
GETEDT00  COMPARE   ZERO,ADJDAYS
          IF        @EQUAL
            MOVE      STRTDATE,EXPDSDTE
            GOTO      GETEDT50
          ENDIF
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
GETEDT50  COMPARE   ZERO,ADJTIME
          IF        @EQUAL
            MOVE      STRTTIME,EXPDSTME
            GOTO      GETEDT99
          ENDIF
.
          CALL      CLDRN000
          MOVE      KEY5,EXPDSTME
.
GETEDT99  RETURN
.
.-----------------------------------------------------------------------------
. CLDRN000 - Calculate Expected Discharge Time
.-----------------------------------------------------------------------------
.
CLDRN000  UNPACK    STRTTIME,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLDRN200  COMPARE   ZERO,FORM4A
          GOTO      CLDRN300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDRN200
.
CLDRN300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDRN400  COMPARE   "24",FORM2
          GOTO      CLDRN500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
.
          UNPACK    EXPDSDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
          GOTO      CLDRN400
.
CLDRN500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDRN800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDRN800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDRN999  RETURN
.
.-------------------------------------------------------------------------
.CHRFL000 - Check if referral details are required
.Outputs  - 0=No Referral Exists
.           1=Valid Referral Exists
.           2=Expired Referral Exists
.-------------------------------------------------------------------------
CHRFL000  PACK      KEY26,URNUMBER,OPSECLIN,Z70
          CALL      RSPMRFL1
          CALL      RPPMRFL1
          BRANCH    OVRCD,CHRFL900
.
          MATCH     URNUMBER,PMRFURNO
          GOTO      CHRFL900 IF NOT EQUAL
.
          MATCH     OPSECLIN,PMRFCONS
          GOTO      CHRFL900 IF NOT EQUAL
.
          MATCH     PMRFEXPD,OPSEDATE
          GOTO      CHRFL960 IF NOT LESS
          GOTO      CHRFL950
.
CHRFL900  WRITE     HTMLFILE;ZERO;
          GOTO      CHRFL999
.
CHRFL950  WRITE     HTMLFILE;ONE;
          GOTO      CHRFL999
.
CHRFL960  WRITE     HTMLFILE;TWO;
          GOTO      CHRFL999
.
CHRFL999  RETURN
.
.-------------------------------------------------------------------------
.DTEAM000 - Output team details if required
.-------------------------------------------------------------------------
DTEAM000  COMPARE   ONE,DISPTEAM
          GOTO      DTEAM999 IF NOT EQUAL
.
          MATCH     SP70,OPSETYD1
          GOTO      DTEAM010 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,OPSETYD1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM010
.
          WRITE     HTMLFILE;"<tr><td>",TDESC,"</td>";
.
          PACK      KEY10,OPSEDCC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;"<td class=DataField>",DOCFNAME,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=DataField>",OPSEDCC1,"</td>";
          ENDIF
.
          MATCH     SP70,OPSETYN1
          GOTO      DTEAM010 IF EQUAL
.
          PACK      KEY5,ANSO,ANSN,OPSETYN1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM010
.
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          PACK      KEY6,OPSENUC1,SP70
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;"<td class=DataField>",DISPNAME,"</td>";
          ENDIF
.
DTEAM010  MATCH     SP70,OPSETYD2
          GOTO      DTEAM020 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,OPSETYD2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM020
.
          WRITE     HTMLFILE;"<tr><td>",TDESC,"</td>";
.
          PACK      KEY10,OPSEDCC2,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;"<td class=DataField>",DOCFNAME,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=DataField>",OPSEDCC2,"</td>";
          ENDIF
.
          MATCH     SP70,OPSETYN2
          GOTO      DTEAM020 IF EQUAL
.
          PACK      KEY5,ANSO,ANSN,OPSETYN2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM020
.
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          PACK      KEY6,OPSENUC2,SP70
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;"<td class=DataField>",DISPNAME,"</td>";
          ENDIF
.
DTEAM020  MATCH     SP70,OPSETYD3
          GOTO      DTEAM030 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,OPSETYD3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM030
.
          WRITE     HTMLFILE;"<tr><td>",TDESC,"</td>";
.
          PACK      KEY10,OPSEDCC3,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;"<td class=DataField>",DOCFNAME,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=DataField>",OPSEDCC3,"</td>";
          ENDIF
.
          MATCH     SP70,OPSETYN3
          GOTO      DTEAM030 IF EQUAL
.
          PACK      KEY5,ANSO,ANSN,OPSETYN3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM030
.
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          PACK      KEY6,OPSENUC3,SP70
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;"<td class=DataField>",DISPNAME,"</td>";
          ENDIF
.
.
DTEAM030  MATCH     SP70,OPSETYD4
          GOTO      DTEAM040 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,OPSETYD4,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM040
.
          WRITE     HTMLFILE;"<tr><td>",TDESC,"</td>";
.
          PACK      KEY10,OPSEDCC4,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;"<td class=DataField>",DOCFNAME,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=DataField>",OPSEDCC4,"</td>";
          ENDIF
.
          MATCH     SP70,OPSETYN4
          GOTO      DTEAM040 IF EQUAL
.
          PACK      KEY5,ANSO,ANSN,OPSETYN4,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM040
.
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          PACK      KEY6,OPSENUC4,SP70
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;"<td class=DataField>",DISPNAME,"</td>";
          ENDIF
.
DTEAM040  MATCH     SP70,OPSETYD5
          GOTO      DTEAM900 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,OPSETYD5,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM900
.
          WRITE     HTMLFILE;"<tr><td>",TDESC,"</td>";
.
          PACK      KEY10,OPSEDCC5,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            WRITE     HTMLFILE;"<td class=DataField>",DOCFNAME,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=DataField>",OPSEDCC5,"</td>";
          ENDIF
.
          MATCH     SP70,OPSETYN5
          GOTO      DTEAM900 IF EQUAL
.
          PACK      KEY5,ANSO,ANSN,OPSETYN5,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DTEAM900
.
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          PACK      KEY6,OPSENUC5,SP70
          CALL      RDOPNUR1
          IF        OVRCD=0
            CLEAR     DISPNAME
            STRIP     OPNRGNAM
            APPEND    OPNRGNAM,DISPNAME
            APPEND    SP1,DISPNAME
            STRIP     OPNRSNAM
            APPEND    OPNRSNAM,DISPNAME
            WRITE     HTMLFILE;"<td class=DataField>",DISPNAME,"</td>";
          ENDIF
.
DTEAM900  WRITE     HTMLFILE;"</tr>";
.
DTEAM999  RETURN
+
.-------------------------------------------------------------------------
.CHGDUR00 - Output team details if required
.-------------------------------------------------------------------------
CHGDU000  MOVE      ZERO,FORM4
          MOVE      ZERO,EXPDURA
.         work out difference between new and old duration
.
          MOVE      OPEREXPD,FORM4           * new duration
          SUB       SAVEEXPD,FORM4          * take away original duration
.
          UNPACK    CASEKEYS,SESNHOSP,SESNDATE,SESNTIME,SESNCODE,DIM1,KEY3
          MOVE      KEY3,CURCASE
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
.
          MOVE      OPDAEXPD,FORM4
          SUB       SAVEEXPD,FORM4
          MOVE      FORM4,EXPDURA
.
. now update session file with new time booked
.
CHGDU105  PACK      KEY22,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          CALL      RDOPSES1
          MOVE      TWO,AUDIFLAG    * before change audit
          CALL      AUSES000        * write audit record
.....     ADD       FORM4,OPSETIMB
.....     CALL      UPOPSES1
          MOVE      THREE,AUDIFLAG    * after change audit
          CALL      AUSES000        * write audit record
.
CHGDU111  ADD       ONE,CURCASE
          MOVE      CURCASE,CASEFROM
          SUB       ONE,CURCASE
          PACK      KEY22,SESNHOSP,SESNDATE,SESNTIME,SESNCODE
          CALL      OPINCTIM                * set new start times
.
.         check whether session is now full
.
          CALL      OPCHKFUL
          BRANCH    EXIT,CHGDU700           * session is not full
.
          CALL      OPSUSPND                * suspended session
          GOTO      CHGDU850
.
CHGDU700  CALL      OPUNSPND                * unsuspend session
.
CHGDU850  MOVE      ZERO,EXIT
          GOTO      CHGDU999
.
CHGDU900  MOVE      ONE,EXIT
.
CHGDU999  RETURN
.
.------------------------------------------------------------
. GTVISC00 - Get Visit Comments
.------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVISC10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   "999",VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
.
.-----------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPVCM000  IF        VSCMTFLG <> 1
            GOTO      UPVCM999
          ENDIF
.
          MOVE      VSCMTTYP,KEY3
          CALL      DLVCM000                  * delete visit comments
.
          IF        VSCMTLIN = 0
            GOTO      UPVCM999
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVCM200  MOVE      ADMISSNO,VSMDVISN         * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      ONE,F6
          MOVE      F6,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE         * Visit date
          MOVE      CTIMEIS,VSMDTIME          * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
.         Insert visit comments
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVCM210  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVCM999 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRVSMTX1
          TRAPCLR   IO
.
          IF        VSTXUNIQ = 99
            GOTO      UPVCM999
          ENDIF
.
          GOTO      UPVCM210
.
UPVCM999  RETURN
.
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,ADMISSNO,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     ADMISSNO,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
.
.*******************************************************************************
.         Update preadmission details with booking details
.*******************************************************************************
UPADM000  READ      CONTROLF,HUND14;*86,PTCNUBAP
.
          MATCH     "1",PTCNUBAP              * update both pread to booking
          IF        !@EQUAL
            MATCH     "2",PTCNUBAP            * update booking to preadmission
            IF        !@EQUAL
              MATCH     "4",PTCNUBAP          * Update Both, no diagnosis
              IF        !@EQUAL
                MATCH     "5",PTCNUBAP        * Upd Both, no diagnosis/procedure
                GOTO      UPADM999 IF NOT EQUAL
              ELSE
                MOVE      SP70,ADIAG1
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPADM999
.
          COMPARE   ONE,ASTAT
          GOTO      UPADM999 IF NOT EQUAL
.
          MATCH     Z70,BKREC002
          IF        !@EQUAL
            PACK      ADOCTA,BKREADOC,SP70
          ENDIF
.
          MATCH     Z70,BKREC003
          IF        !@EQUAL
            PACK      ADOCTR,BKRESDOC,SP70
          ENDIF
.
          MATCH     Z70,BKREC020
          IF        !@EQUAL
            PACK      ATYPE,BKREATYP,SP70
          ENDIF
.
          MATCH     Z70,BKREC019
          IF        !@EQUAL
.           MATCH     "1",FIRSTBOK
.           IF        @EQUAL
              PACK      ACLSS,BKRECLSS,SP70
.           ELSE
.             PACK      ACLSS,OPDAATYP,SP70
.           ENDIF
          ENDIF
.
          MATCH     Z70,BKREC028
          IF        !@EQUAL
            PACK      ACARE,BKREEATY,SP70
          ENDIF
.
          MATCH     Z70,BKREC021
          IF        !@EQUAL
            PACK      ACLSSFT,BKREDEPT,SP70
          ENDIF
.
          MATCH     Z70,BKREC023
          IF        !@EQUAL
            PACK      ACLAIM,BKRECLMT,SP70
          ENDIF
.
          MATCH     Z70,PATCLAIM
          IF        !@EQUAL
.           MATCH     "1",FIRSTBOK
.           IF        @EQUAL
              IF        PROCFLAG=0
                PACK      ACLAIM,PATCLAIM,SP70
              ENDIF
.           ELSE
.             PACK      ACLAIM,OPDACTYP,SP70
.           ENDIF
          ENDIF
.
          MATCH     Z70,BKREC033
          IF        !@EQUAL
            MOVE      DBKREELO,ASTAY
          ENDIF
.
          MATCH     Z70,BKREC031
          IF        !@EQUAL
            PACK      PTMIDOFR,BKREDOFR,SP70
          ENDIF
.
          MATCH     Z70,BKREC015
          IF        !@EQUAL
            PACK      PTMIXWRD,BKREWARD,SP70
          ENDIF
.
          MATCH     Z70,BKREC018
          IF        !@EQUAL
            PACK      PTMIEBED,BKREEBED,SP70
          ENDIF
.
          MATCH     Z70,BOKRX031
          IF        !@EQUAL
            PACK      ASRCE,BKRXASRC,SP70
          ENDIF
.
          MATCH     Z70,OPDEA037
          IF        !@EQUAL
            PACK      ASRCE,OPDAASRC,SP70
          ENDIF
.
          MATCH     Z70,BKREC036
          IF        !@EQUAL
            MATCH     "5",PTCNUBAP
            IF        !@EQUAL
              PACK      ADIAG1,BKDIDES1,SP70
            ENDIF
          ENDIF
.
.
          MATCH     Z70,OPERDES1
          IF        !@EQUAL
            BRANCH    PROCFLAG,UPADM200  * multiple theatre booking
            MATCH     "5",PTCNUBAP
            IF        !@EQUAL
              PACK      ADIAG1,OPERDES1,SP70
            ENDIF
          ENDIF
.
UPADM200  MATCH     Z70,BKREC037
          IF        !@EQUAL
            MATCH     "1",NOBKDES2
            IF        !@EQUAL
              MATCH     "5",PTCNUBAP
              IF        !@EQUAL
                PACK      ADIAG2,BKDIDES2,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERDES2
          IF        !@EQUAL
            MATCH     "1",NOBKDES2
            IF        !@EQUAL
              MATCH     "5",PTCNUBAP
              IF        !@EQUAL
                PACK      ADIAG2,BKDIDES2,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     Z70,BKREC035
          IF        !@EQUAL
            IF        PROCFLAG=0
              PACK      AMBS,BKDICODE,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV1
          IF        !@EQUAL
            IF        PROCFLAG=0
              PACK      AMBS,OPERPRV1,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,BOKRX002
          IF        !@EQUAL
            IF        PTCNDWAW=0
.             MATCH     "1",FIRSTBOK
.             IF        @EQUAL
                PACK      PTMIXWRD,BKRXPOWD,SP70
.             ELSE 
.               PACK      PTMIXWRD,OPDAPOWD,SP70
.             ENDIF
            ENDIF
          ENDIF
          CALL      UPMISS1
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPADM999
.
          MATCH     Z70,BKREC012
          IF        !@EQUAL
            PACK      PMVXPACC,BKREACCM,SP70
          ENDIF
.
          MATCH     Z70,BOKRX003
          IF        !@EQUAL
            PACK      PMVXAPWD,BKRXADWD,SP70
          ENDIF
.
          MATCH     Z70,BOKRX002
          IF        !@EQUAL
            PACK      PMVXPOWD,BKRXPOWD,SP70
            IF        PTCNDWAW=0
              PACK      PTMIXWRD,BKRXPOWD,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,BOKRX005
          IF        !@EQUAL
            PACK      PMVXPSTY,BKRXPSTY,SP70
          ENDIF
.
          MATCH     Z70,BOKRX020
          IF        !@EQUAL
            PACK      PMVXEDC1,BKRXEDC1,SP70
          ENDIF
.
          MATCH     Z70,BOKRX021
          IF        !@EQUAL
            PACK      PMVXEDC2,BKRXEDC2,SP70
          ENDIF
.
          MATCH     Z70,BOKRX022
          IF        !@EQUAL
            PACK      PMVXEDC3,BKRXEDC3,SP70
          ENDIF
.
          MATCH     Z70,BOKRX038
          IF        !@EQUAL
            PACK      PMVXPOBD,BKRXPOBD,SP70
          ENDIF
.
          CALL      UPPMVX11
.
UPADM999  RETURN
.
.------------------------------------------------------------
. Display the first, second, ... anaesthetist names
.------------------------------------------------------------
DANA0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      ZERO,LOOPCNTR
          MOVE      ZERO,FOUNDCNT
.
DANA1000  ADD       ONE,LOOPCNTR
          COMPARE   NINE,LOOPCNTR
          GOTO      DANA9999 IF EQUAL
.
          UNPACK    SP70,DIM3,DIM10
.
          LOAD      DIM3,LOOPCNTR,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4,OPSETYD5:
                            OPSETYD6,OPSETYD7,OPSETYD8
.
          LOAD      DIM10,LOOPCNTR,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4,OPSEDCC5:
                             OPSEDCC6,OPSEDCC7,OPSEDCC8
.
          MATCH     SP70,DIM3
          GOTO      DANA1000 IF EQUAL
.
          MATCH     SP70,DIM10
          GOTO      DANA1000 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,DIM3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DANA1000
.
          MATCH     ANSN,TCINDC1                 * Anaesthetist
          GOTO      DANA1000 IF NOT EQUAL
.
          ADD       ONE,FOUNDCNT
.
          COMPARE   F1,FOUNDCNT
          GOTO      DANA1000 IF NOT EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      DIM10,DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;DOCFNAME;
.
DANA9999  RETURN
.
.------------------------------------------------------------
. Display the first second, ... assistant names
.------------------------------------------------------------
DASS0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      ZERO,LOOPCNTR
          MOVE      ZERO,FOUNDCNT
.
DASS1000  ADD       ONE,LOOPCNTR
          COMPARE   NINE,LOOPCNTR
          GOTO      DASS9999 IF EQUAL
.
          UNPACK    SP70,DIM3,DIM10
.
          LOAD      DIM3,LOOPCNTR,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4,OPSETYD5:
                            OPSETYD6,OPSETYD7,OPSETYD8
.
          LOAD      DIM10,LOOPCNTR,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4,OPSEDCC5:
                             OPSEDCC6,OPSEDCC7,OPSEDCC8
.
          MATCH     SP70,DIM3
          GOTO      DASS1000 IF EQUAL
.
          MATCH     SP70,DIM10
          GOTO      DASS1000 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,DIM3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DASS1000
.
          MATCH     ANSA,TCINDC1                 * Assistant
          GOTO      DASS1000 IF NOT EQUAL
.
          ADD       ONE,FOUNDCNT
.
          COMPARE   F1,FOUNDCNT
          GOTO      DASS1000 IF NOT EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      DIM10,DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;DOCFNAME;
.
DASS9999  RETURN
.------------------------------------------------------------
. Get the name of the first assistant doctor
.------------------------------------------------------------
GASS0000  MOVE      SP70,ASSFNAME
          MOVE      ZERO,LOOPCNTR
.
GASS1000  ADD       ONE,LOOPCNTR
          COMPARE   NINE,LOOPCNTR
          GOTO      GASS9999 IF EQUAL
.
          UNPACK    SP70,DIM3,DIM10
.
          LOAD      DIM3,LOOPCNTR,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4,OPSETYD5:
                            OPSETYD6,OPSETYD7,OPSETYD8
.
          LOAD      DIM10,LOOPCNTR,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4,OPSEDCC5:
                             OPSEDCC6,OPSEDCC7,OPSEDCC8
.
          MATCH     SP70,DIM3
          GOTO      GASS1000 IF EQUAL
.
          MATCH     SP70,DIM10
          GOTO      GASS1000 IF EQUAL
.
          PACK      KEY5,ANSO,ANSP,DIM3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GASS1000
.
          MATCH     ANSA,TCINDC1                 * Assistant
          GOTO      GASS1000 IF NOT EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,DIM10,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      DIM10,DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      DOCFNAME,ASSFNAME
.
GASS9999  RETURN
+
.----------------------------------------------------------------------
. Update patmi1af and patvisaf for Eclipse OEC
.----------------------------------------------------------------------
UPMSEC00  PACK      KEY8,ADMISNUM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPMSEC10
          COMPARE   ONE,ASTAT
          GOTO      UPMSEC10 IF NOT EQUAL   * Not preadmission
.
          MATCH     Z70,PTMIS001
          IF        !@EQUAL
            MOVE      PTMIS001,ADATE
            REP       " 0",ADATE
          ENDIF
.
          MATCH     Z70,PTMIS002
          IF        !@EQUAL
            MOVE      PTMIS002,ATIME
          ENDIF
.
          MATCH     Z70,PTMIS013
          IF        !@EQUAL
            MOVE      PTMIS013,AFUNDH
          ENDIF
.
          MATCH     Z70,PTMIS014
          IF        !@EQUAL
            MOVE      PTMIS014,AFNDTB
          ENDIF
.
          MATCH     Z70,PTMIS015
          IF        !@EQUAL
            MOVE      PTMIS015,AFNDMM
          ENDIF
.
          MATCH     Z70,PTMIS020
          IF        !@EQUAL
            MOVE      PTMIS020,ADIAG1
          ENDIF
.
          MATCH     Z70,PTMIS027
          IF        !@EQUAL
            MOVE      PTMIS027,ACLAIM
          ENDIF
.
          MATCH     Z70,PTMIS030
          IF        !@EQUAL
            MOVE      PTMIS030,ASTAY
          ENDIF
.
          MATCH     Z70,OPERPRV1
          IF        !@EQUAL
            PACK      AMBS,OPERPRV1,SP70
          ENDIF
.
          CALL      UPMISS1
.
UPMSEC10  PACK      KEY8,ADMISNUM,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPMSEC99
.
          MATCH     Z70,PTMIS015
          IF        !@EQUAL
            MOVE      PTMIS015,PMVXFNDM
          ENDIF
.
          MATCH     Z70,PTVIS043
          IF        !@EQUAL
            MOVE      PTVIS043,PMVXIDUS
          ENDIF
.
          MATCH     Z70,PTVIS076
          IF        !@EQUAL
            MOVE      PTVIS076,PMVXUDIN
          ENDIF
.
          MOVE      "1",PMVXPOEC
.
          CALL      UPPMVX11
.
UPMSEC99  RETURN
+
.*******************************************************************************
.         Update Eligibility Details
.*******************************************************************************
UPELG000  MATCH     PTELG014,Z70
          IF        !@EQUAL
            MOVE      PTELG014,PTELSPEA
          ENDIF
.
          MATCH     PTELG033,Z70
          IF        !@EQUAL
            MOVE      PTELG033,PTELEADM
          ENDIF
.
UPELG999  RETURN
.*******************************************************************************
.        Get Next pmsoecaf report counter
.*******************************************************************************
GNXOEC00  MOVE      "  1",KEY3
          PACK      KEY11,ADMISNUM,Z70
          CALL      RSPMOEC1
          CALL      RPPMOEC1
          BRANCH    OVRCD,GNXOEC99
.
          MATCH     ADMISNUM,PMOEVISN
          GOTO      GNXOEC99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMOECNTR
          MOVE      PMOECNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
.
GNXOEC99  RETURN
.*******************************************************************************
.        Eclipse OEC
.*******************************************************************************
ECLOEC00    MATCH     "1",BOKRX039            * if oec indicator = 1
            IF        @EQUAL
              MOVE      ADMISNUM,KEY8
              CALL      RDPTELG1
              IF        OVRCD=1
                CALL      CLPATELG              * Write new patelgaf record
                CALL      UPELG000
                MOVE      ADMISNUM,PTELVISN
                CALL      WRPTELG1
              ELSE
                CALL      UPELG000
                CALL      UPPTELG1
              ENDIF
.
              MOVE      SP70,SAVFPRIM
              PACK      SAVFPRIM,AMBS,SP70       * save
.
.             MATCH     Z70,OPERPRV1
.             IF        !@EQUAL
.               MATCH     SP70,OPERPRV1
.               IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV1,AMBS
                  CALL      REQOEC00                 * OEC Request
                  CALL      REWOEC00
.               ENDIF
.             ENDIF
.
              MATCH     SP70,PTVIS111
              GOTO      ECLOEC50 IF EQUAL
              GOTO      ECLOEC50 IF EOS
.
              MATCH     Z70,PTVIS111
              GOTO      ECLOEC50 IF EQUAL
.
              GOTO      ECLOEC90
.
ECLOEC50      MATCH     Z70,OPERPRV2
              IF        !@EQUAL
                MATCH     SP70,OPERPRV2
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV2,AMBS
                 CALL      REQOEC00               * OEC Request
                 CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV3
              IF        !@EQUAL
                MATCH     SP70,OPERPRV3
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV3,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV4
              IF        !@EQUAL
                MATCH     SP70,OPERPRV4
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV4,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV5
              IF        !@EQUAL
                MATCH     SP70,OPERPRV5
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV5,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV6
              IF        !@EQUAL
                MATCH     SP70,OPERPRV6
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV6,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV7
              IF        !@EQUAL
                MATCH     SP70,OPERPRV7
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV7,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV8
              IF        !@EQUAL
                MATCH     SP70,OPERPRV8
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV8,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPRV9
              IF        !@EQUAL
                MATCH     SP70,OPERPRV9
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPRV9,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR10
              IF        !@EQUAL
                MATCH     SP70,OPERPR10
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR10,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR11
              IF        !@EQUAL
                MATCH     SP70,OPERPR11
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR11,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR12
              IF        !@EQUAL
                MATCH     SP70,OPERPR12
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR12,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR13
              IF        !@EQUAL
                MATCH     SP70,OPERPR13
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR13,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR14
              IF        !@EQUAL
                MATCH     SP70,OPERPR14
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR14,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
              MATCH     Z70,OPERPR15
              IF        !@EQUAL
                MATCH     SP70,OPERPR15
                IF        !@EQUAL & !@EOS
                  MOVE      OPERPR15,AMBS
                  CALL      REQOEC00               * OEC Request
                  CALL      REWOEC00
                ENDIF
              ENDIF
.
ECLOEC90      MOVE      SAVFPRIM,AMBS            * restore
.
            ENDIF
.
ECLOEC99  RETURN
+
.*******************************************************************************
.        Generate OEC Requests
.*******************************************************************************
REQOEC00      MATCH     "1",PTCNOECE
              GOTO      REQOEC99 IF EQUAL
.
              CALL      GNXOEC00
              CALL      CLPMSOEC              * Write new pmsoecaf record
              CALL      UPPMOC00
.
              MOVE      ADMISNUM,PMOEVISN
              MOVE      KEY3,PMOECNTR
              MOVE      " 0",PMOESTAT
              MOVE      URNUMBER,PMOEURNO
              MOVE      ADMISNUM,PMOEARID
              PACK      PMOEARID,PMOEARID,SP70
              LJUSTIFY  PMOEARID
              MOVE      SP70,PMOETRID
              CALL      IBACLOCK
              PACK      PMOERQDT,CCC,CYY,CMM,CDD
              REP       " 0",PMOERQDT
              MOVE      SP70,PMOEETYP
              MOVE      SP70,PMOEERRC
              MOVE      SP70,PMOEERRD
              PACK      PMOECDTE,CCC,CYY,CMM,CDD
              REP       " 0",PMOECDTE
              CLOCK     TIME,CTIMEIS
              MOVE      CTIMEIS,PMOECTIM
              MOVE      SP70,PMOEUDTE
              MOVE      SP70,PMOEUTIM
              MOVE      SP70,PMOEHOSP
              MOVE      SP70,PMOEELEG
.
              IF        IBCNMHOS=1
                PACK      KEY8,ADMISNUM,SP70     * Update pmsvx1af.pmvxpoec
                CALL      RDPMVX11               * OEC Consent
                IF        OVRCD=0
                  MOVE      PMVXMHOS,PMOEHOSP
                ENDIF
              ENDIF
.
              PACK      KEY11,ADMISNUM,KEY3,SP70
              CALL      RAPMOEC1
              IF        OVRCD=1
                CALL      WRPMOEC1
              ELSE
                GOTO      REQOEC00
              ENDIF
.
REQOEC40      MOVE      ONE,F2A
              MOVE      ONE,F2                * Write new pmsoesaf record
              WHILE     F2 <= 5
                CALL      CLPMSOES
                CALL      UPPMOS00
.
                MATCH     SP70,PMOSITEM
                GOTO      REQOEC60 IF EQUAL
                GOTO      REQOEC60 IF EOS
.
                MOVE      ADMISNUM,PMOSVISN
                MOVE      PMOECNTR,PMOSCNTR
                MOVE      F2A,PMOSSCNT
                PACK      PMOSSCNT,PMOSSCNT,SP70
                RJUSTIFY  PMOSSCNT
                CALL      IBACLOCK
                PACK      PMOSCDTE,CCC,CYY,CMM,CDD
                REP       " 0",PMOSCDTE
                CLOCK     TIME,CTIMEIS
                MOVE      CTIMEIS,PMOSCTIM
.
                PACK      KEY14,ADMISNUM,PMOSCNTR,PMOSSCNT,SP70
                CALL      RAPMOES1
                IF        OVRCD=1
                  CALL      WRPMOES1
                ELSE
                  CALL      UPPMOES1
                ENDIF
.
                ADD       ONE,F2A
REQOEC60        ADD       ONE,F2
              DO
.
.             MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
.             ADD       ONE,WARCOUNT
.             MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
              CALL      HOEC0000             * Write history record to
.                                            * pmselfaf (oec free format table)
.
REQOEC99  RETURN
.*******************************************************************************
.        Free Format Eclipse OEC for Medical Bookings
.*******************************************************************************
FOEC0000  MATCH     "1",PTCNOECE
          GOTO      FOEC9999 IF EQUAL
.
          CALL      CLPMSELF
.
          CALL      GELN0000           * Generate Eligibility Number
          BRANCH    EXIT,FOEC9999
.
          CALL      STEF0000
.
          PACK      KEY8,PMEFELGN,SP70
          CALL      RAPMELF1
          IF        OVRCD=0
            GOTO      FOEC9999
          ENDIF
.
          CALL      WRPMELF1
.
          CALL      CLPMSOEC
          CALL      SETOEC00
.
          PACK      KEY11,PMEFELGN,SP1,SP1,ONE,SP70
          CALL      RAPMOEC1
          IF        OVRCD=0
            GOTO      FOEC9999
          ENDIF
.
          CALL      WRPMOEC1
.
          CALL      SETOES00
.
FOEC9999  RETURN
+
.*******************************************************************************
.         Set up free format OEC fields
.*******************************************************************************
STEF0000  
.         MOVE      DBKREBOO,PMEFELGN
          MOVE      DBKREBOO,PMEFVISN
          MOVE      DIM3CNTR,PMEFCNTR
          MOVE      ZERO,PMEFFLAG
          PACK      PMEFSPAR,SP70,SP70
          MOVE      BKREURNO,PMEFURNO
          MOVE      FFOECIND,PMEFOECC
          MOVE      PTITL,PMEFTITL
          MOVE      PGNAME,PMEFFNAM
          MOVE      PSNAME,PMEFSNAM
          MOVE      SP70,PMEFHFGN
          MOVE      SP70,PMEFHFSN
          MOVE      PSEX,PMEFGEND
          MOVE      PBDATE,PMEFBDAT
          MOVE      BKREEDAT,PMEFEADT
.
          MATCH     SP70,PTELF011
          IF        !@EQUAL
            MOVE      PTELF011,PMEFISTY
          ENDIF
.
          MOVE      BKREELOS,PMEFPLOS
.
          MATCH     SP70,PTELF013
          IF        !@EQUAL
            MOVE      PTELF013,PMEFDINT
          ENDIF
.
          MATCH     SP70,PTELF014
          IF        !@EQUAL
            MOVE      PTELF014,PMEFPEAI
          ENDIF
.
          MATCH     SP70,PTELF015
          IF        !@EQUAL
            MOVE      PTELF015,PMEFEMAD
          ENDIF
.
          MATCH     SP70,PTELF016
          IF        !@EQUAL
            MOVE      PTELF016,PMEFPRIC
          ENDIF
.
          MATCH     SP70,DIM9PRIM
          IF        !@EQUAL
            MOVE      DIM9PRIM,PMEFPRIM
          ENDIF
.
          MOVE      BKRECLMT,PMEFCLTY
          MOVE      PFUNDH,PMEFHFND
          MOVE      PFNDTB,PMEFHFNT
          MOVE      PFNDMM,PMEFHFMN
          MOVE      BKDIDES1,PMEFDIAG
.
          MOVE      SP70,PMEFSRV1
          MATCH     SP70,PTELF023
          IF        !@EQUAL & !@EOS
            MOVE      PTELF023,PMEFSRV1
          ENDIF
.
          MOVE      SP70,PMEFSRV2
          MATCH     SP70,PTELF024
          IF        !@EQUAL & !@EOS
            MOVE      PTELF024,PMEFSRV2
          ENDIF
.
          MOVE      SP70,PMEFSRV3
          MATCH     SP70,PTELF025
          IF        !@EQUAL & !@EOS
            MOVE      PTELF025,PMEFSRV3
          ENDIF
.
          MOVE      SP70,PMEFSRV4
          MATCH     SP70,PTELF026
          IF        !@EQUAL & !@EOS
            MOVE      PTELF026,PMEFSRV4
          ENDIF
.
          MOVE      SP70,PMEFSRV5
          MATCH     SP70,PTELF027
          IF        !@EQUAL & !@EOS
            MOVE      PTELF027,PMEFSRV5
          ENDIF
.
          MOVE      WBSEUID,PMEFCUID
          CALL      IBACLOCK
          PACK      PMEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMEFCTIM
.
          MATCH     SP70,PTELF033
          IF        !@EQUAL
            MOVE      PTELF033,PMEFDVAN
          ENDIF
.
STEF9999  RETURN
+
.******************************************************************************
.        Set Parameters for Free Format OEC fields
.******************************************************************************
STELF000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STELF001,STELF002,STELF003,STELF004,STELF005,STELF006:
                       STELF007,STELF008,STELF009,STELF010,STELF011,STELF012:
                       STELF013,STELF014,STELF015,STELF016,STELF017,STELF018:
                       STELF019,STELF020,STELF021,STELF022,STELF023,STELF024:
                       STELF025,STELF026,STELF027,STELF028,STELF029,STELF030:
                       STELF031,STELF032,STELF033,STELF034
          GOTO      STELF999
.
STELF001  MOVE      QRYDATA,PTELF001
          GOTO      STELF999
.
STELF002  MOVE      QRYDATA,PTELF002
          GOTO      STELF999
.
STELF003  MOVE      QRYDATA,PTELF003
          GOTO      STELF999
.
STELF004  MOVE      QRYDATA,PTELF004
          GOTO      STELF999
.
STELF005  MOVE      QRYDATA,PTELF005
          GOTO      STELF999
.
STELF006  MOVE      QRYDATA,PTELF006
          GOTO      STELF999
.
STELF007  MOVE      QRYDATA,PTELF007
          GOTO      STELF999
.
STELF008  MOVE      QRYDATA,PTELF008
          GOTO      STELF999
.
STELF009  MOVE      QRYDATA,PTELF009
          GOTO      STELF999
.
STELF010  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STELF999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PTELF010,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PTELF010
          GOTO      STELF999
.
STELF011  MOVE      QRYDATA,PTELF011
          GOTO      STELF999
.
STELF012  MOVE      QRYDATA,PTELF012
          PACK      PTELF012,PTELF012,SP70
          RJUSTIFY  PTELF012
          GOTO      STELF999
.
STELF013  MOVE      QRYDATA,PTELF013
          GOTO      STELF999
.
STELF014  MOVE      QRYDATA,PTELF014
          GOTO      STELF999
.
STELF015  MOVE      QRYDATA,PTELF015
          GOTO      STELF999
.
STELF016  MOVE      QRYDATA,PTELF016
          GOTO      STELF999
.
STELF017  MOVE      QRYDATA,PTELF017
          GOTO      STELF999
.
STELF018  MOVE      QRYDATA,PTELF018
          GOTO      STELF999
.
STELF019  MOVE      QRYDATA,PTELF019
          GOTO      STELF999
.
STELF020  MOVE      QRYDATA,PTELF020
          GOTO      STELF999
.
STELF021  MOVE      QRYDATA,PTELF021
          GOTO      STELF999
.
STELF022  MOVE      QRYDATA,PTELF022
          GOTO      STELF999
.
STELF023  MOVE      QRYDATA,PTELF023
          GOTO      STELF999
.
STELF024  MOVE      QRYDATA,PTELF024
          GOTO      STELF999
.
STELF025  MOVE      QRYDATA,PTELF025
          GOTO      STELF999
.
STELF026  MOVE      QRYDATA,PTELF026
          GOTO      STELF999
.
STELF027  MOVE      QRYDATA,PTELF027
          GOTO      STELF999
.
STELF028  MOVE      QRYDATA,PTELF028
          PACK      PTELF028,PTELF028,SP70
          RJUSTIFY  PTELF028
          GOTO      STELF999
.
STELF029  MOVE      QRYDATA,PTELF029
          PACK      PTELF029,PTELF029,SP70
          RJUSTIFY  PTELF029
          GOTO      STELF999
.
STELF030  MOVE      QRYDATA,PTELF030
          PACK      PTELF030,PTELF030,SP70
          RJUSTIFY  PTELF030
          GOTO      STELF999
.
STELF031  MOVE      QRYDATA,PTELF031
          PACK      PTELF031,PTELF031,SP70
          RJUSTIFY  PTELF031
          GOTO      STELF999
.
STELF032  MOVE      QRYDATA,PTELF032
          PACK      PTELF032,PTELF032,SP70
          RJUSTIFY  PTELF032
          GOTO      STELF999
.
STELF033  MOVE      QRYDATA,PTELF033
          GOTO      STELF999
.
STELF034  MOVE      QRYDATA,PTELF034
          GOTO      STELF999
.
STELF999  RETURN
+
.*******************************************************************************
.        Set pmsoec variables
.*******************************************************************************
SETOEC00  
.         MOVE      PMEFELGN,PMOEVISN
          MOVE      PMEFELGN,PMOEELEG
          MOVE      PMEFVISN,PMOEVISN
          MOVE      DIM3CNTR,PMOECNTR
          MOVE      " 0",PMOESTAT
          MOVE      PMEFURNO,PMOEURNO
          MOVE      PMEFVISN,PMOEARID
          PACK      PMOEARID,PMOEARID,SP70
          LJUSTIFY  PMOEARID
          MOVE      SP70,PMOETRID
          CALL      IBACLOCK
          PACK      PMOERQDT,CCC,CYY,CMM,CDD
          REP       " 0",PMOERQDT
          MOVE      SP70,PMOEETYP
          MOVE      SP70,PMOEERRC
          PACK      PMOEERRD,SP70,SP70
          PACK      PMOECDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMOECDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMOECTIM
          MOVE      SP70,PMOEUDTE
          MOVE      SP70,PMOEUTIM
          MOVE      SP70,PMOEHOSP
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,PMOEHOSP
          ENDIF
.
          MOVE      SP70,PMOESPAR
.
SETOEC99  RETURN
+
.*******************************************************************************
.        Set pmsoes variables
.*******************************************************************************
SETOES00  MATCH     SP70,PMEFSRV1
          IF        !@EQUAL & !@EOS
            CALL      CLPMSOES
.           MOVE      PMEFELGN,PMOSVISN
            MOVE      PMEFVISN,PMOSVISN
            MOVE      DIM3CNTR,PMOSCNTR
            MOVE      "  1",PMOSSCNT
            MOVE      "6",PMOSRTYP
            MOVE      PMEFSRV1,PMOSITEM
.
            MOVE      "  1",PMOSQUAN
            MATCH     SP70,PTELF028
            IF        !@EQUAL
              MOVE      PTELF028,PMOSQUAN
            ENDIF
.
            MOVE      PMEFEADT,PMOSPDTE
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
            MOVE      SP70,PMOSSPAR
.
            PACK      KEY14,PMOSVISN,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,PMEFSRV2
          IF        !@EQUAL & !@EOS
            CALL      CLPMSOES
.           MOVE      PMEFELGN,PMOSVISN
            MOVE      PMEFVISN,PMOSVISN
            MOVE      DIM3CNTR,PMOSCNTR
            MOVE      "  2",PMOSSCNT
            MOVE      "6",PMOSRTYP
            MOVE      PMEFSRV2,PMOSITEM
.
            MOVE      "  1",PMOSQUAN
            MATCH     SP70,PTELF029
            IF        !@EQUAL
              MOVE      PTELF029,PMOSQUAN
            ENDIF
.
            MOVE      PMEFEADT,PMOSPDTE
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
            MOVE      SP70,PMOSSPAR
.
            PACK      KEY14,PMOSVISN,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,PMEFSRV3
          IF        !@EQUAL & !@EOS
            CALL      CLPMSOES
.           MOVE      PMEFELGN,PMOSVISN
            MOVE      PMEFVISN,PMOSVISN
            MOVE      DIM3CNTR,PMOSCNTR
            MOVE      "  3",PMOSSCNT
            MOVE      "6",PMOSRTYP
            MOVE      PMEFSRV3,PMOSITEM
.
            MOVE      "  1",PMOSQUAN
            MATCH     SP70,PTELF030
            IF        !@EQUAL
              MOVE      PTELF030,PMOSQUAN
            ENDIF
.
            MOVE      PMEFEADT,PMOSPDTE
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
            MOVE      SP70,PMOSSPAR
.
            PACK      KEY14,PMOSVISN,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,PMEFSRV4
          IF        !@EQUAL & !@EOS
            CALL      CLPMSOES
.           MOVE      PMEFELGN,PMOSVISN
            MOVE      PMEFVISN,PMOSVISN
            MOVE      DIM3CNTR,PMOSCNTR
            MOVE      "  4",PMOSSCNT
            MOVE      "6",PMOSRTYP
            MOVE      PMEFSRV4,PMOSITEM
.
            MOVE      "  1",PMOSQUAN
            MATCH     SP70,PTELF031
            IF        !@EQUAL
              MOVE      PTELF031,PMOSQUAN
            ENDIF
.
            MOVE      PMEFEADT,PMOSPDTE
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
            MOVE      SP70,PMOSSPAR
.
            PACK      KEY14,PMOSVISN,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,PMEFSRV5
          IF        !@EQUAL & !@EOS
            CALL      CLPMSOES
.           MOVE      PMEFELGN,PMOSVISN
            MOVE      PMEFVISN,PMOSVISN
            MOVE      DIM3CNTR,PMOSCNTR
            MOVE      "  5",PMOSSCNT
            MOVE      "6",PMOSRTYP
            MOVE      PMEFSRV5,PMOSITEM
.
            MOVE      "  1",PMOSQUAN
            MATCH     SP70,PTELF032
            IF        !@EQUAL
              MOVE      PTELF032,PMOSQUAN
            ENDIF
.
            MOVE      PMEFEADT,PMOSPDTE
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
            MOVE      SP70,PMOSSPAR
.
            PACK      KEY14,PMOSVISN,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ENDIF
          ENDIF
.
SETOES99  RETURN
+
.*******************************************************************************
.        Ward selection list (called by WTTX0000)
.*******************************************************************************
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.------------------------------------------------------------
. Update data integrity audit for reason for schedule
. admission date change
.------------------------------------------------------------
WCHA0000  MATCH     SP70,WMURNO
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     SP70,WMCODE
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     Z70,UPDFLD06
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     SP70,UPDFLD06
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     Z70,REASFC06
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     SP70,REASFC06
          GOTO      WCHA9999 IF EQUAL
.
          MATCH     ORIGCANC,OPDACANC            * No change in cancellation
          GOTO      WCHA9999 IF EQUAL            * reason
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD06,SP70
          PACK      WTCHREAS,REASFC06,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,ORIGCANC
          PACK      WTCHCVAL,OPDACANC
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WCHA9999  RETURN
.
.------------------------------------------------------------
. Update data integrity audit for schedule
. admission date change
.------------------------------------------------------------
WCHB0000  MATCH     SP70,WMURNO
          GOTO      WCHB9999 IF EQUAL
.
          MATCH     Z70,UPDFLD08
          GOTO      WCHB9999 IF EQUAL
.
          MATCH     SP70,UPDFLD08
          GOTO      WCHB9999 IF EQUAL
.
          MATCH     Z70,REASFC08
          GOTO      WCHB9999 IF EQUAL
.
          MATCH     SP70,REASFC08
          GOTO      WCHB9999 IF EQUAL
.
          MATCH     ORIGEDAT,BKREEDAT            * No change in cancellation
          GOTO      WCHB9999 IF EQUAL            * reason
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD08,SP70
          PACK      WTCHREAS,REASFC08,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,ORIGEDAT
          PACK      WTCHCVAL,BKREEDAT
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WCHB9999  RETURN
.
.------------------------------------------------------------
. Write  data integrity audit when merging a booking for edward
.------------------------------------------------------------
WCHC0000  MATCH     SP70,WMURNO
          GOTO      WCHC9999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,ZERO,NINE,SP70
          PACK      WTCHREAS,PRGID,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SAVEBOOK,SP70
          PACK      WTCHCVAL,WMBOOK,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WCHC9999  RETURN
.
.------------------------------------------------------------
. Check if this patient has a EMR Visit  1=visit 0=no visit
.------------------------------------------------------------
UNEMR000  MATCH     "Y",PREAD002                 * Cancel pre admission
          GOTO      UNEMR999 IF NOT EQUAL
.
          PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
UNEMR100  CALL      RPEMVIS3
          BRANCH    OVRCD,UNEMR999
.
          MATCH     URNUMBER,EMVIURNO  * See if its the right patient
          GOTO      UNEMR999 IF NOT EQUAL
.
          MATCH     EMVIPADM,ADMISSNO
          GOTO      UNEMR100 IF NOT EQUAL
.
          MOVE      SP70,EMVIPADM
          MOVE      SP70,EMVIEWRD
          CALL      UPEMVIS3
.
UNEMR999  RETURN
+
.------------------------------------------------------------
. Get other hospital visit details
.------------------------------------------------------------
OHVIS000  PACK      KEY31,INVADMNO,SP70
          CALL      RSOPDEA2
OHVIS150  CALL      RKOPDEA2
          BRANCH    OVRCD,OHVIS999
.
          MATCH     INVADMNO,OPDAADMN
          GOTO      OHVIS999 IF NOT EQUAL
.
          PACK      CASEUNIQ,OPDAUNIQ,SP70
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,OHVIS999
          CALL      RDBKRX11
          BRANCH    OVRCD,OHVIS999
.
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      KEY3,PTWDHOSN,SP70
            CALL      RDPTHSP1
            IF        OVRCD<>1
              PACK      VISDHOSP,PTHSNAME,SP70
            ENDIF
          ENDIF
.
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS999
          RETURN
+
.------------------------------------------------------------
. Case Details by Theatre Session
.------------------------------------------------------------
CASS0000  PACK      KEY26,SESSKEYS,SP70
          CALL      RSOPDEA1
CASS2000  CALL      RKOPDEA1
          BRANCH    OVRCD,CASS9000
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     KEY22,SESSKEYS
          GOTO      CASS9000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASS2000 IF EQUAL   * Ignore Cancelled
.
          MOVE      OPDAADMN,ADMISSNO
          CALL      CASDET00
.
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OADESC
.
          CALL      GETDET00
.
          WRITE     HTMLFILE;"t.addRow(":
                    QUOTE,AURNO,QUOTE,COMMA:                * 0 - patient UR
                    QUOTE,OPDAADMN,QUOTE,COMMA:             * 1 - patient admission
                    QUOTE,KEY3,QUOTE,COMMA:                 * 2 - patient folder indicator
                    QUOTE,FORMATNM,QUOTE,COMMA:             * 3 - patient formated name
                    QUOTE,OPDADATE,QUOTE,COMMA:             * 4 - theatre date
                    QUOTE,OPDATIME,QUOTE,COMMA:             * 5 - theatre time
                    QUOTE,OPDACLIN,QUOTE,COMMA:             * 6 - clinic
                    QUOTE,DOPDASTA,QUOTE,COMMA:             * 7 - theatre status
                    QUOTE,OPDACASE,QUOTE,COMMA:             * 8 - theate case id
                    QUOTE,OPDADES1,SP1,QUOTE,COMMA:         * 9 - Operation desc. line  1
                    QUOTE,OPDADES2,SP1,QUOTE,COMMA:         * 10 - Operation desc. line 2
                    QUOTE,OPDADES3,SP1,QUOTE,COMMA:         * 11 - Operation desc. line 3
                    QUOTE,OPDACOMM,QUOTE,COMMA:             * 12 - Comments
                    QUOTE,SURFNAME,QUOTE,COMMA:             * 13 - doctor name
                    QUOTE,ANAFNAME,QUOTE,COMMA:             * 14 - anaesthetist
                    QUOTE,AWARD,QUOTE,COMMA:                * 15 - ward
                    QUOTE,ABED,QUOTE,COMMA:                 * 16 - bed
                    QUOTE,OADESC,QUOTE,COMMA:                         * 17 - CAT OA desc.
                    QUOTE,OPDADATE,OPDATIME,OPDACASE,QUOTE,COMMA:     * 18 - casekey - not used
                    QUOTE,OPDADATE,OPDATIME,OPDACASE,QUOTE,");"       * 19 - casekey
          GOTO      CASS2000
.
CASS9000  RETURN
.------------------------------------------------------------
. Get patient Infomation
.------------------------------------------------------------
GETDET00  UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
.
          CLEAR     KEY3
          PACK      KEY5,CATFS,PMPXFLDR,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            REP       " 0",TCINDC1
            APPEND    TCINDC1,KEY3
          ELSE
            APPEND    ZERO,KEY3
          ENDIF
.
          PACK      KEY5,CATT,PTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            REP       " 0",TCINDC1
            APPEND    TCINDC1,KEY3
          ELSE
            APPEND    ZERO,KEY3
          ENDIF
.
          PACK      KEY5,CATPV,PMPXPRVI,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            REP       " 0",TCINDC1
            APPEND    TCINDC1,KEY3
          ELSE
            APPEND    ZERO,KEY3
          ENDIF
          RESET     KEY3
          RETURN
.
.------------------------------------------------------------
. Theatre Bookings Requests
.------------------------------------------------------------
THRQ0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      THRQ5000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      THRQ1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      THRQ2000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      THRQ3000 IF EQUAL
.
          MATCH     "L",UPDTTYPE            * Allocate UR formaction
          GOTO      THRQ4000 IF EQUAL
.
          GOTO      THRQ9000
.
.         ************ ADD FORMACTION ***********
.
THRQ1000  CALL      GUTRN000
          BRANCH    EXIT,THRQ9300
.
          MATCH     SP70,URNUMBER
          IF        !@EQUAL & !@EOS
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,THRQ9200
.
            PACK      KEY8,URNUMBER,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,THRQ9200
.
            MOVE      PSNAME,BKREQ008
            MOVE      PGNAME,BKREQ009
            MOVE      PBDATE,BKREQ010
            MOVE      PSEX,BKREQ011
.
          ENDIF
.
          MOVE      WBSEUID,BKREQ037
.
          CALL      IBACLOCK
          PACK      BKREQ035,CCC,CYY,CMM,CDD
          REP       " 0",BKREQ035
          CLOCK     TIME,BKREQ036
.
          MOVE      URNUMBER,BKREQ001
          MOVE      BKRQREQN,BKREQ004
          MOVE      ZERO,BKREQ005
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,BKREQ006
          ENDIF
.
          CALL      CLBOKRQ1
          CALL      MVBOKREQ
.
          PACK      KEY10,BKRQREQN,SP70
          CALL      RABKRQ11
          IF        OVRCD=0
            GOTO      THRQ9999
          ENDIF
.
          CALL      WRBKRQ11
.
          CALL      UPCMR000
.
          CALL      CLBOKRAU
          MOVE      ONE,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      THRQ9999
.
.         ************ UPDATE FORMACTION **********
.
THRQ2000  PACK      KEY10,REQUESTN,SP70
          CALL      RDBKRQ11
          BRANCH    OVRCD,THRQ9500
.
          MOVE      WBSEUID,BKREQ040
.
          CALL      IBACLOCK
          PACK      BKREQ038,CCC,CYY,CMM,CDD
          REP       " 0",BKREQ038
          CLOCK     TIME,BKREQ039
.
          MOVE      SP70,DIM1
          PACK      KEY5,CATrp,BKREQ007,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      DIM1,TCINDC2,SP70
          ENDIF
.
          MOVE      SP70,DIM1A
          PACK      KEY5,CATrp,BKRQPRIO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      DIM1A,TCINDC2,SP70
          ENDIF
.
          MATCH     SP70,DIM1
          GOTO      THRQ2100 IF EQUAL
          GOTO      THRQ2100 IF EOS
.
          MATCH     SP70,DIM1A
          GOTO      THRQ2100 IF EQUAL
          GOTO      THRQ2100 IF EOS
.
          MOVE      SP70,CLCKSIND
          MATCH     DIM1A,DIM1
          IF        @LESS
            CALL      IBACLOCK
            PACK      BKREQ014,CCC,CYY,CMM,CDD
            REP       " 0",BKREQ014
            CLOCK     TIME,BKREQ015
            REP       " 0",BKREQ015
            MOVE      "1",CLCKSIND
          ENDIF
.
THRQ2100  CALL      MVBOKREQ
.
          PACK      KEY10,BKRQREQN,SP70
          CALL      RABKRQ11
          IF        OVRCD=1
            GOTO      THRQ9999
          ENDIF
.
          CALL      UPBKRQ11
.
          CALL      UPCMR000
.
          CALL      CLBOKRAU
          MOVE      TWO,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
          MATCH     "1",CLCKSIND
          IF        @EQUAL
            CALL      CLBOKRAU
            MOVE      SEVEN,BKRUAUTY
            CALL      MVBOKRAU
.
            PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
            CALL      RABKRAU1
            IF        OVRCD=1
              CALL      WRBKRAU1
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      THRQ9999
.
.         ************ DELETE FORMACTION **********
.
THRQ3000  PACK      KEY10,REQUESTN,SP70
          CALL      RDBKRQ11
          IF        OVRCD=1
            GOTO      THRQ9999
          ENDIF
.
          MOVE      TWO,BKRQSTAT
          MOVE      BKREQ044,BKRQCNCD
          MOVE      WBSEUID,BKRQCNUS
          CALL      IBACLOCK
          PACK      BKRQCNDT,CCC,CYY,CMM,CDD
          REP       " 0",BKRQCNDT
          MOVE      CTIMEIS,BKRQCNTM
.
          CALL      UPBKRQ11
.
          CALL      CLBOKRAU
          MOVE      THREE,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      THRQ9999
.
.         ************ ALLOCATE UR FORMACTION **********
.
THRQ4000  PACK      KEY10,BKREQ004,SP70
          CALL      RDBKRQ11
          IF        OVRCD=1
            GOTO      THRQ9999
          ENDIF
.
          PACK      KEY8,BKREQ001,SP70
          CALL      RDMAST1
          IF        OVRCD=0
            MOVE      PSEX,BKRQGEND
            MOVE      PBDATE,BKRQBDAT
          ENDIF
.
          MOVE      BKREQ001,BKRQURNO
          MOVE      WBSEUID,BKRQUUSR
          CALL      IBACLOCK
          PACK      BKRQUDAT,CCC,CYY,CMM,CDD
          REP       " 0",BKRQUDAT
          MOVE      CTIMEIS,BKRQUTIM
.
          CALL      UPBKRQ11
.
          CALL      CLBOKRAU
          MOVE      SIX,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      THRQ9999
.
.         ************ DISPLAY FORMACTION **********
.
THRQ5000  MATCH     SP70,URNUMBER
          IF        !@EQUAL & !@EOS
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,THRQ9200
.
            PACK      KEY8,URNUMBER,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,THRQ9200
.
.           IF        PCEASE=1
.             GOTO      THRQ9800
.           ENDIF
          ENDIF
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            IF        OVRCD=1
              CALL      CLPATMIS
            ENDIF
          ENDIF
.
          MATCH     SP70,AUDTREQN
          IF        !@EQUAL
            PACK      KEY27,AUDTREQN,SP70
            CALL      RDBKRAU1
            IF        OVRCD=1
              GOTO      THRQ9400
            ENDIF
          ENDIF
.
          CALL      CLBOKRQ1
          MATCH     SP70,REQUESTN
          IF        !@EQUAL
            PACK      KEY10,REQUESTN,SP70
            CALL      RDBKRQ11
            IF        OVRCD=1
              CALL      CLBOKRQ1
            ENDIF
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00
.
          CLEAR     WEBTITLE
          MOVE      "Theatre Bookings Requests",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,THRQ9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9200  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9300  MOVE      "CONTACT CSC Healthcare - unique booking request number allocation full.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9400  MOVE      "Audit Details Not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9500  MOVE      "Theatre Request Record Not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9800  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      THRQ9999
.
THRQ9999  RETURN
.
.------------------------------------------------------------
. Update Comments for Theatre Requests
.------------------------------------------------------------
UPCMR000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPCOMFIL,OPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMR999
.
UPCMR100  READ      OPCOMFIL,SEQ;OPCOMLIN
          GOTO      UPCMR999 IF OVER
          MATCH     "%START:",OPCOMLIN
          IF        @EQUAL
            UNPACK    OPCOMLIN,KEY7,OPCOMTYP
            CALL      CLCMR000
            MOVE      ZERO,OPCOMCNT
            GOTO      UPCMR100
          ENDIF
UPCMR110  ADD       ONE,OPCOMCNT
          PACK      KEY16,BKRQREQN,OPCOMTYP,OPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMR110 IF EQUAL
.
          MOVE      OPCOMLIN,OPDDDATA
          MATCH     SP70,OPDDDATA
          GOTO      UPCMR100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMR100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMR100
.
UPCMR999  RETURN
.
.------------------------------------------------------------
. Theatre Session Case List Header with Requests
.------------------------------------------------------------
CSTBHD00  MOVE      SP70,EMRSTYPE
          MATCH     SP70,OPSESTYP
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANST,ANSU,OPSESTYP
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,EMRSTYPE
            ENDIF
          ENDIF
.
          MOVE      SP70,DESCUC03                * Bay
          PACK      KEY5,CATOC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TDESC,DESCUC03
          ENDIF
.
          MATCH     ANSE,EMRSTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center>Priority</td>":
                               "<td class=HeadingCell align=center width='5%'>Time</td>":
                             "<td class=HeadingCell align=center>Duration</td>":
                               "<td class=HeadingCell>Name</td>";
            IF        SHOWPLOS=1
              WRITE     HTMLFILE;"<td class=HeadingCell>LOS</td>";
            ENDIF
         
            WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>":
                              "<td class=HeadingCell>Adm No</td>";
            IF        SHOOPDES=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell>Operation Description</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Operation</td>";
            ENDIF
. 
            WRITE     HTMLFILE;"<td class=HeadingCell>Anaesthetic Type</td>":
                               "<td class=HeadingCell>Usage</td>":
                               "<td class=HeadingCell>Theatre</td>";
.
            IF        SHOWSURG=1
              WRITE     HTMLFILE;"<td class=HeadingCell>Surgeon</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell>Case No</td>";
.
            IF        SHOCNSNT=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell>Consent Obtained/Stat</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Consent Obtained/Status</td>";
            ENDIF

            WRITE     HTMLFILE;"<td class=HeadingCell>Request Time/<br>Clock Start Time</td>":
                               "<td class=HeadingCell>Wait</td>";
          ELSE
            IF        SHOWPLOS=1
              WRITE   HTMLFILE;"<tr>":
                               "<td class=HeadingCell align=center>Time</td>":
                             "<td class=HeadingCell align=center>Duration</td>":
                               "<td class=HeadingCell>Name</td>":
                               "<td class=HeadingCell>LOS</td>":
                               "<td class=HeadingCell>Alerts</td>":
                               "<td class=HeadingCell>Adm No</td>":
                               "<td class=HeadingCell>Operation</td>":
                               "<td class=HeadingCell>Anaesthetic Type</td>":
                               "<td class=HeadingCell>Usage</td>":
                               "<td class=HeadingCell>Theatre</td>";
.
              IF        SHOWSURG=1
                WRITE     HTMLFILE;"<td class=HeadingCell>Surgeon</td>";
              ENDIF
.
              WRITE   HTMLFILE;"<td class=HeadingCell>Case No</td>":
                               "<td class=HeadingCell>Status</td>";
            ELSE
              WRITE  HTMLFILE;"<tr>":
                               "<td class=HeadingCell align=center>Time</td>":
                             "<td class=HeadingCell align=center>Duration</td>":
                               "<td class=HeadingCell>Name</td>":
                               "<td class=HeadingCell>Alerts</td>":
                               "<td class=HeadingCell>Adm No</td>":
                               "<td class=HeadingCell>Operation</td>":
                               "<td class=HeadingCell>Anaesthetic Type</td>":
                               "<td class=HeadingCell>Usage</td>":
                               "<td class=HeadingCell>Theatre</td>";
.
              IF        SHOWSURG=1
                WRITE     HTMLFILE;"<td class=HeadingCell>Surgeon</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td class=HeadingCell>Case No</td>":
                                 "<td class=HeadingCell>Status</td>";
            ENDIF
          ENDIF  
.

          IF        SHOWRBAY=1
            WRITE     HTMLFILE;"<td class=HeadingCell>",DESCUC03,"</td>";
          ENDIF
.
          IF        SHOWBLRQ=1
            WRITE     HTMLFILE;"<td class=HeadingCell>Print</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
CSTBHD99  RETURN
.------------------------------------------------------------
. Clear Comments
.------------------------------------------------------------
CLCMR000  PACK      KEY16,BKRQREQN,OPCOMTYP,SP70
          CALL      RSOPDED1
CLCMR100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCMR999
          MATCH     OPDDUNIQ,BKRQREQN
          GOTO      CLCMR999 IF NOT EQUAL
          MATCH     OPDDTYPE,OPCOMTYP
          GOTO      CLCMR999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCMR100
CLCMR999  RETURN
.------------------------------------------------------------
. Update Request File with Visit details if not yet linked
.------------------------------------------------------------
UPRQ1000  REP       "+ ",REQUESTN
          MATCH     SP70,REQUESTN
          GOTO      UPRQ1999 IF EQUAL
.
          PACK      KEY10,REQUESTN,SP70
          CALL      RDBKRQ11
          BRANCH    OVRCD,UPRQ1999
.
          MOVE      ONE,BKRQSTAT
.
          MATCH     SP70,BKRQVISN
          GOTO      UPRQ1500 IF NOT EQUAL 
.
          MOVE      BKREBOOK,BKRQVISN
.
          MATCH     SP70,BKRQELOS
          IF        @EQUAL
            MOVE      BKREELOS,BKRQELOS
          ENDIF
.
          MATCH     SP70,BKRQCTYP
          IF        @EQUAL
            MOVE      BKRECLMT,BKRQCTYP
          ENDIF
.
          MATCH     SP70,BKRQADPT
          IF        @EQUAL
            MOVE      BKRXADWD,BKRQADPT
          ENDIF
.
          MATCH     SP70,BKRQEPOW
          IF        @EQUAL
            MOVE      BKRXPOWD,BKRQEPOW
          ENDIF
.
          MATCH     SP70,BKRQASRC
          IF        @EQUAL
            MOVE      BKRXASRC,BKRQASRC
          ENDIF
.
          MATCH     SP70,BKRQATYP
          IF        @EQUAL
            MOVE      BKREATYP,BKRQATYP
          ENDIF
.
          MATCH     SP70,BKRQMBS1
          IF        @EQUAL
            MOVE      OPERPRV1,BKRQMBS1
          ENDIF
.
          MATCH     SP70,BKRQMBS2
          IF        @EQUAL
            MOVE      OPERPRV2,BKRQMBS2
          ENDIF
.
          MATCH     SP70,BKRQMBS3
          IF        @EQUAL
            MOVE      OPERPRV3,BKRQMBS3
          ENDIF
.
          MATCH     SP70,BKRQMBD1
          IF        @EQUAL
            MOVE      BKRXUFF1,BKRQMBD1
          ENDIF
.
          MATCH     SP70,BKRQMBD2
          IF        @EQUAL
            MOVE      BKRXUFF2,BKRQMBD2
          ENDIF
.
          MATCH     SP70,BKRQMBD3
          IF        @EQUAL
            MOVE      BKRXUFF3,BKRQMBD3
          ENDIF
.
          MATCH     SP70,BKRQANAE
          IF        @EQUAL
            MOVE      OPDAANAE,BKRQANAE
          ENDIF
.
          MATCH     SP70,BKRQPROR
          IF        @EQUAL
            MOVE      OPDACOMM,BKRQPROR
          ENDIF
.
          MATCH     SP70,BKRQINFC
          IF        @EQUAL
            MOVE      OPDAKNOW,BKRQINFC
          ENDIF
.
          MATCH     SP70,BKRQDURA
          IF        @EQUAL
            MOVE      OPDAEXPD,F3
            MOVE      F3,BKRQDURA 
          ENDIF
.
          MATCH     SP70,BKRQEQU1
          IF        @EQUAL
            MOVE      OPDAEQR1,BKRQEQU1
          ENDIF
.
          MATCH     SP70,BKRQEQU2
          IF        @EQUAL
            MOVE      OPDAEQR2,BKRQEQU2
          ENDIF
.
          MATCH     SP70,BKRQEQU3
          IF        @EQUAL
            MOVE      OPDAEQR3,BKRQEQU3
          ENDIF
.
          MATCH     SP70,BKRQCSNT
          IF        @EQUAL
            MOVE      OPDACSST,BKRQCSNT
          ENDIF
.
          MATCH     SP70,BKRQCCDT
          IF        @EQUAL
            MOVE      OPDACSDT,BKRQCCDT
          ENDIF
.
          CALL      UPRQC000
.
.
.          MATCH     SP70,BKRQPRIO
.          IF        !@EQUAL & !@EOS
.            PACK      KEY5,CATrp,BKRQPRIO
.            CALL      RDCODE1
.            IF        OVRCD=0
.              MATCH     SP70,TCINDC1
.              IF        @EQUAL
.                CALL      CSDTTM00
.              ENDIF
.              MATCH     ANSC,TCINDC1
.              IF        @EQUAL
.                CALL      CSDTTM00
.              ENDIF
.              MATCH     ANSB,TCINDC1
.              IF        @EQUAL
.                CALL      CLBOKRAU
.                MOVE      SEVEN,BKRUAUTY
.                CALL      MVBOKRAU
..
.                PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
.                CALL      RABKRAU1
.                IF        OVRCD=1
.                  CALL      WRBKRAU1
.                ENDIF
..
..               MOVE      OPDADATE,BKRQCSDT
..               PACK      BKRQCSTM,OPDAEXPS,COLON,ZERO,ZERO
..
.                CALL      IBACLOCK
.                PACK      BKRQCSDT,CCC,CYY,CMM,CDD
.                REP       " 0",BKRQCSDT
.                CLOCK     TIME,CTIMEIS
.                MOVE      CTIMEIS,BKRQCSTM
..
.              ENDIF
.              MATCH     ANSR,TCINDC1
.              IF        @EQUAL
.                MOVE      BKRQCDAT,BKRQCSDT
.                MOVE      BKRQCTIM,BKRQCSTM
.              ENDIF
.            ENDIF
.          ENDIF
.
UPRQ1500  CALL      UPBKRQ11
.
          CALL      CLBOKRAU
          MOVE      FOUR,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
UPRQ1999  RETURN
.
.-----------------------------------------------------------------------------
. Update theatre request comments
.-----------------------------------------------------------------------------
UPRQC000  MOVE      "012",DIM3
          PACK      KEY16,REQUESTN,DIM3,SP70
.
          CALL      RSOPDED1
          CALL      RKOPDED1
          BRANCH    OVRCD,UPRQC200
.
          MATCH     REQUESTN,OPDDUNIQ
          GOTO      UPRQC200 IF NOT EQUAL
          MATCH     DIM3,OPDDTYPE
          GOTO      UPRQC200 IF NOT EQUAL
.
          GOTO      UPRQC999
.
UPRQC200  PACK      KEY16,OPDAUNIQ,OPCOMTYP,SP70
          CALL      RSOPDED1
UPRQC300  CALL      RKOPDED1
          BRANCH    OVRCD,UPRQC999
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      OPCOMM99 IF NOT EQUAL
          MATCH     OPCOMTYP,OPDDTYPE
          GOTO      OPCOMM99 IF NOT EQUAL
.
          PACK      SAVKEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          MOVE      REQUESTN,OPDDUNIQ
          MOVE      DIM3,OPDDTYPE
. 
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70 
          CALL      WROPDED1
.
          MOVE      SAVKEY16,KEY16
          GOTO      UPRQC300
.
UPRQC999
.
.------------------------------------------------------------
. Get Clock Start Date/Time from Audit
.------------------------------------------------------------
CSDTTM00  PACK      KEY27,BKRQREQN,SP70
          CALL      RSBKRAU1
          CALL      RKBKRAU1
          BRANCH    OVRCD,CSDTTM99
.
          MATCH     BKRQREQN,BKRUAURQ
          GOTO      CSDTTM99 IF NOT EQUAL
.
          MATCH     "1",BKRUAUTY
          GOTO      CSDTTM99 IF NOT EQUAL
.
          MOVE      BKRUCSDT,BKRQCSDT
          MOVE      BKRUCSTM,BKRQCSTM
.
CSDTTM99  RETURN
+
.------------------------------------------------------------
. Merge Booking Theatre Requests
.------------------------------------------------------------
MRQ10000  MATCH     SP70,OPDAREQN
          GOTO      MRQ19999 IF EQUAL
          GOTO      MRQ19999 IF EOS
.
          PACK      KEY10,OPDAREQN,SP70
          CALL      RDBKRQ11
          BRANCH    OVRCD,MRQ19999
.
          MOVE      LINKVIST,BKRQVISN
.
          CALL      UPBKRQ11
.
          CALL      CLBOKRAU
          MOVE      TWO,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
MRQ19999  RETURN
.
.-------------------------------------------------------------
. Write OEC History Record to pmselfaf (OEC Free Format table)
.-------------------------------------------------------------
HOEC0000  PACK      KEY8,PMOEURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CLPMSELF
.
          PACK      SAVKEY11,PMOEVISN,PMOECNTR,SP70
.
HOEC1000  CALL      GELN0000           * Generate Eligibility Number
          BRANCH    EXIT,HOEC9999
.
          MOVE      SAVKEY11,KEY11
          CALL      RDPMOEC1
.
          MOVE      PMOEURNO,PMEFURNO
          MOVE      ZERO,PMEFOECC
          MOVE      PTITL,PMEFTITL
          PACK      PMEFFNAM,PMPXFNAM,SP70
          PACK      PMEFSNAM,PTMASNAM,SP70
          MOVE      SP70,PMEFHFGN
          MOVE      SP70,PMEFHFSN
          MOVE      PSEX,PMEFGEND
          MOVE      PBDATE,PMEFBDAT
          MOVE      ADATE,PMEFEADT
          MOVE      PMVXIDUS,PMEFISTY
          MOVE      ASTAY,PMEFPLOS
          MOVE      SP70,PMEFDINT
          MOVE      PTELSPEA,PMEFPEAI
          MOVE      PTELEADM,PMEFEMAD
          MOVE      PMVXPILC,PMEFPRIC
.
.         MOVE      AMBS,PMEFPRIM
          MOVE      SP70,PMEFPRIM
          MATCH     AMBS,Z70
          IF        !@EQUAL
            MOVE      AMBS,PMEFPRIM
          ENDIF
.
          MOVE      ACLAIM,PMEFCLTY
          MOVE      AFUNDH,PMEFHFND
          MOVE      AFNDTB,PMEFHFNT
          MOVE      AFNDMM,PMEFHFMN
          MOVE      ADIAG1,PMEFDIAG
.
          MOVE      SP70,PMEFSRV1
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,ONE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV1
          ENDIF
.
          MOVE      SP70,PMEFSRV2
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,TWO,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV2
          ENDIF
.
          MOVE      SP70,PMEFSRV3
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,THREE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV3
          ENDIF
.
          MOVE      SP70,PMEFSRV4
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,FOUR,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV4
          ENDIF
.
          MOVE      SP70,PMEFSRV5
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,FIVE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV5
          ENDIF
.
          MOVE      WBSEUID,PMEFCUID
          CALL      IBACLOCK
          PACK      PMEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMEFCTIM
.
          CALL      CONC0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      PMEFDVAN,SP20                * No
          ELSE
            MOVE      DIM20,PMEFDVAN               * yes
          ENDIF
.
          MOVE      PMOEVISN,PMEFVISN
          MOVE      PMOECNTR,PMEFCNTR
          MOVE      ZERO,PMEFFLAG
          PACK      PMEFSPAR,SP70,SP70
.
          PACK      KEY8,PMEFELGN,SP70
          CALL      RAPMELF1
          IF        OVRCD=0
            GOTO      HOEC1000
          ENDIF
.
          CALL      WRPMELF1
.
          PACK      KEY11,PMOEVISN,PMOECNTR,SP70
          CALL      RDPMOEC1
          IF        OVRCD=0
            MOVE      PMEFELGN,PMOEELEG
            CALL      UPPMOEC1
          ENDIF
.
HOEC9999  RETURN
.-----------------------------------------------------------
.        Generate Free Format OEC Eligibility Number
.-----------------------------------------------------------
GELN0000  MOVE      ZERO,EXIT
.
          MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*117,PTCNELGN
.
GELN0100  MOVE      PTCNELGN,PMEFELGN
          UNPACK    PTCNELGN,ANS,KEY7
          MATCH     "a",ANS
          GOTO      GELN1150 IF LESS
          MOVE      ZERO,F7
          MOVE      KEY7,F7
.
GELN1100  COMPARE   "9999999",F7               * at the end of the group
          GOTO      GELN1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GELN9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F7
.
GELN1110  ADD       ONE,F7
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          CALL      RDPMELF1
          IF        OVRCD=ONE
            PACK      KEY11,ANS,D7,SP1,SP1,ONE,SP70
            CALL      RDPMOEC1
            IF        OVRCD=ONE
              PACK      KEY14,ANS,D7,SP1,SP1,ONE,SP70
              CALL      RSPMOES1
              CALL      RKPMOES1
              BRANCH    OVRCD,GELN9500
.
              PACK      KEY8,ANS,D7,SP70
              MATCH     KEY8,PMOSVISN
              GOTO      GELN9500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      GELN1100
.
. no records
.
GELN1150  MOVE      ONE,F7
          MOVE      "a",ANS
.
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          GOTO      GELN9500
.
GELN9000  MOVE      ONE,EXIT                  * Passcode allocation full
          GOTO      GELN9999
.
GELN9500  MOVE      KEY8,PTCNELGN
          WRITAB    CONTROLF,HUND18;*117,PTCNELGN
.
          MATCH     "00000000",PMEFELGN
          GOTO      GELN0100 IF EQUAL
.
GELN9999  CALL      RELSLK00
          RETURN
+
.*****************************************************************************
.*                              CONC0000           Called by: WPAT0000       *
.*     See if the patient has concession card of DVA type on file            *
.* Requires: PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CONC0000  MOVE      SP70,DIM20
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CONC0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CONC9100               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CONC9100 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CONC0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CONC0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CONC0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card type ?
          GOTO      CONC0500 IF NOT EQUAL        * no - ignore record
.
.         A DVA concession card has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CONC1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      CONC9100 IF LESS             * no - nothing found
.
.         Concession card is current
.
CONC1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CONC9100 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,EXIT
          GOTO      CONC9999
.
CONC9100  MOVE      ONE,EXIT
.
CONC9999  RETURN
+
.-----------------------------------------------------------
.        Display Approved Theatre Requests
.-----------------------------------------------------------
APTHRQ00  CALL      CRTM2000
.
          PACK      KEY17,ANSA,SP70
          CALL      RSBKRQ15
APTHRQ10  CALL      RKBKRQ15
          BRANCH    OVRCD,APTHRQ50
.
          MATCH     ANSA,BKRQSTAT
          GOTO      APTHRQ50 IF NOT EQUAL
.
.         CALL      APTHRW00
          MOVE      BKRQPRIO,TMPFPRIO
          MOVE      BKRQCSDT,TMPFCSDT
          MOVE      BKRQCSTM,TMPFCSTM
          MOVE      BKRQREQN,TMPFREQN
.
          PACK      KEY30,TMPFPRIO,TMPFCSDT,TMPFCSTM,TMPFREQN,SP70
          CALL      RATMPRE2
          IF        OVRCD=1
            CALL      WRTMPRE2
          ENDIF
.
          GOTO      APTHRQ10
.
APTHRQ50  PACK      KEY30,SP70
          CALL      RSTMPRE2
APTHRQ60  CALL      RKTMPRE2
          BRANCH    OVRCD,APTHRQ90
.
          PACK      KEY10,TMPFREQN,SP70
          CALL      RDBKRQ11
          BRANCH    OVRCD,APTHRQ60
.
          CALL      APTHRW00
.
          GOTO      APTHRQ60
.
APTHRQ90  CALL      KTM20000
APTHRQ99  RETURN
.
.-----------------------------------------------------------
.        Display Approved Theatre Requests Row
.-----------------------------------------------------------
APTHRW00  WRITE     HTMLFILE;"<TR>";
.
          MOVE      SP70,PRIOASC1
          MOVE      SP70,PRIOASSN                                 * Get priority
          MOVE      SP70,PRIOHEQV
          MOVE      BKRQPRIO,PRIODESC
          MATCH     SP70,BKRQPRIO
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CATrp,BKRQPRIO,SP70
            CALL      RDCODE1
            IF        OVRCD=0
               ASSIGN    (TCFORM6*60),PRIOASSN                * Convert into min
               MOVE      PRIOASSN,PRIOASSD
               LJUSTIFY  PRIOASSD
               MOVE      THCSCOD,PRIOHEQV
               MOVE      PTCDASC1,PRIOASC1
            ENDIF
          ENDIF
.
          MATCH     SP70,PRIOASC1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<TD ALIGN=CENTER BGCOLOR='##",PRIOASC1,"'>";
          ELSE
            WRITE     HTMLFILE;"<TD ALIGN=CENTER>";
          ENDIF
.
          ADD       ONE,PRIOCNTR
          MOVE      PRIOCNTR,PRIOCNTD
          REP       " 0",PRIOCNTD
.
          MATCH     SP70,BKRQREQN
          IF        !@EQUAL & !@EOS
            REP       " +",BKRQREQN
            REP       " +",BKRQURNO
            REP       " +",BKRQVISN
.
            WRITE     HTMLFILE;PRIODESC:
                      "<A HREF=javascript:UpdateTheatreRequest('":
                      BKRQREQN,"','",BKRQURNO,"','",BKRQVISN,"')>":
                      "<img src=../images/EditIcon.gif hspace=4 ":
                      "border=0></a>":
                      "<input type=hidden":
                      " name=priod",PRIOCNTD," value='",PRIOASSD,"'>":
                      "<input type=hidden":
                      " name=priov",PRIOCNTD," value='",PRIOHEQV,"'>":
                      "<input type=hidden":
                      " name=pridt",PRIOCNTD," value='",BKRQCSDT,"'>":
                      "<input type=hidden":
                      " name=pritm",PRIOCNTD," value='",BKRQCSTM,"'>";
.
            REP       "+ ",BKRQREQN
            REP       "+ ",BKRQURNO
            REP       "+ ",BKRQVISN
.
            MOVE      SP70,THETCOMP
.           PACK      KEY10,OPDAUNIQ,SP70
.           CALL      RDOPARD1
.           IF        OVRCD=1
.             CALL      CLOPRARD
.           ENDIF
.
.           MOVE      ZERO,FORM2
.           MOVE      OPCNTRCS,FORM2
.
.           LOAD      THETCOMP,FORM2,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
.                                    OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
.                                    OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
.                                    OPARTIDP,OPARTETC
.
            WRITE     HTMLFILE;"<input type=hidden":
                      " name=pritc",PRIOCNTD," value='",THETCOMP,"'>";
.
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</TD>"
.
          WRITE     HTMLFILE;"<TD ALIGN=CENTER>";          * Expected Start Time
          IF        SHOWENQY<>1
                                                                 * Not in BOKRQ1
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</TD>"
.
          IF        SHOWREFD<>1
            MATCH     SP70,BKRQDURA                                   * Duration
            IF         @EQUAL
              WRITE     HTMLFILE;"<TD ALIGN=CENTER>0 min&nbsp;";
              WRITE     HTMLFILE;"<input type=hidden value=0>";
            ELSE
              WRITE     HTMLFILE;"<TD ALIGN=CENTER>",BKRQDURA," min&nbsp;";
              WRITE     HTMLFILE;"<input type=hidden value=",BKRQDURA,">";
            ENDIF
            WRITE     HTMLFILE;"</TD>"
          ENDIF
.
          PACK      ALRTIMGE,SP70,SP70
          PACK      ALRTIMG2,SP70,SP70
          PACK      ALRTIMG3,SP70,SP70
          PACK      ALRTIMG4,SP70,SP70
.
          PACK      FORMATNM,SP70,SP70
          WRITE     HTMLFILE;"<td nowrap height=30>";
          MATCH     SP70,BKRQURNO                                 * Patient Name
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQURNO,SP70
            CALL      RDMAST1
            IF        OVRCD=0
              CALL      RDPMPX21
              IF        OVRCD=1
                CALL      CLPMSPX2
              ENDIF
              UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
              CALL      IBACLOCK
              IF        PCEASE=1
                MOVE      PDECDTE,AGEDATE            * Date of Death
              ELSE
                PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
              ENDIF
              REP       " 0",AGEDATE
              CALL      CALCAGE
              CALL      PATLN000
              CALL      PATFLD00
              MOVE      KEY3,FOLDERSF
              MOVE      BKRQURNO,URNUMBER
              MOVE      BKRQVISN,ADMISSNO
              CALL      LSTALR00
            ELSE
              CALL      CLPMSPX2
              PACK      FORMATNM,SP70,SP70
              MOVE      SP70,FOLDERSF
            ENDIF
.
            REP       " +",BKRQVISN
            REP       " +",BKRQURNO
            WRITE     HTMLFILE;"<A HREF=javascript:GotoUR('":
                               BKRQURNO,"','",BKRQVISN,"')>":
                               "<img src=../images/PatientFolder":
                               FOLDERSF,".gif hspace=4 ":
                               "border=0></a>";
            REP       "+ ",BKRQVISN
            REP       "+ ",BKRQURNO
          ELSE
            MOVE      BKRQSNAM,PSNAME
            MOVE      BKRQGNAM,PGNAME
            MOVE      BKRQSNAM,PTMASNAM
            MOVE      SP70,PTITL
            CALL      PATNAM00
            PACK      FORMATNM,PATFNAME,SP70
.
            REP       " +",BKRQREQN
            REP       " +",BKRQSNAM
            REP       " +",BKRQGNAM
            WRITE     HTMLFILE;"<A HREF=javascript:AllocateUR('":
                               BKRQREQN,"','",BKRQSNAM,"','",BKRQGNAM,"')>":
                               "<img src=../images/ActionIcon.gif hspace=4 ":
                               "border=0></a>";
            REP       "+ ",BKRQREQN
            REP       "+ ",BKRQSNAM
            REP       "+ ",BKRQGNAM
          ENDIF
          WRITE     HTMLFILE;"&nbsp;",FORMATNM,"</TD>"
.
.         STRIP     ALRTIMGE                                            * Alerts
.         STRIP     ALRTIMG2
.         STRIP     ALRTIMG3
.         PACK      ALRTIMGT,ALRTIMGE,ALRTIMG2,ALRTIMG3,SP70
.
.         MATCH     SP70,ALRTIMGT                   * returned from LNKALERT.PBL
.         IF        @EQUAL
.           WRITE     HTMLFILE;"<td> &nbsp; ";
.         ELSE
.          WRITE     HTMLFILE;"<td><A HREF=#"",ALRTLINK,"#">",ALRTIMGT,"</a>";
.         ENDIF
.         WRITE      HTMLFILE;"</td>"
.
          
          MATCH     "1",OPERPLOS                   * display Planned LOS
          IF        @EQUAL
            WRITE     HTMLFILE;"<td> &nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>"
.
          REP       " +",BKRQREQN
          REP       " +",BKRQURNO
          REP       " +",BKRQVISN
          REP       " +",BKRQSNAM
          REP       " +",BKRQGNAM
.
          MATCH     "++++++++",BKRQURNO
          IF        !@EQUAL
.                                                                   * 3
            MOVE      ZERO,EXIT
            PROC      DISPALRT                * check for Disability Alerts
            IF        EXIT=0 | EXIT=2
.
              MATCH     "1",PMPXSIN7
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSIN8
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSIN9
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSN11
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      APTHRW30
              ENDIF
              MATCH     "2",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      APTHRW30
              ENDIF
.
              MATCH     "3",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      APTHRW30
              ENDIF
.
              MATCH     SP70,PTMXSIN1
              IF        !@EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                   PTMXSIN1,".gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
.
            ENDIF
.
APTHRW30    IF        EXIT=1 | EXIT=2
              WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 BKRQURNO,"','",BKRQVISN,"');>";
            ENDIF
.
            WRITE     HTMLFILE;"&nbsp;";
.
          ELSE
            WRITE     HTMLFILE;"&nbsp;";                       * 3
          ENDIF
.
          REP       "+ ",BKRQREQN
          REP       "+ ",BKRQURNO
          REP       "+ ",BKRQVISN
          REP       "+ ",BKRQSNAM
          REP       "+ ",BKRQGNAM
.
          WRITE      HTMLFILE;"</td>"
.
          IF        SHOWREFD<>1
            WRITE     HTMLFILE;"<TD>",BKRQVISN,"&nbsp;</TD>"      * Visit Number
          ENDIF
.
          PACK      KEY9,BKRQMBS1,SP70                               * Operation
          PACK      KEY17,KEY9,SP70
          CALL      PATITMRD
          IF        OVRCD=1
            MOVE      BKRQMBD1,IDESC
            WRITE     HTMLFILE;"<TD>",BKRQMBD1," ",BKRQMBD2:
                               " ",BKRQMBD3,"&nbsp;</TD>";
          ELSE
            WRITE     HTMLFILE;"<TD>",IDESC,"&nbsp;</TD>";
          ENDIF
.
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>";               * Anaesthetic Tpe
.
          BRANCH    SHOWREFD,APTHRW60
.
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"                * Usage
.
.         WRITE     HTMLFILE;"<TD>&nbsp;</TD>"                * Theatre
          MATCH     SP70,BKRQTHET
          IF        !@EQUAL & !@EOS
            PACK      KEY6,BKRQTHET,SP70
            CALL      RDOPOPR1
            IF        OVRCD=1
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",OPRMDESC,"&nbsp;</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
. Surgeon
.
          IF        SHOWSURG = 1
            CALL     GSURNQ00
            WRITE     HTMLFILE;"<TD>",DOCFNAME,"</TD>";
          ENDIF
.
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"                   * Case No
.
          WRITE     HTMLFILE;"<TD align=left>"                   *Book Theatre
.
          MATCH     ANSN,BKRQCSNT
          IF        @EQUAL
            WRITE     HTMLFILE;"No / ";
          ELSE
            MATCH     ANSY,BKRQCSNT
            IF        @EQUAL
              WRITE     HTMLFILE;"Yes / ";
            ELSE

            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"Approved<br>";
.
          REP       " +",BKRQREQN
          REP       " +",BKRQURNO
          REP       " +",BKRQVISN
          REP       " +",BKRQSURG
.
          MATCH     "++++++++",BKRQURNO
          IF        !@EQUAL & !@EOS
.
            MATCH     "A",BKRQSTAT
            IF        @EQUAL
              WRITE     HTMLFILE;"<br><input type=button name=booktheatre ":
                                 "onclick=BookTheatre('":
                 BKRQURNO,"','",BKRQVISN,"','",BKRQREQN,"','",BKRQSURG,"'); ":
                                 "value=Book class=button>";
            ENDIF
.
          ENDIF
.
          REP       "+ ",BKRQREQN
          REP       "+ ",BKRQURNO
          REP       "+ ",BKRQVISN
          REP       "+ ",BKRQSURG
          WRITE     HTMLFILE;"&nbsp;</TD>"
.
          WRITE     HTMLFILE;"<TD ALIGN=CENTER>"              *Request Time/Date
          MATCH     SP70,BKRQCDAT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                 NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",BKRQCTIM
          ENDIF
          WRITE     HTMLFILE;"<br>";
          MATCH     SP70,BKRQCSDT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCSDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                 NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",BKRQCSTM
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</TD>"
.
          WRITE     HTMLFILE;"<TD align=center>&nbsp;</TD>"
          GOTO      APTHRW90
.
APTHRW60  WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
.
. Surgeon
.
          IF        SHOWSURG = 1
            WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          ENDIF
.
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          WRITE     HTMLFILE;"<TD align=center>&nbsp;</TD>"
.
APTHRW90  IF        SHOWRBAY=1
            WRITE     HTMLFILE;"<TD>&nbsp;</TD>"
          ENDIF
.
          WRITE     HTMLFILE;"</TR>"
.
APTHRW99  RETURN
+
.-----------------------------------------------------------------------------
. Get surgeon name from BKRQSURG
. Input:  BKRQSURG
. Output: DOCFNAME 
.-----------------------------------------------------------------------------
GSURNQ00  MOVE      SP70,DOCFNAME
          MATCH     SP70,BKRQSURG
          GOTO      GSURNQ99 IF EQUAL
.
          PACK      KEY10,BKRQSURG,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
GSURNQ99  RETURN
+
.-----------------------------------------------------------------------------
. Get surgeon name from OPDACLIN
. Input:  OPDACLIN
. Output: DOCFNAME
.-----------------------------------------------------------------------------
GSURNS00  MOVE      SP70,DOCFNAME
          MATCH     SP70,OPDACLIN
          GOTO      GSURNS99 IF EQUAL
.
          PACK      KEY6,OPDACLIN,SP70
.
          COMPARE   ZERO,OPCNCLSU
          IF        @EQUAL
            CALL      RDOPCLI1
            IF        OVRCD=0
              PACK      KEY6,OPCLDOCT,SP70
            ENDIF
          ENDIF
.
          CALL      RDDOCT1
          IF        OVRCD<>1
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
GSURNS99  RETURN
.
.-----------------------------------------------------------
.        Display Completed Cases
.-----------------------------------------------------------
COMCAS00  MATCH     "1",OPCNUTRA
          GOTO      COMCAS99 IF NOT EQUAL
.
          MOVE      ZERO,PRIOCNTR
.
COMCAS10  PACK      KEY22,SESSKEYS,SP70
          MOVE      KEY22,SESSKEYS
.
          PACK      KEY26,KEY22,SP70
          CALL      RSOPDEA5
COMCAS20  CALL      RKOPDEA5                * next read on details file
          BRANCH    OVRCD,COMCAS99          * end of session
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     SESSKEYS,KEY22
          GOTO      COMCAS99 IF NOT EQUAL   * different session
.
          COMPARE   THREE,OPDASTAT
          GOTO      COMCAS20 IF EQUAL       * different session
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
..           MATCH     SP70,OPARTETC
..           GOTO      COMCAS20 IF EQUAL
.            MATCH     SP70,OPARTIRD
.            GOTO      COMCAS22 IF NOT EQUAL
.            MATCH     SP70,OPARTIRF
.            GOTO      COMCAS22 IF NOT EQUAL
.           GOTO      COMCAS20
          ELSE
            GOTO      COMCAS20
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=0
            MATCH     SP70,OPSGTIDR
            GOTO      COMCAS20 IF EQUAL
          ELSE
            GOTO      COMCAS20
          ENDIF
.
COMCAS22  CALL      CASDET00    * Get Display Details for Case
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      LSTALR00    * Patient Alerts (in LSTALERT.PBL)
.
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          REP       " +",CASEKEYS
          CALL      PATNAM00
.
          PACK      KEY18,OPDAADMN,OPDAUNIQ,SP70
          CALL      RDBKDIA1
          IF        OVRCD=1
            MOVE      SP70,BKDIDES1
            MOVE      SP70,BKDIDES2
            MOVE      SP70,BKDIDES3
            MOVE      SP70,BKDIDES4
            MOVE      SP70,BKDIDES5
            MOVE      SP70,BKDIDES6
          ENDIF
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
.
          MOVE      SP70,EMRSTYPE                       * Check to see if this
          MATCH     SP70,OPSESTYP                       * is an emergency sess
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANST,ANSU,OPSESTYP
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,EMRSTYPE
            ENDIF
          ENDIF
.
          CALL      CLBOKRQ1
          MATCH     SP70,OPDAREQN                       * Get theatre req rec
          IF        !@EQUAL & !@EOS
            PACK      KEY10,OPDAREQN,SP70
            CALL      RDBKRQ11
.
          ENDIF
.
          MOVE      SP70,PRIOASC1
          MOVE      SP70,PRIOASSN                       * Get priority
          MOVE      SP70,PRIOHEQV
          MOVE      BKRQPRIO,PRIODESC
          MATCH     SP70,BKRQPRIO
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CATrp,BKRQPRIO,SP70
            CALL      RDCODE1
            IF        OVRCD=0
               ASSIGN    (TCFORM6*60),PRIOASSN             * Convert into min
               MOVE      PRIOASSN,PRIOASSD
               LJUSTIFY  PRIOASSD
               MOVE      THCSCOD,PRIOHEQV
               MOVE      PTCDASC1,PRIOASC1
            ENDIF
          ENDIF
.
          ADD       ONE,PRIOCNTR
          MOVE      PRIOCNTR,PRIOCNTD
          REP       " 0",PRIOCNTD
.
          MOVE      "OA",CATEGORY   
          MOVE      OPDAANAE,CODE   
          CALL      GETCOD00	
          MOVE      TDESC,OADESC    
.
          CLEAR     HTMLLINK
.
          WRITE     HTMLFILE;"t1.addRow(#"":
                             HTMLLINK,"&nbsp;#",#"";                 * 0
.
          REP       " +",BKRQREQN
          REP       " +",BKRQURNO
          REP       " +",BKRQVISN
          REP       " +",BKRQSNAM
          REP       " +",BKRQGNAM
          REP       " +",OPDAURNO
          REP       " +",OPDAADMN
.
          WRITE     HTMLFILE;"<br>",PRIODESC:
                             "<input type=hidden":
                             " name=priod",PRIOCNTD," value='",PRIOASSD,"'>":
                             "<input type=hidden":
                             " name=priov",PRIOCNTD," value='",PRIOHEQV,"'>":
                             "<input type=hidden":
                             " name=pridt",PRIOCNTD," value='",BKRQCSDT,"'>":
                             "<input type=hidden":
                             " name=pritm",PRIOCNTD," value='",BKRQCSTM,"'>";
.
          MOVE      SP70,THETCOMP
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=1
            CALL      CLOPRARD
          ENDIF
.
          MOVE      ZERO,FORM2
          MOVE      OPCNTRCS,FORM2
.
          LOAD      THETCOMP,FORM2,OPARTCAL,OPARATIM,OPARANAP,OPARANAS:
                                   OPSGTIPS,OPSGTISS,OPSGTISE,OPARANAE:
                                   OPSGTIDR,OPARTIRF,OPARTIRB,OPARTIRD:
                                   OPARTIDP,OPARTETC
.
          WRITE     HTMLFILE;"<input type=hidden":
                             " name=pritc",PRIOCNTD," value='",THETCOMP,"'>":
                             "<input type=hidden value='",PRIOASC1,"'>";
.
          WRITE     HTMLFILE;"&nbsp;#",#"";                          * 1
.
          WRITE     HTMLFILE;OPDAEXPS:
                    "&nbsp;#",#"";                                   * 2
.
          WRITE     HTMLFILE;OPDAEXPD," min":
                    "&nbsp;#",#"";                                   * 3
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
          WRITE     HTMLFILE;"<A HREF=javascript:GotoUR('":
                             OPDAURNO,"','",OPDAADMN,"')>":
                             "<img src=../images/PatientFolder":
                             FOLDERSF,".gif hspace=4 ":
                             "border=0></a>":
                             FORMATNM:
                             "&nbsp;#",#"";                         * 4
.
          REP       "+ ",BKRQREQN
          REP       "+ ",BKRQURNO
          REP       "+ ",BKRQVISN
          REP       "+ ",BKRQSNAM
          REP       "+ ",BKRQGNAM
          REP       "+ ",OPDAURNO
          REP       "+ ",OPDAADMN
.
.          STRIP     ALRTIMGE
.          STRIP     ALRTIMG2
.          STRIP     ALRTIMG3
.          PACK      ALRTIMGT,ALRTIMGE,ALRTIMG2,ALRTIMG3,SP70
.
.          MATCH     SP70,ALRTIMGT                   * returned from LNKALERT.PBL
.          IF        !@EQUAL
.            REP       " +",ALRTLINK
.            WRITE     HTMLFILE;"<A HREF=",ALRTLINK,">",ALRTIMGT,"</A>";
.          ENDIF
.          WRITE     HTMLFILE;"&nbsp;#",#"";                         * 5
.
          REP       " +",BKRQREQN
          REP       " +",BKRQURNO
          REP       " +",BKRQVISN
          REP       " +",BKRQSNAM
          REP       " +",BKRQGNAM
.
          MATCH     "++++++++",BKRQURNO
          IF        !@EQUAL
.                                                                    * 5
            MOVE      ZERO,EXIT
            PROC      DISPALRT                * check for Disability Alerts
            IF        EXIT=0 | EXIT=2
.
              MATCH     "1",PMPXSIN7
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSIN8
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSIN9
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PMPXSN11
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
              MATCH     "1",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      COMCAS23
              ENDIF
              MATCH     "2",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                   "class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      COMCAS23
              ENDIF
.
              MATCH     "3",PTMXSIN1
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
                GOTO      COMCAS23
              ENDIF
.
              MATCH     SP70,PTMXSIN1
              IF        !@EQUAL
                WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                   PTMXSIN1,".gif'":
                                   " class=ListIcon onclick=PatientAlerts('":
                                   BKRQURNO,"','",BKRQVISN,"');>";
              ENDIF
.
            ENDIF
.
COMCAS23    IF        EXIT=1 | EXIT=2
              WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 BKRQURNO,"','",BKRQVISN,"');>";
            ENDIF
.
            WRITE     HTMLFILE;"&nbsp;#",#"";
.
          ELSE
            WRITE     HTMLFILE;"&nbsp;#",#"";                       * 5
          ENDIF
.
          REP       "+ ",BKRQREQN
          REP       "+ ",BKRQURNO
          REP       "+ ",BKRQVISN
          REP       "+ ",BKRQSNAM
          REP       "+ ",BKRQGNAM
.
          WRITE     HTMLFILE;OPDAADMN:
                             "&nbsp;#",#"";                         * 6
.
          MATCH     SP70,OPDADES1
          IF        !@EQUAL
            WRITE     HTMLFILE;OPDADES1," ",OPDADES2:
                               " ",OPDADES3,"&nbsp;";
          ELSE
            WRITE     HTMLFILE;BKDIDES1," ",BKDIDES2:
                               " ",BKDIDES3,"&nbsp;";
          ENDIF
           WRITE     HTMLFILE;"&nbsp;#",#"";                         * 7
.
          PACK      KEY36,OPDAUNIQ,SP70
          CALL      RSOPREQ1
          CALL      RKOPREQ1
          BRANCH    OVRCD,COMCAS25
.
          MATCH     OPDAUNIQ,OPRQUNIQ
          GOTO      COMCAS25  IF NOT EQUAL
.
          WRITE     HTMLFILE;"&nbsp;","R","&nbsp;";
          GOTO      COMCAS30
.
COMCAS25  WRITE     HTMLFILE;"&nbsp;";
.
COMCAS30  MOVE      SP70,KEY3
          BRANCH    OPDASTAT,COMCAS31,COMCAS32,COMCAS33,COMCAS34
          GOTO      COMCAS35
COMCAS31  MOVE      "Pre",KEY3
          GOTO      COMCAS35
COMCAS32  MOVE      "Adm",KEY3
          GOTO      COMCAS35
COMCAS33  MOVE      "Can",KEY3
          GOTO      COMCAS35
COMCAS34  MOVE      "Dis",KEY3
          GOTO      COMCAS35
.
COMCAS35  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<img src='../images/UsageIcon.gif'>&nbsp;":
                               KEY3;
          ELSE
            WRITE     HTMLFILE;KEY3;
          ENDIF
          WRITE     HTMLFILE;"&nbsp;#",#"";                         * 8
.
          MATCH     SP70,OPDATHET
          IF        !@EQUAL
            PACK      KEY6,OPDATHET,SP70
            CALL      RDOPOPR1
            IF        OVRCD=0
              WRITE     HTMLFILE;OPRMDESC;
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"&nbsp;#",#"";                         * 9
.
          WRITE     HTMLFILE;OPDACASE:
                             "&nbsp;#",#"";                         * 10
.
          CALL      PATSTS00       * Patient Status
.
          MOVE      "No ",DIM3     * Consent Status
          MATCH     "Y",OPDACSST
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
          MATCH     SP70,CURSTATS
          IF        !@EQUAL
            IF        SHOCNSNT = 1
              WRITE     HTMLFILE;DIM3,"&nbsp;/",CURSTATS;
            ELSE
              WRITE     HTMLFILE;CURSTATS;
            ENDIF
          ELSE
            IF        SHOCNSNT = 1
              WRITE     HTMLFILE;DIM3,"&nbsp;";
            ELSE
              WRITE     HTMLFILE;"&nbsp;";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"&nbsp;#",#"";                         * 11
.
          MOVE      SP70,CSDATSTR
          MATCH     SP70,BKRQCSDT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCSDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      CSDATSTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          PACK      CSDATDSC,BKRQCSDT,BKRQCSTM
.
          MOVE      SP70,RQDATSTR
          MATCH     SP70,BKRQCDAT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      RQDATSTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          PACK      RQDATDSC,BKRQCDAT,BKRQCTIM
.
          MOVE      SP70,SURGNAM1
COMCAS80  IF        SHOWSURG = 1
            MATCH     SP70,BKRQSURG
            IF        @EQUAL
              CALL      GSURNS00
              MOVE      DOCFNAME,SURGNAM1
            ELSE            
              CALL      GSURNQ00
              MOVE      DOCFNAME,SURGNAM1
            ENDIF 
          ENDIF
.     
          WRITE     HTMLFILE;RQDATSTR," ",BKRQCTIM,"<br>":
                             CSDATSTR," ",BKRQCSTM:
                             "&nbsp;#",#"";                          * 12
.
          WRITE     HTMLFILE;"&nbsp;#",#"";                          * 13
.
          WRITE     HTMLFILE;"#",";                                  * 14
          WRITE     HTMLFILE;"#"",SURGNAM1,"#",";                    * 15  
          WRITE     HTMLFILE;"#"",OADESC,"#"";                       * 16  
.
          WRITE     HTMLFILE;");"
.
          GOTO      COMCAS20
.
COMCAS99  RETURN
+
.-----------------------------------------------------------
.        Display Alerts with Disability
.-----------------------------------------------------------
ALRDIS00  REP       " +",OPDAURNO
          REP       " +",OPDAADMN
.
          WRITE     HTMLFILE;"<td>"
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
.
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
            ENDIF
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
            ENDIF
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 "class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
            ENDIF
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 "class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
            ENDIF
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
              GOTO      ALRDIS30
            ENDIF
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 "class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
              GOTO      ALRDIS30
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
              GOTO      ALRDIS30
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 OPDAURNO,"','",OPDAADMN,"');>";
            ENDIF
.
          ENDIF
.
ALRDIS30  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " class=ListIcon onclick=PatientAlerts('":
                               OPDAURNO,"','",OPDAADMN,"');>";
          ENDIF
.
          WRITE      HTMLFILE;"&nbsp;";
          WRITE      HTMLFILE;"</td>"
.
          REP       "+ ",OPDAURNO
          REP       "+ ",OPDAADMN
.
ALRDIS99  RETURN
.*****************************************************************************
.*        Tempfile I/O Subroutines                                           *
.*****************************************************************************
RATMPRE2  MOVE      ZERO,OVRCD
          RESET     KEY30
          READ      TMPREOR2,KEY30;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPRE2  RESET     KEY30
          READ      TMPREOR2,KEY30;;
          RETURN
.
RKTMPRE2  MOVE      ZERO,OVRCD
          READKS    TMPREOR2;TMPFPRIO,TMPFCSDT,TMPFCSTM,TMPFREQN
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPRE2  RESET     KEY30
          WRITE     TMPREOR2,KEY30;TMPFPRIO,TMPFCSDT,TMPFCSTM,TMPFREQN
          RETURN
.
DETMPRE2  RESET     KEY30
          DELETE    TMPREOR2,KEY30
          RETURN
+
.*****************************************************************************
.*        Create Tempfile                                                    *
.*****************************************************************************
CRTM2000  CALL      KTM20000
.
          CLEAR     DIM100
          APPEND    "isbuild ",DIM100
          APPEND    FNAMEB,DIM100
          APPEND    " 30 U1-3,4-11,12-19,20-29",DIM100
          RESET     DIM100
          EXECUTE   DIM100,TASKID
          OPEN      TMPREOR2,FNAMEB
.
          PACK      KEY30,SP70
          CALL      RSTMPRE2
CRTM2100  CALL      RKTMPRE2
          BRANCH    OVRCD,CRTM2999
.
          CALL      DETMPRE2
          GOTO      CRTM2100
.
CRTM2999  RETURN
.
.*****************************************************************************
.*        Kill Tempfile                                                      *
.*****************************************************************************
KTM20000  CLOSE     TMPREOR2
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEB,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KTM29999  RETURN
.------------------------------------------------------------
. Tracking Map View Condition Update
.------------------------------------------------------------
CONUPD00  MATCH     SP70,CASEKEYS
          GOTO      CONUPD90 IF EQUAL
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,CONUPD91
.
          CALL      CLARD000
          CALL      CASDET00              * Get Case Details
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CONUPD92
.  
          CALL      UPUDF000              * Update User Defined Text Fields
          CALL      UPARD000              * Update Arrival/Recover Details
.
          PROC      PMSCURTH           * Update patient header theatre status
.
          MOVE      ZERO,EXIT
          GOTO      CONUPD99
.
CONUPD90  MOVE      "Case not selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONUPD99
.
CONUPD91  MOVE      "No Theatre Booking Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONUPD99
.
CONUPD92  MOVE      "No Patient Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONUPD99
.
CONUPD99  RETURN
.------------------------------------------------------------
. Update Arrival/Recover Details
.------------------------------------------------------------
UPARD000  PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          IF        OVRCD=0
            CALL      MVOPAR00
            MOVE      USERID,OPARUIAR
            CALL      UPOPARD1
          ELSE
            UNPACK    KEY10,OPARUNID
            CALL      MVOPAR00
            MOVE      USERID,OPARUIAR
            CALL      WROPARD1
          ENDIF
          RETURN
.------------------------------------------------------------
. Update User Defined Comments
.------------------------------------------------------------
UPUDF000  MOVE      ZERO,F3
UPUDF100  ADD       ONE,F3
          LOAD      KEY100,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                              USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
          MATCH     Z70,KEY100
          IF        !@EQUAL
            MOVE      F3,KEY3
            MOVE      "013",OPDDTYPE
            PACK      KEY16,OPDAUNIQ,OPDDTYPE,KEY3,SP70
            CALL      RDOPDED1
            IF        OVRCD=0
              MOVE      KEY100,OPDDDATA
              CALL      UPOPDED1
            ELSE
              UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
              MOVE      KEY100,OPDDDATA
              CALL      WROPDED1
            ENDIF
          ENDIF
          IF       F3<10
            GOTO     UPUDF100
          ENDIF
.
UPUDF999  RETURN
.
.------------------------------------------------------------
. Close Frame
.------------------------------------------------------------
CLOFRM00  CALL      OPENHTML
          BRANCH    EXIT,CLOFRM99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             " src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             " src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             " DFrameExit();":
                             "</script>"
          CALL      CLOSHTML     * End of Document
CLOFRM99  RETURN
.******************************************************************************
.* Set 2nd Input Comments
.******************************************************************************
XPCOM000  PREP      XPCOMFIL,XPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     XPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     XPCOMFIL,SEQ;QRYDATA
.
XPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      XPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      XPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     XPCOMFIL,SEQ;QRYDATA
          GOTO      XPCOM100
.
XPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
XPCOM999  RETURN
.
.******************************************************************************
.* Update 2nd Comments
.******************************************************************************
UPCMX000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      XPCOMFIL,XPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMX999
.
UPCMX100  READ      XPCOMFIL,SEQ;XPCOMLIN
          GOTO      UPCMX999 IF OVER
          MATCH     "%START:",XPCOMLIN
          IF        @EQUAL
            UNPACK    XPCOMLIN,KEY7,XPCOMTYP
            CALL      CLCXM000
            MOVE      ZERO,XPCOMCNT
            GOTO      UPCMX100
          ENDIF
UPCMX110  ADD       ONE,XPCOMCNT
          PACK      KEY16,OPDAUNIQ,XPCOMTYP,XPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMX110 IF EQUAL
          MOVE      XPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMX100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMX100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMX100
.
UPCMX999  RETURN
.******************************************************************************
.* Clear 2nd Comments
.******************************************************************************
CLCXM000  PACK      KEY16,OPDAUNIQ,XPCOMTYP,SP70
          CALL      RSOPDED1
CLCXM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCXM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCXM999 IF NOT EQUAL
          MATCH     OPDDTYPE,XPCOMTYP
          GOTO      CLCXM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCXM100
CLCXM999  RETURN
.******************************************************************************
.* Set 3nd Input Comments
.******************************************************************************
YPCOM000  PREP      YPCOMFIL,YPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     YPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     YPCOMFIL,SEQ;QRYDATA
.
YPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      YPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      YPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     YPCOMFIL,SEQ;QRYDATA
          GOTO      YPCOM100
.
YPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
YPCOM999  RETURN
.
.******************************************************************************
.* Update 3nd Comments
.******************************************************************************
UPCMY000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      YPCOMFIL,YPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMY999
.
UPCMY100  READ      YPCOMFIL,SEQ;YPCOMLIN
          GOTO      UPCMY999 IF OVER
          MATCH     "%START:",YPCOMLIN
          IF        @EQUAL
            UNPACK    YPCOMLIN,KEY7,YPCOMTYP
            CALL      CLCYM000
            MOVE      ZERO,YPCOMCNT
            GOTO      UPCMY100
          ENDIF
UPCMY110  ADD       ONE,YPCOMCNT
          PACK      KEY16,OPDAUNIQ,YPCOMTYP,YPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMY110 IF EQUAL
          MOVE      YPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMY100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMY100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMY100
.
UPCMY999  RETURN
.******************************************************************************
.* Clear 3nd Comments
.******************************************************************************
CLCYM000  PACK      KEY16,OPDAUNIQ,YPCOMTYP,SP70
          CALL      RSOPDED1
CLCYM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCYM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCYM999 IF NOT EQUAL
          MATCH     OPDDTYPE,YPCOMTYP
          GOTO      CLCYM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCYM100
CLCYM999  RETURN
.******************************************************************************
.* Set 4nd Input Comments
.******************************************************************************
ZPCOM000  PREP      ZPCOMFIL,ZPCOMFNM
.
          UNPACK    QRYNAME,KEY5,KEY3
          WRITE     ZPCOMFIL,SEQ;"%START:",KEY3
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     ZPCOMFIL,SEQ;QRYDATA
.
ZPCOM100  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      ZPCOM999 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      ZPCOM800 IF NOT EQUAL
.
          PACK      QRYDATA,QRYDATA,SP70,SP70
          WRITE     ZPCOMFIL,SEQ;QRYDATA
          GOTO      ZPCOM100
.
ZPCOM800  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
ZPCOM999  RETURN
.
.******************************************************************************
.* Update 4nd Comments
.******************************************************************************
UPCMZ000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ZPCOMFIL,ZPCOMFNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCMZ999
.
UPCMZ100  READ      ZPCOMFIL,SEQ;ZPCOMLIN
          GOTO      UPCMZ999 IF OVER
          MATCH     "%START:",ZPCOMLIN
          IF        @EQUAL
            UNPACK    ZPCOMLIN,KEY7,ZPCOMTYP
            CALL      CLCZM000
            MOVE      ZERO,ZPCOMCNT
            GOTO      UPCMZ100
          ENDIF
UPCMZ110  ADD       ONE,ZPCOMCNT
          PACK      KEY16,OPDAUNIQ,ZPCOMTYP,ZPCOMCNT,SP70
          UNPACK    KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          CALL      RDOPDED1
          COMPARE   ZERO,OVRCD
          GOTO      UPCMZ110 IF EQUAL
          MOVE      ZPCOMLIN,OPDDDATA
.
          MATCH     SP70,OPDDDATA
          GOTO      UPCMZ100 IF EQUAL       * Do not save blank lines
          GOTO      UPCMZ100 IF EOS         * Do not save blank lines
.
          CALL      WROPDED1
          GOTO      UPCMZ100
.
UPCMZ999  RETURN
.******************************************************************************
.* Clear 4nd Comments
.******************************************************************************
CLCZM000  PACK      KEY16,OPDAUNIQ,ZPCOMTYP,SP70
          CALL      RSOPDED1
CLCZM100  CALL      RKOPDED1
          BRANCH    OVRCD,CLCZM999
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      CLCZM999 IF NOT EQUAL
          MATCH     OPDDTYPE,ZPCOMTYP
          GOTO      CLCZM999 IF NOT EQUAL
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE,SP70
          CALL      DEOPDED1
          CALL      RSOPDED1
          GOTO      CLCZM100
CLCZM999  RETURN
.
.
.******************************************************************************
.* Check if recovery is closed
.******************************************************************************
RCLS0000  MATCH     SP70,LOCATION           * All locations
          GOTO      RCLS5000 IF EQUAL
.
          MATCH     "ALL",LOCATION          * All locations
          GOTO      RCLS5000 IF EQUAL
.
          PACK      KEY22,LOCATION,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS1000  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS9999
.
          MATCH     LOCATION,OPRCLOCN       * Correct location
          GOTO      RCLS9999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS1000 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"1";           * Yes recovery closed
          GOTO      RCLS9999
.
RCLS5000  PACK      PTCDKEY2,ANSY,ANSD,SP70
          CALL      RDSCODE2
RCLS6000  CALL      RDKCODE2                   * Read location cat YD
          BRANCH    OVRCD,RCLS9999
.
          MATCH     "YD",TCODE                 * Correct category
          GOTO      RCLS9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE                 * Skip category record
          GOTO      RCLS6000 IF EQUAL
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      RCLS6000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS              * Check hospital security
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,RCLS6000
            ENDIF
          ENDIF
.
          PACK      KEY22,ACODE,Z70      * Recovery closed for this location
          CALL      RSOPRCI1
RCLS6100  CALL      RPOPRCI1
          BRANCH    OVRCD,RCLS6000
.
          MATCH     ACODE,OPRCLOCN       * Correct location
          GOTO      RCLS6000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OPRCHOSP
            GOTO      RCLS6100 IF NOT EQUAL
          ELSE
            MATCH     SP70,OPRCHOSP
            GOTO      RCLS6100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,OPRCEDAT           * Is there an end date
          GOTO      RCLS6000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"2";           * Yes a recovery location is closed
.
RCLS9999  RETURN
+
.-----------------------------------------------------------
. Update booking nutrition record in pmsnutaf
.-----------------------------------------------------------
UNUT0000  OPEN      PMSNUTA1,"pmsnutaf"       * Open nutrition file
.
          CALL      IBACLOCK
          PACK      D8,CCC,CYY,CMM,CDD
          REP       " 0",D8
          CLOCK     TIME,CTIMEIS              * Set created timestamp and userid
.
          IF        BKRESTAT = 0 | BKRESTAT = 1
            PACK      KEY16,DBKREBOO,BKREEDAT,SP70
            CALL      RDPMNUT1                * check if new date already exists
            IF        OVRCD = 1
              PACK      KEY16,DBKREBOO,OLDADATE,SP70
              CALL      RDPMNUT1              * read existing nutrition record
              BRANCH    OVRCD,UNUT9000
.
              MOVE      BKREEDAT,PMNUDATE       * use new date
              PACK      PMNUUPDU,WBSEUID,SP70
              PACK      PMNUUPDD,D8,CTIMEIS
              CALL      UPPMNUT1
              CALL      UPCAT000                * update catcomaf (extra diet)
            ENDIF
          ENDIF
.
UNUT9000  CLOSE     PMSNUTA1                  * Close nutrition file
UNUT9999  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details with new date (catcomaf)
.------------------------------------------------------------
UPCAT000  MATCH     "1",PTCNUTOM
          GOTO      UPCAT999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UPCAT999
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,PMNUADMN,OLDADATE,F1
            CALL      RDCTCOM1
            IF        OVRCD = 0
              MOVE      PMNUDATE,CTCODATE
              CALL      UPCTCOM1
            ENDIF
            ADD         TWO,F1
          DO
.
UPCAT900  CLOSE     CATCOMA1
UPCAT999  RETURN
+
.------------------------------------------------------------
. ADTD0000 - Update/Write Admission/Discharge Transfer
.            Destination file 
.------------------------------------------------------------
ADTD0000  COMPARE   ONE,PTCNUADT              * Parameter turned on ?
          GOTO      ADTD9999 IF NOT EQUAL
.
          MATCH     TRNSFSRC,Z70              * Exit if not received
          GOTO      ADTD9999 IF EQUAL
.
          MOVE      TRNSFSRC,PTDAADTS       * move cgi param into file var
.
          MATCH     SP5,PTDAADTS              * Transfer Source = spaces ?
          GOTO      ADTD2000 IF NOT EQUAL     * no
.
          PACK      KEY8,ADMISSNO,SP70        * yes
          CALL      RDPTDAD1                  * read PTDADFD record
          BRANCH    OVRCD,ADTD9999
.
          MATCH     SP5,PTDADCTS              * Dschg Transfer Source = spaces ?
          GOTO      ADTD1000 IF NOT EQUAL
.
          CALL      DEPTDAD1                  * delete a PTDADFD record
          MOVE      SP10,PTDAADTS
          MOVE      SP10,PTDADCTS
          GOTO      ADTD9999
.
ADTD1000  MOVE      SP5,PTDAADTS
          GOTO      ADTD3000
.
ADTD2000  MOVE      PTDAADTS,TFRSRCE          * save Transfer Source
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1                  * read PTDADFD record
          BRANCH    OVRCD,ADTD4000            * record not found
.
          MOVE      TFRSRCE,PTDAADTS          * set Trans Source = saved T/Srce
.
ADTD3000  CALL      UPPTDAD1                  * update PTDADFD record
          GOTO      ADTD9999
.
ADTD4000  MOVE      SP5,PTDADCTS
          MOVE      SP20,PTDASPAR
          CALL      WRPTDAD1                  * write a PTDADFD record
.
ADTD9999  RETURN
+
.---------------------------------------------------------------------
. FHIR Appointments - Theatre Cases by Associated Doctor Code
.---------------------------------------------------------------------
CASL0000  MOVE      ZERO,DISNUMB
          PACK      KEY22,WBSEHOSP,FRSTDATE,SP70
          CALL      RSOPSES1
CASL1000  CALL      RKOPSES1
          BRANCH    OVRCD,CASL9000
.
          MATCH     WBSEHOSP,OPSEHOSP
          GOTO      CASL9000 IF NOT EQUAL
.
          MATCH     OPSEDATE,LASTDATE
          GOTO      CASL9000 IF LESS
.
          COMPARE   ZERO,OPSESTAT      * Cancelled
          GOTO      CASL1000 IF EQUAL
.
          MOVE      OPSECLIN,KEY6
          COMPARE   ZERO,OPCNCLSU
          IF        @EQUAL
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,KEY6
            ENDIF
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE    
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000           
            MOVE      DOCFNAME,SURFNAME
          ELSE
            MOVE      "&nbsp;",SURFNAME
          ENDIF
          MATCH     SP70,OPCLDESC,
          IF        @EQUAL
            MOVE      SURFNAME,OPCLDESC
          ENDIF

          MOVE      ZERO,SESSFLAG         
          MATCH     DOCTCODE,KEY6
          IF        @EQUAL
            MOVE      ONE,SESSFLAG     
          ENDIF
.
          MOVE      ONE,F2
          WHILE     F2 <= 8
            LOAD      KEY6,F2,OPSEANAE,OPSEXDOC,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4,OPSEDCC5,OPSEDCC6
            MATCH     DOCTCODE,KEY6
            IF        @EQUAL
              MOVE      ONE,SESSFLAG    
            ENDIF
            ADD       ONE,F2
          DO
.
          MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE           
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                
            MOVE      DOCFNAME,ANAFNAME
          ELSE
            MOVE      "&nbsp;",ANAFNAME
          ENDIF
.
          PACK      SESSKEYS,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
CASL2000  CALL      RKOPDEA1
          BRANCH    OVRCD,CASL9000
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          MATCH     KEY22,SESSKEYS
          GOTO      CASL1000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CASL2000 IF EQUAL       * Cancelled
.
          BRANCH    SESSFLAG,CASL2200       * Match on Session Doctors
          PACK      KEY35,OPDAUNIQ,SP70     * Check for other doctors associated with case
          CALL      RSOPTSM1
CASL2100  CALL      RKOPTSM1
          BRANCH    OVRCD,CASL2000
          MATCH     OPDAUNIQ,OPTSUNID
          GOTO      CASL2000 IF NOT EQUAL
          MATCH     OPTSSCDE,DOCTCODE        
          GOTO      CASL2100 IF NOT EQUAL   * Match on associated doctor drop through and process
.
CASL2200  MOVE      OPDAADMN,ADMISSNO
          CALL      CASDET00
.
          MOVE      "OA",CATEGORY
          MOVE      OPDAANAE,CODE
          CALL      GETCOD00
          MOVE      TDESC,OADESC
.
          CALL      GETDET00
          CALL      SETC0000
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,CASL2000
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CASL2000
.
          CALL      PATNAA00
          PACK      URNUMBER,BKREURNO,SP70
.
          CALL      FHRAPP00
          GOTO      CASL2000
.
CASL9000  RETURN
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
SETC0000  COMPARE   ZERO,OPCNCLSU
          GOTO      SETC0100 IF NOT EQUAL   * Checking For The CLinic Status
.
          MOVE      SP70,KEY30
          MOVE      SP70,SURGNAME
          PACK      KEY6,OPDACLIN,SP70
          CALL      RDOPCLI1                * Read Clinic table
          BRANCH    OVRCD,SETC0200
.
          MATCH     SP70,OPCLDOCT
          IF        @EQUAL
            MOVE      OPCLDESC,KEY30        * For Displaying Clinic Descrition
            MOVE      OPCLDESC,SURGNAME     * For Displaying Clinic Descrition
            GOTO      SETC0200
          ELSE
            PACK        KEY6,OPCLDOCT,SP70
            GOTO        SETC0110
          ENDIF
.
SETC0100  PACK      KEY6,OPDACLIN,SP70
SETC0110  CALL      RDDOCT1
          BRANCH    OVRCD,SETC0200
          MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,KEY30
          MOVE      DOCFNAME,SURGNAME
.
SETC0200  MOVE      SP70,DIM30
.
          COMPARE   "0",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Booked",DIM30
          ENDIF
.
          COMPARE   "1",OPDASTAT
          IF        @EQUAL
            MOVE      "booked",FHRSTAT
            MOVE      "Pre-Admitted",DIM30
          ENDIF
.
          COMPARE   "2",OPDASTAT
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
            MOVE      "Admitted",DIM30
          ENDIF
.
          COMPARE   "3",OPDASTAT
          IF        @EQUAL
            MOVE      "cancelled",FHRSTAT
            MOVE      "SC",CATEGORY
            MOVE      OPDACANC,CODE
            CALL      GETCOD00
            MATCH     ANST,TCINDC3
            IF        @EQUAL
              MOVE      "Transferred",DIM30
            ELSE
              MOVE      "Cancelled",DIM30
            ENDIF
            GOTO      SETC0420
          ENDIF
.
          COMPARE   "4",OPDASTAT
          IF        @EQUAL
            MOVE      "fulfilled",FHRSTAT
          ENDIF
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,SETC0420
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Holding",DIM30
            ENDIF
.           MOVE      "Holding",DIM30
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Anaes",DIM30
            ENDIF
.           MOVE      "Anaes",DIM30
          ENDIF
.
SETC0410  PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,SETC0420
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",DIM30
            ELSE
              MOVE      "Theatre",DIM30
            ENDIF
.           MOVE      "Theatre",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",DIM30
          ENDIF
.
          MATCH     SP70,OPARTIDP   
          IF        !@EQUAL
            MOVE      "Ready To Depart",DIM30
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",DIM30
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",DIM30
          ENDIF
.
          MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,DIM30                 * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",DIM30         * Yes, set to "Deceased".
            ELSE
              MOVE      "RIP - ",DIM6            * No, prefix with "Deceased"
              MOVE      DIM30,KEY15              * Save current status
              PACK      DIM30,DIM6,KEY15         * Build new status desc
            ENDIF
          ENDIF
.
SETC0420  SQUEEZE   OPDADATE
          SQUEEZE   OPDATIME
          PACK      CASEKEYS,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                             OPDACASE
          RETURN
.
.---------------------------------------------------------
. Get Anaethestist Name return as ANAENAME
.---------------------------------------------------------
GETAN000  MOVE      SP70,ANAENAME
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,OPDASTAT:
                          OPDACASE,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ELSE
            PACK      KEY6,OPSEANAE,SP70
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE          * For Formatting Doctor's Name
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,ANAENAME
            ENDIF
          ENDIF
          STRIP     ANAENAME
          RETURN
+
.---------------------------------------------------------
. Write Admitting Nurse to OPRTSM            
.---------------------------------------------------------
WOPTSM00   MOVE     SP70,KEY3
.
           PACK     KEY5,ANSO,ANSN,SP70
           CALL     RDSCODE1
WOPTSM10   CALL     RDKCODE1
           BRANCH   OVRCD,WOPTSM99 
.
           MATCH    "ON",TCODE
           GOTO     WOPTSM99  IF NOT EQUAL
.
           MATCH    SP70,ACODE
           GOTO     WOPTSM10  IF EQUAL
.
           MATCH    "A",TCINDC1
           GOTO     WOPTSM10  IF NOT EQUAL
.
           MOVE     ACODE,KEY3
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     SAVEANUR,OPTSSCDE            
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARATIM,OPTSSTIM
           MOVE     KEY3,OPTSSTYP 
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     DEOPTSM1
.
           MATCH    SP70,OPARANUR
           GOTO     WOPTSM99  IF EQUAL
           GOTO     WOPTSM99  IF EOS
.
           CALL     CLOPRTSM
           MOVE     OPARUNID,OPTSUNID
           MOVE     ONE,OPTSTMNO
           MOVE     TWO,OPTSSIND
           MOVE     OPARANUR,OPTSSCDE
           MOVE     OPSEDATE,OPTSSDAT
           MOVE     OPARATIM,OPTSSTIM
           MOVE     KEY3,OPTSSTYP           
.
           PACK     KEY35,OPTSUNID,OPTSTMNO,OPTSSIND,OPTSSCDE,OPTSSDAT:
                          OPTSSTIM,SP70
           CALL     RAOPTSM1
           IF       OVRCD=1
             CALL     WROPTSM1 
           ENDIF
.
WOPTSM99   RETURN
.
.-----------------------------------------------------------------------------
. PADM0000 - Check for outpatient pre admission link booking
.-----------------------------------------------------------------------------
PADM0000  PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PADM1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PADM9000
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PADM9999 IF EQUAL
.
          GOTO      PADM1000
.
PADM9000  CALL      CLWATOPA
          GOTO      PADM9999
.
PADM9999  RETURN
.
.-----------------------------------------------------------------------------
. AAUPRF00 - Auto Add Operating Team Preference
.-----------------------------------------------------------------------------
AAUPRF00  MATCH     "1",AUTOPREF
          GOTO      AAUPRF99 IF NOT EQUAL
.
          MATCH     SP70,OPDACLIN
          GOTO      AAUPRF50 IF EQUAL
          GOTO      AAUPRF50 IF EOS
.
          PACK      DIM6,OPDACLIN,SP70             * surgeon
          IF        OPCNCLSU=0
            MOVE      DIM6,KEY6                    * clinic
            CALL      RDOPCLI1
            IF        OVRCD=0
              MOVE      OPCLDOCT,DIM6
            ENDIF
          ENDIF
.
          MATCH     SP70,OPERPRV1
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV1,SP70
            CALL      WRTPRF00     
          ENDIF
.
          MATCH     SP70,OPERPRV2
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV2,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV3
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV3,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV4
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV4,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV5
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV5,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV6
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV6,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV7
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV7,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV8
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV8,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPRV9
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPRV9,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR10
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR10,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR11
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR11,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR12
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR12,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR13
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR13,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR14
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR14,SP70
            CALL      WRTPRF00
          ENDIF
.
          MATCH     SP70,OPERPR15
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPERPR15,SP70
            CALL      WRTPRF00
          ENDIF
.
AAUPRF50  MATCH     SP70,OPSEANAE
          GOTO      AAUPRF60 IF EQUAL
          GOTO      AAUPRF60 IF EOS
.
          PACK      DIM6,OPSEANAE,SP70
.
          MATCH     SP70,OPDAANAE
          IF        !@EQUAL & !@EOS
            PACK      DIM9,OPDAANAE,SP70
            CALL      WRTPRA00
          ENDIF
.
AAUPRF60  CALL      WRTSPC00
.
AAUPRF99  RETURN
+
.-----------------------------------------------------------------------------
. WRTPRF00 - Write OPRPRF record for Doctor and Procedure Codes
.-----------------------------------------------------------------------------
WRTPRF00  PACK      KEY18,DIM6,DIM9,OPSEHOSP,SP70
          CALL      RDOPDPH1
          BRANCH    OVRCD,WRTPRF20
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,DIM6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      DIM6,OPPRDCOD
            MOVE      ONE,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ELSE
            MOVE      ONE,OPPRPQTY
            CALL      UPOPPRF1
          ENDIF
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY18,DIM15,OPSEHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,WRTPRF30
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      SP6,OPPRDCOD
            MOVE      ZERO,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
          GOTO      WRTPRF30
.
WRTPRF20  PACK      DIM15,DIM9,SP70
          PACK      KEY18,DIM15,OPSEHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,WRTPRF30
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      SP6,OPPRDCOD
            MOVE      ONE,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
WRTPRF30  PACK      KEY18,DIM6,SP70
          CALL      RSOPDPH1
WRTPRF35  CALL      RKOPDPH1
          BRANCH    OVRCD,WRTPRF60
.
          MATCH     DIM6,OPDHCODE
          GOTO      WRTPRF60 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     OPSEHOSP,OPDHHOSP
            GOTO      WRTPRF60 IF NOT EQUAL
          ENDIF
.
          PACK      DIM15,OPDHPREF,SP70
          PACK      KEY32,OPDAUNIQ,ONE,DIM6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,OPDHPREF,SP70
            MOVE      DIM6,OPPRDCOD
            MOVE      ZERO,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
          GOTO      WRTPRF35
.
WRTPRF60
.          PACK      KEY19,OPDADATE,OPDATIME,OPDACLIN,SP70
.          CALL      RDOPSES1
.          BRANCH    OVRCD,WRTPRF99
..
.          MATCH     SP70,OPSETYPE
.          GOTO      WRTPRF99 IF EQUAL
..
.          PACK      KEY3,OPSETYPE,SP70
.          CALL      RDOPTPS1
.          BRANCH    OVRCD,WRTPRF99
..
.          MATCH     SP70,OPTPTRPR
.          GOTO      WRTPRF99 IF EQUAL
..
.          PACK      KEY15,OPTPTRPR,SP70
.          CALL      RDOPTRA1
.          BRANCH    OVRCD,WRTPRF99
..
.          PACK      DIM15,OPTPTRPR,SP70
.          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
.          CALL      RDOPPRF1
.          IF        OVRCD=1
.            MOVE      OPDAUNIQ,OPPRUNIQ
.            MOVE      ONE,OPPRTEAM
.            PACK      OPPRPREF,OPTPTRPR,SP70
.            MOVE      SP6,OPPRDCOD
.            MOVE      ZERO,OPPRPQTY
.            MOVE      SP70,OPPRSPAR
..
.            CALL      WROPPRF1
.          ENDIF
.
WRTPRF99  RETURN
+
.-----------------------------------------------------------------------------
. WRTPRA00 - Write OPRPRF record for Anaesthetist and Anaesthetic Type
.-----------------------------------------------------------------------------
WRTPRA00  PACK      KEY18,DIM6,DIM9,OPSEHOSP,SP70
          CALL      RDOPDPH1
          BRANCH    OVRCD,WRTPRA20
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,DIM6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      DIM6,OPPRDCOD
            MOVE      ONE,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY18,DIM15,OPSEHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,WRTPRA30
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      SP6,OPPRDCOD
            MOVE      ZERO,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
          GOTO      WRTPRA30
.
WRTPRA20  PACK      DIM15,DIM9,SP70
          PACK      KEY18,DIM15,OPSEHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,WRTPRA30
.
          PACK      DIM15,DIM9,SP70
          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,DIM9,SP70
            MOVE      SP6,OPPRDCOD
            MOVE      ONE,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
WRTPRA30  PACK      KEY18,DIM6,SP70
          CALL      RSOPDPH1
WRTPRA35  CALL      RKOPDPH1
          BRANCH    OVRCD,WRTPRA60
.
          MATCH     DIM6,OPDHCODE
          GOTO      WRTPRA60 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     OPSEHOSP,OPDHHOSP
            GOTO      WRTPRA60 IF NOT EQUAL
          ENDIF
.
          PACK      DIM15,OPDHPREF,SP70
          PACK      KEY32,OPDAUNIQ,ONE,DIM6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,OPDHPREF,SP70
            MOVE      DIM6,OPPRDCOD
            MOVE      ZERO,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
          GOTO      WRTPRA35
.
WRTPRA60
.          PACK      KEY19,OPDADATE,OPDATIME,OPDACLIN,SP70
.          CALL      RDOPSES1
.          BRANCH    OVRCD,WRTPRA99
..
.          MATCH     SP70,OPSETYPE
.          GOTO      WRTPRA99 IF EQUAL
..
.          PACK      KEY3,OPSETYPE,SP70
.          CALL      RDOPTPS1
.          BRANCH    OVRCD,WRTPRA99
..
.          MATCH     SP70,OPTPTRPR
.          GOTO      WRTPRA99 IF EQUAL
..
.          PACK      KEY15,OPTPTRPR,SP70
.          CALL      RDOPTRA1
.          BRANCH    OVRCD,WRTPRA99
..
.          PACK      DIM15,OPTPTRPR,SP70
.          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
.          CALL      RDOPPRF1
.          IF        OVRCD=1
.            MOVE      OPDAUNIQ,OPPRUNIQ
.            MOVE      ONE,OPPRTEAM
.            PACK      OPPRPREF,OPTPTRPR,SP70
.            MOVE      SP6,OPPRDCOD
.            MOVE      ZERO,OPPRPQTY
.            MOVE      SP70,OPPRSPAR
..
.            CALL      WROPPRF1
.          ENDIF
.
WRTPRA99  RETURN
+
.-----------------------------------------------------------------------------
. WRTSPC00 - Write OPRPRF record for Speciality Type Preference
.-----------------------------------------------------------------------------
WRTSPC00  PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,WRTSPC99
.
          MATCH     SP70,OPSETYPE
          GOTO      WRTSPC99 IF EQUAL
.
          PACK      KEY6,OPSETYPE,OPDAHOSP,SP70
          CALL      RDOPTPS1
          BRANCH    OVRCD,WRTSPC99
.
          MATCH     SP70,OPTPTRPR
          GOTO      WRTSPC99 IF EQUAL
.
          PACK      DIM15,OPTPTRPR,SP70
          PACK      KEY18,DIM15,OPTPHOSP,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,WRTSPC99
.
          PACK      DIM15,OPTPTRPR,SP70
          PACK      KEY32,OPDAUNIQ,ONE,SP6,DIM15,SP70
          CALL      RDOPPRF1
          IF        OVRCD=1
            MOVE      OPDAUNIQ,OPPRUNIQ
            MOVE      ONE,OPPRTEAM
            PACK      OPPRPREF,OPTPTRPR,SP70
            MOVE      SP6,OPPRDCOD
            MOVE      ZERO,OPPRPQTY
            MOVE      SP70,OPPRSPAR
.
            CALL      WROPPRF1
          ENDIF
.
WRTSPC99  RETURN
.*****************************************************************************
.         Check Quantities for Theatre, Anaesthetic, Recovery Gases
.*****************************************************************************
CHKGAS00  MATCH     "1",OPCNPTMC
          GOTO      CHKGAS99 IF NOT EQUAL
.
          PACK      KEY15,OPDAADMN,THREE,SP70
          CALL      RSPMMTI2
CHKGAS10  CALL      RKPMMTI2
          BRANCH    OVRCD,CHKGAS99
.
          MATCH     OPDAADMN,PMMIVISN
          GOTO      CHKGAS99 IF NOT EQUAL
.
          MATCH     "3",PMMIRTYP
          GOTO      CHKGAS99 IF NOT EQUAL
.
          COMPARE   ONE,PMMISERV
          GOTO      CHKGAS10 IF NOT EQUAL
.
          MATCH     SP70,PMMIMGRP
          GOTO      CHKGAS10 IF EQUAL
.
          MOVE      "FI",CATEGORY
          MOVE      PMMIMGRP,CODE
          CALL      GETCOD00
.
          MATCH     ANSA,TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS10
.
            MATCH     SP70,OPARANAS
            GOTO      CHKGAS10 IF EQUAL
.
            MATCH     SP70,OPARANAE
            GOTO      CHKGAS10 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARANAS,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARANAE,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",PMMISERV
            ELSE
              MOVE      CALCTIME,PMMISERV
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          MATCH     ANST,TCINDC10
          IF        @EQUAL
.
            IF        CFEETYP=5
.
              PACK      KEY11,OPDAADMN,SP70
              CALL      RSNZSPR1
CHKGAS70      CALL      RKNZSPR1
              BRANCH    OVRCD,CHKGAS80
.
              MATCH     OPDAADMN,NZSPADMN
              GOTO      CHKGAS80 IF NOT EQUAL
.
              MATCH     PMMIITEM,NZSPPROC
              GOTO      CHKGAS70 IF NOT EQUAL
.
              IF        NZSPTDUR>9999
                MOVE      "9999",PMMISERV
              ELSE
                MOVE      NZSPTDUR,PMMISERV
              ENDIF
.
            ELSE
.
CHKGAS80      PACK      KEY11,OPDAUNIQ,ONE,SP70
              CALL      RDOPSRG1
              BRANCH    OVRCD,CHKGAS10
.
              MATCH     SP70,OPSGTISS
              GOTO      CHKGAS10 IF EQUAL
.
              MATCH     SP70,OPSGTISE
              GOTO      CHKGAS10 IF EQUAL
.
.             Calculate new time/amount
.
              MOVE      OPDADATE,FIRSTDAT
              UNPACK    OPSGTISS,HOUR,D1,MIN
              PACK      FIRSTIME,HOUR,MIN
              REP       " 0",FIRSTDAT
              REP       " 0",FIRSTIME
.
              MOVE      OPDADATE,LASTDATE
              REP       " 0",LASTDATE
              UNPACK    OPSGTISE,HOUR,D1,MIN
              PACK      LASTTIME,HOUR,MIN
              REP       " 0",LASTTIME
              CALL      TIMEDIFF
              IF        CALCTIME>9999
                MOVE      "9999",PMMISERV
              ELSE
                MOVE      CALCTIME,PMMISERV
              ENDIF
.
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          MATCH     "R",TCINDC10
          IF        @EQUAL
.
            PACK      KEY10,OPDAUNIQ,SP70
            CALL      RDOPARD1
            BRANCH    OVRCD,CHKGAS10
.
            MATCH     SP70,OPARTIRD
            GOTO      CHKGAS10 IF EQUAL
.
            MATCH     SP70,OPARTETC
            GOTO      CHKGAS10 IF EQUAL
.
.           Calculate new time/amount
.
            MOVE      OPDADATE,FIRSTDAT
            UNPACK    OPARTIRD,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            MOVE      OPDADATE,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    OPARTETC,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
.
            CALL      TIMEDIFF
            IF        CALCTIME>9999
              MOVE      "9999",PMMISERV
            ELSE
              MOVE      CALCTIME,PMMISERV
            ENDIF
.
            CALL      UPPMMTI2
.
            GOTO      CHKGAS10
.
          ENDIF
.
          GOTO      CHKGAS10
.
CHKGAS99  RETURN
+
.*******************************************************************************
.        Generate OECW Requests
.*******************************************************************************
REWOEC00      MATCH     "1",PTCNWSIN
              GOTO      REWOEC99 IF NOT EQUAL
.
              MATCH     "1",PTCNOECW
              GOTO      REWOEC99 IF NOT EQUAL
.
              COMPARE   "1",OECWINDC
              GOTO      REWOEC99 IF NOT EQUAL
.
              CALL      GNXOEW00
              CALL      CLWEBOEC              * Write new weboecaf record
              CALL      UPWBOC00
.
              MOVE      ADMISNUM,WBOCVISN
              MOVE      KEY3,WBOCCNTR
              MOVE      " 0",WBOCSTAT
              MOVE      URNUMBER,WBOCURNO
              MOVE      ADMISNUM,WBOCARID
              PACK      WBOCARID,WBOCARID,SP70
              LJUSTIFY  WBOCARID
              MOVE      SP70,WBOCTRID
              CALL      IBACLOCK
              PACK      WBOCRQDT,CCC,CYY,CMM,CDD
              REP       " 0",WBOCRQDT
              MOVE      SP70,WBOCETYP
              MOVE      SP70,WBOCERRC
              MOVE      SP70,WBOCERRD
              PACK      WBOCCDTE,CCC,CYY,CMM,CDD
              REP       " 0",WBOCCDTE
              CLOCK     TIME,CTIMEIS
              MOVE      CTIMEIS,WBOCCTIM
              MOVE      SP70,WBOCUDTE
              MOVE      SP70,WBOCUTIM
              MOVE      SP70,WBOCHOSP
              MOVE      SP70,WBOCELEG
              MOVE      SP70,WBOCMSID
.
              MOVE      USERID,WBOCCUID
              MOVE      SP70,WBOCUUID

              IF        IBCNMHOS=1
                PACK      KEY8,ADMISNUM,SP70     * Update pmsvx1af.pmvxpoec
                CALL      RDPMVX11               * OEC Consent
                IF        OVRCD=0
                  MOVE      PMVXMHOS,WBOCHOSP
                ENDIF
              ENDIF
.
              PACK      KEY11,ADMISNUM,KEY3,SP70
              CALL      RAWBOEC1
              IF        OVRCD=1
                CALL      IBACLOCK
                PACK      WBOCUDTE,CCC,CYY,CMM,CDD
                REP       " 0",WBOCUDTE
                MOVE      CTIMEIS,WBOCUTIM
                MOVE      USERID,WBOCUUID

                CALL      WRWBOEC1
              ELSE
                GOTO      REWOEC00
              ENDIF
.
REWOEC40      MOVE      ONE,F2A
              MOVE      ONE,F2                * Write new pmsoesaf record
              WHILE     F2 <= 5
                CALL      CLWEBOES
                CALL      UPWBOS00
.
                MATCH     SP70,WBOSITEM
                GOTO      REWOEC60 IF EQUAL
                GOTO      REWOEC60 IF EOS
.
                MOVE      ADMISNUM,WBOSVISN
                MOVE      WBOCCNTR,WBOSCNTR
                MOVE      F2A,WBOSSCNT
                PACK      WBOSSCNT,WBOSSCNT,SP70
                RJUSTIFY  WBOSSCNT
                CALL      IBACLOCK
                PACK      WBOSCDTE,CCC,CYY,CMM,CDD
                REP       " 0",WBOSCDTE
                CLOCK     TIME,CTIMEIS
                MOVE      CTIMEIS,WBOSCTIM
.
                PACK      KEY14,ADMISNUM,WBOSCNTR,WBOSSCNT,SP70
                CALL      RAWBOES1
                IF        OVRCD=1
                  CALL      WRWBOES1
                ELSE
                  MOVE      WBEFELGN,WBOCELEG
                  CALL      IBACLOCK
                  PACK      WBOCUDTE,CCC,CYY,CMM,CDD
                  REP       " 0",WBOCUDTE
                  MOVE      CTIMEIS,WBOCUTIM
                  MOVE      USERID,WBOCUUID
                  CALL      UPWBOES1
                ENDIF
.
                ADD       ONE,F2A
REWOEC60        ADD       ONE,F2
              DO
.
.             MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
.             ADD       ONE,WARCOUNT
.             MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
              CALL      HOEW0000             * Write history record to
.                                            * webelfaf (oec free format table)
.
REWOEC99  RETURN
+
.*******************************************************************************
.        Get Next weboecaf report counter
.*******************************************************************************
GNXOEW00  MATCH     "1",PTCNOECW
          IF        !@EQUAL
            GOTO      GNXOEW99
          ENDIF
.
          MOVE      "  1",KEY3
          PACK      KEY11,ADMISNUM,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1
          BRANCH    OVRCD,GNXOEW99
.
          MATCH     ADMISNUM,WBOCVISN
          GOTO      GNXOEW99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   WBOCCNTR
          MOVE      WBOCCNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
.
GNXOEW99  RETURN
+
.-------------------------------------------------------------
. Write OECW History Record to webelfaf (OEC Free Format table)
.-------------------------------------------------------------
HOEW0000  PACK      KEY8,WBOCURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CLWEBELF
.
          PACK      SAVKEY11,WBOCVISN,WBOCCNTR,SP70
.
HOEW1000  CALL      GELW0000           * Generate Eligibility Number
          BRANCH    EXIT,HOEW9999
.
          MOVE      SAVKEY11,KEY11
          CALL      RDWBOEC1
.
          MOVE      WBOCURNO,WBEFURNO
          MOVE      ZERO,WBEFOECC
          MOVE      PTITL,WBEFTITL
          PACK      WBEFFNAM,PMPXFNAM,SP70
          PACK      WBEFSNAM,PTMASNAM,SP70
          MOVE      SP70,WBEFHFGN
          MOVE      SP70,WBEFHFSN
          MOVE      PSEX,WBEFGEND
          MOVE      PBDATE,WBEFBDAT
          MOVE      ADATE,WBEFEADT
          MOVE      PMVXIDUS,WBEFISTY
          MOVE      ASTAY,WBEFPLOS
          MOVE      SP70,WBEFDINT
          MOVE      PTELSPEA,WBEFPEAI
          MOVE      PTELEADM,WBEFEMAD
          MOVE      PMVXPILC,WBEFPRIC
.
.         MOVE      AMBS,WBEFPRIM
          MOVE      SP70,WBEFPRIM
          MATCH     AMBS,Z70
          IF        !@EQUAL
            MOVE      AMBS,WBEFPRIM
          ENDIF
.
          MOVE      ACLAIM,WBEFCLTY
          MOVE      AFUNDH,WBEFHFND
          MOVE      AFNDTB,WBEFHFNT
          MOVE      AFNDMM,WBEFHFMN
          MOVE      ADIAG1,WBEFDIAG
.
          MOVE      SP70,WBEFSRV1
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,ONE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV1
          ENDIF
.
          MOVE      SP70,WBEFSRV2
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,TWO,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV2
          ENDIF
.
          MOVE      SP70,WBEFSRV3
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,THREE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV3
          ENDIF
.
          MOVE      SP70,WBEFSRV4
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,FOUR,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV4
          ENDIF
.
          MOVE      SP70,WBEFSRV5
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,FIVE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV5
          ENDIF
.
          MOVE      WBSEUID,WBEFCUID
          CALL      IBACLOCK
          PACK      WBEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBEFCTIM
.
          CALL      CNCW0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      WBEFDVAN,SP20                * No
          ELSE
            MOVE      DIM20,WBEFDVAN               * yes
          ENDIF
.
          MOVE      WBOCVISN,WBEFVISN
          MOVE      WBOCCNTR,WBEFCNTR
          MOVE      ZERO,WBEFFLAG
          MOVE      SP70,WBEFTRID
          MOVE      SP70,WBEFMSID
          PACK      WBEFSPAR,SP70,SP70
.
          PACK      KEY8,WBEFELGN,SP70
          CALL      RAWBELF1
          IF        OVRCD=0
            GOTO      HOEW1000
          ENDIF
.
          CALL      WRWBELF1
.
          PACK      KEY11,WBOCVISN,WBOCCNTR,SP70
          CALL      RDWBOEC1
          IF        OVRCD=0
            MOVE      WBEFELGN,WBOCELEG
            MOVE      WBEFELGN,WBOCELEG
            CALL      IBACLOCK
            PACK      WBOCUDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOCUDTE
            MOVE      CTIMEIS,WBOCUTIM
            MOVE      USERID,WBOCUUID
            CALL      UPWBOEC1
          ENDIF
.
HOEW9999  RETURN
+
.-----------------------------------------------------------
.        Generate Free Format OECW Eligibility Number
.-----------------------------------------------------------
GELW0000  MOVE      ZERO,EXIT
.
          MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*117,PTCNELGN
.
GELW0100  MOVE      PTCNELGN,WBEFELGN
          UNPACK    PTCNELGN,ANS,KEY7
          MATCH     "a",ANS
          GOTO      GELW1150 IF LESS
          MOVE      ZERO,F7
          MOVE      KEY7,F7
.
GELW1100  COMPARE   "9999999",F7               * at the end of the group
          GOTO      GELW1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GELW9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F7
.
GELW1110  ADD       ONE,F7
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          CALL      RDWBELF1
          IF        OVRCD=ONE
            PACK      KEY11,ANS,D7,SP1,SP1,ONE,SP70
            CALL      RDWBOEC1
            IF        OVRCD=ONE
              PACK      KEY14,ANS,D7,SP1,SP1,ONE,SP70
              CALL      RSWBOES1
              CALL      RKWBOES1
              BRANCH    OVRCD,GELW9500
.
              PACK      KEY8,ANS,D7,SP70
              MATCH     KEY8,WBOSVISN
              GOTO      GELW9500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      GELW1100
.
. no records
.
GELW1150  MOVE      ONE,F7
          MOVE      "a",ANS
.
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          GOTO      GELW9500
.
GELW9000  MOVE      ONE,EXIT                  * Passcode allocation full
          GOTO      GELW9999
.
GELW9500  MOVE      KEY8,PTCNELGN
          WRITAB    CONTROLF,HUND18;*117,PTCNELGN
.
          MATCH     "00000000",WBEFELGN
          GOTO      GELW0100 IF EQUAL
.
GELW9999  CALL      RELSLK00
          RETURN
+
.*****************************************************************************
.*                              CNCW0000           Called by: WPAT0000       *
.*     See if the patient has concession card of DVA type on file            *
.* Requires: PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CNCW0000  MOVE      SP70,DIM20
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CNCW0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CNCW9100               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CNCW9100 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CNCW0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CNCW0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CNCW0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card type ?
          GOTO      CNCW0500 IF NOT EQUAL        * no - ignore record
.
.         A DVA concession card has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CNCW1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      CNCW9100 IF LESS             * no - nothing found
.
.         Concession card is current
.
CNCW1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CNCW9100 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,EXIT
          GOTO      CNCW9999
.
CNCW9100  MOVE      ONE,EXIT
.
CNCW9999  RETURN
+
.*******************************************************************************
.        Free Format Eclipse OECW for Medical Bookings
.*******************************************************************************
FOEW0000  MATCH     "1",PTCNWSIN
          GOTO      FOEW9999 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      FOEW9999 IF NOT EQUAL
.
          COMPARE   "1",OECWINDC
          GOTO      FOEW9999 IF NOT EQUAL
.
          CALL      CLWEBELF
.
          CALL      GELW0000           * Generate Eligibility Number
          BRANCH    EXIT,FOEW9999
.
          CALL      STEW0000
.
          PACK      KEY8,WBEFELGN,SP70
          CALL      RAWBELF1
          IF        OVRCD=0
            GOTO      FOEW9999
          ENDIF
.
          CALL      WRWBELF1
.
          CALL      CLWEBOEC
          CALL      SEWOEC00
.
          PACK      KEY11,WBEFELGN,SP1,SP1,ONE,SP70
          CALL      RAWBOEC1
          IF        OVRCD=0
            GOTO      FOEW9999
          ENDIF

          CALL      IBACLOCK
          PACK      WBOCUDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOCUDTE
          MOVE      CTIMEIS,WBOCUTIM
          MOVE      USERID,WBOCUUID
.
          CALL      WRWBOEC1
.
          CALL      SEWOES00
.
FOEW9999  RETURN
+
.*******************************************************************************
.         Set up free format OECW fields
.*******************************************************************************
STEW0000
.         MOVE      DBKREBOO,WBEFELGN
          MOVE      DBKREBOO,WBEFVISN
          MOVE      DIM3CNTR,WBEFCNTR
          MOVE      ZERO,WBEFFLAG
          PACK      WBEFSPAR,SP70,SP70
          MOVE      BKREURNO,WBEFURNO
          MOVE      FFOECIND,WBEFOECC
          MOVE      PTITL,WBEFTITL
          MOVE      PGNAME,WBEFFNAM
          MOVE      PSNAME,WBEFSNAM
          MOVE      SP70,WBEFHFGN
          MOVE      SP70,WBEFHFSN
          MOVE      PSEX,WBEFGEND
          MOVE      PBDATE,WBEFBDAT
          MOVE      BKREEDAT,WBEFEADT
.
          MATCH     SP70,PTELF011
          IF        !@EQUAL
            MOVE      PTELF011,WBEFISTY
          ENDIF
.
          MOVE      BKREELOS,WBEFPLOS
.
          MATCH     SP70,PTELF013
          IF        !@EQUAL
            MOVE      PTELF013,WBEFDINT
          ENDIF
.
          MATCH     SP70,PTELF014
          IF        !@EQUAL
            MOVE      PTELF014,WBEFPEAI
          ENDIF
.
          MATCH     SP70,PTELF015
          IF        !@EQUAL
            MOVE      PTELF015,WBEFEMAD
          ENDIF
.
          MATCH     SP70,PTELF016
          IF        !@EQUAL
            MOVE      PTELF016,WBEFPRIC
          ENDIF
.
          MATCH     SP70,DIM9PRIM
          IF        !@EQUAL
            MOVE      DIM9PRIM,WBEFPRIM
          ENDIF
.
          MOVE      BKRECLMT,WBEFCLTY
          MOVE      PFUNDH,WBEFHFND
          MOVE      PFNDTB,WBEFHFNT
          MOVE      PFNDMM,WBEFHFMN
          MOVE      BKDIDES1,WBEFDIAG
.
          MOVE      SP70,WBEFSRV1
          MATCH     SP70,PTELF023
          IF        !@EQUAL & !@EOS
            MOVE      PTELF023,WBEFSRV1
          ENDIF
.
          MOVE      SP70,WBEFSRV2
          MATCH     SP70,PTELF024
          IF        !@EQUAL & !@EOS
            MOVE      PTELF024,WBEFSRV2
          ENDIF
.
          MOVE      SP70,WBEFSRV3
          MATCH     SP70,PTELF025
          IF        !@EQUAL & !@EOS
            MOVE      PTELF025,WBEFSRV3
          ENDIF
.
          MOVE      SP70,WBEFSRV4
          MATCH     SP70,PTELF026
          IF        !@EQUAL & !@EOS
            MOVE      PTELF026,WBEFSRV4
          ENDIF
.
          MOVE      SP70,WBEFSRV5
          MATCH     SP70,PTELF027
          IF        !@EQUAL & !@EOS
            MOVE      PTELF027,WBEFSRV5
          ENDIF
.
          MOVE      WBSEUID,WBEFCUID
          CALL      IBACLOCK
          PACK      WBEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBEFCTIM
.
          MATCH     SP70,PTELF033
          IF        !@EQUAL
            MOVE      PTELF033,WBEFDVAN
          ENDIF
.
STEW9999  RETURN
+
.*******************************************************************************
.        Set weboes variables
.*******************************************************************************
SEWOES00  MATCH     SP70,WBEFSRV1
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  1",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV1,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     SP70,PTELF028
            IF        !@EQUAL
              MOVE      PTELF028,WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV2
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  2",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV2,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     SP70,PTELF029
            IF        !@EQUAL
              MOVE      PTELF029,WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV3
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  3",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV3,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     SP70,PTELF030
            IF        !@EQUAL
              MOVE      PTELF030,WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV4
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  4",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV4,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     SP70,PTELF031
            IF        !@EQUAL
              MOVE      PTELF031,WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV5
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  5",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV5,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     SP70,PTELF032
            IF        !@EQUAL
              MOVE      PTELF032,WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
SEWOES99  RETURN
+
.*******************************************************************************
.        Set weboec variables
.*******************************************************************************
SEWOEC00
.         MOVE      WBEFELGN,WBOCVISN
          MOVE      WBEFELGN,WBOCELEG
          MOVE      WBEFVISN,WBOCVISN
          MOVE      DIM3CNTR,WBOCCNTR
          MOVE      " 0",WBOCSTAT
          MOVE      WBEFURNO,WBOCURNO
          MOVE      WBEFVISN,WBOCARID
          PACK      WBOCARID,WBOCARID,SP70
          LJUSTIFY  WBOCARID
          MOVE      SP70,WBOCTRID
          CALL      IBACLOCK
          PACK      WBOCRQDT,CCC,CYY,CMM,CDD
          REP       " 0",WBOCRQDT
          MOVE      SP70,WBOCETYP
          MOVE      SP70,WBOCERRC
          PACK      WBOCERRD,SP70,SP70
          PACK      WBOCCDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOCCDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBOCCTIM
          MOVE      SP70,WBOCUDTE
          MOVE      SP70,WBOCUTIM
          MOVE      SP70,WBOCHOSP
.
          MOVE      USERID,WBOCCUID
          MOVE      SP70,WBOCUUID

          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,WBOCHOSP
          ENDIF
.
          MOVE      SP70,WBOCSPAR
.
SEWOEC99  RETURN
+
.*******************************************************************************
.        Delete Preferences
.*******************************************************************************
DELPRF00  MATCH     "1",AUTOPREF
          GOTO      DELPRF99 IF NOT EQUAL
.
DELPRF10  PACK      KEY32,OPDAUNIQ,SP70
          CALL      RSOPPRF1
          CALL      RKOPPRF1
          BRANCH    OVRCD,DELPRF99
.
          MATCH     OPDAUNIQ,OPPRUNIQ
          GOTO      DELPRF99 IF NOT EQUAL
.
          PACK      KEY32,OPPRUNIQ,OPPRTEAM,OPPRDCOD,OPPRPREF,SP70
          CALL      DEOPPRF1
.
          GOTO      DELPRF10 
.
DELPRF99  RETURN
+
.*******************************************************************************
.        Free Format OECW Theatre Booking Only
.*******************************************************************************
FBOOEC00  MATCH     "1",BOKRX039            * if oec indicator = 1
          GOTO      FBOOEC99 IF NOT EQUAL        
.
.          MOVE      "  1",DIM3CNTR
          CALL      GNXOEB00
          MOVE      OPERPRV1,DIM9PRIM
          CALL      FOEB0000
.
          MOVE      PTVIS111,SAVDIM3
          MOVE      SP70,PTVIS111
.
          MATCH     Z70,OPERPRV2
          IF        !@EQUAL
            MATCH     SP70,OPERPRV2
            IF        !@EQUAL & !@EOS
.              MOVE      "  2",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV2,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV3
          IF        !@EQUAL
            MATCH     SP70,OPERPRV3
            IF        !@EQUAL & !@EOS
.              MOVE      "  3",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV3,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV4
          IF        !@EQUAL
            MATCH     SP70,OPERPRV4
            IF        !@EQUAL & !@EOS
.              MOVE      "  4",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV4,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV5
          IF        !@EQUAL
            MATCH     SP70,OPERPRV5
            IF        !@EQUAL & !@EOS
.              MOVE      "  5",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV5,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV6
          IF        !@EQUAL
            MATCH     SP70,OPERPRV6
            IF        !@EQUAL & !@EOS
.              MOVE      "  6",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV6,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV7
          IF        !@EQUAL
            MATCH     SP70,OPERPRV7
            IF        !@EQUAL & !@EOS
.              MOVE      "  7",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV7,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV8
          IF        !@EQUAL
            MATCH     SP70,OPERPRV8
            IF        !@EQUAL & !@EOS
.              MOVE      "  8",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV8,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPRV9
          IF        !@EQUAL
            MATCH     SP70,OPERPRV9
            IF        !@EQUAL & !@EOS
.              MOVE      "  9",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPRV9,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR10
          IF        !@EQUAL
            MATCH     SP70,OPERPR10
            IF        !@EQUAL & !@EOS
.              MOVE      " 10",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR10,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR11
          IF        !@EQUAL
            MATCH     SP70,OPERPR11
            IF        !@EQUAL & !@EOS
.              MOVE      " 11",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR11,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR12
          IF        !@EQUAL
            MATCH     SP70,OPERPR12
            IF        !@EQUAL & !@EOS
.              MOVE      " 12",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR12,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR13
          IF        !@EQUAL
            MATCH     SP70,OPERPR13
            IF        !@EQUAL & !@EOS
.              MOVE      " 13",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR13,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR14
          IF        !@EQUAL
            MATCH     SP70,OPERPR14
            IF        !@EQUAL & !@EOS
.              MOVE      " 14",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR14,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MATCH     Z70,OPERPR15
          IF        !@EQUAL
            MATCH     SP70,OPERPR15
            IF        !@EQUAL & !@EOS
.              MOVE      " 15",DIM3CNTR
              CALL      GNXOEB00
              MOVE      OPERPR15,DIM9PRIM
              CALL      FOEB0000
            ENDIF
          ENDIF
.
          MOVE      SAVDIM3,PTVIS111
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          IF        OVRCD=0
            MOVE      ONE,BKRXPOEC
            CALL      UPBKRX11
          ENDIF          
.
FBOOEC99  RETURN
+
.*******************************************************************************
.        Free Format Eclipse OECW for Theatre Bookings Only
.*******************************************************************************
FOEB0000  MATCH     "1",PTCNWSIN
          GOTO      FOEB9999 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      FOEB9999 IF NOT EQUAL
.
          COMPARE   "1",OECWINDC
          GOTO      FOEB9999 IF NOT EQUAL
.
          CALL      CLWEBELF
.
          CALL      GELW0000           * Generate Eligibility Number
          BRANCH    EXIT,FOEB9999
.
          CALL      STEB0000
.
          PACK      KEY8,WBEFELGN,SP70
          CALL      RAWBELF1
          IF        OVRCD=0
            GOTO      FOEB9999
          ENDIF
.
          CALL      WRWBELF1
.
          CALL      CLWEBOEC
          CALL      SEBOEC00
.
          PACK      KEY11,WBEFELGN,SP1,SP1,ONE,SP70
          CALL      RAWBOEC1
          IF        OVRCD=0
            GOTO      FOEB9999
          ENDIF
.
          CALL      IBACLOCK
          PACK      WBOCUDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOCUDTE
          MOVE      CTIMEIS,WBOCUTIM
          MOVE      USERID,WBOCUUID

          CALL      WRWBOEC1
.
          CALL      SEBOES00
.
FOEB9999  RETURN
+
.*******************************************************************************
.         Set up free format OECW fields Theatre Booking Only
.*******************************************************************************
STEB0000  MOVE      DBKREBOO,WBEFVISN
          MOVE      DIM3CNTR,WBEFCNTR
          MOVE      ZERO,WBEFFLAG
          PACK      WBEFSPAR,SP70,SP70
          MOVE      BKREURNO,WBEFURNO
.
          MATCH     Z70,BOKRX039
          IF        !@EQUAL
            MOVE      BOKRX039,WBEFOECC
          ENDIF
.
          MOVE      PTITL,WBEFTITL
          MOVE      PGNAME,WBEFFNAM
          MOVE      PSNAME,WBEFSNAM
          MOVE      SP70,WBEFHFGN
          MOVE      SP70,WBEFHFSN
          MOVE      PSEX,WBEFGEND
          MOVE      PBDATE,WBEFBDAT
          MOVE      BKREEDAT,WBEFEADT
.
          MATCH     Z70,PTVIS043
          IF        !@EQUAL
            MOVE      PTVIS043,WBEFISTY
          ENDIF
.
.         MOVE      BKREELOS,WBEFPLOS
          MATCH     Z70,PTMIS030
          IF        !@EQUAL
            MOVE      PTMIS030,WBEFPLOS
          ENDIF
.
          MATCH     Z70,PTVIS076
          IF        !@EQUAL
            MOVE      PTVIS076,WBEFDINT
          ENDIF
.
          MATCH     Z70,PTELG014
          IF        !@EQUAL
            MOVE      PTELG014,WBEFPEAI
          ENDIF
.
          MATCH     Z70,PTELG033
          IF        !@EQUAL
            MOVE      PTELG033,WBEFEMAD
          ENDIF
.
          MATCH     Z70,PTVIS111
          IF        !@EQUAL
            MOVE      PTVIS111,WBEFPRIC
          ENDIF
.
          MATCH     SP70,DIM9PRIM
          IF        !@EQUAL
            MOVE      DIM9PRIM,WBEFPRIM
          ENDIF
.
          MOVE      BKRECLMT,WBEFCLTY
.         MOVE      PFUNDH,WBEFHFND
.         MOVE      PFNDTB,WBEFHFNT
.         MOVE      PFNDMM,WBEFHFMN
.
          MATCH     Z70,PTMIS013
          IF        !@EQUAL
            MOVE      PTMIS013,WBEFHFND
          ENDIF
.
          MATCH     Z70,PTMIS014
          IF        !@EQUAL
            MOVE      PTMIS014,WBEFHFNT
          ENDIF
.
          MATCH     Z70,PTMIS015
          IF        !@EQUAL
            MOVE      PTMIS015,WBEFHFMN
          ENDIF
.
.         MOVE      BKDIDES1,WBEFDIAG
          MATCH     Z70,PTMIS020
          IF        !@EQUAL
            MOVE      PTMIS020,WBEFDIAG
          ENDIF
.
          MOVE      SP70,WBEFSRV1
          MATCH     WEBOS005[1],Z70
          IF        !@EQUAL
            MOVE      WEBOS005[1],WBEFSRV1
          ENDIF
.
          MOVE      SP70,WBEFSRV2
          MATCH     WEBOS005[2],Z70
          IF        !@EQUAL
            MOVE      WEBOS005[2],WBEFSRV2
          ENDIF
.
          MOVE      SP70,WBEFSRV3
          MATCH     WEBOS005[3],Z70
          IF        !@EQUAL
            MOVE      WEBOS005[3],WBEFSRV3
          ENDIF
.
          MOVE      SP70,WBEFSRV4
          MATCH     WEBOS005[4],Z70
          IF        !@EQUAL
            MOVE      WEBOS005[4],WBEFSRV4
          ENDIF
.
          MOVE      SP70,WBEFSRV5
          MATCH     WEBOS005[5],Z70
          IF        !@EQUAL
            MOVE      WEBOS005[5],WBEFSRV5
          ENDIF
.
          MOVE      WBSEUID,WBEFCUID
          CALL      IBACLOCK
          PACK      WBEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBEFCTIM
.
          CALL      CNCW0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      WBEFDVAN,SP70                * No
          ELSE
            MOVE      DIM20,WBEFDVAN               * yes
          ENDIF
.
STEB9999  RETURN
+
.*******************************************************************************
.        Set weboec variables Theatre Booking Only
.*******************************************************************************
SEBOEC00  MOVE      WBEFELGN,WBOCELEG
          MOVE      WBEFVISN,WBOCVISN
          MOVE      DIM3CNTR,WBOCCNTR
          MOVE      " 0",WBOCSTAT
          MOVE      WBEFURNO,WBOCURNO
          MOVE      WBEFVISN,WBOCARID
          PACK      WBOCARID,WBOCARID,SP70
          LJUSTIFY  WBOCARID
          MOVE      SP70,WBOCTRID
          CALL      IBACLOCK
          PACK      WBOCRQDT,CCC,CYY,CMM,CDD
          REP       " 0",WBOCRQDT
          MOVE      SP70,WBOCETYP
          MOVE      SP70,WBOCERRC
          PACK      WBOCERRD,SP70,SP70
          PACK      WBOCCDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOCCDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBOCCTIM
          MOVE      SP70,WBOCUDTE
          MOVE      SP70,WBOCUTIM
          MOVE      SP70,WBOCHOSP
.
          MOVE      USERID,WBOCCUID
          MOVE      SP70,WBOCUUID
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,WBOCHOSP
          ENDIF
.
          MOVE      SP70,WBOCSPAR
.
SEBOEC99  RETURN
+
.*******************************************************************************
.        Set weboes variables Theatre Booking Only
.*******************************************************************************
SEBOES00  MATCH     SP70,WBEFSRV1
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  1",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV1,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     WEBOS006[1],Z70
            IF        !@EQUAL
              MOVE      WEBOS006[1],WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV2
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  2",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV2,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     WEBOS006[2],Z70
            IF        !@EQUAL
              MOVE      WEBOS006[2],WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV3
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  3",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV3,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     WEBOS006[3],Z70
            IF        !@EQUAL
              MOVE      WEBOS006[3],WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV4
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  4",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV4,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     WEBOS006[4],Z70
            IF        !@EQUAL
              MOVE      WEBOS006[4],WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
          MATCH     SP70,WBEFSRV5
          IF        !@EQUAL & !@EOS
            CALL      CLWEBOES
.           MOVE      WBEFELGN,WBOSVISN
            MOVE      WBEFVISN,WBOSVISN
            MOVE      DIM3CNTR,WBOSCNTR
            MOVE      "  5",WBOSSCNT
            MOVE      "6",WBOSRTYP
            MOVE      WBEFSRV5,WBOSITEM
.
            MOVE      "  1",WBOSQUAN
            MATCH     WEBOS006[5],Z70
            IF        !@EQUAL
              MOVE      WEBOS006[5],WBOSQUAN
            ENDIF
.
            MOVE      WBEFEADT,WBOSPDTE
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
            MOVE      SP70,WBOSTRID
            MOVE      SP70,WBOSMSID
            MOVE      SP70,WBOSELEG
            MOVE      SP70,WBOSSPAR
.
            PACK      KEY14,WBOSVISN,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ENDIF
          ENDIF
.
SEBOES99  RETURN
+
.*******************************************************************************
.        Get Next weboecaf report counter Theatre Bookings Only
.*******************************************************************************
GNXOEB00  MATCH     "1",PTCNOECW
          IF        !@EQUAL
            GOTO      GNXOEB99
          ENDIF
.
          MOVE      "  1",DIM3CNTR
          PACK      KEY11,DBKREBOO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1
          BRANCH    OVRCD,GNXOEB99
.
          MATCH     DBKREBOO,WBOCVISN
          GOTO      GNXOEB99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   WBOCCNTR
          MOVE      WBOCCNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,DIM3CNTR
.
GNXOEB99  RETURN
+
.*******************************************************************************
.        Update PMI fields for OEC Theatre Booking
.*******************************************************************************
UPDMAS00  MATCH      "1",OECMINDC
          GOTO       UPDMAS99 IF NOT EQUAL
.
          MATCH      SP70,BKREURNO
          GOTO       UPDMAS99 IF EQUAL
          GOTO       UPDMAS99 IF EOS
.
          PACK       KEY8,BKREURNO,SP70
          CALL       RDMAST1
          BRANCH     OVRCD,UPDMAS99
.
          MATCH     Z70,PTMIS013
          IF        !@EQUAL
            MOVE      PTMIS013,PFUNDH
          ENDIF
.
          MATCH     Z70,PTMIS014
          IF        !@EQUAL
            MOVE      PTMIS014,PFNDTB
          ENDIF
.
          MATCH     Z70,PTMIS015
          IF        !@EQUAL
            MOVE      PTMIS015,PFNDMM
          ENDIF
.
          CALL      UPMAST1
.
UPDMAS99  RETURN
.
+
.******************************************************************************
.*                  display tourniquet for theatre details                    *
.******************************************************************************
TOUR0000  PACK      KEY13,OPDAUNIQ,F1,Z70
          CALL      RSOPTQE1
          CALL      RPOPTQE1
          BRANCH    OVRCD,TOUR0200
.
          MATCH     OPTQUNID,OPDAUNIQ
          GOTO      TOUR0200 IF NOT EQUAL
          MOVE      F1,DIM1
          MATCH     OPTQRTYP,DIM1
          GOTO      TOUR0200 IF NOT EQUAL
.
          GOTO      TOUR9999
.
TOUR0200  CALL      CLOPRTQE
          MOVE      ZERO,OPTQCNTR
          GOTO      TOUR9999
.
TOUR9999  RETURN
.
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.******************************************************************************
. FHIR Location Resource
.******************************************************************************
RESLOC00  STRIP     OPRMDESC
          CLEAR     KEY16
          APPEND    "Theatre-",KEY16
          APPEND    OPRMROOM,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": #"",OPRMDESC,"#"":
                    " } "
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      DSADD1,PRACNAME       * use hcp details
          MOVE      DSADD2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      DSADD3,PRACADD3
          MOVE      DSADD4,PRACADD4
          MOVE      DSPOST,PRACPOST
          MOVE      PTDOSEML,PRACPEML
          MOVE      DTELES,PRACPTEL
          MOVE      PTDOFAXN,PRACPFAX
          MOVE      DPROV,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,DRTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",DCODE,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",DCODE,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",DTITL,"#" ],":
                    "  #"given#": [ #"",DGNAME,"#" ],":
                    "  #"family#": #"",DSNAME,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PTDOMOBL,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.*****************************************************************************
.*        I/O Includes                                                       *
.*****************************************************************************
          INC       IBAWEBCD    * Standard WEB Functions
          INC       WEBDATCD
          INC       BEDBDPRO
          INC       BOKRECTM    * Template Fill-in for Booking Details
          INC       BOKRX1TM
          INC       BOKRQ1TM
          INC       OPRABITM
          INC       OPRCPITM
          INC       CALCAGE
          INC       CLOPRTSM
          INC       CLPATATR
          INC       CLBOKRC1
          INC       CLBOKRX1
          INC       CLBOKRQ1
          INC       CLBOKRAU
          INC       CLNHIMAS
          INC       CLOPRSRG
          INC       CLOPRABI
          INC       CLOPRCPI
          INC       CLPATDSC
          INC       CLPATELG
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATRE1
          INC       CLPATTRN
          INC       CLPMSELF
          INC       CLPMSOEC
          INC       CLPMSOES
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPMSWX1
          INC       CLOPRTQE
          INC       CLOPRDEA
          INC       CLOPRARD
          INC       CLWATOPA
          INC       CLWATTR1
          INC       CLWATTX1
          INC       CLWEBOEC
          INC       CLWEBOES
          INC       CLWEBELF
          INC       DAYOFWEK
          INC       DGCLICCB    * Cancel Booking API for DG *I-90202
          INC       DGCLICCP    * HL7 Broadcast Pre-Admission Change
          INC       DGCLICPA    * Cancel Pre-Ad API for DG
          INC       DGCLICUB    * Pre-Ad Booking API for DG *I-90202
          INC       DGCLIS12
          INC       DGCLIS14
          INC       DGCLIS15
          INC       DGCLIUWL                * HL7 Update W/L Entry
          INC       UPEADMVS    * Update Visit number on eAdmission
          INC       GENBOKNO
          INC       IBALPCCD
          INC       NAMSTRCD    * Create Name String
          INC       NZPSPRTM
          INC       OPADDTIM
          INC       OPCLRPMI    * Clear PMI Variables
          INC       OPHISSUB
          INC       OPTHETAT    * Theatre Audit
          INC       OPMAKBOK    * Create Booking
          INC       OPMVSBOK    * Move Booking
          INC       OPRARDTM
          INC       OPRCASTM    * Template Fill-in for Case File
          INC       OPRPOCTM
          INC       OPRSESTM    * Template Fill-in for Session File
          INC       OPRSRGTM
          INC       OPUPDPMI    * Post PMI
          INC       OPUPDURA    * Post PMI
          INC       OPWEBCAN    * Cancel Booking
          INC       OPWEBPST    * Post Booking
          INC       OPWEBSTT    * Adjust Start times
          INC       OPWEBTRN    * Transfer Booking
          INC       PATATRTM
          INC       PATCOMN2
          INC       PATCLMTM
          INC       PATDOCCD    * Formate Doctors Name
          INC       PATDOCTM    * Template Fill-in for Doctors File
          INC       PATMASTM    * Template Fill-in for Patient Master File
          INC       PATMISTM
          INC       PATMSXTM
          INC       PATNAMCD    * Formate Patient Name
          INC       PATVADCK
          INC       PMIGTNID
          INC       PMSOECTM
          INC       PMSOESTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       WATDETTM
          INC       WATTX1TM
          INC       VISCODTM
          INC       WEBOECTM
          INC       WEBOESTM
          INC       WLHISSUB
          INC       LSTALERT        * Alerts column in Patient List   *I-200963
          INC       CINVPEND
.
          INC       IBAPOLIO/INC
          INC       ACCDIAIO/INC
          INC       APSMASIO/INC
          INC       BOKBUDIO/INC
          INC       BOKDIAIO/INC
          INC       BOKRAUIO/INC
          INC       BOKRQ1IO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       CATCOMIO/INC
          INC       COMDEPIO/INC
          INC       COMERHIO/INC
          INC       EMRICDIO/INC
          INC       EMRVISIO/INC
          INC       IBALPCIO/INC   * Print file for labels and forms
          INC       MLTHCPIO/INC
          INC       MRTMASIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NZPSPRIO/INC
          INC       OPRABIIO/INC
          INC       OPRARDIO/INC
          INC       OPRAVEIO/INC
          INC       OPRCBDIO/INC
          INC       OPRCLIIO/INC   * Added for OPRSESTM Recomplie
          INC       OPRCOMIO/INC                                       *I-50678
          INC       OPRCPIIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDEBIO/INC
          INC       OPRDECIO/INC
          INC       OPRDEDIO/INC
          INC       OPRDPHIO/INC
          INC       BOKUNQIO/INC
          INC       OPREXPIO/INC
          INC       OPRHISIO/INC
          INC       OPRITEIO/INC
          INC       OPRNURIO/INC
          INC       OPROPRIO/INC
          INC       OPRPMBIO/INC
          INC       OPRPOCIO/INC
          INC       OPRPRFIO/INC
          INC       OPRRALIO/INC
          INC       OPRREQIO/INC
          INC       OPRRCIIO/INC
          INC       OPRSEMIO/INC
          INC       OPRSESIO/INC
          INC       OPRSRGIO/INC
          INC       OPRTSMIO/INC
          INC       OPRTRAIO/INC
          INC       OPRTPSIO/INC
          INC       OPRWCNIO/INC
          INC       OUTSITIO/INC
          INC       OPRTQEIO/INC
          INC       PATALRIO/INC
          INC       PATASFIO/INC
          INC       PATATRIO/INC
          INC       PATBMDIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDADIO/INC
          INC       PATDGWIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC                                     *T0845646
          INC       PATECOIO/INC                                     *T0845646
          INC       PATELGIO/INC
          INC       PATFN1IO/INC
          INC       PATGSRIO/INC
          INC       PATHSPIO/INC
          INC       PATICOIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATNIDIO/INC
          INC       PATPA1IO/INC
          INC       PATPNIIO/INC
          INC       PATPR1IO/INC
          INC       PATRGMIO/INC
          INC       PATRE1IO/INC
          INC       PATTRNIO/INC
          INC       PATURAIO/INC
          INC       PATUNAIO/INC
          INC       PATVADIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSCCDIO/INC
          INC       PMSCURIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSELFIO/INC
          INC       PMSMTIIO/INC            * Misc.theatre item table
          INC       PMSNUTIO/INC
          INC       PMSOECIO/INC
          INC       PMSOESIO/INC
          INC       PMSRFLIO/INC
          INC       PMSPX2IO/INC
          INC       PMSREGIO/INC
          INC       PMSTLEIO/INC
          INC       PMSRELIO/INC
          INC       PMSVX1IO/INC
          INC       PMSWX1IO/INC
          INC       PATWVEIO/INC
          INC       PMSCTCIO/INC
          INC       PATEORIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       RESLNKIO/INC
          INC       SCRMASIO/INC
          INC       WATCHAIO/INC
          INC       WATHISIO/INC
          INC       WATLETIO/INC
          INC       WATMESIO/INC
          INC       WATOPAIO/INC
          INC       WATPACIO/INC
          INC       WATPROIO/INC
          INC       WATRTDIO/INC
          INC       WATMHDIO/INC
          INC       WATMTXIO/INC
          INC       WATESEIO/INC
          INC       WATESNIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATVWLIO/INC
          INC       WEBOECIO/INC
          INC       WEBOESIO/INC
          INC       WEBELFIO/INC
          INC       VISCODIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       MEHVI1IO/INC
          INC       PMSALNIO/INC
          INC       FHRDATCD
          INC       PMSCURTH
          INC       OPRAAETM
          INC       OPRAAEIO/INC
          INC       OPRMBSIO/INC
          INC       OPRWCNWK
          INC       TFILENAM
          INC       OPTHCMPL           * Theatre complete (all charges posted)
          INC       FHROPRCD           * FHIR Output Routines for Theatre Appointments
          INC       GENANVIS
          INC       CLOPRSES
          INC       UPEREFVS

