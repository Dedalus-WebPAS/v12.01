.-----------------------------------------------------------------------------
. Program       : IBAMRT53
.
. Function      : Medical Records Coding Extract Server
.
. Modifications : 
.-----------------------------------------------------------------------------
. V12.00.02 27/10/2025  Ebon Clements  TSK 0964542
.           Recompiled for WEBGROUP - Load Codefinder clinician date and time
. V12.00.01 19/05/2025 Thanh T         TSK 0955096
.           Changed for alphanumeric visit number
.-----------------------------------------------------------------------------
.V11.05.10  17/04/2025  Ebon Clements TSK 0950532
.           Save cluster id from coding template - SAVDIS00
.V11.05.09  08/04/2025  Ebon Clements TSK 0950532
.           Added diagnosis cluster id functionality 
.           14/04/2025  Davin         TSK 0951723
.           Recompiled for WEBGROUP - send 'I' procedures to grouper
.V11.05.08  27/03/2025  Davin         TSK 0956210
.           Recompiled for WEBGROUP - DRG Version 12.0
.V11.05.07  20/03/2025  Davin         TSK 0956210
.           Recompiled for VALDIOPS (ICD10 Ed.13)
.V11.05.06  11/03/2025  Thanh T          TSK 0949724
.           Changed AUTOC000 to update PMVXUVTH field   
.V11.05.05  07/03/2025  Ebon Clements    TSK 0944729
.           Recompiled for WEBGROUP - Load Codefinder QLD complication prefix
.V11.05.04  06/03/2025  Thanh T          TSK 0949724
.           Recompiled for MRTEXTFD changes
.V11.05.03  06/02/2025  Ebon Clements    TSK 0956930
.           Recompiled for WEBGROUP - Clear grouper vars
.V11.05.02  04/02/2025  Ebon Clements    TSK 0951861
.           Recompiled for WEBGROUP - Added OPRTSMFD
.V11.05.01  15/11/2024  Davin            TSK 0950787
.           Recompiled for WEBGROUP - Send CTYPE Tag to Codefinder (MRCNSCTC)
.V11.04.05  18/10/2024  Davin            TSK 0922271
.           Recompiled for WEBGROUP - allow grouper to handle up to 100 codes
.V11.04.04  05/07/2024  Ebon Clements  TSK 0948817
.           Recompiled for WEBGROUP - CGS/Codefinder Separation mode
.V11.04.03  17/06/2024  PJ Le Febour   TSK 0937495
.           Recompiled for WEBGROUP - get DCLs from new positions grouper v11
.V11.04.02  22/02/2024  Ebon Clements  TSK 0943354
.           Recompiled for WEBGROUP - TG export separation mode
.V11.04.01  25/01/2024  Davin          TSK 0928468
.           Recompiled for WEBGROUP - Added AMHCC Grouper
.V11.03.07  26/09/2023  Ebon Clements  TSK 0934837
.           Recompiled for WEBGROUP - Load Codefinder default clinician
.V11.03.06  04/09/2023  Ebon Clements  TSK 0936661
.           Recompiled for WEBGROUP - TurboGrouper QLD condition onset type
.V11.03.05  21/08/2023  Davin          TSK 0935074
.           Recompiled for WEBGROUP - loading operation codes from codefinder
.V11.03.04  05/07/2023  Ebon Clements  TSK 0934723
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
.           if discharged post DRG 11 go live
.V11.03.03  26/06/2023  Ebon Clements  TSK 0932535
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
.V11.03.02  25/05/2023  J.Tan          TSK 0923703
.           Removed DMDCCODE and DRGVER as they are defined in WEBDINVS
.V11.03.01  23/12/2022  Davin         TSK 0926029
.           Recompiled for WEBGROUP - Use pateco code/desc for non-hosp ops
.V11.02.07  14/06/2022 Ebon Clements  TSK 0906596
.           Recompiled for WEBGROUP - Charlson score 
.V11.02.06  02/06/2022 Ebon Clements  TSK 0902519
.           Recompiled for WEBGROUP - Aboriginality to use cat VA indicator 4
.V11.02.05  21/04/2022  Davin         TSK 0917793
.           Recompiled for WEBGROUP - DRG Version 11.0
.V11.02.04  30/03/3022  Davin         TSK 0917793
.           Recompiled for VALDIOPS (ICD10 Ed.12)
.V11.02.03  08/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG export/import operation times
.V11.02.02  10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
.V11.02.01  08/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG operation times
.V11.01.15  19/11/2021  Ebon Clements TSK 0911383
.           Recompiled for WEBGROUP - CGS Condition onset flag for NWAU
.V11.01.14  18/11/2021  Ebon Clements TSK 0911851
.           Recompiled for WEBGROUP - Codefinder/CGS - ICU NICU hrs
.V11.01.13  17/11/2021  Ebon Clements TSK 0911414
.           Recompiled for WEBGROUP - Export additional fields to TG
.V11.01.12  15/09/2021  Ebon Clements  TSK 0902389
.           Recompiled for WEBGROUP - Urgency of Admission
.V11.01.11  14/09/2021 Ebon Clements  TSK 0897701
.           Recompiled for WEBGROUP - Gender
.V11.01.10  20/08/2021 Ebon Clements  TSK 0909624
.           Recompiled for WEBGROUP - LOS
.V11.01.09 13/07/2021  Ebon Clements   TSK 0902615
.           Recompiled for WEBGROUP - Not using NWAU test
.V11.01.08  07/07/2021  Ebon Clements  TSK 0908708
.           Recompiled for WEBGROUP - ICU Hours
.V11.01.07  06/07/2021  Ebon Clements  TSK 0908709
.           Recompiled for WEBGROUP - Use cat S admission mode
.V11.01.06  30/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - Export Care Type to TG
.V11.01.05  30/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - Don't restrict codes for NWAU
.V11.01.04  29/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
.V11.01.03  22/06/2021  Ebon Clements  TSK 0907810
.           Recompiled for WEBGROUP - Contract care type flag
.V11.01.02  18/06/2021  Ebon Clements  TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
.V11.01.01  05/05/2021  Ebon Clements  TSK 0902615
.           Added read of NWAU parameters MRCNUNWA and MRCNENWA
.V11.00.10  08/10/2020  Ebon Clements  TSK 0892694
.           Recompiled for WEBGROUP - Export 6.2 DRG as 6.0x to TurboGrouper
.V11.00.09  08/10/2020  Ebon Clements  TSK 0892694  
.           Recompiled for WEBGROUP - Send health fund defails to TG 
.V11.00.08  08/10/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - WIES27 Aboriginal and Torres Strait
.           Islander loading
.V11.00.07  23/09/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - Added WIES27 for 2020/2021
.V11.00.06  10/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG version 10
.V11.00.05  08/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG versions
.           08/07/2020  J.Tan           TSK 0886178
.           Recompiled for WEBGROUP - automate calculate Charles scores
.V11.00.04  25/05/2020  Davin          TSK 0890603
.           Recompiled for WEBGROUP/WIESCALC - WIES for private facility
.V11.00.03  15/05/2020  Ebon Clements  TSK 0891590
.           Recompiled for WEBGROUP - TurboGrouper DRG version 6.2
.V11.00.02  31/03/2020  Ebon Clements  TSK 0889596
.           Recompiled for WEBGROUP - Call mrtweb02.us7 for TG import
.V11.00.01  10/03/2020  Jill Parkinson Task 0879163           
.           Added SEXDSCIO include                      
.V10.15.03  17/02/2020  Davin          TSK 0881493
.           Recompiled for WEBGROUP - restrict diag codes to grouper
.V10.15.02  12/11/2019  Nicole Torrisi TSK 0881409
.           Recompiled for WEBGROUP - Added HMV
.V10.15.01  09/10/2019  Ebon Clements  TSK 0877429
.           Added channel and job to TurbGrouper import/export file
.V10.14.15  03/10/2019  Thanh T        TSK 0882260
.           Recompiled for WEBGRPVA - DRG Version 11.0
.V10.14.14  02/10/2019  Ebon Clements  TSK 0877430
.           Populate TurboGrouper coded by user date and time
.V10.14.13  30/09/2019  Ebon Clements  TSK 0877428
.           Populate TurboGrouper campus code
.V10.14.12  26/08/2019  Davin          TSK 0880255
.           Recompiled for WIESCALC - Added WIES26 for 2019/2020
.V10.14.11  04/06/2019  Ebon Clements  TSK 0875790
.           Recompiled for WEBGROUP - TurboGrouper operation prefix
.V10.14.10  31/05/2019  Ebon Clements  TSK 0875696
.           Recompiled for WEBGROUP - TurboGrouper coder id
.V10.14.09  21/05/2019  Davin          TSK 0870480
.           Recompiled for WEBGROUP - Changed eccsraw codefinder tag
.V10.14.08  14/05/2019  Ebon Clements  TSK 0874778
.           Recompiled for WEBGROUP - TurboGrouper diagnosis codes
.V10.14.07  02/05/2019  Ebon Clements  TSK 0874135
.           Recompiled for WEBGROUP - TurboGrouper theatre date/time defaults
.V10.14.06  01/05/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP - Added TURBOSAV - Retain previous details
.V10.14.05  08/04/2019  Ebon Clements  TSK 0872901
.           Recompiled for WEBGROUP -  Auto Coding user id
.V10.14.04  27/03/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP -  Export leave days
.V10.14.03  19/03/2019  Don Nguyen     TSK 0869412
.           Recompiled for VALDIOPS - Added ICD10 Ed.11 - Go-live Date check
.V10.14.02  04/03/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper
.           27/02/2019  Richa Phogat   TSK 0870439
.           Recompiled for WEBGRPVA & WEBGROUP - DRG Version 10.0
.V10.14.01  25/02/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper 
.V10.13.05  24/01/2019  Ebon Clements  TSK 0869592
.           Recompiled for WEBGROUP - TurboGrouper
.V10.13.04  20/12/2018  Don Nguyen     TSK 0837732
.           Recompiled for WEBGROUP - Modified GODTM000 to get the first
.           matching MBS Item time values (if operation date exists).
.V10.13.03  01/11/2018  Davin            TSK 0852820
.           Recompiled for WEBGROUP - Use "TOTWT:" tag for nz wies
.V10.13.02  06/09/2018  Richa Phogat   TSK 0862786
.           Recompiled for WEBGROUP - Removed bypass Morphology
.V10.13.01  21/08/2018  Davin          TSK 0860935
.           Recompiled for WIESCALC - Added WIES25 for 2018/2019
.V10.12.04  05/06/2018  Ebon Clements    TSK 0845772
.           Recompiled for WEBGROUP - TurboGrouper diagnosis
.V10.12.03  04/05/2018  Ebon Clements    TSK 0845772
.           Recompiled for WEBGROUP - TurboGrouper
.V10.12.02  26/03/2018  Tracey Nguyen    TSK 0852793
.           Recompiled for WEBGRPVA & WEBGROUP - DRG Version 9.0
.V10.12.01  29/01/2018  Ania P           TSK 0851398
.           Recompiled for WEBGROUP
.V10.11.05  27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
.V10.11.04  15/12/2017  Peter Vela       TSK 0847747
.           Recompiled for WEBGROUP
.V10.11.03  11/12/2017  Don Nguyen       TSK 0848767
.           Recompiled for WEBGROUP - Modified GDSPX300 to include ACT
.V10.11.02  27/09/2017  Davin            TSK 0845070
.           Recompiled for WEBGROUP - fixed codefinder tag BWIES
.V10.11.01  15/08/2017  Davin            TSK 0842626
.           Recompiled for WIESCALC - Added WIES24 for 2017/2018
.-----------------------------------------------------------------------------
.V10.10.09  06/07/2017  Jill Parkinson TSK 0841688
.           Added check for IBCNMHOS before checking hospital in REGRP000
.V10.10.08  21/06/2017  Davin          TSK 0836775
.           Recompiled for WEBGROUP - mental health legal status
.V10.10.07  13/06/2017  J.Tan          TSK 0839991
.           Recompiled for PATDBTYP (PATGNFEE)
.V10.10.06  07/06/2017  Jill Parkinson TSK 0832750
.           Recompiled for WIESCALC - R64Z issues
.V10.10.05  01/06/2017  Don Nguyen     TSK 0838360
.           Recompiled for WEBGROUP - Fixed RLTAGS00
.           01/06/2017  Don Nguyen     TSK 0838196
.           Added WCFINPFN & WCFOUTFN. Recompiled for WEBGROUP.
.V10.10.04  25/05/2017  Jill Parkinson   TSK 0832750
.           Recompiled for wiescalc - use drg code position 2-3 to
.           decide if surgical                                   
.V10.10.03  28/04/2017  Davin          TSK 0836380
.           Recompiled for WEBGROUP
.V10.10.02  04/04/2017  J.Tan          TSK 0297904
.           Added WEBDINVS.INC       
.V10.10.01  17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Recompiled for VALDIOPS (ICD10 Ed.10)
.V10.09.04  18/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
.V10.09.03  16/01/2017  Ebon Clements  TSK 0826429
.           Added hospital filter to report 8 - Regroup Patients (UserId)
.V10.09.02  09/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
.V10.09.01  24/11/2016  Jill Parkinson TSK 0817492
.           Recompiled for WIESCALC - Added check for surgical procs
.V10.08.10  24/11/2016  Jill Parkinson TSK 0817492
.           Recompiled for WIESCALC - Added check for surgical procs
.V10.08.09  08/11/2016  Don Nguyen       TSK 0828544
.           Recompiled for WEBGROUP - Modified RLTAGS00
.V10.08.08  05/10/2016  Davin            TSK 0826104
.           Recompiled for WEBGROUP - importing codefinder procedure date
.V10.08.07  02/09/2016  Davin            TSK 0825157
.           Recompiled for WIESCALC
.V10.08.06  30/08/2016  Don Nguyen       TSK 0814947
.           Recompiled for WEBGROUP - Modified COPRS000 to check PT0ODTMN
.V10.08.05  26/08/2016  Don Nguyen       TSK 0312570
.           Recompiled for GETDRG (GTDRG000) - Call GTEDRG00 when PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
.V10.08.04  19/07/2016  Davin            TSK 0822753
.           Recompiled for WIESCALC - Added WIES23 functionality for 2016/2017
.V10.08.03  27/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - Modified RDUNIX1 & RDCME1
.V10.08.02  13/04/2016  Don Nguyen       TSK 0321353
.           Recompiled for WEBGROUP - Modified WRENC000 to use GETDRG
.V10.08.01  12/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - process "I10ECCSRAW:" & "HNIV:"
.-----------------------------------------------------------------------------
.V10.07.01  20/10/2015  Davin            CAR 316612
.           Added UCCA0000. Exit program if Using CCA Interface (mrcngrup=2)
.-----------------------------------------------------------------------------
.V10.06.09  30/07/2015  Don Nguyen       CAR 318792
.           Recompiled for WEBGROUP - Modified RLTAGS00 to use KEY200
.V10.06.08  01/07/2015  Don Nguyen       CAR 317693
.           Recompiled for VALDIOPS - Removed Area checks '3' & '4' in VOPCD200
.V10.06.07  18/06/2015  Don Nguyen       CAR 314792
.           Recompiled for WEBGROUP - Modified ENCDT000; output PTEDACDT
.V10.06.06  11/06/2015  Patrick Adair    CAR 313223
.           Recompiled for WEBGROUP - admission weight check
.V10.06.05  29/05/2015  Ebon Clements    CAR 317094
.           Re-compiled for WEBGRPVA & WEBGROUP - changes for DRG 8.0
.V10.06.04  10/04/2015  J.Tan            CAR 304813
.           Added WIESCALC
.V10.06.03  24/03/2015  Don Nguyen       CAR 314100
.           Recompiled for WEBGROUP - modified output for mrtweb02.us1/us2
.V10.06.02  17/03/2015  Davin            CAR 311669
.           Recompiled for VALDIOPS (ICD10 Ed.9)
.V10.06.01  12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.-----------------------------------------------------------------------------
.V10.05.02  18/09/2014  Davin            CAR 304204
.           Recompiled for GETDRG/GETDRGZ - get drg vers based on disch date
.V10.05.01  11/09/2014  Don Nguyen       CAR 302792
.           Recompiled for changes to VALDIOPS
.           09/09/2014  Davin            CAR 296980
.           Added 2014/2015 WIES21 file (patw21af)
.-----------------------------------------------------------------------------
.V10.04.02  03/07/2014  Ebon Clements    CAR 302036
.           Recompiled for WEBGROUP - Urgency of admission tag
.V10.04.01  13/03/2014  Don Nguyen       CAR 294888
.           Recompiled for changes to WEBGROUP
.-----------------------------------------------------------------------------
.V10.03.21  11/11/2013  Don Nguyen       CAR 293534
.           Opened 'patfn1af' for read in GETDRGZ
.V10.03.20  14/10/2013  Don Nguyen       CAR 282453
.           Recompiled for WEBGROUP
.V10.03.19  09/10/2013  Peter Vela       CAR 292070
.           Recompiled for WEBGROUP
.V10.03.18  04/10/2013  Peter Vela       CAR 284261
.           Recompiled for PATWIS19 PATWIS20
.V10.03.17  02/10/2013  Ania P           CAR 292081
.           Recompiled for WEBGROUP
.V10.03.16  09/09/2013  Ania P           CAR 290324
.           Added DIM3 and recompiled for WEBGROUP
.V10.03.15  10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIIO
.V10.03.14  29/08/2013  Ania P           CAR 290324
.           Added DIM3 and recompiled for WEBGROUP
.           02/09/2013  Davin            CAR 290919
.           Recompiled for PATWIS18/19/20
.V10.03.13  07/08/2013  Davin        CAR 284960
.           Added 2013/2014 WIES20 file (patw20af)
.V10.03.12  18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
.V10.03.11  03/05/2013  Davin            CAR 284669 HDP 2013 DRG 7.0
.           Re-compiled for WEBGRPVA & WEBGROUP - changes for DRG 7.0
.V10.03.10  23/04/2013  Davin         CAR 284420
.           Recompiled for VALDIOPS (ICD10 Ed.8)
.V10.03.09  25/02/2013  Ania P           CAR 281021
.           RECOMPILED for WEBGROUP 
.V10.03.08  20/09/2012  Davin            CAR 273279
.           Recompiled for PATWIS19
.V10.03.07  23/08/2012  Davin            CAR 271916
.           Recompiled for WEBGROUP
.V10.03.06  07/08/2012  Davin        CAR 270114
.           Added 2012/2013 WIES19 file (patw19af)
.V10.03.05  28/06/2012  Mike Laming      CAR 267797 HDP 2012 DRG 6.2
.           Re-compiled for WEBGRPVA & WEBGROUP - changes for DRG 6.2
.V10.03.04  18/06/2012  Don Nguyen       CAR 261697
.           Recompiled for WEBGROUP - Corrected default value of end date 
.           (EPENDDAT) for DAYSEP calculations in CPDATS00.
.V10.03.03  12/06/2012  Ebon Clements    CAR 262659
.           Added episode zero test to diagnosis codes - EXTALL00
.V10.03.02  07/05/2012  Mike Laming  CAR 262698
.           Added Date & Time fields for SETGRP00 - ENCSTDAT (using ADATE) &
.           ENCENDAT (for DDATE)
.V10.03.01  02/12/2011  Davin        CAR 251748
.           Recompiled for changes to PATWIS18
.V10.02.04  11/08/2011  Davin        CAR 238236
.           Added 2011/2012 WIES18 file (patw18af)
.V10.02.03  01/09/2011  Steve Armstrong   CAR 248500
.           Added DGCLICAC message triggers for coding.
.           Recompiled for changes to WEBGROUP.
.V10.02.02  08/07/2011  Ebon Clements  CAR 240724
.           Mods for MRT hospital/location - Added hospital to location key
.V10.02.01  28/03/2011  Mike Laming   CAR 240107                      
.           Mods to PATECDaf & PATECOaf variables & Keys - file change
.           Remove PATMDSFD/IO and routines DISSQE00 & PROSQE00
.V10.01.01 03/02/2011  Jill Parkinson CAR 233088
.           Added PMSVX1FD 
.V10.00.05  10/08/2010  Davin        CAR 227937
.           Recompiled for changes to PATWIS17
.V10.00.04  20/05/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
.V10.00.03  27/04/2010  Mike Laming   CAR 219246
.           Recompiled for VALDIOPS (ICD10 Ed.7)
.V10.00.02  10/04/2010  Mike Laming   CAR 208570
.           Recompiled for changes to PATCRDFD.
.V10.00.01  24/03/2010  Davin             CAR 216505
.           Added 2010/2011 WIES17 file (patw17af)
.-----------------------------------------------------------------------------
. V9.12.04  22/02/2010  Jill Parkinson    CAR 216443
.           Mods to set PTEDOSET for states other than qld
. V9.12.03  21/09/2009  J.Tan             CAR 205303
.           Added Contract ID
. V9.12.02  01/07/2009  Davin             CAR 199724
.           Added 2009/2010 WIES16 file (patw16af)
. V9.12.01  19/06/2009  Mike Laming      CAR 197814 HDP 2009 DRG 6.0
.           Re-compiled for WEBGRPVA & WEBGROUP - changes for DRG 6.0
.-----------------------------------------------------------------------------
. V9.11.01  03/03/2009  Mike Laming      CAR 190768
.           Recompiled for WEBGRPVA & WEBGROUP (were VAR41GRP & PAT41GRP)
.-----------------------------------------------------------------------------
. V9.10.04  25/09/1008  Davin            CAR 178428
.           Recompiled for PATWIS15 - radiotherapy drg modification
. V9.10.03  26/08/2008  Mike Laming       CAR 176293
.           Recompiled for VALDIOPS - correct "Posting Code" test
. V9.10.02  17/07/2008  Davin             CAR 163993
.           Added 2008/2009 WIES15 file (patw15af)
. V9.10.01  11/07/2008  Mike Laming   CAR 173199
.           Recompiled for VALDIOPS - fix "not a valid ICD10-AM-Ed.n Code" msg.
.-----------------------------------------------------------------------------
. V9.09.07  22/11/2007  Peter Vela    CAR 132264
.           Recompiled for PATCHCFD  
. V9.09.06  13/09/2007  Ebon Clements CAR 100599
.           Recompiled for VALDIOPS - Added OUTPFLAG
. V9.09.05  28/08/2007  Peter Vela       CAR 148631
.           Modified Terminal Digit for MRTRED CABRINI Health @ WRTRED00
. V9.09.04  28/07/2007  Steve Armstrong  CAR 148718
.           Recompiled for changes to PAT41GRP.
. V9.09.03  02/08/2007  Steve Armstrong  CAR 145161
.           Removed references to WIES 7, 8, 9 & 10 - no longer supported.
.           Recompiled for changes to PAT41GRP & VARDSOPS.
. V9.09.02  18/07/2007  Steve Armstrong   CAR 145161
.           Added 2007/2008 WIES14 file (patw14af)
. V9.09.01  22/06/2007  Ebon Clements CAR 143153
.           Populate web user id in patecdaf 
.-----------------------------------------------------------------------------
. V9.08.04  12/04/2007  Mike Laming   CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
. V9.08.03  12/04/2007  Mike Laming   CAR 137125 HDP 2007 DRG 5.2
.           Added DRGO52FN - recompiled for PAT41GRP & VAR41GRP
.           Added routine DCLM0000 (Get default claim code) to make it work
. V9.08.02  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
. V9.08.01  25/10/2006 Davin S         CAR 121542
.           Changed diagnostic onset type default (ptedoset)
. V9.07.05  11/09/2006  Peter Vela    CAR 118227
.           Added conditions for MREXATYP, MREXPTYP
. V9.07.04  17/07/2006  Peter Vela    CAR 112753
.           Recompiled for VALDIOPS
. V9.07.03  11/07/2006  Davin S       CAR 111764
.           Added 2006/2007 WIES13 file (patw13af)
. V9.07.02  10/07/2006  Peter Vela    CAR 111913
.           Recompiled for PAT41GRP
. V9.07.01  10/07/2006 Peter Vela      CAR 111913
.           Recompiled for PAT41GRP
. V9.06.03  25/05/2006 Davin S         CAR 104165
.           Added diagnostic onset type (ptedoset)
. V9.06.02  18/05/2006  Ebon Clements CAR 105051
.           Added multi hospital test to option 6 Automatic Coding
. V9.06.01  15/05/2006  Mike Laming   CAR 101974      2006 HDP
.           Add PTCNGDV5 for ICD10 Ed.5 Go-live
. V9.05.01  08/03/2006  Peter Vela    CAR 97775
.           Fixed display of option 6 Automatic Coding
.           Added option 8 Regroup patients with UserId
. V9.05.B01 07/02/2006  Peter Vela    CAR 92244
.           Recompiled for PAT41GRP
. V9.04.09  08/09/2005  Jill Habasque CAR 58848
.           Added keyin of USERID
. V9.04.08  25/07/2005  Peter Vela    CAR 66960
.           Added 2005/2006 WIES12 file (patw12bf)
. V9.04.07  24/05/2005  Mike Laming   CAR 61562    
.           July 2005 mods for DRG 5.1 - Recomp for PAT41GRP & VAR41GRP
. V9.04.06  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.05  13/12/2004  Henry Son        CAR 55406
.           Change CME to read new output format.
.           Re-compile PAT41GRP.
. V9.04.04  09/12/2004 Henry Son                      CAR 54882
.           Populate operation times from patmmbsf.
.           Add PATMMBFD for PAT41GRP Compile.
. V9.04.03  08/09/2004  Henry son                CAR 52585
.           Add Indeterminate to Sex check.
. V9.04.02  01/09/2004  Henry son                CAR 53126
.           Further changes for WIES12.
.           Diagnosis or procedure incompatible with SEX code.
.           Recompile for changes in PATWIS12.
. V9.04.01  30/08/2004  Jill Habasque            CAR 53046
.           Added hospital ID
. V9.03.12  26/07/2004  Henry Son                CAR 51504
.           Add WIES12 (2004/2005 changes)
. V9.03.11  16/07/2004  Pat Dirito               CAR 43698
.           Adding setting of PTEDTIME & PTEOTIME in AUTOC000
.           30/06/2004  Henry Son                CAR 50344
.           Call new 3M Quickgroup.
.           Recompiled for PAT41GRP.
. V9.03.10  23/06/2004  Henry Son                CAR 49037
.           ICD10 Ed.4 Changes. Re-compile VALDIOPS.       
. V9.03.09  21/01/2004  Henry Son  CAR 46856
.           Further mapping changs to Nasopharyngeal Intubation.
.           Map 9017902 and 9017905 to 9203500 for grouper.
.           Recompiled for PAT41GRP, PATWIS10, PATWIS11
. V9.03.08  23/12/2003  Sylvek Litewka           CAR 45685
.           VIC DHS 2003 changes - recompiled for VALDIOPS.PBL changes.
.           19/12/2003  Sylvek Litewka           CAR 20222
.           Modified reads of ICD DIsease and Procedure files to use Discharge
.           Date and new IO routines RDPTICD1 and RDPTICO1.
.           18/12/2003  Peter Vela               CAR 43134
.           Recompiled for MRTCONFD
. V9.03.07  11/12/2003  Peter Vela               CAR 40355
.           Recompiled for PATNAMCD, added extra branches to PATCN000
. V9.03.06  04/12/2003  Sylvek Litewka           CAR 45729
.           Populated PTEDDESC and PTEODESC with descriptions from MR Template
.           Details file (mrttdtaf).
. V9.03.05  29/10/2003  Sylvek Litewka           CAR 44328
.           Added clear of new PATECDFD and PATECOFD variables when new 
.           record is written.
. V9.03.04  23/10/2003  Henry Son                CAR 41650
.           Fix Nasopharyngeal Intubation.
.           Re compile to pick up PATWIS10 and PATWIS11
. V9.03.03  10/10/2003 Guomin Fu     CAR 41584
.           Added to read in MRCNSOMV and Recompiled for PAT41GRP
.           10/10/2003 Henry Son     CAR 44242
.           Fix Calc. of Hosptital home days.
.           Re-Compile RHIHDAYS
. V9.03.02  26/09/2003  Pat Dirito               CAR 43698   
.           Added check of Codding Date to AUTOC000 so only allocating to
.           uncodded discharges
. V9.03.01  08/08/2003  Henry Son                CAR 42039   
.           Added WIES11 Functionality.
.-----------------------------------------------------------------------------
. V9.02.34  09/04/2003  Pat Dirito               SRF 37647
.           Now only calling PTHCS000 when State/Nat DRG changes in REGRP000 
. V9.02.33  27/03/2003  Pat Dirito               SRF 37647
.           Added routine PTHCS000 writing patecmaf(Morbidity Coding) to 
.           Regroup Patients
. V9.02.32  12/12/2002  Pat Dirito               SRF 34063
.           Added variable PTEODRGD
. V9.02.31  20/11/2002  Pat Dirito               SRF 33644
.           Fixed read of PTCNI10D was reading incorrect position &
.           added read of PTCNDSCI
. V9.02.30  13/09/2002  Pat Dirito               SRF 22205
.           Added routine PTHCS000 writing patecmaf(Morbidity Coding).      
. V9.02.29  04/09/2002  Jill Habasque            SRF 17573
.           Changed to use RTIODAYS instead of NHOSPDAY  
. V9.02.28  29/08/2002  Pat Dirito               SRF 21608
.           Recompiled for PAT41GRP 
.           Added control var reads for CMDISP,CMOPRT,CMDISA & CMDISL     
. V9.02.27  20/08/2002  Pat Dirito               SRF 21159
.           Recompiled for PAT41GRP 
. V9.02.26  14/08/2002  Davin                    SRF 20183
.           Recompiled for PATWIS10
. V9.02.25  05.08.2002  Pat Dirito               SRF 19847
.           Recompiled for PAT41GRP.PBL
. V9.02.24  26.07.2002  Davin
.           Added WIES10 functionality
. V9.02.23  17.07.2002 Davin  			 SRF 18551,18323
.           Recompiled for PATWIES9
. V9.02.22  06/07/2002  Pat Dirito             
.           Added option 7 Regroup Patients.      
.           03/07/2002  Pat Dirito               SRF 19336
.           PTCNGDV3 was read from incorrect pos.
. V9.02.21  28.06.2002 Pat Dirito                SRF 19036
.           EXTALL00 was checking Discharged Only incorrectly!
. V9.02.20  24.06.2002 Pat Dirito                SRF 18805
.           Added RA read in WRTRED00
.           20.06.2002 Davin  			 SRF 18551,18323
.           Recompiled for PATWIES9
. V9.02.19  07.06.2002 Pat Dirito                SRF 18489 
.           Recompiled for VALDIOPS
. V9.02.18  30.05.2002 Davin  			 SRF 18236
.           Recompiled for PATWIES9
. V9.02.17  02.04.2002 Pat Dirito   
.           Recompiled fo PAT41GRP
. V9.02.16  28.03.2002 Pat Dirito   
.           Recompiled fo PAT41GRP
. V9.02.15  15.03.2002 Pat Dirito   
.           Added parameter PTCNODRG - Using DRG Grouper
. V9.02.14  13.03.2002 Pat Dirito   
.           Added call for Unix or PC Grouper on Automatic Coding
. V9.02.13  07.03.2002 Pat Dirito   
.           Fixed ward filter on Automatic Coding
. V9.02.12  26.02.2002 Pat Dirito   
.           Set VAR VISITNO in DISSQE00 PROSQE00 
. V9.02.11  25.02.2002 Pat Dirito   
.           Now clearing Codding Date Flag and Resequencing Unique Code counter.
. V9.02.10  22.02.2002 Pat Dirito   
.           Added call to CALCAGE before caliing VOPCD000 & VDSCD000 as both
.           routines use variable from CALCAGE!
. V9.02.09  13.02.2002 Dean Cramer  
.           Fix I*C with open on pattran                  
. V9.02.08  11.12.2001 Ebon Clements
.           Fixed coder snag range for research extract
. V9.02.07  22.11.2001 Raghunandan Surve
.           Added range checks for block number and drg,
.           Added KRES0000 for research extract
. V9.02.06  16/11/2001  Greg Horvat
.          Changed the make the program character based friendly
. V9.02.05  19.10.2001 Ebon Clements
.           Added exclude visit types to research extract
. V9.02.04  17.10.2001 Ebon Clements
.           Add deleted status to research extract report
. V9.02.03  17.09.2001 J.Tan
.           Mods to write U/R Number to mrtredaf
. V9.02.02  07.09.2001 J.Tan
.           Added age at admission
. V9.02.01  31.08.2001 J.Tan
.           Fixed extracting patients
. V9.00.B04 21.05.2001 B.G.Ackland
.           Added Coding Scheduler
. V9.00.B03 21/05/2001 Ebon Clements 
.           Fixed up U/R number range validation 
. V9.00.B02 17/05/2001 Ebon Clements 
.           Added option primary coding only
. V9.00.B01 17/05/2001 Dean Cramer   
.           Added option to print extract file
.-----------------------------------------------------------------------------
. V5.10.B04 02/05/2001 Ebon Clements 
.           Added option four to clear research extract file
. V5.10.B02 27/04/2001 Caleb Sharman
.           Added option three for the 'Patient Records
.           Research Extract'
. V5.10.B01 07/03/2001 J.Tan
.           Added Sameday Disc.,suburb,sex,postcode,countrybirth
. V5.09.B02 05/02/2001 Katie Nelson 
.           Fixed flag for checking dagger and asterix codes 
. V5.09.B01 10.01.2000 Katie Nelson 
.           Fixed packing of keys when deleting code records
. V5.09.00  20/10/2000 Katie Nelson 
.           Created Program
.----------------------------------------------------------------------
          INC       STD001FD    
.
          INC       WEBDINVS/INC
          INC       IBACONFD/INC
          INC       PATHLFFD/INC
          INC       PATBFEFD/INC
          INC       PATCMXFD/INC
          INC       PATHSPFD/INC                                      *I-137125
          INC       WEBCONFD/INC
          INC       MEHDLSFD/INC
          INC       MEHHONFD/INC
          INC       MEHLERFD/INC
          INC       MRTEPSFD/INC
          INC       MRTEXTFD/INC
          INC       MRTMASFD/INC
          INC       MRTREDFD/INC
          INC       MRTREXFD/INC
          INC       MRTTDTFD/INC
          INC       MRTTHDFD/INC
          INC       NHIMASFD/INC
          INC       OPRARDFD/INC
          INC       OPRCLIFD/INC
          INC       OPRDEAFD/INC
          INC       OPRCONFD/INC
          INC       OPRSESFD/INC
          INC       OPRSRGFD/INC
          INC       OPRTSMFD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATRE1FD/INC
          INC       PATVISFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCIDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSVX1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSVMTFD/INC
          INC       VARDSOPS/INC
          INC       VISXDCFD/INC
          INC       WATPROFD/INC
          INC       WATTR1FD/INC
          INC       WEBSECFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       WEBGRPVA/INC       * Variables for WEBGROUP.PBL
.-----------------------------------------------------------------------------
...
...
...
ADMISSNO  DIM       8     * Patient Admission No
.ADMFLAG   FORM      1
.ADDPAT    FORM      8.2
.ADDCOL    FORM      4
.ADDHF     FORM      8.2
.ADDEND    FORM      4
.BDAYS     FORM      4
.BTDAYFLG  FORM      1
.CNTRCEFR  FORM      1
.CEFFDATE  DIM       8
.CASMXKEY  DIM       12
COUNTER   FORM      3
COUNTER3  FORM      3
DIM18     DIM       18
DIM18A    DIM       18
.DSCITEM   DIM       30
RTDAYS    FORM      4
SELSAMDY  DIM       1
SELCODTM  DIM       4
SELUNITC  DIM       3
SELWARDC  DIM       3
SELFRDAT  DIM       8
SELTODAT  DIM       8
SELURTTH  DIM       3
.SKEY18    DIM       18
.SKEY30    DIM       30
STRDAT    DIM       8
STATEDRG  DIM       4
ENDDAT    DIM       8
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATVI     INIT      "VI"
CBB       INIT      ")"
CURRDATE  DIM       8                       * Current Date
CODECL    INIT      "CL"
CODED     INIT      "D "
CODEDD    INIT      "DD"
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSDAYS  FORM      6
CDYSYEAR  FORM      2
.COUNT     FORM      3
COUNTFL   FORM      1
COD1CNT   FORM      3
COD9CNT   FORM      2
CMPCNT    FORM      1
CMDLINE   DIM       227
..CODELINE  DIM       30
CODETYPE  DIM       1         Type of code, O - operation
.CMDRG     DIM       9
.CMCODE    DIM       9
.CMXFLAG   FORM      1
.CMIXFLAG  FORM      1
.CONTRCID  DIM       6
.                                           D - disease
.DAYHF     FORM      8.2
.DAYPAT    FORM      8.2
DAYCOUNT  FORM      3
.DAYEND    FORM      4
DAYCOL    FORM      4
DELTSTAT  DIM       3
.DIM8      DIM       8
DIM4      DIM       4
.DIM5      DIM       5
.DIM10     DIM       10
DIM20A    DIM       20
.DIM21     DIM       21
.DIM23     DIM       23
.DIM23A    DIM       23
.DIM24     DIM       24
DIM3      DIM       3
DIM30     DIM       30
DIM127    DIM       127
DISADATE  DIM       10                      * Display Admission Date
DISDDATE  DIM       10                      * Display Discharge Date
DISPDATE  DIM       11                      * Display Discharge Date
DOWNCASE  INIT      "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz"
DRGINP    INIT      "drginp"
DRGOUTFN  DIM       12
DDRGCODE  DIM       4
.DMDCCODE  DIM       4
.DRGVER    DIM       3
DRGVERZ   DIM       3                                                 *I-137125
DISECODE  DIM       5
DISCOUNT  FORM      2       * Diagnosis Code Counter
DISTYPE   DIM       1         Disease type
DSSCODE   DIM       9         Disease/operation code
DIACODES  DIM       9[5]
.
ESC       INIT      27                      * ESC char
EPSCD001  FORM      2                       * Episode No
EPISODNO  FORM      2                       * Episode Code
ENCINP    INIT      "encinp"
ENCDSP    DIM       2
ENCODERF  DIM       1
ENCOUTFN  DIM       12
ENCOUTAF  FILE      ASCII,FIXED=256
ENCFILEF  FILE      ASCII,FIXED=256
EXTRCTID  DIM       4                       * Extract ID
EXTRCTFL  FILE      ASCII, FIXED=400     * Extract File (Adjust Length to Suit)
EXTRCTFN  DIM       13                   * Extract File Name
EXTRCTEX  INIT      ".csv"               * Extract File Name Extension
.
ENCERR01  INIT      "Backup at Key Word Prompt               "
ENCERR02  INIT      "Abort at Key Word Prompt                "
ENCERR03  INIT      "No Entry at Key Word Prompt             "
ENCERR04  INIT      "Next at Key Word Prompt                 "
ENCERR05  INIT      "Invalid File Format                     "
ENCERR06  INIT      "Bad Command or Command Unauthorised     "
ENCERR07  INIT      "Error Opening Interface Input File      "
ENCERR08  INIT      "Error Opening Interface Output File     "
ENCERR09  INIT      "Output File Already Exists              "
ENCERR10  INIT      "Invalid DRG / Fiscal Year               "
ENCERR12  INIT      "Invalid Codes Passed to Application     "
ENCERR34  INIT      "Not Authorised                          "
ENCERR37  INIT      "Invalid or No Age in Input File         "
ENCERR38  INIT      "Invalid or No Gender in Input File      "
ENCERR39  INIT      "Invalid or Not Integrated in Input File "
ENCERR40  INIT      "Invalid or No State in Input File       "
ENCERR41  INIT      "Invalid or No Payor in Input File       "
ENCERR42  INIT      "Invalid Discharge Date in Input File    "
.
.FICUFLAG  FORM      1
.FORM3     FORM      3
FORM5     FORM      5
FORM8     FORM      8
FORMATNM  DIM       127
FOUNDFLG  FORM      1
FMTSNAME  DIM       35
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FILENAM1  DIM       8
FILENAM2  DIM       8
FILENAM3  DIM       8
FILENAM4  DIM       8
FILNAM    DIM       127
.
HOSPCODE  DIM       3
HOSPNAME  DIM       50
HTMLFILE  FIFO      ASCII, FIXED=250
HTMLDIR   DIM       60
HTMLEXT   INIT      ".html"
HUNDRED4  FORM      "104"
ICDCODE   DIM       9         Disease/operation code
..ICDCDESC  DIM       100        Code description (now in WEBGRPVA.INC)
.
LASTDIAG  FORM      3       * Last Item of Diagnosis array
LASTPROC  FORM      3       * Last Item of Procedure array
LENGTH    FORM      3
LOADNAME  DIM       8
LOADCNT   FORM      3
LOADFILE  FILE      ASCII,FIXED=200
LOCNTEST  DIM        7
.LOWFLAG   FORM      1
LINE127   DIM       127
.LUMPAT    FORM      8.2
.LUMHF     FORM      8.2
.
MTHNAM3   DIM       3
.MSGFLAG   FORM      1
OBB       INIT      "("
OPERCLIN  DIM       10
OPERTYPE  DIM       1         Operation type
OPERDATE  DIM       8         Operation date (CCYYMMDD)
OPERSTME  DIM       5         Operation start time
OPERETME  DIM       5         Operation finish time
OPRCODE   DIM       9         Operation code
OUTPFLAG  FORM      1
PROCODES  DIM       9[5]
.
NAME35    DIM       35
NATIODRG  DIM       4
NMPNUMB   DIM       20
NOOFCODE  FORM      2
.NOFEE     FORM      "0"
.NPDAYFLG  FORM      1
.
PROCCODE  DIM       7
PATFNAME  DIM       50                      * Patient's formatted name
.PCENDDTE  DIM       8
.PCFLAG    FORM      1
.
SOPTION   FORM      1
STXXEOF   INIT      032                    * EOF Marker
.SAVBTYP   DIM       3
.SAVFEDAY  FORM      3
SDIM18    DIM       18
.SDIM30    DIM       30
SEXASSCD  FORM      1       * Sex Associated Code Flag
SVEOCLIN  DIM       10
.
TYPOFCOD  DIM       2
TABDELM   EQU       0x09
T1        DIM       4
T2        DIM       2
T3        DIM       2
T4        DIM       5
T5        DIM       2
T6        DIM       1
.
USERID    DIM       10      * Remote User ID
URNUMBER  DIM       8       * Patient UR Number
UPDTTYPE  DIM       1       * Update Type
VISITNO   DIM       8 
VAR       DIM       127
WAHPDATE  FORM      1         * WA Health procedure date test
WCFINPFN  DIM       22       * Web Codefinder input filename
WCFOUTFN  DIM       22       * Web Codefinder output filename
WEBTITLE  DIM       80
WGATEWAY  FORM      1       * WEB Gateway 0=CGI 1=Servlet
WEBPID    DIM       5                      * Process ID
WDATE1    DIM       8
WDATE2    DIM       8
.ZED30     INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
.
TAGCODE   DIM       4       * Tag Code                                 *I-????
.
JAN       INIT      "January"
FEB       INIT      "February"
MAR       INIT      "March"
APR       INIT      "April"
MAY       INIT      "May"
JUN       INIT      "June"
JUL       INIT      "July"
AUG       INIT      "August"
SEP       INIT      "September"
OCT       INIT      "October"
NOV       INIT      "November"
DEC       INIT      "December"
.
.------------------------------------------------------------------------
PRGID     INIT      "IBAMRT53"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Medical Records Coding Extracts"
.------------------------------------------------------------------------
MAIN0000  CALL      INIT0000       * Initialise 
          BRANCH    EXIT,MAIN9999
.
MAIN1000  MOVE      ZERO,EXIT
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON," 0",*HOFF," = Exit":
                    *P1:5,*V2LON," 1",*HOFF," = Extract MR Coding Patients":
                    *P1:6,*V2LON," 2",*HOFF," = Auto Code MR Coding Patients":
                    *P1:7,*V2LON," 3",*HOFF," = Extract MR Research Patients":
                    *P1:8,*V2LON," 4",*HOFF," = Clear MR Research Patients":
                    *P1:9,*V2LON," 5",*HOFF," = Extract MR Research Patients":
                    *P1:10,*V2LON," 6",*HOFF," = Automatic Coding":
                    *P1:11,*V2LON," 7",*HOFF," = Regroup Patients":
                    *P1:12,*V2LON," 8",*HOFF," = Regroup Patients (UserId)":
                    *P1:13,"Select Option : ";
          KEYIN     *P17:13,*V2LON,SOPTION
          BRANCH    SOPTION,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                            MAIN1600,MAIN1700,MAIN1700
          GOTO      MAIN9999
.
MAIN1100  CALL      KEXI0000                * Keyin extract id
          BRANCH    EXIT,MAIN1000
.
          CALL      CLREPS00           * Clear EPS file for extract id
          CALL      EXTMRC00           * Extract MR Coding patients
          GOTO      MAIN9000
.  
MAIN1200  CALL      KEXI0000                * Keyin extract id
          BRANCH    EXIT,MAIN1000
.
          CALL      CODING00           * Automatic Coding 
          GOTO      MAIN9000 
.
MAIN1300  CALL      KRES0000                * Keyin extract id
          BRANCH    EXIT,MAIN1000
.
          CALL      CLRRED00           * Clear RED file for extract id
          CALL      EXTRSC00           * Extract MR Research Patients
          GOTO      MAIN9000
.
MAIN1400  CALL      KRES0000                * Keyin extract id
          BRANCH    EXIT,MAIN1000
.
          CALL      CLRRED00           * Clear RED file for extract id
          GOTO      MAIN9000
.
MAIN1500  CALL      KRES0000                * Keyin extract id
          BRANCH    EXIT,MAIN1000
.
          CALL      PRTRED00           * Print RED file for extract id
          GOTO      MAIN9000
.
MAIN1600  CALL      AUTOC000           * Automatic Coding
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN9000
.
MAIN1700  CALL      REGRP000           * Regroup Patients
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN9000
.
MAIN9000  
.
MAIN9999  CHAIN     PGM
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      DISPHEAD
          CALL      IBACLOCK      * todays date used for a new Doctor code
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          OPEN      PATICDD1,"paticddf"
          OPEN      PATICDO1,"paticdof"
          OPEN      PATECMA1,"patecmaf"
          OPEN      PATPGRA1,"patpgraf"
          OPEN      MRTEPSA1,"mrtepsaf" 
          OPEN      MRTEXTA1,"mrtextaf" 
          OPEN      MRTREDA1,"mrtredaf"
          OPEN      MRTREDA3,"mrtredaf"
          OPEN      MRTREXA1,"mrtrexaf"
          OPEN      MRTTDTR1,"mrttdtaf" 
          OPEN      MRTTHDR1,"mrtthdaf" 
          OPEN      PATCANA1,"patcanaf"
          OPEN      PATCHCO2,"patchcof"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATDGWA1,"patdgwaf" 
          OPEN      PATDSCH1,"patdschf" 
          OPEN      PATDSCH2,"patdschf" 
          OPEN      PATECOA1,"patecoaf" 
          OPEN      PATECOA2,"patecoaf" 
          OPEN      PATECOA3,"patecoaf" 
          OPEN      PATECDA1,"patecdaf" 
          OPEN      PATECDA2,"patecdaf" 
          OPEN      PATECDA3,"patecdaf"
          OPEN      PATECDA5,"patecdaf" 
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATMA1A1,"patma1af" 
          OPEN      PATMX1A1,"patmx1af" 
          OPEN      PATMI1A1,"patmi1af" 
          OPEN      PATMI1A3,"patmi1af" 
          OPEN      PATTRAN2,"pattranf" 
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A3,"patwr1af"
          OPEN      WATPROA1,"watproaf" 
          OPEN      WATTR1A1,"wattr1af" 
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSVX1A2,"pmsvx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRTSMA1,"oprtsmaf"
.
.  For Grouper
.
          OPEN      PATW11A1,"patw11af"                                *I-90235
          OPEN      PATW12A1,"patw12af"                                *I-51504
          OPEN      PATW12B1,"patw12bf"
          OPEN      PATW13A1,"patw13af"
          OPEN      PATW14A1,"patw14af"
          OPEN      PATW15A1,"patw15af"
          OPEN      PATW16A1,"patw16af"
          OPEN      PATW17A1,"patw17af"
          OPEN      PATW18A1,"patw18af"
          OPEN      PATW19A1,"patw19af"
          OPEN      PATW20A1,"patw20af"
          OPEN      PATW21A1,"patw21af"
          OPEN      PATWIEA1,"patwieaf"
          OPEN      PATRDCA1,"patrdcaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCDEA3,"patcdeaf"
          OPEN      PATFN1A1,"patfn1af"
.
          OPEN      PMSEDGA1,"pmsedgaf"     * Effective DRG
          OPEN      PMSEDGA2,"pmsedgaf"     * Effective DRG
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*37,CMOPRT,*105,PTCNU50G:             *C-51504
                                 *235,CMDISP,CMDISS,CMDISC,*238,CMDISA
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,*180,PTCNCDRS,*217,CMDISL
          READ      CONTROLF,FORTY;*111,OPCNCLSU
          READ      CONTROLF,FIFTY9;*34,CTYPEUR
          READ      CONTROLF,SIXTY;*133,MRCNEPSC
          READ      CONTROLF,SIXTY;*147,MRCNSOMV,*248,MRCN3MCD,*249,MRCN3MCG
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG,*240,MRCNUNWA,*241,MRCNENWA
          READ      CONTROLF,SEVENTY7;*220,PTCNEDRG
          READ      CONTROLF,SEVENTY9;*82,PTCNDSCI,*119,PTCNEAPD
          READ      CONTROLF,EIGHTY;*243,PTCNODRG,*250,PTCNHDPS
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*241,PTCNCSTA,PNSWRACE
          READ      CONTROLF,NINTY7;*145,MRCNGRUP,*174,MRCNCLIN,*245,MRCNDFPR:
                                    *248,MRCNEACA,*251,MRCNSCTC
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND05;*104,PTCNDGET,*147,CMDISM,*158,PTCNDGPV:
                                    *217,PTCNGDV4,*227,PTCNGDV5       *I-101974
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND24;*121,PTCNDGED
          READ      CONTROLF,HUND28;*239,PTCNE110
          READ      CONTROLF,HUND31;*1,MRCNDCID
.
          COMPARE   TWO,MRCNGRUP
          GOTO      INIT9500 IF EQUAL       * using CCA interface?
.
          CALL      OPICO1
          CALL      OPICO2
          CALL      OPICD1
          CALL      OPICD2
.
          MOVE      CURRDATE,CURDTE8
          MATCH     PTCNI10D,CURDTE8
          IF        !@LESS
            MOVE       "101",CODTYP         * Using ICD10 v1 codes
          ELSE
            MOVE       "9",CODTYP           * Using ICD9 codes
          ENDIF
.
          MOVE      ONE,CNEWDS
          MOVE      ZERO,OUTPFLAG
.
INIT9000  MOVE      ZERO,EXIT
          GOTO      INIT9999
.
INIT9500  CALL      UCCA0000
          MOVE      ONE,EXIT                * using CCA interface so exit
INIT9999  RETURN
.----------------------------------------------------------------
.                          CLREPS00
.  Clear Medical Records Coding Extract Table (MRTEPSFD) for
.  Extract ID.
.----------------------------------------------------------------
CLREPS00  PACK      KEY12,EXTRCTID,SP70
CLREPS10  CALL      RSMREP1
          CALL      RKMREP1
          BRANCH    OVRCD,CLREPS99
.
          MATCH     EXTRCTID,MREPEID
          GOTO      CLREPS99 IF NOT EQUAL
.
          PACK      KEY12,MREPEID,MREPVIS,SP70
          CALL      DEMREP1
.
          GOTO      CLREPS10
.
CLREPS99  RETURN
.----------------------------------------------------------------
. Extract the MR Coding patients by criteria set
.----------------------------------------------------------------
EXTMRC00  PACK      KEY4,EXTRCTID,SP70
          CALL      RDMREX1
          BRANCH    OVRCD,EXTMRC90
.
          MATCH     SP70,MREXDDFR           * Is there a discharge date range?
          GOTO      EXTMRC10 IF EQUAL       * no
.
          MATCH     SP70,MREXADFR           * Is there an admission date range?
          GOTO      EXTMRC20 IF EQUAL       * no
.
          CALL      EXTPAT00                * extract disch and adm range
          CALL      EXTIND00                * Update Extract in Progress Ind   
          GOTO      EXTMRC99
. 
EXTMRC10  CALL      EXTADM00                * extract admission range
          CALL      EXTIND00                * Update Extract in Progress Ind   
          GOTO      EXTMRC99
.
EXTMRC20  CALL      EXTPAT00                * extract discharge range
          CALL      EXTIND00                * Update Extract in Progress Ind   
.
EXTMRC90  
EXTMRC99  RETURN 
.----------------------------------------------------------------
. Extract Patients within the discharge date and admission date range
.----------------------------------------------------------------
EXTPAT00  PACK      KEY16,MREXDDFR,SP70
          CALL      RDSDSCH2      
EXTPAT10  CALL      RDKDSCH2      
          BRANCH    OVRCD,EXTPAT99
.
          MATCH     DDATE,MREXDDTO          * check discharge date to
          GOTO      EXTPAT99 IF LESS          
.
          MATCH     SP70,MREXWARD
          IF        !@EQUAL
            MATCH     MREXWARD,PTDSDWRD       * check ward
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,DURNO,SP70
          CALL      RDMAST1
.
          CALL      CDMG0000                * check demographic details
          BRANCH    EXIT,EXTPAT10
.
          MATCH     "0",MREXINCD
          IF        @EQUAL
            COMPARE   ONE,PCEASE            * check deceased patients
            GOTO      EXTPAT10 IF EQUAL
          ENDIF
.
          PACK      KEY8,DADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EXTPAT10          * Admission number doesn't exist
.
          MATCH     "1",MREXSDSC            * check for sameday discharge
          IF        @EQUAL
            MATCH     DDATE,ADATE           * check same day
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXADFR           * Is the admission range relevant?
          IF        !@EQUAL
            MATCH     ADATE,MREXADFR          * check admission date from
            GOTO      EXTPAT10 IF NOT LESS
.
            MATCH     ADATE,MREXADTO          * check admission date to  
            GOTO      EXTPAT10 IF LESS
          ENDIF
.
          MATCH     SP70,MREXUNIT
          IF        !@EQUAL
            MATCH     MREXUNIT,ACLSSFT        * check unit
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXCONS
          IF        !@EQUAL
            MATCH     MREXCONS,ADOCTA         * check consulant     
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPDRG
          IF        !@EQUAL
            MATCH     MREXPDRG,PTMIPDRG       * check provisonal DRG     
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPRCG
          IF        !@EQUAL
            CALL      PRCG0000              * Find Procedure Group
            BRANCH    EXIT,EXTPAT10         * no match - exclude patient
          ENDIF
.
          MATCH     SP70,MREXWLPR
          IF        !@EQUAL
            CALL      WLPR0000              * Find Waiting List Procedure
            BRANCH    EXIT,EXTPAT10         * no match - exclude patient
          ENDIF
.
          MATCH     SP70,MREXATYP
          IF        !@EQUAL
            MATCH     MREXATYP,ATYPE       * check admission type
            GOTO      EXTPAT10 IF NOT EQUAL   
          ENDIF
.
          MATCH     SP70,MREXPTYP
          IF        !@EQUAL
            MATCH     MREXPTYP,ACLSS       * check admission type
            GOTO      EXTPAT10 IF NOT EQUAL
          ENDIF
.
          CALL      WRTEPS00                * Write patient to eps file
          GOTO      EXTPAT10
.
EXTPAT99  RETURN  
.----------------------------------------------------------------
. Extract Patients within the admission date range
.----------------------------------------------------------------
EXTADM00  PACK      KEY16,MREXADFR,SP70
          CALL      RDSMISS3      
EXTADM10  CALL      RDKMISS3      
          BRANCH    OVRCD,EXTADM99
.
          MATCH     ADATE,MREXADTO          * check admission date to
          GOTO      EXTADM99 IF LESS          
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXTADM10
.
          IF        IBCNMHOS<>1
            GOTO      EXTADM20
          ENDIF
.
          MATCH     SP70,MRRXHOSP
          IF        !@EQUAL
            MATCH     MRRXHOSP,PMVXMHOS
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
EXTADM20  MATCH     SP70,MREXWARD
          IF        !@EQUAL
            MATCH     MREXWARD,AWARD        * check ward
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
.
          CALL      CDMG0000                * check demographic details
          BRANCH    EXIT,EXTADM10
.
          MATCH     "0",MREXINCD
          IF        @EQUAL
            COMPARE   ONE,PCEASE            * check deceased patients
            GOTO      EXTADM10 IF EQUAL
          ENDIF
.
          MATCH     SP70,MREXUNIT
          IF        !@EQUAL
            MATCH     MREXUNIT,ACLSSFT        * check unit
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXCONS
          IF        !@EQUAL
            MATCH     MREXCONS,ADOCTA         * check consulant     
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPDRG
          IF        !@EQUAL
            MATCH     MREXPDRG,PTMIPDRG       * check provisonal DRG     
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPRCG
          IF        !@EQUAL
            CALL      PRCG0000              * Find Procedure Group
            BRANCH    EXIT,EXTADM10         * no match - exclude patient
          ENDIF
.
          MATCH     SP70,MREXWLPR
          IF        !@EQUAL
            CALL      WLPR0000              * Find Waiting List Procedure
            BRANCH    EXIT,EXTADM10         * no match - exclude patient
          ENDIF
.
          MATCH     "1",MREXSDSC            * check for sameday discharge
          IF        @EQUAL
            COMPARE   THREE,ASTAT
            GOTO      EXTADM10 IF NOT EQUAL * not discharged
            MATCH     DDATE,ADATE           * check same day
            GOTO      EXTADM10 IF NOT EQUAL
          ENDIF
.
          CALL      WRTEPS00                * Write patient to eps file
          GOTO      EXTADM10
.
EXTADM99  RETURN 
.----------------------------------------------------------------
. Check demographic details
.----------------------------------------------------------------
CDMG0000  MOVE      ZERO,EXIT
          MATCH     SP70,MREXSUBR           * Check Suburb
          IF        !@EQUAL
            MATCH     PSUBRB,MREXSUBR
            GOTO      CDMG9000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPCOD           * Check postcode
          IF        !@EQUAL
            MATCH     PPOST,MREXPCOD
            GOTO      CDMG9000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXPSEX           * Check sex
          IF        !@EQUAL
            MATCH     PSEX,MREXPSEX
            GOTO      CDMG9000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,MREXCNTR           * Check Country of birth
          IF        !@EQUAL
            MATCH     PCONT,MREXCNTR
            GOTO      CDMG9000 IF NOT EQUAL
          ENDIF
          GOTO      CDMG9999
.
CDMG9000  MOVE      ONE,EXIT
CDMG9999  RETURN
.----------------------------------------------------------------
. Find Procedure Group
.----------------------------------------------------------------
PRCG0000  MOVE      ONE,EXIT  
          PACK      KEY19,AURNO,SP70
          CALL      RDSTREA1
PRCG0100  CALL      RDKTREA1
          BRANCH    OVRCD,PRCG9999
.
          MATCH     AURNO,WMURNO
          GOTO      PRCG9999 IF NOT EQUAL
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1  
          BRANCH    OVRCD,PRCG0100
.
          MATCH     MREXPDRG,WPCODE
          IF        @EQUAL 
            MOVE      ZERO,EXIT
          ENDIF
          GOTO      PRCG0100
.            
PRCG9999  RETURN 
.----------------------------------------------------------------
. Find Waiting List Procedure
.----------------------------------------------------------------
WLPR0000  MOVE      ONE,EXIT  
          PACK      KEY19,AURNO,SP70
          CALL      RDSTREA1
WLPR0100  CALL      RDKTREA1
          BRANCH    OVRCD,WLPR9999
.
          MATCH     AURNO,WMURNO
          GOTO      PRCG9999 IF NOT EQUAL
.
          MATCH     MREXWLPR,WMCODE
          IF        @EQUAL
            MOVE      ZERO,EXIT
          ENDIF
          GOTO      WLPR0100
.
WLPR9999  RETURN 
.------------------------------------------------------------
.                       WRTEPS00
.  Write Record to Extract Table
.------------------------------------------------------------
WRTEPS00  MOVE      MREXEID,MREPEID     * Extract ID
          MOVE      AADMNO,MREPVIS      * Visit Number
          MOVE      SP70,MREPLEV1       * Summary Level 1
          MOVE      SP70,MREPLEV2       * Summary Level 2
          MOVE      SP70,MREPLEV3       * Summary Level 3
          MOVE      SP70,MREPLEV4       * Summary Level 4
          MOVE      ZERO,MREPANL1       * Analysis Measure 1 Total
          MOVE      ZERO,MREPANL2       * Analysis Measure 2 Total
          MOVE      ZERO,MREPANL3       * Analysis Measure 3 Total
          MOVE      ZERO,MREPDEL        * Deleted from Extract 0=No 1=Yes
.
          PACK      KEY12,MREPEID,MREPVIS,SP70
          CALL      WRMREP1
.
WRTEPS99  RETURN
.----------------------------------------------------------------
. Automatic Coding
.----------------------------------------------------------------
CODING00  PACK      KEY4,EXTRCTID,SP70      * Read the extract details
          CALL      RDMREX1
          BRANCH    OVRCD,CODING99
.
          MOVE      ZERO,CLNO
          MOVE      ZERO,CPAGENO
          CALL      HEAD132
          PRINT     *40,MREXDESC  
.
          UNPACK    CURRDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PRINT     *40,"Date of Coding: ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ADD       ONE,CLNO
.
          PRINT     "U/R",*13,"Admission",*23,"Name",*75,"Admission Date",*90:
                    "Discharge Date"
          ADD       ONE,CLNO
.
          PRINT     "---",*13,"----",*23,"---------",*75,"--------------",*90:
                    "--------------"
          ADD       ONE,CLNO
.
          PACK      KEY12,MREXEID,SP70      * Read through the extract patients
          CALL      RSMREP1
CODING10  CALL      RKMREP1
          BRANCH    OVRCD,CODING99
.
          MATCH     MREXEID,MREPEID
          GOTO      CODING99 IF NOT EQUAL
.
          MATCH     "1",MREPDEL
          GOTO      CODING10 IF EQUAL
.
          MOVE      MREPVIS,KEY8            * Read admission files deatils
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS              * Clear admission variables
          ENDIF
.
          MOVE      AURNO,KEY8              * Read master files deatils
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      RDPMPX21
            CALL      PATNAA00              * Format Patient Name
          ENDIF
.
          MOVE      AADMNO,KEY8             * Read discharge files deatils
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC              * Clear Discharge Variables
          ENDIF
.
          MOVE      DDATE,ICDRDDTE          * Used for reading ICD files
.
          ADD       ONE,CLNO                * Increment number of lines         
          COMPARE   "55",CLNO
          CALL      HEAD132 IF EQUAL
.
          MATCH     SP70,ADATE
          IF        !@EQUAL
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISADATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISADATE
          ENDIF
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISDDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISDDATE
          ENDIF
.
          PRINT     AURNO,*13,AADMNO,*23,PATFNAME,*75,DISADATE,*90,DISDDATE
.
          MOVE      "01",EPISODNO           * Reset Episode Code
          MOVE      MREPVIS,VISITNO         * Set Visit No
.
          CALL      DELECD00  * Del Episode records from Disease Coding file
          CALL      DELECO00  * Del Episode records from Procedure Coding file
.
          MOVE      ADATE,AGEDATE           * Using Admission Date
          CALL      CALCAGE                 * Needed for VDSCD000 & VOPCD000
.
          PACK      KEY8,MREXAUTC,SP70      * Read the coding template
          CALL      RSMRTDT1
CODING20  CALL      RKMRTDT1
          BRANCH    OVRCD,CODING50
.
          MATCH     MREXAUTC,MRTDTMNO
          GOTO      CODING50 IF NOT EQUAL   * no more codes for the 
.
          MATCH     "D",MRTDRECT            * is this a disease code?
          GOTO      CODING30 IF EQUAL       * yes
.
          CALL      VALOPR00                * Validate operation Code 
          BRANCH    EXIT,CODING40           * Error: delete coding
          CALL      SAVPRO00                * Save Procedure record
          GOTO      CODING20                * get next templated code
.
CODING30  CALL      VALDIS00                * Validate Disease Code 
          BRANCH    EXIT,CODING40           * Error: delete coding
          CALL      SAVDIS00                * Save disease record
          GOTO      CODING20                * get next templated code 
.
CODING40  
...          CALL      DELECD00 * Del Episode from Disease Coding file
...          CALL      DELECO00 * Del Episode from Procedure Coding file
....      CALL      DISSQE00             * Resequence Disease Codes & MDS Data
....      CALL      PROSQE00             * Resequence Procedure Codes & MDS Data
          CALL      CODINC00             * Update coding complete 
          GOTO      CODING90             * Get next patient
.
CODING50
....      CALL      DISSQE00             * Resequence Disease Codes & MDS Data
....      CALL      PROSQE00             * Resequence Procedure Codes & MDS Data
          CALL      CODCOM00             * Update coding complete 
.
.    Set the following vars for SETGRP00 & PTHCS000
.
          MOVE      AURNO,URNUMBER       
          MOVE      VISITNO,ADMISSNO     
          MOVE      EPISODNO,EPSCD001    
.                                                                     *I-262698
          MOVE      ADATE,ENCSTDAT       * Start & End dates for Grouper -
          MOVE      ATIME,ENCSTTIM       * (for Episode coding)
          MOVE      DDATE,ENCENDAT
          MOVE      DTIME,ENCENTIM
.
          CALL      PTHCS000             * Update Episode Morbidity Changes File
.
.    Run UNIX or PC Grouper Depending on PARAMETER
.
CODING06  COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "V",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE      * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE      * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
            ENDIF
          ENDIF
.         
.         Before getting the next discharge record, trigger a visit
.         update message after getting the last transfer record and the
.         visit extension
.         
CODING90  PACK      KEY30,AADMNO,ZED30
          CALL      RDSTRAN2                * position on admission number
          CALL      RDPTRAN2                * read previous transfer record
          BRANCH    OVRCD,CODING10          * eof - shouldn't happen 
.         
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      CODING10 IF NOT EQUAL   * no - should happen
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,CODING10          * eof - shouldn't happen
.         
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI        
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * trigger I/P visit update message
          GOTO      CODING10             * Get next patient
.
CODING99  RETURN 
.-------------------------------------------------------------------------------
.                        ******* DELECD00 ********
. ----- Delete Episode 1 records from the medical records disease file ----
.-------------------------------------------------------------------------------
DELECD00  PACK      KEY13,VISITNO,EPISODNO,SP70                       *C-240107
          CALL      RSPTECD1                * Position on & read a patient
DELECD10  CALL      RKPTECD1                * episode disease file record
          BRANCH    OVRCD,DELECD99
.
          MATCH     VISITNO,PTEDADMN
          GOTO      DELECD99 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPISODNO,PTEDEPNO
          GOTO      DELECD99 IF NOT EQUAL
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT                   *C-240107
          CALL      DEPTECD1                * Delete an eps dis coding file rec
.
          GOTO      DELECD10     * Get next record
.
DELECD99  RETURN
.-------------------------------------------------------------------------------
.                        ******* DELECO00 ********
. ----- Delete Episode 1 records from the medical records Procedure file ----
.-------------------------------------------------------------------------------
DELECO00  PACK      KEY13,VISITNO,EPISODNO,SP70                       *C-240107
          CALL      RSPTECO1                * Position on & read a patient
DELECO10  CALL      RKPTECO1                * episode operation file record
          BRANCH    OVRCD,DELECO99
.
          MATCH     VISITNO,PTEOADMN
          GOTO      DELECO99 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPISODNO,PTEOEPNO
          GOTO      DELECO99 IF NOT EQUAL
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT                   *C-240107
          CALL      DEPTECO1                * Delete an eps dis coding file rec
.
          GOTO      DELECO10   * Get Next Record
.
DELECO99  RETURN
.----------------------------------------------------------------
.                        ******* SAVDIS00 ********
. ----- Save one record at a time to the medical records Disease file ----
.----------------------------------------------------------------
SAVDIS00  PACK      KEY13,VISITNO,EPISODNO,Z70                        *C-240107
          CALL      RSPTECD1     
          CALL      RPPTECD1  
          BRANCH    OVRCD,SAVDIS10
.
          MATCH     VISITNO,PTEDADMN
          GOTO      SAVDIS10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPISODNO,PTEDEPNO
          GOTO      SAVDIS20 IF EQUAL        * Same episode no

SAVDIS10  MOVE      ZERO,PTEDCNT         * Reset the episode unique counter
.
SAVDIS20  MOVE      VISITNO,PTEDADMN     * Visit no
          MOVE      EPISODNO,PTEDEPNO    * Epsiode no
          ADD       ONE,PTEDCNT          * Increment the episode unique cnt
          MOVE      MRTDDECD,PTEDCODE    * Disease code
          MOVE      MRTDDEST,PTEDTYPE    * Disease type
          MOVE      ZERO,PTEDUNQN        * Unique no
          MOVE      CURRDATE,PTEDDTCD    * Date of coding
          MOVE      CTIMEIS,PTEDTIME     * Time of coding
          MOVE      PASSCODE,PTEDOPER    * Operator
.
          MOVE      SP70,PTEDUSID        * Web User ID
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD=0
            MATCH     PASSCODE,WBSEPCD
            IF        @EQUAL
              MOVE      WBSEUID,PTEDUSID
            ENDIF
          ENDIF 
.
          MOVE      SP70,PTEDACDT        * Disease accident date
          MOVE      SP70,PTEDCCCL        * CC Class Level
          MOVE      SP70,PTEDDRGD        * DRG Driver
          MOVE      MRTDDESC,PTEDDESC    * Free Format Description
          MOVE      SP70,PTEDOSET        * Diagnosis onset type
.
          IF        PTCNHDPS>1
            MOVE      TWO,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      ONE,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
          ENDIF
.
          IF        PTCNHDPS=4
            MOVE      ONE,PTEDOSET             * Diagnosis onset type
            MATCH     CMDISC,PTEDTYPE
            IF        @EQUAL
              MOVE      TWO,PTEDOSET           * Diagnosis onset type (compl)
            ENDIF
            MATCH     CMDISM,PTEDTYPE
            IF        @EQUAL
              MOVE      SP70,PTEDOSET          * Diagnosis onset type (morph)
            ENDIF
          ENDIF
.
          MOVE      SP70,PTEDDCID              * Diagnosis cluster id
.
          MATCH     "1",MRCNDCID  * Using Diagnosis Cluster Id & ICD10 ED 13
          GOTO      SAVDIS50 IF NOT EQUAL
.
          MATCH     PTCNGDX3,DDATE   * disc.date > ICD10 ED 13 Go live?
          GOTO      SAVDIS50 IF LESS
.
          MOVE      MRTDDCID,PTEDDCID          * Cluster id
.
          MATCH     SP70,PTEDDCID              * Cluster id populated
          GOTO      SAVDIS50 IF NOT EQUAL
.
          MATCH     ANSU,PTEDCODE              * U prefix
          IF        @EQUAL
            UNPACK    PTEDCODE,D1,D2
            MOVE      ZERO,F2
            SQUEEZE   D2
            MOVE      D2,F2                   * U78 to U88 range
            IF        F2 >= 78 & F2 <=88
              MOVE      "0 ",PTEDDCID         * Assign chronic
              GOTO      SAVDIS50
            ENDIF
          ENDIF
.
          MOVE      "8 ",PTEDDCID             * Assign unclusterd
.
SAVDIS50  MOVE      SP70,PTEDSPAR        * Spare
.
          PACK      KEY13,PTEDADMN,PTEDEPNO,PTEDCNT                   *C-240107
          CALL      WRPTECD1              * Write an eps dis coding file rec
.
SAVDIS99  RETURN
.----------------------------------------------------------------
.                        ******* SAVPRO00 ********
. -----  Save one record at a time to the medical records Procedure file ----
.----------------------------------------------------------------
SAVPRO00  PACK      KEY13,VISITNO,EPISODNO,Z70                        *C-240107
          CALL      RSPTECO1     
          CALL      RPPTECO1  
          BRANCH    OVRCD,SAVPRO10
.
          MATCH     VISITNO,PTEOADMN
          GOTO      SAVPRO10 IF NOT EQUAL    * Different admin no
.
          COMPARE   EPISODNO,PTEOEPNO
          GOTO      SAVPRO20 IF EQUAL        * Same episode no

SAVPRO10  MOVE      ZERO,PTEOCNT             * Reset the episode unique counter 
.
SAVPRO20  MOVE      VISITNO,PTEOADMN         * Visit no
          MOVE      EPISODNO,PTEOEPNO        * Epsiode no
          ADD       ONE,PTEOCNT              * Increment the episode unique cnt
          MOVE      MRTDDECD,PTEOCODE        * Operation code
          MOVE      MRTDDEST,PTEOTYPE        * Operation type
          MOVE      ZERO,PTEOUNQN            * Unique no
          MOVE      CURRDATE,PTEODTCD        * Date of coding
          MOVE      CTIMEIS,PTEOTIME         * Time of coding
          MOVE      PASSCODE,PTEOOPER        * Operator
.
          MOVE      SP70,PTEOUSID            * Web User ID
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD=0
            MATCH     PASSCODE,WBSEPCD
            IF        @EQUAL
              MOVE      WBSEUID,PTEOUSID
            ENDIF
          ENDIF
.
          MOVE      SP70,PTEODATE            * Procedure Date
          MOVE      SP70,PTEOSTTM            * Procedure Start Time
          MOVE      SP70,PTEOEDTM            * Procedure End Time
          MOVE      SP70,PTEODRGD            * DRG Driver
          MOVE      MRTDDESC,PTEODESC        * Free Format Description
          MOVE      SP70,PTEOSPAR            * Spare
.
          PACK      KEY13,PTEOADMN,PTEOEPNO,PTEOCNT                   *C-240107
          CALL      WRPTECO1              * Write an eps Pro coding file rec
.
SAVPRO99  RETURN
.----------------------------------------------------------------
. Validate Disease Code 
.----------------------------------------------------------------
VALDIS00  MOVE      ZERO,EXIT
.
          MOVE      MRTDDECD,KEY9
          CALL      RDPTICD1
          BRANCH    OVRCD,VALDIS90
          COMPARE   ONE,ICDRDVER       * ICD9?
          GOTO      VALDIS90 IF EQUAL
.
          MATCH     "P",DFLAG
          GOTO      VALDIS91 IF NOT EQUAL
.
          MOVE      ZERO,ECODECNT      * E code counter
          MOVE      MRTDSEQN,DSCODNO   * Diagnosis Code Sequence Counter
          MOVE      MRTDDEST,DSCODPFX  * Diagnosis Code Prefix
          MOVE      MRTDDECD,DSCOD     * Diagnosis Code     
.
          CALL      VDSCD000
          BRANCH    EXIT,VALDIS93
          GOTO      VALDIS99
.
VALDIS90  PRINT     *23,"Invalid Disease Code" 
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALDIS99
.
VALDIS91  PRINT    "Invalid Disease Prefix not Posting - ",MRTDDECD
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALDIS99
.
VALDIS92  PRINT     "** Fatal Error Occurred - Patient Not Coded **" 
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALDIS99
.
VALDIS93  ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALDIS99
.
VALDIS99  RETURN 
.----------------------------------------------------------------
. Validate operation Code 
.----------------------------------------------------------------
VALOPR00  MOVE      ZERO,EXIT 
.
          MOVE      MRTDDECD,KEY9
          CALL      RDPTICO1
          BRANCH    OVRCD,VALOPR90
          COMPARE   ONE,ICDRDVER         * ICD9?
          GOTO      VALOPR90 IF EQUAL
.
          MATCH     "P",OFLAG
          GOTO      VALOPR91 IF NOT EQUAL
.
          MOVE      MRTDDECD,OPCOD       * Set Var for routine
.
          CALL      VOPCD000
          BRANCH    EXIT,VALOPR93
          GOTO      VALOPR99
.
VALOPR90  PRINT    "Invalid Operation Code - ",MRTDDECD
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALOPR99
.
VALOPR91  PRINT    "Invalid Operation Prefix not Posting - ",MRTDDECD
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALOPR99
.
VALOPR92  PRINT     "** Fatal Error Occurred - Patient Not Coded **" 
          ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALOPR99
.
VALOPR93  ADD       ONE,CLNO                * Increment number of lines         
          MOVE      ONE,EXIT
          GOTO      VALOPR99
.
VALOPR99  RETURN
.----------------------------------------------------------------
. Update coding complete.
. Note there must be at least 1 Disease Code!
.----------------------------------------------------------------
CODCOM00  MOVE      ONE,F3                                            *C-240107
          PACK      KEY13,VISITNO,EPISODNO,F3,SP70                    *C-240107
          CALL      RAPTECD1 
          IF        OVRCD=1
            CALL     CODINC00    * No Codding found set Coding date to blank!
            GOTO     CODCOM99
          ENDIF
.
. * Coding Found! Set Codding Date
.
          MOVE      VISITNO,KEY8
          CALL      RDMISS1  
          IF        OVRCD=0
            MOVE      ZERO,PTMIDDIG           * Dishc diagnosis printed - no
            MOVE      CURRDATE,ACODDTE      * Date Coding Completed
            CALL      UPMISS1      
          ENDIF
.
CODCOM99  RETURN 
.----------------------------------------------------------------
. Update coding complete to status Incomplete
.----------------------------------------------------------------
CODINC00  MOVE      VISITNO,KEY8
          CALL      RDMISS1  
          IF        OVRCD=0
            MOVE      ZERO,PTMIDDIG           * Dishc diagnosis printed - no
            MOVE      SP70,ACODDTE            * Date Coding Completed
            CALL      UPMISS1      
          ENDIF
.
CODINC99  RETURN 
.----------------------------------------------------------------
. Format Patient Name in Title Text - (From PATMASTM)
.------------------------------------------------------------
PATNAA00  CLEAR     DISPNAME
          MOVE      SP70,PATFNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          PACK      NAME35,PSNAME,SP70
          REP       UPPLOW,PSNAME
          APPEND    PSNAME,DISPNAME
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
          RETURN
.----------------------------------------------------------------
. Update Extract in Progress Indicator
.----------------------------------------------------------------
EXTIND00  PACK      KEY4,EXTRCTID,SP70
          CALL      RDMREX1
          MOVE      ZERO,MREXINPR           * Extract in Progress = No
          CALL      UPMREX1
EXTIND99  RETURN 
.----------------------------------------------------------------
.                ***** EXTRSC00 *****                           -
. Extract the MR Research patients by criteria set              -
.----------------------------------------------------------------
EXTRSC00  PACK      KEY4,EXTRCTID,SP70
          CALL      RDMRREX1
          BRANCH    OVRCD,EXTRSC99
.
          MATCH     SP70,MRRXDIFR           * Is there a discharge date range ?
          GOTO      EXTRSC10 IF EQUAL       * no
          CALL      EXTDSC00                * Extract discharge range
.
EXTRSC10  MATCH     SP70,MRRXVIFR           * Is there a visit date range ?
          GOTO      EXTRSC30 IF EQUAL       * no
          CALL      EXTVIS00                * Extract visit range
.
EXTRSC30  CALL      EXTINC00                * Update Extract in Progress Ind
          GOTO      EXTRSC99
.
EXTRSC99  RETURN
.----------------------------------------------------------------
.                       ***** EXTDSC00 *****
. Extract Patients within the discharge date range
.----------------------------------------------------------------
EXTDSC00  PACK      KEY16,MRRXDIFR,SP70
          CALL      RDSDSCH2
EXTDSC10  CALL      RDKDSCH2
          BRANCH    OVRCD,EXTDSC99
.
          MATCH     DDATE,MRRXDITO          * check discharge date to
          GOTO      EXTDSC99 IF LESS
.
          MOVE      DDATE,ICDRDDTE          * Used for reading ICD files
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXTDSC10
.
          IF        IBCNMHOS<>1
            GOTO      EXTDSC20
          ENDIF
.
          MATCH     SP70,MRRXHOSP
          IF        !@EQUAL
            MATCH     MRRXHOSP,PMVXMHOS
            GOTO      EXTDSC10 IF NOT EQUAL
          ENDIF
.
EXTDSC20  MOVE      DADMNO,PMVXVISN         * move to standard 
          MOVE      DADMNO,AADMNO           * move to standard 
          MOVE      DURNO,PURNO             * move to standard
.
          MATCH     SP70,MRRXDGFR
          IF        !@EQUAL
            MATCH     MRRXDGFR,PTDSDDRG     * DRG range  
            GOTO      EXTDSC10 IF LESS
            MATCH     PTDSDDRG,MRRXDGTO
            GOTO      EXTDSC10 IF LESS            
          ENDIF
.
          CALL      EXTALL00                * Extract patient criteria
          BRANCH    EXIT,EXTDSC10
.
          CALL      WRTRED00                * Write patient to extract detail
          GOTO      EXTDSC10
.
EXTDSC99  RETURN
+
.-----------------------------------------------------------------------
.                       ***** EXTVIS00 *****
. Extract Patients within the visit date range
.----------------------------------------------------------------
EXTVIS00  PACK      KEY16,MRRXVIFR,SP70
          CALL      RSPMVX12
EXTVIS10  CALL      RKPMVX12
          BRANCH    OVRCD,EXTVIS99
.
          IF        IBCNMHOS<>1
            GOTO      EXTVIS15
          ENDIF
.
          MATCH     SP70,MRRXHOSP
          IF        !@EQUAL
            MATCH     MRRXHOSP,PMVXMHOS
            GOTO      EXTVIS10 IF NOT EQUAL
          ENDIF
.
EXTVIS15  MATCH     PMVXVSDT,MRRXVITO       * check visit date to
          GOTO      EXTVIS99 IF LESS
.
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EXTVIS20
.
          MOVE      AURNO,PURNO
          GOTO      EXTVIS30                * move to standard
.
EXTVIS20  MOVE      SP8,PURNO
.
EXTVIS30  CALL      EXTALL00                * Extract patient criteria
          BRANCH    EXIT,EXTVIS10
.
          CALL      WRTRED00                * Write patient to extract detail
          GOTO      EXTVIS10
.
EXTVIS99  RETURN
+
.-----------------------------------------------------------------------
.                       ***** EXTALL00 *****
. Extract Patients within the criteria
.-----------------------------------------------------------------------
EXTALL00  MOVE      ZERO,EXIT
.
.********************* discharge consultant *****************************
.
          MATCH     SP70,MRRXDOCT                  
          IF        !@EQUAL
            PACK      KEY30,PMVXVISN,SP30
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,EXTALL90
.
            MOVE      TADMN,DIM8
            MATCH     PMVXVISN,DIM8
            GOTO      EXTALL90 IF NOT EQUAL
.
            MATCH     TADOCT,MRRXDOCT
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** discharge unit ************************************
.
          MATCH     SP70,MRRXUNIT
          IF        !@EQUAL
            PACK      KEY30,PMVXVISN,SP30
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,EXTALL90
.
            MOVE      TADMN,DIM8
            MATCH     PMVXVISN,DIM8
            GOTO      EXTALL90 IF NOT EQUAL
.
            MATCH     TDEPT,MRRXUNIT
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** discharge ward ************************************
.
          MATCH     SP70,MRRXWARD
          IF        !@EQUAL
            PACK      KEY30,PMVXVISN,SP30
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,EXTALL90
.
            MOVE      TADMN,DIM8
            MATCH     PMVXVISN,DIM8
            GOTO      EXTALL90 IF NOT EQUAL
.
            MATCH     TWARD,MRRXWARD                                           
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** sameday patient ***********************************
.
          MATCH     "0",MRRXSMDY
          IF        !@EQUAL
            PACK      KEY8,PMVXVISN                   * does adm no. exist
            CALL      RDMISS1
            BRANCH    OVRCD,EXTALL90
.
            PACK      KEY8,PMVXVISN                   * does adm no. exist
            CALL      RDDSCH1
            BRANCH    OVRCD,EXTALL90
.
            MATCH     ADATE,DDATE                     * compare adm/dsch dates
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** discharged patients only **************************
.
          MATCH     "0",MRRXDISO
          IF        !@EQUAL
            PACK    KEY8,PMVXVISN,SP70
            CALL    RDDSCH1
            BRANCH  OVRCD,EXTALL90
          ENDIF
.
********************** incomplete episodes *******************************
.
          MATCH     "0",MRRXINCM
          IF        !@EQUAL
            PACK      KEY8,PMVXVISN,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,EXTALL90
.
            MATCH     ACODDTE,SP8                       * episode incomplete ?
            GOTO      EXTALL90 IF EQUAL 
          ENDIF
.
********************** include deceased patients *************************
.
          MATCH     "0",MRRXDECD
          IF        @EQUAL
            PACK      KEY8,PURNO
            CALL      RDMAST1
            BRANCH    OVRCD,EXTALL90
.
            COMPARE   PCEASE,ZERO                       * if deceased then skip
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** Exclude visit type ********************************
.
          MATCH     SP70,MRRXINVT
          IF        !@EQUAL
            MOVE      PVITYPE,DIM1
            MATCH     MRRXINVT,DIM1
            GOTO      EXTALL90 IF EQUAL
          ENDIF
.
********************** Exclude visit type 1*******************************
.
          MATCH     SP70,MRRXINV1
          IF        !@EQUAL
            MOVE      PVITYPE,DIM1
            MATCH     MRRXINV1,DIM1
            GOTO      EXTALL90 IF EQUAL
          ENDIF
.
********************** Exclude visit type 2*******************************
.
          MATCH     SP70,MRRXINV2
          IF        !@EQUAL
            MOVE      PVITYPE,DIM1
            MATCH     MRRXINV2,DIM1
            GOTO      EXTALL90 IF EQUAL
          ENDIF
.
********************** postcode ******************************************
.
          MATCH     SP70,MRRXPOST
          IF        !@EQUAL
            PACK      KEY8,PURNO
            CALL      RDMAST1
            BRANCH    OVRCD,EXTALL90
.
            PACK      KEY8,PMVXVISN
            CALL      RDPMVX11
            BRANCH    OVRCD,EXTALL90
.
            MATCH     PPOST,PMVXPOST
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** patient gender ************************************
.
          MATCH     SP70,MRRXGEND
          IF        !@EQUAL
            PACK      KEY8,PURNO
            CALL      RDMAST1
            BRANCH    OVRCD,EXTALL90
.
            MATCH     PSEX,MRRXGEND
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** country of birth **********************************
.
          MATCH     SP70,MRRXCOB
          IF        !@EQUAL
            PACK      KEY8,PURNO
            CALL      RDMAST1
            BRANCH    OVRCD,EXTALL90
.
            MATCH     PCONT,MRRXCOB
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
          IF          MRRXAAGE<>0
            PACK      KEY8,PURNO
            CALL      RDMAST1
            BRANCH    OVRCD,EXTALL90
            IF        PCEASE=1
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ELSE
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ENDIF
            REP       " 0",AGEDATE
            CALL      CALCAGE
            COMPARE   PSAGEYRS,MRRXAAGE
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** provisional DRG ***********************************
.
          MATCH     SP70,MRRXPDRG
          IF        !@EQUAL
            PACK      KEY8,PMVXVISN
            CALL      RDMISS1
            BRANCH    OVRCD,EXTALL90
.
            MATCH     PTMIPDRG,MRRXPDRG
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** diagnosis code **********************************
.
          MOVE      ZERO,FORM1        * Default to Diagnosis code entered
          MATCH     SP70,MRRXDIA1
          IF        @EQUAL
            MATCH      SP70,MRRXDIA2
            IF         @EQUAL
              MATCH      SP70,MRRXDIA3
              IF         @EQUAL
                MOVE       ONE,FORM1   * No diagnosis code entered
              ENDIF
            ENDIF
          ENDIF
          BRANCH    FORM1,EXTALL20          * no diagnosis code entered
.
          PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECD1
EXTALL12  CALL      RKPTECD1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      PTEDADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL90 IF NOT EQUAL
.
          COMPARE   ZERO,PTEDEPNO                * Skip coding locked record
          GOTO      EXTALL12 IF EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      MRRXIPRI,FORM1
          IF        FORM1=1
            MATCH     ANSP,PTEDTYPE
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
          MATCH     PTEDCODE,MRRXDIA1       * check diagnosis 1
          GOTO      EXTALL20 IF EQUAL
.
          MATCH     PTEDCODE,MRRXDIA2       * check diagnosis 2
          GOTO      EXTALL20 IF EQUAL
.
          MATCH     PTEDCODE,MRRXDIA3       * check diagnosis 3
          GOTO      EXTALL20 IF EQUAL
          BRANCH    FORM1,EXTALL90          * primary code only
          GOTO      EXTALL12                * next diagnosis
.
.
********************** procedure code 1 **********************************
.
EXTALL20  MOVE      ZERO,FORM1          * Default to procedure code entered
          MATCH     SP70,MRRXPRO1
          IF        @EQUAL
            MATCH      SP70,MRRXPRO2
            IF          @EQUAL
              MATCH       SP70,MRRXPRO3
              IF          @EQUAL
                MOVE        ONE,FORM1   * No procedure code entered
              ENDIF
            ENDIF
          ENDIF
          BRANCH    FORM1,EXTALL30      * no procedure code entered
         
          PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECO1
EXTALL22  CALL      RKPTECO1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      PTEOADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL90 IF NOT EQUAL 
.
          MATCH     PTEOCODE,MRRXPRO1       * check procedure 1
          GOTO      EXTALL30 IF EQUAL
.
          MATCH     PTEOCODE,MRRXPRO2       * check procedure 2
          GOTO      EXTALL30 IF EQUAL
.
          MATCH     PTEOCODE,MRRXPRO3       * check procedure 3
          GOTO      EXTALL30 IF EQUAL
          GOTO      EXTALL22                * next procedure
.
********************** coder ID *************************************
.
EXTALL30  MATCH     SP70,MRRXCOFR
          GOTO      EXTALL32 IF NOT EQUAL
          MATCH     SP70,MRRXCOTO
          GOTO      EXTALL40 IF EQUAL
.
EXTALL32  PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECD1
EXTALL34  CALL      RKPTECD1
          BRANCH    OVRCD,EXTALL36
          MOVE      PTEDADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL36 IF NOT EQUAL
.
          MATCH     MRRXCOFR,PTEDOPER          * check range of operator/coder
          GOTO      EXTALL34 IF LESS
          MATCH     PTEDOPER,MRRXCOTO
          GOTO      EXTALL34 IF LESS
          GOTO      EXTALL50
.
EXTALL36  PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECO1
EXTALL38  CALL      RKPTECO1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      PTEOADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL90 IF NOT EQUAL
.
          MATCH     MRRXCOFR,PTEOOPER          * check range of operator/coder
          GOTO      EXTALL38 IF LESS
          MATCH     PTEOOPER,MRRXCOTO
          GOTO      EXTALL38 IF LESS
.
********************** coder snags ***************************************
.
EXTALL40  MATCH     SP70,MRRXSNAG
          IF        !@EQUAL
            PACK      KEY8,PMVXVISN,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,EXTALL90
.
            MATCH     PMVXCSNG,MRRXSNAG
            GOTO      EXTALL90 IF NOT EQUAL
          ENDIF
.
********************** coder date ***********************************
.
EXTALL50  MATCH     SP70,MRRXCDFR
          GOTO      EXTALL52 IF NOT EQUAL
          MATCH     SP70,MRRXCDTO
          GOTO      EXTALL60 IF EQUAL
.
EXTALL52  PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECD1
EXTALL54  CALL      RKPTECD1
          BRANCH    OVRCD,EXTALL56
          MOVE      PTEDADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL56 IF NOT EQUAL
.
          MATCH     MRRXCDFR,PTEDDTCD          * check range of coding date
          GOTO      EXTALL54 IF LESS
          MATCH     PTEDDTCD,MRRXCDTO
          GOTO      EXTALL54 IF LESS
          GOTO      EXTALL60
.
EXTALL56  PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECO1
EXTALL58  CALL      RKPTECO1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      PTEOADMN,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL90 IF NOT EQUAL
.
          MATCH     MRRXCDFR,PTEODTCD
          GOTO      EXTALL58 IF LESS
          MATCH     PTEODTCD,MRRXCDTO
          GOTO      EXTALL58 IF LESS
.
********************** home location ********************************
.
EXTALL60  MATCH     SP70,MRRXHLFR
          GOTO      EXTALL62 IF NOT EQUAL
          MATCH     SP70,MRRXHLTO
          GOTO      EXTALL70 IF EQUAL
.
EXTALL62  PACK      KEY20,PURNO,SP70
          CALL      RSMRMAS1
EXTALL64  CALL      RKMRMAS1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      MRMAURNO,DIM8
          MATCH     PURNO,DIM8
          GOTO      EXTALL90 IF NOT EQUAL
.
          MATCH     MRRXHOSF,MRMAHHOS
          GOTO      EXTALL64 IF LESS
          MATCH     MRRXHLFR,MRMAHLOC
          GOTO      EXTALL64 IF LESS
.
          MATCH     MRMAHHOS,MRRXHOST    
          GOTO      EXTALL64 IF LESS
          MATCH     MRMAHLOC,MRRXHLTO
          GOTO      EXTALL64 IF LESS
.
********************** document type ********************************
.
EXTALL70  
          MATCH     SP70,MRRXDTFR
          GOTO      EXTALL72 IF NOT EQUAL
          MATCH     SP70,MRRXDTTO
          GOTO      EXTALL80 IF EQUAL
.
EXTALL72  MOVE     ZERO,EXIT
          PACK      KEY20,PURNO,SP70
          CALL      RSMRMAS1
EXTALL74  CALL      RKMRMAS1
          BRANCH    OVRCD,EXTALL90
.
          MOVE      MRMAURNO,DIM8
          MATCH     PURNO,DIM8
          GOTO      EXTALL90 IF NOT EQUAL
.
          MATCH     MRRXDTFR,MRMADOTY
          GOTO      EXTALL74 IF LESS
          MATCH     MRMADOTY,MRRXDTTO
          GOTO      EXTALL74 IF LESS
.
********************** U/R From **********************************
.
EXTALL80  MATCH     SP70,MRRXURFR
          IF        !@EQUAL
            MATCH     MRRXURFR,PURNO
            GOTO      EXTALL90 IF LESS
          ENDIF
.
********************** U/R To **********************************
.
          MATCH     SP70,MRRXURTO
          IF        !@EQUAL
            MATCH     PURNO,MRRXURTO
            GOTO      EXTALL90 IF LESS
          ENDIF
.
********************** Block Number To **********************************
.
EXTALL85  MATCH     SP70,MRRXBLFR
          GOTO      EXTALL99 IF EQUAL
          PACK      KEY13,PMVXVISN,SP70                               *C-240107
          CALL      RSPTECO1
EXTALL87  CALL      RKPTECO1
          BRANCH    OVRCD,EXTALL99
          MOVE      DPTEOADM,DIM8
          MATCH     PMVXVISN,DIM8
          GOTO      EXTALL87 IF NOT EQUAL
.
          PACK      KEY10,PTEOCODE,SP70
          CALL      RDPTICO1
          BRANCH    OVRCD,EXTALL90
          COMPARE   ONE,ICDRDVER               * ICD?
          GOTO      EXTALL90 IF EQUAL
.
          MATCH     MRRXBLFR,PT0OBLKN          * check block number range 
          GOTO      EXTALL87 IF LESS
          MATCH     PT0OBLKN,MRRXBLTO
          GOTO      EXTALL87 IF LESS
.
          GOTO      EXTALL99
.
EXTALL90  MOVE      ONE,EXIT                             * set exit flag
.
EXTALL99  RETURN
+
.-----------------------------------------------------------------------
. Update Extract in Progress Indicator
.----------------------------------------------------------------
EXTINC00  PACK      KEY4,EXTRCTID,SP70
          CALL      RDMRREX1
          MOVE      ZERO,MRRXPROG           * Extract in Progress = No
          CALL      UPMRREX1
EXTINC99  RETURN
+
.------------------------------------------------------------
.                       WRTRED00
.  Write Record to Extract Table
.------------------------------------------------------------
WRTRED00  PACK      KEY12,MRRXEXID,AADMNO
          CALL      RDMRED1
          BRANCH    OVRCD,WRTRED50
          GOTO      WRTRED99
.         
WRTRED50  MOVE      MRRXEXID,MREDEID         * Extract ID
          MOVE      AADMNO,MREDVIS          * Visit number
          MOVE      PURNO,MREDURNO          * U/R Number
          IF        CTYPEUR=4
            UNPACK    PURNO,T4,T5,T6
            PACK      MREDTDIG,T5,T4,T6
          ELSE
            UNPACK    PURNO,T1,T2,T3
            PACK      MREDTDIG,T3,T2,T1       * Terminal Digit U/R number
          ENDIF
          MOVE      SP70,MREDLEV1           * Summary Level 1
          MOVE      SP70,MREDLEV2           * Summary Level 2
          MOVE      SP70,MREDLEV3           * Summary Level 3
          MOVE      ZERO,MREDANL1           * Analysis Measure 1
          MOVE      ZERO,MREDANL2           * Analysis Measure 2
          MOVE      ZERO,MREDANL3           * Analysis Measure 3
          MOVE      ZERO,MREDDEL            * Deleted from Extract 0=No 1=Yes
.
          PACK      KEY12,MRRXEXID,MREDVIS,SP70
          CALL      RAMRED1
          IF        OVRCD=1       
            CALL      WRMRED1
          ENDIF
.
WRTRED99  RETURN
+
.----------------------------------------------------------------
.                          CLRRED00
.  Clear Patient Records Request Extract Table (MRTREDFD) for
.  Extract ID.
.----------------------------------------------------------------
CLRRED00  PACK      KEY12,EXTRCTID,SP70
          CALL      RSMRED1
          CALL      RKMRED1
          BRANCH    OVRCD,CLRRED99
.
          MATCH     EXTRCTID,MREDEID
          GOTO      CLRRED99 IF NOT EQUAL
.
          PACK      KEY12,MREDEID,MREDVIS,SP70
          CALL      DEMRED1
          GOTO      CLRRED00
.
CLRRED99  RETURN
+
.----------------------------------------------------------------
.                          PRTRED00
.  Print Patient Records Request Extract Table (MRTREDFD) for
.  Extract ID.
.----------------------------------------------------------------
PRTRED00  MOVE      "MR Research Extract",PRGNAM
          CALL      PRTHD000                * Patient List Table Heading
.
          MOVE      EXTRCTID,KEY4
          CALL      RDMRREX1
          BRANCH    OVRCD,PRTRED90
.
          PACK      KEY20,EXTRCTID,SP70
          CALL      RSMRED3
PRTRED10  CALL      RKMRED3
          BRANCH    OVRCD,PRTRED99
.
          MATCH     EXTRCTID,MREDEID
          GOTO      PRTRED99 IF NOT EQUAL
.
          CALL      PRTROW00
          GOTO      PRTRED10
.
PRTRED90  MOVE      "Invalid Research Extract ID",WEBERR  
          MOVE      ONE,EXIT
.
PRTRED99  RETURN
+
.------------------------------------------------------------
.        Patient Research Extract Print Heading           
.------------------------------------------------------------
PRTHD000  CLOCK     TIME,CTIMEIS
.
          CALL      HEAD80
          MOVE      "3",CLNO
          ADD       ONE,CPAGENO
.
          PRINT     *1,"Extract ID : ",EXTRCTID
          PRINT     *1,"|",*3,"U/R Number":
                    *13,"|",*15,"Visit No",*24,"|":
                    *26,"Patient",*56,"|":
                    *58,"Deleted",*66,"|":
                    *68,"Disch. Date",*80,"|"
          PRINT     *1,"----------------------------------------":
                    *40,"----------------------------------------"
.
PRTHD999  RETURN
.------------------------------------------------------------
. Read patient details and write the patient line           
.------------------------------------------------------------
PRTROW00  PACK      KEY8,MREDVIS,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      "Invalid Admission",FORMATNM
          ENDIF
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            MOVE      "Invalid U/R",FORMATNM
          ELSE
            IF        PCEASE=1
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ELSE
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ENDIF
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATCN000
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            MOVE      SP70,DISPDATE
            GOTO      PRTROW99
          ELSE
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CALL      GETDRGZ                 * get Grouper version     *I-137125
          PACK      KEY7,PTMIPDRG,DRGVERZ,SP10                        *C-137125
          CALL      RDPTDGW1
          IF        OVRCD=1
            MOVE      SP70,PTDWDESC
          ENDIF
.
          MATCH    "1",MREDDEL
          IF       @EQUAL
            MOVE     "Yes",DELTSTAT
          ELSE
            MOVE     "No ",DELTSTAT
          ENDIF
.
          ADD       ONE,CLNO
          COMPARE   FIFTY5,CLNO
          CALL      PRTHD000 IF EQUAL
.
          PRINT     *1,"|",*3,MREDURNO,*13,"|":
                    *14,MREDVIS,*24,"|":
                    *26,FORMATNM,*56,"|":
                    *58,DELTSTAT,*66,"|":
                    *68,DISPDATE,*80,"|"
.
PRTROW99  RETURN
.----------------------------------------------------------------
PATCN000  MOVE     PSNAME,FMTSNAME
          MOVE     PGNAME,FMTGNAME
          MOVE     PTITL,FMTTITLE
.
          READ     CONTROLF,HUND01;*45,CWEBPNAM
          MOVE     CWEBPNAM,F2
          SFORMAT  FORMATNM,127
          PACK     FORMATNM,SP70,SP70
          REP      "' ",FMTSNAME
          REP      "#" ",FMTSNAME
          REP      "' ",FMTGNAME
          REP      "#" ",FMTGNAME
          REP      UPPLOW,FMTSNAME
.
          CLEAR    DISPNAME
          PACK     NAME35,FMTTITLE,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTTITLE
          STRIP    FMTTITLE
.
          CLEAR    DISPNAME
          PACK     NAME35,FMTGNAME,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTGNAME
          STRIP    FMTGNAME
.
          STRIP    FMTSNAME
          CLEAR    FORMATNM
          APPEND   FMTSNAME,FORMATNM
          APPEND   COMMA,FORMATNM
          APPEND   SP1,FORMATNM
          BRANCH   F2,PATLN010,PATLN020,PATLN030,PATLN040,PATLN050:
                      PATLN060,PATLN070,PATLN080,PATLN090,PATLN100:
                      PATLN110,PATLN120,PATLN130,PATLN140,PATLN150:
                      PATLN160,PATLN170,PATLN180,PATLN190,PATLN200
.
          GOTO     PATLN999
.
.----------------------------------------------------------------
. Automatic Coding
.----------------------------------------------------------------
AUTOC000  CALL      KCOT0000                * Keyin coding template
          BRANCH    EXIT,AUTOC950
.
. ----- Same Day Only (Y/N) -----
.
          MOVE      "23",CCOL
          MOVE      "16",CVERT
          DISPLAY   *P1:CVERT,"Same Day Only (Y/N) : ";
          CALL      KYNQ0000                * Keyin yes/no question
          MOVE      ANS,SELSAMDY
.
. ----- Discharge Unit -----
.
          MOVE      "23",ECOL
          MOVE      "17",EVERT
          MOVE      "AC",CODE
          PACK      CKYIDEF3,SELUNITC,SP3
          MOVE      ZERO,CKYIMAND
          MOVE      ZERO,CKYIMODE
          DISPLAY   *P1:EVERT,"Discharge Unit      : ";
          CALL      PATCODKY                * Keyin a codes file code
          BRANCH    EXIT,AUTOC010,AUTOC950
.
          MOVE      ACODE,SELUNITC
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,SELUNITC,*HOFF,SP2,TDESC;
          GOTO      AUTOC020
.
AUTOC010  UNPACK    SP30,SELUNITC,TDESC
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,"All";
.
. ----- Discharge Ward -----
.
AUTOC020  MOVE      "23",ECOL
          MOVE      "18",EVERT
          PACK      CKYIDEF3,SELWARDC,SP3
          MOVE      ZERO,CKYIMAND
          MOVE      ZERO,CKYIMODE
          DISPLAY   *P1:EVERT,"Discharge Ward      : ";
          CALL      PATWRDKY                * Keyin a ward code
          BRANCH    EXIT,AUTOC025,AUTOC950
.
          MOVE      WWARD,SELWARDC
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,SELWARDC,*HOFF,SP2,WBDESC;
          GOTO      AUTOC030
.
AUTOC025  UNPACK    SP30,SELWARDC,WBDESC
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,"All";
.
. Unplanned Return to Theatre 
.
AUTOC030  MOVE      "23",ECOL
          MOVE      "19",EVERT
          MOVE      "KB",CODE
          PACK      CKYIDEF3,SELURTTH,SP3
          MOVE      ZERO,CKYIMAND
          MOVE      ZERO,CKYIMODE
          DISPLAY   *P1:EVERT,"Unplanned Return to : ";
          CALL      PATCODKY                * Keyin a codes file code
          BRANCH    EXIT,AUTOC035,AUTOC950
.
          MOVE      ACODE,SELURTTH
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,SELURTTH,*HOFF,SP2,TDESC;
          GOTO      AUTOC040
.
AUTOC035  UNPACK    SP70,SELURTTH,TDESC
          DISPLAY   *PECOL:EVERT,*EL,*V2LON,"";
.
. ----- Keyin The Discharge Date Range -----
.
AUTOC040  CALL      KDDR0000                * Keyin the discharge date range
          BRANCH    EXIT,AUTOC950
.
          DISPLAY   *P1:24,"User ID : ";
          KEYIN     *P23:24,*V2LON,USERID
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1               * Exit if invalid user
            BRANCH    OVRCD,AUTOC950
          ENDIF
.
. ----- Print the report -----
.
          MOVE      ZERO,CLNO
          MOVE      ZERO,CPAGENO
          CALL      HEAD132
.
          UNPACK    STRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ADD       ONE,CLNO
          PRINT     "Discharge Date Range: ":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          UNPACK    ENDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PRINT     " to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                    "  Dicharge Ward:",SELWARDC:
                    "  Dicharge Unit:",SELUNITC:
                    "  Same Day Only:",SELSAMDY:
                    "  Coding Template:",SELCODTM

          UNPACK    CURRDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ADD       ONE,CLNO
          PRINT     "Date of Coding: ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ADD       ONE,CLNO
          CALL      UND132
          PRINT     "U/R",*13,"Admission",*23,"Name",*75,"Admission Date",*90:
                    "Discharge Date"
          CALL      UND132
.
          PACK      KEY16,STRDAT,SP70
          CALL      RDSDSCH2      
AUTOC100  CALL      RDKDSCH2      
          BRANCH    OVRCD,AUTOC600
.
          MATCH     DDATE,ENDDAT            * check discharge date to
          GOTO      AUTOC600 IF LESS          
.
          MOVE      DDATE,ICDRDDTE          * Used for reading ICD files
.
          MATCH     SP70,SELWARDC
          IF        !@EQUAL
            MATCH     PTDSDWRD,SELWARDC     * check ward
            GOTO      AUTOC100 IF NOT EQUAL
          ELSE
            IF      IBCNMHOS=1
              PACK      KEY8,DADMNO,SP70
              CALL      RDPMVX11            * In no ward check hospital
              BRANCH    OVRCD,AUTOC100
.
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      AUTOC100 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,DADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,AUTOC100          * Admission number doesn't exist
.
          MATCH     SP70,ACODDTE            * Only Coding Uncodded Patients
          GOTO      AUTOC100 IF NOT EQUAL
.
          MATCH     "Y",SELSAMDY            * check for sameday discharge
          IF        @EQUAL
            MATCH     DDATE,ADATE           * check same day
            GOTO      AUTOC100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SELUNITC
          IF        !@EQUAL
            MATCH     SELUNITC,ACLSSFT      * check unit
            GOTO      AUTOC100 IF NOT EQUAL
          ENDIF
.
          MOVE      AURNO,KEY8              * Read master files deatils
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      RDPMPX21              * read PMI extension file
            CALL      PATNAA00              * Format Patient Name
          ENDIF
.
          ADD       ONE,CLNO                * Increment number of lines         
          COMPARE   "55",CLNO
          CALL      HEAD132 IF EQUAL
.
          MATCH     SP70,ADATE
          IF        !@EQUAL
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISADATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISADATE
          ENDIF
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISDDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISDDATE
          ENDIF
.
          PRINT     AURNO,*13,AADMNO,*23,PATFNAME,*75,DISADATE,*90,DISDDATE
.
          MOVE      "01",EPISODNO           * Reset Episode Code
          MOVE      DADMNO,VISITNO          * Set Visit number
.
          CALL      DELECD00 * Del Episode records from Disease Coding file
          CALL      DELECO00 * Del Episode records from Procedure Coding file
.
          MOVE      ADATE,AGEDATE           * Using Admission Date
          CALL      CALCAGE                 * Needed for VDSCD000 & VOPCD000
.
AUTOC180  PACK      KEY8,DADMNO,SP70
          CALL      RDPMVX11            * In no ward check hospital
          BRANCH    OVRCD,AUTOC100
.
          MOVE      SELURTTH,PMVXUVTH
          CALL      UPPMVX11 
.
          PACK      KEY8,SELCODTM,SP70      * Read the coding template
          CALL      RSMRTDT1
AUTOC200  CALL      RKMRTDT1
          BRANCH    OVRCD,AUTOC500
.
          MATCH     SELCODTM,MRTDTMNO
          GOTO      AUTOC500 IF NOT EQUAL   * no more codes for the 
.
          MATCH     "D",MRTDRECT            * is this a disease code?
          GOTO      AUTOC300 IF EQUAL       * yes
.
          CALL      VALOPR00                * Validate operation Code 
          BRANCH    EXIT,AUTOC400           * Error: delete coding
          CALL      SAVPRO00                * Save Procedure record
          GOTO      AUTOC200                * get next templated code
.
AUTOC300  CALL      VALDIS00                * Validate Disease Code 
          BRANCH    EXIT,AUTOC400           * Error: delete coding
          CALL      SAVDIS00                * Save disease record
          GOTO      AUTOC200                * get next templated code 
.
AUTOC400
....      CALL      DISSQE00             * Resequence Disease Codes & MDS Data
....      CALL      PROSQE00             * Resequence Procedure Codes & MDS Data
          CALL      CODINC00             * Update coding Incomplete 
          GOTO      AUTOC550             * Get next patient
.
AUTOC500
....      CALL      DISSQE00             * Resequence Disease Codes & MDS Data
....      CALL      PROSQE00             * Resequence Procedure Codes & MDS Data
          CALL      CODCOM00             * Update coding complete 
.
.    Set the following vars for SETGRP00 & PTHCS000
.
          MOVE      AURNO,URNUMBER       
          MOVE      VISITNO,ADMISSNO     
          MOVE      EPISODNO,EPSCD001    
.                                                                     *I-262698
          MOVE      ADATE,ENCSTDAT       * Start & End dates for Grouper -
          MOVE      ATIME,ENCSTTIM       * (for Episode coding)
          MOVE      DDATE,ENCENDAT
          MOVE      DTIME,ENCENTIM
.
          CALL      PTHCS000             * Update Episode Morbidity Changes File
.
.    Run UNIX or PC Grouper Depending on PARAMETER
.
          COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "V",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE      * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE      * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
            ENDIF
          ENDIF
.
.         Before getting the next discharge record, trigger a visit
.         update message after getting the last transfer record
.
AUTOC550  PACK      KEY30,AADMNO,ZED30
          CALL      RDSTRAN2                * position on admission number
          CALL      RDPTRAN2                * read previous transfer record
          BRANCH    OVRCD,AUTOC100          * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      AUTOC100 IF NOT EQUAL   * no - should happen
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * trigger I/P visit update message
.
          GOTO      AUTOC100             * Get next patient
.
AUTOC600  CALL      UND132
          PRINT     *55,"***** END OF REPORT *****"
.
AUTOC900  MOVE      ZERO,EXIT
          GOTO      AUTOC999
.
AUTOC950  MOVE      ONE,EXIT
AUTOC999  RETURN 
+
.----------------------------------------------------------------
. Using CCA Interface for coding/grouping so exit program
.----------------------------------------------------------------
UCCA0000  MOVE      ZERO,CLNO
          MOVE      ZERO,CPAGENO
          CALL      HEAD132
.
          PRINT     *N
          PRINT     "** Interface is set to use CCA, this report option is not available **"
          PRINT     *N
.
          CALL      UND132
          PRINT     *55,"***** END OF REPORT *****"
.
UCCA9999  RETURN
+
.----------------------------------------------------------------
. Patient Regrouping
.----------------------------------------------------------------
REGRP000  CALL      KDDR0000                * Keyin the discharge date range
          BRANCH    EXIT,REGRP950
.
          IF        SOPTION=8
            DISPLAY   *P35:23,"User ID : ";
            KEYIN     *P45:23,*V2LON,USERID
.
            CALL      KHOS0000              * Keyin hospital id
            BRANCH    EXIT,REGRP950
.
          ENDIF
.
. ----- Print the report -----
.
          MOVE      ZERO,CLNO
          MOVE      ZERO,CPAGENO
          CALL      HEAD132
.
          UNPACK    STRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ADD       ONE,CLNO
          PRINT     "Discharge Date Range: ":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          UNPACK    ENDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PRINT     " to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1;
.
          IF        IBCNMHOS=1
            PRINT     "Hospital: ",PTHSNAME
          ELSE
            PRINT     SP1  
          ENDIF
.
          ADD       ONE,CLNO
          CALL      UND132
          PRINT     "U/R",*13,"Admission",*23,"Name",*75,"Admission Date",*90:
                    "Discharge Date",*107,"Episode"
          CALL      UND132
.
          PACK      KEY16,STRDAT,SP70
          CALL      RDSDSCH2      
REGRP100  CALL      RDKDSCH2      
          BRANCH    OVRCD,REGRP600
.
          MATCH     DDATE,ENDDAT            * check discharge date to
          GOTO      REGRP600 IF LESS          
.
..          MATCH     SP70,SELWARDC
..          IF        !@EQUAL
..            MATCH     PTDSDWRD,SELWARDC     * check ward
..            GOTO      REGRP100 IF NOT EQUAL
..          ENDIF
.
          PACK      KEY8,DADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,REGRP100          * Admission number doesn't exist
.
          PACK      KEY8,DADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,REGRP100          * Admission number doesn't exist
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL
              MATCH     HOSPCODE,PMVXMHOS     * Filter by hospital
              GOTO      REGRP100 IF NOT EQUAL
            ENDIF
          ENDIF
.
..          MATCH     "Y",SELSAMDY            * check for sameday discharge
..          IF        @EQUAL
..            MATCH     DDATE,ADATE           * check same day
..            GOTO      REGRP100 IF NOT EQUAL
..          ENDIF
.
..          MATCH     SP70,SELUNITC
..          IF        !@EQUAL
..            MATCH     SELUNITC,ACLSSFT      * check unit
..            GOTO      REGRP100 IF NOT EQUAL
..          ENDIF
.
          MOVE      AURNO,KEY8              * Read master files deatils
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      RDPMPX21              * read PMI extension file
            CALL      PATNAA00              * Format Patient Name
          ENDIF
.
          MATCH     SP70,ADATE
          IF        !@EQUAL
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISADATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISADATE
          ENDIF
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISDDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR      
          ELSE
            MOVE      SP70,DISDDATE
          ENDIF
.
          MOVE      ZERO,EPISODNO           * Reset Episode Code
          MOVE      DADMNO,VISITNO          * Set Visit number
.
          MOVE      ADATE,AGEDATE           * Using Admission Date
          CALL      CALCAGE                 * Needed for VDSCD000 & VOPCD000
.
.  Check as must have at least one Disease Code and check for Multiple Episodes
.
REGRP200  ADD       ONE,EPISODNO      * Set Episode No for SETGRP00 
          PACK      KEY13,VISITNO,EPISODNO,SP70                       *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,REGRP100
.
          MATCH     VISITNO,PTEDADMN        * Admission Not Found 
          GOTO      REGRP100 IF NOT EQUAL   
.
          COMPARE   EPISODNO,PTEDEPNO       * Episode Not Found 
          GOTO      REGRP100 IF NOT EQUAL    
.
.    Set the following vars for SETGRP00 & PTHCS000
.
          MOVE      AURNO,URNUMBER        
          MOVE      VISITNO,ADMISSNO     
          MOVE      EPISODNO,EPSCD001   
.                                                                     *I-262698
          MOVE      ADATE,ENCSTDAT       * Start & End dates for Grouper -
          MOVE      ATIME,ENCSTTIM       * (for Episode coding)
          MOVE      DDATE,ENCENDAT
          MOVE      DTIME,ENCENTIM
.
.    Read PATGRPFD and save National and State DRG
.
          MOVE      SP10,KEY3
          CALL      GTDRG000       * Get Grouper Version - returns it in KEY3
          PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
          CALL      RDPTPGR1   * Read Grouper Details
          IF        OVRCD=1
            MOVE      SP70,NATIODRG   * National DRG
            MOVE      SP70,STATEDRG   * State DRG
          ELSE
            MOVE      PTPGNDRG,NATIODRG   * National DRG
            MOVE      PTPGSDRG,STATEDRG   * State DRG
          ENDIF
.
          PRINT     AURNO,*13,VISITNO,*23,PATFNAME,*75,DISADATE,*90,DISDDATE:
                          *108,EPISODNO 
.
.    Run UNIX or PC Grouper Depending on PARAMETER
.
          COMPARE   ONE,PTCNODRG
          IF        @EQUAL
            COMPARE   ONE,MRCNGRUP     * 1=PC, 0=UNIX Grouper
            IF        @EQUAL
              MOVE      "V",UPDTTYPE        * Export/Import PC Grouper
              CALL      SETGRP00
            ELSE
              IF        MRCNGRUP=3
                MOVE      "O",UPDTTYPE      * Run TurboGrouper
              ELSE
                MOVE      "U",UPDTTYPE      * Run UNIX Grouper
              ENDIF
              CALL      SETGRP00
            ENDIF
          ENDIF
.
.    Check if DRG's have changed? If so then write to PATECMFD 
.
          MOVE      SP10,KEY3
          CALL      GTDRG000       * Get Grouper Version - returns it in KEY3
          PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70
          CALL      RDPTPGR1   * Read Grouper Details
          BRANCH    OVRCD,REGRP400
.
          MATCH     PTPGNDRG,NATIODRG   * National DRG
          GOTO      REGRP300 IF NOT EQUAL
.
          MATCH     PTPGSDRG,STATEDRG   * State DRG
          GOTO      REGRP300 IF NOT EQUAL
.
          GOTO      REGRP400

REGRP300  CALL      PTHCS000             * Update Episode Morbidity Changes File
.
          MOVE      "National DRG before:",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    NATIODRG,WEBTITLE
          ENDSET    WEBTITLE
          APPEND    " State DRG before:",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    STATEDRG,WEBTITLE
          PRINT     *23,WEBTITLE
.
          MOVE      "National DRG after :",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    PTPGNDRG,WEBTITLE
          ENDSET    WEBTITLE
          APPEND    " State DRG after :",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    PTPGSDRG,WEBTITLE
          PRINT     *23,WEBTITLE
.
REGRP400  ADD       ONE,CLNO              * Increment number of lines 
          COMPARE   "55",CLNO
          IF        @EQUAL          
            CALL      HEAD132
            PRINT     "U/R",*13,"Admission",*23,"Name",*75,"Admission Date",*90:
                      "Discharge Date",*107,"Episode"
            CALL      UND132
          ENDIF
.
          GOTO      REGRP200             * Get next Episode
.
REGRP600  CALL      UND132
          PRINT     *55,"***** END OF REPORT *****"
.
REGRP900  MOVE      ZERO,EXIT
          GOTO      REGRP999
.
REGRP950  MOVE      ONE,EXIT
REGRP999  RETURN 
+
.******************************************************************************
.*                                  KHOS0000              Called by: REGRP000 *
.*                            Enter The Hospital Code                         *
.******************************************************************************
KHOS0000  COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          MOVE      SP70,HOSPCODE
          MOVE      SP70,HOSPNAME
.
          DISPLAY   *P1:24,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      TWENTY4,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,HOSPCODE
.
KHOS3000  DISPLAY   *P20:24,*V2LON,PTHSNAME;
          MOVE      PTHSHOSP,HOSPCODE
          MOVE      PTHSNAME,HOSPNAME
          MOVE      ZERO,EXIT
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN

.******************************************************************************
.*                                  PTHCS000              Called by: CODING00 *
.*                                                                   AUTOC000 *
.*             ----- Update The Episode Morbidity Changes File -----          *
.******************************************************************************
PTHCS000  COMPARE   THREE,PTCNHDPS          * State Indicator 
          GOTO      PTHCS999 IF NOT EQUAL   * Not Using Morbidity Changes File
.
          MOVE      SP1,CKYIDEF1            * 1st record flag - default
          UNPACK    CURRDATE,CKYIDEF6
.
          PACK      KEY18,ADMISSNO,EPSCD001,SP20
PTHCS100  CALL      RSPTECM1                * Position on & read an episode
PTHCS200  CALL      RKPTECM1                * morbidity changes file record
          BRANCH    OVRCD,PTHCS300
.
          MATCH     ADMISSNO,DPTEMADM
          GOTO      PTHCS300 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPSCD001,PTEMEPNO
          GOTO      PTHCS300 IF NOT EQUAL   * Different Episode no
.
          UNPACK    PTEMCDTE,KEY6
          MATCH     CKYIDEF6,KEY6
          GOTO      PTHCS200 IF NOT EQUAL   * Different change month
.
          PACK      KEY18,PTEMADMN,PTEMEPNO,PTEMCDTE
          CALL      DEPTECM1                * Delete an eps morb change file rec
          MOVE      ANSC,CKYIDEF1           * 1st record flag - changed
.
          GOTO      PTHCS100
.
PTHCS300  MOVE      ONE,FORM3                                         *C-240107
          PACK      KEY13,ADMISSNO,EPSCD001,FORM3,SP20                *C-240107
          CALL      RDPTECD1         * Read episode disease file record
          BRANCH    OVRCD,PTHCS400
.
          CALL      WTECM000         * Write a record of eps changes file
.
PTHCS400  MOVE      ONE,FORM3                                         *C-240107
          PACK      KEY13,ADMISSNO,EPSCD001,FORM3,SP20                *C-240107
          CALL      RDPTECO1         * Read episode operation file record
          BRANCH    OVRCD,PTHCS999
.
          MOVE      PTEOADMN,PTEDADMN
          MOVE      PTEOEPNO,PTEDEPNO
          CALL      WTECM000        * Write a record of eps changes file
.
PTHCS999  RETURN
.******************************************************************************
.*                                  WTECM000              Called by: PTHCS000 *
.*                  Write A Record To The Episode Changes File                *
.******************************************************************************
WTECM000  PACK      KEY18,PTEDADMN,PTEDEPNO,CURRDATE
          CALL      RAPTECM1                * Read An Eps Morb Change File Rec
          COMPARE   ZERO,OVRCD
          GOTO      WTECM999 IF EQUAL       * Record already there
.
          MOVE      PTEDADMN,PTEMADMN
          MOVE      PTEDEPNO,PTEMEPNO
          MOVE      CURRDATE,PTEMCDTE
          MOVE      CKYIDEF1,PTEMNEWF
          PACK      PTEMSPAR,SP20
.
          PACK      KEY18,PTEMADMN,PTEMEPNO,PTEMCDTE
          CALL      WRPTECM1              * Write an eps morb change file rec
.
WTECM999  RETURN
+
.******************************************************************************
.*                                  KEXI0000              Called by: MAIN0000 *
.*                              Keyin Extract Id                              *
.******************************************************************************
KEXI0000  MOVE      ZERO,CQUEST             * ? flag - no
          MOVE      "14",CVERT
KEXI0500  KEYIN     *P1:CVERT,*EL,"Extract ID : ",*V2LON,EXTRCTID;
.
          PACK      EXTRCTID,EXTRCTID,SP4
          MATCH     SP4,EXTRCTID
          GOTO      KEXI8500 IF EQUAL       * Spaces
          GOTO      KEXI8500 IF EOS         * Nothing
.
          MATCH     "?",EXTRCTID
          GOTO      KEXI1000 IF EQUAL       * ? entered
.
          PACK      KEY4,EXTRCTID
          CALL      RDMREX1                 * Read a med rec extract file rec
          COMPARE   ONE,OVRCD
          GOTO      KEXI8000 IF NOT EQUAL   * Record exists
.
          DISPLAY   *P1:24,*EL,*B,"Invalid extract id.  ";
          CALL      HITENTER
          GOTO      KEXI0500
.
KEXI1000  IF        CQUEST=0
            MOVE      ZERO,HLEF
            CALL      GETSCR00              * Save the current screen
          ENDIF
          MOVE      ONE,CQUEST              * ? flag - yes
          MOVE      "24",CVERT
.
KEXI1500  MOVE      "5",EVERT
          MOVE      "1",FORM2
.xtract ID & Description        Disch Date Range  Admin date Range  Ward/Bed PG
.234 12345678901234567890123456 12/45/78 12/45/78 12/45/78 12/45/78  123/123 123
          DISPLAY   *P1:3,*EF,*V2LON,*ULON:
                    *P1:4,"Extract ID & Description       ":
                    *P33:4,"Disch Date Range ",*P51:4,"Admin Date Range ":
                    *P69:4,"Ward/Bed",*P78:4,"PG ";
.
          PACK      KEY4,SP4
          CALL      RSMREX1                 * Position on & read a medical
KEXI2000  CALL      RKMREX1                   records extract file record
          BRANCH    OVRCD,KEXI0500
.
          COMPARE   "24",EVERT
          GOTO      KEXI3000 IF NOT LESS    * Counter >= 24
.
KEXI2500  MOVE      MREXDESC,KEY26
          DISPLAY   *P1:EVERT,*V2LON,MREXEID,*HOFF,*P6:EVERT,KEY26;
.
          UNPACK    MREXDDFR,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch from date
          DISPLAY   *P33:EVERT,CPDATE;
.
          UNPACK    MREXDDTO,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch to date
          DISPLAY   *P42:EVERT,CPDATE;
.
          UNPACK    MREXADFR,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin from date
          DISPLAY   *P51:EVERT,CPDATE;
.
          UNPACK    MREXADTO,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin from date
          DISPLAY   *P60:EVERT,CPDATE,*P70:EVERT,MREXWARD,SLASH,MREXUNIT:
                    *P78:EVERT,MREXPRCG;
          ADD       "1",EVERT
          GOTO      KEXI2000
.
KEXI3000  DISPLAY   *P1:24,*EL,"(",*V2LON,"N",*HOFF,")ext Screen, (";
          MOVE      "16",ECOL
.
          IF        FORM2>1
            DISPLAY   *V2LON,"F",*HOFF,")irst Screen, (";
            ADD       "16",ECOL
          ENDIF
.
          DISPLAY   *V2LON,"E",*HOFF,")xit ? ";
          ADD       "9",ECOL
.
KEXI3500  KEYIN     *PECOL:24,*EL,*V2LON,ANS;
.
          REP       "nNfFeE",ANS
          MATCH     "N",ANS
          GOTO      KEXI4000 IF EQUAL       * Next screen
.
          IF        FORM2>1
            MATCH     "F",ANS
            GOTO      KEXI1500 IF EQUAL     * 1st screen
          ENDIF
.
          MATCH     "E",ANS
          GOTO      KEXI0500 IF EQUAL       * Exit screen
.
          BEEP
          GOTO      KEXI3500
.
KEXI4000  DISPLAY   *P1:5,*EF;
          ADD       "1",FORM2
          MOVE      "5",EVERT
          GOTO      KEXI2500
.
KEXI8000  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          DISPLAY   *P14:14,*EL,*V2LON,EXTRCTID,*HOFF,SP2,MREXDESC;
          GOTO      KEXI9000
.
KEXI8500  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          GOTO      KEXI9500
.
KEXI9000  MOVE      ZERO,EXIT
          GOTO      KEXI9999
.
KEXI9500  MOVE      ONE,EXIT
KEXI9999  RETURN
+
.******************************************************************************
.*                                  KRES0000              Called by: MAIN0000 *
.*                              Keyin Research Id                             *
.******************************************************************************
KRES0000  MOVE      ZERO,CQUEST             * ? flag - no
          MOVE      "14",CVERT
KRES0500  KEYIN     *P1:CVERT,*EL,"Extract ID : ",*V2LON,EXTRCTID;
.
          PACK      EXTRCTID,EXTRCTID,SP4
          MATCH     SP4,EXTRCTID
          GOTO      KRES8500 IF EQUAL       * Spaces
          GOTO      KRES8500 IF EOS         * Nothing
.
          MATCH     "?",EXTRCTID
          GOTO      KRES1000 IF EQUAL       * ? entered
.
          PACK      KEY4,EXTRCTID
          CALL      RDMRREX1                 * Read a med rec research file rec
          COMPARE   ONE,OVRCD
          GOTO      KRES8000 IF NOT EQUAL   * Record exists
.
          DISPLAY   *P1:24,*EL,*B,"Invalid extract id.  ";
          CALL      HITENTER
          GOTO      KRES0500
.
KRES1000  IF        CQUEST=0
            MOVE      ZERO,HLEF
            CALL      GETSCR00              * Save the current screen
          ENDIF
          MOVE      ONE,CQUEST              * ? flag - yes
          MOVE      "24",CVERT
.
KRES1500  MOVE      "5",EVERT
          MOVE      "1",FORM2
.xtract ID & Description        Disch Date Range  Admin date Range  Ward/Bed PG
.234 12345678901234567890123456 12/45/78 12/45/78 12/45/78 12/45/78  123/123 123
          DISPLAY   *P1:3,*EF,*V2LON,*ULON:
                    *P1:4,"Extract ID & Description       ":
                    *P33:4,"Disch Date Range ",*P51:4,"Admin Date Range ":
                    *P69:4,"Ward/Bed",*P78:4,"PG ";
.
          PACK      KEY4,SP4
          CALL      RSMRREX1                 * Position on & read a medical
KRES2000  CALL      RKMRREX1                 * records research file record
          BRANCH    OVRCD,KRES0500
.
          COMPARE   "24",EVERT
          GOTO      KRES3000 IF NOT LESS    * Counter >= 24
.
KRES2500  MOVE      MRRXDESC,KEY26
          DISPLAY   *P1:EVERT,*V2LON,MRRXEXID,*HOFF,*P6:EVERT,KEY26;
.
          UNPACK    MRRXDIFR,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch from date
          DISPLAY   *P33:EVERT,CPDATE;
.
          UNPACK    MRRXDITO,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the disch to date
          DISPLAY   *P42:EVERT,CPDATE;
.
          UNPACK    MRRXVIFR,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin from date
          DISPLAY   *P51:EVERT,CPDATE;
.
          UNPACK    MRRXVITO,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the admin from date
          DISPLAY   *P60:EVERT,CPDATE,*P70:EVERT,MRRXWARD,SLASH,MRRXUNIT:
                    *P78:EVERT,SLASH;
          ADD       "1",EVERT
          GOTO      KRES2000
.
KRES3000  DISPLAY   *P1:24,*EL,"(",*V2LON,"N",*HOFF,")ext Screen, (";
          MOVE      "16",ECOL
.
          IF        FORM2>1
            DISPLAY   *V2LON,"F",*HOFF,")irst Screen, (";
            ADD       "16",ECOL
          ENDIF
.
          DISPLAY   *V2LON,"E",*HOFF,")xit ? ";
          ADD       "9",ECOL
.
KRES3500  KEYIN     *PECOL:24,*EL,*V2LON,ANS;
.
          REP       "nNfFeE",ANS
          MATCH     "N",ANS
          GOTO      KRES4000 IF EQUAL       * Next screen
.
          IF        FORM2>1
            MATCH     "F",ANS
            GOTO      KRES1500 IF EQUAL     * 1st screen
          ENDIF
.
          MATCH     "E",ANS
          GOTO      KRES0500 IF EQUAL       * Exit screen
.
          BEEP
          GOTO      KRES3500
.
KRES4000  DISPLAY   *P1:5,*EF;
          ADD       "1",FORM2
          MOVE      "5",EVERT
          GOTO      KRES2500
.
KRES8000  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          DISPLAY   *P14:14,*EL,*V2LON,EXTRCTID,*HOFF,SP2,MRRXDESC;
          GOTO      KRES9000
.
KRES8500  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          GOTO      KRES9500
.
KRES9000  MOVE      ZERO,EXIT
          GOTO      KRES9999
.
KRES9500  MOVE      ONE,EXIT
KRES9999  RETURN
+
.******************************************************************************
.*                                  KCOT0000              Called by: AUTOC000 *
.*                            Keyin Coding Template                           *
.******************************************************************************
KCOT0000  MOVE      ZERO,CQUEST             * ? flag - no
          MOVE      "14",CVERT
KCOT0500  KEYIN     *P1:CVERT,*EL,"Template ID         : ",*V2LON,SELCODTM;
.
          PACK      SELCODTM,SELCODTM,SP4
          MATCH     SP4,SELCODTM
          GOTO      KCOT8500 IF EQUAL       * Spaces
          GOTO      KCOT8500 IF EOS         * Nothing
.
          MATCH     "?",SELCODTM
          GOTO      KCOT1000 IF EQUAL       * ? entered
.
          PACK      KEY4,SELCODTM
          CALL      RDMRTHD1                * Read a med rec temp head file rec
          COMPARE   ONE,OVRCD
          GOTO      KCOT8000 IF NOT EQUAL   * Record exists
.
          DISPLAY   *P1:24,*EL,*B,"Invalid template id.  ";
          CALL      HITENTER
          GOTO      KCOT0500
.
KCOT1000  IF        CQUEST=0
            MOVE      ZERO,HLEF
            CALL      GETSCR00              * Save the current screen
          ENDIF
          MOVE      ONE,CQUEST              * ? flag - yes
          MOVE      "24",CVERT
.
KCOT1500  MOVE      "1",ECOL
          MOVE      "5",EVERT
          MOVE      "1",FORM2
.Template Id & Description
.234 1234567890123456789012345678901234  1234 1234567890123456789012345678901234
          DISPLAY   *P1:3,*EF,*V2LON,*ULON:
                    *P1:4,"Template ID & Description";
.
          PACK      KEY4,SP4
          CALL      RSMRTHD1                * Position on & read a medical
KCOT2000  CALL      RKMRTHD1                  records template header file rec
          BRANCH    OVRCD,KCOT0500
.
          COMPARE   "24",EVERT
          GOTO      KCOT3000 IF NOT LESS    * Counter >= 24
.
KCOT2500  DISPLAY   *PECOL:EVERT,*V2LON,MRTHTMID,*HOFF,SP1,MRTHDESC;
          ADD       "1",EVERT
          GOTO      KCOT2000
.
KCOT3000  COMPARE   "42",ECOL
          GOTO      KCOT4500 IF NOT EQUAL   * Display on 2nd 1/2 of screen
.
          DISPLAY   *P1:24,*EL,"(",*V2LON,"N",*HOFF,")ext Screen, (";
          MOVE      "16",ECOL
.
          IF        FORM2>1
            DISPLAY   *V2LON,"F",*HOFF,")irst Screen, (";
            ADD       "16",ECOL
          ENDIF
.
          DISPLAY   *V2LON,"E",*HOFF,")xit ? ";
          ADD       "9",ECOL
.
KCOT3500  KEYIN     *PECOL:24,*EL,*V2LON,ANS;
.
          REP       "nNfFeE",ANS
          MATCH     "N",ANS
          GOTO      KCOT4000 IF EQUAL       * Next screen
.
          IF        FORM2>1
            MATCH     "F",ANS
            GOTO      KCOT1500 IF EQUAL     * 1st screen
          ENDIF
.
          MATCH     "E",ANS
          GOTO      KCOT0500 IF EQUAL       * Exit screen
.
          BEEP
          GOTO      KCOT3500
.
KCOT4000  DISPLAY   *P1:5,*EF;
          ADD       "1",FORM2
          MOVE      "1",ECOL
          MOVE      "5",EVERT
          GOTO      KCOT2500
.
KCOT4500  MOVE      "42",ECOL
          MOVE      "5",EVERT
          GOTO      KCOT2500
.
KCOT8000  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          DISPLAY   *P23:14,*EL,*V2LON,SELCODTM,*HOFF,SP2,MRTHDESC;
          GOTO      KCOT9000
.
KCOT8500  PERFORM   CQUEST,PUTSCR00         * Restore the previous screen
          GOTO      KCOT9500
.
KCOT9000  MOVE      ZERO,EXIT
          GOTO      KCOT9999
.
KCOT9500  MOVE      ONE,EXIT
KCOT9999  RETURN
+
.******************************************************************************
.*                                 KYNQ0000               Called by: AUTOC000 *
.*                           Keyin Yes/No Question                            *
.******************************************************************************
KYNQ0000  KEYIN     *PCCOL:CVERT,*DV,SP3:
                    *PCCOL:CVERT,*V2LON,KEY1:
                    *PCCOL:CVERT,*DV,KEY1;
.
          REP       "yYnN",KEY1
          MOVE      KEY1,ANS
.
          MOVE      ZERO,FORM1
          REP       "Y1N2",KEY1
          MOVE      KEY1,FORM1
          BRANCH    FORM1,KYNQ1000,KYNQ1000
.
          BEEP
          GOTO      KYNQ0000
.
KYNQ1000  LOAD      KEY3,FORM1,DYES,DNO
          DISPLAY   *PCCOL:CVERT,*V2LON,KEY3;
.
KYNQ9000  MOVE      ZERO,EXIT
KYNQ9999  RETURN
+
.******************************************************************************
.*                                  KDDR0000              Called by: AUTOC000 *
.*                       Keyin The Discharge Date Range                       *
.******************************************************************************
KDDR0000  MOVE      "23",CCOL
          MOVE      "22",CVERT
          DISPLAY   *P1:CVERT,*EF,"From Discharge Date : ";
          ADD       ONE,CVERT
          DISPLAY   *P1:CVERT,"To   Discharge Date : ";
.
          MOVE      ONE,CCANLDTE            * Blank cancel default
          MOVE      ZERO,CDEFDTE            * 3 'enters' to accept date
          MOVE      ZERO,CHIGHLT            * Use highlight
.
. ----- Enter from date -----
.
KDDR1000  SUB       ONE,CVERT
KDDR2000  MATCH     SP8,SELFRDAT
          IF        @EQUAL | @EOS
            MOVE      CCC,CCENT
            UNPACK    SP6,CYEAR,CMON,CDAY
          ELSE
            UNPACK    SELFRDAT,CDAY,CMON,CCENT,CYEAR
          ENDIF
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,KDDR9500
          BRANCH    CQUEST,KDDR2000
.
          PACK      STRDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRDAT
.
          MATCH     STRDAT,CURDTE8
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"From date must not be after the current ":
                      "date.  ";
            CALL      HITENTER 
            GOTO      KDDR2000
          ENDIF
.
. ----- Enter to date -----
.
          ADD       ONE,CVERT
KDDR3000  MATCH     SP8,SELTODAT
          IF        @EQUAL | @EOS
            UNPACK    STRDAT,CCENT,CYEAR,CMON,CDAY
          ELSE
            UNPACK    SELTODAT,CDAY,CMON,CCENT,CYEAR
          ENDIF
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,KDDR1000
          BRANCH    CQUEST,KDDR3000
.
          PACK      ENDDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDAT
.
          MATCH     ENDDAT,CURDTE8
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"To date must not be after the current ":
                      "date.  ";
            CALL      HITENTER 
            GOTO      KDDR3000
          ENDIF
.
          MATCH     STRDAT,ENDDAT
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"To date must be after the from date.  ";
            CALL      HITENTER 
            GOTO      KDDR3000
          ENDIF
.
KDDR9000  MOVE      ZERO,EXIT
          GOTO      KDDR9999
.
KDDR9500  MOVE      ONE,EXIT
KDDR9999  RETURN
.------------------------------------------------------------
. Note following labels included for PAT41GRP(As it is a web include) 
. needs labels to compile IBAMRT53 cleanly 
.------------------------------------------------------------
CLOSHTML  
CLOSHT99  RETURN
OPENHTML  
OPENHT99  RETURN
WEBERR00
WEBERR99  RETURN
.
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.
.------------------------------------------------------------
.
          INC       PATNAMCD          
          INC       STD001IO
          INC       CLPATICU
          INC       CLPATDSC
          INC       CLPATMIS
          INC       CLPATCHC
          INC       CLVISXDC
          INC       DGCLICAC
          INC       NAMSTRCD
          INC       PATCODKY
          INC       PATWRDKY
          INC       VALDIOPS
          INC       WEBGROUP                 * (was PAT41GRP)
          INC       NHOSPDAY
          INC       OPRECOVT
          INC       PMIGTNID
          INC       RTIODAYS
          INC       CALCDAYS
          INC       PATHSPKY
          INC       PATM10T9                * Map ICD10 to ICD9 codes
          INC       PATWIS11                * WIES11                   *I-90235
          INC       PATWIS12                * WIES12                   *I-51504
          INC       PATWIS13                * WIES13
          INC       PATWIS14                * WIES14
          INC       PATWIS15                * WIES15
          INC       PATWIS16                * WIES16
          INC       PATWIS17                * WIES17
          INC       PATWIS18                * WIES18
          INC       PATWIS19                * WIES19
          INC       PATWIS20                * WIES20
          INC       PATWIS21                * WIES21
          INC       WIESCALC                * WIES
          INC       RHIHDAYS                * Get HIH LOS              *I-90235
          INC       PATGILOS
          INC       PATDEFCL                * routine DCLM0000
          INC       VALCMXFN
          INC       VALCONTR
          INC       GETCNEFF
          INC       PATGNFEE
          INC       GETEFDRG           * Get Effective DRG Version
          INC       GETCHSCR
.
          INC       CALCAGE
          INC       GETDRG
          INC       GETDRGZ                                           *I-137125
.
          INC       PATW12IO/INC            * WIES12                   *I-51504
          INC       PTW12BIO/INC            * WIES12B
          INC       PATW13IO/INC            * WIES13
          INC       PATW14IO/INC            * WIES14
          INC       PATW15IO/INC            * WIES15
          INC       PATW16IO/INC            * WIES16
          INC       PATW17IO/INC            * WIES17
          INC       PATW18IO/INC            * WIES18
          INC       PATW19IO/INC            * WIES19
          INC       PATW20IO/INC            * WIES20
          INC       PATW21IO/INC            * WIES21
          INC       PATW11IO/INC            * WIES11                   *I-90235
          INC       PATWIEIO/INC            * WIES
          INC       PATRDCIO/INC
          INC       PATCDEIO/INC
          INC       PATASFIO/INC
          INC       PATCMPIO/INC   * Complex mapping file
          INC       PATECMIO/INC
          INC       PATPGRIO/INC
          INC       PATHLFIO/INC
          INC       PATBFEIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATHSPIO/INC                                      *I-137125
          INC       PATCMXIO/INC
          INC       PATNIDIO/INC
          INC       MEHDLSIO/INC
          INC       MEHHONIO/INC
          INC       MRTEPSIO/INC
          INC       MRTEXTIO/INC
          INC       MRTMASIO/INC
          INC       MRTREDIO/INC
          INC       MRTREXIO/INC
          INC       MRTTDTIO/INC
          INC       MRTTHDIO/INC
          INC       NHIMASIO/INC
          INC       OPRARDIO/INC
          INC       OPRCLIIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       OPRSRGIO/INC
          INC       OPRTSMIO/INC
          INC       PATCANIO/INC
          INC       PATCHCIO/INC
          INC       PATCODIO/INC
          INC       PATCFAIO/INC
          INC       PMSCIDIO/INC
          INC       PATDGWIO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATTRNIO/INC
          INC       PATMMBIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSVX1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSVMTIO/INC
          INC       VISXDCIO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       WEBSECIO/INC
          INC       SEXDSCIO
          INC       PATADTYP
.
