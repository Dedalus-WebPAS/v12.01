. *****************************************************************************
. *              P R O G R A M  S U M M A R Y                                 *
. *              -------------  -------------                                 *
. *                                                                           *
. *     PROGRAM NAME:     IBAHOS56                                            *
. *                                                                           *
. *     FUNCTION:         U/R ALTERATIONS REPORT                              *
. *                                                                           *
. *     DATE WRITTEN:     27/07/88                                            *
. *                                                                           *
. *     AUTHOR:           GRAEME WILLIAMS (I.B.A)                             *
. *                                                                           *
. *     MODIFICATIONS:                                                        *
.*        V10.10.01 06/04/2017  Ania P         CAR 261630                     *
.*                  Removed use of PORT                                       *
.*        V10.03.01 11/09/2013  Peter Vela     CAR 288107                     *
.*                  Commented out IBAPRINT functionality                      *
.*        V10.02.01 04/04/2011  Jill Parkinson CAR 239574                     *
.*                  Removed open of ibaprntf                                  *
.*        V9.09.01  14/03/2008  Ebon Clements CAR 161386                      *
.*                  Added SCAN for file name at OAPTAUU1 and a match for      *
.*                  IBARSH at AUDCLR. Ignore audit file status as it's not    *
.*                  used in V9 web. Fixed URCHANGE search dpath filename      *
.*        V9.08.01  11/10/2006  Jill Habasque CAR 121310                      *
.*                  Added checks for PTCNDAUR                                 *
.*        V9.04.01  01/04/2005  Mike Laming  CAR 59734                        *
.*                  Fix I*M in Option 3 - add SCAN for file name at OAPTAUZ1  *
.*       V9.02.01  29.11.2001  B.G.Ackland                                    *
.*                 Remove pi's from Program                                   *
.*        V5.08.03  10.10.2000 Sandra Barcham                                 *
.*                  Recompiled for WEB Report Scheduler                       *
. *       V5.08.02  04/09/2000  Tonii                                         *
. *                 Mods to accept Unknown and Indeterminate as valid patient *
. *                 sex description                                           *
. *       V5.08.01  29/08/2000  Caleb Sharman                                 *
. *                 Changed Health Fund variables to be 8 chars               *
. *        V5.07.B02 28/01/1999  Nicole Harrington                            *
. *                  507 rebounds                                             *
. *        V5.07.B01 13/11/1998  Davin                                        *
. *                  Mods for 507                                             *
. *****************************************************************************
. *                       V5.01 11.05.89 S.Barcham                            *
. *                       Fixed to free audit status                          *
. *                       SRF100516                                           *
. *                       V5.02 05/06/89 K.Peak                               *
. *                       Fixed read & write of temp file                     *
. *                       SRF  100900                                         *
. *                       V5.03 06/06/89 J.Tan                                *
. *                             Mods Locking master file                      *
. *                             (PATIOMAS)     SRF 100809                     *
. *                    V5.01.01 05/07/89 K.Peak                               *
. *                             Changed Adm & U/R to 8 chrs                   *
. *                    V5.01.02 10/10/89 K.Peak                               *
. *                             Added search_dpath for                        *
. *                             alpha ports  SRF 102601                       *
. *                             Removed Medicare SRF 102645                   *
. *                    V5.01.03 12/10/89 K.Peak                               *
. *                             Added marital & resident                      *
. *                             status       SRF 102683                       *
. *                    V5.01.04 23/10/89  Steve O'Gorman                      *
. *                             Replaced Medicare Number                      *
. *                             with Registering Hospital                     *
. *                             SRF 102646                                    *
. *                    V5.01.05 26/10/89  Steve O'Gorman                      *
. *                             Fixed I*M by Resetting                        *
. *                             FILENAM after extracting                      *
. *                             Port Number  SRF 102801                       *
. *                             Fixed Screen Display to                       *
. *                             Stop Scrolling                                *
. *                             Fixed Question on Clearing                    *
. *                             Audit Files                                   *
. *                    V5.01.06 08/11/89  Karin Peak                          *
. *                             Fixed the key length for                      *
. *                             the addition sequence                         *
. *                             SRF 102888                                    *
. *                    V5.01.07 07/12/89 E.Phan                               *
. *                             Altered IBAPRNFD.                             *
. *                    V5.01.08 12/01/90 K.Peak                               *
. *                             Fixed the printing of this                    *
. *                             report SRF 103165                             *
. *                   V5.01.121 27/11/90 Glen Hobby                           *
. *                            Recompiled for changes to                      *
. *                            PATMX1FD                                       *
. *                   V5.01.122 19/12/90 D.Di.Paola                           *
. *                            Recompiled for PATURAFD                        *
. *                                        SRF 107397                         *
. *                   V5.01.123 07/01/92 Graeme Williams                      *
. *                             Read in case notes indicatr                   *
. *                             Fixed last change report.                     *
. *                             SRF 112442                                    *
. *                                                                           *
. *        V5.01.124 03.03.93 Neeriem "I Hate Support" Dye                    *
. *                  Modify to print full address                             *
. *        V5.01.125 07/04/93  Steve O'Gorman                                 *
. *                  Fixed the PREP of the PATAU1A1 file if                   *
. *                  using the new master file                                *
. *        V5.01.126 16/04/93  ROD                                            *
. *                  Fixed I*C on patau1af                                    *
. *        V5.01.127 15/02/94  I.Rutt                                         *
. *                  Standardised program                                     *
. *        V5.01.128 21/03/94  Rob Leonard  SRF 600308                        *
. *                  Fixed Addition Date reporting last                       *
. *                  date of change                                           *
. *       V5.02.01  13/02/1995  Greg Horvat      SRF 134920 134922 134932     *
. *                 Recompiled for IBAPRINT                                   *
. *                                                                           *
. *****************************************************************************
.
          INC       STD001FD
.
          INC       PATCODFD/INC 
          INC       PATCONFD/INC 
          INC       PATHOSFD/INC 
          INC       PATMA1FD/INC 
          INC       PATURAFD/INC 
          INC       PATAU1FD/INC
          INC       PATAZ1FD/INC
          INC       IBASEQFD/INC 
          INC       TFILEVAR/INC
          INC       WEBERRFD/INC
.
.         Other Variables
.
AUDHDR    INIT      "patau"
AUDHDZ    INIT      "pataz"
.
CMDLINE   DIM       50
CPPORT    FORM      2
CODEM     INIT      "M "
CODET     INIT      "T "
.
DIM6      DIM       6
DIM9      DIM       9
DIM10     DIM       10
DIM11     DIM       11
DIM40     DIM       40
DSEX      DIM       6
DSYSAAE   INIT      "A & E    "
DSYSDAY   INIT      "DAY CENTR"
DSYSINP   INIT      "INPATIENT"
DSYSOUT   INIT      "OUTPATNT "
DSYSOTH   INIT      "OTHER FIN"
DSYSTEM   DIM       9
.
FNAMEI    DIM       8
FNAMEP    DIM       8
FROMDATE  DIM       8
FILES     FILE      ASCII, FIXED=256
FILENAM   DIM       40
FILETYP   DIM       6
.
INPFILE   FILE      ASCII, FIXED=256
.
MAXSECT   FORM      5
MSTAT     DIM       7        * marital status description
.
NEWUR     DIM       8
.
OPT1      INIT      "- Additions "
OPT2      INIT      "- Last Changes "
OPT3      INIT      "- Deletions "
OPT4      INIT      "- U/R No Changes "
OPTDESC   DIM       16
ORIGSYS   FORM      1
.
PFDATE    DIM       10
PTDATE    DIM       10
.
RESID     DIM       10          * resident status description
.
SEC1      FORM      "00001"
SEQ1      INIT      "(Alphabetic)"
SEQ2      INIT      "(U/R Number)"
SEQDESC   DIM       12
SEQOPT    FORM      1
SAVCHDTE  DIM       8
.
TODATE    DIM       8
TOTPATS   FORM      8
TRANTIM   DIM       8
.
UNIQUE    FORM      8
.
VERT      FORM      2
.
.
PSTROL    FILE      ASCII, FIXED=256
SORT1     INIT      "u9-28,1-8,29-36"
SORT2     INIT      "u1-8,9-28,29-36"
.
SORTSTR   DIM       20
WORK      IFILE     SQL, FIXED=297, KEY=SORTSTR
.
. ----- Tempfile consists of following vars -----
.
. Name      Type      Length     Physical     Start   
. ----      ----      ------     --------     -----  
.PURNO      DIM        8          8             1
.PSNAME     DIM       20         20             9
DUNIQUE     DIM        8          8            29
.PGNAME     DIM       25         25            37
.PADD1      DIM       25         25            62
.PADD2      DIM       25         25            87
.PSUBRB     DIM       15         15           112
.PPOST      DIM        4          4           127
.PBDATE     DIM        8          8           131
.DSEX       DIM        6          6           139
.PMEDI      DIM       10         10           145
.PCHGDTE    DIM        8          8           155
.PCASE      FORM       1          2           163
.PTITL      DIM        4          4           165
.PTELEP     DIM       12         12           169
.ORIGSYS    FORM       1          2           181
.NEWUR      DIM        8          8           183
.TRANTIM    DIM        8          8           191
. ----- EOR 297 -----
.
.
PRGNAM    INIT      "U/R Alterations Report"
PRGID     INIT      "IBAHOS56"
VERSION   INIT      "V12.01.00"
.
.        Open Files
.
          CALL      DISPHEAD
.
          DISPLAY   *P56:24,"Opening paturadf";
          OPEN      PATURAD1,"paturadf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"pathospf";
          OPEN      PATHOSP2,"pathospf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"ibacodef";
          OPEN      IBACODE1,"ibacodef"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,TEN9;*75,CCNOTES
          READ      CONTROLF,FIFTY9;*37,CTYPCHG
          CLOSE     CONTROLF
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEI
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEP
.
.         Start of Program
.
.         CALL      SELPRINT
.
START     HLINE     *G37,2,51,80
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = U/R Additions Report":
                    *P1:6,*V2LON,TWO,*HOFF," = U/R Last Change Report":
                    *P1:7,*V2LON,THREE,*HOFF," = U/R Deletions Audit":
                    *P1:8,*V2LON,FOUR,*HOFF," = U/R Number Changes Audit"
.
REKEY     KEYIN     *P1:10,"Option : ",*EF,*V2LON,OPTION
.
          COMPARE   ZERO,OPTION
          GOTO      ENDIT IF EQUAL
.
REPEAT    BRANCH    OPTION OF LOADOPT,LOADOPT,LOADOPT,LOADOPT
.
          BEEP 
          GOTO      REKEY
.
LOADOPT   LOAD      OPTDESC USING OPTION OF OPT1,OPT2,OPT3,OPT4
          DISPLAY   *P51:2,*V2LON,OPTDESC
.
.         Select the order the report is to be produced in
.
SELORD    HLINE     *G37,2,71,80
          DISPLAY   *P1:12,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:13,*V2LON,ONE,*HOFF," = Alphabetic Sequence":
                    *P1:14,*V2LON,TWO,*HOFF," = U/R Sequence"
.
SELKEY    KEYIN     *P1:16,"Option : ",*EF,*V2LON,SEQOPT
.
          COMPARE   ZERO,SEQOPT
          GOTO      START IF EQUAL
.
          PACK      SORTSTR,SP30
          BRANCH    SEQOPT TO SORT10,SORT20
.
SORT10    MOVE      SORT1,SORTSTR                  * surname sequence
          GOTO      SORT30
.
SORT20    MOVE      SORT2,SORTSTR                  * UR sequence
.
SORT30    BRANCH    SEQOPT OF LOADSEQ,LOADSEQ
.
          BEEP
          GOTO      SELKEY
.
LOADSEQ   LOAD      SEQDESC USING SEQOPT OF SEQ1,SEQ2
          DISPLAY   *P69:2,*V2LON,SP1,SEQDESC
.
.         For Options 1 & 2 only, ask for a date range
.
          BRANCH    OPTION OF DATERNG,DATERNG,CHECKOK,CHECKOK
.
.         Ask for the date range of the report
.
DATERNG   DISPLAY   *P1:18,*EF,"From Date :":
                    *P1:20,"  To Date :"
.
.         Key in from date - no default date
.
          MOVE      TEN8,CVERT
          MOVE      TEN3,CCOL
          MOVE      TEN8,EVERT
          MOVE      THIRTY2,ECOL
.
          UNPACK    SP8,CCENT,CYEAR,CMON,CDAY
.
          MOVE      ZERO,CHIGHLT
          CALL      KEYDATE
          BRANCH    OVRCD OF SELORD
.
          PACK      FROMDATE,ICENT,IYEAR,IMON,IDAY
          REP       " 0",FROMDATE
          PACK      PFDATE WITH IDAY,SLASH,IMON,SLASH,ICENT,IYEAR
          REP       " 0",PFDATE
.
.         Key in to date - current date as default date
.
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
.
          MOVE      TWENTY,CVERT
.
          CALL      KEYDATE
.
          PACK      TODATE,ICENT,IYEAR,IMON,IDAY
          REP       " 0",TODATE
          PACK      PTDATE WITH IDAY,SLASH,IMON,SLASH,ICENT,IYEAR
          REP       " 0",PTDATE
.
.         Check for a valid range of dates
.
          MATCH     FROMDATE,TODATE
          GOTO      CHECKOK IF NOT LESS
.
          DISPLAY   *P1:24,*EL,*B:
                    "Invalid Date Range. ";
          CALL      HITENTER
          GOTO      DATERNG
.
.         Check if these parameters are correct
.
CHECKOK   MOVE      TWENTY4,CVERT
          MOVE      TWENTY6,CCOL
          MOVE      ZERO,FORM1
.
          CALL      POSTQST
.
          MOVE      ANS,FORM1
          BRANCH    FORM1 OF CONTREP,START,ENDIT
.
          BEEP
          GOTO      CHECKOK
.
.         Create temporary file in desired order
.
CONTREP   CALL      CREAIDX
.
          MOVE      "60",CLNO
          MOVE      ZERO,UNIQUE
          CLOCK     TIME,CTIMEIS
          MOVE      ZERO,CPAGENO
.
.         Go to the appropriate report generation
.
          BRANCH    OPTION OF ADDITION,LASTCHG,DELETION,URCHANGE
.
.         Additions Report
.
ADDITION  DISPLAY   *P1:24,*EL,*P1:24,"U/R Number :";
.
.         Loop over all the "A" records in the change audit file
.
          PACK      KEY17 WITH ANSA,FROMDATE,SP10
          CALL      RDSURAD1
ADDLP     CALL      RDKURAD1
          BRANCH    OVRCD OF GENADDRP
.
          CMATCH    ANSA,URRTYPE
          GOTO      GENADDRP IF NOT EQUAL
.
          MATCH     URDATE,TODATE
          GOTO      GENADDRP IF LESS
.
          DISPLAY   *P33:24,*V2LON,URURNO;
.
.         Read the master file details and add this record to the temporary file
.
          MOVE      URURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF ADDLP
.
          MOVE      URSYST,ORIGSYS
          MOVE      URDATE,PCHGDTE
          CALL      ADDUR
          GOTO      ADDLP
.
.         We have processed all records desired - now generate report
.
GENADDRP  DISPLAY   *P1:24,*EL,*P20:24,"Surname :";
          COMPARE   ZERO,UNIQUE
          GOTO      NODATA IF EQUAL
.
          MOVE      UNIQUE,TOTPATS
.
.         Loop over temporary file and print the relevant details
.
          READ      WORK,SP30;;
NEXTA     CALL      RDTMP
          BRANCH    OVRCD OF ENDP
.
          DISPLAY   *P30:24,*V2LON,PSNAME,PURNO;
.
          CALL      PRINTA
          GOTO      NEXTA
.
.         Last Change Report
.
LASTCHG   DISPLAY   *P1:24,*EL,*P1:24,"U/R Number :";
.
.         Loop over all the "C" records in the change audit file
.
          PACK      KEY17 WITH ANSC,FROMDATE,SP10
          CALL      RDSURAD1
CHGLP     CALL      RDKURAD1
          BRANCH    OVRCD OF GENCHGRP
.
          CMATCH    ANSC,URRTYPE
          GOTO      GENCHGRP IF NOT EQUAL
.
          MATCH     URDATE,TODATE
          GOTO      GENCHGRP IF LESS
.
          DISPLAY   *P33:24,*V2LON,URURNO;
.
.         Read the master file details and add this record to the temporary file
.
          MOVE      URURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF CHGLP
.
          MOVE      URSYST,ORIGSYS
          CALL      ADDUR
          GOTO      CHGLP
.
.         We have processed all records desired - now generate report
.
GENCHGRP  DISPLAY   *P1:24,*EL,*P20:24,"Surname :";
          COMPARE   ZERO,UNIQUE
          GOTO      NODATA IF EQUAL
.
          MOVE      UNIQUE,TOTPATS
.
.         Loop over temporary file and print the relevant details
.
          READ      WORK,SP30;;
NEXTC     CALL      RDTMP
          BRANCH    OVRCD OF ENDP
.
          DISPLAY   *P30:24,*V2LON,PSNAME,PURNO;
.
          CALL      PRINTC
          GOTO      NEXTC
.
.         Deletions Report
.
DELETION  LOAD      ANS USING OPTION OF SP1,SP1,ANSU
          MOVE      "1",ANS
          PACK      FILETYP WITH AUDHDR,ANS
.
          MOVE      ZERO,CPPORT
          CLEAR     CMDLINE
          APPEND    "search_dpath '",CMDLINE
          APPEND    FILETYP,CMDLINE
          APPEND    "*.txt' > ",CMDLINE
          APPEND    FNAMEP,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,*P1:24,"U/R Number :",*P26:24,"Port :";
          TRAP      NOUAUD IF IO
          OPEN      FILES,FNAMEP
          TRAPCLR   IO
.
DPORTLP   CALL      NEXTFILE
          BRANCH    OVRCD OF GENDELRP
.
          CALL      OAPTAUZ1
          CALL      OAPTAUU1
.
.         Check if file in use and get the number of records in this audit file
.
......    CALL      OPPTAUU1
          MOVE      "PU1",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
          CALL      RDSAUDU
....      BRANCH    AUSTAT OF DELABSY
.
....      MOVE      TWO,AUSTAT
....      CALL      WRSAUDUX
          CALL      RELSLK00        * Release System Lock Audits
.
.         Loop through this audit file and store the data into the temp. file
.
          MOVE      SECTOR,MAXSECT
.
          MOVE      ONE,SECTOR
DELLP     COMPARE   MAXSECT,SECTOR
          GOTO      ENDDELA IF NOT LESS
.
          CALL      RDAUDU
          ADD       ONE,SECTOR
.
          DISPLAY   *P14:24,*V2LON,AUURNO;
.
          CALL      ADDELUR
          GOTO      DELLP
.
.         End of an audit file
.
ENDDELA   CLOSE     PATAU1A1
          GOTO      DPORTLP
.
NOUAUD    NORETURN
          GOTO      GENDELRP
.
.         Audit file unavailable
.
DELABSY   CALL      RELSLK00        * Release System Lock Audits
          DISPLAY   *P1:24,*EL,*B,"Audit file for Port ",DIM2," unavailable. ";
          CALL      HITENTER 
          GOTO      DPORTLP
.
.---- open audit file ----
.
OAPTAUZ1  
          PACK      CFNAME,SP20,SP20,SP20,SP20,SP20
.....     PACK      CFNAME,FILENAM                                      D-59734
          SCAN      "pataz",FILENAM                                    *I-59734
          IF        @EQUAL
            MOVE      FILENAM,CFNAME                                   *I-59734
            RESET     FILENAM                                          *I-59734
          ENDIF                                                        *I-59734
.
          TRAP      OAPTAZ30 IF IO
          OPEN      PATAZ1A1,CFNAME
          TRAPCLR   IO
          GOTO      OAPTAZ99
.
OAPTAZ30  NORETURN
          PREP      PATAZ1A1,CFNAME
          MOVE      ONE,AZSTAT
          CALL      WRSAUDZ
OAPTAZ99  RETURN
.
. open patauu audit file
.
OAPTAUU1  
          PACK      CFNAME,SP20,SP20,SP20,SP20,SP20
....      PACK      CFNAME,FILENAM
.
          SCAN      "patau",FILENAM
          IF        @EQUAL
            MOVE      FILENAM,CFNAME
            RESET     FILENAM
          ENDIF
.
          TRAP      OAPTAU30 IF IO
          OPEN      PATAU1A1,CFNAME
          TRAPCLR   IO
          GOTO      OAPTAU99
.
OAPTAU30  NORETURN
          PREP      PATAU1A1,CFNAME
          MOVE      ONE,AUSTAT
          CALL      WRSAUDU
OAPTAU99  RETURN
.
.
.         We have processed all records desired - now generate report
.
GENDELRP  DISPLAY   *P1:24,*EL,*P20:24,"Surname :";
          COMPARE   ZERO,UNIQUE
          GOTO      NODATA IF EQUAL
.
          MOVE      UNIQUE,TOTPATS
.
.         Loop over temporary file and print the relevant details
.
          READ      WORK,SP30;;
NEXTD     CALL      RDTMP
          BRANCH    OVRCD OF ENDP
.
          DISPLAY   *P30:24,*V2LON,PSNAME,PURNO;
.
          CALL      PRINTD
          GOTO      NEXTD
.
.         U/R Number Change Report
.
URCHANGE  LOAD      ANS USING OPTION OF SP1,SP1,SP1,ANSZ
          MOVE      "1",ANS
          PACK      FILETYP WITH AUDHDZ,ANS
.
          MOVE      ZERO,CPPORT
          CLEAR     CMDLINE
          APPEND    "search_dpath '",CMDLINE
          APPEND    FILETYP,CMDLINE
          APPEND    "*.txt' > ",CMDLINE
          APPEND    FNAMEP,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          DISPLAY   *P1:24,*EL,*P1:24,"U/R Number :",*P26:24,"Port :";
          TRAP      NOZAUD IF IO
          OPEN      FILES,FNAMEP
          TRAPCLR   IO
.
UPORTLP   CALL      NEXTFILE
          BRANCH    OVRCD OF GENURCRP
.
          MOVE      FILENAM,DIM40
          CALL      OAPTAUZ1
.
.         Check if file in use and get the number of records in this audit file
.
          MOVE      "PZ1",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
          CALL      RDSAUDZ
....      BRANCH    AZSTAT OF URCABSY
.
....      MOVE      TWO,AZSTAT
....      CALL      WRSAUDZX
          CALL      RELSLK00        * Release System Lock Audits
.
.         Loop through this audit file and store the data into the temp. file
.
          MOVE      SECTOR,MAXSECT
.
          MOVE      ONE,SECTOR
URCLP     COMPARE   MAXSECT,SECTOR
          GOTO      ENDURCA IF NOT LESS
.
          CALL      RDAUDZ
          ADD       ONE,SECTOR
.
          DISPLAY   *P14:24,*V2LON,AZURNO;
.
          CALL      ADDURC
          GOTO      URCLP
.
NOZAUD    NORETURN
          GOTO      GENURCRP
.
.         End of an audit file
.
ENDURCA   MOVE      ZERO TO AZSTAT
          CALL      WRSAUDZX
          CLOSE     PATAZ1A1
          GOTO      UPORTLP
.
.         Audit file unavailable
.
URCABSY   CALL      RELSLK00        * Release System Lock Audits
          DISPLAY   *P1:24,*EL,*B,"Audit file for Port ",DIM2," unavailable. ";
          CALL      HITENTER
          GOTO      UPORTLP
.
.         We have processed all records desired - now generate report
.
GENURCRP  DISPLAY   *P1:24,*EL,*P20:24,"Surname :";
          COMPARE   ZERO,UNIQUE
          GOTO      NODATA IF EQUAL
.
          MOVE      UNIQUE,TOTPATS
.
.         Loop over temporary file and print the relevant details
.
          READ      WORK,SP30;;
NEXTU     CALL      RDTMP
          BRANCH    OVRCD OF ENDP
.
          DISPLAY   *P30:24,*V2LON,PSNAME,PURNO;
.
          CALL      PRINTU
          GOTO      NEXTU
.
.         End of the selected report
.
ENDP      COMPARE   ZERO,CPAGENO
          GOTO      NODATA IF EQUAL
.
          CALL      PAGEND
.
          PRINT     *N,*20,"Total Patients ",TOTPATS,*N:
                    *N,"*** END OF REPORT ***"
.
.          DISPLAY   *P1:24,*EL,*P40:24,*V2LON:
.                    "** Report Generation Completed **",*W;
.
.         CALL      CLSPRINT    * Print the report straight away
.         CALL      OPNPRINT    * Just in case they want to print another rep.
.
          CALL      KILLIDX     * Delete Temporary file
.
.         For options 3 & 4, ask if the audit files are to be cleared
.
          BRANCH    OPTION OF START,START,AUDCLR,AUDCLR
.
AUDCLR    DISPLAY   *P1:24,*EL,"Do you want these Audit files cleared (":
                    *V2LON,ANSY,*HOFF,SLASH,*V2LON,ANSN,*HOFF,") ? ";
.
          MOVE      "47",CCOL
          MOVE      TWENTY4,CVERT
          MOVE      ZERO,FORM1
.
          MATCH     "IBARSH",PGM
          IF        @EQUAL
            MOVE      "N",ANS
          ELSE
            KEYIN     *P47:24,*EL,*V2LON,ANS;
          ENDIF
.
          REP       UPPLOW,ANS
          REP       "Y1N2",ANS
.
          MOVE      ANS,FORM1
.
          BRANCH    FORM1 OF PROCAUD,PROCAUD
.
          BEEP
          GOTO      AUDCLR
.
.         Loop over the audit files and either clear them, or release them
.
PROCAUD   DISPLAY   *P1:24,*EL,*P27:24,"File : ";
          CLOSE     FILES
          TRAP      NOUZCLR IF IO
          OPEN      FILES,FNAMEP
          TRAPCLR   IO
.
ENDLOOP   CALL      NEXTFILE
          BRANCH    OVRCD OF ENDDELT
.
.         We are using PATAU1A1, but it doesn't really matter what we use
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      OPPTAUU1
          TRAPCLR   IO
          BRANCH    OVRCD,ENDLOOP
.
.         Check that we have this audit file locked
.
          CALL      RDSAUDU
          COMPARE   TWO,AUSTAT
          GOTO      ENDLOOP IF NOT EQUAL
.
.         If we are clearing the files, then delete this file, otherwise
.         just reset the status to zero
.
          BRANCH    FORM1 OF CLEARAUD,RESETAUD
.
CLEARAUD  CLOSE     PATAU1A1
          PREP      PATAU1A1,FILENAM
          CLOSE     PATAU1A1
.
          GOTO      ENDLOOP
.
RESETAUD  MOVE      ZERO,AUSTAT
          CALL      WRSAUDUX
.
          GOTO      ENDLOOP
.
NOUZCLR   NORETURN
.
ENDDELT   CLOSE     FILES
          PREP      FILES,FNAMEP
          CLOSE     FILES
          CALL      KILLIDX
          GOTO      START
.
.         No data printed
.
NODATA    DISPLAY   *P1:24,*EL,*B:
                    "No Data to be Printed. ";
          CALL      HITENTER 
.
.         No data in the audit files - we might as well clear them
.
          MOVE      ONE,FORM1
          GOTO      PROCAUD
.
.         Add a record to the temporary file
.
ADDUR     REP       "M1F2I3U4",PSEX
          MOVE      PSEX,FORM2
          MOVE      SP6,DSEX
          LOAD      DSEX USING FORM2 OF DMALE,DFEMALE,DINDETER,DUNK
.
          BRANCH    SEQOPT OF ADDUR1,ADDUR2
.
ADDUR1    MOVE      UNIQUE,DUNIQUE
          PACK      KEY36 WITH PSNAME,PURNO,DUNIQUE
          CALL      WRTMP
          RETURN
.
ADDUR2    MOVE      UNIQUE,DUNIQUE
          PACK      KEY36 WITH PURNO,PSNAME,DUNIQUE
          CALL      WRTMP
          RETURN
.
.         Add a U/R Number change record to the temporary file
.
ADDURC    MOVE      AZURNO,PURNO
          MOVE      AZURNN,NEWUR
          MOVE      AZTITL,PTITL
          MOVE      AZSNAM,PSNAME
          MOVE      AZGNAM,PGNAME
          MOVE      AZADD1,PADD1
          MOVE      AZADD2,PADD2
          MOVE      AZSUBR,PSUBRB
          MOVE      AZPOST,PPOST
          MOVE      AZSEX,PSEX
          MOVE      AZMEDI,PMEDI
          MOVE      AZBDAT,PBDATE
          MOVE      AZTELP,PTELEP
          MOVE      AZDATE,PCHGDTE
          MOVE      AZTIME,TRANTIM
.
          CALL      ADDUR
          RETURN
.
.         Add a deleted U/R record to the temporary file
.
ADDELUR   MOVE      AUURNO,PURNO
          MOVE      AUTITL,PTITL
          MOVE      AUSNAM,PSNAME
          MOVE      AUGNAM,PGNAME
          MOVE      AUADD1,PADD1
          MOVE      AUADD2,PADD2
          MOVE      AUSUBR,PSUBRB
          MOVE      AUPOST,PPOST
          MOVE      AUMEDI,PMEDI
          MOVE      AUTELP,PTELEP
          MOVE      AUSEX,PSEX
          MOVE      AUBDAT,PBDATE
          MOVE      AUDATE,PCHGDTE
          MOVE      AUTIME,TRANTIM
.
          CALL      ADDUR
          RETURN
.
.         Subroutine to print the details of the Additions Report
.
PRINTA    COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          MOVE      PCHGDTE,SAVCHDTE             * save addition date
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          MOVE      SAVCHDTE,PCHGDTE             * restore addition date
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      C4YEAR,XCENT,XYEAR
          REP       " 0",C4YEAR
.
          UNPACK    PCHGDTE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          MOVE      SP10,DSYSTEM
          LOAD      DSYSTEM USING ORIGSYS OF DSYSAAE,DSYSOUT,DSYSINP:
                                             DSYSOTH,DSYSDAY
.
          CALL      PAGEND
.
          BRANCH    CTYPCHG,PRNT1,PRNT2
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRNT1 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRNT11
          ENDIF
.
PRNT1     PRINT     *1,"!",*3,PURNO,ANS;
.
PRNT11    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,PMEDI:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,DSYSTEM,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST,*98,"!",*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
          GOTO      PRNT3
.
PRNT2     MOVE      SP20,MSTAT
          MATCH     SP3,PMSTAT
          GOTO      PRTNN2 IF EQUAL
.
          PACK      KEY5,CODEM,PMSTAT
          CALL      RDCODE1
          BRANCH    OVRCD,PRTNN2
          MOVE      TDESC,MSTAT
.
PRTNN2    MOVE      SP20,RESID
          MATCH     SP3,PTYPE
          GOTO      PRTNN3 IF EQUAL
.
          PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,PRTNN3
          MOVE      TDESC,RESID
.
          MOVE      SP30,HOSDESC
          MOVE      SP10,DIM10
.
PRTNN3    MOVE      PINITHOS,KEY2
          CALL      RDHOSP2
.
          MOVE      HOSDESC,DIM10
.
          MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTNN4 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTNN5
          ENDIF
.
PRTNN4    PRINT     *1,"!",*3,PURNO,ANS;

PRTNN5    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,RESID:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,DSYSTEM,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*113,MSTAT,*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST,*98,"!":
                    *111,"!",*120,"! ",DIM10:
                    *132,"!"
          ADD       ONE,CLNO
.
PRNT3     ADD       THREE,CLNO
          RETURN
.
.         Subroutine to print the details of the Last Change Report
.
PRINTC    COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      C4YEAR,XCENT,XYEAR
          REP       " 0",C4YEAR
.
          UNPACK    PCHGDTE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          MOVE      SP10,DSYSTEM
          LOAD      DSYSTEM USING ORIGSYS OF DSYSAAE,DSYSOUT,DSYSINP:
                                             DSYSOTH,DSYSDAY
.
          CALL      PAGEND
.
          BRANCH    CTYPCHG,PRTC1,PRTC2
.
PRTC1     OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTC11 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTC12
          ENDIF
.
PRTC11    PRINT     *1,"!",*3,PURNO,ANS;
.
PRTC12    PRINT    *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,PMEDI:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,DSYSTEM,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST,*98,"!",*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
          GOTO      PRTC3
.
PRTC2     MOVE      PURNO,KEY8
          CALL      RDMAST1
.
          MOVE      SP20,MSTAT
          MATCH     SP3,PMSTAT
          GOTO      PRTCC2 IF EQUAL
.
          PACK      KEY5,CODEM,PMSTAT
          CALL      RDCODE1
          BRANCH    OVRCD,PRTCC2
          MOVE      TDESC,MSTAT
.
PRTCC2    MOVE      SP20,RESID
          MATCH     SP3,PTYPE
          GOTO      PRTCC3 IF EQUAL
.
          PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,PRTCC3
          MOVE      TDESC,RESID
.
.         This is here because the read of the master file above will
.         alter the value of ANS (used by the I/O include for case notes).
.
PRTCC3    MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTCC31 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTCC32
          ENDIF
.
PRTCC31   PRINT     *1,"!",*3,PURNO,ANS;
.
PRTCC32   PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,RESID:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,DSYSTEM,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*113,MSTAT,*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST,*98,"!":
                    *111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
.
PRTC3     ADD       THREE,CLNO
          RETURN
.
.         Subroutine to print the details of the U/R Deletion Report
.
PRINTD    COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      C4YEAR,XCENT,XYEAR
          REP       " 0",C4YEAR
.
          UNPACK    PCHGDTE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          CALL      PAGEND
.
          BRANCH    CTYPCHG,PRTD1,PRTD2
.
PRTD1     OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTD11 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTD12
          ENDIF
.
PRTD11    PRINT     *1,"!",*3,PURNO,ANS;
.
PRTD12    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,PMEDI:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST,*98,"!":
                    *100,TRANTIM,*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
          GOTO      PRTD3
.
PRTD2     MOVE      PURNO,KEY8
          CALL      RDMAST1
.
          MOVE      SP20,MSTAT
          MATCH     SP3,PMSTAT
          GOTO      PRTDD2 IF EQUAL
.
          PACK      KEY5,CODEM,PMSTAT
          CALL      RDCODE1
          BRANCH    OVRCD,PRTDD2
          MOVE      TDESC,MSTAT
.
PRTDD2    MOVE      SP20,RESID
          MATCH     SP3,PTYPE
          GOTO      PRTDD3 IF EQUAL
.
          PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,PRTDD3
          MOVE      TDESC,RESID
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTDD3 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTDD4
          ENDIF
.
PRTDD3    PRINT     *1,"!",*3,PURNO,ANS;
.
PRTDD4    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,RESID:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*113,MSTAT,*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST:
                    *98,"!",*100,TRANTIM,*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
.
PRTD3     ADD       THREE,CLNO
          RETURN
.
.         Subroutine to print the details of the U/R Number Change Report
.
PRINTU    COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      C4YEAR,XCENT,XYEAR
          REP       " 0",C4YEAR
.
          UNPACK    PCHGDTE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      SP1,ANS
          LOAD      ANS USING PCASE OF CCNOTES
.
          CALL      PAGEND
.
          BRANCH    CTYPCHG,PRTU1,PRTU2
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTU1 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTU12
          ENDIF
.
PRTU1     PRINT     *1,"!",*3,PURNO,ANS;
.
PRTU12    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,PMEDI:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,NEWUR,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST:
                    *98,"!",*100,TRANTIM,*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
          GOTO      PRTU3
.
PRTU2     MOVE      PURNO,KEY8
          CALL      RDMAST1
.
          MOVE      SP20,MSTAT
          MATCH     SP3,PMSTAT
          GOTO      PRTUU2 IF EQUAL
.
          PACK      KEY5,CODEM,PMSTAT
          CALL      RDCODE1
          BRANCH    OVRCD,PRTUU2
          MOVE      TDESC,MSTAT
.
PRTUU2    MOVE      SP20,RESID
          MATCH     SP3,PTYPE
          GOTO      PRTUU3 IF EQUAL
.
          PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,PRTUU3
          MOVE      TDESC,RESID
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          GOTO      PRTUU3 IF NOT EQUAL
          PACK      KEY20,SP70
          PROC      GETALIDS
          MATCH     SP70,KEY20
          IF        !@EQUAL
            UNPACK    KEY20,DIM11,DIM9
            PRINT     *1,"|",*2,DIM9;
            GOTO      PRTUU4
          ENDIF
.
PRTUU3    PRINT     *1,"!",*3,PURNO,ANS;
.
PRTUU4    PRINT     *13,"!",*15,PSNAME,*45,"!":
                    *47,PADD1,*98,"!",*100,XDAY,SLASH,XMON,SLASH,C4YEAR:
                    *111,"!",*113,DSEX,*120,"!",*121,RESID:
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*15,PTITL,SP1,PGNAME:
                    *45,"!",*47,PADD2,*98,"!":
                    *111,"!",*120,"!",*132,"!":
                    *N:
                    *1,"!",*3,NEWUR,*13,"!",*45,"!",*47,PSUBRB,*98,"!":
                    *100,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR:
                    *111,"!",*113,MSTAT,*120,"!",*132,"!":
                    *N:
                    *1,"!",*13,"!",*15,"Phone : ",PTELEP:
                    *45,"!",*47,PADD4,SP1,PPOST:
                    *98,"!",*100,TRANTIM,*111,"!",*120,"!":
                    *132,"!"
          ADD       ONE,CLNO
.
PRTU3     ADD       THREE,CLNO
          RETURN
.
.         Subroutine to print the heading for the report
.
HEAD   
.          COMPARE   ZERO,CPAGENO
.          CALL      PAGEND IF NOT EQUAL
.
.          ADD       ONE,CPAGENO
.
.          PRINT     *F,PRGID,*40,CNAME,*118,"DATE - ",CDATE:
.                    *N,VERSION,*40,"*** U/R ALTERATIONS ",OPTDESC:
.                    SP1,SEQDESC," ***",*118,"TIME - ",CTIMEIS:
.                    *N,*118,"PAGE - ",*130,CPAGENO
.
          MOVE      ONE,CNOUNDLN
          MOVE      OPTDESC,CPHDROPT
          CALL      HEAD132   
          MOVE      THREE,CLNO
.
.         For options one and two, show the date range of the report
.
          BRANCH    OPTION OF PDTERNG,PDTERNG,HEADDEL,HEADURC
.
.         Print the date range of the report
.
PDTERNG   PRINT     *40,"From ",PFDATE," to ",PTDATE
          ADD       ONE,CLNO
.
          BRANCH    OPTION OF HEADADD,HEADCHG
.
.         Print the Additions Report Heading
.
HEADADD   PRINT     *N;
          CALL      PAGEND
.
          PRINT     *1,"! U/R No",*13,"! Patients Name":
                    *45,"! Patients Address",*72,"! Birth Date";
          BRANCH    CTYPCHG,HADD1,HADD2
.
HADD1     PRINT     *111,"! Sex",*120,"! Medicare No":
                    *132,"!":
                    *N:
                    *1,"! Orig Syst",*13,"!",*45,"!":
                    *98,"! Addit Date",*111,"!",*120,"!":
                    *132,"!"
          GOTO      HADD3
.
HADD2     PRINT     *111,"! Sex",*120,"!Resid. Stat":
                    *132,"!":
                    *N:
                    *1,"! Orig Syst",*13,"!",*45,"!":
                    *98,"! Addit Date":
                    *111,"! M/Stat",*120,"!Reg. Hosp.":
                    *132,"!"
.
HADD3     ADD       THREE,CLNO
          RETURN
.
.         Print the Last Change Report Heading
.
HEADCHG   PRINT     *N;
          CALL      PAGEND
.
          PRINT     *1,"! U/R No",*13,"! Patients Name":
                    *45,"! Patients Address",*98,"! Birth Date";
          BRANCH    CTYPCHG,HCHG1,HCHG2
.
HCHG1     PRINT     *111,"! Sex",*120,"!Medicare No":
                    *132,"!":
                    *N:
                    *1,"! Orig Syst",*13,"!",*45,"!":
                    *98,"! Last Chg",*111,"!",*120,"!":
                    *132,"!"
          GOTO      HCHG3
.
HCHG2     PRINT     *111,"! Sex",*120,"!Resid. Stat":
                    *132,"!":
                    *N:
                    *1,"! Orig Syst",*13,"!",*45,"!":
                    *98,"! Last Chg":
                    *111,"! M/Stat",*120,"!":
                    *132,"!"
.
HCHG3     ADD       THREE,CLNO
          RETURN
.
.         Print the U/R Deletions Report Heading
.
HEADDEL   PRINT     *N;
          CALL      PAGEND
.
          PRINT     *1,"! U/R No",*13,"! Patients Name":
                    *45,"! Patients Address",*98,"! Birth Date";
          BRANCH    CTYPCHG,HDEL1,HDEL2
.
HDEL1     PRINT     *111,"! Sex",*120,"!Medicare No":
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*45,"!":
                    *98,"!Del Dat/Tm",*111,"!",*120,"!":
                    *132,"!"
          GOTO      HDEL3
.
HDEL2     PRINT     *111,"! Sex",*120,"!Resid. Stat":
                    *132,"!":
                    *N:
                    *1,"!",*13,"!",*45,"!":
                    *98,"!Del Dat/Tm",*111,"! M/Stat",*120,"!":
                    *132,"!"
.
HDEL3     ADD       THREE,CLNO
          RETURN
.
.         Print the U/R Number Change Report Heading
.
HEADURC   PRINT     *N;
          CALL      PAGEND
          PRINT     *1,"! U/R No",*13,"! Patients Name":
                    *45,"! Patients Address",*98,"! Birth Date";
          BRANCH    CTYPCHG,HURC1,HURC2
.
HURC1     PRINT     *111,"! Sex",*120,"!Medicare No":
                    *132,"!":
                    *N:
                    *1,"! New U/R",*13,"!",*45,"!":
                    *98,"!Chg Dat/Tm",*111,"!",*120,"!":
                    *132,"!"
          GOTO      HURC3
.
HURC2     PRINT     *111,"! Sex",*120,"!Resid. Stat":
                    *132,"!":
                    *N:
                    *1,"! New U/R",*13,"!",*45,"!":
                    *98,"!Chg Dat/Tm":
                    *111,"! M/Stat",*120,"!":
                    *132,"!"
.
HURC3     ADD       THREE,CLNO
          RETURN
.
.         Subroutine to print the seperation line
.
PAGEND    PRINT     *1,"*-------------------------------------------------":
                       "--------------------------------------------------":
                       "-------------------------------*"
          ADD       ONE,CLNO
          RETURN
.
.         Subroutine to generate the name of the next audit file
.         that needs to be processed
.
NEXTFILE  MOVE      ZERO TO OVRCD
          READ      FILES,SEQ;FILENAM
          GOTO      NXT9600 IF OVER
          DISPLAY   *P34:24,*V2LON,FILENAM
          TRAP      NOAUD IF IO
          OPEN      INPFILE,FILENAM
          TRAPCLR   IO
.
NXT8000   ENDSET    FILENAM
NXT9000   CMATCH    ".",FILENAM
          GOTO      NXT9500 IF EQUAL
          BUMP      FILENAM BY -1
          GOTO      NXT9000 IF NOT EOS
NXT9500   BUMP      FILENAM BY -2
          MOVE      FILENAM,DIM2
          RESET     FILENAM
          GOTO      NXT9999
.
NXT9600   MOVE      ONE,OVRCD
NXT9999   RETURN
.
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.         File does not exist
.
NOAUD     NORETURN
          GOTO      NEXTFILE
.
.         Subroutine to create a temporary index file
.
CREAIDX  
.         Delete the previous index file
.
          CALL      KILLIDX
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEI,CMDLINE
          APPEND    " 297 ",CMDLINE
          APPEND    SORTSTR,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      WORK,FNAMEI
          RETURN
.
.         Subroutine to delete the temporary index file
.
KILLIDX   CLOSE     WORK
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEI,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
.
.         I/O routines for temporary file
.
WRTMP     RESET     KEY36
          WRITE     WORK,KEY36;PURNO,PSNAME,DUNIQUE,PGNAME,PADD1,PADD2:
                         PSUBRB,PPOST,PBDATE,DSEX,PMEDI,PCHGDTE,PCASE:
                         PTITL,PTELEP,ORIGSYS,NEWUR,TRANTIM
          ADD       ONE,UNIQUE
          RETURN
.
RDTMP     MOVE      ZERO,OVRCD
          READKS    WORK;PURNO,PSNAME,DUNIQUE,PGNAME,PADD1,PADD2,PSUBRB,PPOST:
                         PBDATE,DSEX,PMEDI,PCHGDTE,PCASE:
                         PTITL,PTELEP,ORIGSYS,NEWUR,TRANTIM
.
          GOTO      OVERCOND IF OVER
          MOVE      DUNIQUE,UNIQUE
          RETURN
.
.         INC       IBAPRINT
.
          INC       TFILENAM
          INC       PATCODIO/INC
          INC       PATHOSIO/INC
          INC       PATMA1IO/INC
          INC       PATURAIO/INC
          INC       PATAU1IO/INC
          INC       PATAZ1IO/INC
          INC       IBASEQIO/INC 
          INC       WEBERRIO/INC

          INC       STD001IO
.
.         End of program
.
ENDIT     CHAIN     PGM
          STOP
