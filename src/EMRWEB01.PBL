.------------------------------------------------------------------------------
. Program       : EMRWEB01
.
. Function      : Emergency List Server
.
. Modifications : 
.------------------------------------------------------------------------------
. V12.01.01 02/02/2026  Thanh T        TSK 0964924
.           Changed EMERGV00 to add field 67 for pmpxucc4 gender data 
. V12.00.02 11/09/2025  Nikitha B      TSK 0965462
.           Recomplied for EMRCHMAN.PBL
. V12.00.01 30/05/2025  Don Nguyen     TSK 0955096
.           Alphanumeric visit number changes
. V11.05.03 18.03.2025  DA Sarkies     Task 0937594
.           Updated #70 to display alert when conditions F & >15 met
. V11.05.02 26.11.2024  Ebon Clements  Task 0954292
.           Recompiled for PATCODTM
. V11.05.01 14.11.2024  DA Sarkies     Task 0937594
.           Added to #70 to display red dot if idc3 set to F for catcode fv
. V11.04.05 18.03.2025  DA Sarkies     Task 0937594
.           Updated #70 to display alert when conditions F & >15 met
. V11.04.04 26.11.2024  Ebon Clements  Task 0954292
.           Recompiled for PATCODTM
. V11.04.03 14.11.2024  DA Sarkies     Task 0937594
.           Added to #70 to display red dot if idc3 set to F for catcode fv
. V11.04.02 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.01 01/12/2023  Ebon Clements  TSK 0940754
.           Save and restore LASTDATE when calling GETNUT00
. V11.03.20 20/10/2023  Ebon Clements  TSK 0888745
.           Added location management move locate date time functionality
.           UPPATL00 - EMCNHISA
. V11.03.19 17/10/2023  Ebon Clements  TSK 0888745
.           Populate EMRHISFD created by fields - WRTHIS00
. V11.03.18 12.10.2023  Ebon Clements   TSK 0930164
.           Changed discharged IP visits and attended OP visits within X hours
.           to check again ED arrival date/time not current date/time - IPOP0000
. V11.03.17 09.10.2023  Ebon Clements   TSK 0930164
.           Added only use current and on leave inpatient visit prior to 
.           the ED visit name highlight - IPOP0000 EMCNPTTI = 2
. V11.03.16 09.10.2023  PJ Le Febour    TSK 0930164d
.           added OPEN OUTBOKA5 to cater for READ RDSBOKA5  
. V11.03.15 06.10.2023  PJ Le Febour    TSK 0930164c
.           IPOP2500 amended to use EMVITIME instead CURRTIME
.           IPOP3100 amended RDSBOKA6 to RDSBOKA5
. V11.03.14 25.09.2023   Sunny          TSK 0937587
.           Recompiled for FHRDATDF - Changed FHRWLOCC from DIM20 to DIM21
. V11.03.13 22/09/2023  PJ Le Febour   TSK 0930164b
.           Amended IPOP0000 when checking IP OP OnLeave or DISC patient is 
.           within XXX PRIOR to the EMERGENCY Visit                         
. V11.03.12 05/09/2023  Ebon Clements  TSK 0888745
.           Added clear of EMRHISFD created/update by fields - WRTHIS00
. V11.03.11 31/08/2023  PJ Le Febour   TSK 0930164a
.           code to reflect new Emergency Parameter to Display ED name in purple
.           if patient was IP or OP and within the number of hours specified
. V11.03.10 11/08/2023  Peter Vela     TSK 0927262
.           Added FHRCON00 - Patient Resource contacts object for FHIR api
. V11.03.09 11/08/2023  Peter Vela     TSK 0927262
.           Fixed comma placement in RESWRD00 for partOf object
. V11.03.08 01/08/2023  Peter Vela     TSK 0927262
.           Recompiled for FHRDATCD
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
. V11.03.07 29/06/2023  Jacob Jackson  TSK 0927731
.           Rename FHRLOCC to FHRWLOCC
. V11.03.06 23/06/2023  PJ Le Febour   TSK 0930164
.           Added additional test to exclude IP visits created after
.           Emergency presentation date/time when option in emergency
.           parameters associated with this rule has been selected
. V11.03.05 23/05/2023  Peter Vela     TSK 0927399
.           Recompiled for FHRDATCD - Changed gender validation to
.           Indicator 7
. V11.03.04 04/05/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Participant include FHRPARIN functionality
.           Added Location include  FHRLOCIN functionality
. V11.03.03 09/02/2023  PJ Le Febour  TSK 0924676
.           Calculate length-of-stay(LOSDTIME) for discharged patients 
.           added VDISCHRD flag set to 2 to indicate a discharge       
. V11.03.02 08/12/2022  Bella Turco   TSK 0927660
.           Read PMSPX2AF in EXPTB000 to fix Preferred Name issue
. V11.03.01 15/11/2022  Bella Turco   TSK 0925495
.           Added new stream icons (TCINDC1 I-R) in STRM0000
. V11.02.05 08/11/2022  Jacob Jackson TSK 0926585
.           Replace \ with / & " with ' in variables EMVICOM1-EMVICOM6
.           for Emergency Map View
. V11.02.04 26/07/2022  Thanh T       TSK 0907640
.           Added ALERTA00 for showing alert icons in the list
. V11.02.03 15/07/2022  Thanh T       TSK 0907640
.           Added ALERTA00 for showing alert icons in the list
. V11.02.02 01/03/2022  Alina Bhari   TSK 0900613
.           Recompiled for PATMASTM                 
.           Aboriginality Icon dislayed on Patient Banner Banner if INDC 3=D 
. V11.02.01 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.16 01/12/2021  Ebon Clements   TSK 0888259
.           Fixed value of CURRDATE in IPOP0000
. V11.01.15 22/11/2021  Jacob Jackson   TSK 0913700
.           Added temporary variable SAVELDAT to ensure attendance and 
.           admittance list LASTDATE value is not overwritten to current date,
.           causing issues with too many patients being shown.
. V11.01.14 08/11/2021  Ebon Clements   TSK 0888259
.           Added patient title, surname, given name and team colour to OUTPUT00
. V11.01.13 05/11/2021  Ebon Clements   TSK 0888259
.           Added not to leave output to ED map display EMVIYN03 - EMERGV00
. V11.01.12 26/10/2021  Ebon Clements   TSK 0888259
.           Added last IP/OP functionality to the ED map - IPOP0000
.           Read and save users ED site once for map display - EMERGV00
. V11.01.11 26/10/2021  Ebon Clements   TSK 0911480
.           Changed MAPCHK00 to clear location of cancelled ED visits.
.           Moved MAPCHK00 and DISLOC00 to to a common include - EMRMAPCK
. V11.01.10 08/10/2021  Ebon Clements   TSK 0897124
.           Added nutrition information to current patient list - GETNUT00
. V11.01.09 07/10/2021  Ebon Clements   TSK 0911480
.           Moved position of stream test to correct visit reads - PATVIS00
.           Changed emrvisaf index 2 reads to index 5 by ED site          
.           CALCB000, ICOMB000, WARTB000, UNSTB000, CALCS000, CALCT000
.           DISTAB00, AWTTB000, INCVIS10 and INCREG00
. V11.01.08 27/07/2021  Thanh T         TSK 0873184
.           Changed BEDREQ00 to show the ward as green 
. V11.01.07 14/07/2021  Ebon Clements   TSK 0898344
.           Added ED map display of liked IP visit bed request info - IPBEDR00
. V11.01.06 17/06/2021  Thanh T         TSK 0873184
.           Changed check for PTCNNSSI with 20 zeros as well as spaces
. V11.01.05 16/06/2021  Thanh T         TSK 0873184
.           Added BEDREQ00 and DSDELY00
. V11.01.04 10/06/2021  Thanh T         TSK 0873184
.           Changed OUTPUT00 to return the length of stay time and delay
.           reason flag  
. V11.01.03 18/05/2021  Thanh T         TSK 0873184
.           Changed SCLK0000 to use EMVIUD09/EMVIUT09 or EMVIUD10/EMVIUT10
.           depending on the PTCNNSSI is setup or not 
. V11.01.02 18/05/2021  Thanh T         TSK 0873184
.           Changed OUTVIS00 to write out the Disposition Delay HCP equivalent 
.           code when the ward/bed is blank. Added ALHTST00 to return the 
.           allied health status color Icon      
. V11.01.01 16/02/2021  Ebon Clements  TSK 0892760
.           Fixed order of bold tags EMPTY000 VISROW00
. V11.00.10 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.09 23/11/2020  Ebon Clements  TSK 0900037
.           Changed management view sort to only use indicator 1 for the
.           triage category. MVST0000
. V11.00.08 30/10/2020  Ebon Clements  TSK 0867112
.           Removed VOSLOC90 cross browser end table and tr
. V11.00.07 07/10/2020  Ebon Clements  TSK 0867112
.           Added delay reason code output to OUTVIS00
. V11.00.06 27/08/2020  Ebon Clements  TSK 0867112
.           Added additional outputs name and stream icon to OUTVIS00
. V11.00.05 20/08/2020  Ebon Clements  TSK 0867112
.           Added management view sort order sequence - MANVSORT - OUTVIS00
.           Added stream icon display - STRMSORT - OUTVIS00
. V11.00.04 18/08/2020  Ebon Clements  TSK 0867112
.           Added slctvtyp - Current patient list select available views
. V11.00.03 18/08/2020  Ebon Clements  TSK 0867112
.           Added deftvtyp - Current patient list default view type when
.           called from a menu
. V11.00.02 12/03/2020  Ebon Clements  TSK 0886985
.           Changed expected patient lists to use site index - MAPEX000 EXPTB000
. V11.00.01 28/02/2020  Ebon Clements  TSK 0829746
.           Changed admitted patients list to use index 6 - ADDAT000
.------------------------------------------------------------------------------
. V10.15.04 12/02/2020  Tracey Nguyen  TSK 0836547
.           Added CALSEQ00 to EOUVRW16                                    
. V10.15.03 10/02/2020  Don Nguyen     TSK 0876992
.           Added VEMD Service Type (EMVIVSTY) to Visits List (EMERGV00) output
. V10.15.02 06/02/2020  Tracey Nguyen  TSK 0836547
.           Added GETWBDSC, SVWBDESC to save and display the actual ward 
.           description from patwr1af.wbdesc - EMRF8300, EOUVRW16, SETEMR00
. V10.15.01 10/12/2019  Tracey Nguyen  TSK 0836547
.           Added cgi variable DISEDSSU to display short stay unit patients
.           to EMR current patient list 
.           Added new tags - EMRF8200, EMRF8300
.------------------------------------------------------------------------------
. V10.14.09 28/08/2019  Ebon Clements  TSK 0880096
.           Fixed indicatior 6 "A"ssessor test to mandatory field 169 mandatory
.           diagnosis test -  CHKMAN00
. V10.14.08 24/07/2019  Peter Vela     TSK 0878840
.           Added reread of WEBSEC in EMERGV00
. V10.14.07 14/05/2019  Davin          TSK 0821139
.           Added hospital/site output to PatientAlerts() function (OUTVIS00)
.           Added SELSAC00 (display active EMR site codes)
. V10.14.06 02/05/2019  Don Nguyen     TSK 0868834
.           Modified Mandatory Field check (CHKMAN00) to include validations
.           for Diagnosis (Code 169) where Discharge Status has Indc3=N.
. V10.14.05 18/04/2019  Ebon Clements  TSK 0868834
.           Fixed mandatory diagnosis test 169 - CHKMAN00
. V10.14.04 16/04/2019  Don Nguyen     TSK 0821139
.           Modified Expected Patient, Advice, Contact List output (EXPTC000)
.           to include ETS Location flag (ETSLOCFL).
.           Modified Current Patients List output (OUTVIS00) to incorporate
.           Telehealth Service (ETSVISFL) data.
.           Recompiled for changes to EMRTHSCD - modified Telehealth Add/Update
.           code (AUTS0000) to cater for new Status value '4' - Exited ETS.
. V10.14.03 13/03/2019  Ebon Clements  TSK  0868834
.           VEMD 2019 - Telehealth mandatory field departure status changes
. V10.14.02 27/02/2019  Don Nguyen    TSK 0821139
.           Added 'Telehealth Service' Current Patients List output (CURETS00).
.           Added code to Add/Update a 'Telehealth Service' record (AUTS0000)
.           when updating patient location (UPPATL00).
.           Modified Location occupied validation code (VALLOC00) to also ignore
.           Telehealth Service room type.
. V10.14.01 07/02/2019  Ebon Clements  TSK 0866794
.           Perform mandatory ambulance handover test 176 and 177 for vic
.           departures 10 & 11 - left after advice and did not wait - CHKMAN00
. V10.13.11 25.01.2019  B.G.Ackland    TSK 0835482
.           Recompile for change to FHIR Encounter Reason in FHRDATCD
. V10.13.10 08/01/2018 Ebon Clements  TSK 0866749
.           Perform mandatory abulance handover test 176 and 177 for all vic
.           departurs - CHKMAN00
. V10.13.09 20/12/2018  Don Nguyen     TSK 0867091
.           Corrected 'Ready for Admission' output to display code description
. V10.13.08 20/12/2018  Don Nguyen     TSK 0867091
.           Reset Discharge Status description (DISPDDSC) for each patient in
.           the list (EDSC0000).
. V10.13.07 11/12/2018  Ken Bell       TSK 0867532
.           Cancelled Bed Request, Continue check for another Bed Request
. V10.13.06 10/12/2018  Don Nguyen     TSK 0867091
.           Modified 'Expected Discharge' details output (EDSC0000) to use
.           'Ready for Departure' date/time (EMVIUD01/EMVIUT01) if available.
.           Modified 'Ready for Admission' output (DISPUC28) to check for
.           pre-admission linked visit.
.           Modified Bed Request output (BEDC0000) to show 3 lines.
. V10.13.05 04.12.2018  Ebon Clements  TSK 0862828
.           Added multiple streams filter to current patient list - EMRVIS00
. V10.13.04 09.11.2018  Ebon Clements  TSK 0865959
.           Added bed request and expected discharge details to OUTVIS00 74 & 75
.           Fix cardinality of priority in FHIR Encounter
. V10.13.03 06.11.2017  B.G.Ackland    TSK 0835482
.           FHIR Output Change for Boolean values to not have quotes
. V10.13.02  01.11.2018  B.G.Ackland    TSK 0835482
.            Added deceased section to patient FHR resource in FHRDATCD
. V10.13.01 16/08/2018  Ania P          TSK 0859009
.           Added output for LONGDESC
. V10.12.04 17/05/2018  Peter Vela      TSK 0850174
.           Added EMVIUC34 in OUTPUT00
. V10.12.03 01/05/2018  Peter Vela      TSK 0853790
.           Added new display variables for expected unit in EMERGV00 for STV
. V10.12.02 09/04/2018  Peter Vela      TSK 0835644
.           Added new business rules around CHKMAN00 to validate
.           Ambulance Handover Date and Time for Vic VEMD
. V10.12.01 12/01/2018  Tracey Nguyen  TSK 0825792
.           Modified NURTB000/NURS0000/NURSAT00/NURTRG00/FRMNUR00/EMERGV00/
.           NUITB000/EMRF3400 to read pmshcpaf if EMCNURSE=1
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 03.10.2017  B.G.Ackland    TSK 0835482 
.           FHIR Encounter Resource for List of Current Emergency Patients
. V10.11.03 08/08/2017  Ebon Clements   TSK 0843359
.           Add 1 space to end of management notes to allow \ as last character
.           MANNOT00
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 18/07/2017  Ebon Clements   TSK 0841312
.           Changed LOKCOD00 to call RDPTICD1 using the visit date
. V10.10.07 12/07/2017  Ebon Clements   TSK 0841312 
.           Check emrvcdaf for wahealth discharge diagnosis - OUTPUT00 - 67
. V10.10.06 01/07/2017  Jill Parkinson  TSK 0841435 
.           Added variable PRESCM10 instead of outputting KEY10 which has
.           been changed
. V10.10.05 25/05/2017  Peter Vela      TSK 0833345
.           Recompiled for EMRCHMAN
. V10.10.04 22/05/2017  Peter Vela      TSK 0833345
.           Recompiled for EMRCHMAN
. V10.10.03 09/05/2017  Peter Vela      TSK 0833345
.           Recompiled for EMRCHMAN
. V10.10.02 03/05/2017  Ebon Clements   TSK 0837653
.           Exclude removed/triaged expected patients from expected count 
.           CALCE000
. V10.10.01 09/03/2017  Thanh T.        TSK 0834564
.           Added new Triage column to allow the user to triage a patient    
. V10.09.05 21/12/2016  Ebon Clements   TSK 
.           Changed expected contacts/advice list to use index 4 - EXPTC000
. V10.09.04 19/12/2016  Ebon Clements   TSK 0825820
.           Fixed patient folder display - OUTPUT00
. V10.09.03 14/12/2016  Ebon Clements   TSK 0828922
.           Added keep alive to admission list - ADDAT000
. V10.09.02 08/12/2016  Peter Vela      TSK 0825820
.           Added Current Location to OUTPUT00
. V10.09.01 28/11/2016  Peter Vela      TSK 0814744
.           Recompiled for EMREXPFD
.           Added new table fields to EXPTC000 
. V10.08.06 09/11/2016  Ebon Clements   TSK 0829038
.           Added SAVEKEY6 to EOU ward list to fix infinite loop - EOUVIS00
.           Changed EOU ward list to display no bed admissions - EOUVIS00
. V10.08.05 26/10/2016  Don Nguyen      TSK 0817345
.           Output MANNOTDT just once for Management Notes details.
.           Modified MANNOT00 to use MANNOTDT.
. V10.08.04 14/10/2016  Don Nguyen      TSK 0817345
.           Added Management Notes output to EMERGV40 (MANNOT01-MANNOT04)
. V10.08.03 08/08/2016  Davin           TSK 0321234
.           Added Chronic Condition Alert (PMPXSN11/ALRTIMG4 @ OUTVIS00)
. V10.08.02 20.06.2016  B.G.Ackland     TSK 0821135
.           Secuity fix for reads on WBSE7 index
. V10.08.01 30/05/2016  Jill Parkinson TSK 0814124 
.           Recompiled for EMRCHMAN             
. V10.07.06 11/03/2016  Peter Vela      CAR 0815116
.           Added missing fields to OTHTL000
. V10.07.05 19/11/2015  Don Nguyen      CAR 323767
.           Added STOPDTIM to output in OUTVIS00 & OUTPUT00
. V10.07.04 04.11.2015  Ebon Clements   CAR 322796
.           Updated business rules for clearing ed location - CLRLOC00
. V10.07.03 09.10.2015  B.G.Ackland     CAR 322391
.           Fixed Calculation for Billing Incomplete Statistic
. V10.07.02 09/10/2015  Peter Vela      CAR 317170
.           Recompiled for  EMRCHMAN
. V10.07.01 09.10.2015  B.G.Ackland     CAR 322391
.           Added Calculation for Billing Incomplete Statistic
. V10.06.09 09/09/2015  Peter Vela      CAR 320022
.           Added fields to WARTB000
.           Added fields to OTHTB000
. V10.06.08 07/09/2015  Peter Vela      CAR 320022
.           Added fields to UNSTB000
.           07/09/2015  Peter Vela      CAR 318849
.           Added management notes to OUTVIS00
. V10.06.07 03/07/2015  Ebon Clements   CAR 318440
.           Added read of pmspx2af in ICOMB000
. V10.06.06 24/04/2015  Ebon Clements   CAR 318184
.           Changed map display to use DISPWRDT and DISPWRTM for ward bed    
.           ready date time
. V10.06.05 23/04/2015  J.Tan           CAR 244314
.           Mods Incomplete Billing List to display patient with Allocated doct
. V10.06.04 02/04/2015  J.Tan           CAR 244314
.           Added Incomplete Billing List
. V10.06.03 18/03/2015  Peter Vela      CAR 282090
.           Added date range functionality for reportno 1
.           Added get los functionality in ADDAT000
.           Added fields to OUTPUT00
.           Added fields to UNSTB000
.           Added fields to OTHTB000
.           Added fields to OUTVIS00
. V10.06.02 16/03/2015  Ebon Clements   CAR 313162
.           Stay on by pass if off date is in the future - EMRF5300 & EMRF6600
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
. ------------------------------------------------------------------------------
. V10.05.11 02/03/2015  Ebon Clements   CAR 304779
.           Added stop the clock functionality - SCLK0000
. V10.05.10 24/02/2015  Ebon Clements   CAR 304779
.           Added output of EMVIUC16 to ED map -  EMERGV00
. V10.05.09 24/02/2015  Ebon Clements   CAR 312889
.           Only read last by pass record - EMRF5300 and EMRF6600
. V10.05.08 19/02/2015  Ebon Clements   CAR 304779
.           Changed NEXTSEQS to be the cat eh code for stream
. V10.05.07 12/02/2015  Ebon Clements   CAR 304779
.           Added additional indicator for next by stream - NEXTSEQS
. V10.05.06 06/01/2015  Ebon Clements   CAR 304779
.           Added on bypass tag with date and time display - EMRF6600
. V10.05.05 19/12/2014  B.G.Ackland     CAR 310348
.           Recompiled for changes to IBAWEBCD
. V10.05.04 22/08/2014  Don Nguyen      CAR 307028
.           Added DISBALRT (Disability Alert Icon indicator) to EMERGV00
. V10.05.03 22/08/2014  B.G.Ackland     CAR 307285
.           Enhanced Configurable Map View emrweb0101040/emrweb0101041
.           Altered Tag in Map View emrweb0101001 stv/emrweb0101001
. V10.05.02 11/08/2014  Don Nguyen      CAR 297774
.           Modified OUTPUT00 to also display PMBRRDAT & PMBRRTIM for allocated
.           Bed Requests (PMBRRSTA = 2).
.           Output PMBRRDAT & PMBRRTIM in EMERGV00.
.           Recompiled for changes to PMSBRQFD/IO
. V10.05.01 06/08/2014  Don Nguyen      CAR 297703
.           Recompiled for EMRBPSFD/IO - new fields added for Authorisation
. V10.04.05 21/05/2014  Peter Vela      CAR 292130
.           Added Ambulance cell color to ed map (emrweb0101001) in EMRGV000
.           Recompiled for EMRCHMAN
. V10.04.04 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 17/03/2014  Peter McMullen  CAR 294083
.           read user credentials using long key for USERNAME  
. V10.04.02 15/01/2014  Patrick Adair   CAR 296035
.           Cleared HCP and Nurse name fields on ovrcd
.           Applied changes required for/from CAR 275582 
. V10.04.01 31/12/2013  Don Nguyen      CAR 294371
.           Recompiled for changes to EMREXPFD and EMREXPIO
. V10.03.33 04/12/2013  Ebon Clements   CAR 293715
.           Added 5 character doctor seen time  - OUTPUT00
. V10.03.32 14/11/2013  Don Nguyen      CAR 293847
.           Added FRMHCP00 and FRMNUR00 to OUTPUT00 for HCP & Nurse short names
. V10.03.31 10/09/2013  Steve Armstrong CAR 291089
.           Recompiled for changes to PMSQVIIO
. V10.03.30 28/08/2013  Peter Vela      CAR 284851
.           Added Ward Only to WARTOT00
. V10.03.29 19/07/2013  Don Nguyen      CAR 282450
.           Modified EMRVIS00 to only output Attending Nurse if there is one
.           18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.28 20/06/2013  Ebon Clements   CAR 287183  
.           Added FILTSITE for current patient list with site filter - 
.           EMERGV00 and PATVIS00
. V10.03.27 08/05/2013  Patrick Adair   CAR 269338
.           Check Max Number of Patients is not exceeded for a location
. V10.03.26 14/03/2013  J.Tan           CAR 281349
.           Recompiled for EMRCHMAN - Clinical notes from vismdtaf file
. V10.03.25 04.03.2013 Peter McMullen   CAR 271555
.           Convert VERUSR00 to use standard authenticaion VFYUSR00     
. V10.03.24 21.02.2013 Ebon Clements    CAR 281571
.           Check if location occupied when updating location - UPPATL00
. V10.03.23 07.02.2013 B.G.Ackland      CAR 278073
.           WA Health Current Patients Complaint/Diagnosis
. V10.03.22 25.01.2013 B.G.Ackland      CAR 278073	
.           WA Health Current Patients including Next Seq
. V10.03.21 23/11/2012 Peter Vela       CAR 276837
.           Added Presenting Complaint/Diagnosis field to EMERGV00
. V10.03.20 15/11/2012 Jill Parkinson CAR 276503
.                      Fixed site based comments from looping all records
. V10.03.19 15/11/2012  Don Nguyen      CAR 276189
.           Copied patient given name & surname to relevant variables used by
.           CHKD0000 (for Zero U/R patients).
. V10.03.18 02/11/2012  Peter Vela      CAR 265655
.           Fixed GETDUU00
. V10.03.17 16/10/2012  Peter Vela      CAR 274636
.           Added FFDIAG00 - Display Free Format / Discharge Diagnosis for
.           emrweb0102005/wahealth
. V10.03.16 10/10/2012  Ebon Clements   CAR 273057
.           Added WA fields to map display - EMERGV00
. V10.03.15 01/10/2012  Ebon Clements   CAR 270231
.           Added ED site to to PSC incompletes - CALCP000 and PSCTB000
. V10.03.14 28/09/2012  Ebon Clements   CAR 273687
.           Fixed ED site test on the expected patient list - EXPTB000
. V10.03.13 26/09/2012  Don Nguyen      CAR 273687
.           Added site code check in CALCE000
. V10.03.12 24/09/2012  Don Nguyen      CAR 270231
.           Added visit location description (EMLODESC) to EMERGV00
. V10.03.11 21/09/2012  Ebon Clements   CAR 273254
.           Fixed AGEINDAY for unknown patients - OUTPUT00
. V10.03.10 11/09/2012  Ebon Clements   CAR 270231
.           Clear wait time WAITHHMM in - GETSFD00
. V10.03.09 04/09/2012  Don Nguyen      CAR 270231
.           Added output tag (EMRF6000) for Site-based comments/notices
. V10.03.08 28/08/2012  Don Nguyen      CAR 270231
.           Added check on EMR Site Code for Expected Patient List EXPTB000
.           Added EMVIUC16 selection list output (EMRF5800) and FILTSTRM
. V10.03.07 23/08/2012  Don Nguyen      CAR 239154
.           Added output of Transfer Destination Coded Name (PTVACNME)
. V10.03.06 16/08/2012  Jill Parkinson  CAR 271121
.           Removed BED from EMRF5700              
. V10.03.05 03/07/2012  Peter Vela      CAR 265655
.           Added functionality for EMCNDDSS
.           Added functionality for EMCNSFSM
. V10.03.04 27/04/2012  Don Nguyen      CAR 254988
.           TCINDC11 will now also work with 'M', as it did with 'E'
. V10.03.03 04/03/2012  Nicole Torrisi  CAR 254747
.           Added output of Doctor Name to EMERGV00
. V10.03.02 06/12/2011  Ebon Clements   CAR 256408
.           Added expected ward/bed descriptions to OUTPUT00
. V10.03.01 17/11/2011  Ebon Clements   CAR 255526
.           Added EMVICOM1 - presenting complaint to OUTPUT00
. V10.02.11 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.10 19/20/2011  Ebon Clements    CAR 251052
.           Added venquiry menu option cgi to display ED enquiry page
. V10.02.09 12/10/2011  Ebon Clements    CAR 250752
.           Added wahealth ED discharge diagnois to lists - OUTPUT00
. V10.02.08 26/09/2011  Steve Armstrong  CAR 249584
.           Added read of pmsvx1af record prior to calls to DGCLICEC.
.           Recompiled for changes to DGCLICEC.
. V10.02.07 23/08/2011 B.G.Ackland    CAR 230354
.           Map View Enhancement to Show Referral Source and Class BOP
. V10.02.06 22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
.           29/06/2011 Peter Vela     CAR 239432
.           Added showflag submit and tag for EmergencyMapFrameMCCustom.html
. V10.02.05 23/06/2011 Saroeun Soeur  CAR 243591
.           check indicator 2 on the triage CALSEQ00
. V10.02.04 25/05/2011  Saroeun Soeur  CAR 230802
.           added report seen for PTH
. V10.02.03 03/05/2011  Davin          CAR 239539
.           Allow 3 alert indicators to be displayed (DIM10 in EMERGV00)
. V10.02.02 28/04/2011 Ebon Clements  CAR 242237
.           Changed EMVCFTXT in OUTPUT00 to use DISDIAGF
. V10.02.01 28/03/2011 Ebon Clements  CAR 239311
.           Added EMVCFTXT to WARTB000
. V10.00.14 13/09/2010 Ebon Clements  CAR 228803
.           Remove \ from patient name on map view - NAMEAM00
. V10.00.13 03/08/2010 Peter Vela     CAR 216620
.           Added EMVCFTXT to OUTPUT00
. V10.00.12 13/08/2010 Peter Vela     CAR 227279
.           Include complete and incomplete discharged emr patients in CALCL00
.           if emviadmt = 1 and emvilocn != SP70
. V10.00.11 12/08/2010 Peter Vela     CAR 227279
.           Include complete and incomplete discharged emr patients in CALCX00
.           and OTHTB000 if emviadmt = 1 and emvilocn != SP70
. V10.00.10 29/07/2010 Ebon Clements  CAR 202417
.           Added research field EMVIUC29 to OUTPUT00
. V10.00.09 28/06/2010 Davin          CAR 202563
.           Added expected date/time field 33 (emexetad/emexetat) to EXPTB000
. V10.00.08 15/06/2010 Peter Vela     CAR 216620
.           Added display functionality for EMVCFTXT @ DIAG0000
. V10.00.07 04/06/2010 Ebon Clements  CAR 222133
.           Display admitted ward/bed in expected ward/bed on admission list
. V10.00.06 14/05/2010 Peter Vela     CAR 218849
.           Added EMCNMSRS validation to EMVILOCN
. V10.00.05 11/05/2010 Peter Vela     CAR 218849
.           Added Display Same Surnames in RED ED Map Screen parameter
.           functionality
. V10.00.04 07/05/2010 Peter Vela     CAR 220127
.           Added bold display of EMVIUR01 on the map screen if EMVIYN01 = 1
.           07/05/2010 Ebon Clements  CAR 219881
.           Fixed length of presenting complaint display - DIAG0000
. V10.00.03 14/04/2010 Steve Armstrong   CAR 219933
.           Recompiled for changes to EMRVCDFD
. V10.00.02 18/03/2010 Steve Armstrong   CAR 135505
.           Added setting of HL7TRGID & HL7INCLD for all broadcast messages
. V10.00.01 16/03/2010 Ebon Clements CAR 210096
.           Calculate unknown patient age before call to OUTPUT00
. ------------------------------------------------------------------------------
. V9.12.18  10/03/2010 Ebon Clements  CAR 216631
.           Don't display discharge date/time until discharged on lists OUTPUT00
. V9.12.17  05/03/2010 Ebon Clements  CAR 216631
.           Added combined departure status an transfer destination field
.           to OUTPUT00
. V9.12.16  04/03/2010 Jill Parkinson CAR 216632
.           Added output of EMVIUC28 in EMERGV00 and ADMRND28
. V9.12.15  03/03/2010 Ebon Clements CAR 2158233
.           Recompiled for EMRCHMAN - Ambulance case number
. V9.12.14  12/02/2010  Peter Vela    CAR 215930
.           Changed EMVIDTIM to EMVIUT01
. V9.12.13  10/02/2010  Peter Vela    CAR 215888
.           Fixed Other Clinical Details indicators @ OCLN0000
. V9.12.12  19/01/2010  Ebon Clements CAR 213775
.           Fixed write of history record if key already existed - WRTHIS80
. V9.12.11  21/12/2009 Saroeun Soeur CAR 211919
.           GETSFD00 - get first doctor seen
. V9.12.10  11/12/2009 Ebon Clements CAR 210183
.           Display ready for admission code in map view cell 7 - BEDR0000
. V9.12.09  25/08/2009 Ebon Clements CAR 202965
.           Added visit based CDM details to the attendance list - PTDAT000
. V9.12.08  29/07/2009 Jill Habasque CAR 145706
.           Mods to output all emr attendances for gp access
. V9.12.07  27/07/2009 Ebon Clements CAR 191702
.           Added WARTOT00 total number of admitted patients in ward
. V9.12.06  21/07/2009 Jill Habasque CAR 145706
.           Mods to check for inform gp in emr attendance list - PTDAT000
. V9.12.05  14/07/2009 Ebon Clements CAR 199879
.           Changed CALSEQ00 to default patients with no triage cat to cat 5
. V9.12.04  17/06/2009 WeeLee Koo    CAR 197930
.           Added new tag to check on Off Pre/By-Pass (EMRF5300)
. V9.12.03  01/06/2009 Ebon Clements CAR 197930  
.           Added EMCNDPRS - Display diagnosis over presenting complaint on map
.           Added user defined date/time 1 to OUTPUT00
. V9.12.02  14/05/2009 Saroeun Soeur CAR 196333
.           Added age in days(AGEINDAY) to OUTPUT20
. V9.12.01  13/05/2009 Peter Vela    CAR 196636
.           Do not display yellow sad face if EMCNWTTM = 0
. V9.11.01  01/05/2009 Jill Habasque CAR 145706 
.           Added emergency attendance list by GP
. V9.10.03  28/08/2008 Ebon Clements  CAR 176381
.           Changed nurse incompletes to include blank nurse - CALCN000 NURTB000
. V9.10.02  30/05/2008 Sandra Barcham CAR 166620
.           Fix display of emergency presentation twice within 24 hours
. V9.10.01  28/04/2008  Ebon Clements CAR 166291
.           Fixed Admitted Patients by date range cancelled status goto-ADDAT000
. V9.09.09  26/02/2008  Ebon Clements CAR 161158
.           Added ward/bed request details to OUTPUT00
. V9.09.08  11/02/2008  Ebon Clements CAR 159717
.           Set values of websteaf in VERUSR00 even if no security for user
. V9.09.07  10/01/2008  Ebon Clements  CAR 152373
.           Fixed setting value of COMPDISP in PTDAT000
. V9.09.06  17/12/2007  Ebon Clements  CAR 157883
.           Changed WARTB600 to display DTRIG not EMVITRIG
. V9.09.05  12/11/2007  Ebon Clements  CAR 151894
.           Added ward/bed request functionality
. V9.09.04  01/11/2007  Ebon Clements  CAR 151800
.           Added EMCNRETC - Using retain patient cubicle in map functionality
.           01/11/2007  Ebon Clements  CAR 96699
.           Removed changed from V9.08.02
. V9.09.03  29/10/2007  Peter Vela     CAR 151199
.           Added new Emergency Cancellation status
. V9.09.02  24/10/2007  Peter McMullen CAR 151514
.           Rettrun all lines of Emergency Notices, not just 10
. V9.09.01  26/07/2007  Ebon Clements CAR 96699
.           Commented out the test for EMVIPADM when checking sad face. If the
.           patients is on the map we should calculate the sad face - EMERGV00
. V9.08.01  31/01/2007  Peter Vela    CAR 127930
.           Recompiled for EMRSITFD
. V9.07.02  27/07/2006  Ebon Clements CAR 113229
.           Changed EMU ward list to dispay EOU beds with ind 8 = 0
. V9.07.01  21/06/2006  Ebon Clements CAR 107743
.           Added new tag EMRF5000 count of admissions in EMU ward
. V9.06.01  20/04/2006  Ebon Clements CAR 101705
.           Removed mandatory field code that was not called
.           CHKMNC00, CHKMNA00, CHKPSC00, CHKDDC00 and CHKNNR00
.------------------------------------------------------------------------------
. V9.05.03  31/03/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.02  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.01  07/03/2006  Ebon Clements    CAR 89461
.           Fixed jump category problem with CALSEQ00 waiting order by
.           changing NEXTSEQN to 9 characters
. V9.05.B01 14/12/2005  Steve Armstrong  CAR 88829
.           Recompiled for changes to DGCLICEC (for HL7 messages).
.           Added read on PMI details before sending broadcast messages.
.------------------------------------------------------------------------------
. V9.04.22  13/10/2005  Ebon Clements CAR 45637
.           Added ability to triage from the triage board - VISLOC00
. V9.04.21  09/09/2005  Ebon Clements CAR 64055
.           Added EMCNLOSW - Emergency length of stay warning to EMERGV00
. V9.04.20  22/08/2005  Peter Vela    CAR 66864
.           Modified to display admission unit if one exists for template 
.           emrweb0101008.html PATVIS22
. V9.04.19  04/08/2005  Ebon Clements CAR 57189
.           Added DISPFLAG to WARTB000 - Waiting room list
. V9.04.18  04/08/2005  Ebon Clements CAR 57189
.           Added call to PATLN000 in ADDAT000 - admissions list
. V9.04.17  04/08/2005  Ebon Clements CAR 57189
.           Added DISPFLAG to UNSTB000 - unseen list
. V9.04.16  03/08/2005  Ebon Clements CAR 57189
.           Added read of presenting complaint in PTDAT000 - attendance list
. V9.04.15  01/08/2005  Ebon Clements CAR 57189
.           Added combined date/time option to WARTB000 - Waiting room list 
. V9.04.14  21/07/2005  Ebon Clements CAR 57510
.           Added combined date/time option to OTHTB000 - Other department list
. V9.04.13  20/06/2005  Peter Vela    CAR 63186
.           Added functionality to display Unit of Admission from Emergency
.           on Emergency Map View Screen EMERGV30
. V9.04.12  18/05/2005  Peter Vela    CAR 60166
.           Implemented Emergecny Sad Face parameter
. V9.04.11  16/05/2005  Ebon Clements CAR 61949
.           Added filtlocn to other location list
. V9.04.10  08/03/2005  Ebon Clements CAR 59018
.           Added new tag at EMRF4040 for number of patients in a location.
.           Made CALCW000 and CALCL000 use location key on emrvisaf
. V9.04.09  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.08  20/01/2005 Ebon Clements CAR 56366
.           Added EMVICOMP to OUTPUT00
. V9.04.07  24/12/2004 Ebon Clements CAR 56056
.           Added new fields to expected patient list. Added expected patient
.           tag for map. Added nz sad face for triage exceeded times on map
. V9.04.06  13/12/2004 J.Tan  CAR 55867
.           Added tag for Unit request list
. V9.04.05  21/10/2004 Ebon Clements  CAR 54531 
.           Pack locacode with spaces in setpar
. V9.04.04  15/10/2004 Ebon Clements  CAR 54258
.           Fixed zero u/r test in INCREG00
. V9.04.03  06/10/2004 Ebon Clements  CAR 54097
.           Set triage category display after call of PATFLD00 in patient lists
. V9.04.02  24/09/2004 Peter Vela CAR 53637
.           Fixed javascript error in emrweb0102004.html OUPUT00
. V9.04.01  24/08/2004  Davin             CAR  52594
.           Added tag for table - Patients Awaiting Triage
. V9.03.14  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.13  31/05/2004 Peter Vela     CAR 50230
.           Fixed re-initialisation of doctor name.
. V9.03.12  17/05/2004 Peter Vela     CAR 49621
.           Made NUMPSCPT (incomplete psc patients) FORM 3
. V9.03.11  22/04/2004 Peter Vela     CAR 48257
.           Added patient folder colours for WARTB000 OTHTB000 and UNSTB000
. V9.03.10  13/04/2004 Peter Vela     CAR 48257
.           Added FORMATNM to OUTPUT00
. V9.03.09  22/03/2004 Peter Vela     CAR 13038
.           Implemented DOCNM00 in OUTPUT00 (Doctor Name Format Parameter)
. V9.03.08  11/12/2003 Peter Vela     CAR 40355
.           Recompiled for PATNAMCD
. V9.03.07  28/10/2003 Ebon Clements  CAR 44623
.           Changed mandatory fields to use category EZ for responsibility
. V9.03.06  13/10/2003  Davin         CAR 39038
.           Recompiled for change to viscmtfd
.           14/10/2003 Ebon Clements CAR 44193
.           Changed VERUSR00 to not check server security if the updated type
.           has no security level set.
. V9.03.05  27/08/2003 Jill Habasque CAR 42879
.           Fixed Discharge outstanding list
. V9.03.04  25/08/2003 Ebon Clements CAR 42813
.           Recompiled for EMRSITFD changes that were missing in V9 that
.           had been made in 5.09 - EMSTDLOC
.           25/08/2003 Jill Habasque CAR 42813
.           Added FDNAM000
. V9.03.03  26/06/2003 Ebon Clements             CAR 40734
.           Added reads of pmspx2af for the patient list folder displays
. V9.03.02  15/05/2003  Lina Vo                  CAR 38501
.           Added EMCNDOCT tag
.           19/05/2003  Jill Habasque            CAR 39202
.           Added read of pmspx2af                            
. V9.03.01  08/05/2003  Ebon Clements            CAR 38859 
.           Fixed category code read in PSCTB000 for the triage category.
.------------------------------------------------------------------------------
. V9.02.47  06/05/2003  Lina Vo                  CAR 38513 
.           Fixed EMRF1500 to use UR number as char not numeric for NZ.        
. V9.02.46  08/04/2003  Lina Vo                            
.           Added check for 0 incompletes in Doctor & Nurse incomplete lists.  
. V9.02.45  20/03/2003  Tracey Nguyen            CAR 34880
.           Call PATFLD00 to display the correct colour for the patient folder.
. V9.02.44  07/03/2003  Lina Vo                  SRF 37131
.           Mods NUITB000 to display only incomplete patients for nurse,
.           excluding complete(1) and until discharge(2).
. V9.02.43  20/02/2003  Lina Vo                  SRF 36369
.           Mods CALSEQ00 to fix triage cat 4 problem.           
. V9.02.42  24/01/2003  Sylvek Litewka           SRF 35723
.           Added check for EMVIPADM before setting the ADMITFLG.
. V9.02.41  24/12/2002  Sylvek Litewka           SRF 34454
.           Added variable ADMITFLG and procedure GETTIM00 that calculates the
.           patients waiting time since being seen by the doctor.
.           If the patient has been waiting for more than 9 hours then ADMITFLG
.           variable is set, indicating that patient should be admitted. 
. V9.02.40  11/12/2002  Ebon Clements            SRF 23449
.           Recompiled for EMRCHMAN - Z099 primary diagnosis visit number
. V9.02.39  25/11/2002  Ebon Clements            SRF 23449
.           Recompiled for EMRCHMAN - Z099 primary diagnosis      
. V9.02.38  21/11/2002  Pat Dirito               SRF 33644
.           Fixed read of PTCNI10D was reading incorrect position
. V9.02.37  20/11/2002  Ebon Clements SRF 22706  
.           Added tag to display the users emergency site code  
. V9.02.36  04/11/2002  Ebon Clements SRF 23698  
.           Mods to WRTHIS00 for doctor and nurse seen date/time
. V9.02.35  16/09/2002  Jill Habasque SRF 20302  
.           Added EMRCHMAN            
. V9.02.34  10/09/2002 Jill Habasque SRF 20584
.           Added check for zero incompletes before displaying
.           the doctor on the map view                        
. V9.02.33  09/09/2002 Jill Habasque SRF 20304
.           Changed CALCW000 to process the same as WARTB000
. V9.02.32  28/08/2002 Ebon Clements SRF 20077
.           Fixed clear of EMVILOCN in MAPCHK00. Update if
.           OVRCD is not equal to 1 not if equal to 1
. V9.02.31  29/06/2002 Ebon Clements 19105  
.           Recompiled for sigpipe trap
. V9.02.30  31/05/2002 Ebon Clements 18229
.           Added trap if sigpipe
. V9.02.29  27.05.2002 Bronko Sosoc
.           Spacial characters striping
. V9.02.28  15.05.2002 Bronko Sosic
.           Removed " from presenting complaint when displayed
.           In current EMR patient List                          
. V9.02.27  10.05.2002 Bronko Sosic
.           Changed auto correction of cat 4 & 5 patients so the
.           queing order is always kept correct 
. V9.02.26  23.04.2002 Bronko Sosic
.           Removed " from presenting complaint when displayed
.           in a table sort
. V9.02.25  22.04.2002 B.G.Ackland
.           Reset FORMATNM Field to Correct Length
. V9.02.24  20.03.2002 Bronko Sosic 
.           Recompiled for EMRICDFD        
. V9.02.23  20.03.2002 Jill Habasque
.           Added call INTMAS00 in INIT0000
. V9.02.22  20.03.2002 Jill Habasque
.           Fixed output of destination in OUTPUT00
. V9.02.21  19.03.2002 B.G.Ackland
.           Indicate if Patient Admitted 
. V9.02.20  17.03.2002 B.G.Ackland
.           Fix Location for Discharged Patients
. V9.02.19  17.03.2002 B.G.Ackland
.           Fix Location for Discharged Patients
. V9.02.18  17.03.2002 B.G.Ackland
.           Fix Mandatory checking for C-Type
. V9.02.17  09.03.2002 B.G.Ackland
.           Fix Read on Complaint
. V9.02.16  09.03.2002 B.G.Ackland
.           Fix Count for Waiting Room Patients
. V9.02.15  09.03.2002 B.G.Ackland
.           Verify Patient Should be in a Location
. V9.02.14  07.03.2002 Bronko Sosic
.           Removed Mandatory feild checking 
. V9.02.13  28.02.2002 Bronko Sosic
.           Added a new list to display. Patients waiting on 
.           discharge
. V9.02.12  24.02.2002 Bronko Sosic
.           Changes Mandatory Feilds                           
. V9.02.11  31.01.2002 Bronko Sosic
.           Changes to the Map View                            
. V9.02.10  21.01.2002 Davin
.           Send CEC broadcast message when visit file updated
. V9.02.09  20.12.2001 Bronko Sosic
.           Changes for display list on mapview           
. V9.02.08  26.11.2001 Bronko Sosic
.           Changes for St.V                     
. V9.02.07  26.11.2001 Bronko Sosic
.           Removed EMRDOCFD                     
. V9.02.06  18.11.2001 Bronko Sosic
.           Changed Name display for Map View    
. V9.02.05  04.10.2001 J.Tan
.           Added Visits by location option (SRHLOC00)
.           Added check in visits by location for emr site code
. V9.02.04  27.09.2001 Bronko
.           Fix injury data not being registered.
. V9.02.03  11.09.2001 Raghu Surve -HPS
.           Modified for patient counters in map 
. V9.02.02  08.09.2001 B.G.Ackland
.           Modified for Jump Queue
.           04.09.2001 B.G.Ackland
.           Fix Output for Map to Only Process Current Patients
. V9.02.01  30.08.2001 Raghu
.           Modified CHKMAN00 and DISMAN00 routines 
.           Recompiled for EMRHISFD 
.------------------------------------------------------------------------------
.                 V9.01.03 16.08.2001 J.Tan
.                           Recompiled for PATMASTM
.                 V9.00.02 16.08.2001 J.Tan
.                           Recompiled for PATMASTM
.                 V9.00.01 13.08.2001 J.Tan & Rahul
.                           Recompiled for PATMASTM
.                           Added filter for Responsibility
.                           on the basis of Category EZ
.                 V9.00.08 13/08/2001 Rahul HPS 
.                          Added filter for the Responsibility 
.                 V9.00.07 13/08/2001 Bronko
.                          Bug Fixes for St V.         
.                 V9.00.06 12/08/2001 Bronko
.                          Fixed for expected patients.
.                 V9.00.05 11/08/2001 Harvinder - HPS
.                          Modified for presenting compliant.
.                 V9.00.04 09/08/2001 HPS
.                          Changed reading of Master file to get Correct
.                          listing of Patient for Waiting,Unseen and PSC.
.                          Unit Description for Current Patient list Added. 
.                 V9.00.03 08/08/2001 HPS
.                          Added filter for the Responsibility 
.                 V9.00.02 07/08/2001 HPS
.                          Called Time Diff Routine
.                 V9.00.01 19/06/2001 Bronko Sosic
.                           Changes as per Spec       
.                 V9.00.B01 24/05/2001 Pat Dirito
.                           Added VYEARMTH in SETPAR00
.                 V5.08.08  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.07  09.07.2000  B.G.Ackland
.                           Changed to Use SELV not SELC for Date Selection
.                 V5.08.06  16.06.2000  B.G.Ackland
.                           Fix Attendance and Admission List Main Loops
.                 V5.08.05  16.06.2000  B.G.Ackland
.                           Fix Triage Location Board to Clear Location of 
.                           Discharged Patients
.                 V5.08.04  16.06.2000  B.G.Ackland
.                           Fix Reg Out
.                 V5.08.03  15/05/2000  Nicole Harrington
.                           Fixed vyearmth to dateselc                 
.                 V5.08.02  11/05/2000  Pat Dirito       
.                           Fixed Image for relative pathing           
.                 V5.08.01  08/05/2000  Nicole Harrington
.                           Added printing of current patient list
.----------------------------------------------------------------------
.                 V5.07.07  30/03/2000  Nicole Harrington
.                           Changed error message when validating site
.                 V5.07.06  28.01.2000  B.G.Ackland
.                           Recompile in Work
.                 V5.07.05  10/01/2000  Nicole Harrington SRF No: 636627
.                           Fixed triage board icons to stop flashing after 
.                           doctor seen date and time is entered
.                 V5.07.04  05/01/2000  Nicole Harrington
.                           Changed to allow calendar date selection on lists
.                           by date range (SELC0000)
.                 V5.07.03  28/10/1999  Nicole Harrington
.                           Fixed age display
.                 V5.07.02  28/10/1999  Nicole Harrington
.                           Recompiled for WEBDATCD/DAYOFWEK
.                 V5.07.01  27/10/1999  Nicole Harrington
.                           Changes for Ballarat
.                 V5.07.00  14/10/1999  Nicole Harrington
.                           Port from 6.06 - 5.07
.----------------------------------------------------------------------
. Modifications : V6.06.01  07/07/1999  Nicole Harrington
.                           Fixed display of unknown patient given name
.                 V6.06.00  16/02/1999  K Nelson and N Harrington
.                           Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       FHRDATDF
.
          INC       EMRDELFD/INC
          INC       VISCMTFD/INC
          INC       PMSVX1FD/INC
          INC       EMRDCMFD/INC
          INC       EMRVPRFD/INC
          INC       EMRMTXFD/INC
          INC       EMRVDGFD/INC
          INC       PATALRFD/INC        
          INC       PATVISFD/INC                                               
          INC       OUTSITFD/INC                                               
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC

          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSPX2FD/INC                                               
          INC       PMSPX2TD/INC
          INC       PATFN1FD/INC                                               
          INC       PATPR1FD/INC                                               
          INC       PATWR1FD/INC                                               
          INC       MRTMASFD/INC
          INC       MRTLOCFD/INC
.
          INC       EMRCMTFD/INC
          INC       EMRCLIFD/INC
          INC       EMRGRCFD/INC
          INC       EMRISMFD/INC
          INC       EMRPROFD/INC
          INC       EMRSCMFD/INC
          INC       EMRWFMFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OPRNURFD/INC
          INC       PMSHCPFD/INC
.
          INC       EMRBPSFD/INC
          INC       EMRCONFD/INC
          INC       EMRINCFD/INC
          INC       EMREXPFD/INC
          INC       EMRHISFD/INC
          INC       EMRICDFD/INC
          INC       EMRLOCFD/INC
          INC       EMRSITFD/INC
          iNC       EMRVCDFD/INC
          INC       EMRVISFD/INC
          INC       EMRUNKFD/INC
          INC       EMRUTYFD/INC
          INC       MEHLERFD/INC
          INC       PATCONFD/INC
          INC       PATCRCFD/INC
          INC       PATDO1FD/INC
          INC       PATDHEAD/INC
          INC       PATDSCFD/INC
          INC       PATHSPFD/INC
          INC       PATICDFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATONLFD/INC
          INC       PATCALAG/INC
          INC       PATNIDFD/INC
          INC       PATNOBFD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCDNFD/INC
          INC       PMSHCGFD/INC
          INC       PMSNUTFD/INC
          INC       PMSCURFD/INC
          INC       PMSCCDFD/INC       * Concession Card Details
          INC       VISMDTFD/INC
          INC       VISXDCFD/INC
.
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
          INC       EMRTHSFD/INC       * Emergency Telehealth Services
.
ALRTIMGE  DIM       250       * Link to the patient alerts page
ALRTIMG1  DIM       250       * Link to the patient alerts page (Medical Alerts)
ALRTIMG2  DIM       250       * Link to the patient alerts page (Micro Alerts)
ALRTIMG3  DIM       250       * Link to the patient alerts page (Risk Alerts)
ALRTIMG4  DIM       250       * Link to the patient alerts page (Chronic Alerts)
ALRTDISA  DIM       250       * Link to the patient alerts page (Disability)
ALRTIMGT  DIM       1250      * Link to the patient alerts page
ALRTCODE  DIM       20[99]           * Array of alert codes
AMODEIN1  DIM       1          * Arrival Mode Indicator 1
LOCADATE  DIM       8
LOCATIME  DIM       8
LOCDTMOV  FORM      1          * Is this a location date/time movement
LOOPSITE  DIM       3
LOCNTYPE  DIM       1          * Location Type
LOOPCNTR  FORM      4
BEDRFONT  DIM       6
BEDRFNTR  DIM       6
BCKTOTRI  DIM       1
CFILEPRE  DIM       3
COUNTLOC  DIM       3          * Location to count 
TEAMCOLR  DIM       7          * Team field hex code
TRICDEI1  DIM       1          * Triage code indicator 1 (Cat AA)
IPBEDREQ  DIM       20         * ED Map display linked IP bed request
ISOIND2   DIM       1          * Isolation indicator 2 (Cat es) 
ISOCOLOR  DIM       14         * Isolation color 
STRMIND1  DIM       1          * Stream indicator 1 (Cat eh)
IASSNAM6  DIM       6          * First 6 chars of initial assessor surname
SDOCNAM6  DIM       6          * First 6 characters of senior doctor surname
CONTTYPE  DIM       10
CONTFILT  DIM       1
CONSICON  DIM       70         * Consults Icon
CONSSORT  DIM       70         * Consults Icon Sort
CHECKGP   FORM      1
CURLOCDS  DIM       40
CURRTIME  DIM       8
DEFTVTYP  DIM       1          * Default view type
DEPREADY  DIM       75         * Departure Ready
DIETCLAS  DIM       12
DOCTSTIM  DIM       5
DOCTTIME  DIM       16
DOCTNAM2  DIM       127
DISBALRT  FORM      1          * Disability Alert Icon indicator
DISCTIME  DIM       16
DISEDSSU  DIM       1          * Display SSU patients to EMR current pat list
DISPBRQT  DIM       5          * Requested time
DISPBRDT  DIM       5          * Bed ready time
DISPBEDS  DIM       20
DISPBEDA  DIM       600
DISPBEDB  DIM       600
DISPDEBR  DIM       600
DISPBEDX  DIM       600
DISPDELY  DIM       20
DISPDTYP  DIM       20
DISPFAST  DIM       3
DISPMENU  DIM       127
DISPML01  DIM       20
DISPML03  DIM       20
DISPML05  DIM       20
DISPML07  DIM       20
DISPALVL  DIM       20
DISPUDF1  DIM       20
DISPUDF2  DIM       20
DISPUDF3  DIM       20
DISPUDF4  DIM       20
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
ALHSTCLR  DIM       100        * Allied Health Status Color
DISPDATE  DIM       11
DISPDTTM  DIM       32
DISPBEDD  DIM       32
DISPDDSC  DIM       22
DISPFLAG  FORM      1          * Display format flag
DISPRWRD  DIM       7
DISPWRDT  DIM       8          * Ward bed request ready date
DISPWRTM  DIM       8          * Ward bed request ready time
DOCTCODE  DIM       10         * Doctor Code
DOCSNAM6  DIM       6          * First 6 characters of doctors surname
DRTRUE    DIM       1          * Default Doctor Code from websecaf
DUPNMFLG  FORM      1          * Duplicate name flag
DURAHHMM  DIM       5          * Visit duration 
GETWBDSC  FORM      1          * Indicator to get ward desc from wbdesc
GPCODE    DIM       10
HCPSHNME  DIM       37         * HCP short name ('A.Smith')
NBSP      INIT      "&nbsp;"
NURSHNME  DIM       37         * Nurse short name ('A.Smith')
NURSCODE  DIM       10         * Nurse Code
NURSNAM6  DIM       6          * First 6 characters of nurse surname
SJOGNAME  DIM       127        * SJOG Patient name format
SLCTVTYP  DIM       5          * Select available view types
SRCHCODE  DIM       3          * Responsibility filter
SRCHTYPE  FORM      1
SHOWFLAG  DIM       1
SHOWSITE  FORM      1          * Show site filter of current patient list
STOPDTIM  DIM       16
STRMSORT  DIM       1          * Stream sort indicator
STRMICON  DIM       127        * Stream Icon
UNITDISP  DIM       30         * Unit Description
READYADM  FORM      1          * Ready for admission
RESADESC  DIM       20         * Reaseach description
FOLODESC  DIM       20         * Follow Up Outcome Description
LONGDESC  DIM       50         * FOLODESC Long Description
COMPDISP  DIM       50         * Compliant Description
REFRESH   DIM       2          * Default Refresh Time
REQSTDIS  DIM       10         * Ward bed request display
RESPNAME  DIM       50         * Responsiblity Doctor
RESPNURE  DIM       50         * Responsibility Nurse
REMOREAS  DIM       20
TRANDESC  DIM       20
TSRCDESC  DIM       30
CUIDNAME  DIM       30  
LASTIPOP  FORM      1          * IP/OP within the last XXX hours
PRESCOMP  DIM       20
SENDNAME  DIM       50         * Senior Doctor Name
DISCNAME  DIM       8          * Discharge Title Name 
DISPATSR  DIM       20         * Display Attenance Source
DISPACPS  DIM       20         * Display Accepting Source
DISPACPT  DIM       20         * Display Accepting Source Trauma
DISPTRIG  DIM       1          * Display triage Code on Route
DISPTRNS  DIM       50         * Display triage nurse
DISPUR04  DIM       50         * Display user defined doctor 4
DISPMPRA  DIM       50         * Display Mental Health Practitioner
FILTLOCN  DIM       3          * Location filter
FILTSITE  DIM       3          * Site filter
FILTSTRM  DIM       3          * Stream filter (EMVIUC16 - Cat 'eh')
FOLDERSF  DIM       3          * Patient Folder suffix
HCPFNAME  DIM       127        * I CAR 13038
HISTDATE  DIM       8
HISTTIME  DIM       5
NEWLOCAT  DIM       3
BOLDON    INIT      "<b>"
BOLDOFF   INIT      "</b>"
.
SAVEADMN  DIM       8
SAVENCOM  FORM      1
SAVEDATE  DIM       8
SAVEDCOM  FORM      1
SAVEDOCT  DIM       10
SAVENURS  DIM       10
SAVEDRDT  DIM       8
SAVEDRTM  DIM       6
SAVESITE  DIM       3
SAVENRDT  DIM       8
SAVENRTM  DIM       6
SAVEKEY6  DIM       6
SAVELOCN  DIM       3
SAVKEY8   DIM       8
SVWBDESC  DIM       20                 * Save ward desc patwr1af.wbdesc
ADSNAME   DIM       40 
ADGNAME   DIM       40 
ADTITLE   DIM       4  
ADMRDISP  DIM       4
ADMRND28  DIM       4
CCYY      DIM       4
COMM127   DIM       127
CONSNAME  DIM       127
CONINIT   DIM       3
CODEDESC  DIM       40
DISPSTAT  DIM       20
DISPUC16  DIM       20
DISPUC28  DIM       20
.
DISPAGE   DIM       4
AGEINDAY  DIM       6         * output for age in days
.
DISDIAG   DIM       40
DISDIA2   DIM       40
DISDIAGF  DIM       100
DISDIAG2  DIM       120
DOCINIT   DIM       3
DPTVADES  DIM       127
DTRIG     DIM       3
FORM3     FORM      3
FORM8     FORM      8
FURNO     FORM      8
HOUR      DIM       2
HTMLLNK1  DIM       227
HTMLLNK2  DIM       60
IMAGE     DIM       12
KEY1A     DIM       1
KEY1B     DIM       1
KEY3A     DIM       3
SAVLASDT  DIM       8
LNK2PRT   FORM      1
LOCACODE  DIM       3
LOCNDESC  DIM       20
LOCNCNTR  FORM      4
MANNCNTR  FORM      1
MANNOT01  DIM       61       * Management Notes line 1
MANNOT02  DIM       61       * Management Notes line 2
MANNOT03  DIM       61       * Management Notes line 3
MANNOT04  DIM       61       * Management Notes line 4
MANNOTDT  DIM       50       * Management Notes details line
MANUSRID  DIM       10       * Management Notes User ID
MANVSORT  DIM       6        * Management View Sort Order 
MIN       DIM       2
MTILEBOX  DIM       227
MULTSCNT  FORM      2
MULTSTRM  DIM       3[99]
PATCOUNT  FORM      3
PATTNAME  DIM       127
PRDGFLAG  FORM      1
PRESCM10  DIM       10
DOCTNAME  DIM       127
ADOCNAME  DIM       127
NEXTPAGE  DIM       2
NMPNUMB   DIM       20
OTHRFLAG  FORM      1
CLASDESC  DIM       20
CLASIN12  DIM       1
SRCEDESC  DIM       20
SRCEIN12  DIM       1
REPTOPTN  FORM      1
REPTTYPE  DIM       1
SDNAME    DIM       127
SDGNAME   DIM       127
SEC       DIM       2
SPSNAME   DIM       127
SPGNAME   DIM       127
SLOCNDES  DIM       127
SPTVADES  DIM       127
STRIGDES  DIM       127
SEMVICO1  DIM       127
SEMVICO2  DIM       127
TESTKEY   DIM       22
TRIGDESC  DIM       20
TRIGFLAG  FORM      1
UNKFLAG   FORM      1
UPDTTYPE  DIM       5
UPDATEKY  DIM       22
USERNAME  DIM       256
PASSWORD  DIM       256
STATIND   DIM       1
VDELAYED  DIM       1
VDISCHRD  DIM       1                  * discharged patient 
VENQUIRY  FORM      1
REMOFILT  DIM       1
.
NEXTPATN  FORM      9
NEXTADMN  DIM       10
TOTLCNT   FORM      2
TOTADMNS  FORM      3
WAITCNT   FORM      2
WORKDATE  DATE      8
OTHRCNT   FORM      2
UNSEECNT  FORM      2
DOCINC    FORM      2
NURINC    FORM      2
PSCINC    FORM      2
CNT       FORM      2
DIM1IND6  DIM       1
DIM3      DIM       3
DIM10     DIM       10
DIM16     DIM       16
DIM16A    DIM       16
DIM80     DIM       80
DIM100    DIM       100
OTHERPAT  FORM      3
OTHRCLIN  DIM       10
WAITRPAT  FORM      3
USEENPAT  FORM      3
EDDISDIA  DIM       70                 * WA health ED discharge diagnosis
AWRDDESC  DIM       20
AWRBDESC  DIM       45
EWRDDESC  DIM       20
EWRBDESC  DIM       45
EXPECTPT  FORM      3
EXPDDISC  DIM       129
TOTALPAT  FORM      3
XLOCNPAT  FORM      3
DIM20     DIM       20
DIM120    DIM       120
BREAKLIN  INIT      "<br>"
CURRDATE  DIM       8
MANFTYPE  DIM       1
MANDINUR  FORM      1
COUNT     FORM      2
FORM5     FORM      5
TYPE4     INIT      "004"
TYPE5     INIT      "005"
UNKNOWN   INIT      "UNK"
NUMBILPT  FORM      3              
NUMPSCPT  FORM      3
DOCINCOM  FORM      2
NURINCOM  FORM      2
NEXTSEQN  DIM       9
NEXTSEQS  DIM       3 
WAITTIME  FORM      4
WAITHHMM  DIM       5
DURATIME  FORM      6
F4A       FORM      4
AARRTIME  FORM      4
LOSTIME   DIM       4             * Length Of Stay (arrival to current)excl disc
LOSDTIME  DIM       4             * Length Of Stay (arrival to current) for disc
SFDSTIME  FORM      4             * SFDS since first doctor seen time
_SFDTIME  FORM      4             * temp variable to store calculated time SFDS
_SFDTEMP  DIM       4
.
VISXDCIN  FORM      1
.
ADMITFLG  FORM      1             * Admit Flag - patient waiting for 9 hours
TESTDTIM  DIM       16
TESTDATE  DIM       8
TESTTIME  DIM       8
TIND3     DIM       1
.
TDCODNME  DIM       10            * Transfer Destination Coded Name output
DEFTVIEW  FORM      1
VIEWTYDF  DIM       1
STREMDSC  DIM       20
.
TEMPVAR1  DIM       100
TEMPVAR2  DIM       150
TEMPVAR3  DIM       350
.
ETSVISFL  FORM      1             * ETS Visits Flag (Current Patients List)
ETSLOCFL  FORM      1             * ETS Location Flag
HOSPNAME  DIM       25            * Hospital Name
SITENAME  DIM       25            * Site Name
LASTVISN  DIM       8             * Last visit number
FILTDOCT  DIM       6             * Doctor/Clinician filter
SAVELDAT  DIM       8             * Saves date from adm/att lists 
.
SP100     INIT      "                                   ":
                    "                                   ":
                    "                              "
.--------------------------------------
. Mandatory Fields Array
.--------------------------------------
MSGARRNO  FORM      2
MSGARR    DIM       50[10]
MANDFLD   INIT      "Mandatory - "
XPRIDIAG  DIM       6      * Primary Diagnosis
XADDIAG1  DIM       6      * Additional Diagnosis 1
.
.   TIMEDIFF VARIABLES
.
.FIRSTDAT  DIM       8
.LASTDATE  DIM       8
.FIRSTIME  DIM       4
.LASTTIME  DIM       4
.CALCTIME  FORM      6
.CDYSDAYS  FORM      6
.CDYSFDTE  DIM       8
.CDYSTDTE  DIM       8
.CDYSYEAR  FORM      2
.FIRSTHR   DIM       2
.FIRSTMIN  DIM       2
.LASTHOUR  DIM       2
.LASTMIN   DIM       2
.HOUR1     FORM      6
.HOUR2     FORM      6
.MINUTE1   FORM      3
.MINUTE2   FORM      3
.TOTTIME1  FORM      4
.TOTTIME2  FORM      4
.
CATA      INIT      "A "
CATS      INIT      "S "
CATAA     INIT      "AA"
CATED     INIT      "ED"
CATEH     INIT      "eh"
CATES     INIT      "es"
CATET     INIT      "et"
CATEU     INIT      "eu"
CATEW     INIT      "ew"
CATYQ     INIT      "YQ"
CATYW     INIT      "YW"
CATTC     INIT      "tc"
NINETY1   FORM      "91"
TRIAGE    INIT      "triage"
GIF       INIT      ".gif"
ZEROS     INIT      "000"  
ZERO20    INIT      "00000000000000000000"
.
OPTNONE   INIT      "- Current Patients"
OPTNTWO   INIT      "- Incomplete EMR Visits"
OPTNTHR   INIT      "- Incomplete EMR Registrations"
OPTNFOR   INIT      "- Daily EMR Attendances"
.
PIPE      INIT      "|"
COMPDIAG  DIM       200
FHRSUBIN  FORM      1     * Include Subject Resource (Patient)
FHRLOCIN  FORM      1     * _include=Encounter:location
FHRPARIN  FORM      1     * _include=Encounter:participant
DIM8      DIM       8
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
DASH      INIT      "-"
.
.----------------------------------------------------------------------
PRGID     INIT      "EMRWEB01"
VERSION   INIT      "V12.01.01"
PRGNAM    INIT      "Emergency List Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      IBACLOCK
          CALL      CURPER00
          CALL      CALCDT00
.
          MOVE      WBSEESC,KEY3
          CALL      RDEMSIT1
          IF        OVRCD=1
            MOVE      "Emergency Site Invalid",WEBTITLE
            CALL      WEBERR00
            GOTO      MAIN1000
          ENDIF 
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.                            Current     Emergency patients 
.                            Patients    by date range
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  MOVE      WBTPDES,WEBTITLE        * template description
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      MAIN1000
.
MAIN1200  MOVE      WBTPDES,WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      MAIN1000 
.
MAIN1300  CALL      UPPATL00                * Update Patient Location
          BRANCH    EXIT,MAIN1000
          MOVE      "01",REPORTNO
          MATCH     "1",NEXTPAGE
          IF        @EQUAL
            CALL      WINCLS00
            GOTO      MAIN1000
          ENDIF
.
          MATCH     "2",NEXTPAGE
          IF        @EQUAL
            CALL      SPCCLS00
            GOTO      MAIN1000
          ENDIF
.
          GOTO      MAIN1100 
.
MAIN1400  MATCH     SP70,SELPRINT
          IF        @EQUAL
            MOVE      "Printer Selection Required",WEBTITLE
            CALL      WEBERR00
          ELSE
            CALL      WINCLS00
            CALL      PRTLST00
          ENDIF
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
SPCCLS00  CALL      OPENHTML
          BRANCH    EXIT,SPCCLS99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#" ":
                               "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame();} ":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame();} ":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
SPCCLS99  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  MOVE      SP70,PGM
          CALL      INTMAS00
          CALL      GETTZ000
       
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      EMRMTXA3,"emrmtxaf"
          OPEN      OPRNURA1,"oprnuraf" 
          OPEN      EMRDCMA1,"emrdcmaf"
          OPEN      EMRWFMA1,"emrwfmaf"
          OPEN      EMRWFMA2,"emrwfmaf"
          OPEN      EMRWFMA3,"emrwfmaf"
          OPEN      EMRWFMA4,"emrwfmaf"
          OPEN      PMSPX2A1,"pmspx2af" 
          OPEN      PMSHCPA1,"pmshcpaf" 
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"
          OPEN      EMRCMTA1,"emrcmtaf" 
          OPEN      EMRISMA1,"emrismaf"
          OPEN      EMRINCA1,"emrincaf"
          OPEN      EMREXPA1,"emrexpaf"
          OPEN      EMREXPA4,"emrexpaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      PMSBRQA1,"pmsbrqaf"
          OPEN      PMSBRQA2,"pmsbrqaf"
          OPEN      PMSNUTA1,"pmsnutaf"
          OPEN      EMRDELA1,"emrdelaf"
          OPEN      EMRUTYA1,"emrutyaf"
          OPEN      EMRHISA1,"emrhisaf"
          OPEN      EMRLOCA1,"emrlocaf"
          OPEN      EMRLOCA2,"emrlocaf"
          OPEN      EMRLOCA3,"emrlocaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRVISA2,"emrvisaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA6,"emrvisaf"
          OPEN      EMRVISA4,"emrvisaf" 
          OPEN      EMRVISA5,"emrvisaf" 
          OPEN      EMRVISA7,"emrvisaf" 
          OPEN      EMRUNKA1,"emrunkaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATCRCA1,"patcrcaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      PMSCURA2,"pmscuraf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      EMRCLIA1,"emrcliaf"
          OPEN      EMRBPSA2,"emrbpsaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATNOBE1,"patnobef"
          OPEN      OUTBOKA5,"outbokaf"    
.
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTLOCA1,"mrtlocaf"
.
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      PMSCDNA1,"pmscdnaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      PATALTT1,"pataltaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D
          READ      CONTROLF,EIGHTY9;*144,EMCNDOCT,*188,EMCNWTTM:
                                     *194,EMCNLOSW,*222,EMCNRETC:
                                     *224,EMCNDPRS,*225,EMCNPCEL
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND05;*180,PTCNTIMN
          READ      CONTROLF,HUND12;*104,PTCNWBDS,*106,PTCNBEDM
          READ      CONTROLF,EIGHTY9;*231,EMCNMSRS,*236,EMCNDDSS:
                                     *237,EMCNSFSM
          READ      CONTROLF,HUND22;*2,EMCNSCLK,*8,EMCNURSE,*13,EMCNPTTI:
                                    *14,EMCNTINU,*27,EMCNHISA
          READ      CONTROLF,HUND25;*93,PTCNNSSI
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      PMSCURA6,"pmscuraf"
          ENDIF
.
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRSCMA1,"emrscmaf"         * Site-based comments/notices
.
          CALL      OPICD1                      * Open ICD Disease files
.
          MOVE      ZERO,VISXDCIN
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      VISXDCA1,"visxdcaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,VISXDCIN
          ENDIF
.
          OPEN      EMRTHSA1,"emrthsaf"
          OPEN      EMRTHSA2,"emrthsaf"
          OPEN      EMRTHSA3,"emrthsaf"
          OPEN      EMRTHSA4,"emrthsaf"
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
INIT9999  RETURN
.
.------------------------------------------------------------
. Open Outpatient files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
OPNOUT99  RETURN
.
.*******************************************************************************
.                     Check Correct Files are Open for System
.*******************************************************************************
OUTFIL00  PACK      KEY6,PVISITE,SP70
          CALL      RDSITA1
          IF        OVRCD=1
            MOVE      "out",OSTFILE          * Default site to out
          ENDIF
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
OUTFIL99  RETURN
+
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,CHECKGP 
          MOVE      ZERO,FHRSUBIN 
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,RECNUMB 
          PACK      VYEARMTH,SP70
          MOVE      SP70,TEMPLATE
          MOVE      SP70,SELPRINT
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,NEXTPAGE
          MOVE      ZERO,VIEWTYPE
          MOVE      ZERO,DEFTVIEW
          MOVE      SP70,LOCACODE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,UPDATEKY
          MOVE      SP256,USERNAME
          MOVE      SP256,PASSWORD
          MOVE      ZERO,UNKFLAG
          MOVE      ZERO,REPTOPTN
          MOVE      SP70,REPTTYPE
          MOVE      SP70,DOCTCODE
          MOVE      SP70,NURSCODE
          MOVE      SP70,SRCHCODE
          MOVE      SP70,FILTLOCN
          MOVE      SP70,FILTSTRM
          MOVE      SP70,SHOWFLAG
          MOVE      ZERO,VENQUIRY
          MOVE      SP70,FILTSITE
          MOVE      ZERO,SHOWSITE
          MOVE      SP70,BCKTOTRI
          MOVE      SP70,VIEWTYDF
          MOVE      SP70,CONTFILT
          MOVE      SP70,REMOFILT
.
          MOVE      ZERO,MULTSCNT
          MOVE      ONE,COUNT
          WHILE     COUNT <= 98
            MOVE      SP70,MULTSTRM[COUNT]
            ADD       ONE,COUNT
          DO
          MOVE      ZERO,COUNT
.
          MOVE      SP70,SAVELOCN      * clear saved location
.
          MOVE      SP70,DRTRUE        * default Doctor Code from websecaf
          MOVE      SP70,LASTVISN
          MOVE      SP70,FILTDOCT
          MOVE      ZERO,ETSVISFL      * clear ETS Visits flag
          MOVE      ZERO,ETSLOCFL      * clear ETS Location flag
          MOVE      SP70,REFRESH       * default Refresh Time
          MOVE      Z70,DISEDSSU      
          MOVE      ZERO,GETWBDSC
          MOVE      SP70,SVWBDESC
          MOVE      SP70,DEFTVTYP
          MOVE      SP70,SLCTVTYP
          MOVE      SP70,LOCADATE
          MOVE      SP70,LOCATIME
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtydf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "locacode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LOCACODE
            PACK      LOCACODE,LOCACODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "password=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PASSWORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "username=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USERNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updateky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "repttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reptoptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPTOPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nurscode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NURSCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtlocn=",QRYNAME
          IF        @EQUAL
            PACK      FILTLOCN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstrm=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTRM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            PACK      SHOWFLAG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "venquiry=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VENQUIRY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtsite=",QRYNAME
          IF        @EQUAL
            PACK      FILTSITE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showsite=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWSITE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bcktotri=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BCKTOTRI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contfilt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONTFILT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remofilt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOFILT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "multstrm=",QRYNAME
          IF        @EQUAL
            ADD       ONE,MULTSCNT
            PACK      MULTSTRM[MULTSCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "drtrue",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DRTRUE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refresh",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRESH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disedssu=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISEDSSU
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftvtyp=",QRYNAME
          IF        @EQUAL
            PACK      DEFTVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slctvtyp=",QRYNAME
          IF        @EQUAL
            PACK      SLCTVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "locadate",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      LOCADATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "locatime=",QRYNAME
          IF        @EQUAL
            PACK      LOCATIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      EMRF0000    * Emergency List
          GOTO      PROFLD99
.
PROFLD12  CALL      SELPRT00
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      EMRD0000    * Emergency Patients by date
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Emergency List
.------------------------------------------------------------
EMRF0000  BRANCH    FLDITMNO,EMRF0100,EMRF0200,EMRF0300,EMRF0400,EMRF0500:
                             EMRF0600,EMRF0700,EMRF0800,EMRF0900,EMRF1000:  *10
                             EMRF1100,EMRF1200,EMRF1300,EMRF1400,EMRF1500:
                             EMRF1600,EMRF1700,EMRF1800,EMRF1900,EMRF2000:  *20
                             EMRF2100,EMRF2200,EMRF2300,EMRF2400,EMRF2500:
                             EMRF2600,EMRF2700,EMRF2800,EMRF2900,EMRF3000:  *30
                             EMRF3100,EMRF3200,EMRF3300,EMRF3400,EMRF3500:
                             EMRF3600,EMRF3700,EMRF3800,EMRF3900,EMRF4000:  *40
                             EMRF4010,EMRF4020,EMRF4030,EMRF4040,EMRF4050:
                             EMRF4060,EMRF4070,EMRF4080,EMRF4090,EMRF5000:  *50
                             EMRF5100,EMRF5200,EMRF5300,EMRF5400,EMRF5500:
                             EMRF5600,EMRF5700,EMRF5800,EMRF5900,EMRF6000:  *60
                             EMRF6100,EMRF6200,EMRF6300,EMRF6400,EMRF6500:
                             EMRF6600,EMRF6700,EMRF6800,EMRF6900,EMRF7000:  *70
                             EMRF7100,EMRF7200,EMRF7300,EMRF7400,EMRF7500:  
                             EMRF7600,EMRF7700,EMRF7800,EMRF7900,EMRF8000:  *80
                             EMRF8100,EMRF8200,EMRF8300,EMRF8400,EMRF8500:
                             EMRF8600
          GOTO      EMRF9999
.
EMRF0100  MOVE      "0",LNK2PRT
.
          MATCH     SP70,FILTSITE      * Default site filter to current site
          IF        @EQUAL
            MOVE      WBSEESC,FILTSITE
          ENDIF
.
          CALL      PATVIS00    * Current emergency patient visits
          GOTO      EMRF9999
.
EMRF0200  CALL      INCVIS00    * Incomplete emergency patient visits  
          GOTO      EMRF9999
.
EMRF0300  CALL      INCREG00    * Incomplete emergency patient registrations
          GOTO      EMRF9999
.
EMRF0400  MOVE      ONE,LNK2PRT
          MOVE      ZERO,TRIGFLAG      * Do not allow triage
          CALL      VISLOC00    * Visits by location
          GOTO      EMRF9999
.
EMRF0500  MOVE      TWO,LNK2PRT
          MOVE      ZERO,TRIGFLAG      * Do not allow triage
          CALL      VISLOC00    * Visits by location with Update Parent
          GOTO      EMRF9999
.
EMRF0600  MOVE      "999999999",NEXTPATN
          MOVE      SP70,NEXTADMN
          MOVE      ZERO,TOTLCNT
          MOVE      ZERO,WAITCNT
          MOVE      ZERO,UNSEECNT
          MOVE      ZERO,OTHRCNT
.    
          CALL      EMERGV00
          GOTO      EMRF9999
.
EMRF0700  CALL      CALCT000            * Calculate Total Patients 
          GOTO      EMRF9999
.
EMRF0800  CALL      CALCE000            * Calculate Expected Patients 
          GOTO      EMRF9999
.
EMRF0900  CALL      CALCW000            * Calculate Waiting Room Patients 
          GOTO      EMRF9999
.
EMRF1000  CALL      CALCS000            * Calculate UnSeen Patients 
          GOTO      EMRF9999
.
EMRF1100  CALL      CALCL000            * Calculate Patients in other Rooms 
          GOTO      EMRF9999
.
EMRF1200  CALL      CALCD000            * Calculate Doctor Incomplete Patients  
          GOTO      EMRF9999
.
EMRF1300  CALL      CALCN000            * Calculate Nurse Incomplete Patients  
          GOTO      EMRF9999
.
EMRF1400  CALL      CALCP000            * Calculate PSC                        
          GOTO      EMRF9999
.
EMRF1500  PACK      KEY8,NEXTADMN,SP70  * Next Patients Name
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
.
          MATCH      "       0",EMVIURNO        
          IF         !@EQUAL
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,EMRF9999
          ELSE
            PACK      KEY8,NEXTADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,EMRF9999
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            SFORMAT   FORMATNM,127
            STRIP     EMUNDET1 
            STRIP     EMUNDET2 
            PACK      FORMATNM,BOLDON,EMUNDET1,BOLDOFF,SP1,EMUNDET2,SP70
            STRIP     FORMATNM 
            GOTO      EMRF1510 
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000

EMRF1510  WRITE     HTMLFILE;FORMATNM;                      
          GOTO      EMRF9999
.
EMRF1600  PACK      KEY8,NEXTADMN,SP70  * Next Patients Location Code
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
.
          WRITE     HTMLFILE;EMVILOCN;                      
          GOTO      EMRF9999

EMRF1700  PACK      KEY8,NEXTADMN,SP70  * Next Patients Location Description 
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
. 
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1 
          BRANCH    OVRCD,EMRF9999
.
          WRITE     HTMLFILE;EMLODESC;                      
          GOTO      EMRF9999
.
EMRF1800  WRITE     HTMLFILE;NEXTADMN;                      
          GOTO      EMRF9999
.
EMRF1900  WRITE     HTMLFILE;NEXTADMN;                      
          GOTO      EMRF9999
.
EMRF2000  PACK      KEY8,NEXTADMN,SP70  * Next Patients U/R 
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
.
          WRITE     HTMLFILE;EMVIURNO;                      
          GOTO      EMRF9999
.
EMRF2100  WRITE     HTMLFILE;NEXTADMN;                      
          GOTO      EMRF9999
.
EMRF2200  CALL      EXPTB000           * Table of Expected Patients  
          GOTO      EMRF9999
.
EMRF2300  MOVE      ZERO,DISPFLAG
          CALL      WARTB000           * Table of Patients In Waiting Room  
          GOTO      EMRF9999
.
EMRF2400  MOVE      ZERO,DISPFLAG
          CALL      UNSTB000           * Table of Unseen Patients           
          GOTO      EMRF9999
.
EMRF2500  CALL      OTHTB000           * Table of Patients in other rooms  
          GOTO      EMRF9999
.
EMRF2600  CALL      DOCTB000           * Table of Doctors Incomplete        
          GOTO      EMRF9999
.
EMRF2700  CALL      NURTB000           * Table of Nurses Incomplete        
          GOTO      EMRF9999
.
EMRF2800  CALL      PSCTB000           * Table of PSC Incomplete Patients       
          GOTO      EMRF9999
.
EMRF2900  CALL      DOITB000           * Table of Doctor Incomplete Patients  
          GOTO      EMRF9999
.
EMRF3000  CALL      NUITB000           * Table of Nurses Incomplete Patients   
          GOTO      EMRF9999
.
EMRF3100  CALL      NOTTB000           * Emergency System notices             
          GOTO      EMRF9999
.
EMRF3200  CALL      SHMTB000           * Table of SHAME                       
          GOTO      EMRF9999
.
EMRF3300  PACK      KEY6,DOCTCODE,SP70     * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;                                        
          GOTO      EMRF9999
.
EMRF3400  MATCH     "1",EMCNURSE           * Use pmshcpaf for ED Nurse?
          GOTO      EMRF3410 IF EQUAL      * Yes 
.
.         CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
          PACK      KEY6,NURSCODE,SP70     * Get Nurses full name
          CALL      RDOPNUR1
          IF        OVRCD=1
            MOVE     SP70,OPNRCODE          * Clear all the file variables
            MOVE     SP70,OPNRSNAM
            MOVE     SP70,OPNRGNAM
            MOVE     SP70,OPNRUSR1
            MOVE     SP70,OPNRUSR2
            MOVE     SP70,OPNRUSR3
            MOVE     SP70,OPNRUSR4
            MOVE     SP70,OPNRUSR5
            MOVE     SP70,OPNRSTAT
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     OPNRGNAM,FMTGNAME
            MOVE     OPNRSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;                                        
          GOTO      EMRF9999
.
.         CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
EMRF3410  PACK      KEY10,NURSCODE,SP70     * Get Nurses full name
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL     CLPMSHCP
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      EMRF9999
.
EMRF3500  CALL      TILE0000
          GOTO      EMRF9999
.
EMRF3600  CALL      SRHLOC00
          GOTO      EMRF9999
.          
EMRF3700  PACK      KEY8,NEXTADMN,SP70  * Next Patients Location Description
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
.
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,EMRF9999
.
          WRITE     HTMLFILE;EMLOTYPE;
          GOTO      EMRF9999
.          
EMRF3800  CALL      DISTAB00           * Table of Patient Waiting for Discharge
          GOTO      EMRF9999
.
EMRF3900  WRITE     HTMLFILE;WBSEESC;  * Emergency site code for map display
          GOTO      EMRF9999
.
EMRF4000  WRITE     HTMLFILE;EMCNDOCT;  * Use patdo1af or emrdocaf file 
          GOTO      EMRF9999
.
EMRF4010  CALL      AWTTB000           * Table of Patients Awaiting Triage
          GOTO      EMRF9999
.
EMRF4020  MOVE      "1",LNK2PRT
          CALL      PATVIS00           * Current emergency patient visits
          GOTO      EMRF9999
.
EMRF4030  CALL      MAPEX000           * Display expected patients on map
          GOTO      EMRF9999
.
EMRF4040  CALL      CALCX000           * Calculate patients in location X
          GOTO      EMRF9999
.
EMRF4050  UNPACK    DIM127,D1,COUNTLOC,DIM127
.
          PACK      KEY8,NEXTADMN,SP70  * Next Patients Location Description
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMRF9999
.
          MATCH     COUNTLOC,EMVILOCN
          GOTO      EMRF9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ANSO;       * Next patient is in this location
          GOTO      EMRF9999
.
EMRF4060  MATCH     SP70,FILTLOCN                                             
          IF        @EQUAL
            WRITE     HTMLFILE;"All Locations";
          ELSE
            PACK      KEY3,FILTLOCN,SP70
            CALL      RDEMLOC1
            IF        OVRCD=1
              MOVE      FILTLOCN,EMLODESC
            ENDIF
            WRITE     HTMLFILE;EMLODESC;
          ENDIF
          GOTO      EMRF9999
.
EMRF4070  MOVE      ONE,DISPFLAG       * Map view top frame
          CALL      UNSTB000           * Table of Unseen Patients           
          GOTO      EMRF9999
.
EMRF4080  MOVE      ONE,DISPFLAG       * Map view top frame
          CALL      WARTB000           * Table of Patients In Waiting Room
          GOTO      EMRF9999
.
EMRF4090  MOVE      ONE,LNK2PRT
          MOVE      ONE,TRIGFLAG       * Allow triage
          CALL      VISLOC00           * Visits by location
          GOTO      EMRF9999
.
EMRF5000  CALL      TOTWRD00           * Total Admitted Patient in EOU
          GOTO      EMRF9999           * Not for ward only
.
EMRF5100  MOVE      "0",LNK2PRT
          CALL      PATVIS00           * Current emergency patient visits
          CALL      EOUVIS00           * Current EOU admissions with dischanged
          GOTO      EMRF9999           * emergency visits
.
EMRF5200  WRITE     HTMLFILE;VIEWTYPE;                      
          GOTO      EMRF9999
.
EMRF5300  PACK      KEY20,WBSEESC,Z70
          CALL      RSEMBPS2
EMRF5310  CALL      RPEMBPS2
          BRANCH    OVRCD,EMRF9999
.
          MATCH     WBSEESC,EMBPSTCD        * Same ED site code
          GOTO      EMRF9999 IF NOT EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     SP70,EMBPOFDT
          IF        !@EQUAL
            MATCH     EMBPOFDT,CURRDATE
            IF        @LESS
              MOVE      SP70,EMBPOFDT            * Off date in the future
               MOVE     SP70,EMBPOFTM            * Clear off date and time
            ENDIF
          ENDIF
.
          MATCH     SP8,EMBPOFDT
          GOTO      EMRF9999 IF NOT EQUAL
.
          MOVE      EMBPPTYP,F1        * 0 =Pre By-Pass,1 =By-Pass
          IF        F1 = 0              
            MATCH     SP70,EMBPOFDT
            GOTO      EMRF5320 IF EQUAL
            MATCH     SP70,EMBPOFTM
            GOTO      EMRF5320 IF EQUAL
.
            GOTO      EMRF5340
          ELSE             
            MATCH     SP70,EMBPOFDT
            GOTO      EMRF5330 IF EQUAL
            MATCH     SP70,EMBPOFTM
            GOTO      EMRF5330 IF EQUAL
.
            GOTO      EMRF5340
          ENDIF
. 
EMRF5320  WRITE     HTMLFILE;"<font size=2 color=green>":
                             "On Pre By-Pass":
                             "</font>";
          GOTO      EMRF9999
.
EMRF5330  WRITE     HTMLFILE;"<font size=2 color=red>":
                             "On By-Pass":
                             "</font>";
          GOTO      EMRF9999
.
EMRF5340  WRITE     HTMLFILE;" "; 
.
EMRF5400  CALL      WARTOT00           * Total Admitted Patient in Ward XXX
          GOTO      EMRF9999           * Not for ward only
.
EMRF5500  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      EMRF9999
.
EMRF5600  WRITE     HTMLFILE;VENQUIRY;
          GOTO      EMRF9999
.
EMRF5700  MOVE      WBSEESC,KEY3
          REP       " _",KEY3
          WRITE     HTMLFILE;KEY3;  * Emergency site code for map location display
          GOTO      EMRF9999
.
EMRF5800  MOVE      "eh",CATEGORY           * Nurse Code (Cat 'eh')
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      EMRF9999
.
EMRF5900  WRITE     HTMLFILE;FILTSTRM;      * Stream Filter (Cat 'eh')
          GOTO      EMRF9999
.
EMRF6000  CALL      NOTSIT00           * Emergency System Notices (Site-based)
          GOTO      EMRF9999
.
EMRF6100  CALL      EMRVIS00    * Current emergency patient visits by site (inc NEXTSEQN)
          GOTO      EMRF9999
.
EMRF6200  CALL      SELSIT00           * ED Site selection list filter
          GOTO      EMRF9999
.
EMRF6300  WRITE     HTMLFILE;SHOWSITE; * Show site code filter
          GOTO      EMRF9999
.
EMRF6400  CALL      EMLOC000           * Emergency Site Map Locations
          GOTO      EMRF9999
.
EMRF6500  WRITE     HTMLFILE;BCKTOTRI;
          GOTO      EMRF9999
.
EMRF6600  PACK      KEY20,WBSEESC,Z70
          CALL      RSEMBPS2
EMRF6610  CALL      RPEMBPS2
          BRANCH    OVRCD,EMRF9999
.
          MATCH     WBSEESC,EMBPSTCD        * Same ED site code
          GOTO      EMRF9999 IF NOT EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     SP70,EMBPOFDT
          IF        !@EQUAL
            MATCH     EMBPOFDT,CURRDATE
            IF        @LESS
              MOVE      SP70,EMBPOFDT            * Off date in the future
               MOVE     SP70,EMBPOFTM            * Clear off date and time
            ENDIF
          ENDIF
.
          MATCH     SP8,EMBPOFDT
          GOTO      EMRF9999 IF NOT EQUAL
.
          MOVE      EMBPPTYP,F1        * 0 =Pre By-Pass,1 =By-Pass
          IF        F1 = 0
            MATCH     SP70,EMBPOFDT
            GOTO      EMRF6620 IF EQUAL
            MATCH     SP70,EMBPOFTM
            GOTO      EMRF6620 IF EQUAL
.
            GOTO      EMRF6640
          ELSE
            MATCH     SP70,EMBPOFDT
            GOTO      EMRF6630 IF EQUAL
            MATCH     SP70,EMBPOFTM
            GOTO      EMRF6630 IF EQUAL
.
            GOTO      EMRF6640
          ENDIF
.
EMRF6620  UNPACK    EMBPONDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<font size=2 color=red>":
                             "On Pre By-Pass - ":
                             DISPDATE:
                             " @ ":
                             EMBPONTM:
                             "</font>";
          GOTO      EMRF9999
.
EMRF6630  UNPACK    EMBPONDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
          WRITE     HTMLFILE;"<font size=2 color=red>":
                             "On By-Pass - ":
                             DISPDATE:
                             " @ ":
                             EMBPONTM:
                             "</font>";
          GOTO      EMRF9999
.
EMRF6640  WRITE     HTMLFILE;" ";
          GOTO      EMRF9999
.
EMRF6700  CALL      NEXT0000    * Link to next day, week, month
          GOTO      EMRF9999
.
EMRF6800  CALL      PREV0000    * Link to previous day, week, month
          GOTO      EMRF9999
.
EMRF6900  CALL      SELV0000
          GOTO      EMRF9999
.
EMRF7000  WRITE     HTMLFILE;VIEWTYPE;  * View type
          GOTO      EMRF9999
.
EMRF7100  WRITE     HTMLFILE;VIEWTYDF;  * Default View type
          GOTO      EMRF9999
.
EMRF7200  CALL      ICOMB000            * Incomplete Billing List
          GOTO      EMRF9999
.
EMRF7300  CALL      CALCB000            * Calculate Billing Incomplete
          GOTO      EMRF9999
.
EMRF7400  CALL      EXPTC000
          GOTO      EMRF9999
.
EMRF7500  WRITE     HTMLFILE;CONTFILT;
          GOTO      EMRF9999
.
EMRF7600  WRITE     HTMLFILE;REMOFILT;
          GOTO      EMRF9999
.
EMRF7700  MOVE      "0",LNK2PRT
.
          MATCH     SP70,FILTSITE      * Default site filter to current site
          IF        @EQUAL
            MOVE      WBSEESC,FILTSITE
          ENDIF
.
          CALL      PATVIS00    * Current emergency patient visits
          GOTO      EMRF9999
.
EMRF7800  WRITE     HTMLFILE;DRTRUE;
          GOTO      EMRF9999
.
EMRF7900  CALL      CURETS00    * Current Patients List (Telehealth Service)
          GOTO      EMRF9999
.
EMRF8000  WRITE     HTMLFILE;REFRESH;  * Default Refresh Time
          GOTO      EMRF9999
.
EMRF8100  CALL      SELSAC00           * ED Site seln list filter (active only)
          GOTO      EMRF9999
.
EMRF8200  WRITE     HTMLFILE;DISEDSSU; * Display ED Short Stay Unit option
          GOTO      EMRF9999
.
EMRF8300  CALL      EMRVIS00           * Current ED pat visits by site
.
          MOVE      ONE,GETWBDSC       * Get ward desc from patwr1af.wbdesc
          CALL      EOUVIS00           * Current EOU adm with discharged EMR 
          MOVE      ZERO,GETWBDSC
.
          GOTO      EMRF9999       
.
EMRF8400  WRITE     HTMLFILE;DEFTVTYP; * Default view type 
          GOTO      EMRF9999
.
EMRF8500  WRITE     HTMLFILE;SLCTVTYP; * Select available view types
          GOTO      EMRF9999
.
EMRF8600  WRITE     HTMLFILE;DEFTVIEW; * default view
          GOTO      EMRF9999
.
EMRF9999  RETURN
+
.------------------------------------------------------------
. Calculate Billing Incomplete Total
.------------------------------------------------------------
CALCB000  MOVE      ZERO,NUMBILPT
.
          PACK      KEY12,WBSEESC,ONE,SP70
          CALL      RSEMVIS5
CALCB100  CALL      RKEMVIS5
          BRANCH    OVRCD,CALCB900
.
          MATCH     EMVISITE,WBSEESC
          GOTO      CALCB900 IF NOT EQUAL
.
          COMPARE   ONE,EMVISTAT
          GOTO      CALCB900 IF NOT EQUAL
.
          MATCH     SP70,EMVIDOCT
          GOTO      CALCB100 IF EQUAL      * No doctor allocated yet
          COMPARE   ONE,EMVIYN09
          GOTO      CALCB100 IF EQUAL      * Dr Billing Complete
          COMPARE   TWO,EMVIYN09
          GOTO      CALCB100 IF EQUAL      * No Dr Charge
.
          ADD       ONE,NUMBILPT
          GOTO      CALCB100
.
CALCB900  WRITE     HTMLFILE;NUMBILPT;
          RETURN
.
.------------------------------------------------------------
. Incomplete billing list
.------------------------------------------------------------
ICOMB000  PACK      KEY12,WBSEESC,ONE,SP70
          CALL      RSEMVIS5
ICOMB100  CALL      RKEMVIS5
          BRANCH    OVRCD,ICOMB999
.
          MATCH     EMVISITE,WBSEESC
          GOTO      ICOMB999 IF NOT EQUAL
.
          COMPARE   ONE,EMVISTAT
          GOTO      ICOMB999 IF NOT EQUAL
.
          MATCH     SP70,EMVIDOCT
          GOTO      ICOMB100 IF EQUAL      * No doctor allocated yet
.
          COMPARE   ONE,EMVIYN09
          GOTO      ICOMB100 IF EQUAL      * Dr Billing Complete
          COMPARE   TWO,EMVIYN09
          GOTO      ICOMB100 IF EQUAL      * No Dr Charge
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2
            PACK      KEY50,SP70
            STRIP     EMEXGNAM
            STRIP     EMEXSNAM
            PACK      KEY50,BOLDON,EMEXSNAM,BOLDOFF,COMMA,SP1,EMEXGNAM,SP70
            MOVE      KEY50,FORMATNM
            GOTO      ICOMB200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
ICOMB200  CALL      ICDOC000               * Get Billing in-complete doctor
          PACK      KEY6,KEY10,SP70        * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNKL
          APPEND    "javascript:OpenBill('",HTMLLNKL
          APPEND    EMVIURNO,HTMLLNKL
          APPEND    "','",HTMLLNKL
          APPEND    EMVIADMN,HTMLLNKL
          APPEND    "')",HTMLLNKL
          RESET     HTMLLNKL
.
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           *0
                             "#"",EMVIADMN,"#",":                    *1
                             "#"",EMVIURNO,"#",":                    *2
                             "#"",FORMATNM,"#",":                    *3
                             "#"",EMVIDATE,EMVITIME,"#",":           *4
                             "#"",EMVILOCN,"#",":                    *5
                             "#"",EMLODESC,"#",":                    *6
                             "#"",DOCFNAME,"#",":                    *7
                             "#"",HTMLLNKL,"#",":                    *8
                             "#"",KEY3,"#");"                        *9
.
          GOTO      ICOMB100
.
.
ICOMB999  RETURN
+
.------------------------------------------------------------
. Get Billing in-complete doctor
.------------------------------------------------------------
ICDOC000  MOVE      EMVIDOCT,KEY10
          PACK      KEY22,DEMVIADM,SP70
          CALL      RSEMHIS1
ICDOC100  CALL      RKEMHIS1
          BRANCH    OVRCD,ICDOC999
.
          MATCH     DEMVIADM,EMHIVIS
          GOTO      ICDOC999 IF NOT EQUAL
.
          MATCH     "ALDOC",EMHIUPT
          GOTO      ICDOC100 IF NOT EQUAL 
.
          MATCH     "1",EMHIDRBC
          GOTO      ICDOC100 IF EQUAL       * Dr Billing Complete
          MATCH     "2",EMHIDRBC
          GOTO      ICDOC100 IF EQUAL       * No Dr Charge
.
          MOVE      EMHIDOC,KEY10           * Billing in-complete doctor
ICDOC999  RETURN
+
.------------------------------------------------------------
. Emergency Map Location Output
.------------------------------------------------------------
EMLOC000  PACK      KEY28,SP70
          CALL      RSEMLOC2
EMLOC100  CALL      RKEMLOC2
          BRANCH    OVRCD,EMLOC999
          MATCH     WBSEESC,EMLOSCOD        * Same Site
          GOTO      EMLOC100 IF NOT EQUAL
          MATCH     "1",EMLOACTV        * Same Site
          GOTO      EMLOC100 IF EQUAL
          WRITE     HTMLFILE;"obj.AddLocation(#"",EMLODESC,"#",":
                             "#"",EMLOLOCA,"#",":
                             "0,0,0,0,0,0,":
                             "#"",EMLOTYPE,"#",":
                             "#"",EMLOMAXP,"#");"
          GOTO      EMLOC100
.
EMLOC999  RETURN
.-------------------------------------------------------------------------
. Calculate total current admissions for the emg sites hospital code in
. EMU beds. Cat BT with HDP=S and ind 8 = 0
.-------------------------------------------------------------------------
TOTWRD00  MOVE      ZERO,TOTADMNS
.
          PACK      KEY6,SP70
          CALL      RDSWARD1
TOTWRD10  CALL      RDKWARD1
          BRANCH    OVRCD,TOTWRD90
.
          BRANCH    WACTIVE,TOTWRD10     * Do not include inactive bed
.
          IF        IBCNMHOS=1
            MATCH     PTWDHOSN,EMSTHSNO
            GOTO      TOTWRD10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,TOTWRD10
.
          MATCH     "S",THCSCOD            * EOU Unit
          GOTO      TOTWRD10 IF NOT EQUAL
.
          MATCH     ANSO,TCINDC8           * Display EOU on map ward list
          GOTO      TOTWRD10 IF NOT EQUAL
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,TOTADMNS
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,TOTADMNS
          ENDIF
.
          GOTO      TOTWRD10
.
TOTWRD90  WRITE     HTMLFILE;TOTADMNS;
.
TOTWRD99  RETURN
.         
.-------------------------------------------------------------------------
. Calculate total current admissions for the emg sites hospital code in
. %EMRWEB01.01.053.XXX
. XXX = Ward code   
.------------------------------------------------------------
WARTOT00  UNPACK    DIM127,D1,COUNTLOC,DIM127
.
          MOVE      ZERO,TOTADMNS
.
          PACK      KEY6,COUNTLOC,SP70
          CALL      RDSWARD1
WARTOT10  CALL      RDKWARD1
          BRANCH    OVRCD,WARTOT50
.
          MATCH     COUNTLOC,WWARD
          GOTO      WARTOT50 IF NOT EQUAL
.
          BRANCH    WACTIVE,WARTOT10     * Do not include inactive bed
.
          IF        IBCNMHOS=1
            MATCH     PTWDHOSN,EMSTHSNO
            GOTO      WARTOT10 IF NOT EQUAL
          ENDIF
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,TOTADMNS
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,TOTADMNS
          ENDIF
.
          GOTO      WARTOT10
.
WARTOT50  PACK      KEY6,COUNTLOC,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARTOT90
.
          BRANCH    WACTIVE,WARTOT10     * Do not include inactive bed
.
          IF        IBCNMHOS=1
            MATCH     PTWDHOSN,EMSTHSNO
            GOTO      WARTOT90 IF NOT EQUAL
          ENDIF
.
          COMPARE   ZERO,WINPUT                   * Check if ward only or
          GOTO      WARTOT90 IF EQUAL             * ward/bed + ward only
.
          PACK      KEY13,WWARD,SP70
          CALL      RDSNOBE1
WARTOT60  CALL      RDKNOBE1
          BRANCH    OVRCD,WARTOT90
.
          MATCH     WWARD,NBWARD
          GOTO      WARTOT90 IF NOT EQUAL
.
          ADD       ONE,TOTADMNS
.
          GOTO      WARTOT60
.
WARTOT90  WRITE     HTMLFILE;TOTADMNS;
.
WARTOT99  RETURN
+
.------------------------------------------------------------
. Emergency System notices                       
.------------------------------------------------------------
NOTTB000  MOVE      ZERO,CNT
          PACK      KEY2,SP70
          CALL      RDEMCMT1
NOTTB100  CALL      RKEMCMT1
          BRANCH    OVRCD,NOTTB999
.
          COMPARE   NINTY9,CNT
          GOTO      NOTTB999 IF EQUAL 
.
          ADD       ONE,CNT
.
          PACK      DIM80,EMCMCMNT,BREAKLIN
          WRITE     HTMLFILE;DIM80;
.
          GOTO      NOTTB100
.
NOTTB999  RETURN
+
.------------------------------------------------------------
. Emergency System Notices (Site-based)
.------------------------------------------------------------
NOTSIT00  MOVE      ZERO,CNT
          PACK      KEY5,WBSEESC,SP70
          CALL      RSEMSCM1
NOTSIT10  CALL      RKEMSCM1
          BRANCH    OVRCD,NOTSIT99
.
          MATCH     WBSEESC,EMSCSITE
          GOTO      NOTSIT99 IF NOT EQUAL
.
          COMPARE   NINTY9,CNT
          GOTO      NOTSIT99 IF EQUAL
.
          ADD       ONE,CNT
.
          PACK      DIM80,EMSCCMNT,BREAKLIN
          WRITE     HTMLFILE;DIM80;
.
          GOTO      NOTSIT10
.
NOTSIT99  RETURN
+
.------------------------------------------------------------
. Table of SHAME                                 
.------------------------------------------------------------
SHMTB000  PACK      KEY11,ONE,SP70        * Readonly status of 1
          CALL      RSEMISM1
SHMTB100  CALL      RKEMISM1              * Read forward
          BRANCH    OVRCD,SHMTB999
.
          MATCH     "1",EMISTYPE          * not of status 1
          GOTO      SHMTB999 IF NOT EQUAL
.
          COMPARE   ZERO,EMISNOIN
          GOTO      SHMTB100 IF EQUAL
.
          PACK      KEY6,EMISCODE,SP70     * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectDoctor('",HTMLLINK
          APPEND    EMISCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMISNOIN,"#");"
.
          GOTO      SHMTB100
.
SHMTB999  RETURN
.------------------------------------------------------------
.         Title Display on Basis of Responsibility
.------------------------------------------------------------
TILE0000  MOVE      "EZ",CATEGORY
          MOVE      SRCHCODE,CODE
          CALL      GETCOD00
          MOVE      TCINDC1,F1
          BRANCH    F1,TILE1000,TILE2000,TILE3000
          GOTO      TILE2000
.
TILE1000  MOVE      "Clerk",DISCNAME
          GOTO      TILE9000
.
TILE2000  MOVE      "Doctor",DISCNAME
          GOTO      TILE9000
.
TILE3000  MOVE      "Nurse",DISCNAME
          GOTO      TILE9000
.
TILE9000  MOVE      ZERO,F1
          WRITE     HTMLFILE;DISCNAME;
TILE9999  RETURN
.------------------------------------------------------------
. Table of Expected Patients
.------------------------------------------------------------
EXPTB000  MOVE      WBSEESC,SAVESITE       * Save ED site
.
          PACK      KEY21,SAVESITE,SP70
          CALL      RSEMEXP4
EXPTB100  CALL      RKEMEXP4
          BRANCH    OVRCD,EXPTB999
.
          MATCH     SAVESITE,EMEXSITE
          GOTO      EXPTB999 IF NOT EQUAL
.
          MATCH     "0",EMEXDELT           * Triaged/Removed
          GOTO      EXPTB100 IF EQUAL
.
          PACK      KEY8,EMEXURNO,SP70     * Read Patient Master details
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2
            PACK      KEY50,SP70
            STRIP     EMEXGNAM
            STRIP     EMEXSNAM
            PACK      KEY50,BOLDON,EMEXSNAM,BOLDOFF,COMMA,SP1,EMEXGNAM,SP70
            MOVE      KEY50,FORMATNM
            GOTO      EXPTB200
          ELSE
            PACK      KEY8,EMEXURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name

EXPTB200  MOVE      "EA",CATEGORY
          MOVE      EMEXTRAN,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY30
.
          MOVE      SP70,DISPATSR
          MATCH     SP70,EMEXATSR
          IF        !@EQUAL
            MOVE      "em",CATEGORY
            MOVE      EMEXATSR,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPATSR
          ENDIF
.
          MOVE      SP70,DISPACPS
          MATCH     SP70,EMEXACPS
          IF        !@EQUAL
            MOVE      "ZQ",CATEGORY
            MOVE      EMEXACPS,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPACPS
          ENDIF
.
          MOVE      SP70,DISPACPT
          MATCH     SP70,EMEXACPT
          IF        !@EQUAL
            MOVE      "ZR",CATEGORY
            MOVE      EMEXACPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPACPT
          ENDIF
.
          MOVE      ZERO,DISPTRIG
          MATCH     SP70,EMEXTRIG
          IF        !@EQUAL
            MOVE      "AA",CATEGORY
            MOVE      EMEXTRIG,CODE
            CALL      GETCOD00
            MATCH     SP70,TCINDC1
            IF        @EQUAL
              MOVE      ZERO,DISPTRIG
            ELSE
              MOVE      TCINDC1,DISPTRIG
            ENDIF
          ENDIF
.
          MOVE      SP70,TDESC
          MOVE      "el",CATEGORY
          MOVE      EMEXCOMP,CODE
          CALL      GETCOD00
.
          PACK      KEY10,EMEXGPCD,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP              * Clear all the file variables
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     PMHCTITL,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          PACK      KEY10,EMEXCUID       * Gets web user name
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,KEY20
          ENDIF
          PACK      KEY20,WBSENAM,SP70
.
          PACK      KEY10,EMEXUUID       * Gets web user name Last updated
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.
          REP       "#"'",EMEXCOM1
          REP       "#"'",EMEXCOM2
          REP       "#"'",EMEXCOM3
          REP       "#"'",EMEXCOM4
          REP       "#"'",EMEXCOM5
          REP       "#"'",EMEXCOM6
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMEXUNIQ,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMEXURNO,"#",":               * 1
                             "#"",FORMATNM,"#",":
                             "#"",EMEXCOMP,"#",":
                             "#"",TDESC,"#",":
                             "#"",EMEXCOM1,"#",":               * 5
                             "#"",EMEXCOM2,"#",":
                             "#"",EMEXCOM3,"#",":
                             "#"",EMEXCOM4,"#",":
                             "#"",EMEXCOM5,"#",":
                             "#"",EMEXCOM6,"#",":               * 10
                             "#"",KEY30,"#",":
                             "#"",EMEXEDAT,"#",":
                             "#"",EMEXETIM,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",KEY20,"#",":                  * 15
                             "#"",EMEXCDAT,"#",":
                             "#"",EMEXCTIM,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",EMEXUDAT,"#",":
                             "#"",EMEXUTIM,"#",":               * 20
                             "#"",EMEXUNIQ,"#",":
                             "#"",EMEXATSR,"#",":
                             "#"",EMEXACPS,"#",":
                             "#"",EMEXACPT,"#",":
                             "#"",EMEXETAD,"#",":               * 25
                             "#"",EMEXETAT,"#",":
                             "#"",DISPATSR,"#",":
                             "#"",DISPACPS,"#",":
                             "#"",DISPACPT,"#",":
                             "#"",EMEXAMBL,"#",":               * 30
                             "#"",EMEXEXPL,"#",":
                             "#"",DISPTRIG,"#",":
                             "#"",EMEXETAD,EMEXETAT,"#");"
.
          GOTO      EXPTB100
.
EXPTB999  RETURN
.------------------------------------------------------------
. Table of Patients Waiting Rooms                         
.------------------------------------------------------------
WARTB000  PACK      KEY12,WBSEESC,ONE,SP70        * Readonly status of 1
          CALL      RSEMVIS5
WARTB100  CALL      RKEMVIS5             * Read forward
          BRANCH    OVRCD,WARTB999
.
          MATCH     EMVISITE,WBSEESC     * Exit if not currect site
          GOTO      WARTB999 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE         * Exit if not of status 1
          GOTO      WARTB999 IF NOT EQUAL
.
          MATCH     SP3,EMVILOCN
          GOTO      WARTB100 IF EQUAL
.
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,WARTB100
.
          MATCH     "W",EMLOTYPE
          GOTO      WARTB100 IF NOT EQUAL
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1            * Patient Master File
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2         * I-48257
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,WARTB100
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            PACK      KEY50,SP70
            STRIP     EMUNDET1
            STRIP     EMUNDET2
            PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
            MOVE      KEY50,FORMATNM
            GOTO      WARTB200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
WARTB200  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1    
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          CALL      SETEMR00
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
WARTB211  CALL      RKEMVCD1
          BRANCH    OVRCD,WARTB215
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      WARTB215 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      WARTB212 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      WARTB211 IF NOT EQUAL
.
WARTB212  MATCH     "000",EMVCSEQU
          GOTO      WARTB211 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
WARTB215  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          PACK      COMPDIAG,DISDIAGF,SP70,SP70
          MATCH     SP70,COMPDIAG
          GOTO      WARTB230 IF NOT EQUAL
.
          CLEAR     COMPDIAG
          APPEND    SEMVICO1,COMPDIAG
          APPEND    SP1,COMPDIAG
          APPEND    SEMVICO2,COMPDIAG
.
WARTB230  RESET     COMPDIAG
          STRIP     COMPDIAG
          REP       "#"'\/",COMPDIAG
.
          CALL      DOCTAT00
          CALL      DOCTSN00
          MATCH     SP70,RESPNAME
          IF        @EQUAL
            PACK      RESPNAME,SENDNAME,SP70
          ENDIF
.
          MOVE      SP70,AARRTIME
          CALL      GETLOS00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          PACK      DTRIG,EMVITRIG
          MATCH     DTRIG,SP3
          IF        @EQUAL
            PACK      DTRIG,ZEROS
          ENDIF
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
WARTB300  CALL      RKEMVCD1
          BRANCH    OVRCD,WARTB500 
          MATCH     DEMVIADM,EMVCVIST
          GOTO      WARTB500 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      WARTB350 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      WARTB300 IF NOT EQUAL
.
WARTB350  MATCH     "000",EMVCSEQU
          GOTO      WARTB300 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
WARTB500  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          CLEAR     HTMLLNK1
          APPEND    "javascript:TriagePatient('",HTMLLNK1
          APPEND    EMVIURNO,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    EMVIADMN,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    DTRIG,HTMLLNK1
          APPEND    "')",HTMLLNK1
          RESET     HTMLLNK1
.
          BRANCH    DISPFLAG,WARTB600
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMVIDRDT,"#",":
                             "#"",EMVIDRTM,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",EMVIEWRD,"#",":
                             "#"",DISDIAG,"#",":
                             "#"",DISDIAGF,"#",":
                             "#"",COMPDIAG,"#",":
                             "#"",RESPNAME,"#",":
                             "#"",AARRTIME,"#",":
                             "#"",EDDISDIA,"#",":
                             "#"",DTRIG,"#",":
                             "#"",HTMLLNK1,"#",":
                             "#"<input type=hidden value=",EMVITRIG,">#");"
.
          GOTO      WARTB100
.
WARTB600  WRITE     HTMLFILE;" obj.AddPatient(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",DTRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMVIDRDT,"#",":
                             "#"",EMVIDRTM,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",EMVIEWRD,"#",":
                             "#"",DISDIAG,"#",":
                             "#"",DISDIAGF,"#",":
                             "#"",COMPDIAG,"#",":
                             "#"",RESPNAME,"#",":
                             "#"",AARRTIME,"#",";
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",EDDISDIA,"#"";
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":
    "<img src=../images/ActionIcon.gif ":
    "onclick=document.SelectPeriod.acnurnum.value='",EMVIURNO,"';":
    "document.SelectPeriod.acnadmno.value='",DEMVIADM,"';":
    "document.SelectPeriod.acnestat.value='",EMVISTAT,"';":
    "AddClinNote(); border=0>&nbsp;&nbsp;",EDDISDIA,"#"";
.
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;");"
.
          GOTO      WARTB100
.
WARTB999  RETURN                       
.------------------------------------------------------------
. Table of UnSeen Patients
.------------------------------------------------------------
UNSTB000  PACK      KEY12,WBSEESC,ONE,SP70        * Readonly status of 1
          CALL      RSEMVIS5
UNSTB100  CALL      RKEMVIS5             * Read forward
          BRANCH    OVRCD,UNSTB999
.
          MATCH     EMVISITE,WBSEESC     * Exit if not currect site
          GOTO      UNSTB999 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE         * Exit if not of status 1
          GOTO      UNSTB999 IF NOT EQUAL
.
          MATCH     SP70,EMVIDOCT
          GOTO      UNSTB100 IF NOT EQUAL

          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1            * Patient Master File
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,UNSTB100
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            PACK      KEY50,SP70
            STRIP     EMUNDET1
            STRIP     EMUNDET2
            PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
            MOVE      KEY50,FORMATNM
            GOTO      UNSTB200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
UNSTB200  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1        
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      SETEMR00
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
UNSTB211  CALL      RKEMVCD1
          BRANCH    OVRCD,UNSTB215
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      UNSTB215 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      UNSTB212 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      UNSTB211 IF NOT EQUAL
.
UNSTB212  MATCH     "000",EMVCSEQU
          GOTO      UNSTB211 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
UNSTB215  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          PACK      COMPDIAG,DISDIAGF,SP70,SP70
          MATCH     SP70,COMPDIAG
          GOTO      UNSTB230 IF NOT EQUAL
.
          CLEAR     COMPDIAG
          APPEND    SEMVICO1,COMPDIAG
          APPEND    SP1,COMPDIAG
          APPEND    SEMVICO2,COMPDIAG
.
UNSTB230  RESET     COMPDIAG
          STRIP     COMPDIAG
          REP       "#"'\/",COMPDIAG
.
          MOVE      SP70,AARRTIME
          CALL      GETLOS00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00
.
          PACK      STREMDSC,SP70
          PACK      TDESC,SP70
          MOVE      "eh",CATEGORY
          MOVE      EMVIUC16,CODE
          CALL      GETCOD00
          MOVE      TDESC,STREMDSC
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          PACK      DTRIG,EMVITRIG
          MATCH     DTRIG,SP3
          IF        @EQUAL
            PACK      DTRIG,ZEROS
          ENDIF
.
          CLEAR     HTMLLNK1
          APPEND    "javascript:TriagePatient('",HTMLLNK1
          APPEND    EMVIURNO,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    EMVIADMN,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    DTRIG,HTMLLNK1
          APPEND    "')",HTMLLNK1
          RESET     HTMLLNK1
.
          MOVE      SP70,DISPSTAT
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,STATIND
            ELSE
              MOVE      TCINDC2,STATIND
            ENDIF
          ENDIF
.
          BRANCH    DISPFLAG,UNSTB600
.
UNSTB500  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",KEY10,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",EMVILOCN,"#",":
                             "#"",EMLODESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",STREMDSC,"#",":
                             "#"",COMPDIAG,"#",":
                             "#"",AARRTIME,"#",":
                             "#"",EDDISDIA,"#",":
                             "#"",DTRIG,"#",":
                             "#"",HTMLLNK1,"#",":
                             "#"<input type=hidden value=",EMVITRIG,">#");"
.
          GOTO      UNSTB100
.
UNSTB600  WRITE     HTMLFILE;" obj.AddPatient(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",KEY10,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",EMVILOCN,"#",":
                             "#"",EMLODESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",STREMDSC,"#",":
                             "#"",COMPDIAG,"#",":
                             "#"",AARRTIME,"#",";
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",EDDISDIA,"#"";
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":
    "<img src=../images/ActionIcon.gif ":
    "onclick=document.SelectPeriod.acnurnum.value='",EMVIURNO,"';":
    "document.SelectPeriod.acnadmno.value='",DEMVIADM,"';":
    "document.SelectPeriod.acnestat.value='",EMVISTAT,"';":
    "AddClinNote(); border=0>&nbsp;&nbsp;",EDDISDIA,"#"";
.
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;");"
.
          GOTO      UNSTB100
.
UNSTB999  RETURN
.------------------------------------------------------------
. Table of Patients In Other Rooms
.------------------------------------------------------------
OTHTB000  MATCH     SP70,FILTLOCN
          IF        !@EQUAL
            CALL      OTHTL000
            GOTO      OTHTB999
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSEMLOC1
OTHTB100  CALL      RKEMLOC1
          BRANCH    OVRCD,OTHTB999
.
          MATCH     "O",EMLOTYPE
          GOTO      OTHTB100 IF NOT EQUAL
.
          PACK      KEY11,EMLOLOCA,SP70
          CALL      RSEMVIS7
OTHTB150  CALL      RKEMVIS7
          BRANCH    OVRCD,OTHTB100
.
          MATCH     EMLOLOCA,EMVILOCN
          GOTO      OTHTB100 IF NOT EQUAL
.
          COMPARE   EMVISTAT,FOUR
          GOTO      OTHTB150 IF EQUAL
.
          IF        EMVISTAT=TWO | EMVISTAT=THREE
            COMPARE   ONE,EMVIADMT
            GOTO      OTHTB150 IF NOT EQUAL
          ENDIF
.
          MATCH     EMVISITE,WBSEESC
          GOTO      OTHTB150 IF NOT EQUAL
.
          CALL      EMHIST00    * Set Up History details
.
          PACK      KEY8,EMVIURNO,SP70     * Read Patient Master details
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2             * I-48257
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,OTHTB150
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            PACK      KEY50,SP70
            STRIP     EMUNDET1
            STRIP     EMUNDET2
            PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
            MOVE      KEY50,FORMATNM
            GOTO      OTHTB200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
OTHTB200  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME                        
            CALL     DOCNM000                               
          ENDIF                                             
.                                              
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      SETEMR00
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
OTHTB211  CALL      RKEMVCD1
          BRANCH    OVRCD,OTHTB215
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      OTHTB215 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      OTHTB212 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      OTHTB211 IF NOT EQUAL
.
OTHTB212  MATCH     "000",EMVCSEQU
          GOTO      OTHTB211 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
OTHTB215  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          PACK      COMPDIAG,DISDIAGF,SP70,SP70
          MATCH     SP70,COMPDIAG
          GOTO      OTHTB230 IF NOT EQUAL
.
          CLEAR     COMPDIAG
          APPEND    SEMVICO1,COMPDIAG
          APPEND    SP1,COMPDIAG
          APPEND    SEMVICO2,COMPDIAG
.
OTHTB230  RESET     COMPDIAG
          STRIP     COMPDIAG
          REP       "#"'\/",COMPDIAG
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       " +",EMVIURNO
          REP       " +",DEMVIADM
.
          CLEAR     HTMLLNKL
          APPEND    "javascript:OpenLocation('",HTMLLNKL
          APPEND    EMVIURNO,HTMLLNKL
          APPEND    "','",HTMLLNKL
          APPEND    EMVIADMN,HTMLLNKL
          APPEND    "')",HTMLLNKL
          RESET     HTMLLNKL
.
          REP       "+ ",EMVIURNO
          REP       "+ ",DEMVIADM
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          PACK      DTRIG,EMVITRIG
          MATCH     DTRIG,SP3
          IF        @EQUAL
            PACK      DTRIG,ZEROS
          ENDIF
.
          CLEAR     HTMLLNK1
          APPEND    "javascript:TriagePatient('",HTMLLNK1
          APPEND    EMVIURNO,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    EMVIADMN,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    DTRIG,HTMLLNK1
          APPEND    "')",HTMLLNK1
          RESET     HTMLLNK1
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",HISTDATE,"#",":
                             "#"",HISTTIME,"#",":
                             "#"",EMVILOCN,"#",":
                             "#"",EMLODESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",HISTDATE,HISTTIME,"#",":
                             "#"",COMPDIAG,"#",";
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",EDDISDIA,"#",";
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":
    "<img src=../images/ActionIcon.gif ":
    "onclick=document.SelectPeriod.acnurnum.value='",EMVIURNO,"';":
    "document.SelectPeriod.acnadmno.value='",DEMVIADM,"';":
    "document.SelectPeriod.acnestat.value='",EMVISTAT,"';":
    "AddClinNote(); border=0>&nbsp;&nbsp;",EDDISDIA,"#",";
.
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;"#"",HTMLLNKL,"#",":
                               "#"",HTMLLNK1,"#",":
                               "#"",DTRIG,"#",":
                               "#"<input type=hidden value=",EMVITRIG,">#"";
.
            WRITE     HTMLFILE;");"
.
          GOTO      OTHTB150
.
OTHTB999  RETURN                         
.------------------------------------------------------------
. Read History FD untill right record found
.------------------------------------------------------------
EMHIST00  MOVE      SP70,HISTDATE
          MOVE      SP70,HISTTIME
          PACK      KEY22,EMVIADMN,Z70                       
          CALL      RSEMHIS1
EMHIST10  CALL      RPEMHIS1                                                   
          BRANCH    OVRCD,EMHIST99
          MOVE      EMHIVIS,DIM8VISN
          MATCH     EMVIADMN,DIM8VISN
          GOTO      EMHIST90 IF NOT EQUAL
          MATCH     EMHILOC,EMVILOCN
          GOTO      EMHIST10 IF NOT EQUAL
.
          UNPACK    EMHITIM,CHOUR,CMIN
          PACK      HISTTIME,CHOUR,COLON,CMIN,SP70
          MOVE      EMHIDAT,HISTDATE
          GOTO      EMHIST10 
.
EMHIST90  
EMHIST99  RETURN
.------------------------------------------------------------
. Table of Doctor Incomplete 
.------------------------------------------------------------
DOCTB000  PACK      KEY11,ONE,SP70        * Readonly status of 1
          CALL      RSEMISM1
DOCTB100  CALL      RKEMISM1              * Read forward    
          BRANCH    OVRCD,DOCTB999                          
.                                                           
          MATCH     "1",EMISTYPE          * not of status 1 
          GOTO      DOCTB999 IF NOT EQUAL                   
.                                                           
          COMPARE   ZERO,EMISNOIN         * disregard 0 incompletes
          GOTO      DOCTB100 IF EQUAL
.
          PACK      KEY6,EMISCODE,SP70     * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectDoctor('",HTMLLINK
          APPEND    EMISCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMISCODE,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMISNOIN,"#");"
.
          GOTO      DOCTB100                                
.                                                           
DOCTB999  RETURN                                       
.------------------------------------------------------------
. Table of Nurses Incomplete 
.------------------------------------------------------------
NURTB000  PACK      KEY11,TWO,SP70        * Readonly status of 2
          CALL      RDEMISM1
          IF        OVRCD<>1
            CALL      RPEMISM1
          ENDIF
NURTB100  CALL      RKEMISM1              * Read forward    
          BRANCH    OVRCD,NURTB999                          
.                                                           
          MATCH     "2",EMISTYPE          * not of status 2 
          GOTO      NURTB999 IF NOT EQUAL                   
.                                                           
          COMPARE   ZERO,EMISNOIN         * disregard 0 incompletes
          GOTO      NURTB100 IF EQUAL
.
          MATCH     "1",EMCNURSE           * Use pmshcpaf for ED Nurse?
          GOTO      NURTB110 IF EQUAL      * Yes
.
.         CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
          PACK      KEY6,EMISCODE,SP70     * Get Nurses full name
          CALL      RDOPNUR1 
          IF        OVRCD=1
            MOVE     SP70,OPNRCODE          * Clear all the file variables
            MOVE     SP70,OPNRSNAM
            MOVE     SP70,OPNRGNAM
            MOVE     SP70,OPNRUSR1
            MOVE     SP70,OPNRUSR2
            MOVE     SP70,OPNRUSR3
            MOVE     SP70,OPNRUSR4
            MOVE     SP70,OPNRUSR5
            MOVE     SP70,OPNRSTAT
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     OPNRGNAM,FMTGNAME
            MOVE     OPNRSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
          GOTO      NURTB500
.
.         CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
NURTB110  PACK      KEY10,EMISCODE,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
          GOTO      NURTB500
.
NURTB500  CLEAR     HTMLLINK
          APPEND    "javascript:SelectNurse('",HTMLLINK                       
          APPEND    EMISCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.                                                           
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMISCODE,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMISNOIN,"#");"
.
          GOTO      NURTB100                                
.                                                           
NURTB999  RETURN                                       
.------------------------------------------------------------
. Table of PSC Incomplete Patients
.------------------------------------------------------------
PSCTB000  PACK      KEY8,SP70
          CALL      RSEMINC1
PSCTB100  CALL      RKEMINC1              * Read forward
          BRANCH    OVRCD,PSCTB999
          PACK      SAVKEY8,EMIPADMN,SP70 
.
          MATCH     "0",EMIPCCOM          * not of status 0
          GOTO      PSCTB100 IF NOT EQUAL
.
          PACK      KEY8,EMIPADMN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,PSCTB100
.
          MATCH     EMVISITE,WBSEESC
          GOTO      PSCTB100 IF NOT EQUAL
.
          MATCH     "1",VIEWTYDF
          IF        @EQUAL
            MATCH     FRSTDATE,EMVIDATE
            GOTO      PSCTB100 IF LESS
            MATCH     EMVIDATE,LASTDATE
            GOTO      PSCTB100 IF LESS
          ENDIF
.
          MOVE      ONE,MANFTYPE
          PACK      ADMISSNO,EMIPADMN,SP70
          PACK      URNUMBER,EMVIURNO,SP70
          CALL      MANF0000          * Mandatory feilds (this may need chk) 
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1                                  
          IF        OVRCD=1                                 
            MOVE     SP70,DOCFNAME                          
          ELSE                                              
            MOVE     DTITL,FMTTITLE                          
            MOVE     DGNAME,FMTGNAME                        
            MOVE     DSNAME,FMTSNAME                        
            CALL     DOCNM000                               
          ENDIF                                             
.                                                           
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      DISMAN00               * Pack Mandatory feild string 
.
          IF        MSGARRNO=0              
            GOTO      PSCTB100              * Dont display this record
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPSC('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       " +",EMVIURNO
          REP       " +",DEMVIADM
.
          CLEAR     HTMLLNKL
          APPEND    "javascript:OpenLocation('",HTMLLNKL
          APPEND    EMVIURNO,HTMLLNKL
          APPEND    "','",HTMLLNKL
          APPEND    EMVIADMN,HTMLLNKL
          APPEND    "')",HTMLLNKL
          RESET     HTMLLNKL
.
          REP       "+ ",EMVIURNO
          REP       "+ ",DEMVIADM
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
. 
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":         *0
                             "#"",EMIPADMN,"#",":                  *1
                             "#"",EMVIURNO,"#",":                  *2
                             "#"",FORMATNM,"#",":                  *3
                             "#"",EMVIDATE,"#",":                  *4
                             "#"",EMVITIME,"#",":                  *5
                             "#"",EMVITRIG,"#",":                  *6
                             "#"",TCINDC1,"#",":                   *7
                             "#"",TDESC,"#",":                     *8
                             "#"",EMVIUC20,"#",":                  *9
                             "#"",KEY20,"#",":                     *10
                             "#"",EMVICOM1,"#",":                  *11
                             "#"",EMVICOM2,"#",":                  *12
                             "#"",EMVICOM3,"#",":                  *13
                             "#"",EMVICOM4,"#",":                  *14
                             "#"",EMVICOM5,"#",":                  *15
                             "#"",EMVICOM6,"#",":                  *16
                             "#"",EMVIDOCT,"#",":                  *17
                             "#"",DOCFNAME,"#",":                  *18
                             "#"",EMVILOCN,"#",":                  *19
                             "#"",EMLODESC,"#",":                  *20
                             "#"",DIM120,"#",":                    *21
                             "#"",EMVIDATE,EMVITIME,"#",":         *22
                             "#"",KEY3,"#",":                      *23
                             "#"",EMVIDDAT,EMVIDTIM,"#",";         *24
.
          PACK      TDESC,SP70
          MOVE      "ED",CATEGORY
          MOVE      EMVIDSTA,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"#"",TDESC,"#",":                     *25
                             "#"",EMLODESC,"#",":                  *26
                             "#"",HTMLLNKL,"#");"                  *27
.
          GOTO      PSCTB100
.
PSCTB999  RETURN
.------------------------------------------------------------
. Table of Doctor Incomplete Patients
.------------------------------------------------------------
DOITB000  PACK      KEY8,SP70
          CALL      RSEMINC1
DOITB100  CALL      RKEMINC1              * Read forward
          BRANCH    OVRCD,DOITB999
.
          MATCH     "0",EMIPDCOM          * not of status 0
          GOTO      DOITB100 IF NOT EQUAL
.
          MATCH     DOCTCODE,EMIPDOCT     * Filter for Doctors
          GOTO      DOITB100 IF NOT EQUAL
.
          PACK      KEY8,EMIPADMN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,DOITB100

          MOVE      TWO,MANFTYPE
          PACK      ADMISSNO,EMIPADMN,SP70
          PACK      URNUMBER,EMVIURNO,SP70
          CALL      MANF0000          * Mandatory feilds (this may need chk) 
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1                                  
          IF        OVRCD=1                                 
            MOVE     SP70,DOCFNAME                          
          ELSE                                              
            MOVE     DTITL,FMTTITLE                          
            MOVE     DGNAME,FMTGNAME                        
            MOVE     DSNAME,FMTSNAME                        
            CALL     DOCNM000                               
          ENDIF                                             
.                                                           
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      DISMAN00               * Pack Mandatory feild string 
.
          IF        MSGARRNO=0   
            GOTO     DOITB100              * Dont display this record
          ENDIF

          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK                      
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           *0
                             "#"",EMVIADMN,"#",":                    *1 
                             "#"",EMVIURNO,"#",":                    *2
                             "#"",FORMATNM,"#",":                    *3
                             "#"",EMVIDATE,"#",":                    *4
                             "#"",EMVIDATE,EMVITIME,"#",":           *5
                             "#"",EMVITRIG,"#",":                    *6
                             "#"",TCINDC1,"#",":                     *7
                             "#"",TDESC,"#",":                       *8
                             "#"",EMVIUC20,"#",":                    *9
                             "#"",KEY20,"#",":                       *10
                             "#"",EMVICOM1,"#",":                    *11
                             "#"",EMVICOM2,"#",":                    *12
                             "#"",EMVICOM3,"#",":                    *13
                             "#"",EMVICOM4,"#",":                    *14
                             "#"",EMVICOM5,"#",":                    *15
                             "#"",EMVICOM6,"#",":                    *16
                             "#"",EMVIDOCT,"#",":                    *17
                             "#"",DOCFNAME,"#",":                    *18
                             "#"",EMVILOCN,"#",":                    *19
                             "#"",EMLODESC,"#",":                    *20
                             "#"",DIM120,"#",":                      *21
                             "#"",KEY3,"#");"                        *22
.
          GOTO      DOITB100
.
DOITB999  RETURN
.------------------------------------------------------------
. Table of Nurse Incomplete Patients
.------------------------------------------------------------
NUITB000  PACK      KEY8,SP70
          CALL      RSEMINC1
NUITB100  CALL      RKEMINC1              * Read forward
          BRANCH    OVRCD,NUITB999
.
          MATCH     "0",EMIPNCOM          * not of status 0
          GOTO      NUITB100 IF NOT EQUAL
.
          MATCH     NURSCODE,EMIPNURS     * Filter for nurses
          GOTO      NUITB100 IF NOT EQUAL
.
          PACK      KEY8,EMIPADMN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,NUITB100

          MOVE      THREE,MANFTYPE
          PACK      ADMISSNO,EMIPADMN,SP70
          PACK      URNUMBER,EMVIURNO,SP70
          CALL      MANF0000          * Mandatory feilds (this may need chk) 
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          MATCH     "1",EMCNURSE           * Use pmshcpaf for ED Nurse?
          GOTO      NUITB110 IF EQUAL      * Yes
.
.         CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
          PACK      KEY6,EMISCODE,SP70     * Get Nurses full name
          CALL      RDOPNUR1
          IF        OVRCD=1
            MOVE     SP70,OPNRCODE          * Clear all the file variables
            MOVE     SP70,OPNRSNAM
            MOVE     SP70,OPNRGNAM
            MOVE     SP70,OPNRUSR1
            MOVE     SP70,OPNRUSR2
            MOVE     SP70,OPNRUSR3
            MOVE     SP70,OPNRUSR4
            MOVE     SP70,OPNRUSR5
            MOVE     SP70,OPNRSTAT
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     OPNRGNAM,FMTGNAME
            MOVE     OPNRSNAM,FMTSNAME
            CALL     DOCNM000
            PACK     KEY30,DOCFNAME
          ENDIF
          GOTO       NUITB500
.
.         CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
NUITB110  PACK      KEY10,EMISCODE,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL     CLPMSHCP
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     SP70,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
            PACK     KEY30,DOCFNAME
          ENDIF
          GOTO      NUITB500  
.
NUITB500  PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1                                  
          IF        OVRCD=1                                 
            MOVE     SP70,DOCFNAME                          
          ELSE                                              
            MOVE     DTITL,FMTTITLE                          
            MOVE     DGNAME,FMTGNAME                        
            MOVE     DSNAME,FMTSNAME                        
            CALL     DOCNM000                               
          ENDIF                                             
.                                                           
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      DISMAN00               * Pack Mandatory feild string 

          IF        MSGARRNO=0   
            GOTO     NUITB100              * Dont display this record
          ENDIF
. 
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           *0
                             "#"",EMVIADMN,"#",":                    *1
                             "#"",EMVIURNO,"#",":                    *2
                             "#"",FORMATNM,"#",":                    *3
                             "#"",EMVIDATE,"#",":                    *4
                             "#"",EMVIDATE,EMVITIME,"#",":           *5
                             "#"",EMVITRIG,"#",":                    *6
                             "#"",TCINDC1,"#",":                     *7
                             "#"",TDESC,"#",":                       *8
                             "#"",EMVIUC20,"#",":                    *9
                             "#"",KEY20,"#",":                       *10
                             "#"",EMVICOM1,"#",":                    *11
                             "#"",EMVICOM2,"#",":                    *12
                             "#"",EMVICOM3,"#",":                    *13
                             "#"",EMVICOM4,"#",":                    *14
                             "#"",EMVICOM5,"#",":                    *15
                             "#"",EMVICOM6,"#",":                    *16
                             "#"",EMVIDOCT,"#",":                    *17
                             "#"",DOCFNAME,"#",":                    *18
                             "#"",EMVIATNS,"#",":                    *19
                             "#"",EMISCODE,"#",":                    *20
                             "#"",KEY30,"#",":                       *21
                             "#"",EMVILOCN,"#",":                    *22
                             "#"",EMLODESC,"#",":                    *23
                             "#"",DIM120,"#",":                      *24
                             "#"",EMWFDES,"#",":                     *25
                             "#"",KEY3,"#");"                        *26
.
          GOTO      NUITB100
.
NUITB999  RETURN
.------------------------------------------------------------
.  mandatory fields
.------------------------------------------------------------
MANF0000  MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,MANF9000
.
          CALL      CHKUR000
          COMPARE   ZERO,UNKFLAG
          IF        @EQUAL
           STRIP     PSNAME
           STRIP     PGNAME
           PACK      KEY50,BOLDON,PSNAME,BOLDOFF,COMMA,SP1,PGNAME,SP70
           MOVE      KEY50,FORMATNM
           GOTO      MANF1000
          ENDIF
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
MANF1000  CALL      CLRMSG00               * Clear Message Array
.
          CALL      CHKMAN00               * Check Mandatory Fields
.
          MOVE      ZERO,EXIT
          GOTO      MANF9999
.
MANF9000  WRITE     HTMLFILE;"<tr><td>Admission record not on file</td></tr>"
          MOVE      ONE,EXIT
          GOTO      MANF9999
.
MANF9999  RETURN
.------------------------------------------------------------
.         CHKUR000 Check URNUMBER contents
.------------------------------------------------------------
CHKUR000  MOVE      ONE,UNKFLAG
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
            CALL      CLPMSPX2
            MOVE      ZERO,UNKFLAG
            MOVE      ZEROUR,URNUMBER
            MATCH     SP8,ADMISSNO
            IF        @EQUAL
              MOVE      EMVIADMN,ADMISSNO
            ENDIF
            GOTO      CHKUR990
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
CHKUR990  BRANCH    UNKFLAG,CHKUR999
.
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          IF        OVRCD=1
            CALL      CUNK0000
            GOTO      CHKUR999
          ENDIF
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET2,PGNAME
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNAGE,PSAGEYRS
          MOVE      EMUNSEX,PSEX
          PACK      PTITL,SP70
.
CHKUR999  RETURN
.------------------------------------------------------------
. Clear Message Array
.------------------------------------------------------------
CLRMSG00  MOVE      ZERO,MSGARRNO
          MOVE      SP70,MSGARR[1]
          MOVE      SP70,MSGARR[2]
          MOVE      SP70,MSGARR[3]
          MOVE      SP70,MSGARR[4]
          MOVE      SP70,MSGARR[5]
          MOVE      SP70,MSGARR[6]
          MOVE      SP70,MSGARR[7]
          MOVE      SP70,MSGARR[8]
          MOVE      SP70,MSGARR[9]
          MOVE      SP70,MSGARR[10]
CLRMSG99  RETURN
.------------------------------------------------------------
.  Check if all the mandatory fields are complete.
.  Return Status status 3 if complete ,otherwise set it to 2
.------------------------------------------------------------
CHKMAN00  PACK      KEY6,ONE,SP70
          CALL      RSEMWFM2
CHKMAN10  CALL      RKEMWFM2
          BRANCH    OVRCD,CHKMAN99
          MATCH     "1",EMWFMAN
          GOTO      CHKMAN99 IF NOT EQUAL
.
          MOVE      "EZ",CATEGORY
          MOVE      EMWFRES,CODE
          CALL      GETCOD00
          MATCH     MANFTYPE,TCINDC1
          GOTO      CHKMAN10 IF NOT EQUAL
.
          MOVE      ZERO,FORM2
          MOVE      SP70,DIM1
          MOVE      SP70,DIM1IND6
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1                      * code on file ?
            IF        OVRCD=0
              UNPACK    THCSCOD,DIM2
              SQUEEZE   DIM2                       * Save HDP Eq.
              MOVE      DIM2,FORM2
              PACK      DIM1,TCINDC3,SP70
              PACK      DIM1IND6,TCINDC6,SP70
            ENDIF
          ENDIF
.
          MOVE      EMWFFLD,FORM5
          PACK      DIM80,SP70,SP70
          CALL      MYEMR000
          MATCH     SP70,DIM80
          GOTO      CHKMAN10 IF NOT EQUAL
.
          IF        PTCNHDPS=THREE & (FORM2=10 | FORM2=11)
            IF       FORM5=176
              GOTO     CHKMAN15
            ENDIF
            IF       FORM5=177
              GOTO     CHKMAN15
            ENDIF
            GOTO     CHKMAN10
          ENDIF
.
          IF        FORM5=102|FORM5=103|FORM5=104|FORM5=105|FORM5=7
            IF        FORM2=11|FORM2=10|FORM2=30
              GOTO      CHKMAN10
            ENDIF
            MATCH     "T1",DIM2
            GOTO      CHKMAN10 IF EQUAL
.
            MATCH     "T1",DIM2
            GOTO      CHKMAN10 IF EQUAL
          ENDIF
.         
          IF        FORM5=169
            IF        FORM2=10|FORM2=11|FORM2=30
              GOTO      CHKMAN10
            ENDIF
            MATCH     "T1",DIM2
            GOTO      CHKMAN10 IF EQUAL
.
            MATCH     "T1",DIM2
            GOTO      CHKMAN10 IF EQUAL
.
            MATCH     "N",DIM1
            IF        @EQUAL
              IF        FORM2=31
                MATCH     "A",DIM1IND6
                IF        @EQUAL
                  PACK      KEY30,EMVIDOCT,EMVIATNS,EMVIMDCD,SP70
                  MATCH     SP70,KEY30
                  GOTO      CHKMAN10 IF EQUAL
                ELSE
                  GOTO      CHKMAN10
                ENDIF
              ELSE
                GOTO      CHKMAN10
              ENDIF
            ENDIF
.
            IF        FORM2=31
              PACK      KEY30,EMVIDOCT,EMVIATNS,EMVIMPRA,SP70
              MATCH     SP70,KEY30
              GOTO      CHKMAN10 IF EQUAL
            ENDIF
          ENDIF 
.
CHKMAN15  PACK      DISPMSG,EMWFFLD,SP70
          CALL      ADDMSG00
          BRANCH    EXIT,CHKMAN99
          GOTO      CHKMAN10
.
CHKMAN99  RETURN
.------------------------------------------------------------
. Check for Admission Unit into hospital
.------------------------------------------------------------
ADUNIT00  MATCH     SP70,EMVIUNIT
          IF        !@EQUAL
            MATCH     SP70,EMVIPADM
            IF        @EQUAL
              MOVE      ONE,EXIT
              GOTO      ADUNIT99
            ENDIF
          ENDIF
          MOVE     ZERO,EXIT

ADUNIT99  RETURN
.------------------------------------------------------------
. Add Message to Message Array
.------------------------------------------------------------
ADDMSG00  MOVE      ONE,EXIT
          ADD       ONE,MSGARRNO
          IF        MSGARRNO<10
            MOVE      DISPMSG,MSGARR[MSGARRNO]
            MOVE      ZERO,EXIT
          ENDIF
.
ADDMSG99  RETURN
.-------------------------------------------------------------------------------
.  Display Mandatory Fields etc
.-------------------------------------------------------------------------------
DISMAN00  MOVE       ZERO,F2
          PACK       DIM120,SP70,SP70
DISMAN10  ADD        ONE,F2
          IF         F2>MSGARRNO
            GOTO        DISMAN99
          ENDIF
.
          MOVE      MSGARR[F2],KEY5
          CALL      RDEMWFM1
          BRANCH    OVRCD,DISMAN10
.
          STRIP     EMWFDES
          APPEND    EMWFDES,DIM120
          APPEND    BREAKLIN,DIM120
.
          GOTO      DISMAN10
.
DISMAN99  RETURN
.------------------------------------------------------------
. Validate Procedures/Diagnoses
.------------------------------------------------------------
VICD0000  MOVE      ZERO,EXIT
          COMPARE   TWO,PRDGFLAG              * 0=Both 1=Diagnosis 2=Procedure
          GOTO      VICD1500 IF EQUAL
.
          PACK      KEY14,DEMVIADM,TYPE5,SP70
          CALL      RSEMVCD1
VICD1000  CALL      RKEMVCD1
          BRANCH    OVRCD,VICD9900
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      VICD9900 IF NOT EQUAL
.
          MATCH     TYPE5,EMVCTYPE          * Emergency diagnosis ?
          GOTO      VICD9900 IF NOT EQUAL
.
          MATCH     "000",EMVCSEQU
          GOTO      VICD1000 IF NOT EQUAL
.
          BRANCH    PRDGFLAG,VICD9999        * only checking for diagnosis
.
VICD1500  PACK      KEY14,DEMVIADM,TYPE4,SP70
          CALL      RSEMVCD1
VICD2000  CALL      RKEMVCD1
          BRANCH    OVRCD,VICD9900
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      VICD9900 IF NOT EQUAL
.
          MATCH     TYPE4,EMVCTYPE
          GOTO      VICD9900 IF NOT EQUAL
.
          MOVE      ZERO,EXIT                        * Coding Complete
          GOTO      VICD9999
.
VICD9900  MOVE      ONE,EXIT
.
VICD9999  RETURN
.------------------------------------------------------------
. Check for Zero U/R
.------------------------------------------------------------
ZERUR000  MATCH     ZEROUR,EMVIURNO
          IF        @EQUAL
            MOVE      ONE,EXIT
          ELSE
            MOVE      ZERO,EXIT
          ENDIF

ZERUR999  RETURN
.------------------------------------------------------------
. Calculate PSC                          
.------------------------------------------------------------
CALCP000  MOVE      ZERO,NUMPSCPT
          PACK      KEY8,SP70      
          CALL      RSEMINC1
CALCP100  CALL      RKEMINC1              * Read forward                       
          BRANCH    OVRCD,CALCP900
.
          MATCH     "0",EMIPCCOM          * not of status 1                    
          GOTO      CALCP100 IF NOT EQUAL
.
          PACK      KEY8,EMIPADMN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,CALCP100
.
          MATCH     EMVISITE,WBSEESC
          GOTO      CALCP100 IF NOT EQUAL
.
          ADD       ONE,NUMPSCPT
          GOTO      CALCP100                                
.                                                           
CALCP900  WRITE     HTMLFILE;NUMPSCPT;                      
.                                                           
CALCP999  RETURN                             
.------------------------------------------------------------
. Calculate Nurse Incomplete Patients
.------------------------------------------------------------
CALCN000  MOVE      ZERO,NURINCOM
.
          PACK      KEY11,TWO,SP70        * Readonly status of 2
          CALL      RDEMISM1
          IF        OVRCD<>1
            ADD       ONE,NURINCOM        * Blank nurse code
          ENDIF
.
          PACK      KEY11,TWO,SP70        * Readonly status of 2
          CALL      RSEMISM1
CALCN100  CALL      RKEMISM1              * Read forward                       
          BRANCH    OVRCD,CALCN900
.
          MATCH     "2",EMISTYPE          * not of status 2                    
          GOTO      CALCN900 IF NOT EQUAL
.
          ADD       ONE,NURINCOM
          GOTO      CALCN100                                
.                                                           
CALCN900  WRITE     HTMLFILE;NURINCOM;                      
.                                                           
CALCN999  RETURN                             
.------------------------------------------------------------
. Calculate Doctor Incomplete Patients
.------------------------------------------------------------
CALCD000  MOVE      ZERO,DOCINCOM
          PACK      KEY11,ONE,SP70        * Readonly status of 1
          CALL      RSEMISM1
CALCD100  CALL      RKEMISM1              * Read forward
          BRANCH    OVRCD,CALCD900
.
          MATCH     "1",EMISTYPE          * not of status 1
          GOTO      CALCD900 IF NOT EQUAL
.
          ADD       ONE,DOCINCOM
          GOTO      CALCD100
.
CALCD900  WRITE     HTMLFILE;DOCINCOM;
.
CALCD999  RETURN
.------------------------------------------------------------
. Calculate Patients In Other Rooms                         
.------------------------------------------------------------
CALCL000  MOVE      ZERO,OTHERPAT
.
          PACK      KEY7,WBSEESC,ANSO,SP70
          CALL      RSEMLOC3
CALCL050  CALL      RKEMLOC3
          BRANCH    OVRCD,CALCL900
.
          MATCH     WBSEESC,EMLOSCOD        * Same Site
          GOTO      CALCL900 IF NOT EQUAL
.
          MATCH     ANSO,EMLOTYPE           * Location Other
          GOTO      CALCL900 IF NOT EQUAL
.
          PACK      KEY11,EMLOLOCA,SP70
          CALL      RSEMVIS7
CALCL100  CALL      RKEMVIS7                * Read forward 
          BRANCH    OVRCD,CALCL050
.
          MATCH     EMVILOCN,EMLOLOCA       * Same Location
          GOTO      CALCL050 IF NOT EQUAL
.
.         COMPARE   EMVISTAT,ONE            * Exit if not of status 1
.         GOTO      CALCL100 IF NOT EQUAL
.
          COMPARE   EMVISTAT,FOUR
          GOTO      CALCL100 IF EQUAL
.
          IF        EMVISTAT=TWO | EMVISTAT=THREE
            COMPARE   ONE,EMVIADMT
            GOTO      CALCL100 IF NOT EQUAL
.
            MATCH     SP70,EMVILOCN
            GOTO      CALCL100 IF EQUAL
            GOTO      CALCL100 IF EOS
          ENDIF
.
          MATCH     EMVISITE,WBSEESC        * Same site
          GOTO      CALCL100 IF NOT EQUAL
.
          ADD       ONE,OTHERPAT
          GOTO      CALCL100
.
CALCL900  WRITE     HTMLFILE;OTHERPAT;
.                                                           
CALCL999  RETURN                                            
.------------------------------------------------------------
. Calculate Patients In Waiting Room 
.------------------------------------------------------------
CALCW000  MOVE      ZERO,WAITRPAT
.
          PACK      KEY7,WBSEESC,ANSW,SP70
          CALL      RSEMLOC3
CALCW050  CALL      RKEMLOC3
          BRANCH    OVRCD,CALCW900
.
          MATCH     WBSEESC,EMLOSCOD        * Same Site
          GOTO      CALCW900 IF NOT EQUAL
.
          MATCH     ANSW,EMLOTYPE           * Location Waiting Room
          GOTO      CALCW900 IF NOT EQUAL
.
          PACK      KEY11,EMLOLOCA,SP70
          CALL      RSEMVIS7
CALCW100  CALL      RKEMVIS7                * Read forward
          BRANCH    OVRCD,CALCW050
.
          MATCH     EMVILOCN,EMLOLOCA       * Same Location
          GOTO      CALCW050 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE            * Exit if not of status 1
          GOTO      CALCW100 IF NOT EQUAL
.
          MATCH     EMVISITE,WBSEESC        * Same Site
          GOTO      CALCW100 IF NOT EQUAL
.
          ADD       ONE,WAITRPAT
          GOTO      CALCW100
.
CALCW900  WRITE     HTMLFILE;WAITRPAT;
.
CALCW999  RETURN
.------------------------------------------------------------
. Calculate UnSeen Patients
.------------------------------------------------------------
CALCS000  MOVE      ZERO,USEENPAT
          PACK      KEY12,WBSEESC,ONE,SP70        * Readonly status of 1
          CALL      RSEMVIS5         
CALCS100  CALL      RKEMVIS5             * Read forward  
          BRANCH    OVRCD,CALCS900
.
          MATCH     EMVISITE,WBSEESC     * Exit if not correct site
          GOTO      CALCS900 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE         * Exit if not of status 1
          GOTO      CALCS900 IF NOT EQUAL
.
          MATCH     SP70,EMVIDOCT
          GOTO      CALCS100 IF NOT EQUAL
.
          ADD       ONE,USEENPAT
          GOTO      CALCS100
.
CALCS900  WRITE     HTMLFILE;USEENPAT;
.
CALCS999  RETURN
.------------------------------------------------------------
. Calculate Expected Patients                          
.------------------------------------------------------------
CALCE000  MOVE      ZERO,EXPECTPT
.
          PACK      WORKDATE,CCC,CYY,CMM,CDD
          REP       " 0",WORKDATE
          SUB       THIRTY1,WORKDATE      * Last month
.
          PACK      KEY21,WBSEESC,WORKDATE,SP70
          CALL      RSEMEXP4         * Emergency Expected Patients Table
CALCE100  CALL      RKEMEXP4         * Loop forward
          BRANCH    OVRCD,CALCE900
.
          MATCH     EMEXSITE,WBSEESC
          GOTO      CALCE900 IF NOT EQUAL
.
          MATCH     "1",EMEXDELT     * Removed
          GOTO      CALCE100 IF EQUAL
.
          MATCH     "0",EMEXDELT     * Triaged
          GOTO      CALCE100 IF EQUAL     
.
          ADD       ONE,EXPECTPT
          GOTO      CALCE100
.
CALCE900  WRITE     HTMLFILE;EXPECTPT;

CALCE999  RETURN
.-----------------------------------------------------------------
. Calculate Total number of Patients
.-----------------------------------------------------------------
CALCT000  MOVE      ZERO,TOTALPAT
          PACK      KEY12,WBSEESC,ONE,SP70        * Readonly status of 1
          CALL      RSEMVIS5         
CALCT100  CALL      RKEMVIS5             * Read forward  
          BRANCH    OVRCD,CALCT900
.
          MATCH     EMVISITE,WBSEESC     * Exit if not correct site
          GOTO      CALCT900 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE         * Exit if not of status 1
          GOTO      CALCT900 IF NOT EQUAL
.
          ADD       ONE,TOTALPAT
          GOTO      CALCT100
.
CALCT900  WRITE     HTMLFILE;TOTALPAT;

CALCT999  RETURN
.
.------------------------------------------------------------
. Calculate the number of patients in locaton X
. %EMRWEB01.01.044.XXX
. XXX = location code
.------------------------------------------------------------
CALCX000  UNPACK    DIM127,D1,COUNTLOC,DIM127 
.
          MOVE      ZERO,XLOCNPAT
          PACK      KEY11,COUNTLOC,SP70
          CALL      RSEMVIS7
CALCX100  CALL      RKEMVIS7             * Read forward
          BRANCH    OVRCD,CALCX900
.
          MATCH     COUNTLOC,EMVILOCN
          GOTO      CALCX900 IF NOT EQUAL
.
.         COMPARE   EMVISTAT,ONE         * Exit if not of status 1
.         GOTO      CALCX100 IF NOT EQUAL
.
          COMPARE   EMVISTAT,FOUR
          GOTO      CALCX100 IF EQUAL
.
          IF        EMVISTAT=TWO | EMVISTAT=THREE
            COMPARE   ONE,EMVIADMT
            GOTO      CALCX100 IF NOT EQUAL
.
            MATCH     SP70,EMVILOCN
            GOTO      CALCX100 IF EQUAL
            GOTO      CALCX100 IF EOS
          ENDIF
.
.
          MATCH     EMVISITE,WBSEESC
          GOTO      CALCX100 IF NOT EQUAL
.
          ADD       ONE,XLOCNPAT
          GOTO      CALCX100
.
CALCX900  WRITE     HTMLFILE;XLOCNPAT;
.
CALCX999  RETURN
.------------------------------------------------------------
. Emergency Visit Table
.------------------------------------------------------------
EMERGV00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                * Read user to get ED site code
          BRANCH    OVRCD,EMERGV99
.
          MOVE      WBSEESC,SAVESITE       * Save user ED site
.
          PACK      KEY11,Z70
          CALL      RSEMVIS7
EMERGV10  CALL      RPEMVIS7
          BRANCH    OVRCD,EMERGV99
.
          MATCH     SP70,EMVILOCN
          GOTO      EMERGV99 IF EQUAL
.
          MATCH     EMVISITE,SAVESITE
          GOTO      EMERGV10 IF NOT EQUAL
.
          COMPARE   "1",EMVISTAT
          GOTO      EMERGV12 IF EQUAL
.
          CALL      MAPCHK00
          BRANCH    EXIT,EMERGV10
.
EMERGV12  MOVE      EMVIADMN,SAVEADMN
          MOVE      EMVIADMN,ADMISSNO
          CALL      CALSEQ00             * Total Patients Counter
.
          MOVE      SP70,LOCNTYPE
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,EMERGV10
          MOVE      EMLOTYPE,LOCNTYPE
.
          MATCH     "O",EMLOTYPE
          IF        @EQUAL
            ADD       ONE,OTHRCNT       * Other Department
          ENDIF 

          MATCH     "W",EMLOTYPE
          IF        @EQUAL
            ADD       ONE,WAITCNT       * Waiting Room
          ENDIF
.
. Treating doctor
.
          MATCH     SP70,EMVIDOCT
          IF        @EQUAL
            ADD       ONE,UNSEECNT      * No Attending Doctor
            MOVE      SP70,DOCFNAME
            MOVE      SP70,DOCSNAM6
          ELSE
            PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
            CALL      RDDOCT1
            IF        OVRCD=1
              MOVE      SP70,DOCFNAME
              MOVE      SP70,DOCSNAM6
            ELSE
              MOVE      DGNAME,PGNAME
              MOVE      DSNAME,PSNAME
              MOVE      DSNAME,DOCSNAM6
              CALL      NAMEAM00
              MOVE      FORMATNM,DOCFNAME
            ENDIF
          ENDIF
.
. Initial assessor
.
          MATCH     SP70,EMVIMDCD
          IF        @EQUAL
            MOVE      SP70,IASSNAM6
          ELSE
.            PACK      KEY6,EMVIMDCD,SP70   
.            CALL      RDDOCT1
.            IF        OVRCD=1
.              MOVE      EMVIMDCD,IASSNAM6
.            ELSE
.              MOVE      DSNAME,IASSNAM6
.            ENDIF
            PACK      KEY10,EMVIMDCD,SP70     * Get HCP name
            CALL      RDPMHCP1
            IF        OVRCD=1
              MOVE      EMVIMDCD,IASSNAM6
            ELSE
              MOVE      PMHCSNAM,IASSNAM6
            ENDIF
          ENDIF
.
. Senior/Other doctor
.
          MATCH     SP70,EMVIUR04
          IF        @EQUAL
            MOVE      SP70,SDOCNAM6
          ELSE
            PACK      KEY6,EMVIUR04,SP70     * Get senior doctor name
            CALL      RDDOCT1
            IF        OVRCD=1
              MOVE      EMVIUR04,SDOCNAM6
            ELSE
              MOVE      DSNAME,SDOCNAM6
            ENDIF
          ENDIF
.
          MOVE      SP70,NURSNAM6
          MATCH     SP70,EMVIATNS
          GOTO      EMERGV16 IF EQUAL
.          
          MATCH     "1",EMCNURSE            * Use pmshcpaf for ED Nurse?
          GOTO      EMERGV14 IF EQUAL       * Yes
.
.         CONTROL.EMCNURSE=0 - Use oprnuraf for nurse                   
          PACK      KEY6,EMVIATNS,SP70
          CALL      RDOPNUR1
          IF        OVRCD<>1
            MOVE      OPNRSNAM,NURSNAM6
          ELSE
            MOVE     SP70,OPNRCODE          * Clear all the file variables
            MOVE     SP70,OPNRSNAM
            MOVE     SP70,OPNRGNAM
            MOVE     SP70,OPNRUSR1
            MOVE     SP70,OPNRUSR2
            MOVE     SP70,OPNRUSR3
            MOVE     SP70,OPNRUSR4
            MOVE     SP70,OPNRUSR5
            MOVE     SP70,OPNRSTAT
            MOVE     SP70,DOCFNAME
            MOVE     SP70,NURSNAM6
          ENDIF
          GOTO      EMERGV16
.
.         CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
EMERGV14  PACK      KEY10,EMVIATNS,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL     CLPMSHCP
            MOVE     SP70,NURSNAM6
          ELSE
            MOVE     PMHCSNAM,NURSNAM6
          ENDIF
          GOTO      EMERGV16
.
EMERGV16  MOVE      SP70,TDESC
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      SP70,PRESCM10
          MOVE      TDESC,PRESCM10
.
          MATCH     "1",EMCNDPRS       * Display diagnosis over presenting comp.
          IF        @EQUAL
            CALL     DIAG0000
          ELSE
            MOVE     TDESC,DISDIAG
.
            CLEAR     DISDIA2
            APPEND    "\tComplaint\t: ",DISDIA2
            APPEND    TDESC,DISDIA2
            RESET     DISDIA2
.
          ENDIF
.
          CALL      GETDUR00                * Get visit duration 
.
          COMPARE   TWO,ADMITFLG            * Duration warning will override
          GOTO      EMERGV17 IF EQUAL       * sad face
.
          COMPARE   ONE,PTCNHDPS
          IF        @EQUAL          
            CALL     EXCD0000               * If NZ check for exceed triage
          ELSE                              * wait times
            MOVE      ZERO,ADMITFLG
            MATCH     SP70,EMVIPADM
            IF        @EQUAL
              CALL      GETTIM00
              SQUEEZE   EMCNWTTM
              MOVE      EMCNWTTM,FORM3
              IF        FORM3 <> 0
                IF        (WAITTIME > FORM3 | CDYSDAYS > ZERO)
                  MOVE      ONE,ADMITFLG
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
EMERGV17  PACK      KEY5,CATAA,EMVITRIG,SP70
          CALL      RDCODE1
.
          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1            * Patient Master File
          COMPARE   "1",OVRCD  
          IF        @EQUAL
            CALL      CLPATMAS                * clear master detils
            CALL      CLPMSPX2                * clear mast ext2 details
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,EMERGV10
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNDET1,PSNAME
            MOVE      EMUNDET2,PGNAME
            MOVE      EMUNDET1,PTMASNAM       * copy surname for CHKD0000
            MOVE      EMUNDET2,PMPXFNAM       * copy firstname for CHKD0000
            MATCH     "Unknown",PSNAME
            IF        @EQUAL
              SFORMAT   FORMATNM,127
              STRIP     PSNAME
              STRIP     PGNAME
              RESET     FORMATNM
              PACK      FORMATNM,SP70,SP70
              PACK      FORMATNM,UNKNOWN,SP1,PGNAME,SP70
              MOVE      EMUNSEX,PSEX
              GOTO      EMERGV30
            ENDIF
            MOVE      EMUNSEX,PSEX
            MOVE      EMUNBDAT,PBDATE
            MATCH     SP70,PBDATE
            IF        @EQUAL
              MOVE      ZERO,PSAGEYRS 
              GOTO      EMERGV20 
            ENDIF
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
EMERGV20  CALL      NAMEAM00
EMERGV30  MOVE      SP1,KEY1
          MOVE      SP3,KEY3
          MOVE      SP1,KEY1A
          MOVE      SP3,KEY3A
.
          MATCH     SP8,EMVIPADM
          IF        @EQUAL
            MATCH     SP8,EMVIUNIT
            IF        !@EQUAL
              MOVE      "*",KEY1
              MOVE      EMVIUNIT,KEY3
              MOVE      "*",KEY1A
              MOVE      EMVIUNIT,KEY3A
            ENDIF
          ELSE
            PACK    KEY8,EMVIPADM,SP70
            CALL    RDMISS1
            IF      OVRCD=1
              MATCH   SP8,EMVIUNIT
              IF      !@EQUAL
                MOVE    "*",KEY1
                MOVE    EMVIUNIT,KEY3
                MOVE    "*",KEY1A
                MOVE    EMVIUNIT,KEY3A
              ENDIF
            ELSE
              MATCH   SP8,ACLSSFT
              IF      !@EQUAL
                MOVE    ACLSSFT,KEY3
                MOVE    ACLSSFT,KEY3A
              ENDIF
            ENDIF
          ENDIF
.
.. **** ready for admission display NO default of EMVIUC28 ****
          MOVE      SP70,ADMRDISP
          MOVE      SP70,REQSTDIS
          PACK      ADMRND28,SP70
          CALL      ADMR0000                * Ready for admission display
          PACK      ADMRND28,ADMRDISP,SP70
.
.. **** ready for admission display WITH default of EMVIUC28 ****
          MOVE      SP70,ADMRDISP
          MATCH     SP70,EMVIUC28
          IF        !@EQUAL
            PACK      ADMRDISP,ANSB,EMVIUC28,SP70 * Ready for admission display
          ENDIF
          CALL      ADMR0000                * Ready for admission display
.
          CALL      BEDR0000                * Check for ward/bed requests
.
          CALL      OCLN0000                * Get other clinical tests
.
          CALL      CHKD0000                * Check for Duplicate names in EMR
.
          PACK      KEY8,SAVEADMN,SP70
          CALL      RDEMVIS1
.
          CALL      SRCCLS00                * Get Source and Class Details
          CALL      GETWAT00                * Routine to get time diff
.
          MOVE      SP70,AMODEIN1
          PACK      KEY5,ANSE,ANSA,EMVIMODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC1,AMODEIN1      * Indicator on Arrival Mode
          ENDIF
.
          MOVE      SP70,TRICDEI1
          PACK      KEY5,CATAA,EMVITRIG,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC1,TRICDEI1     * Triage code indicator 1
          ENDIF
.
          MOVE      SP70,ISOIND2
          MATCH     SP70,EMVIUC27
          IF        !@EQUAL
            PACK      KEY5,CATES,EMVIUC27,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC2,ISOIND2
            ENDIF
          ENDIF
.
          MOVE      SP70,STRMIND1
          MATCH     SP70,EMVIUC16
          MOVE      "eh",KEY2
          IF        !@EQUAL
            PACK      KEY5,KEY2,EMVIUC16,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,STRMIND1
            ENDIF
          ENDIF
.
          PACK      DIM10,PMPXSIN6,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN10:
                          PMPXSN11,PMPXSN12,PMPXSN13,PMPXSN14,PMPXSN15
          REP       " 0",DIM10
.
          CALL      MANNOT00           * Get Management Notes
.
          WRITE     HTMLFILE;"   obj.AddPatient(#"",EMVIURNO,"#",": * 0
                             "#"",EMVIADMN,"#",":                   * 1
                             "#"",FORMATNM,"#",":                   * 2
                             "#"",EMVILOCN,"#",":                   * 3
                             "#"",TRICDEI1,"#",":                   * 4
                             "#"",EMVIDATE,EMVITIME,"#",":          * 5
                             "#"",PSEX,"#",":                       * 6
                             "#"",PSAGEYRS,"#",":                   * 7
                             "#"",PRESCM10,"#",":                   * 8
                             "#"",KEY1,KEY3,"#",":                  * 9
                             "#"",EMVIDOCT,"#",":                   * 10
                             "#"",EMVIATNS,"#",":                   * 11
                             "#"",NEXTSEQN,"#",":                   * 12
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PTMXSIN5:
                             "#",":                                 *13
                             "#"",ADMITFLG,"#",":                   *14
                             "#"",DUPNMFLG,"#",":                   *15
                             "#"",EMVIPRLO,"#",":                   *16
                             "#"",EMVIPRTM,"#",":                   *17
                             "#"",OTHRCLIN,"#",":                   *18
                             "#"",EMVIDSTA,"#",":                   *19
                             "#"",EMVIUT01,"#",";                   *20
.
          IF        EMVIYN01=ONE
            WRITE     HTMLFILE;"#"<b>",EMVIUR01,"</b>#",";          *21
          ELSE
            WRITE     HTMLFILE;"#"",EMVIUR01,"#",";                 *21
          ENDIF
.
          CALL      BEDREQ00        * Ward/Bed Request with Allocation colour
          CALL      DSDELY00  
.
.         Transfer Destination Code...
.
          MOVE      SP10,TDCODNME
          PACK      KEY5,EMVIDEST,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,EMERGV40               * no such transfer dest code
.
          MATCH     SP10,PTVACNME                * Coded Name is blank?
          GOTO      EMERGV40 IF EQUAL
.
          MATCH   SP10,EMVIUT07                  * Ambulance Booking Time?
          IF      !@EQUAL
            PACK    TDCODNME,PTVACNME,PIPE,ONE   * has an ambulance booking time
          ELSE
            PACK    TDCODNME,PTVACNME
          ENDIF
.
EMERGV40  MOVE      ZERO,EXIT
          PROC      DISPALRT           * get Disability Alert Icon indicator
          MOVE      EXIT,DISBALRT
          MOVE      ZERO,EXIT
.
          MOVE      SP1,KEY1B
          PACK      KEY5,CATYW,EMVIVSTY,SP70  * VEMD Service Type (Cat YW)
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      THCSCOD,KEY1B      * HDP Pos. 1
          ENDIF
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          WRITE     HTMLFILE;"#"",DISDIAG,"#",":                    *22
                             "#"",ADMRDISP,"#",":                   *23
                             "#"",EMVIUC28,"#",":                   *24
                             "#"",ADMRND28,"#",":                   *25
                             "#"",WAITHHMM,"#",":                   *26
                             "#"",SRCEDESC,"#",":                   *27
                             "#"",SRCEIN12,"#",":                   *28
                             "#"",CLASDESC,"#",":                   *29
                             "#"",CLASIN12,"#",":                   *30
                             "#"",EMVICOM1,"#",":                   *31
                             "#"",EMVICOM2,"#",":                   *32
                             "#"",EMVICOM3,"#",":                   *33
                             "#"",EMVICOM4,"#",":                   *34
                             "#"",EMVICOM5,"#",":                   *35
                             "#"",EMVICOM6,"#",":                   *36
                             "#"",DOCFNAME,"#",":                   *37
                             "#"",TDCODNME,"#",":                   *38
                             "#"",DIM10,"#",":                      *39
                             "#"",EMLODESC,"#",":                   *40
                             "#"",DOCSNAM6,"#",":                   *41
                             "#"",NURSNAM6,"#",":                   *42
                             "#"",EMVIDTIM,"#",":                   *43
                             "#"",DURAHHMM,"#",":                   *44
                             "#"",REQSTDIS,"#",":                   *45
                             "#"",DISDIA2,"#",":                    *46
                             "#"",LOCNTYPE,AMODEIN1,"#",":          *47
                             "#"",DISPWRDT,DISPWRTM,"#",":          *48
                             "#"",DISBALRT,"#",":                   *49
                             "#"",EMVIUC16,"#",":                   *50
                             "#"",MANNOT01,"#",":                   *51
                             "#"",MANNOT02,"#",":                   *52
                             "#"",MANNOT03,"#",":                   *53
                             "#"",MANNOT04,"#",":                   *54
                             "#"",MANNOTDT,"#",":                   *55
                             "#"",KEY1A,KEY3A,"#",":                *56
                             "#"",EMVIVSTY,KEY1B,"#",":             *57
                             "#"",ISOIND2,"#",":                    *58
                             "#"",IASSNAM6,"#",":                   *59
                             "#"",SDOCNAM6,"#",":                   *60
                             "#"",DISPBEDB,"#",":                   *61
                             "#"",STRMIND1,"#",":                   *62
                             "#"",DISPDELY,"#",";                   *63
.
          CALL      IPBEDR00        * Linked IP visit bed request
          CALL      IPOP0000        * IP/OP within last XXX hours
.
          WRITE     HTMLFILE;"#"",IPBEDREQ,"#",":                   *64
                             "#"",LASTIPOP,"#",":                   *65
                             "#"",EMVIYN03,"#",":                   *66
                             "#"",PMPXUCC4,"#"":                    *67
                             ");"
.
          SFORMAT   FORMATNM,127
.          
          GOTO      EMERGV10
.
EMERGV99  RETURN
.
.--------------------------------------------------
. Get Source and Class Details
.--------------------------------------------------
SRCCLS00  MATCH     SP70,EMVISRCE
          IF        !@EQUAL
            PACK      KEY5,CATS,EMVISRCE
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      SRCEDESC,SP70
              PACK      SRCEIN12,SP70
            ELSE
              PACK      SRCEDESC,TDESC
              PACK      SRCEIN12,TCINDC12
            ENDIF
          ELSE
            PACK      SRCEDESC,SP70
            PACK      SRCEIN12,SP70
          ENDIF
.
          MATCH     SP70,EMVICLAS
          IF        !@EQUAL
            PACK      KEY5,CATA,EMVICLAS
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      CLASDESC,SP70
              PACK      CLASIN12,SP70
            ELSE
              PACK      CLASDESC,TDESC
              PACK      CLASIN12,TCINDC12
            ENDIF
          ELSE
            PACK      CLASDESC,SP70
            PACK      CLASIN12,SP70
          ENDIF
.
          RETURN
.-------------------------------------------------------------------------
. Formate name for output of table
.-------------------------------------------------------------------------
NAMEAM00  MOVE     PSNAME,FMTSNAME
          MOVE     PGNAME,FMTGNAME
.
          SFORMAT  FORMATNM,127
          PACK     FORMATNM,SP70,SP70
          REP      "' ",FMTSNAME
          REP      "#" ",FMTSNAME
          REP      "\ ",FMTSNAME
          REP      "' ",FMTGNAME
          REP      "#" ",FMTGNAME
          REP      "\ ",FMTGNAME
          REP      UPPLOW,FMTSNAME
.
          CLEAR    DISPNAME
          PACK     NAME35,FMTGNAME,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTGNAME
          STRIP    FMTGNAME
.
          STRIP    FMTSNAME
          CLEAR    FORMATNM
.
          MOVE     FMTGNAME,KEY1
          REP      UPPLOW,KEY1
          APPEND   KEY1,FORMATNM
          APPEND   DOT,FORMATNM
          UNPACK   FMTSNAME,KEY1,KEY50
          REP      UPPLOW,KEY1
          REP      DOWNCASE,KEY50
          STRIP    KEY1
          STRIP    KEY50
          APPEND   KEY1,FORMATNM
          APPEND   KEY50,FORMATNM

NAMEAM90  APPEND    SP70,FORMATNM
          RESET     FORMATNM
          SFORMAT   VAR,127
          MOVE      FORMATNM,VAR
          STRIP     FORMATNM
          MOVELPTR  FORMATNM,LENGTH
          IF        LENGTH=0
            SFORMAT   FORMATNM,1
          ELSE
            SFORMAT   FORMATNM,LENGTH
          ENDIF
          MOVE      VAR,FORMATNM
.
NAMEAM99  RETURN
.------------------------------------------------------------
. Determine Patient Sequence      
. NEXTSEQN : XYYYYZZZZ
.            X = Triage category
.            YYYY = Sequence number (9999 - waittime)
.            ZZZZ = Jump category sequence number. 0000 if not jump catrgory
.------------------------------------------------------------
CALSEQ00  MOVE      "000000000",NEXTSEQN
.
          MATCH     SP70,EMVIDOCT                *  Treating doctor
          GOTO      CALSEQ99 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      EMCNSCLK,F1                  * Stop the clock parameter
.
          IF        F1=1  | F1=3
            MATCH     SP70,EMVIMDCD              * Initial Assessor
            GOTO      CALSEQ99 IF NOT EQUAL
          ENDIF
.          
          IF        F1=2 | F1=3
            MATCH     SP70,EMVIUR04              * Other Doctor
            GOTO      CALSEQ99 IF NOT EQUAL
          ENDIF
.          
          IF        EMVIYN08<>0
            PACK      NEXTSEQN,ZERO,ZERO,ZERO,ZERO,EMVIYN08,ZERO,ZERO,ZERO,ZERO
            GOTO      CALSEQ90
          ENDIF
.
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          TYPE      TCINDC2
          IF        @EQUAL
            MOVE      TCINDC2,TCINDC1
          ENDIF
.
          TYPE      TCINDC1
          IF        !@EQUAL
            MOVE      FIVE,TCINDC1          * Default to Cat 5 if no triage cat
          ENDIF                             * or indicator not set
.
          MOVE      TCINDC1,F1
          COMPARE   F1,ONE
          GOTO      CALSEQ99 IF EQUAL

          CALL      GETWAT00
          MOVE      ZERO,F4
          MOVE      WAITTIME,F4
          MOVE      "9999",F4A
          SUB       F4,F4A
          PACK      NEXTSEQN,TCINDC1,F4A,ZERO,ZERO,ZERO,ZERO
          REP       " 0",NEXTSEQN
          MOVE      TCINDC1,F1

          IF        (F1=FOUR & WAITTIME>60)
            MOVE      "39984",KEY5          * If cat 4 and waiting longer than
            PACK      NEXTSEQN,KEY5,F4A     * 60 min jump to cat 3 but before
            REP       " 0",NEXTSEQN         * cat 3 waiting less than 15 min
          ENDIF                                   

          IF        (F1=FIVE & WAITTIME>120)
            MOVE      "49954",KEY5         * If cat 5 and waiting longer than
            PACK      NEXTSEQN,KEY5,F4A    * 120 min jump to cat 4 but before
            REP       " 0",NEXTSEQN        * cat 4 waiting less than 45 min
          ENDIF

CALSEQ90  MOVE      NEXTSEQN,F9
          IF        F9<NEXTPATN
            MOVE      F9,NEXTPATN
            MOVE      ADMISSNO,NEXTADMN
          ENDIF
CALSEQ99  RETURN
.------------------------------------------------------------
. Get the time in waiting          
.------------------------------------------------------------
GETWAT00  MOVE      EMVIDATE,FIRSTDAT
          UNPACK    EMVITIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
          IF        CALCTIME>9999
            MOVE      "9999",WAITTIME
          ELSE
            MOVE      CALCTIME,WAITTIME
          ENDIF
GETWAT99  RETURN
.------------------------------------------------------------
. Get the time since first doc
.------------------------------------------------------------
GETSFD00  MOVE      ZERO,_SFDTIME
          MOVE      ZERO,CDYSDAYS
          MOVE      SP70,WAITHHMM
.
          CALL      SCLK0000                * Find stop the clock doctor
.
          MATCH     SP70,STOPDTIM
          GOTO      GETSFD99 IF EQUAL
.
          UNPACK    STOPDTIM,FIRSTDAT,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
          IF        CALCTIME>9999
            MOVE      "9999",_SFDTIME
          ELSE
            MOVE      CALCTIME,_SFDTIME
          ENDIF
.
          MOVE      "99:99",WAITHHMM
          IF        CALCTIME<6000
            ASSIGN    (CALCTIME/60),IHOUR
            ASSIGN    (CALCTIME%60),IMIN
            MOVE      IMIN,MIN
            REP       " 0",MIN
            PACK      WAITHHMM,IHOUR,COLON,MIN
          ENDIF
.
GETSFD99  RETURN
+
.------------------------------------------------------------
. Get the time in waiting after being seen by the doctor         
.------------------------------------------------------------
GETTIM00  MOVE      ZERO,WAITTIME
          MOVE      ZERO,CDYSDAYS
.
          CALL      SCLK0000                * Find stop the clock doctor
.
          MATCH     SP70,STOPDTIM
          GOTO      GETTIM99 IF EQUAL
.
          UNPACK    STOPDTIM,FIRSTDAT,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
          IF        CALCTIME>9999
            MOVE      "9999",WAITTIME
          ELSE
            MOVE      CALCTIME,WAITTIME
          ENDIF
.
GETTIM99  RETURN
.
.------------------------------------------------------------
. Get total duration of emergency attendance. 
. Arrival date/time to current date/time
.------------------------------------------------------------
GETDUR00  MOVE      ZERO,ADMITFLG
          MOVE      ZERO,DURATIME
          MOVE      ZERO,CDYSDAYS
          MOVE      SP70,DURAHHMM
.
          MOVE      ZERO,FORM4
          SQUEEZE   EMCNLOSW 
          MOVE      EMCNLOSW,FORM4   
.
          COMPARE   ZERO,FORM4              * Not using duration warning
          GOTO      GETDUR90 IF EQUAL
.
          MATCH     SP70,EMVIDATE
          GOTO      GETDUR99 IF EQUAL
.
          MATCH     SP70,EMVITIME
          GOTO      GETDUR99 IF EQUAL
.
          MOVE      EMVIDATE,FIRSTDAT
          UNPACK    EMVITIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
          MOVE      CALCTIME,DURATIME
.
          SQUEEZE   EMCNLOSW 
          MOVE      EMCNLOSW,FORM4   
          IF        (DURATIME > FORM4 | CDYSDAYS > SEVEN)
            MOVE      TWO,ADMITFLG
          ENDIF
.
GETDUR90  CALL      GETDUU00
          CALL      VISDUR00
.
.         CALL      GETDUL00
.
GETDUR99  RETURN
.
.------------------------------------------------------------
. Get the time since arrival and format display HH:MM
.------------------------------------------------------------
VISDUR00  MOVE      SP70,DURAHHMM
.
          MATCH     SP70,EMVIDATE
          GOTO      VISDUR99 IF EQUAL
.
          MATCH     SP70,EMVITIME
          GOTO      VISDUR99 IF EQUAL
.
          MOVE      EMVIDATE,FIRSTDAT
          UNPACK    EMVITIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
.
          MOVE      "99:99",DURAHHMM
          IF        CALCTIME<6000
            ASSIGN    (CALCTIME/60),IHOUR
            ASSIGN    (CALCTIME%60),IMIN
            MOVE      IMIN,MIN
            REP       " 0",MIN
            PACK      DURAHHMM,IHOUR,COLON,MIN
          ENDIF
.
VISDUR99  RETURN
.
.------------------------------------------------------------
. Emergency Patients by Date Range
.------------------------------------------------------------
EMRD0000  BRANCH    FLDITMNO,EMRD0001,EMRD0002,EMRD0003,EMRD0004,EMRD0005:
                             EMRD0006,EMRD0007,EMRD0008,EMRD0009,EMRD0010:
                             EMRD0011,EMRD0012,EMRD0013,EMRD0014,EMRD0015:
                             EMRD0016
          GOTO      EMRD9999
.
EMRD0001  CALL      NEXT0000    * Link to next day, week, month
          GOTO      EMRD9999
.
EMRD0002  CALL      PREV0000    * Link to previous day, week, month
          GOTO      EMRD9999
.
EMRD0003  CALL      CURSTD00    * Current start date
          GOTO      EMRD9999
.
EMRD0004  CALL      CUREND00    * Current End Date
          GOTO      EMRD9999
.
EMRD0005  CALL      CURYR000    * Current Year
          GOTO      EMRD9999
.
EMRD0006  CALL      CURMON00    * Current month name
          GOTO      EMRD9999
.
EMRD0007  CALL      SELV0000    * Select Date Options
          GOTO      EMRD9999
.
EMRD0008  CALL      PTDAT000    * Patients in date range
          GOTO      EMRD9999
.
EMRD0009  WRITE     HTMLFILE;TEMPLATE;  * Template no
          GOTO      EMRD9999
.
EMRD0010  WRITE     HTMLFILE;REPORTNO;  * Report no
          GOTO      EMRD9999
.
EMRD0011  WRITE     HTMLFILE;VIEWTYPE;  * View type
          GOTO      EMRD9999
.
EMRD0012  CALL      ADDAT000    * Admitted patients in date range
          GOTO      EMRD9999
.
EMRD0013  WRITE     HTMLFILE;EMVIUNIT;
          GOTO      EMRD9999
.
EMRD0014  WRITE     HTMLFILE;EMVIUNIT;
          GOTO      EMRD9999
.
EMRD0015  MOVE      ONE,CHECKGP
          CALL      PTDAT000    * Patients in date range
          GOTO      EMRD9999
.
EMRD0016  WRITE     HTMLFILE;VENQUIRY;
          GOTO      EMRD9999
.
EMRD9999  RETURN
.------------------------------------------------------------
. Current emergency patient visits
.------------------------------------------------------------
PATVIS00  PACK      KEY9,ONE,SP70
          CALL      RSEMVIS2
PATVIS10  CALL      RKEMVIS2
          BRANCH    OVRCD,PATVIS99
.
          COMPARE   EMVISTAT,ONE
          GOTO      PATVIS99 IF NOT EQUAL
.
          MATCH     SP70,FILTSTRM
          IF        !@EQUAL
            MATCH     EMVIUC16,FILTSTRM
            GOTO      PATVIS10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSITE
          IF        @EQUAL
            MATCH     EMVISITE,WBSEESC
            GOTO      PATVIS10 IF NOT EQUAL
          ELSE
            MATCH     Z70,FILTSITE               * ~~~ equals all
            IF        !@EQUAL
              MATCH     EMVISITE,FILTSITE
              GOTO      PATVIS10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          COMPARE   ONE,LNK2PRT
          GOTO      PATVIS20 IF NOT EQUAL
.
          MATCH     SP70,EMVIUD03         * Unit request date blank?
          GOTO      PATVIS22 IF NOT EQUAL
          MATCH     SP70,EMVIUT03         * Unit request time blank?
          GOTO      PATVIS22 IF NOT EQUAL
          MATCH     SP70,EMVIUNIT         * Unit code blank?
          GOTO      PATVIS10 IF EQUAL
          GOTO      PATVIS22
.
PATVIS20  MOVE      SP70,AARRTIME
          CALL      GETWAT00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      SP70,SFDSTIME
          CALL      GETSFD00
          MOVE      _SFDTIME,SFDSTIME
.
          MATCH     SP70,EMVIATNS           *   Check for Attending Nurse
          IF        @EQUAL
             MOVE     EMVITRNS,EMVIATNS
          ENDIF
.          
PATVIS22  MATCH     SP8,EMVIPADM
          GOTO      PATVIS23 IF EQUAL
.
          PACK      KEY8,EMVIPADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PATVIS23
.
          MATCH     SP8,ACLSSFT
          GOTO      PATVIS23 IF EQUAL
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
          GOTO      PATVIS24
.
PATVIS23  MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
.
PATVIS24  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC 
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      PATVIS30 
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,PATVIS10
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
PATVIS30  CALL      OUTPUT00
          GOTO      PATVIS10
.
PATVIS99  RETURN
.------------------------------------------------------------
. Current emergency patient Waiting On Discharge that have been Admitted
.------------------------------------------------------------
DISTAB00  PACK      KEY12,WBSEESC,ONE,SP70
          CALL      RSEMVIS5
DISTAB10  CALL      RKEMVIS5
          BRANCH    OVRCD,DISTAB99
.
          MATCH     EMVISITE,WBSEESC
          GOTO      DISTAB99 IF NOT EQUAL
.
          COMPARE   ONE,EMVISTAT
          GOTO      DISTAB99 IF NOT EQUAL
.
          PACK      EMVIPADM,EMVIPADM,SP70
          MATCH     SP70,EMVIPADM           *   Only want admitted patients
          GOTO      DISTAB10 IF EQUAL
.
          MOVE      SP70,AARRTIME
          CALL      GETWAT00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MATCH     SP70,EMVIATNS           *   Check for Attending Nurse
          IF        @EQUAL
             MOVE     EMVITRNS,EMVIATNS
          ENDIF
.          
          MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC 
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      DISTAB30
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,DISTAB10
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.           
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
DISTAB30  CALL      OUTPUT00
          GOTO      DISTAB10
.
DISTAB99  RETURN
.------------------------------------------------------------
. Table of Patients Awaiting Triage
.------------------------------------------------------------
AWTTB000  PACK      KEY12,WBSEESC,ONE,SP70        * Readonly status of 1
          CALL      RSEMVIS5
AWTTB100  CALL      RKEMVIS5             * Read forward
          BRANCH    OVRCD,AWTTB999
.
          MATCH     EMVISITE,WBSEESC     * Exit if not correct site
          GOTO      AWTTB999 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE         * Exit if not of status 1
          GOTO      AWTTB999 IF NOT EQUAL
.
          MATCH     SP70,EMVITRIG
          GOTO      AWTTB100 IF NOT EQUAL

          PACK      KEY8,EMVIURNO,SP70
          CALL      RDMAST1            * Patient Master File
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,AWTTB100
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            PACK      KEY50,SP70
            STRIP     EMUNDET1
            STRIP     EMUNDET2
            PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
            MOVE      KEY50,FORMATNM
            GOTO      AWTTB200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
AWTTB200  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1        
            MOVE      SP70,EMLODESC
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",KEY10,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",EMVILOCN,"#",":
                             "#"",EMLODESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#");"
.
          GOTO      AWTTB100
.
AWTTB999  RETURN
.------------------------------------------------------------
. Incomplete emergency patient visits
.------------------------------------------------------------
INCVIS00  MATCH     SP70,SRCHCODE
          GOTO      INCVIS99 IF EQUAL
.
          MOVE      ZERO,SRCHTYPE
          MOVE      "EZ",CATEGORY
          MOVE      SRCHCODE,CODE
          CALL      GETCOD00
          MOVE      TCINDC1,SRCHTYPE
.
          MATCH     "All",SRCHCODE
          IF        @EQUAL
            MOVE      ZERO,SRCHTYPE
          ENDIF
.
          PACK      KEY12,WBSEESC,TWO,SP70
          CALL      RSEMVIS5
INCVIS10  CALL      RKEMVIS5
          BRANCH    OVRCD,INCVIS99
.
          MATCH     EMVISITE,WBSEESC
          GOTO      INCVIS99 IF NOT EQUAL
.
          COMPARE   EMVISTAT,TWO
          GOTO      INCVIS99 IF NOT EQUAL
.
          MOVE      SP70,RESPNAME
          MOVE      SP70,RESPNURE
.  
          PACK      FORMATNM,SP70,SP70
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            GOTO      INCVIS30
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,INCVIS10
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
INCVIS30  PACK      KEY8,EMVIADMN
          CALL      RDEMINC1
          BRANCH    OVRCD,INCVIS10
          BRANCH    SRCHTYPE,INCVIS50,INCVIS60,INCVIS70 
          GOTO      INCVIS80
.
INCVIS50  MATCH     "0",EMIPCCOM
          IF        @EQUAL
            CALL      DOCT0000
            CALL      NURS0000
            GOTO      INCVIS80
          ELSE
            GOTO      INCVIS10
          ENDIF
.
INCVIS60  MATCH     "0",EMIPDCOM
          IF        @EQUAL
            CALL      DOCT0000
            CALL      NURS0000
            GOTO      INCVIS80
          ELSE
            GOTO      INCVIS10
          ENDIF
.
INCVIS70  MATCH     "0",EMIPNCOM
          IF        @EQUAL
            CALL      NURS0000
            CALL      DOCT0000  
            GOTO      INCVIS80
          ELSE
            GOTO      INCVIS10
          ENDIF
.
INCVIS80  CALL      OUTPUT00
          GOTO      INCVIS10
.
INCVIS99  RETURN
.-----------------------------------------------------------
. Incomplete patient registrations
.-----------------------------------------------------------
INCREG00  PACK      KEY12,WBSEESC,ONE,SP70
          CALL      RSEMVIS5
INCREG10  CALL      RKEMVIS5
          BRANCH    OVRCD,INCREG99
.
          MATCH     EMVISITE,WBSEESC
          GOTO      INCREG99 IF NOT EQUAL
.
          COMPARE   EMVISTAT,THREE
          GOTO      INCREG99 IF EQUAL
          GOTO      INCREG99 IF LESS
.
          MATCH     ZEROUR,EMVIURNO
          GOTO      INCREG10 IF NOT EQUAL
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,INCREG10
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.           
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      FORMATNM,SP70,SP70
.
          CALL      OUTPUT00
          GOTO      INCREG10
.
INCREG99  RETURN
.------------------------------------------------------------
. Visits by Location
.------------------------------------------------------------
VISLOC00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      VISHED00              * table heading
.
          PACK      KEY3,SP70
          CALL      RSEMLOC1
.
VISLOC10  MOVE      ZERO,PATCOUNT 
          CALL      RKEMLOC1
          BRANCH    OVRCD,VISLOC99        * no more locations
.
          MATCH     EMLOSCOD,WBSEESC
          GOTO      VISLOC10 IF NOT EQUAL
.
          PACK      KEY11,EMLOLOCA,SP70
          CALL      RSEMVIS7
VISLOC20  CALL      RKEMVIS7              * get all visits for location
          BRANCH    OVRCD,VISLOC30        * no more visits
.
          MATCH     EMLOLOCA,EMVILOCN     * same location?
          GOTO      VISLOC30 IF NOT EQUAL * no, get next location
.
          COMPARE   ONE,EMVISTAT          * current patient?
          IF        !@EQUAL
            CALL      CLRLOC00
            BRANCH    EXIT,VISLOC20
          ENDIF
.
          CALL      VISROW00              * write table contents
          ADD       ONE,PATCOUNT
          GOTO      VISLOC20
.
VISLOC30  COMPARE   ZERO,PATCOUNT         * check for empty location
          IF        @EQUAL
            CALL      EMPTY000            * write out 'empty'
          ENDIF
          WRITE     HTMLFILE;"<tr><td colspan=5 width=100%>":
                             "<img src=../images/TriageLine.gif width=100%>":
                             "</td></tr>"
          GOTO      VISLOC10              * get next location
.
VISLOC99  RETURN
.----------------------------------------------------------------------
. Patient No Longer With Us so Clear the location from the visit
.----------------------------------------------------------------------
CLRLOC00  CALL      MAPCHK00
          COMPARE   ZERO,EXIT                  * Keep ED location populated
          GOTO      CLRLOC90 IF EQUAL
.
.         Broadcast Update Message
.
          MOVE      EMVIURNO,KEY8              * first - get the PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,CLRLOC99
.
          MOVE      EMVIURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,CLRLOC99
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,CLRLOC99
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC                   * send update emr details
.
          MOVE      ONE,EXIT                   * ED location has neen cleared
          GOTO      CLRLOC99                   * So don;t display patient
.
CLRLOC90  MOVE      ZERO,EXIT                  * OK Keep ED location populated
          GOTO      CLRLOC99
.
CLRLOC99  RETURN
.------------------------------------------------------------
. Heading for table of visits by location
.------------------------------------------------------------
VISHED00 WRITE     HTMLFILE;"<tr><td class=HeadingCell colspan=5 ":
                             "width=100% align=center>":
                             "Triage Board </td></tr>":
                             "<tr><td width=10% class=HeadingCell>Location":
                             "<td width=5% align=center class=HeadingCell>":
                             "Triage</td>":
                             "<td width=35% class=HeadingCell>Patient</td>":
                             "<td width=30% class=HeadingCell>Complaint</td>":
                             "<td width=20% class=HeadingCell>Doctor</td></tr>"
VISHED99  RETURN
.------------------------------------------------------------
. Visit by location row
.------------------------------------------------------------
VISROW00  PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          COMPARE   ZERO,OVRCD
          GOTO      VISROW20 IF EQUAL
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          IF        OVRCD=1
            MOVE      "Patient Master/Unknown Patient Record missing",PATTNAME
            GOTO      VISROW45
          ENDIF
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
          GOTO      VISROW30
.
VISROW20  REP       " 0",PBDATE
          MATCH     "00000000",PBDATE
          IF        @EQUAL
            MOVE      "Unk",DISPAGE
            GOTO      VISROW30
          ENDIF
.
          UNPACK    SP70,PSAGECON,PSAGETYP
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          PACK      DISPAGE,SP70
          CLEAR     DISPAGE
          APPEND    PSAGECON,DISPAGE
          APPEND    PSAGETYP,DISPAGE
          RESET     DISPAGE
.
VISROW30  CALL      GDNAM000   * Get doctors name
.         CALL      SETEMR00   * Set Up Fields
.
          MATCH     SP70,PSEX
          IF        @EQUAL
            MOVE      "U",PSEX
          ENDIF
.
          CLEAR     KEY80
          APPEND    PSNAME,KEY80
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PGNAME,KEY80
.
          MATCH     SP70,PTITL
          GOTO      VISROW40 IF EQUAL
.
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PTITL,KEY80
.
VISROW40  APPEND    SP70,KEY80
          RESET     KEY80
          STRIP     KEY80
          MOVELPTR  KEY80,LENGTH
          SFORMAT   PATTNAME,LENGTH
          MOVE      KEY80,PATTNAME
.
VISROW45  MOVE      SP70,DISPSTAT
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,DISPSTAT
              MOVE      SP70,STATIND
            ELSE
              MOVE      TDESC,DISPSTAT
              MOVE      TCINDC2,STATIND
            ENDIF
          ENDIF
.
          MOVE      EMVIADMN,ADMISSNO
          MOVE      EMVIURNO,URNUMBER
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          COMPARE   ZERO,PATCOUNT
          IF        @EQUAL
            COMPARE   ONE,LNK2PRT
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr><td align=right><b>",EMVILOCN,"</b>":
                                 "<a href='javascript:OpenLocation(#"",EMVIURNO:
                                 "#",#"",EMVIADMN,"#")'>":
                                "<img src=../images/LocationIcon.gif border=0>":
                                 "</a></td>"
            ELSE
              WRITE     HTMLFILE;"<tr><td align=center><b>":
                                 "<a href='javascript:updateParent(#"":
                                 EMLODESC,"#",#"",EMLOLOCA,"#")'>":
                                 EMLOLOCA,"</a></b></td>"
            ENDIF
          ELSE
            COMPARE   ONE,LNK2PRT
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr><td align=right>":
                                 "<a href='javascript:OpenLocation(#"",EMVIURNO:
                                 "#",#"",EMVIADMN,"#")'>":
                                "<img src=../images/LocationIcon.gif border=0>":
                                 "</a></td>"
            ELSE
              WRITE     HTMLFILE;"<tr><td width=10% height=30>&nbsp;</td>"
            ENDIF
          ENDIF
.
          CALL      SCLK0000                * Find stop the clock doctor
.
          MATCH     SP70,STOPDTIM
          IF        @EQUAL
            MOVE      EMVIDATE,FIRSTDAT
            UNPACK    EMVITIME,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
          ELSE
            CLEAR     IMAGE
            MOVE      ZERO,F1
            SQUEEZE   EMVITRIG
            MOVE      EMVITRIG,F1
            GOTO      VISROW49
          ENDIF
.
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          CLEAR     IMAGE
          MOVE      ZERO,F1
          SQUEEZE   EMVITRIG
          MOVE      EMVITRIG,F1
.
          CALL      TIMEDIFF
.
          IF        F1=1 & CALCTIME>=TWO
            APPEND    "triage1f",IMAGE
            GOTO      VISROW50
          ENDIF
          IF        F1=2 & CALCTIME>=TEN
            APPEND    "triage2f",IMAGE
            GOTO      VISROW50
          ENDIF
          IF        F1=3 & CALCTIME>=THIRTY
            APPEND    "triage3f",IMAGE
            GOTO      VISROW50
          ENDIF
          IF        F1=4 & CALCTIME>=SIXTY
            APPEND    "triage4f",IMAGE
            GOTO      VISROW50
          ENDIF
          IF        F1=5 & CALCTIME>=120
            APPEND    "triage5f",IMAGE
            GOTO      VISROW50
          ENDIF
.
VISROW49  APPEND    TRIAGE,IMAGE
          APPEND    F1,IMAGE
.
VISROW50  APPEND    GIF,IMAGE
          SQUEEZE   IMAGE 
.
          BRANCH    LNK2PRT,VISROW60,VISROW70
.
VISROW60  WRITE     HTMLFILE;"<td align=center>";
.
          IF        TRIGFLAG=1
            IF        F1=0
              WRITE     HTMLFILE;"<a ":
                                 "href='javascript:TriagePatient(#"",URNUMBER:
                                 "#",#"",ADMISSNO,"#")'>":
                                 "<img src=../images/",IMAGE," hspace=4":
                                 " border=0 align=absmiddle>"
            ELSE
              WRITE     HTMLFILE;"<a ":
                                 "href='javascript:alert(#"Patient ":
                                 "Already Triaged#")#'>":
                                 "<img src=../images/",IMAGE," hspace=4":
                                 " border=0 align=absmiddle>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<img src=../images/",IMAGE,">";
          ENDIF
.
          WRITE     HTMLFILE;"</td><td><a href=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             "<img src=../images/patdet.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PATTNAME," (",PSEX,",",DISPAGE,")</td>":
                             "<td>",EMVICOM1,"&nbsp;</td>":
                             "<td>",DOCTNAME,"&nbsp;</td></tr>"
          GOTO      VISROW90
.
VISROW70  WRITE     HTMLFILE;"<td align=center><img src=../images/",IMAGE:
                             "></td>":
                             "<td><img src=../images/patdet.gif hspace=4":
                             " border=0 align=absmiddle>":
                             PATTNAME," (",PSEX,",",DISPAGE,")</td>":
                             "<td>",EMVICOM1,"&nbsp;</td>":
                             "<td>",DOCTNAME,"&nbsp;</td></tr>"
.
VISROW90  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      VISROW99
.
VISROW95
.
VISROW99  RETURN
.------------------------------------------------------------
. Write empty row
.------------------------------------------------------------
EMPTY000  BRANCH    LNK2PRT,EMPTY100,EMPTY200
.
EMPTY100  WRITE     HTMLFILE;"<tr align=top>":
                    "<td class=HeadingCell align=center><b>":
                    EMLOLOCA,"</b></td>":
                    "<td class=HeadingCell ":
                    " colspan=4 align=center><b>*** Empty ***</b></td>":
                    "</tr>"
          GOTO      EMPTY999
.
EMPTY200  WRITE     HTMLFILE;"<tr align=top>":
                    "<td class=HeadingCell align=center><b>":
                    "<a href='javascript:updateParent(#"",EMLODESC,"#",#"":
                    EMLOLOCA,"#")'>":
                    EMLOLOCA,"</a></b></td>":
                    "<td class=HeadingCell ":
                    " colspan=4 align=center><b>*** Empty ***</b></td>":
                    "</tr>"
          GOTO      EMPTY999
.
EMPTY999  RETURN
.------------------------------------------------------------
. Set EMR Fields for Output
.------------------------------------------------------------
SETEMR00  SFORMAT   SLOCNDES,1
          SFORMAT   STRIGDES,1
          SFORMAT   SEMVICO1,1
          SFORMAT   SEMVICO2,1
          MOVE      SP1,SLOCNDES
          MOVE      SP1,STRIGDES
          MOVE      SP1,SEMVICO1
          MOVE      SP1,SEMVICO2
.
.--------*T0836547
.-------- if getwdbsc=1 and disedssu=1 then
.--------    Use the saved actual ward description from patwr1af that the 
.--------    patient has been admitted to
          COMPARE   ONE,GETWBDSC
          GOTO      SETEMR20 IF NOT EQUAL
.
          MATCH     "1",DISEDSSU
          GOTO      SETEMR20 IF NOT EQUAL
.
          STRIP     SVWBDESC
          MOVELPTR  SVWBDESC,LENGTH
          SFORMAT   SLOCNDES,LENGTH
          MOVE      SVWBDESC,SLOCNDES
          GOTO      SETEMR30
.
.-------- Location description from emrlocaf
SETEMR20  MATCH     SP70,EMVILOCN
          IF        !@EQUAL
            PACK      KEY3,EMVILOCN
            CALL      RDEMLOC1
            IF        OVRCD=0
              STRIP     EMLODESC
              MOVELPTR  EMLODESC,LENGTH
              SFORMAT   SLOCNDES,LENGTH
              MOVE      EMLODESC,SLOCNDES
            ENDIF
          ENDIF
.
SETEMR30  MATCH     SP70,EMVITRIG
          IF        !@EQUAL
            PACK      KEY5,CATAA,EMVITRIG
            CALL      RDCODE1
            IF        OVRCD=0
              STRIP     TDESC
              MOVELPTR  TDESC,LENGTH
              SFORMAT   STRIGDES,LENGTH
              MOVE      TDESC,STRIGDES
            ENDIF
          ENDIF
          PACK      DTRIG,EMVITRIG
          MATCH     DTRIG,SP3
          IF        @EQUAL
            PACK      TRIGDESC,SP70
            PACK      DTRIG,ZEROS
          ENDIF
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          STRIP     TDESC
          MOVELPTR  TDESC,LENGTH
          SFORMAT   SEMVICO1,LENGTH
          MOVE      TDESC,SEMVICO1
.
          STRIP     EMVICOM1
          MOVELPTR  EMVICOM1,LENGTH
          SFORMAT   SEMVICO2,LENGTH
          MOVE      EMVICOM1,SEMVICO2
.
          RETURN
.------------------------------------------------------------
. Get the Doctors Name
.------------------------------------------------------------
GDNAM000  PACK      KEY10,EMVIDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP              * Clear all the file variables
            SFORMAT   DOCTNAME,1
            MOVE      SP70,DOCTNAME
            MOVE      SP70,DOCINIT
            MOVE      SP70,HCPFNAME
            GOTO      GDNAM999
          ENDIF 
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,HCPFNAME
.
          MOVE      SP70,KEY25
          SQUEEZE   PMHCGNAM
          PACK      KEY25,PMHCGNAM,SP1,PMHCSNAM,SP70
          RESET     KEY25
          STRIP     KEY25 
          MOVELPTR  KEY25,LENGTH
          SFORMAT   DOCTNAME,LENGTH
          MOVE      KEY25,DOCTNAME
.
          MOVE      PMHCINIT,DOCINIT
.
GDNAM999  RETURN
.------------------------------------------------------------
. Format the Doctors Name
.------------------------------------------------------------
FDNAM000  PACK      KEY10,EMVIDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP              * Clear all the file variables
            SFORMAT   DOCTNAM2,1
            MOVE      SP70,DOCTNAM2
            MOVE      SP70,DOCINIT
            GOTO      GDNAM999
          ENDIF
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,DOCTNAM2
.
          MOVE      PMHCINIT,DOCINIT
.
FDNAM999  RETURN
.------------------------------------------------------------
. Get the Consultants Name
.------------------------------------------------------------
GCNAM000  PACK      KEY6,EMVIUR01
          CALL      RDDOCT1
          IF        OVRCD=1
            SFORMAT   CONSNAME,1
            MOVE      SP70,CONSNAME
            GOTO      GCNAM999
          ENDIF
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,CONSNAME
.
GCNAM999  RETURN
.------------------------------------------------------------
. Get the Attending Doctors Name
.------------------------------------------------------------
GANAM000  PACK      KEY10,ADOCTA
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP              * Clear all the file variables
            SFORMAT   ADOCNAME,1
            PACK      ADOCNAME,SP70
            GOTO      GANAM999
          ENDIF
.
          MOVE      SP70,KEY25
          PACK      KEY25,PMHCGNAM,SP1,PMHCSNAM,SP70
          RESET     KEY25
          STRIP     KEY25
          MOVELPTR  KEY25,LENGTH
          SFORMAT   ADOCNAME,LENGTH
          MOVE      KEY25,ADOCNAME
.
GANAM999  RETURN
.------------------------------------------------------------
. Get the Patients Name
.------------------------------------------------------------
GPNAM000  STRIP     PSNAME
          STRIP     PGNAME
          STRIP     PTITL
          CLEAR     KEY80
          APPEND    PSNAME,KEY80
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PGNAME,KEY80
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PTITL,KEY80
          APPEND    SP70,KEY80
          RESET     KEY80
          STRIP     KEY80
          MOVELPTR  KEY80,LENGTH
          SFORMAT   PATTNAME,LENGTH
          MOVE      KEY80,PATTNAME
GPNAM999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=post >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=viewtype value=",KEY1,">"
.
          CALL      SELC0000
.
          WRITE     HTMLFILE;"<input type=submit value=Go>":
                             "</form>"
.
SELDAT99  RETURN
.------------------------------------------------------------
. Patients in date range (Attendance List)
.------------------------------------------------------------
PTDAT000  PACK      KEY24,FRSTDATE,SP70
          CALL      RSEMVIS4  
PTDAT010  CALL      RKEMVIS4
          BRANCH    OVRCD,PTDAT999
.
          MATCH     EMVIDATE,LASTDATE
          GOTO      PTDAT999 IF LESS
.
          COMPARE   FOUR,EMVISTAT
          GOTO      PTDAT010 IF EQUAL
.
          COMPARE   ONE,CHECKGP
          IF        !@EQUAL
            MATCH     EMVISITE,WBSEESC
            GOTO      PTDAT010 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            COMPARE   ONE,CHECKGP
            IF        @EQUAL
              CALL      CHGP0000
              BRANCH    EXIT,PTDAT010
              PACK      KEY8,DEMVIADM,SP70
              CALL      RDPMVX11
              BRANCH    OVRCD,PTDAT010
              MATCH     "1",PMVXINGP
              IF        !@EQUAL
                GOTO      PTDAT010
              ENDIF
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      PTDAT030 
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,PTDAT010
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.           
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
PTDAT030  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC
.
          CALL      OUTPUT00
          GOTO      PTDAT010
.
PTDAT999  RETURN
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,EXIT
         MOVE       SP70,GPCODE
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
CHGP9000 MOVE       ONE,EXIT
.
CHGP9999 RETURN
+
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"emrweb01.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&venquiry=",VENQUIRY:
                                 "&contfilt=",CONTFILT:
                                 "&remofilt=",REMOFILT;
.
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"emrweb01.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&venquiry=",VENQUIRY:
                                 "&contfilt=",CONTFILT:
                                 "&remofilt=",REMOFILT;
.
PREV9999  RETURN
.------------------------------------------------------------
. Admitted Patients in date range (Admissions List) 
.------------------------------------------------------------
ADDAT000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1                 * Logged in user
          BRANCH    OVRCD,ADDAT999
.
          MOVE      WBSEESC,LOOPSITE        * Logged in users ED site
.
          PACK      KEY27,LOOPSITE,FRSTDATE,SP70
          CALL      RSEMVIS6
ADDAT010  CALL      RKEMVIS6
          BRANCH    OVRCD,ADDAT999
.
          MATCH     EMVISITE,LOOPSITE       * Correct Site
          GOTO      ADDAT999 IF NOT EQUAL
.
          MATCH     EMVIDATE,LASTDATE       * To Date
          GOTO      ADDAT999 IF LESS
.
          COMPARE   FOUR,EMVISTAT           * Ignore cancelled
          GOTO      ADDAT010 IF EQUAL
.
          COMPARE   ONE,EMVIADMT            * Admitted to hospital
          GOTO      ADDAT010 IF NOT EQUAL
.
          MOVE      LASTDATE,SAVLASDT
          MOVE      SP70,AARRTIME
          CALL      GETLOS00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
          MOVE      SAVLASDT,LASTDATE
.
          PACK      FORMATNM,SP70,SP70
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD            
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000                           
.
            GOTO      ADDAT030
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,ADDAT010
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.           
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70  
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM 
.
ADDAT030  CALL      OUTPUT00
.
          GOTO      ADDAT010
.
ADDAT999  RETURN
.------------------------------------------------------------
.   Update Patient Location
.------------------------------------------------------------
UPPATL00  MATCH     "1",EMCNHISA           * Using ED location management
          IF        @EQUAL
            MATCH     SP70,LOCADATE        * Back dated movement
            GOTO      UPPATL10 IF NOT EQUAL
          ENDIF
.
          CALL      CHKKEY00
          BRANCH    EXIT,UPPATL99
.
UPPATL10  CALL      VALLOC00               * Validate location
          BRANCH    EXIT,UPPATL96
.
          PACK      KEY8,ADMISSNO
          CALL      RDEMVIS1
          BRANCH    OVRCD,UPPATL90
.
          MOVE      ZERO,LOCDTMOV          * Not a location date/time move
          MATCH     "1",EMCNHISA           * Using ED location management
          IF        @EQUAL
            CALL     VHDT0000
            BRANCH   EXIT,UPPATL99
          ENDIF
.
          MOVE      EMVIDOCT,SAVEDOCT      * Save seen date and time for History
          MOVE      EMVIATNS,SAVENURS      * Save seen date and time for History
.
          CALL      VERUSR00
          BRANCH    EXIT,UPPATL99
.
          MOVE      EMVILOCN,SAVELOCN      * Save original location
          MOVE      LOCACODE,NEWLOCAT
          CALL      RETL0000               * Retain patient prev location
.
          MOVE      LOCACODE,EMVILOCN
          CALL      UPEMVIS1              
.
.         Broadcast update message
.
          MOVE      EMVIURNO,KEY8          * first - get the PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,UPPATL70
.
          MOVE      EMVIURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPPATL70
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,UPPATL70
.
          CALL      PMIGTNID               * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC               * send update emr details
.
UPPATL70  IF        LOCDTMOV=1
            CALL      LOCMHS00             * Write location date/time history
            PROC      EMRDRCHR             * Update Dr Billing complete
          ELSE
            CALL      WRTHIS00
          ENDIF
.
          CALL      AUTS0000           * Add/Update Telehealth Services record
.
          MOVE      ZERO,EXIT
          GOTO      UPPATL99
.
UPPATL75  MOVE      "Security invalid for this server",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99
.
UPPATL80  MOVE      "User ID/Password invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99 
.
UPPATL85  MOVE      "User ID invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99
.
UPPATL90  CLEAR     WEBTITLE
          APPEND    "Could not find visit record - ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          RESET     WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99
.
UPPATL95  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99
.
UPPATL96  MOVE      "Location Already occupied",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPATL99
.
UPPATL99  RETURN
.
.------------------------------------------------------------
. Validate location management movement date and time
.------------------------------------------------------------
VHDT0000  MATCH     SP70,LOCADATE           * Blank movement date
          GOTO      VHDT8000 IF EQUAL
.
          MATCH     SP70,LOCATIME           * Blank movement time
          GOTO      VHDT8000 IF EQUAL
.
          MATCH     EMVIDATE,LOCADATE       * Error movement date < arrival date
          GOTO      VHDT9000 IF LESS
.
          MATCH     LOCADATE,EMVIDATE       * Error movement date = arrival date
          IF        @EQUAL
            MATCH     EMVITIME,LOCATIME     * Movement time < arrival time
            GOTO      VHDT9000 IF LESS
          ENDIF
.
          IF        EMVISTAT = 2 | EMVISTAT = 3
            MATCH     LOCADATE,EMVIDDAT     * Error movement date > disch. date
            GOTO      VHDT9100 IF LESS
.
            MATCH     LOCADATE,EMVIDDAT     * Error movement date = disch. date
            IF        @EQUAL
              MATCH     LOCATIME,EMVIDTIM   * Movement time > disch. time
              GOTO      VHDT9100 IF LESS
            ENDIF
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          MATCH     LOCADATE,CURRDATE     * Error movement date > current date
          GOTO      VHDT9300 IF LESS
.
          MATCH     LOCADATE,CURRDATE     * Error movement date = current date
          IF        @EQUAL
            MATCH     LOCATIME,CURRTIME   * Movement time > current time
            GOTO      VHDT9300 IF LESS
          ENDIF
.
          UNPACK    LOCATIME,HOUR,D1,MIN,D1,SEC
          PACK      D8,HOUR,MIN,SEC,SP70
.
          PACK      KEY22,ADMISSNO,LOCADATE,D8,SP70
          CALL      RDEMHIS1
          IF        OVRCD<>1
            GOTO      VHDT9200             * History record exists for date/time
          ENDIF
.
          PACK      KEY22,ADMISSNO,Z70
          CALL      RSEMHIS1
VHDT2000  CALL      RPEMHIS1
          BRANCH    OVRCD,VHDT7000
.
          MATCH     ADMISSNO,EMHIVIS        * Same Visit Number
          GOTO      VHDT7000 IF NOT EQUAL
.
          MATCH     "NEWMV",EMHIUPT         * New move location update type
          IF        !@EQUAL
            MATCH     "MOVEL",EMHIUPT       * Move location update type
            GOTO      VHDT2000 IF NOT EQUAL
          ENDIF
.
          MATCH     EMHIDAT,LOCADATE      * Error new mov date < last mov date
          GOTO      VHDT9400 IF LESS
.
          MATCH     LOCADATE,EMHIDAT      * Error last mov date = mov date
          IF        @EQUAL
            UNPACK    EMHITIM,HOUR,MIN,SEC
            PACK      D8,HOUR,COLON,MIN,COLON,SEC
            REP       " 0",D8
            MATCH     LOCATIME,D8   * New Mov time <  last move time
            GOTO      VHDT9400 IF NOT LESS
          ENDIF
.
VHDT7000  MOVE      ONE,LOCDTMOV          * Yes a location date/time move
.
VHDT8000  MOVE      ZERO,EXIT
          GOTO      VHDT9999
.
VHDT9000  CLEAR     WEBTITLE
          APPEND    "Movement date/time can't be prior to the ",WEBTITLE
          APPEND    "arrival date/time.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VHDT9999
.
VHDT9100  CLEAR     WEBTITLE
          APPEND    "Movement date/time can't be greater than the ",WEBTITLE
          APPEND    "discharge date/time.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VHDT9999
.
VHDT9200  CLEAR     WEBTITLE
          APPEND    "History record already exists for this movement ",WEBTITLE
          APPEND    "date/time.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VHDT9999
.
VHDT9300  CLEAR     WEBTITLE
          APPEND    "Movement date/time cannot be in the future.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VHDT9999
.
VHDT9400  CLEAR     WEBTITLE
          APPEND    "Movement date/time cannot be prior to the ",WEBTITLE
          APPEND    "last movement date/time.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VHDT9999
VHDT9999  RETURN
.
.------------------------------------------------------------
. Write ED location histry movement for a specific date/time
.------------------------------------------------------------
LOCMHS00  UNPACK    LOCATIME,HOUR,D1,MIN,D1,SEC
          PACK      D8,HOUR,MIN,SEC,SP70
.
          PACK      KEY22,ADMISSNO,LOCADATE,D8,SP70
          CALL      RDEMHIS1
          IF        OVRCD<>1
            GOTO      LOCMHS99             * Exit history record existed
          ENDIF
.
          PACK      KEY22,ADMISSNO,LOCADATE,D8,Z70
          CALL      RSEMHIS1
          CALL      RPEMHIS1
          BRANCH    OVRCD,LOCMHS99
.
          MATCH     ADMISSNO,EMHIVIS       * Same Visit Number
          GOTO      LOCMHS99 IF NOT EQUAL
.
          MOVE      ADMISSNO,EMHIVIS       * Visit number
          MOVE      LOCADATE,EMHIDAT       * Date
.
          UNPACK    LOCATIME,HOUR,D1,MIN,D1,SEC
          PACK      EMHITIM,HOUR,MIN,SEC,SP70        * Time hhmmss
.
          MOVE      "MOVEL",EMHIUPT       * NEWMV
          MOVE      LOCACODE,EMHILOC       * New location
.
          MOVE      USERID,EMHIEUS               * Web User Id Created
          PACK      EMHICDAT,CCC,CYY,CMM,CDD     * Date Created
          REP       " 0",EMHICDAT
          CLOCK     TIME,EMHICTIM                * Time Created
          MOVE      USERID,EMHICUID              * Web User Id Created
          MOVE      SP70,EMHIUDAT                * Date Updated
          MOVE      SP70,EMHIUTIM                * Time Update
          MOVE      SP70,EMHIUUID                * Web User Id Updated
          MOVE      SP70,EMHISPA
.
          PACK      KEY22,EMHIVIS,EMHIDAT,EMHITIM,SP70
          CALL      RAEMHIS1
          IF        OVRCD=1
            CALL      WREMHIS1              * Write new movement history record
          ENDIF
.
. Update location for all histroy records after the movement
.
LOCMHS50  CALL      RKEMHIS1
          BRANCH    OVRCD,LOCMHS99
.
          MATCH     ADMISSNO,EMHIVIS       * Same Visit Number
          GOTO      LOCMHS99 IF NOT EQUAL
.
          MOVE      LOCACODE,EMHILOC       * New location
          CALL      UPEMHIS1
.
          GOTO      LOCMHS50
.
LOCMHS99  RETURN
.
.------------------------------------------------------------
. VALLOC00  Checks whether location is already occupied
.
.         Returns:
.           EXIT    0 - empty
.                   1 - occupied
.------------------------------------------------------------
VALLOC00  PACK      KEY3,LOCACODE,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,VALLOC90
.
          MATCH     "O",EMLOTYPE            * Other Departments
          GOTO      VALLOC90 IF EQUAL
.
          MATCH     "W",EMLOTYPE            * Waiting Room
          GOTO      VALLOC90 IF EQUAL
.
          MATCH     "E",EMLOTYPE            * Emergency Telehealth Service
          GOTO      VALLOC90 IF EQUAL
.
          MOVE      ZERO,LOCNCNTR
          PACK      KEY11,LOCACODE,SP70
          CALL      RSEMVIS7
VALLOC20  CALL      RKEMVIS7
          BRANCH    OVRCD,VALLOC85
.
          MATCH     LOCACODE,EMVILOCN
          GOTO      VALLOC85 IF NOT EQUAL
.
          MATCH     ADMISSNO,DEMVIADM
          GOTO      VALLOC20 IF EQUAL
.
          COMPARE   ONE,EMVISTAT
          GOTO      VALLOC20 IF NOT EQUAL
.
          MATCH     EMVISITE,WBSEESC
          GOTO      VALLOC20 IF NOT EQUAL
.
          ADD       ONE,LOCNCNTR
          GOTO      VALLOC20
.
VALLOC85  IF          EMLOMAXP = 0
            GOTO        VALLOC90                  * Zero assumes unlimited!!!!!!
          ENDIF
.
          IF        LOCNCNTR < EMLOMAXP
            GOTO      VALLOC90
          ENDIF
.
          MOVE      ONE,EXIT
          GOTO      VALLOC99
.
VALLOC90  MOVE      ZERO,EXIT
          GOTO      VALLOC99
.
VALLOC99  RETURN
.
.------------------------------------------------------------
.         Output updateky
.------------------------------------------------------------
UKEY0000  PACK      KEY22,EMVIADMN,Z70
          PACK      UPDATEKY,EMVIADMN,SP70
          CALL      RSEMHIS1
          CALL      RPEMHIS1
          BRANCH    OVRCD,UKEY9999
          MOVE      EMVIADMN,KEY8
          MATCH     KEY8,EMHIVIS
          GOTO      UKEY9999 IF NOT EQUAL
.
          REP       " 0",EMHIDAT
          REP       " 0",EMHITIM
          PACK      UPDATEKY,EMHIVIS,EMHIDAT,EMHITIM
.
UKEY9999  RETURN
.------------------------------------------------------------
.         CHKKEY00
.------------------------------------------------------------
CHKKEY00  MOVE      ZERO,EXIT
          PACK      KEY22,ADMISSNO,Z70
          PACK      TESTKEY,ADMISSNO,SP70
          CALL      RSEMHIS1
          CALL      RPEMHIS1
          BRANCH    OVRCD,CHKKEY90
          MATCH     ADMISSNO,EMHIVIS
          GOTO      CHKKEY90 IF NOT EQUAL
.
          REP       " 0",EMHIDAT
          REP       " 0",EMHITIM
          PACK      TESTKEY,EMHIVIS,EMHIDAT,EMHITIM
.
CHKKEY90  MATCH     TESTKEY,UPDATEKY
          GOTO      CHKKEY99 IF EQUAL
.
CHKKEY95  MOVE      "Invalid Update Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKKEY99  RETURN
.------------------------------------------------------------
.         Verify Username/password/security level for update type
.------------------------------------------------------------
VERUSR00  MOVE      UPDTTYPE,KEY5
          CALL      RDEMUTY1
          BRANCH    OVRCD,VERUSR95
.
          MATCH     "0",EMUTSID            * Security ID Required?
          GOTO      VERUSR70 IF EQUAL      * no - dont check for pwd/sec level
.
          PACK      KEY80,USERNAME,SP256   * check for valid user ID
          CALL      RDWBSE7
          IF        OVRCD=1
            REP       LOWUPP,KEY80
            CALL      RDWBSE7
            BRANCH    OVRCD,VERUSR85
          ENDIF
.
          MATCH     "0",EMUTPWD            * password required
          GOTO      VERUSR70 IF EQUAL      * no - check for name/sec level
.
.         check for user/password on apache file
.
          MOVE      USERNAME,SECUREID
          MOVE      PASSWORD,SECUREPW
          CALL      VFYUSR00
          BRANCH    EXIT,VERUSR80
.
VERUSR70  MATCH     SP70,EMUTSLV      * No security level set so ok to continue
          IF        @EQUAL
            PACK      KEY18,WBSEUID,PRGID,SP70
            CALL      RDWBST1
            IF        OVRCD=1
              MOVE      WBSEUID,WBSTUID     * WBSTUID used in WRTHIS00
              MOVE      SP70,WBSTPRG
              MOVE      ZERO,WBSTLEV
            ENDIF
            MOVE      ZERO,EXIT
            GOTO      VERUSR99
          ENDIF
.
          PACK      KEY18,WBSEUID,PRGID,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,VERUSR75
.
          MOVE      ZERO,F2
          MOVE      EMUTSLV,FORM2     * level required>user sec level??
          IF        FORM2>WBSTLEV
            MOVE      "Security level inadquate for this update type",WEBTITLE
            GOTO      VERUSR98
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      VERUSR99
.
VERUSR75  MOVE      "Security invalid for this server",WEBTITLE
          GOTO      VERUSR98
.
VERUSR80  MOVE      "User ID/Password invalid",WEBTITLE
          GOTO      VERUSR98
.
VERUSR85  MOVE      "User ID invalid",WEBTITLE
          GOTO      VERUSR98
.
VERUSR95  MOVE      "Invalid Update Type",WEBTITLE
          GOTO      VERUSR98
.
VERUSR98  MOVE      ONE,EXIT
          CALL      WEBERR00
.
VERUSR99  RETURN
.------------------------------------------------------------
.         Write history record
.------------------------------------------------------------
WRTHIS00  MOVE      SP70,SAVEDRDT
          MOVE      SP70,SAVEDRTM
          MOVE      SP70,SAVENRDT
          MOVE      SP70,SAVENRTM
          MOVE      SP70,SAVEDOCT
          MOVE      SP70,SAVENURS
.
          PACK      KEY22,ADMISSNO,Z70
          CALL      RSEMHIS1
WRTHIS05  CALL      RPEMHIS1
          BRANCH    OVRCD,WRTHIS10
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      WRTHIS10 IF NOT EQUAL
.
          MOVE      EMHIDSD,SAVEDRDT
          MOVE      EMHIDST,SAVEDRTM
          MOVE      EMHINSD,SAVENRDT
          MOVE      EMHINST,SAVENRTM
          MOVE      EMHIDOC,SAVEDOCT
          MOVE      EMHINUR,SAVENURS
.
WRTHIS10  MOVE      EMVIADMN,EMHIVIS
          CLOCK     TIME,CTIMEIS
.
          PACK      EMHIDAT,CCC,CYY,CMM,CDD
          REP       " 0",EMHIDAT
          UNPACK    CTIMEIS,HOUR,D1,MIN,D1,SEC
          PACK      EMHITIM,HOUR,MIN,SEC
          REP       " 0",EMHITIM
.
          MATCH     SAVEDOCT,EMVIDOCT       * Is this a new doctor
          IF        @EQUAL
            MOVE      SAVEDRDT,EMHIDSD        * Restore current doctor date and
            MOVE      SAVEDRTM,EMHIDST        * time
          ELSE
            PACK      EMHIDSD,CCC,CYY,CMM,CDD * New doctor so seen date and time
            REP       " 0",EMHIDSD            * are set the current and time
            PACK      EMHIDST,HOUR,MIN,SEC
            REP       " 0",EMHIDST
          ENDIF
.
          MATCH     SAVENURS,EMVIATNS       * Is this a new nurse
          IF        @EQUAL
            MOVE      SAVENRDT,EMHINSD        * Restore current nurse date and
            MOVE      SAVENRTM,EMHINST        * time
          ELSE
            PACK      EMHINSD,CCC,CYY,CMM,CDD * New nurse so seen date and time
            REP       " 0",EMHINSD            * are set the current and time
            PACK      EMHINST,HOUR,MIN,SEC
            REP       " 0",EMHINST
          ENDIF
.
WRTHIS40  MOVE      UPDTTYPE,EMHIUPT
          MOVE      WBSTUID,EMHIEUS
          MOVE      EMVILOCN,EMHILOC
          MOVE      EMVIDOCT,EMHIDOC
          MOVE      EMVIATNS,EMHINUR
          PACK      EMHISPA,SP70,SP70
          PACK      EMHIDSD,EMHIDSD,SP70
          PACK      EMHIDST,EMHIDST,SP70
          PACK      EMHINSD,EMHINSD,SP70
          PACK      EMHINST,EMHINST,SP70
.
          MATCH     SP70,EMHINUR
          IF        @EQUAL
            MOVE      SP70,EMHINSD
            MOVE      SP70,EMHINST
          ENDIF
.
          MATCH     SP70,EMHIDOC
          IF        @EQUAL
            MOVE      SP70,EMHIDSD
            MOVE      SP70,EMHIDST
          ENDIF
.
          CALL      IBACLOCK
          PACK      EMHICDAT,CCC,CYY,CMM,CDD  * Date Record Created (ccyymmdd)
          REP       " 0",EMHICDAT
          CLOCK     TIME,EMHICTIM             * Time Record Created (hh:mm:ss)
          MOVE      USERID,EMHICUID           * Web User Id Created (websecaf)
.
          MOVE      SP70,EMHIUDAT      * Date Record Updated (ccyymmdd)
          MOVE      SP70,EMHIUTIM      * Time Record Updated (hh:mm:ss)
          MOVE      SP70,EMHIUUID      * Web User Id Updated (websecaf)
.
WRTHIS80  PACK      KEY22,EMHIVIS,EMHIDAT,EMHITIM
          CALL      RAEMHIS1
          IF        OVRCD=1
            MOVE      SP70,EMHIDRBC          * Dr Billing Complete
            CALL      WREMHIS1
          ELSE
            CALL      IBACLOCK                   * Set new date and time and
            PACK      EMHIDAT,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",EMHIDAT
            CLOCK     TIME,CTIMEIS
            UNPACK    CTIMEIS,HOUR,D1,MIN,D1,SEC
            PACK      EMHITIM,HOUR,MIN,SEC
            REP       " 0",EMHITIM
            GOTO      WRTHIS80
          ENDIF
.
          PROC      EMRDRCHR            * Update Dr Billing complete
          MOVE      ZERO,EXIT
.
WRTHIS99  RETURN
+
.------------------------------------------------------------
.         OUTPUT00  Output row
.------------------------------------------------------------
OUTPUT00  PACK      AGEINDAY,SP70
.
          IF        UNKFLAG=1
             MATCH    SP70,EMUNBDAT         * Unknow patient with no date of
             GOTO     OUTPUT10 IF EQUAL     * birth
.
             MOVE      EMUNBDAT,PBDATE 
          ENDIF
.
          REP       " 0",PBDATE
          MATCH     "00000000",PBDATE
          IF        @EQUAL
            MOVE      "Unk",DISPAGE
            GOTO      OUTPUT10
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          PACK      DISPAGE,SP70
          CLEAR     DISPAGE
          APPEND    PSAGECON,DISPAGE
          APPEND    PSAGETYP,DISPAGE
          RESET     DISPAGE
.
          PACK      AGEINDAY,PSAGEDAY,SP70   * age in days
.
OUTPUT10  CALL      FDNAM000   * Get Doctors Name
          CALL      GDNAM000   * Get Doctors Name
          CALL      GCNAM000   * Get Consultant Name
          CALL      GPNAM000   * Get Patients Name
          CALL      SETEMR00   * Set Up Fields
          CALL      UKEY0000   * Set up updateky
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MATCH     SP70,EMVISRCE
          IF        !@EQUAL
            PACK      KEY5,CATS,EMVISRCE
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      SRCEDESC,SP70
              PACK      SRCEIN12,SP70
            ELSE
              PACK      SRCEDESC,TDESC
              PACK      SRCEIN12,TCINDC12
            ENDIF
          ELSE
            PACK      SRCEDESC,SP70
            PACK      SRCEIN12,SP70
          ENDIF
.
          MATCH     SP70,EMVICLAS
          IF        !@EQUAL
            PACK      KEY5,CATA,EMVICLAS
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      CLASDESC,SP70
              PACK      CLASIN12,SP70
            ELSE
              PACK      CLASDESC,TDESC
              PACK      CLASIN12,TCINDC12
            ENDIF
          ELSE
            PACK      CLASDESC,SP70
            PACK      CLASIN12,SP70
          ENDIF
.
          MATCH     SP70,EMVIUC29
          IF        !@EQUAL
            PACK      KEY5,CATEU,EMVIUC29,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      RESADESC,SP70
            ELSE      
              PACK      RESADESC,TDESC
            ENDIF
          ELSE
            PACK      RESADESC,SP70
          ENDIF
.
          MATCH     SP70,EMVIUC34
          IF        !@EQUAL
            PACK      KEY5,CATYQ,EMVIUC34,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      FOLODESC,SP70
              PACK      LONGDESC,SP70
            ELSE
              PACK      FOLODESC,TDESC
              PACK      LONGDESC,PTCDLDES
            ENDIF
          ELSE
            PACK      FOLODESC,SP70
            PACK      LONGDESC,SP70
          ENDIF
.
          PACK      KEY5,EMVIDEST,SP70
          MATCH     SP70,KEY5
          IF        @EQUAL
            PACK      DPTVADES,SP70,SP70
          ELSE
            CALL      RDPTVAD1
            MOVE      PTVADESC,DPTVADES
          ENDIF
.
          MOVE      SP70,DISPSTAT
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,DISPSTAT
              MOVE      SP70,STATIND
            ELSE
              MOVE      TDESC,DISPSTAT
              MOVE      TCINDC2,STATIND
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPUC28
.
          MATCH     SP70,EMVIPADM
          IF        !@EQUAL
            PACK      KEY8,EMVIPADM
            CALL      RDMISS1
            IF        OVRCD=0
              COMPARE   ONE,ASTAT      * Pre-admission?
              IF        !@EQUAL
                MOVE      "Completed",DISPUC28   * Not a pre-admission
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,DISPUC28
          IF        @EQUAL
            MATCH     SP70,EMVIUC28
            IF        !@EQUAL
              PACK      KEY5,CATET,EMVIUC28
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,DISPUC28
              ENDIF
            ENDIF
          ENDIF
.
          CALL      BEDS0000                * Ward/Bed Request
          PACK      DIM80,SP70,SP70
          MATCH     SP70,DISPBEDS
          IF        !@EQUAL
            MOVE      DISPBEDS,DIM80
            MATCH     "2",PMBRRSTA            * Allocated?
            IF        @EQUAL
              ENDSET    DIM80
.
              MATCH     SP70,PMBRRDAT
              IF        !@EQUAL
                APPEND    "<br>",DIM80
                APPEND    "<br>",DIM80
                UNPACK    PMBRRDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
                PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
                APPEND    DISPDATE,DIM80

                MATCH     SP70,PMBRRTIM
                IF        !@EQUAL
                  APPEND    "&nbsp;at&nbsp;",DIM80
                  APPEND    PMBRRTIM,DIM80
                ENDIF
              ENDIF
.
              RESET     DIM80
            ENDIF
          ENDIF
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
OUTPUT11  CALL      RKEMVCD1
          BRANCH    OVRCD,OUTPUT15
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      OUTPUT15 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      OUTPUT12 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      OUTPUT11 IF NOT EQUAL
.
OUTPUT12  MATCH     "000",EMVCSEQU
          GOTO      OUTPUT11 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
OUTPUT15  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          MATCH     "       0",EMVIPADM
          GOTO      OUTPUT20 IF EQUAL
.
          PACK      KEY8,EMVIPADM
          CALL      RDMISS1
          BRANCH    OVRCD,OUTPUT20
.
          CALL      GANAM000              *     Get Attending Doctor
.
          MATCH     SP70,EMVIEWRD           * Use admitted ward/bed if expected
          GOTO      OUTPUT20 IF NOT EQUAL   * ward/bed is blank
.
          PACK      KEY30,EMVIPADM,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,OUTPUT20
.         
          MATCH     DTADMN,EMVIPADM
          IF        @EQUAL
            MOVE      TWARD,EMVIEWRD
            MOVE      TBED,EMVIEBED
          ENDIF
.
OUTPUT20  MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          MOVE      EMVIDATE,ICDRDDTE
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          MATCH     ANSP,REPTTYPE
          IF        @EQUAL
            CALL      PRTROW00
          ELSE
            REP       "#"'\/",SEMVICO1
            REP       "#"'\/",SEMVICO2
.
            CALL      PATFLD00              *Returns KEY3 for folder colour code
            MOVE      KEY3,FOLDERSF
.
            IF        EMVISTAT=1
              MOVE      SP70,EMVIDDAT            * Clear discharge date/time
              MOVE      SP70,EMVIDTIM            * if not discharged
            ENDIF
.
            CALL      EWRD0000                   * Get expected ward description
            CALL      AWRD0000                   * Get admission wrd description
.
            CALL      FFDIAG00                   * Get Free Format Diag and 
.                                                * ICD10 Desc
            CALL      DOCTSN00
            CALL      DOCTAT00  
            CALL      NURSAT00
            CALL      CURLOC00
.
            COMPARE   ONE,FHIRTYPE
            GOTO      OUTPUT80 IF EQUAL
.
            WRITE     HTMLFILE;"   obj.AddPatient(#"",PATTNAME,"#",": * 0
                               "#"",EMVILOCN,"#",":                   * 1
                               "#"",SLOCNDES,"#",":                   * 2
                               "#"",EMVIURNO,"#",":                   * 3
                               "#"",EMVIADMN,"#",":                   * 4
                               "#"",DTRIG,"#",":                      * 5
                               "#"",STRIGDES,"#",":                   * 6
                               "#"",EMVIDATE,EMVITIME,"#",":          * 7
                               "#"",PSEX,"#",":                       * 8
                               "#"",DISPAGE,"#",":                    * 9
                               "#"",SEMVICO1," ",SEMVICO2,"#",":      * 10
                               "#"",HCPFNAME,"#",":                   * 11
                               "#"",EMVIDRDT,EMVIDRTM,"#",":          * 12
                               "#"",DOCINIT,"#",":                    * 13
                               "#"",EMVIATNS,"#",":                   * 14
                               "#"",UPDATEKY,"#",":                   * 15
                               "#"",EMVIADMT,"#",":                   * 16
                               "#"",DPTVADES,"#",":                   * 17
                               "#"",SPTVADES,"#",":                   * 18
                               "#"",DISPSTAT,"#",":                   * 19
                               "#"",ADOCNAME,"#",":                   * 20
                               "#"",EMVIPADM,"#",":                   * 21
                               "#"",EMVIEWRD,"#",":                   * 22
                               "#"",EMVIDDAT,EMVIDTIM,"#",":          * 23
                               "#"",DISDIAG,"#",":                    * 24
                               "#"",EMVIUC02,"#",":                   * 25
                               "#"",STATIND,"#",":                    * 26
                               "#"",SRCEDESC,"#",":                   * 27
                               "#"",CONSNAME,"#",":                   * 28
                               "#"",EMVIEWRD,"/",EMVIEBED,"#",":      * 29
                               "#"",EMVIUC20,"#",":                   * 30
                               "#"",AARRTIME,"#",":                   * 31
                               "#"",UNITDISP,"#",":                   * 32
                               "#"",EMVIDOCT,"#",":                   * 33
                               "#"",COMPDISP,"#",":                   * 34
                               "#"",RESPNAME,"#",":                   * 35
                               "#"",RESPNURE,"#",":                   * 36  
                               "#"",FOLDERSF,"#",":                   * 37  
                               "#"",DOCTNAM2,"#",":                   * 38
                               "#"",FORMATNM,"#",":      * I-48257    * 39
                               "#"",EMVIUD03,EMVIUT03,"#",":          * 40
                               "#"",EMVIUD04,EMVIUT04,"#",":          * 41
                               "#"",EMVICOMP,"#",":                   * 42
                               "#"",DIM80,"#",":                      * 43
                               "#"",DISPUC28,"#",":                   * 44
                               "#"",AGEINDAY,"#",":                   * 45
                               "#"",EMVIUR01,"#",":                   * 46
                               "#"",EMVIUD01,EMVIUT01,"#",#"";        * 47
.
            MOVE      EMVIADMN,PVIBILL
            CALL      VCDM0000                  * 48 Visit based CDM Icons
.
            COMPARE     SFDSTIME,ZERO
            IF        @EQUAL
              MOVE    "",_SFDTEMP
            ELSE
              MOVE    SFDSTIME,_SFDTEMP
            ENDIF
.   
            MOVE      SP70,DISPUC16
            MOVE      SP70,TEAMCOLR
            MATCH     SP70,EMVIUC16
            IF        !@EQUAL
              PACK      KEY5,CATEH,EMVIUC16
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,DISPUC16
                MOVE       PTCDUDF3,TEAMCOLR
              ENDIF
            ENDIF
.
            CALL      FRMHCP00
            CALL      FRMNUR00
.
            MOVE      LASTDATE,SAVELDAT       *   Ensure list range saved
            CALL      GETNUT00
            MOVE      SAVELDAT,LASTDATE       *   Undo overwrite from call
.
            MOVE      EMVIDRTM,DOCTSTIM
.
            WRITE     HTMLFILE;"#",#"",_SFDTEMP,"#",":                  * 49
                               "#"",DISPSTAT,"<br>",DPTVADES,"#",":     * 50
                               "#"",RESADESC,"#",":                     * 51
                               "#"",DISDIAGF,"#",":                     * 52
                               "#"",CLASDESC,"#",":                     * 53  Health Speciality
                               "#"",CLASIN12,"#",":                     * 54  Health Speciality Indicator
                               "#"",SRCEIN12,"#",":                     * 55  Referral Source Indicator
                               "#"",EDDISDIA,"#",":                     * 56  
                               "#"",EMVICOM1,"#",":                     * 57
                               "#"",EWRDDESC,"#",":                     * 58
                               "#"",EWRBDESC,"#",":                     * 59
                               "#"",DISPUC16,"#",":                     * 60
                               "#"",DISDIAG2,"#",":                     * 61
                               "#"",HCPSHNME,"#",":                     * 62
                               "#"",NURSHNME,"#",":                     * 63
                               "#"",DOCTSTIM,"#",":                     * 64
                               "#"",AWRDDESC,"#",":                     * 65
                               "#"",AWRBDESC,"#",";                     * 66
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",EDDISDIA,"#",";                   * 67
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":
    "<img src=../images/ActionIcon.gif ":
    "onclick=document.SelectPeriod.acnurnum.value='",EMVIURNO,"';":
    "document.SelectPeriod.acnadmno.value='",DEMVIADM,"';":
    "document.SelectPeriod.acnestat.value='",EMVISTAT,"';":
    "AddClinNote(); border=0>&nbsp;&nbsp;",EDDISDIA,"#",";              * 67
.
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;"#"",SENDNAME,"#",":                     * 68
                               "#"",EMVIUR04,"#",":                     * 69
                               "#"",STOPDTIM,"#",":                     * 70
                               "#"",CURLOCDS,"#",":                     * 71
                               "#"",FOLODESC,"#",":                     * 72
                               "#"",LONGDESC,"#",";                     * 73
.
            MOVE      SP70,LOSTIME
            MATCH     SP70,EMVIDDAT
            IF        @EQUAL            
              MOVE      LASTDATE,SAVELDAT       *   Ensure list range saved
              CALL      GETLOS00                *   Routine to get time diff
              MOVE      WAITTIME,LOSTIME
              MOVE      SAVELDAT,LASTDATE       *   Undo overwrite from call
            ENDIF
.
            MOVE      SP70,LOSDTIME             
            MOVE      LASTDATE,SAVELDAT       
            CALL      GETLOS00                  * get time diff  - Discharged
            MOVE      WAITTIME,LOSDTIME         * length of stay - Discharged
            MOVE      SAVELDAT,LASTDATE         * 
..           
            MOVE      SP70,VDELAYED             * Not delayed
            PACK      KEY29,DEMVIADM,SP70
            CALL      RSEMDEL1
OUTPUT70    CALL      RKEMDEL1                  * Check for active delay reason
            BRANCH    OVRCD,OUTPUT71            * record
.
            MATCH     EMDEVISN,DEMVIADM         * Correct visit
            GOTO      OUTPUT71 IF NOT EQUAL
.
            MATCH     "1",EMDEDELT               * deleted
            GOTO      OUTPUT70 IF EQUAL
.
            MOVE      ONE,VDELAYED               * Yes visit delayed
            
OUTPUT71    MOVE      SP70,VDISCHRD
            MOVE      VDELAYED,VDISCHRD
            MATCH     SP70,EMVIDDAT
            IF        !@EQUAL
              MOVE    TWO,VDISCHRD              * flag patient   - Discharged
            ENDIF
.
.
            WRITE     HTMLFILE;"#"",LOSTIME,"#",":                     * 74
                               "#"",VDELAYED,"#",":                    * 75
                               "#"",DISPFAST,"#",":                    * 76
                               "#"",DISPDTYP,"#",":                    * 77
                               "#"",DISPML01,"#",":                    * 78
                               "#"",DISPML03,"#",":                    * 79
                               "#"",DISPML05,"#",":                    * 80
                               "#"",DISPML07,"#",":                    * 81
                               "#"",DISPMENU,"#",":                    * 82
                               "#"",PMNUUPDD,"#",":                    * 83
                               "#"",DIETCLAS,"#",":                    * 84
                               "#"",HTMLLNK2,"#",":                    * 85
                               "#"",PMNUCOM1,PMNUCOM2:                 * 86
                               PMNUCOM3,PMNUCOM4:                          
                               PMNUCOM5,"#",":                   
                               "#"";
.
            CALL      ALERTI00                        * Display Alerts
            CALL      DALD0000                        * Food Allergies
.
            WRITE     HTMLFILE;"#",":                                  * 87
                               "#"",PTITL,"#",":                       * 88
                               "#"",PSNAME,"#",":                      * 89
                               "#"",PGNAME,"#",":                      * 90
                               "#"",TEAMCOLR,"#",":                    * 91
                               "#"",LOSDTIME,"#",":                    * 92
                               "#"",VDISCHRD,"#"";                     * 93
            WRITE     HTMLFILE;");"
.
          ENDIF
          GOTO      OUTPUT90 
.
. Output FHIR Encounter Resource for Current Emergency Visit
.
OUTPUT80  MATCH     "       0",EMVIURNO    * Zero U/R Not available on FHIR Interface
          GOTO      OUTPUT90 IF EQUAL      * No way currently to reference FHIR Patient Resource
.
          CALL      FHRCLR00
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
          PACK      FHRENCID,EMVIURNO,DEMVIADM,SP70
          PACK      FHRPATID,EMVIURNO,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRENCID
          MOVE      EMVIURNO,URNUMBER
          MOVE      DEMVIADM,ADMISSNO
.
          MOVE      "EMER",FHRCLAS
          MOVE      "arrived",FHRSTAT
          MATCH     SP70,EMVITRIG
          IF        !@EQUAL
            MOVE      "triaged",FHRSTAT
          ENDIF
          MATCH     SP70,EMVIDOCT
          IF        !@EQUAL
            MOVE      "in-progress",FHRSTAT
          ENDIF
.
          MOVE      PATTNAME,FHRPATN
          MOVE      SEMVICO1,FHRREAS
.
          CLEAR     FHRWLOCC
          APPEND    "EmergencyLocation-",FHRWLOCC
          APPEND    EMVILOCN,FHRWLOCC
          RESET     FHRWLOCC
          MOVE      SLOCNDES,FHRLOCN
.
          UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          UNPACK    EMVITIME,KEY5
          MOVE      ":00",KEY3
          PACK      FHRSTRDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,KEY5,KEY3,TIMEZONE
.
          MOVE     "CON",FHRDOCT1  *  Doctor  Type
          MOVE     EMVIDOCT,FHRDOCC1  *  Doctor  Code
          MOVE     CONSNAME,FHRDOCN1  *  Doctor  Name
          MOVE     SP70,FHRDOCT2  *  Doctor  Type
          MOVE     SP70,FHRDOCC2  *  Doctor  Code
          MOVE     SP70,FHRDOCN2  *  Doctor  Name
.         
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Encounter/",FHRENCID,"#", ":
                    " #"resource#" : ";
          CALL     RESENC00            * FHIR Resource Encounter
          WRITE    HTMLFILE;*+,"}"
.
          IF       FHRSUBIN=1
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}"
          ENDIF
.
          IF       FHRPARIN=1
.
            MATCH     SP70,EMVIDOCT
            IF        !@EQUAL
.
              PACK      KEY10,EMVIDOCT,SP70
              CALL      RDPMHCP1
              IF        OVRCD = 0
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF    
.
          ENDIF
.UPTOHERE
          IF       FHRLOCIN=1
.
            MATCH    SP70,EMVILOCN
            IF       !@EQUAL & !@EOS
.
              PACK      KEY3,EMVILOCN,SP70
              CALL      RDEMLOC1             
              IF        OVRCD = 0
.
                MOVE      SP70,DIM3
.
                PACK      KEY3,EMLOSCOD,SP70
                CALL      RDEMSIT1
                IF        OVRCD=0
                  MOVE      EMSTHSNO,DIM3
                ENDIF
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRLOCC,"#", ":
                          " #"resource#" : ";
                CALL     RESWRD00         * FHIR Resource Location Emergency Loc
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
OUTPUT90  MOVE      ZERO,UNKFLAG
.
OUTPUT99  RETURN
.------------------------------------------------------------
. FHIR Diagnosis and Procedures Related to Encounter
.------------------------------------------------------------
RESDIA00  
RESDIA99  RETURN
.--------------------------------------------------------------------------------
.--------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.--------------------------------------------------------------------------------
RESEXT00
          WRITE    HTMLFILE;*+,", #"priority#" :  {":
                   " #"coding#" : [ {":
                   "  #"system#" : #"%BASEURL/ValueSet/Category-AA#",":
                   "  #"code#" : #"",DTRIG,"#",":
                   "  #"display#" : #"",STRIGDES,"#"":
                   " } ] ":
                   "}  ";
RESEXT99  RETURN
.------------------------------------------------------------
. Get expected ward/bed description
.------------------------------------------------------------
EWRD0000  MOVE      SP70,EWRDDESC
          MOVE      SP70,EWRBDESC
.
          MATCH     SP70,EMVIEWRD              * No expected ward
          GOTO      EWRD9999 IF EQUAL
.
          PACK      EWRDDESC,EMVIEWRD,SP70
.
          CLEAR     EWRBDESC
          APPEND    EMVIEWRD,EWRBDESC
.
          MATCH     SP70,EMVIEBED
          IF        !@EQUAL
            APPEND    "/",EWRBDESC
            APPEND    EMVIEBED,EWRBDESC
          ENDIF
          RESET     EWRBDESC
.
          MOVE      ZERO,F1
          MOVE      PTCNWBDS,F1  * ward bed name option none,long,short
.
          COMPARE   ZERO,F1
          GOTO      EWRD9999 IF EQUAL
.
          PACK      KEY6,EMVIEWRD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EWRD9999
.
          IF         F1 = 2
            MOVE       PTWDSDES,EWRDDESC
          ELSE
            MOVE       WBDESC,EWRDDESC
          ENDIF
.
          MOVE      EWRDDESC,EWRBDESC
.
          MATCH     SP70,EMVIEBED              * No expected bed
          GOTO      EWRD9999 IF EQUAL
.
          PACK      KEY6,EMVIEWRD,EMVIEBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EWRD9999
.
          CLEAR     EWRBDESC
          APPEND    EWRDDESC,EWRBDESC
          APPEND    "/",EWRBDESC
.
          IF        F1 = 2
            APPEND     PTWDSDES,EWRBDESC
          ELSE
            APPEND     WBDESC,EWRBDESC
          ENDIF
.
EWRD9999  RETURN
.
.------------------------------------------------------------
.  Lookup Code to get description
.------------------------------------------------------------
LOKCOD00  PACK      CODEDESC,SP70
          BRANCH    EMVCCSYS,LOKCOD10,LOKCOD99,LOKCOD99,LOKCOD99,LOKCOD50
.
.   User Defined
.
          GOTO      LOKCOD99
.
LOKCOD10  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDPTICD1
          IF        OVRCD=1
            MOVE      "Invalid Diagnosis Code ",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      DDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD50  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDEMICD1
          IF        OVRCD=1
            MOVE      "Invalid Emergency Diagnosis Code",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      EMICDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD99  RETURN
.
.------------------------------------------------------------
. Selects Day, Week or Month from Viewtype
.------------------------------------------------------------
SELC0000  MATCH     "1",VIEWTYPE
          GOTO      SELC2000 IF EQUAL
          MATCH     "2",VIEWTYPE
          GOTO      SELC4000 IF EQUAL
.
.Defaults to Daily Viewtype
.--------------------------
.
          WRITE     HTMLFILE;"<select name=dateselc> "
..                             "onChange=#"GoDate(this);#">";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "6",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-6",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
SELC1000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      CCYY,CCENT,CYEAR
          REP       " 0",CCYY
          MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                               DAYNAM,SP1,CDAY,SP1,MTHNAM,SP1,CCYY,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                               DAYNAM,SP1,CDAY,SP1,MTHNAM,SP1,CCYY,"</option>"
          ENDIF
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELC1000 IF NOT EQUAL
          GOTO      SELC9000
.
.Select Weekly Viewtype
.--------------------------
SELC2000  WRITE     HTMLFILE;"<select name=dateselc>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.
SELC3000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>Week of ":
                               CDAY,SP1,MTHNAM,SP1,CCENT,CYEAR,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                               CDAY,SP1,MTHNAM,SP1,CCENT,CYEAR,"</option>";
          ENDIF
          MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELC3000 IF NOT EQUAL
          GOTO      SELC9000
.
.
.Select Monthly Viewtype
.------------------------
.
SELC4000  WRITE     HTMLFILE;"<select name=dateselc>";
          UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<0
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
SELC5000  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
          MATCH     KEY6,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               MTHNAM,SP1,F4,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">":
                               MTHNAM,SP1,F4,"</option>";
          ENDIF
          ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      SELC5000 IF NOT EQUAL
.
SELC9000  WRITE     HTMLFILE;"</select>"
          RETURN
.------------------------------------------------------------
. Print lists of patients
.------------------------------------------------------------
PRTLST00  CALL      OPNPRINT
          CALL      HEAD0000
          MOVE      ZERO,PATCOUNT
          MOVE      "0",LNK2PRT
          PERFORM   REPTOPTN,PATVIS00,INCVIS00,INCREG00,PTDAT000,ADDAT000
.
          CALL      TAIL0000
          CALL      CLSPRINT
.
PRTLST99  RETURN
.------------------------------------------------------------
. Heading for report
.------------------------------------------------------------
HEAD0000  PACK      CDATE,CDD,SLASH,CMM,SLASH,CCC,CYY
          REP       " 0",CDATE
          LOAD      CPHDROPT,REPTOPTN,OPTNONE,OPTNTWO,OPTNTHR,OPTNFOR
          CALL      HEAD132
.
          PRINT     *N,"--------------------------------------------":
                       "--------------------------------------------":
                       "--------------------------------------------":
                    *N,*2,"Triage",*10,"Patient",*45,"Age",*55,"Sex":
                       *60,"Arrival",*85,"Doctor",*95,"Complaint":
                       *125,"Location":
                    *N,"--------------------------------------------":
                       "--------------------------------------------":
                       "--------------------------------------------"
          MOVE      THREE,CLNO
.
HEAD9999  RETURN
.------------------------------------------------------------
. Tail for report
.------------------------------------------------------------
TAIL0000  PRINT     *N,"--------------------------------------------":
                       "--------------------------------------------":
                       "--------------------------------------------":
                    *N,*2,"*** End of Current Patient List. ":
                       "Number of Patients Currently in Emergency - ":
                       PATCOUNT," ***":
                    *N,"--------------------------------------------":
                       "--------------------------------------------":
                       "--------------------------------------------"
.
TAIL9999  RETURN
.------------------------------------------------------------
. Print row of report
.------------------------------------------------------------
PRTROW00  COMPARE   CLNO,THIRTY
          CALL      HEAD0000 IF LESS
.
          UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MOVE      PATTNAME,KEY30
          MOVE      SEMVICO1,KEY25
          PRINT     *N,*2,EMVITRIG,*10,KEY30,*45,DISPAGE,*55,PSEX:
                    *60,CPCDATE," at ",EMVITIME,*85,DOCINIT,*95,KEY25:
                    *125,EMVILOCN
.
          ADD       ONE,PATCOUNT
          ADD       ONE,CLNO
.
PRTROW99  RETURN
.
.------------------------------------------------------------------
.                 Getting Nurse Name
.------------------------------------------------------------------
NURS0000    MATCH     "1",EMCNURSE            * Use pmshcpaf for ED Nurse?
            GOTO      NURS1000 IF EQUAL       * Yes, read pmshcpaf for nurse
.
.           CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
            PACK      KEY6,EMVITRNS,SP70
            CALL      RDOPNUR1                * Reading the nurse file
            IF        OVRCD=1
              MOVE     SP70,OPNRCODE          * Clear all the file variables
              MOVE     SP70,OPNRSNAM
              MOVE     SP70,OPNRGNAM
              MOVE     SP70,OPNRUSR1
              MOVE     SP70,OPNRUSR2
              MOVE     SP70,OPNRUSR3
              MOVE     SP70,OPNRUSR4
              MOVE     SP70,OPNRUSR5
              MOVE     SP70,OPNRSTAT
              MOVE     SP70,DOCFNAME
            ELSE
              MOVE     SP70,FMTTITLE
              MOVE     OPNRGNAM,FMTGNAME
              MOVE     OPNRSNAM,FMTSNAME
              CALL     DOCNM000
            ENDIF 
            MOVE      DOCFNAME,RESPNURE
            GOTO      NURS9999
.
.           CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
NURS1000    PACK      KEY10,EMVITRNS,SP70
            CALL      RDPMHCP1
            IF        OVRCD=1
              CALL      CLPMSHCP
              MOVE      SP70,DOCFNAME
            ELSE
              MOVE      SP70,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
            MOVE      DOCFNAME,RESPNURE
            GOTO      NURS9999
.
NURS9999    RETURN
.
.------------------------------------------------------
.                 Getting Doctor Name
.------------------------------------------------------
DOCT0000    PACK      KEY10,EMVIDOCT,SP70
            CALL      RDPMHCP1                * Reading the HCP file
            IF        OVRCD=1
              CALL      CLPMSHCP              * Clear all the file variables
              MOVE      SP70,DOCFNAME
            ELSE
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000               * Routine format the doctor name
            ENDIF 
            MOVE      DOCFNAME,RESPNAME
DOCT9999    RETURN
.
.------------------------------------------------------------
.         CUNK0000  Clear unknown patient file variables
.------------------------------------------------------------
CUNK0000  PACK      EMUNDET1,SP70
          PACK      EMUNDET2,SP70
          PACK      EMUNSEX,SP10
          CLEAR     EMUNAGE
.
CUNK9999  RETURN
.
.------------------------------------------------------------
. Visits by Location
.------------------------------------------------------------
SRHLOC00  PACK      KEY3,SP70
          CALL      RSEMLOC1
SRHLOC10  CALL      RKEMLOC1
          BRANCH    OVRCD,SRHLOC99        * no more locations
          MATCH     EMLOSCOD,WBSEESC
          GOTO      SRHLOC10 IF NOT EQUAL
.
          MOVE      ZERO,PATCOUNT
          PACK      KEY11,EMLOLOCA,SP70
          CALL      RSEMVIS7
SRHLOC20  CALL      RKEMVIS7              * get all visits for location
          BRANCH    OVRCD,SRHLOC30        * no more visits
.
          MATCH     EMLOLOCA,EMVILOCN     * same location?
          GOTO      SRHLOC30 IF NOT EQUAL * no, get next location
.
          COMPARE   ONE,EMVISTAT          * current patient?
          IF        !@EQUAL
            CALL      CLRLOC00
            BRANCH    EXIT,SRHLOC20
          ENDIF
.
          CALL      SRHROW00              * write table contents
          ADD       ONE,PATCOUNT
          GOTO      SRHLOC20
.
SRHLOC30  COMPARE   ZERO,PATCOUNT         * check for empty location
          IF        @EQUAL
            CALL      SRHEMT00            * write out 'empty'
          ENDIF
          GOTO      SRHLOC10              * get next location
.
SRHLOC99  RETURN
.------------------------------------------------------------
. Visit by location row
.------------------------------------------------------------
SRHROW00  PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          COMPARE   ZERO,OVRCD
          GOTO      SRHROW20 IF EQUAL
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          IF        OVRCD=1
            MOVE      "Patient Master/Unknown Patient Record missing",PATTNAME
            GOTO      SRHROW45
          ENDIF
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
          GOTO      SRHROW30
.
SRHROW20  REP       " 0",PBDATE
          MATCH     "00000000",PBDATE
          IF        @EQUAL
            MOVE      "Unk",DISPAGE
            GOTO      SRHROW30
          ENDIF
.
          UNPACK    SP70,PSAGECON,PSAGETYP
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          PACK      DISPAGE,SP70
          CLEAR     DISPAGE
          APPEND    PSAGECON,DISPAGE
          APPEND    PSAGETYP,DISPAGE
          RESET     DISPAGE
.
SRHROW30  CALL      GDNAM000   * Get doctors name
.         CALL      SETEMR00   * Set Up Fields
.
          MATCH     SP70,PSEX
          IF        @EQUAL
            MOVE      "U",PSEX
          ENDIF
.
          CLEAR     KEY80
          APPEND    PSNAME,KEY80
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PGNAME,KEY80
.
          MATCH     SP70,PTITL
          GOTO      SRHROW40 IF EQUAL
.
          APPEND    COMMA,KEY80
          APPEND    SP1,KEY80
          APPEND    PTITL,KEY80
.
SRHROW40  APPEND    SP70,KEY80
          RESET     KEY80
          STRIP     KEY80
          MOVELPTR  KEY80,LENGTH
          SFORMAT   PATTNAME,LENGTH
          MOVE      KEY80,PATTNAME
.
SRHROW45  MOVE      SP70,DISPSTAT
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,DISPSTAT
              MOVE      SP70,STATIND
            ELSE
              MOVE      TDESC,DISPSTAT
              MOVE      TCINDC2,STATIND
            ENDIF
          ENDIF
.
          COMPARE   ZERO,PATCOUNT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td>":
                               "<a href='javascript:updateParent(#"":
                               EMLODESC,"#",#"",EMLOLOCA,"#")'>":
                               EMLOLOCA,"</a>",EMLODESC,"</td>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>",PATTNAME," (",PSEX,",",DISPAGE,")</td>":
                             "<td>",EMVICOM1,"&nbsp;</td>":
                             "<td>",DOCTNAME,"&nbsp;</td></tr>"
SRHROW99  RETURN
.------------------------------------------------------------
. Write empty row
.------------------------------------------------------------
SRHEMT00  WRITE     HTMLFILE;"<tr align=top>":
                    "<td class=AvailableCell>":
                    "<a href='javascript:updateParent(#"",EMLODESC,"#",#"":
                    EMLOLOCA,"#")'>":
                    EMLOLOCA,"</a>",EMLODESC,"</td>":
                    "<td colspan=3 align=center><b>*** Empty ***</b></td>":
                    "</tr>"
          RETURN
.------------------------------------------------------------
. Three routines below are used when patient status is
. discharged incomplete.
.------------------------------------------------------------
SUBNUR00  MATCH    "1",EMIPNCOM  
          IF       @EQUAL
            MOVE      "2",DIM1
            MOVE      EMIPNURS,EMISCODE
            PACK      KEY11,DIM1,EMISCODE,SP70
            CALL      RDEMISM1        * Reading Incomplete summary table
            IF        OVRCD=0
              IF        EMISNOIN=1
                 CALL      DEEMISM1
              ELSE
                 SUB       ONE,EMISNOIN
                 CALL      UPEMISM1           * Updating summary table
              ENDIF
            ENDIF
          ENDIF
.
SUBNUR99  RETURN
.------------------------------------------------------------
. Three routines below are used when patient status is
. discharged incomplete.
.------------------------------------------------------------
SUBDOC00  MATCH    "1",EMIPDCOM  
          IF       @EQUAL
            MOVE      "1",DIM1
            MOVE      EMIPDOCT,EMISCODE
            PACK      KEY11,DIM1,EMISCODE,SP70
            CALL      RDEMISM1       * Reading Incomplete summary table
            IF        OVRCD=0
              IF        EMISNOIN=1
                CALL      DEEMISM1
              ELSE
                SUB       ONE,EMISNOIN
                CALL      UPEMISM1          * Updating summary table
              ENDIF
            ENDIF
          ENDIF
.
SUBDOC99  RETURN
.
.------------------------------------------------------------
. Table of Expected Patients Form Map Display
.------------------------------------------------------------
MAPEX000  MOVE      WBSEESC,SAVESITE       * Save ED site
.
          PACK      WORKDATE,CCC,CYY,CMM,CDD
          REP       " 0",WORKDATE
          SUB       THIRTY1,WORKDATE      * Last month
.
          PACK      KEY21,SAVESITE,WORKDATE,SP70
          CALL      RSEMEXP4
MAPEX100  CALL      RKEMEXP4
          BRANCH    OVRCD,MAPEX999
.
          MATCH     EMEXSITE,SAVESITE
          GOTO      MAPEX999 IF NOT EQUAL
.
          MATCH     "0",EMEXDELT           * Triaged/Removed
          GOTO      MAPEX100 IF EQUAL
.
          PACK      KEY8,EMEXURNO,SP70     * Read Patient Master details
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            PACK      KEY50,SP70
            STRIP     EMEXGNAM
            STRIP     EMEXSNAM
            PACK      KEY50,BOLDON,EMEXSNAM,BOLDOFF,COMMA,SP1,EMEXGNAM,SP70
            MOVE      KEY50,FORMATNM
            GOTO      MAPEX200
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
MAPEX200  WRITE     HTMLFILE;"   obj.AddExpected(#"",FORMATNM,"#",": * 0
                             "#"",EMEXEXPL,"#",":                   * 1
                             "#"",EMEXETAT:                         * 2
                             "#");"    
.
          GOTO      MAPEX100
.
MAPEX999  RETURN
.
.------------------------------------------------------------
. Check if the patient has exceeded the triage wait times
. if so display sad face icon.
.------------------------------------------------------------
EXCD0000  CALL      SCLK0000                * Find stop the clock doctor
.
          MATCH     SP70,STOPDTIM
          IF        @EQUAL
            MOVE      EMVIDATE,FIRSTDAT
            UNPACK    EMVITIME,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
          ELSE
            GOTO      EXCD9000
          ENDIF
.
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          PACK      LASTDATE,CCC,CYY,CMM,CDD
          REP       " 0",LASTDATE
          UNPACK    CTIMEIS,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          MOVE      ZERO,F1
          SQUEEZE   EMVITRIG
          MOVE      EMVITRIG,F1
.
          CALL      TIMEDIFF
.
          IF        F1=1 & CALCTIME>=TWO
            GOTO      EXCD9100
          ENDIF
          IF        F1=2 & CALCTIME>=TEN
            GOTO      EXCD9100
          ENDIF
          IF        F1=3 & CALCTIME>=THIRTY
            GOTO      EXCD9100
          ENDIF
          IF        F1=4 & CALCTIME>=SIXTY
            GOTO      EXCD9100
          ENDIF
          IF        F1=5 & CALCTIME>=120
            GOTO      EXCD9100
          ENDIF
.
EXCD9000  MOVE      ZERO,ADMITFLG
          GOTO      EXCD9999
.
EXCD9100  MOVE      ONE,ADMITFLG
          GOTO      EXCD9999
.
EXCD9999  RETURN
.
.------------------------------------------------------------
. Check if there are patients in emergency that have the same 
. name. If so highlight on the map
.------------------------------------------------------------
CHKD0000  BRANCH    IBCNMHOS,CHKD3000
.
          MATCH     "1",EMCNMSRS
          IF        !@EQUAL
            PACK      KEY96,PTMASNAM,PMPXFNAM,SP70,SP70
          ELSE      
            PACK      KEY96,PTMASNAM,SP70,SP70
          ENDIF
.
          CALL      RSPMCUR2
CHKD1000  CALL      RKPMCUR2
          BRANCH    OVRCD,CHKD9000
.
          MATCH     PTMASNAM,PMCUSURN
          GOTO      CHKD9000 IF NOT EQUAL
. 
          MATCH     "1",EMCNMSRS
          IF        !@EQUAL
            MATCH     PMPXFNAM,SP70
            GOTO      CHKD9000 IF EQUAL          * ignore blank first name

            MATCH     PMPXFNAM,PMCUGNAM          * first name does NOT match
            GOTO      CHKD9000 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",PMCUSYST
          GOTO      CHKD1000 IF NOT EQUAL
.
          MATCH     DEMVIADM,PMCUVISN
          GOTO      CHKD1000 IF EQUAL
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RDEMVIS1
          IF        OVRCD=0
            COMPARE   FOUR,EMVISTAT
            IF        @EQUAL
              MOVE      SAVEADMN,DEMVIADM
              GOTO      CHKD1000
            ENDIF
.
            MATCH     "1",EMCNMSRS
            IF        @EQUAL
              MATCH     SP70,EMVILOCN
              IF        @EQUAL|@EOS
                MOVE      SAVEADMN,DEMVIADM
                GOTO      CHKD1000
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      CHKD9100
.
CHKD3000  MATCH     "1",EMCNMSRS
          IF        !@EQUAL
            PACK      KEY99,EMSTHSNO,PTMASNAM,PMPXFNAM,SP70,SP70
          ELSE
            PACK      KEY99,EMSTHSNO,PTMASNAM,SP70,SP70
          ENDIF
.
          CALL      RSPMCUR6
CHKD3100  CALL      RKPMCUR6
          BRANCH    OVRCD,CHKD9000
.
          MATCH     EMSTHSNO,PMCUHOSP
          GOTO      CHKD9000 IF NOT EQUAL
.
          MATCH     PTMASNAM,PMCUSURN
          GOTO      CHKD9000 IF NOT EQUAL
.
          MATCH     "1",EMCNMSRS
          IF        !@EQUAL
            MATCH     PMPXFNAM,SP70
            GOTO      CHKD9000 IF EQUAL          * ignore blank first name
.
            MATCH     PMPXFNAM,PMCUGNAM
            GOTO      CHKD9000 IF NOT EQUAL      * first name does NOT match
          ENDIF
.
CHKD3200  MATCH     "1",PMCUSYST
          GOTO      CHKD3100 IF NOT EQUAL
.
          MATCH     DEMVIADM,PMCUVISN
          GOTO      CHKD3100 IF EQUAL
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RDEMVIS1
          IF        OVRCD=0
            COMPARE   FOUR,EMVISTAT
            IF        @EQUAL
              MOVE      SAVEADMN,DEMVIADM
              GOTO      CHKD3100
            ENDIF
.
            MATCH     "1",EMCNMSRS
            IF        @EQUAL
              MATCH     SP70,EMVILOCN
              IF        @EQUAL|@EOS
                MOVE      SAVEADMN,DEMVIADM
                GOTO      CHKD3100
              ENDIF 
            ENDIF  
          ENDIF
.
          GOTO      CHKD9100
.
CHKD9000  MOVE      ZERO,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9100  MOVE      ONE,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9999  RETURN
.
.------------------------------------------------------------
. Current EMU admissions with discharged emergency visits
.------------------------------------------------------------
EOUVIS00  PACK      KEY6,SP70
          CALL      RDSWARD1
EOUVIS10  CALL      RDKWARD1
          BRANCH    OVRCD,EOUVIS99
.        
          PACK      SAVEKEY6,WWARD,WBED,SP70     * Save key for loop
.
          BRANCH    WACTIVE,EOUVIS10        * Do not include inactive bed
.
          IF        IBCNMHOS=1
            MATCH     PTWDHOSN,EMSTHSNO
            GOTO      EOUVIS10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EOUVIS10
.
          MATCH     "S",THCSCOD             * EOU Unit Beds Only
          GOTO      EOUVIS10 IF NOT EQUAL
.
          MATCH     ANSO,TCINDC8            * EOU display on ward list
          GOTO      EOUVIS10 IF NOT EQUAL
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            PACK      KEY8,WADMNO,SP70
            CALL      RDVISA1               * Read visit 
            BRANCH    OVRCD,EOUVIS10
.
            CALL      EOUVRW00
.
            MATCH     "1",DISEDSSU
            IF        @EQUAL
              PACK      KEY6,SAVEKEY6,SP70      * Save key for loop
              CALL      RDWARD1
              BRANCH    OVRCD,EOUVIS10
            ENDIF
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            PACK      KEY8,WSTBY,SP70
            CALL      RDVISA1               * Read visit
            BRANCH    OVRCD,EOUVIS10
.
            CALL      EOUVRW00
.
            MATCH     "1",DISEDSSU
            IF        @EQUAL
              PACK      KEY6,SAVEKEY6,SP70      * Save key for loop
              CALL      RDWARD1
              BRANCH    OVRCD,EOUVIS10
            ENDIF
          ENDIF
.
          MATCH     SP70,WBED               * On the main ward record
          GOTO      EOUVIS10 IF NOT EQUAL
.
          COMPARE   ZERO,WINPUT             * Check for no bed admission
          GOTO      EOUVIS10 IF EQUAL
.
          PACK      KEY13,WWARD,SP70
          CALL      RDSNOBE1
EOUVIS20  CALL      RDKNOBE1                * Check no bed admission
          BRANCH    OVRCD,EOUVIS10
.
          MATCH     WWARD,NBWARD
          GOTO      EOUVIS10 IF NOT EQUAL
.
          PACK      KEY8,NBADMNO,SP70
          CALL      RDVISA1               * Read visit
          BRANCH    OVRCD,EOUVIS20
.
          CALL      EOUVRW00
.
          MATCH     "1",DISEDSSU
          IF        @EQUAL
            PACK      KEY6,SAVEKEY6,SP70      * Save key for loop
            CALL      RDWARD1
            BRANCH    OVRCD,EOUVIS10
          ENDIF
.
          GOTO      EOUVIS20
.
EOUVIS99  RETURN
.
.------------------------------------------------------------
. Current EMU admissions with discharged emergency visits row
.------------------------------------------------------------
EOUVRW00  PACK      KEY16,PVIURNO,Z70
          CALL      RSEMVIS3
EOUVRW15  CALL      RPEMVIS3
          BRANCH    OVRCD,EOUVRW90
.
          MATCH     PVIURNO,EMVIURNO
          GOTO      EOUVRW90 IF NOT EQUAL
.
          MATCH     DPVIBILL,EMVIPADM
          IF        @EQUAL
            COMPARE   EMVISTAT,ONE          * Look for linked emergency visit
            GOTO      EOUVRW90 IF EQUAL
.
            COMPARE   EMVISTAT,FOUR
            GOTO      EOUVRW90 IF EQUAL
.
            GOTO      EOUVRW16
          ENDIF
.
          GOTO      EOUVRW15
.
EOUVRW16  MOVE      WWARD,EMVILOCN
.
.--------*T0836547
.-------- if getwdbsc=1 and disedssu=1 then
.--------    Save actual ward description from patwr1af that the patient
.--------    has been admitted to for routine SETEMR00
          COMPARE   ONE,GETWBDSC           
          GOTO      EOUVRW18 IF NOT EQUAL
.  
          MATCH     "1",DISEDSSU
          GOTO      EOUVRW18 IF NOT EQUAL
.
          RESET     SVWBDESC
          MOVE      SP70,SVWBDESC           
          MOVE      WBDESC,SVWBDESC         * Save patwr1af.wbdesc
.
          MOVE      EMVIADMN,SAVEADMN
          MOVE      EMVIADMN,ADMISSNO
          CALL      CALSEQ00                * Next Patient Sequence Count 
.
EOUVRW18  COMPARE   ONE,LNK2PRT
          GOTO      EOUVRW20 IF NOT EQUAL
.
          MATCH     SP70,EMVIUD03           * Unit request date blank?
          GOTO      EOUVRW22 IF NOT EQUAL
          MATCH     SP70,EMVIUT03           * Unit request time blank?
          GOTO      EOUVRW22 IF NOT EQUAL
          MATCH     SP70,EMVIUNIT           * Unit code blank?
          GOTO      EOUVRW90 IF EQUAL
          GOTO      EOUVRW22
.
EOUVRW20  MOVE      SP70,AARRTIME
          CALL      GETWAT00                *   Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MATCH     SP70,EMVIATNS           *   Check for Attending Nurse
          IF        @EQUAL
             MOVE     EMVITRNS,EMVIATNS
          ENDIF
.
EOUVRW22  MATCH     SP8,EMVIPADM
          GOTO      EOUVRW23 IF EQUAL
.
          PACK      KEY8,EMVIPADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EOUVRW23
.
          MATCH     SP8,ACLSSFT
          GOTO      EOUVRW23 IF EQUAL
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
          GOTO      EOUVRW24
.
EOUVRW23  MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
.
EOUVRW24  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      EOUVRW30
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,EOUVRW90
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.           
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
EOUVRW30  MATCH     "1",DISEDSSU
          IF        @EQUAL
            CALL      OUTVIS00
          ELSE
            CALL      OUTPUT00
          ENDIF
.
EOUVRW90  PACK      KEY6,SAVEKEY6,SP70
          CALL      RDWARD1                      * Re position ward record
.
EOUVRW99  RETURN
.
+
.*****************************************************************************
.*  RETL0000 - Retain the patients previous ED location/time if they are moving
.*             to a location with a type of other. Don't update the previous
.*             location if moving from a type other to a type other
.*  REQUIRES - Valid read of EMRVISAF
.*             NEWLOCAT populated with the new location code
.*****************************************************************************
RETL0000  MATCH     "1",EMCNRETC                 * Using retain prev location
          GOTO      RETL8000 IF NOT EQUAL
.
          MATCH     Z70,NEWLOCAT                 * No change of location
          GOTO      RETL9999 IF EQUAL
.
          MATCH     EMVILOCN,NEWLOCAT            * No change of location
          GOTO      RETL9999 IF EQUAL
.
          MATCH     SP70,NEWLOCAT                * Clear prev location if       
          GOTO      RETL8000 IF EQUAL            * deleting the current location
.
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,RETL8000
.
          MATCH     ANSO,EMLOTYPE                * Check current location type
          IF        @EQUAL 
            MOVE      ONE,OTHRFLAG               * In an other location
          ELSE                                
            MOVE      ZERO,OTHRFLAG              * Not in an other location
          ENDIF
.
          PACK      KEY3,NEWLOCAT,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,RETL8000
.
          MATCH     ANSO,EMLOTYPE                * Check if new location type
          GOTO      RETL8000 IF NOT EQUAL        * is other
.
          BRANCH    OTHRFLAG,RETL9999            * Don't update
.
          MOVE      EMVILOCN,EMVIPRLO            * Save prev location
          CLOCK     TIME,EMVIPRTM                * Time left prev location
          GOTO      RETL9999
.
RETL8000  MOVE      SP70,EMVIPRLO
          MOVE      SP70,EMVIPRTM
.
RETL9999  RETURN 
.
.------------------------------------------------------------
. Check if using ward bed requests and display in the unit 
. field if appropriate
.------------------------------------------------------------
BEDR0000  MOVE      ZERO,READYADM                 * Not ready for admission
          MOVE      SP70,DISPWRDT                 * Ward bed request ready date
          MOVE      SP70,DISPWRTM                 * Ward bed request ready time
.
          MATCH     "1",PTCNBEDM
          GOTO      BEDR9999 IF NOT EQUAL
.
          MATCH     SP70,EMVIPADM                 * Inpatient admission
          IF        !@EQUAL
            MOVE      "G",KEY1
            GOTO      BEDR9999 
          ENDIF
.
          MATCH     SP70,EMVIUC28
          GOTO      BEDR0500 IF EQUAL
.
          PACK      KEY5,CATET,EMVIUC28,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,BEDR0500
.
          MATCH     "1",TCINDC1
          IF        @EQUAL
            MOVE      ONE,READYADM
            MOVE      "G",KEY1
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      EMVIUC28,KEY3  
            ENDIF
          ENDIF
.
BEDR0500  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPMBRQ2
BEDR1000  CALL      RKPMBRQ2
          BRANCH    OVRCD,BEDR9999
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      BEDR9999 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA
          GOTO      BEDR2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      BEDR2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      BEDR3000 IF EQUAL
.
          GOTO      BEDR1000
.
BEDR2000  MATCH     SP70,PMBRTYPE
          GOTO      BEDR9999 IF EQUAL
.
          IF        READYADM<>1
            MOVE      "R",KEY1              * Bed requested (red)
          ENDIF
          MOVE      PMBRTYPE,KEY3
.
          GOTO      BEDR9999
.
BEDR3000  MATCH     SP70,PMBREWRD
          GOTO      BEDR9999 IF EQUAL
.
          IF        READYADM<>1
            MOVE      "B",KEY1              * Ward allocated (blue)
          ENDIF
.  
          MOVE      PMBREWRD,KEY3
          MOVE      PMBRRDAT,DISPWRDT       * Ward bed request ready date
          MOVE      PMBRRTIM,DISPWRTM       * Ward bed request ready time
          GOTO      BEDR9999
.
BEDR9999  RETURN
.
.------------------------------------------------------------
. Display the ready for admission code(black) and if using ward 
. bed requests and there is a bed request display REQ(red) or the
. bed request allocated ward (green)
.------------------------------------------------------------
ADMR0000  MATCH     "1",PTCNBEDM
          GOTO      ADMR9999 IF NOT EQUAL
.
ADMR0500  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPMBRQ2
ADMR1000  CALL      RKPMBRQ2
          BRANCH    OVRCD,ADMR9999
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      ADMR9999 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA
          GOTO      ADMR2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      ADMR2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      ADMR3000 IF EQUAL
.
          GOTO      ADMR1000
.
ADMR2000  PACK      ADMRDISP,ANSR,ANSR,ANSE,ANSQ,SP70
          PACK      REQSTDIS,ANSR,ANSR,ANSE,ANSQ,SP70
          GOTO      ADMR9999
.
ADMR3000  PACK      ADMRDISP,ANSG,PMBREWRD,SP70
          PACK      REQSTDIS,ANSG,PMBREWRD,SP70
.
          MATCH     SP70,PMBREWRD
          GOTO      ADMR9999 IF EQUAL
.
          PACK      KEY6,PMBREWRD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      REQSTDIS,ANSG,PTWDSDES,SP70
          ENDIF
          GOTO      ADMR9999
.
ADMR9999  RETURN
.
.------------------------------------------------------------
. Check if using ward bed requests and display the status or
. requested bed. Used in the current patient list
.------------------------------------------------------------
BEDS0000  MOVE      SP70,DISPBEDS
.
          MATCH     "1",PTCNBEDM
          GOTO      BEDS9999 IF NOT EQUAL
.         
BEDS0500  PACK      KEY25,EMVIADMN,SP70
          CALL      RSPMBRQ2
BEDS1000  CALL      RKPMBRQ2
          BRANCH    OVRCD,BEDS9999
.
          MATCH     DEMVIADM,PMBRVISN
          GOTO      BEDS9999 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA
          GOTO      BEDS2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      BEDS2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      BEDS3000 IF EQUAL
.
          GOTO      BEDS1000
.
BEDS2000  MATCH     SP70,PMBRTYPE
          GOTO      BEDS9999 IF EQUAL
.
          MOVE      "Requested",DISPBEDS
.
          GOTO      BEDS9999
.
BEDS3000  MATCH     SP70,PMBREWRD
          GOTO      BEDS9999 IF EQUAL
.
          MATCH     SP70,PMBREBED
          IF        @EQUAL
            PACK      DISPBEDS,PMBREWRD
          ELSE
            PACK      DISPBEDS,PMBREWRD,SLASH,PMBREBED
          ENDIF
          GOTO      BEDS9999
.
BEDS9999  RETURN
.
.------------------------------------------------------------
. If display diagnosis over presenting complaint is set to yes
. get the primary diagnosis to this visit
.------------------------------------------------------------
DIAG0000  MATCH     "1",EMCNDPRS
          GOTO      DIAG9999 IF NOT EQUAL
.
          PACK      DISDIAG,SP70
          PACK      DISDIA2,SP70
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
DIAG1000  CALL      RKEMVCD1
          BRANCH    OVRCD,DIAG9000
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      DIAG9000 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      DIAG2000 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      DIAG1000 IF NOT EQUAL
.
DIAG2000  MATCH     "000",EMVCSEQU
          GOTO      DIAG1000 IF NOT EQUAL
.
          MOVE      SP70,DIM20
          MOVE      EMVCFTXT,DIM20
.
          MATCH     SP70,DIM20
          GOTO      DIAG3000 IF EQUAL
.
          CLEAR     DISDIAG
          APPEND    "<b>",DISDIAG
          APPEND    DIM20,DISDIAG
          APPEND    "</b>",DISDIAG
          RESET     DISDIAG
.
          CLEAR     DISDIA2
          APPEND    "\tDiagnosis\t: ",DISDIA2
          APPEND    DIM20,DISDIA2
          RESET     DISDIA2
.
          GOTO      DIAG9999
.
DIAG3000  MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
.
          MATCH     SP70,CODEDESC
          GOTO      DIAG9000 IF EQUAL
.
          CLEAR     DISDIAG
          APPEND    "<b>",DISDIAG
          APPEND    CODEDESC,DISDIAG
          APPEND    "</b>",DISDIAG
          RESET     DISDIAG
.
          CLEAR     DISDIA2
          APPEND    "\tDiagnosis\t: ",DISDIA2
          APPEND    CODEDESC,DISDIA2
          RESET     DISDIA2
.
          GOTO      DIAG9999
.
DIAG9000  MOVE      TDESC,DISDIAG
.
          CLEAR     DISDIA2
          APPEND    "\tComplaint\t: ",DISDIA2
          APPEND    TDESC,DISDIA2
          RESET     DISDIA2
.
DIAG9999  RETURN
.
.------------------------------------------------------------
. Get other clinical details info if display 3 line       
. patient cell is turned on
.------------------------------------------------------------
OCLN0000  MOVE      "0000000000",OTHRCLIN
.
          MATCH     "1",EMCNPCEL
          GOTO      OCLN9999 IF NOT EQUAL
.
          PACK      KEY8,EMVIADMN,SP70
          CALL      RDEMCLI1
          BRANCH    OVRCD,OCLN9999
.
          CLEAR     OTHRCLIN
.
          MATCH     "1",EMCIOR01                 * Ordered Field 1
          IF        @EQUAL
            MATCH     "1",EMCIPR01
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN1000
          ENDIF
.
          MATCH     "1",EMCIPR01                 * Returned Field 1
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN1000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN1000  MATCH     "1",EMCIOR02                 * Ordered Field 2
          IF        @EQUAL
            MATCH     "1",EMCIPR02
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN2000
          ENDIF
.
          MATCH     "1",EMCIPR02                 * Returned Field 2
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN2000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN2000  MATCH     "1",EMCIOR03                 * Ordered Field 3
          IF        @EQUAL
            MATCH     "1",EMCIPR03
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN3000
          ENDIF
.
          MATCH     "1",EMCIPR03                 * Returned Field 3
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN3000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN3000  MATCH     "1",EMCIOR04                 * Ordered Field 4
          IF        @EQUAL
            MATCH     "1",EMCIPR04
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN4000
          ENDIF
.
          MATCH     "1",EMCIPR04                 * Returned Field 4
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN4000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN4000  MATCH     "1",EMCIOR05                 * Ordered Field 5
          IF        @EQUAL
            MATCH     "1",EMCIPR05
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN5000
          ENDIF
.
          MATCH     "1",EMCIPR05                 * Ordered Field 5
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN5000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN5000  MATCH     "1",EMCIOR06                 * Ordered Field 6
          IF        @EQUAL
            MATCH     "1",EMCIPR06
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN6000
          ENDIF
.
          MATCH     "1",EMCIPR06                 * Ordered Field 6
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN6000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN6000  MATCH     "1",EMCIOR07                 * Ordered Field 7
          IF        @EQUAL
            MATCH     "1",EMCIPR07
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN7000
          ENDIF
.
          MATCH     "1",EMCIPR07                 * Ordered Field 7
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN7000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN7000  MATCH     "1",EMCIOR08                 * Ordered Field 8
          IF        @EQUAL
            MATCH     "1",EMCIPR08
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN8000
          ENDIF
.
          MATCH     "1",EMCIPR08                 * Ordered Field 8
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN8000
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN8000  MATCH     "1",EMCIOR09                 * Ordered Field 9
          IF        @EQUAL
            MATCH     "1",EMCIPR09
            IF        @EQUAL
              MATCH     "1",EMCIRS09
              IF        @EQUAL
                APPEND    THREE,OTHRCLIN
              ELSE
                APPEND    TWO,OTHRCLIN
              ENDIF
            ELSE
              MATCH     "1",EMCIRS09
              IF        @EQUAL
                APPEND    THREE,OTHRCLIN
              ELSE
                APPEND    ONE,OTHRCLIN
              ENDIF
            ENDIF
            GOTO      OCLN9000
          ENDIF
.
          MATCH     "1",EMCIPR09                 * Ordered Field 9
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN9000
          ENDIF
.
          MATCH     "1",EMCIRS09
          IF        @EQUAL
            APPEND    THREE,OTHRCLIN
            GOTO      OCLN9000
          ENDIF
.
          APPEND    ZERO,OTHRCLIN
.
OCLN9000  MATCH     "1",EMCIOR10                 * Ordered Field 10
          IF        @EQUAL
            MATCH     "1",EMCIPR10
            IF        @EQUAL
              APPEND    TWO,OTHRCLIN
            ELSE
              APPEND    ONE,OTHRCLIN
            ENDIF
            GOTO      OCLN9500
          ENDIF
.
          MATCH     "1",EMCIPR10                 * Ordered Field 10
          IF        @EQUAL
            APPEND    TWO,OTHRCLIN
            GOTO      OCLN9500
          ENDIF
          APPEND    ZERO,OTHRCLIN
.
OCLN9500  RESET     OTHRCLIN
.
OCLN9999  RETURN
.
.------------------------------------------------------------
. Table of Patients In Other Rooms - with EMR Location
.------------------------------------------------------------
OTHTL000  PACK      KEY11,FILTLOCN,SP70
          CALL      RSEMVIS7
OTHTL100  CALL      RKEMVIS7             * Read forward
          BRANCH    OVRCD,OTHTL999
.
          MATCH     FILTLOCN,EMVILOCN
          GOTO      OTHTL999 IF NOT EQUAL
.
          COMPARE   EMVISTAT,FOUR        * Exit if not of status 1
          GOTO      OTHTL100 IF EQUAL
.
          IF        EMVISTAT=TWO | EMVISTAT=THREE
            COMPARE   ONE,EMVIADMT
            GOTO      OTHTL100 IF NOT EQUAL
          ENDIF   
.
          MATCH     EMVISITE,WBSEESC
          GOTO      OTHTL100 IF NOT EQUAL
.
          PACK      KEY3,EMVILOCN,SP70
          CALL      RDEMLOC1
          BRANCH    OVRCD,OTHTL100
.
          MATCH     "O",EMLOTYPE
          GOTO      OTHTL100 IF NOT EQUAL
.
          CALL      EMHIST00    * Set Up History details
.
          PACK      KEY8,EMVIURNO,SP70     * Read Patient Master details
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            CALL      CLPMSPX2
            PACK      KEY8,EMVIADMN
            CALL      RDEMUNK1
            BRANCH    OVRCD,OTHTL100
            CALL      RDPRAM1
            MOVE      "       0",PURNO
            MOVE      EMUNSNAM,PSNAME
            MOVE      EMUNGNAM,PGNAME
            MOVE      EMUNBDAT,PBDATE
            MOVE      EMUNSEX,PSEX
            MOVE      SP70,PTITL
            PACK      KEY50,SP70
            STRIP     EMUNDET1
            STRIP     EMUNDET2
            PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
            MOVE      KEY50,FORMATNM
            GOTO      OTHTL200
          ELSE
            PACK      KEY8,EMVIURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name
.
OTHTL200  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY20
.
          PACK      KEY6,EMVIDOCT,SP70     * Get Doctors full name
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     DTITL,FMTTITLE
            MOVE     DGNAME,FMTGNAME
            MOVE     DSNAME,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          PACK      KEY3,EMVILOCN,SP70     * Get Location Description
          CALL      RDEMLOC1
          IF        OVRCD=1
            MOVE      SP70,EMLODESC
          ENDIF
.
          CALL      SETEMR00
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
OTHTL211  CALL      RKEMVCD1
          BRANCH    OVRCD,OTHTL215
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      OTHTL215 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      OTHTL212 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      OTHTL211 IF NOT EQUAL
.
OTHTL212  MATCH     "000",EMVCSEQU
          GOTO      OTHTL211 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
OTHTL215  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          PACK      COMPDIAG,DISDIAGF,SP70,SP70
          MATCH     SP70,COMPDIAG
          GOTO      OTHTL230 IF NOT EQUAL
.
          CLEAR     COMPDIAG
          APPEND    SEMVICO1,COMPDIAG
          APPEND    SP1,COMPDIAG
          APPEND    SEMVICO2,COMPDIAG
.
OTHTL230  RESET     COMPDIAG
          STRIP     COMPDIAG
          REP       "#"'\/",COMPDIAG
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVIADMN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       " +",EMVIURNO
          REP       " +",DEMVIADM
.
          CLEAR     HTMLLNKL
          APPEND    "javascript:OpenLocation('",HTMLLNKL
          APPEND    EMVIURNO,HTMLLNKL
          APPEND    "','",HTMLLNKL
          APPEND    EMVIADMN,HTMLLNKL
          APPEND    "')",HTMLLNKL
          RESET     HTMLLNKL
.
          REP       "+ ",EMVIURNO
          REP       "+ ",DEMVIADM
.
          REP       "#"'\/",COMPDIAG
          REP       "#"'\/",EMVICOM1
          REP       "#"'\/",EMVICOM2
          REP       "#"'\/",EMVICOM3
          REP       "#"'\/",EMVICOM4
          REP       "#"'\/",EMVICOM5
          REP       "#"'\/",EMVICOM6
.
          CALL      PATFLD00
.
          PACK      TDESC,SP70
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00
.
          PACK      DTRIG,EMVITRIG
          MATCH     DTRIG,SP3
          IF        @EQUAL
            PACK      DTRIG,ZEROS
          ENDIF
.
          CLEAR     HTMLLNK1
          APPEND    "javascript:TriagePatient('",HTMLLNK1
          APPEND    EMVIURNO,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    EMVIADMN,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    DTRIG,HTMLLNK1
          APPEND    "')",HTMLLNK1
          RESET     HTMLLNK1
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMVIADMN,"#",":
                             "#"",EMVIURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",EMVIDATE,"#",":
                             "#"",EMVITIME,"#",":
                             "#"",EMVITRIG,"#",":
                             "#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",EMVIUC20,"#",":
                             "#"",KEY20,"#",":
                             "#"",EMVICOM1,"#",":
                             "#"",EMVICOM2,"#",":
                             "#"",EMVICOM3,"#",":
                             "#"",EMVICOM4,"#",":
                             "#"",EMVICOM5,"#",":
                             "#"",EMVICOM6,"#",":
                             "#"",EMVIDOCT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",HISTDATE,"#",":
                             "#"",HISTTIME,"#",":
                             "#"",EMVILOCN,"#",":
                             "#"",EMLODESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",EMVIDATE,EMVITIME,"#",":
                             "#"",HISTDATE,HISTTIME,"#",":
                             "#"",COMPDIAG,"#",";
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",EDDISDIA,"#",";
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":
    "<img src=../images/ActionIcon.gif ":
    "onclick=document.SelectPeriod.acnurnum.value='",EMVIURNO,"';":
    "document.SelectPeriod.acnadmno.value='",DEMVIADM,"';":
    "document.SelectPeriod.acnestat.value='",EMVISTAT,"';":
    "AddClinNote(); border=0>&nbsp;&nbsp;",EDDISDIA,"#",";
.
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;"#"",HTMLLNKL,"#",":
                               "#"",HTMLLNK1,"#",":
                               "#"",DTRIG,"#",":
                               "#"<input type=hidden value=",EMVITRIG,">#"";
.
            WRITE     HTMLFILE;");"
.
          GOTO      OTHTL100
.
OTHTL999  RETURN
.
.------------------------------------------------------------
. Check if Short Stay Unit and Emergency Unit
.------------------------------------------------------------
GETDUU00  MOVE      ZERO,FORM4
          SQUEEZE   EMCNSFSM
          MOVE      EMCNSFSM,FORM4
.
          IF       FORM4 > ZERO
.
            MATCH     SP70,EMVIPADM
            GOTO      GETDUU80 IF EQUAL
            GOTO      GETDUU80 IF EOS
.
GETDUU70    MATCH     SP70,EMVIUNIT
            GOTO      GETDUU80 IF EQUAL
            GOTO      GETDUU80 IF EOS
.
            PACK      KEY5,ANSA,ANSC,EMVIUNIT,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,GETDUU80
.
            MATCH     "E",TCINDC7
            GOTO      GETDUU80 IF NOT EQUAL
.
            MOVE      ZERO,ADMITFLG
.
            GOTO      GETDUU99
.
GETDUU80    MOVE      ZERO,DURATIME
            MOVE      ZERO,CDYSDAYS
            MOVE      ZERO,ADMITFLG
.
            MOVE      ZERO,FORM4
            SQUEEZE   EMCNSFSM
            MOVE      EMCNSFSM,FORM4
.
            COMPARE   ZERO,FORM4              * Not using duration warning
            GOTO      GETDUU99 IF EQUAL
.
            MATCH     SP70,EMVIDATE
            GOTO      GETDUU99 IF EQUAL
.
            MATCH     SP70,EMVITIME
            GOTO      GETDUU99 IF EQUAL
.
            MOVE      EMVIDATE,FIRSTDAT
            UNPACK    EMVITIME,HOUR,D1,MIN
            PACK      FIRSTIME,HOUR,MIN
            REP       " 0",FIRSTDAT
            REP       " 0",FIRSTIME
.
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
            UNPACK    CTIMEIS,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
            CALL      TIMEDIFF
            MOVE      CALCTIME,DURATIME
.
            SQUEEZE   EMCNSFSM
            MOVE      EMCNSFSM,FORM4
            IF        (DURATIME > FORM4 | CDYSDAYS > SEVEN)
              MOVE      TWO,ADMITFLG
            ENDIF
.
          ENDIF
.
GETDUU99  RETURN
.------------------------------------------------------------
. Get Free Format Diag and ICD10 Desc
.------------------------------------------------------------
FFDIAG00  PACK      DISDIAG2,SP70,SP70
          MOVE      EMVITXT2,DISDIAG2
.
          PACK      KEY8,EMVIADMN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,FFDIAG99
.
          MATCH     SP70,PMVXPICD
          GOTO      FFDIAG99 IF EQUAL
          GOTO      FFDIAG99 IF EOS
.
          PACK      KEY9,PMVXPICD,SP70
          CALL      RDPTICD1
          BRANCH    OVRCD,FFDIAG99
.
          MATCH     SP70,DDESC
          GOTO      FFDIAG99 IF EQUAL
          GOTO      FFDIAG99 IF EOS
.
          ENDSET    DISDIAG2
.
          APPEND    " ",DISDIAG2
          APPEND    DDESC,DISDIAG2 
.
          GOTO       FFDIAG99 
.
FFDIAG99  RETURN
.------------------------------------------------------------
. Current emergency patient visits
.------------------------------------------------------------
EMRVIS00  PACK      KEY12,WBSEESC,ONE,SP70
          CALL      RSEMVIS5
EMRVIS10  CALL      RKEMVIS5
          BRANCH    OVRCD,EMRVIS99
.
          MATCH     EMVISITE,WBSEESC
          GOTO      EMRVIS99 IF NOT EQUAL
.
          COMPARE   EMVISTAT,ONE
          GOTO      EMRVIS99 IF NOT EQUAL
.
          MATCH     SP70,FILTSTRM
          IF        !@EQUAL
            MATCH     EMVIUC16,FILTSTRM
            GOTO      EMRVIS10 IF NOT EQUAL
          ENDIF
.
          IF        MULTSCNT<>0
            MOVE      ONE,COUNT
            WHILE     COUNT <= MULTSCNT
              MATCH     SP70,MULTSTRM[COUNT]
              GOTO      EMRVIS15 IF EQUAL
.
              MATCH     MULTSTRM[COUNT],EMVIUC16
              GOTO      EMRVIS15 IF EQUAL
              ADD     ONE,COUNT
            DO
            GOTO      EMRVIS10
          ENDIF
.
EMRVIS15  MOVE      SP70,AARRTIME
          CALL      GETWAT00                * Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      EMVIADMN,SAVEADMN
          MOVE      EMVIADMN,ADMISSNO
          CALL      CALSEQ00              * Next Patient Sequence Count
.
          MOVE      SP70,SFDSTIME
          CALL      GETSFD00
          MOVE      _SFDTIME,SFDSTIME
.
          MATCH     SP70,EMVIATNS           *   Check for Attending Nurse
          IF        @EQUAL
.            MOVE     EMVITRNS,EMVIATNS
          ENDIF
.          
EMRVIS22  MATCH     SP8,EMVIPADM
          GOTO      EMRVIS23 IF EQUAL
.
          PACK      KEY8,EMVIPADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EMRVIS23
.
          MATCH     SP8,ACLSSFT
          GOTO      EMRVIS23 IF EQUAL
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
          GOTO      EMRVIS24
.
EMRVIS23  MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
.
EMRVIS24  MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC 
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      EMRVIS30 
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          BRANCH    OVRCD,EMRVIS10
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
EMRVIS30  CALL      OUTVIS00
          GOTO      EMRVIS10
.
EMRVIS99  RETURN
+
.------------------------------------------------------------
.         OUTVIS00  Output row
.------------------------------------------------------------
OUTVIS00  PACK      AGEINDAY,SP70
.
          IF        UNKFLAG=1
             MATCH    SP70,EMUNBDAT         * Unknow patient with no date of
             GOTO     OUTVIS10 IF EQUAL     * birth
.
             MOVE      EMUNBDAT,PBDATE 
          ENDIF
.
          REP       " 0",PBDATE
          MATCH     "00000000",PBDATE
          IF        @EQUAL
            MOVE      "Unk",DISPAGE
            GOTO      OUTVIS10
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          PACK      DISPAGE,SP70
          CLEAR     DISPAGE
          APPEND    PSAGECON,DISPAGE
          APPEND    PSAGETYP,DISPAGE
          RESET     DISPAGE
.
          PACK      AGEINDAY,PSAGEDAY,SP70   * age in days
.
OUTVIS10  CALL      FDNAM000   * Get Doctors Name
          CALL      GDNAM000   * Get Doctors Name
          CALL      GCNAM000   * Get Consultant Name
          CALL      GPNAM000   * Get Patients Name
          CALL      SETEMR00   * Set Up Fields
          CALL      UKEY0000   * Set up updateky
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MATCH     SP70,EMVISRCE
          IF        !@EQUAL
            PACK      KEY5,CATS,EMVISRCE
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      SRCEDESC,SP70
              PACK      SRCEIN12,SP70
            ELSE
              PACK      SRCEDESC,TDESC
              PACK      SRCEIN12,TCINDC12
            ENDIF
          ELSE
            PACK      SRCEDESC,SP70
            PACK      SRCEIN12,SP70
          ENDIF
.
          MATCH     SP70,EMVICLAS
          IF        !@EQUAL
            PACK      KEY5,CATA,EMVICLAS
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      CLASDESC,SP70
              PACK      CLASIN12,SP70
            ELSE
              PACK      CLASDESC,TDESC
              PACK      CLASIN12,TCINDC12
            ENDIF
          ELSE
            PACK      CLASDESC,SP70
            PACK      CLASIN12,SP70
          ENDIF
.
          MATCH     SP70,EMVIUC29
          IF        !@EQUAL
            PACK      KEY5,CATEU,EMVIUC29,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              PACK      RESADESC,SP70
            ELSE      
              PACK      RESADESC,TDESC
            ENDIF
          ELSE
            PACK      RESADESC,SP70
          ENDIF
.
          PACK      KEY5,EMVIDEST,SP70
          MATCH     SP70,KEY5
          IF        @EQUAL
            PACK      DPTVADES,SP70,SP70
          ELSE
            CALL      RDPTVAD1
            MOVE      PTVADESC,DPTVADES
          ENDIF
.
          CALL      EDSC0000              * Format expected discharge deatils
.
          MOVE      SP70,DISPSTAT
          MATCH     SP70,EMVIDSTA
          IF        !@EQUAL
            PACK      KEY5,CATED,EMVIDSTA
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,DISPSTAT
              MOVE      SP70,STATIND
            ELSE
              MOVE      TDESC,DISPSTAT
              MOVE      TCINDC2,STATIND
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPUC28
.
          MATCH     SP70,EMVIPADM
          IF        !@EQUAL
            PACK      KEY8,EMVIPADM
            CALL      RDMISS1
            IF        OVRCD=0
              COMPARE   ONE,ASTAT      * Pre-admission?
              IF        !@EQUAL
                MOVE      "Completed",DISPUC28   * Not a pre-admission
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,DISPUC28
          IF        @EQUAL
            MATCH     SP70,EMVIUC28
            IF        !@EQUAL
              PACK      KEY5,CATET,EMVIUC28
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,DISPUC28
              ENDIF
            ENDIF
          ENDIF
.
          CALL      BEDS0000           * Ward/Bed Request
          CALL      BEDC0000           * Ward/Bed Request with colour
          CALL      BEDA0000           * Ward/Bed Request with Allocation colour
          CALL      ALHTST00           * Allied health Status color
.
          PACK      DISDIAG,SP70
          PACK      DISDIAGF,SP70
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
OUTVIS11  CALL      RKEMVCD1
          BRANCH    OVRCD,OUTVIS15
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      OUTVIS15 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      OUTVIS12 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      OUTVIS11 IF NOT EQUAL
.
OUTVIS12  MATCH     "000",EMVCSEQU
          GOTO      OUTVIS11 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
          MOVE      CODEDESC,DISDIAG
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      DISDIAG,DISDIAGF        * Free format diagnosis
          ELSE
            MOVE      EMVCFTXT,DISDIAGF       * Free format diagnosis
          ENDIF
.
OUTVIS15  PACK      DISDIAG,DISDIAG,SP70
          PACK      DISDIAGF,DISDIAGF,SP70
.
          MATCH     "       0",EMVIPADM
          GOTO      OUTVIS20 IF EQUAL
.
          PACK      KEY8,EMVIPADM
          CALL      RDMISS1
          BRANCH    OVRCD,OUTVIS20
.
          CALL      GANAM000              *     Get Attending Doctor
.
          MATCH     SP70,EMVIEWRD           * Use admitted ward/bed if expected
          GOTO      OUTVIS20 IF NOT EQUAL   * ward/bed is blank
.
          PACK      KEY30,EMVIPADM,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,OUTVIS20
.         
          MATCH     DTADMN,EMVIPADM
          IF        @EQUAL
            MOVE      TWARD,EMVIEWRD
            MOVE      TBED,EMVIEBED
          ENDIF
.
OUTVIS20  MOVE      EMVITXT2,EDDISDIA       * WA health ED disharge doctor
          MOVE      EMVIDATE,ICDRDDTE
          PACK      KEY9,PMVXPICD,SP70      * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      DDESC,EDDISDIA
          ENDIF
.
          MATCH     SP70,DISDIAGF
          IF        !@EQUAL
            MOVE      DISDIAGF,EDDISDIA     * wahealth ED full
          ENDIF
.
          MATCH     ANSP,REPTTYPE
          IF        @EQUAL
            CALL      PRTROW00
          ELSE
            REP       "#"'\/",SEMVICO1
            REP       "#"'\/",SEMVICO2
.
            CALL      PATFLD00              *Returns KEY3 for folder colour code
.
            IF        EMVISTAT=1
              MOVE      SP70,EMVIDDAT            * Clear discharge date/time
              MOVE      SP70,EMVIDTIM            * if not discharged
            ENDIF
.
            CALL      EWRD0000                   * Get expected ward description
.
            CALL      FFDIAG00                   * Get Free Format Diag and 
.                                                * ICD10 Desc
            CALL      DOCTAT00  
            CALL      NURSAT00
            CALL      NURTRG00                   * Get triage nurse name
            CALL      DOCUDF00                   * Get user defined doctor 4
            CALL      DOCMPA00                   * Mental health practitioner
            CALL      DOCTSN00                   * Senior Doctor
.
            PACK      ALRTIMG1,SP70,SP70,SP70,SP70
            PACK      ALRTIMG2,SP70,SP70,SP70,SP70
            PACK      ALRTIMG3,SP70,SP70,SP70,SP70
            PACK      ALRTIMG4,SP70,SP70,SP70,SP70
            PACK      ALRTIMGE,SP70,SP70,SP70,SP70
            PACK      ALRTDISA,SP70,SP70,SP70,SP70
            PACK      ALRTIMGT,SP100,SP100,SP100,SP100:
                               SP100,SP100,SP100,SP100:
                               SP100,SP100,SP100,SP100:
                               SP100
.
            MATCH     "       0",EMVIURNO
            IF        !@EQUAL
              MOVE      ZERO,EXIT
              PROC      DISPALRT
              IF        EXIT=0 | EXIT=2
.
                REPLACE   " +",EMVIURNO
                REPLACE   " +",DEMVIADM
                REPLACE   " +",EMTSHOSP
                REPLACE   " +",EMTSSITE
.
                MATCH     "1",PMPXSIN7
                IF        @EQUAL
                  CLEAR     ALRTIMG1
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG1
                  APPEND    " alt='Medical Alerts'",ALRTIMG1
                  APPEND    " onclick=",ALRTIMG1
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMG1
                  APPEND    EMVIURNO,ALRTIMG1
                  APPEND    "';", ALRTIMG1
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMG1
                  APPEND    DEMVIADM,ALRTIMG1
                  APPEND    "';", ALRTIMG1
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMG1
                    APPEND    EMTSHOSP,ALRTIMG1
                    APPEND    "','",ALRTIMG1
                    APPEND    EMTSSITE,ALRTIMG1
                    APPEND    "');",ALRTIMG1
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMG1
                  ENDIF
                  APPEND    " src='../images/AlertIconM.gif'>",ALRTIMG1
                  RESET     ALRTIMG1
                ENDIF
.
                MATCH     "1",PMPXSIN8
                IF        @EQUAL
                  CLEAR     ALRTIMG2
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG2
                  APPEND    " alt='Micro Alerts'",ALRTIMG2
                  APPEND    " onclick=",ALRTIMG2
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMG2
                  APPEND    EMVIURNO,ALRTIMG2
                  APPEND    "';", ALRTIMG2
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMG2
                  APPEND    DEMVIADM,ALRTIMG2
                  APPEND    "';", ALRTIMG2
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMG2
                    APPEND    EMTSHOSP,ALRTIMG2
                    APPEND    "','",ALRTIMG2
                    APPEND    EMTSSITE,ALRTIMG2
                    APPEND    "');",ALRTIMG2
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMG2
                  ENDIF
                  APPEND    " src='../images/AlertIconB.gif'>",ALRTIMG2
                  RESET     ALRTIMG2
                ENDIF
.
                MATCH     "1",PMPXSIN9
                IF        @EQUAL
                  CLEAR     ALRTIMG3
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG3
                  APPEND    " alt='Risk Alerts'",ALRTIMG3
                  APPEND    " onclick=",ALRTIMG3
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMG3
                  APPEND    EMVIURNO,ALRTIMG3
                  APPEND    "';", ALRTIMG3
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMG3
                  APPEND    DEMVIADM,ALRTIMG3
                  APPEND    "';", ALRTIMG3
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMG3
                    APPEND    EMTSHOSP,ALRTIMG3
                    APPEND    "','",ALRTIMG3
                    APPEND    EMTSSITE,ALRTIMG3
                    APPEND    "');",ALRTIMG3
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMG3
                  ENDIF
                  APPEND    " src='../images/AlertIconR.gif'>",ALRTIMG3
                  RESET     ALRTIMG3
                ENDIF
.
                MATCH     "1",PMPXSN11
                IF        @EQUAL
                  CLEAR     ALRTIMG4
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG4
                  APPEND    " alt='Chronic Alerts'",ALRTIMG4
                  APPEND    " onclick=",ALRTIMG4
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMG4
                  APPEND    EMVIURNO,ALRTIMG4
                  APPEND    "';", ALRTIMG4
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMG4
                  APPEND    DEMVIADM,ALRTIMG4
                  APPEND    "';", ALRTIMG4
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMG4
                    APPEND    EMTSHOSP,ALRTIMG4
                    APPEND    "','",ALRTIMG4
                    APPEND    EMTSSITE,ALRTIMG4
                    APPEND    "');",ALRTIMG4
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMG4
                  ENDIF
                  APPEND    " src='../images/AlertIconC.gif'>",ALRTIMG4
                  RESET     ALRTIMG4
                ENDIF
.
                MATCH     "1",PTMXSIN1
                IF        @EQUAL
                  CLEAR     ALRTIMGE
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
                  APPEND    " alt='Alerts'",ALRTIMGE
                  APPEND    " onclick=",ALRTIMGE
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMGE
                  APPEND    EMVIURNO,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMGE
                  APPEND    DEMVIADM,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMGE
                    APPEND    EMTSHOSP,ALRTIMGE
                    APPEND    "','",ALRTIMGE
                    APPEND    EMTSSITE,ALRTIMGE
                    APPEND    "');",ALRTIMGE
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMGE
                  ENDIF
                  APPEND    " src='../images/AlertIcon.gif'>",ALRTIMGE
                  RESET     ALRTIMGE
                  GOTO      OUTVIS25
                ENDIF
.
                MATCH     "2",PTMXSIN1
                IF        @EQUAL
                  CLEAR     ALRTIMGE
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
                  APPEND    " alt='Alerts'",ALRTIMGE
                  APPEND    " onclick=",ALRTIMGE
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMGE
                  APPEND    EMVIURNO,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMGE
                  APPEND    DEMVIADM,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMGE
                    APPEND    EMTSHOSP,ALRTIMGE
                    APPEND    "','",ALRTIMGE
                    APPEND    EMTSSITE,ALRTIMGE
                    APPEND    "');",ALRTIMGE
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMGE
                  ENDIF
                  APPEND    " src='../images/AlertIconBlack.gif'>",ALRTIMGE
                  RESET     ALRTIMGE
                  GOTO      OUTVIS25
                ENDIF
.
                MATCH     "3",PTMXSIN1
                IF        @EQUAL
                  CLEAR     ALRTIMGE
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
                  APPEND    " alt='Alerts'",ALRTIMGE
                  APPEND    " onclick=",ALRTIMGE
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMGE
                  APPEND    EMVIURNO,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMGE
                  APPEND    DEMVIADM,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMGE
                    APPEND    EMTSHOSP,ALRTIMGE
                    APPEND    "','",ALRTIMGE
                    APPEND    EMTSSITE,ALRTIMGE
                    APPEND    "');",ALRTIMGE
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMGE
                  ENDIF
                  APPEND    " src='../images/AlertIconDelete.gif'>",ALRTIMGE
                  RESET     ALRTIMGE
                  GOTO      OUTVIS25
                ENDIF
.
                MATCH     "0",PTMXSIN1
                GOTO      OUTVIS25 IF EQUAL
.
                MATCH     SP70,PTMXSIN1
                IF        !@EQUAL
                  CLEAR     ALRTIMGE
                  APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
                  APPEND    " alt='Alerts'",ALRTIMGE
                  APPEND    " onclick=",ALRTIMGE
                  APPEND    "document.HiddenFields.alrturno.value='",ALRTIMGE
                  APPEND    EMVIURNO,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  APPEND    "document.HiddenFields.alrtadmn.value='",ALRTIMGE
                  APPEND    DEMVIADM,ALRTIMGE
                  APPEND    "';", ALRTIMGE
                  IF        ETSVISFL=1
                    APPEND    "PatientAlerts('",ALRTIMGE
                    APPEND    EMTSHOSP,ALRTIMGE
                    APPEND    "','",ALRTIMGE
                    APPEND    EMTSSITE,ALRTIMGE
                    APPEND    "');",ALRTIMGE
                  ELSE
                    APPEND    "PatientAlerts();",ALRTIMGE
                  ENDIF
                  APPEND    " src='../images/AlertIcon",ALRTIMGE
                  APPEND    PTMXSIN1,ALRTIMGE
                  APPEND    ".gif'>",ALRTIMGE
                  RESET     ALRTIMGE
                ENDIF
              ENDIF
.
OUTVIS25      IF        EXIT=1 | EXIT=2
                CLEAR     ALRTDISA
                APPEND    "<img border=0 hspace=4 align=absmiddle",ALRTDISA
                APPEND    " alt='Disability Alerts'",ALRTDISA
                APPEND    " onclick=",ALRTDISA
                APPEND    "document.HiddenFields.alrturno.value='",ALRTDISA
                APPEND    EMVIURNO,ALRTDISA
                APPEND    "';", ALRTDISA
                APPEND    "document.HiddenFields.alrtadmn.value='",ALRTDISA
                APPEND    DEMVIADM,ALRTDISA
                APPEND    "';", ALRTDISA
                IF        ETSVISFL=1
                  APPEND    "PatientAlerts('",ALRTDISA
                  APPEND    EMTSHOSP,ALRTDISA
                  APPEND    "','",ALRTDISA
                  APPEND    EMTSSITE,ALRTDISA
                  APPEND    "');",ALRTDISA
                ELSE
                  APPEND    "PatientAlerts();",ALRTDISA
                ENDIF
                APPEND    " src='../images/AlertIconDIS.gif'>",ALRTDISA
                RESET     ALRTDISA
              ENDIF
.
              STRIP     ALRTIMG1
              STRIP     ALRTIMG2
              STRIP     ALRTIMG3
              STRIP     ALRTIMG4
              STRIP     ALRTIMGE
              STRIP     ALRTDISA
              PACK      ALRTIMGT,ALRTIMG1,ALRTIMG2,ALRTIMG3,ALRTIMG4,ALRTIMGE,ALRTDISA
.
              REPLACE   "+ ",EMVIURNO
              REPLACE   "+ ",DEMVIADM
              REPLACE   "+ ",EMTSHOSP
              REPLACE   "+ ",EMTSSITE
.
            ENDIF
.
            WRITE     HTMLFILE;"   obj.AddPatient(#"",PATTNAME,"#",": * 0
                               "#"",EMVILOCN,"#",":                   * 1
                               "#"",SLOCNDES,"#",":                   * 2
                               "#"",EMVIURNO,"#",":                   * 3
                               "#"",EMVIADMN,"#",":                   * 4
                               "#"",DTRIG,"#",":                      * 5
                               "#"",STRIGDES,"#",":                   * 6
                               "#"",EMVIDATE,EMVITIME,"#",":          * 7
                               "#"",PSEX,"#",":                       * 8
                               "#"",DISPAGE,"#",":                    * 9
                               "#"",SEMVICO1," ",SEMVICO2,"#",":      * 10
                               "#"",HCPFNAME,"#",":                   * 11
                               "#"",EMVIDRDT,EMVIDRTM,"#",":          * 12
                               "#"",DOCINIT,"#",":                    * 13
                               "#"",EMVIATNS,"#",":                   * 14
                               "#"",UPDATEKY,"#",":                   * 15
                               "#"",EMVIADMT,"#",":                   * 16
                               "#"",DPTVADES,"#",":                   * 17
                               "#"",SPTVADES,"#",":                   * 18
                               "#"",DISPSTAT,"#",":                   * 19
                               "#"",ADOCNAME,"#",":                   * 20
                               "#"",EMVIPADM,"#",":                   * 21
                               "#"",EMVIEWRD,"#",":                   * 22
                               "#"",EMVIDDAT,EMVIDTIM,"#",":          * 23
                               "#"",DISDIAG,"#",":                    * 24
                               "#"",EMVIUC02,"#",":                   * 25
                               "#"",STATIND,"#",":                    * 26
                               "#"",SRCEDESC,"#",":                   * 27
                               "#"",CONSNAME,"#",":                   * 28
                               "#"",EMVIEWRD,"/",EMVIEBED,"#",":      * 29
                               "#"",EMVIUC20,"#",":                   * 30
                               "#"",AARRTIME,"#",":                   * 31
                               "#"",UNITDISP,"#",":                   * 32
                               "#"",EMVIDOCT,"#",":                   * 33
                               "#"",COMPDISP,"#",":                   * 34
                               "#"",RESPNAME,"#",":                   * 35
                               "#"",RESPNURE,"#",":                   * 36  
                               "#"",KEY3,"#",":                       * 37  
                               "#"",DOCTNAM2,"#",":                   * 38
                               "#"",FORMATNM,"#",":      * I-48257    * 39
                               "#"",EMVIUD03,EMVIUT03,"#",":          * 40
                               "#"",EMVIUD04,EMVIUT04,"#",":          * 41
                               "#"",EMVICOMP,"#",":                   * 42
                               "#"",DISPBEDS,"#",":                   * 43
                               "#"",DISPUC28,"#",":                   * 44
                               "#"",AGEINDAY,"#",":                   * 45
                               "#"",EMVIUR01,"#",":                   * 46
                               "#"",EMVIUD01,EMVIUT01,"#",#"";        * 47
.
          MOVE      EMVIADMN,PVIBILL
          CALL      VCDM0000                  * 48 Visit based CDM Icons
.
          COMPARE     SFDSTIME,ZERO
          IF        @EQUAL
            MOVE    "",_SFDTEMP
          ELSE
            MOVE    SFDSTIME,_SFDTEMP
          ENDIF
.   
          MATCH     "000000000",NEXTSEQN
          IF        @EQUAL
            MOVE      "999999999",NEXTSEQN
          ENDIF
.
          MOVE      SP70,DISPUC16
          PACK      NEXTSEQS,SP70            * Next patient stream Complex / Non Complex
          MATCH     SP70,EMVIUC16
          IF        !@EQUAL
            PACK      KEY5,CATEH,EMVIUC16,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DISPUC16                        * Next patient by
              PACK      NEXTSEQS,ACODE,SP70                    
            ENDIF
          ENDIF
.
          CALL      GETDWT00  * Determine Wait to be Seen Time
.
. Presenting Complaint/Diagnosis Field
.
          PACK      COMPDIAG,DISDIAGF,SP70,SP70
          MATCH     SP70,COMPDIAG
          GOTO      OUTVIS30 IF NOT EQUAL
.
          CLEAR     COMPDIAG
          APPEND    SEMVICO1,COMPDIAG
          APPEND    SP1,COMPDIAG
          APPEND    SEMVICO2,COMPDIAG
.
OUTVIS30  RESET     COMPDIAG
          STRIP     COMPDIAG
          REP       "#"'\/",COMPDIAG 
.
          CALL      MANNOT00           * Get Management Notes
.
          WRITE     HTMLFILE;"#",#"",_SFDTEMP,"#",":                  * 49
                             "#"",DISPSTAT,"<br>",DPTVADES,"#",":     * 50
                             "#"",RESADESC,"#",":                     * 51
                             "#"",DISDIAGF,"#",":                     * 52
                             "#"",CLASDESC,"#",":                     * 53  Health Speciality
                             "#"",CLASIN12,"#",":                     * 54  Health Speciality Indicator
                             "#"",SRCEIN12,"#",";                     * 55  Referral Source Indicator
.
          WRITE     HTMLFILE;"#"",EDDISDIA,"#",":                     * 56
                             "#"",COMPDIAG,"#",":                     * 57
                             "#"",EWRDDESC,"#",":                     * 58
                             "#"",EWRBDESC,"#",":                     * 59
                             "#"",DISPUC16,"#",":                     * 60
                             "#"",DISDIAG2,"#",":                     * 61
                             "#"",NEXTSEQN,"#",":                     * 62
                             "#"",WAITTIME,"#",":                     * 63
                             "#"",DISPTRNS,"#",":                     * 64
                             "#"",DISPUR04,"#",":                     * 65
                             "#"",DISPMPRA,"#",":                     * 66
                             "#"",NEXTSEQS,"#",":                     * 67
                             "#"",SENDNAME,"#",":                     * 68
                             "#"",FORMATNM,ALRTIMGT,"#",";            * 69
.
            MOVE      "fv",CATEGORY
            MOVE      PMVXFVIO,CODE
            CALL      GETCOD00
.
.
            PACK      KEY17,EMVIADMN,ZERO,ZERO,ONE,SP5,ONE,SP70
            CALL      RDVSMDT1
.
            IF        OVRCD=ONE
              WRITE     HTMLFILE;"#"",COMPDIAG;                       * 70
.
              MATCH     "F",TCINDC3
              IF        @EQUAL
                MOVE      "G ",CATEGORY
                MOVE      PSEX,CODE
                CALL      GETCOD00
.
                MATCH     "F",THCSCOD
                IF        @EQUAL                   
                  COMPARE   "15",PSAGEYRS
                  IF        !@LESS
                    WRITE     HTMLFILE;"</br><img src='../images/alert-9.gif'":
                                       "style='padding-top:10px'>#",";
                  ELSE
                    WRITE     HTMLFILE;"#",";
                  ENDIF
                ELSE
                  WRITE     HTMLFILE;"#",";
                ENDIF
              ELSE
                WRITE     HTMLFILE;"#",";
              ENDIF
            ELSE
.
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM
.
              WRITE     HTMLFILE;"#"":                                * 70
    "&nbsp;<img src='../images/ActionIcon.gif' style='cursor:pointer' ":
    "title='Clinical Notes' ":
    "onclick=\#"document.HiddenFields.alrturno.value='",EMVIURNO,"';":
    "document.HiddenFields.alrtadmn.value='",DEMVIADM,"';":
    "document.HiddenFields.acnestat.value='",EMVISTAT,"';";
              IF        ETSVISFL=1
                WRITE     HTMLFILE;"AddClinNote('",EMTSHOSP,"','",EMTSSITE,"');";
              ELSE
                WRITE     HTMLFILE;"AddClinNote();";
              ENDIF
.
              WRITE     HTMLFILE;"\#" border=0>&nbsp;&nbsp;",COMPDIAG;
.
              MATCH     "F",TCINDC3
              IF        @EQUAL
                MOVE      "G ",CATEGORY
                MOVE      PSEX,CODE
                CALL      GETCOD00
.
                MATCH     "F",THCSCOD
                IF        @EQUAL                   
                  COMPARE   "15",PSAGEYRS
                  IF        !@LESS
                    WRITE     HTMLFILE;"</br><img src='../images/alert-9.gif'":
                                       "style='padding-top:10px'>#",";
                  ELSE
                    WRITE     HTMLFILE;"#",";
                  ENDIF
                ELSE
                  WRITE     HTMLFILE;"#",";
                ENDIF
              ELSE
                WRITE     HTMLFILE;"#",";
              ENDIF
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
.
            ENDIF
.
            WRITE     HTMLFILE;"#"",MANNOT01,"<br>":
                                    MANNOT02,"<br>":
                                    MANNOT03,"<br>":
                                    MANNOT04,"#",";
.
            COMPARE   FIVE,MANNCNTR
            IF        @EQUAL
              REP       " +",EMVIURNO
              REP       " +",DEMVIADM 
              WRITE     HTMLFILE;"#"":                                  * 72
    "<img src=../images/ActionIcon.gif onclick=displayManNot('",EMVIURNO,"','":
                                                             DEMVIADM,"');>#"";
              REP       "+ ",EMVIURNO
              REP       "+ ",DEMVIADM
            ELSE
              WRITE     HTMLFILE;"#"#"";                                * 72
            ENDIF
.
            WRITE     HTMLFILE;",#"",STOPDTIM,"#",";                    * 73
            WRITE     HTMLFILE;"#"",DISPDEBR,"#",";                     * 74
            WRITE     HTMLFILE;"#"",EXPDDISC,"#",";                     * 75
.
            MOVE      SP70,HOSPNAME
            WRITE     HTMLFILE;"#"",PMVXMHOS,"#",";                     * 76
.
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,HOSPNAME
            ENDIF
            WRITE     HTMLFILE;"#"",HOSPNAME,"#",";                     * 77
.
            MOVE      SP70,SITENAME
            WRITE     HTMLFILE;"#"",EMVISITE,"#",";                     * 78
.
            PACK      KEY3,EMVISITE,SP70
            CALL      RDEMSIT1
            IF        OVRCD=0
              MOVE      EMSTDESC,SITENAME
            ENDIF
            WRITE     HTMLFILE;"#"",SITENAME,"#",";                     * 79
.
            UNPACK    EMVITIME,KEY5
            WRITE     HTMLFILE;"#"",KEY5,"#"";                          * 80
.
            IF        ETSVISFL=1
.             Output ETS (Telehealth) details
              WRITE     HTMLFILE;",#"",EMTSCNTR,"#",";                  * 81
              WRITE     HTMLFILE;"#"",EMTSSITE,"#",";                   * 82
              WRITE     HTMLFILE;"#"",EMTSHOSP,"#",";                   * 83
              WRITE     HTMLFILE;"#"",EMTSLOCN,"#",";                   * 84
            ELSE
              WRITE     HTMLFILE;",#"",SP1,"#",";                       * 81
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 82
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 83
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 84
            ENDIF
.
            WRITE     HTMLFILE;"#"",EMVISTAT,"#",";                     * 85
.
            CALL      MVST0000    * Management View Sort Order
            WRITE     HTMLFILE;"#"",MANVSORT,"#",";                     * 86
.
            CALL      STRM0000    * Management View Sort Order
            WRITE     HTMLFILE;"#"",STRMSORT,"#",";                     * 87
            WRITE     HTMLFILE;"#"",STRMICON,"#",";                     * 88
.
            WRITE     HTMLFILE;"#"",EMVIMDCD,"#",";                     * 89
.
            CALL      CONS0000    * Consults Icon
            WRITE     HTMLFILE;"#"",CONSSORT,"#",";                     * 90
            WRITE     HTMLFILE;"#"",CONSICON,"#",";                     * 91
.
            MATCH     SP70,EMVIUD01
            IF        @EQUAL
              MOVE      SP70,DEPREADY
            ELSE
              CLEAR     DEPREADY
              APPEND    "<p style='font-size:160%;font-weight: bold;",DEPREADY
              APPEND    "vertical-align:middle;'>D</p>",DEPREADY     
              RESET     DEPREADY
            ENDIF
.
            WRITE     HTMLFILE;"#"",DEPREADY,"#",";                     * 92
.
            CALL      SJGN0000              * SJOG Name
            WRITE     HTMLFILE;"#"",FORMATNM,SP1,FMTGNAME:
                               "<br>",PURNO,COMMA,SP1,PSEX,"#",";       * 93
.
            WRITE     HTMLFILE;"#"",DISPBEDA,"#",";                     * 94
.
            MOVE      SP70,VDELAYED              * Not delayed
            PACK      KEY29,DEMVIADM,SP70
            CALL      RSEMDEL1
OUTVIS40    CALL      RKEMDEL1                   * Check for active delay reason
            BRANCH    OVRCD,OUTVIS41             * record
.
            MATCH     EMDEVISN,DEMVIADM          * Correct visit
            GOTO      OUTVIS41 IF NOT EQUAL
.
            MATCH     "1",EMDEDELT               * deleted
            GOTO      OUTVIS40 IF EQUAL
.
            MOVE      ONE,VDELAYED               * Yes visit delayed
.
OUTVIS41    WRITE     HTMLFILE;"#"",VDELAYED,"#",";                     * 95
            MOVE      DISPBEDA,DISPBEDX
            STRIP     DISPBEDX
            MATCH     SP70,DISPBEDX
            IF        @EQUAL|@EOS
              MOVE      SP70,PTCDNHCP
              MATCH     SP70,EMVIDISD
              IF        !@EQUAL
                MOVE      "dd",CATEGORY
                PACK      KEY5,CATEGORY,EMVIDISD,SP70
                CALL      RDCODE1
              ENDIF
              WRITE     HTMLFILE;"#"",PTCDNHCP,"#",";                   * 96
            ELSE
              WRITE     HTMLFILE;"#"",DISPBEDX,"#",";                   * 96
            ENDIF
.
            WRITE     HTMLFILE;"#"",ALHSTCLR,"#",";                     * 97
.
OUTVIS50    MOVE      SP70,ISOCOLOR
            MATCH     SP70,EMVIUC27
            IF        !@EQUAL
              PACK      KEY5,CATES,EMVIUC27,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     ANSY,TCINDC2
                IF        @EQUAL
                  MOVE      "PinkBackground",ISOCOLOR
                ENDIF  
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"#"",ISOCOLOR,"#",":                      * 98
                               "#"",SEMVICO1," ",SEMVICO2,"#"";          * 99
.
            WRITE     HTMLFILE;");"
.
          ENDIF
          MOVE      ZERO,UNKFLAG
.
OUTVIS99  RETURN
+
.----------------------------------------------------------------------------
. Returns the allied health status color Icon
.----------------------------------------------------------------------------
ALHTST00  CLEAR     ALHSTCLR
          MATCH     SP70,EMVIAHST
          IF        @EQUAL
            IF        PSAGEYRS < 65
              MOVE      "5",DIM1
              GOTO      ALHTST50
            ENDIF
          ENDIF
.
          MATCH     "R",EMVIAHST
          IF        @EQUAL
            MOVE      "1",DIM1
            GOTO      ALHTST50
          ENDIF
.
          MATCH     "A",EMVIAHST
          IF        @EQUAL
            MOVE      "2",DIM1
            GOTO      ALHTST50
          ENDIF
.
          MATCH     "G",EMVIAHST
          IF        @EQUAL
            MOVE      "3",DIM1
            GOTO      ALHTST50
          ENDIF
.
          MATCH     "N",EMVIAHST
          IF        @EQUAL
            MOVE      "5",DIM1
            GOTO      ALHTST50
          ENDIF
.
          GOTO      ALHTST99
.
ALHTST50  APPEND    "<img src='../images/new-triage",ALHSTCLR
          APPEND    DIM1,ALHSTCLR
          APPEND    ".gif'",ALHSTCLR
          APPEND    " class=Icon>",ALHSTCLR
          RESET     ALHSTCLR     
.
ALHTST99  RETURN
.
.------------------------------------------------------------------------------
. SJOG Name format - Line 1, Surname, Given Name
.                    Line 2, U/R, Sex Code
.------------------------------------------------------------------------------
SJGN0000  PACK      SJOGNAME,SP70,SP70
.
          MATCH     ZEROUR,EMVIURNO
          IF        @EQUAL
            PACK      KEY8,EMVIADMN,SP70
            CALL      RDEMUNK1
            IF        OVRCD<>1
              MOVE      "       0",PURNO
.
              MATCH     SP70,EMUNDET2
              IF        @EQUAL
                MOVE      "Unknown",EMUNDET1
                MOVE      EMVIADMN,EMUNDET2
              ENDIF
.
              MOVE      EMUNDET1,PTMASNAM
              MOVE      EMUNDET2,PGNAME
              MOVE      EMUNSEX,PSEX
            ENDIF
          ENDIF
.
          REP      "#" ",PTMASNAM
          REP      UPPLOW,PTMASNAM
.
          STRIP    PTMASNAM
          CLEAR    FORMATNM
          APPEND   "<b>",FORMATNM
          APPEND   PTMASNAM,FORMATNM
          APPEND   "</b>",FORMATNM
          APPEND   ",",FORMATNM
          RESET    FORMATNM
          STRIP    FORMATNM
.
          PACK     PTMASNAM,PTMASNAM,SP70   * Restore full length
.
          MOVE     PGNAME,FMTGNAME
          REP      "#" ",FMTGNAME
          CLEAR    DISPNAME
          PACK     NAME35,FMTGNAME,SP70
          CALL     NAMSTR00
          APPEND   SP70,DISPNAME
          RESET    DISPNAME
          MOVE     DISPNAME,FMTGNAME
          STRIP    FMTGNAME
.
SJGN9999  RETURN
+
.------------------------------------------------------------------------------
. Consults Icon Display and sort order
. CONSSORT - Consult sort indicator
. CONSICON - Consult Icon
.------------------------------------------------------------------------------
CONS0000  MOVE      SP70,CONSSORT                   * Clear consults sort
          MOVE      SP70,CONSICON                   * Clear consults image
.
          PACK      KEY31,EMVIADMN,SP70
          CALL      RSPTCRC1
CONS1000  CALL      RKPTCRC1                        * Check for consults
          BRANCH    OVRCD,CONS9999
.
          MATCH     EMVIADMN,PTCRBILL               * Correct visit
          GOTO      CONS9999 IF NOT EQUAL
.
          MATCH     SP70,PTCRACTN
          IF        @EQUAL
            CLEAR     CONSICON
            APPEND    "<img src=../images/",CONSICON
            APPEND    "ballred.gif",CONSICON               * Red Ball
            APPEND    " class=Icon>",CONSICON
            RESET     CONSICON
            MOVE      "R",CONSSORT
            GOTO      CONS9999
          ENDIF
.
          CLEAR     CONSICON
          APPEND    "<img src=../images/",CONSICON
          APPEND    "ball_gre.gif",CONSICON               * Green Ball
          APPEND    " class=Icon>",CONSICON
          RESET     CONSICON
          MOVE      "G",CONSSORT
.
          GOTO      CONS1000
.
CONS9999  RETURN
+
.------------------------------------------------------------------------------
. Stream Icon Display and sort order 
. STRMSORT - Stream sort indicator
. STRMICON - Stream Icon
.------------------------------------------------------------------------------
STRM0000  MOVE      SP70,STRMSORT                   * Clear stream sort 
          MOVE      SP70,STRMICON                   * Clear stream image
.
          MATCH     SP70,EMVIUC16                   * No stream
          GOTO      STRM9999 IF EQUAL
.
          PACK      KEY5,CATEH,EMVIUC16,SP70        * Read stream
          CALL      RDCODE1
          BRANCH    OVRCD,STRM9999
.
          STRIP     TDESC
.
          MATCH     "D",TCINDC1                     * Grey Diamond icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "rhombus-grey-20.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "H",TCINDC1                     * Heart icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "OrganIcon.gif'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "S",TCINDC1                     * Yellow Star icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "star-yellow-20.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "F",TCINDC1                     * Pink Ball icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "ballpink.gif'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "B",TCINDC1                     * Blue Ball icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "ball_blu.gif'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "G",TCINDC1                     * Green Cross icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "FullDetailsGreen.gif'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "I",TCINDC1                     * Grey Horizontal Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "GreyH.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "J",TCINDC1                     * Grey Vertical Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "GreyV.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "K",TCINDC1                     * Yellow Horizontal Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "YellH.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "L",TCINDC1                     * Yellow Vertical Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "YellV.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "M",TCINDC1                     * Green Horizontal Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "GreenH.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "N",TCINDC1                     * Green Vertical Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "GreenV.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "O",TCINDC1                     * Purple Horizontal Icon 
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "PurpH.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "P",TCINDC1                     * Purple Vertical Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "PurpV.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "Q",TCINDC1                     * Red Horizontal Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "RedH.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          MATCH     "R",TCINDC1                     * Red Vertical Icon
          IF        @EQUAL
            MOVE      TCINDC1,STRMSORT
            CLEAR     STRMICON
            APPEND    "<img src='../images/",STRMICON
            APPEND    "RedV.png'",STRMICON
            APPEND    " alt=#'",STRMICON
            APPEND    TDESC,STRMICON
            APPEND    "#'",STRMICON
            APPEND    " class=Icon ",STRMICON
            APPEND    "onclick=\#"openStream('",STRMICON
            APPEND    EMVIURNO,STRMICON
            APPEND    "','",STRMICON
            APPEND    EMVIADMN,STRMICON
            APPEND    "');\#">",STRMICON
            RESET     STRMICON
          ENDIF
.
          RESET      TDESC
.
STRM9999  RETURN
+
.------------------------------------------------------------------------------
. Calculate management view sort order - MANVSORT
.
. First order is by Treating Doctor
.
. If there is no Treating Doctor the patients will then ee ordered by
. Triage Category, and then Length of Stay, with oldest at the top
.
. If there is a Treating Doctor the patients will then be ordered by
. Length of Stay, with oldest at the top
. Lowest number displays first - XYAAAA  X=Doctor allocated No/Yes, 0/1
.                                        Y=Triage cat or 9 = ignore
.                                        AAAA = 9999 - Length of stay
.------------------------------------------------------------------------------
MVST0000  MATCH     SP70,EMVIDOCT
          IF        !@EQUAL
            PACK      D2,ONE,NINE           * Doctor and ignore triage category
            GOTO      MVST5000
          ENDIF
.
          MATCH     SP70,EMVITRIG
          IF        @EQUAL
            PACK      D2,ZERO,ZERO          * No Doctor and No triage category
            GOTO      MVST5000
          ENDIF
.
          MOVE      "AA",CATEGORY
          MOVE      EMVITRIG,CODE
          CALL      GETCOD00                * Triage category
.
          TYPE      TCINDC1
          IF        !@EQUAL
            MOVE      FIVE,TCINDC1          * Default to Cat 5 if no triage cat
          ENDIF                             * or indicator not set
.
          PACK      D2,ZERO,TCINDC1         * No Doctor and triage category
.
MVST5000  MOVE      SP70,AARRTIME
          CALL      GETWAT00                * Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      "9999",F4A
          MOVE      WAITTIME,F4
          SUB       F4,F4A                  * 9999 - LOS minutes
          PACK      MANVSORT,D2,F4A,SP70
          REP       " 0",MANVSORT    
.
MVST9999  RETURN

+
.------------------------------------------------------------------------------
.         Current ETS (Emergency Telehealth Service) Patients List
.------------------------------------------------------------------------------
CURETS00  MOVE      SP70,LASTVISN
          MOVE      ONE,ETSVISFL            * ETS visit flag (used by OUTVIS00)
.
          MATCH     SP70,FILTSITE           * Site filter specified?
          GOTO      CURETS20 IF NOT EQUAL
.
.
.         Loop by Status = 1 (Current Emergency Patient)
.
CURETS10  PACK      KEY12,ONE,Z70
          CALL      RSEMTHS4
CURETS11  CALL      RPEMTHS4
          BRANCH    OVRCD,CURETS99
.
          MATCH     "1",EMTSSTAT            * Current patient?
          GOTO      CURETS99 IF NOT EQUAL
.
          MATCH     EMTSVISN,LASTVISN
          GOTO      CURETS11 IF EQUAL
.
          MOVE      EMTSVISN,LASTVISN       * Store the last visit no. read
.
          PACK      KEY8,EMTSVISN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,CURETS11
.
          MATCH     SP70,FILTDOCT           * Clinician filter specified?
          GOTO      CURETS30 IF EQUAL
          GOTO      CURETS30 IF EOS
.
          MATCH     EMVIDOCT,FILTDOCT       * Match Treating Doctor
          GOTO      CURETS11 IF NOT EQUAL
.
          GOTO      CURETS30                * Get other data
.
.
.         Loop by Site Code
.
CURETS20  PACK      KEY14,FILTSITE,Z70
          CALL      RSEMTHS2
CURETS21  CALL      RPEMTHS2
          BRANCH    OVRCD,CURETS99
.
          MATCH     EMTSSITE,FILTSITE       * Same site?
          GOTO      CURETS99 IF NOT EQUAL
.
          MATCH     "1",EMTSSTAT            * Current patient?
          GOTO      CURETS21 IF NOT EQUAL
.
          MATCH     EMTSVISN,LASTVISN
          GOTO      CURETS21 IF EQUAL
.
          MOVE      EMTSVISN,LASTVISN       * Store the last visit no. read
.
          PACK      KEY8,EMTSVISN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,CURETS21
.
          MATCH     SP70,FILTDOCT           * Clinician filter specified?
          GOTO      CURETS30 IF EQUAL
          GOTO      CURETS30 IF EOS
.        
          MATCH     EMVIDOCT,FILTDOCT       * match Treating Doctor
          GOTO      CURETS21 IF NOT EQUAL
.  
CURETS30  MOVE      SP70,AARRTIME
          CALL      GETWAT00                * Routine to get time diff
          MOVE      WAITTIME,AARRTIME
.
          MOVE      EMVIADMN,SAVEADMN
          MOVE      EMVIADMN,ADMISSNO
          CALL      CALSEQ00                * Next Patient Sequence Count
.
          MOVE      SP70,SFDSTIME
          CALL      GETSFD00
          MOVE      _SFDTIME,SFDSTIME
.
          MATCH     SP70,EMVIATNS           * Check for Attending Nurse
          IF        @EQUAL
.            MOVE     EMVITRNS,EMVIATNS     * Use Triage Nurse
          ENDIF
.          
          MATCH     SP8,EMVIPADM
          GOTO      CURETS40 IF EQUAL
.
          PACK      KEY8,EMVIPADM,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CURETS40
.
          MATCH     SP8,ACLSSFT
          GOTO      CURETS40 IF EQUAL
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
          GOTO      CURETS40
.
CURETS40  MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDISP
          MOVE      SP70,TDESC
.
          MOVE      "el",CATEGORY
          MOVE      EMVIUC20,CODE
          CALL      GETCOD00
          MOVE      TDESC,COMPDISP
          MOVE      SP70,TDESC 
.
          PACK      KEY8,EMVIURNO
          CALL      RDMAST1
          IF        OVRCD=0
            PACK      KEY8,EMVIURNO
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            REP       " 0",AGEDATE
            CALL      CALCAGE
            CALL      PATLN000
.
            GOTO      CURETS80 
          ELSE
            CALL      CLPATMAS
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,EMVIADMN
          CALL      RDEMUNK1
          IF        OVRCD=1
            MATCH     SP70,FILTSITE
            GOTO      CURETS11 IF EQUAL
.
            GOTO      CURETS21
          ENDIF
.
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNDET2,PGNAME
          PACK      PTITL,SP70
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,DISPAGE
.
          MATCH     SP70,EMUNBDAT
          IF        !@EQUAL
            MOVE      EMUNBDAT,PBDATE          * If birthday populated and the
            PACK      AGEDATE,CCC,CYY,CMM,CDD  * age is zero calculate age
            REP       " 0",AGEDATE
            CALL      CALCAGE
.
            PACK      DISPAGE,SP70
            CLEAR     DISPAGE
            APPEND    PSAGECON,DISPAGE
            APPEND    PSAGETYP,DISPAGE
            RESET     DISPAGE
          ENDIF
.
          MOVE      ONE,UNKFLAG
.
          PACK      KEY50,SP70
          STRIP     EMUNDET1
          STRIP     EMUNDET2
          PACK      KEY50,BOLDON,EMUNDET1,BOLDOFF,COMMA,SP1,EMUNDET2,SP70
          MOVE      KEY50,FORMATNM
.
CURETS80  MOVE      EMTSSITE,EMVISITE       * Use ETS Site Code
.
          CALL      OUTVIS00                * Output table row
.
          MATCH     SP70,FILTSITE
          GOTO      CURETS11 IF EQUAL
.
          GOTO      CURETS21
.
CURETS99  RETURN
+
.------------------------------------------------------------------
. Format the Expected Discharge details
.------------------------------------------------------------------
EDSC0000  PACK      EXPDDISC,SP70,SP70
          MOVE      SP70,DISPDDSC
          MOVE      SP70,DISPDTTM
.
          MATCH     SP70,EMVIUD01           * Blank Ready for Departure date?
          IF        !@EQUAL
            UNPACK    EMVIUD01,CCENT,CYEAR,CMON,CDAY
          ELSE
            MATCH     SP70,EMVIDDAT
            GOTO      EDSC2000 IF EQUAL
.
            UNPACK    EMVIDDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MOVE      "&nbsp",KEY5
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MATCH     SP70,EMVIUT01           * blank Ready for Departure time?
          IF        !@EQUAL
            PACK      DISPDTTM,CDAY,KEY5,MTHNAM3,KEY5,CCENT,CYEAR,KEY5,EMVIUT01
          ELSE
            PACK      DISPDTTM,CDAY,KEY5,MTHNAM3,KEY5,CCENT,CYEAR,KEY5,EMVIDTIM
          ENDIF
.
EDSC1000  MATCH     SP70,EMVIDSTA           * Blank departure status
          GOTO      EDSC2000 IF EQUAL
.
          PACK      KEY5,CATED,EMVIDSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EDSC2000
.
          MOVE     TDESC,DISPDDSC
          MATCH    "4",THCSCOD              * Transfer to another hospital
          IF       @EQUAL
            CLEAR    DISPDDSC
            APPEND   "Trans: ",DISPDDSC
            APPEND   DPTVADES,DISPDDSC
            RESET    DISPDDSC
          ENDIF
.
EDSC2000  STRIP     DISPDTTM
          STRIP     DISPDDSC
.
          CLEAR     EXPDDISC
          APPEND    DISPDTTM,EXPDDISC
          APPEND    "<br>",EXPDDISC
          APPEND    DISPDDSC,EXPDDISC
          RESET     EXPDDISC
.
EDSC9999  RETURN
.
.------------------------------------------------------------------
. Format the ward bed request details with colour
.------------------------------------------------------------------
BEDC0000  PACK      DISPDEBR,SP100,SP100,SP100,SP100,SP100
          MOVE      SP70,DISPBEDD
          MOVE      SP70,DISPRWRD
          MOVE      "black",BEDRFONT
.
          PACK      KEY24,DEMVIADM,SP70
          CALL      RSPMBRQ1
BEDC1000  CALL      RKPMBRQ1
          BRANCH    OVRCD,BEDC9999
.
          MATCH     DEMVIADM,PMBRVISN
          GOTO      BEDC9999 IF NOT EQUAL
.
          MATCH     "4",PMBRRSTA            * Cancelled, Read Another Request
          GOTO      BEDC1000 IF EQUAL
.
          MATCH     " ",PMBRRSTA            * No Status, Default to Requested
          GOTO      BEDC1100 IF EQUAL
.
          MATCH     "1",PMBRRSTA            * Requested
          GOTO      BEDC2000 IF NOT EQUAL
.
BEDC1100  MOVE      "&nbsp",KEY5
          UNPACK    PMBRREQD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPBEDD,CDAY,KEY5,MTHNAM3,KEY5,CCENT,CYEAR,KEY5,PMBRREQT
          MOVE      "red",BEDRFONT
          GOTO      BEDC8000
.
BEDC2000  MATCH     "2",PMBRRSTA            * Allocated
          GOTO      BEDC8000 IF NOT EQUAL
.
          MATCH     SP70,PMBRRDAT         * Bed not ready
          IF        @EQUAL
            MOVE      "&nbsp",KEY5
            UNPACK    PMBRADAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                 NOV,DEC
            PACK      DISPBEDD,CDAY,KEY5,MTHNAM3,KEY5,CCENT,CYEAR,KEY5:
                      PMBRATIM
            MOVE      "green",BEDRFONT
          ELSE
            MOVE      "&nbsp",KEY5
            UNPACK    PMBRRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                 NOV,DEC
            PACK      DISPBEDD,CDAY,KEY5,MTHNAM3,KEY5,CCENT,CYEAR,KEY5:
                      PMBRRTIM
            MOVE      "blue",BEDRFONT
          ENDIF
.
          MATCH     SP70,PMBREWRD           * No expected bed
          GOTO      BEDC8000 IF EQUAL
.
          MATCH     SP70,PMBREBED           * Any bed or just a ward
          IF        @EQUAL
            PACK      DISPRWRD,PMBREWRD,SP70
          ELSE
            PACK      DISPRWRD,PMBREWRD,SLASH,PMBREBED
          ENDIF
.
BEDC8000  MATCH     SP70,DISPBEDD           * No date
          GOTO      BEDC9999 IF EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,PMBRRHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            REP       "'`",DOCFNAME
          ENDIF
.
          CLEAR     TEMPVAR1
          APPEND    "<font color=",TEMPVAR1
          APPEND    BEDRFONT,TEMPVAR1
          APPEND    ">",TEMPVAR1
          APPEND    DISPBEDD,TEMPVAR1
          APPEND    "<br>",TEMPVAR1
          APPEND    DISPRWRD,TEMPVAR1
          APPEND    "</font>&nbsp;",TEMPVAR1
          RESET     TEMPVAR1
.
          CLEAR     TEMPVAR2
          APPEND    "<a title='Admitting Doctor' href='",TEMPVAR2
          APPEND    "javascript:DoctorViewFrame(\#"",TEMPVAR2
          APPEND    PMBRRHCP,TEMPVAR2
          APPEND    "\#");'>",TEMPVAR2
          APPEND    DOCFNAME,TEMPVAR2
          APPEND    "</a>",TEMPVAR2
          RESET     TEMPVAR2
.
          CLEAR     TEMPVAR3
          APPEND    "<br>",TEMPVAR3
          APPEND    "<input align=left type=button value='Alloc'",TEMPVAR3
          APPEND    " title='Update' onclick='Alloc(",TEMPVAR3
          APPEND    "\#"",TEMPVAR3
          APPEND    PMBRVISN,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    PMBRREQD,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    PMBRREQT,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    EMVIURNO,TEMPVAR3
          APPEND    "\#");'>",TEMPVAR3
          APPEND    "&nbsp;",TEMPVAR3
.
          APPEND    "<a align=right title='View Notes' href='",TEMPVAR3
          APPEND    "javascript:ViewNotes(",TEMPVAR3
          APPEND    "\#"",TEMPVAR3
          APPEND    PMBRVISN,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    PMBRREQD,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    PMBRREQT,TEMPVAR3
          APPEND    "\#",\#"",TEMPVAR3
          APPEND    EMVIURNO,TEMPVAR3
          APPEND    "\#");'>",TEMPVAR3
          APPEND    "<img border=0 align=absmiddle hspace=4 ",TEMPVAR3
          APPEND    " src='../images/CommentIcon1.gif'>",TEMPVAR3
          APPEND    "</img>",TEMPVAR3
          APPEND    "</a>",TEMPVAR3
          RESET     TEMPVAR3
.
          PACK      DISPDEBR,TEMPVAR1,TEMPVAR2,TEMPVAR3
.
BEDC9999  RETURN
.
.------------------------------------------------------------------
. Format the ward bed request details with colour and allocation.
. Find first bed request with a status of requested or allocated.
.------------------------------------------------------------------
BEDA0000  PACK      DISPBEDA,SP100,SP100,SP100,SP100,SP100,SP100
          MOVE      SP70,DISPBRQT           * Requested/Allocated time
          MOVE      SP70,DISPBRDT           * Bed ready time
          MOVE      SP70,DISPRWRD           * Ward/Bed
          MOVE      SP70,BEDRFONT           * Bed Request Font color
          MOVE      SP70,BEDRFNTR           * Bed Request Ready Green Font
.
          PACK      KEY24,DEMVIADM,SP70
          CALL      RSPMBRQ1
BEDA1000  CALL      RKPMBRQ1                * Read Bed Requests
          BRANCH    OVRCD,BEDA9999
.
          MATCH     DEMVIADM,PMBRVISN       * Correct visit number
          GOTO      BEDA9999 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA            * No Status, Default to Requested
          GOTO      BEDA2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA            * Requested
          GOTO      BEDA2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA            * Allocated
          GOTO      BEDA3000 IF EQUAL
.
          GOTO      BEDA1000
.
BEDA2000  MOVE      PMBRREQT,DISPBRQT       * Bed Requested Time
          MOVE      "Red",BEDRFONT          * Red Font
          GOTO      BEDA8000
.
BEDA3000  MOVE      PMBRATIM,DISPBRQT       * Bed Allocated Time
.
          MATCH     SP70,PMBREBED           * Any bed or just a ward
          IF        @EQUAL
            PACK      DISPRWRD,PMBREWRD,SP70
          ELSE
            PACK      DISPRWRD,PMBREWRD,SLASH,PMBREBED
          ENDIF
          MOVE      "Orange",BEDRFONT          * Orange Font
          MOVE      "Orange",BEDRFNTR          * Orange Font
.
          MATCH     SP70,PMBRRTIM               * Bed Ready Time
          IF        !@EQUAL
            MOVE      PMBRRTIM,DISPBRDT
            MOVE      "Green",BEDRFNTR          * Green Font
          ENDIF
.
BEDA8000  CLEAR     TEMPVAR1
          APPEND    "<p style='color:",TEMPVAR1
          APPEND    BEDRFONT,TEMPVAR1
          APPEND    ";margin:0'>",TEMPVAR1
          APPEND    DISPBRQT,TEMPVAR1
          APPEND    "</p>",TEMPVAR1
          RESET     TEMPVAR1
.
          CLEAR     TEMPVAR2
          APPEND    "<p style='color:",TEMPVAR2
          APPEND    BEDRFNTR,TEMPVAR2
          APPEND    ";margin:0'>",TEMPVAR2
          APPEND    DISPRWRD,TEMPVAR2
          APPEND    "</p>",TEMPVAR2
          RESET     TEMPVAR2
.
          CLEAR     TEMPVAR3
          APPEND    "<p style='color:",TEMPVAR3
          APPEND    BEDRFNTR,TEMPVAR3
          APPEND    ";margin:0'>",TEMPVAR3
          APPEND    DISPBRDT,TEMPVAR3
          APPEND    "</p>",TEMPVAR3
          RESET     TEMPVAR3
.
          PACK      DISPBEDA,TEMPVAR1,TEMPVAR2,TEMPVAR3
.
BEDA9999  RETURN
.------------------------------------------------------------------
. Format the ward bed request details with colour and allocation.
. Find first bed request with a status of requested or allocated.
.------------------------------------------------------------------
BEDREQ00  PACK      DISPBEDB,SP100,SP100,SP100,SP100,SP100,SP100
          MOVE      SP70,DISPBRQT           * Requested/Allocated time
          MOVE      SP70,DISPBRDT           * Bed ready time
          MOVE      SP70,DISPRWRD           * Ward/Bed
          MOVE      SP70,BEDRFONT           * Bed Request Font color
          MOVE      SP70,BEDRFNTR           * Bed Request Ready Green Font
.
          PACK      KEY24,DEMVIADM,SP70
          CALL      RSPMBRQ1
BEDREQ10  CALL      RKPMBRQ1                * Read Bed Requests
          BRANCH    OVRCD,BEDREQ99
.
          MATCH     DEMVIADM,PMBRVISN       * Correct visit number
          GOTO      BEDREQ99 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA            * No Status, Default to Requested
          GOTO      BEDREQ20 IF EQUAL
.
          MATCH     "1",PMBRRSTA            * Requested
          GOTO      BEDREQ20 IF EQUAL
.
          MATCH     "2",PMBRRSTA            * Allocated
          GOTO      BEDREQ30 IF EQUAL
.
          GOTO      BEDREQ10
.
BEDREQ20  MOVE      PMBRREQT,DISPBRQT       * Bed Requested Time
          MOVE      "Red",BEDRFONT          * Red Font
.
          CLEAR     TEMPVAR1
          APPEND    "<p style='color:",TEMPVAR1
          APPEND    BEDRFONT,TEMPVAR1
          APPEND    ";margin:0'>",TEMPVAR1
          APPEND    DISPBRQT,TEMPVAR1
          APPEND    "</p>",TEMPVAR1
          RESET     TEMPVAR1
.
          MOVE      TEMPVAR1,DISPBEDB
          GOTO      BEDREQ99
.
BEDREQ30  MOVE      PMBRATIM,DISPBRQT       * Bed Allocated Time
.
          PACK      DISPRWRD,PMBREWRD,SP70
          MOVE      "Green",BEDRFONT          * Orange Font
.
          MATCH     SP70,PMBRRTIM               * Bed Ready Time
          IF        !@EQUAL
            MOVE      PMBRRTIM,DISPBRDT
            MOVE      "Green",BEDRFNTR          * Green Font
          ENDIF
.
          CLEAR     TEMPVAR1
          APPEND    "<p style='color:",TEMPVAR1
          APPEND    BEDRFONT,TEMPVAR1
          APPEND    ";margin:0'>",TEMPVAR1
          APPEND    DISPRWRD,TEMPVAR1
          APPEND    "</p>",TEMPVAR1
          RESET     TEMPVAR1
.
          CLEAR     TEMPVAR2
          APPEND    "<p style='color:",TEMPVAR2
          APPEND    BEDRFNTR,TEMPVAR2
          APPEND    ";margin:0'>",TEMPVAR2
          APPEND    DISPBRDT,TEMPVAR2
          APPEND    "</p>",TEMPVAR2
          RESET     TEMPVAR2
.
          PACK      DISPBEDB,TEMPVAR1,TEMPVAR2
.
BEDREQ99  RETURN
.
.------------------------------------------------------------------
. Get speciality bed required details if bed request exists or  
. Disposition Delay decrription
.------------------------------------------------------------------
DSDELY00  MOVE      SP70,DISPDELY
          MOVE      SP70,DISPBRQT           * Requested/Allocated time
          MOVE      SP70,DISPBRDT           * Bed ready time
          MOVE      SP70,DISPRWRD           * Ward/Bed
          MOVE      SP70,BEDRFONT           * Bed Request Font color
          MOVE      SP70,BEDRFNTR           * Bed Request Ready Green Font
.
          PACK      KEY24,DEMVIADM,SP70
          CALL      RSPMBRQ1
DSDELY10  CALL      RKPMBRQ1                * Read Bed Requests
          BRANCH    OVRCD,DSDELY50
.
          MATCH     DEMVIADM,PMBRVISN       * Correct visit number
          GOTO      DSDELY50 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA            * No Status, Default to Requested
          GOTO      DSDELY20 IF EQUAL
.
          MATCH     "1",PMBRRSTA            * Requested
          GOTO      DSDELY20 IF EQUAL
.
          MATCH     "2",PMBRRSTA            * Allocated
          GOTO      DSDELY20 IF EQUAL
.
          GOTO      DSDELY10
.
. Bed request exists
.
DSDELY20  MATCH     SP70,PMBRSBED
          GOTO      DSDELY50 IF EQUAL
. 
          MOVE      "CG",KEY2
          PACK      KEY5,KEY2,PMBRSBED,SP70 
          CALL      RDCODE1           
          IF        OVRCD=1
            MOVE    PMBRSBED,TDESC
          ENDIF
          MOVE      TDESC,DISPDELY
          GOTO      DSDELY99 
.
.  Bed request does not exist
.
DSDELY50  MATCH     SP70,EMVIDISD
          GOTO      DSDELY99 IF EQUAL
. 
          MOVE      "dd",KEY2
          PACK      KEY5,KEY2,EMVIDISD,SP70 
          CALL      RDCODE1           
          IF        OVRCD=1
            MOVE    EMVIDISD,TDESC
          ENDIF
          MOVE      TDESC,DISPDELY
          GOTO      DSDELY99 
.
DSDELY99  RETURN
.
.------------------------------------------------------------------
. Getting Attending Nurse Name
.------------------------------------------------------------------
NURSAT00    MATCH     "1",EMCNURSE            * Use pmshcpaf for ED Nurse?
            GOTO      NURSAT10 IF EQUAL       * Yes
.
.           CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
            PACK      KEY6,EMVIATNS,SP70
            CALL      RDOPNUR1                * Reading the nurse file
            IF        OVRCD=1
              MOVE     SP70,OPNRCODE          * Clear all the file variables
              MOVE     SP70,OPNRSNAM
              MOVE     SP70,OPNRGNAM
              MOVE     SP70,OPNRUSR1
              MOVE     SP70,OPNRUSR2
              MOVE     SP70,OPNRUSR3
              MOVE     SP70,OPNRUSR4
              MOVE     SP70,OPNRUSR5
              MOVE     SP70,OPNRSTAT
              MOVE     SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    OPNRSNAM
              APPEND   OPNRSNAM,DOCFNAME
              MOVE     OPNRGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF 
            MOVE      DOCFNAME,RESPNURE
            GOTO      NURSAT99
.
.           CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
NURSAT10    PACK     KEY10,EMVIATNS,SP70
            CALL     RDPMHCP1
            IF       OVRCD=1
              CALL     CLPMSHCP
              MOVE     SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE     DOCFNAME,RESPNURE
            GOTO     NURSAT99
.             
NURSAT99    RETURN
.
.------------------------------------------------------------------
. Getting Triage Nurse Name
.----------------------------------------------------
NURTRG00    MATCH     "1",EMCNURSE            * Use pmshcpaf for ED Nurse?
            GOTO      NURTRG10 IF EQUAL       * Yes
.
.           CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
            PACK      KEY6,EMVITRNS,SP70
            CALL      RDOPNUR1                * Reading the nurse file
            IF        OVRCD=1
              MOVE     SP70,OPNRCODE          * Clear all the file variables
              MOVE     SP70,OPNRSNAM
              MOVE     SP70,OPNRGNAM
              MOVE     SP70,OPNRUSR1
              MOVE     SP70,OPNRUSR2
              MOVE     SP70,OPNRUSR3
              MOVE     SP70,OPNRUSR4
              MOVE     SP70,OPNRUSR5
              MOVE     SP70,OPNRSTAT
              MOVE     SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    OPNRSNAM
              APPEND   OPNRSNAM,DOCFNAME
              MOVE     OPNRGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE      DOCFNAME,DISPTRNS
            GOTO      NURTRG99
.
.           CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
NURTRG10    PACK      KEY10,EMVITRNS,SP70
            CALL      RDPMHCP1                * Reading the nurse file
            IF        OVRCD=1
              CALL     CLPMSHCP               * Clear all the file variables
              MOVE     SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE      DOCFNAME,DISPTRNS
            GOTO      NURTRG99
.
NURTRG99    RETURN
.
.------------------------------------------------------
.                 Getting Doctor Name
.------------------------------------------------------
DOCTAT00    PACK      KEY10,EMVIDOCT,SP70
            CALL      RDPMHCP1                * Reading the HCP file
            IF        OVRCD=1
              CALL      CLPMSHCP              * Clear all the file variables
              MOVE      SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF 
            MOVE      DOCFNAME,RESPNAME
DOCTAT99    RETURN
+
.------------------------------------------------------
.                 Getting User defined Doctor 4 Name
.------------------------------------------------------
DOCUDF00    PACK      KEY10,EMVIUR04,SP70
            CALL      RDPMHCP1                * Reading the HCP file
            IF        OVRCD=1
              CALL      CLPMSHCP              * Clear all the file variables
              MOVE      SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE      DOCFNAME,DISPUR04
DOCUDF99    RETURN
+
.------------------------------------------------------
. Get Mental Health Practitioner Name
.------------------------------------------------------
DOCMPA00    PACK      KEY10,EMVIMPRA,SP70
            CALL      RDPMHCP1                * Reading the HCP file
            IF        OVRCD=1
              CALL      CLPMSHCP              * Clear all the file variables
              MOVE      SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE      DOCFNAME,DISPMPRA
DOCMPA99    RETURN
+
.------------------------------------------------------------------------------
.                   FRMHCP00
.         Formats the HCP name in the format of 'A.Smith'
.         
.         Parameters:
.           RESPNAME - HCP Full Name (populated by call to DOCTAT00)
.           PMHCGNAM - HCP Given Names
.           PMHCSNAM - HCP Surname
.
.         Returns:
.           HCPSHNME - HCP short name
.------------------------------------------------------------------------------
FRMHCP00  PACK      HCPSHNME,SP70
          CLEAR     HCPSHNME
.
          MATCH     SP70,RESPNAME
          GOTO      FRMHCP90 IF EQUAL
.
          MATCH     SP70,PMHCGNAM
          GOTO      FRMHCP90 IF EQUAL
.
          PACK      DIM1,PMHCGNAM
          APPEND    DIM1,HCPSHNME
.
          MATCH     SP70,PMHCSNAM
          GOTO      FRMHCP90 IF EQUAL
.
          APPEND    DOT,HCPSHNME
          APPEND    PMHCSNAM,HCPSHNME
.
FRMHCP90  RESET     HCPSHNME
.
FRMHCP99  RETURN
+
.------------------------------------------------------------------------------
.                   FRMNUR00
.         Formats the Nurse name in the format of 'A.Smith'
.         
.         Parameters:
.           RESPNURE - Nurse Full Name (populated by call to NURSAT00)
.           OPNRGNAM - Nurse Given Name
.           OPNRSNAM - Nurse Surname
.
.         Returns:
.           NURSHNME - Nurse short name
.------------------------------------------------------------------------------
FRMNUR00  PACK      NURSHNME,SP70
          CLEAR     NURSHNME
.
          MATCH     SP70,RESPNURE
          GOTO      FRMNUR90 IF EQUAL
.
          MATCH     "1",EMCNURSE                   * Use pmshcpaf for ED Nurse?
          GOTO      FRMNUR10 IF EQUAL              * Yes
.
.         CONTROL.EMCNURSE=0 - Use oprnuraf for nurse
          MATCH     SP70,OPNRGNAM
          GOTO      FRMNUR90 IF EQUAL
.
          PACK      DIM1,OPNRGNAM
          APPEND    DIM1,NURSHNME
.
          MATCH     SP70,OPNRSNAM
          GOTO      FRMNUR90 IF EQUAL
.
          APPEND    DOT,NURSHNME
          APPEND    OPNRSNAM,NURSHNME
          GOTO      FRMNUR90
.
.         CONTROL.EMCNURSE=1 - Use pmshcpaf for nurse
FRMNUR10  MATCH     SP70,PMHCGNAM
          GOTO      FRMNUR90 IF EQUAL
.
          PACK      DIM1,PMHCGNAM
          APPEND    DIM1,NURSHNME
.
          MATCH     SP70,PMHCSNAM
          GOTO      FRMNUR90 IF EQUAL
.
          APPEND    DOT,NURSHNME
          APPEND    PMHCSNAM,NURSHNME
          GOTO      FRMNUR90
.
FRMNUR90  RESET     NURSHNME
.
FRMNUR99  RETURN
+
.
.------------------------------------------------------------
. Get the time in waiting for doctor
.EMVIDRDT  DIM       8      8        840   Date First Seen by Doct. (CCYYMMDD)
.EMVIDRTM  DIM       8      8        848   Time First Seen by Doct. (HH:MM:SS)
.------------------------------------------------------------
GETDWT00  MOVE      EMVIDATE,FIRSTDAT
          UNPACK    EMVITIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          CALL      SCLK0000                * Find stop the clock doctor
.
          MATCH     SP70,STOPDTIM
          IF        @EQUAL
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
            UNPACK    CTIMEIS,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTTIME
          ELSE
            UNPACK    STOPDTIM,LASTDATE,HOUR,D1,MIN
            PACK      LASTTIME,HOUR,MIN
            REP       " 0",LASTDATE
            REP       " 0",LASTTIME
          ENDIF
.
          CALL      TIMEDIFF
          IF        CALCTIME>9999
            MOVE      "9999",WAITTIME
          ELSE
            MOVE      CALCTIME,WAITTIME
          ENDIF
GETDWT99  RETURN
.
.------------------------------------------------------------
.  Site filter selection list
.------------------------------------------------------------
SELSIT00  PACK      KEY3,SP70
          CALL      RSEMSIT1
SELSIT30  CALL      RKEMSIT1
          BRANCH    OVRCD,SELSIT99
.
          MATCH     SP70,EMSTSCOD
          GOTO      SELSIT30 IF EQUAL
.
          PACK      KEY10,QUOTE,EMSTSCOD,QUOTE
          MATCH     FILTSITE,EMSTSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY10," selected>":
                               EMSTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY10,">",EMSTDESC,"</option>"
          ENDIF
          GOTO      SELSIT30
.
SELSIT99  RETURN
+
.------------------------------------------------------------
.  Site filter selection list (active only)
.------------------------------------------------------------
SELSAC00  PACK      KEY3,SP70
          CALL      RSEMSIT1
SELSAC30  CALL      RKEMSIT1
          BRANCH    OVRCD,SELSAC99
.
          MATCH     SP70,EMSTSCOD
          GOTO      SELSAC30 IF EQUAL
.
          MATCH     "1",EMSTACTV
          GOTO      SELSAC30 IF EQUAL            * active only
.
          PACK      KEY10,QUOTE,EMSTSCOD,QUOTE
          MATCH     FILTSITE,EMSTSCOD
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY10," selected>":
                               EMSTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY10,">",EMSTDESC,"</option>"
          ENDIF
          GOTO      SELSAC30
.
SELSAC99  RETURN
+
.------------------------------------------------------------
. Stop the clock using the selected first seen by doctor.
. Requires: The emr visit record read
.           Parameter EMCNSCLK to be read
.           " " or "0" = Treating Doctor
.           "1" = Treating Doctor & Initial Assessor
.           "2" = Treating Doctor & Other Doctor
.           "3" = Treating Doctor ,Initial Assessor & Other Doctor
.           The emr visit record read
. Return: STOPDTIM = stop date and time CCYYMMDDHH:MM:SS
.
. Note: at 28/05/2021.
. sjog uses EMVIUD10/EMVIUT10 for senior/other date/time but wahealth
. uses EMVIUD09/EMVIUT09 for senior/other date/time. If PTCNNSSI is not
. Blank indicates that it is sjog site.
.------------------------------------------------------------
SCLK0000  MOVE      SP70,STOPDTIM
          MOVE      SP70,TESTDTIM
.
          MATCH     SP70,PTCNNSSI        * no edward source sys/sjog
          IF        @EQUAL
            MOVE      EMVIUD09,TESTDATE  * wahealth uses EMVIUD09 uses
            MOVE      EMVIUT09,TESTTIME  * for senior/other doctor
          ELSE
            MATCH     ZERO20,PTCNNSSI      * no edward source sys/sjog
            IF        @EQUAL
              MOVE      EMVIUD09,TESTDATE  * wahealth uses EMVIUD09 uses
              MOVE      EMVIUT09,TESTTIME  * for senior/other doctor 
            ELSE
              MOVE      EMVIUD10,TESTDATE  * sjog uses EMVIUD10 uses
              MOVE      EMVIUT10,TESTTIME  * for senior/other doctor
            ENDIF
          ENDIF
.
.  Treating Doctor
.
          PACK      STOPDTIM,EMVIDRDT,EMVIDRTM,SP70   * Date and time
.
          MOVE      ZERO,F1
          MOVE      EMCNSCLK,F1
          BRANCH    F1,SCLK1000,SCLK2000,SCLK3000
.
          GOTO      SCLK9999
.
. Treating Doctor & Initial Assessor
.
SCLK1000  MATCH     SP70,EMVIMDDT           * Exit initial assessor date blank
          GOTO      SCLK9999 IF EQUAL
.
          MATCH     SP70,EMVIMDTM           * Exit initial assessor time blank
          GOTO      SCLK9999 IF EQUAL
.
          MATCH     SP70,STOPDTIM
          IF        !@EQUAL
            PACK      TESTDTIM,EMVIMDDT,EMVIMDTM,SP70   * Test Date and time
.
            MATCH     STOPDTIM,TESTDTIM
            GOTO      SCLK9999 IF NOT LESS
          ENDIF
.
          PACK      STOPDTIM,EMVIMDDT,EMVIMDTM,SP70   * Use assessor date/time 
          GOTO      SCLK9999
.
. Treating Doctor & Other Doctor
.
SCLK2000  MATCH     SP70,TESTDATE           * Exit other doctor date blank
          GOTO      SCLK9999 IF EQUAL
.
          MATCH     SP70,TESTTIME           * Exit other doctor time blank
          GOTO      SCLK9999 IF EQUAL
.
          MATCH     SP70,STOPDTIM
          IF        !@EQUAL
            PACK      TESTDTIM,TESTDATE,TESTTIME,SP70   * Test Date and time
.
            MATCH     STOPDTIM,TESTDTIM
            GOTO      SCLK9999 IF NOT LESS
          ENDIF
.
          PACK      STOPDTIM,TESTDATE,TESTTIME,SP70     * Use Other date/time
          GOTO      SCLK9999
.
. Treating Doctor, Initial Assessor & Other Doctor
.
SCLK3000  MATCH     SP70,EMVIMDDT           * Exit initial assessor date blank
          GOTO      SCLK3500 IF EQUAL
.
          MATCH     SP70,EMVIMDTM           * Exit initial assessor time blank
          GOTO      SCLK3500 IF EQUAL
.
          MATCH     SP70,STOPDTIM
          IF        !@EQUAL
            PACK      TESTDTIM,EMVIMDDT,EMVIMDTM,SP70   * Test Date and time
.
            MATCH     STOPDTIM,TESTDTIM
            GOTO      SCLK3500 IF NOT LESS
          ENDIF
.
          PACK      STOPDTIM,EMVIMDDT,EMVIMDTM,SP70    * Use assessor date/time
.
SCLK3500  MATCH     SP70,TESTDATE           * Exit other doctor date blank
          GOTO      SCLK9999 IF EQUAL
.
          MATCH     SP70,TESTTIME           * Exit other doctor time blank
          GOTO      SCLK9999 IF EQUAL

          MATCH     SP70,STOPDTIM
          IF        !@EQUAL
            PACK      TESTDTIM,TESTDATE,TESTTIME,SP70   * Test Date and time
.
            MATCH     STOPDTIM,TESTDTIM
            GOTO      SCLK9999 IF NOT LESS
          ENDIF
.
          PACK      STOPDTIM,TESTDATE,TESTTIME,SP70     * Use Other date/time 
.
SCLK9999  RETURN
.
.-----------------------------------------------------------------------
. Get the time in waiting between arrival date/time, discharge date/time
.-----------------------------------------------------------------------
GETLOS00  MOVE      EMVIDATE,FIRSTDAT
          UNPACK    EMVITIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MATCH     SP70,EMVIDDAT
          IF        !@EQUAL
            MOVE      EMVIDDAT,LASTDATE
            REP       " 0",LASTDATE
            UNPACK    EMVIDTIM,HOUR,D1,MIN
          ELSE
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
            UNPACK    CTIMEIS,HOUR,D1,MIN
          ENDIF
.
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
          IF        CALCTIME>9999
            MOVE      "9999",WAITTIME
          ELSE
            MOVE      CALCTIME,WAITTIME
          ENDIF
GETLOS99  RETURN
.
.------------------------------------------------------------
. Get admission ward/bed description
.------------------------------------------------------------
AWRD0000  MOVE      SP70,AWRDDESC
          MOVE      SP70,AWRBDESC
.
          PACK      KEY30,EMVIPADM,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,AWRD9999
.
          MATCH     DTADMN,EMVIPADM
          GOTO      AWRD9999 IF NOT EQUAL
.
          MATCH     SP70,TWARD              * No expected ward
          GOTO      AWRD9999 IF EQUAL
.
          PACK      AWRDDESC,TWARD,SP70
.
          CLEAR     AWRBDESC
          APPEND    TWARD,AWRBDESC
.
          MATCH     SP70,TBED
          IF        !@EQUAL
            APPEND    "/",AWRBDESC
            APPEND    TBED,AWRBDESC
          ENDIF
          RESET     AWRBDESC
.
          MOVE      ZERO,F1
          MOVE      PTCNWBDS,F1  * ward bed name option none,long,short
.
          COMPARE   ZERO,F1
          GOTO      AWRD9999 IF EQUAL
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,AWRD9999
.
          IF         F1 = 2
            MOVE       PTWDSDES,AWRDDESC
          ELSE
            MOVE       WBDESC,AWRDDESC
          ENDIF
.
          MOVE      AWRDDESC,AWRBDESC
.
          MATCH     SP70,TBED              * No expected bed
          GOTO      AWRD9999 IF EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,AWRD9999
.
          CLEAR     AWRBDESC
          APPEND    AWRDDESC,AWRBDESC
          APPEND    "/",AWRBDESC
.
          IF        F1 = 2
            APPEND     PTWDSDES,AWRBDESC
          ELSE
            APPEND     WBDESC,AWRBDESC
          ENDIF
.
AWRD9999  RETURN
.
.------------------------------------------------------
.                 Getting Senior Doctor Name
.------------------------------------------------------
DOCTSN00    MOVE      SP70,SENDNAME
            PACK      KEY10,EMVIUR04,SP70
            CALL      RDPMHCP1                * Reading the HCP file
            IF        OVRCD=1
              CALL      CLPMSHCP              * Clear all the file variables
              MOVE      SP70,DOCFNAME
            ELSE
              CLEAR    DOCFNAME
              STRIP    PMHCSNAM
              APPEND   PMHCSNAM,DOCFNAME
              MOVE     PMHCGNAM,DIM1
              APPEND   COMMA,DOCFNAME
              APPEND   SP1,DOCFNAME
              APPEND   DIM1,DOCFNAME
              RESET    DOCFNAME
            ENDIF
            MOVE      DOCFNAME,SENDNAME
DOCTSN99    RETURN
+
.------------------------------------------------------
.                 Get Management Notes
.------------------------------------------------------
MANNOT00  PACK      MANNOT01,SP70
          PACK      MANNOT02,SP70
          PACK      MANNOT03,SP70
          PACK      MANNOT04,SP70
          PACK      MANNOTDT,SP70
          PACK      MANUSRID,SP70
          MOVE      ZERO,MANNCNTR
.
          PACK      KEY14,EMVIADMN,ZERO,ZERO,TWO,SP70
          CALL      RSVSCMT1
MANNOT10  CALL      RKVSCMT1
          BRANCH    OVRCD,MANNOT90
.
          MATCH     DEMVIADM,VSCTVIST
          GOTO      MANNOT90 IF NOT EQUAL
.
          MATCH     "002",VSCTTYPE
          GOTO      MANNOT90 IF NOT EQUAL
.
          MATCH     SP100,VSCTDATA
          GOTO      MANNOT10 IF EQUAL
.
          ADD       ONE,MANNCNTR
.
          UNPACK    VSCTUKEY,CCENT,CYEAR,CMON,CDAY,CHOUR,CMIN,KEY2,MANUSRID
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY10,MANUSRID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,KEY20
          ELSE
            PACK      KEY20,WBSENAM,SP70
          ENDIF
.
          PACK      MANNOTDT,DISPDATE,SP1,CHOUR,COLON,CMIN,COLON,KEY2,SP1,KEY20
.
          IF        MANNCNTR=ONE
            UNPACK    VSCTDATA,KEY60        * Append 1 space to allow \
            PACK      MANNOT01,KEY60,SP1    * as the last character
          ENDIF
.
          IF        MANNCNTR=TWO
            UNPACK    VSCTDATA,KEY60
            PACK      MANNOT02,KEY60,SP1
          ENDIF
.
          IF        MANNCNTR=THREE
            UNPACK    VSCTDATA,KEY60
            PACK      MANNOT03,KEY60,SP1
          ENDIF
.
          IF        MANNCNTR=FOUR
            UNPACK    VSCTDATA,KEY60
            PACK      MANNOT04,KEY60,SP1
          ENDIF
.
          COMPARE   MANNCNTR,FIVE
          GOTO      MANNOT90 IF EQUAL
.
          GOTO      MANNOT10
.
MANNOT90  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
.
MANNOT99  RETURN
.------------------------------------------------------------
. Table of Expected Patients, Contacts, Advice
.------------------------------------------------------------
EXPTC000  MOVE      WBSEESC,SAVESITE       * Save ED site
.
          IF        DEFTVIEW = 0
            PACK      KEY21,SAVESITE,FRSTDATE,SP70
          ELSE
            PACK      KEY21,SAVESITE,SP70
          ENDIF
.
          CALL      RSEMEXP4
EXPTC100  CALL      RKEMEXP4
          BRANCH    OVRCD,EXPTC999
.
          MATCH     SAVESITE,EMEXSITE
          GOTO      EXPTC999 IF NOT EQUAL
.
          IF        DEFTVIEW = 0
            MATCH     EMEXEDAT,LASTDATE
            GOTO      EXPTC999 IF LESS
            MATCH     SP70,REMOFILT
            IF        @EQUAL | @EOS
              MATCH     "0",EMEXDELT
              GOTO      EXPTC100 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,CONTFILT
          IF        !@EQUAL & !@EOS
            MATCH     CONTFILT,EMEXCONT
            GOTO      EXPTC100 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,EMEXURNO,SP70     * Read Patient Master details
          CALL      RDMAST1
          COMPARE   "1",OVRCD
          IF        @EQUAL
            PACK      KEY50,SP70
            STRIP     EMEXGNAM
            STRIP     EMEXSNAM
            PACK      KEY50,BOLDON,EMEXSNAM,BOLDOFF,COMMA,SP1,EMEXGNAM,SP70
            MOVE      KEY50,FORMATNM
            GOTO      EXPTC200
          ENDIF
.
          CALL      CALCAGE
          CALL      PATLN000               * Formate Patients Name

EXPTC200  MOVE      "EA",CATEGORY
          MOVE      EMEXTRAN,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY30
.
          MOVE      SP70,DISPATSR
          MOVE      SP70,TIND3
          MATCH     SP70,EMEXATSR
          IF        !@EQUAL
            MOVE      "em",CATEGORY
            MOVE      EMEXATSR,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPATSR
            MOVE      TCINDC3,TIND3
          ENDIF
.
          MOVE      SP70,TSRCDESC
          MATCH     "1",TIND3
          IF        @EQUAL
            MATCH     SP70,EMEXTSRC
            IF        !@EQUAL
              PACK      KEY5,EMEXTSRC,SP70
              CALL      RDPTVAD1               * read PATVADFD record
              IF        OVRCD = 0
                MOVE      PTVADESC,TSRCDESC
              ENDIF
            ENDIF 
          ENDIF
.
          MOVE      SP70,DISPACPS
          MATCH     SP70,EMEXACPS
          IF        !@EQUAL
            MOVE      "ZQ",CATEGORY
            MOVE      EMEXACPS,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPACPS
          ENDIF
.
          MOVE      SP70,DISPACPT
          MATCH     SP70,EMEXACPT
          IF        !@EQUAL
            MOVE      "ZR",CATEGORY
            MOVE      EMEXACPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DISPACPT
          ENDIF
.
          MOVE      ZERO,DISPTRIG
          MATCH     SP70,EMEXTRIG
          IF        !@EQUAL
            MOVE      "AA",CATEGORY
            MOVE      EMEXTRIG,CODE
            CALL      GETCOD00
            MATCH     SP70,TCINDC1
            IF        @EQUAL
              MOVE      ZERO,DISPTRIG
            ELSE
              MOVE      TCINDC1,DISPTRIG
            ENDIF
          ENDIF
.
          MOVE      SP70,PRESCOMP
          MOVE      "el",CATEGORY
          MOVE      EMEXCOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRESCOMP
.
          PACK      KEY10,EMEXGPCD,SP70     * Get Doctors full name
          CALL      RDPMHCP1
          IF        OVRCD=1
            CALL      CLPMSHCP              * Clear all the file variables
            MOVE     SP70,DOCFNAME
          ELSE
            MOVE     PMHCTITL,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          PACK      KEY10,EMEXCUID       * Gets web user name
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,KEY20
          ENDIF
          PACK      KEY20,WBSENAM,SP70
.
          PACK      KEY10,EMEXUUID       * Gets web user name Last updated
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.
          MOVE      SP70,CONTTYPE
.
          MATCH     "1",EMEXCONT
          IF        @EQUAL
            MOVE      "Expected  ",CONTTYPE
          ENDIF
.
          MATCH     "2",EMEXCONT
          IF        @EQUAL
            MOVE      "Advice    ",CONTTYPE
          ENDIF
.
          MATCH     "3",EMEXCONT
          IF        @EQUAL
            MOVE      "Contact   ",CONTTYPE
          ENDIF
.
          MOVE      SP70,REMOREAS
          MOVE      "rR",CATEGORY
          MOVE      EMEXREMV,CODE
          CALL      GETCOD00
          MOVE      TDESC,REMOREAS
.
          REP       "#"'",EMEXCOM1
          REP       "#"'",EMEXCOM2
          REP       "#"'",EMEXCOM3
          REP       "#"'",EMEXCOM4
          REP       "#"'",EMEXCOM5
          REP       "#"'",EMEXCOM6
.
          MOVE      ZERO,ETSLOCFL         * clear ETS Location flag
          PACK      KEY3,EMEXEXPL,SP70
          CALL      RDEMLOC1
          IF        OVRCD=0
            MATCH     "E",EMLOTYPE            * Telehealth Location?
            IF        @EQUAL
              MOVE      ONE,ETSLOCFL          * set ETS Location flag
            ENDIF
          ENDIF
.
          MATCH     SP70,EMEXTRAN
          IF        !@EQUAL
            MOVE      "EA",CATEGORY
            MOVE      EMEXTRAN,CODE
            CALL      GETCOD00
            MOVE      TDESC,TRANDESC
          ENDIF
.
          PACK      KEY10,EMEXCUID       * Gets web user name who created
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
          MOVE      WBSENAM,CUIDNAME
.
          CLEAR     HTMLLNK1
          APPEND    "javascript:setTriage('",HTMLLNK1
          APPEND    EMEXUNIQ,HTMLLNK1
          APPEND    "','",HTMLLNK1
          APPEND    ETSLOCFL,HTMLLNK1
          APPEND    "')",HTMLLNK1
          RESET     HTMLLNK1
.
          CLEAR     HTMLLINK
          APPEND    "javascript:SelectPatient('",HTMLLINK
          APPEND    EMEXUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMEXDELT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ETSLOCFL,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",EMEXURNO,"#",";               * 1
.
EXPTC700  CALL      ALERTA00
          MATCH     SP70,ALRTIMGT
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",FORMATNM,"#",";             * 2
          ELSE
            WRITE     HTMLFILE;"#"",FORMATNM,ALRTIMGT,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",EMEXCOMP,"#",":
                             "#"",PRESCOMP,"#",":
                             "#"",EMEXCOM1,"#",":               * 5
                             "#"",EMEXCOM2,"#",":
                             "#"",EMEXCOM3,"#",":
                             "#"",EMEXCOM4,"#",":
                             "#"",EMEXCOM5,"#",":
                             "#"",EMEXCOM6,"#",":               * 10
                             "#"",KEY30,"#",":
                             "#"",EMEXEDAT,"#",":
                             "#"",EMEXETIM,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",KEY20,"#",":                  * 15
                             "#"",EMEXCDAT,"#",":
                             "#"",EMEXCTIM,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",EMEXUDAT,"#",":
                             "#"",EMEXUTIM,"#",":               * 20
                             "#"",EMEXUNIQ,"#",":
                             "#"",EMEXATSR,"#",":
                             "#"",EMEXACPS,"#",":
                             "#"",EMEXACPT,"#",":
                             "#"",EMEXETAD,"#",":               * 25
                             "#"",EMEXETAT,"#",":
                             "#"",DISPATSR,"#",":
                             "#"",DISPACPS,"#",":
                             "#"",DISPACPT,"#",":
                             "#"",EMEXAMBL,"#",":               * 30
                             "#"",EMEXEXPL,"#",":
                             "#"",DISPTRIG,"#",":
                             "#"",EMEXETAD,EMEXETAT,"#",":
                             "#"",EMEXEDAT,EMEXETIM,"#",":
                             "#"",CONTTYPE,"#",":              * 35 
                             "#"",REMOREAS,"#",":
                             "#"",EMEXCOM1,"<br>":
                                  EMEXCOM2,"<br>":
                                  EMEXCOM3,"<br>":
                                  EMEXCOM4,"<br>":
                                  EMEXCOM5,"<br>":
                                  EMEXCOM6,"#",":
                             "#"",HTMLLNK1,"#",":
                             "#"",TRANDESC,"#",":
                             "#"",TSRCDESC,"#",":              * 40
                             "#"",CUIDNAME,"#",":
                             "#"",EMEXCONT,"#");"
.
          GOTO      EXPTC100
.
EXPTC999  RETURN
.
.-----------------------------------------------------------------------------
. Add alert icons
.-----------------------------------------------------------------------------
ALERTA00    PACK      ALRTIMG1,SP70,SP70,SP70,SP70
            PACK      ALRTIMG2,SP70,SP70,SP70,SP70
            PACK      ALRTIMG3,SP70,SP70,SP70,SP70
            PACK      ALRTIMG4,SP70,SP70,SP70,SP70
            PACK      ALRTIMGE,SP70,SP70,SP70,SP70
            PACK      ALRTDISA,SP70,SP70,SP70,SP70
            PACK      ALRTIMGT,SP100,SP100,SP100,SP100:
                               SP100,SP100,SP100,SP100:
                               SP100,SP100,SP100,SP100:
                               SP100
.
            CLEAR     ALRTIMGT
            CLEAR     ALRTDISA
.
            MOVE      ZERO,EXIT
            MATCH     SP70,EMEXURNO
            GOTO      ALERTA99 IF EQUAL
.
            PROC      DISPALRT
.
            IF        EXIT=0
              GOTO      ALERTA20
            ENDIF
.
            IF        EXIT=2
              GOTO      ALERTA20
            ENDIF
.
            GOTO      ALERTA99
.
ALERTA20    PACK      KEY8,EMEXURNO,SP70
            CALL      RDPMPX21 
.
            REPLACE   " +",EMEXURNO
.
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              CLEAR     ALRTIMG1
              APPEND    "<img ",ALRTIMG1
              APPEND    " alt='Medical Alerts'",ALRTIMG1
              APPEND    " onclick=",ALRTIMG1
              APPEND    "PatientAlerts('",ALRTIMG1
              APPEND    EMEXURNO,ALRTIMG1
              APPEND    "');",ALRTIMG1
              APPEND    " src='../images/AlertIconM.gif'",ALRTIMG1
              APPEND    " class=Icon>",ALRTIMG1
              RESET     ALRTIMG1
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              CLEAR     ALRTIMG2
              APPEND    "<img ",ALRTIMG2
              APPEND    " alt='MMicro Alerts'",ALRTIMG2
              APPEND    " onclick=",ALRTIMG2
              APPEND    "PatientAlerts('",ALRTIMG2
              APPEND    EMEXURNO,ALRTIMG2
              APPEND    "');",ALRTIMG2
              APPEND    " src='../images/AlertIconB.gif'",ALRTIMG2
              APPEND    " class=Icon>",ALRTIMG2
              RESET     ALRTIMG2
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              CLEAR     ALRTIMG3
              APPEND    "<img ",ALRTIMG3
              APPEND    " alt='Risk Alerts'",ALRTIMG3
              APPEND    " onclick=",ALRTIMG3
              APPEND    "PatientAlerts('",ALRTIMG3
              APPEND    EMEXURNO,ALRTIMG3
              APPEND    "');",ALRTIMG3
              APPEND    " src='../images/AlertIconR.gif'",ALRTIMG3
              APPEND    " class=Icon>",ALRTIMG3
              RESET     ALRTIMG3
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              CLEAR     ALRTIMG4
              APPEND    "<img ",ALRTIMG4
              APPEND    " alt='Chronic Alerts'",ALRTIMG4
              APPEND    " onclick=",ALRTIMG4
              APPEND    "PatientAlerts('",ALRTIMG4
              APPEND    EMEXURNO,ALRTIMG4
              APPEND    "');",ALRTIMG4
              APPEND    " src='../images/AlertIconC.gif'",ALRTIMG4
              APPEND    " class=Icon>",ALRTIMG4
              RESET     ALRTIMG4
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img ",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " onclick=",ALRTIMGE
              APPEND    "PatientAlerts('",ALRTIMGE
              APPEND    EMEXURNO,ALRTIMGE
              APPEND    "');",ALRTIMGE
              APPEND    " src='../images/AlertIcon.gif'",ALRTIMGE
              APPEND    " class=Icon>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      ALERTA50
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img ",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " onclick=",ALRTIMGE
              APPEND    "PatientAlerts('",ALRTIMGE
              APPEND    EMEXURNO,ALRTIMGE
              APPEND    "');",ALRTIMGE
              APPEND    " src='../images/AlertIconBlack.gif'",ALRTIMGE
              APPEND    " class=Icon>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      ALERTA50
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img ",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " onclick=",ALRTIMGE
              APPEND    "PatientAlerts('",ALRTIMGE
              APPEND    EMEXURNO,ALRTIMGE
              APPEND    "');",ALRTIMGE
              APPEND    " src='../images/AlertIconDelete.gif'",ALRTIMGE
              APPEND    " class=Icon>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      ALERTA50
            ENDIF
.
            MATCH     "0",PTMXSIN1
            GOTO      ALERTA50 IF EQUAL
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img ",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " onclick=",ALRTIMGE
              APPEND    "PatientAlerts('",ALRTIMGE
              APPEND    EMEXURNO,ALRTIMGE
              APPEND    "');",ALRTIMGE
              APPEND    " src='../images/AlertIcon",ALRTIMGE
              APPEND    PTMXSIN1,ALRTIMGE
              APPEND    ".gif'",ALRTIMGE
              APPEND    " class=Icon>",ALRTIMGE
              RESET     ALRTIMGE
            ENDIF
.
ALERTA50    IF        EXIT=2
ALERTA51      CLEAR     ALRTDISA
              APPEND    "<img ",ALRTDISA
              APPEND    " alt='Disability Alerts'",ALRTDISA
              APPEND    " onclick=",ALRTDISA
              APPEND    "PatientAlerts('",ALRTDISA
              APPEND    EMEXURNO,ALRTDISA
              APPEND    "');",ALRTDISA
              APPEND    " src='../images/AlertIconDIS.gif'",ALRTDISA
              APPEND    " class=Icon>",ALRTDISA
              RESET     ALRTDISA
            ENDIF
.
            STRIP     ALRTIMG1
            STRIP     ALRTIMG2
            STRIP     ALRTIMG3
            STRIP     ALRTIMG4
            STRIP     ALRTIMGE
            STRIP     ALRTDISA
            PACK      ALRTIMGT,ALRTIMG1,ALRTIMG2,ALRTIMG3,ALRTIMG4,ALRTIMGE:
                               ALRTDISA
.
            REPLACE   "+ ",EMEXURNO
.
.
ALERTA99    RETURN
.
.------------------------------------------------------------
. Current Location Medical Record
.------------------------------------------------------------
CURLOC00  MOVE      SP70,CURLOCDS
.
          MATCH     SP70,WBSEHOSP 
          GOTO      CURLOC99 IF EQUAL
          GOTO      CURLOC99 IF EOS
.
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CURLOC99
.
          MATCH     SP70,PTHSRCTY
          GOTO      CURLOC99 IF EQUAL
          GOTO      CURLOC99 IF EOS    
.
          PACK      KEY20,EMVIURNO,Z70
          CALL      RSMRMAS1
CURLOC10  CALL      RPMRMAS1
          BRANCH    OVRCD,CURLOC99
.
          MATCH     MRMAURNO,EMVIURNO
          GOTO      CURLOC99 IF NOT EQUAL
.
          MATCH     MRMADOTY,PTHSRCTY
          GOTO      CURLOC10 IF NOT EQUAL
.
          CLEAR     CURLOCDS
          APPEND    "(",CURLOCDS
          APPEND    MRMACHOS,CURLOCDS
          APPEND    ")",CURLOCDS
.
          MATCH     SP70,MRMACLOC
          IF        @EQUAL | @EOS
            GOTO      CURLOC90      
          ELSE
            PACK      KEY7,MRMACHOS,MRMACLOC,SP70
            CALL      RDMRLOC1
            IF        OVRCD=1
              APPEND    MRMACLOC,CURLOCDS
            ELSE
              APPEND    MRLODESC,CURLOCDS
            ENDIF
          ENDIF
.
CURLOC90  RESET     CURLOCDS          
.
CURLOC99  RETURN
+
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.
.------------------------------------------------------------
. Get a discharged ED visits linked current inpatient bed 
. request if they are still displayed on the Map
.------------------------------------------------------------
IPBEDR00  MOVE      SP70,IPBEDREQ            * Clear bed request
.
          MATCH     SP70,EMVILOCN            * No ED location 
          GOTO      IPBEDR99 IF EQUAL
.
          MATCH     SP70,EMVIPADM            * Linked IP visit
          GOTO      IPBEDR99 IF EQUAL
.
          IF        EMVISTAT <> 2 & EMVISTAT <> 3
            GOTO     IPBEDR99               * Discharged ED visits only
          ENDIF
.
          PACK      KEY8,EMVIPADM,SP70
          CALL      RDMISS1                 * Read linked IP visit
          BRANCH    OVRCD,IPBEDR99
.
          COMPARE   TWO,ASTAT               * Current IP only
          GOTO      IPBEDR99 IF NOT EQUAL
.
          PACK      KEY24,EMVIPADM,SP70
          CALL      RSPMBRQ1
IPBEDR10  CALL      RKPMBRQ1                * Read Ip visit bed requests
          BRANCH    OVRCD,IPBEDR90
.
          MATCH     EMVIPADM,PMBRVISN       * Correct visit number
          GOTO      IPBEDR90 IF NOT EQUAL
.
          MATCH     "4",PMBRRSTA            * Skip cancelled
          GOTO      IPBEDR10 IF EQUAL
.
          MATCH     " ",PMBRRSTA            * Requested
          GOTO      IPBEDR20 IF EQUAL
.
          MATCH     "1",PMBRRSTA            * Requested
          GOTO      IPBEDR20 IF EQUAL
.
          MATCH     "2",PMBRRSTA            * Allocated
          IF        @EQUAL
            CLEAR     IPBEDREQ  
            APPEND    "G",IPBEDREQ             * Bed request allocated so 
            APPEND    "Inpatient ",IPBEDREQ    * display green bold word
            APPEND    PMBREWRD,IPBEDREQ        * Inpatient ward/bed
.
            MATCH     SP70,PMBREBED           
            IF        !@EQUAL
              APPEND    SLASH,IPBEDREQ
              APPEND    PMBREBED,IPBEDREQ
            ENDIF
            RESET     IPBEDREQ
          ENDIF
.
          GOTO      IPBEDR99
.
IPBEDR20  MOVE      "RInpatient REQ",IPBEDREQ   * Bed requested so display
          GOTO      IPBEDR99                    * red bold word Inpatient REQ
.
IPBEDR90  MOVE      "BInpatient",IPBEDREQ       * No bed request so display
          GOTO      IPBEDR99                    * black bold word Inpatient
.
IPBEDR99  RETURN
.
.------------------------------------------------------------
. Get todays nutrition details for an ED visit                
.------------------------------------------------------------
GETNUT00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:UpdateNutrition('",HTMLLNK2
          APPEND    EMVIURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    EMVIADMN,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          CALL      IALR0000               * Clear alert allergy array
          CALL      LALD0000               * Load Alert allerys descriptions
.
          PACK      KEY16,EMVIADMN,CURRDATE,SP70
          CALL      RDPMNUT1
          IF        OVRCD=1
            CALL      CLPMSNUT
          ENDIF
.
          MATCH     "1",PMNUFAST            * Fasting
          IF        @EQUAL
            MOVE      "Yes",DISPFAST
          ELSE
            MOVE      SP70,DISPFAST
          ENDIF
.
          MOVE      "MJ",CATEGORY           * Diet type 1
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPDTYP       
.
          MOVE      "MJ",CATEGORY           * Diet type 2
          MOVE      PMNUML01,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPML01       
.
          MOVE      "MJ",CATEGORY           * Diet type 3
          MOVE      PMNUML03,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPML03       
.
          MOVE      "MJ",CATEGORY           * Diet type 4
          MOVE      PMNUML05,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPML05       
.
          MOVE      "MJ",CATEGORY           * Diet type 5
          MOVE      PMNUML07,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPML07       
.
          MOVE      "MK",CATEGORY           * Menu/Assistance
          MOVE      PMNUALVL,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPALVL
.
          MOVE      "MK",CATEGORY           * Menu/Assistance 1
          MOVE      PMNUUDF1,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUDF1
.
          MOVE      "MK",CATEGORY           * Menu/Assistance 2
          MOVE      PMNUUDF2,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUDF2
.
          MOVE      "MK",CATEGORY           * Menu/Assistance 3
          MOVE      PMNUUDF3,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUDF3
.
          MOVE      "MK",CATEGORY           * Menu/Assistance 4
          MOVE      PMNUUDF4,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUDF4
.
          STRIP     DISPALVL
          STRIP     DISPUDF1
          STRIP     DISPUDF2
          STRIP     DISPUDF3
          STRIP     DISPUDF4
          PACK      DISPMENU,SP70,SP70
          CLEAR     DISPMENU
.
          MATCH     SP70,DISPALVL
          IF        !@EQUAL & !@EOS
            APPEND    DISPALVL,DISPMENU
          ENDIF
.
          MATCH     SP70,DISPUDF1
          IF        !@EQUAL & !@EOS
            APPEND    BREAKLIN,DISPMENU
            APPEND    DISPUDF1,DISPMENU
          ENDIF
.
          MATCH     SP70,DISPUDF2
          IF        !@EQUAL & !@EOS
            APPEND    BREAKLIN,DISPMENU
            APPEND    DISPUDF2,DISPMENU
          ENDIF
.
          MATCH     SP70,DISPUDF3
          IF        !@EQUAL & !@EOS
            APPEND    BREAKLIN,DISPMENU
            APPEND    DISPUDF3,DISPMENU
          ENDIF
.
          MATCH     SP70,DISPUDF4
          IF        !@EQUAL & !@EOS
            APPEND    BREAKLIN,DISPMENU
            APPEND    DISPUDF4,DISPMENU
          ENDIF
.
          RESET     DISPMENU
.
. Check if diet has been updated by a user within the last 12 hours
. and set highlight class. Not by the overnight diet update
.
          MOVE      SP70,DIETCLAS           * Clear field class highlight
.
          MATCH     SP70,PMNUUPDD           * Exit if no last update date
          GOTO      GETNUT99 IF EQUAL
.
          UNPACK    PMNUUPDD,FIRSTDAT,D8    * Last update date/time
.
          MATCH     PTCNTIMN,D8             * Update by overnight nutition
          GOTO      GETNUT99 IF EQUAL       * update
.
          UNPACK    D8,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MOVE      CURRDATE,LASTDATE       * Current date /time
          UNPACK    CURRTIME,HOUR,D1,MIN
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
          CALL      TIMEDIFF
.
          IF        CALCTIME <= 720
            MOVE      "NutritionUpd",DIETCLAS    * Update field class highlight
          ENDIF
.
GETNUT99  RETURN
.
.*******************************************************************************
. Clear food allergy description array
.*******************************************************************************
IALR0000  MOVE      ZERO,FORM2
          WHILE     FORM2 < 99
            ADD       ONE,FORM2
            MOVE      SP70,ALRTCODE[FORM2]
          DO
IALR9999  RETURN
.
.------------------------------------------------------------
. Load food allergy description array
.------------------------------------------------------------
LALD0000  CALL      IALR0000                * Initialise variables
          MOVE      ZERO,FORM2
.
          MATCH     ZEROUR,EMVIURNO
          IF        @EQUAL
            PACK      KEY16,EMVIADMN,SP70
            CALL      RSPTALT1
          ELSE
            PACK      KEY16,EMVIURNO,SP70
            CALL      RSPTALR1
          ENDIF
.
LALD1000  MATCH     ZEROUR,EMVIURNO
          IF        @EQUAL
            CALL      RKPTALT1                * Check for any food allergies
            BRANCH    OVRCD,LALD9999
.
            MATCH     DEMVIADM,PTALURNO
            GOTO      LALD9999 IF NOT EQUAL
          ELSE
            CALL      RKPTALR1                * Check for any food allergies
            BRANCH    OVRCD,LALD9999
.
            MATCH     EMVIURNO,PTALURNO
            GOTO      LALD9999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PTALCODE
          GOTO      LALD1000 IF EQUAL
.
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LALD1000
.
          MATCH     "F",TCINDC20            * Food Allergy alert
          GOTO      LALD1000 IF NOT EQUAL
.
          COMPARE   "99",FORM2
          GOTO      LALD9999 IF NOT LESS
.
          ADD       ONE,FORM2
          MOVE      TDESC,ALRTCODE[FORM2]
          GOTO      LALD1000
.
LALD9999  RETURN
.
.------------------------------------------------------------
. Display food allergy description array
.------------------------------------------------------------
DALD0000  MOVE      ZERO,FORM2
.
DALD1000  COMPARE   "99",FORM2
          GOTO      DALD9999 IF NOT LESS
.
          ADD       ONE,FORM2
.
          MATCH     SP70,ALRTCODE[FORM2]
          GOTO      DALD9999 IF EQUAL
.
          WRITE     HTMLFILE;"<br>",ALRTCODE[FORM2],NBSP;
          GOTO      DALD1000
.
DALD9999  RETURN
.
.---------------------------------------------------------------------
.         Output Patient Alert icons
.---------------------------------------------------------------------
ALERTI00  MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
.
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " alt='Medical Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " alt='Micro Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 " alt='Risk Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 " alt='Chronic Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
              GOTO      ALERTI90
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
            ENDIF
          ENDIF
.
ALERTI90  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " alt='Disability Alerts'":
                                 " class=ListIcon onclick=\#"PatientAlerts('":
                                 EMVIURNO,"','",EMVIADMN,"');\#">";
          ENDIF
.
ALERTI99  RETURN
.
.---------------------------------------------------------------------
. Check if U/R was a previous IP/OP within the last XXX hours
.---------------------------------------------------------------------
IPOP0000  MOVE      ZERO,LASTIPOP        * IP/OP within the last XXX hours
.
          MATCH     ZEROUR,EMVIURNO      * Exit zero U/R
          GOTO      IPOP9999 IF EQUAL
.
          MATCH     "1",EMCNPTTI         * Any Patient Recent Visit IP/OP
          GOTO      IPOP0010 IF EQUAL
.
          MATCH     "2",EMCNPTTI         * Only IP Visits prior to Emerg Visit
          GOTO      IPOP0010 IF EQUAL
          GOTO      IPOP9999
.
IPOP0010  MOVE      ZERO,F3              * Check if IP/OP within X hour is set
          MOVE      ZERO,F6
          SQUEEZE   EMCNTINU
          MOVE      EMCNTINU,F3
          ASSIGN    (F3 * SIXTY),F6      * Convert minutes to hours
.
          COMPARE   ZERO,F6              * Exit no hours set
          GOTO      IPOP9999 IF EQUAL
.
. Current IP
.
          PACK      KEY17,EMVIURNO,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                     * Check for current IP
          BRANCH    OVRCD,IPOP1000
.
          MATCH     EMVIURNO,AURNO               * Same U/R
          GOTO      IPOP1000 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT                    * Current IP
          IF        @EQUAL
            MATCH     "2",EMCNPTTI         * Only IP Visits prior to Emerg Visit
            IF        @EQUAL
              PACK      DIM16,EMVIDATE,EMVITIME,SP70
              REP       ":0",DIM16
              PACK      DIM16A,ADATE,ATIME,SP70
              REP       ":0",DIM16A
.
              MATCH     DIM16,DIM16A             * Skip if admittion date/time
              GOTO      IPOP1000 IF NOT LESS     * >= Ed arrival date/time
            ENDIF
            GOTO      IPOP9000
          ENDIF
.
. IP on Leave
.
IPOP1000  PACK      KEY17,EMVIURNO,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                     * Check for current leave
          BRANCH    OVRCD,IPOP2000
.
          MATCH     EMVIURNO,AURNO               * Same U/R
          GOTO      IPOP2000 IF NOT EQUAL
.
          COMPARE   FOUR,ASTAT                   * On leave
          IF        @EQUAL
            MATCH     "2",EMCNPTTI         * Only IP Visits prior to Emerg Visit
            IF        @EQUAL
              PACK      DIM16,EMVIDATE,EMVITIME,SP70
              REP       ":0",DIM16
              PACK      DIM16A,ADATE,ATIME,SP70
              REP       ":0",DIM16A
.
              MATCH     DIM16,DIM16A             * Skip if admittion date/time
              GOTO      IPOP2000 IF NOT LESS     * >= Ed arrival date/time
            ENDIF
            GOTO      IPOP9000
          ENDIF
.
. Discharge IP
.
IPOP2000  PACK      KEY24,EMVIURNO,CURRDATE,Z70
          CALL      RDSDSCH3
          CALL      RDPDSCH3
          BRANCH    OVRCD,IPOP3000               * Discharged visits
.
          MATCH     EMVIURNO,DURNO
          GOTO      IPOP3000 IF NOT EQUAL        * Same U/R
.
          MOVE      DDATE,FIRSTDAT               * Discharge date/time
          UNPACK    DTIME,HOUR,D1,MIN
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MOVE      EMVIDATE,LASTDATE            * ED arrival date
.
          UNPACK    EMVITIME,HOUR,D1,MIN         * ED arrival time
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF
          IF        CALCTIME<=F6
            GOTO      IPOP9000                   * Discharge within XXX hours
          ENDIF
.
. Attended OP
.
IPOP3000  MOVE      SP70,SAVEDATE
          PACK      KEY26,EMVIURNO,SP1,TWO,CURRDATE,Z70
          CALL      RSPTVIS4
IPOP3100  CALL      RPPTVIS4                     * Attended OP visit
          BRANCH    OVRCD,IPOP9999
.
          MATCH     EMVIURNO,PVIURNO             * Same U/R
          GOTO      IPOP9999 IF NOT EQUAL
.
          MATCH     " 2",PTVITYPE                * OP visit
          GOTO      IPOP9999 IF NOT EQUAL
.
          MATCH     SP70,SAVEDATE
          IF        !@EQUAL
            MATCH     PVIDATE,SAVEDATE           * Check all attended OP
            GOTO      IPOP9999 IF NOT EQUAL      * visits for the visit date
          ELSE
            MOVE      PVIDATE,SAVEDATE
          ENDIF
.
          CALL      OUTFIL00                     * Check OP file prefix
.
          PACK      KEY36,DPVIBILL,SP70
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,IPOP9999               * eof - finished
.
          MATCH     DOBAOUTN,DPVIBILL            * same visit number ?
          GOTO      IPOP9999 IF NOT EQUAL
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,IPOP9999
.
          MOVE      OBADATE,FIRSTDAT             * Booking date/time-time seen
          MATCH     SP70,OTBBASTM
          IF        @EQUAL
            UNPACK    OBATIME,HOUR,D1,MIN
          ELSE
            UNPACK    OTBBASTM,HOUR,D1,MIN
          ENDIF
.
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MOVE      EMVIDATE,LASTDATE            * ED arrival date
.
          UNPACK    EMVITIME,HOUR,D1,MIN         * ED arrival time
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF
          IF        CALCTIME<=F6
            GOTO      IPOP9000                   * Discharge within XXX hours
          ENDIF
.
          GOTO      IPOP3100
.
IPOP9000  MOVE      ONE,LASTIPOP        * IP/OP within the last XXX hours
.
IPOP9999  RETURN
.
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAM00
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for EmergencyLocation.
.------------------------------------------------------------------------------
RESWRD00  STRIP     EMLODESC
          STRIP     DIM3
          CLEAR     KEY25
          APPEND    "EmergencyLocation-",KEY25
          APPEND    EMVILOCN,KEY25
          APPEND    SP70,KEY25
          RESET     KEY25
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY25,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY25,"#"},":
                    " #"name#": #"",EMLODESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"ro#",":
                    "   #"display#": #"Room#"  } ] } ";
.          MATCH     SP70,WEXTN
.          IF        !@EQUAL
.             WRITE     HTMLFILE;*+," #"telecom#": [":
.                       "{ #"system#": #"phone#",":
.                       "  #"value#": #"",WEXTN,"#" } ],";
.          ENDIF
.
          MATCH     SP70,DIM3
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",#"partOf#": { ":
                      "  #"reference#": #"Location/Hospital-",DIM3,"#"":
                      " } } ";
          ELSE
            WRITE     HTMLFILE;*+,"} ";
          ENDIF
.
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAM00  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          RETURN
+
.----------------------------------------------------
          INC       CALCAGE
          INC       CLEMRETS                * Clear emrthsaf vars
          INC       CLNHIMAS
          INC       CLPATMAS
          INC       CLPMSHCP
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPMSNUT
          INC       DAYOFWEK
          INC       DGCLICEC
          INC       EMRCHMAN
          INC       IBAWEBCD
          INC       NAMSTRCD
          INC       PATDOCCD
          INC       PATDOCTM
          INC       PATMASTM
          INC       PATNAMCD
          INC       PMIGTNID
          INC       PMSCDNDS
          INC       PMSPX2TM
          INC       WEBDATCD
          INC       EMRDRCHR
.
          INC       EMRBPSIO/INC
          INC       EMRDCMIO/INC
          INC       EMRDELIO/INC
          INC       EMRCLIIO/INC
          INC       EMRCMTIO/INC
          INC       EMREXPIO/INC
          INC       EMRGRCIO/INC
          INC       EMRHISIO/INC
          INC       EMRICDIO/INC
          INC       EMRINCIO/INC
          INC       EMRISMIO/INC
          INC       EMRLOCIO/INC
          INC       EMRMTXIO/INC
          INC       EMRPROIO/INC
          INC       EMRSCMIO/INC
          INC       EMRSITIO/INC
          INC       EMRUNKIO/INC
          INC       EMRUTYIO/INC
          INC       EMRVCDIO/INC
          INC       EMRVDGIO/INC
          INC       EMRVISIO/INC
          INC       EMRVPRIO/INC
          INC       EMRWFMIO/INC
          INC       MRTMASIO/INC
          INC       MRTLOCIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OPRNURIO/INC
          INC       OUTSITIO/INC
          INC       PATALRIO/INC
          INC       PATCRCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDSCIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATICDIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATNOBIO/INC
          INC       PATONLIO/INC
          INC       PATPR1IO/INC
          INC       PATTRNIO/INC
          INC       PATVADIO/INC
          INC       PATVISIO/INC
          INC       PATWR1IO/INC
          INC       PMSBRQIO/INC
          INC       PMSCDNIO/INC
          INC       PMSCURIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSNUTIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
          INC       PMSPX2IO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PMSVX1IO/INC
          INC       VISCMTIO/INC
          INC       VISMDTIO/INC
          INC       VISXDCIO/INC
          INC       FHRDATCD
.
          INC       EMRTHSIO/INC       * Emergency Telehealth Services
          INC       EMRTHSCD           * Emergency Telehealth Services routines
          INC       EMRMAPCK           * Discharged patient location check
.
