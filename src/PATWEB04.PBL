.----------------------------------------------------------------------
. Program       : PATWEB04
.
. Function      : Merge server
.
. Modifications : 
.
.----------------------------------------------------------------------
. V12.00.03 27/07/2025  Nikitha Bhaskar   TSK 0963585
.           Recompiled for WEBCHGUR
. V12.00.02 24/06/2025  J.Tan             TSK 0961696
.           Recompiled for WEBCHGUR - Patient Debt=4 Payment Plan admission
. V12.00.01 28.05.2025  Bella Turco     TSK 0955096
.           Alphanumeric changes                                   
. V11.05.02 06.03.2025  Ebon Clements   TSK 0953786
.           Added code to retrieve and record NDIS number watespaf
. V11.05.01 22/11/2024  Ebon Clements   TSK 0953786
.           Added identifying gender to ESIS patient details watespaf
. V11.04.02 15/12/2023  Peter Vela      TSK 0935874
.           Added writes to pmsnplaf (NIHC IHI polling table )for both ur
.           unmerge in MRGLST00
. V11.04.01 27/11/2023 Thanh T                TSK 0916369
.           Recompiled for PRIFACFD changes             
. V11.03.01 12/09/2023  Davin           TSK 0896442
.           Added broadcast of HL7 UnMerge (A37) message (MRGLST10/DGCLIUMR)
.----------------------------------------------------------------------
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.01.01 31/03/2021  Tracey Nguyen   TSK 0904417
.           Recompiled for MEHPATFD in WEBCHGUR - added MHPTFAMW Family/Whanau 
.           Involvement
.-----------------------------------------------------------------------------
. V11.00.04 30/12/2020  Thanh T        TSK 0878747
.           Recompiled for WEBCHGUR changes
. V11.00.03 09/12/2020  Thanh T         TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.02 09/09/2020  Peter Vela      TSK 0895969
.           Recompiled for WEBCHGUR 
. V11.00.01 07/05/2020  Thanh T         TSK 0876574
.           Recompiled for PMSCEXTM/PMSCEXTD changes
.----------------------------------------------------------------------
. V10.15.01 20/02/2020  Peter Vela      TSK 0887845
.           Recompiled for NZHISWIO
. V10.14.05 17/07/2019  Ebon Clements  TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.04 12/07/2019  Richa Phogat    TSK 0864951
.           Recompiled for WEBCHGUR
. V10.14.03 10/07/2019  Richa Phogat    TSK 0864951
.           Recompiled for WEBCHGUR
. V10.14.02 30/05/2019  Thanh T.        TSK 0872539
.           Recompiled for NZHISWIO changes
. V10.14.01 05/04/2019  Jill Parkinson Task 0872438
.           Mods to pack pmewtype with spaces in WREDW000 to stop I*D
. V10.13.01 05/12/2018  Don Nguyen     TSK 0838558
.           Deleted temp file (TEMP1) after use
.           19/10/2018  Ebon Clements    TSK 0865146
.           Write EDWARD unmerged record - WREDW000
. V10.12.03 25/06/2018  Ebon Clements    TSK 0845295
.           Recompiled for WEBCHGUR - eReferrals
. V10.12.02 25/05/2018  Thanh T.         TSK 0856102
.           Added PMSEHB00 for pmsehbaf in WEBCHGUR
. V10.12.01 05/04/2018  Steve Armstrong  TSK 0844685
.           Recompiled for changes to WEBCHGUR
.           06/04/2018  Davin            TSK 0844685
.           Recompiled for changes to WEBCHGUR
.----------------------------------------------------------------------
. V10.11.07 14/12/2017  Ania P         TSK 0849648
.           Recompiled for MRGURPRI
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 21/09/2017  Thanh T.       TSK 0821710
.           Recompiled WEBCHGUR
. V10.11.04 13/09/2017  Thanh T.       TSK 0821710
.           Recompiled WEBCHGUR
. V10.11.03 08/09/2017  Thanh T.       TSK 0821710
.           Removed PATCOMDF/IO
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. 
.           changed PATMASTM/PMSPX2TM.
. V10.11.01 18/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.01 12/04/2017  Peter Vela       TSK 0836016
.           Recompiled for WEBCHGUR - Always keep bad debt in
.           FIXMAS
. V10.08.07 18/08/2016  Ebon Clements    TSK 0260691
.           Recompiled for WEBCHGUR - A/H equipment loans
. V10.08.06 08/08/2016  Davin            TSK 0321234
.           Recompiled for WEBCHGUR - Added chronic condition alert (savesn11)
. V10.08.05 29/07/2016  Don Nguyen       TSK 0809271
.           Recompiled for WEBCHGUR - Modified FXBKRES1 to call UPESIS00
. V10.08.04 17/06/2016  Peter Vela       TSK 0820868
.           Recompiled for MRGURPRI
. V10.08.03 13/05/2016  Don Nguyen       TSK 0319664
.           Recompiled for WEBCHGUR - added FIXOBSNT
. V10.08.02 28/04/2016  Don Nguyen       TSK 0316489
.           Recompiled for WEBCHGUR/PATATRFD
.           18/04/2016  Peter Vela       TSK 0294177
.           Recompiled for MRGURPRI
. V10.08.01 01/04/2016  Steve Armstrong  TSK 0324703
.           Recompiled for changes to PATURCFD & WEBCHGUR
.----------------------------------------------------------------------
. V10.07.04 04/02/2016  Peter Vela       CAR 0809659
.           Recompiled for WEBCHGUR
. V10.07.03 02/02/2016  Peter Vela       CAR 0809659
.           Recompiled for SVRSPMI
. V10.07.02 05/11/2015  Steve Armstrong  CAR 303363
.           Recompiled for changes to RESHEAFD
. V10.07.01 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
.----------------------------------------------------------------------
. V10.06.07 30/09/2015  Ania P           CAR 321333               
.           Recompiled for changes to WEBCHGUR                    
. V10.06.06 26/08/2015  Jill Parkinson   CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.05 25/08/2015  Jill Parkinson   CAR 320905
.           Recompiled for changes to NZHISWIO
. V10.06.04 06/07/2015  Peter Vela       CAR 316928
.           Recompiled for MRGURWEB 
. V10.06.03 03/07/2015  J.Tan            CAR 316441
.           Recompiled for changes to WEBCHGUR - pmsdauaf file
. V10.06.02 10/06/2015  Steve Armstrong  CAR 313856
.           Recompiled for changes to WEBCHGUR
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed reference to PATCGPFD (No Longer in use)
.----------------------------------------------------------------------
. V10.05.03 14/10/2014  Peter Vela       CAR 301518
.           Recompiled for MRGURWEB
. V10.05.02 03/09/2014  J.Tan            CAR 298984
.           Recompiled for WEBCHGUR - changes to PATDETFD
. V10.05.01 26/08/2014  Ania P           CAR 303210
.           Recompiled for WEBCHGUR
.----------------------------------------------------------------------
. V10.04.05 05/06/2014  Steve Armstrong  CAR 299293
.           Recompiled for changes to WEBCHGUR
. V10.04.04 07/04/2014  Peter Vela       CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland      CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 20/03/2014  Ebon Clements    CAR 298136
.           Fixed confirm message redirect. Changed UPHERR80 target to
.           _self and set nextpage to 4
. V10.04.01 11/03/2014  Peter Vela     CAR 218689
.           Recompiled for WEBCHGUR - Added BOKRQ1FD
.----------------------------------------------------------------------
. V10.03.30 09/12/2013  Peter Vela     CAR 286158
.           Recompiled for WEBCHGUR - Added PATATRFD
. V10.03.29 08/10/2013  Ebon Clements  CAR 275205
.           Added un-merge EBS temp ur functionality
. V10.03.28 03/10/2013  Ebon Clements  CAR 275205
.           Recompiled for PMSARQFD - Addition of transfer source
. V10.03.27 25/09/2013  Ebon Clements    CAR 275205
.           Recompiled for WEBCHGUR - Electronic booking files
. V10.03.26 27/08/2013  Ebon Clements    CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.25 22/08/2013  Ebon Clements    CAR 281169
.           Recompiled for WEBCHGUR - Health fund program files
. V10.03.24 26/07/2013  Steve Armstrong  CAR 287787
.           Recompiled for changes to DGCLICUA.
. V10.03.23 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.22 09/07/2013 Sandra Barcham    CAR 288188
.           Recompiled for changes to WEBCHGUR
. V10.03.21 28/06/2013  Patrick Adair    CAR 286757
.           Recompiled for changes to MRGURWEB (in WEBCHGUR)
. V10.03.20 01/05/2013  Steve Armstrong   CAR 284376
.           Recompiled for changes to BRHLCOMN so that PMI messages
.           can use H7CIHOSP for Facility Code.
.           Recompiled for changes to DGCLICUP & DGCLICMR.
. V10.03.19 12/04/2013  Steve Armstrong   CAR 283973
.           Recompiled for changes to WEBCHGUR
. V10.03.18 ??/??/????  Steve Armstrong
.           Looks like there was an incorrect VERSION, probably for
.           V10.03.16, so I have implemented CAR 283973
.           as one version higher to avoid on site confusion.
. V10.03.17 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.16 05/03/2013  Jill Parkinson   CAR 257831
.           Recompiled for changes to WEBCHGUR, and added pmsupdaf
. V10.03.15 13/12/2012  Jill Parkinson   CAR 278129
.           Recompiled for changes to WEBCHGUR
. V10.03.14 10/12/2012  Saroeun Soeur    CAR 275430
.           Recompiled for changes to WEBCHGUR
. V10.03.13 02/11/2012  Saroeun Soeur    CAR 275430
.           Recompiled for changes to WEBCHGUR
. V10.03.12 31/08/2012  J.Tan            CAR 270090
.           Recompiled for changes to WEBCHGUR to call FLAGDEBT
. V10.03.11 14/08/2012  Steve Armstrong  CAR 256888
.           Recompiled for changes to WEBCHGUR.
. V10.03.10 06/07/2012  Mike Laming   CAR 261603
.           Recompiled for WEBCHGUR - correct Key for MEHPATaf to KEY32
. V10.03.09 29/05/2012  J.Tan            CAR 259554               
.           Recompiled for WEBCHGUR - Event visit to upd patinvrf 
. V10.03.08 23/05/2012  Ebon Clements   CAR 265676
.           Recompiled for WEBCHGUR
. V10.03.07 16/05/2012  Steve Armstrong CAR 256322
.           Recompiled for changes to NZHISWIO.
. V10.03.06 11/04/2012  Steve Armstrong CAR 263369
.           Recompiled for WEBCHGUR
. V10.03.05 04/04/2012  Peter Vela      CAR 262395
.           Recompiled for WEBCHGUR
. V10.03.04 03/04/2012  Don Nguyen      CAR 262735
.           Recompiled for WEBCHGUR
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 08/12/2011  Jill Parkinson CAR 253264
.           Added move zero to exit in UDET9000
. V10.03.01 29/11/2011  Steve Armstrong  CAR 253264
.           Recompiled for changes to WEBCHGUR
.----------------------------------------------------------------------
. V10.02.09 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.08 05/10/2010  J.Tan      CAR 249242
.           Mods for SX G/L Extract transactions
. V10.02.07 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.06 26/07/2011  Steve Armstrong   CAR 240684
.           Recompiled for changes to LEGALTFD & WEBCHGUR.
. V10.02.05 13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.04 04/07/2011  Steve Armstrong  CAR 240722
.           Recompiled for changes to PATLOCFD
.           Recompiled for changes to PMSCURFD
.           Mods to cater for changes to PATGSRFD:
.                - GSRSNAM & GSRGNAM extended to 30 chars.
.                - PTGSGNM2 added.
.                - all indexes changed in length.
. V10.02.03 09/05/2011  Davin         CAR 239539
.           Recompiled for WEBCHGUR - added savesin7/8/9
. V10.02.02 05/05/2011  Mike Laming   CAR 240720
.           Recompiled for WEBCHGUR - added Appointment Request table
. V10.02.01 21/04/2011  Mike Laming   CAR 233229
.           Recompiled for WEBCHGUR - added Patient Debt Indicators
.----------------------------------------------------------------------
. V10.00.07 27/10/2010  Steve Armstrong  CAR 232111 
.           Recompiled for changes to WEBCHGUR
. V10.00.06 20/10/2010  Jill Parkinson   CAR 227377 
.           Added reads of pmspx2af after all master file reads
. V10.00.05 23/08/2010  J.Tan             CAR 228752
.           Recompiled for MRGURPRI - Private Practice Credit notes files
. V10.00.04 02/07/2010  Ebon Clements     CAR 218982
.           Recompiled for WEBCHGUR - WATCHAFD
. V10.00.03 19/03/2010  Davin S           CAR 223380
.           Recompiled for changes to PMSCCDFD
. V10.00.02 09/04/2010 Steve Armstrong   CAR 219045
.           Recompiled for changes PATMRGFD.
.           Mods to populate PTMRSTIM.
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.04  01/03/2009  Steve Armstrong  CAR 217090
.           Recompiled for WEBCHGUR
. V9.12.03  01/12/2009  Davin            CAR 210980               
.           Added merge broadcast (dgclicmr) to multidatabase merge (rlur0000)
. V9.12.02  09/10/2009  WeeLee Koo       CAR 181371               
.           Recompiled for changes to WEBCHGUR.
. V9.12.01  23/07/2009  Jill Habasque     CAR 200251
.           Mods to write to watesmaf
. V9.11.04  02/04/2009  Mike Laming       CAR 166690
.           Recompiled for changes to WEBCHGUR. - Added NZ PRIMHD Hist. Tables
. V9.11.03  19/02/2009  Steve Armstrong   CAR 190455
.           Recompiled for (Eclipse) changes to WEBCHGUR.
. V9.11.02  20/11/2008  Steve Armstrong   CAR 181373
.           Recompiled for changes to PMSPTDFD and WEBCHGUR.
.           Added read of PTCNTRPR.
. V9.11.01  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
.----------------------------------------------------------------------
. V9.10.01  03/09/2008  J.Tan            CAR 177376
.           Recompiled for WEBCHGUR - pmsfedaf file
.----------------------------------------------------------------------
. V9.09.08  28/02/2008  Ebon Clements    CAR 162564
.           Recompiled for WEBCHGUR - Related provider invoice files
. V9.09.07  30/01/2008  Peter Vela       CAR 155334
.           Recompiled for WEBCHGUR. Added PMSPTDFD, IO
. V9.09.06  18/01/2008  Steve Armstrong  CAR 159429
.           Recompiled for changes to WEBCHGUR
. V9.09.05  07/12/2007  Ebon Clements    149191
.           Added JAVDES00 to DISROW00
. V9.09.04  01/10/2007  Sandra Barcham   151255
.           Recompiled for WEBCHGUR - Fixed I * U in alllonaf
. V9.09.03  28/09/2007  Sandra Barcham   151255
.           Recompiled for WEBCHGUR - Fixed I * U in allpctaf
. V9.09.02  27/08/2007  Peter Vela   CAR 147747
.           Added variables for PATCOMN2 Cabrini Health UR format
. V9.09.01  07/08/2007  Mike Laming      CAR 146598
.           Added call to FIXALLEG (Alt.Legacy file) - recompiled for WEBCHGUR
.----------------------------------------------------------------------
. V9.08.05  20/04/2007  Steve Armstrong  CAR 111005
.           Recompiled for changes to WEBCHGUR
. V9.08.04  19/04/2007  Jill Habasque CAR 116984
.           Added check for PTCNNHII
. V9.08.03  13/02/2007 Janet George         114378
.           Populated web user id field pmpxwbid (pmspx2af)
. V9.08.02  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.01  13/10/2006  Peter Vela    CAR 120583
.           Recompiled for WEBCHGUR - Defaulted MRMACOMM to SP70 in CRMED000
.----------------------------------------------------------------------
. V9.07.04  01/08/2006  Mike Laming   CAR 87846
.           Recompiled for WEBCHGUR - fix WRITE at FIXHIS30
. V9.07.03  13/07/2006  Jill Habasque CAR 112134
.           Recompiled for WEBCHGUR
. V9.07.02  12/07/2006  Ebon Clements     CAR 103365
.           Added visit expected payor functionality
.           11/07/2006  Jill Habasque CAR 108049    
.           Mods to redirect after an error message                     
.           06/07/2006  Jill Habasque CAR 108049    
.           Mods for error on temp nhi merge        
. V9.07.01  07/07/2006  Ebon Clements     CAR 103365
.           Added expected payor functionality to pmi add/update
.----------------------------------------------------------------------
. V9.06.03  24/04/2006  Mike Laming       CAR 87846
.           Recompiled for changes WEBCHGUR - add FIXHIS00 (WATHISaf)
. V9.06.02  18/05/2006  Ebon Clements CAR 104168
.           Added ur created by to merged ur list - MLST0000
. V9.06.01  27/03/2006  Jill Habasque CAR 78524
.           Added update of PTMRUSER
.----------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B04 20/02/2006  Ebon Clements     CAR 76341 
.           Added referral and encounter file audit  
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B02 21/12/2005  Steve Armstrong   CAR 89329
.           Recompiled for changes to MRGURRES
.----------------------------------------------------------------------
. V9.04.09  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.08  03/08/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.07  27/05/2005  J.Tan         CAR 56699
.           Recompiled for WEBCHGUR - update HIC files
. V9.04.06  02/05/2005  Mike Laming   CAR 60976
.           Recompiled for WEBCHGUR - Add routine for "Intepreter Visit Dets"
. V9.04.05  29/04/2005  Peter Vela    CAR 55214
.           Recompiled for MRTCONFD
.           29/04/2005  Mike Laming   CAR 61101
.           Recompiled for WEBCHGUR - Add routine for "Previous Address"
. V9.04.04  07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINADT, HL7CISIN & HL7CISVR
. V9.04.03  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.02  25/01/2005  Peter Vela    CAR 56906
.           Recompiled for WEBCHGUR
. V9.04.01  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for CRMED000 - medical record link
.----------------------------------------------------------------------
. V9.03.18  02/08/2004  Davin         CAR 34707
.           Recompiled for WEBCHGUR - added update of pmsccdaf
. V9.03.17  14/07/2004  Steve Armstrong  CAR 51769
.           Removed reference to PATHCSUC
. V9.03.16  05/07/2004  Lina Vo       CAR 50811
.           Recompile for MRGURPRI in WEBCHGUR
. V9.03.15  02/07/2004  Jill Habasque CAR 51382
.           Recompiled for WEBCHGUR - reslnkaf.relnpid update
. V9.03.14  28/06/2004  Steve Armstrong      CAR 51167
.           Recompiled for changes to HL7CISIN
. V9.03.13  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.12  09/06/2004  Sylvek Litewka  CAR 50371
.           Recompiled for FIXPFA (Patient Future Actions) in WEBCHGUR.
.           09/06/2004  Steve Armstrong   PAS-CIS Product Integration
.           Recompiled for changes to WEBCHGUR  CAR  49679
.           07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.11  13/05/2004  Steve Armstrong      CAR 49679
.           PAS-CIS Product Integration
.           Recompiled for WRTUR in PATCOMN2 (added call to CISA28BR)
. V9.03.10  22/04/2004  Mike Laming   CAR 46224 
.           Re-compile for PATCATBI - Theatre DTR sequences 
. V9.03.09  26/03/2004 Peter Vela    CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
.           16/03/2004  Steve Armstrong  HosClaims Phase 1 (48280)
.           Recompiled for WEBCHGUR
. V9.03.08  18/12/2003  Peter Vela   CAR 43134
.           Recompiled for MRTCONFD
. V9.03.07  11/12/2003  Peter Vela   CAR 40355
.           Recompiled for PATNAMCD
. V9.03.06  03/12/2003  Davin  CAR 44095
.           Removed reference to receipting trans file
. V9.03.05  22/10/2003 Jill Habasque CAR 43615
.           Added WINPAR00
. V9.03.04  19/10/2003 Jill Habasque CAR 43615
.           Added override options
. V9.03.03  21/07/2003 Jill Habasque CAR 40554
.           Fixed temporary NHI list
. V9.03.02  02/07/2003 Jill Habasque CAR 40660
.           Recompiled for PATDSCTM
. V9.03.01  22/05/2003 Ebon Clements CAR 39351
.           Added update of ALLLINFD for allied health change ur function.
. V9.02.07  21/03/2003 Jill Habasque SRF 36883
.           Added read of PTCNNHTM
. V9.02.06  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
.           18/03/2003 Jill Habasque SRF 37368
.           Added move of purno to gsrurno when unmerging
. V9.02.05  06/03/2003  J.Tan    SRF 36097
.           Fixed reading nhi interface system parameter
. V9.02.04  13/02/2003  Dean Cramer  CAR 22238                       
.           Recompiled for RCPTRNFD via WEBCHGUR                                
. V9.02.03  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.02  17/12/2002  Lina Vo       SRF 22698             
.           Added Temporary NHI Number list
.           Added Replace Temporary NHI number functionality from IBANHI02.
. V9.02.01  11/12/2002  Jill Habasque SRF 22697             
.           Added nhi merge    
. V9.02.00  26/11/2002  Jill Habasque SRF 33996             
.           Created Web Server 
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       AAEDE1FD/INC       * A&E Details file      Defect 22698
          INC       ALLCONFD/INC
          INC       ALLEDTFD/INC
          INC       ALLETXFD/INC
          INC       ALLLINFD/INC
          INC       ALLLONFD/INC
          INC       ALLPCTFD/INC
          INC       ALLREFFD/INC                             * Defect 22698
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC                             * Defect 22698
          INC       EMRVISFD/INC                             * Defect 22698
          INC       LEGALTFD/INC       * Alternate Legacy file
          INC       LEGBOAFD/INC
          INC       LEGDEAFD/INC
          INC       LEGDSCFD/INC
          INC       LEGINVFD/INC
          INC       LEGMISFD/INC
          INC       LEGTRNFD/INC
          INC       LEGVISFD/INC
          INC       MRTCONFD/INC                             * Defect 22698
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       NZHISIFD/INC
          INC       MEHVI1FD/INC
          INC       OUTARTFD/INC                             * Defect 22698
          INC       OUTCONFD/INC                             * Defect 22698
          INC       OUTSITFD/INC
          INC       PATAM1FD/INC                             * Defect 22698
          INC       PATDO1FD/INC   * Doctor File
          INC       PATECDFD/INC
          INC       PATGSRFD/INC
          INC       PATHOSFD/INC
          INC       PATKWCFD/INC                             * Defect 22698
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATMRGFD/INC
          INC       PATNIDFD/INC                             * Defect 22698
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       PMSEDWFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCOMM/INC                              * Defect 22698
          INC       PATPA1FD/INC                             * Defect 22698
          INC       PATPR1FD/INC
          INC       PMSNPLFD/INC       * NIHC IHI Polling
          INC       PMSPX2FD/INC
          INC       PMSPTDFD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PATAXEFD/INC                             * Defect 22698
          INC       PATCSLFD/INC                             * Defect 22698
          INC       PATDNRFD/INC                             * Defect 22698
          INC       PATINVFD/INC                             * Defect 22698
          INC       PATLINFD/INC                             * Defect 22698
          INC       PATLOCFD/INC                             * Defect 22698
          INC       PATURAFD/INC                             * Defect 22698
          INC       PATURCFD/INC   * U/R no. change audit file Defect 22698
          INC       PATTRNFD/INC                             * Defect 22698
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCURFD/INC                             * Defect 22698
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PATIN1FD/INC
          INC       PMSPAYFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PATDSCFD/INC
          INC       SAVPX2FD/INC                              * Defect 22698
          INC       TMPALIFD/INC
          INC       VISPAYFD/INC
          INC       WATTR1FD/INC                              * Defect 22698
          INC       WATTX1FD/INC                              * Defect 22698
          INC       WATESPFD/INC
          INC       WATESMFD/INC
          INC       PATHSPFD/INC
          INC       NZPEXTFD/INC
          INC       PMSTSPFD/INC
          INC       PMSUPDFD/INC
          INC       PMSEHBFD/INC
.----------------------------------------------------------------------
TEMP1     FILE      ASCII, FIXED=17
.Name     Type      Length    Start
.-------  ----      ------    -----
.OLDURNO   DIM       8        1
.NEWURNO   DIM       8        9
.
.     End of Record            17
.
TEMP3     FILE      ASCII, FIXED=107
.Name     Type      Length    Start
.-------  ----      ------    -----
.OLDURNO   DIM       8        1
.NEWURNO   DIM       8        9
.CHOSPNUM  FORM      2        17
XXFILE     DIM       8        19
XXDESC     DIM       80       27
.
.     End of Record           107
.
.LOGERR     FORM      "1"     * set in IBANHI10
LOGERR     FORM     "0"       * set in IBANHI02
NCCURNO    DIM       8
UPDKWARN  DIM       1
ADDRWARN  DIM       1
DUPLWARN  DIM       1
ERRTYPE   DIM       3
OVERRIDE  DIM       3
OCCURNO    DIM       8
WARNMES   DIM       30
.
ACTION    DIM       1
ADD       DIM       2
AYY       DIM       2
AMM       DIM       2
ACC       DIM       2
ALTKEY35  DIM       35
APPRDESC  DIM       20
APPRVNOW  FORM      1
.
CMDLINE   DIM       80
COUNT     FORM      3
.CPPURNO   DIM       8
CURRDATE  DIM       8       * Current Date
.
DETNTREC  FORM      2
DIM4      DIM       4
DIM8      DIM       8
DIM16     DIM       16
DIM20     DIM       20
DISPDATE  DIM       11        * display date
DOCTCODE  DIM       8
.
ENDNAME   DIM       80
ETHDES1   DIM       25         * For PATDETNT
ETHDES2   DIM       25         * For PATDETNT
ETHDES3   DIM       25         * For PATDETNT
EXISTFL   FORM      1
.
.FILNHIAF  FILE      ASCII, FIXED=256       * tmp save file for forking
FNAMER    DIM       8
F3A       FORM      3
FORM3     FORM      3 
FORM8     FORM      8 
FORMURNO  FORM      8
.
HOSPREQ   DIM       30
.
JAVSNAME  DIM       80
.
LBED      DIM       3
LEGCFLAG  FORM      1
LWARD     DIM       3
.
MBSDESC   DIM       70
MRGESTAT  DIM       1
MRGSENT   DIM       3
MRGSTAT   DIM       20
MRGURDAT  FORM      1
MRGODDAT  DIM       8
.
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NEWURNO   DIM       8                        * NEW urno - used by changeur
NEWURNUM  DIM       8
.
NHMASLUP  DIM       16                      * Last Update Key
NHMAS001  DIM       25                      * Surname
NHMAS002  DIM       20                      * Given Name 1
NHMAS003  DIM       20                      * Given Name 2
NHMAS004  DIM       20                      * Given Name 3
NHMAS005  DIM       1                       * Preferred Given Name Indicator
NHMAS006  DIM       35                      * Address Line 1
NHMAS007  DIM       30                      * Address Line 2
NHMAS008  DIM       30                      * Suburb
NHMAS009  DIM       30                      * City/Town
NHMAS010  DIM       30                      * Country
NHMAS011  DIM       8                       * Date of Birth
NHMAS012  DIM       8                       * Date of Death
NHMAS013  DIM       4                       * Domicile Code
NHMAS014  DIM       1                       * Residence Status (Y/N) (0=N,1=Y)
NHMAS015  DIM       1                       * Gender (M or F)
NHMAS016  DIM       2                       * 1st Ethnicity
NHMAS017  DIM       2                       * 2nd Ethnicity
NHMAS018  DIM       2                       * 3rd Ethnicity
NHMAS019  FORM      1                       * Save Alias 0=No 1=Yes
.
NMPNUMB   DIM       20      * actual number keyed in
.NZHISMOD  FORM      1       * NZHIS change mode indicator
.
OLDCASE   DIM       20
OURNO     DIM       8                        * OLD urno - used by changeur
OLDURNO   DIM       8
OLDURNUM  DIM       8
OPERCODE  DIM       4
.
PATLINK   DIM       127     * Link to the next patient info
PSAGECON  DIM       3
PSAGETYP  DIM       3
.
REQUSER   DIM       30
SAVEALIA  FORM      1
SAVEDETL  FORM      1
SAVEHOSP  DIM       3
SAVEURNO  DIM       8
SAVKEY16  DIM       16
SAVKEY19  DIM       19
SAVKEY25  DIM       25
SAVKEY28  DIM       28
SAVKEY32  DIM       32
SAVKEY35  DIM       35
SVKEY115  DIM       115
SAVPFUND  DIM       6
SAVESIN7  DIM       1
SAVESIN8  DIM       1
SAVESIN9  DIM       1
SAVESN11  DIM       1
SAVERETN  FORM      1
STARTKEY  DIM       10      * Starting Key
STRTNAME  DIM       80
TOTALALI  FORM      3
UPDTTYPE  DIM       1       * Update Type
URCHKDGT  FORM      4
URNLNGTH  FORM      2
URCHKPRD  FORM      2
URNOWGHT  FORM      1
WLOTANAE  DIM       8
WLOTPACN  DIM       8
.
APPRV1    INIT      "Merge Approved "
APPRV2    INIT      "Merge Rejected "
APPRV3    INIT      "No Action Taken"
.
CHAINPRG  INIT      "IBAPMS05"         * Second merge program to change
.
KWCFIL    INIT      "patkwc"
.
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
MRGSTAT1  INIT      "Merge Requested     "
MRGSTAT2  INIT      "Merge Fully Accepted"
MRGSTAT3  INIT      "Merge Processed     "
MRGSTAT4  INIT      "Merge Rejected      "
PIPE      INIT      "|"
.
SEC1      FORM      "00001"
TILDA35   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
TMPURFLG  INIT      "T-"
URWTARAY  INIT      "234567"
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB04"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Patient Merge Web Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MRGLST00         * patient level merge list
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      MRGREQ00         * merge requests list (hospital level)
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      TMPLST00         * temporary NHI number              
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      GLTRNS00         * patient level merge list
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG50  CALL      NRGDIR00      * New registration redirect
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPAR00      * Close window and redirect
          GOTO      NXTPAG99
.
NXTPAG70  CALL      WINPR200      * Clse window and redirect (append newurno)
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame1#"||":
                             "     self.name==#"PopUpFrame#") {":
     "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; ":
                            "  parent.parent.location.href=#"",REDIRECT,"#"; }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPR200  CALL      OPENHTML
          BRANCH    EXIT,WINPR299
          ENDSET    REDIRECT
          REP       " +",NEWURNUM
          APPEND    NEWURNUM,REDIRECT
          RESET     REDIRECT
          REP       "+ ",NEWURNUM
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame1#"||":
                             "     self.name==#"PopUpFrame#") {":
     "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; ";
          MATCH     SP70,OVERRIDE
          IF        !@EQUAL
            WRITE     HTMLFILE;"parent.location.href=#"",REDIRECT,"#"; }";
          ELSE
            WRITE     HTMLFILE;"parent.parent.location.href=#"",REDIRECT,"#";}";
          ENDIF
          WRITE     HTMLFILE;" else { ":
                             "  parent.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINPR299  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL  (append new urnumber)
.------------------------------------------------------------------------------
NRGDIR00  CALL      OPENHTML
          BRANCH    EXIT,NRGDIR90
.
          ENDSET    REDIRECT
          REP       " +",NEWURNUM
          APPEND    NEWURNUM,REDIRECT
          RESET     REDIRECT
          REP       "+ ",NEWURNUM
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      NRGDIR99
.
NRGDIR90  DISPLAY   "*** Fifo Not Found ***"
.
NRGDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSEDWA2,"pmsedwaf"
          OPEN      PMSPAYA1,"pmspayaf"
          OPEN      PMSPAYA2,"pmspayaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATMRGG1,"patmrgaf"
          OPEN      PATMRGG2,"patmrgaf"
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATHOSP1,"pathospf"
          OPEN      PATHOSP2,"pathospf"
          OPEN      PATAM1A1,"patam1af"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      WATESMA1,"watesmaf"
          OPEN      WATESPA1,"watespaf"
          READ      CONTROLF,TEN;*213,CAUDM
          READ      CONTROLF,TEN;*244,CHOSINDX
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          IF        PTCNNHII=1
            OPEN      NHIMASA1,"nhimasaf"
            OPEN      NHIMASA2,"nhimasaf"
          ENDIF
          READ      CONTROLF,SIXTY;*129,MRCNNOHS
          READ      CONTROLF,EIGHTY;*138,PTCNNZUR
          READ      CONTROLF,HUND09;*177,PTCNNHTM
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND10;*248,PTCNEPAY
          READ      CONTROLF,HUND12;*118,PTCNTRPR
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND25;*93,PTCNNSSI
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CLEAR     FNAMER
          APPEND    "mergeurs",FNAMER
          RESET     FNAMER
          REP       " 0",FNAMER
.
          MATCH     "3",PTCNUNET
          IF        @EQUAL
            OPEN      PMSNPLA1,"pmsnplaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,OLDURNUM
          MOVE      SP70,NEWURNUM
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,MRGESTAT
          MOVE      ZERO,APPRVNOW
          MOVE      SP70,OVERRIDE
          MOVE      SP70,ADDRWARN
          MOVE      SP70,DUPLWARN
          MOVE      SP70,UPDKWARN
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldurnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDURNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newurnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWURNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrgestat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRGESTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "apprvnow=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,APPRVNOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "override=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVERRIDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addrwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updkwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDKWARN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "duplwarn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DUPLWARN
            GOTO      SETPAR99
          ENDIF
.
.
SETPAR99  RETURN
.------------------------------------------------------------
. G/L Transactions
.------------------------------------------------------------
GLTRNS00  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,GLTRNS91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "G/L Transactions",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GLTRNS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      GLTRNS99
.
GLTRNS90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GLTRNS99
.
GLTRNS91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GLTRNS99
.
GLTRNS99  RETURN
+
.------------------------------------------------------------
. Merge list
.------------------------------------------------------------
MRGLST00  MATCH     SP70,UPDTTYPE
          GOTO      MRGLST70 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Un-Merge
          GOTO      MRGLST10 IF EQUAL
.
          GOTO      MRGLST90
.
MRGLST10  PACK      KEY8,OLDURNUM,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MRGLST94
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          UNPACK    SP70,D8,D1         * If 9th character = "R" then this is an
          UNPACK    PPSNAME,D8,D1      * EBS created U/R so set pstat back to 4
.
          MATCH     ANSR,D1
          IF        @EQUAL
            MOVE      FOUR,PSTAT       * EBS created U/R
          ELSE
            MOVE      ZERO,PSTAT
          ENDIF
.
          MOVE      SP70,PPSNAME
          CALL      UPMAST1
.
          CALL      UZDS0000        * write surname record
.
          PACK      KEY17,THREE,OLDURNUM,URNUMBER,SP70
          CALL      RDPTMRG1
          BRANCH    OVRCD,MRGLST99
          CALL      DEPTMRG1
.
          CALL      WREDW000           * Write EDWARD unmerge record
.       
.0896442  Re-read the U/R in context before broadcasting UnMerge message
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      OLDURNUM,OLDURNO        * U/R being UnMerged
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUMR                * send UnMerge (A37)
.
          MOVE      URNUMBER,DIM8
          CALL      WPMNPL00                    * Write to NIHC IHI polling
.
          MOVE      OLDURNUM,DIM8
          CALL      WPMNPL00
.
          GOTO      MRGLST99
.
MRGLST70  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MRGLST91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Merged Records",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRGLST99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST92  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST93  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST94  MOVE      "Old UR Number not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGLST99
.
MRGLST99  RETURN
+
.------------------------------------------------------------
. Merges Requested List
.------------------------------------------------------------
MRGREQ00  MOVE      "Merges Requested",WEBTITLE
.
          MATCH     SP70,OLDURNUM
          GOTO      MRGREQ70 IF EQUAL
          GOTO      MRGREQ70 IF EOS
.
          MATCH     SP70,NEWURNUM
          GOTO      MRGREQ70 IF EQUAL
          GOTO      MRGREQ70 IF EOS
.
          MATCH     ANSR,UPDTTYPE
          GOTO      MRGREQ10 IF EQUAL
.
          MATCH     ANSA,UPDTTYPE
          GOTO      MRGREQ30 IF EQUAL
.
          MATCH     ANSJ,UPDTTYPE
          GOTO      MRGREQ40 IF EQUAL
.
          MATCH     ANSS,UPDTTYPE
          GOTO      MRGREQ50 IF EQUAL
.
          GOTO      MRGREQ20
.
MRGREQ10  CALL      NWVL0000
          BRANCH    EXIT,MRGREQ99
          CALL      WRIT0000
          BRANCH    EXIT,MRGREQ99
          MOVE      ANSY,ACTION
          CALL      UPDT0000
          GOTO      MRGREQ99
.
MRGREQ20  PACK      KEY17,MRGESTAT,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          BRANCH    OVRCD,MRGREQ90
          GOTO      MRGREQ70
.
. ---- Accept Merge ----
.
MRGREQ30  PACK      KEY17,MRGESTAT,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          BRANCH    OVRCD,MRGREQ90
.
          CALL      NWVL0000
          BRANCH    EXIT,MRGREQ99
          MOVE      ANSY,ACTION
          CALL      NEWW0000
.
          CALL      UPDT0000
          GOTO      MRGREQ99
.
. ---- Reject Merge ----
.
MRGREQ40  PACK      KEY17,MRGESTAT,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          BRANCH    OVRCD,MRGREQ90
.
          MOVE      ANSN,ACTION
          CALL      NEWW0000
.
          CALL      UPDT0000
          GOTO      MRGREQ99
.
. ---- Send Request to NHI ----
.
MRGREQ50  PACK      KEY17,MRGESTAT,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          BRANCH    OVRCD,MRGREQ90
.
          CALL      GETNAT00
          BRANCH    EXIT,MRGREQ99
          CALL      CONNECT
          CALL      MRGHCU
          CALL      DISCNNCT
          IF        OVRCD=1
            CALL      NZHISERR                    * display error message
          ENDIF
          MOVE      ONE,PTMRSENT
.
          PACK      PTMRSDTE,CCC,CYY,CMM,CDD     * Last Status Change Date
          REP       " 0",PTMRSDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PTMRSTIM             * Last Status Change Time
          REP       " 0",PTMRSTIM
          CALL      UPPTMRG1
.
          GOTO      MRGREQ99
.
MRGREQ70  CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MRGREQ99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MRGREQ99
.
MRGREQ90  MOVE      "Missing patient merge record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MRGREQ99
.
MRGREQ99  RETURN
.------------------------------------------------------------
. Read and write to the double soundex surname file - From PATPRG31
.------------------------------------------------------------
UZDS0000  MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO
          MOVE      ZEROUR,GSRBILL
          MOVE      THREE,GSRSYS
.
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1                 * check if its already there
          COMPARE   ONE,OVRCD
          GOTO      UZDS9999 IF NOT EQUAL
          CALL      WRPTGSR1
.
UZDS9999  RETURN
.------------------------------------------------------------
. Temporary NHI Number List
.------------------------------------------------------------
TMPLST00  MOVE      ZERO,EXIT
          MOVE      "Temporary NHI Number List",WEBTITLE
.
          MATCH     ANSN,UPDTTYPE
          IF        @EQUAL
            CALL      NEWREG00
            BRANCH    EXIT,TMPLST99
            CALL      NHIMG000     * Replace temporary NHI number
            GOTO      TMPLST99
          ENDIF
.
          MATCH     ANSU,UPDTTYPE
          IF        @EQUAL
            CALL      NHIMG000     * Replace temporary NHI number
            GOTO      TMPLST99
          ENDIF
.
          MATCH     SP70,NEWURNUM
          GOTO      TMPLST80 IF EQUAL
.
          PACK      KEY8,SP1,NEWURNUM,SP70
          CALL      RDNHMAS2                * Read Local NHI Details
          IF        OVRCD=0
            MOVE      NHMANMPI,NZIBNMPI
          ELSE
            MOVE      NEWURNUM,D8
            SQUEEZE   D8
            MOVE      D8,NZIBNMPI
          ENDIF
          CALL      CONNECT
          BRANCH    OVRCD,TMPLST90
          PACK      NMPNUMB,SP10,SP3,NZIBNMPI
          CALL      GETHCU                  * Read National Details
          BRANCH    OVRCD,TMPLST90
          CALL      DISCNNCT
.
.**       PACK      KEY8,NEWURNUM,SP70
.**       CALL      RDNHMAS2                * Read Local NHI Details
.**       IF        OVRCD=0
.**         MOVE      NHMAURNO,KEY8
.**         CALL      RDMAST1
.**         BRANCH    OVRCD,TMPLST92
.**         MOVE      PURNO,KEY8
.**         CALL      RDPMPX21
.**         IF        OVRCD=1
.**           CALL      CLPMSPX2
.**         ENDIF
.**       ENDIF
.
TMPLST80  CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,TMPLST99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      TMPLST99
.
TMPLST90  CALL      NZHISERR                    * display error message
          MOVE      TRUE,EXIT
          GOTO      TMPLST99
.
TMPLST92  MOVE      "Invalid Patient Master Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TMPLST99
.
TMPLST99  CLOSE     TEMP1,DELETE       * Delete temp file created by UDET0000
          RETURN
+
.------------------------------------------------------------
. New National Patient Registration
.------------------------------------------------------------
NEWREG00  MOVE      OLDURNUM,OLDURNO
          CALL      CHKI0000
          BRANCH    EXIT,NEWREG99
.
          CALL      LOCNHI00
          REP       "* ",NZIBETH2
          REP       "* ",NZIBETH3
          REP       "* ",NZIBGIV2
          REP       "* ",NZIBGIV3
          REP       "* ",NZIBADD2
          REP       "* ",NZIBSUBR
          REP       "* ",NZIBCITY
          REP       "* ",NZIBCTRY
          REP       "* ",NZIBDDTH
          MOVE      " ",NZIBSCRB  * Clear Overide Flags
          MOVE      " ",NZIBDUPL
          MOVE      " ",NZIBUPDT
.
NEWREG10  MATCH     SP70,OVERRIDE
          CALL      OVRRID00 IF NOT EQUAL
          CALL      CONNECT
          CALL      NEWHCU
          MATCH     SP70,OVERRIDE
          IF        @EQUAL
            BRANCH    OVRCD,NEWREG95
          ENDIF
          CALL      RETUP000       * Move Changed Fields back to NHMA Fields
.
          MOVE      NZIBNMPI,KEY7
          MOVE      NZIBNMPI,NHMANMPI
.
          MOVE      NZIBNMPI,NHMANMPI
          PACK      NHMAURNO,SP1,NZIBNMPI
          MOVE      NHMAURNO,NEWURNUM          
          GOTO      NEWREG99
.
NEWREG95  CALL      UPDERR00       * Display Error on New Record
          MOVE      ONE,EXIT              * Return to Input Screen
          GOTO      NEWREG99
.
NEWREG99  RETURN
+
.------------------------------------------------------------
. Merge Temporary NHI Number
.------------------------------------------------------------
NHIMG000  MOVE      NEWURNUM,NEWURNO         * for changeur
          MOVE      OLDURNUM,OLDURNO         * for changeur
.
          CALL      CHKI0000                 * Check UR
          BRANCH    EXIT,NHIMG999            * Don't continue
          CALL      VLUR0000                 * validate UR
          BRANCH    EXIT,NHIMG999
.
          COMPARE   ONE,PTCNNHII
          IF        @EQUAL
            CALL      CONNECT                  * Open NHI database
            CALL      UPDNAT00
            BRANCH    EXIT,NHIMG999           * link down/cant update
            CALL      DISCNNCT
          ENDIF
.
          CALL      UDET0000
          GOTO      NHIMG999
.
NHIMG900  CALL      UPHERR00
          MOVE      ONE,EXIT              * Return to Input Screen
          GOTO      NHIMG999
.
NHIMG999  RETURN
+
.------------------------------------------------------------
. Check Temporary UR selected                     
.------------------------------------------------------------
CHKI0000  IF        PTCNNHII=1
            MOVE      OLDURNO,KEY8
            CALL      RDNHMAS2                * read NHI Master file
            BRANCH    OVRCD,CHKI9000          * should never get here
            MOVE      NHMAURNO,PURNO
          ELSE
            MOVE      OLDURNO,KEY8
            CALL      RDMAST1                 * read NHI Master file
            BRANCH    OVRCD,CHKI9000          * should never get here
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          MOVE      PURNO,OURNO             * set OURNO for changeur
          MOVE      PURNO,OLDURNO           * set OLDURNO for changeur
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
.*        IF        PTCNNZUR<>1
.*          MOVE      PURNO,NEWURNO   * since already been allocated a UR
.*        ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CHKI9999
.
CHKI9000  MOVE      ONE,EXIT
          MOVE      "Old UR Number not found. ",WEBTITLE
          CALL      WEBERR00
          GOTO      CHKI9999
.
CHKI9999  RETURN
+
.------------------------------------------------------------
. Move Local Variable to National for UPDHCU or NEWHCU
. Routine from NHIWEB99
.----------------------------------------------------------------
LOCNHI00  MOVE     NHMASURN,NZIBSURN
          MOVE     NHMAGIV1,NZIBGIV1
.
          MATCH    SP70,NHMAGIV2
          IF       @EQUAL
            MOVE     "*",NZIBGIV2
          ELSE
            MOVE     NHMAGIV2,NZIBGIV2
          ENDIF
.
          MATCH    SP70,NHMAGIV3
          IF       @EQUAL
            MOVE     "*",NZIBGIV3
          ELSE
            MOVE     NHMAGIV3,NZIBGIV3
          ENDIF
.
          MATCH    SP70,NHMAETH2
          IF       @EQUAL
            MOVE     "*",NZIBETH2
          ELSE
            MOVE     NHMAETH2,NZIBETH2
          ENDIF
.
          MATCH    SP70,NHMAETH3
          IF       @EQUAL
            MOVE     "*",NZIBETH3
          ELSE
            MOVE     NHMAETH3,NZIBETH3
          ENDIF
.
          MOVE     NHMAPREI,NZIBPRNM
          MOVE     NHMAADD1,NZIBADD1
.
          MATCH    SP70,NHMAADD2
          IF       @EQUAL
            MOVE     "*",NZIBADD2
          ELSE
            MOVE     NHMAADD2,NZIBADD2
          ENDIF
.
          MATCH    SP70,NHMAADD3
          IF       @EQUAL
            MOVE     "*",NZIBSUBR
          ELSE
            MOVE     NHMAADD3,NZIBSUBR
          ENDIF
.
          MATCH    SP70,NHMAADD4
          IF       @EQUAL
            MOVE     "*",NZIBCITY
          ELSE
            MOVE     NHMAADD4,NZIBCITY
          ENDIF
.
          MATCH    SP70,NHMAADD5
          IF       @EQUAL
            MOVE     "*",NZIBCTRY
          ELSE
            MOVE     NHMAADD5,NZIBCTRY
          ENDIF
.
          MOVE     NHMADOB,NZIBDOB
.
          MATCH    SP70,NHMADDTH
          GOTO     LOCNHI10 IF NOT EQUAL
          MATCH    SP70,NZIBDDTH
          GOTO     LOCNHI10 IF EQUAL
          MOVE     "*",NZIBDDTH
          GOTO     LOCNHI20
.
LOCNHI10  MOVE     NHMADDTH,NZIBDDTH
LOCNHI20  MOVE     NHMADOMC,NZIBDOMC
          MOVE     NHMARES,NZIBRESI
          MOVE     NHMAETH,NZIBETHN
          MOVE     NHMASEX,NZIBSEX
.
. Not Using Alias Facility on NEWHCU SO Clear all Fields
.
          MOVE     ZERO,NZIBACNT      * assume no aliases

          MOVE     SP70,NZIBALSR[1]
          MOVE     SP70,NZIBALG1[1]
          MOVE     SP70,NZIBALG2[1]
          MOVE     SP70,NZIBALG3[1]
          MOVE     SP70,NZIBALPN[1]
          MOVE     SP70,NZIBALSR[2]
          MOVE     SP70,NZIBALG1[2]
          MOVE     SP70,NZIBALG2[2]
          MOVE     SP70,NZIBALG3[2]
          MOVE     SP70,NZIBALPN[2]
          MOVE     SP70,NZIBALSR[3]
          MOVE     SP70,NZIBALG1[3]
          MOVE     SP70,NZIBALG2[3]
          MOVE     SP70,NZIBALG3[3]
          MOVE     SP70,NZIBALPN[3]
          MOVE     SP70,NZIBALSR[4]
          MOVE     SP70,NZIBALG1[4]
          MOVE     SP70,NZIBALG2[4]
          MOVE     SP70,NZIBALG3[4]
          MOVE     SP70,NZIBALPN[4]
.
LOCNHI99  RETURN
.------------------------------------------------------------
. Routine from NHIWEB99
. Move National Variable to Local after UPDHCU or NEWHCU
.---------------------------------------------------------------
. This will set local variables after domicile coding and
. Name and address scrubbing has occured on the NHI.
.----------------------------------------------------------------
RETUP000  MOVE     NZIBSURN,NHMASURN
          MOVE     NZIBGIV1,NHMAGIV1
          MATCH    "*",NZIBGIV2
          IF       !@EQUAL
            MOVE     NZIBGIV2,NHMAGIV2
          ENDIF
          MATCH    "*",NZIBGIV3
          IF       !@EQUAL
            MOVE     NZIBGIV3,NHMAGIV3
          ENDIF
.
          MOVE     NZIBPRNM,NHMAPREI
          MOVE     NZIBADD1,NHMAADD1
.
          MATCH    "*",NZIBADD2
          IF       !@EQUAL
            MOVE     NZIBADD2,NHMAADD2
          ENDIF
.
          MATCH    "*",NZIBSUBR
          IF       !@EQUAL
            MOVE     NZIBSUBR,NHMAADD3
          ENDIF
.
          MATCH    "*",NZIBCITY
          IF       !@EQUAL
            MOVE     NZIBCITY,NHMAADD4
          ENDIF
.
          MATCH    "*",NZIBCTRY
          IF       !@EQUAL
            MOVE     NZIBCTRY,NHMAADD5
          ENDIF
.
          MOVE     NZIBDOMC,NHMADOMC
          MOVE     NZIBETHN,NHMAETH
.
          MATCH    "*",NZIBETH2
          IF       !@EQUAL
            MOVE     NZIBETH2,NHMAETH2
          ENDIF
.
          MATCH    "*",NZIBETH3
          IF       !@EQUAL
            MOVE     NZIBETH3,NHMAETH3
          ENDIF
.
RETUP999  RETURN
.------------------------------------------------------------
. Set Override Flag
.------------------------------------------------------------
OVRRID00  MOVE      ONE,EXIT
.
          MOVE      ADDRWARN,NZIBSCRB
          MOVE      UPDKWARN,NZIBUPDT
.
          MATCH     "MSM",OVERRIDE     * Name and Address Integrity
          IF        @EQUAL
            MOVE      "Y",NZIBSCRB
          ENDIF
          MATCH     "ADC",OVERRIDE     * Automated Domicile Code Warning
          IF        @EQUAL
            MATCH     SP70,NHMADOMC
            IF        @EQUAL
              BEEP
              MOVE      "Domicile Code must be entered for Override",WEBTITLE
              CALL      WEBERR00
              MOVE      ONE,EXIT       * Allow Mods to Fields
              GOTO      OVRRID99
            ENDIF
            MOVE      "Y",NZIBSCRB
          ENDIF
          MATCH     "DUP",OVERRIDE     * Duplicate Checking
          IF        @EQUAL
            MOVE      "Y",NZIBDUPL
          ENDIF
          MATCH     "UPD",OVERRIDE     * Update Key Fields Checking
          IF        @EQUAL
            MOVE      "Y",NZIBUPDT
          ENDIF
.
OVRRID99  RETURN
.------------------------------------------------------------
. Error Returned from NEWHCU
.------------------------------------------------------------
UPDERR00  MOVE      NZIBERRD,ERRTYPE
          MOVE      SP70,WARNMES
          MATCH     "MSM",ERRTYPE        * Name and Address Integrity
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Name and Address Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
.
          MATCH     "ADC",ERRTYPE        * Automated Domicile Code Warning
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Domicile Code Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
          MATCH     "DUP",ERRTYPE        * Duplicate Checking
          IF        @EQUAL
            MOVE      ANSY,DUPLWARN
            MOVE      "Duplicate Registration Warning",WARNMES
            GOTO      UPDERR90
          ENDIF
          MATCH     "UPD",ERRTYPE        * Update Key Fields Checking
          IF        @EQUAL
            MOVE      ANSY,UPDKWARN
            MOVE      "Update Key Fields Warning",WARNMES
            GOTO      UPDERR80
          ENDIF
          CALL      NZHISERR
          GOTO      UPDERR99
.
UPDERR80  CALL      OPENHTML
          BRANCH    EXIT,UPDERR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WARNMES,"\nClick Ok if you want to":
                   " Override Warning.#")) {":
                   "    parent.newreg.override.value=#"",ERRTYPE,"#"; ":
                   "    parent.newreg.addrwarn.value=#"",ADDRWARN,"#"; ":
                   "    parent.newreg.duplwarn.value=#"",DUPLWARN,"#"; ":
                   "    parent.newreg.updkwarn.value=#"",UPDKWARN,"#"; ":
                   "    parent.newreg.target=#"PopUpFrame#"; ":
                   "    parent.newreg.submit(); }":
                   "  else {":
    "  parent.document.getElementById('PopUpScreen').style.display='none'; }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      UPDERR99
.
UPDERR90  CALL      OPENHTML
          BRANCH    EXIT,UPDERR99
          REP       "#" ",NZIBERRD
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WARNMES,"\nClick Ok if you want to":
                   " Override Warning.#")) {":
                   "    parent.newreg.override.value=#"",ERRTYPE,"#"; ":
                   "    parent.newreg.addrwarn.value=#"",ADDRWARN,"#"; ":
                   "    parent.newreg.duplwarn.value=#"",DUPLWARN,"#"; ":
                   "    parent.newreg.updkwarn.value=#"",UPDKWARN,"#"; ":
                   "    parent.newreg.target=#"PopUpFrame#"; ":
                   "    parent.newreg.submit(); }":
                   "  else {":
                   "  parent.newreg.target=#"PopUpFrame#"; ":
                   "  parent.submitSearch(); }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      UPDERR99
.
UPDERR99  RETURN
.------------------------------------------------------------
. Error Returned from UPDHCU
.------------------------------------------------------------
UPHERR00  MOVE      NZIBERRD,ERRTYPE
          MOVE      SP70,WARNMES
          MATCH     "MSM",ERRTYPE        * Name and Address Integrity
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Name and Address Warning",WARNMES
            GOTO      UPHERR80
          ENDIF
.
          MATCH     "ADC",ERRTYPE        * Automated Domicile Code Warning
          IF        @EQUAL
            MOVE      ANSY,ADDRWARN
            MOVE      "Domicile Code Warning",WARNMES
            GOTO      UPHERR80
          ENDIF
          MATCH     "DUP",ERRTYPE        * Duplicate Checking
          IF        @EQUAL
            MOVE      ANSY,DUPLWARN
            GOTO      UPHERR99
          ENDIF
          MATCH     "UPD",ERRTYPE        * Update Key Fields Checking
          IF        @EQUAL
            MOVE      ANSY,UPDKWARN
            MOVE      "Update Key Fields Warning",WARNMES
            GOTO      UPHERR80
          ENDIF
          CALL      NZHISERR
          GOTO      UPHERR99
.
UPHERR80  CALL      OPENHTML
          BRANCH    EXIT,UPHERR99
          REP       "#" ",NZIBERRD
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                   "  var undefined;":
                   "  if (confirm(#"",WARNMES,"\n",NZIBERRD:
                   "\nClick Ok if you want to":
                   " Override Warning.#")) {":
                   "parent.UpdateForm.override.value=#"",ERRTYPE,"#"; ":
                   "parent.UpdateForm.addrwarn.value=#"",ADDRWARN,"#"; ":
                   "parent.UpdateForm.duplwarn.value=#"",DUPLWARN,"#"; ":
                   "parent.UpdateForm.updkwarn.value=#"",UPDKWARN,"#"; ":
.....              "parent.UpdateForm.target=#"PopUpFrame#"; ":
                   "parent.UpdateForm.target=#"_self#"; ":
                   "parent.UpdateForm.nextpage.value=4; ":
                   "parent.UpdateForm.submit(); }":
                   "  else {":
    " parent.document.getElementById('PopUpScreen').style.display='none'; }":
                   "}":
                   "</script>",012
.
          CALL      CLOSHTML
          GOTO      UPHERR99
.
.
UPHERR99  RETURN
.**********************************************************************
.*                            VLUR0000                                *
.*                   Validate the U/R Numbers                         *
.**********************************************************************
.
VLUR0000  MOVE      ZERO,EXIT
.
. -----   Check if Actual Merge is on File  (any status) -----
.
          PACK      KEY17,ONE,OLDURNO,NEWURNO,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      VLUR9100
          ENDIF
.
          PACK      KEY17,TWO,OLDURNO,NEWURNO,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      VLUR9100
          ENDIF
.
          PACK      KEY17,THREE,OLDURNO,NEWURNO,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      VLUR9100
          ENDIF
.
          PACK      KEY17,FOUR,OLDURNO,NEWURNO,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      VLUR9100
          ENDIF
.
VLUR1500
. -----   Check if New U/R Number is Already Requested to be Merged -----
. -----   as an Old U/R Number With a Status = 1 -----
.
          PACK      KEY17,ONE,NEWURNO,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,VLUR3000
.
          MATCH     NEWURNO,PTMROLUR
          GOTO      VLUR3000 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      VLUR9500 IF EQUAL
.
VLUR3000
. -----   Check if New U/R Number is Already Requested to be Merged -----
. -----   as an Old U/R Number With a Status = 2 -----
.
          PACK      KEY17,TWO,NEWURNO,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,VLUR4000
.
          MATCH     NEWURNO,PTMROLUR
          GOTO      VLUR4000 IF NOT EQUAL
.
          COMPARE   TWO,PTMRSTAT
          GOTO      VLUR9500 IF EQUAL
.
VLUR4000
. -----   Check if Old U/R Number is Already Requested to be Merged -----
. -----   as with a Status = 1 -----
.
          PACK      KEY17,ONE,OLDURNO,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,VLUR5000
.
          MATCH     OLDURNO,PTMROLUR
          GOTO      VLUR5000 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      VLUR9300 IF EQUAL
.
VLUR5000
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as with a Status = 2 -----
.
          PACK      KEY17,TWO,OLDURNO,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,VLUR6000
.
          MATCH     OLDURNO,PTMROLUR
          GOTO      VLUR6000 IF NOT EQUAL
.
          COMPARE   TWO,PTMRSTAT
          GOTO      VLUR9300 IF EQUAL
.
VLUR6000
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as a new U/R Number with a status = 1 -----
.
          PACK      KEY17,ONE,OLDURNO,SP20
          CALL      RSPTMRG2
          CALL      RKPTMRG2
          BRANCH    OVRCD,VLUR6500
.
          MATCH     OLDURNO,PTMRNWUR
          GOTO      VLUR6500 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      VLUR9600 IF EQUAL
.
VLUR6500
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as a new U/R Number with a status = 2 -----
.
          PACK      KEY17,TWO,OLDURNO,SP20 
          CALL      RSPTMRG2
          CALL      RKPTMRG2
          BRANCH    OVRCD,VLUR7000
.         
          MATCH     OLDURNO,PTMRNWUR
          GOTO      VLUR7000 IF NOT EQUAL
.         
          COMPARE   TWO,PTMRSTAT
          GOTO      VLUR9300 IF EQUAL
. 
VLUR7000  MOVE      ZERO,EXIT
          GOTO      VLUR9999
.
VLUR9100  MOVE      "Request already on file. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9200  MOVE    "Merge already requested, use Approve/Reject Option.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9300  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    OLDURNO,WEBTITLE
          APPEND    " already on file. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9400  MOVE      "Patient Missing off NHI link file.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9500  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    NEWURNO,WEBTITLE
          APPEND    " already on file. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9600  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    OLDURNO,WEBTITLE
          APPEND    " already on file as the New U/R for ",WEBTITLE
          APPEND    PTMROLUR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLUR9999
.
VLUR9999  RETURN
+
.**********************************************************************
.*  UPDNAT000  :  update national system                              *
.**********************************************************************
UPDNAT00  CALL      LOCNHI00        * Move Variables
          UNPACK    NEWURNUM,DIM1,NZIBNMPI
          MOVE      " ",NZIBSCRB     * Clear Overide Flags
          MOVE      " ",NZIBDUPL
          MOVE      " ",NZIBUPDT
.
UPDNAT60  MOVE      "Y",NZIBDUPL
          MATCH     SP70,OVERRIDE
          CALL      OVRRID00 IF NOT EQUAL
          PACK      NMPNUMB,SP10,SP3,NZIBNMPI
          CALL      UPDHCU
          BRANCH    OVRCD,UPDNAT90
.
          MOVE      ZERO,EXIT
          GOTO      UPDNAT99
.
UPDNAT90  CALL      UPHERR00
          MOVE      ONE,EXIT              * Return to Input Screen
.
UPDNAT99  RETURN
+
.----------------------------------------------------------------
. Move Local Variable to National for UPDHCU or NEWHCU
.----------------------------------------------------------------
MVNHIMAS  MOVE     NHMASURN,NZIBSURN
          MOVE     NHMAGIV1,NZIBGIV1
          MOVE     NHMAGIV2,NZIBGIV2
          MOVE     NHMAGIV3,NZIBGIV3
          MOVE     NHMAPREI,NZIBPRNM
          MOVE     NHMAADD1,NZIBADD1
          MOVE     NHMAADD2,NZIBADD2
          MOVE     NHMAADD3,NZIBSUBR
          MOVE     NHMAADD4,NZIBCITY
          MOVE     NHMAADD5,NZIBCTRY
          MOVE     NHMADOB,NZIBDOB
          MOVE     NHMADDTH,NZIBDDTH
          MOVE     NHMADOMC,NZIBDOMC
          MOVE     NHMARES,NZIBRESI
          MOVE     NHMAETH,NZIBETHN
          MOVE     NHMASEX,NZIBSEX
.
. Not Using Alias Facility on NEWHCU SO Clear all Fields
.
          MOVE     ZERO,NZIBACNT      * assume no aliases
          MOVE     SP70,NZIBALSR[1]
          MOVE     SP70,NZIBALG1[1]
          MOVE     SP70,NZIBALG2[1]
          MOVE     SP70,NZIBALG3[1]
          MOVE     SP70,NZIBALPN[1]
          MOVE     SP70,NZIBALSR[2]
          MOVE     SP70,NZIBALG1[2]
          MOVE     SP70,NZIBALG2[2]
          MOVE     SP70,NZIBALG3[2]
          MOVE     SP70,NZIBALPN[2]
          MOVE     SP70,NZIBALSR[3]
          MOVE     SP70,NZIBALG1[3]
          MOVE     SP70,NZIBALG2[3]
          MOVE     SP70,NZIBALG3[3]
          MOVE     SP70,NZIBALPN[3]
          MOVE     SP70,NZIBALSR[4]
          MOVE     SP70,NZIBALG1[4]
          MOVE     SP70,NZIBALG2[4]
          MOVE     SP70,NZIBALG3[4]
          MOVE     SP70,NZIBALPN[4]
.
          RETURN
+
.**********************************************************************
.*  UDET0000  :  update details                                       *
.**********************************************************************
UDET0000  IF        PTCNNHII=1
            CALL      UNHI0000                 * update NHI record
            BRANCH    EXIT,UDET9999
          ENDIF
.
          MATCH     NEWURNO,OURNO
          GOTO      UDET9999 IF EQUAL
.
          CALL      NPMI0000                 * Write new PMI records
          MOVE      ONE,CMERGEUR             * save old details to correct ur
.
          CALL      WRIT0000                 * Write to patmrgaf-merge requested
.
          COMPARE   TWO,MRCNNOHS             * Check for multiple databases
          GOTO      UDET8000 IF LESS
.
.         Multiple databases - loop through hospital file and execute their
.                              RUN macro.
.
          CALL      VALD0000
          CALL      VLDTE000                 * Validate U/R's (from CHANGEUR)
          BRANCH    EXIT,UDET9999,UDET9999   * not valid
          CALL      RDPARM00                 * Read control file (from CHANGEUR)
.
          PREP      TEMP1,FNAMER
          MOVE      OURNO,PTMROLUR
          MOVE      NEWURNO,PTMRNWUR
          CALL      WRTEMP1                  * Write the record to tempfile
.
          CALL      HOSP0000                 * Loop over hospital file and exec.
.                                            * their RUN macro
.
          CALL      COMM0000                 * Execute on the common files
          GOTO      UDET9000
.
UDET8000  CALL      VALD0000
          CALL      CHANGEUR                 * change OURNO to NEWURNO
.
UDET9000  PACK      KEY17,ONE,OLDURNO,NEWURNO,SP70
          CALL      RDPTMRG1
          MOVE      THREE,PTMRSTAT           * update status to merged
          CALL      UPPTMRG1
          CALL      WESIM000
          MOVE      ZERO,EXIT
.
UDET9999  RETURN
+
.------------------------------------------------------------
. Validate U/R
.------------------------------------------------------------
VALD0000  MOVE      ZERO,EXIT
          MOVE      OLDURNUM,KEY8           * old U/R
          CALL      CHKU0000                * check if master file locked/merge
          BRANCH    EXIT,VALD9999
          CALL      NEWS0000                * Check soundex surname
.
          MOVE      NEWURNUM,KEY8           * new U/R
          CALL      CHKU0000                * check if master file locked/merge
          BRANCH    EXIT,VALD9000
          CALL      NEWS0000                * Check soundex surname
          GOTO      VALD9999
.
VALD9000  MOVE      OLDURNUM,KEY8
          CALL      UUPTMAS1
VALD9999  RETURN
.
.------------------------------------------------------------
. Routine to handle new surname file
.------------------------------------------------------------
NEWS0000  MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          MOVE      PBDATE,GSRDOB
          MOVE      PSEX,GSRSEX
          CALL      SOUNDEX                 * get soundex key for surname
          CALL      SOUNDX2                 * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                * check if its already there
          BRANCH    OVRCD,NEWS1000
          GOTO      NEWS9999
.
NEWS1000  CALL      WRPTGSR1
NEWS9999  RETURN
.------------------------------------------------------------
. Check if master record locked
.------------------------------------------------------------
CHKU0000  RESET     KEY8
          MATCH     SP8,KEY8
          GOTO      CHKU2000 IF NOT EQUAL
.
          PACK      WEBTITLE,SP70,SP70
          CLEAR     WEBTITLE
          APPEND    "U/R Number is not entered. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKU9999
.
CHKU2000 
.         CALL      RLPTMAS1
.         IF        OVRCD=2
.           PACK      WEBTITLE,SP70,SP70
.           CLEAR     WEBTITLE
.           APPEND    "Patient U/R Number: ",WEBTITLE
.           APPEND    KEY8,WEBTITLE
.           APPEND    " is locked",WEBTITLE
.           RESET     WEBTITLE
.           CALL      WEBERR00
.           MOVE      ONE,EXIT
.         ENDIF
.
.         CALL      CLPMSPX2
.         MOVE      PURNO,KEY8
.         CALL      RDPMPX21
.
CHKU9999  RETURN
.*************************************************************************
. UNHI0000 : Update NHIMAS file
.*************************************************************************
UNHI0000  MATCH     NEWURNO,OURNO              * set up U/R Number
          IF        !@EQUAL
            PACK      KEY8,NEWURNO
            CALL      RDNHMAS2
            COMPARE   ZERO,OVRCD
            GOTO      UNHI9100 IF EQUAL
.**         GOTO      UNHI3000 IF NOT EQUAL
.**         PACK      KEY8,NEWURNO
.**         CALL      DENHMAS2
          ENDIF
.
UNHI3000  PACK      KEY8,OURNO                    * get old record (temporary)
          CALL      RDNHMAS2
          BRANCH    OVRCD,UNHI9000                * should never get here
.
          MATCH     NZIBNMPI,NHMANMPI              * set up U/R Number
          IF        !@EQUAL
            PACK      KEY7,NZIBNMPI
            CALL      RDNHMAS1
            COMPARE   ZERO,OVRCD
            GOTO      UNHI9200 IF EQUAL
.**         GOTO      UNHI4000 IF NOT EQUAL
.**         PACK      KEY7,NZIBNMPI
.**         CALL      DENHMAS1
          ENDIF
.
UNHI4000  PACK      KEY8,OURNO                    * get old record (temporary)
          CALL      RDNHMAS2
          BRANCH    OVRCD,UNHI9000                * should never get here
.
          UNPACK    NEWURNO,D1,NHMANMPI            * set up 7 char NMPI Number
          MOVE      NEWURNO,NHMAURNO              * set up U/R Number
.
          CALL      RETUP000                      * Return Updated Fields
.
          CALL      UPNHMAS2
          GOTO      UNHI9999
.
UNHI9000  MOVE      "Old UR Number not found. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNHI9999
.
UNHI9100  
..        MOVE      "New UR Already on NHI master. ",WEBTITLE
..        CALL      WEBERR00
..        MOVE      ONE,EXIT
          GOTO      UNHI9999
.
UNHI9200  MOVE      "New HCU ID Already on NHI master. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNHI9999
.
UNHI9999  RETURN
.*************************************************************************
. NPMI0000 : Write new PMI records, surname records
.*************************************************************************
NPMI0000  MOVE      OURNO,KEY8
          CALL      RDMAST1
          MOVE      NEWURNO,PURNO          * set the new U/R number
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ZEROVISN,PVIBILL            * clear the visit number
          MOVE      THREE,PVITYPE           * set as inpatients
          CALL      SETPMI00                * Setup NHI PMI Variables
          PACK      KEY8,PURNO
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          CALL      WRTUR
.
          CALL      WEXP0000                * Write expected payor details
.
.**       IF        PTCNNZUR=1
.**          CLEAR     WEBTITLE
.**          APPEND    "New patient U/R is ",WEBTITLE
.**          APPEND    NEWURNO,WEBTITLE
.**          RESET     WEBTITLE
.**          CALL      WEBERR00
.**       ENDIF
.
NPMI9999  RETURN
.----------------------------------------------------------------------
. Update Patient Masterfile
.----------------------------------------------------------------------
SETPMI00  MOVE      NHMADOMC,PPOST
          UNPACK    SP70,PADD1,PADD2
          UNPACK    SP70,PSUBRB,PADD4
          MOVE      NHMAADD1,PADD1
.
          REP       UPPLOW,NHMAADD1
          REP       UPPLOW,NHMAADD2
          REP       UPPLOW,NHMAADD3
          REP       UPPLOW,NHMAADD4
          REP       UPPLOW,NHMAADD5
.
          MOVE      NHMAADD2,PADD2
          MOVE      NHMAADD3,PSUBRB
          MOVE      NHMAADD4,PADD4
          MATCH     SP70,NHMAADD5
          IF        !@EQUAL
            STRIP     PADD4
            PACK      PADD4,PADD4,COMMA,SP1,NHMAADD5
          ENDIF
.
SETPMI99  RETURN
.
.**********************************************************************
.*  HOSP0000  :  Execute hospital dependant files                     *
.**********************************************************************
HOSP0000  PACK      KEY4,SP30
          CALL      RDSHOSP1
HOSP0100  CALL      RDKHOSP1
          BRANCH    OVRCD,HOSP9999
.
          CMATCH    ANSI,PTHOACTV
          GOTO      HOSP0100 IF EQUAL       * ignore inactive hospitals
.
          MOVE      HOSDESC,CNAME
          CLEAR     CMDLINE                 * Get Hospital dependent RUN macro
          APPEND    HOSRUN,CMDLINE          * and append merge program 1 space
          ENDSET    CMDLINE                 * after end of RUN macro
.
HOSP1000  CMATCH    SP1,CMDLINE
          GOTO      HOSP2000 IF NOT EQUAL
.
          BUMP      CMDLINE,-1
          GOTO      HOSP0100 IF EOS         * No RUN macro on file
          GOTO      HOSP1000
.
HOSP2000  APPEND    SP1,CMDLINE
          APPEND    CHAINPRG,CMDLINE        * Run Second Merger program to
          RESET     CMDLINE                 * merge hos. dependent files
.
          EXECUTE   CMDLINE,TASKID
          GOTO      HOSP0100
.
HOSP9999  RETURN
.**********************************************************************
.*  COMM0000  :  Execute common files                                 *
.**********************************************************************
COMM0000  PROC      FIXMAS                * Fix Master file
          PROC      FIXPAD                * Change U/R for PADPADFD
          PROC      FIXNMP                * National Master Patient Index file
          PROC      FIXAXE                * Update pataxe with national id.
          PROC      FIXSUR                * Surname Index file
          PROC      FIXURA                * U/R Changes Audit file
.
          PROC      FIXCSLF               * case notes location file
          PROC      FIXLNK                * Link File
          PROC      FIXALR                * Alerts File
          PROC      FIXKWC                * kiwicard file
.         PROC      FIXMRT                * Medical record tracking file
          PROC      FDNR0000              * Fix Donor file
.
          PROC      MRGUREOC              * EOC & ACC
.
          PROC      DELMRG00              * Delete or Merge U/R?
          PROC      PATCOM00              * Change U/R for PATCOMFD
.
          CALL      RLUR0000              * Release U/R numbers
          RETURN
.
.**********************************************************************
.*  RLUR0000  :  Release the U/R numbers                              *
.**********************************************************************
RLUR0000  IF        PTCNNHII=1
            MOVE      "U/R number successfully changed. ",WEBTITLE
            CALL      WEBERR00
          ENDIF
.
          MOVE      NEWURNO,KEY8
          CALL      UUPTMAS1              * Release the new U/R
          IF        CMERGURS = 1 & EXISTFL = 0
            MOVE      OURNO,KEY8
            CALL      UUPTMAS1
          ENDIF
.
.         Re-read the new U/R record before broadcasting any messages
.
          MOVE      NEWURNO,KEY8
          CALL      RDMAST1
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      OURNO,OLDURNO
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICMR                * send merge details to DG
          RETURN
.
WERR0000  RETURN                    * dummy routine for change U/R
+
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      MLST0000    * List of merges
          GOTO      PROFLD99
.
PROFLD13  CALL      MISC0000    * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      MRRQ0000    * Merge Requests
          GOTO      PROFLD99
.
PROFLD22  CALL      MISC0000    * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      TLST0000    * Temporary List
          GOTO      PROFLD99
.
PROFLD32  CALL      MISC0000    * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD42  CALL      SXGL0000    * SX G/L Extract
          GOTO      PROFLD99
.
.
PROFLD99  RETURN
+
.------------------------------------------------------------
.         SX G/L Extract Transaction
.------------------------------------------------------------
SXGL0000  BRANCH    FLDITMNO,SXGL0100
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      SXGL9999
.
SXGL0100  CALL      GLEX0000           * G/L Extract List
          GOTO      SXGL9999
.
SXGL9999  RETURN
+
.------------------------------------------------------------
.         List of G/L Extract
.------------------------------------------------------------
GLEX0000  OPEN      NZPEXTA2,"nzpextaf"
          PACK      KEY30,ADMISSNO,SP70
          CALL      RSNZEXT2
GLEX1000  CALL      RKNZEXT2
          BRANCH    OVRCD,GLEX9999
.
          MATCH     ADMISSNO,NZEXADMN
          GOTO      GLEX9999 IF NOT EQUAL
.
          MOVE      SP70,KEY20
          IF        NZEXRTYP=1
            MOVE      "Accommodation",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=2
            MOVE      "Theatre Charges",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=3
            MOVE      "Fees Invoiced Charges",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=4
            MOVE      "Procedure/Doctor Fees",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=5
            MOVE      "Cash Receipt",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=6
            MOVE      "Journal Entry",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=7
            MOVE      "Rounding",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=8
            MOVE      "GST",KEY20
            GOTO      GLEX2000
          ENDIF
          IF        NZEXRTYP=9
            MOVE      "Debtor Control Line",KEY20
            GOTO      GLEX2000
          ENDIF
.
GLEX2000  MOVE      " (",KEY2
          MOVE      ")",KEY1
          PACK      KEY25,NZEXRTYP,KEY2,KEY20,KEY1,SP70
          PACK      KEY14,NZEXINVN,NZEXTRNO,SP70
          WRITE     HTMLFILE;"t.addRow(#"",NZEXBTID,"#",":
                             "#"",NZEXINVN,"#",":
                             "#"",NZEXTRNO,"#",":
                             "#"",KEY25,"#",":
                             "#"",NZEXDESC,"#",":
                             "#"",NZEXTDAT,"#",":
                             "#"",NZEXRCNO,"#",":
                             "#"",NZEXCAMT,"#",":
                             "#"",NZEXDAMT,"#");"
          GOTO      GLEX1000
.
GLEX9999  RETURN
+
.------------------------------------------------------------
. List of Merged records
.------------------------------------------------------------
MLST0000  PACK      KEY17,THREE,URNUMBER,SP70
          CALL      RSPTMRG2
MLST1000  CALL      RKPTMRG2
          BRANCH    OVRCD,MLST9999
.
          MATCH     PTMRNWUR,URNUMBER
          GOTO      MLST9999 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:deletePatient('",HTMLLINK
          APPEND    PTMROLUR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,REQUSER
          MATCH     SP70,PTMRUSER
          IF        !@EQUAL
            PACK      KEY10,PTMRUSER,SP70
            CALL      RDWBSE1
            PACK      REQUSER,WBSENAM,SP70
          ENDIF
.
          MOVE      SP70,PTMXRDAT
          PACK      KEY8,PTMROLUR,SP70
          CALL      RDPTMSX1
.
          CALL      OPPASS1
          PACK      KEY4,PTMXOPER,SP70
          CALL      RDPASS1
          IF        OVRCD=1
            MOVE      SP70,SECUSER
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                            "#"",PTMROLUR,"#",":
                            "#"",PTMRRDTE,"#",":
                            "#"",PTMXRDAT,"#",":
                            "#"",REQUSER,"&nbsp;#",":
                            "#"",SECUSER,"&nbsp;#")"
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPTMSX1
          GOTO      MLST1000
.
MLST9999  RETURN
+
.------------------------------------------------------------
. Miscellaneous outputs
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      MISC9999
.
MISC0100  READ      CONTROLF,TWENTY1;*138,PTCNNHII
          WRITE     HTMLFILE;PTCNNHII;        * nhi interface
          GOTO      MISC9999
.
MISC0200  WRITE     HTMLFILE;MRGESTAT;
          GOTO      MISC9999
.
MISC0300  WRITE     HTMLFILE;PTMROLUR;
          GOTO      MISC9999
.
MISC0400  WRITE     HTMLFILE;PTMRNWUR;
          GOTO      MISC9999
.
MISC0500  PACK      KEY4,PTMRRHOS,SP70
          CALL      RDHOSP1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;HOSDESC;
          GOTO      MISC9999
.
MISC0600  MATCH     SP70,PTMRRDTE
          GOTO      MISC9999 IF EQUAL
          GOTO      MISC9999 IF EOS
          UNPACK    PTMRRDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC0700  LOAD      MRGSTAT,PTMRSTAT,MRGSTAT1,MRGSTAT2,MRGSTAT3,MRGSTAT4
          WRITE     HTMLFILE;MRGSTAT;
          GOTO      MISC9999
.
MISC0800  WRITE     HTMLFILE;PTMRAPPR;
          GOTO      MISC9999
.
MISC0900  WRITE     HTMLFILE;PTMRSTAT;
          GOTO      MISC9999
.
MISC1000  MOVE      CHOSINDX,FORM2
          ENDSET    PTMRAPPR
          RESET     PTMRAPPR,FORM2
          MOVE      PTMRAPPR,DIM1
.
          REP       "Y1N2 3",DIM1
          MOVE      DIM1,FORM1
.
          LOAD      APPRDESC,FORM1,APPRV1,APPRV2,APPRV3
          WRITE     HTMLFILE;APPRDESC;
          GOTO      MISC9999
.
MISC1100  MATCH     "1",PTMRSENT
          IF        @EQUAL
            WRITE     HTMLFILE;DYES;
          ELSE
            WRITE     HTMLFILE;DNO;
          ENDIF
          GOTO      MISC9999
.
MISC1200  WRITE     HTMLFILE;OLDURNUM;
          GOTO      MISC9999
.
MISC1300  MATCH     SP70,NEWURNUM
          IF        !@EQUAL
            WRITE     HTMLFILE;NEWURNUM;
          ELSE
            WRITE     HTMLFILE;URNUMBER;
          ENDIF
          GOTO      MISC9999
.
MISC9999  RETURN
+
.------------------------------------------------------------
. List of Merge Requests
.------------------------------------------------------------
MRRQ0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP70,MRGESTAT
          GOTO      MRRQ9999 IF EQUAL
          GOTO      MRRQ9999 IF EOS
.
          PACK      KEY17,MRGESTAT,SP70
          CALL      RSPTMRG1
MRRQ0100  CALL      RKPTMRG1
          BRANCH    OVRCD,MRRQ9999
.
          MATCH     MRGESTAT,DPTMRSTA
          GOTO      MRRQ9999 IF NOT EQUAL
.
          MOVE      PTMROLUR,URNUMBER
          CALL      GETPAT00
          CALL      PATLN000
.
          MOVE      SP70,HOSPREQ
          PACK      KEY4,PTMRRHOS,SP70
          CALL      RDHOSP1
          IF        OVRCD=0
            MOVE      HOSDESC,HOSPREQ
          ENDIF
          LOAD      MRGSTAT,PTMRSTAT,MRGSTAT1,MRGSTAT2,MRGSTAT3,MRGSTAT4
          MOVE      DNO,MRGSENT
          MATCH     "1",PTMRSENT
          IF        @EQUAL
            MOVE      DYES,MRGSENT
          ENDIF
.
          REP       " +",URNUMBER
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    PTMRSTAT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTMROLUR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTMRNWUR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PTMRNWUR,"#",":
                             "#"",HOSPREQ,"#",":
                             "#"",PTMRRDTE,"#",":
                             "#"",MRGSTAT,"#",":
                             "#"",PTMRAPPR,"#",":
                             "#"",MRGSENT,"#");"
.
          GOTO      MRRQ0100
.
MRRQ9999  RETURN
+
.------------------------------------------------------------
. List of Temporary NHI numbers
.------------------------------------------------------------
TLST0000  PACK      KEY7,TMPURFLG,SP70
          CALL      RSNHMAS1
TLST0100  CALL      RKNHMAS1
          BRANCH    OVRCD,TLST2000
.
          MATCH     TMPURFLG,NHMANMPI        * Temporary National Number?
          GOTO      TLST2000 IF NOT EQUAL    * no, we have finished!
.
          PACK      KEY8,NHMAURNO
          CALL      RDMAST1
          BRANCH    OVRCD,TLST0100
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          BRANCH    PSTAT,TLST0100           * ignore if already merged
.
          CALL      DISROW00
          GOTO      TLST0100
.
TLST2000  MOVE      "$",KEY1
          PACK      KEY7,KEY1,SP70
          CALL      RSNHMAS1
TLST2100  CALL      RKNHMAS1
          BRANCH    OVRCD,TLST9999
.
          MATCH     "$",NHMANMPI             * Temporary National Number?
          GOTO      TLST9999 IF NOT EQUAL    * no, we have finished!
.
          PACK      KEY8,NHMAURNO
          CALL      RDMAST1
          BRANCH    OVRCD,TLST2100
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          BRANCH    PSTAT,TLST2100           * ignore if already merged
.
          CALL      DISROW00
          GOTO      TLST2100
.
TLST9999  RETURN
+
.------------------------------------------------------------
.         Display row of temporary UR number
.------------------------------------------------------------
DISROW00  RESET     NHMAURNO
          MOVE      NHMAURNO,URNUMBER
          CALL      GETPAT00
          CALL      PATLN000
.
          REP       " +",URNUMBER
          UNPACK    NHMADOB,ACC,AYY,AMM,ADD
          MOVE      AMM,F2
          LOAD      D3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                    NOV,DEC
          PACK      DISPDATE,ADD,SP1,D3,SP1,ACC,AYY
.
          MOVE      NHMASURN,JAVSNAME       * String to Convert
          CALL      JAVDES00                * Remove "'" replace with "%60"
          MOVE      JAVSNAME,NHMASURN
.
          CLEAR     HTMLLINK
          APPEND    "javascript:PatientSearch('",HTMLLINK
          APPEND    NHMAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NHMASURN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NHMAGIV1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NHMASEX,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PSAGEYRS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",NHMAURNO,"#",":
.**                          "#"",FORMATNM,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",NHMADOB,"#",":
                             "#"",PSAGEYRS,"#",":
                             "#"",DISPSEX,"#");"
.
DISROW99  RETURN
.
.------------------------------------------------------------
. Get Patient
.------------------------------------------------------------
GETPAT00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
          CALL      RDPMPX21
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00

GETPAT99  RETURN
+
.**********************************************************************
.*                            NWVL0000                                *
.*                   Validate the New U/R Number                      *
.**********************************************************************
.
NWVL0000  MOVE      ZERO,EXIT
.
. -----   Check if Actual Merge is on File  (any status) -----
.
          PACK      KEY17,ONE,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      NWVL9100
          ENDIF
.
          PACK      KEY17,TWO,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      NWVL9100
          ENDIF
.
          PACK      KEY17,THREE,OLDURNUM,NEWURNUM,SP70
          CALL      RDPTMRG1
          IF        OVRCD<>1
            GOTO      NWVL9100
          ENDIF
.
          MATCH     ANSR,UPDTTYPE
          IF        @EQUAL
            PACK      KEY17,FOUR,OLDURNUM,NEWURNUM,SP70
            CALL      RDPTMRG1
            IF        OVRCD<>1
              GOTO      NWVL9100
            ENDIF
          ENDIF
.
NWVL1500
. -----   Check if New U/R Number is Already Requested to be Merged -----
. -----   as an Old U/R Number With a Status = 1 -----
.
          PACK      KEY17,ONE,NEWURNUM,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,NWVL3000
.
          MATCH     NEWURNUM,PTMROLUR
          GOTO      NWVL3000 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      NWVL9500 IF EQUAL
.
NWVL3000
. -----   Check if New U/R Number is Already Requested to be Merged -----
. -----   as an Old U/R Number With a Status = 2 -----
.
          PACK      KEY17,TWO,NEWURNUM,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,NWVL4000
.
          MATCH     NEWURNUM,PTMROLUR
          GOTO      NWVL4000 IF NOT EQUAL
.
          COMPARE   TWO,PTMRSTAT
          GOTO      NWVL9500 IF EQUAL
.
NWVL4000
. -----   Check if Old U/R Number is Already Requested to be Merged -----
. -----   as with a Status = 1 -----
.
          PACK      KEY17,ONE,OLDURNUM,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,NWVL5000
.
          MATCH     OLDURNUM,PTMROLUR
          GOTO      NWVL5000 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      NWVL9300 IF EQUAL
.
NWVL5000
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as with a Status = 2 -----
.
          PACK      KEY17,TWO,OLDURNUM,SP20
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,NWVL6000
.
          MATCH     OLDURNUM,PTMROLUR
          GOTO      NWVL6000 IF NOT EQUAL
.
          COMPARE   TWO,PTMRSTAT
          GOTO      NWVL9300 IF EQUAL
.
NWVL6000
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as a new U/R Number with a status = 1 -----
.
          PACK      KEY17,ONE,OLDURNUM,SP20
          CALL      RSPTMRG2
          CALL      RKPTMRG2
          BRANCH    OVRCD,NWVL6500
.
          MATCH     OLDURNUM,PTMRNWUR
          GOTO      NWVL6500 IF NOT EQUAL
.
          COMPARE   ONE,PTMRSTAT
          GOTO      NWVL9600 IF EQUAL
.
NWVL6500
. -----   Check if old U/R Number is Already Requested to be Merged -----
. -----   as a new U/R Number with a status = 2 -----
.
          PACK      KEY17,TWO,OLDURNUM,SP20 
          CALL      RSPTMRG2
          CALL      RKPTMRG2
          BRANCH    OVRCD,NWVL7000
.         
          MATCH     OLDURNUM,PTMRNWUR
          GOTO      NWVL7000 IF NOT EQUAL
.         
          COMPARE   TWO,PTMRSTAT
          GOTO      NWVL9300 IF EQUAL
. 
. make sure patient is on national system
.
NWVL7000  COMPARE   ONE,PTCNNHII
          IF        !@EQUAL
            PACK      KEY8,OLDURNUM
            CALL      RDMAST1
            BRANCH    OVRCD,NWVL9400
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            GOTO      NWVL8000
          ENDIF
          PACK      KEY8,OLDURNUM
          CALL      RDNHMAS2
          BRANCH    OVRCD,NWVL9400
.
          CALL      CONNECT
          BRANCH    OVRCD,NWVL9000
.
          MOVE      NHMANMPI,NZIBNMPI
          CALL      GETHCU
          BRANCH    OVRCD,NWVL9000
          CALL      DISCNNCT
.
          CALL      DCHG0000                      * check PMI Local vs National
          BRANCH    EXIT,NWVL9999                 * details diff. Dont continue
.
NWVL8000  COMPARE   ONE,PTCNNHII
          IF        !@EQUAL
            PACK      KEY8,NEWURNUM
            CALL      RDMAST1
            BRANCH    OVRCD,NWVL9400
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
.
            GOTO      NWVL9999
          ENDIF
          PACK      KEY8,NEWURNUM
          CALL      RDNHMAS2
          BRANCH    OVRCD,NWVL9400
.
          CALL      CONNECT
          BRANCH    OVRCD,NWVL9000
.
          MOVE      NHMANMPI,NZIBNMPI
          CALL      GETHCU
          BRANCH    OVRCD,NWVL9000
          CALL      DISCNNCT
.
          CALL      DCHG0000                      * check PMI Local vs National
          BRANCH    EXIT,NWVL9999                 * details diff. Dont continue
.
          MOVE      ZERO,EXIT
          GOTO      NWVL9999
.
NWVL9000  CALL      NZHISERR                    * display error message
          MOVE      TRUE,EXIT
.
NWVL9100  MOVE      "Request already on file. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9200  MOVE    "Merge already requested, use Approve/Reject Option.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9300  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    OLDURNUM,WEBTITLE
          APPEND    " already on file. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9400  MOVE      "Patient Missing off NHI link file.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9500  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    NEWURNUM,WEBTITLE
          APPEND    " already on file. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9600  CLEAR     WEBTITLE
          APPEND    "Request to Merge ",WEBTITLE
          APPEND    OLDURNUM,WEBTITLE
          APPEND    " already on file as the New U/R for ",WEBTITLE
          APPEND    PTMROLUR,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NWVL9999
.
NWVL9999  RETURN
+
.**********************************************************************
.*  DCHG0000  :  Check if details are different (Local vs National)   *
.**********************************************************************
DCHG0000  MATCH     NZIBSURN,NHMASURN             * same surname?
          GOTO      DCHG5000 IF NOT EQUAL         
          MATCH     NZIBSEX,NHMASEX               * same sex?
          GOTO      DCHG5000 IF NOT EQUAL         
          MATCH     NZIBDOB,NHMADOB               * same DOB?
          GOTO      DCHG8000 IF EQUAL             * all details are same 
. 
. the main details have changed so give user warning
.
DCHG5000  CLEAR     WEBTITLE
          APPEND    "Error: PMI details differ between Local ",WEBTITLE
          APPEND    "& National System for UR ",WEBTITLE
          APPEND    NHMAURNO,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
.
          MOVE      ONE,EXIT                      * dont continue
          GOTO      DCHG9999
.
DCHG8000  MOVE      ZERO,EXIT                     * continue with update
.
DCHG9999  RETURN
.**********************************************************************
.*                            WRIT0000                                *
.*                Writw a Request to the Request File                 *
.**********************************************************************
.
WRIT0000  MOVE      ZERO,EXIT
          MOVE      OLDURNUM,PTMROLUR
          MOVE      NEWURNUM,PTMRNWUR
.
          PACK      PTMRRDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTMRRDTE
.
          MOVE      CHOSINDX,DIM2
          PACK      KEY2,DIM2
          CALL      RDHOSP2
          MOVE      HOSCODE,PTMRRHOS
.
          MOVE      SP30,PTMRAPPR
          MOVE      CHOSINDX,HOSINDX             * Use Current Hospital Number
          SUB       ONE,HOSINDX
          RESET     PTMRAPPR,HOSINDX
          APPEND    ANSY,PTMRAPPR
          RESET     PTMRAPPR
          ADD       ONE,HOSINDX
.
          MOVE      ONE,PTMRSTAT
.
          PACK      PTMRSDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTMRSDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PTMRSTIM             * Last Status Change Time
          REP       " 0",PTMRSTIM
.
          MOVE      SP2,PTMRLOCK
          MOVE      ZERO,PTMRSENT
          PACK      PTMRUSER,WBSEUID,SP70
.
          CALL      WRPTMRG1
.
          PACK      KEY17,PTMRSTAT,PTMROLUR,PTMRNWUR
          CALL      RDPTMRG1
.
WRIT9999  RETURN
.
.**********************************************************************
.*                           NEWW0000                                 *
.*                      Determine New Status                          *
.**********************************************************************
.
NEWW0000  RESET     PTMRAPPR
          MOVE      PTMRAPPR,DIM20
          MOVE      CHOSINDX,FORM2
          SUB       ONE,FORM2
.
          RESET     DIM20,FORM2
          APPEND    ACTION,DIM20
          RESET     DIM20
.
          SCAN      ANSN,DIM20
          GOTO      NEWW1000 IF NOT EQUAL
.
          MOVE      FOUR,PTMRSTAT
          GOTO      NEWW9999
NEWW1000  MOVE      SP4,KEY4
          CALL      RDSHOSP1
NEWW2000  CALL      RDKHOSP1
          BRANCH    OVRCD,NEWW3000
.
          CMATCH    ANSI,PTHOACTV
          GOTO      NEWW2000 IF EQUAL            * ignore inactive hospitals
.
          RESET     PTMRAPPR,HOSINDX
          CMATCH    ANSY,PTMRAPPR
          GOTO      NEWW2000 IF EQUAL
.
          MOVE      ONE,PTMRSTAT
          GOTO      NEWW9999
NEWW3000  MOVE      TWO,PTMRSTAT
.
NEWW9999  RETURN
.
.**********************************************************************
.*                           UPDT0000                                 *
.*                 Update Status In Merger Record                     *
.**********************************************************************
.
UPDT0000  MOVE      CHOSINDX,FORM2
.
          MOVE      SP20,DIM20
          RESET     DIM20
          RESET     PTMRAPPR,FORM2
          BUMP      PTMRAPPR
          PACK      DIM20,PTMRAPPR,SP20
          RESET     DIM20
.
          SUB       ONE,FORM2
          RESET     PTMRAPPR,FORM2
          APPEND    ACTION,PTMRAPPR
          APPEND    DIM20,PTMRAPPR
          RESET     PTMRAPPR
UPDT8000  SCAN      ANSN,PTMRAPPR
          GOTO      UPDT8100 IF NOT EQUAL
          MOVE      FOUR,PTMRSTAT
          GOTO      UPDT9000
.
UPDT8100  MOVE      SP4,KEY4
          CALL      RDSHOSP1
UPDT8120  CALL      RDKHOSP1
          BRANCH    OVRCD,UPDT8150
.
          CMATCH    ANSI,PTHOACTV
          GOTO      UPDT8120 IF EQUAL            * ignore inactive hospitals
.
          RESET     PTMRAPPR,HOSINDX
          CMATCH    ANSY,PTMRAPPR
          GOTO      UPDT8120 IF EQUAL
.
          MOVE      ONE,PTMRSTAT
          GOTO      UPDT9000

.
. Request a merge on the national system if the merge has been approved by
. all hospitals (dont update merge status on local system until the NHI have
. approved the merge. Done in NHI10)
.
UPDT8150  IF        PTCNNHII=0
            GOTO      UPDT9999
          ENDIF
          CALL      GETNAT00
          BRANCH    EXIT,UPDT9999
          CALL      CONNECT
          CALL      MRGHCU
          CALL      DISCNNCT
          IF        OVRCD=1
            CALL      NZHISERR                    * display error message
          ENDIF
          MOVE      TWO,PTMRSTAT
          MOVE      ONE,PTMRSENT
.
UPDT9000  PACK      PTMRSDTE,CCC,CYY,CMM,CDD     * Last Status Change Date
          REP       " 0",PTMRSDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PTMRSTIM             * Last Status Change Time
          REP       " 0",PTMRSTIM
          CALL      UPPTMRG1
.
UPDT9999  RETURN
+
.------------------------------------------------------------
. Get National Details for Merge Request
.------------------------------------------------------------
GETNAT00  MOVE      NEWURNUM,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,GETNAT90
          IF        CMERGEUR=1
            MOVE      NHMANMPI,NZIBALNO
          ELSE
            MOVE      NHMANMPI,NZIBNMPI
          ENDIF
          MOVE      OLDURNUM,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,GETNAT90
          IF        CMERGEUR=1
            MOVE      NHMANMPI,NZIBNMPI
          ELSE
            MOVE      NHMANMPI,NZIBALNO
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETNAT99
.
GETNAT90  MOVE      "National Patient Details Missing",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
GETNAT99  RETURN
.
.------------------------------------------------------------
.    Save master fields - Used by PATCOMN2
.------------------------------------------------------------
ACTMSAV   MOVE      PMICRO,SPMICRO
          MOVE      PUSR1,SPUSR1
          MOVE      PUSR2,SPUSR2
          MOVE      PUSR3,SPUSR3
          MOVE      PUSR4,SPUSR4
          MOVE      PUSR5,SPUSR5
          MOVE      PUSR6,SPUSR6
          MOVE      PUYN1,SPUYN1
          MOVE      PUYN2,SPUYN2
          MOVE      PUYN3,SPUYN3
.
          MOVE      PURNO,SPURNO
          MOVE      PTITL,SPTITL
          MOVE      PSNAME,SPSNAME
          MOVE      PGNAME,SPGNAME
          MOVE      PPSNAME,SPPSNAME
          MOVE      PADD1,SPADD1
          MOVE      PADD2,SPADD2
          MOVE      PSUBRB,SPSUBRB
          MOVE      PPOST,SPPOST
          MOVE      PTELEP,SPTELEP
          MOVE      PTELEB,SPTELEB
          MOVE      PTMXDOFR,SPDOR
          MOVE      PSEX,SPSEX
          MOVE      PMSTAT,SPMSTAT
          MOVE      PBDATE,SPBDATE
          MOVE      PSAGE,SPSAGE
          MOVE      PCONT,SPCONT
          MOVE      PREG,SPREG
          MOVE      PTYPE,SPTYPE
          MOVE      POCCUP,SPOCCUP
          MOVE      PMEDI,SPMEDI
          MOVE      PPENNO,SPPENNO
          MOVE      PPNDTE,SPPNDTE
          MOVE      PREPAT,SPREPAT
          MOVE      PSMOK,SPSMOK
.
.-------- Save Community Card Details ---------------------------------
.
          MOVE      PTMXCARD,SPCARD
          MOVE      PTMXCEXP,SPCEXP
          MOVE      PTMXCXMP,SPCXMP
          MOVE      PTMXFMLY,SPFMLY
.
          MOVE      PNKNAME,SPNKNAME
          MOVE      PNKADD1,SPNKADD1
          MOVE      PNKADD2,SPNKADD2
          MOVE      PNKSUBR,SPNKSUBR
          MOVE      PNKPOST,SPNKPOST
          MOVE      PNKTELP,SPNKTELP
          MOVE      PNKTELB,SPNKTELB
          MOVE      PNKRELP,SPNKRELP
          RETURN
.
.------------------------------------------------------------
. Format Description/Name (for Javascript)
.*** format the surname and given name by changing any ' to %60
.---------------------------------------------------------------
JAVDES00  SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVDES99 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted string
.
JAVDES99  RETURN
.
.------------------------------------------------------------
. Write to ESIS merge table
.------------------------------------------------------------
WESIM000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESIM999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY16,OLDURNUM,Z70
          CALL      RSWTESP1
          CALL      RPWTESP1
          BRANCH    OVRCD,WESIM999
.
          MATCH     OLDURNUM,WTEPURNO
          GOTO      WESIM999 IF NOT EQUAL
.
          PACK      WTEMEDAT,SP70
          PACK      WTEMCURN,OLDURNUM
          PACK      WTEMRURN,NEWURNUM
.
          PACK      KEY24,WTEMCURN,WTEMRURN,WTEMEDAT,SP70
          CALL      RDWTESM1
          IF        OVRCD=1
            CALL      WRWTESM1
          ENDIF
.
          CALL      WESP0000
.
WESIM999  RETURN
+
.******************************************************************************
.*                                 WESP0000                                   *
.*                          Write/update watespaf                             *
.******************************************************************************
.
WESP0000  COMPARE   THREE,PTCNHDPS
          GOTO      WESP0999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY16,NEWURNUM,Z70
          CALL      RSWTESP1
          CALL      RPWTESP1
          BRANCH    OVRCD,WESP0100
.
          MATCH     NEWURNUM,WTEPURNO
          GOTO      WESP0100 IF NOT EQUAL
.
          CALL      CHKESI00
          BRANCH    EXIT,WESP0999   * no changes
          GOTO      WESP0200
.
WESP0100  CALL      CLRWTESI
.
WESP0200  PACK      WTEPURNO,NEWURNUM
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,PBDATE,SP70
          PACK      WTEPEDOB,PMPXEDOB,SP70
          PACK      WTEPPSEX,PSEX,SP70
          PACK      WTEPMEDI,PMEDI,SP70
          SQUEEZE   PTMXMCCD
          PACK      WTEPMREF,PTMXMCCD,SP70
          PACK      WTEPRESI,PTYPE,SP70
          PACK      WTEPPOST,PPOST,SP70
          PACK      WTEPSUBR,PSUBRB,SP70
          PACK      WTEPABRG,PMPXABRG,SP70
          PACK      WTEPPGEN,PMPXUCC4,SP70
.
          CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
WESP0280  CALL      RKPMCCD1
          BRANCH    OVRCD,WESP0300
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      WESP0300 IF NOT EQUAL
.
          MATCH     XDATE,PMCDEXDT
          IF        !@LESS
            MATCH     "NDI",PMCDCTYP
            IF        @EQUAL
              PACK    WTEPNDIS,PMCDCNUM,SP70
            ENDIF
          ENDIF
          GOTO      WESP0280
.
WESP0300  PACK      WTEPSPAR,SP70
.
          PACK      KEY16,NEWURNUM,SP70
          CALL      RAWTESP1
          IF        OVRCD=1
            PACK      WTEPWEBC,WBSEUID,SP70
            PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPCDAT
            PACK      WTEPCTIM,CTIMEIS,SP70
            REP       " 0",WTEPCTIM
            CALL      WRWTESP1
          ELSE
            PACK      WTEPWEBU,WBSEUID,SP70
            PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS,SP70
            REP       " 0",WTEPUTIM
            CALL      UPWTESP1
          ENDIF
.
WESP0999  RETURN
.
.******************************************************************************
.*                                 CHKESI00                                   *
.*                 Check if any ESIS have changed since last sent             *
.******************************************************************************
.
CHKESI00  MOVE      ZERO,EXIT
.
          MATCH     WTEPPDOB,PBDATE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPEDOB,PMPXEDOB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPSEX,PSEX
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPMEDI,PMEDI
          GOTO      CHKESI90 IF NOT EQUAL
.
          SQUEEZE   PTMXMCCD
          MATCH     WTEPMREF,PTMXMCCD
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPRESI,PTYPE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPOST,PPOST
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPSUBR,PSUBRB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPABRG,PMPXABRG
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPGEN,PMPXUCC4
          GOTO      CHKESI90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESI90  GOTO      CHKESI99
.
CHKESI99  RETURN
+
CLRWTESI  PACK      WTEPURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,SP70
          PACK      WTEPMREF,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,SP70
          PACK      WTEPCDAT,SP70
          PACK      WTEPCTIM,SP70
          PACK      WTEPWEBU,SP70
          PACK      WTEPUDAT,SP70
          PACK      WTEPUTIM,SP70
          PACK      WTEPPGEN,SP70
          PACK      WTEPNDIS,SP70
          PACK      WTEPSPAR,SP70
.
          RETURN
.**********************************************************************
.*                       Temp File I/O Routines                       *
.**********************************************************************
.
WRTEMP1   WRITE     TEMP1,SEQ;PTMROLUR,PTMRNWUR
.
          RETURN
.
.******************************************************************************
.*                                 WREDW000                                   *
.* Write EDWARD UnMerge record                                                *
.******************************************************************************
WREDW000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          MOVE      OLDURNUM,PMEWURNO
          MOVE      "24",PMEWTYPE
.
          PACK      PMEWOLDV,URNUMBER,SP70,SP70,SP70,SP70
          PACK      PMEWNEWV,OLDURNUM,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMEWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEWCDAT
          CLOCK     TIME,PMEWCTIM
          PACK      PMEWCUID,USERID
          PACK      PMEWTYPE,PMEWTYPE,SP70
          PACK      PMEWSPAR,SP70,SP70
.
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RAPMEDW2
          IF        OVRCD=1
            CALL      WRPMEDW2
          ELSE
            CALL      UPPMEDW2
          ENDIF
.
WREDW999  RETURN
.
.------------------------------------------------------------
. Write out pmsnplaf record
.------------------------------------------------------------
WPMNPL00  MATCH     "3",PTCNUNET
          GOTO      WPMNPL99 IF NOT EQUAL
.
          CALL      CLPMSNPL
.
          MOVE      "09",PMNPRTYP
          MOVE      DIM8,PMNPURNO
          CALL      IBACLOCK
          PACK      PMNPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPRDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMNPRTIM
          MOVE      "   1",PMNPCNTR
.
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,PMNPHOSP
          ELSE
            OPEN      PATHSPA1,"pathspaf"
.
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD=0
              MOVE      PTHSHOSP,PMNPHOSP
            ENDIF
          ENDIF
.
          MOVE      USERID,PMNPRUID
          MOVE      "0",PMNPRSTA
          MOVE      PMNPRDAT,PMNPCDAT
          MOVE      PMNPRTIM,PMNPCTIM
          MOVE      PMNPRUID,PMNPCUID
.
          CALL      WRPMNPL1
.
WPMNPL99  RETURN
.
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
.
          INC       AAEDE1IO/INC       * A&E Details file      Defect 22698
          INC       ALLEDTIO/INC
          INC       ALLETXIO/INC
          INC       ALLLINIO/INC
          INC       ALLLONIO/INC
          INC       ALLPCTIO/INC
          INC       ALLREFIO/INC                             * Defect 22698
          INC       APSMASIO/INC
          INC       BOKRC1IO/INC                             * Defect 22698
          INC       EMRVISIO/INC                             * Defect 22698
          INC       LEGALTIO/INC       * Alternate Legacy file
          INC       LEGBOAIO/INC
          INC       LEGDEAIO/INC
          INC       LEGDSCIO/INC
          INC       LEGINVIO/INC
          INC       LEGMISIO/INC
          INC       LEGTRNIO/INC
          INC       LEGVISIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       MEHVI1IO/INC
          INC       OUTARTIO/INC                             * Defect 22698
          INC       OUTSITIO/INC
          INC       PATAM1IO/INC                             * Defect 22698
          INC       PATDO1IO/INC   * Doctor File
          INC       PATECDIO/INC
          INC       PATGSRIO/INC 
          INC       PATHOSIO/INC 
          INC       PATKWCIO/INC                             * Defect 22698
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATMRGIO/INC
          INC       PATNIDIO/INC                             * Defect 22698
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATALRIO/INC
          INC       PMSEDWIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSNPLIO/INC
          INC       PMSPX2IO/INC
          INC       PMSPTDIO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATDNRIO/INC                             * Defect 22698
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       PATAXEIO/INC                             * Defect 22698
          INC       PATINVIO/INC                             * Defect 22698
          INC       PATLINIO/INC                             * Defect 22698
          INC       PATLOCIO/INC                             * Defect 22698
          INC       PATPA1IO/INC                             * Defect 22698
          INC       PATURAIO/INC                             * Defect 22698
          INC       PATURCIO/INC                             * Defect 22698
          INC       PATTRNIO/INC                             * Defect 22698
          INC       PMSCURIO/INC                             * Defect 22698
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPAYIO/INC
          INC       PATIN1IO/INC
          INC       PATDSCIO/INC
          INC       TMPALIIO/INC
          INC       VISPAYIO/INC
          INC       WATTR1IO/INC                             * Defect 22698
          INC       WATTX1IO/INC                             * Defect 22698
          INC       WATESPIO/INC
          INC       WATESMIO/INC
          INC       PATHSPIO/INC
          INC       NZPEXTIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSTSPIO/INC
          INC       PMSUPDIO/INC
          INC       PMSEHBIO/INC
.
          INC       NZHISWIO
          INC       NZHISWUP
          INC       PATCOMN2                                  * Defect 22698
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPMSPAY
          INC       CLPMSPX2
          INC       CLVISPAY
          INC       CLPMSNPL
          INC       DGCLICMR                                  * Defect 22698
          INC       DGCLIUMR
          INC       EXPPAYCD
          INC       PATNAMCD
          INC       PATMASTM
          INC       PATDOCTM
          INC       PMIGTNID                                  * Defect 22698
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATDSCTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATDOCCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       SVPMSPX2                                  * Defect 22698
          INC       WEBCHGUR                                  * Defect 22698
          INC       PMSOSDTM

