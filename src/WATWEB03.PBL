.----------------------------------------------------------------------
. Program       : WATWEB03
.
. Function      : Waiting List Print Server 
.
. Modifications :
.
.--------------------------------------------------------------------------
. V12.00.01 05/09/2025  Thanh T           TSK 0949457    
.           Added LXPUSRAC-LXPUSRIL fields
.           Moved all LX fields to WATLETDF.PBL   
. V12.00.01 23/05/2025  Ebon Clements     TSK 0955096
.           Alphanueric visit number changes
.--------------------------------------------------------------------------
. V11.04.01 17/07/2024  Thanh T           TSK 0939648          
.           Added LXPXSN18-LXPXSN30 fields
. V11.03.02 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.03.01 15/08/2023  Don Nguyen     TSK 0935736
.           Recompiled for SMSPRXML - Skip inactive extra contacts for SMS
. V11.02.03 19/04/2022  Thanh T          TSK 0903453                  
.           Added LXPXUCC4, LXUCC4LD, LXPXATF1, LXPXUCC5, LXUCC5LD and
.           LXPXATF2 fields                                           
. V11.02.02 21/03/2022  Sunny          TSK 0905914 
.           Added %arddate (LXARDATE) - Administrative Registration Date 
. V11.02.01 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes
. V11.01.02 28/06/2021  Sunny            TSK 0893817                         
.           Added %systype - PTCNSTYP (LCSYSTYP/LXSYSTYP)      
. V11.01.01 02/07/2021  Ebon Clements    TSK 0900650
.           Recompiled for SMSPRXML
. V11.00.06 16/07/2020  Tracey Nguyen    TSK 0893621
.           Added %smsusrnm (LCCSMSUN/LXXSMSUN)
. V11.00.05 08/04/2020  Thanh T          TSK 0879163 
.           Changed SET0182 for Sex category changes 
. V11.00.04 20/03/2020  Peter Vela       TSK 0889143
.           Fixed WATLET IO calls
. V11.00.03 19/03/2020  Peter Vela       Task 0889143
.           Recompiled for WATLETFD
. V11.00.02 03.03.220   Ken Bell         TSK 0886979
.           At Label SET8600 it should be clearing LXUDEF5 - LXUDEF8
. V11.00.01 03/03/2020  Peter Vela       TSK 0886979
.           Added work variable for PNKNAME for waiting list letters
.           04/03/2019  Ken Bell         TSK 0869019
.           If no bokrc1af exists, call CLBKRX00 for BKRX variables
.           to avoid reprinted values from previous printed letter.
.           Set the following LX values spaces prior to each Letter
.             LXREADOC Attending Doctor
.             LXRESDOC Referring Doctor
.             LXRETYPE Booking Type
.             LXRECANC Cancel Reason
.             LXREACCM Pref Accom
.             LXREPROC Procedure
.             LXREWARD Expected Ward
.             LXRECLSS Adm Class
.             LXREATYP Adm Type
.             LXREDEPT Department
.             LXRETDOC Associated Doctor
.             LXRERFGP Referral GP Doctor
.             LXREEATY Elective Admission Type
.
.             LXRXPOWD Post Operative Ward
.             LXRXOPRD Operation Period
.             LXRXASRC Admission Source
.             LXRXBLDT Blood Type
.             LXUDEF5 to 8.
.--------------------------------------------------------------------------
. V10.15.02 07/02/2020  Ebon Clements    TSK 0887235
.           Recompiled for PMSCEXCD - extra contact postal address
. V10.15.01 22/11/2019  Thanh T.         TSK 0883309
.           Changed CLGP0000 to clear Local GP Name LXWRLDFN field
.--------------------------------------------------------------------------
. V10.13.01 23/01/2019  Nicole Torrisi   TSK 0868849
.           Added LXPACLOC and LXPASLOC
. V10.12.01 07/05/2018  Richa Phogat     TSK 0852348
.           Added LXRELDES - Removal Reason Long Description(Cat WR)
. V10.11.01 30/10/2017  Peter Vela       TSK 0843931
.           Added to Waiting List Letter variables:
.           WL Suspension From Date
.           WL Suspension To Date 
.           WL Suspension Reason Code Cat WN
.           WL Suspension Reason Description Cat WN
.           WL Consultant Address 1
.           WL Consultant Address 2
.           WL Consultant Address 3
.           WL Consultant Address 4
.           WL Consultant Post Code
.           WL Consultant State
. V10.10.01 23/05/2017  Thanh T.         TSK 0825240
.           Added Days Not Ready for surgery for Patient and Clinical fields
. V10.10.01 21/03/2017  Thanh T.         TSK 0832066
.           Changed DVA PREPAT/PMPXDVAC fields to use the new
.           concession card PMCDCNUM/PMCDDVAC fields 
. V10.09.01 28/12/2016  Jill Parkinson   TSK 0828825
.           Recompiled for WATLETCD - continue to try printing even if data
.           reaches end of line.
. V10.08.07 17/11/2016  Peter Vela        TSK 0828936
.            Added %wxidus %wtstay
. V10.08.06 22/09/2016  Ebon Clements  TSK 0294154
.           Uncommented read of pmi master file  - SET0025
. V10.08.05 21/09/2016  Don Nguyen     TSK 0294154
.           Modified PWTLET00 to call RDLET1
. V10.08.04 15/09/2016  Don Nguyen     TSK 0294154
.           Recompiled for WATLETCD
.           Modified PWTLET00 - added calls to PRMSGH00 & PRMSGF00
.           14/09/2016  Ebon Clements  TSK 0294154
.           Added CONTTYPS                       
. V10.08.03 16/08/2016  Peter Vela     TSK 319220
.           Increased PRTSTRNG to 80
.           Increased DISPSTRN to 80
.           04/08/2016  Don Nguyen     TSK 0294154
.           Recompiled for WATLETCD - Added PRIN9050 to skip line count check
. V10.08.02 20/07/2016  Don Nguyen     TSK 0294154
.           Added SMSPRXML - print XML metatags for SMS (PRIN0000).
.           Recompiled for changes to WATLETCD.
. V10.08.01 07/06/2016  Jill Parkinson TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.07.02 09/03/2016  Ebon Clements  TSK 0294154
.           Added %smsid, %smscode, %smskey, %smsurno, %smsuser,
.           %smsphone
. V10.07.01 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
.----------------------------------------------------------------------
. V10.06.02 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.01 02/06/2015  Peter Vela     CAR 308967
.           Changed LXWRDESC to length 80
. V10.05.01 03/10/2014  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.04.04 08/07/2014  Don Nguyen        CAR 302950
.           Recompiled for WATLETCD
. V10.04.03 27/03/2014  Ebon Clements     CAR 298968
.           Added BKREURNO to CLBOKREC
. V10.04.02 24/02/2014  Don Nguyen        CAR 291879
.           Recompiled for changes to WATLETCD & WATLETDF. Added LXIHINUM.
. V10.04.01 31/12/2013  Don Nguyen        CAR 294389
.           Recompiled for changes to WATLETFD & WATLETIO
. V10.03.10 08/07/2013  Peter Vela        CAR 286022
.           Added UPPLOW conversion for PADD4
. V10.03.09 05/07/2013  Peter Vela        CAR 287964
.           Removed asterisk initialisation for %adda %addb %suburb %addd %pcode
. V10.03.08 05/07/2013  Peter Vela        CAR 286022
.           Removed call to CASE0000 for %fname %gname %addb
. V10.03.07 03/07/2013  Peter Vela        CAR 286022
.           Removed call to CASE0000 for %title %sname %adda %suburb %addd
. V10.03.06 20/03/2013  Ania P            CAR 281663
.           Added %rfgpp  -nam -ad1 -ad2 -ad3 -ad4 -pos -tel -fax -eml
. V10.03.05 15/02/2013  Peter Vela        CAR 280643
.           Fixed output %nafdate and %natdate 
. V10.03.04 14/08/2012  Don Nguyen        CAR 270829
.           Fixed output of LXWRLDPC - Local GP Preferred Method of contact
. V10.03.03 30/01/2012  Peter Vela        CAR 257930
.           Added LXWTCHRC - Reason Code Urgency Update
.           Added LXWTCHRD - Reason Desc Urgency Update
.           Added LXWTCHOV - Original Value Urgency Update
. V10.03.02 21/09/2011  Davin             CAR 257512
.           Added LXPTLSNM - Patient Long Surname
. V10.03.01 09/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
. V10.02.09 25/10/2011  Ebon Clements     CAR 253354
.           Added LXWRSRCR WL source of referral 
. V10.02.08 24/10/2011  Peter Vela        CAR 253568
.           Removed asterisk initialization for NOK address vars in SET0000
. V10.02.07 24/10/2011  Peter Vela        CAR 253568
.           Initialised next of kin variables to spaces if none found @ 
.           SET0040
. V10.02.06 21/09/2011  Davin             CAR 248749
.           Added extra contact fields (pmscexaf)
. V10.02.05 15/09/2011  Ebon Clements     CAR 250738
.           Fixed hospital letter fields - SHSP0000
.           Added referring clinicial letter fields
. V10.02.04 08/08/2011  Peter McMullen    CAR 248749
.           Add support for new WATLETDF tags  
. V10.02.03 22/06/2011  Steve Armstrong   CAR 240722
.           Recompiled for changes to PMSCEXCD 
. V10.02.02 14/06/2011  Ebon Clements     CAR 239530
.           Added print extra contact functionality 
. V10.02.01 04/04/2011  Jill Parkinson    CAR 239574
.           Removed open of ibaprntf
.----------------------------------------------------------------------
. V10.01.01 23/02/2011  Ebon Clements     CAR 233571
.           Recompiled for WATLETCD and WATLETDF
.----------------------------------------------------------------------
. V10.00.04 28/09/2010  Jill Parkinson    CAR 230878
.           Fixed previous sad date
. V10.00.03 02/09/2010  Jill Parkinson    CAR 222489
.           Added clear of BKRXDIET and BKRXTRAN
. V10.00.02 18/08/2010  Jill Parkinson   CAR 221663
.           Added tbcanc and prevpa
. V10.00.01 28/06/2010  Peter McMullen   CAR 224562
.           Take resident status from PATMA1
.----------------------------------------------------------------------
.                 V9.12.03 19/10/2009  Ebon Clements    CAR 208060
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.12.02 16/10/2009  Ebon Clements    CAR 208060
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.12.01 12/05/2009  Ebon Clements CAR 195390
.                          Added missing bokrx1af fields to CLBKRX00
.----------------------------------------------------------------------
.                 V9.11.02 27/04/2009  Saroeun Soeur    CAR 193622 
.                          Added LXWLPSTA (cate VL)  and LXWLPSTD
.                 V9.11.01 02/03/2009  Ebon Clements    CAR 189616 187103
.                          Recompiled for WATLETCD and WATLETDF
.                          Removal reason code, description and date
.----------------------------------------------------------------------
.                 V9.09.05 12/12/2007  Ebon Clements    CAR 157081
.                          Recompiled for WATLETCD and WATLETDF
.                          Patient e-mail address
.                 V9.09.04 18/10/2007  Steve Armstrong  CAR 149755
.                          Created new RGGP... & RGPR... variables
.                          instead of using LX... variables and extended
.                          the length of some of the RGGP... & RGPR...
.                          variables to 55.
.                          Recompiled for changes to WATLETCD.
.                 V9.09.03 07/08/2007  Peter Vela      CAR 143567
.                          Added Waiting List Consultant email
.                          address (pmshcpaf,patdo1af)
.                 V9.09.02 03/08/2007  Peter Vela      CAR 143555
.                          Added Reg GP Practice Email Address to Waiting List
.                          Letters
.                 V9.09.01 30/07/2007  Peter Vela      CAR 143555
.                          Added Reg GP Phone Number to Waiting List Letters
.                          Added Reg GP Practice Fax Number to Waiting List
.                          Letters
.----------------------------------------------------------------------
.                 V9.08.01 27/10/2006  Peter Vela      CAR 120911
.                          Initialised LXRECLMT to spaces
.----------------------------------------------------------------------
.                 V9.07.01 30/08/2006  Peter Vela      CAR 117576
.                          Added patient date of birth
.                          Added Local GP preferred method of contact
.----------------------------------------------------------------------
.                 V9.06.01 08/06/2006  Ramesh VK       CAR 86021
.                          Added patient sex %psex
.----------------------------------------------------------------------
.                 V9.05.02 31/03/2006 Peter Vela      CAR 86019
.                          Added Procedure Description (WMDESC.wattr1af)
.                 V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                          Mods for PATCODTM - Hospital specific category codes
.----------------------------------------------------------------------
.                 V9.04.12 15/11/2005 Peter Vela      CAR 83840
.                          Added Admit Ward, Admit Date, Admit Time (patmi1af)
.                 V9.04.11 13/10/2005 Jill Habasque   CAR 55584
.                          Fixed to allow multiple copies
.                 V9.04.10 05/10/2005 Mike Laming     CAR 52354
.                          Add LxWRCSST & LxWRCSDT & re-comp for WATLETCD/DF
.                 V9.04.09 18/08/2005 Peter Vela      CAR 69456
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.08 09/08/2005 Peter Vela      CAR 67204
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.07 27/07/2005 Peter Vela      CAR 68536
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.06 19/07/2005 Peter Vela      CAR 63023
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.05 24/06/2005 Peter Vela      CAR 62391
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.04 21/06/2005 Ebon Clements   CAR 62391
.                          Recompiled for WATLETCD and WATLETDF for
.                          PAS and PAC clinics
.                 V9.04.03 29/04/2005 Peter Vela      CAR 60667
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.02 07/05/2005 Peter Vela      CAR 59792
.                          Recompiled for WATLETCD and WATLETDF
.                 V9.04.01 04/04/2005 Jill Habasque CAR 59773  
.                          Recompiled for WATLETCD
.----------------------------------------------------------------------
.                 V9.03.05 24/12/2003 Peter Vela      CAR 45149
.                          Recompiled for WATLETCD
.                 V9.03.04 24/11/2003 Peter Vela      CAR 45249
.                          Added variable %age to waiting list letters
.                 V9.03.03 05/11/2003 Peter Vela      CAR 42607
.                          Fixed Today's Date variable not populating
.                 V9.03.02 13/08/2003 Sylvek Litewka  CAR 41293
.                          Modified procedure PWTLET00 to populate SCHEDDSC. 
                           08/08/2003 Guomin Fu     CAR 39013
.                          Fixed patients title(%title) prints blank and
.                          full name(%fname)variable sometimes truncated
.                          patient title. Changes at FNAM0000
.                          07/08/2003 Jill Habasque CAR 41815
.                          Changed check for OPDASTAT
.                 V9.03.01 16/06/2003 Tonii  CAR 40266
.                          Mods to use WTWMDABD as proposed operation date and 
.                          OPDADATE as confirmed operation date for theatre 
.                          bookings
.----------------------------------------------------------------------
.                 V9.02.01 07/03/2003 J.Tan 
.                          Mods to admitting point/ward to use code category ap
.                 V9.02.00 13.12.2002 Ebon Clements 8116
.                          Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WATLETDF
.
          INC       WATTR1FD/INC
          INC       WATLPCFD/INC
          INC       WATLETFD/INC
          INC       WATVWLFD/INC
          INC       PATMA1FD/INC
          INC       PMSCEXFD/INC
          INC       PMSPX2FD/INC
          INC       PMSCCDFD/INC
          INC       PATHSPFD/INC
          INC       WATLHIFD/INC
          INC       WATSUSFD/INC
          INC       PATCALAG/INC                * I CAR 45249
          INC       PATCONFD/INC
          INC       PATDHEAD/INC                * I CAR 45249
          INC       WATCONFD/INC
          INC       BOKRC1FD/INC
          INC       PATDO1FD/INC
          INC       BOKRX1FD/INC
          INC       PMSHCPFD/INC
          INC       PATWR1FD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC
          INC       PMSHCGFD/INC
          INC       PMSIHIFD/INC
          INC       PATMI1FD/INC
          INC       WATPROFD/INC
          INC       BOKDIAFD/INC
          INC       WATTX1FD/INC
          INC       OPRDEAFD/INC
          INC       WATOPAFD/INC
          INC       WATESNFD/INC
          INC       WATOPSFD/INC
          INC       WATCHAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCLIFD/INC
          INC       OUTHEDFD/INC
          INC       OUTMA1FD/INC
          INC       OUTSESFD/INC
          INC       OUTSITFD/INC

.
.
. ----- Program Variables -----
.
BTYPE     DIM       2
BOTTMARG  FORM      2
BOOKDM8   DIM       8
CASEKEYS  DIM       23
CATAP     INIT      "ap"                                               *I-59792
CATTC     INIT      "tc"
CFILEPRE  DIM       3
CHECKSIT  DIM       6
CODEA     INIT      "A "
CODEAP    INIT      "ap"
CODEBK    INIT      "BK"
CODEBP    INIT      "BP"
CODECZ    INIT      "CZ"
CODEX5    INIT      "X5"
CODEX6    INIT      "X6"
CODEX7    INIT      "X7"
CODEX8    INIT      "X8"
CODETP    INIT      "TP"
CODEWU    INIT      "WU"
CODEDX    INIT      "DX"
CODEVA    INIT      "VA"
CODEPV    INIT      "PV"
CODEEC    INIT      "EC"
CODEP     INIT      "P "
CODEVB    INIT      "VB"
CODEVR    INIT      "VR"
CODEVI    INIT      "VI"
CODEVK    INIT      "VK"
CODEVL    INIT      "VL"
CODEVJ    INIT      "VJ"
CODEBO    INIT      "BO"
CODES     INIT      "S "
CODET     INIT      "T "
CODESP    INIT      "SP"
CODECL    INIT      "CL"
CODECC    INIT      "CC"
CODEBC    INIT      "BC"
CODEAC    INIT      "AC"
CODEWR    INIT      "WR"
CONTTYPE  DIM       1
COUNT     FORM      3
COUNTER   FORM      5
DESCCAT   DIM       20
DATELINE  DIM       19
DEXT      DIM       3
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
DIM8      DIM       8
DIM55     DIM       55
DIM70     DIM       70
DIMAGE    DIM       3                * I CAR 45249
DISPSTRN  DIM       80
DOCLINE   DIM       33
DUMMY     DIM       1
EADMDESC  DIM       20
ENDSTR    FORM      2
FNAMER    DIM       8
FIRSTCH   FORM      1
FORM3     FORM      3
FORM3A    FORM      3
HOUR      DIM       2
IHINUMBR  DIM       20
TWOHUN30  FORM      "232"
IDDIM1    DIM       8
INITIAL   DIM       4
LEAVPSMS  FORM      1        * Don't send overdue leave SMS to patient
LEAVFSMS  DIM       20       * First SMS number of not sending to patient
LEFTMARG  FORM      2
LETTER    DIM       3
LETTFORM  FORM      3
LINE      DIM       55
.
MINUTE    DIM       2
MONTH     DIM       9
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
NAMELINE  DIM       52
NAMEDIS   DIM       14
NRFCDAYS  FORM      5
PACCOM    DIM       20
PERCPOS   FORM      2
PDESC     DIM       50
PRTSTRNG  DIM       80
PHYSPAGE  FORM      3
REFPRTY   DIM       20
REFUNIT   DIM       20
RESPSEX   DIM       6
RESPNAME  DIM       52
RESPPNKN  DIM       52
RESPADDA  DIM       25
RESPADDB  DIM       25
RESPSUBR  DIM       15
RESPPOST  DIM       4
RESPADDD  DIM       25
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090"
RFGPSNAM  DIM       20
RFGPGNAM  DIM       20
RFGPADD1  DIM       35
RFGPADD2  DIM       35
RFGPADD3  DIM       35
RFGPADD4  DIM       35
RFGPPOST  DIM       8
RFGPPNAM  DIM       80
RFGPPAD1  DIM       60
RFGPPAD2  DIM       60
RFGPPAD3  DIM       60
RFGPPAD4  DIM       60
RFGPPPOS  DIM       8
RFGPPTEL  DIM       20
RFGPPFAX  DIM       20
RFGPPEML  DIM       80
RFPRSURG  DIM       25
RFPRSAD1  DIM       35
RFPRSAD2  DIM       35
RFPRSAD3  DIM       35
RFPRSAD4  DIM       35
RFPRSPCD  DIM       8
RFPRTELE  DIM       20
RGPRSURG  DIM       55
RGPRSAD1  DIM       55
RGPRSAD2  DIM       55
RGPRSAD3  DIM       55
RGPRSAD4  DIM       55
RGPRSPCD  DIM       8
RGPRTELE  DIM       20
RGPRFAXN  DIM       20
RGPRPEML  DIM       55
RGGPSNAM  DIM       35
RGGPGNAM  DIM       35
RGGPADD1  DIM       55
RGGPADD2  DIM       55
RGGPADD3  DIM       55
RGGPADD4  DIM       55
RGGPPOST  DIM       8
RGGPFAXN  DIM       20
RGGPSEML  DIM       80
RGGPMOBN  DIM       20
RGGPPAGR  DIM       20
RGGPPAGN  DIM       20
RGGPPRV1  DIM       10
RGGPSTEL  DIM       20
STARTSTR  FORM      2
SRCHNUM   FORM      3
SRCHVAR   DIM       15
TEMP2     FORM      2
TEMP3     FORM      3
TEMP55    DIM       55
TEMP70    DIM       70
TEMPHOUR  FORM      3
TEMPHOUR2 FORM      2
TIMELINE  DIM       8
TODAY     DIM       8
TOPMARG   FORM      2
WLETPLEN  FORM      3
WLTYCODE  DIM       1
RFDTITL   DIM       10       
RFDADD3   DIM       30       
RFDADD4   DIM       30       
.
.------ Temp File -------------
.
TEMP1     FILE      ASCII,FIXED=399
.Name     Type    Length      Start
.-------  ----    ------      -----
BOOKNO    DIM       8           1
URDIM     DIM       8           9
FDATE     DIM       19         17
DOCTNAM   DIM       33         36
XXDATE    DIM       19         69
FULLNAME  DIM       52         88
XTIME     DIM       8         140
LDATE     DIM       19        148
PDATE     DIM       19        167
PTIME     DIM       8         186
LRDATE    DIM       19        194
.DEPT      DIM       3         213
RFDADD1   DIM       30        216
RFDADD2   DIM       30        246
.WMCODE    DIM       9        276
.WMUNIT    DIM       3        285
DADATE    DIM       19        288
GADATE    DIM       19        307
DNABDATE  DIM       19        326
NAFDATE   DIM       19        345
NATDATE   DIM       19        364
ELECATYP  DIM       3         373
.WMCNT    FORM      2         376
.WMPTY    DIM       3         378
.WMUDEF5  DIM       3         381
.WMUDEF6  DIM       3         384
.WMUDEF7  DIM       3         387
.WMUDEF7  DIM       3         390
.WTWMRANK FORM      6         393
.End of Record                399
.
LETRCOMM  DIM       1                  * Letter Communication Method
.                                         0 or Blank = Printed Letter
.                                         1 = SMS Notification
CONTPNMS  DIM       200                * Pipe-delimited list of phone numbers
CONTMSGI  DIM       200                * Pipe-delimited list of msg id's
CONTTYPS  DIM       200                * Pipe-delimited list of contact types
MAXCOUNT  INIT      "10"               * Max count for SMS phone numbers
.
. ----- Program Constants -----
.
.
.----------------------------------------------------------------------
PRGID     INIT      "WATWEB03"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Waiting List Print Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
.
          CALL      INIT0000       * Open Files
.
MAIN0000  COMMIT                   * Match BEGIN in WEBINT00 for Transactions
.
          BEGIN
.
          DISPLAY   *W5
          PACK      KEY5,SP70
          CALL      RSWTLPC1
MAIN1000  CALL      RKWTLPC1
          BRANCH    OVRCD,MAIN0000
.
          MOVE      WTLPSCHE,KEY5
          CALL      RLWTLPC1
          BRANCH    OVRCD,MAIN0000,MAIN1000
.
          MOVE      WTLPURNO,URNUMBER
          MOVE      WTLPPRNT,SELPRINT
          MOVE      WTLPCOPY,NOCOPIES
          PACK      CASEKEYS,WTLPURNO,WTLPPCOD,WTLPPCNT,SP70
.
          MOVE      WTLPWEBU,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,PASSCODE
          ELSE
            MOVE      WBSEPCD,PASSCODE
          ENDIF
.
          MOVE      WTLPLETT,LETTER    
          MATCH     SP70,WTLPLETT
          GOTO      MAIN1100 IF NOT EQUAL
.
          GOTO      MAIN9000
.
MAIN1100  CALL      PWTLET00                * Print Letter     
          GOTO      MAIN9000
.
MAIN9000  MOVE      WTLPSCHE,KEY5
          CALL      DEWTLPC1
          PACK      KEY5,SP70
          CALL      RSWTLPC1
.
          COMMIT
.
          BEGIN
.
          GOTO      MAIN1000
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      WATLPCA1,"watlpcaf" 
          OPEN      WATLETR1,"watletrf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATVWLA1,"watvwlaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      WATLHIA1,"watlhiaf"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      CONTROLF,"controlf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      WATPROA1,"watproaf"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      PATCODE1,"patcodes"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      WATOPAA1,"watopaaf"
          OPEN      WATOPSA1,"watopsaf"
          OPEN      WATCHAA1,"watchaaf"
          OPEN      OUTSITA1,"outsitaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      IBASEQA1,"ibaseqaf"
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          READ      CONTROLF,TEN5;*189,CTHETR
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND28;*210,PTCNSTYP
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"     * IHI Details
          ENDIF
.
INIT9000  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,LETTER   
          MOVE      SP70,SELPRINT
          MOVE      SP70,NOCOPIES
          MOVE      SP70,CASEKEYS
          MOVE      ZERO,LETRCOMM
          PACK      CONTPNMS,SP70,SP70,SP70
          PACK      CONTMSGI,SP70,SP70,SP70
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Process Template Fields
.------------------------------------------------------------
PROFLD00
PROFLD99  RETURN
.------------------------------------------------------------
. Print Waiting List Letter
.------------------------------------------------------------
PWTLET00  MATCH     SP70,CASEKEYS
          GOTO      PWTLET99 IF EQUAL
.
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,PWTLET99
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,PWTLET99
.
          MOVE      WMURNO,URNUMBER
          MOVE      WMURNO,URDIM
          MOVE      WMBOOK,BOOKNO
.
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,PWTLET99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,BOOKNO,SP70
          CALL      RDPTMIS1
          IF        OVRCD = 1
            CALL      CLPATMIS
          ENDIF
.
          MOVE      "Waiting List Letter Printing",SCHEDDSC
          CALL      OPNPRINT
          CALL      SET0000
          CALL      FRMT0000
.
          MOVE      SP1,LETRCOMM
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      PWTLET50 IF NOT EQUAL
.
          MOVE      LETTER,LETTFORM
          MOVE      ZERO,FORM3              * read letter file header record
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDLET1
.
          MOVE      WLETCOMM,LETRCOMM
          MATCH     "1",LETRCOMM
          IF        @EQUAL
            CALL      PRMSGH00              * print SMS Messages XML Header tag
          ENDIF
.
PWTLET50  CALL      PRIN0000
.
          MATCH     "1",LETRCOMM
          IF        @EQUAL
            CALL      PRMSGF00              * print SMS Messages XML Footer tag
          ENDIF
.
          CALL      CLSPRINT
.
PWTLET99  RETURN
+
.****************************************************************************
.*                                FRMT0000                                  *
.*                           FoRMaT the details                             *
.****************************************************************************
FRMT0000  MOVE      WMBOOK,BOOKNO
          MOVE      WMBOOK,BOOKDM8
          MOVE      BOOKDM8,KEY8
          MOVE      SP8,BKREPDAT          * pre-assesment date
          MOVE      SP8,BKREPTIM          * pre-assesment time
          MOVE      SP8,BKREATIM          * expected assesment time
          MOVE      SP8,BKREEDAT          * expected due date
          CALL      RDBKREC1              * read booking file
.
          UNPACK    WTWMDTAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                        * Decision to admit date
          MOVE      DATELINE,DADATE
          MOVE      "99",CDAY
          UNPACK    WTWMGADD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                      * Guareented admission date
          MOVE      DATELINE,GADATE
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                       * Do not admit before date
          MOVE      DATELINE,DNABDATE
          MOVE      "99",CDAY
          CALL      IBACLOCK                        * I CAR 42607
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR                       
          REP       " 0",CDAY
          REP       " 0",CMON
          REP       " 0",CCENT
          REP       " 0",CYEAR                      * end I CAR 42607
.         UNPACK    CDATE,CDAY,DUMMY,CMON,DUMMY,CCENT,CYEAR    * D CAR 42607
          CALL      FDAT0000                        * format todays date
          MOVE      DATELINE,FDATE
          MOVE      "99",CDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                        * format date on list
          MOVE      DATELINE,LDATE
          MOVE      "99",CDAY
          UNPACK    WMDATE2,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                       * format last review date
          MOVE      DATELINE,LRDATE
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                      * format expected due date
          MOVE      DATELINE,XXDATE
          MOVE      "99",CDAY
          UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format pre-assessment date
          MOVE      DATELINE,PDATE
          MOVE      "99",HOUR
          UNPACK    BKREPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format pre-assessment time
          MOVE      TIMELINE,PTIME
          MOVE      "99",HOUR
          UNPACK    BKREATIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format expected due time
          MOVE      TIMELINE,XTIME
          MOVE      WMURNO,PURNO
          MOVE      WMURNO,URDIM
          MOVE      PURNO,KEY8
..        CALL      RDMAST1                         * read master file
          CALL      FNAM0000                        * format patients name
          MOVE      NAMELINE,FULLNAME
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      FDOC0000                        * format doctors name
          MOVE      DOCLINE,DOCTNAM
.
          MOVE      SP70,LXWRWLCC
          MOVE      SP70,LXWTWLA1
          MOVE      SP70,LXWTWLA2
          MOVE      SP70,LXWTWLA3
          MOVE      SP70,LXWTWLA4
          MOVE      SP70,LXWTWLPT
          MOVE      SP70,LXWTWLST
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCHCPC,LXWRWLCC               * doctor code
            MOVE      PMHCSEML,LXWLCHEM
            MOVE      PMHCFAXN,LXWLCFAX
            MOVE      PMHCPRFC,LXWRCPCC
.
            MATCH     SP70,PMHCPRFC
            IF        !@EQUAL
              PACK      KEY5,ANSC,ANSZ,PMHCPRFC,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,LXWRCPCD
              ENDIF
            ENDIF
.
            MOVE      PMHCADR1,LXWTWLA1
            MOVE      PMHCADR2,LXWTWLA2
            MOVE      PMHCADR3,LXWTWLA3
            MOVE      PMHCADR4,LXWTWLA4
            MOVE      PMHCPOST,LXWTWLPT
            MOVE      PMHCSTAT,LXWTWLST
          ENDIF
.
          PACK      KEY6,WMDOCTOR,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      PTDOSEML,LXWLCDEM
          ENDIF
.
          MOVE      SP70,LXWRWLCP
          PACK      KEY9,WMDOCTOR,WMUNIT,SP70
          CALL      RDWTVWL1
          IF        OVRCD=0
            MOVE      WTVWTELE,LXWRWLCP               * Consultant Surgery Tel
          ENDIF
.
          MOVE      WMPCAT,DEPT                     * department
          MOVE      WTWMEATY,ELECATYP
.
. get referred doctor's address
.
          MOVE      SP30,RFDADD1
          MOVE      SP30,RFDADD2
          MOVE      SP30,RFDADD3
          MOVE      SP30,RFDADD4
.
FRMT0900  MATCH     ZEROVISN,BKREBOOK 
          GOTO      FRMT1000 IF EQUAL
.
          MATCH     SP6,BKRESDOC
          GOTO      FRMT1000 IF EQUAL
.
          MOVE      BKRESDOC,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,FRMT1000
          MOVE      DTITL,RFDTITL
          MOVE      DSADD1,RFDADD1
          MOVE      DSADD2,RFDADD2
          MOVE      DSADD3,RFDADD3
          MOVE      DSADD4,RFDADD4
.
.------ write formatted variables to temporary file ------
.
FRMT1000  MOVE      PSNAME,NAMEDIS
          ADD       ONE,COUNTER
.
FRMT9999  RETURN
+
.**********************************************************************
.*                           FTIM0000                                 *
.*                   routine to Format the TIMe                       *
.**********************************************************************
FTIM0000  CLEAR     TIMELINE
          MATCH     "99",HOUR
          GOTO      FTIM7000 IF EQUAL
          MATCH     SP2,HOUR
          GOTO      FTIM7000 IF EQUAL
          MOVE      HOUR,TEMPHOUR
          SUBTRACT  TEN2,TEMPHOUR
          GOTO      FTIM1000 IF LESS
          GOTO      FTIM2000 IF EQUAL
          COMPARE   TEN2,TEMPHOUR
          GOTO      FTIM0050 IF NOT EQUAL
          MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          GOTO      FTIM1100
.
FTIM0050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM0100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM0100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "pm",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM1000  ADD       TEN2,TEMPHOUR
          GOTO      FTIM1050 IF NOT EQUAL
          MOVE      TEN2,HOUR
          GOTO      FTIM1100
.
FTIM1050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM1100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM1100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "am",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM2000  MOVE      TEN2,HOUR
          GOTO      FTIM0100
.
FTIM7000  MOVE      "        ",TIMELINE
.          MOVE      "99:99 pm",TIMELINE
          GOTO      FTIM9999
.
FTIM9999  RETURN
+
.**********************************************************************
.*                           FDAT0000                                 *
.*                  routine to Format the DATe                        *
.**********************************************************************
FDAT0000  CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT2000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT2000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                               DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                                MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          BUMP      CDAY
.
.------ pack the formatted date ------
.
FDAT1000  PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT2000  MOVE      "                  ",DATELINE
.         MOVE      "99th December 1999",DATELINE
          GOTO      FDAT9999
.
FDAT9999  RETURN
+
.**********************************************************************
.*                              FDOC0000                              *
.*                   routine to Format DOCtor's name                  *
.**********************************************************************
FDOC0000  CLEAR     DOCLINE
          CALL      RDPMHCP1                        * read doctor file
          BRANCH    OVRCD,FDOC7000
          CLEAR     INITIAL
          APPEND    SP1,INITIAL
          MOVE      PMHCGNAM,ANS
          APPEND    ANS,INITIAL
          APPEND    ". ",INITIAL
          RESET     INITIAL
          PACK      DOCLINE,PMHCTITL,INITIAL,PMHCSNAM   * pack formatted doctors
          MOVE      DOCLINE,LINE                   *   name
          CALL      COMP0000                       * compress blanks
          CALL      CASE0000                       * convert to lower case
          MOVE      LINE,DOCLINE
          GOTO      FDOC9999
.
.------ doctors name does not exist ------
.
FDOC7000  MOVE      "*********************************",DOCLINE
          GOTO      FDOC9999
.
FDOC9999  RETURN
+
.**********************************************************************
.*                             CASE0000                               *
.*  routine to convert all except first character of each word to     *
.*        lower CASE                                                  *
.**********************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL       * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW              * test to see if char is a letter
          GOTO      CASE1100 IF EQUAL
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                * any char but a letter found
.
CASE1100  RESET     UPPLOW
          OR        040,LINE                * actual conversion to lower case
.
CASE2000  MOVE      ZERO,FIRSTCH            * not on first char. any more
.
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS     * move to next character
          RESET     LINE                    * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH             * first character was a space
          GOTO      CASE3000
.
CASE9999  RETURN
+
.**********************************************************************
.*                              COMP0000                              *
.*            routine to COMPress excessive blanks in LINE            *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL   * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                   * compress multiple blanks
          GOTO      COMP8000 IF EOS         *   from in-between words
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
+
.**********************************************************************
.*                              SET0000                               *
.*             SET up the values for all the "%" variables            *
.**********************************************************************
.
.------ read the temporary file ------
.
SET0000   DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
.
.------ read files to get values of other % variables ------
.------ not already formatted -------
.
          ADD       ONE,COUNTER
          MOVE      FALSE,EXIT
          MOVE      SP3,BKREWARD
          MOVE      BOOKNO,BOOKDM8
          MOVE      BOOKDM8,KEY8
          CALL      RDBKREC1
          IF        OVRCD = 1
            CALL    CLBOKREC
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
            IF        OVRCD = 1
              CALL      CLBKRX00
            ENDIF
          ENDIF
.
          CALL      SHSP0000             * set up hospital details
          CALL      RCLI0000             * Set referring clinician fields
.
.         Waiting List - Category VL
.
          MOVE      WTTXPLST,LXWLPSTA
          MATCH     SP70,WTTXPLST
          GOTO      SET0005 IF EQUAL
          PACK      KEY5,CODEVL,WTTXPLST
          CALL      RDCODE1
          BRANCH    OVRCD,SET0005
          MOVE      TDESC,LXWLPSTD       * category VL description
.
SET0005   MATCH     SP70,BKRETYPE
          GOTO      SET0010 IF EQUAL
          PACK      KEY5,CODEBK,BKRETYPE * booking type
          CALL      RDCODE1
          BRANCH    OVRCD,SET0010
          MOVE      TDESC,BTYPE
.
SET0010   MATCH     SP70,BKREACCM
          GOTO      SET0015 IF EQUAL
          PACK      KEY5,CODEBP,BKREACCM * preferred accomadation
          CALL      RDCODE1
          BRANCH    OVRCD,SET0015
          MOVE      TDESC,PACCOM
.
SET0015   MOVE      WMCODE,LXWRPCOD
          MOVE      WMCNT,LXWRPCNT
          MOVE      WMCODE,KEY9
          CALL      RDPROA1
          BRANCH    OVRCD,SET0020
          MOVE      WPDESC,PDESC
.
SET0020   MATCH     SP70,WMUNIT
          GOTO      SET0021 IF EQUAL
          PACK      KEY5,CODEWU,WMUNIT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0021
          MOVE      TDESC,REFUNIT
.
SET0021   MATCH     SP70,WMPTY
          GOTO      SET0022 IF EQUAL
          PACK      KEY5,CODETP,WMPTY
          CALL      RDCODE1
          BRANCH    OVRCD,SET0022
          MOVE      TDESC,REFPRTY
.
SET0022   MATCH     SP3,DEPT
          GOTO      SET0025 IF EQUAL
          PACK      KEY5,CODEA,DEPT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0025
          MOVE      TDESC,DESCCAT
.
SET0025   MOVE      URDIM,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "9",CONTTYPE          * OTH Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME     
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXOCNAME     * Other Contact Details
            MOVE      PMCETITL,LXOCTITL
            MOVE      PMCESNAM,LXOCSNAM
            MOVE      PMCEGNAM,LXOCGNAM
            MOVE      PMCEGNM2,LXOCGNM2
            MOVE      PMCEADD1,LXOCADD1
            MOVE      PMCEADD2,LXOCADD2
            MOVE      PMCEADD3,LXOCADD3
            MOVE      PMCEADD4,LXOCADD4
            MOVE      PMCEPOST,LXOCPOST
            MOVE      PMCETELP,LXOCTELP
            MOVE      PMCETELB,LXOCTELB
            MOVE      PMCETELM,LXOCTELM
            MOVE      PMCERELP,LXOCRELP
            MOVE      PMCEEMAI,LXOCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXOCSLET
            ELSE
              MOVE     DNO,LXOCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * NOK2 Contact
            CALL      NOK20000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXP2NAME     * NOK2 Contact Details
            MOVE      PMCETITL,LXP2TITL
            MOVE      PMCESNAM,LXP2SNAM
            MOVE      PMCEGNAM,LXP2GNAM
            MOVE      PMCEGNM2,LXP2GNM2
            MOVE      PMCEADD1,LXP2ADD1
            MOVE      PMCEADD2,LXP2ADD2
            MOVE      PMCEADD3,LXP2ADD3
            MOVE      PMCEADD4,LXP2ADD4
            MOVE      PMCEPOST,LXP2POST
            MOVE      PMCETELP,LXP2TELP
            MOVE      PMCETELB,LXP2TELB
            MOVE      PMCETELM,LXP2TELM
            MOVE      PMCERELP,LXP2RELP
            MOVE      PMCEEMAI,LXP2EMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP2SLET
            ELSE
              MOVE     DNO,LXP2SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "C",CONTTYPE          * CAR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPCNAME     * Carer Contact Details
            MOVE      PMCETITL,LXPCTITL
            MOVE      PMCESNAM,LXPCSNAM
            MOVE      PMCEGNAM,LXPCGNAM
            MOVE      PMCEGNM2,LXPCGNM2
            MOVE      PMCEADD1,LXPCADD1
            MOVE      PMCEADD2,LXPCADD2
            MOVE      PMCEADD3,LXPCADD3
            MOVE      PMCEADD4,LXPCADD4
            MOVE      PMCEPOST,LXPCPOST
            MOVE      PMCETELP,LXPCTELP
            MOVE      PMCETELB,LXPCTELB
            MOVE      PMCETELM,LXPCTELM
            MOVE      PMCERELP,LXPCRELP
            MOVE      PMCEEMAI,LXPCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPCSLET
            ELSE
              MOVE     DNO,LXPCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * EMR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXECNAME     * Emergency Contact Details
            MOVE      PMCETITL,LXECTITL
            MOVE      PMCESNAM,LXECSNAM
            MOVE      PMCEGNAM,LXECGNAM
            MOVE      PMCEGNM2,LXECGNM2
            MOVE      PMCEADD1,LXECADD1
            MOVE      PMCEADD2,LXECADD2
            MOVE      PMCEADD3,LXECADD3
            MOVE      PMCEADD4,LXECADD4
            MOVE      PMCEPOST,LXECPOST
            MOVE      PMCETELP,LXECTELP
            MOVE      PMCETELB,LXECTELB
            MOVE      PMCETELM,LXECTELM
            MOVE      PMCERELP,LXECRELP
            MOVE      PMCEEMAI,LXECEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXECSLET
            ELSE
              MOVE     DNO,LXECSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "7",CONTTYPE          * Local Address Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPLNAME     * Local Address Contact Details
            MOVE      PMCETITL,LXPLTITL
            MOVE      PMCESNAM,LXPLSNAM
            MOVE      PMCEGNAM,LXPLGNAM
            MOVE      PMCEGNM2,LXPLGNM2
            MOVE      PMCEADD1,LXPLADD1
            MOVE      PMCEADD2,LXPLADD2
            MOVE      PMCEADD3,LXPLADD3
            MOVE      PMCEADD4,LXPLADD4
            MOVE      PMCEPOST,LXPLPOST
            MOVE      PMCETELP,LXPLTELP
            MOVE      PMCETELB,LXPLTELB
            MOVE      PMCETELM,LXPLTELM
            MOVE      PMCERELP,LXPLRELP
            MOVE      PMCEEMAI,LXPLEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPLSLET
            ELSE
              MOVE     DNO,LXPLSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Preferred Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME     
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPRNAME     * Preferred Contact Details
            MOVE      PMCETITL,LXPRTITL
            MOVE      PMCESNAM,LXPRSNAM
            MOVE      PMCEGNAM,LXPRGNAM
            MOVE      PMCEGNM2,LXPRGNM2
            MOVE      PMCEADD1,LXPRADD1     
            MOVE      PMCEADD2,LXPRADD2
            MOVE      PMCEADD3,LXPRADD3
            MOVE      PMCEADD4,LXPRADD4
            MOVE      PMCEPOST,LXPRPOST
            MOVE      PMCETELP,LXPRTELP
            MOVE      PMCETELB,LXPRTELB
            MOVE      PMCETELM,LXPRTELM
            MOVE      PMCERELP,LXPRRELP
            MOVE      PMCEEMAI,LXPREMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPRSLET
            ELSE
              MOVE     DNO,LXPRSLET
            ENDIF
          ENDIF
.>>>>
          PACK      RESPPNKN,PNKNAME,SP70
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RESPPNKN     * NEXT OF KIN 1 NAME
            MOVE      PMCETITL,LXP1TITL     * title
            MOVE      PMCESNAM,LXP1SNAM     * surname
            MOVE      PMCEGNAM,LXP1GNAM     * given name 1
            MOVE      PMCEGNM2,LXP1GNM2     * given name 2
            MOVE      PMCEADD1,PNKADD1      * N.O.K 1 ADDRESS LINE 1
            MOVE      PMCEADD2,PNKADD2      * N.O.K 1 ADDRESS LINE 2
            MOVE      PMCEADD3,PNKSUBR      * N.O.K 1 ADDRESS LINE 3
            MOVE      PMCEADD4,PNKADD4      * N.O.K 1 ADDRESS LINE 4
            MOVE      PMCEPOST,PNKPOST      * N.O.K 1 POSTCODE
            MOVE      PMCETELP,PNKTELP      * N.O.K 1 PRIVATE TELEPHONE
            MOVE      PMCETELP,LXP1TELP
            MOVE      PMCETELB,PNKTELB      * N.O.K 1 BUSINESS TELEPHONE
            MOVE      PMCETELB,LXP1TELB
            MOVE      PMCETELM,PMPXKMOB     * N.O.K 1 MOBILE
            MOVE      PMCETELM,LXP1TELM
            MOVE      PMCERELP,PNKRELP      * N.O.K 1 RELATIONSHIP
            MOVE      PMCERELP,LXP1RELP
            MOVE      PMCEEMAI,PMPXKEML     * N.O.K 1 EMAIL
            MOVE      PMCEEMAI,LXP1EMAI
            MOVE      PMCESLET,PMPXKCRP     * N.O.K 1 Send Letter
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP1SLET
            ELSE
              MOVE     DNO,LXP1SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPONAME     * Postal Address Formatted Name
            MOVE      PMCETITL,LXPOTITL     * title
            MOVE      PMCESNAM,LXPOSNAM     * surname
            MOVE      PMCEGNAM,LXPOGNAM     * given name 1
            MOVE      PMCEGNM2,LXPOGNM2     * given name 2
            MOVE      PMCEADD1,PTMXADD1     * POSTAL ADDRESS LINE 1
            MOVE      PMCEADD2,PTMXADD2     * POSTAL ADDRESS LINE 2
            MOVE      PMCEADD3,PTMXADD3     * POSTAL ADDRESS LINE 3
            MOVE      PMCEADD4,PTMXADD4     * POSTAL ADDRESS LINE 4
            MOVE      PMCEPOST,PTMXPOST     * POSTAL POSTCODE
            MOVE      PMCETELP,LXPOTELP
            MOVE      PMCETELB,LXPOTELB
            MOVE      PMCETELM,LXPOTELM
            MOVE      PMCERELP,LXPORELP
            MOVE      PMCEEMAI,LXPOEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPOSLET
            ELSE
              MOVE     DNO,LXPOSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXMSNA     * MOTHER SURNAME
            MOVE      PMCEGNAM,PMPXMGNA     * MOTHER GIVEN NAME
            MOVE      PMCETITL,PMPXMTLE     * MOTHER TITLE
            MOVE      PMCEADD1,PMPXMAD1     * MOTHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXMAD2     * MOTHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXMAD3     * MOTHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXMAD4     * MOTHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXMPOS     * MOTHER POSTCODE
            MOVE      PMCETELP,PMPXMPNO     * MOTHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXMBNO     * MOTHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXMMNO     * MOTHER MOBILE
            MOVE      PMCEEMAI,PMPXMEML     * MOTHER EMAIL
            MOVE      PMCECONT,PMPXMCNT     * MOTHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXMCRP     * MOTHER SEND LETTER
            MOVE      SP70,PMPXMLAB         * MOTHER NAME OF LABEL
            MOVE      PMCERELP,PMPXMREL     * MOTHER RELATIONSHIP
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXFSNA     * FATHER SURNAME
            MOVE      PMCEGNAM,PMPXFGNA     * FATHER GIVEN NAME
            MOVE      PMCETITL,PMPXFTLE     * FATHER TITLE
            MOVE      PMCEADD1,PMPXFAD1     * FATHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXFAD2     * FATHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXFAD3     * FATHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXFAD4     * FATHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXFPOS     * FATHER POSTCODE
            MOVE      PMCETELP,PMPXFPNO     * FATHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXFBNO     * FATHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXFMNO     * FATHER MOBILE
            MOVE      PMCEEMAI,PMPXFEML     * FATHER EMAIL
            MOVE      PMCECONT,PMPXFCNT     * FATHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXFCRP     * FATHER SEND LETTER
            MOVE      SP70,PMPXFLAB         * FATHER NAME OF LABEL
            MOVE      PMCERELP,PMPXFREL     * FATHER RELATIONSHIP
          ENDIF
.
.          PACK      RESPPNKN,PNKNAME,SP70
          PACK      RESPNAME,RESPPNKN,SP20,SP20,SP20
          MATCH     SP70,RESPNAME
          GOTO      SET0040 IF EQUAL
          MOVE      PNKADD1,RESPADDA
          MOVE      PNKADD2,RESPADDB
          MOVE      PNKADD4,RESPADDD
          MOVE      PNKSUBR,RESPSUBR
          MOVE      PNKPOST,RESPPOST
          GOTO      SET0050
.
SET0040   MOVE      SP70,RESPNAME
          MOVE      SP70,RESPADDA
          MOVE      SP70,RESPADDB
          MOVE      SP70,RESPPOST
          MOVE      SP70,RESPSUBR
          MOVE      SP70,RESPADDD 
.
.         MOVE      FULLNAME,RESPNAME
.         MOVE      PADD1,RESPADDA
.         MOVE      PADD2,RESPADDB
.         MOVE      PPOST,RESPPOST
.         MOVE      PSUBRB,RESPSUBR
.         MOVE      PADD4,RESPADDD
.
SET0050   MOVE      PMPXMSNA,PACSNAME              * Mothers Details
          MOVE      PMPXMGNA,PACGNAME
          MOVE      PMPXMTLE,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXPXMSNA
          MOVE      PMPXMGNA,LXPXMGNA
          MOVE      PMPXMTLE,LXPXMTLE
          MOVE      PMPXMAD1,LXPXMAD1
          MOVE      PMPXMAD2,LXPXMAD2
          MOVE      PMPXMAD3,LXPXMAD3
          MOVE      PMPXMAD4,LXPXMAD4
          MOVE      PMPXMPOS,LXPXMPOS
          MOVE      PMPXMPNO,LXPXMPNO
          MOVE      PMPXMBNO,LXPXMBNO
          MOVE      PMPXMMNO,LXPXMMNO
          MOVE      PMPXMEML,LXPXMEML
          MOVE      PMPXPEML,LXPXPEML
.
          MOVE      SP30,LXPXMCNT
          MATCH     SP70,PMPXMCNT
          GOTO      SET0051 IF EQUAL
          PACK      KEY5,CODEEC,PMPXMCNT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0051
.
          MOVE    TDESC,LXPXMCNT
.
SET0051   MATCH     "1",PMPXMCRP
          IF        @EQUAL
            MOVE     DYES,LXPXMCRP
          ELSE
            MOVE     DNO,LXPXMCRP
          ENDIF
.
          MATCH     "1",PMPXMLAB
          IF        @EQUAL
            MOVE     DYES,LXPXMLAB
          ELSE
            MOVE     DNO,LXPXMLAB
          ENDIF
          MOVE      PMPXMREL,LXPXMREL
.
          MOVE      PMPXFSNA,PACSNAME              * Fathers Details
          MOVE      PMPXFGNA,PACGNAME
          MOVE      PMPXFTLE,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXPXFSNA
          MOVE      PMPXFGNA,LXPXFGNA
          MOVE      PMPXFTLE,LXPXFTLE
          MOVE      PMPXFAD1,LXPXFAD1
          MOVE      PMPXFAD2,LXPXFAD2
          MOVE      PMPXFAD3,LXPXFAD3
          MOVE      PMPXFAD4,LXPXFAD4
          MOVE      PMPXFPOS,LXPXFPOS
          MOVE      PMPXFPNO,LXPXFPNO
          MOVE      PMPXFBNO,LXPXFBNO
          MOVE      PMPXFMNO,LXPXFMNO
          MOVE      PMPXFEML,LXPXFEML
.
          MOVE      SP30,LXPXFCNT
          MATCH     SP70,PMPXFCNT
          IF        !@EQUAL
            PACK      KEY5,CODEEC,PMPXFCNT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE    TDESC,LXPXFCNT
            ENDIF
          ENDIF
.
          MATCH     "1",PMPXFCRP
          IF        @EQUAL
            MOVE     DYES,LXPXFCRP
          ELSE
            MOVE     DNO,LXPXFCRP
          ENDIF
.
          MATCH     "1",PMPXFLAB
          IF        @EQUAL
            MOVE     DYES,LXPXFLAB
          ELSE
            MOVE     DNO,LXPXFLAB
          ENDIF
.
          MOVE      PMPXMREL,LXPXFREL
.
          MOVE      SP70,LXPXDVAC
          MOVE      THREE,DIM1
          CALL      GCCARD00
          MATCH     SP70,PMCDDVAC
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CODEDX,PMCDDVAC,SP10    * DVA Card colour
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXDVAC
            ENDIF
          ENDIF
.
          MATCH     SP70,PMPXABRG
          IF        !@EQUAL
            PACK      KEY5,CODEVA,PMPXABRG         * Aboriginality
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXABRG
            ENDIF
          ENDIF
.
          MATCH     SP70,PMPXPRVI
          IF        !@EQUAL
            PACK      KEY5,CODEPV,PMPXPRVI         * Privacy
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXPXPRVI
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDPMVX11
          BRANCH    OVRCD,SET0055
.
          MATCH     SP70,PMVXABRG
          IF        !@EQUAL
            PACK      KEY5,CODEVA,PMVXABRG           * Aboriginality
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXABRG
            ENDIF
          ENDIF
.
          MATCH     SP70,PMVXCADM
          IF        !@EQUAL
            PACK      KEY5,CODEVB,PMVXCADM           * Admission Criteria
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXCADM
            ENDIF
          ENDIF
.
          MATCH     SP70,PMVXIRAD
          IF        !@EQUAL
            PACK      KEY5,CODEVR,PMVXIRAD           * Intention to readmit
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXIRAD
            ENDIF
          ENDIF
.
          MATCH     SP70,PMVXIDUS
          IF        !@EQUAL
            PACK      KEY5,CODEVI,PMVXIDUS           * Intended stay duration
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXIDUS
            ENDIF
          ENDIF
.
          MATCH     SP70,PMVXCRAV
          IF        !@EQUAL
            PACK      KEY5,CODEVK,PMVXCRAV           * Carer Availability
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXCRAV
            ENDIF
          ENDIF
.
          MATCH     SP70,PMVXRCCT
          IF        !@EQUAL
            PACK      KEY5,CODEVJ,PMVXRCCT           * Crit care Xref
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXVXRCCT
            ENDIF
          ENDIF
.
          MOVE      SP70,LXVXAPWD
          MATCH     SP70,PMVXAPWD
          IF        !@EQUAL
            PACK      KEY5,CODEAP,PMVXAPWD,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXVXAPWD
            ENDIF
          ENDIF
          MOVE      PMVXAPBD,LXVXAPBD
.
SET0055   CALL      CLGP0000             * Clear Gp details
          PACK      KEY10,PMPXRHC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0060
          MOVE      PMHCSNAM,RGGPSNAM
          MOVE      PMHCGNAM,RGGPGNAM
          MOVE      PMHCADR1,RGGPADD1
          MOVE      PMHCADR2,RGGPADD2
          MOVE      PMHCADR3,RGGPADD3
          MOVE      PMHCADR4,RGGPADD4
          MOVE      PMHCPOST,RGGPPOST
          MOVE      PMHCFAXN,RGGPFAXN
          MOVE      PMHCSEML,RGGPSEML
          MOVE      PMHCMOBN,RGGPMOBN
          MOVE      PMHCPAGR,RGGPPAGR
          MOVE      PMHCPAGN,RGGPPAGN
          MOVE      PMHCPRV1,RGGPPRV1
          MOVE      PMHCSTEL,RGGPSTEL
.
          PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,LXWRLDFN
.                                                                      *I-52354
          MATCH     "Y",WTWMCSST
          IF        @EQUAL
            MOVE     DYES,LXWRCSST
          ELSE
            MOVE     DNO,LXWRCSST
          ENDIF
.
          MOVE      SP70,LXWRCSDT
          MOVE      "99",CDAY
          UNPACK    WTWMCSDT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRCSDT
.
SET0060   PACK      KEY10,WTWMRFGP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0063
          MOVE      PMHCSNAM,RFGPSNAM
          MOVE      PMHCGNAM,RFGPGNAM
          MOVE      PMHCADR1,RFGPADD1
          MOVE      PMHCADR2,RFGPADD2
          MOVE      PMHCADR3,RFGPADD3
          MOVE      PMHCADR4,RFGPADD4
          MOVE      PMHCPOST,RFGPPOST
.
. get the Registered GP Practice address
.
SET0063   PACK      KEY12,PMPXRH1G,PMPXR1GC
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0065
          MOVE      PMHGPNAM,RGPRSURG
          MOVE      PMHGADD1,RGPRSAD1
          MOVE      PMHGADD2,RGPRSAD2
          MOVE      PMHGADD3,RGPRSAD3
          MOVE      PMHGADD4,RGPRSAD4
          MOVE      PMHGPOST,RGPRSPCD
          MOVE      PMHGPTEL,RGPRTELE
          MOVE      PMHGPFAX,RGPRFAXN
          MOVE      PMHGPEML,RGPRPEML
.
. get the Referring GP Practice address
.
SET0065   PACK      KEY19,URDIM,WMCODE,WMCNT
          CALL      RDTREA1
          BRANCH    OVRCD,SET0068
.
          PACK      KEY8,WTWMGPPC,WTWMGPPT
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0066
          MOVE      PMHGPNAM,RFPRSURG
          MOVE      PMHGADD1,RFPRSAD1
          MOVE      PMHGADD2,RFPRSAD2
          MOVE      PMHGADD3,RFPRSAD3
          MOVE      PMHGADD4,RFPRSAD4
          MOVE      PMHGPOST,RFPRSPCD
          MOVE      PMHGPTEL,RFPRTELE
.
SET0066   PACK      KEY19,URDIM,WMCODE,WMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,SET0068
.
          PACK      KEY12,WTTXRCLP,WTWMGPPT,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0068
          MOVE      PMHGPNAM,LXGPPNAM
          MOVE      PMHGADD1,LXGPPAD1
          MOVE      PMHGADD2,LXGPPAD2
          MOVE      PMHGADD3,LXGPPAD3
          MOVE      PMHGADD4,LXGPPAD4
          MOVE      PMHGPOST,LXGPPPOS
          MOVE      PMHGPTEL,LXGPPTEL
          MOVE      PMHGPFAX,LXGPPFAX
          MOVE      PMHGPEML,LXGPPEML
.
SET0068   PACK      LXTBCANC,SP70
          PACK      LXPREVPA,SP70
          PACK      KEY36,WTWMECNT,ANSP,Z70
          CALL      RSWTESN1
          CALL      RPWTESN1
          BRANCH    OVRCD,SET0070
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      SET0070 IF NOT EQUAL
.
          MATCH     ANSP,WTENETYP
          GOTO      SET0070 IF NOT EQUAL
.
          PACK      KEY5,ANSS,ANSC,WTENEVAL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SET0070
.
          PACK      LXTBCANC,TDESC,SP70
.
          PACK      KEY10,WTENSADI,SP70
          PACK      KEY36,WTENUNIQ,ANSS,WTENEVDT,Z70
          CALL      RSWTESN1
SET0069   CALL      RPWTESN1
          BRANCH    OVRCD,SET0070
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      SET0070 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP
          GOTO      SET0070 IF NOT EQUAL
.
          MATCH     WTENSADI,KEY10
          GOTO      SET0069 IF NOT EQUAL
.
          UNPACK    WTENEVAL,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                 * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXPREVPA
.
SET0070   MOVE      SP20,TDESC
          MATCH     SP3,ELECATYP
          GOTO      SET0071 IF EQUAL
          PACK      KEY5,ANSC,ANSC,ELECATYP
          CALL      RDCODE1
          BRANCH    OVRCD,SET0071
          MOVE      TDESC,EADMDESC
.
SET0071   MATCH     "                         ",RESPADDA
          GOTO      SET0072 IF NOT EQUAL
.         MOVE      "*************************",RESPADDA
.
SET0072   MATCH     "                              ",RFDADD1
          GOTO      SET0073 IF NOT EQUAL
          MOVE      "******************************",RFDADD1
.
SET0073   MATCH     "                              ",RFDADD2
          GOTO      SET0074 IF NOT EQUAL
          MOVE      "******************************",RFDADD2
.
SET0074   MATCH     "      ",RESPSEX
          GOTO      SET0075 IF NOT EQUAL
          MOVE      "******",RESPSEX
.
SET0075   MATCH     "                         ",RESPADDB
          GOTO      SET0080 IF NOT EQUAL
.         MOVE      "*************************",RESPADDB
.
SET0080   MATCH     "               ",RESPSUBR
          GOTO      SET0085 IF NOT EQUAL
.         MOVE      "***************",RESPSUBR
.
SET0085   MATCH     "    ",RESPPOST
          GOTO      SET0090 IF NOT EQUAL
.         MOVE      "****",RESPPOST
.
SET0090   
.         MATCH     "                         ",PADD1
.         GOTO      SET0140 IF NOT EQUAL
.         MOVE      "*************************",PADD1
.
SET0140   
.         MATCH     "                         ",PADD4
.         GOTO      SET0141 IF NOT EQUAL
.         MOVE      "*************************",PADD4
.
SET0141   
.         MATCH     "                         ",PSUBRB
.         GOTO      SET0144 IF NOT EQUAL
.         MOVE      "*************************",PSUBRB
.
SET0144   
.         MATCH     "                         ",PADD2
.         GOTO      SET0146 IF NOT EQUAL
.         MOVE      "*************************",PADD2

.
SET0146   MATCH     "                         ",PGNAME
          GOTO      SET0148 IF NOT EQUAL
          MOVE      "*************************",PGNAME
.
SET0148   MATCH     "                    ",PSNAME
          GOTO      SET0150 IF NOT EQUAL
          MOVE      "********************",PSNAME
.
SET0150   
.         MATCH     "    ",PPOST
.         GOTO      SET0155 IF NOT EQUAL
.         MOVE      "****",PPOST
.
SET0155   MATCH     "            ",PTELEP
          GOTO      SET0160 IF NOT EQUAL
          MOVE      "************",PTELEP
.
SET0160   MATCH     "                    ",BTYPE
          GOTO      SET0164 IF NOT EQUAL
          MOVE      "********************",BTYPE
.
SET0164   MATCH     "                    ",PACCOM
          GOTO      SET0166 IF NOT EQUAL
          MOVE      "********************",PACCOM
.
SET0166   MATCH     SP70,PDESC
          GOTO      SET0170 IF NOT EQUAL
          MOVE      "*************************************************",PDESC
.
SET0170   MATCH     "                    ",REFUNIT
          GOTO      SET0175 IF NOT EQUAL
          MOVE      "********************",REFUNIT
.
SET0175   MATCH     "                    ",REFPRTY
          GOTO      SET0180 IF NOT EQUAL
          MOVE      "********************",REFPRTY
.
SET0180   
.         MATCH     "               ",PSUBRB
.         GOTO      SET0181 IF NOT EQUAL
.         MOVE      "***************",PSUBRB
.
SET0181   MATCH     "    ",PTITL
          GOTO      SET0182 IF NOT EQUAL      * C CAR 45249
          MOVE      "****",PTITL
.
SET0182   MOVE      PSEX,DSEXCHAR     
          CALL      SEXDSP00	  
          MOVE      DSEXASC1,RESPSEX    
          GOTO      SET0190
.
SET0190   CALL      IBACLOCK                  * I CAR 45249
          PACK      AGEDATE,CC,YY,MM,DD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          MOVE      PSAGEYRS,DIMAGE           * end I CAR 45249

.
... Set up all booking and booking extension variable
.
SET8000   MOVE      BKREBOOK,LXKREBOO         * Booking Number
... Reset the Booking Data to Spaces for each letter
... to prevent assigning value from previous printed
... letter
.
          MOVE      SP70,LXREADOC             * Attending Doctor
          MOVE      SP70,LXRESDOC             * Referring Doctor
          MOVE      SP70,LXRETYPE             * Booking Type
          MOVE      SP70,LXRECANC             * Cancel Reason
          MOVE      SP70,LXREACCM             * Pref Accom
          MOVE      SP70,LXREPROC             * Procedure
          MOVE      SP70,LXREWARD             * Expected Ward
          MOVE      SP70,LXRECLSS             * Adm Class
          MOVE      SP70,LXREATYP             * Adm Type
          MOVE      SP70,LXREDEPT             * Department
          MOVE      SP70,LXRETDOC             * Associate Doctor
          MOVE      SP70,LXRERFGP             * Referral GP Doctor
          MOVE      SP70,LXREEATY             * Elective Admission Type
.
          MOVE      SP70,LXRXPOWD             * Post Operative Ward
          MOVE      SP70,LXRXOPRD             * Operation Period
          MOVE      SP70,LXRXASRC             * Admission Source
          MOVE      SP70,LXRXBLDT             * Blood Type
          MOVE      BKREURNO,LXREURNO         * U/R
.
          PACK      KEY6,BKREADOC,SP70        * Attending Doct
          CALL      RDDOCT1
          IF        OVRCD = 0
            MOVE      DSNAME,PACSNAME
            MOVE      DGNAME,PACGNAME
            MOVE      DTITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXREADOC
          ENDIF
.
          PACK      KEY6,BKRESDOC,SP70        * Attending Doct
          CALL      RDDOCT1
          IF        OVRCD = 0
            MOVE      DSNAME,PACSNAME
            MOVE      DGNAME,PACGNAME
            MOVE      DTITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXRESDOC
          ENDIF
.
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                 * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREEDAT
.
          MOVE      BKREATIM,LXREATIM         * Booking Time
.
          MOVE      "99",CDAY
          UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                 * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREPDAT
.
          MOVE      BKREPTIM,LXREPTIM         * Pre-ass Time
.
          MOVE      "99",CDAY
          UNPACK    BKREADAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREADAT
.
          MATCH     SP70,BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,CODEBK,BKRETYPE,SP70 * Booking Type
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRETYPE
            ENDIF
          ENDIF
.
          MATCH     SP70,BKRECANC
          IF        !@EQUAL
            PACK      KEY5,CODEBC,BKRECANC,SP70 * Canc Reason
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRECANC
            ENDIF
          ENDIF
.
          MATCH     SP70,BKREACCM
          IF        !@EQUAL
            PACK      KEY5,CODEBP,BKREACCM,SP70 * Pref Accom
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXREACCM
            ENDIF
          ENDIF
.
          PACK      KEY9,BKREPROC,SP70         * Procedure
          CALL      RDPROA1
          IF        OVRCD = 0
            MOVE      WPDESC,LXREPROC
          ENDIF
.
          MOVE      BKRECNT,LXKRECNT           * Prodedure count
.
          PACK      KEY6,BKREWARD,SP70         * Expected ward
          CALL      RDWARD1
          IF        OVRCD = 0
            MOVE      WBDESC,LXREWARD
          ENDIF
.
          MOVE      BKREEBED,LXREEBED
.
          MATCH     SP70,BKRECLSS
          IF        !@EQUAL
            PACK      KEY5,CODEP,BKRECLSS,SP70   * Adm class
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRECLSS
            ENDIF
          ENDIF
.
          MATCH     SP70,BKREATYP
          IF        !@EQUAL
            PACK      KEY5,CODEA,BKREATYP,SP70   * Adm Type
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXREATYP
            ENDIF
          ENDIF
.
          MATCH     SP70,BKREDEPT
          IF        !@EQUAL
            PACK      KEY5,CODEAC,BKREDEPT,SP70  * Department
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXREDEPT
            ENDIF
          ENDIF
.
          PACK      KEY6,BKRETDOC,SP70        * Associated Doct
          CALL      RDDOCT1
          IF        OVRCD = 0
            MOVE      DSNAME,PACSNAME
            MOVE      DGNAME,PACGNAME
            MOVE      DTITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXRETDOC
          ENDIF
.
          MOVE      SP70,LXRECLMT
          MATCH     SP70,BKRECLMT
          IF        !@EQUAL
            PACK      KEY5,CODECL,BKRECLMT,SP70  * Claim Type
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRECLMT
            ENDIF
          ENDIF
.
          PACK      KEY10,BKRERFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXRERFGP
          ENDIF
.
          MOVE      BKREGPPC,LXREGPPC
          MOVE      SP70,LXRERESI 
.
          MATCH     SP70,BKRERESI
          IF        !@EQUAL
            PACK      KEY5,CODET,BKRERESI,SP70   * Resident
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRERESI
            ENDIF
          ELSE
            MATCH     SP70,PTYPE
            IF        !@EQUAL
              PACK      KEY5,CODET,PTYPE,SP70   * Resident
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE      TDESC,LXRERESI
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,BKREEATY
          IF        !@EQUAL
            PACK      KEY5,CODECC,BKREEATY,SP70  * Elective Adm Type
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXREEATY
            ENDIF
          ENDIF
.
          MOVE      BKREELOS,LXKREELO
.
          MOVE      "99",CDAY
          UNPACK    BKREBKDT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                   * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREBKDT
.
          PACK      KEY6,BKRXPOWD,SP70         * Post op ward
          CALL      RDWARD1
          IF        OVRCD = 0
            MOVE      WBDESC,LXRXPOWD
          ENDIF
.
          MOVE      SP70,LXRXADWD
          MATCH     SP70,BKRXADWD
          IF        !@EQUAL
            MOVE      "ap",TCODE
            PACK      KEY5,TCODE,BKRXADWD,SP70  * Admitting Ward
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRXADWD
            ENDIF
          ENDIF
.
          MOVE      "99",CDAY
          UNPACK    BKRXCDTE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                   * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXRXCDTE
.
          MATCH     "1",BKRXPSTY
          IF        @EQUAL
            MOVE      DYES,LXRXPSTY
          ELSE
            MOVE      DNO,LXRXPSTY
          ENDIF
.
.         Confirmed Operation Date
.
          MOVE      "99",CDAY
          COMPARE   ONE,CTHETR
          IF        @EQUAL
            CALL      GETOP000
          ELSE 
            UNPACK    BKRXCNDT,CCENT,CYEAR,CMON,CDAY
            CALL      FDAT0000                   * Format Date XX/XX/XXXX
            MOVE      DATELINE,LXRXCNDT
          ENDIF
.
          MOVE      BKRXUFF1,LXRXUFF1          * Procedure Desc
          MOVE      BKRXUFF2,LXRXUFF2
          MOVE      BKRXUFF3,LXRXUFF3
.
.         Proposed Operation date
.
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
..          UNPACK    BKRXODTE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                   * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXRXODTE
.
          MATCH     SP70,BKRXOPRD
          IF        !@EQUAL
            PACK      KEY5,CODESP,BKRXOPRD,SP70  * Operation Period
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRXOPRD
            ENDIF
          ENDIF
.
          MATCH     SP70,BKRXASRC
          IF        !@EQUAL
            PACK      KEY5,CODES,BKRXASRC,SP70   * Admission source
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXRXASRC
            ENDIF
          ENDIF
.
          MATCH     SP70,BKRXBLDT
          IF        !@EQUAL
            PACK      KEY5,CODEBO,BKRXBLDT,SP70  * Blood Type LXRXBLDT
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRXBLDT
            ENDIF
          ENDIF
.
          MOVE      BKRXCTTY,F3
          MOVE      F3,BKRXCTTY
          MOVE      ZERO,F3
          MOVE      F3,D3
          PACK      KEY6,BKRXCTTY,D3
          CALL      RDLET1
          IF        OVRCD = 0
            MOVE      WLTEXT,LXRXCTTY
          ENDIF
.
          MATCH     "1",BKRXSGBK               *  Surgical Booking
          IF        @EQUAL
            MOVE     DYES,LXRXSGBK
          ELSE
            MOVE     DNO,LXRXSGBK
          ENDIF
.
          MOVE      SP70,LXWRPRED
          MOVE      "99",CDAY                                          *I-59792
          UNPACK    WTWMREAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRED
.
          MOVE      SP70,LXWXPRET
          MOVE      "99",HOUR
          UNPACK    WTTXPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRET
.
          MOVE      SP70,LXWXADMW
          MATCH     SP70,WTTXADMW
          GOTO      SET8500 IF EQUAL
          PACK      KEY5,CATAP,WTTXADMW,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SET8500
          MOVE      TDESC,LXWXADMW                                 *end I-59792
.
SET8500   MOVE      SP70,LXWRPRAD                                      *I-60667
          MOVE      "99",CDAY
          UNPACK    WMDATE3,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRAD
.
          MOVE      SP70,LXWXPRAT
          MOVE      "99",HOUR
          UNPACK    WTTXPATM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRAT
.
          MOVE      SP70,LXWRPROD
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPROD
.
          MOVE      SP70,LXWXPROT
          MOVE      "99",HOUR
          UNPACK    WTTXPOTM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPROT                              *end I-60667
.
          MOVE      SP70,LXWRPAND
          MOVE      "99",CDAY                                       
          UNPACK    WTWMTRPA,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPAND
.
          MOVE      SP70,LXWXPANT
          MOVE      "99",HOUR
          UNPACK    WTTXPANT,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPANT
.
          CALL      PACC0000
          CALL      PACLOC00
.
          CALL      PASC0000
          CALL      PASLOC00
.
          MOVE      SP70,LXPMIXWD
          PACK      KEY6,PTMIXWRD,SP70
          CALL      RDAWARD1
          CALL      RDKWARD1
          IF        OVRCD = 0
            MATCH     PTMIXWRD,WWARD
            IF        @EQUAL
              MOVE      WBDESC,LXPMIXWD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXPMIATM
          MOVE      "99",HOUR
          UNPACK    ATIME,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXPMIATM
.
          MOVE      SP70,LXPMIADT
          MOVE      "99",CDAY
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIADT
.
          MOVE      SP70,LXWRDESC
          MATCH     SP70,WMDESC
          IF        !@EQUAL|!@EOS
            MOVE      WMDESC,LXWRDESC
          ENDIF
.
          MOVE      SP70,LXPMIDOB
          MOVE      "99",CDAY
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIDOB
.         
          MOVE      SP70,LXWRLPCC
          MOVE      SP70,LXWRLDPC
.
          MOVELPTR  PMHCPRFC,F1
          COMPARE   F1,ZERO
          GOTO      SET8600 IF EQUAL    * PMHCPRFC has not been read
.
          MOVE      PMHCPRFC,LXWRLPCC
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRLDPC  * Local GP Preferred Method of Contact
            ENDIF   
          ENDIF 
.
.------ move all the form totals to dims and ------
.------ compress any multiple blanks ------
.
SET8600   MOVE      BOOKNO,IDDIM1
.
          MOVE      SP70,LXUDEF5
          MOVE      SP70,LXUDEF6
          MOVE      SP70,LXUDEF7
          MOVE      SP70,LXUDEF8
.
          MATCH     SP3,WMUDEF5
          IF        !@EQUAL
            PACK      KEY5,CODEX5,WMUDEF5
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF5
              MOVE      LXUDEF5,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF5
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF6
          IF        !@EQUAL
            PACK      KEY5,CODEX6,WMUDEF6
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF6
              MOVE      LXUDEF6,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF6
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF7
          IF        !@EQUAL
            PACK      KEY5,CODEX7,WMUDEF7
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF7
              MOVE      LXUDEF7,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF7
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF8
          IF        !@EQUAL
            PACK      KEY5,CODEX8,WMUDEF8
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF8
              MOVE      LXUDEF8,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF8
            ENDIF
          ENDIF
.
          MOVE      SP70,LXREMCOD
          MOVE      SP70,LXREMDES
          MOVE      SP70,LXRELDES
          MATCH     SP3,WMREMOVE
          IF        !@EQUAL
            PACK      LXREMCOD,WMREMOVE,SP70
            PACK      KEY5,CODEWR,WMREMOVE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXREMDES
              MOVE      LXREMDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXREMDES
              MOVE      PTCDLDES,LXRELDES
              MOVE      LXRELDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXRELDES          
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWRSRCR
          MATCH     SP70,WTWMSRCR
          IF        !@EQUAL
            PACK      KEY5,CODES,WTWMSRCR,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRSRCR
              MOVE      LXWRSRCR,LINE
              CALL      CASE0000
              MOVE      LINE,LXWRSRCR
            ENDIF
          ENDIF
.
          MOVE      SP70,LXREMDAT
          MOVE      "99",CDAY
          UNPACK    WMDATE4,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXREMDAT
.
          MOVE      WTWMRANK,LXPRANK
          MOVE      WMREASON,LXWRWLDI
.
          MOVE      SP70,LXWTCHOV
          MOVE      SP70,LXWTCHRD
          MOVE      SP70,LXWTCHRC
.
          PACK      KEY35,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTCHA1
SET8710   CALL      RPWTCHA1
          BRANCH    OVRCD,SET8720 
.
          MATCH     WMURNO,WTCHURNO
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     WMCODE,WTCHPROC
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     DWMCNT,WTCHPCNT
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     "02",WTCHUPTY
          GOTO      SET8710 IF NOT EQUAL
.
          MOVE      WTCHOVAL,LXWTCHOV
          MOVE      WTCHREAS,LXWTCHRC
.
          MATCH     SP70,WTCHREAS
          GOTO      SET8720 IF EQUAL
.
          PACK      KEY5,ANSW,ANSD,WTCHREAS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SET8720
.
          MOVE      TDESC,LXWTCHRD
.
SET8720   MOVE      SP70,NAFDATE
          MOVE      SP70,NATDATE
          MOVE      SP70,LXWNRCDY
          MOVE      SP70,LXWNRCDP
          MOVE      SP70,LXWNRCDC
          MOVE      SP70,LXWTSUFT
          MOVE      SP70,LXWTSUTT
          MOVE      SP70,LXWTSURC
          MOVE      SP70,LXWTSURD
.
          PACK      KEY21,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTSUS1
          CALL      RPWTSUS1
          BRANCH    OVRCD,SET8750
.
          MATCH     WMURNO,WTSUURNO
          GOTO      SET8750 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      SET8750 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      SET8750 IF NOT EQUAL
.
          MATCH     SP70,WTSUFDAT
          IF        !@EQUAL
            UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      NAFDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      NATDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CALL      IBACLOCK
            PACK      DIM8,CC,YY,MM,DD
            REP       " 0",DIM8
.
            MATCH     DIM8,WTSUTDAT
            GOTO      SET8730 IF NOT LESS
.
          ELSE
.
SET8730     MATCH       SP70,WTSUFDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUFDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUFT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MATCH       SP70,WTSUTDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUTDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUTT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MOVE        WTSUREAS,LXWTSURC
.
            MATCH       SP70,WTSUREAS
            IF          !@EQUAL & !@EOS
              PACK        KEY5,ANSW,ANSN,WTSUREAS,SP70
              CALL        RDCODE1
              IF          OVRCD=0
                MOVE        TDESC,LXWTSURD
              ENDIF
            ENDIF 
.
          ENDIF
.
          MOVE      SP70,WLTYCODE
          CALL      SNRCDY00
          MOVE      NRFCDAYS,LXWNRCDY	
.
          MOVE      ANSP,WLTYCODE
          CALL      SNRCDY00
          MOVE      NRFCDAYS,LXWNRCDP	
.
          MOVE      ANSC,WLTYCODE
          CALL      SNRCDY00
          MOVE      NRFCDAYS,LXWNRCDC	
.
SET8750   MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,LXIHINUM
          ENDIF
.
.------  move all names, addresses etc to LINE and convert to lower case ------
.
          MOVE      PSEX,LINE
          CALL      CASE0000
          MOVE      LINE,PSEX
.
          MOVE      BTYPE,LINE
          CALL      CASE0000
          MOVE      LINE,BTYPE
          MOVE      PACCOM,LINE
          CALL      CASE0000
          MOVE      LINE,PACCOM
          MOVE      PDESC,LINE
          CALL      CASE0000
          MOVE      LINE,PDESC
          MOVE      REFUNIT,LINE
          CALL      CASE0000
          MOVE      LINE,REFUNIT
          MOVE      REFPRTY,LINE
          CALL      CASE0000
          MOVE      LINE,REFPRTY
.
.         MOVE      PADD1,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD1
.
.         MOVE      PADD2,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD2
.
.         MOVE      PSUBRB,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSUBRB
.
.         MOVE      PADD4,LINE
.         CALL      CASE0000
.         MOVE      LINE,PADD4
.
          REP       UPPLOW,PADD4
.
.         MOVE      PTITL,LINE
.         CALL      CASE0000
.         MOVE      LINE,PTITL
          MOVE      RESPNAME,LINE
          CALL      CASE0000
          MOVE      LINE,RESPNAME
.         MOVE      PGNAME,LINE
.         CALL      CASE0000
.         MOVE      LINE,PGNAME
.         MOVE      PSNAME,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSNAME
.
          MOVE      PTMASNAM,LXPTLSNM            * Patient Long Surname
          MOVE      LXPTLSNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXPTLSNM
.
          CALL      PMAST000
.
          MOVE      RESPSEX,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSEX
.
          MOVE      RESPADDA,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDA
          MOVE      RESPADDB,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDB
          MOVE      RESPSUBR,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSUBR
.         MOVE      PSUBRB,LINE
.         CALL      CASE0000
.         MOVE      LINE,PSUBRB
          MOVE      EADMDESC,LINE
          CALL      CASE0000
          MOVE      LINE,EADMDESC

          MOVE      PTHSNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSNAME
.
          MOVE      PTHSADD1,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD1
.
          MOVE      PTHSADD2,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD2
.
          MOVE      PTHSADD3,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD3
.
          MOVE      PTHSADD4,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD4
.
          MOVE      RGPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSURG
          MOVE      RGPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD1
          MOVE      RGPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD2
          MOVE      RGPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD3
          MOVE      RGPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD4
          MOVE      RGPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRTELE
.
          MOVE      RFPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSURG
          MOVE      RFPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD1
          MOVE      RFPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD2
          MOVE      RFPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD3
          MOVE      RFPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD4
          MOVE      RFPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRTELE
.
          MOVE      RFGPPNAM,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPNAM
          MOVE      RFGPPAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPAD1
          MOVE      RFGPPAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPAD2
          MOVE      RFGPPAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPAD3
          MOVE      RFGPPAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPAD4
          MOVE      RFGPPPOS,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPPOS
          MOVE      RFGPPTEL,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPTEL
          MOVE      RFGPPFAX,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPFAX
          MOVE      RFGPPEML,LINE
          CALL      CASE0000
          MOVE      LINE,RFGPPEML
.
          MOVE      PTMXCELL,LINE              * load cellular phone number
          CALL      CASE0000
          MOVE      LINE,LXCELL
          MOVE      PTMXADD1,LINE              * load postal address line 1
          CALL      CASE0000
          MOVE      LINE,LXPADDA
          MOVE      PTMXADD2,LINE              * load postal address line 2
          CALL      CASE0000
          MOVE      LINE,LXPADDB
          MOVE      PTMXADD3,LINE              * load postal address line 3
          CALL      CASE0000
          MOVE      LINE,LXPADDC
          MOVE      PTMXADD4,LINE              * load postal address line 4
          CALL      CASE0000
          MOVE      LINE,LXPADDD
          MOVE      PTMXPOST,LINE              * load postal Post Code
          CALL      CASE0000
          MOVE      LINE,LXPPOST
.
          CALL      GSMSID00                 * Get SMS message id
          MOVE      IBSQNEXT,LXXSMSID        * SMS message id
.
          PACK      LXXSMSKY,SP1,NINE,WMURNO,WMCODE,WMCNT,SP70  * SMS key
          MOVE      LETTER,LXSMSCOD          * SMS Code (Letter Number)
          MOVE      PTMXCELL,LXXSMSPH        * SMS Phone Number
          MOVE      PURNO,LXXSMSUR           * SMS U/R
          MOVE      SP70,LXXSMSUS            * SMS User
          MOVE      SP70,LXXSMSUN            * SMS User Name
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD<>1
           MATCH      PASSCODE,WBSEPCD
           IF         @EQUAL
             MOVE      WBSEUID,LXXSMSUS      * SMS User
             MOVE      WBSENAM,LXXSMSUN      * SMS User Name
           ENDIF
          ENDIF
.
          MOVE      SP70,LXWXIDUS
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,CODEVI,WTTXINTD           * Intended stay duration
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXWXIDUS
            ENDIF
          ENDIF
.
          MOVE      WMSTAY,LXWTSTAY
.
          MOVE      SP70,LXARDATE
          MOVE      "99",CDAY
          UNPACK    WMKEYDT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXARDATE
.
          MOVE      PMPXUCC4,LXPXUCC4          * Identify gender
          MOVE      PMPXATF1,LXPXATF1          * Identify gender Free Text
          MOVE      PMPXUCC5,LXPXUCC5          * Identify pronoun
          MOVE      PMPXATF2,LXPXATF2          * Identify Pronoun Free Tex
.
          MOVE      PMPXSN18,LXPXSN18
          MOVE      PMPXSN19,LXPXSN19
          MOVE      PMPXSN20,LXPXSN20
          MOVE      PMPXSN21,LXPXSN21
          MOVE      PMPXSN22,LXPXSN22
          MOVE      PMPXSN23,LXPXSN23
          MOVE      PMPXSN24,LXPXSN24
          MOVE      PMPXSN25,LXPXSN25
          MOVE      PMPXSN26,LXPXSN26
          MOVE      PMPXSN27,LXPXSN27
          MOVE      PMPXSN28,LXPXSN28
          MOVE      PMPXSN29,LXPXSN29
          MOVE      PMPXSN30,LXPXSN30
.
          MOVE      PMPXUSR7,LXPUSRGC
          MOVE      SP70,LXPUSRGD
          MOVE      SP70,LXPUSRGL
.
          MATCH     SP70,PMPXUSR7
          IF        !@EQUAL
            PACK      KEY5,ANSP,SEVEN,PMPXUSR7,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRGD
            MOVE      PTCDLDES,LXPUSRGL
          ENDIF
.
          MOVE      PMPXUSR8,LXPUSRHC
          MOVE      SP70,LXPUSRHD
          MOVE      SP70,LXPUSRHL
.
          MATCH     SP70,PMPXUSR8
          IF        !@EQUAL
            PACK      KEY5,ANSP,EIGHT,PMPXUSR8,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRHD
            MOVE      PTCDLDES,LXPUSRHL
          ENDIF
.
          MOVE      PMPXUSR9,LXPUSRIC
          MOVE      SP70,LXPUSRID
          MOVE      SP70,LXPUSRIL
.
          MATCH     SP70,PMPXUSR9
          IF        !@EQUAL
            PACK      KEY5,ANSP,NINE,PMPXUSR9,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRID
            MOVE      PTCDLDES,LXPUSRIL
          ENDIF
.
          MOVE      SP70,LXUCC4LD
          MATCH     SP70,PMPXUCC4
          IF        !@EQUAL
            MOVE      "Gi",DIM2
            PACK      KEY5,DIM2,PMPXUCC4,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,LXUCC4LD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXUCC5LD
          MATCH     SP70,PMPXUCC5
          IF        !@EQUAL
            MOVE      "Gp",DIM2
            PACK      KEY5,DIM2,PMPXUCC5,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDLDES,LXUCC5LD
            ENDIF
          ENDIF
.
          GOTO      SET9999
.
SET9000   MOVE      TRUE,EXIT
.
SET9999   RETURN
+
.-----------------------------------------------------------------------------
. Print patient master deails
.-----------------------------------------------------------------------------
PMAST000  MOVE      PUSR1,LXPUSRAC
          MOVE      SP70,LXPUSRAD
          MOVE      SP70,LXPUSRAL
.
          MATCH     SP70,PUSR1
          IF        !@EQUAL
            PACK      KEY5,ANSP,ONE,PUSR1,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRAD
            MOVE      PTCDLDES,LXPUSRAL
          ENDIF
.
          MOVE      PUSR2,LXPUSRBC
          MOVE      SP70,LXPUSRBD
          MOVE      SP70,LXPUSRBL
.
          MATCH     SP70,PUSR2
          IF        !@EQUAL
            PACK      KEY5,ANSP,TWO,PUSR2,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRBD
            MOVE      PTCDLDES,LXPUSRBL
          ENDIF
.
          MOVE      PUSR3,LXPUSRCC
          MOVE      SP70,LXPUSRCD
          MOVE      SP70,LXPUSRCL
.
          MATCH     SP70,PUSR3
          IF        !@EQUAL
            PACK      KEY5,ANSP,THREE,PUSR3,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRCD
            MOVE      PTCDLDES,LXPUSRCL
          ENDIF
.
          MOVE      PUSR4,LXPUSRDC
          MOVE      SP70,LXPUSRDD
          MOVE      SP70,LXPUSRDL
.
          MATCH     SP70,PUSR4
          IF        !@EQUAL
            PACK      KEY5,ANSP,FOUR,PUSR4,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRDD
            MOVE      PTCDLDES,LXPUSRDL
          ENDIF
.
          MOVE      PUSR5,LXPUSREC
          MOVE      SP70,LXPUSRED
          MOVE      SP70,LXPUSREL
.
          MATCH     SP70,PUSR5
          IF        !@EQUAL
            PACK      KEY5,ANSP,FIVE,PUSR5,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRED
            MOVE      PTCDLDES,LXPUSREL
          ENDIF
.
          MOVE      PUSR6,LXPUSRFC
          MOVE      SP70,LXPUSRFD
          MOVE      SP70,LXPUSRFL
.
          MATCH     SP70,PUSR6
          IF        !@EQUAL
            PACK      KEY5,ANSP,SIX,PUSR6,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,TDESC
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      TDESC,LXPUSRFD
            MOVE      PTCDLDES,LXPUSRFL
          ENDIF
.
PMAST999  RETURN
.
.-------------------------------------------------------------------------
. Calculate Not Ready for Care Days - Total, Patient, Clinical 
.-------------------------------------------------------------------------
SNRCDY00  READ      CONTROLF,HUND11;*11,WTCNERFC
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MOVE      ZERO,NRFCDAYS
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,SNRCDY99
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
SNRCDY10  CALL      RKWTSUS1
          BRANCH    OVRCD,SNRCDY99
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      SNRCDY99 IF NOT EQUAL
.
          MOVE      WTSUAUTO,KEY1
          PACK      KEY5,ANSV,ANSL,WTSULSTS
          CALL      RDCODE1
          BRANCH    OVRCD,SNRCDY10
.
          MATCH     "R",TCINDC1
          GOTO      SNRCDY10 IF EQUAL
.
          MATCH     SP70,WLTYCODE
          GOTO      SNRCDY20 IF EQUAL
.          
          PACK      KEY5,ANSW,ANSN,WTSUREAS
          CALL      RDCODE1
          BRANCH    OVRCD,SNRCDY10
.
          MATCH     WLTYCODE,TCINDC3
          GOTO      SNRCDY10 IF NOT EQUAL
.
SNRCDY20  MATCH     WTSUFDAT,TODAY
          GOTO      SNRCDY10 IF LESS
.
          MATCH     "1",WTCNERFC
          IF        @EQUAL
            MATCH     WMKEYDT,WTSUFDAT
            IF        @LESS
              PACK      WTSUFDAT,WMKEYDT
            ENDIF
            MATCH     SP70,WTSUTDAT
            IF        !@EQUAL
              MATCH     WMKEYDT,WTSUTDAT
              IF        @LESS
                PACK      WTSUTDAT,WMKEYDT
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      TODAY,WTSUTDAT
          ELSE
            MATCH     WTSUTDAT,TODAY
            GOTO      SNRCDY40 IF NOT LESS
            MOVE      TODAY,WTSUTDAT
          ENDIF
.
SNRCDY40  DAYSEP    WTSUFDAT,WTSUTDAT,F4
          ASSIGN    F4+NRFCDAYS,NRFCDAYS 
          GOTO      SNRCDY10
.
SNRCDY99  RETURN
+
.**********************************************************************
.*                           GETOP000                                 *
.*                routine to get Theatre details                      *
.**********************************************************************
GETOP000  PACK      KEY31,BKREBOOK,ZERO,SP70
          CALL      RSOPDEA2
GETOP100  CALL      RKOPDEA2
          BRANCH    OVRCD,GETOP999          * No theatre Bookings
.
          MATCH     BKREBOOK,OPDAADMN
          GOTO      GETOP999 IF NOT EQUAL   * No theatre Bookings
.
          COMPARE   THREE,OPDASTAT
          GOTO      GETOP100 IF EQUAL       * Cancelled Bookings
.
.         Found a booking
.
          MOVE      "99",CDAY
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                   * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXRXCNDT
.          
GETOP999  RETURN
+
.**********************************************************************
.*                           FNAM0000                                 *
.*                routine to Format patient's NAMe                    *
.**********************************************************************
FNAM0000  CLEAR     NAMELINE
          RESET     PTITL
          MATCH     SP4,PTITL               * test title for spaces
          GOTO      FNAM2000 IF EQUAL
.
FNAM0500  CMATCH    SP1,PTITL
          GOTO      FNAM1000 IF EQUAL
          MOVE      PTITL,ANS               * append title to nameline
          APPEND    ANS,NAMELINE
          BUMP      PTITL
          GOTO      FNAM1000 IF EOS

....      BUMP      PTITL
....      GOTO      FNAM1000 IF EOS
          GOTO      FNAM0500
.
FNAM1000  RESET     PTITL 
          APPEND    DOT,NAMELINE
          APPEND    SP1,NAMELINE
          MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1700 IF EQUAL
.
FNAM1500  APPEND    PGNAME,NAMELINE         * append given name to nameline
          APPEND    SP1,NAMELINE
.
FNAM1700  APPEND    PSNAME,NAMELINE
          RESET     NAMELINE
          MOVE      NAMELINE,LINE           * append surname to name line
          CALL      COMP0000                * compress blanks
.         CALL      CASE0000                * convert to lower case
          MOVE      LINE,NAMELINE
          GOTO      FNAM9999
.
FNAM2000  MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1500 IF NOT EQUAL
          GOTO      FNAM1700
.
FNAM9999  RETURN
.
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBKRX00  MOVE      SP70,BKRXPOWD  *  Post-Op Ward (patwr1af)
          MOVE      SP70,BKRXADWD  * Admitting Ward (patwr1af)
          MOVE      SP70,BKRXCDTE  * Contact Date (ccyymmdd)
          MOVE      SP70,BKRXPSTY  * Parent Staying (0=NO,1=YES)
          MOVE      SP70,BKRXCNDT  * Confirmation Date (ccyymmdd)
          MOVE      SP70,BKRXUDF1  * User Defined Field 1 (Cat BE)
          MOVE      SP70,BKRXUDF2  * User Defined Field 2 (Cat BF)
          MOVE      SP70,BKRXUDF3  * User Defined Field 3 (Cat BG)
          MOVE      SP70,BKRXUDF4  * User Defined Field 4 (Cat BH)
          MOVE      SP70,BKRXUDF5  * User Defined Field 5 (Cat BL)
          MOVE      SP70,BKRXUDD1  * User Defined Date 1 (ccyymmdd)
          MOVE      SP70,BKRXUDD2  * User Defined Date 2 (ccyymmdd)
          MOVE      SP70,BKRXUDD3  * User Defined Date 3 (ccyymmdd)
          MOVE      SP70,BKRXUDD4  * User Defined Date 4 (ccyymmdd)
          MOVE      SP70,BKRXUFF1  * Procedure Description 1
          MOVE      SP70,BKRXUFF2  * Procedure Description 2
          MOVE      SP70,BKRXUFF3  * Procedure Description 3
          MOVE      SP70,BKRXUFF4  * User Defined Free Format 4
          MOVE      SP70,BKRXEDC1  * Extra Doctor Code 1 (pmshcpaf)
          MOVE      SP70,BKRXEDC2  * Extra Doctor Code 2 (pmshcpaf)
          MOVE      SP70,BKRXEDC3  * Extra Doctor Code 3 (pmshcpaf)
          MOVE      SP70,BKRXODTE  * Operation Date (ccyymmdd)
          MOVE      SP70,BKRXOPRD  * Operation Period (Cat SP)
          MOVE      SP70,BKRXCRDT  * Date record created (ccyymmdd)
          MOVE      SP70,BKRXCRTM  * Time record created (hh:mm:ss)
          MOVE      SP70,BKRXWEBC  * WEB User Id rec. creator (websecaf)
          MOVE      SP70,BKRXLUPD  * Last Update Date (ccyymmdd)
          MOVE      SP70,BKRXLUPT  * Last Update Time (hh:mm:ss)
          MOVE      SP70,BKRXWEBU  * WEB User Id rec. updater (websecaf)
          MOVE      SP70,BKRXASRC  * Admission Source (Category S)
          MOVE      SP70,BKRXBLDT  * Blood Type (category BO)
          MOVE      SP70,BKRXCTTY  * Contact Type (Letter No.-watletaf)
          MOVE      SP70,BKRXPOBD  * Post Op Bed 
          MOVE      SP70,BKRXSGBK  * Surgical Booking
          MOVE      SP70,BKRXDIET  * Diet
          MOVE      SP70,BKRXTRAN  * Transport
          RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBOKREC  MOVE      SP70,BKREURNO  *        U/R
          MOVE      SP70,BKRESNAM  *        Surname
          MOVE      SP70,BKRELOCK  *        Lock variable
          MOVE      SP70,BKREADOC  *        Attending Doctor
          MOVE      SP70,BKRESDOC  *        Referring Doctor
          MOVE      SP70,BKREEDAT  *        Expected due date (CCYYMMDD)
          MOVE      SP70,BKREATIM  *        Expected assessment time
          MOVE      SP70,BKREPDAT  *        Pre-assessment date
          MOVE      SP70,BKREPTIM  *        Pre-assessment time
          MOVE      SP70,BKREADAT  *        Date booking was made CCYYMMDD
          MOVE      SP70,BKRETYPE  *        Booking type (Cat "BK")
          MOVE      SP70,BKRECANC  *        Cancellation reason (Cat "BC")
          MOVE      SP70,BKRESTAT  *        Booking status
          MOVE      SP70,BKREOMEM  *        Benefit fund member (Y/N/U)
          MOVE      SP70,BKREPREV  *        Previous inpatient (Y/N/U)
          MOVE      SP70,BKREACCM  *        Preferred accommodation (Cat BP)
          MOVE      SP70,BKREPROC  *        Waiting list procedure code
          MOVE      SP70,DBKRECNT  *        Waiting list procedure count
          MOVE      SP70,BKREWARD  *        Expected ward
          MOVE      SP70,BKREADMN  *        Maternity admission number
          MOVE      SP70,BKREPREA  *        Deposit paid (Y/N) Matern only
          MOVE      SP70,BKREEBED  *        Expected bed
          MOVE      SP70,BKRECLSS  *        Patient Cat./Adm Class. (Cat P)
          MOVE      SP70,BKREATYP  *        Adm Type/Pat. Class (Cat A)
          MOVE      SP70,BKREDEPT  *        Department (Cat AC)
          MOVE      SP70,BKRETDOC  *        Associated Doctor
          MOVE      SP70,BKRECLMT  *        Claim type (Cat CL)
          MOVE      SP70,BKRERFGP  *        Referring GP
          MOVE      SP70,BKREGPPC  *        GP Practice code
          MOVE      SP70,BKREGPFA  *       GPFH Approval Number
          MOVE      SP70,BKRERESI  *        Resident Status (Cat T)
          MOVE      SP70,BKREEATY  *        Elective Admission Type  (Cat CC)
          MOVE      SP70,BKREECRA  *       ECR Approval Number
          MOVE      SP70,BKREGPPT  *        GP Practice count
          MOVE      SP70,BKREDOFR  *        District of Residence (Cat DA)
          MOVE      SP70,BKREOPER  *        Operator who made I/P Booking
          MOVE      SP70,DBKREELO  *        Expected Length of Stay (Days)
          MOVE      SP70,BKREBKDT  *        Booking date (ccyymmdd)
          MOVE      SP70,BKRESPAR  *        Spare
          MOVE      SP70,BKDICODE
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDICOMM
          MOVE      SP70,BKDISPAR
          MOVE      SP70,BKREINDC
          RETURN
+
.****************************************************************************
.*                              CLGP0000                                    *
.*                          CLear GP details                                *
.****************************************************************************
CLGP0000  MOVE      SP70,RGGPSNAM
          MOVE      SP70,RGGPGNAM
          MOVE      SP70,RGGPADD1
          MOVE      SP70,RGGPADD2
          MOVE      SP70,RGGPADD3
          MOVE      SP70,RGGPADD4
          MOVE      SP70,RGGPPOST
          MOVE      SP70,RGGPFAXN
          MOVE      SP70,RGGPSEML
          MOVE      SP70,RGGPMOBN
          MOVE      SP70,RGGPPAGR
          MOVE      SP70,RGGPPAGN
          MOVE      SP70,RGGPPRV1
          MOVE      SP70,RGGPSTEL
          MOVE      SP70,RFGPSNAM
          MOVE      SP70,RFGPGNAM
          MOVE      SP70,RFGPADD1
          MOVE      SP70,RFGPADD2
          MOVE      SP70,RFGPADD3
          MOVE      SP70,RFGPADD4
          MOVE      SP70,RFGPPOST
.
. Registered GP Practice address
.
          MOVE      SP70,RGPRSURG
          MOVE      SP70,RGPRSAD1
          MOVE      SP70,RGPRSAD2
          MOVE      SP70,RGPRSAD3
          MOVE      SP70,RGPRSAD4
          MOVE      SP70,RGPRSPCD
          MOVE      SP70,RGPRTELE
          MOVE      SP70,RGPRFAXN
          MOVE      SP70,RGPRPEML
.
. Referring GP Practice address
.
          MOVE      SP70,RFPRSURG
          MOVE      SP70,RFPRSAD1
          MOVE      SP70,RFPRSAD2
          MOVE      SP70,RFPRSAD3
          MOVE      SP70,RFPRSAD4
          MOVE      SP70,RFPRSPCD
          MOVE      SP70,RFPRTELE
.
          MOVE      SP70,LXGPPNAM
          MOVE      SP70,LXGPPAD1
          MOVE      SP70,LXGPPAD2
          MOVE      SP70,LXGPPAD3
          MOVE      SP70,LXGPPAD4
          MOVE      SP70,LXGPPPOS
          MOVE      SP70,LXGPPTEL
          MOVE      SP70,LXGPPFAX
          MOVE      SP70,LXGPPEML
          MOVE      SP70,LXWRLDFN
.
CLGP9999  RETURN
+
.*****************************************************************************
.*                             SHSP0000                                      *
.*               Set up HoSPital details for multi hospital                  *
.*****************************************************************************
SHSP0000  PACK      PTHSHOSP,SP30,SP30
          PACK      PTHSNAME,SP30,SP30
          PACK      PTHSADD1,SP30,SP30
          PACK      PTHSADD2,SP30,SP30
          PACK      PTHSADD3,SP30,SP30
          PACK      PTHSADD4,SP30,SP30
          PACK      PTHSPCOD,SP30,SP30
          PACK      PTHSTELE,SP30,SP30
.
          PACK      BKREWARD,BKREWARD,SP3
          MATCH     SP3,BKREWARD
          GOTO      SHSP6000 IF EQUAL
.
SHSP5000  PACK      KEY6,BKREWARD,SP10
          CALL      RDWARD1
          BRANCH    OVRCD,SHSP9999
.
          PACK      KEY3,PTWDHOSN,SP70           * Bookings expected ward 
          CALL      RDPTHSP1                     * hospital
          GOTO      SHSP9999
.
SHSP6000  PACK      KEY3,WTWMIHSP,SP70           * WL Intended hospital
          CALL      RDPTHSP1
          GOTO      SHSP9999
.
SHSP9999  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
OPNOUT99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the site code. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
COTFIL00  MATCH     SP70,CHECKSIT            * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      CHECKSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic name
.------------------------------------------------------------
PACC0000  MOVE      SP70,LXWRPRCC
          MOVE      SP70,LXWRPRAC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PACC1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PACC9000 IF EQUAL
.
          GOTO      PACC1000
.
PACC9000  MOVE      WTOPSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOPSITE,WTOPCLIN,WTOPDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,WTOPSITE,WTOPCLIN,WTOPDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PACC9999
.
            MATCH     WTOPSITE,OCASITE
            GOTO      PACC9999 IF NOT EQUAL
.
            MATCH     WTOPCLIN,OCACLIN
            GOTO      PACC9999 IF NOT EQUAL
          ENDIF
.
          MOVE      OCACLIN,LXWRPRCC
          MOVE      OCADESC,LXWRPRAC
.
PACC9999  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic location
.------------------------------------------------------------
PACLOC00  PACK      KEY36,WTOPOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PACLOC99
.
          MATCH     DOBAOUTN,WTOPOUTN
          GOTO      PACLOC99 IF NOT EQUAL
.
          MOVE      WTOPOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PACLOC99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PACLOC99
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPACLOC
.
PACLOC99  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic name
.------------------------------------------------------------
PASC0000  MOVE      SP70,LXWRPACC
          MOVE      SP70,LXWRPANC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPS1
PASC1000  CALL      RKWTOPS1
          BRANCH    OVRCD,PASC9999
.
          MATCH     WTOSURNO,WMURNO
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCODE,WMCODE
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCOUN,DWMCNT
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     "0",WTOSSTAT
          GOTO      PASC9000 IF EQUAL
.
          GOTO      PASC1000
.
PASC9000  MOVE      WTOSSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOSSITE,WTOSCLIN,WTOSDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,WTOSSITE,WTOSCLIN,XXDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PASC9999
.
            MATCH     WTOSSITE,OCASITE
            GOTO      PASC9999 IF NOT EQUAL
.
            MATCH     WTOSCLIN,OCACLIN
            GOTO      PASC9999 IF NOT EQUAL
          ENDIF
.
          MOVE      OCACLIN,LXWRPACC
          MOVE      OCADESC,LXWRPANC
.
PASC9999  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic location
.------------------------------------------------------------
PASLOC00  PACK      KEY36,WTOSOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PASLOC99
.
          MATCH     DOBAOUTN,WTOSOUTN
          GOTO      PASLOC99 IF NOT EQUAL
.
          MOVE      WTOSOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PASLOC99
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPASLOC
.
PASLOC99  RETURN
.
.------------------------------------------------------------
. Set referring clinician fields (WTTXRCLI)
.------------------------------------------------------------
RCLI0000  MOVE      SP70,LXRCLINF
          MOVE      SP70,LXRCLTLE
          MOVE      SP70,LXRCLSNM
          MOVE      SP70,LXRCLGNM
          MOVE      SP70,LXRCLAD1
          MOVE      SP70,LXRCLAD2
          MOVE      SP70,LXRCLAD3
          MOVE      SP70,LXRCLAD4
          MOVE      SP70,LXRCLPST
.
          MATCH     SP70,WTTXRCLI           * Referring clinician
          GOTO      RCLI9999 IF EQUAL       * blank
.
          PACK      KEY10,WTTXRCLI,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,RCLI9999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXRCLINF
          MOVE      PMHCTITL,LXRCLTLE
          MOVE      PMHCSNAM,LXRCLSNM
          MOVE      PMHCGNAM,LXRCLGNM
          MOVE      PMHCADR1,LXRCLAD1
          MOVE      PMHCADR2,LXRCLAD2
          MOVE      PMHCADR3,LXRCLAD3
          MOVE      PMHCADR4,LXRCLAD4
          MOVE      PMHCPOST,LXRCLPST
.
RCLI9999  RETURN
+
.******************************************************************************
.*                                  NOK20000                                  *
.*                         Get NOK2 Contact Details                           *
.******************************************************************************
NOK20000  PACK      KEY5,CATTC,SP70
          CALL      RDSCODE1
NOK21000  CALL      RDKCODE1
          BRANCH    OVRCD,NOK25000
.
          MATCH     CATTC,TCODE
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      NOK21000 IF EQUAL
.
          MATCH     CONTTYPE,TCINDC1
          IF        @EQUAL
            MATCH     "2",TCINDC3                * indc1=1 and indc3=2
            GOTO      NOK22000 IF EQUAL
          ENDIF
          GOTO      NOK21000
.
NOK22000  PACK      KEY14,PURNO,ACODE,SP70
          CALL      RSPMCEX1
NOK22100  CALL      RKPMCEX1
          BRANCH    OVRCD,NOK25000
.
          MATCH     PURNO,PMCEURNO          * Same U/R
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     ACODE,PMCETYPE          * Same Contact Type
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV            * Ignore if inactive
          GOTO      NOK22100 IF EQUAL
.
          GOTO      NOK29999
.
NOK25000  CALL      CLPMSCEX                * Clear extra contact file vars
.
NOK29999  RETURN
+
.------------------------------------------------------------
.
          INC       IBAWEBCD    
          INC       WATLETCD
          INC       CLPMSPX2
          INC       CALCAGE
          INC       CLPATMIS
          INC       CLPMSCEX
          INC       GTIHINUM
          INC       SMSMESID
.
          INC       PMSCEXCD
          INC       GCCARD00
.
          INC       WATLPCIO/INC
          INC       WATTR1IO/INC
          INC       WATLETIO/INC
          INC       WATVWLIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSCCDIO/INC
          INC       PATHSPIO/INC
          INC       WATLHIIO/INC
          INC       WATSUSIO/INC
          INC       BOKRC1IO/INC
          INC       PATDO1IO/INC
          INC       BOKRX1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSHCPIO/INC
          INC       PATWR1IO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PMSHCGIO/INC
          INC       PMSIHIIO/INC
          INC       PATMI1IO/INC
          INC       WATPROIO/INC
          INC       BOKDIAIO/INC
          INC       WATTX1IO/INC
          INC       OPRDEAIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       WATESNIO/INC
          INC       WATCHAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTCLIIO/INC
          INC       OUTHEDIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSESIO/INC
          INC       OUTSITIO/INC

.
          INC       SMSPRXML           * Print XML metatags for SMS
