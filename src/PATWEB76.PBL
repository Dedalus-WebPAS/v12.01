. Program      : PATWEB76
.
. Function     : Re-Print Invoice Server
.
. Modifications  :
.---------------------------------------------------------------------
. V12.00.07 06/10/2025  J.Tan          TSK 0966784
.           Recompiled for PATCATAI - Fixed printing ICD10 on reprint
. V12.00.06 30/09/2025  Thanh T        TSK 0937505
.           Recompiled for PATINVHL changes
. V12.00.05 24/07/2025  J.Tan          TSK 0962500
.           Mod Cash routines to check for U/R number
. V12.00.04 15/07/2025  J.Tan          TSK 0961277
.           Recompiled for PATCATAI - NOT to display item with zero patient amt
. V12.00.03 03/06/2025  Ebon Clements   TSK 0955096
.           Set ADMISSNO to ZEROVISN - INVENQ20
. V12.00.02 20/05/2025  Ebon Clements   TSK 0955096
.           Alphanueric visit number changes
. V12.00.01 12/05/2025 J.Tan           TSK 0960349
.           Recompiled for PMSFESTM - Fixed GST amount for HEA Fees Estimate
. V11.05.18 07/05/2025  Nikitha B      TSK 0959601
.           Recomplied for PATMISTM.
. V11.05.17 28/04/2025  J.Tan         TSK 0958153
.           Mod PRPAT000 to check outstanding invoice prior read patient details
. V11.05.16 10/04/2025  J.Tan         TSK 0953687
.           Recompiled for PMSFESTM - SJOG IFC GST for Uninsured
. V11.05.15 03/04/2025  J.Tan          TSK 0958935
.           Fixed Hold invoice from HL7RECVR
. V11.05.14 13/03/2025 Alina Bhari     TSK 0945900
.           Display all Journal Type when cat CL ind 5 =blank except those     
.           where Cat J Ind 7 isnot blank - SJRN6000                           
. V11.05.13 06/03/2025 Alina Bhari     TSK 0945900
.           Validate the Cat CC Ind 15, CAT J Ind 7 to (a-z,A-Z,0-9)           
.           - VALINTXT,SJRN0000,SJRN6000                                       
. V11.05.12 05/03/2025 Alina Bhari     TSK 0945900
.           Displayed valid journal when CatCL Ind 15 is empty - SJRN6000      
. V11.05.11 03/03/2025  J.Tan         TSK 0954618
.           Mod check for blank TADMTYP for FINCODE
. V11.05.10 21/02/2025  J.Tan   TSK 0955356
.           Added FININVN,FINADMN,FINURNO - Financial details
. V11.05.09 19/02/2025 Alina Bhari     TSK 0945900
.           Excluded the Journal Types from the drop down (Cat J, Ind 7) if the
.           claim type of the invoice selected does not match Cat CL, Ind 15
.           when Enable Restricted Journals on Invoice Functionality is turned
.           on - SJRN6000
. V11.05.08 12/02/2025 Peter Vela      TSK 0939466
.           Added Eclipse WebServvices DVAW indicator tag WDVA0000
. V11.05.07 19/12/2024 J.Tan           TSK 0955163
.           Recompiled for FEESESTM - DVA concession card (dvacolor)
. V11.05.06 17/12/2024  J.Tan         TSK 0925576
.           Removed Future action from Payment plan for fully paid invoice
. V11.05.05 03/12/2024  J.Tan         TSK 0953918
.           Recompiled for PMSFESTM - fixed HEA Total Exp.LOS
. V11.05.04 29/11/2024  Thanh T        TSK 0939466
.           Added Distance in kms field
. V11.05.03 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.02 25/11/2024  J.Tan          TSK 0953687
.           Recompiled for PMSFESTM - HEA IFC GST total for Patient/Fund Rebate
. V11.05.01 25/11/2024 Thanh T         TSK 0946085
.           Recompiled for NZPCATAI changes
. V11.04.23 29/10/2024 Thanh T         TSK 0946085
.           Added code to read Display Statement Reference (nzprivate)
.           parameter (RCCNSTRF)
. V11.04.22 28/10/2024 Alina Bhari     TSK 0948172
.           Recompiled for FEESESTM 
. V11.04.21 23/10/2024  J.Tan          TSK 0942917
.           Recompiled for FEESESTM - SJOG IFC Adm.type for Using Basic cover
. V11.04.20 20/09/2024 J.Tan           TSK 0950577
.           Fixed Hold invoice audit list
.           25/09/2024  J.Tan          TSK 0942917
.           Recompiled for FEESEST - Fixed SJOG IFC keyin amount Misc.item
. V11.04.19 20/09/2024 J.Tan           TSK 0942917
.           Recompiled for FEESESTM - Fixed SJOG Accommodation Fees Estimate
. V11.04.18 23/08/2024 J.Tan           TSK 0939432
.           Mod printing item with zero quantity for Ind.billing
. V11.04.17 21/08/2024  J.Tan          TSK 0942917
.           Recompiled for PMSFESTM - fixed SJOG IFC
. V11.04.16 30/07/2024  J.Tan          TSK 0942917
.           Recompiled for PMSFESTM - changes for SJOG Fees Estimate(PrivateBed)
. V11.04.15 28/06/2024  J.Tan          TSK 0942917
.           Recompiled for FEESESTM - changes for SJOG IFC Eligibility check
. V11.04.14 11/06/2024  J.Tan          TSK 0946701
.           Recompiled for PATCATAI - calculating items(amt x quantity)>FORM6P2
. V11.04.13 05/05/2024  J.Tan          TSK 0927259
.           Recompiled for PATCATAI - Printing Claim details and ICD Diag/Proc
. V11.04.12 28/03/2024  PJ Le Febour   TSK 0929044f
.           restore update WBICUUID WBICUDAT WBICUTIM before call UPWBIHC2
. V11.04.11 26/03/2024  J.Tan          TSK 0943340
.           Recompiled for PRTINVBD - print MV date for Pendelbury invoice
. V11.04.10 20/03/2024  PJ Le Febour   TSK 0929044e 
.           update WBICUUID WBICUDAT WBICUTIM before call UPWBIHC2
. V11.04.09 14/03/2024 J.Tan           TSK 0910994
.           Recompiled for CMXMATRX-Added Att.Doctor,Concession card & Disc.UDF
.           13/03/2024  J.Tan          TSK 0919335
.           Mod checking for HF history
. V11.04.08 04/03/2024  PJ Le Febour   TSK 0929044dc
.           update WBICUUID WBICUDAT WBICUTIM before call UPWBIHC2
. V11.04.07 21/02/2024  J.Tan          TSK 0942976
.           Recompiled for NZPCATAI - Fixed Win/Loss for Multi contract proc.
. V11.04.06 20/02/2024  J.Tan          TSK 0942477
.           Recompiled for PRTINVBD -  Cabrini Accom. print additional desc.
. V11.04.05 29/01/2024  Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
. V11.04.04 18/01/2024  J.Tan          TSK 0941108
.           Recompiled for NZPCATAI - fixed displaying W/L amount
. V11.04.03 20/12/2023  J.Tan          TSK 0936664
.           Recompiled for PATCATAI - fixed printing GST journals for Disc.Bill.
. V11.04.02 22/11/2023 J.Tan    TSK 0939335
.           Recompiled for FEESESTM - mod validating misc.item to check for date
. V11.04.01 21/11/2023 J.Tan    TSK 0940129
.           Recompiled for FEESESTM - SJOG suggested class. from hightest mbs
. V11.03.23 08/11/2023  Nikitha B      TSK 0927699c
.           Read PTCNHABN for Hospital ABN number.
. V11.03.22 04/10/2023  Nikitha B      TSK 0927699
.           Recompiled for PATINVHL, PATINVTL 
. V11.03.21 09/08/2023  J.Tan          TSK 0935667
.           Recompiled for FEESESTM - added trap prior write to pmsfesaf
. V11.03.20 04/07/2023  J.Tan          TSK 0934653
.           Recompiled for PMSFESTM - Usebasic flag for SJOG IFC
. V11.03.19 26/06/2023  J.Tan          TSK 0934216
.           Recompiled for PMSFESTM - Health fund table issue
. V11.03.18 21/06/2023  J.Tan          TSK 0934004
.           Recompiled for PATIPERH - checking Patient Hold invoice
. V11.03.17 15/06/2023  Bella Turco    TSK 0931756
.           Recompiled for PRTINVBD             
. V11.03.16 25/05/2023  J.Tan          TSK 0923703
.           Mod for ABF Mental health event
. V11.03.15 19/05/2023 Ebon Clements  TSK 0932677
.           Read visit extension to get hosital id for DRG selection - DRGV0000
. V11.03.14 15/05/2023 J.Tan    TSK 0926482
.           Recompiled for FEESESTM - HEA Use basic cover
. V11.03.13 09/05/2023 J.Tan           TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.12 05.05.2023  DA Sarkies     TSK 0930775
.           Fixed the table sort for the invoice table to it sorts correctly
.           where there are cells with tags
. V11.03.11 21/04/2023  J.Tan          TSK 0900145
.           Mod Credit all to set Contract Procedure code
. V11.03.10 05/04/2023 J.Tan          TSK 0847250
.           Mod for PP reassign debt
.           05/04/2023  Bella Turco   TSK 0911166
.           Mod for Hold Invoice Audit
. V11.03.09 14/04/2023  J.Tan          TSK 0900145
.           Mod Win/Loss for each procedure code
. V11.03.08 12/01/2023  J.Tan          TSK 0900145
.           Mod Win/Loss for each procedure code
.           09/03/2023  J.Tan          TSK 0924587
.           Fixed credit all for Keyin amount items
.           08/03/2023 J.Tan    TSK 0926482
.           Recompiled for FEESESTM - HEA Use basic cover
. V11.03.07 28/02/2023  Bella Turco    TSK 0928897
.           Fixed date/time formatting for field 9 in Invoice List tablesort
.           when PTCNIRAI = 0 or 1 (PRPRI301)
. V11.03.06 03/02/2023 J.Tan    TSK 0926482
.           Mod CTXT0000 checking indic.for Insurance/Comment box(Fees Estimate)
.           Recompiled for PMSFESTM - Use basic for HEA Fees Estimate
. V11.03.05 31/01/2023 Peter Vela   0928897
.           Fixed goto in INTS0000
.           Commented out tablesort validation in PRPAT000 PRPRI000 PRDBT000
.           for SHOWFLAG 
. V11.03.04 23/12/2022 J.Tan    TSK 0920195
.           Recompiled for NZPCATAI - display payment type for NZ Private
. V11.03.03 12/12/2022 J.Tan    TSK 0926482
.           Recompiled PMSFESTM - Fixed HEA Fees Estimate (Default Cover rate)
. V11.03.02 06/12/2022 J.Tan    TSK 0926482
.           Recompiled PMSFESTM - Fixed HEA Fees Estimate (Default Cover rate)
. V11.03.01 21/11/2022 J.Tan    TSK 0900069
.           Recompiled PMSFESTM for HEA Fees Estimate
. V11.02.18 05.05.2023  DA Sarkies     TSK 0930775
.           Fixed the table sort for the invoice table to it sorts correctly
.           where there are cells with tags
. V11.02.17 07/11/2022 J.Tan    TSK 0925716
.           Mod INVENQ10 to set Claim/HF from Fees Estimate details(pmsfedaf)
. V11.02.16 04/10/2022 J.Tan    TSK 0900069
.           Recompiled for PMSFEDTM and Mod EBTY0000 to include TCFORM6=2
. V11.02.15 26/09/2022 J.Tan    TSK 0900069
.           Mod to initialise REASADMN
. V11.02.14 07/09/2022 J.Tan    TSK 0924383
.           Recompiled for FEESESTM - mod to read Admission file
. V11.02.13 05/09/2022 J.Tan    TSK 0924085
.           Recompiled for FEESESTM - SJOG GST Fees Estimate
. V11.02.12 13/07/2022 J.Tan           TSK 0900069
.           Mod HEA Fees Estimate for using Default Cover Rate
.           25/08/2022 Bella Turco     TSK 0923624
.           Uppercase SRCHSNAM & SRCHGNAM in FREQSN00 before returning search 
.           results 
. V11.02.11 07/07/2022 J.Tan    TSK 0921542
.           Recompiled for FEESESTM
. V11.02.10 05/07/2022 J.Tan    TSK 0921542 & 0921364
.           Recompiled for FEESESTM Fixed I*D on pmsfesaf and deleting Tempfile
. V11.02.08 22/06/2022  Peter Vela         0920731
.           Added webservices functionality to DECL0000
. V11.02.07 16/06/2022  Alina Bhari    TSK 0816719
.           Corrected the date for private practise Invoice - PRPRI301 
. V11.02.06 31/05/2022  Alina Bhari    TSK 0816719
.           Converted the Patient Invoice List Table (%PATWEB76.01.309)
.           into table sorting.
.           -MISC5000,INTS0000,PINVCI41,PINVCI42,PRPAT401,PRPAT402,PRPAT301   
.           -PRPAT302,PRPAT801,PRPAT802,PRPRI301,PRPRI302,PRDBT501,PRDBT502    
.           -Disabled tablesorting in ENQI0900,ENQI2100,ENQI3200,ENQI5100
. V11.02.05 08/04/2022  Jacob Jackson  TSK 0864505
.           Recompiled for PATINVHL, PATINVTL
.           Add CONTROLF parameters - PTCNPFSN, PTCNPFGN
. V11.02.04 04/04/2022  J.Tan          Task 0910723
.           Recompiled for FEESESTM - fixed Misc.amount (SJOG Eligiblity Check)
. V11.02.03 04/02/2022  J.Tan          Task 0902652
.           Mod for Patient Only invoice for Emergency/Outpatient(PTCNPPIN=1)
. V11.02.02 11/02/2022  J.Tan          Task 0910723
.           Recompiled for PMSFESTM - SJOG IFC
. V11.02.01 01/02/2022  J.Tan          Task 0915997
.           Recompiled for PMSFESTM - HEC standard IFC
. V11.01.27 08/11/2021 J.Tan           TSK 0880410
.           Mod for System Health fund on hold invoice
. V11.01.26 08/11/2021  J.Tan          Task 0913303
.           Mod FREQUT00 to position read on Quote number (IFC)
. V11.01.25 18/10/2021  DA Sarkies     Task 0912469
.           Added check for visit type at MISC2400 and PRPRI300
. V11.01.24 14/10/2021  J.Tan          Task 0910723
.           Recompiled for FEESESTM - SJOG Eligibilty check
. V11.01.23 07/10/2021 J.Tan           TSK 0901515
.           Recompiled for CMXMATRX - Added for Primary ICD Procedures
. V11.01.22 06/10/2021  J.Tan          TSK 0910723
.           Recompiled for FEESESTM - SJOG IFC
. V11.01.21 06/10/2021  J.Tan          TSK 0911440
.           Fixed updating patfigsf for lumpsum GST Credit Note amount
. V11.01.20 04/10/2021  J.Tan          TSK 0911440
.           Fixed FINAMNT for lumpsum GST Credit Note amount
. V11.01.19 14/09/2021  Davin          TSK 0911277
.           Recompiled for PRTINVBD
. V11.01.18 10/09/2021  Davin          TSK 0911277
.           Recompiled for PATINVTL - Changed field 20 length to 12.2
. V11.01.17 07/09/2021  J.Tan          TSK 0910723
.           Recompiled for FEESESTM for SJOG Fees Estimate
. V11.01.16 31/08/2021  J.Tan          TSK 0910799
.           Recompiled for PRTINVBD - printing Referring ADF
. V11.01.15 24/08/2021  J.Tan           TSK 0903454
.           Added Claim code to Lumpsum/Daily charge for CACCFEE=4
.           24/08/2021  Davin           TSK 0897318
.           Recompiled for PATINVTL - added field 57 Adjustment Total
. V11.01.14 19/08/2021  J.Tan           TSK 0910460
.           Recompiled for FEESESTM - Standard fees estimate
. V11.01.13 02/08/2021  Peter Vela      TSK 0909175
.           Added BBSW functionality
. V11.01.12 03/08/2021  J.Tan           TSK 0909724
.           Recompiled for PRTINVBD - SJOG invoice
. V11.01.11 07/07/2021  J.Tan           TSK 0908588
.           Recompiled for CMXMATRX - Exclude Unqualified days for Casepayment
. V11.01.10 25/06/2021  Peter Vela     TSK 0906538
.           Added PCIW functionality
. V11.01.09 01/07/2021  J.Tan          Task 0885959
.           Recompiled for FEESESTM - Fees Estimate Standard format
. V11.01.08 04/06/2021  J.Tan          TSK 0896226
.           Recompiled for PMSFESTM (SJOG IFC/Fees Estimate)
. V11.01.07 19/05/2021  J.Tan          TSK 0903992
.           Mod to initialise PMMIITYP for Credit All (NZ)
. V11.01.06 28/04/2021  Peter Vela     TSK 0902857
.           Added IHCW functionality
. V11.01.05 03/05/2021  J.Tan           TSK 0863287
.           Fixed Discharge Billing Statement for PTCNPPIN=1
.	    30/04/2021	DA Sarkies	TSK 0904655
.	    Removed HMTL code that resulted in gaps in the
.	    margins in the tables in patweb7601004
. V11.01.04 28/04/2021  Thanh T         TSK 0895165     
.           Recompiled for OPRARDFD changes 
.           14/04/2021  J.Tan           TSK 0863287
.           Mod for Patient Invoice new functionality
. V11.01.03 07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.02 11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
. V11.01.01 18/02/2021  J.Tan          TSK 0888639
.           Added PMMITMNO - Theatre Team no
. V11.00.16 25/01/2021  J.Tan          TSK 0901244
.           Added tag IVLH000 - display header for Inv.list with Inv.raised by
. V11.00.15 25/01/2021  Thanh T        TSK 0896396
.           Recompiled for PATINVHL changes
. V11.00.14 18/01/2021  Peter Vela     TSK 0898361
.           Added IMCW Functionality
.           19/01/2021  J.Tan          TSK 0883075
.           Recompiled for PRTINVBD - mod to print ADF address on invoice
. V11.00.13 13/01/2021  Thanh T        TSK 0896396
.           Recompiled for PATINVHL changes
. V11.00.12 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.11 10/11/2020  J.Tan           TSK 0899562
.           Recompiled for CMXMATRX - setup date for reading MBS item
. V11.00.10 22/10/2020  J.Tan         TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.09 14/10/2020  J.Tan          TSK 0894879
.           Recompiled for PRTINVBD - Print 30 item desc.for RCH Invoice
. V11.00.08 07/10/2020  J.Tan          TSK 0868356
.           Added option for DRG Versions
. V11.00.07 29/09/2020  J.Tan          TSK 0896829
.           Recompiled for CMXMATRX - use National(PTPGNDRG)DRG
. V11.00.06 22/09/2020  J.Tan           TSK 0895330
.           Recompiled for CMXMATRX - reposition read of Matrix table
. V11.00.05 27/07/2020  Tracey Nguyen  TSK 0892433
.           Recompiled for PRIHRETM
.           27/07/2020  J.Tan          TSK 0885061
.           Recompiled for PMSFESTM - to display Theatre fee desc.
. V11.00.04 07/07/2020  Tracey Nguyen  TSK 0888423
.           Added new tag MISC4200 - Invoice record time created
.           Added check for PTCNIRAI=2 - Display Invoice Raised by and Time
.           Invoice raised
. V11.00.03 25/05/2020  J.Tan          TSK 0891011
.           Added tags for Eligibility check fields for SJOG Fees Estimate
. V11.00.02 01/04/2020  Jill Parkinson  Task 0292638
.           Added code to store an invoice against a patient as a clinical
.           document
.           10/04/2020  J.Tan             TSK 0868813
.           Mod PRF name to DIM80
.           17/04/2020  Peter Vela     TSK 0874025
.           Recompiled for PRIECTFD
. V11.00.01 10/03/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
. V10.15.07 22/01/2020  J.Tan          TSK 0826834
.           Recompiled for FEESESTM - SJOG Fees Estimate
. V10.15.06 13/01/2020  J.Tan          TSK 0883332
.           Recompiled for PRTINVBD - print multi page of Workers Comp.
. V10.15.05 10/01/2020  J.Tan          TSK 0886294
.           Mod to print blue on invoice amount for Patient Only invoice
. V10.15.04 07/01/2020  J.Tan          TSK 0882754
.           Recompiled for PATCATAI - printing Accommodation
. V10.15.03 31/12/2019  J.Tan          TSK 0886176
.           Added 'ABF details' button - added 'invoicno'
. V10.15.02 02/12/2019  J.Tan          TSK 0826834
.           Mod for SJOG IFC/Fees Estimate
. V10.15.01 15/11/2019  J.Tan          TSK 0826834
.           Mod for SJOG IFC/Fees Estimate
. V10.14.06 20/09/2019  J.Tan           TSK 0857392
.           Mod to set Claim code for Emergency/Outpatient ABF invoice
. V10.14.05 03/09/2019  J.Tan           TSK 0857392
.           Mod for Emergency ABF invoice
. V10.14.04 21/05/2019  J.Tan           TSK 0857392
.           Mod for ABF invoice
.           16/07/2019  J.Tan            TSK 0867131
.           Mod check for PMMIITYP =3 (not to validate Misc.charge)
. V10.14.03 04/06/2019  Thanh T.         TSK 0850685
.           Changed PRPAT000/PATINV00/PMTINV00 to colour the invoice no,
.           invoice total and outstanding amount to be Blue.      
.           Added MISC3500 to return PINVTYP field
. V10.14.02 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.01 18/02/2019  J.Tan          TSK 0870149
.           Fixed move of CURRDATE to PTRAUDAT
. V10.13.12 17/01/2019  J.Tan          TSK 0869117
.           Recompiled for NZPCATAI - displaying Win/Loss amount 
. V10.13.11 15/01/2019  J.Tan          TSK 0868832
.           Fixed IRBY0000 to save current User id
. V10.13.10 11/12/2018  J.Tan          Task 0859743
.           Added printing Bulk Billing DB4 Form
. V10.13.09 21/12/2018  Peter Vela     Task 0859743
.           Recompiled for OUTECTFD
. V10.13.08 27/11/2018  Tracey Nguyen  TSK 0859743
.           Added ECBB0000 for Eclipse Bulk Billing
.           06/12/2013 J.Tan         TSK 0859743
.           Mod OTRECTYP=6 for Theatre item
. V10.13.07 13/11/2018  J.Tan          TSK 0854372
.           Added tag for PMVXUD15
.           09/11/2018  J.Tan            TSK 0859742
.           Mod to print Lodgement of Advice
. V10.13.06 18/10/2018  Don Nguyen     TSK 0838558
.           Moved temp file (FEDCOMAF) creation to GETFED00 rather than at
.           server startup.
.           23/10/2018  Tracey Nguyen  TSK 0859743
.           Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
. V10.13.05 19/09/2018  J.Tan        TSK 0863727
.           Added Restrictive Override code
. V10.13.04 13/09/2018  Peter Vela   TSK 0863035
.           Added read for pmscltaf for emergency invoices
. V10.13.03 22/08/2018  Peter Vela   TSK 0859742
.           Added Eclipse Store and Forward functionality
.           21/08/2017  J.Tan        TSK 0859742
.           Added ECLIPSE new fields from pmsmtiaf
. V10.13.02 17/08/2018  Ebon Clements    TSK 0859742
.           Added Eclipse other claimant functionality
. V10.13.01 26/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
. V10.12.07 10/07/2018  Ebon Clements    TSK 0859180
.           Recompiled for PMSFESTM - Fees estimate consumables 
. V10.12.06 14/06/2018  J.Tan            TSK 0848921
.           Added tag for Invoice claim type for input journal
. V10.12.05 28/05/2018  J.Tan            TSK 0848921
.           Added PTCNRJNL - Enable restricted Jounals on Invoice
. V10.12.04 23/05/2018  Ania P         TSK 0857549
.           Fixed typo
. V10.12.03 09/05/2018  J.Tan          TSK 0856648
.           Added PMI Extension (pmspx2af) on Reprint Invoice
. V10.12.02 28/02/2018  J.Tan          TSK 0852351
.           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)
. V10.12.01 15.01.2018  J.Tan         TSK 0848146
.           Added CACCFEE=5 - Accumulation FI by Claim code
. V10.11.11 04/01/2018  J.Tan         TSK 0844301
.           Added Consumables record to pmsfesaf (Fees Estimate)
. V10.11.10 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.09 22/11/2017  Ania P         TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
. V10.11.08 23/10/2017  Peter Vela     TSK 0846757
.           Validate OVRCD in IPJRNL00
. V10.11.07 12/10/2017  J.Tan          TSK 0839794
.           Mod to display 'Invoice Raised By'
. V10.11.06 29/08/2017  Peter Vela     TSK 0837619
.           Added IMC Details functionality for PRIDTR
.           31/08/2017  J.Tan         TSK 0837479
.           Added PMMICTYP - Consumption Type
. V10.11.05 24/08/2017  Thanh T.       TSK 0821710
.           Removed PATCMNTS 
. V10.11.04 09/08/2017  Peter Vela     TSK 0837619
.           Added IHC Adjustments functionality
. V10.11.03 27/07/2017  Peter Vela     TSK 0837619
.           Added tag for PRHRROVR
.           28/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.---------------------------------------------------------------------
. V10.10.03 25/06/2017  Jill Parkinson TSK 0841000
.           Added read of pmsaelaf to check that eligibility check is linked
.           to quote before using eligibility values 
. V10.10.02 13/06/2017  J.Tan          TSK 0839991
.           Recompiled for PATDBTYP (PATCMSTP)
. V10.10.01 18/05/2017  J.Tan          TSK 0837782
.           Mod FREQUT00 Fees estimate to use second index of pmsfedaf
. V10.09.03 19/01/2017  J.Tan          TSK 0829932
.           Recompiled for PATANVS - PRFA address4 defaulting from Master record
. V10.09.02 13/01/2017  K.Bell         TSK 0831874
.           Add Eclipse Indicator flag to hide/show Anasthetic Button
. V10.09.01 05/01/2017  J.Tan          TSK 0830638
.           Recompiled for FEESESTM - Fees Estimate for Multiple bed types
. V10.08.21 07/11/2016  Ebon Clements TSK 0827937
.           Recompiled for PATINVHL - Hospital approval number
. V10.08.20 28/09/2016  Peter Vela    TSK 0294177
.           Added check for PTCNUIMC in ECLM0000
. V10.08.19 28/09/2016  J.Tan         TSK 0826492
.           Recompiled for PMSFESTM - Fixed Fees estimate Link
. V10.08.18 21/09/2016  J.Tan         TSK 0826370
.           Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3
. V10.08.17 07/09/2016  J.Tan         TSK 0822590
.            Recompiled for PRIVRDEB
. V10.08.16 29/08/2016  J.Tan          TSK 0823330
.           Recompiled for PMSFESTM - Fixed Fees Est.linked with Elig.Check
. V10.08.15 26/08/2016  Don Nguyen     TSK 0312570
.           Recompiled for CMXMATRX - Added check for PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
. V10.08.14 18/08/2016  J.Tan          TSK 0823330
.           Recompiled for PMSFESTM - Fixed Fees Estimate free format name
. V10.08.13 28/07/2016  J.Tan          TSK 0823330
.           Recompiled for FEESESTM - Fixed Fees Estimate for HEA & SJOG IFC
. V10.08.12 08/07/2016  Peter Vela        TSK 0294177
.           Added IMC functionality
. V10.08.11 28/07/2016  J.Tan          TSK 0823330
.           Fixed Fees Estimate for using HEA and SJOG IFC format
. V10.08.10 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.09 03/06/2016  J.Tan         CAR 0820188
.           Mods to Input Journal to be Not available for zero O/S amt of Inv.
. V10.08.08 01/06/2016  J.Tan         CAR 0816648
.           Fixed Claim code for Re-assign debt
. V10.08.07 01/06/2016  J.Tan         CAR 0820069
.           Fixed Input journal availibility option
. V10.08.06 09/05/2016  J.Tan          CAR 0313842
.           Recompiled for FEESESTM - fixed Fees Estimate
. V10.08.05 07/05/2016  J.Tan          CAR 0313842
.           Recompiled for FEESESTM - fixed Fees Estimate
. V10.08.04 03/05/2016  J.Tan          CAR 0313842
.           Recompiled for FEESESTM - fixed Fees Estimate
. V10.08.03 29/04/2016  J.Tan          CAR 0313842
.           Recompiled for FEESESTM - fixed IFC default basic cover rate
. V10.08.02 18/04/2016  Peter Vela    TSK 0294177
.           Changed read to prihdb to KEY27
. V10.08.01 13/04/2016  J.Tan         CAR 0313842
.           Added 'Use Basic Cover' to Eligibility Check screen for SJOG
. V10.07.06 16/02/2016  J.Tan         CAR 0310703
.           Mods Public Hosp to chk for to be inv.amnt before write to patipen
. V10.07.05 23/02/2016  J.Tan          CAR 0814431
.           Recompiled for FEESESTM - HEA IFC Sugg.class for Daycase
. V10.07.04 11/02/2016  J.Tan          CAR 0323465
.           Recompiled for FEESESTM - HEA IFC EPM Based contracts
. V10.07.03 27/01/2016  J.Tan           CAR 0303842
.           Recompiled for FEESESTM - SJGHC IFC
.           Recompiled for PATCATAI - Additional payment type
. V10.07.02 15/01/2016  J.Tan           CAR 0303942
.           Recompiled for PRTINVBD - Mods to payment type
. V10.07.01 12/10/2015  J.Tan           CAR 320522
.           Recompiled for PRBILCMN
. V10.06.14 11/09/2015  J.Tan          CAR 317216
.           Recompiled for PATCATAI - fixed displaying Credit notes list
. V10.06.13 20/08/2015  J.Tan          CAR 316980
.           Recompiled for FEESESTM - HEA IFC daycase Adm.type suggested class.
. V10.06.12 14/08/2015  J.Tan          CAR 320073
.           Recompiled for PATCATAI - reprint invoice for unreleased cash
. V10.06.11 11/08/2015  J.Tan          CAR 316980
.           Recompiled for FEESESTM - HEA IFC Theatre fees
. V10.06.10 07/08/2015  Davin          CAR 317002
.           Recompiled for PRTINVBD - Print pmexname for ADF MO
. V10.06.09 15/07/2015  J.Tan          CAR 319342
.           Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'
. V10.06.08 14/07/2015  Peter Vela     CAR 319413
.           Recompiled for PRBILCMN - Validate for deleted VISMDT
.           record
. V10.06.07 09/07/2015  J.Tan          CAR 316980
.           Recompiled for FEESESTM - Healthscope IFC changes
.           14/07/2015  J.Tan          CAR 308951
.           Mods to Input journal option availibility
. V10.06.06 09/06/2015  J.Tan          CAR 316116
.           Recompiled for PATCATAI - printing receipts details on second page
.           23/06/2015  J.Tan          CAR 318039
.           Recompiled for PRBILCMN - printing billing comments for EMR
. V10.06.05 27/05/2015  J.Tan          CAR 276452
.           Added Reassign debts & Reprint inv.to Receipts Processing template
. V10.06.04 07/05/2015  J.Tan          CAR 314812
.           Fixed FFS (FFSI0000) to set nzspinvd for Uniq ID of Thea.Charge only
.           15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.03 30/04/2015  J.Tan          CAR 314005
.           Recompiled for FEESESTM - Healthscope IFC
. V10.06.02 02/04/2015  Ania P         CAR 313236                     
.           Recompiled for PRTINVBD                                   
. V10.06.01 24/03/2015 J.Tan       CAR 284113
.           Added new PP Invoice Comments
.           24/03/2015 J.Tan          CAR 314662
.           Fixed checking for Deleted Billing Comments
. V10.05.20 26/02/2015 Ebon Clements  CAR 313396
.           Move one to exit aftet WEBERR00 calls in INVENQ00 and INVDEB00
. V10.05.19 13/02/2015 J.Tan      CAR 310816
.           Recompiled for FEESESTM
. V10.05.18 11/02/2015 J.Tan      CAR 310816
.           Recompiled for FEESESTM
. V10.05.17 10/02/2015 J.Tan      CAR 311717
.           Recompiled for PATINVHL
. V10.05.16 12/01/2014  Peter Vela     CAR 310738
.           Recompiled for PRTINVBD
. V10.05.15 29/10/2014 J.Tan     CAR 307784
.           Fixed the availibility of Action plan on Invoice screen (CINV1900)
.           29/10/2014 J.Tan     CAR 307268
.           Recompiled for PATCATAI - display date for Mechanical Ventilation
. V10.05.14 28/10/2014 J.Tan     CAR 305386
.           Mods checking for Hospital ID for Receipt Processing list
. V10.05.13 28/10/2014 J.Tan     CAR 304455
.           Recompiled for PATINVHL - fixed Doctor Name and Provider no
. V10.05.12 27/10/2014 J.Tan     CAR 302440
.           Recompiled PATCATAI - Unreleased Banked receipt
. V10.05.11 24/10/2014 J.Tan     CAR 253233
.           Recompiled PMSFESTM - fixed printing Theatre/Procedure charges
. V10.05.10 14/10/2014  J.Tan          CAR 307154
.           Mods to set nzspinvd to zero for all nzpspraf if no invoice raised
. V10.05.09 02/10/2014  J.Tan          CAR 253233
.           Mods to skip IFC record for Fees Estimate
. V10.05.08 02/10/2014  J.Tan          CAR 305144
.           Fixed NZSPINVD for credit note Patient invoice
. V10.05.07 26/09/2014 J.Tan  CAR 291619
.           Recompiled for PATCATAI/PRTINVBD - MV NOT to print Quantity
. V10.05.06 23/09/2014 J.Tan  CAR 253233
.           Recompiled for FEESESTM - PTCDNHCP=2 for Shared bed type 
. V10.05.05 19/09/2014  J.Tan          CAR 305963
.           Recompiled for NZPCATAI - not to print Inc/Excl for FFS
. V10.05.04 12/09/2014  J.Tan          CAR 253233
.           Recompiled for FEESESTM - Added Healthscope IFC layout
. V10.05.03 03/09/2014  J.Tan             CAR 298984
.           Recompiled for PATDETFD
. V10.05.02 05/08/2014  Peter Vela     CAR 302164
.           Added PMMIRBRS - Rebate Reason CAT Rr
. V10.05.01 21/07/2014  J.Tan          CAR 291099
.           Mods to Billing Comments
. V10.04.26 30/06/2014  J.Tan          CAR 302908
.           Fixed to set up system prior WRPTDET1
. V10.04.25 24/06/2014  J.Tan          CAR 302586
.           Recompiled for PATCATAI - problem printing Cheque drawer
. V10.04.24 23/06/2014  J.Tan          CAR 302610
.           Fixed to set KEY20 prior WRPMAEL1
. V10.04.23 23/06/2014  J.Tan          CAR 302586
.           Recompiled for PATCATAI - problem printing Cheque drawer
. V10.04.22 23/06/2014  J.Tan          CAR 302586
.           Recompiled for PATCATAI - problem printing payer details 
. V10.04.21 19/06/2014 J.Tan           CAR 302452
.           Recompiled for WEBDINVS - Changed MCHGARR/MCHGAMT
. V10.04.20 16/06/2014  Peter Vela     CAR 302147
.           Recompiled for PRIPPINV - Added journal validation to PRCNPJCI
. V10.04.19 10/06/2014  Jill Parkinson CAR 301639
.           Moved call to TFILENAM to INIT0000 for FEDCOMNM
. V10.04.18 27/05/2014  J.Tan          CAR 300784
.           Recompiled for STEPDOWN - force stepdown prior inv.fromdate
.           29/05/2014  J.Tan          CAR 301639
.           Recompiled for FEESESTM - Mods to erase tempfile at end of process
. V10.04.17 13/05/2014 J.Tan  CAR 300955
.           Recompiled for NZPGLEXT - Fixed to extract Adjustment fees
. V10.04.16 17/05/2014 J.Tan  CAR 300260
.           Recompiled for NZPCATAI-Check prev record after Inactive itm
. V10.04.15 16/04/2014  J.Tan            CAR 261630
.           Removed pataui pataub patauc pataum patauf audit files
. V10.04.14 22/04/2014  J.Tan            CAR 300260
.           Recompiled for NZPGLEXT - checking Active/Inactive Misc.items
. V10.04.13 15/04/2014  J.Tan            CAR 261630
.           Removed port number from temp file name
.           15/04/2014  J.Tan            CAR 299278
.           Recompiled for NZPGLEXT - checking Effective date for Pack items
. V10.04.12 07/04/2014 Peter Vela CAR 286158
.           Recompiled for PATMASTM
. V10.04.11 01/03/2014 Peter Vela CAR 285260
.           Recompiled for PRICONFD
. V10.04.10 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.09 31/03/2014  J.Tan           CAR 292653
.           Added tag for Invoice comments
. V10.04.08 05/03/2014  J.Tan           CAR 295681
.           Added SYSTEM to patdetaf file
. V10.04.07 26/02/2014  J.Tan           CAR 275810
.           Recompiled for PATCATAI - to print Defence Force details
. V10.04.06 20/01/2014  J.Tan          CAR 273713
.           Recompiled for PRTINVBD -Print payment types of a receipt on invoice
. V10.04.05 24/01/2014 J.Tan  CAR 296422
.           Mods to set TCLAIM=2 for Misc.Item not incl.in Win/Loss Calc.
. V10.04.04 28/01/2014  Patrick Adair    CAR 265844
.           Added PRA Address line 4 and Mobile Phone
. V10.04.03 17/01/2014  J.Tan        CAR 295008
.           Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.           20/01/2014  J.Tan        CAR 249828
.           Added PMMIPMBS - Patient MBS Team and Counter
. V10.04.02 13/01/2014 J.Tan          CAR 285118
.           Added MISC2700 - Hospital code for FeesEstimate logo
. V10.04.01 16/12/2013 J.Tan          CAR 294414
.           Recompiled for PRIPPINV - checking type of register
.---------------------------------------------------------------------
. V10.03.71 13/12/2013  J.Tan          CAR 294609
.           Recompiled for CMXMATRX - mods for Default Grouper Version
. V10.03.70 11/12/2013 J.Tan          CAR 294414
.           Mods CPND0000 to check register payments
. V10.03.69 09/12/2013  Ania P         CAR 294740
.           Recompiled for PATINVHL
. V10.03.68 02/12/2013 Sandra Barcham CAR 294414
.           Mods TPAY0000 to exclude transactions without a register
. V10.03.67 26/11/2013 J.Tan          CAR 294271
.           Mods TPAY0000 to exclude Private practice payments
. V10.03.66 23/08/2013 J.Tan          CAR 283618
.           Mods for Independence Services Billing
. V10.03.65 07/11/2013 J.Tan  CAR 251004
.           Recompiled for FEESESTM - Adm.type 'Use for Accom.Charge'
. V10.03.64 25/09/2013 J.Tan  CAR 281515
.           Recompiled for DBSCATBI - exclude items for Disc.Billing
. V10.03.63 25/09/2013 J.Tan  CAR 251004
.           Mods for Adm.type Used for Accom.charge on Fees Estimate
. V10.03.62 25/09/2013 Peter Vela CAR 290782
.           Recompiled for PATCATAI - Added new display wweights for ACHA
.           in D8TYP100
. V10.03.61 13/09/2013 J.Tan   CAR 289256
.           Mods to write a journal record for zero amt of Win/Loss (SX)
. V10.03.60 12/09/2013 Peter Vela     CAR 271911
.           Recompiled for PATINVTL
. V10.03.59 16/08/2013 Davin          CAR 289111
.           Recompiled for PMSFEDTM - Changed pmsfd026 to be numeric
. V10.03.58 05/08/2013  J.Tan         CAR 288060
.           Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary MBS
. V10.03.57 25/07/2013  J.Tan        CAR 251004
.           Recompiled for FEESESTM - added ATYPECHR(Adm.type used for Charging)
. V10.03.56 02/07/2013  J.Tan         CAR 287814
.           Fixed SCHPDRNT to DIM6
. V10.03.55 20/06/2013  Davin         CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.54 06/05/2013  J.Tan          CAR 284902
.           Recompiled for STEPDOWN - force stepdown prior Inv.Fromdate
. V10.03.53 17/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATINVHL, PATINVTL
. V10.03.52 12/04/2013  J.Tan          CAR 283721
.           Added tags for Journals screens 
. V10.03.51 26/03/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN
. V10.03.50 18/03/2013  J.Tan          CAR 280802
.           Recompiled for PATINVHL - Outpatient HF membership
. V10.03.49 05/03/2013  Patrick Adair     CAR 281898
.           Recompiled for PRNTICDC
. V10.03.48 25/02/2013 Ania P          CAR 281021
.           Removed unnecessary modification of constants.
. V10.03.47 31/01/2013 J.Tan           CAR 280296
.           Recompiled for NZPCATAI - remove printing LESS Payment on invoice
. V10.03.46 15/11/2012  J.Tan          CAR 262673
.           Recompiled for PATCMSTP - Additional Casepayment Perdiem rate
.           04/12/2012  J.Tan          CAR 271474
.           Recompiled for CMXMATRX - Mods using index 5 of pmscmtaf file
. V10.03.45 23/10/2012 J.Tan   CAR 274919
.           Mods to Invoice and Credit Note flags for SX G/L interface Extract
. V10.03.44 16/10/2012  J.Tan          CAR 274111
.           Recompiled for PRTINVBD - fixed printing West Wimmera layout
. V10.03.43 15/10/2012  J.Tan          CAR 273928
.           Fixed updating date/time when updating patureaf file
. V10.03.42 04/10/2012  J.Tan          CAR 268233
.           Mods to check for Invoice O/S for Reassign Debt option availability
. V10.03.41 25/09/2012  J.Tan          CAR 272436
.           Mods for PP Cash transfer
.           12/10/2012  J.Tan          CAR 274381
.           Recompiled for PRTINVBD - printing accommodation desc.
. V10.03.40 14/09/2012 J.Tan   CAR 273034
.           Fixed Invoice and Credit Note flags for SX G/L interface Extract
. V10.03.39 14/09/2012  Saroeun Soeur    CAR 268841
.           Recompiled for  PATINVHL
. V10.03.38 04/09/2012  J.Tan            CAR 268233
.           Mods for Emergency Reassign Debts
. V10.03.37 09/08/2012  J.Tan          CAR 270942
.           Mods to set EXIT to zero after generating Fees Information
. V10.03.36 31/07/2012  J.Tan          CAR 268318
.           Recompiled for PATCATAI - displaying Emergency Procedure fee info.
. V10.03.35 31/07/2012  J.Tan          CAR 270216
.           Recompiled for PATCATAI - printing Cabrini procedures rates
. V10.03.34 25/07/2012  J.Tan          CAR 266612
.           Recompiled for PRTINVBD - printing Cabrini item rates
. V10.03.33 23/07/2012 J.Tan  CAR 257771
.           Mods to display Time in Recovery on NZprivate Invoice
. V10.03.32 20/07/2012  Don Nguyen     CAR 264561
.           Recompiled for PATGBCRN
. V10.03.31 01/07/2012  Nicole Torrisi CAR 236421
.           Added LOOPCNTR output to prevent timeout
. V10.03.30 21/06/2012  J.Tan          CAR 266656
.           Mods to clear pmsvx1 HF membership for free format Fees Estimate
. V10.03.29 05/06/2012  Jill Parkinson CAR
.           Added read of master and ext. records in LRCP2000
. V10.03.28 18/05/2012  J.Tan        CAR 250988
.           Recompiled for FEESESTM - Fixed calculating Lumpsum GST amount
. V10.03.27 15/05/2012 J.Tan             CAR 255708
.           Mods checking for Hold Invoices From Date
. V10.03.26 04/05/2012  J.Tan          CAR 262427
.           Fixed Resetting assinging debt to call FLAGDEBT
. V10.03.25 02/05/2012  J.Tan          CAR 264231
.           Recompiled for PRTINVBD - fixed printing HEC Event item code
. V10.03.24 01/05/2012  J.Tan          CAR 262427
.           Mods Reassign debt to call FLAGDEBT
. V10.03.23 30/04/2012  J.Tan          CAR 264392
.           Fixed I*C on pmsfetaf file
. V10.03.22 26/04/2012  J.Tan          CAR 264231
.           Recompiled for PRTINVBD - fixed printing HEC Emergency invoice
. V10.03.21 24/04/2012  J.Tan          LanDesk 500543
.           Added Other Fees record type=7 to Fees Estimate
. V10.03.20 28/03/2012  J.Tan          CAR 262761
.           Recompiled for PATCATAI - printing HEA unreleased cash
. V10.03.19 27/03/2012  J.Tan          CAR 262517
.           Recompiled for PRTINVBD - SJOG layout to print item rate
. V10.03.18 07/03/2012  J.Tan          CAR 250477
.           Mods for Pack items
. V10.03.17 08/03/2012  J.Tan          CAR 261468
.           Recompiled for PATCATAI - SX Win/Loss for invoice with Journals/Cash
. V10.03.16 07/03/2012  Saroeun Soeur  CAR 261530
.           RCPL1000 - moved PATFLD00 
. V10.03.15 07/03/2012  J.Tan          CAR 250477
.           Mods for Pack items
. V10.03.14 29/02/2012  J.Tan          CAR 260999
.           Mods Input Journal type Not to include INDIC6=N
. V10.03.13 29/02/2012  Ebon Clements  CAR 233838
.           Changed SELINV00 to not display balanced invoices
. V10.03.12 03/02/2012  J.Tan          CAR 259576
.           Recompiled for PRTINVBD - fixed item date after printing tail
. V10.03.11 03/02/2012  J.Tan          CAR 259556
.           Mods Input Journal type Not to include Journal code for Cash Trans.
. V10.03.10 02/02/2012  J.Tan          CAR 235425
.           Recompiled for NZPCATAI - printing Credit notes
. V10.03.09 18/01/2012  J.Tan          CAR 258698
.           Fixed the Input receipt availibility for Event visit type
. V10.03.08 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.07 12/01/2012  J.Tan          CAR 257752
.           Fixed Credit note for Funded Contract and zero Co-payment invoice
. V10.03.06 11/01/2012 J.Tan           CAR 257142
.           Recompiled for PRTINVBD - Hospital provider number
. V10.03.05 06/01/2012 J.Tan           CAR 257430
.           Recompiled for PATCATAI - fixed printing blank Lumpsum description
. V10.03.04 16/11/2011 J.Tan           CAR 237245
.           Recompiled for PATCATAI - JH inv.printing negative rounding
. V10.03.03 04/11/2011 J.Tan  CAR 235425
.           Mods SX Credit Note enquiry screen to display second field of desc.
. V10.03.02 10/11/2011 J.Tan           CAR 237245
.           Recompiled for PATCATAI - fixed printing JH invoice with journal
. V10.03.01 04/11/2011 J.Tan           CAR 237245
.           Recompiled for PATCATAI - JH inv.to print rounding amount
. V10.02.15 24/10/2011 J.Tan  CAR 253765
.           Recompiled for PATCATAI - printing receipt
. V10.02.14 12/10/2011 J.Tan  CAR 235370 
.           Recompiled for PATINVHL - NHI names for SX
. V10.02.13 12/10/2011 J.Tan  CAR 249242
.           Recompiled for NZPGLEXT - set up credit note status
. V10.02.12 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.11 03/10/2011 J.Tan  CAR 252727
.           Recompiled for PATCATAI - Lumpsum description
. V10.02.10 29/09/2011 J.Tan  CAR 252227
.           Recompiled for PRTINVBD - fixed printing items
.           27/09/2011 J.Tan  CAR 251945
.           Recompiled for PATINVHL - printing Primary doctor
.           03/10/2011 J.Tan  CAR 244790
.           Mods for using a new indicator for self insured journals
. V10.02.09 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.08 07/09/2011 J.Tan          CAR 244790
.           Mods input journals for self insured patients
. V10.02.07 22/08/2011 J.Tan          CAR 235765
.           Recompiled for PATINVHL - free text field for SX Insurer
. V10.02.06 10/08/2011 J.Tan           CAR 244790
.           Mods for Self insured Journals
. V10.02.05 16/06/2011 J.Tan      CAR 237245
.           Recompiled for PRTIPROV - print Insurance prov.for JHS
. V10.02.04 25/05/2011 J.Tan           CAR 239526
.           Recompiled for NZPCATAI - problems with zero amount of inv.breakdown
. V10.02.03 19/04/2011 J.Tan      CAR 237245
.           Recompiled for PATCATAI - Mods for Johns Hopkins invoice
. V10.02.02 20/04/2010  Mike Laming    CAR 233229
.           Added UR Number (PTDEURNO) in PATDETFD (Key 2) - mods to LRCP2500
.           to set Patient Debt Icons correctly
. V10.02.01 04/04/2011 Ebon Clements   CAR 233156
.           Recompiled for PATCATAI - Credit note enquiry
.           04/04/2011 Jill Parkinson  CAR 239574 
.           Removed open of ibaprntf
. V10.01.09 16/03/2011 J.Tan           CAR 233264
.           Fixed updating Unreconciled invoice file to update date/time
. V10.01.08 24/02/2011  Peter Vela        CAR 233034
.           Removed PATBF2FD and PATBF2IO
. V10.01.07 06/12/2010  Ebon Clements     CAR 233927
.           Added reason for hold update to invoice pending
.  ........ 03/12/2010  Mike Laming   CAR 233046
.           Mods to "patmchgf" - use "Table Type" (PTMCHFTT) replacing "H/F 
.           Table" (MHFTAB) - replace code to read/validate Item with PATMCHRD
.           11/01/2011 J.Tan           CAR 230716
.           Fixed setting Claim code for an Event visit
.           Recompiled for PATCATAI - No payday
.  ........ 08/12/2010 J.Tan  CAR 229956
.           Recompiled for NZPCATAI -Fixed printing item group on multiple pages
.  ........ 08/12/2010 J.Tan          CAR 234706
.           Recompiled for PATCATAI - printing SX RECEIPT in capital letters
.  ........ 09/12/2010 J.Tan   CAR 233034
.           Mods bed fees file to use health fund table type
. V10.01.06 23/11/2010 J.Tan          CAR 233079
.           Fixed SX G/L extract for credit notes by item
. V10.01.05 24/11/2010  Mike Laming     CAR 233229
.           Mods to setting PMPXSN14 at LRCP2700
. V10.01.04 24/11/2010  Peter Vela      CAR 233222
.           Added tag for latest record from pmsectaf
.           24/11/2010  Ebon Clements   CAR 233156
.           Added journal enquiry
. V10.01.03 22/11/2010  J.Tan           CAR 230716
.           Recompiled for PATCATAI - fixed No payday
. V10.01.02 16/11/2010  Mike Laming     CAR 233229
.           Added PATDETaf for 3 Debt types - Pat.Only, Pat.Plan & Debt Collectr
. V10.01.01 12/11/2010  Mike Laming     CAR 233264
.           Added PTRADBAG to RCPP0000, added DEBTAGNT into PTRADBAG, set Debt
.           Collection flag (PMPXSN14), and call FLAGDEBT at LRCP2700
. V10.00.44 26/10/2010  Davin           CAR 231481
.           Recompiled for PATCATAI - added ward provider number for hea
. V10.00.43 22/10/2010  J.Tan           CAR 231497
.           Recompiled for PATCATAI - HEC Event invoice
. V10.00.42 15/10/2010  Davin           CAR 225374
.           Added tag for fees estimate text (misc2600) and new table (pmsfetaf)
. V10.00.41 12/10/2010 J.Tan          CAR 231326
.           Fixed number of invoice printed for NZ private credit note
. V10.00.40 14/10/2010 J.Tan          CAR 218153
.           Fixed checking Credit notes availibility for Outstanding debts
. V10.00.39 11/10/2010 J.Tan          CAR 229937
.           Recompiled for PATCATAI - Cabrini invoice layout
. V10.00.38 08/10/2010 J.Tan          CAR 231497
.           Recompiled for PATCATAI - print doctor on HEC Emergency invoice 
. V10.00.37 07/10/2010 J.Tan          CAR 231497
.           Recompiled for PATCATAI - print doctor on HEC Emergency invoice 
. V10.00.36 06/10/2010 J.Tan          CAR 227936
.           Mods to reprint unbalanced invoiced from Receipts processing page
. V10.00.35 30/09/2010 J.Tan          CAR 230735
.           Recompiled for NZPGLEXT
. V10.00.34 27/09/2010 J.Tan            CAR 230664
.           Mods for HEC invoice layout 
. V10.00.33 22/09/2010 J.Tan            CAR 218066
.           Added Query selection to Eligibility Pre-existing ailment
. V10.00.32 22/09/2010 J.Tan            CAR 230162
.           Recompiled for PRIPPINV- display insurance code for payment
. V10.00.31 16/09/2010 J.Tan            CAR 229937
.           Recompiled for PATANVS - multiple pages for Cabrini reprint invoice
. V10.00.30 07/09/2010 J.Tan            CAR 228976
.           Mods checking for Private practice comments
. V10.00.29 26/08/2010 J.Tan            CAR 228845
.           Recompiled for PATCATAI -Lumpsum description for expired Contract ID
. V10.00.28 23/08/2010 J.Tan            CAR 228192
.           Mods to set Booking uniq id for Credit All items
. V10.00.27 18/08/2010 J.Tan            CAR 222031
.           Mods to set PMMIDUPD and PMMITUPD
.           19/08/2010  Davin        CAR 228437
.           Recompiled for FEESESTM
. V10.00.26 18/08/2010 J.Tan         CAR 228157 
.           Mods Reciept processing to display deleted status
. V10.00.25 17/08/2010 J.Tan         CAR 227873 
.           Recompiled for CMXMATRX- getting the grouper version
. V10.00.24 11/08/2010 J.Tan         CAR 227873 
.           Recompiled for CMXMATRX-searching for next matrix rules
. V10.00.23 10/08/2010 Peter Vela       CAR 228065
.           Added read to PMI @ LRCP0000
.           09/08/2010 J.Tan            CAR 226947
.           Fixed displaying credit notes
.           08/08/2010 Davin            CAR 221046
.           Added set parameters (smamt000) for misc charge amounts (feesestm)
. V10.00.22 03/08/2010 J.Tan            CAR 191023
.           Mods to write un-balanced invoice to un-reconciled invoice file
. V10.00.21 30/07/2010  J.Tan         CAR 227425
.           Fixed checking availibility of credit all (to use register code)
. V10.00.20 30/07/2010  J.Tan         CAR 227425
.           Fixed checking availibility of credit all (to use register code)
. V10.00.19 22/07/2010  J.Tan         CAR 226975
.           Recompiled for PATCATAI - I*C on htmlfile for printing credit note
.           with bpay on inv.tail
. V10.00.18 14/07/2010  J.Tan         CAR 226158
.           Recompiled for STEPDOWN - bed fees update
. V10.00.17 16/07/2010 J.Tan          CAR 226322
.           Recompiled for CMXMATRX - search for next rule if Contract not valid
. V10.00.16 13/07/2010 J.Tan          CAR 225571
.           Fixed routine for checking casemix patient
. V10.00.15 21/06/2010 J.Tan          CAR 218905
.           Recompiled for PATCATAI - printing No of Accom.days for SJOG
. V10.00.14 16/06/2010 J.Tan          CAR 223982
.           Recompiled for PATCATAI - to disp.balance payable after Credit Note
. V10.00.13 10/06/2010 J.Tan          CAR 223078
.           Fixed checking Credit All availibility
.           10/06/2010 J.Tan          CAR 220390
.           Mods O/S Inv.list of Fund Group to display in ascending inv.order
.           (the oldest invoice first)
. V10.00.12 02/06/2010 J.Tan          CAR 223078
.           Mods to display O/S Debts on invoice list
. V10.00.11 31/05/2010 J.Tan          CAR 216085
.           Checking cash for credit note for same Inp & Pri.Prac Invoice number
. V10.00.10 27/05/2010 J.Tan          CAR 219471
.           Fixed keep misc.after credit all to skip Mechanical Vent.record
. V10.00.09 24/05/2010 J.Tan          CAR 222497
.           Fixed Credit note split invoice for SX
. V10.00.08 12/05/2010 J.Tan          CAR 221434
.           Recompiled for NZPGLEXT - checking zero amt for Accomm. or Thea.only
. V10.00.07 30/04/2010  J.Tan     CAR 220887
.           Mods checking for Active/Inactive of Misc.charge
. V10.00.06 29/04/2010 Peter Vela     CAR 216164
.           Fixed Tablesort Name column in RCPL0000
.           Fixed Patient Folder colours in RCPL0000
. V10.00.05 29/04/2010 J.Tan          CAR 122214
.           Mods for Credit note split invoices
.           28/04/2010 J.Tan          CAR 218153
.           Disabled Credit All & Credit by item for Outstanding Debt patient
. V10.00.04 27/04/2010 J.Tan  CAR 218779
.           Recompiled for NZPCATAI - Fixed printing date of misc.items
. V10.00.03 16/04/2010  J.Tan         CAR 188189
.           Added HCP Doctor to Fees Estimate 
. V10.00.02 09/04/2010  Davin         CAR 219667
.           Added date/time/user created for write to pmscnoaf
. V10.00.01 30/03/2010  J.Tan         CAR 174079
.           Added a new field to patfactaf for Act.Plan Inv.number
. V9.12.48  11/03/2010  J.Tan         CAR 216044
.           Mods to include Leave days in stepdown count for TAC
. V9.12.47  05/03/2010  J.Tan           CAR 174079
.           Mods to remove future actions from Action plan for balanced invoice
. V9.12.46  01/03/2009  J.Tan             CAR 217108
.           Recompiled for PATCATAI -  to display SX win/loss for inv.with jrnls
. V9.12.45  22/02/2010  J.Tan          CAR 216114
.           Fixed Patient invoice list to show inv for cancelled admissions
. V9.12.44  19/02/2010  J.Tan          CAR 216119
.           Fixed printing GST amount of Credit Notes (with Credit by items)
. V9.12.43  18/02/2010  J.Tan          CAR 215866
.           Mods SX Hospital selection (HSEL0000) for the login hospital only
. V9.12.42  25/01/2010  J.Tan          CAR 213106
.           Fixed displaying Outstanding invoice list for Contract
. V9.12.41  19/01/2010  J.Tan          CAR 214156
.           Disabled input journal for fully credit notes invoice
. V9.12.40  19/01/2010  J.Tan          CAR 166439
.           Recompiled for PATCMSTP - fixed C/P additional charge stepdown
. V9.12.39  13/01/2010  J.Tan         CAR 214028
.           Recompiled for PATCATAI - fixed print/display lumpsum for daycase
. V9.12.38  08/01/2010  J.Tan         CAR 202277
.           Recompiled for PATANVS - Tail of SJOG invoice
. V9.12.37  06/01/2010  J.Tan         CAR 212759
.           Fixed SDOC0000 - routine to get service doctor for Emergency invoice
. V9.12.36  23/12/2009  J.Tan         CAR 174079
.           Mods for Action Plan
. V9.12.35  23/12/2009  J.Tan         CAR 212746
.           Mods 'Inv.Transfer To' Selection of Cash.trans.to check full Credit
. V9.12.34  08/12/2009  J.Tan         CAR 205378
.           Recompiled for PATCATAI - Fixed display/print No Pay Day
. V9.12.33  04/12/2009  Peter Vela    CAR 202333
.           Recompiled for PATINVHL - Changed variable 88 to surname only 
. V9.12.32  24/10/2009  J.Tan         CAR 210064
.           Recompiled for PATCATAI - printing SJOG unit price of Misc.item
. V9.12.31  23/10/2009  J.Tan         CAR 209647
.           Mods to Cash Transfer
. V9.12.30  04/11/2009  J.Tan         CAR 174079
.           Added Action Plan
.           11/11/2009  J.Tan         CAR 210012
.           Fixed Credit Note to check if fully credited already
. V9.12.29  27/10/2009  J.Tan         CAR 208761
.           Recompiled for PATCATAI - Checking adm.no for Non-banked payment
. V9.12.28  15/10/2009  J.Tan         CAR 191023
.           Added Reassign Debt option from invoice screen
. V9.12.27  12/10/2009  J.Tan         CAR 188108
.           Recompiled for CHKCMXPT - I*C on patcmxaf file
.           Recompiled for PATCATAI - display/print zero lumpsum amount
. V9.12.26  01/10/2009 J.Tan         CAR  204960
.           Recompiled for NZPCATAI - Fixed displaying Win/Loss for Contract Adm
.           Fixed Win/Loss for Contract admission bill to Patient invoice
.           09/10/2009  Davin         CAR 206538
.           Recompiled for changes to fees information (FEESESTM)
. V9.12.25  01/10/2009  Peter Vela    CAR 205008
.           Recompiled for PRIPPINV
. V9.12.24  29/09/2009  J.Tan         CAR 202803
.           Fixed Credit note for Co-payments
. V9.12.23  28/09/2009  Saroeun Soeur CAR 187490
.           Recompiled for PATCATAI
. V9.12.22  03/09/2009  J.Tan         CAR 202803
.           Fixed fincode credit note for Co-payment (UPFIN770)
. V9.12.21  27/08/2009  J.Tan         CAR 204390
.           Added old file FD for bed fees
. V9.12.20  27/08/2009  J.Tan         CAR 170784
.           Added tag for Invoice balance
. V9.12.19  26/08/2009  J.Tan         CAR 202255
.           Recompiled for PATCATAI - Mods to SJOG/Cabrini to display Payee
.           details for receipts (to be same as print)
. V9.12.18  24/08/2009  J.Tan  CAR 186102
.           Recompiled for NZPCATAI - Mods to display Win/Loss after invoiced
. V9.12.17  19/08/2009  J.Tan         CAR 187486
.           Recompiled for PATCATAI - printing Payer for SX invoice
. V9.12.16  04/08/2009  J.Tan         CAR 200712
.           Recompiled for PATCATAI - Cabrini Discharge Billing Statement
. V9.12.15  24/07/2009  J.Tan         CAR 201132 & 202168
.           Recompiled for CMXMATRX - checking for zero MBS amount
. V9.12.14  21/07/2009  J.Tan         CAR 199603
.           Recompiled for PATCATAI - printing theatre banding and ICD codes
. V9.12.13  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.12  20/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.11  15/07/2009  Saroeun Soeur CAR 187490
.           Recompiled for PATCATAI - Display Payer name on invoice
. V9.12.10  13/07/2009  J.Tan         CAR 199759
.           Recompiled for PATCATAI - Fixed printing Pendlebury ED invoice
.           Recompiled for PATCATAI - Fixed I*C on patin1af  CAR 200841
. V9.12.09  26/06/2009  J.Tan   CAR 199464
.           Fixed GST credit note
. V9.12.08  23/06/2009  J.Tan   CAR 199114
.           Recompiled for PATCATAI - name of health fund/insurance cash payment
. V9.12.07  19/06/2009  J.Tan   CAR 198713
.           Recompiled for NZPCATAI - receipt amount,invoice total for inv.tail
. V9.12.06  18/06/2009  J.Tan         CAR 198435
.           Recompiled for PRIPPINV - to display full description of item
. V9.12.05  12/06/2009  J.Tan         CAR 194815
.           Recompiled for PATINVHL - JH Billing Date
. V9.12.04  04/06/2009  J.Tan         CAR 197218
.           Mods for Pendlebury/healthscope to print invoice without amount
. V9.12.03  26/05/2009  J.Tan         CAR 188108
.           Mods for Invoice comments
. V9.12.02  12/05/2009  J.Tan         CAR 191023
.           Mods for Change Owner of Debt
.           15/05/2009  J.Tan         CAR 196685
.           Added hospital name for Fees Estimate
. V9.12.01  12/05/2009  J.Tan         CAR 194815
.           Recompiled for PATINVHL - JH Billing Date
. V9.11.25  28/04/2009  J.Tan         CAR 195525
.           Mods to PRFA name
. V9.11.24  28/04/2009  Mike Laming   CAR 195368
.           Add code to set ACLAIM for Emergency Visit Claim Type at REPINV04
. V9.11.23  16/04/2009  Davin         CAR 182901
.           Recompiled for PATSHT6 & FEESESTM - fees information mods
. V9.11.22  01/04/2009  J.Tan         CAR 192772
.           Recompiled for PATCATAI - Mods to Johns Hopkins invoice
. V9.11.21  23/03/2009  Davin         CAR 178015
.           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number
. V9.11.20  17/03/2009 J.Tan      CAR 192339
.           Recompiled PATCATAI - Fixed Printing SJOG/Cab Adjustment total
. V9.11.19  04/03/2009  J.Tan   CAR 172912
.           Recompiled for PATCATAI - SJOG to print Credit notes details 
. V9.11.18  25/02/2009  J.Tan   CAR 186125
.           Mods to disable Credit All opt.for PP inv.with Non-Banked payment
. V9.11.17  24/02/2009  J.Tan   CAR 190567
.           Mods for Cabrini Discharge Billing Statement
.           25/02/2009  J.Tan   CAR 188205
.           Mods printing Non-banked
.           25/02/2009  J.Tan   CAR 181844 and 188731
.           Fixed printing Cabrini invoices
. V9.11.16  20/02/2009  J.Tan   CAR 190439
.           Mods Credit Note to increase the array of items to 999
. V9.11.15  12/02/2009  J.Tan   CAR 185620
.           Fixed Exppayer for printing credit notes
. V9.11.14  05/02/2009  J.Tan   CAR 172740
.           Mods Health fund invoice list to use invoice index7
. V9.11.13  05/02/2009  J.Tan   CAR 183976
.           Mods for Eclipse
. V9.11.12  29/01/2009  J.Tan   CAR 188549
.           Recompiled for NZPCATAI - display/print rounding amount on invoice
. V9.11.11  20/01/2009  J.Tan   CAR 187842
.           Recompiled for printing NZ Private invoice
.           20/01/2009  J.Tan   CAR 187856
.           Mods to initialise co-payment fields for fees estimates
. V9.11.10  15/01/2009  Ebon Clements  CAR 175204
.           Added clear of IBPDNUM to saving default printer - UPDEFP0
. V9.11.09  14/01/2009  J.Tan   CAR 187462
.           Recompiled for NZPCATAI - reprint of NZ Summary invoice
.           V9.10.34  14/01/2009  J.Tan   CAR 187463
.           Recompiled for PATINVHL - SX Vendor ID & Ref
. V9.11.08  02/12/2008  J.Tan         CAR 160496
.           Recompiled for PATCATAI - RCH Emergency reprint invoice
. V9.11.07  Recompiled for changes to PMSPTDFD.
.           Added code to handle "credit all" for prosthetic tracking items.
.           19/11/2008  J.Tan         CAR 183363
.           Fixed FFS flag for SX credit all
. V9.11.06  14/11/2008  Steve Armstrong   CAR 181373
.           Added PTRK0000 to handle credit notes for tracking prosthetic
.           items
. V9.11.05  12/11/2008  J.Tan         CAR 183242
.           Fixed SX Win/Loss credit notes
. V9.11.04  03/11/2008  J.Tan         CAR 181263
.           Recompiled for PATCATAI - Discharge billing statement
. V9.11.03  23/10/2008  J.Tan         CAR 178415
.           Mods checking for Medical practice user access file
. V9.11.02  14/10/2008  Peter Vela    CAR 159227
.           Recompiled for PATINVHL - Added Emergency Invoice
.           Arrival Date and Time
. V9.11.01  07/10/2008  J.Tan         CAR 172904
.           Recompiled for PATCATAI - SX Invoice
.---------------------------------------------------------------------
. V9.10.26  02/10/2008  Davin         CAR 179991
.           Recompiled for changes to fees information (FEESESTM)
. V9.10.25  22/09/2008  Davin         CAR 177361
.           Changed eligibility excess tag to not display if zero (misc1100)
.           Recompiled for changes to fees information (FEESESTM)
. V9.10.24  12/09/2008 Sandra Barcham CAR 178533
.           Fixed Transfer Overpayment read journal code from controlf   
. V9.10.23  21/08/2008  J.Tan         CAR 176442
.           Fixed SX G/L credit notes for invoice had not been extracted 
. V9.10.22  22/08/2008  J.Tan         CAR 170219
.           Recompiled for PATCATAI - to print item description for Cabrini inv.
. V9.10.21  18/08/2008  J.Tan         CAR 176322
.           Recompiled for PMSFESTM - Generating bed fees
. V9.10.20  18/08/2008  Ebon Clements CAR 174917
.           Recompiled for PMSFESTM - assistant gap amount 
. V9.10.19  13/08/2008  Davin         CAR 175768
.           Recompiled for PMSFESTM - fixed gst tag
.           13/08/2008  J.Tan
.           Fixed to generate credit note for zero amount of invoice
. V9.10.18  12/08/2008  J.Tan         CAR 175967
.           Recompiled for PATCATAI - Not printing Anaesthetic codes/times for
.           Cabrini invoice
.           12/08/2008  J.Tan         CAR 175967
.           Recompiled for PATANVS - initialised doctor provider number
. V9.10.17  07/08/2008  J.Tan         CAR 174542
.           Fixed SX credit notes (ALACDTE)
.           Recompiled for NZPCATAI - reprinting theatre charges
. V9.10.16  23/07/2008  J.Tan         CAR 172740
.           Mods to use invoice index 1 for Health fund outstanding list
. V9.10.15  23/07/2008  J.Tan         CAR 173734  
.           Recompiled for PATANVS - Doctor on Emergency invoice header
. V9.10.14  22/07/2008  J.Tan         CAR 169840  
.           Recompiled for PATINVHL - field 62 for Credit notes   
. V9.10.13  11/07/2008  J.Tan         CAR 168769
.           Fixed Win/Loss credit notes
. V9.10.12  03/07/2008  Ebon Clements CAR 160213
.           Added update functionality to Cabrini Fees Estimation
. V9.10.11  27/06/2008  Ebon Clements CAR 171757
.           Recompiled for PATMISTM - Admission comments tag
. V9.10.10  19/06/2008  Mike Laming   CAR 151025
.           Added PTREMOBL (PTRA010) Person Responsible for Acct. Mobile
. V9.10.09  11/06/2008  J.Tan         CAR 170222
.           Recompiled for NZPGLEXT - Credit notes no on Extract file
. V9.10.08  21/05/2008  J.Tan         CAR 167702
.           Recompiled for PATCATAI - Cabrini invoice layout
.           23/05/2008 J.Tan          CAR 169149
.           Added Date and Time invoice created/updated
. V9.10.07  16/05/2008  Jill Habasque CAR 161873
.           Recompiled for FEESESTM
.           13/05/2008  Ebon Clements CAR 166566
.           Recompiled for PATINVHL
.           14/05/2008  J.Tan         CAR 167702
.           Recompiled for PATCATBI - SJOG invoice layout
.           14/05/2008  J.Tan         CAR 164036
.           Recompiled for FEESESTM
. V9.10.06  13/05/2008 J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.10.05  07/05/2008  J.Tan         CAR 164036
.           Recompiled for PMSFESTM - Daily charge description for Daycase
. V9.10.04  06/05/2008  J.Tan         CAR 167607
.           Mods Credit All to write to invoice pending only if required
. V9.10.03  01/05/2008  Ebon Clements CAR 161882
.           Added allocate U/R to fee estimation
. V9.10.02  01/05/2008  Ebon Clements CAR 161882
.           Added re print fee information
. V9.10.01  30/04/2008  J.Tan         CAR 167215
.           Mods checking for GST journals for Credit all availibility
.---------------------------------------------------------------------
. V9.09.51  17/04/2008  J.Tan         CAR 165627
.           Fixed Free format Postcode for Fees estimates
. V9.09.50  17/04/2008  J.Tan         CAR 165630
.           Fixed displaying rebate/patient portion for Rebate List
. V9.09.49  15/04/2008  Ebon Clements CAR 165627
.           Added surname search to fee estimate list  - FREQSN00
.           15/04/2008  J.Tan         CAR 157585
.           Recompiled for FEESESTM - zero bed fees for not setup fees
.           15/04/2008 J.Tan          CAR 164036
.           Recompiled for FEESESTM - print other bedtypes with Assc.no=1
. V9.09.48  15/04/2008  J.Tan         CAR 161684
.           Recompiled for PATCATAI - Print procedure Date/Time on Invoice
. V9.09.47  14/04/2008  Ebon Clements CAR 161941
.           Added eligibility and exclusion comments tags
. V9.09.46  07/04/2008  J.Tan         CAR 165709
.           Added tag for PP outstanding amount
. V9.09.45  03/04/2008  J.Tan         CAR 163219
.           Recompiled for PATCATAI - JH Credit notes
. V9.09.44  26/03/2008  J.Tan         CAR 161156
.           Mods to display Service doctor for ED Billing invoice 
. V9.09.43  20/02/2008  Peter Vela    CAR 162070
.           Replaced ~ with & at PDDBT000
. V9.09.42  18/02/2008 J.Tan      CAR 151897
.           Mods for Free format/UR Fees estimates
. V9.09.41  13/02/2008 Peter Vela CAR 155334
.           Removed new pmsmtiaf variable
. V9.09.40  01/02/2008 Peter Vela CAR 155334
.           Initialised new pmsmtiaf variable
.           02/02/2008  Davin         CAR 153384
.           Added call to print fees info (prtfin00) - moved from FEESESTM
.           Added tag to Get Default Stationery Code for fees information
. V9.09.39  30/01/2008 J.Tan  CAR 159905
.           Recompiled for PATCATAI -Fixed Estimate rebate amount
. V9.09.38  25/01/2008  Davin         CAR 153384
.           Added fees information functionality (invenq79)
. V9.09.37  10/01/2008  Mike Laming   CAR 156882
.           Add tag ENQI5200 to use NOCOMPCL for Sth.Cross Invoice list
. V9.09.36  10/01/2008  J.Tan         CAR 153568
.           Mods calc.Credit notes GST for SX IBCNUGST=3 (GST on Inv.Total)
. V9.09.35  09/01/2008  J.Tan         CAR 158959
.           Fixed PP Invoice list to include GST Journals
. V9.09.34  27/12/2007  Peter Vela    CAR 155907
.           Recompiled for PATINVTL
. V9.09.33  11/12/2007  Davin         CAR 151898
.           Added eligibility tags for fees estimate form (misc0000)
. V9.09.32  30/11/2007  Peter Vela    CAR 151987
.           Added Fee Estimation Comments functionality
. V9.09.31  29/11/2007  J.Tan         CAR 155415
.           Fixed setting up pmmisunq for SX credit note (item with contract)
. V9.09.30  27/11/2007  J.Tan         CAR 151897
.           Mods for Fees Estimation Create form (CAB)
. V9.09.29  22/11/2007  J.Tan         CAR 155607
.           Fixed printing SJOG cash to check for cancelled status and
.           amount
. V9.09.28  16/11/2007  Peter Vela    CAR 110766
.           Recompiled for PATINVHL
. V9.09.27  12/11/2007  Jill Habasque CAR 153223
.           Added reads of mltsecaf when checking hospital
. V9.09.26  07/11/2007  J.Tan         CAR 154477
.           Mods JOURTOT to FORM12P2
. V9.09.25  07/11/2007 J.Tan          CAR 154464
.           Fixed I*C on mltcfnaf file
. V9.09.24  31/10/2007 J.Tan          CAR 151803
.           Mods Credit note by items not to display Emergency Facility fees
. V9.09.23  26/10/2007 J.Tan          CAR 153442
.           Mods to set PTMICMXP for SX FFS after Credit all
. V9.09.22  17/10/2007 Jill Habasque  CAR 152082
.           Added output of chckhosp to nextgr00 and prevgr00
. V9.09.21  03/10/2007 J.Tan          CAR 151472
.           Recompiled for NZPCATAI - printing procedure fees with inv.breakdown
. V9.09.20  04/10/2007 Jill Habasque  CAR 150322
.           Added move of 1 to PMMICCON in WRMTI000
. V9.09.19  27/09/2007 J.Tan          CAR 151260
.           Recompiled for PRIPPINV - mods displaying priv.practice payments
.           31/10/2007 J.Tan          CAR 151225
.           Recompiled for NZCATAI - SX reprinting invoice
. V9.09.18  24/09/2007  Ebon Clements CAR 149203
.           Added multi hospital test to admission and U/R invoice lists
. V9.09.17  21/09/2007  J.Tan         CAR 149966
.           Recompiled for NZPCATAI - mods to printing Summary invoice
. V9.09.16  13/09/2007  Jill Habasque    CAR 143626
.           Added NOCOMPCL - Don't display compensable column in invoice list
.           21/09/2007 J.Tan             CAR 140282
.           Fixed number of invoices printed for credit all
. V9.09.15  12/09/2007  Mike Laming      CAR 149764
.           Restrict Invoice List to 200 Invoices for calculating O/Standing
.           Totals at PRPAT200
. V9.09.14  11/09/2007 Jill Habasque  CAR 149117
.           Added chckhosp - check hospital before outputting invoice
. V9.09.13  06/09/2007 J.Tan          CAR 149210
.           Recompiled for PATCATAI - SX Funder invoice
. V9.09.12  10/08/2007 Peter Vela     CAR 146143
.           Recompiled for PATCATAI
. V9.09.11  06/08/2007  J.Tan         CAR 140282
.           Recompiled for changing record length of nzpextaf 
. V9.09.10  27/07/2007  J.Tan         CAR 140282
.           Mods for Credit Note - SX G/L extract
. V9.09.09  25/07/2007 Peter Vela   CAR 144787
.           Recompiled for PATCATAI
. V9.09.08  20/07/2007 Peter Vela   CAR 142913
.           Added missing read to pmspx2af
. V9.09.07  18/07/2007 J.Tan          CAR 140282
.           Recompiled for NZPCATAI - Invoice breakdown
. V9.09.06  05/07/2007 Peter Vela     CAR 144548
.           Recompiled for PATANVS
. V9.09.05  05/07/2007 J.Tan          CAR 140282
.           Recompiled for NZPCATAI - Fixed displaying SX Journals
. V9.09.04  02/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.03  01/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATINVTL
. V9.09.02  01/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.01  29/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
.---------------------------------------------------------------------
. V9.08.44  25/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI  
. V9.08.43  15/06/2007  J.Tan         CAR 142173
.           Mods credit note for EMR Event procedure
. V9.08.42  14/06/2007  Peter Vela    CAR 142173
.           Recompiled for PATCATAI
. V9.08.41  08/06/2007  J.Tan         CAR 141539
.           Fixed populating inclusion type for credit all
. V9.08.40  21/05/2007  J.Tan         CAR 141297
.           Mods for GST Revenue breakdown
. V9.08.39  14/05/2007  Peter Vela    CAR 136586
.           Recompiled for PRIINVPR - Added SJOG Referral Doctor details
. V9.08.38  07/05/2007 Peter Vela CAR SJOG ED Billing
.           Initialised new pmsmtiaf variables
. V9.08.37  01/05/2007  J.Tan            CAR 139655
.           Mods Patient Invoice list for Outstanding debt patients
. V9.08.36  26/04/2007  J.Tan            CAR 130467
.           Mods for Transfer Overpayment
. V9.08.35  24/04/2007  J.Tan            CAR 138026
.           Recompiled for PATCATAI - JH half day charge description
. V9.08.34  23/04/2007  J.Tan            CAR 132272
.           Fixed problem with SX Credit notes
. V9.08.33  17/04/2007  J.Tan            CAR 130467                           
.           Added Credit Transfer for overpayment                             
.           18/04/2007  Mike Laming      CAR 138299
.           Added OPEN for PMSFCIA2
.           17/04/2007  J.Tan            CAR 138571                           
.           Recompiled for PATCATAI - No doc.charge for outpatients   
. V9.08.32  22/03/2007  J.Tan            CAR 130467
.           Added Credit Transfer option for JH
. V9.08.31  14/03/2007  J.Tan            CAR 135853
.           Recompiled for PATANVS for JH patient name on invoice
. V9.08.30  13/03/2007  J.Tan            CAR 120062
.           Recompiled for PATCATAI - SX Rounding
. V9.08.29  08/03/2007  J.Tan            CAR 130462
.           Recompiled for PATCATAI - JH GST
. V9.08.28  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.27  01/03/2007  J.Tan          CAR 120009
.           Recompiled for NZPCATAI - to print procedure date on invoice
. V9.08.26  15/02/2007  Peter Vela       CAR sjog-vic
.           Recompiled for PATCATAI - Added St. John of God layout
. V9.08.25  22/02/2007 Mike Laming   CAR 119436
.           Added PMSOSDTM for Outstanding Debt Alert indicator
. V9.08.24  21/02/2007  J.Tan          CAR 120014
.           Mods for SX credit note
. V9.08.23  08/02/2007  J.Tan          CAR 133130
.           Mods to check for no fee after stepdown in VRATES00
. V9.08.22  07/02/2007  Davin         CAR 126848
.           Added tag to display invoice list for a health fund (ENQI4600)
. V9.08.21  31/01/2007  Ebon Clements CAR 119999 119998
.           Added related provider invoice tag MISC0700
.           Recompiled for PATINVHL
. V9.08.20  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.19  24/01/2007  Mike Laming   CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.18  19/01/2007  J.Tan          CAR 120014
.           Mods for NZ Billing Credit notes
. V9.08.17  16/01/2007  Peter Vela     CAR 128097
.           Added tags and functionality for Linked Fee Estimates
. V9.08.16  11/01/2007  Mike Laming    CAR 130313
.           Added different Name sequence for JH at label GPNAME00
. V9.08.15  15/12/2006 J.Tan
.           Recompiled for PATCATAI - Balance total with credit notes
. V9.08.14  13/12/2006  J.Tan         CAR 127625
.           Mods to JH HRN
. V9.08.13  12/12/2006  J.Tan             CAR 127726
.           Recompiled for PATCATAI - JH GST Discount
. V9.08.12  11/12/2006  J.Tan             CAR 127646
.           Recompiled for modifications to JH invoices
. V9.08.11  05/12/2006  J.Tan             CAR 127092
.           Mods SELF PRFA for JH Invoice
. V9.08.10  04/12/2006  J.Tan         CAR 126763
.           Recompiled for PATCATAI - JH Cash for JH invoices
. V9.08.09  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.08  22/11/2006  Mike Laming   CAR 103368
.           Add routine CCPSCA00 (in PRCA0000) for CCPS "Credit All" Invoice
. V9.08.07  16/11/2006  Steve Armstrong   CAR 124160
.           Recompiled for PATINVHL (Singapore HRN)
.           Recompiled for PATINVTL (Singapore HRN)
. V9.08.06  15/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.05  10/11/2006  J.Tan         CAR 121178
.           Recompiled for PATCATAI - Fixed partial days description
. V9.08.04  26/10/2006  J.Tan         CAR 122541
.           Recompiled for PATCATAI - Alternate Item group for JH invoice
. V9.08.03  11/10/2006  J.Tan         CAR 121178
.           Recompiled for PATCATAI - Acc.desc for halfday charge on Dsc
.           16/10/2006  J.Tan         CAR 121629/121630
.           Fixed Discount from receipts/printing in bold for Items JH
. V9.08.02  11/10/2006  Jill Habasque CAR 121261
.           Recompiled for PATINVHL
. V9.08.01  29/09/2006  Peter Vela    CAR 120319
.           Recompiled for PATINVHL
.---------------------------------------------------------------------
. V9.07.07  25/09/2006  Peter Vela   CAR 118940
.           Recompiled for PATCATBI
. V9.07.06  20/09/2006 J.Tan         CAR 119336
.           Added claim code to Suggested classification file
. V9.07.05  18/08/2006  J.Tan         CAR 115853
.           Recompiled for PATCATAI- Print claim for Pendlebury
. V9.07.04  07/08/2006  J.Tan         CAR 113658
.           Fixed checking for cancel receipt for Credit note option
. V9.07.03  02/08/2006  Peter Vela    CAR 113658
.           Recompiled for PATCATAI - Fixed Date and Cash Payment
.           display
. V9.07.02  31/07/2006 J.Tan      CAR 103365
.           Mods for Johns hopkins invoice
. V9.07.01  25/07/2006  Peter Vela    CAR 113658
.           Recompiled for PATCATAI - Fixed "Journal Total" display
. V9.06.02  16/05/2006  Peter Vela    CAR 104103
.           Recompiled for PATCATBI - PTCNINVL=12
. V9.06.01  24/04/2006  J.Tan         CAR 102287 
.           Recompiled for PATINVHL - Added fields for multi hospital details
. V9.05.03  29/03/2006  Peter Vela    CAR 95780
.           Recompiled for PATINVHL - Added emg mobile contact numbers
. V9.05.02  27/03/2006  Peter Vela    CAR 61299
.           Increased field no size from DIM3 to DIM5   
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B05 02/10/2005  J.Tan         CAR 89413 
.           Recompiled for PATCATAI - Mods printing 2nd line acc.desc.
. V9.05.B04 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B03 20/12/2005  Ebon Clements CAR 76341
.           Key length changes for encounter number
. V9.04.62  12/12/2005  J.Tan         CAR 59381
.           Recompiled for PATCATAI - Split invoice
. V9.04.61  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.60  17/11/2005  Peter Vela    CAR 84547
.           Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1
. V9.04.59  25.10.2005 Sandra Barcham CAR 81362
.           Recompiled for PATINVS - Fixed pack of fincode
. V9.04.58  11/10/2005  J.Tan         CAR 79727
.           Recompiled for PATCATAI - Fixed printing grosstot
. V9.04.57  30/09/2005  J.Tan         CAR 77671
.           Recompiled for PATCATAI - Fixed outpatient dtr
. V9.04.56  29/09/2005  J.Tan         CAR 77671
.           Recompiled for PATCATAI - printing cash amount
. V9.04.55  27/09/2005  Jill Habasque CAR 77671
.           Recompiled for PATCATAI - GROSSTOT overlapping fields
. V9.04.54  06/09/2005  J.Tan         CAR 74862
.           Recompiled for PATCATAI - layout 11 printing payment total
. V9.04.53  11/08/2005  J.Tan        CAR 66543
.           Fixed I*D on pmscnoaf file
. V9.04.52  10/08/2005  J.Tan        CAR 66543
.           Recompiled for PATCATAI - printing RCH invoice tail
. V9.04.51   04/08/2005  J.Tan        CAR 62750
.           Mods not to use the redefined amount variables
. V9.04.50  03/08/2005 Peter Vela CAR 68675
.           Recompiled for PATDSCTM
. V9.04.49  01/08/2005 J.Tan   CAR  69340
.           Recompiled for PATCATAI-Fixed position for printing credit note tot.
. V9.04.48  26/07/2005  J.Tan          CAR 67934
.           Mods credit note to use current date for fees invoice
. V9.04.47  21/07/2005  J.Tan  
.           Fixed patfinsf credit note of casemix lumpsum amount to be positive 
. V9.04.46  14/07/2005  Peter Vela     CAR 62172
.           Recompiled for PATINVTL
. V9.04.45  12/07/2005  J.Tan          CAR 67096
.           Recompiled for PATCATAI - fixed TROFF000
. V9.04.44  28/06/2005  Peter Vela    CAR 65165
.           Recompiled for PATANVS
. V9.04.43  16/06/2005  Mike Laming   CAR 61746 
.           Recompiled for CLPATDTR - add clear PTDTTIME & PTDTCRST 
. V9.04.42  14/06/2005  Jill Habasque  CAR 61761  
.           Recompiled for IBAWEBCD - relationship selection list
. V9.04.41  06/06/2005  J.Tan          CAR 61641  
.           Fixed print Ballarat invoice with claim
. V9.04.40  31/05/2005  J.Tan          CAR 61641
.           Fixed RHS multiple page invoice    
. V9.04.39  27/05/2005  J.Tan          CAR 61641
.           Added page number to invoice tail
. V9.04.38  26/05/2005  J.Tan          CAR 61641
.           Mods for Ballarat invoice
. V9.04.37  26/05/2005  J.Tan          CAR 61641
.           Mods for Ballarat invoice
. V9.04.36  23/05/2005  Jill Habasque CAR 61939 
.           Mods for multi database invoice search
. V9.04.35  10/05/2005  J.Tan          CAR 61488
.           Mods for Ballarat invoice (layout 19)
. V9.04.34  15/03/2005  Jill Habasque CAR 55072
.           Added call to PATNAA00 before packing webtitle
. V9.04.33  07/03/2005  Peter Vela    CAr 57547
.           Recompiled for PATVADFD and PATVADIO
.           04/03/2005  J.Tan         CAR 57321
.           Recompiled for PATCATAI - SVHM Reprint invoice with Adjust.
. V9.04.32  24/02/2005  J.Tan         CAR 58263
.           Recompiled for PATCATAI - printing item description
. V9.04.31  25/01/2005  J.Tan         CAR 56192
.           Recompiled for PATMASTM - Checking O/S debtors with credit notes
. V9.04.30  30/12/2004  J.Tan         CAR 55977
.           Mods to set adate for outpatient invoice heading
. V9.04.29  10/12/2004  J.Tan         CAR 54420
.           Fixed patient invoice list to check for outpatient site
. V9.04.28  09/12/2004  J.Tan         CAR 55635
.           Recompiled for PATINVTL - Receipt amount on invoice tail
. V9.04.27  06/12/2004  J.Tan       CAR 55673
.           Mods to allow credit note all for invoice after cash/jrnl balanced
. V9.04.26  03/12/2004  J.Tan       CAR 55380/ 55599
.           Recompiled for PATCATAI - Calvary ACT invoice layout
. V9.04.25  29/11/2004  Mike Laming   CAR 54534                           
.           Re-comple for PATCMSTP - fix Addit.Charge Description
. V9.04.24  19/11/2004 J.Tan  CAR 52385
.           Mods displaying debtor invoice list
. V9.04.23  16/11/2004  Guomin Fu  CAR 54768
.           Recompiled for PATCATAI - Pendlebury layout(PTCNINVL=16)
. V9.04.22  11/11/2004  J.Tan    CAR 54665
.           Recompiled for PATCATAI - Holy spirit layout
. V9.04.21  03/11/2004  J.Tan    CAR 54324
.           Mods checking for non-banked cash for credit note option
. V9.04.20  28/10/2004  J.Tan    CAR 54392
.           Fixed discharged date on invoice form Event file for non inpat
. V9.04.19  26/10/2004  J.Tan    CAR 54380
.           Recompiled for PATCATAI - fixed unit price amount for OUT/EMG
. V9.04.18  26/10/2004  J.Tan    CAR 54398
.           Fixed printing invoice number for reprint
. V9.04.17  26/10/2004  J.Tan   CAR 54532 
.           Recompiled for PATCATAI - SVHM Emergency invoice
. V9.04.16  25/10/2004  J.Tan   CAR 54527                   
.           Recompiled for PATCATAI - SVHM reprint invoice
. V9.04.15  15/10/2004  J.Tan   CAR 52765  
.           Recompiled for PATCATAI - SVHM outpatient invoice
. V9.04.14  14/10/2004 J.Tan   CAR 54312
.           Recompiled for PATCATAI - SVHM Outpatient reprint invoice
. V9.04.13  14/10/2004 J.Tan   CAR 54230
.           Fixed Private practice invoice list
. V9.04.12  05/10/2004  J.Tan   CAR 53798
.           Mods default charging claim code for multi hospital       
. V9.04.11  04/10/2004 Peter Vela CAR 52906
.           Recompiled for PATCATAI
. V9.04.10  27/09/2004 J.Tan   CAR 53067
.           Removed visit no and visit date from private pratice invoice list
. V9.04.09  27/09/2004 J.Tan   CAR 52877
.           Mods invoice list to check for cancelled invoice
. V9.04.08  16/09/2004  Lina Vo  CAR 53586
.           Fixed Invoice List by UR and Adm to display Health Fund
.           from patma1af when patmi1af is blank.
.           10/09/2004  Lina Vo  CAR 53324          
.           Fixed display of Invoice List for Receipting. It was missing 
.           the initialization of SHOWFLAG.
.           17/09/2004  J.Tan  
.           Mods to use new sundry debtor parameter HSYS6 instead of HSYS4
.           Fixed credit notes for lumpsum amount
.           22/09/2004  Lina Vo  CAR 53660
.           Recompiled for PATCATAI & PATCATBI                           
.           27/09/2004 Jill Habasque CAR 53783
.           Added read of patinvrf if invoicen is available
. V9.04.07  08/09/2004  J.Tan    CAR 53292          
.           Recompiled for STEPDOWN - bed fees not setup 
. V9.04.06  07/09/2004 J.Tan    CAR 53073
.           Mods invoice list to display hospital
.           Checking zeros visit date for takeup outstanding debts patients
. V9.04.05  06/09/2004 Lina Vo  CAR 52998
.           Recompiled for PATANVS, PATINVHL & WEBDINVS.
. V9.04.04  31/08/2004 J.Tan  CAR 50391
.           Fixed fincode for Credit note
. V9.04.03  30/08/2004  J.Tan    CAR 53073
.           Mods to display Hospital ID on invoice heading
. V9.04.02  27/08/2004  J.Tan    CAR 52891
.           Recompiled for PATCATAI - printing journals over payments
. V9.04.01  20/08/2004 J.Tan  CAR 52835
.           Mods to setup hospital ID for patfinsf
. V9.03.53  12/08/2004 J.Tan  CAR 52504   
.           Mods checking the register of payment receipts
. V9.03.52  10/08/2004 Lina Vo   CAR 51011
.           Recompiled for PMSFEDTM.                              
. V9.03.51  02/08/2004 J.Tan CAR 52033
.           Recompiled for PATCATAI - displaying item unit price
. V9.03.50  19/07/2004 J.Tan   CAR 51688
.           Mods to initialise lumpsum amount for credit notes
.           Recompiled for PATINVHL - I*C on patfund 
. V9.03.49  16/07/2004 Jill Habasque CAR 50308
.           Added output of "No Invoice Selected" message
. V9.03.48  13/07/2004 J.Tan CAR 51412
.           Fixed rates listing for C/P
. V9.03.47  06/07/2004 J.Tan CAR 50781
.           Recompiled for PATINVHL - claim code description      
. V9.03.46  30/06/2004 J.Tan   CAR 51112
.           Mods for unrelease non-banked deposit
. V9.03.45  17/06/2004 Peter Vela CAR 49016
.           2004 Stat Changes
.           Recompiled for PMSPX2TM
.           16/06/2004 J.Tan  CAR 49644
.           Fixed displaying discharged record of Rate listing
. V9.03.44  11/06/2004 J.Tan  CAR 50035
.           Mods to set mechanical vent var from pmsmtiaf
. V9.03.43  07/06/2004 J.Tan  CAR 50510
.           Mods checking for new sundry debtor (HSYS4)
. V9.03.42  02/06/2004 J.Tan  CAR 50396
.           Fixed credit note updating patfinsf file
. V9.03.41  01/06/2004 Jill Habasque CAR 50308
.           Added call to clrinv00 if no invoicen in report option 1
. V9.03.40  13/05/2004 Lina Vo    CAR 49748
.           Added extra flag (NZEROFLG) to skip invoices with zero outstanding 
.           balance for display of Invoice List.        
. V9.03.39  31/04/2004 J.Tan  CAR 47748
.           Added total of patient portion to Invoice rebate screen
. V9.03.38  26/04/2004 J.Tan  CAR 47849
.           Mods to remove allowance, fixed I*C on rate viewing
. V9.03.37  21/04/2004 J.Tan 
.           Fixed non-bank amount on the invoice list
. V9.03.36  19/04/2004 Jill Habasque CAR 49078
.           Added read of patma1af in INVENQ20                  
. V9.03.35  06/04/2004 Peter Vela   CAR 48227
.           Added VARGBCRN and PATGBCRN - BPAY Reference Number
. V9.03.34  08/04/2004  J.Tan  CAR 48918    
.           Mods to remove allowance
. V9.03.33  02/04/2004  J.Tan  CAR 48234    
.           Mods to include credit note in Outstanding amount.
. V9.03.32  30/03/2004  Lina Vo CAR 47832   
.           Added MISC0000 for miscellaneous tags.  Added FESTF000.
.           29/03/2004  Lina Vo CAR 44116   
.           Added check for PP Credit Note Transactions tags in CINV0000.
. V9.03.31  26/03/2004 Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.30  23/03/2004  Lina Vo CAR 44116   
.           Added check for PP Credit Note tags in CINV0000.
. V9.03.29  02/03/2004  Lina Vo CAR 47921   
.           Removed use of PRIDBTFD & IO.                  
. V9.03.28  26/02/2004  J.Tan   CAR 44109   
.           Added new tags for private practice variables
. V9.03.27  23/02/2004  Lina Vo    CAR 47662
.           Fixed display of blank Health fund in Quote List Table. 
. V9.03.26  06/02/2004  J.Tan  
.           Recompiled for PATCATAI - fixed displaying item description on WEB
. V9.03.25  03/02/2004  J.Tan  CAR 45047
.           Mods to display Non-banked Cash on the invoice screen
.           Added tag for private practive invoice list 
. V9.03.24  21/01/2004  J.Tan 
.           Mods to check parameter for using debtors    
.           Fixed displaying patient debtor invoice list 
. V9.03.23  10/01/2004 J.Tan
. V9.03.22  10/01/2004 J.Tan
. V9.03.21  10/01/2004 J.Tan   - Sent program to RCH without credit notes
. V9.03.20  13/01/2004  Lina Vo CAR 44073
.           Changed list of Account Receivable debtors invoice.   
. V9.03.19  13/01/2004  J.Tan  
.           Mods to check for debtor flag before read debtor files
. V9.03.18  09/01/2004  J.Tan   CAR 44078
.           Added receipt option
. V9.03.17  19/12/2003  Lina Vo CAR 44073
.           Added Report 3 - Debtors Invoice Search.         
. V9.03.16  19/12/2003  J.Tan  CAR 44093
.           Replaced patcashf with comdepaf file
. V9.03.15  18/12/2003  J.Tan  
.           Fixed posting journals
. V9.03.14  21/11/2003  J.Tan   CAR  44161
.           Recompiled for PATCATAI - print credit note
. V9.03.13  07/11/2003  Peter Vela CAR 44849
.           Recompiled for PATINVTL
.           07/11/2003  J.Tan  CAR 44160
.           Recompiled for PATCALFN  
. V9.03.12  03/11/2003  Peter Vela CAR 44757
.           Recompiled for PATINVTL
. V9.03.11  20/10/2003  J.Tan   CAR 44176
.           Recompiled for OUTDTR, AAEDTR and PATDTR
. V9.03.10  28/10/2003  J.Tan  
.           Recompiled for VISCMTFD.                                    
. V9.03.09  15/09/2003  CAR 40497   Lina Vo      
.           Recompiled for PATMCHFD.                                    
. V9.03.08  04/09/2003  CAR 42713   Mike Laming 
.           Recompiled for PATINVTL (correct GST twice in final Total)
. V9.03.07  22/08/2003 J.Tan  
.           Mods to include GST on the invoice rebate list
. V9.03.06  31/07/2003 J.Tan  CAR 40786
.           Recompiled for CMXMATRX
. V9.03.05  27/06/2003 J.Tan  
.           Mods for WEB Billing printing invoice
. V9.03.04  02/07/2003 Jill Habasque CAR 40660
.           Recompiled for PATDSCTM
. V9.03.03  23/06/2003 J.Tan   SRF 40601 
.           Mods Invoice List to display visit no left justified
.           Fixed reprinting invoice
.           26/06/2003 Dean Cramer   CAR 36506
.           Included server facilities for Fees Quotations
. V9.03.02  05/06/2003 J.Tan 
.           Added HF Table on admission invoice list
.           Added Next and Previous under the Invoice list
. V9.03.01  13/05/2003 J.Tan CAR 36505
.           Added PRFA,View Rebates and Rates
. V9.02.17  30/04/2003 J.Tan
.           Added Patient invoice Listing WEB 
. V9.02.16  25/03/2003 J.Tan
.           Added Patient invoice Listing
. V9.02.15  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
. V9.02.14  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.13  12/11/2002  J.Tan     
.           Recompiled for PATCATAI
. V9.02.12  30/10/2002  J.Tan 
.           Recompiled for PATCMSTP
. V9.02.11  09/10/20021 Peter Vela SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.10  23/07/2002  J.Tan
.           Recompiled for PATMISTM - added patasfaf file
. V9.02.09  21/05/2002  J.Tan
.           Recompiled for PATDSBFE
. V9.02.08  14/05/2002  J.Tan
.           Recompiled for PATMISTM - added casemix code
. V9.02.07  28/03/2002  J.Tan
.           Recompiled for PATCATAI - STV invoice layout
. V9.02.06  07/12/2001  Tonii                                          
.           Recompiled for PATCATAI - Casemix changes                  
. V9.02.05  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.04  29/11/2001  J.Tan 
.           Recompiled for PATCATAI - fixed displaying invoice
. V9.02.03  08.10.2001 J.Tan
.           Recompiled for PATCATAI
. V9.02.02  22.09.2001 Tonii  SRF 13075
.           Recompiled for PATDINVS    
. V9.02.01  22.08.2001 S.Barcham
.           Open patdadaf not patvadaf
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B03 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 26/02/2001  J.Tan        
.           Recompiled for PATWMAFD
.----------------------------------------------------------------------
.         V5.09.02  15/01/2001 Bronko Sosic
.                   Recompiled for PATMASTM
.         V5.08.10  22/11/2000  Greg Horvat
.                   Recompiled for PATCATAI - Commented out any code to do
.                   with Hong Kong or Mt Alvernia
.                V5.08.09  08/11/2000  Ebon Clements
.                          Recompiled for PATINVS
.                V5.08.08  16/10/2000  Steve Downing
.                          Recompiled for PATANVS
.                V5.08.07  28/09/2000 Bronko Sosic
.                          Recompiled for PATMASTM
.                V5.08.06  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                V5.08.05  29/06/2000  Steve Armstrong
.                          Recompiled for PATCATAI
.                V5.08.04  29/06/2000  Steve Armstrong
.                          Recompiled for PATCATAI
.                V5.08.03  07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM          
.                V5.08.02  26/04/2000 Davin
.                          Recompiled for invoice templating
.                V5.08.01 11/04/2000 J.Tan
.                          Mods for GST
.                 V5.07.05  28.01.2000  B.G.Ackland
.                           Recompile in Work
.                 V5.07.04 10/01/2000  Nicole Harrington
.                          Fixed Y2K date problem - CYY displaying " 0"
.                 V5.07.03 20.12.1999  Katie Nelson
.                          Recompiled for IBAWEBDF/IBAWEBCD            
.                 V5.07.02 03/11/1999  Katie Nelson
.                          Recompiled for WEBDATCD/DAYOFWEK            
.                 V5.07.01 23/08/1999  Katie Nelson
.                          Fix Date Options to Stop Continuous Loop
.                 V6.06.01 04/05/1999 Katie Nelson
.                          New Program 
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       DEBINVDF
.
          INC       TFILEVAR/INC
          INC       CHKDIGVR/INC
          INC       IBAGSTFD/INC
          INC       IBALPCFD/INC
          INC       PRIVRDEB/INC
          INC       IBATMDFD/INC
          INC       PATCOMM/INC
          INC       PATDHEAD/INC
.
          INC       IBAPOLFD/INC
          INC       COMDEPFD/INC
          INC       DEBDBTFD/INC
          INC       DEBFDTFD/INC
          INC       DEBITMFD/INC
          INC       APSMASFD/INC
          INC       AAEDTRFD/INC
          INC       AAEDE1FD/INC
          INC       AAEDI1FD/INC
          INC       AAECONFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       EMRECTFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OUTECTFD/INC
          INC       PATBFEFD/INC
          INC       PATCFAFD/INC
          INC       PMSTLEFD/INC
          INC       PMSCIDFD/INC
          INC       PMSCLTFD/INC
          INC       PMSCLTTD/INC
          INC       PMSPRGFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPEXTFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       MLTCFNFD/INC
          INC       MLTSECFD/INC
          INC       PABXVARS/INC
          INC       PATAFEFD/INC
          INC       PATALRFD/INC
          INC       PATALWFD/INC
          INC       PATASDFD/INC
          INC       PATCALAG/INC
          INC       PATCMXFD/INC
          INC       PATCMCFD/INC
          INC       PATONHFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PRICONFD/INC
          INC       PATHOSFD/INC
          INC       MRTCONFD/INC
          INC       PATCTFFD/INC
          INC       PATDO1FD/INC
          INC       PATDGWFD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATEDTFD/INC
          INC       PATELGFD/INC
          INC       PATHDFFD/INC
          INC       PATHSPFD/INC
          INC       PATIBLFD/INC
          INC       PATICDFD/INC
          INC       PATIN1FD/INC
          INC       PATJRNFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PATHLFFD/INC
          INC       PATIPEFD/INC
          INC       PATIPRFD/INC
          INC       PATINVFD/INC
          INC       PATIRNFD/INC
          INC       PATITMFD/INC
          INC       PATFACFD/INC
          INC       PATFEEFD/INC
          INC       PATFIGFD/INC
          INC       PATFINFD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPIVBFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPRDTFD/INC
          INC       OBSPCOFD/INC
          INC       OBSPCTFD/INC
          INC       PATFN1FD/INC
          INC       PATHGPFD/INC
          INC       PATHTRFD/INC
          INC       EMRHTRFD/INC
          INC       OUTHTRFD/INC
          INC       PATMA1FD/INC
          INC       PATPGRFD/INC
          INC       PMSAELFD/INC
          INC       PMSAILFD/INC
          INC       PMSCMTFD/INC
          INC       PATCMTFD/INC
          INC       PMSCNOFD/INC
          INC       PMSEVTFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSFCIFD/INC
          INC       PMSMTIFD/INC
          INC       PMSPTDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSECTFD/INC
          INC       PRIECTFD/INC
          INC       PMSWORFD/INC
          INC       PMSWORTD/INC
          INC       PATFAPFD/INC
          INC       PATMESFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATMMBFD/INC
          INC       PATPFAFD/INC
          INC       PATPARFD/INC            * Eclipse Participants
          INC       PATPR1FD/INC
          INC       PATASFFD/INC
          INC       PATRBLFD/INC
          INC       PATRATFD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC            * Person Responsible for Acct cgi's
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATSGCFD/INC
          INC       PATSCFFD/INC
          INC       PATTFEFD/INC
          INC       PATRCAUD/INC
          INC       PATREMFD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATDADFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWVEFD/INC
          INC       PMSFEDFD/INC
          INC       PMSFEDTD/INC
          INC       PMSFENFD/INC
          INC       PMSFESFD/INC
          INC       PMSFESTD/INC
          INC       PMSFETFD/INC
          INC       PMSFIDFD/INC
          INC       PMSFIDTD/INC
          INC       OPRARDFD/INC
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDECFD/INC
          INC       OUTDTRFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTSITFD/INC
          INC       OUTCTYFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       MAMMASFD/INC
          INC       RESLNKFD/INC
          INC       MRTMASFD/INC
          INC       VISPAYFD/INC
          INC       VISPAYTD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       IBAGEDFD/INC
          INC       PMSICMFD/INC
          INC       PATRGMFD/INC
          INC       PMSREGFD/INC
          INC       PMSEXTFD/INC
          INC       PATIFCFD/INC
.
          INC       MULTVISV/INC            * PATDPATH variables
          INC       PATDPTHV/INC            * PATDPATH variables
          INC       WEBDINVS/INC     * ---- substitue include for PATDINVS ----
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSVX1FD/INC
          INC       PATUREFD/INC
          INC       PATRASFD/INC
          INC       PATDETFD/INC
          INC       PATDDHFD/INC
          INC       PMSPYRFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIVBFD/INC
          INC       PMSIDEFD/INC
          INC       PMSVSCFD/INC
.
          INC       PRICMNFD/INC
          INC       PRISECFD/INC
          INC       PRIALSFD/INC
          INC       PRIICMFD/INC                 * PP Invoice comments file
          INC       PRICNOFD/INC
          INC       PRIHDBFD/INC                 * holding header file
          INC       PRIHREFD/INC                 * referral file
          INC       PRIHRETD/INC
          INC       PRIDTRFD/INC                 * debtor transaction file
          INC       PRIINVFD/INC                 * invoice file
          INC       PRIPRAFD/INC
          INC       VARGBCRN/INC                 * I-48227
.
          INC       RCPCONFD/INC                 * Receipts
          INC       RCPREGFD/INC                 * Receipts
          INC       RCPBDTFD/INC
          INC       RCPDTEFD/INC                 * Receipts
          INC       RCPBNKFD/INC                 * Receipts
          INC       RCPCRSFD/INC
.
          INC       PMSEDGFD/INC       * Effective DRG Dates
.
          INC       WEBPCIFD/INC
          INC       WEBIHCFD/INC
          INC       WEBIMCFD/INC
          INC       WEBBBSFD/INC
          INC       WEBDVWFD/INC
.
          INC       PATMISTD/INC
          INC       RSHWEBDF
.
.TOCCYY    FORM      4
.FRCCYY    FORM      4
.DCCYY     DIM       4
.DCENT     DIM       2
.DYEAR     DIM       2
.FORM72    FORM      7.2
.
MTIFLAG    FORM      1
MPGEFLAG   FORM      1
.
.
.   Work Variables
.
THEANUMB  FORM     2
THCFLAG   FORM     1
TFFSAMNT  FORM     12.2
TOTTCRD   FORM     7.2
TOTTGST   FORM     7.2
TOTCCRD   FORM     7.2
TOTCGST   FORM     7.2
TOTLFLAG  FORM     1
TGSTAMNT  FORM     12.2
TGSTEXCV  FORM     12.2
TODAY     DIM       8
.AADMNOX   DIM       8
ADIAG     DIM       50
ALLOCATU  DIM       1
ATTDOCT   DIM       31
ATTPROV   DIM       10
ACTNCODE  DIM       3
ASGDEB    DIM       1[999]
PRTINV    DIM       1[999]
INVNUM    DIM       8[999]
INVOICNO  DIM       8
PRVBTYP   DIM       3
ICUBTYP   DIM       3
SCNBTYP   DIM       3
SHRBTYP   DIM       3
FEESTYPE  FORM      1
FESTFLAG  FORM      1
.
BFECOUNT  FORM      2
BFAMT     FORM      4.2
BBDESC    DIM       20
BASICFLG  FORM      1
BASICHF   FORM      12.2
BOOKFLAG  FORM      1
SBTYPEPA  FORM      12.2
SBTYPEHF  FORM      12.2
PRIFEEPA  FORM      12.2
PRIFEEHF  FORM      12.2
.
CLMINDIC  DIM       1
CORRESID  FORM      4
CORSP001  DIM       30
CORSP002  DIM       8
CORSP003  DIM       3
CORSP004  DIM       8
CORSFILE  DIM       20
CORSPPRT  INIT      ".pdf"
CMDMOVE   INIT      "mv "
CMDFCHK   INIT      "cliweb08.us1 "
TBSPOOL   INIT      "TBSPOOL"
DASH      INIT      "-"
SAVVISIT  DIM       8
SAVURNUM  DIM       8
TEMPNAME  DIM       8
TEMPFILE  FILE      ASCII,FIXED=127
CURRDATE  DIM       8
COLRFLAG  DIM       15
CRDFLAG   FORM      1
CPNDFLAG  DIM       1
PTRBFLAG  FORM      1
CREDITEM  FORM      1
COUNTER   FORM      3 
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
COMTYPE   FORM      1
COMWTKEY  DIM       18
CATGB     INIT      "GB"
CODEGI    INIT      "GI"
CFILEPRE  DIM       3
CHGFLAG   FORM      1
CALDAYS   FORM      4
.CDYSDAYS  FORM      6
.CDYSFDTE  DIM       8
.CDYSTDTE  DIM       8
.CDYSYEAR  FORM      2
CMDLINE   DIM       180
CNTPTFLG  FORM      1
CURSESS   DIM       14
CURDATE8  DIM       8
CCENT1    DIM       2
CYEAR1    DIM       2
CMON1     DIM       2
CDAY1     DIM       2
CMXFLG    FORM      1
CHCKHOSP  DIM       4
COMCHAR   INIT      "M1W2V3"
CREDAMNT  FORM      8.2[999]   * Array of credit amount
CREDITNO  DIM       8 
.
DEFSTCOD  DIM       6
DSTEP     DIM       1
DOCNAME   DIM       25                           * formatted doctor name
DAYFORMT  DIM       4
DOCTCODE  DIM       6
DSCHFLAG  FORM      1
DIM1A     DIM       1
DIM3      DIM       3
DIM3A     DIM       3
DIM3B     DIM       3
DIM4      DIM       4
DIM6U     DIM       6
DIM7      DIM       7
DIM9      DIM       9
DIM10A    DIM       10
DIM12A    DIM       12
DIM14     DIM       14
DIM14A    DIM       14
DIM14B    DIM       14
DIM18     DIM       18
DIM18A    DIM       18
DIM19A    DIM       19
DIM25A    DIM       25
DIM26A    DIM       26
DIM27A    DIM       27
DIM30     DIM       30
DIM30A    DIM       30
DIM50     DIM       50
DIM70     DIM       70
DIM80     DIM       80
DIM127A   DIM       127
DISPDATE  DIM       11
DNAME     DIM       20
DOCLINE1  DIM       62
DOCLINE2  DIM       62
DOCTNAM   DIM       36
DIM14GRN  DIM       14
DIM14TAX  DIM       14
.
EPMPATAM  FORM      12.2
EPMREBAM  FORM      12.2
EPMFLAG   FORM      1
EMCNGINV  DIM       1
EXTRFLG   FORM      1
EMRVFLAG  FORM      1
ENDDAT    DIM       6
ENDNAM    DIM       6
ENDSEC    FORM      5
EXPIRYDT  DATE      8
EXPCDATE  DIM       8
EXPCTDSC  DIM       19
.
PUBCLAIM  FORM      1
PFFSFLAG  FORM      1
FMBSCODE  DIM       9[100]
OMBSCODE  DIM       9[100]
FNDBTYPE  DIM       15
FULLPAID  DIM       1
FILTCLAM  DIM       3
FILTHFND  DIM       6
FILTSTAT  DIM       1
FILTAUTO  DIM       1
F4P2      FORM      4.2
F12P2     FORM     12.2
FEDCOMAF  FILE      ASCII, FIXED=256
FEDCOMFL  FORM      1
FEDCOMNM  DIM       8
FEEINFLG  FORM      1                       * fees information update flag
FESTINDC  FORM      2
LASTFEDP  FORM      3   * Last Item
FGSTFLAG  FORM      1
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FNAMEC    DIM       8
FNAMED    DIM       8
FORMCNT   FORM      1
FORM1A    FORM      1
FORM1B    FORM      1
FORM2B    FORM      2
FORM1C    FORM      1
FORM2A    FORM      2
FORM3A    FORM      3
FORM5     FORM      5
FORM52    FORM      5.2
FORM8     FORM      8
FORM8P2   FORM      8.2
FORM102   FORM      10.2
FORM10    FORM      10
FUNDGAP   FORM      5.2
.
HOSPCODE  DIM       4
HOSPFLAG  FORM      1
HFNDESC   DIM       6 
HFNTABL   DIM       8
HDUDAY1   FORM      3                       * High Dependency
HDUDAY2   FORM      3
HLTHFUND  DIM       6
HFUNDGRP  DIM       6
HGRPFLAG  FORM      1
HOWPAID   DIM       13
HFHIFUND  FORM      2
.
GLAMOUNT  FORM     12.2
GSTAAMNT  FORM      8.2[999]   * Array of GST amount
GSTCODES  DIM       6
..ITCODE    DIM       12
INVCEIMG  FORM      "1"                     * Display Invoice image
ITEMCD    FORM      1
ITEMFLAG  FORM      1                       * Input items flag
ITHOSTOT  FORM      12.2
ITGSTTOT  FORM      12.2
ACGSTTOT  FORM      12.2
ITREBTOT  FORM      12.2
.
ITPATGST  FORM      12.2
ITFNDGST  FORM      12.2
ACPATGST  FORM      12.2
ACFNDGST  FORM      12.2
.
INVOICEN  FORM      12
INITDATE  DIM       8
IFCFLAG   FORM      1
IHCINVON  DIM       8
IHCBTCHN  DIM       8
QUOTENUM  FORM      12
QUOTEEST  FORM      12
.
JOURFLAG  FORM      1
JOURNLKY  DIM       24
JOURTOT   FORM      12.2
JYEAR     FORM      2
.
KEY13A    DIM       13
KEY21A    DIM       21
KEY22A    DIM       22
KEY26A    DIM       26
KEY29A    DIM       29
KEYFLAG   FORM      1
KEEPMISC  FORM      1
.
LASTITEM  FORM      3       * Last Array Item 
LSTDATE   DIM       8
LASTINV   FORM      1
LNO       FORM      2
LOOPCNTR  FORM      3
LWCHG     FORM      6.2                     * Labour Ward Fee
LWDT      DIM       8
LSTACCM   DIM       8
.
MBSINDEX  FORM      3
MODECODE  DIM       3
MBSLOP    FORM      2
MBSDESC   DIM       40
MBSFLAG   FORM      1
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MINOWE    FORM      6.2
MULTAMT   FORM      6.2
MULTNUM   FORM      3
MINFLD    FORM      2
MAXSCRN   FORM      2
MTHNAM3A  DIM       3
MULTHOSP  DIM       4
NAME80    DIM       80
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
NOCOMPCL  FORM      1
NZEROFLG  FORM      1
.
ONAME     DIM       30
OPERCODE  DIM       4
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8                       * Other Items
OTDT2     DIM       8
OVRGAP    FORM      10.2                    * Overnight fund total
.
.
PMFETFLG  FORM      1
PRINTINV  DIM       1
PATLINK   DIM       127                     * Link to the next patient info
PRINTPDF  DIM       1
PROSFLAG  DIM       1             * Prosthetic flag
.                                    A = Add
.                                    C = Change
.                                    D = Delete
.
REPTOPTN  DIM       1
PATTITLE  DIM       4
PATGIVEN  DIM       15
PRINTFEE  DIM       1
PSURNAME  DIM       20
ADDRESS1  DIM       35
ADDRESS2  DIM       35
ADDRESS3  DIM       35
POSTCODE  DIM       8
PATBIRTH  DIM       8
PATPHONE  DIM       20
PATPORTN  FORM      12.2
PROCESSD  FORM      1
REASMOVE  DIM       3
DEBTAGNT  DIM       3                       * Debt Collection Agency
LENPTR    FORM      2
REASADMN  DIM       50
.
NEXTVKEY  DIM       26
PHARMACY  FORM      12.2
PHARMREB  FORM      12.2
PROSTHET  FORM      12.2
PROSTREB  FORM      12.2
CONSUMAB  FORM      12.2
CONSMREB  FORM      12.2
DISCOUNT  FORM      12.2
.
SKEY8     DIM       8
SURGAPAM  FORM      6.2
ASSGAPAM  FORM      6.2
ANAGAPAM  FORM      6.2
ICUINTEN  FORM      6.2
PHYSINIT  FORM      6.2
PHYSSUBS  FORM      6.2
RADIOLGY  FORM      6.2
PATHOLGY  FORM      6.2
COSMETIC  FORM      6.2
.
PATINDIC  DIM       3
PPRCFLAG  FORM      1
PREVFLAG  FORM      1  
PREVVKEY  DIM       26
PAYMFLAG  FORM      1
PCENFLG   FORM      1
PSTROL    FILE      ASCII, FIXED=256
..PFNAME    DIM       30
.
RECDISP   FORM      1
REFDOCT   DIM       29
REGIST8   DIM       2
ROWCOUNT  FORM      5
RCASH     INIT      "Cash         "              * receipt types
RCHEQUE   INIT      "Cheque       "
RCCARD    INIT      "Credit Card  "
RMCARD    INIT      "Merchant Card"
RMORDER   INIT      "Money Order  "
.
DEBINVNO  DIM       12
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
REASCRED  DIM       3
LABELTYP  DIM       10
SPLITINV  FORM      12
SERVDOCT  DIM       10
SRCHSNAM  DIM       20
SRCHGNAM  DIM       25
SUBSYSKY  DIM       50
SAVATYPE  DIM       3
SAVESUNQ  DIM       3
SAVUNQID  DIM       10
SAVPSNAM  DIM       20
SAVEROVR  DIM       3
SAVELVIS  DIM       8
SETDEFPN  DIM       10[95]
SCHDPARR  DIM       6[95]   * Array of selected Printer
SCHDPCNT  FORM      2
SCHDCARR  FORM      3[95]   * Number of Copies
SCHDCCNT  FORM      2
SDOCFNAM  DIM       50
STATNARR  DIM       6[95]   * Stationary Code
STATNCNT  FORM      2
STATNCOD  DIM       6       * Stationery Code
.SCHDCOPY  FORM      3       * No of Copies
.SCHDPRNT  DIM       6       * Printer
STRACCM   DIM       8
SHOWFLAG  FORM      1
SDBTYPE   FORM      1
SAVEXTRA  FORM      6.2
SBWINDOW  FORM      1
SCDJULDY  FORM      4
SCDJULYR  FORM      2
SAVCENT   DIM       2
SAVBEND   FORM      3
SAVKEY12  DIM       12 
SAVKEY15  DIM       15 
SAVKEY16  DIM       16 
SAVKEY18  DIM       18 
SAVKEY20  DIM       20
SAVKEY22  DIM       22
SAVKEY23  DIM       23
SAVALLW   FORM      6.2
SAVDISC   FORM      6.2
SMCHARGE  DIM       9
SMITMTYP  FORM      1
SMMSCGRP  DIM       3
SAVFLAG   FORM      1
SAVADM    DIM       8
SAVDAY    DIM       2
SAVMON    DIM       2
SAVYEAR   DIM       2
SCANFLAG  FORM      2
SNETTOT   FORM      8.2
SDATE     DIM       8
SEC       FORM      5
SPECCODE  FORM      1
SPLING    FORM      2
STRTDAT   DIM       6
STRTNAM   DIM       6
SHDESC    DIM       23
STRDATE   DIM       12
SAVNODAY  FORM      5
SVCRAMNT  FORM      12.2
.
TRANSNUM  FORM      6[999]   * Array of Transaction number
TOTOUT    FORM      9.2
.TOTINV    FORM      9.2
TABLNA    DIM       25
TEMP1     FILE      ASCII,FIXED=70
TEMPAMT   FORM      6.2
TEMPETCP  FORM      12.2
TEMPETCH  FORM      12.2
TEMPEMCP  FORM      12.2
TEMPEMCH  FORM      12.2
THCFLG    FORM      2
THDUDT1   DIM       8
THDUDT2   DIM       8
THEACHG   FORM      6.2                     * Theatre Fee
THEADTE   DIM       8
THTOTAL   FORM      5.2
THFUND    FORM      5.2
THTHOSPT  FORM      10.2                    * Theatre fee hospital total
TEMPADT   DIM       3
TBSRTFLG  FORM      "0"                     * Flag for Table sorting
.
HEASINSR  FORM      "0"
SELFINSR  FORM      1
USEBASIC  DIM       1                       * Use Basic Cover rate
UPDATEST  FORM      1
UPDATETP  FORM      1
UPDATETY  FORM      1
UNIQUE    FORM      8
UNIQUEX   DIM       8
UNIQNUMB  DIM       8
UPGSTFLG  FORM      1
VISITTYP  FORM      1
VALINTXT  DIM       62                      * Cal Cl Indicator 15 check
.
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FILE      ASCII, FIXED=256
.
XTRDFLAG  FORM      1
XDESC     DIM       30
XXCENT    DIM       2
XXADM     DIM       6
XXDAY     DIM       2
XXMON     DIM       2
XXMULT    FORM      3
XXNAM     DIM       22
XXYEAR    DIM       2
XAMT      FORM      4.2
XMBS      FORM      5
XAMTX     DIM       7
XMBSX     DIM       5
XDATE1    DIM       8
.
HDINVFLG  DIM       1
ACTION    DIM       25
PERFBY    DIM       30
HDREASON  DIM       20
.
. ----- Variables for automatic admission type change / exploding charges -----
.
ADMTYP    DIM       3                       * Admission type
ADMTYPFG  FORM      1                       * Auto admission type flag
DTRDATE   DIM       8                       * DTR date (ccyymmdd)
.EFTADMIN  FORM      6                       * Effective admission number
EFTATYPE  DIM       3                       * Effective admission type
EFTDATE   DIM       8                       * Effective date (ccyymmdd)
EFTTIME   DIM       8                       * Effective time
EXPCHCNT  FORM      2                       * Exploding MBS charge counter
.FORM42    FORM      4.2
FORM5P2   FORM      5.2
INVCOUNT  FORM      3                                                 *I-149764
MBSCOUNT  FORM      2                       * MBS item counter
MBSDATE   DIM       8[15]                   * MBS date (ccyymmdd)
MBSITEM   DIM       9[15]                   * MBS items
NOATYPUP  FORM      1                       * No admission type updated flag
SAVKEY9   DIM       9
SAVKEY14  DIM       14
SAVKEY27  DIM       27
SAVKEY34  DIM       34
SAVKEY38  DIM       38
.
.
.   Constants
.
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODECL    INIT      "CL"
CODEFA    INIT      "FA"
CODERH    INIT      "rh"
.
FIRST     FORM      "0"
FAILCNT   FORM      8
F82       FORM      8.2
.
HDUFLG    FORM      "0"
.
LWCODE    INIT      "LW"
.
MBSNUM    FORM      "0"
.
SELFLG    FORM      "0"
SP14      INIT      "              "
SP22      INIT      "                      "
SP27      INIT      "                           "
SURGFLG   FORM      "0"
.
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
OTCODE    INIT      "OT"
OTFLG     FORM      "0"
OPNFLAG   FORM      "0"                     * Used in stepdown
.
ZERO00    FORM      "0.00"
ZERO4     INIT      "0000"        
ZERO8     INIT      "0000    "              * needed by PATINVS
ZEIGHT    INIT      "00000000"              * needed by PATREBAT
.
CWKEY15   DIM       15
CWKEY34   DIM       34
CLMDESC   DIM       20
VISTDESC  DIM       10
EMRPAT    INIT      "Emergency "
OUTPAT    INIT      "Outpatient"
INPPAT    INIT      "Inpatient "
.
SBEDTYPE  DIM       3
SUMOUTS   FORM      12.2
SUMPAID   FORM      12.2
SUMINV    FORM      12.2
SUMJR     FORM      12.2
TOTOUTS   FORM      12.2
TOTPAID   FORM      12.2
TOTDEPS   FORM      12.2
SUMPPOR   FORM      12.2
SUMRPOR   FORM      12.2
SUMPCSH   FORM      12.2
SUMRCSH   FORM      12.2
.
MCFILE    IFILE     SQL, FIXED=14, KEY="u1-9"
XCHARGE   DIM       9        9        1
XMCCNT    FORM      5        4        10
.EOF                                  14
.
TTFILE    IFILE     SQL, FIXED=150, KEY="u1-18"
DXAMT     DIM      11      11      1
DXMBS     DIM       5       5     12
DUNIQ     DIM       2       2     17
XTHEA     DIM       9       9     19
XBAND     DIM       3       3     28
.TFPAT1   FORM   12.2       8     31
.TFPAT2   FORM   12.2       8     39
.TFPAT3   FORM   12.2       8     47
.TFPAT4   FORM   12.2       8     55
.TFPAT5   FORM   12.2       8     63
.TFPAT6   FORM   12.2       8     71
.TFHF1    FORM   12.2       8     79
.TFHF2    FORM   12.2       8     87
.TFHF3    FORM   12.2       8     95
.TFHF4    FORM   12.2       8    103
.TFHF5    FORM   12.2       8    111
.TFHF6    FORM   12.2       8    119
XQUAN     FORM    3         3    127
XGSTA     DIM     1         1    130
XGSTC     DIM     6         6    131
XBTYP     DIM     3         3    137
XKGST     DIM     1         1    140
XAMNT     FORM    12.2      8    141
XKAMT     DIM     1         1    149
.
.EOR                             150
.
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB76"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Re-Print Patient Invoice Server"      
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      INVENQ00                * display invoice
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      REPINV00                * reprint invoice
          BRANCH    EXIT,MAIN1000
.
          MOVE      "Printing Complete",WEBTITLE
          IF        SBWINDOW<>ZERO
            CALL      WINALT00
          ELSE
            CALL      DISALT00
          ENDIF
          GOTO      MAIN1000
.
MAIN1300  CALL      INVDEB00                * display Debtors invoice
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      LRCP0000                * List of Receipts Processing
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
NXTPAG20  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      AAEDTRE1,"aaedtref"
          OPEN      AAEDTRE4,"aaedtref"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      PATIN1A1,"patin1af" 
          OPEN      PATJRNL1,"patjrnlf"
          OPEN      PATRE1A1,"patre1af" 
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      MLTCODA1,"mltcodaf" 
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATTRAN2,"pattranf"        
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATHTRA1,"pathtraf"
          OPEN      PATHTRA2,"pathtraf"
          OPEN      EMRHTRA1,"emrhtraf"
          OPEN      EMRHTRA2,"emrhtraf"
          OPEN      OUTHTRA1,"outhtraf"
          OPEN      OUTHTRA2,"outhtraf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA3,"patdtraf"
          OPEN      PATDTRA4,"patdtraf"
          OPEN      PATDTRA5,"patdtraf"
          OPEN      PATELGA1,"patelgaf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATHLFA1,"pathlfaf"
          OPEN      PATHDFA1,"pathdfaf"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATINVR5,"patinvrf"
          OPEN      PATINVR7,"patinvrf"
          OPEN      PATFEEP1,"patfeepf"
          OPEN      PATCTFA1,"patctfaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATTFEE1,"pattfeef"
          OPEN      PMSCLTA1,"pmscltaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRDETC1,"oprdetcf"
          OPEN      PATLDFA1,"patldfaf"
          OPEN      PATAFEA1,"patafeaf"
          OPEN      PATRBLA1,"patrblaf"
          OPEN      PATIBLA1,"patiblaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
.
          OPEN      PATPGRA1,"patpgraf"
          OPEN      PATCMXA1,"patcmxaf"
          OPEN      PATDTRA5,"patdtraf"
          OPEN      PATDTRA6,"patdtraf"
          OPEN      PMSICMA1,"pmsicmaf"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
.
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFN1A3,"patfn1af"
          OPEN      PATHGRP1,"pathgrpf"
          OPEN      PATFINS1,"patfinsf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      PATFIGA1,"patfigaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPRDTA1,"nzprdtaf"
          OPEN      NZPRDTA4,"nzprdtaf"
          OPEN      NZPRDTA5,"nzprdtaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATIRNG1,"patirnge"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATPARA1,"patparaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATONHA1,"patonhaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSAELA1,"pmsaelaf"
          OPEN      PMSAELA2,"pmsaelaf"
          OPEN      PMSAILA1,"pmsailaf"
          OPEN      PMSAILA2,"pmsailaf"
          OPEN      PMSCNOA1,"pmscnoaf"
          OPEN      PMSCNOA2,"pmscnoaf"
          OPEN      PMSCNOA3,"pmscnoaf"
          OPEN      PMSFEDA1,"pmsfedaf"
          OPEN      PMSFEDA2,"pmsfedaf"
          OPEN      PMSFENA1,"pmsfenaf"
          OPEN      PMSFENA2,"pmsfenaf"
          OPEN      PMSFESA1,"pmsfesaf"
          OPEN      PMSFESA2,"pmsfesaf"
          OPEN      PMSFIDA1,"pmsfidaf"
          OPEN      PMSFIDA2,"pmsfidaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSFCIA1,"pmsfciaf"
          OPEN      PMSFCIA2,"pmsfciaf"
          OPEN      PMSFCIA3,"pmsfciaf"
          OPEN      PMSPTDA1,"pmsptdaf"
          OPEN      PMSPTDA2,"pmsptdaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSVSCA1,"pmsvscaf"
          OPEN      RCPREGA1,"rcpregaf"
.
          OPEN      PRIICMA1,"priicmaf"
          OPEN      PRICMNT1,"pricmntf"
          OPEN      PRIINVO1,"priinvof"
          OPEN      PRIINVO3,"priinvof"
          OPEN      PRIHREF1,"prihreff"
          OPEN      PRIHREF2,"prihreff"          * referral file
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIDTRA1,"pridtraf"          * debtor transaction file
          OPEN      PRIDTRA3,"pridtraf"          * debtor transaction file
          OPEN      PRIINVO1,"priinvof"          * invoice file
          OPEN      PRIINVO3,"priinvof"
          OPEN      PRIPRAC1,"pripracf"          * medical practice file
          OPEN      COMDEPA1,"comdepaf"          * medical practice file
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPDTEA5,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATHOSP1,"pathospf"
          OPEN      PATHOSP2,"pathospf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
          OPEN      IBAGEDA1,"ibagedaf"
          OPEN      PATUREA1,"patureaf"
          OPEN      PATUREA2,"patureaf"
          OPEN      PATRASA1,"patrasaf"
          OPEN      PATDETA1,"patdetaf"
          OPEN      PATFACT1,"patfactf"
          OPEN      PATFAPA1,"patfapaf"
          OPEN      PATPFAA1,"patpfaaf"
          OPEN      IBAPOLA1,"ibapolaf"
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00        * Open outpatient file
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRVISA1,"emrvisaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRVFLAG
.
          CALL      RDCNT000                       *Read control file
.
          COMPARE   ONE,HSYS6
          GOTO      INIT2000 IF NOT EQUAL
.
          OPEN      DEBDBTA1,"debdbtaf"
          OPEN      DEBDBTA4,"debdbtaf"
          OPEN      DEBFDTA6,"debfdtaf"
          OPEN      DEBITMA1,"debitmaf"
.
INIT2000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      AAEDE1A1,"aaede1af"
          TRAPCLR   IO
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEC
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMED
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FEDCOMNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CFNAMEDP
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWO;*4,CNAME
          READ      CONTROLF,TEN;*79,CAPPRVNO,*244,CHOSPNUM,*104,PTCNMBSF
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,EIGHTY8;*248,PTCNISBZ
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          READ      CONTROLF,HUND03;*1,PTCNCJRN,*212,PTCNPFSN,PTCNPFGN:
                                    *246,PTCNLJCD,PTCNWJCD
          READ      CONTROLF,HUND08;*124,RCCNSTRF
          READ      CONTROLF,HUND10;*115,PTCNUEDI          
          READ      CONTROLF,HUND12;*118,PTCNTRPR
          READ      CONTROLF,HUND14;*249,PTCNDFUP
          READ      CONTROLF,HUND18;*165,PTCNPPRC,*166,PTCNPITM
          READ      CONTROLF,THIRTY4;*231,PRCNPJCI
          READ      CONTROLF,HUND20;*160,PTCNIFCL,*244,PTCNCWCL
          READ      CONTROLF,HUND24;*111,PTCNUIMC,*212,PTCNIRAI,*216,PTCNRJNL:
                                    *222,PTCNUESF
          READ      CONTROLF,HUND27;*122,PTCNUEBB
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND29;*1,PTCNWSDR,*61,PTCNWSIN,*62,PTCNRKDY:
                                    *68,PTCNTKMN,*73,PTCNIMCW,*88,PTCNIHCW:
                                    *89,PTCNPPIN,*91,PTCNPCIW,*193,PTCNBBSW:
                                    *249,PTCNDVAW
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTCFNA1,"mltcfnaf"
          ENDIF
.
          OPEN      MLTSECA1,"mltsecaf"
          CALL      PATDPATH
          MOVE      ZERO,UPGSTFLG
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSFETA1,"pmsfetaf"
          TRAPCLR   IO
          MOVE      OVRCD,PMFETFLG
.
          RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the FILBB file
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          OPEN      OUTDTRO1,CFNAME
          OPEN      OUTDTRO4,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Slot templat header file
.
OPNOUT99  RETURN
+
.------------------------------------------------------------
.   Read the control file
.------------------------------------------------------------
RDCNT000  READ      CONTROLF,ZERO;*43,IBCNMHOS:
                                  *85,IBCNUGST
          READ      CONTROLF,TEN;*66,CINVLAY:
                                 *94,CAGECOFF,*166,CMEMB:
                                 *183,CVIEWIP:
                                 *188,CCHKRAT,*192,CACCFEE,*217,CAUDQ
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2,CHPPOST:
                                  CHTELEB,*154,CUSEMBS,*163,BEDTYP:
                                 *211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN5;*189,CTHETR,*247,CSTDOWN
          READ      CONTROLF,TEN8;*143,CLOWMBS,CLOWADM,CHIGHMBS,CHIGHADM:
                                       CTOPADM,*206,CFINAN
          READ      CONTROLF,TEN9;*212,CFEETYP,*216,CINVRIP
          READ      CONTROLF,TWENTY;*164,PTRESDAY,*166,PTCNTACP:
                                  *211,PTCNCNDY
          READ      CONTROLF,TWENTY1;*44,PTCNIDES,*51,PTCNINVL,*237,PTCNPAOF
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,THIRTY6;*91,HSYS6
          READ      CONTROLF,FIFTY9;*1,CDLSTEP,*23,CFUTINV,CFUTENQ,CFUTCOM:
                                    *33,CPRTREC,*62,CINVJRN:
                                  *210,PTMBSINV,PTPAYRPR,PTREBRPR
          READ      CONTROLF,SEVENTY7;*218,PTCNDSDY,PTCNDMSO
          READ      CONTROLF,SEVENTY8;*40,AECNAEIH,*46,AECNAEIT
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,*248,PTCNIPEN
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR
          READ      CONTROLF,NINTY8;*127,PTCNPMIS,*136,PTCNPAIH,*142,PTCNPAIT:
                                    *148,PTCNINVB
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*130,PTCNAUAT,*131,PTCNWSPC:
                                      *132,PTCNADB1,PTCNADB2,PTCNADB3,PTCNADB4:
                                      *190,PTSGCOPT:
                                      *195,PTCNLASR
          READ      CONTROLF,HUND09;PTCNQUM1,PTCNQUM2,*196,PTCNCRNO
          READ      CONTROLF,EIGHTY9;*221,EMCNGINV
.
RDCNT999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,SELPRINT
          MOVE      SP70,CREDITNO
          MOVE      SP70,CHCKHOSP
          MOVE      ZERO,INVOICEN
          MOVE      ZERO,QUOTENUM
          MOVE      ZERO,UPDATETP
          MOVE      ZERO,UPDATETY
          MOVE      ZERO,VISITTYP
          MOVE      ZERO,NOCOPIES
          MOVE      ZERO,SBWINDOW
          MOVE      ZERO,KEEPMISC
          MOVE      ZERO,CRDNFLAG
          MOVE      ZERO,JHFLAG  
          MOVE      SP70,EXPPAYER
          MOVE      ZERO,NOCOMPCL
          MOVE      ZERO,UPDATEST
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,JOURNLKY
.
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,NEXTVKEY
          MOVE      SP70,PREVVKEY
          MOVE      ZERO,PREVFLAG
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,REASCRED
          MOVE      SP70,SERVDOCT
          MOVE      SP70,SRCHSNAM
          MOVE      SP70,SRCHGNAM
          MOVE      SP70,PRINTFEE
          MOVE      SP70,ALLOCATU
          MOVE      SP70,INITDATE
          MOVE      SP70,ACTNCODE
          MOVE      SP70,MODECODE
          MOVE      SP70,PRINTINV
.
          MOVE      SP70,FILTCLAM
          MOVE      SP70,FILTHFND
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTAUTO
.
          MOVE      Z70,HFUNDGRP
          MOVE      Z70,MULTHOSP
.
          MOVE      ZERO,TBSRTFLG
          MOVE      SP70,INVCEIMG
.
          MOVE      SP70,VALINTXT
.
          CALL      CLPTPRA0                * clear PRA cgi vars
          CALL      CLPMCL00
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 998
            MOVE      ZERO,CREDAMNT[COUNTER] 
            MOVE      ZERO,GSTAAMNT[COUNTER] 
            MOVE      ZERO,TRANSNUM[COUNTER] 
            ADD       ONE,COUNTER
          DO
.
          CALL      CPMFD000           * pmsfedaf file
          MOVE      ZERO,PHARMACY
          MOVE      ZERO,PHARMREB
          MOVE      ZERO,PROSTHET
          MOVE      ZERO,PROSTREB
          MOVE      ZERO,CONSUMAB
          MOVE      ZERO,CONSMREB
          MOVE      ZERO,DISCOUNT
          MOVE      ZERO,SURGAPAM
          MOVE      ZERO,ASSGAPAM
          MOVE      ZERO,ANAGAPAM
          MOVE      ZERO,ICUINTEN
          MOVE      ZERO,PHYSINIT
          MOVE      ZERO,PHYSSUBS
          MOVE      ZERO,RADIOLGY
          MOVE      ZERO,PATHOLGY
          MOVE      ZERO,COSMETIC
.
.         PREP      FEDCOMAF,FEDCOMNM
          MOVE      ZERO,FEDCOMFL
.
          CALL      CPPMFI00           * clear pmsfidaf cgis
.
          MOVE      ZERO,SCHDPCNT
          MOVE      ZERO,F3
CLRPAR20  ADD       ONE,F3
          IF        F3<=95
            PACK      SCHDPARR[F3],SP70,SP70
            GOTO      CLRPAR20
          ENDIF
.
          MOVE      ZERO,F3
CLRPAR25  ADD       ONE,F3
          IF        F3<=95
            PACK      SETDEFPN[F3],SP70,SP70
            GOTO      CLRPAR25
          ENDIF
.
          MOVE      ZERO,SCHDCCNT
          MOVE      ZERO,F3
CLRPAR30  ADD       ONE,F3
          IF        F3<=95
            MOVE      ZERO,SCHDCARR[F3]
            GOTO      CLRPAR30
          ENDIF
.
          MOVE      ZERO,STATNCNT
          MOVE      ZERO,F3
CLRPAR55  ADD       ONE,F3
          IF        F3<=95
            PACK      STATNARR[F3],SP70,SP70
            GOTO      CLRPAR55
          ENDIF
.
          MOVE      SP70,SCHDPRNT
          MOVE      ZERO,SCHDCOPY
          MOVE      SP70,STATNCOD
.
          MOVE      SP70,REPTOPTN
          MOVE      SP70,PATTITLE
          MOVE      SP70,PATGIVEN
          MOVE      SP70,PSURNAME
          MOVE      SP70,ADDRESS1
          MOVE      SP70,ADDRESS2
          MOVE      SP70,ADDRESS3
          MOVE      SP70,POSTCODE
          MOVE      SP70,PATBIRTH
          MOVE      SP70,PATPHONE
.
          MOVE      ZERO,PATPORTN
          MOVE      ZERO,PROCESSD
          MOVE      SP70,REASMOVE
          MOVE      SP70,DEBTAGNT
          MOVE      Z70,FULLPAID
          MOVE      SP70,REASADMN
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,ASGDEB[F3]
            MOVE      SP70,PRTINV[F3]
            MOVE      SP70,INVNUM[F3]
            MOVE      SP70,FMBSCODE[F3]
            MOVE      SP70,OMBSCODE[F3]
            ADD       ONE,F3
          DO
.
          MOVE      SP70,UNIQNUMB
          CALL      CPPRHR00
.
          MOVE      ZERO,THEANUMB
          MOVE      ZERO,MBSINDEX
.
          MOVE      ZERO,SBTYPEPA
          MOVE      ZERO,SBTYPEHF
          MOVE      ZERO,PRIFEEPA
          MOVE      ZERO,PRIFEEHF
          MOVE      SP70,INVOICNO
          MOVE      SP70,PRINTPDF
          MOVE      ZERO,PTRBFLAG         * Patient/Rebate Invoice raised flag
          MOVE      ZERO,QUOTEEST
          MOVE      ZERO,FESTFLAG
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exppayer=",QRYNAME
          IF        @EQUAL
            PACK      EXPPAYER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "creditno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREDITNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "quotenum=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,QUOTENUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "multhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printpdf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTPDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHCKHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,VISITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keepmisc=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,KEEPMISC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbwindow=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SBWINDOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reascred=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASCRED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERVDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trano",QRYNAME    
          IF        @EQUAL
            CALL      STTRN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cramt",QRYNAME    
          IF        @EQUAL
            CALL      STCRD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gsamt",QRYNAME    
          IF        @EQUAL
            CALL      STGST000
            GOTO      SETPAR99
          ENDIF
.
          CALL       SPPRA000          * Set parameters for PRFA
.
          MATCH     "hlthfund",QRYNAME    
          IF        @EQUAL
            MOVE      QRYDATA,HLTHFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hfundgrp",QRYNAME    
          IF        @EQUAL
            MOVE      QRYDATA,HFUNDGRP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatetp=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsfd",QRYNAME
          IF        @EQUAL
            CALL      SPMFD000      * parameters for pmsfedaf
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pharmacy",QRYNAME    
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PHARMACY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pharmreb",QRYNAME    
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PHARMREB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prosthet",QRYNAME    
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PROSTHET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prostreb",QRYNAME    
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PROSTREB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "consumab",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,CONSUMAB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "consmreb",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,CONSMREB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "discount",QRYNAME    
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,DISCOUNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "surgapam",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SURGAPAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "assgapam",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,ASSGAPAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "anagapam",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,ANAGAPAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "icuinten",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,ICUINTEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "physinit",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PHYSINIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "physsubs",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PHYSSUBS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "radiolgy",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,RADIOLGY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patholgy",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PATHOLGY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cosmetic",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,COSMETIC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mischg",QRYNAME
          IF        @EQUAL
            CALL      SMCHG000      * parameters for misc.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "misqua",QRYNAME
          IF        @EQUAL
            CALL      SMQUA000      * parameters for misc.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "misamt",QRYNAME
          IF        @EQUAL
            CALL      SMAMT000      * parameters for misc.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstapm",QRYNAME
          IF        @EQUAL
            CALL      SGAPM000      * parameters for misc.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcom",QRYNAME
          IF        @EQUAL
            CALL      SMGST000      * parameters for misc.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thefee",QRYNAME
          IF        @EQUAL
            CALL      STFEE000      * parameters for theatre.item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "thequa",QRYNAME
          IF        @EQUAL
            CALL      STQUA000      * parameters for theatre item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstapl",QRYNAME
          IF        @EQUAL
            CALL      SGAPL000      * parameters for theatre item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcod",QRYNAME
          IF        @EQUAL
            CALL      SGCOD000      * parameters for theatre item
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsfi",QRYNAME
          IF        @EQUAL
            CALL      SPPMF000      * parameters for pmsfidaf
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcop",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SCHDCOPY
            MOVE      QRYDATA,SCHDCARR[SCHDPCNT]
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprn",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            PACK      SCHDPARR[SCHDPCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdefp",QRYNAME
          IF        @EQUAL
            PACK      SETDEFPN[SCHDPCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statnco",QRYNAME
          IF        @EQUAL
            ADD       ONE,SCHDPCNT
            PACK      STATNARR[SCHDPCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reptoptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPTOPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pattitle=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATTITLE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patgiven=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,patgiven
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "psurname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PSURNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "address1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRESS1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "address2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRESS2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "address3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRESS3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "postcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,POSTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patbirth=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      PATBIRTH,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patphone=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPHONE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchsnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHSNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchgnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHGNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printfee=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allocatu=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLOCATU
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "initdate=",QRYNAME
          IF        @EQUAL
            CALL      SCHDAT00
            PACK      INITDATE,KEY8,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actncode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTNCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "modecode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MODECODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatest=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthfnd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHFND
            PACK      FILTHFND,FILTHFND,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTCLAM
            PACK      FILTCLAM,FILTCLAM,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtauto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTAUTO
            PACK      FILTAUTO,FILTAUTO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patportn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPORTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "processd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCESSD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasmove=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASMOVE
            PACK      REASMOVE,REASMOVE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASADMN
            PACK      REASADMN,REASADMN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "debtagnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEBTAGNT
            PACK      DEBTAGNT,DEBTAGNT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "journlky=",QRYNAME
          IF        @EQUAL
            PACK      JOURNLKY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "asg00",QRYNAME
          IF        @EQUAL
            CALL      STASG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prt00",QRYNAME
          IF        @EQUAL
            CALL      STPRT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inv00",QRYNAME
          IF        @EQUAL
            CALL      STINV000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "usebasic=",QRYNAME
          IF        @EQUAL
            PACK      USEBASIC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ihcinvon=",QRYNAME
          IF        @EQUAL
            PACK      IHCINVON,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ihcbtchn=",QRYNAME
          IF        @EQUAL
            PACK      IHCBTCHN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prhre",QRYNAME
          IF        @EQUAL
            CALL      SPPRHR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmclt",QRYNAME
          IF        @EQUAL
            CALL      SPMCL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fullpaid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FULLPAID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVOICNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN        
+
.------------------------------------------------------------
.   Set Parameters for transaction number
.------------------------------------------------------------
STTRN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,TRANSNUM[F3]
          MOVE      F3,LASTITEM
STTRN999  RETURN
+
.------------------------------------------------------------
. Set parameters for Reassign Debt
.------------------------------------------------------------
STASG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STASG999 IF EQUAL
          MOVE      QRYDATA,ASGDEB[F3]
STASG999  RETURN
+
.------------------------------------------------------------
. Set parameters for Reprint Invoice
.------------------------------------------------------------
STPRT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPRT999 IF EQUAL
          MOVE      QRYDATA,PRTINV[F3]
STPRT999  RETURN
+
.------------------------------------------------------------
. Set parameters for Invoice number
.------------------------------------------------------------
STINV000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STINV999 IF EQUAL
          MOVE      QRYDATA,INVNUM[F3]
STINV999  RETURN
+
.------------------------------------------------------------
. SCDAT000 - Setup change date for stepdown
.------------------------------------------------------------
SCHDAT00  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8
          ELSE
            MOVE      QRYDATA,KEY8
          ENDIF
SCHDAT99  RETURN
+
.------------------------------------------------------------
.   Set Parameters for Credit amount
.------------------------------------------------------------
STCRD000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,CREDAMNT[F3]
STCRD999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for GST amount
.------------------------------------------------------------
STGST000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,GSTAAMNT[F3]
STGST999  RETURN
+
.------------------------------------------------------------
. Process Fields in Body of HTML Template
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD30,PROFLD40
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFL191
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD14  CALL      ENQI0000
          GOTO      PROFLD99
.
PROFLD15  CALL      PMFD0000
          GOTO      PROFLD99
.
PROFLD16  CALL      PMFS0000
          GOTO      PROFLD99
.
PROFLD17  CALL      CINV0000               * Invoice credit
          GOTO      PROFLD99
.
PROFLD18  CALL      MISC0000               * Miscellaneous tags
          GOTO      PROFLD99
.
PROFLD19  CALL      PMIX0000
          GOTO      PROFLD99
.
PROFL191  CALL      PMFI0000               * fees information
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      DENQ0000
          GOTO      PROFLD99
.
PROFLD32  CALL      ENQI0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      RCPP0000                * Receipts Processing
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. Output INP Patient Enquiry Page
.------------------------------------------------------------
INVENQ00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      ZERO,DSCHFLAG
          MOVE      ZERO,RESPFLAG
          MOVE      SP70,DOCTCODE
          MOVE      ZERO,PTELPHSP
          MOVE      ZERO,PTELPHSU
          MOVE      ZERO,QUOTEEST
          CALL      CLPRIHRE
          CALL      CLPFED00
.
          BRANCH    UPDATETP,INVENQ75,INVENQ55,INVENQ56
.
          BRANCH    UPDATETY,INVENQ20,INVENQ50,INVENQ60,INVENQ70,INVENQ78:
                             INVENQ79,INVENQ80,INVENQ58
.
          MATCH     "040",TEMPLATE          * Estimation Invoice
          GOTO      INVENQ90 IF EQUAL
          MATCH     "40",TEMPLATE           * Estimation Invoice
          GOTO      INVENQ90 IF EQUAL
          MATCH     "017",TEMPLATE          * Invoice search
          GOTO      INVENQ90 IF EQUAL
          MATCH     "018",TEMPLATE          * Credit Note search
          GOTO      INVENQ90 IF EQUAL
          MATCH     "025",TEMPLATE          * Invoice List by Health Fund
          GOTO      INVENQ90 IF EQUAL
          MATCH     "25",TEMPLATE           * Invoice List by Health Fund
          GOTO      INVENQ90 IF EQUAL
.
          CALL      CLPATMAS
          PACK      URNUMBER,URNUMBER,SP70
          MATCH     SP70,URNUMBER
          GOTO      INVENQ10 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,INVENQ96
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
INVENQ10  CALL      CLPATMIS
          CALL      CLPMSVX1
          CALL      CLPATDSC
          CALL      CLPATELG                  * Clear elgibility fields
.
          PACK      KEY8,ADMISSNO,SP70
          MATCH     SP70,KEY8
          IF        @EQUAL
            MOVE      ONE,MISSFLAG
            MOVE      ONE,DSCHFLAG
            COMPARE   ZERO,QUOTENUM
            GOTO      INVENQ90 IF EQUAL
            GOTO      INVENQ12                * Check for Fees Estimate Quote
          ENDIF
          CALL      RDMISS1
          MOVE      OVRCD,MISSFLAG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLRRES00          * Clear person responsible for acc.
            MOVE      OVRCD,RESPFLAG
          ENDIF
.
          COMPARE   ZERO,QUOTENUM
          GOTO      INVENQ14 IF EQUAL        * Blank Fees Estimate Quote no
.
INVENQ12  MOVE      QUOTENUM,KEY12
          CALL      RDPMFED1
          IF        OVRCD=1
            CALL      CLPFED00
          ELSE
.
.           The following fields are used to print Fees Estimate
.
            MOVE      PMFDNONS,ASTAY
            MOVE      PMFDADAT,ADATE
            MOVE      PMFDHFUN,AFUNDH       * Health Fund
            MOVE      PMFDHFTB,AFNDTB       * Health Fund table
            MOVE      PMFDCLTY,ACLAIM       * Claim type
            MOVE      PMFDATYP,ATYPE        * Admission type
            MOVE      PMFDCMCD,PTMIPCMX     * Casemix Code
          ENDIF
.
          CALL      CKCM0000
.
          PACK      KEY17,QUOTENUM,SP4,ONE
          CALL      RDPMFES1
          IF        OVRCD=1
            CALL      CLPFES00
          ENDIF
.
          PACK      KEY15,QUOTENUM,SP2,ONE
          CALL      RDPMFID1
          IF        OVRCD=1
            CALL      CLPMFI00
          ENDIF
.
          PACK      KEY20,QUOTENUM,ADMISSNO,SP70
          CALL      RDPMAIL2
          IF        OVRCD=1
            UNPACK    SP70,PMALADMN,PMALFINO,PMALSPAR
          ENDIF
.
          PACK      KEY12,QUOTENUM,SP70
          CALL      RDPMFEN1
          IF        OVRCD=1
            UNPACK    SP70,PMFNTITL,PMFNSNAM
            UNPACK    SP70,PMFNGNAM,PMFNADD1
            UNPACK    SP70,PMFNADD2,PMFNSUBR,PMFNPOST,PMFNBDAT,PMFNPHON
          ENDIF
.
          PACK      KEY20,QUOTENUM,SP70
          CALL      RSPMAEL2
          CALL      RKPMAEL2
          IF        OVRCD=0
            PACK      KEY12,QUOTENUM,SP70
            MATCH     PMAEQUOT,KEY12
            IF        @EQUAL
              MOVE      PMAEVISN,KEY8
              CALL      RDPTELG1
              IF        OVRCD=1
                CALL      CLPATELG            * Clear elgibility fields
              ENDIF
            ENDIF
          ENDIF
.
INVENQ14  MOVE      SP70,PMVXMHOS
          COMPARE   ZERO,INVOICEN
          IF        @EQUAL
            CALL      CLRINV00        * Clear invoice fields if no invoice no.
          ELSE
            MOVE      INVOICEN,FORM8
            MOVE      FORM8,KEY8
            CALL      RDINV1
            IF        OVRCD=1
              CALL      CLRINV00
            ELSE
              CALL      RDPTPFA1
              IF        OVRCD=1
                UNPACK    SP70,PTPFINVN,PTPFIFDT,PTPFPLAN,PTPFSTAT,PTPFMODR
              ENDIF
              PACK      KEY8,PINVADM
              CALL      RDPMVX11
              CALL      JHHD0000      * Get number of items & Funder
            ENDIF
          ENDIF  
.
          PACK      KEY24,JOURNLKY,SP70
          CALL      RDJRNL1
          IF        OVRCD=1
            CALL      CLPATJRN              * Clear journal file     
          ELSE
            UNPACK    JOURNLKY,KEY18,KEY6
            MOVE      INVOICEN,FORM8
            MOVE      FORM8,KEY8
            PACK      KEY22,ADMISSNO,KEY8,KEY6
            CALL      RDDTRN1
            IF        OVRCD=1
              CALL      CLPATDTR
            ENDIF
          ENDIF
          GOTO      INVENQ90
.
.         Display a selected invoice
.
INVENQ20  MOVE      INVOICEN,FORM8
          MATCH     SP70,CREDITNO
          IF        !@EQUAL
            PACK      KEY8,CREDITNO
            CALL      RDPMCNO1
            IF        OVRCD=0
              MOVE      PMCNVISN,ADMISSNO
              MOVE      PMCNINVN,FORM8
            ENDIF
          ENDIF
.
          MOVE      FORM8,KEY8
.
          COMPARE   FOUR,VISITTYP
          GOTO      INVENQ30 IF NOT EQUAL
.
          PACK      KEY9,TWO,KEY8,SP70
          CALL      RDPMCLT1                * Eclipse other claimant
          IF        OVRCD=1
            CALL      CLPMSCLT
          ENDIF
.
          CALL      RDPRIN1
          IF        OVRCD=0 & PRINSCAN=1
            MOVE      PRINDEBT,URNUMBER
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,INVENQ96
.
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            MOVE      ZEROVISN,ADMISSNO
.
            CALL      GINDC000       * Get patient indicator
.
            MATCH     SP70,UNIQNUMB
            IF        @EQUAL
              PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
              CALL      RDPRHR1
              IF        OVRCD=ONE
                CALL      CLPRIHRE
              ENDIF
            ENDIF
.
          ELSE
            GOTO      INVENQ96
          ENDIF
          GOTO      INVENQ90
.
INVENQ30  COMPARE   ONE,HSYS6
          GOTO      INVENQ40 IF NOT EQUAL    * no debtors file
.
          COMPARE   FIVE,VISITTYP
          GOTO      INVENQ40 IF NOT EQUAL    * not debtors
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSDBDB4
INVENQ32  CALL      RKDBDB4              * next debtor number
          BRANCH    OVRCD,INVENQ95
.
          MATCH     URNUMBER,DBDBPUR
          GOTO      INVENQ95 IF NOT EQUAL  * not same U/R
.
          MOVE      INVOICEN,KEY12
          REP       " 0",KEY12
          PACK      KEY36,DBDBDEB,KEY12,SP70
          CALL      RSDBFD6
          CALL      RKDBFD6
          BRANCH    OVRCD,INVENQ32       * Next debtor code
.
          MATCH     DBDBDEB,DBFDDEB
          GOTO      INVENQ32 IF NOT EQUAL   * Not same debtor
          MATCH     KEY12,DBFDINV
          GOTO      INVENQ32 IF NOT EQUAL   * Not same invoice
          GOTO      INVENQ90
.
INVENQ40  MOVE      SP70,PMVXMHOS
          CALL      RDINV1
          IF        OVRCD=1
            CALL      CLRINV00
          ELSE
            MOVE      PINVADM,ADMISSNO
            MOVE      PINVUR,URNUMBER
            PACK      KEY8,PINVADM
            CALL      RDPMVX11
          ENDIF
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLRRES00          * Clear person responsible for acc.
            MOVE      OVRCD,RESPFLAG
          ENDIF
          CALL      JHHD0000            * Get number of items & Funder
.
          MATCH     SP70,PINVNO
          IF        !@EQUAL & !@EOS
            MOVE      PINVNO,KEY8
            PACK      KEY9,ONE,KEY8,SP70
            CALL      RDPMCLT1                * Eclipse other claimant
            IF        OVRCD=1
              CALL      CLPMSCLT
            ENDIF
          ENDIF
.
          GOTO      INVENQ90
.
.         Update Person responsible for account
.
INVENQ50  CALL      UPDPRA00  * move cgi variables to the fields
          CALL      UPPRA000  * Update person responsbile for account
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         IHC Adjustments
.
INVENQ55  OPEN      PMSECTA2,"pmsectaf"
.
          PACK      KEY16,IHCINVON,IHCBTCHN,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,INVENQ91
.
          MOVE      TEN5,PMECFLAG
.
          CALL      UPPMECT2 
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,INVENQ91
.
          MOVE      ONE,PMVXEAFL
          CALL      UPPMVX11
.
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         IHCW Adjustments
.
INVENQ56  OPEN      WEBIHCA2,"webihcaf"
.
          PACK      KEY16,IHCINVON,IHCBTCHN,SP70
          CALL      RDWBIHC2
          BRANCH    OVRCD,INVENQ91
.
          MOVE      TEN6,WBICFLAG
.
          CALL      IBACLOCK
          PACK      WBICUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBICUDAT
          MOVE      CTIMEIS,WBICUTIM
          MOVE      USERID,WBICUUID
          CALL      UPWBIHC2
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,INVENQ91
.
          MOVE      ONE,PMVXEAFL
          CALL      UPPMVX11
.
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         Updating Account Paid in Full (ECLIPSE)
.
INVENQ58  MATCH     Z70,FULLPAID
          GOTO      INVENQ99 IF EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          IF        OVRCD=0
            MOVE      FULLPAID,PTINAPIN     * Account paid indicator (ECLIPSE)
            CALL      UPINV1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         Credit All the selected invoice
.
INVENQ60  MOVE      ZERO,ISBLFLAG      * Initialise flag for Ind.Services Bill.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,INVENQ99
.
          MATCH     "1",PTINCRST
          GOTO      INVENQ93 IF EQUAL  * invoice is full credited already
.
          MOVE      ZERO,KEYFLAG       * flag for Pat/Rebate invoice
          MOVE      ZERO,SPLITINV      * Initialise the other split invoice no
          COMPARE   FIVE,CFEETYP
          GOTO      INVENQ68 IF EQUAL     * SX
.
.         COMPARE   ZERO,PINVTYP
.         GOTO      INVENQ68 IF EQUAL
.
          CALL      SPLI0000           * Check for split invoice
.
.         Return FORM1 0 -  Not a split invoice
.                      1 -  split invoice (the other invoice not neutral)
.                      2 -  split invoice (both neutral)
.                      3 -  missing the other split invoice
.                      4 -  Independence Services Billing (all invoices neutral)
.                      5 -  Patient Inv with Rebate inv.raised(for PTCNPPIN=1)
.                      6 -  either Patient or Rebate inv.only (for PTCNPPIN=1)
.
          BRANCH    FORM1,INVENQ98
          COMPARE   FOUR,FORM1
          GOTO      INVENQ68 IF NOT EQUAL
.
          MOVE      ONE,ISBLFLAG
          CALL      CRIS0000        * Credit all Independence Services Billing
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
INVENQ68  MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
.
.         PTRBFLAG = 1 Rebate Invoice
.         PTRBFLAG = 2 Patient Invoice
.
          IF        PTRBFLAG=1 | PTRBFLAG=2
            CALL      PTCA0000        * Processing Credit All for Pat/Reb Inv.
          ELSE
            CALL      PRCA0000        * Processing Credit All
          ENDIF
          CALL      DFAC0000        * Delete Future Action from Act.Plan
          MOVE      PINVNO,KEY8
          CALL      DEPTPFA1               * delete patient future plan
.
          BRANCH    PTRBFLAG,INVENQ69 
.
.         Check if we have the other corresponding split invoice number
.
          IF        SPLITINV<>0
            MOVE      SPLITINV,FORM8
            MOVE      FORM8,KEY8
            CALL      RDINV1
            IF        OVRCD=0
              CALL      PRCA0000        * Processing Credit All
              CALL      DFAC0000        * Delete Future Action from Act.Plan
              MOVE      PINVNO,KEY8
              CALL      DEPTPFA1               * delete patient future plan
            ENDIF
          ENDIF
.
INVENQ69  MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         Credit by item
.
INVENQ70  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,INVENQ99
.
          MATCH     "1",PTINCRST
          GOTO      INVENQ93 IF EQUAL  * invoice is full credited already
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
.
          CALL      PRCI0000  * Processing credit for each trans record
          BRANCH    EXIT,INVENQ92
.
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.INVENQ75  PACK      KEY20,ADMISSNO,QUOTENUM,SP70
.          CALL      RAPMAEL1
.          IF        OVRCD=1
.            PACK      PMAEVISN,ADMISSNO,SP70
.            PACK      PMAEQUOT,QUOTENUM,SP70
.            PACK      PMAESPAR,SP70
.
.            CALL      WRPMAEL1
.          ENDIF
.          GOTO      INVENQ99
.
INVENQ75  PACK      KEY20,ADMISSNO,SP70
          CALL      RSPMAEL1
          CALL      RKPMAEL1
          BRANCH    OVRCD,INVENQ77
.
          MATCH    ADMISSNO,PMAEVISN
          IF       @EQUAL
            PACK      PMAEQUOT,QUOTENUM,SP70
            CALL      UPPMAEL1
          ELSE
INVENQ77    PACK      PMAEVISN,ADMISSNO,SP70
            PACK      PMAEQUOT,QUOTENUM,SP70
            PACK      PMAESPAR,SP70
            PACK      KEY20,PMAEVISN,PMAEQUOT,SP70
            CALL      WRPMAEL1
          ENDIF
          GOTO      INVENQ99
.
.         The Fees estimation is calculated in FEESESTM
.
INVENQ78  MATCH     "2",PTCNIFCL
          IF        @EQUAL
            CALL      GFEH0000                 * SJOG layout - Generate IFC
          ELSE
            CALL      GFES0000                 * Generate Fees estimation
          ENDIF
          MOVE      PMFDQUOT,QUOTENUM
.
          MATCH     SP70,PMFDQUOT
          IF        !@EQUAL
            REP       " +",PMFDQUOT
            ENDSET    REDIRECT
            APPEND    "&quotenum=",REDIRECT
            APPEND    PMFDQUOT,REDIRECT
            SQUEEZE   REDIRECT
            REP       "+ ",PMFDQUOT
          ENDIF
          GOTO      INVENQ99
.
INVENQ79  MATCH     "1",PRINTFEE
          IF        @EQUAL
            CALL      PRTFIN00                * print fee information form
            GOTO      INVENQ99
          ENDIF
.
          CALL      GFINF000                 * Generate Fees Information
          MOVE      PMFIFINO,QUOTENUM
.
          MATCH     SP70,PMFIFINO
          IF        !@EQUAL
            REP       " +",PMFIFINO
            ENDSET    REDIRECT
            APPEND    "&quotenum=",REDIRECT
            APPEND    PMFIFINO,REDIRECT
            SQUEEZE   REDIRECT
            REP       "+ ",PMFIFINO
          ENDIF
.
          READ      CONTROLF,HUND12;*112,PTCNAFIP
          MATCH     "1",PTCNAFIP             * auto link to preadmission?
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPMAIL1
            IF        OVRCD=1
              PACK      PMALADMN,ADMISSNO,SP70
              PACK      PMALFINO,QUOTENUM,SP70
              PACK      PMALSPAR,SP70
              CALL      WRPMAIL1                   * link to (pre)admission
            ELSE
              PACK      PMALFINO,QUOTENUM,SP70
              CALL      UPPMAIL1                   * link to (pre)admission
            ENDIF
          ENDIF
          CALL      PRTFIN00                * print fee information form
          MOVE      ZERO,EXIT
          GOTO      INVENQ99
.
.         Fees Estimation with multi bedtypes from hospital level
.
INVENQ80  MATCH     "1",ALLOCATU             * Allocate U/R
          IF        @EQUAL
            CALL      ALLU0000
            GOTO      INVENQ99
          ENDIF
.
          MATCH     "1",REPTOPTN
          GOTO      INVENQ82 IF EQUAL        * By U/R Number
.
          PACK      PTITL,PATTITLE,SP70
          PACK      PGNAME,PATGIVEN,SP70
          PACK      PSNAME,PSURNAME,SP70
          PACK      PADD1,ADDRESS1,SP70
          PACK      PADD2,ADDRESS2,SP70
          PACK      PSUBRB,ADDRESS3,SP70
          PACK      PPOST,POSTCODE,SP70
          PACK      PBDATE,PATBIRTH,SP70
          PACK      PTELEP,PATPHONE,SP70
          GOTO      INVENQ84
.
INVENQ82  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,INVENQ94
.
INVENQ84  
          MATCH     "2",PTCNIFCL
          IF        @EQUAL
            CALL      GFEH0000                 * SJOG layout - Generate IFC
          ELSE
            CALL      GFES0000                 * Generate Fees estimation
          ENDIF
          MOVE      ZERO,EXIT
.
          MOVE      PMFDQUOT,QUOTENUM
.
          MATCH     SP70,PMFDQUOT
          IF        !@EQUAL
            REP       " +",PMFDQUOT
            ENDSET    REDIRECT
            APPEND    "&quotenum=",REDIRECT
            APPEND    PMFDQUOT,REDIRECT
            SQUEEZE   REDIRECT
            REP       "+ ",PMFDQUOT
          ENDIF
          GOTO      INVENQ99
.
INVENQ90  IF        (UPDATETY=5) | (UPDATETY=6)
            GOTO      INVENQ99
          ENDIF
          CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,INVENQ99
.
          CALL      WEBBOD00   * Output Templated Body of HTML
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ91  MOVE      "Invalid IHC Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ92  MOVE      "No Credit processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ93  MOVE      "Invoice is fully Creditted already.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ94  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ95  MOVE      "Invalid Invoice Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ96  MOVE      "Patient Must have U/R to invoice",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ97  MOVE      "Please select a Pre-Admission first",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ98  CLEAR     WEBTITLE
          APPEND    "'Split' Invoice Exists.",WEBTITLE
          APPEND    "\n\n** Neutralise payments and journals ",WEBTITLE
          APPEND    "before continuing **",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVENQ99
.
INVENQ99  RETURN
+
.------------------------------------------------------------------------------
.         Credit all Independence Services Billing
.------------------------------------------------------------------------------
CRIS0000
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIVBA1,"pmsivbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CRIS9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIVBA2,"pmsivbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CRIS9999
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA2,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CRIS9999
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
          BRANCH    OVRCD,CRIS9999
.
          MOVE      PINVNO,KEY8
          CALL      RDPMIVB1
          BRANCH    OVRCD,CRIS9999          * Not Independence Services Invoice
.
.         Loop through Invoice link table to get all invoices for same Unique ID
.
          MOVE      PMIVUNIQ,SAVUNQID
          PACK      KEY26,DPINVADM,SAVUNQID,SP70
          CALL      RSPMIVB2
CRIS1000  CALL      RKPMIVB2
          BRANCH    OVRCD,CRIS8000
.
          MATCH     DPINVADM,PMIVADMN
          GOTO      CRIS8000 IF NOT EQUAL
          MATCH     SAVUNQID,PMIVUNIQ
          GOTO      CRIS8000 IF NOT EQUAL
.
.         Credit all invoices for the same Unique ID
.
          MOVE      PMIVINVN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CRIS1000         * Invalid invoice no
.
          MATCH     "0",PTINCRST
          GOTO      CRIS1000 IF NOT EQUAL  * Credited
.
          CALL      PRCA0000               * Processing Credit All
          CALL      DFAC0000               * Delete Future Action from Act.Plan
          MOVE      PINVNO,KEY8
          CALL      DEPTPFA1               * delete patient future plan
.
          MOVE      "1",PMIVSTAT           * changed status to Credit Noted
          CALL      UPPMIVB2
          GOTO      CRIS1000
.
CRIS8000  CALL      AREG0000              * Add items of the Regime

CRIS9999  RETURN
*
.------------------------------------------------------------------------------
.      Check for a split invoice
.------------------------------------------------------------------------------
SPLI0000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
.
          MOVE      ZERO,KEYFLAG          * flag for Pat/Rebate invoice
          MOVE      ZERO,PTRBFLAG         * Patient/Rebate Invoice raised flag
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            CALL      CIPT0000      * Check if Patient/HF Inv.has been raised
            BRANCH    EXIT,SPLI9000
            BRANCH    KEYFLAG,SPLI9000
          ENDIF
.
.         PINVTYP 0 = Normal Invoice
.                 1 = Insurance Inv of two invs
.                 2 = Pat Invoice of two invs
.
          BRANCH    PINVTYP,SPLI1000,SPLI2000
.
.         check if this is one of Independence Services billing Invoices
.
          CALL      CISB0000           * Ind.Services Billing invoice?
          BRANCH    EXIT,SPLI8000      * Not a split invoice
.
          CALL      BALN0000           * Check if all inv.Balance neutral
          MOVE      ZERO,SPLITINV
          GOTO      SPLI9000
.
.         Insurance invoice, the previous invoice number is likely to be the
.         Patient invoice
.
SPLI1000  CALL      RDPINV1
          BRANCH    OVRCD,SPLI8300
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      SPLI8300 IF NOT EQUAL
.
          COMPARE   TWO,PINVTYP
          GOTO      SPLI8300 IF NOT EQUAL     * Not a patient invoice
.
          MOVE      PINVNO,SPLITINV     * save the other split invoice number
          GOTO      SPLI3000
.
.         Patient invoice, the next invoice number is likely to be the Insurance
.         invoice
.
SPLI2000  CALL      RDKINV1
          BRANCH    OVRCD,SPLI8300
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      SPLI8300 IF NOT EQUAL
.
          COMPARE   ONE,PINVTYP
          GOTO      SPLI8300 IF NOT EQUAL     * Not an insurance invoice
.
          MOVE      PINVNO,SPLITINV     * save the other split invoice number
.
.         Check if the previous or next invoice is neutral
.
SPLI3000  MOVE      SPLITINV,FORM8
          CALL      LINV0000
.
          COMPARE   ZERO,FORM1
          GOTO      SPLI8200 IF EQUAL         * Both neutral
          GOTO      SPLI8100
.
SPLI8000  MOVE      "0",FORM1                * not a split invoice
          MOVE      ZERO,SPLITINV
          GOTO      SPLI9000
.
SPLI8100  MOVE      "1",FORM1                 * split invoice - not neutral
          MOVE      ZERO,SPLITINV
          GOTO      SPLI9000
.
SPLI8200  MOVE      "2",FORM1                 * split invoice - both neutral
          GOTO      SPLI9000
.
SPLI8300  MOVE      "3",FORM1                 * missing the other split invoice
          MOVE      ZERO,SPLITINV
          GOTO      SPLI9000
.
SPLI9000  MOVE      INVOICEN,FORM8            * reposition
          MOVE      FORM8,KEY8
          CALL      RDINV1
.
          IF        KEYFLAG=1
            MOVE      SIX,FORM1             * either Patient or Rebate Inv.ONLY
          ENDIF
.
SPLI9999  RETURN
+
.-------------------------------------------------------------------------------
.     Check if it's a Patient or Rebate Invoice
.-------------------------------------------------------------------------------
CIPT0000  MOVE      ZERO,SPLITINV
          MOVE      ZERO,EXIT
          MOVE      ZERO,KEYFLAG          * flag for Pat/Rebate invoice
          MOVE      ZERO,FORM1
.
          PACK      KEY22,DPINVADM,PINVNO,SP70
          CALL      RSHT1000              * Check if this is a Rebate invoice
CIPT1000  CALL      RKHT1000
          BRANCH    OVRCD,CIPT2000
.
          MATCH     DPINVADM,PTHTADMN     * Same admission ?
          GOTO      CIPT2000 IF NOT EQUAL
.
          MATCH     PINVNO,PTHTTREF       * same invoice ?
          GOTO      CIPT2000 IF NOT EQUAL
          MOVE      ONE,KEYFLAG
.
.         It's a rebate invoice, check if the patient invoice had been credited
.
          MOVE      PTHTPINV,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CIPT1200
.
          MATCH     "1",PTINCRST
          GOTO      CIPT1200 IF EQUAL     * fully credited
.
          MOVE      ONE,PTRBFLAG          * it's a Rebate invoices
.
.         Check if this accommodation rec.is the last invoice with accommodation
.
          MOVE      INVOICEN,FORM8
          CALL      LINR0000
          GOTO      CIPT8000
.
CIPT1200  MOVE      INVOICEN,FORM8        * restore the invoice number
          MOVE      FORM8,KEY8
          CALL      RDINV1
          GOTO      CIPT1000
.
.         Check this is a Patient invoice 
.
CIPT2000  PACK      KEY36,DPINVADM,PINVNO,SP70
          CALL      RSHT2000
CIPT3000  CALL      RKHT2000
          BRANCH    OVRCD,CIPT9999
.
          MATCH     DPINVADM,PTHTADMN     * Same admission
          GOTO      CIPT9999 IF NOT EQUAL
.
          MATCH     PINVNO,PTHTPINV
          GOTO      CIPT9999 IF NOT EQUAL
.
          MOVE      ONE,KEYFLAG
          MOVE      TWO,PTRBFLAG          * Patient Invoice
.
.         It's a patient invoice, check if the rebate invoice had been 
.         raised/credited
.
          MATCH     SP70,PTHTTREF
          GOTO      CIPT6000 IF EQUAL     * Rebate invoice not raised yet
.
          MOVE      PTHTTREF,KEY8         * check if rebate invoice credited
          CALL      RDINV1
          BRANCH    OVRCD,CIPT3200
.
          MATCH     "1",PTINCRST
          GOTO      CIPT3200 IF EQUAL      * fully creditted
.
          MOVE      "5",FORM1              * Rebate invoice has been raised
          GOTO      CIPT8000
.
CIPT3200  MOVE      INVOICEN,FORM8         * restore the invoice number
          MOVE      FORM8,KEY8
          CALL      RDINV1
          GOTO      CIPT3000
.
CIPT6000  MOVE      INVOICEN,FORM8
          CALL      LINR0000
.
CIPT8000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          MOVE      ONE,EXIT
CIPT9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check if this accommodation rec.is the last invoice with accommodation
.-------------------------------------------------------------------------------
LINR0000  MOVE      ZERO,EXIT
          MOVE      SP8,LSTACCM
          MOVE      SP8,STRACCM
          MOVE      ZERO,FORM1
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,LINR8100
.
          MATCH     "1",PTINCRST
          GOTO      LINR8100 IF EQUAL          * Fully credited
.
          COMPARE   THREE,PINVSYS
          GOTO      LINR3000 IF NOT EQUAL      * Not an Inpat., no Accommodation
.
          PACK      KEY22,DPINVADM,PINVNO,SP70
          CALL      RSHT1000
LINR1000  CALL      RKHT1000
          BRANCH    OVRCD,LINR2000
.
          MATCH     DPINVADM,PTHTADMN     * Same admission
          GOTO      LINR2000 IF NOT EQUAL
.
          MATCH     PINVNO,PTHTTREF
          GOTO      LINR2000 IF NOT EQUAL
.
.         Check if there is any accomodation record
.
          COMPARE   THREE,PINVSYS
          GOTO      LINR1000 IF NOT EQUAL
.
          MATCH     "1",PTHTRECT
          GOTO      LINR1000 IF NOT EQUAL
.
          PACK      LSTACCM,PTHTTCEN,PTHTTYER,PTHTTMON,PTHTTDAY 
          REP       " 0",LSTACCM                          * end of accom.date
.
          MATCH     SP8,STRACCM
          GOTO      LINR1000 IF NOT EQUAL
.
          PACK      STRACCM,PTHTFCEN,PTHTFYER,PTHTFMON,PTHTFDAY
          REP       " 0",STRACCM                          * start of accom.date
          GOTO      LINR1000
.
LINR2000  MATCH     SP8,LSTACCM
          GOTO      LINR3000 IF EQUAL
.
.         Check if this accomodation record is the last invoice with accomn.
.
          MATCH     ALACDTE,LSTACCM
          GOTO      LINR8100 IF NOT EQUAL
.
LINR3000  MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          MOVE      "0",KEY1                * flag for inpatient
          MOVE      PINVUR,SAVURNUM
          CALL      CSJR0000                * Check if cash & journal balanced
          BRANCH    EXIT,LINR8000
          GOTO      LINR9999
.
LINR8000  MOVE      "1",FORM1                 * Invoice got payment/journal
          GOTO      LINR9999
.
LINR8100  MOVE      "2",FORM1                 * not the last accom.date
          GOTO      LINR9999
.
LINR9999  RETURN
+
.-------------------------------------------------------------------------
.         check if this is one of Independence Services billing Invoices
.-------------------------------------------------------------------------
CISB0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIVBA1,"pmsivbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CISB9000
.
          TRAP      OVERCOND IF IO
          OPEN      PMSIVBA2,"pmsivbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CISB9000
.
          MOVE      PINVNO,KEY8
          CALL      RDPMIVB1
          BRANCH    OVRCD,CISB9000            * not a split invice
.
CISB8000  MOVE      ZERO,EXIT
          GOTO      CISB9999
.
CISB9000  MOVE      ONE,EXIT
          GOTO      CISB9999
.
CISB9999  RETURN
+
.-------------------------------------------------------------------------
.         Check if all Independence Serv. invoices for same ID are neutral
.-------------------------------------------------------------------------
BALN0000  MOVE      PMIVUNIQ,KEY10       * save unique ID
          PACK      KEY26,PMIVADMN,PMIVUNIQ,SP70
          CALL      RSPMIVB2
BALN1000  CALL      RKPMIVB2
          BRANCH    OVRCD,BALN9000
.
          MATCH     DPINVADM,PMIVADMN     * Same admission
          GOTO      BALN9000 IF NOT EQUAL
          MATCH     KEY10,PMIVUNIQ
          GOTO      BALN9000 IF NOT EQUAL
.
          MOVE      PMIVINVN,KEY8
          CALL      RDINV1
          IF        OVRCD=0
            MATCH     "1",PTINCRST
            GOTO      BALN1000 IF EQUAL     * Fully credited
          ENDIF
          MOVE      PMIVINVN,SPLITINV     * save the other split invoice number
          MOVE      SPLITINV,FORM8
          CALL      LINV0000
.
          COMPARE   ZERO,FORM1
          GOTO      BALN1000 IF EQUAL     * neutral, check next invoice
.
          MOVE      "1",FORM1             * split invoice - not neutral
          GOTO      BALN9999
.
BALN9000  MOVE      "4",FORM1             * split invoice - all neutral
          GOTO      BALN9999
.
BALN9999  RETURN
+
.------------------------------------------------------------
. Allocate a U/R number to a fee estimation
.------------------------------------------------------------
ALLU0000  PACK      KEY12,QUOTENUM,SP70
          CALL      RDPMFED1
          IF        OVRCD=0
            MOVE      URNUMBER,PMFDURNO
            CALL      UPPMFED1
          ENDIF
.
          PACK      KEY17,QUOTENUM,SP70
          CALL      RSPMFES1
ALLU1000  CALL      RKPMFES1
          BRANCH    OVRCD,ALLU9999
.
          MOVE      QUOTENUM,KEY12
          MATCH     KEY12,PMFSQUOT
          GOTO      ALLU9999 IF NOT EQUAL
.
          MOVE      URNUMBER,PMFSURNO
.
          CALL      UPPMFES1
          GOTO      ALLU1000
.
ALLU9999  RETURN
.------------------------------------------------------------
. Get number of items charged and the Funder - Only for Johns Hopkins
.------------------------------------------------------------
JHHD0000  MOVE      ZERO,TOTCHRG
          COMPARE   FIVE,CFEETYP
          GOTO      JHHD1000 IF EQUAL        * NZ Private billing
          COMPARE   NINE,CFEETYP
          GOTO      JHHD9999 IF NOT EQUAL
.
JHHD1000  MOVE      INVOICEN,FORM8
          COMPARE   ZERO,FORM8
          GOTO      JHHD9999 IF EQUAL
          MOVE      FORM8,KEY8
          MOVE      ZERO,CRDNFLAG
          MOVE      ZERO,CSTYPEF
          PACK      KEY23,ADMISSNO,KEY8,SP70
          PACK      KEY22,ADMISSNO,KEY8,SP70
          CALL      RDSDTRAN
JHHD3000  CALL      RDKDTRAN
          BRANCH    OVRCD,JHHD8000
.
          MATCH     TREF,KEY8
          GOTO      JHHD8000 IF NOT EQUAL
.
          BRANCH    TRECTYPE,JHHD3000,JHHD4000,JHHD4000
          GOTO      JHHD3000
.
JHHD4000  ADD       ONE,TOTCHRG              * increase number of items
          GOTO      JHHD3000
.
.         Get details of Expected payer
.
JHHD8000  MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          IF        OVRCD=1
            UNPACK    SP70,PKNAME,PKADD1
            UNPACK    SP70,PKADD2,PKSUBR
            UNPACK    SP70,PKADD4,PKPOST
          ENDIF
.
          IF        CFEETYP=5
            MATCH     SP70,PTINHFND
            IF        @EQUAL
              MOVE      "PRFA",EXPPAYER
            ELSE
              MOVE      PTINHFND,EXPPAYER
            ENDIF
          ELSE
            MATCH     SP70,EXPPAYER
            IF        @EQUAL
              CALL      GPAY0000            * Get default payer
              MOVE      VSPAPAYC,EXPPAYER
            ENDIF
          ENDIF
.
          MATCH     "PRFA",EXPPAYER
          GOTO      JHHD9999 IF EQUAL
.
          PACK      KEY14,EXPPAYER,ZERO8,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            PACK      PKNAME,HFNAME,SP70
            PACK      PKADD1,HFADD1,SP70
            PACK      PKADD2,HFADD2,SP70
            PACK      PKSUBR,HFADD3,SP70
            PACK      PKADD4,HFADD4,SP70
            PACK      PKPOST,HFPCODE,SP70
          ENDIF
.
JHHD9999  RETURN
+
.------------------------------------------------------------
. Debtor Invoice Enquiry Page
.------------------------------------------------------------
INVDEB00  COMPARE   "0",UPDATETY
          GOTO      INVDEB88 IF EQUAL
.
INVDEB80  COMPARE   FIVE,VISITTYP
          GOTO      INVDEB82 IF EQUAL
          COMPARE   FOUR,VISITTYP
          GOTO      INVDEB88 IF NOT EQUAL
.
.         Private Practice Debtors Invoice
.
          MOVE      URNUMBER,KEY8
..          CALL      RDPRDB1
          CALL      RDMAST1
          BRANCH    OVRCD,INVDEB96
          CALL      RDPMPX21
          BRANCH    OVRCD,INVDEB96
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          IF        OVRCD=1
            CALL      CLRPRI00
          ENDIF
          GOTO      INVDEB88
.
.         Account Receivable Debtors Invoice
.
INVDEB82  COMPARE   ONE,HSYS6
          GOTO      INVDEB88 IF NOT EQUAL    * no debtors file
.
          MOVE      URNUMBER,KEY8
          CALL      RDDBDB1
          BRANCH    OVRCD,INVDEB96
.
          MOVE      INVOICEN,KEY12
          REP       " 0",KEY12
          PACK      KEY36,DBDBDEB,KEY12,SP70
          CALL      RSDBFD6
          CALL      RKDBFD6
          BRANCH    OVRCD,INVENQ32       * Next debtor code
.
          MATCH     DBDBDEB,DBFDDEB
          GOTO      INVDEB83 IF NOT EQUAL   * Not same debtor
          MATCH     KEY12,DBFDINV
          GOTO      INVDEB83 IF NOT EQUAL   * Not same invoice
          GOTO      INVDEB88
.
INVDEB83  CALL      CLRDBF00
          GOTO      INVDEB88
.      
INVDEB88  CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,INVDEB99
.
          CALL      WEBBOD00   * Output Templated Body of HTML
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
          GOTO      INVDEB99
.
INVDEB95  MOVE      "Invalid Invoice Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INVDEB99
.
INVDEB96  MOVE      "Patient Must have UR/Debtors Number to invoice",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
INVDEB99  RETURN
+
.------------------------------------------------------------
.         Receipts Processing List
.------------------------------------------------------------
LRCP0000  BRANCH    UPDATETY,LRCP1000,LRCP2000,LRCP3000,LRCP4000
          MOVE      SP70,PTRARMOV       * Reason of Movement
          MOVE      SP70,PTRADBAG       * Debt Collection Agency (code)
          GOTO      LRCP9000
.
LRCP1000  COMPARE   ZERO,INVOICEN
          GOTO      LRCP9800 IF EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,LRCP9200
          CALL      GDET0000              * Get patient's Claim and Health Fund
.
          MOVE      PINVNO,KEY8
          CALL      RDPTURE1
          IF        OVRCD=1
            MOVE      ZERO,FORM12P2
            CALL      SETU0000              * Setup Unreconciled inv.fields
            CALL      WRPTURE1
          ENDIF
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LRCP9200
          CALL      RDPMPX21
          BRANCH    OVRCD,LRCP9200
.
.         Check if there is any previous reassign debt record
.
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          BRANCH    OVRCD,LRCP1200
.
          MATCH     PINVNO,PTRAINVN      * Same invoice ?
          GOTO      LRCP1200 IF NOT EQUAL
.
          MATCH     "1",PTRADELE       * Not deleted?
          GOTO      LRCP9000 IF NOT EQUAL
.
LRCP1200  MOVE      SP70,PTRARMOV
          MOVE      ZERO,PTRAPPOR
          GOTO      LRCP9000
.
. ******************************************************************************
.         Reassign Debt   (also reasign to Debt Collection Agency)
.
LRCP2000  COMPARE   ZERO,INVOICEN
          GOTO      LRCP9800 IF EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,LRCP9200
          CALL      GDET0000              * Get patient's Claim and Health Fund
.
          MOVE      PINVNO,KEY8
          CALL      RDPTURE1
          IF        OVRCD=1
            MOVE      ZERO,FORM12P2
            CALL      SETU0000              * Setup Unreconciled inv.fields
            CALL      WRPTURE1
          ENDIF
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LRCP9200
          CALL      RDPMPX21
          BRANCH    OVRCD,LRCP9200
.
          MOVE      "1",PTURSTAT          * Default status to Process
          IF        PROCESSD=0
            MOVE      "0",PTURSTAT        * New or Not processed
          ENDIF
.
          MOVE      PINVAMT,PTURINVT      * Invoice total
          ADD       PTINCRTT,PTURINVT     * credit note
          MOVE      PINVPATA,PTURPAYM
          ADD       PINVHFDA,PTURPAYM
          ADD       PINVOTHA,PTURPAYM     * payment
          MOVE      PINVJOUR,PTURJRNL
          ADD       PTINGSTJ,PTURJRNL     * journals
.
          MOVE      PINVAMT,PTUROSTD     * Invoice amount +
          ADD       PINVPATA,PTUROSTD    * Patient payments +
          ADD       PINVHFDA,PTUROSTD    * H.F payments +
          ADD       PINVOTHA,PTUROSTD    * Other payments +
          ADD       PTINCRTT,PTUROSTD    * Credit Notes +
          ADD       PINVJOUR,PTUROSTD    * Journals = amount outstanding
          ADD       PTINGSTJ,PTUROSTD    * Journal GST = amount outstanding
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      WBSEUID,PTURCUID        * WEB user id
          CALL      UPPTURE1
.
.         Write record to Reassign Debt table
.
          MOVE      ONE,FORM2
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          IF        OVRCD=0
            MATCH     PINVNO,PTRAINVN      * Same invoice ?
            IF        @EQUAL
              MOVE      PTRACNTN,FORM2
            ENDIF
          ENDIF
.
LRCP2400  MOVE      FORM2,PTRACNTN
          PACK      KEY10,PINVNO,PTRACNTN,SP70
          CALL      RDPTRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      LRCP2400
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "patrasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PTRACNTN
          MOVE      PINVNO,PTRAINVN
          MOVE      FORM2,PTRACNTN
          MOVE      "3",PTRASYST            * Inpatient
          MOVE      PTUROSTD,PTRAOUST       * Outstanding amount
          MOVE      REASMOVE,PTRARMOV       * Reason of Movement
          MOVE      DEBTAGNT,PTRADBAG       * Debt Collection Agency (code)
          MOVE      PATPORTN,PTRAPPOR       * Patient portion
          MOVE      PINVBLCD,PTRAIBAL       * Date invoice balanced
          MOVE      "0",PTRADELE            * set Deleted flag off
.
          CALL      IBACLOCK
          MOVE      CURRDATE,PTRACDAT
          MOVE      CTIMEIS,PTRACTIM
          MOVE      WBSEUID,PTRACUID        * WEB user id
.
          MOVE      CURRDATE,PTRAUDAT
          MOVE      CTIMEIS,PTRAUTIM
          MOVE      WBSEUID,PTRAUUID        * WEB user id
          CALL      WRPTRAS1
.    
.                        *****************  * write to Patient Debt Reg. file
LRCP2500  MOVE      PINVSYS,PTDESYST        * System
          PACK      KEY10,THREE,PINVNO,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            GOTO      LRCP2800 IF EQUAL     * no - this debt has been cleared
.
            CALL      CLPATDET
            MOVE      "3",PTDETYPE
            MOVE      PINVNO,PTDEINVN
            MOVE      DEBTAGNT,PTDEAGNT     * Debt Collection Agency (code)
            MOVE      CURRDATE,PTDECDAT
            MOVE      CTIMEIS,PTDECTIM
            MOVE      WBSEUID,PTDECUID      * WEB user id
            MOVE      PINVUR,PTDEURNO
            MOVE      PINVSYS,PTDESYST      * System
            CALL      WRPTDET1
            MOVE      ONE,KEY1
          ELSE
            MOVE      ZERO,KEY1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            IF        @EQUAL
              MOVE      CURRDATE,PTDEDTCL
            ELSE
              MOVE      SP8,PTDEDTCL
              MOVE      DEBTAGNT,PTDEAGNT   * Debt Collection Agency (code)
              MOVE      ONE,KEY1
            ENDIF
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          MATCH     "1",PMPXSN14
          IF        !@EQUAL
            MOVE      KEY1,PMPXSN14         * set Debt Collection flag
            CALL      UPPMPX21              * update PMI Extention record
          ENDIF
.
LRCP2800  PROC      FLAGDEBT              * flag Outstanding Debt
.
          MATCH     "1",PRINTINV
          GOTO      LRCP9800 IF NOT EQUAL   * Not reprinting invoice
.
          COMPARE   ZERO,PTUROSTD
          GOTO      LRCP9800 IF EQUAL       * No outstanding amount
.
          MOVE      ZERO,UPDATETY
          MOVE      PINVNO,INVOICEN
          CALL      REPINV00                * reprint invoice
.
          GOTO      LRCP9800
.
. ******************************************************************************
.        Reset - Update the last record of the Reassign debt table to be Deleted
.
LRCP3000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          MOVE      ONE,FORM2
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          IF        OVRCD=0
            MATCH     PINVNO,PTRAINVN      * Same invoice ?
            IF        @EQUAL
              MOVE      PTRACNTN,FORM2
            ENDIF
          ENDIF
          MOVE      FORM2,PTRACNTN         * Count
          PACK      KEY10,PINVNO,PTRACNTN,SP70
          CALL      RDPTRAS1
          BRANCH    OVRCD,LRCP9800
          MOVE      "1",PTRADELE            * Deleted
          CALL      UPPTRAS1
.
          MOVE      PINVNO,KEY8
          CALL      RDPTURE1
          IF        OVRCD=0
            MOVE      "2",PTURSTAT          * Deleted - reset
            CALL      UPPTURE1
          ENDIF
          PROC      FLAGDEBT              * flag Outstanding Debt
.
          MATCH     SP3,DEBTAGNT            * assigned to Debt Collect.Agency ?
          GOTO      LRCP9800 IF EQUAL
.    
.                        *****************  * write to Patient Debt Reg. file
          MOVE      PINVSYS,PTDESYST        * System
          PACK      KEY10,THREE,PINVNO,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            MOVE      CURRDATE,PTDEDTCL
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          GOTO      LRCP9800
.
. ******************************************************************************
LRCP4000  MOVE      ONE,COUNTER
          WHILE     COUNTER < 500
            PACK      ASGDEB[COUNTER],ASGDEB[COUNTER],SP70
            PACK      PRTINV[COUNTER],PRTINV[COUNTER],SP70
            PACK      INVNUM[COUNTER],INVNUM[COUNTER],SP70
.
            MOVE      ZERO,FORM8
            MOVE      INVNUM[COUNTER],FORM8
            IF        FORM8<>0
              MOVE      FORM8,KEY8
              CALL      RDINV1
              IF        OVRCD=0
                MOVE      SP70,KEY1
                MOVE      ASGDEB[COUNTER],KEY1
                MATCH     "1",KEY1
                IF        @EQUAL
                  CALL      RASG0000              * Reassign debt
                ENDIF
.
                MOVE      SP70,KEY1
                MOVE      PRTINV[COUNTER],KEY1
                MATCH     "1",KEY1
                IF        @EQUAL
                  IF        PTUROSTD <>0
                    MOVE      "009",KEY3         * Pooling Type
                    CALL      PNTX0000            * reprint invoice
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            ADD       ONE,COUNTER
          DO
.
          GOTO      LRCP9800
.
. ******************************************************************************
.
LRCP9000  MOVE      "Receipts Processing List",WEBTITLE
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LRCP9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      LRCP9999
.
LRCP9200  MOVE      "Record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LRCP9999
.
LRCP9800  MOVE      ZERO,EXIT
          GOTO      LRCP9999
.
LRCP9999  RETURN
+
.*****************************************************************************
. Write the Invoice number to the COMWEB70 polling table to reprint
. invoice or reassign debt
.*****************************************************************************
PNTX0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,PNTX1000
.
          MOVE      IBPLUNIQ,FORM10
PNTX1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      KEY3,IBPLTYPE     * Pooling Type
          MOVE      PINVUR,IBPLURNO
          MOVE      PINVADM,IBPLVISN
          PACK      IBPLSKEY,PINVNO,SELPRINT,WBSEUID,SP70
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,PNTX1000
          ELSE
            GOTO      PNTX1000
          ENDIF
.
PNTX9999  RETURN
.
. ******************************************************************************
.         Bulk re-assign debt
. ******************************************************************************
RASG0000  MOVE      FORM8,INVOICEN        * Invoice number
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,RASG9999
.
          MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RASG9999
          CALL      RDPMPX21
          BRANCH    OVRCD,RASG9999
          CALL      GDET0000              * Get patient's Claim and Health Fund
.
          CALL      UPURE000              * Update Unreconciled invoice file
          CALL      WRRDB000              * Write to Reassign debt file
          CALL      WRPDR000              * Write to Patient Debt Reg.file
.
          PROC      FLAGDEBT              * flag Outstanding Debt
.
RASG9999  RETURN
+
.------------------------------------------------------------
.         Update Unreconciled invoice file
.------------------------------------------------------------
UPURE000  MOVE      PINVNO,KEY8
          CALL      RDPTURE1
          IF        OVRCD=1
            MOVE      ZERO,FORM12P2
            CALL      SETU0000            * Setup Unreconciled inv.fields
            CALL      WRPTURE1
          ENDIF
          MOVE      "1",PTURSTAT          * Processed
          MOVE      PINVAMT,PTURINVT      * Invoice total
          ADD       PTINCRTT,PTURINVT     * credit note
          MOVE      PINVPATA,PTURPAYM
          ADD       PINVHFDA,PTURPAYM
          ADD       PINVOTHA,PTURPAYM     * payment
          MOVE      PINVJOUR,PTURJRNL
          ADD       PTINGSTJ,PTURJRNL     * journals
.
          MOVE      PINVAMT,PTUROSTD     * Invoice amount +
          ADD       PINVPATA,PTUROSTD    * Patient payments +
          ADD       PINVHFDA,PTUROSTD    * H.F payments +
          ADD       PINVOTHA,PTUROSTD    * Other payments +
          ADD       PTINCRTT,PTUROSTD    * Credit Notes +
          ADD       PINVJOUR,PTUROSTD    * Journals = amount outstanding
          ADD       PTINGSTJ,PTUROSTD    * Journal GST = amount outstanding
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      WBSEUID,PTURCUID        * WEB user id
          CALL      UPPTURE1
UPURE999  RETURN
.
.------------------------------------------------------------
.         Write record to Reassign Debt table
.------------------------------------------------------------
WRRDB000  PACK      REASMOVE,REASMOVE,SP70
          PACK      DEBTAGNT,DEBTAGNT,SP70
.
          MOVE      ONE,FORM2
.
.     Bulk New movement should not have record in patrasaf, double check anyway
.
          MATCH     "2",FILTAUTO
          GOTO      WRRDB200 IF EQUAL      * Bulk New movement
.
.         Reprocess Previous
.
          PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
WRRDB100  CALL      RPPTRAS1
          BRANCH    OVRCD,WRRDB400
.
          MATCH     PINVNO,PTRAINVN      * Same invoice ?
          GOTO      WRRDB400 IF NOT EQUAL
          MATCH     "1",PTRADELE       * Deleted ?
          GOTO      WRRDB100 IF EQUAL
.
          MOVE      PTRARMOV,REASMOVE       * save previous Reason of Movement
          MOVE      PTRADBAG,DEBTAGNT       * save previous Debt Collec.Agency
.
.         Get the last counter
.
WRRDB200  PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          IF        OVRCD=0
            MATCH     PINVNO,PTRAINVN      * Same invoice ?
            IF        @EQUAL
              MOVE      PTRACNTN,FORM2
            ENDIF
          ENDIF
.
WRRDB400  MOVE      FORM2,PTRACNTN
          PACK      KEY10,PINVNO,PTRACNTN,SP70
          CALL      RDPTRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      WRRDB400
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "patrasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PTRACNTN
          MOVE      PINVNO,PTRAINVN
          MOVE      FORM2,PTRACNTN
          MOVE      "3",PTRASYST            * Inpatient
          MOVE      PTUROSTD,PTRAOUST       * Outstanding amount
          MOVE      REASMOVE,PTRARMOV       * Reason of Movement
          MOVE      DEBTAGNT,PTRADBAG       * Debt Collection Agency (code)
          MOVE      PTUROSTD,PTRAPPOR       * Patient portion=Outstanding amt
          MOVE      PINVBLCD,PTRAIBAL       * Date invoice balanced
          MOVE      "0",PTRADELE            * set Deleted flag off
.
          CALL      IBACLOCK
          MOVE      CURRDATE,PTRACDAT
          MOVE      CTIMEIS,PTRACTIM
          MOVE      WBSEUID,PTRACUID        * WEB user id
.
          PACK      CURRDATE,PTRAUDAT
          MOVE      CTIMEIS,PTRAUTIM
          MOVE      WBSEUID,PTRAUUID        * WEB user id
          CALL      WRPTRAS1
WRRDB999  RETURN
+
.------------------------------------------------------------
.         write to Patient Debt Reg. file
.------------------------------------------------------------
WRPDR000  MOVE      PINVSYS,PTDESYST        * System
          PACK      KEY10,THREE,PINVNO,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            GOTO      WRPDR999 IF EQUAL     * no - this debt has been cleared
.
            CALL      CLPATDET
            MOVE      "3",PTDETYPE
            MOVE      PINVNO,PTDEINVN
            MOVE      DEBTAGNT,PTDEAGNT     * Debt Collection Agency (code)
            MOVE      CURRDATE,PTDECDAT
            MOVE      CTIMEIS,PTDECTIM
            MOVE      WBSEUID,PTDECUID      * WEB user id
            MOVE      PINVUR,PTDEURNO
            MOVE      PINVSYS,PTDESYST      * System
            CALL      WRPTDET1
            MOVE      ONE,KEY1
          ELSE
            MOVE      ZERO,KEY1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            IF        @EQUAL
              MOVE      CURRDATE,PTDEDTCL
            ELSE
              MOVE      SP8,PTDEDTCL
              MOVE      DEBTAGNT,PTDEAGNT   * Debt Collection Agency (code)
              MOVE      ONE,KEY1
            ENDIF
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          MATCH     "1",PMPXSN14
          IF        !@EQUAL
            MOVE      KEY1,PMPXSN14       * set Debt Collection flag
            CALL      UPPMPX21            * update PMI Extention record
          ENDIF
.
WRPDR999  RETURN
.
.------------------------------------------------------------
.   Clear Private Practice invoice - priinvof
.------------------------------------------------------------
CLRPRI00  MOVE      SP70,PRINNUMB
          MOVE      SP70,PRINDATE
          MOVE      SP70,PRINNAME
          MOVE      SP70,PRINDEBT
          MOVE      SP70,DPRINSCN
          MOVE      ZERO,PRINSCAN
          MOVE      SP70,DPRINUNQ
          MOVE      SP70,PRINUNIQ
          MOVE      SP70,PRINPRAC
          MOVE      SP70,PRINDOCT
          MOVE      SP70,PRINCLAM
          MOVE      ZERO,PRINITOT
          MOVE      ZERO,PRINPAMT
          MOVE      ZERO,PRINHAMT
          MOVE      ZERO,PRINIAMT
          MOVE      ZERO,PRINMAMT
          MOVE      ZERO,PRINVAMT
          MOVE      ZERO,PRINOTHA
          MOVE      ZERO,PRINJAMT
          MOVE      ZERO,PRINPEND
          MOVE      ZERO,PRINTRAN
          MOVE      SP70,PRINNAMR
          MOVE      SP70,PRINPRA1
          MOVE      SP70,PRINPRA2
          MOVE      SP70,PRINPRA3
          MOVE      SP70,PRINPRA4
          MOVE      SP70,PRINPOST
          MOVE      SP70,PRINTELP
          MOVE      SP70,PRINTELB
          MOVE      SP70,PRINMPHN
          MOVE      SP70,PRINRELP
          MOVE      ZERO,PRINCNUM
          MOVE      SP70,PRINADTE
          MOVE      ZERO,PRINGSTA
          MOVE      ZERO,PRINGSTJ
          MOVE      SP70,USEBASIC
          MOVE      SP70,IHCINVON
          MOVE      SP70,IHCBTCHN
          MOVE      SP70,CLMINDIC
.
CLRPRI99  RETURN
+
.------------------------------------------------------------
.   Clear Account Receivable invoice - debfdtaf
.------------------------------------------------------------
CLRDBF00  MOVE      SP70,DBFDDEB
          MOVE      SP70,DBFDDTY
          MOVE      SP70,DBFDDOC
          MOVE      SP70,DBFDDLN
          MOVE      SP70,DBFDINV
          MOVE      SP70,DBFDILN
          MOVE      SP70,DBFDIDAT
          MOVE      SP70,DBFDPDAT
          MOVE      SP70,DBFDGLS
          MOVE      SP70,DBFDLED
          MOVE      SP70,DBFDIAC
          MOVE      SP70,DBFDCAC
          MOVE      SP70,DBFDTAC
          MOVE      SP70,DBFDTCA
          MOVE      SP70,DBFDBCHG
          MOVE      SP70,DBFDBDAT
          MOVE      SP70,DBFDBTIM
          MOVE      SP70,DBFDBUSR
          MOVE      SP70,DBFDITM 
          MOVE      SP70,DBFDSDAT
          MOVE      SP70,DBFDDREF
          MOVE      SP70,DBFDOREF
          MOVE      ZERO,DBFDQTY 
          MOVE      ZERO,DBFDPRI 
          MOVE      ZERO,DBFDTOT
          MOVE      ZERO,DBFDTRT
          MOVE      ZERO,DBFDTAX 
          MOVE      ZERO,DBFDPAID
          MOVE      SP70,DBFDUR1 
          MOVE      SP70,DBFDUR2 
          MOVE      SP70,DBFDUD1 
          MOVE      SP70,DBFDUD2 
          MOVE      SP70,DBFDUY1 
          MOVE      SP70,DBFDUY2 
          MOVE      SP70,DBFDUC1 
          MOVE      SP70,DBFDUC2 
          MOVE      SP70,DBFDUC3 
          MOVE      SP70,DBFDUC4 
          MOVE      SP70,DBFDGST 
.
CLRDBF99  RETURN
+
.------------------------------------------------------------
.   Clear invoice
.------------------------------------------------------------
CLRINV00  MOVE      SP70,PINVNO   
          MOVE      SP70,PINVDTE 
          MOVE      SP70,PINALPHA
          MOVE      SP70,DPINVADM
          MOVE      SP70,PINVUR  
          MOVE      SP70,DPINVSYS
          MOVE      SP70,PINVSITE
          MOVE      SP70,PINVCLM 
          MOVE      SP70,PINVLOCK
          MOVE      ZERO,PINVAMT 
          MOVE      ZERO,PINVPATA 
          MOVE      ZERO,PINVHFDA 
          MOVE      ZERO,PINVOTHA 
          MOVE      ZERO,PINVJOUR 
          MOVE      ZERO,PINVREB 
          MOVE      SP70,PINVCANC
          MOVE      ZERO,PINVPCSH
          MOVE      ZERO,PINVTYP 
          MOVE      SP70,PINVBLCD
          MOVE      SP70,PINVCADM
          MOVE      SP70,DPTINCMX
          MOVE      SP70,DPTINEDS
          MOVE      ZERO,PTINGSTA
          MOVE      ZERO,PTINGSTJ
          MOVE      SP70,PTINCMCD
          MOVE      SP70,PTINPMD1
          MOVE      SP70,PTINPMD2
          MOVE      ZERO,PTINPMAM
          MOVE      SP70,PINVSPAR
          MOVE      ZEROVISN,PINVADM  
          MOVE      ZERO,PINVSYS 
          MOVE      ZERO,PINVAMT  
          MOVE      ZERO,PINVPATA  
          MOVE      ZERO,PINVHFDA   
          MOVE      ZERO,PINVOTHA
          MOVE      ZERO,PINVJOUR 
          MOVE      ZERO,PINVREB   
          MOVE      ZERO,PINVPCSH   
          MOVE      ZERO,PTINCMIX
          MOVE      ZERO,PTINEDSF 
CLRINV99  RETURN
+
.------------------------------------------------------------
.   Re-Print Patient Invoice Verification
.------------------------------------------------------------
ENQI0000  BRANCH    FLDITMNO,ENQI0100,ENQI0200,ENQI0300,ENQI0400,ENQI0500:
                             ENQI0600,ENQI0700,ENQI0800,ENQI0900,ENQI1000:
                             ENQI1100,ENQI1200,ENQI1300,ENQI1400,ENQI1500:
                             ENQI1600,ENQI1700,ENQI1800,ENQI1900,ENQI2000:
                             ENQI2100,ENQI2200,ENQI2300,ENQI2400,ENQI2500:
                             ENQI2600,ENQI2700,ENQI2800,ENQI2900,ENQI3000:
                             ENQI3100,ENQI3200,ENQI3300,ENQI3400,ENQI3500:
                             ENQI3600,ENQI3700,ENQI3800,ENQI3900,ENQI4000:
                             ENQI4100,ENQI4200,ENQI4300,ENQI4400,ENQI4500:
                             ENQI4600,ENQI4700,ENQI4800,ENQI4900,ENQI5000:
                             ENQI5100,ENQI5200,ENQI5300,ENQI5400,ENQI5500:
                             ENQI5600,ENQI5700,ENQI5800,ENQI5900,ENQI6000:
                             ENQI6100,ENQI6200,ENQI6300,ENQI6400,ENQI6500:
                             ENQI6600,ENQI6700,ENQI6800,ENQI6900,ENQI7000:
                             ENQI7100,ENQI7200,ENQI7300,ENQI7400,ENQI7500:
                             ENQI7600,ENQI7700,ENQI7800,ENQI7900,ENQI8000:
                             ENQI8100,ENQI8200,ENQI8300,ENQI8400,ENQI8500:
                             ENQI8600,ENQI8700,ENQI8800,ENQI8900,ENQI9000:
                             ENQI9100,ENQI9200,ENQI9300,ENQI9400,ENQI9500:
                             ENQI9600,ENQI9700,ENQI9800,ENQI9900
          GOTO      ENQI9999
.
ENQI0100  MOVE      ONE,TOTLFLAG
          CALL      HDPIV000                  * Invoice heading
          CALL      PATINV00                  * Patient Invoice List
          GOTO      ENQI9999
.
ENQI0200  IF        VISITTYP=4
            WRITE     HTMLFILE;PRINNUMB;
          ELSE
            IF        VISITTYP=5
              WRITE     HTMLFILE;DBFDINV;
            ELSE
              WRITE     HTMLFILE;PINVNO;
            ENDIF
          ENDIF
          GOTO      ENQI9999
.
ENQI0300  IF        VISITTYP=4
            UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          ELSE
            IF        VISITTYP=5
              UNPACK    DBFDIDAT,CCENT,CYEAR,CMON,CDAY
            ELSE
              UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
            ENDIF
          ENDIF
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      ENQI9999
.
ENQI0400  MOVE      ZERO,PRINTFLG
          MOVE      ZERO,ISBLFLAG
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          COMPARE   FOUR,VISITTYP
          GOTO      ENQI0420 IF NOT EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          IF        OVRCD=0
            CALL      GINDC000       * Get patient indicator
          ENDIF
          CALL      PPRINV00          * Display private practice invoice
          GOTO      ENQI9999
.
ENQI0420  COMPARE   FIVE,VISITTYP
          GOTO      ENQI0440 IF NOT EQUAL
          CALL      DEBINV00          * Display Debtor invoice
          GOTO      ENQI9999
.
ENQI0440  COMPARE   ZERO,F1
          GOTO      ENQI9999 IF EQUAL * skip the heading
          COMPARE   ZERO,INVOICEN
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=7 align=center><b>":
                               "No Invoice Selected</b></td></tr>"
            GOTO      ENQI9999
          ENDIF
          MOVE      ZERO,INVTYPE
          CALL      CKIB0000          * Check for Independance services billing
          CALL      CALCTAI           * Display inpat/aae/out patient invoice
          GOTO      ENQI9999
.
ENQI0500  CALL      CDATE000
          GOTO      ENQI9999
.
ENQI0600  MOVE      "J ",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ENQI9999
.
ENQI0700  MOVE      "CR",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ENQI9999
.
ENQI0800  MOVE      "MC",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ENQI9999
.
ENQI0900  MOVE      ONE,TOTLFLAG
          MOVE      ZERO,PPRCFLAG
          MOVE      ZERO,NZEROFLG      * Display all outstanding balance
          MOVE      ZERO,NOCOMPCL
.
          MOVE      ZERO,TBSRTFLG       * Flag set for tablesorting (0=normal)
.
          CALL      HDINV000                * Invoice heading
          MOVE      ONE,SHOWFLAG            * Show no more invoice message
          MOVE      IBCNMHOS,HOSPFLAG
.
          CALL      PINVCI00           * Patient Invoice list
          GOTO      ENQI9999
.
ENQI1000  
.         MOVE      ZERO,VISITTYP
.         LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
          WRITE     HTMLFILE;VISITTYP;
          GOTO      ENQI9999
.
ENQI1100  CALL      LGST0000           * GST code list
          GOTO      ENQI9999
.
ENQI1200  CALL      REBINV00           * Invoice Rebate list
          GOTO      ENQI9999
.
ENQI1300  CALL      VIEWRB00           * View Invoice Rebate
          GOTO      ENQI9999
.
ENQI1400  CALL      VRATES00           * View Rates
          GOTO      ENQI9999
.
ENQI1500  CALL      PREVGR00                 * Show previous group of records
          GOTO      ENQI9999
.
ENQI1600  CALL      NEXTGR00                 * Show next group of records
          GOTO      ENQI9999
.
ENQI1700  CALL      FEEQUT00           * Fees Estimates Quotation 
          GOTO      ENQI9999
.
ENQI1800  WRITE     HTMLFILE;CREDITNO;
          GOTO      ENQI9999
.
ENQI1900  PACK      KEY8,CREDITNO
          CALL      RDPMCNO1
          UNPACK    PMCNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          IF        OVRCD=0
            WRITE     HTMLFILE;KEY12;
          ENDIF
          GOTO      ENQI9999
.
ENQI2000  PACK      KEY8,CREDITNO
          CALL      RDPMCNO1
          IF        OVRCD=0
            WRITE     HTMLFILE;PMCNINVN;
          ENDIF
          GOTO      ENQI9999
.
ENQI2100  MOVE      ONE,TOTLFLAG
          MOVE      ONE,PPRCFLAG
          MOVE      ZERO,NZEROFLG      * Display all outstanding balance
          MOVE      ZERO,HOSPFLAG
          MOVE      ONE,SHOWFLAG           
.
          MOVE      ZERO,TBSRTFLG       * Flag set for tablesorting
. 
          MOVE      ZERO,ISBLFLAG
          CALL      PPHD0000           * Private Practice heading
          CALL      PINVCI00           * Private Practice Invoice list
          GOTO      ENQI9999
.
ENQI2200  WRITE     HTMLFILE;PRHRUNIQ;
          GOTO      ENQI9999
.
ENQI2300  WRITE     HTMLFILE;PRHRPRAC;
          GOTO      ENQI9999
.
ENQI2400  WRITE     HTMLFILE;PRHRDOCT;
          GOTO      ENQI9999
.
ENQI2500  MOVE      "GI",CATEGORY
          MOVE      PRHRPIND,CODE
          CALL      CODITM00 
          GOTO      ENQI9999
.
ENQI2600  WRITE     HTMLFILE;SELPRINT;
          GOTO      ENQI9999
.
ENQI2700  WRITE     HTMLFILE;NOCOPIES;
          GOTO      ENQI9999
.
ENQI2800  WRITE     HTMLFILE;PRINUNIQ;
          GOTO      ENQI9999
.
ENQI2900  WRITE     HTMLFILE;PRINPRAC;
          GOTO      ENQI9999
.
ENQI3000  WRITE     HTMLFILE;PRINDOCT;
          GOTO      ENQI9999
.
ENQI3100  WRITE     HTMLFILE;PATINDIC;
          GOTO      ENQI9999
.
ENQI3200  MOVE      ONE,TOTLFLAG
          MOVE      ZERO,PPRCFLAG
          MOVE      ONE,NZEROFLG       * skip zero outstanding balance
          MOVE      ZERO,HOSPFLAG
          MOVE      ONE,SHOWFLAG            
          READ      CONTROLF,SIXTY;*129,MRCNNOHS
          MATCH     Z70,MULTHOSP
          IF        @EQUAL
            PACK      KEY2,CHOSPNUM
            CALL      RDHOSP2
            IF        OVRCD<>1
              MOVE      HOSCODE,MULTHOSP
            ENDIF
          ENDIF
          COMPARE   ZERO,MRCNNOHS
          IF        !@EQUAL
            MOVE      MULTHOSP,HOSPCODE
            PACK      KEY4,HOSPCODE,SP70
            CALL      RDHOSP1
            IF        OVRCD<>1
              MOVE      HOSINDX,HOSPCNT
              CALL      OPFIL000
            ENDIF
          ENDIF
          MOVE      ZERO,ISBLFLAG
          MOVE      ZERO,TBSRTFLG       * Flag set for tablesorting
          CALL      PINVCI00           * Patient Invoice list
          COMPARE   ZERO,MRCNNOHS
          IF        !@EQUAL
            PACK      KEY2,CHOSPNUM,SP70
            CALL      RDHOSP2
            IF        OVRCD<>1
              MOVE      HOSCODE,HOSPCODE
              MOVE      HOSINDX,HOSPCNT
              CALL      OPFIL000
            ENDIF
          ENDIF
          GOTO      ENQI9999
.
ENQI3300  COMPARE   ONE,IBCNMHOS
          GOTO      ENQI9999 IF NOT EQUAL
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXMHOS,KEY3
            OPEN      PATHSPA1,"pathspaf"
            CALL      RDPTHSP1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTHSNAME;
            ENDIF
          ENDIF
          GOTO      ENQI9999
.
ENQI3400  CALL      MSEL0000
          GOTO      ENQI9999
.
ENQI3500  WRITE     HTMLFILE;CFEETYP;
          GOTO      ENQI9999
.
ENQI3600  MOVE      ZERO,PRINTFLG
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    VISITTYP,ENQI3620,ENQI3620,ENQI3620
          GOTO      ENQI9999
.
.         Only for Inpatient/Outpatient/Emergency invoice
.
ENQI3620  COMPARE   ZERO,INVOICEN
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td colspan=7 align=center><b>":
                               "No Invoice Selected</b></td></tr>"
            GOTO      ENQI9999
          ENDIF
          MOVE      ONE,JHFLAG
          MOVE      ONE,INVTYPE       * Summary Invoice
          MOVE      ZERO,ISBLFLAG
          IF        F1=1
            MOVE      TWO,INVTYPE     * Detailed Invoice
          ENDIF
          CALL      CALCTAI           * Display inpat/aae/out patient invoice
          MOVE      ZERO,JHFLAG
          GOTO      ENQI9999
.
ENQI3700  MATCH     SP70,EXPPAYER
          IF        @EQUAL
            CALL      DPAY0000         * Use default expected payer
          ELSE
            CALL      EPAY0000         * Expected payers/Funders List
          ENDIF
          GOTO      ENQI9999
.
ENQI3800  WRITE     HTMLFILE;TOTCHRG;
          GOTO      ENQI9999
.
ENQI3900  CALL      GPAY0000         * Get the default next expected payer
          WRITE     HTMLFILE;VSPAPAYC;
          GOTO      ENQI9999
.
ENQI4000  WRITE     HTMLFILE;PKADD1;
          GOTO      ENQI9999
.
ENQI4100  WRITE     HTMLFILE;PKADD2;
          GOTO      ENQI9999
.
ENQI4200  WRITE     HTMLFILE;PKSUBR;
          GOTO      ENQI9999
.
ENQI4300  WRITE     HTMLFILE;PKADD4;
          GOTO      ENQI9999
.
ENQI4400  WRITE     HTMLFILE;PKPOST;
          GOTO      ENQI9999
.
ENQI4500  WRITE     HTMLFILE;EXPPAYER;
          GOTO      ENQI9999
.
ENQI4600  
.         MOVE      ONE,TOTLFLAG
          MOVE      ZERO,TOTLFLAG
.
          MOVE      ZERO,PPRCFLAG
          MOVE      ONE,NZEROFLG       * skip zero outstanding balance
          MOVE      ZERO,HOSPFLAG
          MOVE      ONE,SHOWFLAG
          READ      CONTROLF,SIXTY;*129,MRCNNOHS
          MATCH     Z70,MULTHOSP
          IF        @EQUAL
            PACK      KEY2,CHOSPNUM
            CALL      RDHOSP2
            IF        OVRCD<>1
              MOVE      HOSCODE,MULTHOSP
            ENDIF
          ENDIF
          COMPARE   ZERO,MRCNNOHS
          IF        !@EQUAL
            MOVE      MULTHOSP,HOSPCODE
            PACK      KEY4,HOSPCODE,SP70
            CALL      RDHOSP1
            IF        OVRCD<>1
              MOVE      HOSINDX,HOSPCNT
              CALL      OPFIL000
            ENDIF
          ENDIF
          CALL      HFPINV00           * Health Fund Invoice list
          COMPARE   ZERO,MRCNNOHS
          IF        !@EQUAL
            PACK      KEY2,CHOSPNUM,SP70
            CALL      RDHOSP2
            IF        OVRCD<>1
              MOVE      HOSCODE,HOSPCODE
              MOVE      HOSINDX,HOSPCNT
              CALL      OPFIL000
            ENDIF
          ENDIF
          GOTO      ENQI9999
.
ENQI4700  WRITE     HTMLFILE;HLTHFUND;     * Invoice Health Fund
          GOTO      ENQI9999
.
ENQI4800  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,ENQI9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,PTINHFND
          GOTO      ENQI4820 IF EQUAL      * PRFA
.
          MOVE      PTINHFND,EXPPAYER
          PACK      KEY14,EXPPAYER,ZERO8,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,ENQI9999
          IF        F1=1
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;PTINHFND;     * Invoice Health Fund
          ENDIF
          GOTO      ENQI9999
.
ENQI4820  MOVE      "PRFA",EXPPAYER
          IF        F1=1
            WRITE     HTMLFILE;"Person Responsible for Account";
          ELSE
            WRITE     HTMLFILE;"PRFA";
          ENDIF
          GOTO      ENQI9999
.
ENQI4900  WRITE     HTMLFILE;HFUNDGRP;     * Invoice Health Fund Group
          GOTO      ENQI9999
.
ENQI5000  CALL      HSEL0000
          GOTO      ENQI9999
.
ENQI5100  MOVE      ONE,TOTLFLAG
          MOVE      ZERO,PPRCFLAG
          MOVE      ZERO,NZEROFLG      * Display all outstanding balance
          MOVE      ONE,NOCOMPCL       * No compensable column
.
          MOVE      ZERO,TBSRTFLG       * Flag set for tablesorting
.
          CALL      HDINV000                * Invoice heading
          MOVE      ONE,SHOWFLAG            * Show no more invoice message
          MOVE      IBCNMHOS,HOSPFLAG
          MOVE      ZERO,ISBLFLAG
          CALL      PINVCI00           * Patient Invoice list
          GOTO      ENQI9999
.
ENQI5200  MOVE      ONE,NOCOMPCL       * No compensable column
          GOTO      ENQI3200
ENQI5209  GOTO      ENQI9999
.
ENQI5300  CALL      FEEINF00           * Fees Information Quotation
          GOTO      ENQI9999
.
ENQI5400  MOVE      PMFNSNAM,PACSNAME
          MOVE      PMFNGNAM,PACGNAME
          MOVE      PMFNTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME                 * Format the patient name
          WRITE     HTMLFILE;PACFNAME;      * Patient name
          GOTO      ENQI9999
.
ENQI5500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MASF0501
          MATCH     SP70,PMFNTITL
          GOTO      ENQI9999 IF EQUAL
          WRITE     HTMLFILE;PMFNTITL;
          GOTO      ENQI9999
.
ENQI5520  PROC      TITLEDSC
          GOTO      ENQI9999
.
ENQI5600  REP       "#" ",PMFNSNAM
          WRITE     HTMLFILE;PMFNSNAM;      * Patient surname
          GOTO      ENQI9999
.
ENQI5700  REP       "#" ",PMFNGNAM
          WRITE     HTMLFILE;PMFNGNAM;      * Patient given name
          GOTO      ENQI9999
.
ENQI5800  REP       "#" ",PMFNADD1
          WRITE     HTMLFILE;PMFNADD1;      * Patient address 1
          GOTO      ENQI9999
.
ENQI5900  REP       "#" ",PMFNADD2
          WRITE     HTMLFILE;PMFNADD2;      * Patient address 2
          GOTO      ENQI9999
.
ENQI6000  REP       "#" ",PMFNSUBR
          WRITE     HTMLFILE;PMFNSUBR;      * Patient address 3
          GOTO      ENQI9999
.
ENQI6100  REP       "#" ",PMFNPOST
          WRITE     HTMLFILE;PMFNPOST;      * Patient postcode
          GOTO      ENQI9999
.
ENQI6200  MATCH     SP70,SRCHSNAM
          IF        @EQUAL
            CALL      FREQUT00         * Fees Est.Quotation for free format U/R
          ELSE
            CALL      FREQSN00         * Fees Est.Quotation for free format U/R
          ENDIF                        * search by surname
          GOTO      ENQI9999
.
ENQI6300  WRITE     HTMLFILE;EMCNGINV;
          GOTO      ENQI9999
.
ENQI6400  CALL      SDOC0000           * Get service doctor for an ED Invoice
          GOTO      ENQI9999
.
ENQI6500  WRITE     HTMLFILE;SRCHSNAM;
          GOTO      ENQI9999
.
ENQI6600  WRITE     HTMLFILE;SRCHGNAM;
          GOTO      ENQI9999
.
ENQI6700  MOVE      SP70,KEY1
          MOVE      ZERO,F1
          PACK      DIM127,DIM127,SP70
          UNPACK    DIM127,D1,KEY1
          MATCH     SP70,KEY1
          IF        !@EQUAL
            MOVE      KEY1,F1
          ENDIF
          CALL      EBTY0000           * Bed types selection for Fees Estimates
          GOTO      ENQI9999
.
ENQI6800  MATCH     SP70,PMFNBDAT
          GOTO      ENQI9999 IF EQUAL
.
          UNPACK    PMFNBDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ENQI9999
.
ENQI6900  WRITE     HTMLFILE;PMFNPHON;
          GOTO      ENQI9999
.
ENQI7000  CALL      ECLP0000        * Check for Eclipse
          WRITE     HTMLFILE;F1;
          GOTO      ENQI9999
.
ENQI7100  CLEAR     DIM80
          MOVE      SP70,KEY80
          PACK      NAME80,PTITL,SP70
          CALL      NAMASX00
          MOVE      PGNAME,ANS
          MOVE      ".",KEY1
          PACK      NAME80,ANS,KEY1,SP70
          CALL      NAMASX00
          PACK      NAME80,PTMASNAM,SP70
          CALL      NAMASX00
          APPEND    SP70,DIM80
          RESET     DIM80
          MOVE      DIM80,KEY80          * PRFA Name
          STRIP     KEY80
          WRITE     HTMLFILE;KEY80;
          GOTO      ENQI9999
.
ENQI7200  WRITE     HTMLFILE;CNAME;
          GOTO      ENQI9999
.
ENQI7300  CALL      LSIV0000                * List of Invoices of an admission
          GOTO      ENQI9999
.
ENQI7400  CALL      DIVC0000                * Display Invoice Comments
          GOTO      ENQI9999
.
ENQI7500  CALL      PMTINV00                  * Patient Invoice List
          GOTO      ENQI9999
.
ENQI7600  WRITE     HTMLFILE;INVOICEN;
          GOTO      ENQI9999
.
ENQI7700  MOVE      PINVAMT,FORM12P2
.         ADD       PINVPATA,FORM12P2
.         ADD       PINVHFDA,FORM12P2
.         ADD       PINVOTHA,FORM12P2
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          CALL      TPAY0000              * Get total payment
          ADD       TOTPAID,FORM12P2
.
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;
          GOTO      ENQI9999
.
ENQI7800  PACK      KEY8,CREDITNO
          CALL      RDPMCNO1
          IF        OVRCD=0
            WRITE     HTMLFILE;PMCNVISN;
          ENDIF
          GOTO      ENQI9999
.
ENQI7900  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,ENQI9999
.
          MOVE      ZERO,SPLITINV      * Initialise the other split invoice no
          MOVE      ZERO,FORM1
          CALL      SPLI0000           * Check for split invoice
.
.         Return FORM1 0 -  Not a split invoice
.                      1 -  split invoice (the other invoice not neutral)
.                      2 -  split invoice (both neutral)
.                      3 -  missing the other split invoice
.                      4 -  Independence Services Billing (all invoices neutral)
.                      5 -  Patient Inv with Rebate inv.raised(for PTCNPPIN=1)
.                      6 -  either Patient or Rebate inv.only(for PTCNPPIN=1)
.
ENQI7940  WRITE     HTMLFILE;FORM1;
          GOTO      ENQI9999
.
ENQI8000  CALL      ECLB0000        * Tag for Eclipse Batch button re-print inv
          GOTO      ENQI9999
.
ENQI8100  MATCH     SP70,PTJRCUID                * Journal Created By
          GOTO      ENQI9999 IF EQUAL
.
          PACK      KEY10,PTJRCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTJRCUID,WBSENAM
          ENDIF 
          WRITE     HTMLFILE;WBSENAM;
          GOTO      ENQI9999
.
ENQI8200  MATCH     PTJRCDAT,SP70                * Journal Created Date
          GOTO      ENQI9999 IF EQUAL
.
          UNPACK    PTJRCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ENQI9999
.
ENQI8300  WRITE     HTMLFILE;PTJRCTIM;           * Journal Created Time
          GOTO      ENQI9999
.
ENQI8400  MOVE      "J ",CATEGORY
          MOVE      SP70,CODE
          MOVE      ONE,JOURFLAG             * Exclude Self insured journal type
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,ENQI8480
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,ENQI8480
.
          MATCH     "S",TCINDC15             * self funded using special jrnls
          IF        @EQUAL
            MOVE      ZERO,JOURFLAG          * include Self insured journal type
          ENDIF
.
ENQI8480  CALL      SJRN0000                 * Selection of Journal types
          GOTO      ENQI9999
.
ENQI8500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      XRFN0000                 * get max refund or deposit amount
          GOTO      ENQI9999
.
ENQI8600  CALL      DRECV000                * NZ Time in  Recovery
          GOTO      INVD9999
.
ENQI8700  WRITE     HTMLFILE;PINVAMT;
          GOTO      INVD9999
.
ENQI8800  MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          CALL      TPAY0000              * Get total payment
          WRITE     HTMLFILE;TOTPAID;     * Total payment
          GOTO      INVD9999
.
ENQI8900  MOVE      ZERO,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;    * Total Journals
          GOTO      INVD9999
.
ENQI9000  MOVE      "J ",CATEGORY
          MOVE      JCODE,CODE
          CALL      CODITM00
          GOTO      INVD9999
.
ENQI9100  WRITE     HTMLFILE;TDDESC;
          GOTO      INVD9999
.
ENQI9200  MOVE      ZERO,F1
          MOVE      "003",VSMDTYPE        * Billing Comments
          PACK      KEY17,ADMISSNO,VSMDTYPE,SP70
          CALL      RSVSMDT1
ENQI9210  CALL      RKVSMDT1
          BRANCH    OVRCD,ENQI9280
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      ENQI9280 IF NOT EQUAL
.
          MATCH     "003",VSMDTYPE
          GOTO      ENQI9280 IF NOT EQUAL
          MATCH     "1",VSMDDELT
          GOTO      ENQI9210 IF EQUAL     * Deleted
.
          MOVE      ONE,F1
.
ENQI9280  WRITE     HTMLFILE;F1;
          GOTO      INVD9999
.
ENQI9300  CALL      ECLM0000
          GOTO      ENQI9999
.
ENQI9400  CALL      ECLIND00              * Eclipse Indicator Flag
          GOTO      ENQI9999
.
ENQI9500  CALL      GROVR000
          WRITE     HTMLFILE;SAVEROVR;
          GOTO      ENQI9999
.
ENQI9600  CALL      GLVIS000
          WRITE     HTMLFILE;SAVELVIS;
          GOTO      ENQI9999
.
ENQI9700  CALL      IMCRCV00
          GOTO      ENQI9999
.
ENQI9800  PACK      KEY10,PTINCUID,SP70
          IF        VISITTYP=4
            PACK      KEY10,PRINCUID,SP70
          ENDIF
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      ENQI9999
.
ENQI9900  MOVE      "CL",CATEGORY
          MOVE      PINVCLM,CODE         * claim type
          CALL      CODITM00
          GOTO      INVD9999
.
ENQI9999  RETURN
+
.------------------------------------------------------------------------------
.         Check if this is an independence services billing
.------------------------------------------------------------------------------
CKIB0000  MOVE      ZERO,ISBLFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIVBA1,"pmsivbaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CKIB9999
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPMIVB1
          BRANCH    OVRCD,CKIB9999
          MOVE      ONE,ISBLFLAG
CKIB9999  RETURN
+
.------------------------------------------------------------------------------
.         Selection of Journal codes include Self insured journal type
.------------------------------------------------------------------------------
SJRN0000  MOVE      ZERO,PUBCLAIM                  * default to Not Public
          PACK      KEY5,CODECL,PINVCLM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "P",TCINDC1
            IF        @EQUAL
              MOVE      ONE,PUBCLAIM               * Public
            ENDIF
          ENDIF
.
          MOVE      TCINDC15,DIM1                  * Cat CL Ind15         
          APPEND    "abcdefghijklmnopqrstuvwxyz",VALINTXT
          APPEND    "ABCDEFGHIJKLMNOPQRSTUVWXYZ",VALINTXT
          APPEND    "0123456789",VALINTXT
          RESET     VALINTXT

.
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>"
.
.         Check if Indicator value is within the range a-zA-Z0-9
          SCAN      DIM1,VALINTXT
          IF        !@EQUAL
            GOTO      SJRN9999
          ENDIF
.
          MOVE      ZERO,F2
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
SJRN1000  CALL      RDKCODE2
          BRANCH    OVRCD,SJRN9999
          MATCH     CATEGORY,TCODE
          GOTO      SJRN9999 IF NOT EQUAL
.
          MATCH     "N",TCINDC6                 * exclude indic6=N
          GOTO      SJRN1000 IF EQUAL
.
          MATCH     SP70,ACODE
          GOTO      SJRN1000 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SJRN1000 IF EQUAL           * Inactive
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,SJRN1000
            ENDIF
          ENDIF
.
.         Check parameter for 'Enable restricted Journals on Invoice'
.
          MATCH     "1",PTCNRJNL
          GOTO      SJRN6000 IF NOT EQUAL
.
.         Display journal type indic7=P for Public Claim type (Cat CL indic1=P)
.
          IF        PUBCLAIM=1
            MATCH     "P",TCINDC7
            GOTO      SJRN1000 IF NOT EQUAL       * Not for Public
          ELSE
            MATCH     "P",TCINDC7
            GOTO      SJRN1000 IF EQUAL           * Only for Public
          ENDIF
.
SJRN6000  PACK      KEY35,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
          PACK      KEY40,QUOTE,ACODE,KEY35,QUOTE
.
.         If parameter Enable restricted Journals on Invoice is turned on and
.         Cat CL Ind15 is not equal to Cat J Ind 7 then exclude
          MATCH       "1",PTCNRJNL
          IF          @EQUAL
.
.           Exclude rule if is self funded
            IF        JOURFLAG=1      
              RESET       VALINTXT
              SCAN        TCINDC7,VALINTXT
              IF          !@EQUAL
                GOTO        SJRN1000
              ENDIF   
.
              MATCH       SP1,DIM1
              IF          !@EQUAL
                MATCH       DIM1,TCINDC7
                GOTO        SJRN1000 IF NOT EQUAL
              ENDIF
            ENDIF
.      
.           Cat CL ind 15 = blank then display record where Catj Ind 7 != blank
            MATCH     SP1,DIM1
            IF        @EQUAL
              MATCH       SP70,TCINDC7
              GOTO        SJRN1000 IF NOT EQUAL
            ENDIF        
          ENDIF
.
.         If patient is NOT 'Self funded' then Exclude 'Self funded' journals
.         If patient is 'Self funded' then include only 'Self funded' journals
.
          IF        JOURFLAG=1
            MATCH     SP70,TCINDC5             * exclude if ind5<>blank
            GOTO      SJRN1000 IF NOT EQUAL
          ELSE
            MATCH     SP70,TCINDC5             * only ind5<>blank
            GOTO      SJRN1000 IF EQUAL
.
.         Self Insured patient will have default to 'Discount' journal type
.
            IF        F2=0
              MATCH     "D",TCINDC5
              IF        @EQUAL
                WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                                   TDESC,"</option>"
                MOVE      ONE,F2
                GOTO      SJRN1000
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<option value=",KEY40,">",TDESC,"</option>"
          GOTO      SJRN1000
.
SJRN9999  RETURN
+
.------------------------------------------------------------------------------
.         Maximum Refund amount for self funded
.         Refund will only be available if invoice is overpaid
.------------------------------------------------------------------------------
XRFN0000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          CALL      TPAY0000              * Get total payment
.
          BRANCH    F1,XRFN1000,XRFN8000
          GOTO      XRFN2000
.
XRFN1000  MOVE      TOTDEPS,TOTPAID       * Total deposit
.
XRFN2000  MULT      "-1",TOTPAID
          GOTO      XRFN9000
.
XRFN8000  MOVE      "0",KEY1
          IF        TOTPAID<>0
            MOVE      "1",KEY1            * flag for finding a receipt
          ENDIF
          WRITE     HTMLFILE;KEY1;
          GOTO      XRFN9999
.
XRFN9000  WRITE     HTMLFILE;TOTPAID;
XRFN9999  RETURN
+
.------------------------------------------------------------
. Display time in recovery
.------------------------------------------------------------
DRECV000  OPEN      OPRDETA2,"oprdetaf"
          PACK      KEY31,ADMISSNO,SP70   * has the patient been to theatre?
          CALL      RSOPDEA2
DRECV100  CALL      RKOPDEA2
          BRANCH    OVRCD,DRECV999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DRECV999 IF NOT EQUAL
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,DRECV100
.
          MATCH     SP70,OPARTIRD
          GOTO      DRECV100 IF EQUAL    * Time in Recovery is blank
          MATCH     SP70,OPARTETC
          GOTO      DRECV100 IF EQUAL    * Time Exit Theatre is blank
.
          PACK      FIRSTDAT,OPDADATE,SP70
          PACK      LASTDATE,OPDADATE,SP70
.
          MOVE      OPARTIRD,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      FIRSTIME,DIM5,SP70
.
          MOVE      OPARTETC,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      LASTTIME,DIM5,SP70
.
.         Assume Overnight if Theatre Exit time is Less than Time in Recover.
.
          MATCH     FIRSTIME,LASTTIME
          IF        @LESS
            MOVE      FIRSTDAT,DATFIELD
            ADD       ONE,DATFIELD
            MOVE      DATFIELD,LASTDATE
          ENDIF
.
          CALL      TIMEDIFF               * calculate the time difference
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>":
                             "Recovery Time:",CALCTIME:
                             "mins, Booking ID:":
                             OPDAUNIQ,"</td></tr>";
          GOTO      DRECV100

DRECV999  RETURN
+
.------------------------------------------------------------------------------
.         Check if invoice has been submitted via Eclipse
.------------------------------------------------------------------------------
ECLP0000  MOVE      ZERO,F1
          OPEN      PMSECTA2,"pmsectaf"
          PACK      KEY16,PINVNO,SP70
          CALL      RDPMECT2
          COMPARE   ZERO,OVRCD
          GOTO      ECLP2000 IF EQUAL
.
ECLP1000  CALL      RKPMECT2
          BRANCH    OVRCD,ECLP9999
.
          MATCH     PMECINVN,PINVNO         * same invoice?
          GOTO      ECLP9999 IF NOT EQUAL
.
ECLP2000  
.         COMPARE   ZERO,PMECFLAG
.         GOTO      ECLP1000 IF EQUAL
          MOVE      ONE,F1
ECLP9999  RETURN
+
.------------------------------------------------------------
. Table of invoices
.------------------------------------------------------------
LSIV0000  UNPACK    DIM127,D1,KEY1,DIM127
.
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,URNUMBER
          GOTO      LSIV9999 IF EQUAL
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          PACK      KEY16,ADMISSNO,Z70
          CALL      RSPTINV3
LSIV2000  CALL      RPPTINV3
          BRANCH    OVRCD,LSIV9999
          MATCH     ADMISSNO,DPINVADM
          GOTO      LSIV9999 IF NOT EQUAL
.
          PACK      NEXTVKEY,ADMISSNO,PINVNO,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,ADMISSNO,PINVNO,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      LSIV2000
          ENDIF
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr><td>":
                             PINVNO,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td align=right>$",PINVAMT,"&nbsp;</td>":
                             "<td><img src=../images/DocumentIcon.gif ":
                             " class=ListIcon onclick='linkComments(#"":
                             ADMISSNO,"#",#"",PINVNO,"#")'></td></tr>";
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      LSIV2000 IF NOT EQUAL
.
LSIV9999  RETURN
+
.------------------------------------------------------------
. Display Invoice Comments
.------------------------------------------------------------
DIVC0000  MOVE      SP70,KEY8
          MOVE      ZERO,FORM8
          MOVE      INVOICEN,FORM8
          IF        FORM8<>0
            MOVE      FORM8,KEY8
          ENDIF
          PACK      KEY19,ADMISSNO,KEY8,SP70
          CALL      RSPMICM1
DIVC1000  CALL      RKPMICM1
          BRANCH    OVRCD,DIVC9999          * end of file
          MATCH     PMICVISN,ADMISSNO       * same Admission Number?
          GOTO      DIVC9999 IF NOT EQUAL
.
          MATCH     KEY8,PMICINVN
          GOTO      DIVC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMICCMNT
          GOTO      DIVC1000
.
DIVC9999  RETURN
+
.------------------------------------------------------------
.         Bed types selection for Fees Estimates
.------------------------------------------------------------
EBTY0000  MOVE      "BT",KEY2
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
EBTY2000  CALL      RDKCODE2
          BRANCH    OVRCD,EBTY9999
          MATCH     KEY2,TCODE
          GOTO      EBTY9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      EBTY2000 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      EBTY2000 IF EQUAL      * In-active
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,EBTY2000
            ENDIF
          ENDIF
.
          COMPARE   TWO,TCFORM6
          GOTO      EBTY4000 IF EQUAL      * other bed type with Additional Fee
.
          COMPARE   ONE,TCFORM6
          GOTO      EBTY2000 IF NOT EQUAL  * not a valid fees estimates bedtype
.
EBTY4000  PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
.
.         F1=1, first Bed type default to Private bed type
.
          IF        F1=1
            MATCH     "1",TCINDC3
            IF        @EQUAL
              MOVE      ZERO,F1
              WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                                 TDESC,"</option>"
              GOTO      EBTY2000
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          GOTO      EBTY2000
.
EBTY9999  RETURN
+
.------------------------------------------------------------
.         Get service doctor for an ED Invoice
.------------------------------------------------------------
SDOC0000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8             
          PACK      KEY23,KEY8,SP70
          CALL      RDSDTRE4
SDOC1000  CALL      RDKDTRE4
          BRANCH    OVRCD,SDOC9999
          MATCH     KEY8,ATINVNO      * Same invoice number?
          GOTO      SDOC9999 IF NOT EQUAL
          BRANCH    ATRECTYP,SDOC2000,SDOC1000,SDOC1000,SDOC1000
.
SDOC2000  MATCH     SP70,ATDTEDAD
          GOTO      SDOC1000 IF EQUAL
          WRITE     HTMLFILE;ATDTEDAD;
SDOC9999  RETURN
+
.------------------------------------------------------------
.         Get default next expected payer
.------------------------------------------------------------
GPAY0000  PACK      KEY10,ADMISSNO,SP70
          CALL      RSVSPAY2
GPAY1000  CALL      RKVSPAY2
          BRANCH    OVRCD,GPAY8000
          MATCH     ADMISSNO,VSPAVISN        * Same visit no?
          GOTO      GPAY8000 IF NOT EQUAL
.
          BRANCH    VSPAISEN,GPAY1000       * Already sent
          GOTO      GPAY9999
.
GPAY8000  MOVE      "PRFA",VSPAPAYC
GPAY9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
MSEL0000  PACK      KEY4,SP70
          CALL      RDSHOSP1
MSEL0100  CALL      RDKHOSP1
          BRANCH    OVRCD,MSEL9999
.
          MOVE      HOSDESC,KEY50
          PACK      KEY6,QUOTE,HOSCODE,QUOTE
          MATCH     Z70,MULTHOSP
          IF        !@EQUAL
            MATCH     MULTHOSP,HOSCODE
          ELSE
            MATCH     HOSPCODE,HOSCODE
          ENDIF
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">",KEY50,"</option>"
          ENDIF
          GOTO      MSEL0100
.
MSEL9999  RETURN
+
.------------------------------------------------------------
.         Processing Receipts
.------------------------------------------------------------
RCPP0000  BRANCH    FLDITMNO,RCPP0100,RCPP0200,RCPP0300,RCPP0400,RCPP0500:
                             RCPP0600,RCPP0700,RCPP0800,RCPP0900,RCPP1000:
                             RCPP1100,RCPP1200,RCPP1300,RCPP1400,RCPP1500:
                             RCPP1600,RCPP1700,RCPP1800,RCPP1900,RCPP2000:
                             RCPP2100,RCPP2200,RCPP2300,RCPP2400,RCPP2500:
                             RCPP2600
          GOTO      RCPP9999
.
RCPP0100  CALL      RCPL0000           * List of Receipts Processing
          GOTO      RCPP9999
.
RCPP0200  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP0300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RCPP0310
.
          MATCH     SP70,FILTHFND
          GOTO      RCPP9999 IF EQUAL
.
          WRITE     HTMLFILE;FILTHFND;
          GOTO      RCPP9999
.         
RCPP0310  PACK      KEY14,FILTHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;FILTHFND;
          ENDIF
          GOTO      RCPP9999
.
RCPP0400  WRITE     HTMLFILE;FILTSTAT;       * Status
          GOTO      RCPP9999
.
RCPP0500  CALL      PREVRC00        * Show Previous Receipts of records
          GOTO      RCPP9999
.
RCPP0600  CALL      NEXTRC00        * Show Next Receipts of records
          GOTO      RCPP9999
.
RCPP0700  CALL      SELV0000
          GOTO      RCPP9999
.
RCPP0800  CALL      CURSTD00
          GOTO      RCPP9999
.
RCPP0900  CALL      CUREND00
          GOTO      RCPP9999
.
RCPP1000  CALL      CURYR000
          GOTO      RCPP9999
.
RCPP1100  CALL      CURMON00
          GOTO      RCPP9999
.
RCPP1200  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      RCPP9999
.
RCPP1300  WRITE     HTMLFILE;INVOICEN;
          GOTO      RCPP9999
.
RCPP1400  MOVE      "CL",CATEGORY
          MOVE      PTURCLMN,CODE
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP1500  MOVE      SP70,KEY20
          MATCH     SP70,PTURHFND
          IF        !@EQUAL
            PACK      KEY20,PTURHFND,SLASH,PTURHTAB,SP70
          ENDIF
          WRITE     HTMLFILE;KEY20;
          GOTO      RCPP9999
.
RCPP1600  WRITE     HTMLFILE;PINVNO;
          GOTO      RCPP9999
.
RCPP1700  UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      RCPP9999
.
RCPP1800  WRITE     HTMLFILE;PINVAMT;
          GOTO      RCPP9999
.
RCPP1900  WRITE     HTMLFILE;PINVREB;
          GOTO      RCPP9999
.
RCPP2000  MOVE      PINVAMT,FORM12P2
          SUB       PINVREB,FORM12P2
          WRITE     HTMLFILE;FORM12P2;
          GOTO      RCPP9999
.
RCPP2100  CALL      TPAY0000
          MOVE      PINVAMT,FORM12P2
.         ADD       PINVPATA,FORM12P2
.         ADD       PINVHFDA,FORM12P2
.         ADD       PINVOTHA,FORM12P2
          ADD       TOTPAID,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
.
          WRITE     HTMLFILE;FORM12P2;
          GOTO      RCPP9999
.
RCPP2200  MOVE      "dm",CATEGORY
          MOVE      PTRARMOV,CODE          * reason for Debt movement
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP2300  WRITE     HTMLFILE;PTRAPPOR;     * Patient portion
          GOTO      RCPP9999
.
RCPP2400  WRITE     HTMLFILE;PTURSTAT;     * Processed status
          GOTO      RCPP9999
.
RCPP2500  MOVE      "dc",CATEGORY
          MOVE      PTRADBAG,CODE          * Debt Collection Agencies
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP2600  WRITE     HTMLFILE;FILTAUTO;     * filter for Auto Processing
          GOTO      RCPP9999
.
RCPP9999  RETURN
+
.------------------------------------------------------------
.         List of Receipts
.------------------------------------------------------------
RCPL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,DISNUMB
          PACK      KEY24,FRSTDATE,SP70
          CALL      RSPTURE2
RCPL1000  CALL      RKPTURE2
          BRANCH    OVRCD,RCPL9999
.
          MATCH     PTURUDAT,LASTDATE
          GOTO      RCPL9999 IF LESS
.
          REP       " 0",FILTAUTO
          MATCH     "0",FILTAUTO
          IF        !@EQUAL
            CALL      CRAS0000          * Check for existing reassign record
            BRANCH    EXIT,RCPL1000
          ENDIF
.
.         MATCH     "2",PTURSTAT           * Skip deleted record
.         GOTO      RCPL1000 IF EQUAL
.
          MOVE      PTURVISN,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,RCPL1000         * Missing Visit record
.
          MOVE      PTURINVN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,RCPL1000         * Missing Invoice record
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RCPL1000         * Missing Master record
.
          MATCH     SP70,FILTCLAM
          IF        !@EQUAL
            MATCH     FILTCLAM,PTURCLMN
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHFND
          IF        !@EQUAL
            MATCH     FILTHFND,PTURHFND
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,PTURSTAT
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          CALL      PATNAC00               * setup patient name
.
          MOVE      PVIURNO,URNUMBER
          MOVE      PTURVISN,ADMISSNO
          CALL      GETPAT00
.
          COMPARE   ONE,IBCNMHOS
          GOTO      RCPL3000 IF NOT EQUAL
.
          MATCH     SP70,PMVXMHOS
          GOTO      RCPL1000 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      RCPL1000 IF NOT EQUAL   * different hospital id
.
RCPL3000  CALL      PATLN000
.
          ADD       ONE,DISNUMB
          MOVE      SP70,DIM5
          MOVE      ZERO,FORM5
          MOVE      DISNUMB,FORM5
          MOVE      FORM5,DIM5
          REP       " 0",DIM5
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PINVUR,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    PINVADM,PATLINK
          RESET     PATLINK
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    PTURINVN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                          "#"",PINVADM,"#",";                    * 1
.
          MATCH     SP70,PTURCLMN
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",SP1,"#",";                   * 2
          ELSE
            MOVE      "Invalid Claim Code",TDESC
            MOVE      "CL",KEY2
            PACK      KEY5,KEY2,PTURCLMN,SP70
            CALL      RDCODE1
            WRITE     HTMLFILE;"#"",TDESC,"#",";                 * 2
          ENDIF
.
          MATCH     SP70,PTURHFND
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",SP1,"#",";                   * 3
          ELSE
            PACK      KEY17,PTURHFND,SLASH,PTURHTAB,SP70
            WRITE     HTMLFILE;"#"",KEY17,"#",";                 * 3
          ENDIF
.
          MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
.         Get payment for released and un-released payments
.
          CALL      TPAY0000
.
          MOVE      PINVJOUR,FORM12P2    * Journals
          ADD       PTINGSTJ,FORM12P2
          ADD       PTINCRTT,FORM12P2
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       FORM12P2,TOTOUTS
.
          MOVE      SP70,KEY1
          PACK      DIM10A,PTURINVN,SP70
          MATCH     "1",PTURSTAT
          IF         @EQUAL
            MOVE       "*",KEY1            * status of Processed
          ENDIF
          PACK      DIM10A,KEY1,PTURINVN,SP70
.
.         Get the last record of Reassign debt table
.
          MOVE      ZERO,PATPORTN
          PACK      KEY10,PTURINVN,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          IF        OVRCD=0
            MATCH     PTURINVN,PTRAINVN    * Same invoice number?
            IF        @EQUAL
              MATCH     "1",PTRADELE       * Not deleted
              IF        !@EQUAL
                MOVE      PTRAPPOR,PATPORTN
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY3
          CALL      PATFLD00
.
.
          WRITE     HTMLFILE;"#"",PATFNAME,"#",":                * 4
                             "#"",PVIDATE,"#",":                 * 5
                             "#"",DIM10A,"#",":                  * 6
                             "#"",PINVAMT,"#",":                 * 7
                             "#"",TOTPAID,"#",":                 * 8
                             "#"",FORM12P2,"#",":                * 9
                             "#"",TOTOUTS,"#",":                 * 10
                             "#"",PTURUDAT,"#",":                * 11
                             "#"",PATLINK,"#",":                 * 12
                             "#"",PATPORTN,"#",":                * 13
                             "#"",KEY3,"#",";                    * 13
.
          WRITE     HTMLFILE;"#"<input type=checkbox name=asg",DIM5:
                     " value='",PTURINVN;
.
          MATCH     "0",FILTAUTO
          IF        @EQUAL
            WRITE   HTMLFILE;"' disabled onclick=updateAssignDebt();>","#",";
          ELSE
            WRITE     HTMLFILE;"' onclick=updateAssignDebt();>","#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"<input type=checkbox name=prt",DIM5:
                      " value='",PTURINVN,"' onclick=updatePrintInv();>":
                      "#")"
.
          GOTO      RCPL1000
.
RCPL9999  RETURN
+
.------------------------------------------------------------------------------
.         Check for existing reassign record
.------------------------------------------------------------------------------
CRAS0000  MOVE      ZERO,EXIT
          PACK      KEY10,PTURINVN,SP70
          CALL      RSPTRAS1
CRAS1000  CALL      RKPTRAS1
          BRANCH    OVRCD,CRAS2000
.
          MATCH     PTURINVN,PTRAINVN    * Same invoice number?
          GOTO      CRAS2000 IF NOT EQUAL
.
          MATCH     "1",PTRADELE       * Not deleted
          GOTO      CRAS1000 IF EQUAL
.
.         found existing reassign record
.
          MATCH     "1",FILTAUTO         * Previouly processed
          GOTO      CRAS9999 IF EQUAL
          GOTO      CRAS9000
      
CRAS2000  MATCH     "2",FILTAUTO         * New Movement
          GOTO      CRAS9999 IF EQUAL
.
CRAS9000  MOVE      ONE,EXIT
CRAS9999  RETURN
+
.------------------------------------------------------------------------------
.      get all receipts/payments
.------------------------------------------------------------------------------
TPAY0000 MOVE      ZERO,TOTPAID
         MOVE      ZERO,TOTDEPS
         PACK      SAVKEY12,SP4,PINVNO,SP70  * set up invoice number
         PACK      KEY29,SAVKEY12,SP70
         CALL      RSRCDTE3
TPAY1000 CALL      RKRCDTE3
         BRANCH    OVRCD,TPAY9000
.
         MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
         GOTO      TPAY9000 IF NOT EQUAL
.
         PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,TPAY1000
         MATCH     "1",RCBNSTAT
         GOTO      TPAY1000 IF EQUAL       * Receipt cancelled
.
.        Check for Deposit register
.
         PACK      KEY3,RCDTREGI,SP70
         CALL      RDREGA1
         BRANCH    OVRCD,TPAY1000
.
         COMPARE   "2",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * Private Practice
         COMPARE   "96",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * PRI Deposit
.
         IF        REGIBACD=90 | REGIBACD=91 | REGIBACD=97
           ADD       RCDTAMNT,TOTDEPS       * Deposit amount
         ENDIF
.
TPAY2000 ADD       RCDTAMNT,TOTPAID
         GOTO      TPAY1000
.
TPAY9000 MULT      "-1",TOTPAID
         MULT      "-1",TOTDEPS
TPAY9999 RETURN
+
.-------------------------------------------------------------
. Link to Prev Receipts
.-------------------------------------------------------------
PREVRC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
.
          WRITE     HTMLFILE;"patweb76.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&filtclam=",FILTCLAM:
                                 "&filthfnd=",FILTHFND:
                                 "&filtstat=",FILTSTAT:
                                 "&viewtype=",VIEWTYPE:
                                 "&invoicen=",INVOICEN;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",PREVVKEY
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
.
PREVRC99  RETURN
+
.-----------------------------------------------------------
. Link to Next Receipts
.-----------------------------------------------------------
NEXTRC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
.
          WRITE     HTMLFILE;"patweb76.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&norecord=",KEY2:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&filtclam=",FILTCLAM:
                                 "&filthfnd=",FILTHFND:
                                 "&filtvtyp=",FILTSTAT:
                                 "&viewtype=",VIEWTYPE:
                                 "&invoicen=",INVOICEN;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
.
NEXTRC99  RETURN
+
.------------------------------------------------------------
.   Debtor Invoice Verification
.------------------------------------------------------------
DENQ0000  BRANCH    FLDITMNO,DENQ0100,DENQ0200,DENQ0300,DENQ0400,DENQ0500
.
DENQ0100  REP       "~&",URNUMBER
          WRITE     HTMLFILE;URNUMBER;
          GOTO      DENQ9999
.
DENQ0200  MOVE      ONE,TOTLFLAG
          MOVE      ZERO,NZEROFLG   
          CALL      PPINVC00           * Priv Prac Debtor Invoice list
          GOTO      DENQ9999
.
DENQ0300  MOVE      ONE,TOTLFLAG
          MOVE      ONE,NZEROFLG   
          CALL      ARINVC00           * Acc Rec Debtor Invoice list
          GOTO      DENQ9999
.
DENQ0400  CALL      PREVGR00                 * Show previous group of records
          GOTO      DENQ9999
.
DENQ0500  CALL      NEXTGR00                 * Show next group of records
          GOTO      DENQ9999
.
DENQ9999  RETURN
.------------------------------------------------------------
.   Invoice credit fields
.------------------------------------------------------------
CINV0000  BRANCH    FLDITMNO,CINV0100,CINV0200,CINV0300,CINV0400,CINV0500:
                             CINV0600,CINV0700,CINV0800,CINV0900,CINV1000:
                             CINV1100,CINV1200,CINV1300,CINV1400,CINV1500:
                             CINV1600,CINV1700,CINV1800,CINV1900,CINV2000:
                             CINV2100,CINV2200,CINV2300,CINV2400,CINV2500:
                             CINV2600,CINV2700,CINV2800,CINV2900,CINV3000:
                             CINV3100,CINV3200,CINV3300,CINV3400,CINV3500:
                             CINV3600,CINV3700
.
          GOTO      CINV9999
.
CINV0100  MOVE      ZERO,KEYFLAG          * flag for Pat/Rebate invoice
          MOVE      INVOICEN,FORM8
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            CALL      CIPT0000      * Check if Patient/HF Inv.has been raised
            BRANCH    EXIT,CINV0120
            BRANCH    KEYFLAG,CINV0120
          ENDIF
          CALL      LINV0000               * Last invoice
CINV0120  WRITE     HTMLFILE;FORM1;
          GOTO      CINV9999
.
CINV0200  CALL      REAS0000               * Reason for Credit Note
          GOTO      CINV9999
.
CINV0300  CALL      GMSC0000               * Check if any item in the invoice
          GOTO      CINV9999
.
CINV0400  CALL      KEEP0000               * Keep misc.item
          GOTO      CINV9999
.
CINV0500  CALL      DCRI0000               * List of Credit note by item
          GOTO      CINV9999
.
CINV0600  CALL      LCRD0000               * List credit note
          GOTO      CINV9999
.
CINV0700  CALL      DSCR0000               * Display credit note
          GOTO      CINV9999
.
CINV0800  CALL      DICR0000               * Display credit notes for an invoice
          GOTO      CINV9999
.
CINV0900  CALL      CTRN0000               * Check if Credit Transaction avail
          GOTO      CINV9999
.
CINV1000  CALL      CITM0000               * Check if Credit by item avail
          GOTO      CINV9999
.
CINV1100  CALL      RDIR0000               * redirect to invoice detail screen
          GOTO      CINV9999
.
CINV1200  CALL      CRCP0000               * Check for cash receipt
          GOTO      CINV9999
.
CINV1300  CALL      PPLINV00               * PP Last invoice
          GOTO      CINV9999
.
CINV1400  CALL      PPCITM00               * PP Check if Credit by item avail
          GOTO      CINV9999
.
CINV1500  CALL      PPCTRN00               * PP Check if Credit Trans avail
          GOTO      CINV9999
.
CINV1600  CALL      CSTR0000               * Check if Cash Transfer avail
          WRITE     HTMLFILE;FORM1;
          GOTO      CINV9999
.
CINV1700  CALL      CSHT0000               * List of Payments for cash transfer
          GOTO      CINV9999
.
CINV1800  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8             
          CALL      RDINV1
          BRANCH    OVRCD,CINV9999
          MOVE      PINVSYS,F1        * save system type 
          CALL      SELINV00          * Display available select of invoice no
          GOTO      CINV9999
.
CINV1900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      KEY1,DIM1A
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CINV9999
.
          MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
          MOVE      ZERO,F1
          PACK      KEY12,SP4,PINVNO,SP70 * set up invoice number
          MOVE      PINVUR,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
          ADD       PTINGSTJ,TOTOUTS
          ADD       PTINCRTT,TOTOUTS
.
          MOVE      DIM1A,F1
          BRANCH    F1,CINV1920
          MULT      "-1",TOTOUTS
.
CINV1920  WRITE     HTMLFILE;TOTOUTS;
          GOTO      CINV9999
.
CINV2000  MOVE      ZERO,TOTOUTS
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,CINV9999
.
          MOVE      PRINITOT,TOTOUTS      * Total Outstanding
          ADD       PRINPAMT,TOTOUTS
          ADD       PRINHAMT,TOTOUTS
          ADD       PRINIAMT,TOTOUTS
          ADD       PRINMAMT,TOTOUTS
          ADD       PRINVAMT,TOTOUTS
          ADD       PRINOTHA,TOTOUTS
          ADD       PRINJAMT,TOTOUTS
          ADD       PRINCNTT,TOTOUTS
.
          WRITE     HTMLFILE;TOTOUTS;
          GOTO      CINV9999
.
CINV2100  CALL      RASS0000              * Check if Re-assign Debt avail.
          GOTO      CINV9999
.
CINV2200  CALL      SACT0000              * Selection of Action plans
          GOTO      CINV9999
.
CINV2300  CALL      CACT0000              * Check for existing Action plans
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,CINV2320
          WRITE     HTMLFILE;EXIT;
          GOTO      CINV9999
.
CINV2320  IF        EXIT=1
            MOVE      "Assign ",KEY7
          ELSE
            MOVE      "Update ",KEY7
          ENDIF
          WRITE     HTMLFILE;KEY7;
          GOTO      CINV9999
.
CINV2400  UNPACK    PTPFIFDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      CINV9999
.
CINV2500  MOVE      "AK",CATEGORY
          MOVE      PTPFPLAN,CODE          * Action plan
          CALL      CODITM00
          GOTO      CINV9999
.
CINV2600  MOVE      "mr",CATEGORY
          MOVE      PTPFMODR,CODE          * Modify reason
          CALL      SMRE0000               * Selection
          GOTO      CINV9999
.
CINV2700  CALL      CSTR0000               * Check if Cash Transfer avail
          SUB       F12P2,FORM12P2         * total payment - jrnl overpay
          IF        FORM12P2<0
            MOVE      ZERO,FORM12P2
          ENDIF
          WRITE     HTMLFILE;FORM12P2;
          GOTO      CINV9999
.
CINV2800  WRITE     HTMLFILE;PTCNDFUP;
          GOTO      CINV9999
.
CINV2900  CALL      PPCM0000               * Check for Private Practice Comments
          WRITE     HTMLFILE;F1;
          GOTO      CINV9999
.
CINV3000  CALL      CPTR0000               * Check if Cash Transfer available
          WRITE     HTMLFILE;F1;
          GOTO      CINV9999
.
CINV3100  CALL      CINC0000               * Check invoice comments
          GOTO      CINV9999
.
CINV3200  CALL      IPCM0000               * Check PP Invoice comments
          GOTO      CINV9999
.
CINV3300  CALL      PPJRNL00               * Check if PP Input Journal available
          GOTO      CINV9999
.
CINV3400  CALL      IPJRNL00               * Check if Inp Input Journal avail.
          GOTO      CINV9999
.
CINV3500  MATCH     SP70,PMFDCMCD          * Casemix code
          IF        !@EQUAL
            WRITE     HTMLFILE;PMFDCMCD;
          ELSE
            MATCH     "2",PTCNIFCL           * SJOG using IFC layout
            IF        @EQUAL
              CALL      GITM0000             * items from theatre fees
              BRANCH    EXIT,CINV9999
            ENDIF
            MOVE      "A ",CATEGORY
            MOVE      PMFDATYP,CODE
            PACK      KEY5,CATEGORY,CODE
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;TDESC;
            ENDIF
          ENDIF
          GOTO      CINV9999
.
CINV3600  WRITE     HTMLFILE;PTINCMIX;
          GOTO      CINV9999
.
CINV3700  CALL      IVLH0000            * Display Invoice List Heading
          GOTO      CINV9999
.
CINV9999  RETURN
+
.------------------------------------------------------------
.         Item from Theatre fees item
.------------------------------------------------------------
GITM0000  MOVE      ZERO,EXIT
          MOVE      QUOTENUM,KEY12
          MOVE      "5",KEY1
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
GITM1000  CALL      RKPMFES2
          BRANCH    OVRCD,GITM9999
.
          MATCH     KEY12,PMFSQUOT
          GOTO      GITM9999 IF NOT EQUAL
.
          COMPARE   FIVE,PMFSRTYP           * Only pick up Theatre Fee
          GOTO      GITM9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMFSTHIT;
          MOVE      ONE,EXIT
.
GITM9999  RETURN
+
.------------------------------------------------------------
.         Display Invoice List heading
.------------------------------------------------------------
IVLH0000  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                             "<td><b>Visit No</b></td>":
                             "<td><b>Visit Date</b></td>":
                             "<td><b>Invoice No.</b></td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date/Time</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Medical Prac.</b></td>":
                             "<td><b>Compensable</b></td>":
                             "<td><b>Health Fund</b></td>":
                             "<td align=right><b>Invoice Total</b></td>":
                             "<td align=right><b>Paid</b></td>":
                             "<td align=right><b>Journals</b></td>":
                             "<td align=right><b>Outstanding</b>":
                             "</td></tr>"
.
IVLH9999  RETURN
+
.------------------------------------------------------------
.         Check for Private Practice comments
.------------------------------------------------------------
PPCM0000  MOVE      ZERO,F1
          PACK      KEY13,URNUMBER,SP70
          CALL      RSPRCM1
          CALL      RKPRCM1
          BRANCH    OVRCD,PPCM9999
          MATCH     URNUMBER,PRCMDEBT
          GOTO      PPCM9999 IF NOT EQUAL
          MOVE      ONE,F1
PPCM9999  RETURN
+
.------------------------------------------------------------
.         Selection of Modification reason
.------------------------------------------------------------
SMRE0000  MOVE      "mr",KEY2
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
SMRE2000  CALL      RDKCODE2
          BRANCH    OVRCD,SMRE9999
          MATCH     KEY2,TCODE
          GOTO      SMRE9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      SMRE2000 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      SMRE2000 IF EQUAL      * In-active
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,SMRE2000
            ENDIF
          ENDIF
.
          MATCH     "S",TCINDC1
          GOTO      SMRE4000 IF EQUAL      * a valid mod.reason code
          MATCH     "R",TCINDC1
          GOTO      SMRE4000 IF EQUAL      * a valid mod.reason code
          MATCH     "C",TCINDC1
          GOTO      SMRE2000 IF NOT EQUAL  * not a valid mod.reason code
.
SMRE4000  PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          GOTO      SMRE2000
.
SMRE9999  RETURN
+
.------------------------------------------------------------
.   Miscellaneous tags     
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300,MISC1400,MISC1500:
                             MISC1600,MISC1700,MISC1800,MISC1900,MISC2000:
                             MISC2100,MISC2200,MISC2300,MISC2400,MISC2500:
                             MISC2600,MISC2700,MISC2800,MISC2900,MISC3000:
                             MISC3100,MISC3200,MISC3300,MISC3400,MISC3500:
                             MISC3600,MISC3700,MISC3800,MISC3900,MISC4000:
                             MISC4100,MISC4200,MISC4300,MISC4400,MISC4500:
                             MISC4600,MISC4700,MISC4800,MISC4900,MISC5000:
                             MISC5100,MISC5200,MISC5300,MISC5400,MISC5500
          GOTO      MISC9999
.
MISC0100  CALL      FESTF000               * Fees Estimate Theatre Fees
          GOTO      MISC9999
.
MISC0200  WRITE     HTMLFILE;PINVSYS;
          GOTO      MISC9999
.
MISC0300  WRITE     HTMLFILE;CNAME;
          GOTO      MISC9999
.
MISC0400  WRITE     HTMLFILE;CMXFLG;
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;PTCNQUM1;
          GOTO      MISC9999
.
MISC0600  WRITE     HTMLFILE;PTCNQUM2;
          GOTO      MISC9999
.
MISC0700  MOVE      INVOICEN,FORM8
.
          PACK      KEY22,ADMISSNO,FORM8,SP70
          CALL      RSNZPIC1
          CALL      RKNZPIC1
          BRANCH    OVRCD,MISC0750
.
          MATCH     ADMISSNO,NZPIADMN
          GOTO      MISC0750 IF NOT EQUAL
.
          COMPARE   INVOICEN,FORM8
          GOTO      MISC0750 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * Yes related provider contract adm
          GOTO      MISC9999
.
MISC0750  WRITE     HTMLFILE;ZERO;          * Not a releated provider adm
          GOTO      MISC9999
.
MISC0800  CALL      SELGST00                * Selection of GST
          GOTO      MISC9999
.
MISC0900  WRITE     HTMLFILE;QUOTENUM;
          GOTO      MISC9999
.
MISC1000  MOVE      SP3,YESNO
          MATCH     "1",PTELFINC
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          MATCH     "0",PTELFINC
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      MISC9999
.
MISC1100  COMPARE   ZERO,PTELXCSS
          IF        !@EQUAL
            WRITE     HTMLFILE;PTELXCSS;
          ENDIF
          GOTO      MISC9999
.
MISC1200  MOVE      SP70,KEY5
          MATCH     "1",PTELSPEA
          IF        @EQUAL
            MOVE      YES,KEY5
          ENDIF
          MATCH     "0",PTELSPEA
          IF        @EQUAL
            MOVE      NO,KEY5
          ENDIF
          MATCH     "2",PTELSPEA
          IF        @EQUAL
            MOVE      "Query",KEY5
          ENDIF
          WRITE     HTMLFILE;KEY5;
          GOTO      MISC9999
.
MISC1300  MOVE      SP3,YESNO
          MATCH     "1",PTELQLPS
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF     
          MATCH     "0",PTELQLPS
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF     
          WRITE     HTMLFILE;YESNO;
          GOTO      MISC9999
.
MISC1400  WRITE     HTMLFILE;PTELPHSP;
          GOTO      MISC9999
.
MISC1500  WRITE     HTMLFILE;PTELPHSU;
          GOTO      MISC9999
.
MISC1600  READ      CONTROLF,HUND12;*112,PTCNAFIP
          MATCH     "1",PTCNAFIP            * must be on preadmission?
          IF        @EQUAL
            COMPARE   ONE,MISSFLAG
            GOTO      MISC1610 IF EQUAL
            COMPARE   ONE,ASTAT
            GOTO      MISC1610 IF NOT EQUAL
          ENDIF
          WRITE     HTMLFILE;ZERO;          * ok to load (valid preadmission)
          GOTO      MISC9999
.
MISC1610  WRITE     HTMLFILE;ONE;           * don't load page
          GOTO      MISC9999
.
MISC1700  CALL      STFORM00                * stationery code selection
          GOTO      MISC9999
.
MISC1800  CALL      GDSCOD00                * get default stationery code
          GOTO      MISC9999
.
MISC1900  WRITE     HTMLFILE;PTELECMN       * eligibility comments
          GOTO      MISC9999
.
MISC2000  WRITE     HTMLFILE;PTELXCMN       * exclusion comments
          GOTO      MISC9999
.
MISC2100  WRITE     HTMLFILE;PTMXCELL       * Patient's Mobile phone (PATMX1FD)
          GOTO      MISC9999
.
MISC2200  CALL      FESPR000               * Fees Estimate Theatre Prosthetics
          GOTO      MISC9999
.
MISC2300  CALL      FESPH000               * Fees Estimate Theatre Pharmacy
          GOTO      MISC9999
.
MISC2400  CALL      IBACLOCK
          PACK      EXPIRYDT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",EXPIRYDT
          ADD       NINTY,EXPIRYDT
.
          UNPACK    EXPIRYDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2500  WRITE     HTMLFILE;INVOICEN;
          GOTO      MISC9999
.
MISC2600  MOVE      ONE,FESTINDC
MISC2605  PACK      KEY5,ANSF,ANSE,SP70
          CALL      RDSCODE1
MISC2610  CALL      RDKCODE1
          BRANCH    OVRCD,MISC9999
.
          MATCH     "FE",TCODE              * get codes from cat FE
          GOTO      MISC9999 IF NOT EQUAL
.
          MOVE      TCINDC1,F2
          COMPARE   FESTINDC,F2             * check indc1 for print order
          GOTO      MISC2610 IF NOT EQUAL
.
          MATCH     "E",TCINDC2             * only want 'Estimate' codes (indc2)
          IF        !@EQUAL
            MATCH     " ",TCINDC2           * blank is ok
            GOTO      MISC2610 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td class=HeadingRow>",TDESC,"</td></tr>"
.
          BRANCH    PMFETFLG,MISC2610
.
          WRITE     HTMLFILE;"<tr><td>";
          PACK      KEY6,ACODE,SP70
          CALL      RSPMFET1
MISC2620  CALL      RKPMFET1
          BRANCH    OVRCD,MISC2630
.
          MATCH     ACODE,PMFETYPE
          GOTO      MISC2630 IF NOT EQUAL
.
          STRIP     PMFETEXT
          MOVELPTR  PMFETEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      PMFETEXT,VAR
          WRITE     HTMLFILE;VAR            * display text detail
          SFORMAT   VAR,127
          GOTO      MISC2620
.
MISC2630  WRITE     HTMLFILE;"</td></tr>"
          ADD       ONE,FESTINDC
          GOTO      MISC2605
.
MISC2700  COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            SQUEEZE   WBSEHOSP
            WRITE     HTMLFILE;*+,WBSEHOSP;
            RESET     WBSEHOSP
          ELSE
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD<>1
              SQUEEZE   PTHSHOSP
              WRITE     HTMLFILE;*+,PTHSHOSP;
              RESET     PTHSHOSP
            ENDIF
          ENDIF
.
          GOTO      MISC9999
.
MISC2800  MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC2900  CALL      FESCN000               * Fees Estimate Consumables
          GOTO      MISC9999
.
MISC3000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMCL0000                * Eclipse other claimant tags
          GOTO      MISC9999
.
MISC3100  CALL      ESTF0000
          GOTO      MISC9999
.
MISC3200  WRITE     HTMLFILE;PTINAPIN;      * Account paid indicator
          GOTO      MISC9999
.
MISC3300  WRITE     HTMLFILE;PMVXUD15;       * UDF 15
          GOTO      MISC9999
.
MISC3400  CALL      ECBB0000                 * Eclipse Bulk Billing
          GOTO      MISC9999
.
MISC3500  MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          IF        OVRCD=0
            IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
              MOVE      ONE,FORM1            * Patient Only invoice
            ENDIF
          ENDIF
          WRITE     HTMLFILE;FORM1;
          GOTO      MISC9999
.
MISC3600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MISC3610,MISC3620
.
          MOVE      PTELXCLS,KEY1
          CALL      DNOYES00              * Yes/No option
          GOTO      MISC9999
.
MISC3610  MOVE      SP3,YESNO
          MATCH     "1",PTELXCLS
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          MATCH     "0",PTELXCLS
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      MISC9999
.
MISC3620  WRITE     HTMLFILE;PTELXCLS;
          GOTO      MISC9999
.
MISC3700  WRITE     HTMLFILE;PTELHFPN;
          GOTO      MISC9999
.
MISC3800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MISC3810,MISC3820
.
          MOVE      PTELQLPS,KEY1
          CALL      DNOYES00              * Yes/No option
          GOTO      MISC9999
.
MISC3810  MOVE      SP3,YESNO
          MATCH     "1",PTELQLPS
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          MATCH     "0",PTELQLPS
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      MISC9999
.
MISC3820  WRITE     HTMLFILE;PTELQLPS;
          GOTO      MISC9999
.
MISC3900  WRITE     HTMLFILE;PTELCMPL;
          GOTO      MISC9999
.
MISC4000  MATCH     PTELRDAT,SP70
          GOTO      MISC9999 IF EQUAL
          UNPACK    PTELRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC4100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MISC4110,MISC4120
.
          MOVE      PTELFINC,KEY1
          CALL      DNOYES00              * Yes/No option
          GOTO      MISC9999
.
MISC4110  MOVE      SP3,YESNO
          MATCH     "1",PTELFINC
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          MATCH     "0",PTELFINC
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      MISC9999
.
MISC4120  WRITE     HTMLFILE;PTELFINC;
          GOTO      MISC9999
.
MISC4200  IF        VISITTYP = 4
            WRITE     HTMLFILE;PRINCTIM;
          ELSE
            WRITE     HTMLFILE;PTINCTIM;       * Invoice record time created
          ENDIF
          GOTO      MISC9999
.
MISC4300  CALL      DRGV0000                 * DRG Versions list
          GOTO      MISC9999
.
MISC4400  CALL      WBSM0000
          GOTO      MISC9999
.
MISC4500  CALL      IMWRCV00
          GOTO      MISC9999
.
MISC4600  CALL      WBSH0000
          GOTO      MISC9999
.
MISC4700  CALL      IHWRCV00
          GOTO      MISC9999
.
MISC4800  CALL      PCWRCV00
          GOTO      ENQI9999
.
MISC4900  CALL      WBSB0000
          GOTO      ENQI9999
.
MISC5000  CALL      INTS0000                * Patient Invoice tablesorting
          GOTO      ENQI9999
.
MISC5100  CALL      FDISC000                * Fees Estimate Discount
          GOTO      MISC9999
.
MISC5200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      CTXT0000                * Fees Estimate Comments
          GOTO      MISC9999
.
MISC5300  CALL      HLDINV00                * Hold Invoice Audit List
          GOTO      MISC9999
.
MISC5400  MOVE      ZERO,F1
          PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "11",PTCDUDF6
            IF        @EQUAL
              MOVE      ONE,F1           * Mental Health Event
            ENDIF
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      MISC9999
.
MISC5500  CALL      WDVA0000
          GOTO      ENQI9999
.
MISC9999  RETURN
+
.------------------------------------------------------------
.         Fees Estimate Comments text
.------------------------------------------------------------
CTXT0000  BRANCH    PMFETFLG,CTXT9999
.
          MOVE      SP70,CLMINDIC
          PACK      PMFDCLTY,PMFDCLTY,SP70
          MATCH     SP70,PMFDCLTY
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PMFDCLTY
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC25,CLMINDIC      * Claim code ind25
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSF,ANSE,SP70
          CALL      RDSCODE1
CTXT2610  CALL      RDKCODE1
          BRANCH    OVRCD,MISC9999
.
          MATCH     "FE",TCODE              * get codes from cat FE
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     "E",TCINDC2             * only want 'Estimate' codes (indc2)
          IF        !@EQUAL
            MATCH     " ",TCINDC2           * blank is ok
            GOTO      CTXT2610 IF NOT EQUAL
          ENDIF
.
.         F1=0 for Insurance box, F1=1 for Comments box
.
          BRANCH    F1,CTXT2614,CTXT2616
          GOTO      CTXT2610
.
CTXT2614  MATCH     "I",TCINDC4
          GOTO      CTXT2610 IF NOT EQUAL
          GOTO      CTXT2618
.
CTXT2616  MATCH     SP70,TCINDC4
          GOTO      CTXT2610 IF NOT EQUAL
.
.         Check Cat FE ind3 against claim code ind25
.
CTXT2618  MATCH     SP70,TCINDC3
          IF        !@EQUAL
            MATCH     TCINDC3,CLMINDIC
            GOTO      CTXT2610 IF NOT EQUAL
          ENDIF
.
.         WRITE     HTMLFILE;"<tr><td class=HeadingRow>",TDESC,"</td></tr>"
.
          WRITE     HTMLFILE;"<tr><td>";
          PACK      KEY6,ACODE,SP70
          CALL      RSPMFET1
CTXT2620  CALL      RKPMFET1
          BRANCH    OVRCD,CTXT2630
.
          MATCH     ACODE,PMFETYPE
          GOTO      CTXT2630 IF NOT EQUAL
.
          STRIP     PMFETEXT
          MOVELPTR  PMFETEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      PMFETEXT,VAR
          WRITE     HTMLFILE;VAR            * display text detail
          SFORMAT   VAR,127
          GOTO      CTXT2620
.
CTXT2630  WRITE     HTMLFILE;"</td></tr>"
          GOTO      CTXT2610
.
CTXT9999  RETURN
+
.------------------------------------------------------------
.         Hold Invoice Audit List
.------------------------------------------------------------
HLDINV00  MOVE      "0",HDINVFLG 
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPTONH1
HLDINV10  CALL      RPPTONH1
          BRANCH    OVRCD,HLDINV90
          MATCH     ADMISSNO,PTONVISN
          GOTO      HLDINV90 IF NOT EQUAL
          MOVE      "1",HDINVFLG
.
.         Date & Time
.
          UNPACK    PTONTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM30,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Update Type
.
          PACK      ACTION,SP70
          MATCH     "A",PTONHACT
          IF        @EQUAL
            MOVE      "Patient Hold",ACTION   
          ENDIF
.
          MATCH     "C",PTONHACT
          IF        @EQUAL
            MOVE      "Claim Code Hold",ACTION   
          ENDIF
          MATCH     "F",PTONHACT
          IF        @EQUAL
            MOVE      "Health Fund Hold",ACTION   
          ENDIF
.
          MATCH     "L",PTONHACT
          IF        @EQUAL
            MOVE      "Updated by HL7 Receiver",ACTION
          ENDIF
.
          MATCH     "U",PTONHACT
          IF        @EQUAL
            MOVE      "Updated by Health Fund",ACTION
          ENDIF
.
          MATCH     "G",PTONHACT
          IF        @EQUAL
            MOVE      "Updated by Claim Code",ACTION
          ENDIF
.
          MATCH     "M",PTONHACT
          IF        @EQUAL
            MOVE      "Deleted by HL7 Receiver",ACTION
          ENDIF
.
          MATCH     "D",PTONHACT
          IF        @EQUAL
            MOVE      "Deleted by Health Fund",ACTION
          ENDIF
.
          MATCH     "H",PTONHACT
          IF        @EQUAL
            MOVE      "Deleted by Claim Code",ACTION
          ENDIF
.
          MATCH     "R",PTONHACT
          IF        @EQUAL
            MOVE      "Removed Hold for Visit",ACTION
          ENDIF
.
          MATCH     "T",PTONHACT
          IF        @EQUAL
            MOVE      "Updated Hold for Visit",ACTION
          ENDIF
.
.         Performed By
.
          MOVE      SP70,PERFBY
          PACK      KEY10,PTONURID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ELSE
            MOVE      WBSENAM,PERFBY
          ENDIF
.          
.         Reason for Hold Invoice
.
          PACK      KEY5,CODERH,PTONREAH,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PTONREAH,HDREASON
          ELSE
            MOVE      TDESC,HDREASON
          ENDIF
.         
.         Hold Invoice From Date
.
          MATCH     PTONHLIN,SP70
          IF        !@EQUAL
            UNPACK    PTONHLIN,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM30A,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ELSE
            MOVE      SP70,DIM30A
          ENDIF
.
          MATCH     "R",PTONHACT
          GOTO      HLDINV60 IF EQUAL
          MATCH     "D",PTONHACT
          GOTO      HLDINV60 IF EQUAL
          MATCH     "H",PTONHACT
          GOTO      HLDINV60 IF EQUAL
          MATCH     "M",PTONHACT
          GOTO      HLDINV60 IF EQUAL
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",DIM30," at ",PTONTTIM,"</td>":
                             "<td>",ACTION,"</td>":
                             "<td>",PERFBY,"</td>":
                             "<td>",HDREASON,"</td>":
                             "<td>",PTONDESC,"</td>":
                             "<td>",PTONCLCD,"</td>":
                             "<td>",PTONHLFU,"</td>":
                             "<td>",DIM30A,"</td>":
                             "</tr>"
          GOTO      HLDINV10
.
HLDINV60  WRITE     HTMLFILE;"<tr>":
                               "<td>",DIM30," at ",PTONTTIM,"</td>":
                               "<td>",ACTION,"</td>":
                               "<td>",PERFBY,"</td>":
                               "<td><del>",HDREASON,"</del></td>":
                               "<td><del>",PTONDESC,"</del></td>":
                               "<td><del>",PTONCLCD,"</del></td>":
                               "<td><del>",PTONHLFU,"</del></td>":
                               "<td><del>",DIM30A,"</del></td>":
                               "</tr>"
          GOTO      HLDINV10
                                 
HLDINV90  MATCH     "0",HDINVFLG
          GOTO      HLDINV99 IF NOT EQUAL
          WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No records to display</td>"
.
HLDINV99  MOVE      SP70,ACTION
          MOVE      SP70,PERFBY
          MOVE      SP70,HDREASON
          RETURN
+
.------------------------------------------------------------
.         DRG Version list
.------------------------------------------------------------
DRGV0000  PACK      KEY8,ADMISSNO,SP70      * Get visits hospital
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXMHOS        
          ENDIF                             
.
          CALL      CDRG0000                * Check Effective DRG
          CALL      DRGH0000                * Output table heading
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTPGR1
DRGV1000  CALL      RKPTPGR1
          BRANCH    OVRCD,DRGV9999
.
          MATCH     ADMISSNO,DPTPGADM       * same invoice?
          GOTO      DRGV9999 IF NOT EQUAL
.
          MOVE      SP70,ANS
          MATCH     PTHFGRPV,PTPGGPVR       * same Grouper version ?
          IF        @EQUAL
            MOVE      "*",ANS
          ENDIF
          WRITE     HTMLFILE;"<tr><td>",PTPGGPVR,"</td>":
                             "<td>&nbsp;",ANS,"</td>":
                             "<td>",PTPGNDRG,"</td>":
                             "<td>",PTPGNMDC,"</td>":
                             "<td>",PTPGSDRG,"</td>":
                             "<td>",PTPGSMDC,"</td>":
                             "<td>",PTPGLDRG,"</td>":
                             "<td>",PTPGLMDC,"</td>":
                             "</tr>"
          GOTO      DRGV1000
.
DRGV9999  RETURN
+
.------------------------------------------------------------
. Get effective DRG
.------------------------------------------------------------
CDRG0000  MOVE      SP70,PTHFGRPV
          READ      CONTROLF,HUND24;*121,PTCNDGED
.
          MATCH     "1",PTCNDGED
          GOTO      CDRG1000 IF EQUAL
.
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,ZERO8
            CALL      RDFUND1
          ELSE
            PACK      KEY5,ANSC,ANSL,ACLAIM
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      PTCDGRPV,PTHFGRPV       * Use claim code grouper version
            ENDIF
          ENDIF
.
          MATCH     SP70,PTHFGRPV
          IF        @EQUAL
            READ      CONTROLF,HUND05;*158,PTCNDGPV
            MOVE      PTCNDGPV,PTHFGRPV         * Use the Default Grouper vers.
          ENDIF
.
          GOTO      CDRG9999
.
.         Get DRG Version using 'Effective DRG' table
.
CDRG1000  CALL      GTEDRG00
          IF        EXIT=0
            MOVE      KEY3,PTHFGRPV
          ELSE
            READ      CONTROLF,HUND05;*158,PTCNDGPV
            MOVE      PTCNDGPV,PTHFGRPV         * Use the Default Grouper vers.
          ENDIF
.
CDRG9999 RETURN
+
.------------------------------------------------------------
. DRG Version heading
.------------------------------------------------------------
DRGH0000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=12%>":
                               "<b>DRG Ver</b></td>":
                               "<td class=HeadingCell width=4%>":
                               "<b>Fund</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>Nat DRG</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>Nat MDC</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>State DRG</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>State MDC</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>Local DRG</b></td>":
                               "<td class=HeadingCell width=14%>":
                               "<b>Local MDC</b></td>":
                             "</tr>"
.
DRGH9999  RETURN
+
.------------------------------------------------------------
. GST Code Selection
.------------------------------------------------------------
SELGST00  PACK      KEY6,SP70
          OPEN      IBAGSTA1,"ibagstaf"
          CALL      RAIBGS1
SELGST10  CALL      RKIBGS1
          BRANCH    OVRCD,SELGST99
          PACK      KEY8,QUOTE,IBGSCODE,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY8,">":
                             IBGSDESC,"</option>"
          GOTO      SELGST10
SELGST99  RETURN
.
.------------------------------------------------------------
.  Show Fees Estimate Theatre Fees
.------------------------------------------------------------
FESTF000  MOVE      ZERO,COUNTER
          MOVE      QUOTENUM,KEY12
.
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            MOVE      "5",KEY1                * Only pick up Theatre Fee
          ELSE
            MOVE      "3",KEY1                * Only pick up Theatre Fee
          ENDIF
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
FESTF100  CALL      RKPMFES2
          BRANCH    OVRCD,FESTF999
.
          MATCH     KEY12,PMFSQUOT
          GOTO      FESTF999 IF NOT EQUAL
.
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            COMPARE   FIVE,PMFSRTYP           * Only pick up Theatre Fee
            GOTO      FESTF999 IF NOT EQUAL
          ELSE
            COMPARE   THREE,PMFSRTYP          * Only pick up Theatre Fee
            GOTO      FESTF999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY17,PMFSTHIT,SP70
          CALL      PATITMRD
          IF        OVRCD=1
            MOVE      "Unknown Code",IDESC
          ENDIF
          ADD       ONE,COUNTER
          WRITE     HTMLFILE;"<tr><td class=DataLabel>Theatre Fee Code":
                             COUNTER,"</td>":
                             "<td class=DataField>",PMFSTHIT," - ":
                             IDESC,"</td></tr>";
          GOTO      FESTF100
.
FESTF999  RETURN
.
+
.------------------------------------------------------------
.   Redirect to invoice details screen
.------------------------------------------------------------
RDIR0000  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          REP       " +",DIM8
          UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&visittyp=",VISITTYP:
                                 "&invoicen=",DIM8;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
RDIR9999  RETURN
+
.------------------------------------------------------------
.   Check if it's the Last invoice
.------------------------------------------------------------
LINV0000  MOVE      SP8,LSTACCM
          MOVE      SP8,STRACCM
          MOVE      ZERO,FORM1
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,LINV8100
.
          MATCH     "1",PTINCRST
          GOTO      LINV8100 IF EQUAL          * Fully credited
.
          MOVE      PINVADM,KEY8
          BRANCH    PINVSYS,LINV0100,LINV3000,LINV0300
          GOTO      LINV8100
.
.         Emergency
.
LINV0100  CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      RDPMEVT1
            BRANCH    OVRCD,LINV8100
            MOVE      PMEVADTE,EMVIDATE
          ENDIF
          MATCH     "00000000",EMVIDATE
          GOTO      LINV8100 IF EQUAL          * Take up outstanding debts
          GOTO      LINV3000
.
.         Inpatient
.
LINV0300  CALL      RDMISS1
          BRANCH    OVRCD,LINV8100
          MATCH     "00000000",ADATE
          GOTO      LINV8100 IF EQUAL          * Take up outstanding debt
.
          MOVE      FORM8,KEY8
          PACK      KEY22 WITH ADMISSNO,KEY8,SP6
          CALL      RDSDTRN1
LINV1000  CALL      RDKDTRN1
          BRANCH    OVRCD OF LINV2000
.
          MATCH     AADMNO,TADMNO
          GOTO      LINV2000 IF NOT EQUAL
.
          MATCH     TREF,KEY8
          GOTO      LINV2000 IF NOT EQUAL
.
.         Check if there is any accomodation record
.
          COMPARE   ONE,TRECTYPE
          GOTO      LINV1000 IF NOT EQUAL
.
          PACK      LSTACCM,TTCENT,TTYEAR,TTMONTH,TTDAY   * end of accom.date
          REP       " 0",LSTACCM
.
          MATCH     SP8,STRACCM
          GOTO      LINV1000 IF NOT EQUAL
.
          PACK      STRACCM,TFCENT,TFYEAR,TFMONTH,TFDAY   * start of accom.date
          REP       " 0",STRACCM
          GOTO      LINV1000
.
LINV2000  MATCH     SP8,LSTACCM
          GOTO      LINV3000 IF EQUAL
.
.         Check if this accomodation record is the last invoice with accomn.
.
          MATCH     ALACDTE,LSTACCM
          GOTO      LINV8100 IF NOT EQUAL
.
LINV3000  MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          MOVE      "0",KEY1                * flag for inpatient
          MOVE      PINVUR,SAVURNUM
          CALL      CSJR0000                * Check if cash & journal balanced
          BRANCH    EXIT,LINV8000
          GOTO      LINV9999
.
LINV8000  MOVE      "1",FORM1                 * Invoice got payment/journal
          GOTO      LINV9999
.
LINV8100  MOVE      "2",FORM1                 * not the last accom.date
          GOTO      LINV9999
.
LINV9999  RETURN
+
.------------------------------------------------------------------------------
.      Check if receipt/payment balances with Journals                         
.------------------------------------------------------------------------------
CSJR0000 MOVE      ZERO,EXIT
         MOVE      ZERO,FORM9P2
         PACK      KEY29,SAVKEY12,SP70
         CALL      RSRCDTE3
CSJR1000 CALL      RKRCDTE3
         BRANCH    OVRCD,CSJR2000
.
         MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
         GOTO      CSJR2000 IF NOT EQUAL
.
         MATCH     SAVURNUM,RCDTURNO       * Same U/R ?
         GOTO      CSJR1000 IF NOT EQUAL
.
         MOVE      RCDTREGI,KEY3
         CALL      RDREGA1
         BRANCH    OVRCD,CSJR1000
.
         MATCH     "1",KEY1                * Private practice has rcdtsflg=1
         IF        @EQUAL
           COMPARE   "2",REGIBACD
           GOTO      CSJR1200 IF EQUAL     * PRI receipt
           COMPARE   "96",REGIBACD
           GOTO      CSJR1000 IF NOT EQUAL * Not PRI deposit
         ELSE
           COMPARE   ONE,REGIBACD          * Inp/Out/EMR might have 0 or blank
           GOTO      CSJR1200 IF EQUAL
           COMPARE   "90",REGIBACD
           GOTO      CSJR1200 IF EQUAL     * EMR Deposit
           COMPARE   "91",REGIBACD
           GOTO      CSJR1200 IF EQUAL     * OUT Deposit
           COMPARE   "97",REGIBACD
           GOTO      CSJR1000 IF NOT EQUAL * Not IP Deposit
         ENDIF
.
CSJR1200 PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,CSJR1000
         MATCH     "1",RCBNSTAT
         GOTO      CSJR1000 IF EQUAL       * Receipt cancelled
.
         ADD       RCDTAMNT,FORM9P2
         GOTO      CSJR1000
.
CSJR2000 MOVE      PINVJOUR,FORM12P2
         ADD       PTINGSTJ,FORM12P2
         COMPARE   FORM12P2,FORM9P2
         GOTO      CSJR9999 IF EQUAL
         MOVE      ONE,EXIT
CSJR9999 RETURN
+
.------------------------------------------------------------
.   Check if it's the Last PP invoice
.------------------------------------------------------------
PPLINV00  MOVE      SP8,LSTACCM
          MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PPLINV81
          MATCH     "1",PRINCNST
          GOTO      PPLINV81 IF EQUAL          * Fully credited
.
          MOVE      PRINJAMT,PINVJOUR
          MOVE      PRINGSTJ,PTINGSTJ
          MOVE      INVOICEN,SAVKEY12
          MOVE      "1",KEY1                  * flag for private practice
          MOVE      PRINDEBT,SAVURNUM
          CALL      CSJR0000                  * Check for any Cash/Deposit
          BRANCH    EXIT,PPLINV80
          GOTO      PPLINV90
.
PPLINV80  MOVE      "1",FORM1                 * Invoice got payment/journal
          GOTO      PPLINV90
.
PPLINV81  MOVE      "2",FORM1                 * Fully credited             
          GOTO      PPLINV90
.
PPLINV90  WRITE     HTMLFILE;FORM1;
PPLINV99  RETURN
+
.------------------------------------------------------------
.   Reason for credit card
.------------------------------------------------------------
REAS0000  MOVE      "BX",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      REAS9999
REAS9999  RETURN
+
.------------------------------------------------------------
.   Check if any item in the invoice
.------------------------------------------------------------
GMSC0000  MOVE      ZERO,FORM1
          MOVE      ZERO,CREDITEM
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          PACK      KEY22 WITH ADMISSNO,PINVNO,SP6
          CALL      RSDTR000
GMSC1000  CALL      RKDTR000
          BRANCH    OVRCD OF GMSC9000
          MATCH     ADMISSNO,DTADMNO
          GOTO      GMSC9000 IF NOT EQUAL
.
          MATCH     TREF,PINVNO
          GOTO      GMSC9000 IF NOT EQUAL
.
.         Check if there is any item for this invoice
.
          BRANCH    TRECTYPE,GMSC1000,GMSC2000,GMSC2000
          IF        CFEETYP<>5 & PINVSYS=1
            COMPARE   EIGHT,TRECTYPE        * Check for EMR Event procedure
            GOTO      GMSC2000 IF EQUAL
          ENDIF
          GOTO      GMSC1000
.
GMSC2000  MOVE      ONE,FORM1               * Found theatre or misc.item
GMSC9000  WRITE     HTMLFILE;FORM1;
.
GMSC9999  RETURN
+
.------------------------------------------------------------
.   Keep items request    
.------------------------------------------------------------
KEEP0000  WRITE     HTMLFILE;"<option value=#"",ONE,"#" selected>Keep":
                               "</option>":
                             "<option value=#"",TWO,"#">Delete":
                               "</option>";
          GOTO      REAS9999
KEEP9999  RETURN
+
.------------------------------------------------------------
.   List of invoice details for credit by item
.------------------------------------------------------------
DCRI0000  MOVE      ZERO,FORM3 
          MOVE      ZERO,TOTTCRD
          MOVE      ZERO,TOTTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          CALL      DISHD000      * Output Table Heading
.
          MOVE      ONE,CREDITEM  * read index 4 of patdtraf file
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,PINVNO
          PACK      KEY22 WITH ADMISSNO,PINVNO,SP6
          PACK      KEY23 WITH ADMISSNO,PINVNO,SP70
          CALL      RSDTR000
DCRI1000  CALL      RKDTR000
          BRANCH    OVRCD OF DCRI2000
          MATCH     ADMISSNO,DTADMNO
          GOTO      DCRI2000 IF NOT EQUAL
.
          MATCH     TREF,PINVNO
          GOTO      DCRI2000 IF NOT EQUAL
.
          IF        CFEETYP=5
.
.         NZ private only display misc.item 
.
            BRANCH    TRECTYPE,DCRI1000,DCRI1000,DCRI1020
.
          ELSE
.
.           Only display misc. and theatre items, No Credit notes on Procedure
.
            BRANCH    TRECTYPE,DCRI1000,DCRI1200,DCRI1100
          ENDIF
.
          GOTO      DCRI1000
.
.         NZ private - check for Win/Loss file
.
DCRI1020  COMPARE   THREE,PINVSYS
          GOTO      DCRI1200 IF NOT EQUAL
.
.         save DTR transaction number to nzprdtaf if necessary for
.         credit note by item (incase we need to read to patdtraf from nzprdtaf)
.
          PACK      SKEY23,DTADMNO,TREF,DTRECTYP,TTRANSN1,SP70
          MOVE      TREF,KEY8
          MOVE      TTRANSN1,KEY6
          MOVE      TITEMNO,KEY9
          CALL      CRDT0000
.
          MOVE      SKEY23,KEY23
          CALL      RDDTRN4                  * reposition
          GOTO      DCRI1200
.
DCRI1100  COMPARE   ONE,PINVSYS
          GOTO      DCRI1200 IF NOT EQUAL   * Not Emergency patient
          MATCH     SP70,TITEMNO
          GOTO      DCRI1000 IF EQUAL       * Skip facility fees
.
DCRI1200  CALL      DISRW000    * Display Row
          GOTO      DCRI1000
.
DCRI2000  MOVE      "        0",KEY10
          MOVE      TOTTCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td align=right><b>",KEY10,"</b></td>";
.
          IF        CFEETYP=5   
            COMPARE   THREE,IBCNUGST
            GOTO      DCRI4000 IF EQUAL         * GST on Invoice Total
          ENDIF     
.
          MOVE      "        0",KEY10
          MOVE      TOTTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
DCRI4000  MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        CFEETYP=5
            COMPARE   THREE,IBCNUGST
            GOTO      DCRI6000 IF EQUAL         * GST on Invoice Total
          ENDIF
.
          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td>";
.           
DCRI6000  WRITE     HTMLFILE;"</tr>";
.
DCRI9999  RETURN
.
.------------------------------------------------------------
.         Update DTR transaction to nzprdtaf file
.------------------------------------------------------------
CRDT0000  PACK      KEY22,DTADMNO,TREF,SP70
          CALL      RSNZRDT1
CRDT1000  CALL      RKNZRDT1
          BRANCH    OVRCD,CRDT9999
          MATCH     DTADMNO,ADMISSNO
          GOTO      CRDT9999 IF NOT EQUAL      * different admission number
          MATCH     TREF,KEY8
          GOTO      CRDT9999 IF NOT EQUAL      * different invoice
          MATCH     TITEMNO,KEY9
          GOTO      CRDT1000 IF NOT EQUAL      * not same item
.
          MATCH     SP70,TDOCTO
          GOTO      CRDT1000 IF NOT EQUAL      * use this field for DTR trans.no
.
          PACK      TDOCTO,KEY6,SP70      * DTR trans.no for Creditnote by item
          CALL      UPNZRDT1
.
CRDT9999  RETURN
.
.------------------------------------------------------------
. Credit note (TABLE HEADING)
.------------------------------------------------------------
DISHD000  IF        CFEETYP=5
            COMPARE   THREE,IBCNUGST
            GOTO      DISHD200 IF EQUAL         * GST on Invoice Total
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Date</td>":
                               "<td class=HeadingCell width=20%>":
                               "Description</td>":
                               "<td class=HeadingCell width=8%>":
                               "Item</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Exc.GST</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "GST</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Current Credit</td>":
                               "<td align=right class=HeadingCell>":
                               "New Credit</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Current Cr GST</td>":
                               "<td align=right class=HeadingCell>":
                               "New Credit GST</td>":
                             "</tr>"
          GOTO      DISHD999
.
DISHD200  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell >":
                               "Date</td>":
                               "<td class=HeadingCell >":
                               "Description</td>":
                               "<td class=HeadingCell >":
                               "Item</td>":
                               "<td align=right class=HeadingCell >":
                               "Item Amount</td>":
                               "<td align=right class=HeadingCell >":
                               "Current Credit</td>":
                               "<td align=right class=HeadingCell >":
                               "New Credit</td>":
                             "</tr>"
.
DISHD999  RETURN
.------------------------------------------------------------
. Display invoice row (TABLE ROW)
.------------------------------------------------------------
DISRW000  ADD       ONE,FORM3   * Increment parameter counter
          MOVE      FORM3,KEY3
          REP       " 0",KEY3 
.
          MOVE      DTFCENT,CCENT
          MOVE      DTFYEAR,CYEAR
          REP       " 0",CCENT
          REP       " 0",CYEAR
          MOVE      DTFMONTH,CMON
          MOVE      DTFDAY,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
          MOVE      "        0",KEY10
          MOVE      TPATAMTT,FORM72
          MOVE      FORM72,KEY10
.
          CALL      GCCR0000               * Get previous amount of credit note
          MOVE      TPATAMTT,FORM72
          ADD       TOTAMT,FORM72          * maximum credit
.
          MOVE      PTDTGSTM,FORM7P2
          ADD       TOTGST,FORM7P2         * maximum gst
.
          WRITE     HTMLFILE;"<input type=hidden name=trano",KEY3," value=#"":
                             TTRANSN1,"#">":
                             "<input type=hidden name=maxcr",KEY3," value=#"":
                             FORM72,"#">":
                             "<input type=hidden name=maxgs",KEY3," value=#"":
                             FORM7P2,"#">":
                             "<tr><td>",STRDATE,"</td>";
.
          IF        CFEETYP=5
            PACK      KEY65,TDDESC,PTDTDES2,SP70
            WRITE     HTMLFILE;"<td>",KEY65,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",TDDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",TITEMNO,"</td>":
                             "<td align=right>",KEY10,"</td>";
.
          IF        CFEETYP=5
            COMPARE   THREE,IBCNUGST
            GOTO      DISRW200 IF EQUAL         * GST on Invoice Total
          ENDIF
.
          MOVE      "        0",KEY10
          MOVE      PTDTGSTM,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
DISRW200  MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>":
                             "<input type=text name=cramt",KEY3:
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                         "onchange='checkCRD(cramt",KEY3,",maxcr",KEY3,")' >":
                             "</td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72
          MOVE      FORM72,KEY10
.
          IF        CFEETYP=5
            COMPARE   THREE,IBCNUGST
            GOTO      DISRW400 IF EQUAL         * GST on Invoice Total
          ENDIF     
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>":
                             "<input type=text name=gsamt",KEY3:
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                         "onchange='checkCRD(gsamt",KEY3,",maxgs",KEY3,")' >":
                             "</td>";
.
DISRW400  WRITE     HTMLFILE;"</tr>";
.
          ADD       TPATAMTT,TOTTCRD
          ADD       PTDTGSTM,TOTTGST
          ADD       TOTAMT,TOTCCRD
          ADD       TOTGST,TOTCGST
.
DISRW999  RETURN
+
.------------------------------------------------------------
.   Display credit note details
.------------------------------------------------------------
DSCR0000  MOVE      ZERO,FORM3 
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          CALL      DCRHD000      * Output Table Heading
.
          MOVE      CREDITNO,KEY8
          CALL      RDPMCNO1
          BRANCH    OVRCD,DSCR9999
.
          MOVE      PMCNINVN,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,DSCR9999
.
          CALL      PCRD0000          * credit note details
.
          MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
 
          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td></tr>";
.
DSCR9999  RETURN
+
.-------------------------------------------------------------------------
.   Display credit note details
.   ABF Invoice uses index 1, so that ABF Charge will appear on first line
.-------------------------------------------------------------------------
PCRD0000  IF        PTINCMIX=3
            PACK      KEY30 WITH PINVADM,PINVNO,SP70
            CALL      RSPMFCI1
          ELSE
            PACK      KEY31 WITH CREDITNO,SP70
            CALL      RSPMFCI3
          ENDIF
PCRD2000  IF        PTINCMIX=3
            CALL      RKPMFCI1
          ELSE
            CALL      RKPMFCI3
          ENDIF
          BRANCH    OVRCD OF PCRD9999
.
          IF        PTINCMIX=3
            MATCH     CREDITNO,PMFCCRNO
            GOTO      PCRD2000 IF NOT EQUAL
          ELSE
            MATCH     CREDITNO,PMFCCRNO
            GOTO      PCRD9999 IF NOT EQUAL
          ENDIF
.
          CALL      DFRRW000    * Display Row
          GOTO      PCRD2000
PCRD9999  RETURN
+
.------------------------------------------------------------
. Display full credit note row (TABLE ROW)
.------------------------------------------------------------
DFRRW000  UNPACK    PMFCTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
          COMPARE   ONE,PTINCMIX
          GOTO      DFRRW100 IF NOT EQUAL    * Not casemix
.
          MOVE      ZERO,FORM72
          MOVE      PMFCPTLS,FORM72
          ADD       PMFCRBLS,FORM72
          COMPARE   ZERO,FORM72
          GOTO      DFRRW100 IF EQUAL      * no lumpsum amount
.
          MOVE      SP10,AFUNDH
          MOVE      ZERO,DCFLAG            * default to not daycase
          MOVE      PMFCVISN,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            IF        ASTAT=3
              CALL      RDDSCH1
              IF        OVRCD=0
                MATCH     ADATE,DDATE
                IF        @EQUAL
                  MOVE      ONE,DCFLAG     * Daycase
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
.         Get description for lumpsum
.
          MOVE      SP10,PTHFBCAT
          MATCH     SP6,AFUNDH
          IF        !@EQUAL
            OPEN      PATFN1A1,"patfn1af"
            PACK      KEY14,AFUNDH,AFNDTB
            CALL      RDFUND1
          ENDIF
.
          PACK      CMCODE,SP70
          MATCH     SP10,PTINCMCD
          IF        !@EQUAL
            PACK      CMCODE,PTINCMCD,SP70
          ENDIF
          IF        DCFLAG=1
            CALL      DLUM0000              * get desc.for daycase lumpsum
          ELSE
            CALL      OLUM0000              * get desc.for overnight lumpsum
          ENDIF
          MOVE      PMFCDESC,KEY30
          MOVE      SAVDES1,PMFCDESC
.
          PACK      KEY27,STRDATE,SP70
          MOVE      "&nbsp;   ",PMFCITEM
          MOVE      "&nbsp;      ",KEY10      * no rate
          WRITE     HTMLFILE;"<tr><td>",KEY27,"</td>":
                             "<td>",PMFCDESC,"</td>":
                             "<td>",PMFCITEM,"</td>":
                             "<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCPTLS,FORM72        * total lumpsum amount
          ADD       PMFCRBLS,FORM72
          MULT      "-1",FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCGSTL,FORM72        * GST amount
          MULT      "-1",FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCPTLS,FORM72        * total lumpsum amount
          ADD       PMFCRBLS,FORM72
          SUB       FORM72,TOTAMT
          MOVE      FORM72,KEY10
          ADD       FORM72,TOTCCRD
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCGSTL,FORM72        * GST amount
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "</tr>";
.
          SUB       PMFCGSTL,TOTGST
          ADD       PMFCGSTL,TOTCGST
          MOVE      KEY30,PMFCDESC
.
DFRRW100  MATCH     "9",PMFCRTYP
          GOTO      DFRRW120 IF EQUAL     * ABF
.  
          MATCH     "1",PMFCRTYP
          IF        @EQUAL
DFRRW120
            UNPACK    PMFCADAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
            MOVE      "to",KEY2
            PACK      KEY27,STRDATE,SP1,KEY2,SP1,KEY12,SP70
            MOVE      "        0",KEY10
            MOVE      PMFCAMTI,FORM72
            MOVE      FORM72,KEY10
            MOVE      "&nbsp;   ",PMFCITEM
          ELSE
            PACK      KEY27,STRDATE,SP70
            MOVE      "&nbsp;      ",KEY10      * no rate
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",KEY27,"</td>";
.
          IF        CFEETYP=5
            PACK      KEY65,PMFCDESC,PMFCDES2,SP70
            WRITE     HTMLFILE;"<td>",KEY65,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",PMFCDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",PMFCITEM,"</td>":
                             "<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCAMTT,FORM72        * total transaction amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCGSTM,FORM72        * GST amount
          MULT      "-1",FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCCAMT,FORM72          * total credit
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCCGST,FORM72          * total credit GST
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "</tr>";
.
          ADD       PMFCAMTT,TOTAMT
          SUB       PMFCGSTM,TOTGST
          ADD       PMFCCAMT,TOTCCRD
          ADD       PMFCCGST,TOTCGST
.
DFRRW999  RETURN
+
.------------------------------------------------------------
. Credit note (TABLE HEADING)
.------------------------------------------------------------
DCRHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Date</td>":
                               "<td class=HeadingCell>":
                               "Description</td>":
                               "<td class=HeadingCell>":
                               "Item</td>":
                               "<td align=right class=HeadingCell>":
                               "Rate</td>":
                               "<td align=right class=HeadingCell>":
                               "Total Exc.GST</td>":
                               "<td align=right class=HeadingCell>":
                               "GST</td>":
                               "<td align=right class=HeadingCell>":
                               "Credit Exc.GST</td>":
                               "<td align=right class=HeadingCell>":
                               "Credit GST</td></tr>";
.
DCRHD999  RETURN
+
.-------------------------------------------------------------
. List credit notes
.-------------------------------------------------------------
LCRD0000  MOVE      "10",NORECORD           * Numb of records=0 Default to 10
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RDSINV5
LCRD1000  CALL      RDPINV5
          BRANCH    OVRCD,LCRD9999
          MATCH     URNUMBER,PINVUR       * Same U/R ?
          GOTO      LCRD9999 IF NOT EQUAL
.
          MOVE      ZERO,SAVFLAG
          MOVE      DPINVADM,KEY8
          CALL      RDVISA1
          IF        OVRCD=1
            MOVE      ONE,SAVFLAG         * Cancelled admission
            MOVE      SP70,PVIDATE
          ENDIF
.
          PACK      KEY16,PINVNO,SP20
          CALL      RSPMCNO3
LCRD2000  CALL      RKPMCNO3
          BRANCH    OVRCD,LCRD1000
          MATCH     PINVNO,PMCNINVN        * same invoice number?
          GOTO      LCRD1000 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      LCRD2000
          ENDIF
.
          IF        SAVFLAG=1
            WRITE     HTMLFILE;"<tr><td align=left>":
                               "<font color=#FF0000><b>",PINVADM:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td align=left>",PINVADM,"</td>";
          ENDIF
.
          MOVE      DPINVADM,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MATCH     "00000000",ADATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>O/S Debt.</td>";
              GOTO      LCRD4000
            ENDIF
          ENDIF
.
          REP       " 0",PVIDATE
          MATCH     "00000000",PVIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Cancelled</td>";
          ELSE
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY  
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
LCRD4000  WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkCredit(#"":
                             PMCNCRNO,"#")'>":
                             PMCNCRNO,"</td>";
.
          REP       " 0",PMCNDATE
          UNPACK    PMCNDATE,CCENT,CYEAR,CMON,CDAY  
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      PINVAMT,FORM82
          ADD       PMCNAMNT,FORM82
          IF        CFEETYP=9 | CFEETYP=5
            IF        FORM82=PTINROUN
              SUB       PTINROUN,FORM82
              SUB       PTINROUN,PMCNAMNT
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td align=right>",PMCNAMNT,"</td>":
                             "<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",PINVNO,"</td>":
                             "<td align=right>",FORM82,"</td></tr>";
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      LCRD2000 IF NOT EQUAL
.
LCRD9999  RETURN
+
.------------------------------------------------------------
. Header of credit note
.------------------------------------------------------------
HCRD0000 WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Visit No</td>":
                               "<td class=HeadingCell width=20%>":
                               "Visit Date</td>":
                               "<td class=HeadingCell width=8%>":
                               "Credit Note #</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Credit Note Date</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Credit Note Total</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Invoice Total</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Invoice #</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Balance</td></tr>";
HCRD9999  RETURN
+
.------------------------------------------------------------
. Display Credit notes transaction for an invoice
.------------------------------------------------------------
DICR0000  MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          MOVE      ZERO,FORM1
          CALL      DIRHD000      * Output Table Heading
.
          PACK      KEY22,SP70
          PACK      KEY22A,SP70
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
.
          PACK      KEY30 WITH ADMISSNO,KEY8,SP70
          CALL      RSPMFCI1
DICR1000  CALL      RKPMFCI1
          BRANCH    OVRCD OF DICR9000
          MATCH     ADMISSNO,PMFCVISN
          GOTO      DICR9000 IF NOT EQUAL
          MATCH     KEY8,PMFCINVN
          GOTO      DICR9000 IF NOT EQUAL
.
.
          PACK      KEY22,PMFCVISN,PMFCINVN,PMFCTRAN
          MATCH     SP70,KEY22A
          GOTO      DICR2000 IF EQUAL     * first time
.
          MATCH     KEY22,KEY22A
          GOTO      DICR3000 IF EQUAL     * display credit notes details
.
          IF        FORM1=0
            MOVE      ONE,FORM1
          ELSE
            MOVE      ZERO,FORM1
          ENDIF
.
.         Display transaction details
.
DICR2000  
          IF        FORM1=0
            WRITE     HTMLFILE;"<tr>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>";
          ENDIF
.
          MOVE      KEY22,KEY22A          * save transaction key
.
          UNPACK    PMFCTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
          MATCH     "9",PMFCRTYP
          GOTO      DICR2100 IF EQUAL         * ABF
.
          MATCH     "1",PMFCRTYP
          IF        @EQUAL
DICR2100  
            UNPACK    PMFCADAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
            MOVE      "to",KEY2
            PACK      KEY27,STRDATE,SP1,KEY2,SP1,KEY12,SP70
            MOVE      "&nbsp;   ",PMFCITEM
          ELSE
            PACK      KEY27,STRDATE,SP70
          ENDIF
.
          MATCH     SP20,PMFCDESC
          IF        @EQUAL
            MOVE      "&nbsp;   ",PMFCDESC
          ENDIF
.
          WRITE     HTMLFILE;"<td>",KEY27,"</td>":
                             "<td>",PMFCDESC,"</td>":
                             "<td>",PMFCITEM,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCAMTT,FORM72        * total transaction amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCGSTM,FORM72        * GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
.
          ADD       PMFCAMTT,TOTAMT
          ADD       PMFCGSTM,TOTGST
.
.         Display credit notes details
.
DICR3000  
          IF        FORM1=0
            WRITE     HTMLFILE;"<tr>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>";
          ENDIF
.
          UNPACK    PMFCCRDA,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
          MOVE      "        0",KEY10
          MOVE      PMFCCAMT,FORM72        * total credit amount
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td>",STRDATE,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PMFCCGST,FORM72        * Credit GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>",PMFCCRNO,"</td>":
                             "</tr>";
.
          ADD       PMFCCAMT,TOTCCRD
          ADD       PMFCCGST,TOTCGST
          GOTO      DICR1000
.
.         Display totals
.
DICR9000  MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
 
          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
.
DICR9999  RETURN
+
.------------------------------------------------------------
. Credit note transaction (TABLE HEADING)
.------------------------------------------------------------
DIRHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=17%>":
                               "Date</td>":
                               "<td class=HeadingCell width=20%>":
                               "Description</td>":
                               "<td class=HeadingCell width=8%>":
                               "Item</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit Note No.</td></tr>";
.
DIRHD999  RETURN
+
.------------------------------------------------------------
. Check if input journal available
.------------------------------------------------------------
IPJRNL00  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1                 * No credit note
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
.         BRANCH    OVRCD,IPJRNL90
          IF        OVRCD=ONE
            MOVE      ONE,FORM1
            GOTO      IPJRNL90
          ENDIF
.
          MOVE      PTINCRST,FORM1
          BRANCH    FORM1,IPJRNL70,IPJRNL80   * Fully, Partially Credited
          GOTO      IPJRNL90
.
IPJRNL70  MOVE      PINVAMT,FORM12P2
          ADD       PINVPATA,FORM12P2
          ADD       PINVHFDA,FORM12P2
          ADD       PINVOTHA,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
          COMPARE   ZERO,FORM12P2
          GOTO      IPJRNL80 IF NOT EQUAL
.
          MOVE      "1",FORM1                 * No Input journal option
          GOTO      IPJRNL90
.
IPJRNL80  MOVE      "0",FORM1                 * Input journal available
IPJRNL90  WRITE     HTMLFILE;FORM1;
IPJRNL99  RETURN
+
.------------------------------------------------------------
. Check if Credit Transaction option available
.------------------------------------------------------------
CTRN0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1                 * No credit note
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CTRN9000
.
          MOVE      PTINCRST,FORM1
CTRN9000  WRITE     HTMLFILE;FORM1;
CTRN9999  RETURN
+
.-------------------------------------------------------------------------
. Check if Credit Transfer option available (only if there is any payment)
.-------------------------------------------------------------------------
CSTR0000  MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CSTR7000            * Invalid invoice number
.
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,F12P2
.
.         Only available for Outpatient, Inpatient and Emergency
.
          MOVE      FORM8,PINVNO
          MOVE      "2",KEY1          * Payment record type
          IF        PINVSYS=3
            MOVE      "5",KEY1
          ENDIF
          MOVE      TWO,CREDITEM
          PACK      KEY23,PINVNO,KEY1,SP70
          CALL      RSDTR000
CSTR1000  CALL      RKDTR000
          BRANCH    OVRCD,CSTR2000
.
          MATCH     TREF,PINVNO
          GOTO      CSTR2000 IF NOT EQUAL     * Different invoice number
.
.         Do not include 'From Payment Transfer' Journal amount
.         
          IF        TRECTYPE=5
            ADD       TPATAMTT,FORM12P2       * Total payment
          ELSE
            IF        TRECTYPE=6
              MATCH     PTCNCJRN,TTYPE
              IF        @EQUAL
                MATCH     "FROM",TDDESC
                IF        !@EQUAL
                  ADD       TPATAMTT,F12P2    * Total payment transfer journal
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      CSTR1000
.
CSTR2000  MULT      "-1",FORM12P2
          COMPARE   FORM12P2,F12P2
          GOTO      CSTR8000 IF LESS
.
CSTR7000  MOVE      "1",FORM1                 * No credit transfer
          GOTO      CSTR9000
.
CSTR8000  MOVE      "0",FORM1                 * credit transfer -available
.
CSTR9000  MOVE      ZERO,CREDITEM
CSTR9999  RETURN
+
.-------------------------------------------------------------------------
. Check if Reassign debt option available
.-------------------------------------------------------------------------
RASS0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
.
          BRANCH    F1,RASS2000               * Private Practice
.
          CALL      RDINV1
          BRANCH    OVRCD,RASS7000            * No un-reconciled record
.
          MOVE      PINVAMT,FORM12P2
          ADD       PINVPATA,FORM12P2
          ADD       PINVHFDA,FORM12P2
          ADD       PINVOTHA,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
.
          GOTO      RASS6000
.
RASS2000  CALL      RDPRIN1
          BRANCH    OVRCD,RASS7000
.
          MOVE      PRINITOT,FORM12P2
          ADD       PRINPAMT,FORM12P2
          ADD       PRINHAMT,FORM12P2
          ADD       PRINIAMT,FORM12P2
          ADD       PRINMAMT,FORM12P2
          ADD       PRINVAMT,FORM12P2
          ADD       PRINOTHA,FORM12P2
          ADD       PRINJAMT,FORM12P2
          ADD       PRINGSTJ,FORM12P2
          ADD       PRINCNTT,FORM12P2
.
RASS6000  COMPARE   ZERO,FORM12P2
          GOTO      RASS7000 IF EQUAL         * No Outstanding amount
.
          GOTO      RASS8000
.
RASS7000  MOVE      "1",FORM1                 * No reassign debt option
          GOTO      RASS9000
.
RASS8000  MOVE      "0",FORM1                 * Reassign debt option available
.
RASS9000  WRITE     HTMLFILE;FORM1;
RASS9999  RETURN
+
.------------------------------------------------------------
. Selection of Action plans
.------------------------------------------------------------
SACT0000  PACK      KEY6,ACLAIM,SP70
          CALL      RSPTFAP1
SACT1000  CALL      RKPTFAP1
          BRANCH    OVRCD,SACT9999
.
          MATCH     ACLAIM,PTFPCLAI
          GOTO      SACT9999 IF NOT EQUAL
.
          MOVE      "AK",KEY2
          PACK      KEY5,KEY2,PTFPACPL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SACT1000
.
          WRITE     HTMLFILE;"<option value=",PTFPACPL,">",TDESC,"</option>"
          GOTO      SACT1000
.
SACT9999  RETURN
+
.------------------------------------------------------------
. Check if there is an existing Action plan
.------------------------------------------------------------
CACT0000  MOVE      ONE,EXIT
          MOVE      ZERO,FORM8
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPTPFA1
          BRANCH    OVRCD,CACT9999
          MOVE      ZERO,EXIT
CACT9999  RETURN
+
.------------------------------------------------------------
.         List of Payment records
.------------------------------------------------------------
CSHT0000  CALL      CSHD0000                  * Payment heading
          MOVE      ZERO,FORM3
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MOVE      PINVSYS,F1                * save system type
          MOVE      FIVE,KEY1
          IF        PINVSYS<>3
            MOVE      TWO,KEY1                * Cash record type for Outpat/A&E
          ENDIF
          MOVE      ZERO,TOTTCRD
          MOVE      TWO,CREDITEM
          PACK      KEY23,KEY8,KEY1,SP70
          CALL      RSDTR000
CSHT1000  CALL      RKDTR000
          BRANCH    OVRCD,CSHT7000
.
          MATCH     TREF,KEY8
          GOTO      CSHT7000 IF NOT EQUAL     * Different invoice number
.
          COMPARE   FIVE,TRECTYPE
          GOTO      CSHT7000 IF NOT EQUAL     * not a payment record
.
          ADD       ONE,FORM3   * Increment parameter counter
          MOVE      FORM3,KEY3
          REP       " 0",KEY3
.
          MOVE      DTFCENT,CCENT
          MOVE      DTFYEAR,CYEAR
          REP       " 0",CCENT
          REP       " 0",CYEAR
          MOVE      DTFMONTH,CMON
          MOVE      DTFDAY,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      TPATAMTT,FORM12P2
          MULT      "-1",FORM12P2
          WRITE     HTMLFILE;"<input type=hidden name=trnno",KEY3," value=#"":
                             TTRANSN1,"#">":
                             "<input type=hidden name=ramnt",KEY3," value=#"":
                             FORM12P2,"#">":
                             "<tr><td>",STRDATE,"</td>":
                             "<td>",TDDESC,"</td>":
                             "<td>",TRECEIPT,"</td>":
                             "<td align=right>",TPATAMTT,"</td>":
                             "<td align=center>":
                             "<input type=checkbox name=cstrn",KEY3:
                             " value=1 onclick='chgINV(cstrn",KEY3:
                             ",ivtrn",KEY3:
                             ",ramnt",KEY3:
                             ")' ></td>":
                             "<td align=center>":
                             "<select disabled title='Invoice No.'":
                             " name=ivtrn",KEY3,">";
.
          CALL      SELINV00          * Display available select of invoice no
          WRITE     HTMLFILE;"</select></td>":
                             "</tr>";
          ADD       TPATAMTT,TOTTCRD
          GOTO      CSHT1000
.
CSHT7000  WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",TOTTCRD,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>";
CSHT9999  RETURN
+
.------------------------------------------------------------
.         Heading for List of Payments
.------------------------------------------------------------
CSHD0000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell>":
                               "Date</td>":
                               "<td class=HeadingCell>":
                               "Description</td>":
                               "<td class=HeadingCell>":
                               "Receipt Number</td>":
                               "<td class=HeadingCell>":
                               "Amount</td>":
                               "<td align=center class=HeadingCell>":
                               "Cash Transfer</td>":
                               "<td align=center class=HeadingCell>":
                               "To Invoice No.</td>":
                             "</tr>"
CSHD9999  RETURN
+
.-----------------------------------------------------------------------------
.         Display selection of invoice numbers for this U/R (same system type)
.-----------------------------------------------------------------------------
SELINV00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RDSINV5
SELINV10  CALL      RDPINV5
          BRANCH    OVRCD,SELINV90
          MATCH     URNUMBER,PINVUR
          GOTO      SELINV90 IF NOT EQUAL
.
          MATCH     ZEROVISN,PINVADM
          GOTO      SELINV10 IF EQUAL       * Invoice cancelled
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MATCH     KEY8,PINVNO
          GOTO      SELINV10 IF EQUAL       * Skip the invoice
.
          COMPARE   F1,PINVSYS
          GOTO      SELINV10 IF NOT EQUAL   * Different system type
          MATCH     "1",PTINCRST
          GOTO      SELINV10 IF EQUAL       * Fully Credited
.
          MOVE      PINVAMT,FORM12P2
          ADD       PINVPATA,FORM12P2
          ADD       PINVHFDA,FORM12P2
          ADD       PINVOTHA,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          ADD       PTINGSTJ,FORM12P2
.
          COMPARE   ZERO00,FORM12P2         * invoice balanced ?
          GOTO      SELINV10 IF EQUAL       * yes, ignore invoice
.
          WRITE     HTMLFILE;"<option value=#"",PINVNO,"#">":
                               PINVNO,"</option>"
          GOTO      SELINV10
.
SELINV90  MOVE      F1,PINVSYS        * Restore visit type
SELINV99  RETURN
+
.------------------------------------------------------------
. Priv Pract Check if Credit Transaction option available
.------------------------------------------------------------
PPCTRN00  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PPCTRN90
          MOVE      PRINCNST,FORM1
          BRANCH    FORM1,PPCTRN80,PPCTRN80   * Fully or Partially Credited
          MOVE      "1",FORM1                 * No credit note
          GOTO      PPCTRN90
.
PPCTRN80  MOVE      "0",FORM1                 * has got a credit note -available
.
PPCTRN90  WRITE     HTMLFILE;FORM1;
PPCTRN99  RETURN
.
.------------------------------------------------------------
. Check if Credit by item option available
.------------------------------------------------------------
CITM0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CITM8000
          MOVE      PTINCRST,FORM1
          BRANCH    FORM1,CITM8000            * Fully Credited
.
          MOVE      ADMISSNO,KEY8
          BRANCH    PINVSYS,CITM1000,CITM3000,CITM2000
          GOTO      CITM8000
.
CITM1000  CALL      RDEMVIS1
          BRANCH    OVRCD,CITM1200             * Check for Event visit
          MATCH     "00000000",EMVIDATE
          GOTO      CITM8000 IF EQUAL          * Take up outstanding debts
          GOTO      CITM3000
.
CITM1200  MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CITM8000
.
          COMPARE   NINE,PVITYPE
          GOTO      CITM8000 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      CITM8000 IF NOT EQUAL
.
          MOVE      SP10,CODE
          MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,CITM8000             * missing event record
          GOTO      CITM3000
.
CITM2000  CALL      RDMISS1
          BRANCH    OVRCD,CITM8000
.
.         check if this is one of Independence Services billing Invoices
.
          CALL      CISB0000           * Ind.Services Billing invoice?
          IF        EXIT=0
            GOTO      CITM8000         * Credit by item not available
          ENDIF
.
          MATCH     "00000000",ADATE
          GOTO      CITM8000 IF EQUAL          * Take up outstanding debt
.
CITM3000  MATCH     "1",PTCNPPIN
          GOTO      CITM3200 IF NOT EQUAL    * Not using Pat Inv functionality
.
          BRANCH    PINVTYP,CITM8000,CITM8000  * not avaialble for Pat/Reb Inv.
.
CITM3200  MOVE      "0",FORM1                 * Credit note by item available
          COMPARE   FIVE,CFEETYP
          GOTO      CITM9000 IF NOT EQUAL     * Not SX
.
.         If this is the only item in the invoice, do not allow Credit by item.
.         User has to use Credit all to include rounding amount
.
          MOVE      ZERO,F1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          PACK      KEY23,ADMISSNO,KEY8,SP70
          CALL      RDSDTRN4
CITM4000  CALL      RDKDTRN4
          BRANCH    OVRCD,CITM7000
.
          MATCH     ADMISSNO,DTADMNO          * Same admission?
          GOTO      CITM7000 IF NOT EQUAL
.
          MATCH     TREF,KEY8                 * Same invoice?
          GOTO      CITM7000 IF NOT EQUAL
.
.         If accommodation record is found than Credit Note by Item available
.
          BRANCH    TRECTYPE,CITM9000,CITM6000,CITM6000
          GOTO      CITM4000
.
.         If more than one item found, then Credit note by Item available
.
CITM6000  MATCH     "1",PTDTCRST
          GOTO      CITM4000 IF EQUAL         * fully credited
          MATCH     "2",PTDTCRST
          GOTO      CITM4000 IF EQUAL         * partial credited
.
          BRANCH    F1,CITM9000               * found an item already
          ADD       ONE,F1
          GOTO      CITM4000
.
CITM7000  BRANCH    F1,CITM8000               * only found one item record
          GOTO      CITM9000
.
CITM8000  MOVE      "1",FORM1                 * No Credit note by item option
          GOTO      CITM9000
.
CITM9000  WRITE     HTMLFILE;FORM1;
CITM9999  RETURN
+
.------------------------------------------------------------
. PP Check if Credit by item option available
.------------------------------------------------------------
PPCITM00  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1                * Credit note by item available
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PPCITM90
          MOVE      PRINCNST,FORM1
          BRANCH    FORM1,PPCITM70,PPCITM80   * Fully, Partially Credited
          GOTO      PPCITM90
.
PPCITM70  MOVE      "1",FORM1                 * No Credit note by item option
          GOTO      PPCITM90
.
PPCITM80  MOVE      "0",FORM1                 * Credit note by item available
PPCITM90  WRITE     HTMLFILE;FORM1;
PPCITM99  RETURN
+
.------------------------------------------------------------
. PP Check if input journal option available
.------------------------------------------------------------
PPJRNL00  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1                * Input journal available
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PPJRNL90
          MOVE      PRINCNST,FORM1
          BRANCH    FORM1,PPJRNL70,PPJRNL80   * Fully, Partially Credited
          GOTO      PPJRNL90
.
.         Check if outstanding amt of invoice is a negative amount
.
PPJRNL70  MOVE      ZERO,FORM12P2
          MOVE      PRINITOT,FORM12P2      * Total Outstanding
          ADD       PRINPAMT,FORM12P2
          ADD       PRINHAMT,FORM12P2
          ADD       PRINIAMT,FORM12P2
          ADD       PRINMAMT,FORM12P2
          ADD       PRINVAMT,FORM12P2
          ADD       PRINOTHA,FORM12P2
          ADD       PRINJAMT,FORM12P2
          ADD       PRINCNTT,FORM12P2
          COMPARE   ZERO,FORM12P2
          GOTO      PPJRNL80 IF LESS
.
          MOVE      "1",FORM1                 * No Input journal option
          GOTO      PPJRNL90
.
PPJRNL80  MOVE      "0",FORM1                 * Input journal available
PPJRNL90  WRITE     HTMLFILE;FORM1;
PPJRNL99  RETURN
+
.------------------------------------------------------------
. Check if Credit by item option available
.------------------------------------------------------------
CRCP0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM1
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MOVE      SP20,KEY4
          IF        VISITTYP=5
            MOVE      "0000",KEY4
            REP       " 0",KEY8
          ENDIF
          PACK      KEY12,KEY4,KEY8
          PACK      KEY29,KEY12,SP70
          CALL      RSRCDTE3
          CALL      RKRCDTE3
          BRANCH    OVRCD,CRCP7000
          MATCH     KEY12,RCDTINVN
          GOTO      CRCP7000 IF NOT EQUAL
          MOVE      "0",FORM1                 * receipt option available
          GOTO      CRCP9000
.
CRCP7000  MOVE      "1",FORM1                 * No receipt option
CRCP9000  WRITE     HTMLFILE;FORM1;
CRCP9999  RETURN
.
.-------------------------------------------------------------------------
. Check if Credit Transfer option available (only if there is any payment)
.-------------------------------------------------------------------------
CPTR0000  MOVE      ZERO,F1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,CPTR7000            * Invalid invoice number
.
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,F12P2
.
          OPEN      PRIDTRA4,"pridtraf"          * debtor transaction file
          PACK      KEY22,PRINNUMB,SP70
          CALL      RSPRDT4
CPTR1000  CALL      RKPRDT4
          BRANCH    OVRCD,CPTR2000
.
          MATCH     PRDTINVN,PRINNUMB
          GOTO      CPTR2000 IF NOT EQUAL     * Different invoice number
.
.         Do not include 'From Payment Transfer' Journal amount
.
          IF        PRDTRTYP=2
            ADD       PRDTAMNT,FORM12P2       * Total payment
          ELSE
            IF        PRDTRTYP=3
              MATCH     PTCNCJRN,TTYPE
              IF        @EQUAL
                MATCH     "FROM",TDDESC
                IF        !@EQUAL
                  ADD       PRDTAMNT,F12P2    * Total payment transfer journal
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      CPTR1000
.
CPTR2000  MULT      "-1",FORM12P2
          COMPARE   FORM12P2,F12P2
          GOTO      CPTR8000 IF LESS
.
CPTR7000  MOVE      "1",F1                 * No credit transfer
          GOTO      CPTR9999
.
CPTR8000  MOVE      "0",F1                 * credit transfer -available
.
CPTR9999  RETURN
+
.------------------------------------------------------------
.         Check invoice comments
.------------------------------------------------------------
CINC0000  MOVE      ZERO,F1
          MOVE      INVOICEN,FORM8
          IF        FORM8<>0
            MOVE      FORM8,KEY8
          ENDIF
          PACK      KEY19,ADMISSNO,KEY8,SP70
          CALL      RSPMICM1
          CALL      RKPMICM1
          BRANCH    OVRCD,CINC9000          * end of file
          MATCH     PMICVISN,ADMISSNO       * same Admission Number?
          GOTO      CINC9000 IF NOT EQUAL
.
          MATCH     KEY8,PMICINVN
          GOTO      CINC9000 IF NOT EQUAL
          MOVE      ONE,F1
.
CINC9000  WRITE     HTMLFILE;F1;
CINC9999  RETURN
+
.------------------------------------------------------------
.         Check PP invoice comments
.------------------------------------------------------------
IPCM0000  MOVE      ZERO,F1
          MOVE      INVOICEN,FORM8
          COMPARE   ZERO,FORM8
          GOTO      IPCM9000 IF EQUAL
.
          MOVE      FORM8,KEY8
          MOVE      "001",KEY3              * PRI Invoice comment
          PACK      KEY17,KEY8,KEY3,SP70
          CALL      RSPRICM1
IPCM1000  CALL      RKPRICM1
          BRANCH    OVRCD,IPCM9000          * end of file
.
          MATCH     KEY8,PRICINVN
          GOTO      IPCM9000 IF NOT EQUAL
	  MATCH     KEY3,PRICCTYP           * same comment type?
          GOTO      IPCM9000 IF NOT EQUAL
.
          MATCH     "1",PRICDIND
          GOTO      IPCM1000 IF EQUAL       * Deleted
.
          MOVE      ONE,F1
.
IPCM9000  WRITE     HTMLFILE;F1;
IPCM9999  RETURN
+
.------------------------------------------------------------
. Table of Invoice Details
. TOTLFLAG=1 - calculate total only and loop through the file
.              again to display screen.
.------------------------------------------------------------
PATINV00  MATCH     SP70,ADMISSNO
          GOTO      PATINV99 IF EQUAL
.
          MOVE      ONE,SHOWFLAG            * Show no more invoice message
          COMPARE   ONE,TOTLFLAG
          GOTO      PATINV02 IF NOT EQUAL
.
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          GOTO      PATINV04
.
PATINV02  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
PATINV04  PACK      KEY16,ADMISSNO,Z70
          CALL      RDSINV3
PATINV10  CALL      RDPINV3
          BRANCH    OVRCD,PATINV90
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      PATINV90 IF NOT EQUAL
.
          MOVE      ZERO,SAVFLAG
          MATCH     ZEROVISN,PINVADM
          GOTO      PATINV10 IF EQUAL       * invoice cancelled
.
          BRANCH    PINVSYS,PATINV12,PATINV12,PATINV12
          GOTO      PATINV10
.
PATINV12  BRANCH    TOTLFLAG,PATINV14      * calculate total only
.
          PACK      NEXTVKEY,ADMISSNO,PINVNO,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,ADMISSNO,PINVNO,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PATINV10
          ENDIF
.
          MOVE      SP70,VISTDESC
          LOAD      VISTDESC,PINVSYS,EMRPAT,OUTPAT,INPPAT
.
          MOVE      SP70,ADATE
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
.         BRANCH    OVRCD,PATINV10
          IF        OVRCD=1
            MOVE      ONE,SAVFLAG            * Cancelled admission
            MOVE      SP70,PVIDATE
            MOVE      SP70,PMVXMHOS
            GOTO      PATINV13
          ELSE
            MOVE      PINVADM,KEY8
            CALL      RDPMVX11
            BRANCH    OVRCD,PATINV10
            IF        PVITYPE=3
              MOVE      PINVADM,KEY8
              CALL      RDMISS1
            ENDIF
          ENDIF
.
PATINV13  MATCH     SP10,AFUNDH
          IF        @EQUAL
            MOVE      PFUNDH,AFUNDH
            MOVE      PFNDTB,AFNDTB
          ENDIF
.
          CALL      HFUND000             * Get health fund
.
PATINV14  MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
          MOVE      ZERO,F1
          MOVE      SP70,PRINNUMB
          PACK      KEY12,SP4,PINVNO,SP70 * set up invoice number
          MOVE      PINVUR,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
          ADD       PTINGSTJ,TOTOUTS
          ADD       PTINCRTT,TOTOUTS
          COMPARE   ONE,TOTLFLAG
          GOTO      PATINV16 IF NOT EQUAL
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       PTINGSTJ,SUMJR
          ADD       PTINCRTT,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PATINV10
.
PATINV16  IF        (ROWCOUNT%2) = 0
...         WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
....        WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      ZERO,VISITTYP
          LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        IBCNMHOS=1 & CFEETYP=5
            MATCH     WBSEHOSP,PMVXMHOS
            IF        !@EQUAL
              WRITE     HTMLFILE;"<tr><td><img src=../images/spacer3.gif":
                                 " class=ListIcon >";
            ELSE
              WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                                 " class=ListIcon onclick='linkInvoice(#"":
                               PINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkInvoice(#"":
                               PINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>";
          ENDIF
.
          MATCH     "1",PTINCRST
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=#FF0000><b>",PINVNO:
                               "</font></b></td>";
          ELSE
            IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
              WRITE     HTMLFILE;"<font color=#0000FF><b>",PINVNO:
                                 "</font></b></td>";
            ELSE
              WRITE     HTMLFILE;PINVNO,"</td>";
            ENDIF
          ENDIF
.
          MATCH     "00000000",ADATE
          IF        @EQUAL
            MATCH      "2",PTCNIRAI
            IF         @EQUAL
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",PTINCTIM,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</td>";
            ENDIF
.
            CALL     IRBY0000      * Display Invoice Raised By ?
            WRITE    HTMLFILE;"<td>",VISTDESC,"(O/S Debt.)</td>";
            GOTO     PATINV40
          ENDIF
.
          REP       " 0",PVIDATE
          MATCH     "00000000",PVIDATE
          IF        @EQUAL
            MATCH      "2",PTCNIRAI
            IF         @EQUAL
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",PTINCTIM,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</td>";
            ENDIF
.
            CALL      IRBY0000      * Display Invoice Raised By ?
            WRITE     HTMLFILE;"<td>",VISTDESC,"(Cancelled)</td>";
          ELSE
            MATCH      "2",PTCNIRAI
            IF         @EQUAL
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",PTINCTIM,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</td>";
            ENDIF
.
            CALL      IRBY0000      * Display Invoice Raised By ?
            WRITE     HTMLFILE;"<td>",VISTDESC,"</td>";
          ENDIF
.
PATINV40  MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",HFNDESC,"/",HFNTABL,"</td>";
          ENDIF
.
          MOVE      PINVJOUR,FORM8P2
          ADD       PTINGSTJ,FORM8P2
          IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#0000FF><b>",PINVAMT:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>";
          ENDIF

          IF        DSCNFLAG=1
            WRITE     HTMLFILE;"<td align=right><font color=#000080><b>":
                               TOTPAID,CPNDFLAG,"</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",TOTPAID,CPNDFLAG,"</td>";
          ENDIF
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          IF        !@EQUAL
            ADD       PTINCRTT,FORM8P2
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#FF0000><b>",FORM8P2:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM8P2,"</td>";
          ENDIF
.
          IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#0000FF><b>",TOTOUTS:
                               "</font></b></td></tr>"
          ELSE
            WRITE     HTMLFILE;"<td align=right>",TOTOUTS,"</td></tr>"
          ENDIF
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PATINV10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
          GOTO      PATINV99
.
PATINV90  IF        TOTLFLAG=1
            MOVE      ZERO,TOTLFLAG
            GOTO      PATINV00
          ENDIF
.
          IF        SHOWFLAG=1
            WRITE     HTMLFILE;"<tr><td>Total</td>":
                               "<td>&nbsp;</td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            MATCH     "2",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right><b>",SUMINV,"</b></td>":
                               "<td align=right><b>",SUMPAID,"</b></td>":
                               "<td align=right><b>",SUMJR,"</b></td>":
                               "<td align=right><b>",SUMOUTS,"</b></td></tr>"
          ENDIF
PATINV99  RETURN
+
.-------------------------------------------------------------
.         Display Invoice Raised By - if PCNCIRAI = 1 OR 2
.-------------------------------------------------------------
IRBY0000  MATCH     "2",PTCNIRAI             * Display Invoice raised by and
          GOTO      IRBY1000 IF EQUAL        * time invoice created
.
          MATCH     "1",PTCNIRAI             * Display Invoice Raised By
          GOTO      IRBY2000 IF NOT EQUAL    * Not displaying Invoice raised By
.
IRBY1000  PACK      DIM10A,WBSEUID,SP70      * Save current User ID
.
          PACK      KEY10,PTINCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
          IF        TBSRTFLG=1
            WRITE     HTMLFILE;"#"",WBSENAM,"#",";                * 9
          ELSE
           WRITE    HTMLFILE;"<td>&nbsp;",WBSENAM,"</td>";        * 9
          ENDIF
.
          MOVE     DIM10A,KEY10
          CALL     RDWBSE1                 * Reposition to original User ID
          GOTO      IRBY9999
.
IRBY2000  IF        TBSRTFLG=1
            WRITE     HTMLFILE;"#""," ","#",";                    * 9
          ENDIF
.
IRBY9999  RETURN
+
.-------------------------------------------------------------
.         Print list of invoice for an admission
.-------------------------------------------------------------
PMTINV00  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                             "<td><b>Invoice No.</b></td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date/Time</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Visit Type</b></td>":
                            "<td><b>Health Fund</b></td>":
                            "</tr>"
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          MATCH     SP70,ADMISSNO
          GOTO      PMTINV99 IF EQUAL
.
          PACK      KEY16,ADMISSNO,Z70
          CALL      RDSINV3
PMTINV10  CALL      RDPINV3
          BRANCH    OVRCD,PMTINV99
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      PMTINV99 IF NOT EQUAL
.
          MATCH     ZEROVISN,PINVADM
          GOTO      PMTINV10 IF EQUAL       * invoice cancelled
.
          COMPARE   THREE,PINVSYS
          GOTO      PMTINV10 IF NOT EQUAL   * Not inpatient
.
          PACK      NEXTVKEY,ADMISSNO,PINVNO,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,ADMISSNO,PINVNO,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PMTINV10
          ENDIF
.
          MOVE      SP70,VISTDESC
          LOAD      VISTDESC,PINVSYS,EMRPAT,OUTPAT,INPPAT
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PMTINV10
.
          MOVE      PINVADM,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,PMTINV10
.
          MOVE      PINVADM,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PMTINV10
.
          MATCH     SP10,AFUNDH
          IF        @EQUAL
            MOVE      PFUNDH,AFUNDH
            MOVE      PFNDTB,AFNDTB
          ENDIF
          MOVE      AFUNDH,HFNDESC        * Master File Var (Already read)
          MOVE      AFNDTB,HFNTABL
.
          MATCH     SP10,HFNDESC
          IF        @EQUAL
            MOVE      "&nbsp",HFNDESC
            MOVE      "&nbsp",HFNTABL
          ENDIF
.
          IF        (ROWCOUNT%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      ZERO,VISITTYP
          LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='PrtNoAmtInv(#"":
                             PINVNO,"#")'>";
          IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"<font color=#0000FF><b>",PINVNO:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;PINVNO,"</td>";
          ENDIF
.
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",PTINCTIM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td>";
          ENDIF
.
          CALL      IRBY0000      * Display Invoice Raised By ?
.
          WRITE     HTMLFILE;"<td>",VISTDESC,"</td>";
.
          MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<td>",HFNDESC,"/",HFNTABL,"</td></tr>"
          ENDIF
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PMTINV10 IF NOT EQUAL
.
PMTINV99  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
          REP       " +",HLTHFUND    
          REP       " +",HFUNDGRP    
          REP       " +",CHCKHOSP
          REP       " +",SRCHSNAM
          REP       " +",SRCHGNAM
.
          WRITE     HTMLFILE;"patweb76.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&prevflag=",ONE:
                                 "&prevvkey=",PREVVKEY:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&hlthfund=",HLTHFUND:
                                 "&hfundgrp=",HFUNDGRP:
                                 "&chckhosp=",CHCKHOSP:
                                 "&srchsnam=",SRCHSNAM:
                                 "&srchgnam=",SRCHGNAM;
.
          REP       "+ ",ADMISSNO    
          REP       "+ ",URNUMBER    
          REP       "+ ",HLTHFUND    
          REP       "+ ",HFUNDGRP    
          REP       "+ ",CHCKHOSP
          REP       "+ ",SRCHSNAM
          REP       "+ ",SRCHGNAM
.
PREVGR99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
          REP       " +",HLTHFUND    
          REP       " +",HFUNDGRP    
          REP       " +",CHCKHOSP
          REP       " +",SRCHSNAM
          REP       " +",SRCHGNAM
.
          WRITE     HTMLFILE;"patweb76.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&nextvkey=",NEXTVKEY:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&hlthfund=",HLTHFUND:
                                 "&hfundgrp=",HFUNDGRP:
                                 "&chckhosp=",CHCKHOSP:
                                 "&srchsnam=",SRCHSNAM:
                                 "&srchgnam=",SRCHGNAM;
.         
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",HLTHFUND    
          REP       "+ ",HFUNDGRP    
          REP       "+ ",CHCKHOSP
          REP       "+ ",SRCHSNAM
          REP       "+ ",SRCHGNAM
.
NEXTGR99  RETURN
.
.------------------------------------------------------------
. Table of Invoice Details for a Health Fund
. TOTLFLAG=1 - calculate total only and loop through the file
.              again to display screen.
.------------------------------------------------------------
HFPINV00  PACK      HFUNDGRP,HFUNDGRP,SP70       * check if using fund group
          MATCH     SP70,HFUNDGRP
          IF        @EQUAL
            MATCH     SP70,HLTHFUND
            GOTO      HFPINV99 IF EQUAL          * check for health fund
          ENDIF
.
          COMPARE   ONE,TOTLFLAG
          GOTO      HFPINV10 IF NOT EQUAL
.
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          GOTO      HFPINV20
.
HFPINV10  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
HFPINV20  BRANCH    PPRCFLAG,HFPINV30       * Private practice invoice only
.
          CALL      PRFND000                * Print Health Fund invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      HFPINV99 IF EQUAL
.
HFPINV30  MOVE      ONE,SCANFLAG
          MOVE      ZERO,ISBLFLAG
          CALL      PRPRI000                * Print Private Practice invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      HFPINV99 IF EQUAL
.
          BRANCH    PPRCFLAG,HFPINV40       * Private practice invoice only
.
          CALL      PRDBT000                * Print Sundry Debtors invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      HFPINV99 IF EQUAL
.
HFPINV40  BRANCH    TOTLFLAG,HFPINV90        * calculate total only
.
          GOTO      HFPINV99
.
HFPINV90  IF        TOTLFLAG=1
            MOVE      ZERO,TOTLFLAG
            GOTO      HFPINV00
          ENDIF
HFPINV99  RETURN
+
.------------------------------------------------------------
. Private Practice heading
.------------------------------------------------------------
PPHD0000  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                            "<td><b>Invoice No.</b></td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Medical Prac.</b></td>":
                            "<td><b>Compensable</b></td>":
                            "<td><b>Health Fund</b></td>":
                           "<td width=75 align=right><b>Invoice Total</b></td>":
                            "<td width=75 align=right><b>Paid</b></td>":
                            "<td width=75 align=right><b>Journals</b></td>":
                            "<td width=75 align=right><b>Outstanding</b></td>":
                            "</tr>"
PPHD9999  RETURN
+
.------------------------------------------------------------
. Table of Patient Invoice Details
. TOTLFLAG=1 - calculate total only and loop through the file
.              again to display screen.
.------------------------------------------------------------
PINVCI00  MATCH     SP70,URNUMBER
          GOTO      PINVCI99 IF EQUAL
.
          IF        ISBLFLAG=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      PMSIVBA1,"pmsivbaf"
            TRAPCLR   IO
            BRANCH    OVRCD,PINVCI99
.
            TRAP      OVERCOND IF IO
            OPEN      PMSPBRA1,"pmspbraf"
            TRAPCLR   IO
            BRANCH    OVRCD,PINVCI99
.
            TRAP      OVERCOND IF IO
            OPEN      PMSPYRA1,"pmspyraf"
            TRAPCLR   IO
            BRANCH    OVRCD,PINVCI99
          ENDIF
.
          COMPARE   ONE,TOTLFLAG
          GOTO      PINVCI10 IF NOT EQUAL
.
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          GOTO      PINVCI20
.
PINVCI10  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
PINVCI20  BRANCH    PPRCFLAG,PINVCI30       * Private practice invoice only
.
          CALL      PRPAT000                * Print Patient invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      PINVCI99 IF EQUAL
.
PINVCI30  MOVE      ONE,SCANFLAG
          CALL      PRPRI000                * Print Private Practice invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      PINVCI99 IF EQUAL
.
          BRANCH    PPRCFLAG,PINVCI40       * Private practice invoice only
.
          CALL      PRDBT000                * Print Sundry Debtors invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      PINVCI99 IF EQUAL
.
PINVCI40  BRANCH    TOTLFLAG,PINVCI90        * calculate total only
.
...       IF        ROWCOUNT>0
          IF        TBSRTFLG=1
            GOTO PINVCI41
          ELSE
            GOTO PINVCI42
          ENDIF
.
PINVCI41  CLEAR     INVCEIMG
          MOVE      TWO,INVCEIMG
          WRITE     HTMLFILE;"t.addTotal(",QUOTE,QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,"Total",QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,QUOTE,COMMA:
                                           QUOTE,INVCEIMG,QUOTE,COMMA:
                                           QUOTE,SP2,QUOTE,COMMA:
                                           QUOTE,SP2,QUOTE,COMMA:
                                           QUOTE,SP2,QUOTE,COMMA:
                                           QUOTE,SP2,QUOTE,COMMA:
                                           QUOTE,SP2,QUOTE,COMMA:
                                           QUOTE,SUMINV,QUOTE,COMMA:
                                           QUOTE,SUMPAID,QUOTE,COMMA:
                                           QUOTE,SUMJR,QUOTE,COMMA:
                                           QUOTE,SUMOUTS,QUOTE,");";
.
          GOTO      PINVCI99
.
PINVCI42  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>Total</td>":
                               "<td>&nbsp;</td>";
.
          IF        ISBLFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          IF        PPRCFLAG<>1
            IF        HOSPFLAG=1
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          ENDIF
            WRITE     HTMLFILE;"<td align=right><b>",SUMINV,"</b></td>":
                               "<td align=right><b>",SUMPAID,"</b></td>":
                               "<td align=right><b>",SUMJR,"</b></td>":
                               "<td align=right><b>",SUMOUTS,"</b></td></tr>"
...       ENDIF
          GOTO      PINVCI99
.
PINVCI90  IF        TOTLFLAG=1
            MOVE      ZERO,TOTLFLAG
            GOTO      PINVCI00
          ENDIF
          MOVE      ZERO,ISBLFLAG
PINVCI99  RETURN
+
.------------------------------------------------------------
. Invoice heading
.------------------------------------------------------------
HDINV000  MOVE      ZERO,ISBLFLAG  
          MOVE      SP70,KEY1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,ISBLFLAG
.
          BRANCH    ISBLFLAG,HDINV1000
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                               "<td><b>Hosp</b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>";
          ENDIF
          WRITE     HTMLFILE;"<td><b>Visit No</b></td>":
                               "<td><b>Visit Date</b></td>":
                               "<td><b>Invoice No.</b></td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date/Time</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Medical Prac.</b></td>";
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td><b>Compensable</b></td>";
          ENDIF
.
          IF        CFEETYP=5
            WRITE     HTMLFILE;"<td><b>Contract</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Health Fund</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td width=75 align=right><b>Invoice Total":
                            "</b></td>":
                            "<td width=75 align=right><b>Paid</b></td>":
                            "<td width=75 align=right><b>Journals</b></td>":
                            "<td width=75 align=right><b>Outstanding</b>":
                            "</td></tr>"
          GOTO      HDINV999
.
.         Independence Services billing
.
HDINV100  IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                               "<td><b>Hosp</b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>";
          ENDIF
          WRITE     HTMLFILE;"<td><b>Visit No</b></td>":
                               "<td width=10><b>Unique Id.</b></td>":
                               "<td><b>Visit Date</b></td>":
                               "<td><b>Invoice No.</b></td>";
.
          MATCH    "2",PTCNIRAI
          IF       @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date/Time</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Medical Prac.</b></td>";
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td><b>Compensable</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Payer</b></td>";
.
          WRITE     HTMLFILE;"<td width=75 align=right><b>Invoice Total":
                            "</b></td>":
                            "<td width=75 align=right><b>Paid</b></td>":
                            "<td width=75 align=right><b>Journals</b></td>":
                            "<td width=75 align=right><b>Outstanding</b>":
                            "</td></tr>"
.
HDINV999  RETURN
+
.------------------------------------------------------------
.         Admission invoice list
.------------------------------------------------------------
HDPIV000  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                            "<td><b>Invoice No.</b></td>";
.
          MATCH    "2",PTCNIRAI
          IF       @EQUAL
            WRITE     HTMLFILE;"<td><b>Invoice Date/Time</b></td>";
            WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Invoice Date</b></td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><b>Raised By</b></td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td><b>Visit Type</b></td>";
.
          IF        CFEETYP=5
            WRITE     HTMLFILE;"<td><b>Contract</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td><b>Health Fund</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td width=75 align=right><b>Total Invoice":
                            "</b></td>":
                            "<td width=75 align=right><b>Paid</b></td>":
                            "<td width=75 align=right><b>Journals</b></td>":
                            "<td width=75 align=right><b>Outstanding</b>":
                            "</td></tr>"
.
HDPIV999  RETURN
+
.------------------------------------------------------------
. Print Health Fund invoices
.------------------------------------------------------------
PRFND000  PACK      HFUNDGRP,HFUNDGRP,SP70
          MATCH     SP70,HFUNDGRP
          IF        @EQUAL
            MOVE      ONE,HGRPFLAG          * not using fund group
            GOTO      PRFND090              * only display single health fund
          ELSE
            MOVE      ZERO,HGRPFLAG         * using fund group
          ENDIF
.
          PACK      KEY20,HFUNDGRP,SP70
          CALL      RDSFUND3
PRFND080  BRANCH    HGRPFLAG,PRFND990       * end if not using fund group
          CALL      RDKFUND3                * loop health fund file for a group
          BRANCH    OVRCD,PRFND990
.
          MATCH     HFUNDGRP,PTHFHGRP
          GOTO      PRFND080 IF NOT EQUAL
.
          MOVE      HCODE,HLTHFUND          * get health fund code
.
PRFND090  PACK      KEY38,HLTHFUND,SP70
          CALL      RDSINV7
PRFND100  CALL      RDKINV7
          BRANCH    OVRCD,PRFND080          * check next health fund in group
.
          MATCH     HLTHFUND,PTINHFND
          GOTO      PRFND080 IF NOT EQUAL   * check next health fund in group
.
.         * Added loop counter output for CAR 236421
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR%400) = 0
            WRITE     HTMLFILE;"<!--",LOOPCNTR,"-->"
          ENDIF
.
          MATCH     ZEROVISN,PINVADM
          GOTO      PRFND100 IF EQUAL       * invoice cancelled
.         
          COMPARE   TWO,PINVSYS
          GOTO      PRFND120 IF NOT EQUAL   * Not outpatient
          MATCH     SP70,WBSESIT
          GOTO      PRFND120 IF EQUAL
          MATCH     WBSESIT,PINVSITE
          GOTO      PRFND100 IF NOT EQUAL
.
PRFND120  BRANCH    TOTLFLAG,PRFND200     * calculate total only
.
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRFND100
          IF        PVITYPE=3
            MOVE      PINVADM,KEY8
            CALL      RDMISS1
          ENDIF
          CALL      RDPMVX11
          BRANCH    OVRCD,PRFND100
.
          IF        IBCNMHOS=1
            MATCH     SP70,CHCKHOSP
            IF        !@EQUAL
              MATCH     CHCKHOSP,PMVXMHOS
              GOTO      PRFND100 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,PRFND100
              ENDIF
            ENDIF
            GOTO      PRFND130
          ENDIF
.
          MATCH     SP70,CHCKHOSP
          IF        !@EQUAL
            MATCH     CHCKHOSP,PMVXMHOS
            GOTO      PRFND100 IF NOT EQUAL
          ENDIF
.
PRFND130  MATCH     SP10,AFUNDH
          IF        @EQUAL
            MOVE      PFUNDH,AFUNDH
            MOVE      PFNDTB,AFNDTB
          ENDIF
.
PRFND200  MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
          MOVE      ZERO,F1
          MOVE      SP70,PRINNUMB
          PACK      KEY12,SP4,PINVNO,SP70 * set up invoice number
          MOVE      PINVUR,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
          ADD       PTINGSTJ,TOTOUTS
          ADD       PTINCRTT,TOTOUTS
.
.         Skip invoices with zero or negative outstandaing balance
.
          IF        NZEROFLG=1
            IF        TOTOUTS<=0
              GOTO      PRFND100
            ENDIF
          ENDIF
.
.         Check line number for display of invoices
.
          IF        TOTLFLAG=0
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PRFND100
            ENDIF
            GOTO      PRFND300
          ENDIF
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       PTINGSTJ,SUMJR
          ADD       PTINCRTT,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PRFND100
.
PRFND300  MOVE      SP70,VISTDESC
          LOAD      VISTDESC,PINVSYS,EMRPAT,OUTPAT,INPPAT
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      ZERO,VISITTYP
          LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
.
          MOVE      ZERO,LOOPCNTR
.
          IF        HOSPFLAG=1
            WRITE     HTMLFILE;"<tr><td>",PMVXMHOS,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",PINVUR,"</td>";
          WRITE     HTMLFILE;"<td align=left>",PINVADM,"</td>";
.
          REP       " 0",PVIDATE
          MATCH     "00000000",PVIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>";
.
          MATCH     "1",PTINCRST
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=#FF0000><b>",PINVNO:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;PINVNO,"</td>";
          ENDIF
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",PTINHFND,"</td>";
.
          MOVE      PINVJOUR,FORM8P2
          ADD       PTINGSTJ,FORM8P2
          WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",TOTPAID,CPNDFLAG,"</td>";
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          IF        !@EQUAL
            ADD       PTINCRTT,FORM8P2
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#FF0000><b>",FORM8P2:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM8P2,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",TOTOUTS,"</td>";
.
          WRITE     HTMLFILE;"<td align=center>":
                   "<input type=checkbox name=invlstno":
                   " value='",PINVNO,VISITTYP,PINVUR,PINVADM,TOTOUTS:
                   "' onClick=RemoveTable(this.value);></td></tr>"
.
          ADD       ONE,ROWCOUNT
.
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PRFND100 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
PRFND990  IF        HGRPFLAG=0
            PACK      HLTHFUND,SP70         * using fund group, not single fund
          ENDIF
PRFND999  RETURN
+
.------------------------------------------------------------
. Print Patient invoices
.------------------------------------------------------------
PRPAT000  PACK      KEY32,URNUMBER,Z70
          MOVE      ZERO,INVCOUNT                                     *I-149764
          CALL      RDSINV5
PRPAT100  CALL      RDPINV5
.          IF        TBSRTFLG=1
.            IF        OVRCD=1
.             MOVE      ZERO,SHOWFLAG     * PRPAT810 END CASE
.            ENDIF
.          ENDIF
          BRANCH    OVRCD,PRPAT999 
          MOVE      PINVUR,KEY8
          MATCH     KEY8,URNUMBER
          GOTO      PRPAT999 IF NOT EQUAL
.
          MATCH     ZEROVISN,PINVADM
          GOTO      PRPAT100 IF EQUAL       * invoice cancelled
.
          MOVE      ZERO,SAVFLAG
.
          COMPARE   TWO,PINVSYS
          GOTO      PRPAT120 IF NOT EQUAL   * Not outpatient
          MATCH     SP70,WBSESIT
          GOTO      PRPAT120 IF EQUAL
          MATCH     WBSESIT,PINVSITE
          GOTO      PRPAT100 IF NOT EQUAL
.
...AT120  BRANCH    TOTLFLAG,PRPAT200     * calculate total only       D-149764
PRPAT120  
          MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
          MOVE      ZERO,F1
          MOVE      SP70,PRINNUMB
          PACK      KEY12,SP4,PINVNO,SP70 * set up invoice number
          MOVE      PINVUR,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
          ADD       PTINGSTJ,TOTOUTS
          ADD       PTINCRTT,TOTOUTS
.
.         Skip invoices with zero or negative outstandaing balance
.
          IF        NZEROFLG=1
            MATCH     "1",PTINCRST
            GOTO      PRPAT100 IF EQUAL     * INvoice fully credited
            IF        TOTOUTS<=0
              GOTO      PRPAT100            
            ENDIF
          ENDIF
.
          COMPARE   ONE,TOTLFLAG                                      *I-149764
.                                         * cancel calculating Invoice Totals
.                                         * if more than 200 invoices (Calcs are
.                                         * done on 1st pass, display on 2nd)
          IF        @EQUAL
            ADD       ONE,INVCOUNT
            COMPARE   "201",INVCOUNT
            GOTO      PRPAT999 IF NOT LESS
            GOTO      PRPAT200
          ENDIF                                                       *I-149764
.
          MOVE      SP70,ADATE
          MOVE      PINVADM,KEY8
          CALL      RDVISA1
.         BRANCH    OVRCD,PRPAT100
          IF        OVRCD=1
            MOVE      ONE,SAVFLAG        * Cancelled admission
            MOVE      SP70,PVIDATE
            MOVE      SP70,PMVXMHOS
            GOTO      PRPAT180
          ELSE
            IF        PVITYPE=3
              MOVE      PINVADM,KEY8
              CALL      RDMISS1
            ENDIF
            CALL      RDPMVX11
            BRANCH    OVRCD,PRPAT100
          ENDIF
.
PRPAT180  MATCH     SP10,AFUNDH
          IF        @EQUAL
            MOVE      PFUNDH,AFUNDH
            MOVE      PFNDTB,AFNDTB
          ENDIF
.
          CALL      HFUND000             * Get health fund
.
.         Check line number for display of invoices
.
PRPAT200  IF        TOTLFLAG=0
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PRPAT100
            ENDIF
            GOTO      PRPAT300
          ENDIF
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       PTINGSTJ,SUMJR
          ADD       PTINCRTT,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PRPAT100
.
PRPAT300  MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PINVCLM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          MOVE      SP70,VISTDESC
          LOAD      VISTDESC,PINVSYS,EMRPAT,OUTPAT,INPPAT
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          IF        TBSRTFLG =1
            WRITE     HTMLFILE;"t.addRow(#"","  ","#",":
                               "#"","  ","#",";
            GOTO      PRPAT301
          ELSE
            GOTO      PRPAT302
          ENDIF
.
PRPAT301  MOVE      ZERO,VISITTYP
          LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
.          
          IF        HOSPFLAG=1
            WRITE     HTMLFILE;"#"",PMVXMHOS,"#",";               * 2
          ELSE
            WRITE     HTMLFILE;"#""," ","#",";                    * 2
          ENDIF
.
          IF        SAVFLAG=1
            WRITE     HTMLFILE;"#"","<b><span class=TextRed>",PINVADM,"</span>":
                                 "</b>","#",";                     * 3
          ELSE
            WRITE     HTMLFILE;"#"",PINVADM,"#",";                 * 3
          ENDIF
.
          IF        ISBLFLAG=1
            MOVE      PINVNO,KEY8
            CALL      RDPMIVB1
            IF        OVRCD=0
              WRITE     HTMLFILE;"#"",PMIVUNIQ,"#",";             * 3
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                  * 3
            ENDIF
          ENDIF
.
          COMPARE     ISBLFLAG,ZERO
          IF        !@EQUAL
              COMPARE     SAVFLAG,ZERO
                IF          !@EQUAL
                  WRITE     HTMLFILE;"#"",SP1,"#",";              * 3
                ENDIF
          ENDIF
.
          MATCH     "00000000",ADATE
          IF        @EQUAL
            WRITE     HTMLFILE;"#"","O/S Debt.","#",";            * 4
            WRITE     HTMLFILE;"#"",PVIDATE,"#",";                * 5
            GOTO      PRPAT400
          ENDIF
.
          REP       " 0",PVIDATE
          MATCH     "00000000",PVIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"#"","Cancelled","#",";            * 4
            WRITE     HTMLFILE;"#"",PVIDATE,"#",";                * 5
          ELSE
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#","; *4
            WRITE     HTMLFILE;"#"",PVIDATE,"#",";                * 5
          ENDIF
.
          GOTO        PRPAT400 
.
PRPAT302  MOVE      ZERO,VISITTYP
          LOAD      VISITTYP,PINVSYS,ONE,TWO,THREE
.
          IF        HOSPFLAG=1
            WRITE     HTMLFILE;"<tr><td>",PMVXMHOS,"&nbsp;</td>";
          ELSE 
            WRITE     HTMLFILE;"<tr>";
          ENDIF
.
          IF        SAVFLAG=1
            WRITE     HTMLFILE;"<td align=left>":
                               "<font color=#FF0000><b>",PINVADM:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=left>",PINVADM,"</td>";
          ENDIF
.
          IF        ISBLFLAG=1
            MOVE      PINVNO,KEY8
            CALL      RDPMIVB1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<td align=left>",PMIVUNIQ,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          MATCH     "00000000",ADATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>O/S Debt.</td>";
            GOTO      PRPAT400
          ENDIF
.
          REP       " 0",PVIDATE
          MATCH     "00000000",PVIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Cancelled</td>";
          ELSE
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
.
PRPAT400  IF        TBSRTFLG=1
            GOTO      PRPAT401
          ELSE
            GOTO      PRPAT402
          ENDIF
.
PRPAT401  CLEAR     HTMLLINK
          IF        IBCNMHOS=1 & CFEETYP=5
            MATCH     WBSEHOSP,PMVXMHOS
            IF        !@EQUAL
              MOVE      ZERO,INVCEIMG
              APPEND    " ",HTMLLINK
            ELSE
              APPEND    "javascript:InvoiceLink('",HTMLLINK
              MOVE      ONE,INVCEIMG
              APPEND    PINVNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    VISITTYP,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    URNUMBER,HTMLLINK
              APPEND    "')",HTMLLINK
            ENDIF
          ELSE
            APPEND    "javascript:InvoiceLink('",HTMLLINK
            MOVE      ONE,INVCEIMG              
            APPEND    PINVNO,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    VISITTYP,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    URNUMBER,HTMLLINK
            APPEND    "')",HTMLLINK
          ENDIF
          WRITE     HTMLFILE;"#"",HTMLLINK,"#",";                 * 6
          RESET     HTMLLINK          
.
          MATCH     "1",PTINCRST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"","<b><span class=TextRed>":
                               PINVNO,"<span></b>","#",";         * 7
          ELSE
            IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
              WRITE     HTMLFILE;"#"","<b><span class=TextBlue>":
                               PINVNO,"<span></b>","#",";         * 7
            ELSE
              WRITE     HTMLFILE;"#"",PINVNO,"#",";
            ENDIF
          ENDIF          
.
          WRITE     HTMLFILE;"#"",INVCEIMG,"#",";                 * 8 
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            WRITE     HTMLFILE;"#"",PINVDTE,PTINCTIM,"#",";       * 9
          ELSE
            WRITE     HTMLFILE;"#"",PINVDTE,PTINCTIM,"#",";       * 9
          ENDIF
.
          CALL      IRBY0000      * Display Invoice Raised By ?   * 10
          WRITE     HTMLFILE;"#"",VISTDESC,"#",";                 * 11
.
          BRANCH    ISBLFLAG,PRPAT600
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"#"",CLMDESC,"#",";                * 12
          ENDIF
.
          MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"#""," ","#",";                    * 13
          ELSE
            WRITE     HTMLFILE;"#"",HFNDESC,"/",HFNTABL,"#",";    * 13
          ENDIF
          GOTO      PRPAT800
.
PRPAT402  IF        IBCNMHOS=1 & CFEETYP=5
            MATCH     WBSEHOSP,PMVXMHOS
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td><img src=../images/spacer3.gif ":
                                 " class=ListIcon >";
            ELSE
              WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                                 " class=ListIcon onclick='linkInvoice(#"":
                               PINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>";
            ENDIF
          ELSE      
            WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkInvoice(#"":
                               PINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>";
          ENDIF
.
          MATCH     "1",PTINCRST
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=#FF0000><b>",PINVNO:
                               "</font></b></td>";
          ELSE
            IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
              WRITE     HTMLFILE;"<font color=#0000FF><b>",PINVNO:
                                 "</font></b></td>";
            ELSE
              WRITE     HTMLFILE;PINVNO,"</td>";
            ENDIF
          ENDIF
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",PTINCTIM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td>";
          ENDIF
.
          CALL      IRBY0000      * Display Invoice Raised By ?
          WRITE     HTMLFILE;"<td>",VISTDESC,"</td>";
.
          BRANCH    ISBLFLAG,PRPAT600
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td>",CLMDESC,"</td>";
          ENDIF
.
          MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",HFNDESC,"/",HFNTABL,"</td>";
          ENDIF
          GOTO      PRPAT800
.
.         Independence Services billing
.
PRPAT600  IF    TBSRTFLG=1
            WRITE     HTMLFILE;"#"",CLMDESC,"#",";                * 12
            CALL      GPYR0000             * Get name of payer
            WRITE     HTMLFILE;"#"",PACFNAME,"#",";               * 13
          ELSE
            WRITE     HTMLFILE;"<td>",CLMDESC,"</td>";            * 12
            CALL      GPYR0000             * Get name of payer
            WRITE     HTMLFILE;"<td>",PACFNAME,"</td>";           * 13
          ENDIF 
.
PRPAT800  MOVE      PINVJOUR,FORM8P2
          ADD       PTINGSTJ,FORM8P2
.
          IF        TBSRTFLG = 1
            GOTO      PRPAT801
          ELSE
            GOTO      PRPAT802
          ENDIF
.
PRPAT801 IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"#"","<b><span class=TextBlue>",PINVAMT:
                                 "</b></span>","#",";             * 14
          ELSE
            WRITE     HTMLFILE;"#"",PINVAMT,"#",";                * 14
          ENDIF
          WRITE     HTMLFILE;"#"",TOTPAID,CPNDFLAG,"#",";         * 15   
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          IF        !@EQUAL
            ADD       PTINCRTT,FORM8P2
            WRITE     HTMLFILE;"#"","<b><span class=TextRed>":
                                 FORM8P2,"</span></b>","#",";     * 16
          ELSE
            WRITE     HTMLFILE;"#"",FORM8P2,"#",";                * 16
          ENDIF
.
          IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"#"","<b><span class=TextBlue>":
                                 TOTOUTS,"</span></b>","#",";     * 17
          ELSE
            WRITE     HTMLFILE;"#"",TOTOUTS,"#",";                * 17 
          ENDIF
.
          WRITE     HTMLFILE;"#"",PINVNO,"#",";                   * 18
          WRITE     HTMLFILE;"#"",PINVAMT,"#",";                  * 19
          WRITE     HTMLFILE;"#"",FORM8P2,"#",";                  * 20
          WRITE     HTMLFILE;"#"",TOTOUTS,"#","                   * 21
          WRITE     HTMLFILE;"#"",TOTPAID,"#");"                  * 22
          ADD       ONE,ROWCOUNT
.
          GOTO      PRPAT100           
.
PRPAT802  IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#0000FF><b>",PINVAMT:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",TOTPAID,CPNDFLAG,"</td>";
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          IF        !@EQUAL
            ADD       PTINCRTT,FORM8P2
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#FF0000><b>",FORM8P2:
                               "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM8P2,"</td>";
          ENDIF
.
          IF        PINVTYP = 2 | (PINVAMT<>0 & PINVREB=0)
            WRITE     HTMLFILE;"<td align=right>":
                               "<font color=#0000FF><b>",TOTOUTS:
                               "</font></b></td></tr>"
          ELSE 
            WRITE     HTMLFILE;"<td align=right>",TOTOUTS,"</td></tr>"
          ENDIF
          ADD       ONE,ROWCOUNT
.
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PRPAT100 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
PRPAT999  RETURN
+
.------------------------------------------------------------
.         Get payer
.------------------------------------------------------------
GPYR0000  PACK      PACFNAME,SP70
          PACK      KEY22,PINVADM,PINVCLM,SP70
          CALL      RSPMPBR1
          CALL      RKPMPBR1
          BRANCH    OVRCD,GPYR8000
.
          PACK      KEY11,PMPBADMN,PMPBCLTY,SP70
          MATCH     KEY11,KEY22
          GOTO      GPYR8000 IF NOT EQUAL
.
          PACK      KEY19,URNUMBER,PMPBCLTY,PMPBEFDT,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,GPYR8000
.
          MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          GOTO      GPYR9000
.
GPYR8000  MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
.
GPYR9000  MOVE      ONE,PACFRMT
          CALL      PACNAME                 * Format the patient name
.
GPYR9999  RETURN
+
.------------------------------------------------------------
.         Print Private Practice Invoice
.------------------------------------------------------------
PRPRI000  OPEN      PRISECA1,"prisecaf"
          OPEN      PRIALSA1,"prialsaf"
          MOVE      SCANFLAG,DPRINSCN
          PACK      KEY18,URNUMBER,DPRINSCN,Z70
          CALL      RSPRIN3
PRPRI100  CALL      RPPRIN3
.          IF        TBSRTFLG=1
.            IF        OVRCD=1
.             MOVE      ZERO,SHOWFLAG     * PRPRI301 END CASE
.            ENDIF
.          ENDIF
.
          BRANCH    OVRCD,PRPRI999
.
          MATCH     URNUMBER,PRINDEBT
          GOTO      PRPRI999 IF NOT EQUAL
.
          COMPARE   SCANFLAG,PRINSCAN
          GOTO      PRPRI999 IF NOT EQUAL    * Debtor record
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      PRPRI120 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRINPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,PRPRI100          * no access
.
PRPRI120  BRANCH    TOTLFLAG,PRPRI200         * Calculate total only
.
          MOVE      PFUNDH,HFNDESC
          MOVE      PFNDTB,HFNTABL
.
PRPRI200  MOVE      PRINPAMT,TOTPAID     * Total Paid
          ADD       PRINHAMT,TOTPAID
          ADD       PRINIAMT,TOTPAID
          ADD       PRINMAMT,TOTPAID
          ADD       PRINVAMT,TOTPAID
          ADD       PRINOTHA,TOTPAID
.
          MOVE      ONE,F1
          MOVE      PRINNUMB,PINVNO
          PACK      KEY12,SP4,PRINNUMB,SP70  * set up invoice number
          MOVE      PRINDEBT,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PRINITOT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PRINJAMT,TOTOUTS
          ADD       PRINGSTJ,TOTOUTS
          ADD       PRINCNTT,TOTOUTS
.
.         Skip invoices with zero or negative outstandaing balance
.
          IF        NZEROFLG=1
            IF        TOTOUTS<=0
              GOTO      PRPRI100            
            ENDIF
          ENDIF
.
.         Check line number for display invoices
.
          IF        TOTLFLAG=0
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PRPRI100
            ENDIF
            GOTO      PRPRI300
          ENDIF
.         
.         Accumulate totals
.
          ADD       PRINITOT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PRINJAMT,SUMJR
          ADD       PRINGSTJ,SUMJR
          ADD       PRINCNTT,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PRPRI100
.
PRPRI300  MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PRINCLAM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          MOVE      PRINPRAC,VISTDESC      * Medical Practice
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      FOUR,VISITTYP
.
          IF        TBSRTFLG =1
            WRITE     HTMLFILE;"t.addRow(#"","  ","#",":          * 0
                               "#"","  ","#",":                   * 1
                               "#"","  ","#",":                   * 2
                               "#"","  ","#",":                   * 3 
                               "#"","  ","#",":                   * 4
                               "#"","  ","#",";                   * 5
            GOTO      PRPRI301
          ELSE
            GOTO      PRPRI302
          ENDIF
.
PRPRI301  IF        PPRCFLAG=1
            CALL      GINDC000       * Get patient indicator
            CLEAR     HTMLLINK
            APPEND    "javascript:InvoiceLink('",HTMLLINK
            MOVE      ONE,INVCEIMG                
            APPEND    PRINNUMB,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    VISITTYP,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    URNUMBER,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PRINUNIQ,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PRINPRAC,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PRINDOCT,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PATINDIC,HTMLLINK
            APPEND    "')",HTMLLINK
            WRITE     HTMLFILE;"#"",HTMLLINK,"#",";
            RESET     HTMLLINK                                    * 6
.
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:InvoiceLink('",HTMLLINK
            MOVE      ONE,INVCEIMG                 
            APPEND    PRINNUMB,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    VISITTYP,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    URNUMBER,HTMLLINK
            APPEND    "')",HTMLLINK
            WRITE     HTMLFILE;"#"",HTMLLINK,"#",";               * 6
            RESET     HTMLLINK
.
          ENDIF
.
          MATCH     "1",PRINCNST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"","<b><span class=TextRed>":
                               PRINNUMB,"<span></b>","#",";       * 7
          ELSE
            WRITE     HTMLFILE;"#"",PRINNUMB,"#",";               * 7
          ENDIF
.
          WRITE     HTMLFILE;"#"",INVCEIMG,"#",";                 * 8
.
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            IF         VISITTYP = 4
              WRITE     HTMLFILE;"#"",PRINDATE,PRINCTIM,"#",";     * 9
            ELSE
              WRITE     HTMLFILE;"#"",PRINDATE,PTINCTIM,"#",";     * 9
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",PRINDATE,"#",";                * 9
          ENDIF
.
          MOVE      PRINCUID,PTINCUID                             * 10
          CALL      IRBY0000      * Display Invoice Raised By ?
          WRITE     HTMLFILE;"#"",VISTDESC,"#",";                 * 11
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"#"",CLMDESC,"#",";                * 12
          ELSE
            WRITE     HTMLFILE;"#""," ","#",";                    * 12
          ENDIF
.
          MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"#""," ","#",";                    * 13
          ELSE
            WRITE     HTMLFILE;"#"",HFNDESC,"/",HFNTABL,"#",";    * 13
          ENDIF
          WRITE     HTMLFILE;"#"",PRINITOT,"#",";                 * 14
. check with jill and ebon
          IF        DSCNFLAG=1
            WRITE     HTMLFILE;"#"","<span class=TextDarkBlue>":
                                 TOTPAID,CPNDFLAG,"</span>","#",";  *15
          ELSE
            WRITE     HTMLFILE;"#"",TOTPAID,CPNDFLAG,"#",";         *15
          ENDIF
.
          REP       " 0",PRINCNST
          MATCH     "0",PRINCNST
          IF        !@EQUAL
            ADD       PRINCNTT,PRINJAMT
             WRITE     HTMLFILE;"#"","<b><span class=TextRed>":
                                 PRINJAMT,"</span></b>","#",";    * 16
          ELSE
            WRITE     HTMLFILE;"#"",PRINJAMT,"#",";               * 16
          ENDIF
          WRITE     HTMLFILE;"#"",TOTOUTS,"#",";                  * 17
          WRITE     HTMLFILE;"#"",PRINNUMB,"#",";                 * 18
          WRITE     HTMLFILE;"#"",PRINITOT,"#",";                 * 19
          WRITE     HTMLFILE;"#"",PRINJAMT,"#",";                 * 20
          WRITE     HTMLFILE;"#"",TOTOUTS,"#","                   * 21
          WRITE     HTMLFILE;"#"",TOTPAID,"#");"                  * 22
          ADD       ONE,ROWCOUNT         
.
          GOTO      PRPRI100
.
PRPRI302  IF        PPRCFLAG=1
            WRITE     HTMLFILE;"<tr>";
            CALL      GINDC000       * Get patient indicator
            WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkInvoice(#"":
                             PRINNUMB,"#",#"",VISITTYP,"#",#"",URNUMBER,"#",#"":
                             PRINUNIQ,"#",#"",PRINPRAC,"#",#"",PRINDOCT,"#",#"":
                             PATINDIC,"#")'>";
            MATCH     "1",PRINCNST
            IF        @EQUAL
              WRITE     HTMLFILE;"<font color=#FF0000><b>",PRINNUMB:
                               "</font></b></td>";
            ELSE
              WRITE     HTMLFILE;PRINNUMB,"</td>";
            ENDIF
          ELSE
            IF        HOSPFLAG=1
              WRITE     HTMLFILE;"<tr><td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<tr>";
            ENDIF
            IF        ISBLFLAG=1
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td align=left>&nbsp;</td>":
                                 "<td>&nbsp;</td>":
                               "<td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkInvoice(#"":
                             PRINNUMB,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>";
            MATCH     "1",PRINCNST
            IF        @EQUAL
              WRITE     HTMLFILE;"<font color=#FF0000><b>",PRINNUMB:
                               "</font></b></td>";
            ELSE
              WRITE     HTMLFILE;PRINNUMB,"</td>";
            ENDIF
          ENDIF
.
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            IF         VISITTYP = 4
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",PRINCTIM,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 " at ",PTINCTIM,"</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td>";
          ENDIF
.
          MOVE      PRINCUID,PTINCUID
          CALL      IRBY0000      * Display Invoice Raised By ?
          WRITE     HTMLFILE;"<td>",VISTDESC,"</td>";
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td>",CLMDESC,"</td>";
          ENDIF
.
          MATCH     "&nbsp",HFNDESC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",HFNDESC,"/",HFNTABL,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",PRINITOT,"</td>";
.
          IF        DSCNFLAG=1
            WRITE     HTMLFILE;"<td align=right><font color=#000080><b>":
                               TOTPAID,CPNDFLAG,"</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",TOTPAID,CPNDFLAG,"</td>";
          ENDIF
.
          REP       " 0",PRINCNST
          MATCH     "0",PRINCNST
          IF        !@EQUAL
            ADD       PRINCNTT,PRINJAMT
            WRITE     HTMLFILE;"<td align=right>":
                              "<font color=#FF0000><b>",PRINJAMT:
                              "</font></b></td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",PRINJAMT,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",TOTOUTS,"</td></tr>"
          ADD       ONE,ROWCOUNT
.
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PRPRI100 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
PRPRI999  RETURN
+
.------------------------------------------------------------
.         Get patient indicator 
.------------------------------------------------------------
GINDC000  MOVE      ONE,VSCANPMI
          PACK      KEY24,PRINDEBT,VSCANPMI,PRINNUMB,SP10
          CALL      RSPRDT3                      * position in file
          CALL      RKPRDT3                      * read next record
          BRANCH    OVRCD,GINDC900               * end of file
.
          MATCH     PRINDEBT,PRDTDEBT            * same debtor ?
          GOTO      GINDC900 IF NOT EQUAL        * no
.
          COMPARE   ONE,PRDTSCAN                 * same scan flag ?
          GOTO      GINDC900 IF NOT EQUAL        * no
.
          MATCH     PRDTINVN,PRINNUMB            * same invoice number ?
          GOTO      GINDC900 IF NOT EQUAL
.
          MOVE      PRDTCODE,PATINDIC
          GOTO      GINDC999
.
GINDC900  MOVE      SP10,PATINDIC
GINDC999  RETURN
+
.------------------------------------------------------------
.         Print invoices from Sundry debtors by U/R
.------------------------------------------------------------
PRDBT000  COMPARE   ONE,HSYS6
          GOTO      PRDBT999 IF NOT EQUAL * no debtors
.
.         UR Number
.
          MATCH     SP70,URNUMBER
          GOTO      PRDBT999 IF EQUAL
.
          PACK      KEY16,URNUMBER,Z70
          CALL      RSDBDB4
PRDBT100  CALL      RPDBDB4              * next debtor number
.          IF        TBSRTFLG=1
.            IF        OVRCD=1
.             MOVE      ZERO,SHOWFLAG     * PRDBT900 END CASE
.            ENDIF
.          ENDIF
.
          BRANCH    OVRCD,PRDBT999
.
          MATCH     URNUMBER,DBDBPUR
          GOTO      PRDBT999 IF NOT EQUAL  * not same U/R
.
.         Get invoices details for this debtor
.
PRDBT120  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
          MOVE      ZERO,LASTINV
.
          MOVE      SP10,DEBINVNO        * Save invoice number
          PACK      KEY36,DBDBDEB,SP70
          CALL      RSDBFD6
PRDBT200  CALL      RKDBFD6
          BRANCH    OVRCD,PRDBT390       * Next debtor code
.
          MATCH     DBDBDEB,DBFDDEB
          GOTO      PRDBT390 IF NOT EQUAL   * Not same debtor
.
          MATCH     DBFDINV,DEBINVNO
          GOTO      PRDBT400 IF NOT EQUAL   * print invoice details

PRDBT300  MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,PRDBT310,PRDBT320,PRDBT320,PRDBT340,PRDBT350
          GOTO      PRDBT200
.
PRDBT310  ADD       DBFDTOT,PINVAMT     * invoice amount
          ADD       DBFDTAX,PINVAMT     * Tax amount
          GOTO      PRDBT200
.
PRDBT320  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      PRDBT200
.
PRDBT340  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      PRDBT200
.
PRDBT350  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      PRDBT200
.
PRDBT390  MOVE      ONE,LASTINV          * no more invoice for this debtor
.
PRDBT400  MATCH     SP10,DEBINVNO
          GOTO      PRDBT900 IF EQUAL    * first record
.
          MOVE      ZERO,F1
          MOVE      SP70,PRINNUMB
          PACK      KEY12,DEBINVNO,SP70 * set up invoice number
          MOVE      DBFDDEB,SAVURNUM
          CALL      CPND0000             * Get cash pending for the invoice
.
          MOVE      PINVAMT,TOTOUTS    * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
.
.         Skip invoices with zero or negative outstanding balance
.
          IF        NZEROFLG=1
            IF        TOTOUTS<=0
              GOTO      PRDBT520           
            ENDIF
          ENDIF
.
.         Check line number for display invoices
.
          IF        TOTLFLAG=0
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PRDBT520
            ENDIF
            GOTO      PRDBT500
          ENDIF
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PRDBT520
.
PRDBT500  MOVE      "Debtors",VISTDESC
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      FIVE,VISITTYP
.
          IF        TBSRTFLG =1
            WRITE     HTMLFILE;"t.addRow(#"","  ","#",":          * 0
                               "#"","  ","#",":                   * 1
                               "#"","  ","#",":                   * 2
                               "#"","  ","#",":                   * 3
                               "#"","  ","#",":                   * 4
                               "#"","  ","#",";                   * 5
            GOTO      PRDBT501
          ELSE
            GOTO      PRDBT502
          ENDIF
.
PRDBT501  CLEAR     HTMLLINK
          APPEND    "javascript:InvoiceLink('",HTMLLINK
          APPEND    "InvoiceIcon.gif",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DEBINVNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    VISITTYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    URNUMBER,HTMLLINK  
          APPEND    "')",HTMLLINK
          WRITE     HTMLFILE;"#"",HTMLLINK,"#",";
          RESET     HTMLLINK                                      * 6
          WRITE     HTMLFILE;"#"",DEBINVNO,"#",";                 * 7
          WRITE     HTMLFILE;"#"",INVCEIMG,"#",";                 * 8
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            WRITE     HTMLFILE;"#"",PINVDTE,PTINCTIM,"#",";       * 9
          ELSE
            WRITE     HTMLFILE;"#"",PINVDTE,PTINCTIM,"#",";       * 9
          ENDIF
.
          CALL      IRBY0000      * Display Invoice Raised By ?   * 10
          WRITE     HTMLFILE;"#"",VISTDESC,"#",";                 * 11
          WRITE     HTMLFILE;"#""," ","#",";                      * 12
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"#""," ","#",";                    * 13
          ELSE
            WRITE     HTMLFILE;"#""," ","#",";                    * 13
          ENDIF
.
          WRITE     HTMLFILE;"#"",PINVAMT,"#",";                 * 14
          WRITE     HTMLFILE;"#"",TOTPAID,CPNDFLAG,"#",";        * 15   
          WRITE     HTMLFILE;"#"",PINVJOUR,"#",";                * 16
          WRITE     HTMLFILE;"#"",TOTOUTS,"#","                  * 17
          WRITE     HTMLFILE;"#"",DEBINVNO,"#","                 * 18
          WRITE     HTMLFILE;"#"",PINVAMT,"#","                  * 19
          WRITE     HTMLFILE;"#"",PINVJOUR,"#","                 * 20
          WRITE     HTMLFILE;"#"",TOTOUTS,"#","                  * 21
          WRITE     HTMLFILE;"#"",TOTPAID,"#");"                 * 22
.
          GOTO      PRDBT520  
.
PRDBT502  WRITE     HTMLFILE;"<tr><td align=left>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        ISBLFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkInvoice(#"":
                             DEBINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>":
                                DEBINVNO,"</td>";
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH      "2",PTCNIRAI
          IF         @EQUAL
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",PTINCTIM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td>";
          ENDIF
.
          CALL      IRBY0000      * Display Invoice Raised By ?
          WRITE     HTMLFILE;"<td>",VISTDESC,"</td>":
                             "<td>&nbsp;</td>";
.
          IF        NOCOMPCL<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",TOTPAID,CPNDFLAG,"</td>":
                             "<td align=right>",PINVJOUR,"</td>":
                             "<td align=right>",TOTOUTS,"</td></tr>"
.
          ADD       ONE,ROWCOUNT
.
PRDBT520  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
.
PRDBT900  MOVE      DBFDINV,DEBINVNO
          MOVE      DBFDIDAT,PINVDTE
.
          BRANCH    TOTLFLAG,PRDBT920        * Calculate total only
.
          IF        TBSRTFLG =1
            GOTO      PRDBT920
          ELSE
            COMPARE   NORECORD,ROWCOUNT
            GOTO      PRDBT920 IF NOT EQUAL
            MOVE      ZERO,SHOWFLAG
            GOTO      PRDBT999
          ENDIF
.
PRDBT920  COMPARE   ONE,LASTINV
          GOTO      PRDBT300 IF NOT EQUAL
          GOTO      PRDBT100
.
PRDBT999  RETURN
+
.------------------------------------------------------------
. Table of Private Practice Debtors Invoice Details
. TOTLFLAG=1 - calculate total only and loop through the file
.              again to display screen.
.------------------------------------------------------------
PPINVC00  MATCH     SP70,URNUMBER
          GOTO      PPINVC99 IF EQUAL
.
          MOVE      ONE,SHOWFLAG            * Show no more invoice message
          COMPARE   ONE,TOTLFLAG
          GOTO      PPINVC10 IF NOT EQUAL
.
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          GOTO      PPINVC20
.
PPINVC10  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
PPINVC20  MOVE      ZERO,SCANFLAG
          MOVE      ZERO,HOSPFLAG
          MOVE      ZERO,ISBLFLAG
          CALL      PRPRI000                * Print Private Practice invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      PPINVC99 IF EQUAL
.
          BRANCH    TOTLFLAG,PPINVC90        * calculate total only
.
          IF        ROWCOUNT>0
            WRITE     HTMLFILE;"<tr><td>Total</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right><b>",SUMINV,"</b></td>":
                               "<td align=right><b>",SUMPAID,"</b></td>":
                               "<td align=right><b>",SUMJR,"</b></td>":
                               "<td align=right><b>",SUMOUTS,"</b></td></tr>"
          ENDIF
          GOTO      PPINVC99
.
PPINVC90  IF        TOTLFLAG=1
            MOVE      ZERO,TOTLFLAG
            GOTO      PPINVC00
          ENDIF
PPINVC99  RETURN
+
.------------------------------------------------------------
. Table of Account Receivable Debtors Invoice Details
. TOTLFLAG=1 - calculate total only and loop through the file
.              again to display screen.
.------------------------------------------------------------
ARINVC00  MATCH     SP70,URNUMBER
          GOTO      ARINVC99 IF EQUAL
.
          MOVE      ONE,SHOWFLAG            * Show no more invoice message
          COMPARE   ONE,TOTLFLAG
          GOTO      ARINVC10 IF NOT EQUAL
.
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          GOTO      ARINVC20
.
ARINVC10  IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
ARINVC20  CALL      PDDBT000                * Print Sundry Debtors invoices
          COMPARE   ZERO,SHOWFLAG
          GOTO      ARINVC99 IF EQUAL
.
          BRANCH    TOTLFLAG,ARINVC90        * calculate total only
.
          IF        ROWCOUNT>0
            WRITE     HTMLFILE;"<td>Total</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right><b>",SUMINV,"</b></td>":
                               "<td align=right><b>",SUMPAID,"</b></td>":
                               "<td align=right><b>",SUMJR,"</b></td>":
                               "<td align=right><b>",SUMOUTS,"</b></td>":
                               "</tr>"
          ENDIF
          GOTO      ARINVC99
.
ARINVC90  IF        TOTLFLAG=1
            MOVE      ZERO,TOTLFLAG
            GOTO      ARINVC00
          ENDIF
ARINVC99  RETURN
+
.------------------------------------------------------------
.         Print invoices from Sundry debtors by debtor number
.------------------------------------------------------------
PDDBT000  COMPARE   ONE,HSYS6
          GOTO      PDDBT999 IF NOT EQUAL    * no debtors file
.
.         Debtor Number
.
          REP       "~&",URNUMBER
.    
          PACK      KEY8,URNUMBER,SP70
          CALL      RDDBDB1
          BRANCH    OVRCD,PDDBT999
.          
.         Get invoices details for this debtor
.
PDDBT120  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
          MOVE      ZERO,LASTINV
.
          MOVE      SP10,DEBINVNO        * Save invoice number
          PACK      KEY36,DBDBDEB,SP70
          CALL      RSDBFD6
PDDBT200  CALL      RKDBFD6
          BRANCH    OVRCD,PDDBT390       * Next debtor code
.
          MATCH     DBDBDEB,DBFDDEB
          GOTO      PDDBT390 IF NOT EQUAL   * Not same debtor
.
          MATCH     DBFDINV,DEBINVNO
          GOTO      PDDBT400 IF NOT EQUAL   * print invoice details
.
PDDBT300  MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,PDDBT310,PDDBT320,PDDBT320,PDDBT340,PDDBT350
          GOTO      PDDBT200
.
PDDBT310  ADD       DBFDTOT,PINVAMT     * invoice amount
          ADD       DBFDTAX,PINVAMT     * Tax amount
          GOTO      PDDBT200
.
PDDBT320  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      PDDBT200
.
PDDBT340  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      PDDBT200
.
PDDBT350  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      PDDBT200
.
PDDBT390  MOVE      ONE,LASTINV          * no more invoice for this debtor
.
PDDBT400  MATCH     SP10,DEBINVNO
          GOTO      PDDBT900 IF EQUAL    * first record
.
          MOVE      PINVAMT,TOTOUTS    * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
.
          IF        NZEROFLG=1
            IF        TOTOUTS<=0
              GOTO      PDDBT520           
            ENDIF
          ENDIF
.
.         Check line number for Display Invoice
.
          IF        TOTLFLAG=0
            ADD       ONE,RECNUMB
            IF        STARTNUM>=RECNUMB
              GOTO      PDDBT520
            ENDIF
            GOTO      PDDBT500 
          ENDIF
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       TOTOUTS,SUMOUTS
          GOTO      PDDBT520
.
PDDBT500  MOVE      "Debtors",VISTDESC
.
.         Visit type - 1 A&E, 2 OUT, 3 INP, 4 PRIV PRAC, 5 DEBTORS
.
          MOVE      FIVE,VISITTYP
.
          WRITE     HTMLFILE;"<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkInvoice(#"":
                             DEBINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>":
                                DEBINVNO,"</td>";
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",VISTDESC,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",TOTPAID,"</td>":
                             "<td align=right>",PINVJOUR,"</td>":
                             "<td align=right>",TOTOUTS,"</td>":
                             "</tr>"
.
          ADD       ONE,ROWCOUNT
.
PDDBT520  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
.
PDDBT900  MOVE      DBFDINV,DEBINVNO
          MOVE      DBFDIDAT,PINVDTE
.
          COMPARE   ONE,LASTINV
          GOTO      PDDBT300 IF NOT EQUAL
.
          BRANCH    TOTLFLAG,PDDBT999        * Calculate total only
.
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PDDBT999 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
PDDBT999  RETURN
+
.-----------------------------------------------------------------------
.         Get cash pending for an invoice 
.-----------------------------------------------------------------------
CPND0000  MOVE      SP70,CPNDFLAG      * Default to 'No cash pending'
          MOVE      ZERO,DSCNFLAG
          MOVE      ZERO,FORM2
.
.         Check if any unreleased deposit
.
          MOVE      KEY12,SAVKEY12
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
CPND2200  CALL      RKRCDTE3
          BRANCH    OVRCD,CPND9999
          MATCH     SAVKEY12,RCDTINVN
          GOTO      CPND9999 IF NOT EQUAL
.
          MATCH     SAVURNUM,RCDTURNO        * Same U/R number ?
          GOTO      CPND2200 IF NOT EQUAL
.
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,CPND2200
.
.         F1 =1  for Private Practice, F1 =0 for Inp/Out/EMR Patients
.
          COMPARE   "2",REGIBACD
          GOTO      CPND5000 IF EQUAL       * Private Practice
          COMPARE   "96",REGIBACD
          GOTO      CPND5000 IF EQUAL       * PRI Deposit
.
          COMPARE   ZERO,F1
          GOTO      CPND8000 IF EQUAL       * F1=0 for Patients
          GOTO      CPND2200
.
CPND5000  BRANCH    F1,CPND8000             * F1=1 for Private practice
          GOTO      CPND2200
.
CPND8000  PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          COMPARE   ZERO,OVRCD
          GOTO      CPND2200 IF EQUAL       * payment released
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CPND2200
          MATCH     "0",RCBNSTAT               * Cash Not banked?
          GOTO      CPND2200 IF NOT EQUAL
          MOVE      "*",CPNDFLAG               * Flag for cash pending 
.
          IF        RCDTDISC<>0
            ADD       ONE,DSCNFLAG
          ENDIF
.
          MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,TOTPAID
          GOTO      CPND2200
.
CPND9999  RETURN
+
.------------------------------------------------------------
. Get health fund
.------------------------------------------------------------
HFUND000  MOVE      SP70,HFNDESC
          MOVE      SP70,HFNTABL
          BRANCH    PVITYPE,HFUND100,HFUND200,HFUND300
          GOTO      HFUND900
.
HFUND100  BRANCH    EMRVFLAG,HFUND900      * No EMR Visit Table
          PACK      KEY8,PINVADM,SP70     * Read Emergency Visit File 
          CALL      RDEMVIS1
          BRANCH    OVRCD,HFUND900
          MOVE      EMVIFUND,HFNDESC          * Health Fund Set  
          MOVE      EMVITABL,HFNTABL
          GOTO      HFUND900
.
HFUND200  PACK      KEY8,PINVADM,SP70     * Read OUT - Session Booking File B
          CALL      RDBOKB1
          BRANCH    OVRCD,HFUND900
          MOVE      OTBBFUND,HFNDESC      * Health Fund Set 
          MOVE      OTBBTBLE,HFNTABL
          GOTO      HFUND900
.
HFUND300  MOVE      AFUNDH,HFNDESC        * Master File Var (Already read)
          MOVE      AFNDTB,HFNTABL
.
          IF        CFEETYP=5 
            MOVE      "&nbsp",HFNDESC
            MOVE      "&nbsp",HFNTABL
            MATCH     SP70,PTINHFND
            IF        !@EQUAL
              MOVE      PTINHFND,HFNDESC 
            ENDIF
          ENDIF
.
          GOTO      HFUND900
.
HFUND900  MATCH     SP10,HFNDESC
          IF        @EQUAL
            MOVE      "&nbsp",HFNDESC
            MOVE      "&nbsp",HFNTABL
          ENDIF
HFUND999  RETURN
+
.------------------------------------------------------------
. Calculate different option dates for bed transfer date. 
.------------------------------------------------------------
CDATE000  CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,FAILCNT
.
CDATE100  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     TODAY,KEY8
          GOTO      CDATE200 IF EQUAL
          GOTO      CDATE200 IF NOT LESS
          ADD       ONE,FAILCNT
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                               MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          IF        FAILCNT<100
            GOTO      CDATE100
          ENDIF
.
CDATE200  MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                               MTHNAM3,SP1,CCENT,CYEAR,"</option>";
.
CDATE999  RETURN
.------------------------------------------------------------
.   Verify Patient Invoice
.------------------------------------------------------------
INVD0000  BRANCH    FLDITMNO,INVD0100,INVD0200,INVD0300,INVD0400
          GOTO      INVD9999
.
INVD0100  CALL      SELPRT00                * Select Printer
          GOTO      INVD9999
.
INVD0200  CALL      FRMDAT00
          GOTO      INVD9999
.
INVD0300  CALL      TODATE00 
          GOTO      INVD9999
.
INVD0400  CALL      DSIV0000                * Display INP Invoice
          GOTO      INVD9999
.
INVD9999  RETURN
.------------------------------------------------------------
. Invoice From Date
.------------------------------------------------------------
FRMDAT00  PACK      KEY16,AADMNO,Z70
          CALL      RDSINV3
FRMDAT10  CALL      RDPINV3
          BRANCH    OVRCD,FRMDAT20
.
          MATCH     AADMNO,PINVADM
          GOTO      FRMDAT20 IF NOT EQUAL
.
          MATCH     ZEROVISN,PINVADM
          GOTO      FRMDAT20 IF EQUAL       * invoice cancelled
.
          COMPARE   "3",PINVSYS
          GOTO      FRMDAT10 IF NOT EQUAL 
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY 
          CALL      IBACLOCK
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      FRMDAT99
.
FRMDAT20  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY 
          CALL      IBACLOCK
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
FRMDAT99  RETURN
.------------------------------------------------------------
. Invoice To Date
.------------------------------------------------------------
TODATE00  COMPARE   "3",ASTAT
          GOTO      TODATE10 IF EQUAL
.
.   Patient admitted - use current date
.
          CALL      IBACLOCK
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDD,SP1,MTHNAM3,SP1,CCC,CYEAR;
          GOTO      TODATE99
.
.  Patient discharged - use discharged date
.
TODATE10  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY 
          CALL      IBACLOCK
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;

TODATE99  RETURN
.------------------------------------------------------------
. Display INP Invoice Details
.------------------------------------------------------------
DSIV0000  MOVE      ONE,PROGFLAG
          CALL      CLPATDSC
          PACK      KEY8,AADMNO
          CALL      RDDSCH1
          IF        OVRCD<>1
            MOVE      ZERO,ITEMFLAG         *Input items flag - no
            MATCH     ADATE,DDATE
            CALL      CATDC000 IF EQUAL     *Change admission type for daycases
          ENDIF 
          CALL      CALCTBI 
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          PACK      ADIAG,ADIAG1,ADIAG2
.
          MOVE      TWO,PROGFLAG
          MOVE      ONE,INVPRTD
          CALL      INVPRT                          *Display the invoice
.
          MOVE      ZERO,EXIT
          GOTO      DSIV9999
.
DSIV9000  MOVE      "Patient Locked",WEBTITLE
          CALL      WEBERR00 
          MOVE      ONE,EXIT
.
DSIV9999  RETURN
+
.------------------------------------------------------------
.   Update person responsible for account
.------------------------------------------------------------
UPPRA000  MOVE      ADMISSNO,PKADMN
          MOVE      PKADMN,KEY8
.
          MATCH     SP70,PKNAME             * If no name don't write a record
          GOTO      UPPRA200 IF EQUAL
.
          CALL      RDARESP1
          BRANCH    OVRCD,UPPRA100
.
          CALL      UPRESP1
          GOTO      UPPRA900
.
UPPRA100  CALL      WRRESP1
          GOTO      UPPRA900
.
UPPRA200  CALL      RDRESP1
          BRANCH    OVRCD,UPPRA900
          CALL      DERESP1
.
UPPRA900  CALL      UPRI0000         * Update private practice prfa 
UPPRA999  RETURN
+
.------------------------------------------------------------
.         Check for private practice, get the unique number
.------------------------------------------------------------
UPRI0000  PACK      KEY27,URNUMBER,SP70       * Private Practice Holding Header
          CALL      RSPRHD1
          CALL      RKPRHD1 
          BRANCH    OVRCD,UPRI9999
          MATCH     AURNO,PRHDDEBT
          GOTO      UPRI9999 IF NOT EQUAL      * no private practice
.
          PACK      KEY27,PRHDUNIQ,SP70        
          CALL      RSPRHR1
UPRI2000  CALL      RKPRHR1
          BRANCH    OVRCD,UPRI9999
          COMPARE   PRHDUNIQ,PRHRUNIQ         * same unique number ?
          GOTO      UPRI9999 IF NOT EQUAL
.
          COMPARE   ONE,PRHRPINV
          GOTO      UPRI2000 IF NOT EQUAL     * invoice printed already
.
          MOVE      PKNAME,PRHRNAME
          MOVE      PKADD1,PRHRADD1
          MOVE      PKADD2,PRHRADD2
          MOVE      PKSUBR,PRHRADD3
          MOVE      PKPOST,PRHRPOST
          MOVE      PKTELEP,PRHRTELP
          MOVE      PKTELEB,PRHRTELB
          MOVE      PKRELP,PRHRRELP
...       MOVE      PTREMOBL,PRHRMOBL         * field required in PRIHREFD
          CALL      UPPRHR1
          GOTO      UPRI2000
.
UPRI9999  RETURN
+
.------------------------------------------------------------
. Re-Print Invoice
.------------------------------------------------------------
REPINV00   CALL      IBACLOCK
.
           CALL      CLPATMAS
           CALL      CLPATMIS
           CALL      CLPMSVX1
           CALL      CLPATDSC
.
           PACK      CDATE,CDD,SLASH,CMM,SLASH,CCC,CYY
           REP       " 0",CDATE
           MOVE      SP10,ADATE
           MOVE      ZERO,PRTIFLAG
           MOVE      ZERO,PAGENO
.
           MOVE      ONE,WEBFLAG
           MOVE      INVOICEN,FORM8
           MOVE      FORM8,KEY8
           CALL      RDINV1
           BRANCH    OVRCD,REPINV95
.
           MOVE      PINVADM,ADMISSNO
           MOVE      PINVADM,AADMNO
           MOVE      PINVUR,URNUMBER
.
           MOVE      URNUMBER,KEY8
           CALL      RDMAST1
           MOVE      OVRCD,MASTFLAG
           CALL      RDPMPX21
           MOVE      OVRCD,MASTFLAG
.
           CALL      GPNAME00
.
           MOVE      ZERO,MISSFLAG
           MOVE      ADMISSNO,KEY8
           MATCH     SP70,KEY8
           IF        @EQUAL
             MOVE      ONE,MISSFLAG
             MOVE      ONE,RESPFLAG
             MOVE      ONE,DSCHFLAG
             GOTO      REPINV95
           ENDIF
.
          CALL      RDMISS1
          MOVE      OVRCD,MISSFLAG
.
          MOVE      SP10,DDATE
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
.
          COMPARE   ONE,PINVSYS
          GOTO      REPINV05 IF NOT EQUAL             * Not EMG
.
          CALL      RDPMEVT1
          IF        OVRCD=0
            MOVE      PMEVCCOD,ACLAIM       * Event Claim code
          ENDIF
.
          BRANCH    EMRVFLAG,REPINV05      * No EMR Visit Table
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      EMVIDATE,ADATE
            MOVE      EMVIDDAT,DDATE
            MOVE      EMVICOMP,ACLAIM                                 *I-195368
          ENDIF
.
REPINV05  IF        PINVSYS=2
            CALL      RDBOKB1
            IF        OVRCD=0
              MOVE      OBADATE,ADATE     * admission date
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          MOVE      OVRCD,RESPFLAG
.
          MOVE      SP70,PMVXMHOS
          PACK      KEY8,ADMISSNO
          CALL      RDPMVX11
.
          CALL      OPNPRINT 
          BRANCH    UPDATETY,REPINV10,REPINV20
.
          MOVE      ZERO,INVTYPE
          MOVE      ZERO,JHFLAG
          MATCH     "031",TEMPLATE
          GOTO      REPINV06 IF EQUAL
          MATCH     "032",TEMPLATE
          GOTO      REPINV07 IF NOT EQUAL
.
          MOVE      TWO,INVTYPE         * Details
          MOVE      ONE,JHFLAG
          GOTO      REPINV07
.
REPINV06  MOVE      ONE,INVTYPE           * Summary
          MOVE      ONE,JHFLAG
.
REPINV07  MOVE      ZERO,CRDNFLAG
          CALL      CKIB0000          * Check for Independance services billing
          CALL      INVPRT                * print invoice
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
            BRANCH    EXIT,REPINV99
          ENDIF
.
          IF        PINVSYS=1
            CALL      LADV0000         * ED -Print Lodgement Advice if necessary
          ELSE
            IF        PINVSYS=2
              CALL      DB4F0000       * Outpatient - DB4 Form
            ENDIF
          ENDIF
.
          MATCH     SP70,EXPPAYER
          GOTO      REPINV08 IF EQUAL
.
          PACK      KEY14,ADMISSNO,EXPPAYER,SP70
          CALL      RDVSPAY1
          BRANCH    OVRCD,REPINV08
          MOVE      ONE,VSPAISEN          * Set to Yes for sending invoice
          CALL      UPVSPAY1
.
REPINV08  MOVE      ZERO,EXIT
          GOTO      REPINV99
.
REPINV10  MOVE      CREDITNO,KEY8
          CALL      RDPMCNO1
          BRANCH    OVRCD,REPINV99
.
          MOVE      SP70,EXPPAYER
          IF        CFEETYP=5
            MOVE      PMCNINVN,KEY8
            CALL      RDINV1
            IF        OVRCD=0
              MATCH     SP70,PTINHFND
              IF        @EQUAL
                MOVE      "PRFA  ",EXPPAYER
              ELSE
                MOVE      PTINHFND,EXPPAYER
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PMCNCRNO,PINVNO
.
          MOVE      ONE,CRDNFLAG
          CALL      INVPRT                * print Credit note
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
            BRANCH    EXIT,REPINV99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      REPINV99
.
REPINV20  MOVE      ZERO,CRDNFLAG
          MOVE      ONE,PRTIFLAG          * re-Print invoice without amount
          CALL      INVPRT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
            BRANCH    EXIT,REPINV99
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      REPINV99
.
REPINV95  CLEAR     WEBTITLE
          APPEND    "ERROR : Can't Re-print Invoice - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
REPINV99  RETURN
+
.------------------------------------------------------------------------------
.         Generating a Lodgement of Advice
.------------------------------------------------------------------------------
LADV0000  MATCH     "1",PTCNUESF
          GOTO      LADV9999 IF NOT EQUAL     * Not using store and forward
.
          MATCH     SP70,EMVICOMP
          GOTO      LADV9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LADV9999            * Invalid code
.
          MATCH     "H",TCINDC1
          GOTO      LADV2000 IF EQUAL
          MATCH     "J",TCINDC1
          GOTO      LADV9999 IF NOT EQUAL
.
LADV2000  MOVE      "IBAADT26",SCHDPGID
          MOVE      "Generating a Lodgement of Advice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for ED
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
LADV9999  RETURN
+
.------------------------------------------------------------------------------
.         Generating DB4 Form
.------------------------------------------------------------------------------
DB4F0000  MATCH     "1",PTCNUEBB
          GOTO      DB4F9999 IF NOT EQUAL     * Not using Eclipse Bulk billing
.
          PACK      KEY36,ADMISSNO,PVIDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,DB4F9999
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      DB4F9999 IF NOT EQUAL
.
          MATCH     PVIDATE,OBADATE
          GOTO      DB4F9999 IF NOT EQUAL
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,DB4F9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO:
                          OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,DB4F9999
.
          MATCH     SP70,OBACOMP
          GOTO      DB4F9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4F9999            * Invalid code
.
          MATCH     "P",TCINDC1
          GOTO      DB4F9999 IF NOT EQUAL
.
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4F9999            * Invalid code
.
          MATCH     "P",TCINDC1
          GOTO      DB4F9999 IF NOT EQUAL
.
          MOVE      "IBAADT16",SCHDPGID
          MOVE      "Generating DB4 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
DB4F9999  RETURN
+
.------------------------------------------------------------
.         Get the name of the patient
.------------------------------------------------------------
GPNAME00  CLEAR     PNAME
          REP       ", ",PTITL
          REP       ", ",PGNAME
          REP       ", ",PSNAME
.
          PACK      DIM6 WITH SP1,PTITL,SP1
GPNAME10  CMATCH    SP1,DIM6
          GOTO      GPNAME20 IF NOT EQUAL
          BUMP      DIM6
          GOTO      GPNAME10 IF NOT EOS
          IF        CFEETYP <> 9
            APPEND    PGNAME,PNAME     * original
          ELSE
            APPEND    PSNAME,PNAME     * Singapore
          ENDIF
          GOTO      GPNAME50
.
GPNAME20  APPEND    DIM6,PNAME
GPNAME30  CMATCH    SP1,PNAME
          GOTO      GPNAME40 IF NOT EQUAL
          BUMP      PNAME,-1
          GOTO      GPNAME30 IF NOT EOS
          CLEAR     PNAME
          IF        CFEETYP <> 9
            APPEND    PGNAME,PNAME     * original
          ELSE
            APPEND    PSNAME,PNAME     * Singapore
          ENDIF
          GOTO      GPNAME50
.
GPNAME40  APPEND    SP1,PNAME
          IF        CFEETYP <> 9
            APPEND    PGNAME,PNAME     * original
          ELSE
            APPEND    PSNAME,PNAME     * Singapore
          ENDIF
.
GPNAME50  CMATCH    SP1,PNAME
          GOTO      GPNAME60 IF NOT EQUAL
          BUMP      PNAME,-1
          GOTO      GPNAME50 IF NOT EOS
          CLEAR     PNAME
          IF        CFEETYP <> 9
            APPEND    PSNAME,PNAME     * original
          ELSE
            APPEND    PGNAME,PNAME     * Singapore
          ENDIF
          GOTO      GPNAME70
.
GPNAME60  APPEND    SP1,PNAME
          IF        CFEETYP <> 9
            APPEND    PSNAME,PNAME     * original
          ELSE
            APPEND    PGNAME,PNAME     * Singapore
          ENDIF
.
GPNAME70  APPEND    SP30,PNAME
          APPEND    SP30,PNAME
          RESET     PNAME
GPNAME99  RETURN
+
.------------------------------------------------------------
.         Process Credit ALL for the selected invoice
.------------------------------------------------------------
PRCA0000  MOVE      ZERO,CRDFLAG
          MOVE      SP8,STRACCM
          CALL      GCLM0000               * Get claim code
          MOVE      ONE,CREDITEM
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          MOVE      SP70,SAVESUNQ
          MOVE      SP70,PTDTBTCH
          MOVE      ZERO,XTRDFLAG
          MOVE      SP70,PRIMFUND
.
          PACK      KEY23 WITH ADMISSNO,PINVNO,SP6
          PACK      KEY22 WITH ADMISSNO,PINVNO,SP6
          CALL      RSDTR000
PRCA1000  CALL      RKDTR000
          BRANCH    OVRCD OF PRCA2000
          MATCH     ADMISSNO,DTADMNO
          GOTO      PRCA2000 IF NOT EQUAL
          MATCH     TREF,PINVNO
          GOTO      PRCA2000 IF NOT EQUAL
.
.         Check if it's an accomodation record
.
          COMPARE   NINE,TRECTYPE
          GOTO      PRCA1100 IF EQUAL       * ABF record type
.
          COMPARE   ONE,TRECTYPE
          GOTO      PRCA1200 IF NOT EQUAL
.
PRCA1100  MATCH     SP8,STRACCM
          GOTO      PRCA1200 IF NOT EQUAL
.
          PACK      STRACCM,TFCENT,TFYEAR,TFMONTH,TFDAY   * start of accom.date
          REP       " 0",STRACCM
.
.         If GST is calculated on Invoice total, then calculate accom.GST last
.
PRCA1200  IF        IBCNUGST=3
            BRANCH    TRECTYPE,PRCA1220,PRCA1220,PRCA1220,PRCA1220:
                               PRCA1000,PRCA1000,PRCA1220
            IF        CFEETYP=5
              COMPARE   EIGHT,TRECTYPE
              GOTO      PRCA1220 IF EQUAL      * Procedure record
            ENDIF
          ELSE
            BRANCH    TRECTYPE,PRCA1220,PRCA1220,PRCA1220
            COMPARE   NINE,TRECTYPE
            GOTO      PRCA1220 IF EQUAL   * ABF record type
          ENDIF
.
          IF        CFEETYP<>5 & PINVSYS=1
            COMPARE   EIGHT,TRECTYPE      * Check for EMR Event procedure
            GOTO      PRCA1220 IF EQUAL
            COMPARE   NINE,TRECTYPE       * Check for ABF
            GOTO      PRCA1220 IF EQUAL
          ENDIF
          GOTO      PRCA1000
.
PRCA1220  IF        TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=8
            CALL      GCCR0000            * Get previous amount of credit note
            MOVE      TPATAMTT,PMFCCAMT   * Credit Amount
            MOVE      PTDTGSTM,PMFCCGST   * Credit GST Amount
.
.         If this is not an accommodation record, subtract any previous credit
.         notes amount
.
            ADD       TOTAMT,PMFCCAMT
            IF        CFEETYP=5 & IBCNUGST=3
              MOVE      PMFCCAMT,TGSTEXCV
              CALL      IGST0000                   * Get item GST
            ELSE
              ADD       TOTGST,PMFCCGST
            ENDIF
          ELSE
            MOVE      TPATAMTT,PMFCCAMT            * Credit Amount
            IF        CFEETYP=5 & IBCNUGST=3
              MOVE      PMFCCAMT,TGSTEXCV
              CALL      IGST0000                   * Get item GST
            ELSE    
              MOVE      PTDTGSTM,PMFCCGST          * Credit GST Amount
            ENDIF   
          ENDIF
.
PRCA1300  MULT      "-1",PMFCCAMT
          MULT      "-1",PMFCCGST
          MOVE      ZERO,PMFCPTLS        * Lumpsum amount patient portion     
          MOVE      ZERO,PMFCRBLS        * Lumpsum amount rebate portion      
          MOVE      ZERO,PMFCGSTL        * GST Lumpsum amount                 
          IF        PTINCMIX=1
            IF        PTDTLSPT<>0
              MOVE      PTDTLSPT,PMFCPTLS
              MULT      "-1",PMFCPTLS    * Lumpsum amount patient portion     
            ENDIF
            IF        PTDTLSRB<>0
              MOVE      PTDTLSRB,PMFCRBLS
              MULT      "-1",PMFCRBLS    * Lumpsum amount rebate portion      
            ENDIF
            IF        PTDTGSTL<>0
              MOVE      PTDTGSTL,PMFCGSTL
              MULT      "-1",PMFCGSTL    * GST Lumpsum amount                 
            ENDIF
          ENDIF
.
  IF TRECTYPE=1 | TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=4 | TRECTYPE=7 | TRECTYPE=9
            CALL      WRFCI000       * Write record to pmsfciaf
            IF        PINVSYS = 3 & TRECTYPE = 3
              MOVE      ANSD,PROSFLAG
              CALL      PTRK0000
            ENDIF
          ENDIF
.
          COMPARE   EIGHT,TRECTYPE
          GOTO      PRCA1320 IF NOT EQUAL   * not procedure fee/procedure item
.
          COMPARE   FIVE,CFEETYP
          GOTO      PRCA1310 IF EQUAL       * must be procedure fees
.
          BRANCH    PINVSYS,PRCA1310        * procedure for EMR visit/event
          GOTO      PRCA1320
.
PRCA1310  CALL      WRFCI000       * Procedure fee for NZ or Proc.for EMR Event
.
PRCA1320  MOVE      "1",KEY1       * Fully credited
          STORE     KEY1,PINVSYS,ATDTCRST,OTDTCRST,PTDTCRST
.
          IF        CFEETYP=5 & PINVSYS=3
            PACK      KEY11,ADMISSNO,PTDTSUNQ,SP70
            CALL      RDNZSPR1
            IF        OVRCD=0
              MOVE      NZSPPROC,PTDTCPRC     * Contract Procedure code
            ENDIF
          ENDIF
          CALL      UPDTR000
.
          BRANCH    ISBLFLAG,PRCA1400         * Ind.Services doesn't keep items
.
.         If misc./mbs items are to be kept, write records to pmsmtiaf
.
          COMPARE   ONE,KEEPMISC
          GOTO      PRCA1400 IF NOT EQUAL
.
          CALL      CLPMSMTI                  * initialise
          COMPARE   FIVE,CFEETYP
          GOTO      PRCA1360 IF NOT EQUAL     * not NZ private
.
          IF        TRECTYPE=3
            MOVE      TPATAMTT,TPATAMTT
.
.   Check for NOT 'Validating Misc.Item' for items coming from HL7 message,
.
            MATCH     "3  ",PTDTPCOD
            IF        @EQUAL
              MOVE      "3",PMMIITYP          * not validating Misc.code
            ENDIF
            CALL      WRMTI000     * Write record to pmsmtiaf
          ENDIF
          GOTO      PRCA1400
.
PRCA1360  IF        TRECTYPE=3
            BRANCH    PTDTEPSD,PRCA1400        * Ignore Mechanical Vent.billing
.
.   If using New Patient functionality, read Misc.charge to get the No of
.   Invoice field for this item
.
            MATCH     "1",PTCNPPIN
            IF        @EQUAL
              PACK      MISCDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY  * date
              REP       " 0",MISCDATE
              MOVE      TITEMNO,MCHARGE
              CALL      GETMCH00            * Get the new misc. charge
              IF        EXIT=0
                MOVE      PTMCGSTA,PTDTGSTA
                MOVE      PTMCGSTC,PTDTGSTC
                MOVE      MDESC,TDDESC
                MOVE      MMSCGRP,TMISGRP
                MATCH     "Y",PTMCKREB
                IF        !@EQUAL
                  MOVE      MPATPOR,TPATAMTP
                  MOVE      MHFPOR,TREBATE
                ENDIF
                MOVE      TPATAMTP,TPATAMTT
                ADD       TREBATE,TPATAMTT
                MULT      TSERVS,TPATAMTT
                MOVE      MNINV,TNINVS
              ENDIF
            ENDIF
          ENDIF
          IF        TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=4 
            CALL      WRMTI000     * Write record to pmsmtiaf
            IF        PINVSYS = 3 & TRECTYPE = 3
              MOVE      ANSA,PROSFLAG
              CALL      PTRK0000   * write tracking prosthetic
            ENDIF
          ENDIF
.
          IF        TRECTYPE=8
            IF        CFEETYP<>5 & PINVSYS=1
              MOVE      TPATAMTT,TPATAMTT
              CALL      WRMTI000     * Write record to pmsmtiaf
            ENDIF
          ENDIF
.
PRCA1400  COMPARE   "5",TRECTYPE
          GOTO      PRCA1500 IF LESS       * Ignore cash/journal
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      PRCA1500 IF EQUAL      * rounding/discount
          COMPARE   NINE,TRECTYPE
          GOTO      PRCA1500 IF EQUAL      * ABF
.
          COMPARE   FIVE,CFEETYP
          GOTO      PRCA1420 IF EQUAL
.
          BRANCH    PINVSYS,PRCA1420       * Check for EMR Event procedure
          GOTO      PRCA1000
.
PRCA1420  COMPARE   EIGHT,TRECTYPE
          GOTO      PRCA1500 IF EQUAL      * Procedure
          COMPARE   NINE,TRECTYPE
          GOTO      PRCA1500 IF EQUAL      * ABF
          GOTO      PRCA1000
.
PRCA1500  MOVE      PMFCCAMT,TPATAMTT   * add credit amount from patfinsf
          IF        IBCNUGST=3
            MOVE      ZERO,PTDTGSTM     * update GST later
          ELSE
            MOVE      PMFCCGST,PTDTGSTM * add gst crd amount from patfinsf
            IF        PTINCMIX=1
              MOVE      PMFCGSTL,PTDTGSTL
              MULT      "-1",PTDTGSTL
            ENDIF
          ENDIF
          CALL      UPFIN000            * Update patfinsf file
.
          ADD       PMFCCAMT,TOTCCRD
          ADD       PMFCCGST,TOTCGST
          IF        PTINCMIX=1
            ADD       PMFCPTLS,TOTCCRD
            ADD       PMFCRBLS,TOTCCRD
            ADD       PMFCGSTL,TOTCGST
          ENDIF
.
          MATCH     PTDTSUNQ,SAVESUNQ
          IF        !@EQUAL
            CALL      USPR0000            * Update nzpspraf file
          ENDIF
.
          IF        CFEETYP=5 & PINVSYS=3
            MATCH     "9999999999999999",PTDTBTCH
            IF        !@EQUAL
              MOVE      PMFCCAMT,GLAMOUNT
              MOVE      "1",PTDTCRST
              PROC      NZPGLEXT          * G/L Extract for NZ Private
              MOVE      ONE,XTRDFLAG
            ENDIF
          ENDIF
          GOTO      PRCA1000
.
.         Update invoice file
.
PRCA2000  IF        CRDFLAG=0
            CALL      GENCR000     * Generate next credit note number
          ENDIF
          MOVE      "1",PTINCRST        * Fully credited
          MOVE      PINVAMT,PTINCRTT    * amount credited
          MULT      "-1",PTINCRTT
          MOVE      PINVADM,PINVCADM
          PACK      PINVCANC,CCC,CYY,CMM,CDD
          REP       " 0",PINVCANC       * date invoice was credited
          CALL      CBAL0000            * Check if invoice is now balanced
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT       * date updated
          CLOCK     TIME,PTINUTIM       * time updated
          MOVE      USERID,PTINUUID     * web user id
          CALL      UPINV1
          PROC      FLAGDEBT
.
          MOVE      PINVUR,SAVURNUM
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          COMPARE   THREE,IBCNUGST
          GOTO      PRCA2800 IF NOT EQUAL
.
          IF        CFEETYP=5 & XTRDFLAG=0 & PINVSYS=3
            CALL      XRDT0000           * extract from nzprdtaf for FFS Win/los
          ENDIF
.
.         Write Credit note GST to patfinsf file
.
          CALL      ICCR0000             * get GST from prev.credit note amt
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          MOVE      PTINGSTA,FINAMT      * total invoice
          ADD       TOTGST,FINAMT        * subtract any previous crd notes amt
          MOVE      ONE,FGSTFLAG
          PACK      FINCODE,ANSQ,SP70
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
          MOVE      ANSA,FINTYPE
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
          MOVE      PINVAMT,PMCNAMNT       * total invoice (incl.GST)
          SUB       PTINROUN,PMCNAMNT      * rounding amt
          ADD       TOTAMT,PMCNAMNT        * prev.credit note amt
          ADD       TOTGST,PMCNAMNT        * prev.GST amt
          MULT      "-1",PMCNAMNT
.
          MOVE      PTINGSTA,PMCNGSTM      * total GST amt
          ADD       TOTGST,PMCNGSTM        * prev.GST amt
          MULT      "-1",PMCNGSTM
.
          COMPARE   FIVE,CFEETYP
          GOTO      PRCA2900 IF NOT EQUAL  * Not SX
          COMPARE   THREE,PINVSYS
          GOTO      PRCA2900 IF NOT EQUAL
.
          MOVE      ONE,UPGSTFLG
          MOVE      PMCNGSTM,GLAMOUNT    * total GST
          MOVE      "1",PTDTCRST
          PROC      NZPGLEXT             * G/L Extract for NZ Private
          MOVE      ZERO,UPGSTFLG
.
          GOTO      PRCA2900
.
PRCA2800  MOVE      TOTCCRD,PMCNAMNT       * Total amount of credit note
          ADD       TOTCGST,PMCNAMNT       * plus GST
          MOVE      TOTCGST,PMCNGSTM       * Total GST
.
PRCA2900  MOVE      "1",PMCNSTAT           * Fully credited
          CALL      WRCRN000               * Write record to pmscnoaf 
.                                           * check CCPS EDI Extract  *I-103368
          CALL      CCPSCA00                * cancel invoice in CCPS extract
.
          COMPARE   THREE,PINVSYS
          GOTO      PRCA8000 IF NOT EQUAL     * Not inpatient visit
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1 
          BRANCH    OVRCD,PRCA8000
.
          MATCH     SP8,STRACCM 
          GOTO      PRCA3000 IF EQUAL
.
          IF        CFEETYP=5
            MOVE      ANSN,PTMICMXP     * Set flag to re-charge FFS for SX
          ENDIF
          MOVE      STRACCM,ALACDTE
.
          COMPARE   THREE,ASTAT
          GOTO      PRCA3000 IF NOT EQUAL
          MOVE      ZERO,ADSCHI
.
PRCA3000  IF        AINVPRT>0
            SUB       ONE,AINVPRT
          ENDIF
.
          IF        AINVPRT=0
            MOVE      ADATE,ALACDTE
            IF        CFEETYP=5
              MOVE      ANSN,PTMICMXP     * Set flag to re-charge FFS for SX
            ENDIF
          ENDIF
.
          CALL      UPMISS1
.
.        Make sure there is an invoice pending record
.        If Using the Invoice Pending File
.
PRCA8000  IF        PTCNIPEN = 0
            CALL       CIPN0000
          ENDIF
.
          IF        CFEETYP=5 & XTRDFLAG=0 & PINVSYS=3
            CALL      UWNL0000         * Check if we need to update Win/Loss
          ENDIF
.
          CALL      CRAI0000           * Check for other raised invoice
.
          CALL      DECL0000           *  Check if need to delete Eclipse claims
.
PRCA9999  RETURN
+
.-----------------------------------------------------------------------
.         Credit All for Patient/Rebate Invoice (PTCNPPIN=1)
.-----------------------------------------------------------------------
PTCA0000  MOVE      ZERO,CRDFLAG
          MOVE      SP8,STRACCM
          CALL      GCLM0000               * Get claim code
          MOVE      ONE,CREDITEM
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          MOVE      SP70,SAVESUNQ
          MOVE      SP70,PTDTBTCH
          MOVE      ZERO,XTRDFLAG
          MOVE      SP70,PRIMFUND
.
.         Credit Note a Patient/Rebate Invoice
.
          PACK      KEY23 WITH ADMISSNO,PINVNO,SP6
          PACK      KEY22 WITH ADMISSNO,PINVNO,SP6
          CALL      RSDTR000
PTCA1000  CALL      RKDTR000
          BRANCH    OVRCD OF PTCA2000
          MATCH     ADMISSNO,DTADMNO
          GOTO      PTCA2000 IF NOT EQUAL
          MATCH     TREF,PINVNO
          GOTO      PTCA2000 IF NOT EQUAL
.
.         Check if it's an accomodation record
.
          COMPARE   NINE,TRECTYPE
          GOTO      PTCA1100 IF EQUAL       * ABF record type
.
          COMPARE   ONE,TRECTYPE
          GOTO      PTCA1200 IF NOT EQUAL
.
PTCA1100  MATCH     SP8,STRACCM
          GOTO      PTCA1200 IF NOT EQUAL
.
          PACK      STRACCM,TFCENT,TFYEAR,TFMONTH,TFDAY   * start of accom.date
          REP       " 0",STRACCM
.
.         If GST is calculated on Invoice total, then calculate accom.GST last
.
PTCA1200  BRANCH    TRECTYPE,PTCA1220,PTCA1220,PTCA1220
          COMPARE   NINE,TRECTYPE
          GOTO      PTCA1220 IF EQUAL   * ABF record type
.
          IF        PINVSYS=1
            COMPARE   EIGHT,TRECTYPE      * Check for EMR Event procedure
            GOTO      PTCA1220 IF EQUAL
            COMPARE   NINE,TRECTYPE       * Check for ABF
            GOTO      PTCA1220 IF EQUAL
          ENDIF
          GOTO      PTCA1000
.
PTCA1220  IF        TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=8
            CALL      GCCR0000            * Get previous amount of credit note
            MOVE      TPATAMTT,PMFCCAMT   * Credit Amount
            MOVE      PTDTGSTM,PMFCCGST   * Credit GST Amount
.
.         If this is not an accommodation record, subtract any previous credit
.         notes amount
.
            ADD       TOTAMT,PMFCCAMT
            ADD       TOTGST,PMFCCGST
          ELSE
            MOVE      TPATAMTT,PMFCCAMT          * Credit Amount
            MOVE      PTDTGSTM,PMFCCGST          * Credit GST Amount
          ENDIF
.
PTCA1300  MULT      "-1",PMFCCAMT
          MULT      "-1",PMFCCGST
          MOVE      ZERO,PMFCPTLS        * Lumpsum amount patient portion
          MOVE      ZERO,PMFCRBLS        * Lumpsum amount rebate portion
          MOVE      ZERO,PMFCGSTL        * GST Lumpsum amount
          IF        PTINCMIX=1
            IF        PTDTLSPT<>0
              MOVE      PTDTLSPT,PMFCPTLS
              MULT      "-1",PMFCPTLS    * Lumpsum amount patient portion
            ENDIF
            IF        PTDTLSRB<>0
              MOVE      PTDTLSRB,PMFCRBLS
              MULT      "-1",PMFCRBLS    * Lumpsum amount rebate portion
            ENDIF
            IF        PTDTGSTL<>0
              MOVE      PTDTGSTL,PMFCGSTL
              MULT      "-1",PMFCGSTL    * GST Lumpsum amount
            ENDIF
          ENDIF
.
  IF TRECTYPE=1 | TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=4 | TRECTYPE=7 | TRECTYPE=9
            CALL      WRFCI000       * Write record to pmsfciaf
            IF        PINVSYS = 3 & TRECTYPE = 3
              MOVE      ANSD,PROSFLAG
              CALL      PTRK0000
            ENDIF
          ENDIF
.
          COMPARE   EIGHT,TRECTYPE
          GOTO      PTCA1312 IF NOT EQUAL   * not procedure fee/procedure item
.
          BRANCH    PINVSYS,PTCA1310        * procedure for EMR visit/event
          GOTO      PTCA1312
.
PTCA1310  CALL      WRFCI000       * Procedure fee for Proc.for EMR Event
.
PTCA1312  MOVE      "1",KEY1       * Fully credited
          STORE     KEY1,PINVSYS,ATDTCRST,OTDTCRST,PTDTCRST
          CALL      UPDTR000
.
.         PTRBFLAG = 1 Rebate Invoice 
.         PTRBFLAG = 2 Patient Invoice
.
          BRANCH    PTRBFLAG,PTCA1320       * Credit Note Rebate invoice
          GOTO      PTCA1340                * Credit Note Patient invoice
.
.         Credit note a Rebate invoice - Create a record in pathtraf 
.
PTCA1320  PACK      KEY22,DTADMNO,TREF,TTRANSN1,SP70
          CALL      RDHT1000
          BRANCH    OVRCD,PTCA1400
.
          MOVE      SP70,PTHTTREF
          STORE     SP70,PINVSYS,EMHTINVN,OTHTINVN,PTHTTREF *blank Rebate Inv.no
          PACK      KEY22,PTHTADMN,PTHTTREF,PTHTTRNS
          CALL      RAHT1000
          IF        OVRCD=1
            CALL      WRHT1000
          ENDIF
          GOTO      PTCA1400
.
.         Credit note a Patient Invoice - write a record to pmsmtiaf
.
PTCA1340  CALL      CREB0000      * Check if Rebate invoice has been raised
          BRANCH    EXIT,PTCA1360
.
.         Recalculate the item to get the rebate amount
.
          IF        TRECTYPE=3
            PACK      MISCDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY  * date
            REP       " 0",MISCDATE
            MOVE      TITEMNO,MCHARGE
            CALL      GETMCH00            * Get the new misc. charge
            IF        EXIT=0
              MOVE      PTMCGSTA,PTDTGSTA
              MOVE      PTMCGSTC,PTDTGSTC
              MOVE      MDESC,TDESC
              MOVE      MMSCGRP,TMISGRP
              MATCH     "Y",PTMCKREB
              IF        !@EQUAL
                MOVE      MPATPOR,TPATAMTP
                MOVE      MHFPOR,TREBATE
              ENDIF
            ENDIF
          ENDIF

PTCA1360  IF        TRECTYPE=3
            BRANCH    PTDTEPSD,PTCA1400        * Ignore Mechanical Vent.billing
          ENDIF
.
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MULT      TSERVS,TPATAMTT
          IF        TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=4
            CALL      WRMTI000     * Write record to pmsmtiaf
            IF        PINVSYS = 3 & TRECTYPE = 3
              MOVE      ANSA,PROSFLAG
              CALL      PTRK0000   * write tracking prosthetic
            ENDIF
          ENDIF
.
          IF        TRECTYPE=8
            IF        PINVSYS=1
              CALL      WRMTI000     * Write record to pmsmtiaf
            ENDIF
          ENDIF
.
PTCA1400  COMPARE   "5",TRECTYPE
          GOTO      PTCA1500 IF LESS       * Ignore cash/journal
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      PTCA1500 IF EQUAL      * rounding/discount
          COMPARE   NINE,TRECTYPE
          GOTO      PTCA1500 IF EQUAL      * ABF
.
          BRANCH    PINVSYS,PTCA1420       * Check for EMR Event procedure
          GOTO      PTCA1000
.
PTCA1420  COMPARE   EIGHT,TRECTYPE
          GOTO      PTCA1500 IF EQUAL      * Procedure
          COMPARE   NINE,TRECTYPE
          GOTO      PTCA1500 IF EQUAL      * ABF
          GOTO      PTCA1000
.
PTCA1500  MOVE      PMFCCAMT,TPATAMTT   * add credit amount from patfinsf
          MOVE      PMFCCGST,PTDTGSTM * add gst crd amount from patfinsf
          IF        PINVSYS=3 & PTINCMIX=1
            MOVE      PMFCGSTL,PTDTGSTL
            MULT      "-1",PTDTGSTL
          ENDIF
          CALL      UPFIN000            * Update patfinsf file
.
          ADD       PMFCCAMT,TOTCCRD
          ADD       PMFCCGST,TOTCGST
          IF        PTINCMIX=1
            ADD       PMFCPTLS,TOTCCRD
            ADD       PMFCRBLS,TOTCCRD
            ADD       PMFCGSTL,TOTCGST
          ENDIF
.
          GOTO      PTCA1000
.
.         Update invoice file
.
PTCA2000  IF        CRDFLAG=0
            CALL      GENCR000     * Generate next credit note number
          ENDIF
          MOVE      "1",PTINCRST        * Fully credited
          MOVE      PINVAMT,PTINCRTT    * amount credited
          MULT      "-1",PTINCRTT
          MOVE      PINVADM,PINVCADM
          PACK      PINVCANC,CCC,CYY,CMM,CDD
          REP       " 0",PINVCANC       * date invoice was credited
          CALL      CBAL0000            * Check if invoice is now balanced
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT       * date updated
          CLOCK     TIME,PTINUTIM       * time updated
          MOVE      USERID,PTINUUID     * web user id
          CALL      UPINV1
          PROC      FLAGDEBT
.
          MOVE      PINVUR,SAVURNUM
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          MOVE      TOTCCRD,PMCNAMNT       * Total amount of credit note
          ADD       TOTCGST,PMCNAMNT       * plus GST
          MOVE      TOTCGST,PMCNGSTM       * Total GST
.
          MOVE      "1",PMCNSTAT           * Fully credited
          CALL      WRCRN000               * Write record to pmscnoaf
.
.                                           * check CCPS EDI Extract  *I-103368
          CALL      CCPSCA00                * cancel invoice in CCPS extract
.
          COMPARE   THREE,PINVSYS
          GOTO      PTCA8000 IF NOT EQUAL     * Not inpatient visit
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PTCA8000
.
.         Credit note for Rebate Invoice
.
          IF        PTRBFLAG=1
            MATCH     SP8,STRACCM
            IF        !@EQUAL
              MOVE      STRACCM,ALACDTE
            ENDIF
.
            MATCH     ALACDTE,ADATE
            IF        @EQUAL
              MOVE      ZERO,ADSCHI  * patient discharged not invoiced
            ENDIF
            GOTO      PTCA3000       * Credit Note Rebate invoice
          ENDIF
.
          MATCH     SP8,STRACCM
          GOTO      PTCA3000 IF EQUAL
.
          MOVE      STRACCM,ALACDTE
.
          COMPARE   THREE,ASTAT
          GOTO      PTCA3000 IF NOT EQUAL
          MOVE      ZERO,ADSCHI
.
PTCA3000  IF        AINVPRT>0
            SUB       ONE,AINVPRT
          ENDIF
          IF        AINVPRT=0
            MOVE      ADATE,ALACDTE
            MOVE      ZERO,ADSCHI
          ENDIF
.
          CALL      UPMISS1
.
.        Make sure there is an invoice pending record
.        If Using the Invoice Pending File
.
PTCA8000  IF        PTCNIPEN = 0
            CALL       CIPN0000
          ENDIF
.
.         If it's crediting Rebate invoice, set Credit Note flag in pathtr file
.
          IF        PTRBFLAG=1
            CALL      SPHT0000         *  set credit note flag 
            GOTO      PTCA9999
          ENDIF
.
          CALL      DECL0000           *  Check if need to delete Eclipse claims
          GOTO      PTCA9999
.
PTCA9999  RETURN
+            
.-----------------------------------------------------------------------
.         Check if Rebate invoice has been raised for this Patient Inv.
.-----------------------------------------------------------------------
CREB0000  MOVE      ZERO,EXIT
          MOVE      TTRANSN1,KEY6
          PACK      KEY36,DTADMNO,TREF,TTRANSN1,SP70
          CALL      RSHT2000
CREB1000  CALL      RKHT2000
          BRANCH    OVRCD,CREB9999
          MATCH     DTADMNO,PTHTADMN     * Same admission
          GOTO      CREB9999 IF NOT EQUAL
.
          MATCH     TREF,PTHTPINV
          GOTO      CREB9999 IF NOT EQUAL
.
          MATCH     KEY6,PTHTPTRN
          GOTO      CREB9999 IF NOT EQUAL
.
          MATCH     SP70,PTHTTREF
          GOTO      CREB1000 IF NOT EQUAL      * Rebate invoice is raised
.
.         we found a record with blank Rebate invoice number, which means that
.         the Rebate Invoice of this Patient invoice has not been raised..
.
          MOVE      PTHTRBAT,TREBATE         * retrieve the Rebate amount
          ADD       PTHTGSTM,PTDTGSTM        * GST amount
.
.         delete record in pathtraf
.
          PACK      KEY22,PTHTADMN,PTHTTREF,PTHTTRNS
          CALL      DEHT1000
          MOVE      ONE,EXIT
.
CREB9999  RETURN
+
.-----------------------------------------------------------------------
.         Credit Note a Rebate Invoice
.-----------------------------------------------------------------------
SPHT0000  PACK      KEY22,DPINVADM,PINVNO,SP70
          CALL      RSHT1000
SPHT1000  CALL      RKHT1000
          BRANCH    OVRCD,SPHT9999
.
          MATCH     DPINVADM,PTHTADMN     * Same admission
          GOTO      SPHT9999 IF NOT EQUAL
.
          MATCH     PINVNO,PTHTTREF
          GOTO      SPHT9999 IF NOT EQUAL
.
          MOVE      "1",KEY1             * Fully credited
          STORE     KEY1,PINVSYS,EMHTCRST,OTHTCRST,PTHTCRST
          PACK      KEY22,PTHTADMN,PTHTPINV,PTHTPTRN
          CALL      UPHT1000
          GOTO      SPHT1000
.
SPHT9999  RETURN
+
.-----------------------------------------------------------------------
.         If no invoice raised for the admission set nzspinvd to zero
.         for all record in nzpspraf file
.-----------------------------------------------------------------------
CRAI0000  COMPARE   FIVE,CFEETYP
          GOTO      CRAI9999 IF NOT EQUAL
.
          MOVE      PINVNO,SKEY8            * Save invoice no.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
CRAI1000  CALL      RDKINV3
          BRANCH    OVRCD,CRAI6000
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      CRAI6000 IF NOT EQUAL
.
          MATCH     "1",PTINCRST            * Fully credited?
          GOTO      CRAI1000 IF EQUAL
.
          GOTO      CRAI9000
.
.         No raised invoice found, set field to No invoice raised
.
CRAI6000  PACK      KEY11 WITH ADMISSNO,SP70
          CALL      RSNZSPR1
CRAI8000  CALL      RKNZSPR1
          BRANCH    OVRCD OF CRAI9000
.
          MATCH     NZSPADMN,ADMISSNO
          GOTO      CRAI9000 IF NOT EQUAL
.
          MOVE      ZERO,NZSPINVD           * no invoice raised
          CALL      UPNZSPR1
          GOTO      CRAI8000
.
CRAI9000  MOVE      SKEY8,KEY8              * restore invoice no
          CALL      RDINV1
.
CRAI9999  RETURN
+
.-----------------------------------------------------------------------
.  Automaticaly add items of the Regime for Independence Service Billing
.-----------------------------------------------------------------------
AREG0000  OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSREGA1,"pmsregaf"
          PACK      KEY10,ADMISSNO,SP70   * get regime code
          CALL      RSPTRGM1
          CALL      RKPTRGM1
          BRANCH    OVRCD,AREG9999
          MATCH     ADMISSNO,PTRGADMN
          GOTO      AREG9999 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,AREG9999
.
.         Write all items of Regime with correct quantity
.
          MOVE      ALACDTE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD  * Default to current date
          REP       " 0",TODATE
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,AREG9999
            MOVE      DDATE,TODATE
          ENDIF
.
.         Check for Add Misc.Charges item with Quantity of zero
.
          MOVE      ZERO,NBRDAYS
          MATCH     "1",PTCNISBZ
          IF        !@EQUAL
            DAYSEP    FROMDATE,TODATE,NBRDAYS * LOS include leaves
            COMPARE   ZERO,NBRDAYS
            GOTO      AREG9999 IF EQUAL
          ENDIF
.
          CALL      DCLM0000              * get default claim code
          PACK      KEY13,PTRGREGM,SP70
          CALL      RSPMREG1
AREG2000  CALL      RKPMREG1
          BRANCH    OVRCD,AREG8000
.
          MATCH     PTRGREGM,PMREREGM
          GOTO      AREG8000 IF NOT EQUAL      * different regime
          MATCH     "1",PMREITYP
          GOTO      AREG2000 IF NOT EQUAL
.
          CALL      AITM0000                   * Add item
          GOTO      AREG2000                   * next item
.
AREG8000  MOVE      ZERO,EXIT
AREG9999  RETURN
+
.------------------------------------------------------------
.         Add item with quantity equals to curent LOS
.------------------------------------------------------------
AITM0000  MOVE      ZERO,EXIT
.
          MOVE      ALACDTE,PMMITDAT
          REP       " 0",PMMITDAT
          MOVE      PMREITMN,PMMIITEM
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMMIITEM,MCHARGE
          CALL      GETMCH00            * Get the new misc. charge
          BRANCH    EXIT,AITM9999
.
          MOVE      ADMISSNO,KEY8
AITM4000  CALL      TRVISA1               * Get the next transaction number
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      AITM4000 IF EQUAL
.
          MOVE      ADMISSNO,PMMIVISN
          MOVE      URNUMBER,PMMIURNO
          MOVE      " 3",PMMISYST
          MOVE      THREE,PMMIRTYP
          MOVE      NBRDAYS,PMMISERV
.
          MOVE      ZERO,PMMIGSTM
          UNPACK    SP70,PMMIDESC,PMMIDES2
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
.
          MOVE      PTMCGSTA,PMMIGSTA
          MOVE      PTMCGSTC,PMMIGSTC
          MOVE      MDESC,PMMIDESC
          MOVE      MITMTYP,PMMIRTYP
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MPATPOR,PMMIAMTP
          MOVE      MHFPOR,PMMIRBAT
.
          MOVE      PMMIAMTP,PMMIAMTT
          ADD       PMMIRBAT,PMMIAMTT
          MULT      PMMISERV,PMMIAMTT
          MOVE      ONE,PMMIINVN
.
          UNPACK    SP70,PMMIBTCH,PMMIMVBR,PMMIUNIQ,PMMICNTR,PMMISUNQ:
                         PMMITDOC,PMMIODOC
          UNPACK    SP70,PMMIINCT,PMMISUBN,PMMIEDAD,PMMISVTM,PMMICCON
          UNPACK    SP70,PMMIITYP,PMMIREFN,PMMISESS
          MOVE      "1",PMMIINCT          * flag Item from Regime
.
          MOVE      ZERO,PMMISCHF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR        * User id
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
          PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
          MOVE      SP70,PMMIDKSM       * Distance in kms
          PACK      PMMISPAR,SP70,SP70
.
          PACK      KEY14,ADMISSNO,PMMITRAN
          CALL      WRPMMTI1

          MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          MOVE      PVITRAN,ATRANNO      * next transaction number
          PACK      PTMIWEBU,WBSEUID,SP70
          CALL      UPLMISS1
.
AITM9999  RETURN
+
.------------------------------------------------------------
. Get the appropriate miscellaneous charges record
.------------------------------------------------------------
GETMCH00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9            * (MCHARGE re-use in PATMCHRD)
.
          PACK      MISCDATE,MISCDATE,SP70
          MATCH     SP70,MISCDATE
          IF        @EQUAL
            PACK      MISCDATE,CCC,CYY,CMM,CDD,SP70
            REP       " 0",MISCDATE
          ENDIF
.
          UNPACK    SP20,PTHFBCAT           * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1                 * "Table Type code" now in PTHFBCAT
.
          PACK      KEY29,ACLAIM,AFUNDH,PTMCHFTT,KEY9,MISCDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMCH99 IF EQUAL
.
.         No record with health fund detials - try a blank health fund
.
GETMCH10  PACK      KEY29,ACLAIM,SP6,SP3,KEY9,MISCDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMCH99 IF EQUAL
.
.         No record with health fund detials - last chance, try default claim
.
GETMCH20  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,MISCDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP3,KEY9,MISCDATE,SP10
          ENDIF
.
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMCH99 IF EQUAL
.
GETMCH90  MOVE      ONE,EXIT
.
GETMCH99  RETURN
+
.------------------------------------------------------------
.         Delete Future Actions where tcindc1= H,B or P
.------------------------------------------------------------
DFAC0000  MATCH     "1",PTCNDFUP
          GOTO      DFAC9999 IF NOT EQUAL
.
          PACK      DIM8,CCC,CYY,CMM,CDD    * setup current date
          REP       " 0",DIM8
          PACK      KEY19,ADMISSNO,DIM8,SP70
DFAC1000  CALL      RDSFACT1
DFAC2000  CALL      RDKFACT1
          BRANCH    OVRCD,DFAC9999
.
          MATCH     ADMISSNO,DFADMNO
          GOTO      DFAC9999 IF NOT EQUAL
.
          MATCH     PINVNO,PTFCINVN          * same invoice number?
          GOTO      DFAC2000 IF NOT EQUAL
.
          MOVE      "FA",TCODE
          PACK      KEY5,TCODE,FACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DFAC2000
.
          MATCH     "H",TCINDC1
          GOTO      DFAC4000 IF EQUAL
          MATCH     "B",TCINDC1
          GOTO      DFAC4000 IF EQUAL
          MATCH     "P",TCINDC1
          GOTO      DFAC2000 IF NOT EQUAL
.
DFAC4000  PACK      KEY19,DFADMNO,FADATE,FACODE,SP70
          CALL      DEFACT1
          GOTO      DFAC1000
.
DFAC9999  RETURN
+
.------------------------------------------------------------
.         Delete Eclipse claims
.------------------------------------------------------------
DECL0000  MATCH     "1",PTCNWSIN
          GOTO      DECL5000 IF NOT EQUAL
.
          MATCH     "1",PTCNIHCW
          GOTO      DECL9999 IF NOT EQUAL
.
          OPEN      WEBIHCA1,"webihcaf"
          OPEN      WEBIHCA2,"webihcaf"
          PACK      KEY16,PINVNO,SP70
          CALL      RDWBIHC2
          BRANCH    OVRCD,DECL9999
.
          COMPARE   ZERO,WBICFLAG      * Check Eclipse status flag
          GOTO      DECL9999 IF NOT EQUAL
.
          PACK      KEY35,WBICHOSP,DWBICFLG,WBICHFND,WBICADMN:
                          WBICINVN,WBICBATN,SP70
          CALL      DEWBIHC1
.
          GOTO      DECL9999
.
DECL5000  OPEN      PMSECTA1,"pmsectaf"
          OPEN      PMSECTA2,"pmsectaf"
          PACK      KEY16,PINVNO,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,DECL9999
.
          COMPARE   ZERO,PMECFLAG      * Check Eclipse status flag
          GOTO      DECL9999 IF NOT EQUAL
.
          PACK      KEY35,PMECHOSP,DPMECFLG,PMECHFND,PMECADMN:
                          PMECINVN,PMECBATN,SP70
          CALL      DEPMECT1
.
DECL9999  CLOSE     WEBIHCA1
          CLOSE     WEBIHCA2
          CLOSE     PMSECTA1
          CLOSE     PMSECTA2
.
          RETURN
+
.------------------------------------------------------------
.         Extract data from nzprdtaf for FFS with Win/Loss
.------------------------------------------------------------
XRDT0000  PACK      KEY23 WITH ADMISSNO,PINVNO,SP70
          CALL      RSNZRDT4
XRDT1000  CALL      RKNZRDT4
          BRANCH    OVRCD OF XRDT9999
          MATCH     ADMISSNO,DTADMNO
          GOTO      XRDT9999 IF NOT EQUAL
          MATCH     TREF,PINVNO
          GOTO      XRDT9999 IF NOT EQUAL
.
          BRANCH    TRECTYPE,XRDT2000,XRDT2000,XRDT1400,XRDT2000:
                             XRDT1000,XRDT1200,XRDT2000,XRDT2000
          GOTO      XRDT1000
.
.         Only journal for increase/decrease FFS for Win/Loss
.
XRDT1200  MATCH     TTYPE,PTCNLJCD          * Loss journal type
          GOTO      XRDT2000 IF EQUAL
          MATCH     TTYPE,PTCNWJCD          * Win journal type
          GOTO      XRDT1000 IF NOT EQUAL
          GOTO      XRDT2000
.
XRDT1400  MATCH     SP70,TDOCTO            * Check if we have DTR trans.no
          GOTO      XRDT2000 IF EQUAL
.
          MOVE      ZERO,F1
          PACK      SKEY23,DTADMNO,TREF,TRECTYPE,TTRANSN1,SP70
          PACK      KEY22,DTADMNO,TREF,TDOCTO,SP70
          CALL      RDDTRN1
          BRANCH    OVRCD,XRDT1800
.
.         Not including the current credit note number
.
          MOVE      PTCNCRNO,KEY8
          PACK      KEY30,KEY22,SP70
          CALL      RSPMFCI1
XRDT1500  CALL      RKPMFCI1
          BRANCH    OVRCD,XRDT1800
          PACK      SKEY22,PMFCVISN,PMFCINVN,PMFCTRAN,SP70
          MATCH     KEY22,SKEY22
          GOTO      XRDT1800 IF NOT EQUAL
          MATCH     PMFCCRNO,KEY8
          GOTO      XRDT1500 IF EQUAL        * skip current credit note record
.
          MATCH     "1",PTDTCRST
          GOTO      XRDT1600 IF EQUAL        * Fully credit notes
          MATCH     "2",PTDTCRST
          GOTO      XRDT1600 IF EQUAL        * Credit note by item
          GOTO      XRDT1800
.
XRDT1600  MOVE      ONE,F1
XRDT1800  MOVE      SKEY23,KEY23             * reposition
          CALL      RDNZRDT4
          BRANCH    F1,XRDT1000
.
XRDT2000  MOVE      TPATAMTT,GLAMOUNT
          MULT      "-1",GLAMOUNT
          MOVE      "1",PTDTCRST           * Credit note status
          PROC      NZPGLEXT               * G/L Extract for NZ Private
          GOTO      XRDT1000
.
XRDT9999  RETURN
+
.******************************************************************************
.         Check if this credit notes invoice had the raised invoice extracted
.******************************************************************************
UWNL0000  CALL      CHXT0000
          BRANCH    EXTRFLG,UWNL9999          * Invoice had been extracted
.
          CALL      GPRM0000                  * Get primary funder
.
          MOVE      ZERO,CPRCNUMB
          MOVE      ZERO,COUNTA
.
          MOVE      ONE,F2
          WHILE     F2<=9
            MOVE      SP70,CPRCCODE[F2]
            ADD       ONE,F2
          DO
          CALL      MCPR0000                  * set no of contract procedures
          COMPARE   ZERO,CPRCNUMB
          GOTO      UWNL3000 IF EQUAL
.
          MOVE      ZERO,COUNTA
UWNL2200  ADD       ONE,COUNTA
          MOVE      CPRCCODE[COUNTA],SAVECPRC     * Contract Procedure code
.
UWNL3000  CALL      CNTR0000                  * Get total Contract amount
          CALL      CFFS0000                  * Calculate FFS amount
          SUB       TFFSAMNT,FORM12P2         * Subtracted by total FFS amount
.         
.         COMPARE   ZERO,FORM12P2
.         GOTO      XRDT9999 IF EQUAL         * no Win/Loss
.
          CALL      WJNL0000                  * Write Win/Loss
          MOVE      TPATAMTT,GLAMOUNT
          MULT      "-1",GLAMOUNT
          MOVE      "1",PTDTCRST
          PROC      NZPGLEXT                  * G/L Extract for NZ Private
.
          COMPARE   ZERO,CPRCNUMB
          GOTO      UWNL9999 IF EQUAL
.
          COMPARE   CPRCNUMB,COUNTA
          GOTO      UWNL2200 IF LESS
.
UWNL9999  RETURN
+
.******************************************************************************
.         Get total contract amount
.******************************************************************************
CNTR0000  MOVE      ZERO,FORM12P2
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          PACK      KEY23,ADMISSNO,DIM8,SP70
          CALL      RDSDTRN4
CNTR1000  CALL      RDKDTRN4
          BRANCH    OVRCD,CNTR9999
          MATCH     ADMISSNO,DTADMNO
          GOTO      CNTR9999 IF NOT EQUAL
          MATCH     TREF,DIM8
          GOTO      CNTR9999 IF NOT EQUAL
.
          MATCH     SP70,SAVECPRC
          IF        @EQUAL
            MATCH     PTDTCNTR,PRIMFUND
            GOTO      CNTR1000 IF NOT EQUAL * Not a primary funder invoice
          ELSE
            MATCH     SAVECPRC,PTDTCPRC
            GOTO      CNTR1000 IF NOT EQUAL
          ENDIF
.
          MOVE      TREF,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CNTR1000
.
          MOVE      TRECTYPE,F1
          MOVE      PTDTLSPT,F12P2
          ADD       PTDTLSRB,F12P2
          ADD       PTDTADPT,F12P2
.
          MATCH     "1",PTINCRST             * Fully credited?
          GOTO      CNTR2000 IF NOT EQUAL
.
.         Check if it had been generated
.
          MATCH     SP70,PTDTBTCH
          GOTO      CNTR2000 IF EQUAL     * not extracted yet
.
          MOVE      ZERO,EXTRFLG
          MATCH     "9999999999999",PTDTBTCH
          IF        @EQUAL
            CALL       CHXT0000           * is it extracted from nzprdtaf ?
          ELSE
            MOVE       ONE,EXTRFLG
          ENDIF
          BRANCH    EXTRFLG,CNTR1000
.
CNTR2000  COMPARE   EIGHT,F1
          GOTO      CNTR1000 IF NOT EQUAL * Not a procedure record
.
          ADD       F12P2,FORM12P2
          GOTO      CNTR1000
.
CNTR9999  RETURN
+
.******************************************************************************
.         Check if it had been extracted previously
.******************************************************************************
CHXT0000  MOVE      ZERO,EXTRFLG
          PACK      KEY23,PINVADM,PINVNO,SP70
          CALL      RSNZRDT4
          CALL      RKNZRDT4
          BRANCH    OVRCD,CHXT9999
.
          MATCH     PINVADM,TADMNO
          GOTO      CHXT9999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF
          GOTO      CHXT9999 IF NOT EQUAL
.
          MATCH     SP70,PTDTBTCH
          GOTO      CHXT9999 IF EQUAL
          MOVE      ONE,EXTRFLG
.
CHXT9999  RETURN
+
.******************************************************************************
.         Get primary funder
.******************************************************************************
GPRM0000  MOVE      ZERO,EXIT
          MOVE      ZERO,CNTPTFLG
.
          MOVE      SP70,PRIMFUND
          MOVE      SP70,PRIMMBS
.
          MOVE      SP70,MULTCNTR
          MOVE      SP6,KEY6
          MOVE      ADMISSNO,KEY8
          PACK      KEY17 WITH ADMISSNO,SP70
          CALL      RSNZSPR2
GPRM2000  CALL      RKNZSPR2
          BRANCH    OVRCD OF GPRM2200
.
          MATCH     NZSPADMN,KEY8
          GOTO      GPRM2200 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND
          GOTO      GPRM2000 IF NOT EQUAL        * Not performed
.
          COMPARE   ONE,NZSPPRIM
          GOTO      GPRM2000 IF NOT EQUAL        * Not primary
.
          MATCH     SP70,NZSPCNTR
          GOTO      GPRM9999 IF EQUAL
.
          MOVE      NZSPCNTR,PRIMFUND            * Primary funder
          MOVE      NZSPCPRC,PRIMMBS
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "P",TCINDC7
            IF        @EQUAL
              MOVE      ONE,CNTPTFLG              * Contract bill to Patient
            ELSE
              MATCH     "F",TCINDC7
              GOTO      GPRM2000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      NZSPCNTR,KEY6                * Contract Primary funder
          GOTO      GPRM2000
.
.         Check for other subsequence procedures
.
GPRM2200  MATCH     SP70,KEY6
          GOTO      GPRM9999 IF EQUAL
.
          PACK      KEY17 WITH ADMISSNO,SP70
          CALL      RSNZSPR2
GPRM3000  CALL      RKNZSPR2
          BRANCH    OVRCD OF GPRM9999
.
          MATCH     NZSPADMN,KEY8
          GOTO      GPRM9999 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND
          GOTO      GPRM3000 IF NOT EQUAL        * Not performed
.
          COMPARE   ONE,NZSPPRIM
          GOTO      GPRM3000 IF EQUAL            * Skip primary
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,GPRM3000
.
          CMATCH    "P",TCINDC7
          IF        !@EQUAL
            MATCH     "F",TCINDC7
            GOTO      GPRM3000 IF NOT EQUAL
          ENDIF
.
          MATCH     NZSPCNTR,KEY6                * Contract Primary funder
          GOTO      GPRM3000 IF EQUAL
.
          MOVE      ONE,MULTCNTR            * multiple contract procedure
.
GPRM9999  RETURN
+
.******************************************************************************
.         Calculate FFS
.******************************************************************************
CFFS0000  MOVE      ZERO,TFFSAMNT
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          PACK      KEY23,ADMISSNO,DIM8,SP70
          CALL      RSNZRDT4
CFFS1000  CALL      RKNZRDT4
          BRANCH    OVRCD,CFFS9999
.
          MATCH     ADMISSNO,DTADMNO
          GOTO      CFFS9999 IF NOT EQUAL
          MATCH     DIM8,TREF
          GOTO      CFFS9999 IF NOT EQUAL
.
          MATCH     SP70,SAVECPRC
          IF        !@EQUAL
            MATCH     SAVECPRC,PTDTCPRC
            GOTO      CFFS1000 IF NOT EQUAL
          ENDIF
.
          MOVE      TREF,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CFFS1000
.
          MATCH     "1",PTINCRST
          GOTO      CFFS1080 IF NOT EQUAL
.
.         Check if it has been extracted
.
          MATCH     SP70,PTDTBTCH
          GOTO      CFFS1000 IF NOT EQUAL
.
CFFS1080  BRANCH    TRECTYPE,CFFS1020:       * Accommodation record
                             CFFS1100:       * Theatre
                             CFFS1200        * Misc.Charge
          GOTO      CFFS1000
.
CFFS1020  MATCH     PTDTCPRC,PRIMMBS
          GOTO      CFFS1000 IF NOT EQUAL
.
          GOTO      CFFS2000
.
CFFS1100  PACK      KEY11,ADMISSNO,PTDTSUNQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,CFFS1000
.
          GOTO      CFFS2000
.
CFFS1200  BRANCH    PTDTCCU,CFFS1000,CFFS1000
          COMPARE   TWO,TCLAIM
          GOTO      CFFS1000 IF EQUAL        * Not included in Win/Loss Calc.
.
          IF        CNTPTFLG=1
            MATCH     SP70,PTDTCNTR
            GOTO      CFFS1000 IF NOT EQUAL

            PACK      KEY11,ADMISSNO,PTDTSUNQ,SP70
            CALL      RDNZSPR1
            IF        OVRCD=0
              IF        NZSPPRIM<>1
                PACK      KEY5,CODECL,NZSPCLMN
                CALL      RDCODE1
                IF        OVRCD=0
                  CMATCH    "P",TCINDC7
                  GOTO      CFFS1000 IF NOT EQUAL       * Not a Patient contract
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
CFFS2000  ADD       TPATAMTT,TFFSAMNT
          GOTO      CFFS1000
.
CFFS9999  RETURN
+
.------------------------------------------------------------
.      Write Win/Loss amount
.------------------------------------------------------------
WJNL0000  CALL      CLPATDTR
          IF        FORM12P2<0
            MOVE      PTCNLJCD,TTYPE          * Loss
          ELSE
            MOVE      PTCNWJCD,TTYPE          * Win
          ENDIF
          MOVE      "J ",KEY2
          PACK      KEY5,KEY2,TTYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      TDDESC,TDESC,SP70
          ENDIF
.
          MOVE      ADMISSNO,TADMNO
          MOVE      AURNO,TDCODE
          MOVE      FORM12P2,TPATAMTT
          MOVE      FORM12P2,TPATAMTP
.
          REP       " 0",PINVDTE
          UNPACK    PINVDTE,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,TFCENT
          MOVE      XYEAR,TFYEAR
          MOVE      XMON,TFMONTH
          MOVE      XDAY,TFDAY
          MOVE      SP70,TITEMNO
          MOVE      PINVNO,TREF
          MOVE      ONE,TINVPRT
          MOVE      PINVDTE,PTDTEFFD
          MOVE      SIX,TRECTYPE        * for Journal
.
          MATCH     SP70,SAVECPRC
          IF        @EQUAL
            MOVE      PRIMMBS,SAVECPRC
          ENDIF
          MOVE      SAVECPRC,PTDTCPRC     * Contract Procedure code
.
WJNL4000  MOVE      ADMISSNO,TADMNO
          MOVE      PINVNO,TREF
          MOVE      TADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      TRVISA1
          MOVE      PVITRAN,TTRANSN1
          MOVE      PVITRAN,ATRANNO
.
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1,SP70
          CALL      RANZRDT1
          COMPARE   ZERO,OVRCD
          GOTO      WJNL4000 IF EQUAL    * Try the next transaction number
.
          MOVE      SP70,PTDTBTCH
          CALL      WRNZRDT1             * Write Procedure record
WJNL9999  RETURN
+
.------------------------------------------------------------
.      Check if Invoice pending need to be written
.------------------------------------------------------------
CIPN0000  PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,CIPN1000
.
          MATCH     ADMISSNO,PMMIVISN
          GOTO      CIPN8000 IF EQUAL       * found item still tobe invoiced
.
.         Check for ABF
.
CIPN1000  MATCH     "1",PTCNUABF
          GOTO      CIPN6000 IF NOT EQUAL      * Not using ABF
.
          MOVE      SP70,KEY3
          LOAD      KEY3,PINVSYS,EMVICOMP,OBACOMP,ACLAIM
          MATCH     SP70,KEY3
          GOTO      CIPN6000 IF EQUAL       * Blank claim code
.
          PACK      KEY5,ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,CIPN6000
          MATCH     "A",TCINDC2
          GOTO      CIPN6000 IF NOT EQUAL   * Not an ABF Claim code
.
          CALL      ABFN00000               * Check if ABF Inv. has been raised
          BRANCH    EXIT,CIPN8000           * ABF invoice has not been raised
.
.         No item to be invoiced, check accommodation charges for Inpatient
.
CIPN6000  BRANCH    PTRBFLAG,CIPN8000       * Credit Note Rebate invoice
.
          COMPARE   THREE,PINVSYS
          GOTO      CIPN9999 IF NOT EQUAL   * Not inpatient visit
.
          COMPARE   THREE,ASTAT
          GOTO      CIPN9999 IF NOT EQUAL   * Not discharged
.
          COMPARE   ZERO,AINVPRT
          GOTO      CIPN8000 IF EQUAL       * has not been invoiced
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,CIPN9999          * Missing discharge record
.
.         Check if Accommodation had been invoiced up to discharged date
.
          MATCH     DDATE,ALACDTE
          GOTO      CIPN9999 IF NOT LESS
.
.         Write a record to Invoice pending as it still has tobe invoiced item
.
CIPN8000  MOVE      ADMISSNO,IPADMNO
          MOVE      PINVSYS,IPSYSTM
          MOVE      SP10,IPSITE
          MOVE      SP70,PTIPRHLD
          MOVE      SP70,PTIPRDES
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      IPADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
.
          IF        PINVSYS=1
            PACK      KEY8,IPADMNO,SP70
            CALL      RDEMVIS1
            IF        OVRCD<>1
              MOVE      EMVIDATE,PENDSDAT        * as at date
              MOVE      EMVIDATE,PENDADAT        * visit date
              MOVE      SP70,PENDDDAT
              IF        EMVISTAT=2 | EMVISTAT=3
                MOVE      EMVIDDAT,PENDDDAT      * discharged date
              ENDIF
              MOVE      EMVIFUND,PENDFUND               * ED
              MOVE      EMVICOMP,PENDCLAM
              MOVE      " 1",PENDSYST            * Emergency
              CALL      IPRH0000
            ENDIF
          ENDIF
.
          IF        PINVSYS=2
            PACK      KEY8,IPADMNO,SP70
            CALL      RDBOKB1 
            IF        OVRCD<>1
              MOVE      OBADATE,PENDSDAT         * as at date
              MOVE      OBADATE,PENDADAT         * Visit date
              MOVE      OBADATE,PENDDDAT         * discharged date
              MOVE      OTBBFUND,PENDFUND               * OP
              MOVE      OBACOMP,PENDCLAM
              MOVE      " 2",PENDSYST            * Outpatient
              CALL      IPRH0000
            ENDIF
          ENDIF
.
          IF        PINVSYS=3
            PACK      KEY8,IPADMNO,SP70
            CALL      RDMISS1
            IF        OVRCD<>1
              IF        CHOSTYP=1 & CFEETYP=0
                MOVE      SIX,PTIPRSTA                * Credit
                MOVE      ADATE,PENDSDAT              * as at date
                CALL      CINVP000                    * Check for tobe invoiced
                GOTO      CIPN9999
              ENDIF
              MOVE      ADATE,PENDSDAT                * as at date
              MOVE      ADATE,PENDADAT                * admission date
              MOVE      SP70,PENDDDAT
              IF        ASTAT=3
                CALL      RDDSCH1
                IF        OVRCD=0
                  MOVE      DDATE,PENDDDAT            * discharged date
                ENDIF
              ENDIF
              MOVE      AFUNDH,PENDFUND               * IP
              MOVE      ACLAIM,PENDCLAM
              MOVE      " 3",PENDSYST                 * Inpatient
              CALL      IPRH0000
            ENDIF
          ENDIF
.
          MOVE      SIX,PTIPRSTA
          MOVE      SP70,PTIPSVAR
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RAIPEN1
          IF        OVRCD=1
            CALL      WRIPEN1
          ELSE
            CALL      UPIPEN1
          ENDIF
.
CIPN9999  RETURN
+
.------------------------------------------------------------
.         Check if ABF Invoice has been charged
.------------------------------------------------------------
ABFN0000  OPEN      PATINVR3,"patinvrf"
          MOVE      PINVADM,AADMNO
          PACK      KEY16,AADMNO,SP70
          CALL      RSPTINV3
ABFN1000  CALL      RKPTINV3
          BRANCH    OVRCD,ABFN8100
.
          MATCH     PINVADM,AADMNO
          GOTO      ABFN8100 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      ABFN1000 IF NOT EQUAL  * Credit note
.
          COMPARE   THREE,PTINCMIX         * check for ABF invoice
          GOTO      ABFN8000 IF EQUAL
          GOTO      ABFN1000
.
ABFN8000  MOVE      ZERO,EXIT              * found an ABF Invoice
          GOTO      ABFN9000
.
ABFN8100  MOVE      ONE,EXIT               * ABF Invoice has not been raised
.
ABFN9000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1                 * reposition to the original invoice

ABFN9999  RETURN
+
.------------------------------------------------------------
.                            USPR0000
.                 Update procedure file if necessary
.------------------------------------------------------------
USPR0000  MOVE      ZERO,F1
          COMPARE   FIVE,CFEETYP
          GOTO      USPR9999 IF NOT EQUAL   * not NZ private billing
.
          COMPARE   THREE,PINVSYS
          GOTO      USPR9999 IF NOT EQUAL
.
          MOVE      ZERO,PFFSFLAG
          CALL      CPRC0000                * Check for Theatre/Proc.charge
          BRANCH    EXIT,USPR1000           * No charge found
          MOVE      ONE,F1
.
USPR1000  MATCH     SP70,PTDTSUNQ
          GOTO      USPR9999 IF EQUAL       * No proc.uniq no
.
          COMPARE   ONE,PFFSFLAG
          GOTO      USPR1200 IF NOT EQUAL
.
.         if we are invoicing FFS invoice, ignore Item records
.
          COMPARE   THREE,TRECTYPE
          GOTO      USPR9999 IF EQUAL
.
USPR1200  PACK      KEY11,DTADMNO,PTDTSUNQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,USPR9999
.
          COMPARE   ZERO,F1
          GOTO      USPR1800 IF NOT EQUAL   * found a procedure charge
.
.         No procedure, check if patient invoice raised
.
          CALL      CPIN0000
          BRANCH    EXIT,USPR3000           * Found a patient invoice
.
.         No patient inv.found, then we must be crediting note a patient invoice
.         but if this a Funded Contract & Invoice is NOT a Funder Contribution
.         with zero Patient Co-payment then there is No Patient Invoice
.         unless there is a Patient charge item..
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,USPR1800
          MATCH     "F",TCINDC7
          GOTO      USPR1800 IF NOT EQUAL
.
          MATCH     "1",NZSPCONT
          GOTO      USPR1800 IF EQUAL       * Funder Contribution
.
          COMPARE   ZERO,NZSPCPAY           * No Co-payment?
          GOTO      USPR1800 IF NOT EQUAL
.
          MATCH     SP70,PTINHFND
          IF        @EQUAL
            COMPARE   THREE,TRECTYPE
            GOTO      USPR9999 IF NOT EQUAL
            COMPARE   ONE,PTDTCCU             * Bill to Patient?
            GOTO      USPR9999 IF NOT EQUAL
            GOTO      USPR1800
          ENDIF
          GOTO      USPR9999
.
USPR1800  MATCH     "0",NZSPINVD
          GOTO      USPR9999 IF EQUAL      * No invoice raised
          MATCH     "1",NZSPINVD
          GOTO      USPR8000 IF EQUAL      * Pat.inv.raised,set to No inv.raised
          MATCH     "2",NZSPINVD
          GOTO      USPR8000 IF EQUAL      * HF inv.raised,set to No inv.raised
.
.         All invoices raised, check the type of invoice
.
          MATCH     SP70,PTINHFND
          GOTO      USPR2000 IF NOT EQUAL 
.
.         Invoice is for PRFA, so set Funder invoice raised
.
          MOVE      "2",NZSPINVD            * Funder invoice
          GOTO      USPR3000
.
.         Invoice is for funder, so set PRFA invoice raised
.
USPR2000  MOVE      "1",NZSPINVD            * PRFA invoice
          GOTO      USPR9000
.
USPR3000  CALL      IRAI0000                * Check if any invoice raised
          BRANCH    EXIT,USPR9000           * found an invoice raised
.
USPR8000  MOVE      "0",NZSPINVD            * Set no invoice raised
.
USPR9000  CALL      UPNZSPR1
          MOVE      PTDTSUNQ,SAVESUNQ
USPR9999  RETURN
+
.******************************************************************************
.         Check if any other invoice had been raised
.******************************************************************************
IRAI0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
IRAI2000  CALL      RDKINV3
          BRANCH    OVRCD,IRAI8000
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      IRAI8000 IF NOT EQUAL
.
          MOVE      ZERO,FORM8
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MATCH     PINVNO,KEY8
          GOTO      IRAI2000 IF EQUAL       * skip current invoice record
.
          MATCH     "1",PTINCRST            * Fully credited?
          GOTO      IRAI2000 IF EQUAL
.
          MOVE      ONE,EXIT
          GOTO      IRAI9000
.
IRAI8000  MOVE      ZERO,EXIT
.
IRAI9000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
IRAI9999  RETURN
+
.******************************************************************************
.         Check if patient invoice had been raised
.******************************************************************************
CPIN0000  PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
CPIN2000  CALL      RDKINV3
          BRANCH    OVRCD,CPIN8000
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      CPIN8000 IF NOT EQUAL
.
          MOVE      ZERO,FORM8
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MATCH     PINVNO,KEY8
          GOTO      CPIN2000 IF EQUAL       * skip current invoice record
.
          MATCH     "1",PTINCRST            * Fully credited?
          GOTO      CPIN2000 IF EQUAL
.
.         Found an invoice raised, check for a patient invoice
.
          MATCH     SP70,PTINHFND
          GOTO      CPIN2000 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CPIN9000
.
CPIN8000  MOVE      ZERO,EXIT
.
CPIN9000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
CPIN9999  RETURN
+
.******************************************************************************
.         Check if there is any procedure/theatre charge for this invoice
.******************************************************************************
CPRC0000  PACK      SKEY23,DTADMNO,TREF,DTRECTYP,TTRANSN1,SP70
.
          PACK      KEY23,ADMISSNO,PINVNO,SP70
          CALL      RDSDTRN4
CPRC1000  CALL      RDKDTRN4
          BRANCH    OVRCD,CPRC8000
.
          MATCH     ADMISSNO,DTADMNO
          GOTO      CPRC8000 IF NOT EQUAL   * different admission number
.
          MATCH     TREF,PINVNO
          GOTO      CPRC8000 IF NOT EQUAL   * different invoice number
.
          IF        TRECTYPE=2
            CALL      FFSI0000              * check for FFS invoice
            GOTO      CPRC6000              * Theatre charge record
          ENDIF
.
          COMPARE   EIGHT,TRECTYPE
          GOTO      CPRC1000 IF NOT EQUAL
.
CPRC6000  MOVE      ZERO,EXIT               * found a procedure/theatre charge
          GOTO      CPRC9000
.
CPRC8000  MOVE      ONE,EXIT
.
CPRC9000  MOVE      SKEY23,KEY23
          CALL      RDDTRN4                  * reposition
.
CPRC9999  RETURN
.------------------------------------------------------------
.         Check if this patient only has FFS procedure
.------------------------------------------------------------
FFSI0000  PACK      KEY11 WITH ADMISSNO,SP70
          CALL      RSNZSPR1
FFSI1000  CALL      RKNZSPR1
          BRANCH    OVRCD OF FFSI9000
.
          MATCH     NZSPADMN,ADMISSNO
          GOTO      FFSI9000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,FFSI1000
.
          MATCH     SP70,TCINDC7
          GOTO      FFSI1000 IF EQUAL           * FFS
.
          MOVE      ZERO,PFFSFLAG
          GOTO      FFSI9999
.
FFSI9000  MOVE      ONE,PFFSFLAG
FFSI9999  RETURN
+
.------------------------------------------------------------
.                            CCPSCA00
.                 cancel Invoice data for CCPS Extract
.------------------------------------------------------------
CCPSCA00  MOVE      ZERO,EXIT
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND03;*218,PTCNUCCP
.
          MATCH     "1",PTCNUCCP            * "1" is "Using CCPS EDI extract"
          GOTO      CCPSCA99 IF NOT EQUAL
.
          OPEN      PATEDTA2,"patedtaf"
.
          PACK      KEY16,PINVNO,SP20
          CALL      RDPTEDT2
          BRANCH    OVRCD,CCPSCA20
.
          COMPARE   TWO,PTETFLAG
          IF        @LESS
.                                           * Invoice "not sent" or "error"
            MOVE      NINE,PTETFLAG         * set to "cancel"
            MOVE      " 9",PTETCCST         * set to "cancel"
          ELSE
            MOVE      " 9",PTETCCST         * set to "cancel"
          ENDIF
          CALL      UPPTEDT2
.
          GOTO      CCPSCA99
.
.
CCPSCA20  CALL      RSPTEDT2
          CALL      RKPTEDT2
          BRANCH    OVRCD,CCPSCA99
.
          MATCH     PINVNO,PTETINVN
          GOTO      CCPSCA99 IF NOT EQUAL
.
          PACK      KEY16,PTETINVN,PTETBATN,SP20
          CALL      RDPTEDT2
.
.                                           * already extracted
          MATCH     " 4",PTETCCST           * is it already approved?
          IF        @EQUAL
            MOVE      ZERO,PTETFLAG         * set to "not sent"
          ENDIF
.
          MOVE      PTETBATN,PTETPBAT
          MOVE      SP8,PTETBATN
          MOVE      " 9",PTETCCST           * set to "cancel"
          CALL      UPPTEDT2
.
.
CCPSCA99  RETURN
+
.------------------------------------------------------------
.         Get the previous credit amount for a transaction
.------------------------------------------------------------
GCCR0000  MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          PACK      KEY22,ADMISSNO,TREF,TTRANSN1
          PACK      KEY30,ADMISSNO,TREF,TTRANSN1,SP70
          CALL      RSPMFCI1
GCCR1000  CALL      RKPMFCI1
          BRANCH    OVRCD,GCCR9999
          PACK      KEY22A,PMFCVISN,PMFCINVN,PMFCTRAN
          MATCH     KEY22,KEY22A
          GOTO      GCCR9999 IF NOT EQUAL
          ADD       PMFCCAMT,TOTAMT
          ADD       PMFCCGST,TOTGST
          ADD       PMFCGSTL,TOTGST
          GOTO      GCCR1000
GCCR9999  RETURN
+
.------------------------------------------------------------
.         Get the previous credit amount for an invoice
.------------------------------------------------------------
ICCR0000  MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          MOVE      PTCNCRNO,KEY8
          PACK      KEY30,ADMISSNO,PINVNO,SP70
          CALL      RSPMFCI1
ICCR1000  CALL      RKPMFCI1
          BRANCH    OVRCD,ICCR9999
.
          MATCH     ADMISSNO,PMFCVISN
          GOTO      ICCR9999 IF NOT EQUAL
.
          MATCH     PINVNO,PMFCINVN
          GOTO      ICCR9999 IF NOT EQUAL
.
          MATCH     KEY8,PMFCCRNO
          GOTO      ICCR1000 IF EQUAL       * Not include current credit note
.
          ADD       PMFCCAMT,TOTAMT
          ADD       PMFCCGST,TOTGST
.
          GOTO      ICCR1000
ICCR9999  RETURN
+
.------------------------------------------------------------
.         Process Credit by item
.------------------------------------------------------------
PRCI0000  MOVE      ZERO,CRDFLAG
          CALL      GCLM0000               * Get claim code
          MOVE      ZERO,CREDITEM
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
.
          MOVE      ZERO,PMFCCGST
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTITEM
            MOVE      CREDAMNT[COUNTER],FORM72
            MOVE      GSTAAMNT[COUNTER],FORM7P2
            IF        FORM72<>0 | FORM7P2<>0
              PACK      KEY22 WITH ADMISSNO,PINVNO,TRANSNUM[COUNTER],SP70
              CALL      RDDTR000
              IF        OVRCD=0
.
                IF        CFEETYP=5 & IBCNUGST=3
                  MOVE      CREDAMNT[COUNTER],TGSTEXCV
                  CALL      IGST0000                   * Get item GST
                ELSE
                  MOVE      GSTAAMNT[COUNTER],PMFCCGST * GST Amount
                ENDIF
                MOVE      CREDAMNT[COUNTER],PMFCCAMT   * Credit Amount
.
                MULT      "-1",PMFCCAMT
                MULT      "-1",PMFCCGST
                MOVE      ZERO,PMFCPTLS    * Lumpsum amount patient portion     
                MOVE      ZERO,PMFCRBLS    * Lumpsum amount rebate portion      
                MOVE      ZERO,PMFCGSTL    * GST Lumpsum amount                 
                CALL      WRFCI000       * Write record to pmsfciaf
                IF        PINVSYS = 3
                  MOVE      ANSC,PROSFLAG
                  CALL      PTRK0000
                ENDIF
.
                MOVE      "2",KEY1       * credit by item
                STORE     KEY1,PINVSYS,ATDTCRST,OTDTCRST,PTDTCRST
                CALL      UPDTR000
.
                MOVE      PMFCCAMT,TPATAMTT  * add credit amount to patfinsf
                MOVE      PMFCCGST,PTDTGSTM  * add gst crd amnt to patfinsf
                CALL      UPFIN000       * Update patfinsf file
                IF        CFEETYP=5 & PINVSYS=3
                  MOVE      PMFCCAMT,GLAMOUNT
                  PACK      NZEXCRST,PTDTCRST,SP70      * Credit note status
                  PROC      NZPGLEXT          * G/L Extract for NZ Private
                ENDIF
              ENDIF
              ADD      PMFCCAMT,TOTAMT
              ADD      PMFCCGST,TOTAMT
.
              ADD      PMFCCGST,TOTGST
            ENDIF
            ADD       ONE,COUNTER
          DO 
.
          COMPARE   ZERO,TOTAMT
          GOTO      PRCI1000 IF NOT EQUAL
          COMPARE   ZERO,TOTGST
          GOTO      PRCI9000 IF EQUAL
.
.         Check if invoice is now fully credited
.
PRCI1000  CALL      CCRD0000               * Check if invoice is now fully cred.
          IF        CHGFLAG=1
            MOVE      "1",PMCNSTAT         * fully credited
          ELSE
            MOVE      "2",PMCNSTAT         * partially credited
          ENDIF
          MOVE      TOTAMT,PMCNAMNT        * Total amount of credit note  
          MOVE      TOTGST,PMCNGSTM        * Total GST
          CALL      WRCRN000               * Write record to pmscnoaf 
.
.         Credit note has now been fully credited, so update the flag in dtr
.
          MATCH     "1",PMCNSTAT
          IF        @EQUAL
            CALL      UPCRD000             * Update dtr for the credit note flag
          ENDIF
.
.         Update the total amount credited for this invoice
.
          IF        CHGFLAG=1
            MOVE      "1",PTINCRST           * fully credited
            CALL      DFAC0000           * Delete Future Action from Act.Plan
            MOVE      PINVNO,KEY8
            CALL      DEPTPFA1               * delete patient future plan
          ELSE
            MOVE      "2",PTINCRST           * partially credited
          ENDIF
          ADD       TOTAMT,PTINCRTT        * amount credited
.
          MOVE      PINVADM,PINVCADM
          PACK      PINVCANC,CCC,CYY,CMM,CDD
          REP       " 0",PINVCANC       * date invoice was credited
          CALL      CBAL0000            * Check if invoice is now balanced
          PACK      PTINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTINUDAT       * date updated
          CLOCK     TIME,PTINUTIM       * time updated
          MOVE      USERID,PTINUUID     * web user id
          CALL      UPINV1
          PROC      FLAGDEBT
.
          MOVE      PINVUR,SAVURNUM
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      SIX,PTIPRSTA                * Credit
            MOVE      ADATE,PENDSDAT              * as at date
            CALL      CINVP000                    * Check for tobe invoiced
            GOTO      CIPN9999
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PRCI9999
.
PRCI9000  MOVE      ONE,EXIT
PRCI9999  RETURN
+
.------------------------------------------------------------
.         Check if invoice is now balanced?
.------------------------------------------------------------
CBAL0000  MOVE      PINVAMT,FORM102      * Invoice amount +
          ADD       PINVPATA,FORM102     * Patient payments +
          ADD       PINVHFDA,FORM102     * H.F payments +
          ADD       PINVOTHA,FORM102     * Other payments +
          ADD       PTINCRTT,FORM102     * Credit Notes +
          ADD       PINVJOUR,FORM102     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM102     * Journal GST = amount outstanding
.
          MOVE      "99999999",PINVBLCD  * Assume it doesn't balance
.
.         Invoice is now balanced. Record the date that this occured
.
          IF        FORM102=0
            PACK      PINVBLCD,CCC,CYY,CMM,CDD
            REP       " 0",PINVBLCD
          ENDIF
CBAL9999  RETURN
+
.------------------------------------------------------------------------------
.         IGST0000 - Get Credit note GST
.------------------------------------------------------------------------------
IGST0000  MOVE      ZERO,FORM12P2
          MOVE      ZERO,TGSTAMNT
          MOVE      TGSTEXCV,FORM12P2      * Credit Amount w/o GST
.
          PACK      KEY16,PINVNO,SP20
          CALL      RSPMCNO3
IGST1000  CALL      RKPMCNO3
          BRANCH    OVRCD,IGST4000
          MATCH     PINVNO,PMCNINVN        * same invoice number?
          GOTO      IGST4000 IF NOT EQUAL
.
          MOVE      PMCNAMNT,F12P2
          SUB       PMCNGSTM,F12P2         * Exclude GST amount
          MULT      "-1",F12P2
.
          ADD       F12P2,FORM12P2      * add up the credit amount w/o GST
.
          ADD       PMCNGSTM,TGSTAMNT      * Accummulate Credit Note GST
          GOTO      IGST1000
.
IGST4000  MULT      "-1",TGSTAMNT
          MOVE      ZERO,F12P2
          MOVE      PINVAMT,F12P2
          SUB       PTINGSTA,F12P2         * Invoice total w/o GST
.
          COMPARE   FORM12P2,F12P2
          GOTO      IGST6000 IF NOT EQUAL
.
.         If Invoice Amt (excl.GST) equals to total Credit Notes Amt
.
          MOVE      PTINGSTA,PMFCCGST
          SUB       TGSTAMNT,PMFCCGST
          GOTO      IGST9999
.
.         Calculate the GST of the credit note
.
IGST6000  CALL      PRCG0000           * Get GST percentage
          MOVE      TGSTEXCV,PMFCCAMT   * Credit Amount
          MOVE      PMFCCAMT,PMFCCGST
          MULT      IBGEAMNT,PMFCCGST  * GST amount
          DIV       "100.00",PMFCCGST  * Divide by 100
IGST9999  RETURN
+
.----------------------------------------------------------------
.         Get GST Percentage
.----------------------------------------------------------------
PRCG0000  MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY14,PTCNAGST,KEY8
          CALL     RDIBGE1
          COMPARE  ZERO,OVRCD
          GOTO     PRCG9999 IF EQUAL         * found GST amount for current date
.
          CALL     RPIBGE1                   * read previous record
          BRANCH   OVRCD,PRCG8000
.
          MATCH    PTCNAGST,IBGECODE         * Same code ?
          GOTO     PRCG9999 IF EQUAL
.
PRCG8000  MOVE     ZERO,IBGEAMNT
PRCG9999  RETURN
+
.----------------------------------------------------------------
.         Update credit note flag in dtr file
.----------------------------------------------------------------
UPCRD000  PACK      KEY22 WITH ADMISSNO,PINVNO,SP70
          CALL      RSDTR000
UPCRD100  CALL      RKDTR000
          BRANCH    OVRCD,UPCRD999
          MATCH     DTADMNO,ADMISSNO
          GOTO      UPCRD999 IF NOT EQUAL
          MATCH     TREF,PINVNO
          GOTO      UPCRD999 IF NOT EQUAL
.
          BRANCH    TRECTYPE,UPCRD100,UPCRD200,UPCRD200
.
          IF        CFEETYP<>5 & PINVSYS=1
            COMPARE   EIGHT,TRECTYPE
            GOTO      UPCRD200 IF EQUAL         * EMR Event procedure
          ENDIF
          GOTO      UPCRD100
.
UPCRD200  MOVE      "1",KEY1       * fully credit
          STORE     KEY1,PINVSYS,ATDTCRST,OTDTCRST,PTDTCRST
          CALL      UPDTR000
          GOTO      UPCRD100
.
UPCRD999  RETURN
+
.----------------------------------------------------------------
.         Check if it's now fully credited 
.----------------------------------------------------------------
CCRD0000  MOVE      ZERO,CHGFLAG
          MOVE      ZERO,FORM82
          MOVE      TOTAMT,FORM82          * Total amount of credit note  
          MOVE      ZERO,FORM12P2
          PACK      KEY16,PINVNO,SP20
          CALL      RSPMCNO3
CCRD1000  CALL      RKPMCNO3
          BRANCH    OVRCD,CCRD8000
          MATCH     PINVNO,PMCNINVN        * same invoice number?
          GOTO      CCRD8000 IF NOT EQUAL
          ADD       PMCNAMNT,FORM82        * add up the credit amount
          ADD       PMCNGSTM,FORM12P2      * add up GST credit note amount
          GOTO      CCRD1000
.
CCRD8000  MULT      "-1",FORM82
          COMPARE   FORM82,PINVAMT
          GOTO      CCRD9999 IF NOT EQUAL
          MOVE      ONE,CHGFLAG               * Fully credited
CCRD9999  RETURN
+
.----------------------------------------------------------------
.         Get claim code for the admission 
.----------------------------------------------------------------
GCLM0000  MOVE      SP10,ACLAIM
          MOVE      PINVADM,KEY8
          BRANCH    PINVSYS,GCLM1000,GCLM2000,GCLM3000
          GOTO      GCLM9999
.
GCLM1000  CALL      RDDETA1                    * Emergency
          BRANCH    OVRCD,GCLM1100             * try Emergency Event
          MOVE      ADACOMP,ACLAIM
          GOTO      GCLM9999
.
GCLM1100  CALL      RDPMEVT1
          BRANCH    OVRCD,GCLM9999 
          MOVE      PMEVCCOD,ACLAIM
          GOTO      GCLM9999
.
GCLM2000  CALL      RDBOKB1                    * Outpatient
          BRANCH    OVRCD,GCLM9999 
          MOVE      OBACOMP,ACLAIM
          GOTO      GCLM9999
.
GCLM3000  CALL      RDMISS1
GCLM9999  RETURN
+
.-----------------------------------------------------------------------------
.         Write record to pmscnoaf (credit note header file for fully credit)
.-----------------------------------------------------------------------------
WRCRN000  MOVE      PTCNCRNO TO PMCNCRNO       * credit note number
          PACK      PMCNDATE,CCC,CYY,CMM,CDD
          REP       " 0",PMCNDATE
          MOVE      PINVADM,PMCNVISN
          MOVE      PINVNO,PMCNINVN
          MOVE      " 3",PMCNSYST         * Inpatient
          IF        PINVSYS=1
            MOVE      " 1",PMCNSYST       * Emergency
          ELSE
            IF        PINVSYS=2
              MOVE      " 2",PMCNSYST     * Outpatient
            ENDIF
          ENDIF
          MOVE      REASCRED,PMCNREAS      * Reason for Credit Note (catg BX)   
          PACK      PMCNSPAR,SP70
          PACK      KEY16,PMCNCRNO,PMCNDATE
          MOVE      PMCNCRNO,KEY8
          CALL      IBACLOCK
          PACK      PMCNCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTCNCDAT
          MOVE      CTIMEIS,PMCNCTIM
          MOVE      WBSEUID,PMCNCUID        * WEB user id
          CALL      WRPMCNO1
.
WRCRN999  RETURN
+
.----------------------------------------------------------------
.         Write record to pmsfciaf (fully credited invoice file)
.----------------------------------------------------------------
WRFCI000  IF        CRDFLAG=0
            CALL      GENCR000     * Generate next credit note number
          ENDIF
          MOVE      DTADMNO,PMFCVISN
          MOVE      TREF,PMFCINVN
          MOVE      TTRANSN1,PMFCTRAN
          MOVE      " 3",PMFCSYST         * Inpatient
          IF        PINVSYS=1
            MOVE      " 1",PMFCSYST       * Emergency
          ELSE
            IF        PINVSYS=2
              MOVE      " 2",PMFCSYST     * Outpatient
            ENDIF
          ENDIF
          MOVE      PTCNCRNO TO PMFCCRNO       * credit note number
          PACK      PMFCCRDA,CCC,CYY,CMM,CDD
          REP       " 0",PMFCCRDA
          MOVE      TPATAMTT,PMFCAMTT    * Gross Total amount                 
          MOVE      TPATAMTG,PMFCAMTG    * Government Portion                 
          MOVE      TPATAMTH,PMFCAMTH    * Orig rate before any disc.allowance
          MOVE      TPATAMTI,PMFCAMTI    * Individual daily rate amount       
          MOVE      TPATAMTP,PMFCAMTP    * Patient portion amount             
          MOVE      TREBATE,PMFCRBAT     * Estimate fund rebate               
          PACK      PMFCTDAT,DTFCENT,DTFYEAR,TFMONTH,DTFDAY  * Date 
          REP       " 0",PMFCTDAT
          PACK      PMFCADAT,TTCENT,TTYEAR,TTMONTH,TTDAY
          REP       " 0",PMFCADAT
          MOVE      TITEMNO,PMFCITEM     * Item Number                        
          MOVE      TDDESC,PMFCDESC      * Description                        
          MOVE      PTDTDES2,PMFCDES2    * Description 2                      
          MOVE      TRECTYPE,PMFCRTYP    * Record Type                        
          MOVE      TNODAYS,PMFCNDAY     * No of days (Accommodation only)    
          MOVE      TCLAIM,PMFCCLAI      * Claimed/Not claimed
          MOVE      TSERVS,PMFCSERV  
          MOVE      TDOCTO,PMFCODOC      * Operating Doctor                   
          MOVE      TSESSION,PMFCSESS    * Session (Theatre Only)             
          MOVE      TMISGRP,PMFCMGRP     * Misc.Group (Misc & Theatre only)   
          MOVE      TDWARD,PMFCWARD      * Ward of Accommodation record       
          MOVE      TCLMTYP,PMFCCTYP     * Claim Type when printing invoice   
          MOVE      TADMTYP,PMFCATYP     * Adm.Type when printing invoice     
          MOVE      TBATCHN,PMFCBTCH     * Batch No for Misc.Itms,Cash,Journal
          MOVE      TINVPRT,PMFCNINV     * Number of invoice to be printed    
          MOVE      PTDTDTYP,PMFCDTYP    * 1=Low outlier,2=Inlier,3=Outlier   
          MOVE      PTDTCCU,PMFCADDC     * Flag for additional charge         
          MOVE      PTDTGSTA,PMFCGSTA    * Is GST Applicable to this item     
          MOVE      PTDTGSTC,PMFCGSTC    * GST Payable code                   
          MOVE      PTDTGSTM,PMFCGSTM    * GST Amount                         
          MULT      "-1",PMFCGSTM
          MOVE      PTDTEFFD,PMFCATFI    * Date item Assigned to Fees Invoice 
          MOVE      WBSEUID,PMFCWUSR     * WEB user
          PACK      PMFCSPAR,SP70
          IF        CFEETYP=5
            MOVE      PTDTLSPT,PMFCPTLS
            MOVE      PTDTLSRB,PMFCRBLS
          ENDIF
          PACK      KEY30,PMFCVISN,PMFCINVN,PMFCTRAN,PMFCCRNO
          CALL      WRPMFCI1
.
WRFCI999  RETURN
+
.----------------------------------------------------------------
.         Update patfinsf (financial file)
.----------------------------------------------------------------
UPFIN000  MOVE      PMFCCRDA,FINDATE        * Credit note date - current date
          REP       " 0",FINDATE
          MOVE      "A",FINTYPE
.
          MOVE      PINVNO,FININVN
          MOVE      PINVADM,FINADMN
          MOVE      PINVUR,FINURNO
.
          MOVE      "0",KEY1
          MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      "1",KEY1              * daycase
          ENDIF
.
          IF        PTINCMIX=3
            MOVE      PINVCLM,TCLMTYP       * ABF
            MOVE      PINVCLM,ACLAIM        * ABF
          ENDIF
.
          MATCH     SP70,TADMTYP
          IF        @EQUAL
            MOVE      ATYPE,TADMTYP
          ENDIF
.
.        update the summary financial file
.
          BRANCH    TRECTYPE,UPFIN020,UPFIN500,UPFIN500,UPFIN500,UPFIN999:
                             UPFIN999,UPFIN500,UPFIN010,UPFIN500
          GOTO      UPFIN999
.
UPFIN010  COMPARE   FIVE,CFEETYP
          GOTO      UPFIN760 IF EQUAL       * NZ Procedure fees
.
          BRANCH    PINVSYS,UPFIN500        * EMR Event Procedure item
          GOTO      UPFIN999
.
.         Accommodation
.
UPFIN020  COMPARE   ONE,PTINCMIX
          GOTO      UPFIN200 IF NOT EQUAL
.
          MATCH     SP70,TCLMTYP
          IF        @EQUAL
            MOVE      PINVCLM,TCLMTYP
          ENDIF
          MOVE      PTDTLSPT,FORM82
          ADD       PTDTLSRB,FORM82
.
          COMPARE   ZERO,FORM82
          GOTO      UPFIN100 IF EQUAL      * no lumpsum amount 
          IF        CACCFEE=5
            PACK      FINCODE,ANSH,KEY1,TCLMTYP,SP70
          ELSE
            IF        CACCFEE=4
              PACK      FINCODE,ANSH,KEY1,TADMTYP,TCLMTYP,SP20
            ELSE
              PACK      FINCODE,ANSH,KEY1,TADMTYP,SP70
            ENDIF
          ENDIF
          MOVE      FORM82,FINAMT
.
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      ZERO,FGSTFLAG
          MOVE      PMVXMHOS,FINHOSP
.
          CALL      PATCALF
          CALL      CRFN0000              * Adjusting patrfnaf file
.
          IF        IBCNUGST=2 & PTDTGSTL<>0
            IF        CACCFEE=5
              PACK      FINCODE,ANSH,KEY1,TCLMTYP,SP70
            ELSE
              IF        CACCFEE=4
                PACK      FINCODE,ANSH,KEY1,TADMTYP,TCLMTYP,SP20
              ELSE
                PACK      FINCODE,ANSH,KEY1,TADMTYP,SP70
              ENDIF
            ENDIF
            MOVE      PTDTGSTL,FINAMT
            MOVE      ONE,FGSTFLAG
            MOVE      PMVXMHOS,FINHOSP
            CALL      PATCALF
            CALL      CRFG0000           * Adjusting patrfgaf file
          ENDIF
.
UPFIN100  IF        CACCFEE=5
            PACK      FINCODE,ANSJ,TCLMTYP,SP70    * daily charge
          ELSE
            IF        CACCFEE=4
              PACK      FINCODE,ANSJ,TDWARD,TCLMTYP,SP20 * Ward/claim
            ELSE
              PACK      FINCODE,ANSJ,TDWARD,SP70    * daily charge
            ENDIF
          ENDIF
          GOTO      UPFIN400
.
UPFIN200  MOVE      "N",ANS
          BRANCH    CACCFEE OF UPFIN210,UPFIN220,UPFIN230,UPFIN240,UPFIN250
.
.         Use Admission type as financial code
.
          PACK      FINCODE WITH ANS,TADMTYP,SP70
          GOTO      UPFIN400
.
.         Use ward and claim type as financial code
.
UPFIN210  PACK      FINCODE WITH ANS,TDWARD,TCLMTYP,SP70
          GOTO      UPFIN400
.
.         Use ward and admission type
.
UPFIN220  PACK      FINCODE,ANS,TDWARD,TADMTYP,SP70
          GOTO      UPFIN400
.
.         Use ward,claim and admission type
.
UPFIN230  PACK      FINCODE,ANS,TDWARD,TCLMTYP,TADMTYP,SP70
          GOTO      UPFIN400
.
.         Use ward and claim type as financial code
.
UPFIN240  PACK      FINCODE,ANS,TDWARD,TADMTYP,TCLMTYP,SP70
          GOTO      UPFIN400
.
.         Use claim type as financial code
.
UPFIN250  PACK      FINCODE WITH ANS,TCLMTYP,SP70
          GOTO      UPFIN400
.
.         the amount from the financial summary file
.
UPFIN400  MOVE      TPATAMTT,FINAMT
          MULT      "-1",FINAMT
.
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      ZERO,FGSTFLAG
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
          COMPARE   ZERO,PTDTGSTM
          GOTO      UPFIN999 IF EQUAL
.
          IF        IBCNUGST=2 | IBCNUGST=3
            IF        PTDTGSTM<>0
              MOVE      PTDTGSTM,FINAMT
              MULT      "-1",FINAMT
              MOVE      ONE,FGSTFLAG
              MOVE      PMVXMHOS,FINHOSP
              CALL      PATCALF
            ENDIF
          ENDIF
          GOTO      UPFIN999
.
.        - Miscellaneous or Theatre record
.
UPFIN500  COMPARE   ONE,PTINCMIX
          GOTO      UPFIN700 IF NOT EQUAL
.
          IF        PTCNMFEE=1
            MATCH     TMISGRP,SP3
            IF        @EQUAL
              PACK      FINCODE,ANSP,KEY1,ACLAIM,TITEMNO,SP20
.                               Misc. Charge, Episode, Claim Code, Item Code
            ELSE
              PACK      FINCODE,ANSP,KEY1,ACLAIM,TMISGRP,SP20
.                          Misc. Charge, Episode, Claim Code, Group Code
            ENDIF
          ELSE
            PACK      FINCODE,ANSP,KEY1,TMISGRP,TITEMNO,SP20
.                             Misc. Charge, Episode, Group Code, Item Code
          ENDIF
          GOTO      UPFIN800
.
UPFIN700  IF        PTCNMFEE=1
            MATCH     TMISGRP,SP3
            IF        @EQUAL
              PACK      FINCODE,ANSQ,ACLAIM,TITEMNO,SP20
.                               Misc. Charge, Claim Code, Item Code
            ELSE
              PACK      FINCODE,ANSQ,ACLAIM,TMISGRP,SP20
.                               Misc. Charge, Claim Code, Group Code
            ENDIF
          ELSE
            PACK      FINCODE,ANSQ,TMISGRP,TITEMNO,SP20
.                             Misc. Charge, Group Code, Item Code
          ENDIF
          GOTO      UPFIN800
.
.         Procedure for NZ private
.
UPFIN760  MATCH     SP70,PTDTSUNQ
          GOTO      UPFIN999 IF EQUAL       * No proc.uniq no
.
          PACK      KEY11,DTADMNO,PTDTSUNQ  * read procedure details file
          CALL      RDNZSPR1                * to check if it's funder contr.
          BRANCH    OVRCD,UPFIN999
.
.         Check type of invoice
.
          MATCH     SP70,PTINHFND
          GOTO      UPFIN770 IF NOT EQUAL
.
.         Patient Invoice
.
          MATCH     "1",NZSPCONT
          IF        @EQUAL
            PACK      FINCODE,ANSO,NZSPCNTR,NZSPCPRC
          ELSE
            PACK      FINCODE,ANSR,NZSPCNTR,NZSPCPRC      * Patient Co-payment
          ENDIF
          GOTO      UPFIN800
.
.         Health Fund Invoice
.
UPFIN770  MATCH     "1",NZSPCONT
          IF        @EQUAL
            PACK      FINCODE,ANSS,NZSPCNTR,NZSPCPRC
          ELSE
            PACK      FINCODE,ANSP,NZSPCNTR,NZSPCPRC      * Fixed fee
            IF        TPATAMTT>0
              PACK      FINCODE,ANSU,NZSPCNTR,NZSPCPRC    * Co-payment Adj.
            ENDIF
          ENDIF
.
UPFIN800  MOVE      TPATAMTT,FINAMT
          MULT      "-1",FINAMT
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      ZERO,FGSTFLAG
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
          IF        IBCNUGST=2 | IBCNUGST=3
            IF        PTDTGSTM<>0
              MOVE      PTDTGSTM,FINAMT
              MULT      "-1",FINAMT
              MOVE      ONE,FGSTFLAG
              MOVE      PMVXMHOS,FINHOSP
              CALL      PATCALF
            ENDIF
          ENDIF
.
UPFIN999  RETURN
+
.******************************************************************************
.       CRFN0000 - check for patrfnaf file
.******************************************************************************
CRFN0000 MOVE      ZERO,FORM8
         MOVE      PMVXMHOS,FINHOSP
         MOVE      TWO,FGSTFLAG
         OPEN      PATRFNA1,"patrfnaf"
         IF        CFEETYP=5
           OPEN      NZPRFNA1,"nzprfnaf"
         ENDIF
         PACK      KEY19,PINVADM,PINVNO,SP70
         CALL      RSPTRBL1
CRFN1000 CALL      RKPTRBL1
         BRANCH    OVRCD,CRFN7000
         MATCH     DPINVADM,PTRBADMN       * same admission ?
         GOTO      CRFN7000 IF NOT EQUAL
         MATCH     PINVNO,PTRBINVN         * Same invoice number ?
         GOTO      CRFN7000 IF NOT EQUAL  
.
         ADD       ONE,FORM8
.
         MATCH     SP70,TCLMTYP
         IF        @EQUAL
           MOVE      ACLAIM,TCLMTYP
         ENDIF
.
.        Adjust patrfnaf file
.
         PACK      KEY5,ANSF,ANSI,PTRBBRCD   * check if this is accommodation
         CALL      RDCODE1
         BRANCH    OVRCD,CRFN2000
.
         MATCH     ANSA,TCINDC2
         GOTO      CRFN2000 IF NOT EQUAL     * not accommodation record
.
         BRANCH    CACCFEE,CRFN1100,CRFN1200,CRFN1300,CRFN1400,CRFN1500
         PACK      FINCODE,ANSN,PTRBBRCD,TADMTYP,SP70
         GOTO      CRFN3000
.
CRFN1100 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TCLMTYP,SP70
         GOTO      CRFN3000
.
CRFN1200 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TADMTYP,SP70
         GOTO      CRFN3000
.
CRFN1300 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TCLMTYP,TADMTYP,SP70
         GOTO      CRFN3000
.
CRFN1400 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TADMTYP,TCLMTYP,SP70
         GOTO      CRFN3000
.
CRFN1500 PACK      FINCODE,ANSN,TCLMTYP,PTRBBRCD,SP70
         GOTO      CRFN3000
.
.        Miscellaneous items
.
CRFN2000 IF        PTCNMFEE = 1
           PACK      FINCODE,ANSP,TCLMTYP,PTRBBRCD,SP70
         ELSE
           PACK      FINCODE,ANSP,PTRBBRCD,SP70
         ENDIF
.
CRFN3000 MOVE      PTRBAMNT,FINAMT
         CALL      PATCALF
         GOTO      CRFN1000
.
CRFN7000 COMPARE   ZERO,FORM8            * check if revenue breakdown exists
         GOTO      CRFN9999 IF NOT EQUAL * yes
.
         PACK      FINCODE,ANSZ,PTINCMCD,AFUNDH,SP70
         CALL      PATCALF
CRFN9999 RETURN
+
.******************************************************************************
.       CRFG0000 - check for patrfgaf file
.******************************************************************************
CRFG0000 COMPARE   FIVE,CFEETYP
         GOTO      CRFG9999 IF EQUAL       * NZ private
.
         MOVE      ZERO,FORM8
         MOVE      PMVXMHOS,FINHOSP
         MOVE      THREE,FGSTFLAG
         OPEN      PATRFGA1,"patrfgaf"
         PACK      KEY19,PINVADM,PINVNO,SP70
         CALL      RSPTRBL1
CRFG1000 CALL      RKPTRBL1
         BRANCH    OVRCD,CRFG7000
         MATCH     DPINVADM,PTRBADMN       * same admission ?
         GOTO      CRFG7000 IF NOT EQUAL
         MATCH     PINVNO,PTRBINVN         * Same invoice number ?
         GOTO      CRFG7000 IF NOT EQUAL
.
         ADD       ONE,FORM8
.
         MATCH     SP70,TCLMTYP
         IF        @EQUAL
           MOVE      ACLAIM,TCLMTYP
         ENDIF
.
.        Adjust patrfgaf file
.
         PACK      KEY5,ANSF,ANSI,PTRBBRCD   * check if this is accommodation
         CALL      RDCODE1
         BRANCH    OVRCD,CRFG2000
.
         MATCH     ANSA,TCINDC2
         GOTO      CRFG2000 IF NOT EQUAL     * not accommodation record
.
         BRANCH    CACCFEE,CRFG1100,CRFG1200,CRFG1300,CRFG1400,CRFG1500
         PACK      FINCODE,ANSN,PTRBBRCD,TADMTYP,SP70
         GOTO      CRFG3000
.
CRFG1100 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TCLMTYP,SP70
         GOTO      CRFG3000
.
CRFG1200 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TADMTYP,SP70
         GOTO      CRFG3000
.
CRFG1300 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TCLMTYP,TADMTYP,SP70
         GOTO      CRFG3000
.
CRFG1400 PACK      FINCODE,ANSN,PTRBBRCD,TDWARD,TADMTYP,TCLMTYP,SP70
         GOTO      CRFG3000
.
CRFG1500 PACK      FINCODE,ANSN,TCLMTYP,PTRBBRCD,SP70
         GOTO      CRFG3000
.
.        Miscellaneous items
.
CRFG2000 IF        PTCNMFEE = 1
           PACK      FINCODE,ANSP,TCLMTYP,PTRBBRCD,SP70
         ELSE
           PACK      FINCODE,ANSP,PTRBBRCD,SP70
         ENDIF
.
CRFG3000 MOVE      PTRBGAMN,FINAMT
         CALL      PATCALF
         GOTO      CRFG1000
.
CRFG7000 COMPARE   ZERO,FORM8            * check if revenue breakdown exists
         GOTO      CRFG9999 IF NOT EQUAL * yes
.
         PACK      FINCODE,ANSZ,PTINCMCD,AFUNDH,SP70
         CALL      PATCALF
CRFG9999 RETURN
+
.----------------------------------------------------------------
.         Write record to pmsmtiaf (misc.theatre item file)
.----------------------------------------------------------------
WRMTI000  MOVE      DTADMNO,PMMIVISN      * Visit number                       
          MOVE      TTRANSN1,PMMITRAN     * Transaction Number                 
          MOVE      URNUMBER,PMMIURNO     * U/R Number                         
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      " 3",PMMISYST         * Inpatient System
          IF        PINVSYS=1
            MOVE      " 1",PMMISYST       * Emergency
            MOVE      ATDTEDAD,PMMIEDAD   * Service doctor
            MOVE      ATDTSUBN,PMMISUBN   * Sub-item code
            MOVE      ATDTSVTM,PMMISVTM   * Service time
            MOVE      ATDTSCHF,PMMISCHF   * Schedule fee
            MOVE      ATDTITYP,PMMIITYP   * Item type
            MATCH     "1",PTCNUESF
            IF        @EQUAL
              MOVE     ATDTRBRS,PMMIRBRS  * Rebate Reason
            ENDIF
          ELSE
            IF        PINVSYS=2
              MOVE      " 2",PMMISYST     * Outpatient
            ENDIF
          ENDIF
          MOVE      TITEMNO,PMMIITEM      * Item Number                        
          MOVE      TDDESC,PMMIDESC       * Description                        
          MOVE      PTDTDES2,PMMIDES2     * Description 2                      
          PACK      PMMITDAT,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY  * date 
          REP       " 0",PMMITDAT
          MOVE      TRECTYPE,PMMIRTYP     * Record type                        
          MOVE      TRECEIPT,PMMIREFN     * Reference                          
          MOVE      TPATAMTT,PMMIAMTT     * Gross Total amount                 
          MOVE      TPATAMTG,PMMIAMTG     * Government Portion                 
          MOVE      TPATAMTH,PMMIAMTH     * Orig rate before any disc.allowance
          MOVE      TPATAMTP,PMMIAMTP     * Patient portion amount             
          MOVE      TREBATE,PMMIRBAT      * Estimate Rebate amount             
          MOVE      TDOCTA,PMMITDOC       * Treating doctor                    
          MOVE      TSERVS,PMMISERV       * Service Number                     
          MOVE      TDOCTO,PMMIODOC       * Operating docotr                   
          MOVE      TSESSION,PMMISESS     * Session (Theatre only)             
          MOVE      TMISGRP,PMMIMGRP      * Misc.Group (Mis.& Theatre only)    
          MOVE      TBATCHN,PMMIBTCH      * Batch No for Misc.Items,Cash,Jrnl. 
          MOVE      TNINVS,PMMIINVN       * No of Invoices                     
          MOVE      PTDTGSTA,PMMIGSTA     * Is GST Applicable to this item     
          MOVE      PTDTGSTC,PMMIGSTC     * GST Payable code                   
          MOVE      PTDTGSTM,PMMIGSTM     * GST Amount                         
          MOVE      SP70,PMMIINCT
          MOVE      PTDTCCU,PMMIINCT      * Flag for Inclusion flag
          MOVE      PTDTSUNQ,PMMISUNQ     * Procedure Unique no
          MOVE      PTDTUNIQ,PMMIUNIQ     * Booking Unique number
          MOVE      PTDTCNTR,PMMICNTR     * Funder
          MOVE      ATDTACOI,PMMIACOI     * After Care Override Indicator
          MOVE      ATDTDSOV,PMMIDSOV     * Duplicate Service Override
          MOVE      ATDTSTXT,PMMISTXT     * Service Text
          MOVE      ATDTLSPN,PMMILSPN     * Location Specific Practice No(LSPN)
          MOVE      ATDTMPOV,PMMIMPOV     * Multi Procedure Override
          MOVE      ATDTNMPT,PMMINMPT     * Number of Patients Seen
          MOVE      ATDTSDCD,PMMISDCD     * Self Deem Code (Cat Sd)
          MOVE      ATDTTDUR,PMMITDUR     * Time Duration (Mins)
          MOVE      ATDTROVR,PMMIROVR     * Restricted Override Code (Cat Ro)
          MOVE      WBSEUID,PMMIWUSR      * WEB User ID                        
          MOVE      "0",PMMIMVBR          * Mechanical ventilation billing
          IF        CFEETYP=5 & TRECTYPE=3
            MOVE      PTDTEPSD,PMMIMVBR   * flag for NZ Private Pack item
          ENDIF
          MOVE      "1",PMMICCON          * CMBS Confirmed
          PACK      PMMISPAR,SP70
.
WRMTI200  PACK      KEY14,PMMIVISN,PMMITRAN,SP70
          CALL      RAPMMTI1
          IF        OVRCD=0
            MOVE      PMMIVISN,KEY8
            CALL      TRVISA1
            MOVE      PVITRAN,PMMITRAN
            GOTO      WRMTI200
          ENDIF
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      WBSEUID,PMMIIDCR
          MOVE      PTDTTMNO,PMMITMNO
          MOVE      PTDTPMBS,PMMIPMBS
          MOVE      SP70,PMMICTYP
.
          CALL      WRPMMTI1
.
WRMTI999  RETURN
+
.----------------------------------------------------------------
.         Generate next credit note number
.----------------------------------------------------------------
GENCR000  MOVE      SP20 TO PMFCCRNO
          READ      CONTROLF,HUND09;*196,PTCNCRNO
.
          MOVE      "109",PRXCODE   * System Lock Sector 109
          CALL      GETSLK00        * Get System Lock of Sector 109
.
          READ      CONTROLF,HUND09;*196,PTCNCRNO
          COMPARE   ZERO TO PTCNCRNO
          IF        @EQUAL
            MOVE      ONE,PTCNCRNO
          ENDIF
.
GENCR100  MOVE      PTCNCRNO,KEY8
          CALL      RAPMCNO1
          IF        OVRCD=0
            ADD       ONE,PTCNCRNO
            GOTO      GENCR100
          ENDIF
.
          ADD       ONE TO PTCNCRNO
          WRITAB    CONTROLF,HUND09;*196,PTCNCRNO
          CALL      RELSLK00        * Release System Lock of Sector 109
          SUB       ONE FROM PTCNCRNO
          MOVE      PTCNCRNO TO PMFCCRNO       * credit note number
          MOVE      ONE,CRDFLAG
GENCR999  RETURN
+
.------------------------------------------------------------
. GST Code List
.------------------------------------------------------------
LGST0000  PACK      KEY6,SP10
          OPEN      IBAGSTA1,"ibagstaf"
          CALL      RSIBGS1 
LGST1000  CALL      RKIBGS1
          BRANCH    OVRCD,LGST9000
.
          COMPARE   ONE,IBGSACTV         
          GOTO      LGST1000 IF EQUAL     * inactive code
.
          MATCH     IBGSCODE,GSTCODES
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected>":
                               IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#">":
                               IBGSDESC,"</option>"
          ENDIF
          GOTO      LGST1000
.
LGST9000  CLOSE     IBAGSTA1
LGST9999  RETURN
+
.------------------------------------------------------------
. Table of Invoice Rebate Details
.------------------------------------------------------------
REBINV00  MOVE      ZERO,SUMPPOR
          MOVE      ZERO,SUMRPOR
          MOVE      ZERO,SUMPCSH
          MOVE      ZERO,SUMRCSH
          MOVE      ZERO,SUMJR
          MOVE      ZERO,ROWCOUNT
.
          MATCH     SP70,ADMISSNO
          GOTO      REBINV99 IF EQUAL
          PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
REBINV10  CALL      RDKINV3
          BRANCH    OVRCD,REBINV90
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      REBINV90 IF NOT EQUAL
.
          COMPARE   ZERO,PINVREB
          GOTO      REBINV10 IF EQUAL
.
          SUB       PINVREB,PINVAMT
          ADD       PINVOTHA,PINVHFDA
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkInvoice(#"":
                               PINVNO,"#",#"",VISITTYP,"#",#"",URNUMBER,"#")'>":
                               PINVNO,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          ADD       PTINGSTJ,PINVJOUR    * GST Journals
          WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",PINVREB,"</td>":
                             "<td align=right>",PINVPATA,"</td>":
                             "<td align=right>",PINVHFDA,"</td>":
                             "<td align=right>",PINVJOUR,"</td></tr>"
          ADD       ONE,ROWCOUNT
.
          ADD       PINVAMT,SUMPPOR     * total patient portion
          ADD       PINVREB,SUMRPOR      * total rebate portion
          ADD       PINVPATA,SUMPCSH     * Patient cash
          ADD       PINVHFDA,SUMRCSH     * Rebate cash 
          ADD       PINVJOUR,SUMJR       * Journals
.
          GOTO      REBINV10
.
REBINV90  IF        ROWCOUNT>0
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>Total</td>":
                               "<td align=right><b>",SUMPPOR,"</b></td>":
                               "<td align=right><b>",SUMRPOR,"</b></td>":
                               "<td align=right><b>",SUMPCSH,"</b></td>":
                               "<td align=right><b>",SUMRCSH,"</b></td>":
                               "<td align=right><b>",SUMJR,"</b></td></tr>"
          ENDIF
REBINV99  RETURN
+
.------------------------------------------------------------
. View Invoice Rebate 
.------------------------------------------------------------
VIEWRB00  MOVE      ZERO,SUMRPOR
          MOVE      ZERO,SUMPPOR
          MOVE      ZERO,ROWCOUNT
.
          MATCH     SP70,ADMISSNO
          GOTO      VIEWRB99 IF EQUAL
.
          WRITE     HTMLFILE;"<tr>":
                            "<td class=HeadingCell>Date</td>":
                            "<td class=HeadingCell>Days</td>":
                            "<td class=HeadingCell>Description</td>":
                            "<td class=HeadingCell>Item</td>":
                            "<td align=right class=HeadingCell>":
                            "Patient Amount</td>":
                            "<td align=right class=HeadingCell>":
                            "Rebate Amount</td>":
                            "</tr>"
.
          PACK      KEY22 WITH ADMISSNO,PINVNO,SP6
          CALL      RDSDTRN1
VIEWRB10  CALL      RDKDTRN1
          BRANCH    OVRCD OF VIEWRB90
.
          MATCH     TREF,PINVNO
          GOTO      VIEWRB90 IF NOT EQUAL
.
          COMPARE   ZERO,TREBATE
          GOTO      VIEWRB10 IF EQUAL
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          BRANCH    TRECTYPE OF VIEWRB20,VIEWRB30,VIEWRB30,VIEWRB30:
                                VIEWRB40,VIEWRB40
.
.         Accommodation
.
VIEWRB20  PACK      KEY8,TTCENT,TTYEAR,TTMONTH,TTDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      TPATAMTT,TPATAMTP
          SUB       TREBATE,TPATAMTP
          ADD       PTDTGSTM,TPATAMTP             * include GST
          WRITE     HTMLFILE;" to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>&nbsp;",TNODAYS,"</td>":
                             "<td>&nbsp;",TDDESC,"</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>&nbsp;",TPATAMTP,"</td>":
                             "<td align=right>&nbsp;",TREBATE,"</td>":
                             "</tr>"
          GOTO      VIEWRB50
.
.         Miscellaneous
.
VIEWRB30  IF        TSERVS<>0
            MULT      TSERVS,TREBATE
          ENDIF
          MOVE      TPATAMTT,TPATAMTP
          SUB       TREBATE,TPATAMTP
          ADD       PTDTGSTM,TPATAMTP             * include GST
          WRITE     HTMLFILE;"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;",TDDESC,"</td>":
                             "<td>&nbsp;",TITEMNO,"</td>":
                             "<td align=right>&nbsp;",TPATAMTP,"</td>":
                             "<td align=right>&nbsp;",TREBATE,"</td>":
                             "</tr>"
          GOTO      VIEWRB50
.
.         Cash/Journals
.
VIEWRB40  MOVE      TPATAMTT,TPATAMTP
          SUB       TREBATE,TPATAMTP
          WRITE     HTMLFILE;"</td>";
.
          IF        TRECTYPE=5
            WRITE     HTMLFILE;"<td>Cash</td>";
          ELSE
            WRITE     HTMLFILE;"<td>Journal</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",TDDESC,"</td>":
                             "<td>&nbsp;",TTYPE,"</td>":
                             "<td align=right>&nbsp;",TPATAMTP,"</td>":
                             "<td align=right>&nbsp;",TREBATE,"</td>":
                             "</tr>"
.
VIEWRB50  ADD       TREBATE,SUMRPOR
          ADD       TPATAMTP,SUMPPOR
          ADD       ONE,ROWCOUNT
          GOTO      VIEWRB10
.
.         Display Rebate Total
.
VIEWRB90  IF        ROWCOUNT>0
            WRITE     HTMLFILE;"<tr>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>Total</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>&nbsp;<b>",SUMPPOR,"</b></td>":
                               "<td align=right>&nbsp;<b>",SUMRPOR,"</b></td>":
                               "</tr>"
          ENDIF
VIEWRB99  RETURN
+
.------------------------------------------------------------
. View Rates
.------------------------------------------------------------
VRATES00  MOVE      ZERO,SUMRPOR
          MOVE      ZERO,ROWCOUNT
.
          MATCH     "00000000",ADMISSNO
          GOTO      VRATES99 IF EQUAL
.
          MATCH     SP70,ADMISSNO
          GOTO      VRATES99 IF EQUAL
.
          MOVE      ADMISSNO,AADMNO
          MOVE      SP10,LSTDATE
          MOVE      ZERO,ENDFLAG
          MOVE      ZERO,CMIXFLAG
          PACK      KEY30 WITH AADMNO,SP20
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD OF VRATES90     * No rates
.
          MATCH     TADMN,AADMNO
          GOTO      VRATES90 IF NOT EQUAL
.
          MOVE      ALACDTE,IDATEF           * set starting date for next inv.
          MOVE      IDATEF,SIDATET           * set starting date for next inv.
          PACK      CMDRG,PTMIPCMX,SP20      * default to provisional DRG code
.
          UNPACK    SP10,KEY4,KEY5
          UNPACK    PTMIPCMX,KEY4,KEY5
          MATCH     SP5,KEY5
          IF        @EQUAL
            IF        ASTAT = 3
              MATCH     SP4,PTDSDDRG
              IF        !@EQUAL
                PACK      CMDRG,PTDSDDRG,SP20        * use discharge DRG code
              ENDIF
            ENDIF
          ENDIF
.
.         If provisional DRG is blank and not invoiced, check matrix
.
          IF        AINVPRT=0
            MATCH     SP9,PTMIPCMX
            IF        @EQUAL
              MATCH     ANSY,PTMICMXP
              IF        @EQUAL
                CALL      CMXMATRX          * Check if a matrix record exists
                PACK      PTMIPCMX,CMDRG,SP20 
              ENDIF
            ENDIF
          ELSE
            PACK      KEY16,AADMNO,Z70
            CALL      RDSINV3
            CALL      RDPINV3
            IF        OVRCD=0
              MATCH     AADMNO,PINVADM
              IF        @EQUAL
                MOVE      PTINCMCD,PTMIPCMX  * use casemixcode from invoice file
              ENDIF
            ENDIF
          ENDIF
.
.         PCFLAG = 3 where casepayment patient reverts to patcat
.
          MATCH     SP9,PTMIPCMX
          IF        !@EQUAL
            IF        PCFLAG<>3
              MOVE      ONE,CMIXFLAG
            ENDIF
          ENDIF
.
          MOVE      ZERO,TRNFLAG
          MOVE      SP10,A8DATE
          MOVE      SP10,B8DATE
          PACK      CMCODE,PTMIPCMX,SP70
          MOVE      SP10,PTHFBCAT
          MATCH     SP6,AFUNDH
          IF        !@EQUAL
            OPEN      PATFN1A1,"patfn1af"
            PACK      KEY14,AFUNDH,AFNDTB
            CALL      RDFUND1
          ENDIF
.
          PACK      KEY30 WITH AADMNO,SP20
          CALL      RDSTRAN2
VRATES10  CALL      RDKTRAN2
          BRANCH    OVRCD OF VRATES70
.
          MATCH     TADMN,AADMNO
          GOTO      VRATES70 IF NOT EQUAL
.
          MOVE      SP1,DSTEP             * Assume we don't have a stepdown rec
          MOVE      TDATE,A8DATE
.
          MATCH     SP70,PTMIPCMX
          GOTO      VRATES20 IF EQUAL
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            CMATCH    ANSA,TMOVE
            IF        @EQUAL
              MOVE      ZERO,ACDAYCS      * initialise daycase flag
              MATCH     ADATE,DDATE
              IF        @EQUAL
                MOVE      ONE,ACDAYCS     * set one to daycase flag
              ENDIF
            ENDIF
.
            IF       ACDAYCS=1
              GOTO      VRATES40           * sameday, no stepdown
            ELSE
              MOVE      TDATE,XDATE1
              MOVE      TDATE,LSTDATE
              CALL      PATCMSTP
.
              IF        TRNFLAG <>1
                MOVE      A8DATE,B8DATE
              ENDIF
              MOVE      ZERO,TRNFLAG
.
              GOTO      VRATES30
            ENDIF
          ENDIF
.
VRATES20  BRANCH    CHOSTYP OF VRATES40   * Public hospitals don't have stepdown
          MOVE      TDATE,XDATE1
          MOVE      TDATE,LSTDATE
.
          COMPARE   ONE,CSTDOWN
          GOTO      VRATES30 IF NOT EQUAL
.
          CALL      STEPDOWN
          BRANCH    NOFEE,VRATES40
.
VRATES30  MATCH     TDATE,XDATE1
          GOTO      VRATES40 IF EQUAL
          MOVE      "*",DSTEP           * We have a stepdown here
.
VRATES40  COMPARE   ZERO,ENDFLAG
          GOTO      VRATES46 IF EQUAL
.
          MATCH     LSTDATE,TDATE
          GOTO      VRATES60 IF EQUAL
.
VRATES46  REP       " 0",TDATE
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CMATCH    ANSD,TMOVE
          GOTO      VRATES64 IF EQUAL
          CMATCH    ANSL,TMOVE
          GOTO      VRATES50 IF EQUAL
.
          MOVE      TRATEH,FORM82
          ADD       TRATEF,FORM82
          IF        CMIXFLAG=0
            MOVE      ZERO,PTTRADPT      * non casepayment will have no add.chrg
            MOVE      ZERO,PTTRADRB
          ELSE
            ADD       PTTRADRB,FORM82
            ADD       PTTRADPT,FORM82
          ENDIF
          SUB       TDISC,FORM82
.         SUB       TALLW,FORM82
.
          ADD       TRATEF,PTTRADPT
          ADD       TRATEH,PTTRADRB  * patient portion
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " at ",TTIME,DSTEP,"</td>":
                             "<td>&nbsp;",TWARD,"</td>":
                             "<td>&nbsp;",TBED,"</td>":
                             "<td align=right>&nbsp;",PTTRADPT,"</td>":
                             "<td align=right>&nbsp;",TDISC,"</td>":
                             "<td align=right>&nbsp;",PTTRADRB,"</td>":
                             "<td align=right>&nbsp;",FORM82,"</td>":
                             "</tr>"
          GOTO      VRATES60
.
.         On-leave record
.
VRATES50  MOVE      ZERO,PTTRADPT
          MOVE      ZERO,PTTRADRB
          MOVE      ZERO,TDISC
          MOVE      ZERO,TALLW
          MOVE      ZERO,FORM82
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " at ",TTIME,DSTEP,"</td>":
                             "<td>&nbsp;",TWARD,"</td>":
                             "<td>&nbsp;",TBED,"</td>":
                             "<td align=right>&nbsp;",PTTRADPT,"</td>":
                             "<td align=right>&nbsp;",TDISC,"</td>":
                             "<td align=right>&nbsp;",PTTRADRB,"</td>":
                             "<td align=right>&nbsp;",FORM82,"</td>":
                             "</tr>"
.
.         Save some variables for use by STEPDOWN if we are not discharged
.
VRATES60  MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      PTTREPSD,SPTTREPS
          MOVE      TDATE,SIDATET
          GOTO      VRATES10
.
.         Discharge record
.
VRATES64  WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             " at ",TTIME,"</td>":
                             "<td>Discharged</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "</tr>"
          GOTO      VRATES99
.
.
VRATES70  MATCH     SP70,PTMIPCMX
          GOTO      VRATES74 IF EQUAL        * no casemix code
.
          MATCH     ANSY,PTMICMXP
          GOTO      VRATES74 IF NOT EQUAL
.
          MOVE      SP10,A8DATE
          MOVE      SP10,B8DATE
          MOVE      ZERO,TRNFLAG
.
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            GOTO      VRATES99 IF EQUAL
          ENDIF
.
          PACK      XDATE1 WITH CCC,CYY,CMM,CDD
          REP       " 0",XDATE1
          MOVE      XDATE1,TDATE
.
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          MOVE      SPTTRAEN,PTTRAEND
          MOVE      SPTTREPS,PTTREPSD
          CALL      PATCMSTP
          MOVE      "*",DSTEP
          MOVE      ONE,ENDFLAG
          GOTO      VRATES78
.
VRATES74  BRANCH    CHOSTYP OF VRATES99
.
.         Check if a stepdown is required
.
          COMPARE   ONE,CSTDOWN
          GOTO      VRATES99 IF NOT EQUAL
.
          PACK      XDATE1 WITH CCC,CYY,CMM,CDD
          REP       " 0",XDATE1
          MOVE      XDATE1,TDATE
.
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          MOVE      SPTTREPS,PTTREPSD
          MOVE      SPTTRAEN,PTTRAEND
          CALL      STEPDOWN
          BRANCH    NOFEE,VRATES99
          MOVE      "*",DSTEP
          MOVE      ONE,ENDFLAG
.
.         Check if a stepdown was indicated = shown by a new TDATE
.
VRATES78  MATCH     TDATE,XDATE1
          GOTO      VRATES99 IF EQUAL
.
          MATCH     TDATE,LSTDATE
          GOTO      VRATES40 IF LESS
          GOTO      VRATES60
.
.         No stepdown indicated
.
VRATES90  WRITE     HTMLFILE;"<tr><center></blink><h2><b>No Rates Details":
                             "</b></h2>":
                             "</blink></center></tr>";
VRATES99  RETURN
+
.------------------------------------------------------------
. Table of Fees Estimates Quotations
.------------------------------------------------------------
FEEQUT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,URNUMBER
          GOTO      FEEQUT99 IF EQUAL
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
FEEQUT10  PACK      KEY20,URNUMBER,Z70
          CALL      RSPMFED2
FEEQUT20  CALL      RPPMFED2
          BRANCH    OVRCD,FEEQUT99
          MOVE      PMFDURNO,KEY8
          MATCH     KEY8,URNUMBER
          GOTO      FEEQUT99 IF NOT EQUAL
.
          MATCH     "9",PMFDQUOT
          GOTO      FEEQUT20 IF EQUAL      * Skip IFC quote
.
          PACK      NEXTVKEY,URNUMBER,PMFDQUOT,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,URNUMBER,PMFDQUOT,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FEEQUT20
          ENDIF
.
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PMFDCLTY
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMFDEXPD
          IF        !@EQUAL
            UNPACK    PMFDEXPD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
. 
          UNPACK    PMFDADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,DIM50
          PACK      KEY20,PMFDQUOT,SP70
          CALL      RSPMAEL2
FEEQUT50  CALL      RKPMAEL2
          IF        OVRCD=0 
            MATCH     PMFDQUOT,PMAEQUOT
.           IF        !@EQUAL
.             MOVE      SP70,PMAEVISN 
.           ENDIF
            IF        @EQUAL
              STRIP     DIM50
              SQUEEZE   PMAEVISN
              PACK      DIM50,DIM50,SP1,PMAEVISN
              GOTO      FEEQUT50
            ENDIF
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DIM50,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DISPDATE,"&nbsp;</td>";
          ENDIF
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      FEEQUT20 IF NOT EQUAL
.
FEEQUT99  RETURN
+
.------------------------------------------------------------
. Table of Fees Estimates Quotations for Free format patient
. using a surname and given name search
.------------------------------------------------------------
FREQSN00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          STRIP     SRCHSNAM
          STRIP     SRCHGNAM
          REP       UPPLOW,SRCHSNAM
          REP       UPPLOW,SRCHGNAM
.
          PACK      KEY32,SRCHSNAM,SP70
          CALL      RSPMFEN2
FREQSN10  CALL      RKPMFEN2
          BRANCH    OVRCD,FREQSN90
.
          MATCH     SRCHSNAM,PMFNSNAM
          GOTO      FREQSN90 IF NOT EQUAL
.
          MATCH     SP70,SRCHGNAM
          IF        !@EQUAL & !@EOS
            MATCH     SRCHGNAM,PMFNGNAM
            GOTO      FREQSN10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,PMFNQUOT,SP70
          CALL      RDPMFED1
          BRANCH    OVRCD,FREQSN10
.
          MATCH     SP70,PMFDURNO
          GOTO      FREQSN10 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FREQSN10
          ENDIF
.
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PMFDCLTY
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMFDEXPD
          IF        !@EQUAL
            UNPACK    PMFDEXPD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
. 
          UNPACK    PMFDADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,DIM50
          PACK      KEY20,PMFDQUOT,SP70
          CALL      RSPMAEL2
FREQSN50  CALL      RKPMAEL2
          IF        OVRCD=0
            MATCH     PMFDQUOT,PMAEQUOT
            IF        @EQUAL
              STRIP     DIM50
              SQUEEZE   PMAEVISN
              PACK      DIM50,DIM50,SP1,PMAEVISN
              GOTO      FREQSN50
            ENDIF
          ENDIF
.
          MOVE      SP70,PACFNAME
          MOVE      PMFDQUOT,KEY12
          CALL      RDPMFEN1
          IF        OVRCD=0
            MOVE      PMFNSNAM,PACSNAME
            MOVE      PMFNGNAM,PACGNAME
            MOVE      PMFNTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME                 * Format the patient name
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",PACFNAME,"&nbsp;</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DIM50,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",PACFNAME,"&nbsp;</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DISPDATE,"&nbsp;</td>";
          ENDIF
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      FREQSN10 IF NOT EQUAL
.
FREQSN90  RESET     SRCHSNAM
          RESET     SRCHGNAM
.
FREQSN99  RETURN
.
+
.------------------------------------------------------------
. Table of Fees Estimates Quotations for Free format patient
. searched by surname and given name
.------------------------------------------------------------
FREQUT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
FREQUT10  PACK      KEY20,URNUMBER,Z70
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      "9",KEY1
            PACK      KEY20,URNUMBER,KEY1,SP70
          ENDIF
          CALL      RSPMFED2
FREQUT20  CALL      RPPMFED2
          BRANCH    OVRCD,FREQUT99
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MATCH     SP70,PMFDURNO
            GOTO      FREQUT99 IF NOT EQUAL
          ELSE
            MOVE      PMFDURNO,KEY8
            MATCH     KEY8,URNUMBER
            GOTO      FEEQUT99 IF NOT EQUAL
          ENDIF
.
          MATCH     "9",PMFDQUOT
          GOTO      FREQUT20 IF EQUAL      * Skip IFC quote
.
          PACK      NEXTVKEY,URNUMBER,PMFDQUOT,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,URNUMBER,PMFDQUOT,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FREQUT20
          ENDIF
.
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PMFDCLTY
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMFDEXPD
          IF        !@EQUAL
            UNPACK    PMFDEXPD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          UNPACK    PMFDADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,DIM50
          PACK      KEY20,PMFDQUOT,SP70
          CALL      RSPMAEL2
FREQUT50  CALL      RKPMAEL2
          IF        OVRCD=0
            MATCH     PMFDQUOT,PMAEQUOT
.           IF        !@EQUAL
.             MOVE      SP70,PMAEVISN
.           ENDIF
            IF        @EQUAL
              STRIP     DIM50
              SQUEEZE   PMAEVISN
              PACK      DIM50,DIM50,SP1,PMAEVISN
              GOTO      FREQUT50
            ENDIF
          ENDIF
.
          MOVE      SP70,PACFNAME
          MOVE      PMFDQUOT,KEY12
          CALL      RDPMFEN1
          IF        OVRCD=0
            MOVE      PMFNSNAM,PACSNAME
            MOVE      PMFNGNAM,PACGNAME
            MOVE      PMFNTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME                 * Format the patient name
          ENDIF
.
          IF        F1=1
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",PACFNAME,"&nbsp;</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DIM50,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               PMFDQUOT,"#",#"",URNUMBER,"#")'>":
                               PMFDQUOT,"</td>":
                               "<td>",PACFNAME,"&nbsp;</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFDHFUN,"&nbsp;</td>":
                               "<td>",PMFDHFTB,"&nbsp;</td>":
                               "<td>",DISPDATE,"&nbsp;</td>";
          ENDIF
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      FREQUT20 IF NOT EQUAL
.
FREQUT99  RETURN
+
.------------------------------------------------------------
. Table of Fees Information Quotations
.------------------------------------------------------------
FEEINF00  MATCH     SP70,URNUMBER
          GOTO      FEEINF99 IF EQUAL
.         
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
FEEINF10  PACK      KEY23,URNUMBER,Z70
          CALL      RSPMFID2
FEEINF20  CALL      RPPMFID2
          BRANCH    OVRCD,FEEINF99
          MOVE      PMFIURNO,KEY8
          MATCH     KEY8,URNUMBER
          GOTO      FEEINF99 IF NOT EQUAL
.
          PACK      NEXTVKEY,URNUMBER,PMFIFINO,PMFIUNIQ,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,URNUMBER,PMFIFINO,PMFIUNIQ,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FEEINF20
          ENDIF
.
          MOVE      "CL",KEY2
          PACK      KEY5,KEY2,PMFICLTY
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLMDESC
          ENDIF
.
          UNPACK    PMFIADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,DIM50
          PACK      KEY20,PMFIFINO,SP70
          CALL      RSPMAIL2
FEEINF50  CALL      RKPMAIL2
          IF        OVRCD=0
            MATCH     PMFIFINO,PMALFINO
.           IF        !@EQUAL
.             MOVE      SP70,PMALADMN
.           ENDIF
            IF        @EQUAL
              STRIP     DIM50
              SQUEEZE   PMALADMN
              PACK      DIM50,DIM50,SP1,PMALADMN
              GOTO      FEEINF50
            ENDIF
          ENDIF
.
          MOVE      ONE,FEEINFLG            * set 'update' flag
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                               " class=ListIcon onclick='linkQuote(#"":
                               FEEINFLG,"#",#"":
                               PMFIFINO,"#",#"":
                               PMFIADMN,"#",#"":
                               URNUMBER,"#")'>":
                               PMFIFINO,"</td>":
                               "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                               "<td>",PMFIHFND,"&nbsp;</td>":
                               "<td>",PMFIHFTB,"&nbsp;</td>":
                               "<td>",DIM50,"&nbsp;</td>";
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      FEEINF20 IF NOT EQUAL
.
FEEINF99  RETURN
+
.------------------------------------------------------------
. INTS000   - Table sorting of Patient Invoice Details
.------------------------------------------------------------
INTS0000  MOVE      ONE,TOTLFLAG
          MOVE      ZERO,PPRCFLAG
          MOVE      ZERO,NZEROFLG      * Display all outstanding balance
.
          MOVE      ZERO,NOCOMPCL
.
          MOVE      ZERO,ISBLFLAG      * Taken from HDINV000
.
          MOVE      ONE,TBSRTFLG       * Flag set for tablesorting
          MOVE      ONE,SHOWFLAG       * Show no more invoice message
          MOVE      IBCNMHOS,HOSPFLAG
.
          CALL      PINVCI00           * Patient Invoice list
          GOTO      INTS9999
.
INTS9999  RETURN
+
.------------------------------------------------------------
.   Clear PMDFES
.------------------------------------------------------------
CLPFES00  MOVE      SP70,PMFSQUOT   
          MOVE      SP70,DPMFSUNI   
          MOVE      SP70,PMFSURNO   
          MOVE      ZERO,PMFSRTYP  
          MOVE      ZERO,PMFSLUMH  
          MOVE      ZERO,PMFSLUMF  
          MOVE      ZERO,PMFSDAFR  
          MOVE      ZERO,PMFSDAYT  
          MOVE      ZERO,PMFSDAYH  
          MOVE      ZERO,PMFSDAHF  
          MOVE      SP70,PMFSTHIT   
          MOVE      SP70,PMFSTHEH   
          MOVE      SP70,PMFSTHEF   
          MOVE      SP70,PMFSGSTP
          MOVE      SP70,PMFSGSTC
          MOVE      SP70,PMFSSPAR
CLPFES99  RETURN
+
.------------------------------------------------------------
. Routines that should never be called
.------------------------------------------------------------
PATDSITM  DISPLAY   "ERROR ROUTINE PATDSITM CALLED"
          RETURN
PATDSMSC  DISPLAY   "ERROR ROUTINE PATDSMSC CALLED"
          RETURN
PATDSALW  DISPLAY   "ERROR ROUTINE PATDSALW CALLED"
          RETURN
PATDSCOD  DISPLAY   "ERROR ROUTINE PATDSCOD CALLED"
          RETURN
.
.------------------------------------------------------------
.         I/O for DTR's
.------------------------------------------------------------
RSDTR000  BRANCH    PINVSYS,RSDTR100,RSDTR200,RSDTR300
          GOTO      RSDTR999
.
RSDTR100  IF        CREDITEM=2
            CALL      RDSDTRE4            * Emergency
          ELSE
            CALL      RDSDTRE1            * Emergency
          ENDIF
          GOTO      RSDTR999
.
RSDTR200  IF        CREDITEM=2
            CALL      RDSDTRO4            * Outpatient
          ELSE
            CALL      RDSDTRO1            * Outpatient
          ENDIF
          GOTO      RSDTR999
.
RSDTR300  BRANCH    CREDITEM,RSDTR320,RSDTR330
          CALL      RDSDTRN1            * Inpatient
          GOTO      RSDTR999
.
RSDTR320  CALL      RDSDTRN4
          GOTO      RSDTR999
.
RSDTR330  CALL      RDSDTRN5
          GOTO      RSDTR999
.
RSDTR999  RETURN
.
.------------------------------------------------------------
RKDTR000  CALL      CLPATDTR
          BRANCH    PINVSYS,RKDTR100,RKDTR200,RKDTR300
          GOTO      RKDTR999
.
RKDTR100  IF        CREDITEM=2
            CALL      RDKDTRE4            * Emergency
          ELSE
            CALL      RDKDTRE1            * Emergency
          ENDIF
          BRANCH    OVRCD,RKDTR999
          MOVE      DATNUMB,DTADMNO
          MOVE      ATINVNO,TREF
          MOVE      ATTRANS,TTRANSN1
          MOVE      ATDDESC,TDDESC
          MOVE      ATPATAMT,TPATAMTT
          MOVE      ZERO,TPATAMTG
          UNPACK    ATDDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          MOVE      ATITEMNO,TITEMNO
          MOVE      ATRECEPT,TRECEIPT
          MOVE      ATINVPRT,TINVPRT
          MOVE      ATTYPE,TTYPE
          LOAD      TRECTYPE,ATRECTYP,THREE,FIVE,SIX,FIVE,EIGHT,NINE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      ATMISGRP,TMISGRP
          MOVE      ATBATCHN,TBATCHN
          MOVE      ATPATPOR,TPATAMTP
          MOVE      ATREBPOR,TREBATE
          MOVE      ATNINVS,TNINVS
          MOVE      ATSERVS,TSERVS
          MOVE      ATDTEFFD,PTDTEFFD
          MOVE      ATDTGSTA,PTDTGSTA
          MOVE      ATDTGSTC,PTDTGSTC
          MOVE      ATDTGSTM,PTDTGSTM
          GOTO      RKDTR999
.
RKDTR200  IF        CREDITEM=2
            CALL      RDKDTRO4            * Outpatient
          ELSE
            CALL      RDKDTRO1            * Outpatient
          ENDIF
          BRANCH    OVRCD,RKDTR999
          MOVE      DOTNUMB,DTADMNO
          MOVE      OTINVNO,TREF
          MOVE      OTTRANS,TTRANSN1
          MOVE      OTDDESC,TDDESC
          MOVE      OTPATAMT,TPATAMTT
          UNPACK    OTDDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          MOVE      OTITEMNO,TITEMNO
          MOVE      OTRECEPT,TRECEIPT
          MOVE      OTINVPRT,TINVPRT
          MOVE      OTTYPE,TTYPE
          LOAD      TRECTYPE,OTRECTYP,THREE,FIVE,SIX,FOUR,SEVEN,TWO,NINE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      OTMISGRP,TMISGRP
          MOVE      OTBATCHN,TBATCHN
          MOVE      OTPATPOR,TPATAMTP
          MOVE      OTREBPOR,TREBATE
          MOVE      OTNINVS,TNINVS
          MOVE      OTSERVS,TSERVS
          MOVE      OTDTEFFD,PTDTEFFD
          MOVE      OTDTGSTA,PTDTGSTA
          MOVE      OTDTGSTC,PTDTGSTC
          MOVE      OTDTGSTM,PTDTGSTM
          GOTO      RKDTR999
.
RKDTR300  BRANCH    CREDITEM,RKDTR320,RKDTR330
          CALL      RDKDTRN1            * Inpatient
          GOTO      RKDTR999
.
RKDTR320  CALL      RDKDTRN4
          GOTO      RKDTR999
.
RKDTR330  CALL      RDKDTRN5
          GOTO      RKDTR999
.
RKDTR999  RETURN
.
.------------------------------------------------------------
RDDTR000  CALL      CLPATDTR
          BRANCH    PINVSYS,RDDTR100,RDDTR200,RDDTR300
          GOTO      RDDTR999
.
RDDTR100  CALL      RDDTRE1            * Emergency
          BRANCH    OVRCD,RDDTR999
          MOVE      DATNUMB,DTADMNO
          MOVE      ATINVNO,TREF
          MOVE      ATTRANS,TTRANSN1
          MOVE      ATDDESC,TDDESC
          MOVE      ATPATAMT,TPATAMTT
          UNPACK    ATDDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          MOVE      ATITEMNO,TITEMNO
          MOVE      ATRECEPT,TRECEIPT
          MOVE      ATINVPRT,TINVPRT
          LOAD      TRECTYPE,ATRECTYP,THREE,FIVE,SIX,FIVE,EIGHT,NINE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      ATMISGRP,TMISGRP
          MOVE      ATBATCHN,TBATCHN
          MOVE      ATPATPOR,TPATAMTP
          MOVE      ATREBPOR,TREBATE
          MOVE      ATNINVS,TNINVS
          MOVE      ATSERVS,TSERVS
          MOVE      ATDTEFFD,PTDTEFFD
          MOVE      ATDTGSTA,PTDTGSTA
          MOVE      ATDTGSTC,PTDTGSTC
          MOVE      ATDTGSTM,PTDTGSTM
          GOTO      RDDTR999
.
RDDTR200  CALL      RDDTRO1            * Outpatient
          BRANCH    OVRCD,RDDTR999
          MOVE      DOTNUMB,DTADMNO
          MOVE      OTINVNO,TREF
          MOVE      OTTRANS,TTRANSN1
          MOVE      OTDDESC,TDDESC
          MOVE      OTPATAMT,TPATAMTT
          UNPACK    OTDDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          MOVE      OTITEMNO,TITEMNO
          MOVE      OTRECEPT,TRECEIPT
          MOVE      OTINVPRT,TINVPRT
          LOAD      TRECTYPE,OTRECTYP,THREE,FIVE,SIX,FOUR,SEVEN,TWO,NINE
          MOVE      TRECTYPE,DTRECTYP
          MOVE      OTMISGRP,TMISGRP
          MOVE      OTBATCHN,TBATCHN
          MOVE      OTPATPOR,TPATAMTP
          MOVE      OTREBPOR,TREBATE
          MOVE      OTNINVS,TNINVS
          MOVE      OTSERVS,TSERVS
          MOVE      OTDTEFFD,PTDTEFFD
          MOVE      OTDTGSTA,PTDTGSTA
          MOVE      OTDTGSTC,PTDTGSTC
          MOVE      OTDTGSTM,PTDTGSTM
          GOTO      RDDTR999
.
RDDTR300  BRANCH    CREDITEM,RDDTR320
          CALL      RDDTRN1            * Inpatient
          GOTO      RDDTR999
.
RDDTR320  CALL      RDDTRN4
          GOTO      RDDTR999
.
RDDTR999  RETURN
.
.------------------------------------------------------------
UPDTR000  BRANCH    PINVSYS,UPDTR100,UPDTR200,UPDTR300
          GOTO      UPDTR999
.
UPDTR100  CALL      UPDTRE1             * Emergency
          GOTO      UPDTR999
.
UPDTR200  CALL      UPDTRO1             * Outpatient
          GOTO      UPDTR999
.
UPDTR300  BRANCH    CREDITEM,UPDTR320
          CALL      UPDTRN1             * Inpatient
          GOTO      UPDTR999
.
UPDTR320  CALL      UPDTRN4
          GOTO      UPDTR999
.
UPDTR999  RETURN
.
.------------------------------------------------------------
. Open Multi database tables
.------------------------------------------------------------
OPFIL000  PACK      XXDPATH,SP20,SP20,SP20
          LOAD  XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          LOAD  HOSPCODE,HOSPCNT,HDNAME1,HDNAME2,HDNAME3,HDNAME4,HDNAME5,HDNAME6
.
          MOVE      "patinvrf",OPFILE
          MOVE      ONE,FILENUM
          CALL      OMDFN000
.
          MOVE      "patvisaf",OPFILE
          MOVE      TWO,FILENUM
          CALL      OMDFN000
.
          MOVE      "patmi1af",OPFILE
          MOVE      THREE,FILENUM
          CALL      OMDFN000
.
          MOVE      "pmsvx1af",OPFILE
          MOVE      FOUR,FILENUM
          CALL      OMDFN000
.
          MOVE      "priinvof",OPFILE
          MOVE      FIVE,FILENUM
          CALL      OMDFN000
.
          MOVE      "pridtraf",OPFILE
          MOVE      SIX,FILENUM
          CALL      OMDFN000
.
          GOTO      OMDFN999
.
OPFIL999  RETURN
.
.------------------------------------------------------------
.         open the required file
.------------------------------------------------------------
OTRF0000  IF        FILENUM = 1
            CLOSE     PATINVR5
            OPEN      PATINVR5,PATH
          ENDIF
.
          IF        FILENUM = 2
            CLOSE     PATVISA1
            OPEN      PATVISA1,PATH
          ENDIF
.
          IF        FILENUM = 3
            CLOSE     PATMI1A1
            OPEN      PATMI1A1,PATH
          ENDIF
.
          IF        FILENUM = 4
            CLOSE     PMSVX1A1
            OPEN      PMSVX1A1,PATH
          ENDIF
.
          IF        FILENUM = 5
            CLOSE     PRIINVO3
            OPEN      PRIINVO3,PATH
          ENDIF
.
          IF        FILENUM = 6
            CLOSE     PRIDTRA3
            OPEN      PRIDTRA3,PATH
          ENDIF
.
OTRF9999  RETURN
.
.******************************************************************************
.*                                  CKCM0000              Called by: KYDT0000 *
.*                          Check If Casemix Patient                          *
.******************************************************************************
CKCM0000  MATCH     SP9,PMFDCMCD
          GOTO      CKCM9000 IF EQUAL       * Non casemix patient
.         
          PACK      KEY18,PMFDCLTY,PMFDHFUN,PMFDCMCD,SP30
          MOVE      PMFDADAT,CEFFDATE
          CALL      VALCMXFN                * validate casemix funding
          BRANCH    EXIT,CKCM9000
.
          MOVE      ONE,CMXFLG
          GOTO      CKCM9999
.
CKCM9000  MOVE      ZERO,CMXFLG             * Casemix flag - not using casemix
          GOTO      CKCM9999
.
CKCM9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          IF        CFEETYP=5
            MATCH     WBSEHOSP,PTHSHOSP
            GOTO      HSEL0100 IF NOT EQUAL            * Login hospital only
          ELSE
            PACK      KEY13,USERID,SP70                * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,HSEL0100
            ENDIF
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     CHCKHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
+
.------------------------------------------------------------
. * Output Stationery Form Selection
.------------------------------------------------------------
STFORM00  UNPACK    DIM127,D1,D3,D1,D6,DIM127
          PACK      DEFSTCOD,SP70
.
STFORM10  PACK      KEY6,SP70
          CALL      RSIBTH1
STFORM20  CALL      RKIBTH1
          BRANCH    OVRCD,STFORM99
.
          MATCH     "1",IBTHACTV
          GOTO      STFORM20 IF NOT EQUAL
.
          MATCH     D3,IBTHSTYP
          GOTO      STFORM20 IF NOT EQUAL
.
          MATCH     IBTHSCOD,DEFSTCOD       * default stationery code?
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#" selected>":
                               IBTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">",IBTHDESC:
                               "</option>"
          ENDIF
          GOTO      STFORM20
.
STFORM99  RETURN
+
.**********************************************************************
.         Get Default Stationery Code for fees information
.**********************************************************************
GDSCOD00  MATCH     SP70,AFUNDH
          GOTO      GDSCOD20 IF EQUAL
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          BRANCH    OVRCD,GDSCOD20
.
          MATCH     SP70,PTHFDFIC
          GOTO      GDSCOD10 IF EQUAL
.
          WRITE     HTMLFILE;PTHFDFIC;           * use fund code
          GOTO      GDSCOD99
.
GDSCOD10  MATCH     SP70,PTHFHGRP
          GOTO      GDSCOD20 IF EQUAL
.
          PACK      KEY6,PTHFHGRP,SP10
          CALL      RDPAHGP1
          BRANCH    OVRCD,GDSCOD20
.
          MATCH     SP70,PTHGDFIC
          GOTO      GDSCOD20 IF EQUAL
.
          WRITE     HTMLFILE;PTHGDFIC;           * use fund group code
          GOTO      GDSCOD99
.
GDSCOD20  MATCH     SP70,ACLAIM
          GOTO      GDSCOD99 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,GDSCOD99
.
          MATCH     SP70,PTCDDFIC
          GOTO      GDSCOD99 IF EQUAL
.
          WRITE     HTMLFILE;PTCDDFIC;           * use claim code default
GDSCOD99  RETURN
+
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  MATCH     SP70,SETDEFPN[COUNT]
          IF        !@EQUAL
            PACK      KEY20,SETDEFPN[COUNT],WBSEUID,SP70
            GOTO      UPDEFP10
          ENDIF
          GOTO      UPDEFP99
.
UPDEFP10  UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT
          MOVE      SCHDCOPY,IBPDCOP        * no of copies
          MOVE      STATNCOD,IBPDDOC        * save stat code to document code
          MOVE      SP70,IBPDNUM
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
.
.
.------------------------------------------------------------
.  Show Fees Estimate Prosthetic Charge
.------------------------------------------------------------
FESPR000  MOVE      QUOTENUM,KEY12
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            MOVE      "8",KEY1                * Misc Charge Costs
          ELSE
            MOVE      "6",KEY1                * Misc Charge Costs
          ENDIF
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
FESPR100  CALL      RKPMFES2
          BRANCH    OVRCD,FESPR900
.
          MATCH     KEY12,PMFSQUOT
          GOTO      FESPR900 IF NOT EQUAL
.
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            COMPARE   EIGHT,PMFSRTYP          * Misc Charge Costs
            GOTO      FESPR900 IF NOT EQUAL
          ELSE
            COMPARE   SIX,PMFSRTYP            * Misc Charge Costs
            GOTO      FESPR900 IF NOT EQUAL
          ENDIF
.
          MATCH     "Prosthet.",PMFSTHIT
          GOTO      FESPR100 IF NOT EQUAL
.
          MATCH     "1",PTCNIFCL              * HEA layout
          GOTO      FESPR200 IF EQUAL
.
          WRITE     HTMLFILE;PMFSTHEH;
          GOTO      FESPR9999
.
FESPR200  MOVE      SP70,KEY1
          PACK      DIM127,DIM127,SP70
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FESPR210
.
          MOVE      PMFSTHEH,FORM12P2
          SUB       PMFSTHEF,FORM12P2
          WRITE     HTMLFILE;FORM12P2;           * Patient
          GOTO      FESPR999
.
FESPR210  WRITE     HTMLFILE;PMFSTHEF;           * Rebate
          GOTO      FESPR999
.
FESPR900  MATCH     "1",PTCNIFCL              * HEA layout
          IF        @EQUAL
            UNPACK    DIM127,D1,KEY1,DIM127
          ENDIF
FESPR999  RETURN
.
.------------------------------------------------------------
.  Show Fees Estimate Pharmacy Charge
.------------------------------------------------------------
FESPH000  MOVE      QUOTENUM,KEY12
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            MOVE      "8",KEY1                * Misc Charge Costs
          ELSE
            MOVE      "6",KEY1                * Misc Charge Costs
          ENDIF
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
FESPH100  CALL      RKPMFES2
          BRANCH    OVRCD,FESPH900
.
          MATCH     KEY12,PMFSQUOT
          GOTO      FESPH900 IF NOT EQUAL
.
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            COMPARE   EIGHT,PMFSRTYP          * Misc Charge Costs
            GOTO      FESPH900 IF NOT EQUAL
          ELSE
            COMPARE   SIX,PMFSRTYP            * Misc Charge Costs
            GOTO      FESPH900 IF NOT EQUAL
          ENDIF
.
          MATCH     "Pharmacy ",PMFSTHIT
          GOTO      FESPH100 IF NOT EQUAL
.
          MATCH     "1",PTCNIFCL              * HEA layout
          GOTO      FESPH200 IF EQUAL
.
          WRITE     HTMLFILE;PMFSTHEH;
          GOTO      FESPH999
.
FESPH200  MOVE      SP70,KEY1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FESPH210
.
          MOVE      PMFSTHEH,FORM12P2
          SUB       PMFSTHEF,FORM12P2
          WRITE     HTMLFILE;FORM12P2;           * Patient
          GOTO      FESPH999
.
FESPH210  WRITE     HTMLFILE;PMFSTHEF;           * Rebate
          GOTO      FESPH999
.
FESPH900  MATCH     "1",PTCNIFCL              * HEA layout
          IF        @EQUAL
            UNPACK    DIM127,D1,KEY1,DIM127
          ENDIF
FESPH999  RETURN
+
.------------------------------------------------------------
.  Show Fees Estimate Consumables
.------------------------------------------------------------
FESCN000  MOVE      QUOTENUM,KEY12
          MOVE      "8",KEY1                * Misc Charge Costs
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
FESCN100  CALL      RKPMFES2
          BRANCH    OVRCD,FESCN900
.
          MATCH     KEY12,PMFSQUOT
          GOTO      FESCN900 IF NOT EQUAL
.
          COMPARE   EIGHT,PMFSRTYP          * Misc Charge Costs
          GOTO      FESCN900 IF NOT EQUAL
.
          MATCH     "2",PTCNIFCL              * SJOG using IFC layout
          IF        @EQUAL
            MATCH     "Consumab.",PMFSTHIT
            GOTO      FESCN100 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",PTCNIFCL              * HEA layout
          GOTO      FESCN200 IF EQUAL
.
          WRITE     HTMLFILE;PMFSTHEH;
          GOTO      FESCN999
.
FESCN200  MOVE      SP70,KEY1
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FESCN210
.
          MOVE      PMFSTHEH,FORM12P2
          SUB       PMFSTHEF,FORM12P2
          WRITE     HTMLFILE;FORM12P2;           * Patient
          GOTO      FESCN999
.
FESCN210  WRITE     HTMLFILE;PMFSTHEF;           * Rebate
          GOTO      FESCN999
.
FESCN900  MATCH     "1",PTCNIFCL              * HEA layout
          IF        @EQUAL
            UNPACK    DIM127,D1,KEY1,DIM127
          ENDIF
FESCN999  RETURN
+
.-------------------------------------------------------------------
.  Show Fees Estimate Discount (currently on HEA Fees Estimate only)
.-------------------------------------------------------------------
FDISC000  MOVE      QUOTENUM,KEY12
          MOVE      "9",KEY1
          PACK      KEY18,QUOTENUM,KEY1,SP70
          CALL      RSPMFES2
FDISC100  CALL      RKPMFES2
          BRANCH    OVRCD,FDISC999
.
          MATCH     KEY12,PMFSQUOT
          GOTO      FDISC999 IF NOT EQUAL
.
          COMPARE   NINE,PMFSRTYP                * Discount record
          GOTO      FDISC999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMFSTHEH;           * Patient
.
FDISC999  RETURN
+
.****************************************************************************
.*                             PTRK0000            Called by: PRCI0000      *
.*      A credit note has been posted against an item, so check if it is    *
.*      a prosthetic tracking item, and if so, write a change record to     *
.*      the prosthetic tracking detail table (pmsptdaf).                    *
.* Requires:  Valid read on admission record (ACLAIM, AFUNDH, AFNDTB)       *
.*            Valid write of a record to pmsfciaf                           *
.*            PROSFLAG - prosthetic flag A-Add, C-Change, D-Delete          *
.****************************************************************************
.
PTRK0000  MATCH     "1",PTCNTRPR                 * using prosthetics tracking ?
          GOTO      PTRK9999 IF NOT EQUAL        * no - finished
.
.
.         Look for a matching record in patmchgf for the item code using
.         the following criteria:
.            1. claim code, health fund/table, item code
.            2. claim code, blank health fund/table, item code
.            3. zero claim code, blank health fund/table, item code
.
.                                           * Read Misc. Charges file
          CALL      GTAB0000                * Change "H/F Table" to "Table Type"

          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,PMFCITEM,PMFCTDAT,SP10
          CALL      PATMCHRD                * find Miscellaneous Charge Item
          IF        EXIT = 1
            PACK      KEY29,ACLAIM,SP6,SP3,PMFCITEM,PMFCTDAT,SP10
            CALL      PATMCHRD              * find Miscellaneous Charge Item
            IF        EXIT = 1
              CALL      DCLM0000            * set Hospital default
              PACK      KEY29,PTCNDCLM,SP6,SP3,PMFCITEM,PMFCTDAT,SP10
              CALL      PATMCHRD            * find Miscellaneous Charge Item
              BRANCH    EXIT,PTRK9999       * not found or invalid
            ENDIF
          ENDIF
.
PTRK1200  MATCH     "1",PTMCPRTR                 * tracking prosthetic ?
          GOTO      PTRK9999 IF NOT EQUAL        * no
.
.         The item was a valid tracking prosthetic item, so we need to
.         check if this is a change (credit item), a delete (credit all) or
.         an add (keep item after credit all).
.
          MATCH     ANSD,PROSFLAG                * credit all ?
          IF        @EQUAL
            ASSIGN    (PMFCCAMT*SEQ),PMPEAMTT    * yes - change sign on amount
            GOTO      PTRK2500
          ENDIF
.
          MATCH     ANSA,PROSFLAG                * keep item ?
          IF        @EQUAL
            CALL      CLPMSPTD                   * yes - load pmsptdaf variables
            MOVE      PMMIVISN,PMPEVISN
            MOVE      PMMITRAN,PMPETRAN
            MOVE      PMMIITEM,PMPEITEM
            MOVE      PMMIURNO,PMPEURNO
            MOVE      PROSFLAG,PMPETRTY
            MOVE      PMMIDESC,PMPEIDES
            MOVE      PMMISERV,PMPESERV
            MOVE      PMMITDAT,PMPETDAT
            MOVE      PMMIAMTT,PMPEAMTT
            MOVE      PMMIAMTP,PMPEAMTP
            MOVE      PMMIRBAT,PMPERBAT
            MOVE      PMMIGSTC,PMPEGSTC
            MOVE      PMMIWUSR,PMPEWUSR
            GOTO      PTRK3000
          ENDIF
.
.         This was a credit item, so we need to save the
.         credit note amount, then loop back through the pmsptdaf table to
.         get the last Add or Change record, for the same transaction, which
.         will contain the last charge amount for the item.  Then add the last
.         charge amount to the credit note amount (which is negative), to get
.         the new charge amount before writing a pmsptdaf record.
.         The reason for doing this is that when processing a Change record, the
.         prosthetic extract progam gets the last record for the item, writes
.         a negative anmount record to cancel that charge out totally, before
.         then writing a new record with the new charge amount in it.
.
          MOVE      PMFCCAMT,SVCRAMNT            * save credit note amount
.
          PACK      KEY30,PMFCVISN,TILDA30
          CALL      RSPMPTD2                     * position on visit/transaction
PTRK2000  CALL      RPPMPTD2                     * read previous record
          BRANCH    OVRCD,PTRK9999               * eof - finish (not good)
.
          MATCH     PMFCVISN,PMPEVISN            * same visit still ?
          GOTO      PTRK9999 IF NOT EQUAL        * no - finish (not good)
.
          MATCH     PMFCTRAN,PMPEDTRN            * same transaction ?
          GOTO      PTRK2000 IF NOT EQUAL        * no - finish (not good)
.
          MATCH     PMFCITEM,PMPEITEM            * same item ?
          GOTO      PTRK2000 IF NOT EQUAL        * no - finish (not good)
.
          MATCH     ANSD,PMPETRTY                * delete record ?
          GOTO      PTRK9999 IF EQUAL            * no - finish (not good)
.
          ADD       SVCRAMNT,PMPEAMTT            * get new item charge amount
.
.         Write a prosthetic tracking detail record
.
PTRK2500  MOVE      PMFCVISN,PMPEVISN
          MOVE      PMFCTRAN,PMPETRAN
          MOVE      PMFCITEM,PMPEITEM
          MOVE      PVIURNO,PMPEURNO
          MOVE      PROSFLAG,PMPETRTY
          MOVE      PMFCDESC,PMPEIDES
          MOVE      PMFCSERV,PMPESERV
          MOVE      PMFCTDAT,PMPETDAT
          MOVE      PMFCAMTP,PMPEAMTP
          MOVE      PMFCRBAT,PMPERBAT
          MOVE      PMFCGSTC,PMPEGSTC
          MOVE      ZERO,PMPEGSTM
          MOVE      PMFCWUSR,PMPEWUSR
          MOVE      SP30,PMPEEXFN
          MOVE      SP8,PMPEDTEX
          MOVE      SP8,PMPETMEX
          MOVE      PMFCTRAN,PMPEDTRN
          MOVE      SP20,PMPESPAR
.
PTRK3000  CALL      IBACLOCK
          PACK      PMPETRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMPETRDT
          MOVE      CTIMEIS,PMPETRTM
          REP       " 0",PMPETRTM
.
          PACK      KEY30,PMPETRDT,PMPETRTM,PMPEVISN,PMPETRAN
          CALL      RAPMPTD1
          IF        OVRCD = 1
            CALL      WRPMPTD1                   * write record
          ELSE
            GOTO      PTRK3000                   * wait for time to increment
          ENDIF
.
PTRK9999  RETURN
+
.---------------------------------------------------------------------------
. Patient Details from master file to display in table c
.   Requires ADMISSNO & URNUMBER to be set.
.   URNUMBER can be blank if a Valid Admission Record is Expected.
.---------------------------------------------------------------------------
GETPAT00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      AURNO,URNUMBER
          ENDIF
          MOVE      OVRCD,MISSFLAG
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPRAM1
            BRANCH    OVRCD,GETPAT95
          ELSE
            PACK      KEY8,URNUMBER
            CALL      RDMAST1
            BRANCH    OVRCD,GETPAT95
          ENDIF
.
          CALL      PATINT00                * Format Patient Name with Initial
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            PACK      SDOCFNAM,DOCFNAME
...         CALL      SDOCNM00
          ENDIF
.
GETPAT10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWOEDAT
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            GOTO      GETPAT20
          ENDIF
.
          MOVE      CCC,CCENT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
. Find if expected disch date is =,<, or > current date and set bgcolor flag
.
GETPAT20  MOVE      SP70,COLRFLAG
          PACK      EXPCDATE,CCENT,CYEAR,CMON,CDAY
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,EXPCDATE
          IF        @EQUAL
            MOVE      "CurrDischDate",COLRFLAG        * Set bgcolor to Current
          ENDIF
          IF        @LESS
            MOVE      "PastDischDate",COLRFLAG          * set bgcolor to past
          ENDIF
.
          PACK      KEY3,SP70
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
          BRANCH    OVRCD,GETPAT95
.
          MOVE      ADMISSNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXVALW
            MOVE      SP70,PMVXPALW
            MOVE      SP70,PMVXUDF2
            MOVE      SP70,PMVXMHOS
          ENDIF
.
          GOTO      GETPAT99
.
GETPAT95  MOVE      "Invalid Record",PSNAME
          MOVE      SP70,PGNAME
          MOVE      SP70,PTITL
          CALL      PATNAM00
.
GETPAT99  RETURN
.------------------------------------------------------------
. Format Patient Name in Title Text
.------------------------------------------------------------
PATNAC00  CLEAR     DIM80
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    PSNAME,DIM80
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          PACK      NAME35,PSNAME,SP70
          APPEND    SP70,DIM80
          RESET     DIM80
          MOVE      DIM80,PATFNAME
          STRIP     PATFNAME
          RETURN
.
.------------------------------------------------------------------------
. Format Patient Name with Second Name Initial
.------------------------------------------------------------------------
PATINT00  CLEAR     DISPNAME
          MOVE      PSNAME,SAVPSNAM
.
..        REP       "' ",PSNAME
          REP       "#" ",PSNAME
..        REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<b>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
.
          MOVELPTR  PGNAME,LENPTR
          MOVE      ONE,COUNT
PATINT10  BUMP      PGNAME
          GOTO      PATINT99 IF EOS
          ADD       ONE,COUNT
          MATCH     SP1,PGNAME
          GOTO      PATINT10 IF NOT EQUAL
          BUMP      PGNAME
          ADD       ONE,COUNT
          RESET     PGNAME
          SETLPTR   PGNAME,COUNT
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          RESET     PGNAME,LENPTR
          RESET     PGNAME
.
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
.
          MOVE      SAVPSNAM,PSNAME         * Original value with quotes etc
.
PATINT99  RETURN
.
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after input journal
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM102
          MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MATCH     SAVURNUM,RCDTURNO       * Same U/R number ?
          GOTO      CREC1000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM102       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM102,FORM12P2      * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999
.
          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
RECN0000  PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      WBSEUID,PTURCUID        * WEB user id
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      PINVPATA,PTURPAYM    * Patient payments +
          ADD       PINVHFDA,PTURPAYM    * H.F payments +
          ADD       PINVOTHA,PTURPAYM    * Other payments +
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      WBSEUID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      WBSEUID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.------------------------------------------------------------------------------
.         Get last Eclipse batch record from pmsect
.------------------------------------------------------------------------------
ECLB0000  OPEN      PMSECTA2,"pmsectaf"
          PACK      KEY16,PINVNO,SP70
          CALL      RDPMECT2
          COMPARE   ZERO,OVRCD
          GOTO      ECLB2000 IF EQUAL
.
ECLB1000  PACK      KEY16,PINVNO,Z70
          CALL      RSPMECT2
          CALL      RPPMECT2
          BRANCH    OVRCD,ECLB9999
.
          MATCH     PMECINVN,PINVNO         * same invoice?
          GOTO      ECLB9999 IF NOT EQUAL
.
ECLB2000  PACK      PMECURNO,PMECURNO,SP70
          PACK      PMECADMN,PMECADMN,SP70
          PACK      PMECINVN,PMECINVN,SP70
          PACK      PMECBATN,PMECBATN,SP70
.
          WRITE     HTMLFILE;PMECURNO,PMECADMN,PMECINVN,PMECBATN;
.
ECLB9999  RETURN
+
. Indicator for Eclipse
.------------------------------------------------------------
ECLIND00  MOVE      ZERO,DIM1
.
          COMPARE   ONE,PTCNUEDI
          GOTO      ECLIND90 IF NOT EQUAL
.
          MATCH     SP70,ACLAIM
          GOTO      ECLIND50 IF EQUAL
          GOTO      ECLIND50 IF EOS
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ECLIND50
.
          MOVE      ZERO,FORM1
          WHILE     FORM1 < 5
            ADD       ONE,FORM1
            LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
            MATCH     ANSV,ANS                   * DVA code ?
            IF        @EQUAL
              PACK      KEY3,ANSD,ANSV,ANSA,SP70
              CALL      RDPTPAR1
              BRANCH    OVRCD,ECLIND90
.
              MOVE      ONE,DIM1
              GOTO      ECLIND90                 * yes
            ENDIF
          DO
.
ECLIND50  MATCH     SP70,AFUNDH
          GOTO      ECLIND90 IF EQUAL
          GOTO      ECLIND90 IF EOS
.
          PACK      KEY6,AFUNDH,SP70
          CALL      RDPTFX11
          BRANCH    OVRCD,ECLIND90
.
          IF        PTFXEXTR=THREE
            MOVE      ONE,DIM1
          ENDIF
.
ECLIND90  WRITE     HTMLFILE;DIM1;
ECLIND99  RETURN
.

.------------------------------------------------------------------------------
.         Get last Eclipse batch record from priect
.------------------------------------------------------------------------------
ECLM0000  MATCH     "1",PTCNUIMC
          GOTO      ECLM9999 IF NOT EQUAL
.
          OPEN      PRIECTA2,"priectaf"
          PACK      KEY16,PRINNUMB,SP70
          CALL      RDPRECT2
          COMPARE   ZERO,OVRCD
          GOTO      ECLM2000 IF EQUAL
.
ECLM1000  PACK      KEY16,PRINNUMB,Z70
          CALL      RSPRECT2
          CALL      RPPRECT2
          BRANCH    OVRCD,ECLM9999
.
          MATCH     PRECINVN,PRINNUMB         * same invoice?
          GOTO      ECLM9999 IF NOT EQUAL
.
ECLM2000  PACK      PRECURNO,PRECURNO,SP70
          PACK      PRECUNIQ,PRECUNIQ,SP70
          PACK      PRECINVN,PRECINVN,SP70
          PACK      PRECBATN,PRECBATN,SP70
.
          WRITE     HTMLFILE;PRECURNO,PRECUNIQ,PRECINVN,PRECBATN;
.
ECLM9999  RETURN
+
.------------------------------------------------------------------------------
.         Get Referral Override
.------------------------------------------------------------------------------
GROVR000  OPEN      PRIDTRA4,"pridtraf"          * debtor transaction file
.
          MOVE      SP70,SAVEROVR
          MOVE      INVOICEN, FORM8
          PACK      KEY22,FORM8,SP30
          CALL      RSPRDT4                      * position before invoice
GROVR600  CALL      RKPRDT4                      * read next record
          BRANCH    OVRCD,GROVR999
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          MATCH     DIM8,PRDTINVN                * same invoice still ?
          GOTO      GROVR999 IF NOT EQUAL        * no - finished
.
          COMPARE   ONE,PRDTRTYP                 * item record ?
          GOTO      GROVR600 IF NOT EQUAL        * no - ignore record
.
          COMPARE   TWO,PRDTIFLG
          GOTO      GROVR600 IF NOT EQUAL
.
          MOVE      PRDTROVR,SAVEROVR
.
GROVR999  RETURN
.------------------------------------------------------------------------------
.         Get  Linked Visit Number
.------------------------------------------------------------------------------
GLVIS000  OPEN      PRIDTRA4,"pridtraf"          * debtor transaction file
.
          MOVE      SP70,SAVELVIS
          MOVE      INVOICEN, FORM8
          PACK      KEY22,FORM8,SP30
          CALL      RSPRDT4                      * position before invoice
GLVIS600  CALL      RKPRDT4                      * read next record
          BRANCH    OVRCD,GLVIS999
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          MATCH     DIM8,PRDTINVN                * same invoice still ?
          GOTO      GLVIS999 IF NOT EQUAL        * no - finished
.
          COMPARE   ONE,PRDTRTYP                 * item record ?
          GOTO      GLVIS600 IF NOT EQUAL        * no - ignore record
.
          COMPARE   TWO,PRDTIFLG
          GOTO      GLVIS600 IF NOT EQUAL
.
          MOVE      PRDTLVIS,SAVELVIS
.
GLVIS999  RETURN
.------------------------------------------------------------------------------
.         Validate if IMC has been recieved at Medicare Hub
.------------------------------------------------------------------------------
IMCRCV00  MATCH     "1",PTCNUIMC
          GOTO      IMCRCV99 IF NOT EQUAL
.
          OPEN      PRIECTA2,"priectaf"
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
.
          PACK      KEY16,KEY8,SP70
          CALL      RDPRECT2
          BRANCH    OVRCD,IMCRCV99
.
          PACK      KEY16,KEY8,SP70
          CALL      RSPRECT2
IMCRCV10  CALL      RKPRECT2
          BRANCH    OVRCD,IMCRCV99
.
          MATCH     KEY8,PRECINVN
          GOTO      IMCRCV99 IF NOT EQUAL
.
          COMPARE   FOUR,PRECFLAG
          GOTO      IMCRCV10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
IMCRCV99  RETURN
.------------------------------------------------------------------------------
.         Get last Eclipse batch record from emrect
.------------------------------------------------------------------------------
ESTF0000  MATCH     "1",PTCNUESF
          GOTO      ESTF9999 IF NOT EQUAL
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY8
.
          IF        VISITTYP=ONE
            MOVE      "1",KEY1
            MOVE      PINVNO,KEY8
            GOTO      ESTF0500
          ENDIF
.
          IF        VISITTYP=FOUR
            MOVE      "2",KEY1
            MOVE      PRINNUMB,KEY8
            GOTO      ESTF0500
          ENDIF
.
          GOTO      ESTF9999
.
ESTF0500  OPEN      EMRECTA2,"emrectaf"
          PACK      KEY17,KEY8,SP8,KEY1,SP70
          CALL      RDEMECT2
          COMPARE   ZERO,OVRCD
          GOTO      ESTF2000 IF EQUAL
.
ESTF1000  PACK      KEY17,KEY8,Z70
          CALL      RSEMECT2
          CALL      RPEMECT2
          BRANCH    OVRCD,ESTF9999
.
          MATCH     EMECINVN,KEY8           * same invoice?
          GOTO      ESTF9999 IF NOT EQUAL
.
          MATCH     EMECMODL,KEY1
          GOTO      ESTF1000 IF NOT EQUAL
.
ESTF2000  PACK      EMECURNO,EMECURNO,SP70
          PACK      EMECUNIQ,EMECUNIQ,SP70
          PACK      EMECINVN,EMECINVN,SP70
          PACK      EMECBATN,EMECBATN,SP70
          PACK      EMECMODL,EMECMODL,SP70
.
          WRITE     HTMLFILE;EMECURNO,EMECUNIQ,EMECINVN,EMECBATN,EMECMODL;
.
ESTF9999  RETURN
+
.------------------------------------------------------------------------------
.         Get last Eclipse batch record from outect
.------------------------------------------------------------------------------
ECBB0000  MATCH     "1",PTCNUEBB
          GOTO      ECBB9999 IF NOT EQUAL
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY8
.
.-------- Emergency visit
          IF        VISITTYP=ONE
            MOVE      "1",KEY1
            MOVE      PINVNO,KEY8
            GOTO      ECBB0500
          ENDIF
.
.-------- Private Practice visit
          IF        VISITTYP=FOUR
            MOVE      "2",KEY1
            MOVE      PRINNUMB,KEY8
            GOTO      ECBB0500
          ENDIF
.
.-------- Outpatient visit
          IF        VISITTYP=TWO
            MOVE      "3",KEY1
            MOVE      PINVNO,KEY8
            GOTO      ECBB0500
          ENDIF
. 
          GOTO      ECBB9999
.
ECBB0500  OPEN      OUTECTA2,"outectaf"
          PACK      KEY17,KEY8,SP8,KEY1,SP70
          CALL      RDOTECT2
          COMPARE   ZERO,OVRCD
          GOTO      ECBB2000 IF EQUAL
.
ECBB1000  PACK      KEY17,KEY8,Z70
          CALL      RSOTECT2
          CALL      RPOTECT2
          BRANCH    OVRCD,ECBB9999
.
          MATCH     OTECINVN,KEY8           * same invoice?
          GOTO      ECBB9999 IF NOT EQUAL
.
          MATCH     OTECMODL,KEY1
          GOTO      ECBB1000 IF NOT EQUAL
.
ECBB2000  PACK      OTECURNO,OTECURNO,SP70
          PACK      OTECUNIQ,OTECUNIQ,SP70
          PACK      OTECINVN,OTECINVN,SP70
          PACK      OTECBATN,OTECBATN,SP70
          PACK      OTECMODL,OTECMODL,SP70
.
          WRITE     HTMLFILE;OTECURNO,OTECUNIQ,OTECINVN,OTECBATN,OTECMODL;
.
ECBB9999  RETURN
+
.------------------------------------------------------------
. New Correspondenance Item
.------------------------------------------------------------
NEWCOR00  PACK      CORSP001,SPLFILE,CORSPPRT,SP70
          PACK      CORSP002,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CORSP002
          CLOCK     TIME,CTIMEIS
          PACK      CORSP004,CTIMEIS
.
          PACK      KEY8,ADMISSNO           * validate admissno
          MOVE      ADMISSNO,SAVVISIT
          MATCH     SP70,ADMISSNO
          IF        @EQUAL|@EOS
            MOVE      "00000000",SAVVISIT
          ENDIF
.
NEWCOR20  PACK      KEY8,URNUMBER         * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
.
          MOVE      ONE,CORRESID
          PACK      KEY20,URNUMBER,SAVVISIT,Z70
          CALL      RSOBPC1
          CALL      RPOBPC1              * Positions on last value
          BRANCH    OVRCD,NEWCOR50
          MATCH     URNUMBER,OBPCURNO
          GOTO      NEWCOR50 IF NOT EQUAL
          MATCH     SAVVISIT,OBPCCVIS
          GOTO      NEWCOR50 IF NOT EQUAL
          MOVE      OBPCCPID,CORRESID
          ADD       ONE,CORRESID
.
NEWCOR50  MOVE      CORRESID,OBPCCPID       * Correspondance ID
          MOVE      SAVVISIT,OBPCCVIS
          MOVE      URNUMBER,OBPCURNO
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD * Last update date
          REP       " 0",OBPCDTLU
          MOVE      CTIMEIS,OBPCTMLU        * Last Update time
.
          MOVE      WBSEUID,OBPCINUS        * Web User ID
          MOVE      WBSEUID,OBPCLUID        * Last Web User ID
          MOVE      ZERO,OBPCMDEL           * Delete indicator not set
.
          MATCH     SP70,CORSP001
          IF        @EQUAL
            CLOSE     TEMPFILE
            CLEAR     CORSP001
            APPEND    TEMPNAME,CORSP001
            APPEND    ".html",CORSP001
            RESET     CORSP001
          ENDIF
.
          SCAN      ".",CORSP001
          MOVE      CORSP001,OBPCFEXT
          RESET     CORSP001
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CORSFILE
          REP       " 0",CORSFILE
.
          READ      CONTROLF,NINTY1;*219,CWEBCLOC
          PACK      KEY4,CWEBCLOC
          CALL      RDOBPT1
          BRANCH    OVRCD,NEWCOR91
.
          MOVE      OBPTSLID,OBPCSLID       * Storage Location ID
          STRIP     OBPTSDIR
          GETENV    TBSPOOL,KEY80
          STRIP     KEY80
          STRIP     CORSP001
          PACK      CMDLINE,CMDFCHK,USERID,SP1,KEY80,SLASH,CORSP001,SP1,CORSFILE
          EXECUTE   CMDLINE,TASKID
          PACK      CMDLINE,CMDMOVE,KEY80,SLASH,CORSP001,SP1,OBPTSDIR,CORSFILE
          EXECUTE   CMDLINE,TASKID
.
          MOVE      CORSP002,OBPCINDT       * Input date
          REP       " 0",OBPCINDT
          MOVE      CORSP004,OBPCINTM       * Input time
          CALL      GETCTY00               * get type of correspondence
          MOVE      SP70,OBPCSLEV       * Security Level
          MOVE      SP70,OBPCCOM1       * Comment 1
          MOVE      SP70,OBPCCOM2       * Comment 2
          MOVE      SP70,OBPCCFRM       * From
          MOVE      SP70,OBPCCTOO       * To
          MOVE      SP70,OBPCUDF1       * User Def Code 1
          MOVE      SP70,OBPCUDF2       * User Def Code 2
          MOVE      SP70,OBPCUYN1       * User Def Y/N 1
          MOVE      SP70,OBPCUYN2       * User Def Y/N 2
          MOVE      SP70,OBPCUDD1       * User Def Date 1
          MOVE      SP70,OBPCUDD2       * User Def Date 2
          MOVE      SP70,OBPCACAT  *   Alert Category
          MOVE      SP70,OBPCACOD  *   Alert Code
          MOVE      SP70,OBPCCNTR  *   Alert Counter
.
          MOVE      SAVVISIT,OBPCCVIS
NEWCOR80  PACK      KEY12,OBPCCVIS,OBPCCPID
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROBPC1
          TRAPCLR   IO
          IF        OVRCD=1
            ADD       ONE,CORRESID
            MOVE      CORRESID,OBPCCPID     * Correspondance ID
            GOTO      NEWCOR80
          ENDIF
.
          PACK      KEY8,URNUMBER           * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
          MATCH     "1",PTMXSIN4
          IF        !@EQUAL
            PACK      KEY8,URNUMBER         * validate UR
            CALL      RLPTMAS1
            BRANCH    OVRCD,NEWCOR90,NEWCOR96
            MOVE      "1",PTMXSIN4
            CALL      UPMAST1
            CALL      UUPTMAS1
          ENDIF
          GOTO      NEWCOR99
.
NEWCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR93  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR94  MOVE      "Invalid File - ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR95  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No for UR - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR96  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR99  RETURN
+
.------------------------------------------------------------
. Get correspondence type - Category wi indicator 1=R Reprinted Invoice
.------------------------------------------------------------
GETCTY00  MOVE      "wi",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
GETCTY10  CALL      RDKCODE1
          BRANCH    OVRCD,GETCTY90
.
          MATCH     CATEGORY,TCODE
          GOTO      GETCTY90 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      GETCTY10 IF EQUAL
.
          MATCH     ANSR,TCINDC1
          GOTO      GETCTY10 IF NOT EQUAL
          PACK      OBPCCTYP,ACODE
          GOTO      GETCTY99
.
GETCTY90  MOVE      SP70,OBPCCTYP
.
GETCTY99  RETURN
+
.-----------------------------------------------------------------------------
. Format PRFA Name as is - same as namstr but without formatting case
.-----------------------------------------------------------------------------
NAMASX00  RESET     NAME80
          GOTO      NAMASX99 IF EOS
.
NAMASX10  CMATCH    SP1,NAME80               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME80
            GOTO      NAMASX10 IF NOT EOS
            GOTO      NAMASX99               * entire name if blank
          ENDIF
          PACK      KEY85,NAME80,SP30        * reset form pointer
          MOVE      KEY85,NAME80
.
          SCAN      SP1,NAME80             * Locate the blank
          GOTO      NAMASX20 IF NOT EQUAL
          BUMP      NAME80,-1              * go back 1 to end of name
          MOVEFPTR  NAME80,CCITEM          * another handly form field
          RESET     NAME80                 * reset the form pointer
          SETLPTR   NAME80,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME80,KEY1,KEY79
.....     REP       DOWNCASE,KEY79
          APPEND    KEY1,DIM80
          STRIP     KEY79
          APPEND    KEY79,DIM80
          APPEND    SP1,DIM80
.
.         Check for any more names
.
          SETLPTR   NAME80,80              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME80,CCITEM          * reset to this point
          PACK      KEY85,NAME80,SP70      * reset form pointer
          MOVE      KEY85,NAME80
          GOTO      NAMASX10
.
.         Rest of the string is one name
.
NAMASX20  UNPACK    NAME80,KEY1,KEY79
.....     REP       DOWNCASE,KEY79
          APPEND    KEY1,DIM80
          STRIP     KEY79
          APPEND    KEY79,DIM80
          APPEND    SP1,DIM80
.
NAMASX99  RETURN
+
.------------------------------------------------------------------------------
.         Yes/No option
.------------------------------------------------------------------------------
DNOYES00  MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ZERO,">":
                               "No</option>":
                               "<option value=",ONE," selected>":
                               "Yes</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ZERO," selected>":
                               "No</option>":
                               "<option value=",ONE,">":
                               "Yes</option>"
          ENDIF
DNOYES99  RETURN
+
.------------------------------------------------------------------------------
.         Get last WebServices IMCW batch record from webimc
.------------------------------------------------------------------------------
WBSM0000  MATCH     "1",PTCNWSIN
          GOTO      WBSM9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      WBSM9999 IF NOT EQUAL
.
          OPEN      WEBIMCA2,"webimcaf"
          PACK      KEY16,PRINNUMB,SP70
          CALL      RDWBIMC2
          COMPARE   ZERO,OVRCD
          GOTO      WBSM2000 IF EQUAL
.
WBSM1000  PACK      KEY16,PRINNUMB,Z70
          CALL      RSWBIMC2
          CALL      RPWBIMC2
          BRANCH    OVRCD,WBSM9999
.
          MATCH     WBIMINVN,PRINNUMB         * same invoice?
          GOTO      WBSM9999 IF NOT EQUAL
.
WBSM2000  PACK      WBIMURNO,WBIMURNO,SP70
          PACK      WBIMUNIQ,WBIMUNIQ,SP70
          PACK      WBIMINVN,WBIMINVN,SP70
          PACK      WBIMBATN,WBIMBATN,SP70
.
          WRITE     HTMLFILE;WBIMURNO,WBIMUNIQ,WBIMINVN,WBIMBATN;
.
WBSM9999  RETURN
+
.------------------------------------------------------------------------------
.         Validate if IMCW has been recieved at Medicare Hub
.------------------------------------------------------------------------------
IMWRCV00  MATCH     "1",PTCNWSIN
          GOTO      IMWRCV99 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      IMWRCV99 IF NOT EQUAL
.
          OPEN      WEBIMCA2,"webimcaf"
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
.
          PACK      KEY16,KEY8,SP70
          CALL      RDWBIMC2
          BRANCH    OVRCD,IMWRCV99
.
          PACK      KEY16,KEY8,SP70
          CALL      RSWBIMC2
IMWRCV10  CALL      RKWBIMC2
          BRANCH    OVRCD,IMWRCV99
.
          MATCH     KEY8,WBIMINVN
          GOTO      IMWRCV99 IF NOT EQUAL
.
          COMPARE   FOUR,WBIMFLAG
          GOTO      IMWRCV10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
IMWRCV99  RETURN
+
.------------------------------------------------------------------------------
.         Get last WebServices IHCW batch record from webihc
.------------------------------------------------------------------------------
WBSH0000  MATCH     "1",PTCNWSIN
          GOTO      WBSH9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIHCW
          GOTO      WBSH9999 IF NOT EQUAL
.
          OPEN      WEBIHCA2,"webihcaf"
          PACK      KEY16,PINVNO,SP70
          CALL      RDWBIHC2
          COMPARE   ZERO,OVRCD
          GOTO      WBSH2000 IF EQUAL
.
WBSH1000  PACK      KEY16,PINVNO,Z70
          CALL      RSWBIHC2
          CALL      RPWBIHC2
          BRANCH    OVRCD,WBSH9999
.
          MATCH     WBICINVN,PINVNO        * same invoice?
          GOTO      WBSH9999 IF NOT EQUAL
.
WBSH2000  PACK      WBICURNO,WBICURNO,SP70
          PACK      WBICADMN,WBICADMN,SP70
          PACK      WBICINVN,WBICINVN,SP70
          PACK      WBICBATN,WBICBATN,SP70
.
          WRITE     HTMLFILE;WBICURNO,WBICADMN,WBICINVN,WBICBATN;
.
WBSH9999  RETURN
+
.------------------------------------------------------------------------------
.         Validate if IHCW has been recieved at Medicare Hub
.------------------------------------------------------------------------------
IHWRCV00  MATCH     "1",PTCNWSIN
          GOTO      IHWRCV99 IF NOT EQUAL
.
          MATCH     "1",PTCNIHCW
          GOTO      IHWRCV99 IF NOT EQUAL
.
          OPEN      WEBIHCA2,"webihcaf"
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
.
          PACK      KEY16,KEY8,SP70
          CALL      RDWBIHC2
          BRANCH    OVRCD,IHWRCV99
.
          PACK      KEY16,KEY8,SP70
          CALL      RSWBIHC2
IHWRCV10  CALL      RKWBIHC2
          BRANCH    OVRCD,IHWRCV99
.
          MATCH     KEY8,WBICINVN
          GOTO      IHWRCV99 IF NOT EQUAL
.
          COMPARE   FOUR,WBICFLAG
          GOTO      IHWRCV10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
IHWRCV99  RETURN
+
.------------------------------------------------------------------------------
.         Get last PCIW batch record from webpci
.------------------------------------------------------------------------------
PCWRCV00  MATCH     "1",PTCNWSIN
          GOTO      PCWRCV99 IF NOT EQUAL
.
          MATCH     "1",PTCNPCIW
          GOTO      PCWRCV99 IF NOT EQUAL
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY8
.
          IF        VISITTYP=ONE
            MOVE      "1",KEY1
            MOVE      PINVNO,KEY8
            GOTO      PCWRCV05
          ENDIF
.
          IF        VISITTYP=FOUR
            MOVE      "2",KEY1
            MOVE      PRINNUMB,KEY8
            GOTO      PCWRCV05
          ENDIF
.
          GOTO      PCWRCV99
.
PCWRCV05  OPEN      WEBPCIA2,"webpciaf"
          PACK      KEY17,KEY8,SP8,KEY1,SP70
          CALL      RDWBPCI2
          COMPARE   ZERO,OVRCD
          GOTO      PCWRCV20 IF EQUAL
.
PCWRCV10  PACK      KEY17,KEY8,Z70
          CALL      RSWBPCI2
          CALL      RPWBPCI2
          BRANCH    OVRCD,PCWRCV99
.UPTOHERE
          MATCH     WBPIINVN,KEY8           * same invoice?
          GOTO      PCWRCV99 IF NOT EQUAL
.
          MATCH     WBPIMODL,KEY1
          GOTO      PCWRCV10 IF NOT EQUAL
.
PCWRCV20  PACK      WBPIURNO,WBPIURNO,SP70
          PACK      WBPIUNIQ,WBPIUNIQ,SP70
          PACK      WBPIINVN,WBPIINVN,SP70
          PACK      WBPIBATN,WBPIBATN,SP70
          PACK      WBPIMODL,WBPIMODL,SP70
.
          WRITE     HTMLFILE;WBPIURNO,WBPIUNIQ,WBPIINVN,WBPIBATN,WBPIMODL;
.
PCWRCV99  RETURN
+
.------------------------------------------------------------------------------
.         Get last WebServices batch record from webbbs
.------------------------------------------------------------------------------
WBSB0000  MATCH     "1",PTCNWSIN
          GOTO      WBSB9999 IF NOT EQUAL
.
          MATCH     "1",PTCNBBSW
          GOTO      WBSB9999 IF NOT EQUAL
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY8
.
.-------- Emergency visit
          IF        VISITTYP=ONE
            MOVE      "1",KEY1
            MOVE      PINVNO,KEY8
            GOTO      WBSB0500
          ENDIF
.
.-------- Private Practice visit
          IF        VISITTYP=FOUR
            MOVE      "2",KEY1
            MOVE      PRINNUMB,KEY8
            GOTO      WBSB0500
          ENDIF
.
.-------- Outpatient visit
          IF        VISITTYP=TWO
            MOVE      "3",KEY1
            MOVE      PINVNO,KEY8
            GOTO      WBSB0500
          ENDIF
.
          GOTO      WBSB9999
.
WBSB0500  OPEN      WEBBBSA2,"webbbsaf"
          PACK      KEY17,KEY8,SP8,KEY1,SP70
          CALL      RDWBBBS2
          COMPARE   ZERO,OVRCD
          GOTO      WBSB2000 IF EQUAL
.
WBSB1000  PACK      KEY17,KEY8,Z70
          CALL      RSWBBBS2
          CALL      RPWBBBS2
          BRANCH    OVRCD,WBSB9999
.
          MATCH     WBBSINVN,KEY8           * same invoice?
          GOTO      WBSB9999 IF NOT EQUAL
.
          MATCH     WBBSMODL,KEY1
          GOTO      WBSB1000 IF NOT EQUAL
.
WBSB2000  PACK      WBBSURNO,WBBSURNO,SP70
          PACK      WBBSUNIQ,WBBSUNIQ,SP70
          PACK      WBBSINVN,WBBSINVN,SP70
          PACK      WBBSBATN,WBBSBATN,SP70
          PACK      WBBSMODL,WBBSMODL,SP70
.
          WRITE     HTMLFILE;WBBSURNO,WBBSUNIQ,WBBSINVN,WBBSBATN,WBBSMODL;
.
WBSB9999  RETURN
+
.------------------------------------------------------------------------------
.         Get last WebServices batch record from webdva
.------------------------------------------------------------------------------
WDVA0000  MATCH     "1",PTCNWSIN
          GOTO      WDVA9999 IF NOT EQUAL
.
          MATCH     "1",PTCNDVAW
          GOTO      WDVA9999 IF NOT EQUAL
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY8
.
.-------- Private Practice visit
          IF        VISITTYP=FOUR
            MOVE      "2",KEY1
            MOVE      PRINNUMB,KEY8
            GOTO      WDVA0500
          ENDIF
.
.-------- Outpatient visit
          IF        VISITTYP=TWO
            MOVE      "3",KEY1
            MOVE      PINVNO,KEY8
            GOTO      WDVA0500
          ENDIF
.
          GOTO      WDVA9999
.
WDVA0500  OPEN      WEBDVWA2,"webdvwaf"
          PACK      KEY17,KEY8,SP8,KEY1,SP70
          CALL      RDWBDVW2
          COMPARE   ZERO,OVRCD
          GOTO      WDVA2000 IF EQUAL
.
WDVA1000  PACK      KEY17,KEY8,Z70
          CALL      RSWBDVW2
          CALL      RPWBDVW2
          BRANCH    OVRCD,WDVA9999
.
          MATCH     WBDWINVN,KEY8           * same invoice?
          GOTO      WDVA9999 IF NOT EQUAL
.
          MATCH     WBDWMODL,KEY1
          GOTO      WDVA1000 IF NOT EQUAL
.
WDVA2000  PACK      WBDWURNO,WBDWURNO,SP70
          PACK      WBDWUNIQ,WBDWUNIQ,SP70
          PACK      WBDWINVN,WBDWINVN,SP70
          PACK      WBDWBATN,WBDWBATN,SP70
          PACK      WBDWMODL,WBDWMODL,SP70
.
          WRITE     HTMLFILE;WBDWURNO,WBDWUNIQ,WBDWINVN,WBDWBATN,WBDWMODL;
.
WDVA9999  RETURN
+
.------------------------------------------------------------------------------
          INC       IBAWEBCD    
.
          INC       READHTRA
          INC       CLPATHTR
          INC       CLPATDTR
          INC       CLPATELG
          INC       CLPATJRN
          INC       CLPRIHRE
          INC       PRIPPINV
          INC       PMSDBINV
          INC       CMXMATRX
          INC       NZPGLEXT
          INC       IBALPCCD
          INC       TFILENAM
.
          INC       IBAPOLIO/INC
          INC       PRICMNIO/INC
          INC       PRISECIO/INC
          INC       PRIALSIO/INC
          INC       DEBDBTIO/INC
          INC       DEBFDTIO/INC
          INC       DEBITMIO/INC
          INC       APSMASIO/INC
          INC       AAEDI1IO/INC
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       COMDEPIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       EMRECTIO/INC
          INC       IBALPCIO/INC
          INC       IBATMDIO/INC
          INC       OUTECTIO/INC
          INC       PATAFEIO/INC
          INC       PATALRIO/INC
          INC       PATASDIO/INC
          INC       PATCMXIO/INC
          INC       PATCTFIO/INC
          INC       PATDRGIO/INC
          INC       PATDGWIO/INC
          INC       PATFEEIO/INC
          INC       PATHDFIO/INC
          INC       PATHSPIO/INC
          INC       PATHLFIO/INC
          INC       PATLDFIO/INC
          INC       PATALWIO/INC
          INC       PATBFEIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPEXTIO/INC
          INC       NZPPICIO/INC
          INC       NZPSPRIO/INC
          INC       MLTCFNIO/INC
          INC       PMSTLEIO/INC
          INC       PMSCIDIO/INC
          INC       PMSPRGIO/INC
          INC       PATCMCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATEDTIO/INC
          INC       PATELGIO/INC
          INC       PATIPEIO/INC
          INC       PATINVIO/INC
          INC       PATIRNIO/INC
          INC       PATITMIO/INC
          INC       PATICDIO/INC
          INC       PATIBLIO/INC
          INC       PATIN1IO/INC
          INC       PATJRNIO/INC
          INC       PATFACIO/INC
          INC       PATFIGIO/INC
          INC       PATFINIO/INC
          INC       PATFN1IO/INC
          INC       PATHGPIO/INC
          INC       PATHTRIO/INC
          INC       EMRHTRIO/INC
          INC       OUTHTRIO/INC
          INC       PATIPRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPIVBIO/INC
          INC       NZPFIGIO/INC
          INC       NZPFINIO/INC
          INC       NZPRDTIO/INC
          INC       NZPRFNIO/INC
          INC       PATMA1IO/INC
          INC       PATPGRIO/INC
          INC       PMSAELIO/INC
          INC       PMSAILIO/INC
          INC       PMSCLTIO/INC
          INC       PMSCMTIO/INC
          INC       PATCMTIO/INC
          INC       PMSCNOIO/INC
          INC       PMSEVTIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSFCIIO/INC
          INC       PMSMTIIO/INC
          INC       PMSPTDIO/INC
          INC       PMSPX2IO/INC
          INC       PMSWORIO/INC
          INC       PMSECTIO/INC
          INC       PRIECTIO/INC
          INC       PATCFAIO/INC
          INC       PATFAPIO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATPFAIO/INC
          INC       PATPR1IO/INC
          INC       PATASFIO/INC
          INC       PATPARIO/INC       * Eclipse Participants
          INC       PATHOSIO/INC
          INC       PATRBLIO/INC
          INC       PATRATIO/INC
          INC       PATRCAIO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATVADIO/INC
          INC       PATDADIO/INC
          INC       PATONHIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PATLSDIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATSGCIO/INC
          INC       PATSCFIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PMSFEDIO/INC
          INC       PMSFENIO/INC
          INC       PMSFESIO/INC
          INC       PMSFETIO/INC
          INC       PMSFIDIO/INC
          INC       PMSVX1IO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDECIO/INC
          INC       OUTDTRIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCLIIO/INC
          INC       OUTSITIO/INC
          INC       OUTCTYIO/INC
          INC       OUTSESIO/INC
          INC       OUTHEDIO/INC
          INC       MAMMASIO/INC
          INC       RESLNKIO/INC
          INC       MLTSECIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       IBAGSTIO/INC
          INC       VISPAYIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       IBAGEDIO/INC
          INC       PATMESIO/INC
          INC       PATUREIO/INC
          INC       PATRASIO/INC
          INC       PATDETIO/INC
          INC       PATDDHIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIVBIO/INC
          INC       PMSIDEIO/INC
          INC       PMSVSCIO/INC
          INC       PMSICMIO/INC
          INC       PATRGMIO/INC
          INC       PMSREGIO/INC
          INC       PMSEXTIO/INC
          INC       PATIFCIO/INC
          INC       OBSPCOIO/INC
          INC       OBSPCTIO/INC
.
          INC       PRIICMIO/INC                 * PP Invoice comments file
          INC       PRICNOIO/INC
          INC       PRIHDBIO/INC                 * holding header file
          INC       PRIHREIO/INC                 * holding referral file
          INC       PRIDTRIO/INC                 * debtor transaction file
          INC       PRIINVIO/INC                 * invoice file
          INC       PRIPRAIO/INC
          INC       RCPBDTIO/INC
          INC       RCPDTEIO/INC                 * Receipts
          INC       RCPBNKIO/INC                 * Receipts
          INC       RCPREGIO/INC                 * Receipts
          INC       RCPCRSIO/INC
          INC       WEBPCIIO/INC
          INC       WEBIHCIO/INC
          INC       WEBIMCIO/INC
          INC       WEBBBSIO/INC
          INC       WEBDVWIO/INC
.
          INC       PMSEDGIO/INC                 * Effective DRG Dates
          INC       PRNTICDC                     * print ICD10
          INC       RSHWEBCD
.
          INC       PRTIPROV
          INC       CLNHIMAS                     * Clear nhimasaf file variables
          INC       CHKCMXPT
          INC       CLPATDET
          INC       CMGETTHR
          INC       PATCALFN 
          INC       VISPAYTM
          INC       PATCMSTP
          INC       PATCOMN3
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATGBCRN 
          INC       PATMASTM
          INC       PATNAMCD
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSFEDTM
          INC       PMSFESTM
          INC       PMSFIDTM
          INC       PMSWORTM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATDSCTM
          INC       PATRE1TM
          INC       NAMSTRCD
          INC       STEPDOWN
          INC       CALCAGE
          INC       NHOSPDAY
          INC       DAYOFWEK
          INC       WEBDATCD
          INC       PATANVS  
          INC       PATINVHL 
          INC       PATINVTL 
          INC       PATCATAI
          INC       PATIPERH
          INC       PRIHRETM
          INC       CLPATDSC
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPMSCLT
          INC       CLPMSVX1
          INC       CLPMSFID
          INC       CLPMSPTD
          INC       CLPMSMTI
          INC       CLPMSFED
          INC       PATCODDS
          INC       PATALWDS
          INC       PATDEFCL                * routine DCLM0000
          INC       GETALTID
          INC       FEESESTM
          INC       PRTINVBD
          INC       PATDPATH
          INC       PATMCHRD                * Get Misc. Item Charges  *I-233046
          INC       PATDDHRD
          INC       PMSCLTTM
          INC       PMSOSDTM
          INC       SGCHKDIG
          INC       GETBFEES
          INC       GETTFEES
          INC       GETCNEFF
          INC       VALCMXFN
          INC       CINVPEND
          INC       GETEFDRG           * Get Effective DRG Version
