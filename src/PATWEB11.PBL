.----------------------------------------------------------------------
. Program       : PATWEB11
.
. Function      : Multi database server
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.01 30/05/2025  Don Nguyen     TSK 0955096
.           Alphanumeric visit number changes
. V11.02.02 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD changes
. V11.02.01 07/02/2022  Thanh T       TSK 0896905
.           Recompiled for ALLDEPFD changes
. V11.01.01 21/05/2021  Thanh T        TSK 0873184
.           Added SEENDTIM, TESTDTIM, EMCNPBSD for EMRVISTM changes  
. V11.00.01 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V10.15.01 23/10/2019  Ebon Clements    TSK 0308709
.           Recompiled for OUTBOATM - Clinic type linked visit types
.----------------------------------------------------------------------
. V10.14.03 21/03/2019  Tracey Nguyen  TSK 0838668
.           Added CHARTREV for OUTBOATM
. V10.14.02 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.01 27/02/2019  Don Nguyen     TSK 0821139
.           Recompiled for EMRVISTM - Modified Location selection list code
.----------------------------------------------------------------------
. V10.12.04 18/07/2018  Ebon Clements   TSK 0856416
.           Increased length of VISTLOC and VSTATUS
. V10.12.03 14/05/2018  Ebon Clements   TSK 0856416
.           Fixed ED visit location and status display - GETVIS00
. V10.12.02 18/05/2018  Thanh T.        TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.01 03/05/2018  Ebon Clements   TSK 0856416
.           Fixed emergency doctor name in GETVIS00
.----------------------------------------------------------------------
. V10.11.08 27/11/2017  Thanh Tieu     TSK 0821710
.           Recompiled as PATMASTM changed
. V10.11.07 22/11/2017  Ania P         TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
. V10.11.06 11/09/2017  Thanh T.       TSK 0821710
.           Recompiled for OUTBOATM
. V10.11.05 31/08/2017  Thanh T.       TSK 0821710
.           Recompiled OUTBOATM.
. V10.11.04 08/08/2017  Thanh T.       TSK 0821710
.           Recompiled OUTBOATM.
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.08.01 10/06/2016  Peter Vela    TSK 0816991
.           Recompiled for EMRVISTM
. V10.07.01 19/10/2015  Don Nguyen     CAR 316625
.           Added ALLCASFD/IO and opened file
.----------------------------------------------------------------------
. V10.08.01 22/11/2016  Ania P         CAR 261630
.           Removed use of PORT
. V10.06.06 13/08/2015  Don Nguyen     CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
.           11/08/2015  Peter Vela     CAR 319532
.           Recompiled for OUTBOATM - Added slot template location to APPTAB00
. V10.06.05 05/08/2015  Peter Vela     CAR 320066
.           Recompiled for EMRVISTM
. V10.06.04 22/06/2015  Peter Vela     CAR 311435
.           Recompiled for EMRVISTM
. V10.06.03 15/05/2015  Davin          CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.02 30/04/2015  Don Nguyen     CAR 314266
.           Recompiled for OUTBOATM - Modified OBOA3300 with test on indicator 1
. V10.06.01 03/03/2015  Peter Vela     CAR 282090
.           Recompiled for EMRVISTM
. V10.05.05 24/02/2015  Don Nguyen     CAR 303885
.           Recompiled for OUTBOATM - Modified APPTAB00 to output PTHSNAME.
. V10.05.04 16/10/2014  Ebon Clements   CAR 291413
.           Write record for polling server for AH referral expiry
.           date recalulation on attendance - POLX0000
. V10.05.03 21/08/2014  Peter Vela     CAR 303909
.           Recompiled for EMRVISTM
. V10.05.02 19/08/2014  Peter Vela     CAR 304873
.           Recompiled for EMRVISTM
. V10.05.01 18/08/2014  Peter Vela     CAR 304873
.           Recompiled for EMRVISTM
. V10.04.03 07/07/2014  Ebon Clements  CAR 303213
.           Added open of PMSVX1A1
. V10.04.02 07/04/2014  Peter Vela     CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland    CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.04 20/06/2013  Davin             CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.03 26/03/2013  Don Nguyen        CAR 282342
.           Recompiled for PATGBCRN
. V10.03.02 20/07/2012  Don Nguyen        CAR 264561
.           Recompiled for PATGBCRN
.           Also read in Hospital ID before calling GBCRN000
. V10.03.01 16/01/2012  Sandra Barcham    CAR 256563
.           Recompiled for PATMASTM
. V10.02.01 13/07/2011  Ebon Clements     CAR 242246
.           Recompiled for OUTBOATM - Display hospital on cancelled appt list
. V10.00.03 18/08/2010  Davin             CAR 223805
.           Recompiled for PATVISTM
. V10.00.02 03/06/2010  Ebon Clements  CAR 208220
.           Recompiled for OUTBOATM -  Added comment icon link to APPTSU00
. V10.00.01 14/04/2010 Steve Armstrong   CAR 219933
.           Recompiled for changes to EMRVCDFD
.----------------------------------------------------------------------
. V9.11.01  19/03/2009  Davin S       CAR 178015
.                       Changed to use invoice number for BPAY CRN (OEXT4200)
.----------------------------------------------------------------------
. V9.08.02  31/01/2007  Peter Vela    CAR 127930
.                       Recompled for MRTCONFD
. V9.08.01  10/10/2006  Peter Vela    CAR 120583
.                       Added PTMIUYN1 PTMIUYN2 tags
.                       Added missing tags for patweb1101002.html sjog-vic
.----------------------------------------------------------------------
. V9.07.01  20/07/2006  Peter Vela    CAR 112999
.                       Recompiled for EMRVISTM
.----------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                       Mods for PATCODTM - Hospital specific category codes
. V9.05.B04 20/02/2006  Ebon Clements     CAR 76341
.                       Added referral and encounter file audit 
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.                       Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B01 20/12/2005  Ebon Clements CAR 76341
.                       Key length changes for encounter number
. V9.04.02  21/11/2005  Peter Vela    CAR 68675
.                       Recompiled for PATDSCTM
. V9.04.01  22/06/2005  Jill Habasque 
.                       Added outpatient bookings
. V9.04.00  30/03/2005  Jill Habasque            SRF 52841
.                       Created Web Server
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       AAEDE1FD/INC
          INC       AAEDI1FD/INC
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC
          INC       ALLDEPFD/INC
          INC       ALLENCFD/INC
          INC       ALLLNKFD/INC
          INC       EMRHISFD/INC
          INC       EMRDOCFD/INC
          INC       EMRGRCFD/INC
          INC       EMRICDFD/INC
          INC       EMRLOCFD/INC
          INC       EMRVCDFD/INC
          INC       EMRSITFD/INC
          INC       EMRVISFD/INC
          INC       EMRUNKFD/INC
          INC       MULTVISV/INC            * PATDPATH variables
          INC       PATDPTHV/INC            * PATDPATH variables
          INC       PATDO1FD/INC   * Doctor File
          INC       PATHOSFD/INC
          INC       PATHSPFD/INC
          INC       PMSDUNFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PMSEVTFD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       OPRCONFD/INC
          INC       OUTCONFD/INC
          INC       PATCONFD/INC
          INC       EMRCONFD/INC
          INC       MRTCONFD/INC
          INC       PATALRFD/INC
          INC       OPRNURFD/INC
          INC       OUTHEDFD/INC
          INC       OUTCANFD/INC
          INC       OUTMA1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       OUTBITFD/INC
          INC       OUTBOCFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCVTFD/INC
          INC       OUTRSHFD/INC
          INC       OUTSESFD/INC
          INC       OUTSIPFD/INC
          INC       OUTSITFD/INC
          INC       OUTDIAFD/INC
          INC       OUTXSCFD/INC
          INC       OUTXWPFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATPR1FD/INC
          INC       PMSPX2FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       PRITHDFD/INC
          INC       PRIHTRFD/INC
          INC       PRIITMFD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATINVFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSHCLFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATDSCFD/INC
          INC       VISCMTFD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       VARGBCRN/INC
          INC       ALLCASFD/INC
          INC       TFILEVAR/INC
          INC       PATMISTD/INC
.
.----------------------------------------------------------------------
.
ADIADESC  DIM       25
ATYPDESC  DIM       25
AUDITDTE  DIM       12
BOOKFLAG  FORM      1    
CALCDATE  DATE      8
CASEKEYS  DIM       28
CFILEPRE  DIM       3
CFNAMEO   DIM       8
CHARTREV  FORM      1        * Chart Review               * T0838668
CLAIMCOD  DIM       6
CLAIMTYP  DIM       1
CLILDESC  DIM       25         
CMDLINE   DIM       127
COUNT     FORM      6
COUNTER   FORM      3
CTYPDESC  DIM       25
CURRDATE  DIM       8       * Current Date
DDIADESC  DIM       25
DEPTFLAG  FORM      1
DESCDOCM  DIM       30
DESCHOME  DIM       30
DIDATE    DIM       11
DIM3      DIM       3
DIM5      DIM       5
DIM8      DIM       8
DIM30     DIM       30       
DIM40     DIM       40
DIM60     DIM       60
DISCDATE  DIM       12
DISWARD   DIM       3
DISUNIT   DIM       3
DISBED    DIM       3
DTYPDESC  DIM       25
DOCTCODE  DIM       8
ENDATE    DIM       11  
FORM8     FORM      8 
FORM3     FORM      3 
F12P2     FORM      12.2
F8P2      FORM      8.2
HELPRNT   FORM      3
HOSFLAG   FORM      1
HOSPFLAG  DIM       2
HOSPCODE  DIM       4
HOSPITAL  DIM       25
HTMLLNK2  DIM       127
LINK2PRT  FORM      1      
LINKVTYP  FORM      1
MBSDESC   DIM       70
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NEXTSCRN  DIM       3       
NEWSLOTK  DIM       28
OUTCDESC  DIM       25
ORACLEDB  FORM      1
OVERBOOK  FORM      1
PDIADESC  DIM       70
PRIDISCD  DIM       9       * Primary Disease Code 
PSAGECON  DIM       3
PSAGETYP  DIM       3
SAVKEY8   DIM       8
SESSKEYS  DIM       25
SHOWHOSC  FORM      1
SHWPRINT  FORM      1   
SLOTTIME  DIM        5      
STARTKEY  DIM       10      * Starting Key
SELCDATE  DIM       8
SHOWFRMT  DIM       1  
SLOTNUMB  DIM       3
.
SEENDTIM  DIM       16
TESTDTIM  DIM       16
TESTDATE  DIM       8
TESTTIME  DIM       8
.
TEMPTIME  DIM        5
TMPDATE   DIM       8
TODAY     DIM       8
UPDATEKY  DIM       22
UNITCODE  DIM       6
UNITDESC  DIM       20
UPDTTYPE  DIM       1       * Update Type
VCODE     DIM       5
VISCMFLG  FORM      1
VISADIAG  DIM       12                *Diagnosis Code
VISTDATE  DIM       11
VISTDESC  DIM       25
VISTLOC   DIM       70
VISTTIME  DIM       10
VISTRCOD  DIM       20
VISTFLAG  FORM      1
VTYPDESC  DIM       70
WAITFLAG  FORM      1 
WAITLKEY  DIM       19   
WAITRKEY  DIM       19  
WARDNAME  DIM       25
.
DASH      INIT      "-"
VISHOSID  INIT      "01"
SECOPT    DIM       1
VISTDAY   DIM       5
PVISYSN   FORM      2
VISTCOMH  INIT      "COM"
VISTEMER  INIT      "EMG"
VISTOUTP  INIT      "OP"
VISTINPT  INIT      "IP"
VISTALLH  INIT      "AH"
VISTEVNT  INIT      "EV"
VISTTYPE  DIM       5
VSTATUS   DIM       100
VIEWFLAG  FORM      1
VOLNDESC  DIM       16
.
EMGSTAT1  INIT      "Current"
.
INPSTAT1  INIT      "Pre-adm"
INPSTAT2  INIT      "Current IP"
INPSTAT3  INIT      "Discharged"
INPSTA3A  INIT      "Disc-"
INPSTA3B  INIT      "Cancelled"
INPSTAT4  INIT      "Leave"
INPSTAT5  INIT      "Cancel"
.
ALLSTAT0  INIT      "On W/List"
ALLSTAT1  INIT      "Active"
ALLSTAT2  INIT      "Closed"
ALLSTAT3  INIT      "Inactive"
ALLSTAT4  INIT      "Cancelled"
.
OEVSTA0   INIT      "Outpatient-ATTENDED"
OEVSTA1   INIT      "Outpatient-NO ATTENDANCE"
OEVSTA2   INIT      "Outpatient-CANCELLED"
.
WLSTAT1   INIT      "Unscheduled"
WLSTAT2   INIT      "Scheduled"
WLSTAT3   INIT      "Pre-Admitted"
WLSTAT4   INIT      "Admitted"
WLSTAT5   INIT      "Discharged"
WLSTAT6   INIT      "Removed from W/L"
WLSTAT7   INIT      "Performed"
WLSTAT8   INIT      "Not Performed"
WLSTAT9   INIT      "Cancelled Booking"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATVI     INIT      "VI"
.
TESTFILE  FILE      ASCII, FIXED=128
.
TEMPO     IFILE     SQL, FIXED=4, KEY="U1-3"
KEYO      INIT      " 4 U1-3"
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB11"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Multi Database Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      VLIST000        * Multi database visit list
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATINVR5,"patinvrf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATHOSP2,"pathospf"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      ALLCASA1,"allcasaf"
.
          OPEN      CONTROLF,"controlf"         * For spool file
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,HUND22;*12,EMCNPBSD
          READ      CONTROLF,HUND05;*211,PTCNBPAY
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEO
          CALL      PATDPATH
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,HOSPFLAG

CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            PACK      ADMISSNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPFLAG
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Multi Database visit details
.------------------------------------------------------------
VLIST000  MOVE      CHOSPNUM,HOSPCNT
          MATCH     SP70,HOSPFLAG
          IF        !@EQUAL
            MOVE      HOSPFLAG,HOSPCNT
          ENDIF
.
          CALL      OPFIL000
.
          MATCH     SP70,UPDTTYPE
          GOTO      VLIST700 IF EQUAL
.
          GOTO      VLIST900
.
VLIST700  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,VLIST910
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,ADMISSNO
          GOTO      VLIST800 IF EQUAL
.
          MOVE      ADMISSNO,KEY8   * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,VLIST920
.
          MOVE      ADMISSNO,KEY8   * Read Visit Extension File
          CALL      RDPMVX11
          BRANCH    OVRCD,VLIST920
.
          BRANCH    PVITYPE,VLIST710,VLIST720,VLIST730
          GOTO      VLIST800
.
VLIST710  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VLIST920
          GOTO      VLIST800
.
VLIST720  MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,VLIST940
          MOVE      ADMISSNO,KEY8
          CALL      RDOTXSC1
          MOVE      OBASITE,WBSESIT
.
          PACK      CASEKEYS,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDSBOKA1
VLIST725  CALL      RDKBOKA1
          BRANCH    OVRCD,VLIST940
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     KEY20,CASEKEYS
          GOTO      VLIST940 IF NOT EQUAL
          MATCH     OBAOUTNO,PVIBILL         * Set up billing number
          GOTO      VLIST725 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      VLIST800
.
VLIST730  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VLIST930
          GOTO      VLIST800
.
VLIST800  CLEAR     WEBTITLE
          MOVE      HOSPITAL,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VLIST999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST910  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST920  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST930  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST940  MOVE      "Error: No Appointment Found for Visit No",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLIST999
.
VLIST999  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFL191
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000    * Discharge File Info
          GOTO      PROFLD99
.
PROFLD14  CALL      VISTAB00
          GOTO      PROFLD99
.
PROFLD15  CALL      PMIX0000
          GOTO      PROFLD99
.
PROFLD16  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD17  CALL      EMRA0000             * emrvisaf/emrunkaf/emrvpraf/emrvdgaf
          GOTO      PROFLD99
.
PROFLD18  CALL      EMRB0000             * emrvisaf user defined fields
          GOTO      PROFLD99
.
PROFLD19  CALL      OBOA0000
          GOTO      PROFLD99
.
PROFL191  CALL      OEXT0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. Extra Outpatient Fields for Booking/Follow up/Reschedule
.------------------------------------------------------------
OEXT0000  BRANCH    FLDITMNO,OEXT0100,OEXT0200,OEXT0300,OEXT0400,OEXT0500:
                             OEXT0600,OEXT0700,OEXT0800,OEXT0900,OEXT1000:
                             OEXT1100,OEXT1200,OEXT1300,OEXT1400,OEXT1500:
                             OEXT1600,OEXT1700,OEXT1800,OEXT1900,OEXT2000:
                             OEXT2100,OEXT2200,OEXT2300,OEXT2400,OEXT2500:
                             OEXT2600,OEXT2700,OEXT2800,OEXT2900,OEXT3000:
                             OEXT3100,OEXT3200,OEXT3300,OEXT3400,OEXT3500:
                             OEXT3600,OEXT3700,OEXT3800,OEXT3900,OEXT4000:
                             OEXT4100,OEXT4200
          WRITE     HTMLFILE;"Invalid Tag"
          GOTO      OEXT9999
.
OEXT0100  CALL      SCODL000
          GOTO      OEXT9999
.
OEXT0200  CALL      RSHCNT00
          GOTO      OEXT9999
.
OEXT0300  WRITE     HTMLFILE;PMVXUDF1;      * PMSVX1FD (Visit Extension Table)
          GOTO      OEXT9999
.
OEXT0400  CALL      NXTAPP00  * Next Available Appointment Details by Type
          GOTO      OEXT9999
.
OEXT0500  CALL      GETCTY00
          GOTO      OEXT9999
.
OEXT0600  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1
          GOTO      OEXT9999
.
OEXT0700  MOVE      "CI",CATEGORY
          MOVE      OMACIND,CODE
          CALL      CODITM00
          GOTO      OEXT9999
.
OEXT0800  IF        OBASTAT=1
            WRITE     HTMLFILE;"<option value=1 selected>Booked</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=1>Booked</option>"
          ENDIF
          IF        OBASTAT=4
            WRITE     HTMLFILE;"<option value=4 selected>Attended</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=4>Attended</option>"
          ENDIF
          IF        OBASTAT=5
           WRITE     HTMLFILE;"<option value=5 selected>Did Not Attend</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=5>Did Not Attend</option>"
          ENDIF
          GOTO      OEXT9999
.
OEXT0900  WRITE     HTMLFILE;SHWPRINT;
          GOTO      OEXT9999
.
OEXT1000  CALL      NXTAID00  * Next Available Appointment Details by ID
          GOTO      OEXT9999
.
OEXT1100  MOVE      "R  ",CODE
          MOVE      ZERO,VISTFLAG
          CALL      VTYSEL00
          GOTO      OEXT9999
.
OEXT1200  WRITE     HTMLFILE;OTCNOCRD;
          GOTO      OEXT9999
.
OEXT1300  WRITE     HTMLFILE;OTCNOCDD;
          GOTO      OEXT9999
.
OEXT1400  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      OEXT9999
.
OEXT1500  WRITE     HTMLFILE;NEXTSCRN;  * redirect program after extra pgm
          GOTO      OEXT9999
.
OEXT1600  WRITE     HTMLFILE;PTCNUEOC;  * Using episode of care
          GOTO      OEXT9999
.
OEXT1700  WRITE     HTMLFILE;DEPTFLAG;  * Time default flag for departure screen
          GOTO      OEXT9999
.
OEXT1800  CALL      HTMS0000            * Is this booking part of a series.
          GOTO      OEXT9999
.
OEXT1900  WRITE     HTMLFILE;WAITLKEY;  * Waiting list key for pre admit clinics
          GOTO      OEXT9999
.
OEXT2000  WRITE     HTMLFILE;WAITFLAG;  * Return to Waiting list flag
          GOTO      OEXT9999
.
OEXT2100  IF        WAITFLAG=1
            PACK      WAITRKEY,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
            REP       " +",WAITRKEY
            WRITE     HTMLFILE;WAITRKEY;  * Return to Waiting list key PAC
          ELSE
            PACK      WAITRKEY,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
            REP       " +",WAITRKEY
            WRITE     HTMLFILE;WAITRKEY;  * Return to Waiting list key PAS
          ENDIF
          GOTO      OEXT9999
.
OEXT2200  WRITE     HTMLFILE;OTCNCSUM;  * Using clinic summary for app search
          GOTO      OEXT9999
.
OEXT2300  CALL      RDCM0000            * read cancellation comments   *I-48413
          GOTO      OEXT9999                                           *I-48413
.
OEXT2400  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     " 0",OTBIIFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"MBS";
            GOTO      OEXT9999
          ENDIF
.
          MATCH     " 1",OTBIIFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"AMA";
            GOTO      OEXT9999
          ENDIF
          GOTO      OEXT9999
.
OEXT2500  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;OTBIITMN;
          GOTO      OEXT9999
.
OEXT2600  UNPACK    DIM127,D1,KEY2,DIM127
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;OTBISUBN;
          GOTO      OEXT9999
.
OEXT2700  UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          PACK      KEY10,OBAOUTNO,KEY2,SP70
          CALL      RDOTBIT1
          BRANCH    OVRCD,OEXT9999
.
          MOVE      OTBIIFLG,FORM2
          PACK      KEY22,OTBIIFLG,OTBIITMN,OTBISUBN,Z70 * Get current record
          CALL      RSPRIT1
OEXT2710  CALL      RPPRIT1
          BRANCH    OVRCD,OEXT9999
.
          COMPARE   FORM2,PRITFLAG           * Item Type
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     OTBIITMN,PRITITMN        * AMA/MBS Item
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     OTBISUBN,PRITSUBN        * Sub Item
          GOTO      OEXT9999 IF NOT EQUAL
.
          MATCH     SP70,OBADATE
          IF        !@EQUAL
            MATCH     PRITDAT1,OBADATE
            GOTO      OEXT2710 IF LESS
          ENDIF
.
          BRANCH    F1,OEXT2790
          WRITE     HTMLFILE;PRITDESC;       * AMA/MBS Description
          GOTO      OEXT9999
.
OEXT2790  WRITE     HTMLFILE;PRITSFEE;       * AMA/MBS schedule fee
          GOTO      OEXT9999
.
OEXT2800  MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TCINDC1;
          GOTO      OEXT9999
.
OEXT2900  PACK      KEY4,SP70
          CALL      RSPRTHD1
OEXT2910  CALL      RKPRTHD1
          BRANCH    OVRCD,OEXT9999
.         MATCH     "1",PRTHINDC
.         IF        !@EQUAL
.           GOTO      OEXT2910        * Not Active
.         ENDIF
          PACK      KEY6,QUOTE,PRTHTMID,QUOTE
          MATCH     PRTHTMID,OTMAMBST
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               PRTHDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">",PRTHDESC,"</option>"
          ENDIF
          GOTO      OEXT2910
.
OEXT3000  MATCH     SP70,ALREREXP           * Open ended
          GOTO      OEXT9999 IF EQUAL
.
          MATCH     SP70,ALRERTYP           * No referral type
          GOTO      OEXT9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OEXT9999
.
          MATCH     SP70,THCSCOD            * No days for expiry warning
          GOTO      OEXT9999 IF EQUAL
.
          MOVE      ZERO,F4
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,F4              * After expiry warning days
.
          MOVE      ALREREXP,CALCDATE
          SUB       F4,CALCDATE
.
          WRITE     HTMLFILE;CALCDATE;      * Referral warning date
.
          GOTO      OEXT9999
.
OEXT3100  MATCH     SP70,ALREREXP
          GOTO      OEXT9999 IF EQUAL
.
          WRITE     HTMLFILE;ALREREXP;
          GOTO      OEXT9999
.
OEXT3200  MATCH     SP70,ALRERDAT
          GOTO      OEXT9999 IF EQUAL
.
          WRITE     HTMLFILE;ALRERDAT;
          GOTO      OEXT9999
.
OEXT3300  MOVE      "No ",KEY3
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,OEXT3320
          MATCH     DOBAOUTN,ALLNLNKV     * same visit no?
          GOTO      OEXT3320 IF NOT EQUAL
          MOVE      "Yes",KEY3
          WRITE     HTMLFILE;KEY3;
          GOTO      OEXT9999
.
OEXT3320  WRITE     HTMLFILE;"<font color=red size=3>",KEY3,"</font>";
          GOTO      OEXT9999
.
OEXT3400  WRITE     HTMLFILE;OTMAUMCI;       * Clinic using medclaims
          GOTO      OEXT9999
.
OEXT3500  UNPACK    DIM127,D1,KEY1,DIM127     * .0   User Defined Y/N 1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,OEXT3510
          WRITE     HTMLFILE;PTMIUYN1;
          GOTO      OEXT9999
OEXT3510  COMPARE   "1",PTMIUYN1              * .1
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      OEXT9999
.
OEXT3600  UNPACK    DIM127,D1,KEY1,DIM127     * .0   User Defined Y/N 2
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,OEXT3610
          WRITE     HTMLFILE;PTMIUYN2;
          GOTO      OEXT9999
OEXT3610  COMPARE   "1",PTMIUYN2              * .1
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      OEXT9999
.
OEXT3700  CALL      DISWRD00              * discharge ward
          WRITE     HTMLFILE;DISWARD;
          GOTO      OEXT9999
.
OEXT3800  CALL      DISWRD00              * discharge bed
          WRITE     HTMLFILE;DISBED;
          GOTO      OEXT9999
.
OEXT3900  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          BRANCH    OVRCD,OEXT9999
.
          PACK      KEY5,PTDAADTS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;PTVADESC;   * Admission Transfer Source Desc
          GOTO      OEXT9999
.
OEXT4000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          BRANCH    OVRCD,OEXT9999
.
          PACK      KEY5,PTDADCTS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,OEXT9999
.
          WRITE     HTMLFILE;PTVADESC;    * Discharge Transfer Source Desc
          GOTO      OEXT9999
.
OEXT4100  WRITE     HTMLFILE;PTCNBPAY;
          GOTO      OEXT9999
.
OEXT4200  MOVE      ADMISSNO,AADMNO
          CALL      GETINV00
          MOVE      PINVNO,BPAYINVN
.
          IF        IBCNMHOS=1
            PACK      KEY8,AADMNO,SP70
            OPEN      PMSVX1A1,"pmsvx1af"
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,BPAYHOSP
            ENDIF
          ENDIF
.
          CALL      GBCRN000
          WRITE     HTMLFILE;BPAYREFN;
          GOTO      OEXT9999
.
OEXT9999  RETURN
.------------------------------------------------------------
. Multi database Visit List
.------------------------------------------------------------
VISTAB00  MOVE      ZERO,DIM1
          MOVE      ZERO,HOSFLAG
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      PATDPATH
.
          MOVE      ZERO,HOSPCNT
VISTAB10  CALL      VFILE000
          BRANCH    EXIT,VISTAB99
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSPTVIS2
VISTAB20  CALL      RKPTVIS2
          BRANCH    OVRCD,VISTAB50
.
          MATCH     PVIURNO,URNUMBER
          GOTO      VISTAB50 IF NOT EQUAL
.
          CALL      GETVIS00
          BRANCH    EXIT,VISTAB20
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,VISTAB30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * dont include emergency events
          GOTO      VISTAB20 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70
            IF        IBCNMHOS=1
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPWRD,SLASH,PMEVPBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      VISTAB30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      VISTAB30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS
          ENDIF
          MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
VISTAB30  MATCH     SP70,PMEVCTYP
          GOTO      VISTAB40 IF EQUAL
.
          PACK      KEY6,PMEVCTYP,SP70
          CALL      RDSCTYA1
VISTAB31  CALL      RDKCTYA1
          BRANCH    OVRCD,VISTAB40
.
          MATCH     OCTSITE,WBSESIT     * Must be in the Same Site
          GOTO      VISTAB31 IF NOT EQUAL
.
          MATCH     PMEVCTYP,OCTCTYP
          GOTO      VISTAB31 IF NOT EQUAL
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
VISTAB40  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,VISTAB20        * don't display
.
          REP       " 0",PVIDATE
.
          MOVE      ZERO,HOSFLAG
          PACK      KEY2,CHOSPNUM,SP70
          CALL      RDHOSP2
          IF        OVRCD<>1
            MATCH     HOSCODE,HOSPCODE
            IF        @EQUAL
              MOVE      ONE,HOSFLAG
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVISITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSPCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PVIBILL,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",DDATE,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP8,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",SP8,"#",":
                             "#"",SP8,"#",":
                             "#"",SP8,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SLOTNUMB,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",VISTRCOD,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP8,"#",":
                             "#"",ACODDTE,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP8,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",SP8,"#",":
                             "#"",SP8,"#",":
                             "#"",HOSPITAL,"#",":
                             "#"",HOSFLAG,"#")"
.
          GOTO      VISTAB20
.
VISTAB50  CALL      GFOB0000            * Get future outpatient bookings
          GOTO      VISTAB10
.
VISTAB99  RETURN
.
.*********************************************************************
.         get the future OP bookings
.*********************************************************************
GFOB0000  CALL      CTMPO000                * create temp file 
          MOVE      SP6,KEY6
          CALL      RDSSITA1
GFOB1000  CALL      RDKSITA1
          BRANCH    OVRCD,GFOB2000          * end if file
.
          MOVE      OSTFILE,KEY3
          READ      TEMPO,KEY3;ANS
          GOTO      GFOB1000 IF NOT OVER    * already on temp file
.
          WRITE     TEMPO,KEY3;OSTFILE
          GOTO      GFOB1000
.
.         loop over temp file to look at all bookings
.
GFOB2000  MOVE      SP3,KEY3
          READ      TEMPO,KEY3;;
.
GFOB2100  READKS    TEMPO;OSTFILE
          GOTO      GFOB9500 IF OVER        * end of file
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          CLOCK     TIME,KEY5
          CALL      OUTLST00
.
          GOTO      GFOB2100
.
GFOB9500  CALL      DTMPO000
.
GFOB9999  RETURN
+
.------------------------------------------------------------
. Output Outpatient Bookings
.------------------------------------------------------------
OUTLST00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
          MOVE      SP70,PRIDISCD              * I CAR 18122
          MOVE      SP70,PDIADESC              * I CAR 18122
.
          PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
OUTLST10  CALL      RDKBOKA3
          BRANCH    OVRCD,OUTLST70
          MOVE      URNUMBER,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OUTLST70 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,ADIADESC
            MOVE      OPDICODE,VISADIAG
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
          MOVE      OBADATE,PVIDATE
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          MOVE      SP70,VSTATUS
          IF        OBASTAT=1|OBASTAT=5
            IF        OBASTAT=1
              MOVE      "Booked",VSTATUS
            ELSE
              MOVE      "DNA",VSTATUS
            ENDIF
          ELSE
            GOTO        OUTLST10
          ENDIF
.
OUTLST12  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,OUTLST70
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OUTLST70
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OUTLST70
.
          PACK      VISTLOC,OTHELTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      VISTLOC,OTMAHOSP,DASH,OTHELTYP,SP70
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST15
          ENDIF
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
OUTLST15
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,OBACLIN
          GOTO      OUTLST60 IF EQUAL
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      OUTLST18
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST20
.
          MATCH     OBASITE,OCASITE
          GOTO      OUTLST20 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      OUTLST20 IF NOT EQUAL
.
OUTLST18  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST60 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          GOTO      OUTLST60
.
OUTLST20  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.          GOTO      GETVIS60
.
OUTLST60  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOBAOUTN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TWO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBASITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSPCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      OUTROW00
.
. ---  get rescheduled outpatient bookings ---
.
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1
OUTLST65  CALL      RDKRSHA1
          BRANCH    OVRCD,OUTLST10
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      OUTLST10 IF NOT EQUAL
.
          CALL      RCTY0000                   * Get clinic type description
          PACK      VISTLOC,OTMALTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,OTMAHOSP,DASH,OTMALTYP,SP70
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
            MATCH     SP6,OCADOCT          * I CAR 13038
            GOTO      OUTLST68 IF EQUAL
.
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.                                          * end I CAR 13038
            GOTO      OUTLST68
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST67
.
          MATCH     OPRSSITE,OCASITE
          GOTO      OUTLST67 IF NOT EQUAL
.
          MATCH     OPRSCLIN,OCACLIN
          GOTO      OUTLST67 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
          MATCH     SP6,OCADOCT          * I CAR 13038
          GOTO      OUTLST68 IF EQUAL
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          GOTO      OUTLST68
.
OUTLST67  MOVE      "Invalid Clinic",DOCFNAME     * If no Doctor Use Clinic Name
.
OUTLST68  MOVE      OPRSDATE,PVIDATE
          MOVE      OPRSTIME,VISTTIME
          MOVE      OPRSSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
OUTLST69  MOVE      "Rescheduled",VSTATUS
          MOVE      "javascript:alert('Rescheduled')",HTMLLINK
.
          CALL      OUTROW00
.
          GOTO      OUTLST65
.
. ---  get cancelled outpatient bookings ---
.
OUTLST70  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,VISTLOC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSOTCAN2
OUTLST75  CALL      RKOTCAN2
          BRANCH    OVRCD,OUTLST99
.
          MATCH     URNUMBER,OPCNURNO
          GOTO      OUTLST99 IF NOT EQUAL
.
          CALL      CCTY0000                   * Get clinic type description
          PACK      VISTLOC,OTMALTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,OTMAHOSP,DASH,OTMALTYP,SP70
          ENDIF
.
.
          PACK      KEY36,DOPCNOUT,OPCNDATE,OPCNSTRT,DOPCNSLO,OPCNSITE,OPCNCLIN
          CALL      RDBOKA3
          BRANCH    OVRCD,OUTLST80
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTLST77
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
OUTLST77  MATCH     OBAURNO,URNUMBER
          GOTO      OUTLST75 IF EQUAL
.
OUTLST80  MOVE      OPCNDATE,PVIDATE
          MOVE      OPCNTIME,VISTTIME
          MOVE      DOPCNOUT,SLOTNUMB
          MOVE      SP70,VSTATUS
          MOVE      "Cancelled",VSTATUS
          MATCH     SP70,OPCNCLIN
          GOTO      OUTLST85 IF EQUAL
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      OUTLST81
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST82
.
          MATCH     OPCNSITE,OCASITE
          GOTO      OUTLST82 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      OUTLST82 IF NOT EQUAL
.
OUTLST81  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST85 IF EQUAL
          MOVE      OCADOCT,OPCNCLIN     * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          GOTO      OUTLST85
.
OUTLST82  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
OUTLST85  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOPCNOUT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    FOUR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPCNSITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    HOSPCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      OPCNOUTN,OBAOUTNO
          MOVE      OPCNURNO,OBAURNO
          MOVE      OPCNSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
OUTLST87  CALL      OUTROW00
          GOTO      OUTLST75
.
OUTLST99  RETURN
.
.------------------------------------------------------------
. Get clinic type description for cancelled bookings
.------------------------------------------------------------
CCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CCTY9999
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.
CCTY9999  RETURN
.
.------------------------------------------------------------
. Get clinic type description for re-scheduled bookings
.------------------------------------------------------------
RCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPRSSITE,OPRSCLIN,OPRSDATE,OPRSSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,RCTY9999
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.
RCTY9999  RETURN
.
OUTROW00  REP       " 0",PVIDATE
          MOVE      SP70,AUDITDTE
          MOVE      SP70,VISTDAY
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBAOUTNO,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":                   * Location
                             "#"",VSTATUS,"#",":
                             "#"",OBASLOT,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":                  * I CAR 18122
                             "#"",PDIADESC,"#",":                  * I CAR 18122
                             "#"",HOSPITAL,"#",":
                             "#"",HOSFLAG,"#")"
          RETURN
.*********************************************************************
.*                  CTMPO000                    Called by : GFOB0000 * 
.*        Create a temp file                                         *
.*********************************************************************
CTMPO000  CALL      DTMPO000                * delete temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISBUILD,CFNAMEO,KEYO,SP30      * set command
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * build the temp file
          PREP      TEMPO,CFNAMEO 
.
CTMPO999  RETURN
+
.*********************************************************************
.*                  DTMPO000                    Called by : GFOB0000 *
.*        Delete temp file O                                         *
.*********************************************************************
DTMPO000  CLOSE     TEMPO                   * close temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISERASE,CFNAMEO * set command line for erase
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * delete the temp file
.
DTMPO999  RETURN
+
.------------------------------------------------------------
.         Check for Allied Health
.------------------------------------------------------------
CKAL0000  MOVE      ZERO,EXIT
          COMPARE   "9",PVITYPE
          GOTO      CKAL9999 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      CKAL1000 IF NOT EQUAL
.
. Event Type Visit
.------------------
          PACK      VISTTYPE,PMEVEVNT,SP10  * Event
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,CKAL9999
          MOVE      TWO,SECOPT
          MOVE      PMEVATIM,VISTTIME
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      PMEVUNIT,UNITCODE
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      VISTTYPE,PMEVEVNT,SP70
          MATCH     "O",TCINDC1
          IF        @EQUAL
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      PMEVCTYP,UNITCODE
            PACK      VISTLOC,PMEVPLOC,SP70
            COMPARE   ONE,IBCNMHOS
            IF        @EQUAL
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPLOC,SP70
            ENDIF
          ENDIF
          MOVE      "CL",CATEGORY
          MOVE      PMEVCCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMEVACON
          GOTO      CKAL0500 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    PMEVACON,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
CKAL0500  MATCH     SP70,PMEVCLID
          GOTO      CKAL9999 IF EQUAL
.
          PACK      KEY20,PMEVSITE,PMEVCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CKAL9999
.
          MATCH     PMEVSITE,OCASITE
          GOTO      CKAL9999 IF NOT EQUAL
.
          MATCH     PMEVCLID,OCACLIN
          GOTO      CKAL9999 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      CKAL9999 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
          GOTO      CKAL9999
.
CKAL1000  MATCH    " 2",PVISYST
          GOTO     CKAL9999 IF NOT EQUAL
.
. Allied Heath Type Visit
.-------------------------
          PACK     VISTTYPE,VISTALLH,SP10      * Allied Health
          MOVE     PVIBILL,KEY8
          CALL     RDALREF1              *TO GET DEPT OF THE REFERRAL TABLE
          BRANCH   OVRCD,CKAL9999
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK     KEY3,ALREDEPT,SP70
          CALL     RDALDEP1
          BRANCH   OVRCD,CKAL9000
          MOVE     ALDESECU,SECOPT
.
          MATCH    "2",ALDESECU
          IF       @EQUAL
            MATCH    WBSEDALL,ALREDEPT     * Check department
            GOTO     CKAL9000 IF NOT EQUAL * don't display
          ENDIF
.
          MOVE     ALLSTAT0,VSTATUS
          MOVE     ZERO,FORM1
          MOVE     ALRESTAT,FORM1
          LOAD     VSTATUS,FORM1,ALLSTAT1,ALLSTAT2,ALLSTAT3,ALLSTAT4
.
          PACK     KEY16,PVIBILL,Z70
          CALL     RSALENC1
          CALL     RPALENC1
          IF       OVRCD=0
            MATCH    DPVIBILL,ALENVISN   * Same visit number ?
            IF       @EQUAL
              MATCH    SP8,ALENSDAT
              IF       !@EQUAL
                UNPACK   ALENSDAT,CCENT,CYEAR,CMON,CDAY
                CALL     PACDATE
                REP      " 0",CPCDATE
                ENDSET   VSTATUS
                APPEND   "(Last Enc.",VSTATUS
                APPEND   CPDATE,VSTATUS
                APPEND   ")",VSTATUS
                RESET    VSTATUS
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ALREDEPT,UNITCODE            * To get department
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          PACK      KEY10,ALREHCP,SP70          * To get service provider name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      "&nbsp;",DOCFNAME
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,SP70
          ENDIF
.
          GOTO      CKAL9999
.
CKAL9000  MOVE      ONE,EXIT
CKAL9999  RETURN
.------------------------------------------------------------
. Get status for patient event record
.------------------------------------------------------------
GETSTA00  MATCH     SP70,PMEVDDTE
          GOTO      GETSTA99 IF EQUAL
.
          MOVE      PMEVDDTE,DDATE
          UNPACK    PMEVDDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,DISCDATE
          GOTO      GETSTA00 IF EQUAL
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP70,PMEVDSTT
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSD,PMEVDSTT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,KEY10
              APPEND    KEY10,VSTATUS
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    PMEVDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETSTA99  RETURN
+
.------------------------------------------------------------
. Get visit information
.------------------------------------------------------------
GETVIS00  MOVE      SP70,VISTDATE
          MOVE      ZERO,EXIT
          MOVE      SP1,SECOPT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      SP70,VISTDAY
          MOVE      SP70,VISTLOC
          MOVE      SP70,ACLAIM
          MOVE      SP70,DDATE
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,ATYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,WARDNAME
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,DISCDATE
          MOVE      SP10,VISTTIME
          MOVE      "&nbsp;",DISCDATE
          MOVE      SP70,VISTRCOD
          MOVE      SP70,DOCFNAME
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VISTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          BRANCH    PVITYPE,GETVIS05,GETVIS10,GETVIS15
          GOTO      GETVIS60
.
.       Emergency
.
GETVIS05  MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GETVIS60
          MOVE      ADACOMP,ACLAIM
          MOVE      ADADOCT,PVIDOCT
          MOVE      ADADIAG,ADIADESC       * Diagnosis
          MOVE      ADADATE,PVIDATE
          MOVE      ADATIME,VISTTIME
          CALL      RDDISA1
          IF        OVRCD=0
            MOVE      ADSDIAG,DDIADESC
            MOVE      ADSDATE,DDATE
          ENDIF
.
          MOVE      SP70,PTVADESC
          MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            PACK      KEY5,EMVIDEST
            CALL      RDPTVAD1
            IF        OVRCD=0
              PACK      VSTATUS,PTVADESC,SP70
            ENDIF
            MOVE      EMVIDATE,PVIDATE
            MOVE      EMVITIME,VISTTIME
.
            IF        EMVISTAT=1
              MOVE      SP70,EMVIDDAT
              MOVE      SP70,EMVIDTIM
            ENDIF
.
            MOVE      EMVIDDAT,DDATE
            MOVE      EMVIDOCT,PVIDOCT
            PACK      KEY5,ANSA,ANSA,EMVITRIG
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VISTRCOD         * Triage Code
            ENDIF
          ENDIF
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          IF        OVRCD<>1
            PACK      VISTLOC,EMSTDESC,SP70
          ENDIF
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          IF        EMVISTAT=FOUR
            APPEND    INPSTA3B,VSTATUS
            GOTO      GETVIS60
          ELSE
            IF        EMVISTAT=1
              APPEND    EMGSTAT1,VSTATUS
              GOTO      GETVIS60
            ENDIF
          ENDIF
.
          MATCH     SP70,DISCDATE
          GOTO      GETVIS60 IF EQUAL
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP70,PTVADESC
          IF        !@EQUAL
            MOVE      PTVADESC,KEY10
            APPEND    KEY10,VSTATUS
          ELSE
            MATCH     SP70,EMVIDSTA
            IF        !@EQUAL
              PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,KEY20
                APPEND    KEY20,VSTATUS
              ENDIF
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    EMVIDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
          GOTO      GETVIS60
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
GETVIS10  CALL      OCLI0000              * Get Outpatient details
.
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVIS70 IF EQUAL
.
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      GETVIS11
          ENDIF
.
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,GETVIS12
.
          MATCH     PVISITE,OCASITE
          GOTO      GETVIS12 IF NOT EQUAL
.
          MATCH     PVIDOCT,OCACLIN
          GOTO      GETVIS12 IF NOT EQUAL
.
GETVIS11  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      GETVIS70 IF EQUAL
          MOVE      OCADOCT,PVIDOCT      * Use the doctor's code from the clinic
          GOTO      GETVIS60
.
GETVIS12  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
          GOTO      GETVIS60
.
.         Inpatient
.
GETVIS15  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF GETVIS60
          LOAD      VSTATUS,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                   INPSTAT5
          MOVE      AMBS,VISADIAG
          MOVE      ADIAG1,ADIADESC
          MOVE      ATIME,VISTTIME
.
          MOVE      SP70,DDATE
          CALL      GETLTR00             * Get last transfer record
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC       * Unit Description
.
          MOVE      "A ",CATEGORY
          MOVE      TATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETVIS40
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      DDIAG,DDIADESC         * Discharged Diagnosis
.
          MOVE      SP20,KEY8
          IF        PTCNUADT<>1
            GOTO      GETVIS30
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTDAD1
          BRANCH    OVRCD,GETVIS30
          MATCH     SP70,PTDADCTS
          GOTO      GETVIS30 IF EQUAL
.
          MOVE      SP20,KEY8
          MOVE      PTDADCTS,KEY5            * transfer destination
          CALL      RDPTVAD1
          IF        OVRCD=0
            MOVE      PTVADESC,KEY8      * Destination desc.
          ENDIF
          GOTO      GETVIS35
.
GETVIS30  PACK      KEY5,ANSD,ANSD,DDEST
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY8
          ENDIF
.
GETVIS35  PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP10,KEY8
          IF        !@EQUAL
            APPEND    KEY8,VSTATUS
          ENDIF
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    DTIME,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETVIS40  PACK      VISTLOC,AWARD,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,DASH,AWARD,SP70
          ENDIF
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
GETVIS60  IF        PVITYPE=1
            MATCH     "1",SHOWFRMT
            GOTO      GETVIS70 IF EQUAL
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVIS70 IF EQUAL
.
          COMPARE   TWO,PVITYPE
          GOTO      GETVIS70 IF EQUAL
.
          MOVE      PVIDOCT,KEY6         * Read the doctor's file to get nam
          CALL      RDDOCT1
          IF        OVRCD=1
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
            GOTO      GETVIS70
          ELSE
.           CALL      DOCNAM00             * format doctors name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
GETVIS70  MOVE      "&nbsp;",VISTDESC
          MOVE      "&nbsp;",WARDNAME
          LOAD      VISTDESC,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTDESC
          ENDIF
          IF        PVITYPE=3
            LOAD      VISTDESC,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                     INPSTAT5
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Insurance Class
          MOVE      ACODE,CLAIMCOD
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
          LOAD      VISTTYPE,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTTYPE
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          PACK      VISTDAY,DAYNAM3,SP70
.
GETVIS99  RETURN
.------------------------------------------------------------
. Get Last Transfer Record
.------------------------------------------------------------
GETLTR00  PACK      KEY30,PVIBILL,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETLTR10
          MATCH     PVIBILL,TADMN
          GOTO      GETLTR10 IF NOT EQUAL
          MOVE      TADOCT,PVIDOCT          * Clinician
.
          MATCH     "D",TMOVE
          GOTO      GETLTR99 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
          PACK      VISTLOC,TWARD,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,DASH,TWARD,SP70
          ENDIF
          GOTO      GETLTR99
.
GETLTR10  MOVE      ADOCTA,PVIDOCT
          MOVE      ACLSSFT,TDEPT
          MOVE      ATYPE,TATYPE
.
GETLTR99  RETURN
.------------------------------------------------------------
. Get Outpatient details
.------------------------------------------------------------
OCLI0000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
OCLI1000  CALL      RDKBOKA3
          BRANCH    OVRCD,OCLI9999
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBADATE,PVIDATE
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      OCLI1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          IF        OBASTAT=4
            MOVE      "Attended",VSTATUS
          ENDIF
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OCLI9999
.
          PACK      VISTLOC,OTHELTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      VISTLOC,OTMAHOSP,DASH,OTHELTYP,SP70
            ENDIF
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 1
            UNPACK    SP70,OCTSITE,OCTCTYP,OCTGRP,OCTDESC,OCTXBOK,OCTXATT
            UNPACK    SP70,OCTBKT,OCTATT,OCTACT,OCTVACS
          ENDIF
.
          MOVE      OTHECTYP,UNITCODE
.
          MATCH     SP70,UNITDESC
          IF        @EQUAL
            MOVE      OCTDESC,UNITDESC
          ENDIF
.
OCLI9999  RETURN
+
.------------------------------------------------------------
. Open Multi database tables for vistab00
.------------------------------------------------------------
VFILE000  MOVE      ZERO,EXIT
.
          ADD       ONE,HOSPCNT
.
          COMPARE   ZERO,MRCNNOHS
          GOTO      VFILE950 IF EQUAL       * not using data directories
.
          COMPARE   HOSPCNT,MRCNNOHS
          GOTO      VFILE950 IF LESS
.
          CALL      OPFIL000
.
          GOTO      VFILE999
.
VFILE950  MOVE      ONE,EXIT
VFILE999  RETURN
.------------------------------------------------------------
. Open Multi database tables
.------------------------------------------------------------
OPFIL000  PACK      XXDPATH,SP20,SP20,SP20
          LOAD  XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
          LOAD  HOSPITAL,HOSPCNT,HDDESC1,HDDESC2,HDDESC3,HDDESC4,HDDESC5,HDDESC6
          LOAD  HOSPCODE,HOSPCNT,HDNAME1,HDNAME2,HDNAME3,HDNAME4,HDNAME5,HDNAME6
.
          MOVE      "patvisaf",OPFILE
          MOVE      ONE,FILENUM
          CALL      OMDFN000
.
          MOVE      "patmi1af",OPFILE
          MOVE      TWO,FILENUM
          CALL      OMDFN000
.
          MOVE      "aaede1af",OPFILE
          MOVE      THREE,FILENUM
          CALL      OMDFN000
.
          MOVE      "aaedi1af",OPFILE
          MOVE      FOUR,FILENUM
          CALL      OMDFN000
.
          MOVE      "emrvisaf",OPFILE
          MOVE      FIVE,FILENUM
          CALL      OMDFN000
.
          MOVE      "outdiagf",OPFILE
          MOVE      SIX,FILENUM
          CALL      OMDFN000
.
          MOVE      "outbokaf",OPFILE
          MOVE      SEVEN,FILENUM
          CALL      OMDFN000
.
          MOVE      "outbb1af",OPFILE
          MOVE      EIGHT,FILENUM
          CALL      OMDFN000
.
          MOVE      "outma1af",OPFILE
          MOVE      NINE,FILENUM
          CALL      OMDFN000
.
          MOVE      "outsesaf",OPFILE
          MOVE      TEN,FILENUM
          CALL      OMDFN000
.
          MOVE      "outhedaf",OPFILE
          MOVE      TEN1,FILENUM
          CALL      OMDFN000
.
          MOVE      "outctyaf",OPFILE
          MOVE      TEN2,FILENUM
          CALL      OMDFN000
.
          MOVE      "outcliaf",OPFILE
          MOVE      TEN3,FILENUM
          CALL      OMDFN000
.
          MOVE      "pattranf",OPFILE
          MOVE      TEN4,FILENUM
          CALL      OMDFN000
.
          MOVE      "patdschf",OPFILE
          MOVE      TEN5,FILENUM
          CALL      OMDFN000
.
          MOVE      "pmsevtaf",OPFILE
          MOVE      TEN6,FILENUM
          CALL      OMDFN000
.
          MOVE      "allrefaf",OPFILE
          MOVE      TEN7,FILENUM
          CALL      OMDFN000
.
          MOVE      "alldepaf",OPFILE
          MOVE      TEN8,FILENUM
          CALL      OMDFN000
.
          MOVE      "allencaf",OPFILE
          MOVE      TEN9,FILENUM
          CALL      OMDFN000
.
          MOVE      "patvisaf",OPFILE
          MOVE      TWENTY,FILENUM
          CALL      OMDFN000
.
          MOVE      "pmsvx1af",OPFILE
          MOVE      TWENTY1,FILENUM
          CALL      OMDFN000
.
          MOVE      "oprnuraf",OPFILE
          MOVE      TWENTY2,FILENUM
          CALL      OMDFN000
.
          MOVE      "emrlocaf",OPFILE
          MOVE      TWENTY3,FILENUM
          CALL      OMDFN000
.
          MOVE      "outxscaf",OPFILE
          MOVE      TWENTY4,FILENUM
          CALL      OMDFN000
.
          MOVE      "outbitaf",OPFILE
          MOVE      TWENTY5,FILENUM
          CALL      OMDFN000
.
          MOVE      "viscmtaf",OPFILE
          MOVE      TWENTY6,FILENUM
          CALL      OMDFN000
.
          MOVE      "outbokaf",OPFILE
          MOVE      TWENTY7,FILENUM
          CALL      OMDFN000
.
          MOVE      "outsitaf",OPFILE
          MOVE      TWENTY8,FILENUM
          CALL      OMDFN000
.
          MOVE      "outbb1af",OPFILE
          MOVE      TWENTY9,FILENUM
          CALL      OMDFN000
.
          MOVE      "outma1af",OPFILE
          MOVE      THIRTY,FILENUM
          CALL      OMDFN000
.
          MOVE      "outrshaf",OPFILE
          MOVE      THIRTY1,FILENUM
          CALL      OMDFN000
.
          MOVE      "outcanaf",OPFILE
          MOVE      THIRTY2,FILENUM
          CALL      OMDFN000
.
          MOVE      "emrsitaf",OPFILE
          MOVE      THIRTY3,FILENUM
          CALL      OMDFN000
.
          GOTO      OPFIL999
.
OPFIL999  MOVE      ZERO,EXIT
          RETURN
+
.------------------------------------------------------------
.         open the required file
.------------------------------------------------------------
OTRF0000  IF        FILENUM = 1
            CLOSE     PATVISA2
            OPEN      PATVISA2,PATH
          ENDIF
.
          IF        FILENUM = 2
            CLOSE     PATMI1A1
            OPEN      PATMI1A1,PATH
          ENDIF
.
          IF        FILENUM = 3
            CLOSE     AAEDE1A1
            OPEN      AAEDE1A1,PATH
          ENDIF
.
          IF        FILENUM = 4
            CLOSE     AAEDI1A1
            OPEN      AAEDI1A1,PATH
          ENDIF
.
          IF        FILENUM = 5
            CLOSE     EMRVISA1
            OPEN      EMRVISA1,PATH
          ENDIF
.
          IF        FILENUM = 6
            CLOSE     OUTDIAG1
            OPEN      OUTDIAG1,PATH
          ENDIF
.
          IF        FILENUM = 7
            CLOSE     OUTBOKA3
            OPEN      OUTBOKA3,PATH
          ENDIF
.
          IF        FILENUM = 8
            CLOSE     OUTBB1A1
            OPEN      OUTBB1A1,PATH
          ENDIF
.
          IF        FILENUM = 9
            CLOSE     OUTMA1A1
            OPEN      OUTMA1A1,PATH
          ENDIF
.
          IF        FILENUM = 10
            CLOSE     OUTSESA1
            OPEN      OUTSESA1,PATH
          ENDIF
.
          IF        FILENUM = 11
            CLOSE     OUTHEDA1
            OPEN      OUTHEDA1,PATH
          ENDIF
.
          IF        FILENUM = 12
            CLOSE     OUTCTYA1
            OPEN      OUTCTYA1,PATH
          ENDIF
.
          IF        FILENUM = 13
            CLOSE     OUTCLIA1
            OPEN      OUTCLIA1,PATH
          ENDIF
.
          IF        FILENUM = 14
            CLOSE     PATTRAN2
            OPEN      PATTRAN2,PATH
          ENDIF
.
          IF        FILENUM = 15
            CLOSE     PATDSCH1
            OPEN      PATDSCH1,PATH
          ENDIF
.
          IF        FILENUM = 16
            CLOSE     PMSEVTA1
            OPEN      PMSEVTA1,PATH
          ENDIF
.
          IF        FILENUM = 17
            CLOSE     ALLREFA1
            OPEN      ALLREFA1,PATH
          ENDIF
.
          IF        FILENUM = 18
            CLOSE     ALLDEPA1
            OPEN      ALLDEPA1,PATH
          ENDIF
.
          IF        FILENUM = 19
            CLOSE     ALLENCA1
            OPEN      ALLENCA1,PATH
          ENDIF
.
          IF        FILENUM = 20
            CLOSE     PATVISA1
            OPEN      PATVISA1,PATH
          ENDIF
.
          IF        FILENUM = 21
            CLOSE     PMSVX1A1
            OPEN      PMSVX1A1,PATH
          ENDIF
.
          IF        FILENUM = 22
            CLOSE     OPRNURA1
            OPEN      OPRNURA1,PATH
          ENDIF
.
          IF        FILENUM = 23
            CLOSE     EMRLOCA1
            OPEN      EMRLOCA1,PATH
          ENDIF
.
          IF        FILENUM = 24
            CLOSE     OUTXSCA1
            OPEN      OUTXSCA1,PATH
          ENDIF
.
          IF        FILENUM = 25
            CLOSE     OUTBITA1
            OPEN      OUTBITA1,PATH
          ENDIF
.
          IF        FILENUM = 26
            CLOSE     VISCMTA1
            OPEN      VISCMTA1,PATH
          ENDIF
.
          IF        FILENUM = 27
            CLOSE     OUTBOKA1
            OPEN      OUTBOKA1,PATH
          ENDIF
.
          IF        FILENUM = 28
            CLOSE     OUTSITA1
            OPEN      OUTSITA1,PATH
          ENDIF
.
          IF        FILENUM = 29
            CLOSE     OUTBB1A1
            OPEN      OUTBB1A1,PATH
          ENDIF
.
          IF        FILENUM = 30
            CLOSE     OUTMA1A1
            OPEN      OUTMA1A1,PATH
          ENDIF
.
          IF        FILENUM = 31
            CLOSE     OUTRSHA1
            OPEN      OUTRSHA1,PATH
          ENDIF
.
          IF        FILENUM = 32
            CLOSE     OUTCANA2
            OPEN      OUTCANA2,PATH
          ENDIF
.
          IF        FILENUM = 33
            CLOSE     EMRSITA1
            OPEN      EMRSITA1,PATH
          ENDIF
.
OTRF9999  RETURN
.
SCODL000  RETURN         * defined for EMRVISTM
HTMS0000  RETURN         * defined for OUTBOATM
VTYSEL00  RETURN         * defined for OUTBOATM
NXTAID00  RETURN         * defined for OUTBOATM
NXTAPP00  RETURN         * defined for OUTBOATM
RSHCNT00  RETURN         * defined for OUTBOATM
.*******************************************************************************
.                    Read/Display Cancellation Comments
.*******************************************************************************
RDCM0000  MOVE      "005",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
RDCM1000  CALL      RKVSCMT1
          BRANCH    OVRCD,RDCM9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      RDCM9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      RDCM9999 IF NOT EQUAL
.
          UNPACK    VSCTDATA,DIM60,DIM40    * only use first 60 chars
          WRITE     HTMLFILE;DIM60
          GOTO      RDCM1000
.
RDCM9999  RETURN
.------------------------------------------------------------
. Ouput Clinic Type for Selected Session (SESSKEYS)
.------------------------------------------------------------
GETCTY00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
.
          MATCH     SP70,SESSKEYS
          GOTO      GETCTY99 IF EQUAL
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,GETCTY99
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,GETCTY99
.
          BRANCH    F1,GETCTY10
.
          WRITE     HTMLFILE;OCTDESC;
          GOTO      GETCTY99
.
GETCTY10  WRITE     HTMLFILE;OCTCTYP;
          GOTO      GETCTY99
.
GETCTY99  RETURN
.------------------------------------------------------------------------
.  Get last patient transfer record info
.------------------------------------------------------------------------
DISWRD00  PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
DISWRD10  CALL      RDPTRAN2
          BRANCH    OVRCD,DISWRD90
.
          MATCH     DTADMN,ADMISSNO
          GOTO      DISWRD90 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      DISWRD90 IF NOT EQUAL
          MOVE      TWARD,DISWARD
          MOVE      TBED,DISBED
          MOVE      TDEPT,DISUNIT
          GOTO      DISWRD99
.
DISWRD90  MOVE      SP8,DISWARD
          MOVE      SP8,DISBED
          MOVE      SP8,DISUNIT
.
DISWRD99  RETURN
+
.------------------------------------------------------------------------
.  Get last invoice number for selected visit
.------------------------------------------------------------------------
GETINV00  PACK      KEY32,URNUMBER,ADMISSNO,Z70
          CALL      RDSINV5
GETINV10  CALL      RDPINV5
          BRANCH    OVRCD,GETINV90
.
          MATCH     URNUMBER,PINVUR
          GOTO      GETINV90 IF NOT EQUAL
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      GETINV90 IF NOT EQUAL
.
          GOTO      GETINV99
.
GETINV90  MOVE      SP70,PINVNO
GETINV99  RETURN
+
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
.
          INC       AAEDE1IO/INC
          INC       AAEDI1IO/INC
          INC       ALLREFIO/INC
          INC       ALLDEPIO/INC
          INC       ALLENCIO/INC
          INC       ALLLNKIO/INC
          INC       EMRSITIO/INC
          INC       EMRDOCIO/INC
          INC       EMRHISIO/INC
          INC       EMRVCDIO/INC
          INC       EMRGRCIO/INC
          INC       EMRICDIO/INC
          INC       EMRLOCIO/INC
          INC       EMRVISIO/INC
          INC       EMRUNKIO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PMSEVTIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATALRIO/INC
          INC       OPRNURIO/INC
          INC       OUTDIAIO/INC
          INC       OUTHEDIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCANIO/INC
          INC       OUTCVTIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSESIO/INC
          INC       OUTBITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBOCIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCTYIO/INC
          INC       OUTRSHIO/INC
          INC       OUTSIPIO/INC
          INC       OUTSITIO/INC
          INC       OUTXSCIO/INC
          INC       OUTXWPIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATINVIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
          INC       PATDSCIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSDUNIO/INC
          INC       PATHOSIO/INC
          INC       PATHSPIO/INC
          INC       PRIITMIO/INC
          INC       PRITHDIO/INC
          INC       VISCMTIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       ALLCASIO/INC
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPMSPX2
          INC       CLEMRVIS
          INC       CLOUTHED
          INC       EMRVISTM
          INC       OUTBOATM
          INC       PATDOCTM
          INC       PATMASTM
          INC       PATVISTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATDSCTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       PATDPATH
          INC       PATGBCRN
          INC       TFILENAM

