.----------------------------------------------------------------------
. Program       : CLIWEB06
.
. Function      : Clinical Notes Server
.                  
. Modifications : 
.
.----------------------------------------------------------------------
. V12.00.14 06.10.2025 Alina Bhari     TSK 0967329
.           Modified lastupdateby to return the a value reference field
. V12.00.13 14.09.2025 DA Sarkies      TSK 0967090
.           Added check for note time (Referral/Emergecy) to DISS1600
. V12.00.12 18/07/2025 Nikitha B       TSK 0966342
.           Added to append PTMXMCCD - Medicare Code at WRPID000
. V12.00.11 03.09.2025 DA Sarkies      TSK 0966046
.           Redirected script to correct location in EMRN1000 after checking
.           date ranges
. V12.00.10 02.09.2025 DA Sarkies      TSK 0966046
.           Redirected script to correct table in EMRN4000 after displaying
.           clinical note to FHIR.
. V12.00.09 02.09.2025 Bella Turco     TSK 0966324
.           Removed ROWCOUNT variable from only displaying last 200 Clinical
.           Note records
. V12.00.08 28.08.2025 DA Sarkies      TSK 0964201
.           Moved 'Emergency' into NOTEDESC for displaying codes in EMR
. V12.00.07 28.08.2025 DA Sarkies      TSK 0964664
.           Added a oomma at the end for last updated    
. V12.00.06 25.08.2025 DA Sarkies      TSK 0964664
.           Updated the date in lastupdated to CCYY-MM-DD
. V12.00.05 25.08.2025 DA Sarkies      TSK 0964663
.           Removed the extra :00 from fields that display date/time
. V12.00.04 22.08.2025 DA Sarkies      TSK 0964660
.           Added lastupdatedby FHIR extension to RESVSN00
. V12.00.03 18/08/2025 Ebon Clements   TSK 0963878
.           Save observation free text for non IP visits - ADDNDD00
. V12.00.02 08/07/2025 Don Nguyen      TSK 0961750
.           Added output tags for the delete by fields (date/time/user) of the
.           Visit Notes table (vismdtaf); VSMD2700/VSMD2800/VSMD2900
. V12.00.01 19/05/2025 Thanh T         TSK 0955096
.           Changed for alphanumeric visit number
.----------------------------------------------------------------------
. V11.05.13 14.09.2025 DA Sarkies      TSK 0967090
.           Added check for note time (Referral/Emergecy) to DISS1600
. V11.05.12 18/07/2025 Nikitha B       TSK 0966342
.           Added to append PTMXMCCD - Medicare Code at WRPID000
. V11.05.11 03.09.2025 DA Sarkies      TSK 0966046
.           Redirected script to correct location in EMRN1000 after checking
.           date ranges
. V11.05.10 02.09.2025 DA Sarkies      TSK 0966046
.           Redirected script to correct table in EMRN4000 after displaying
.           clinical note to FHIR.
. V11.05.09 02.09.2025 Bella Turco     TSK 0966324
.           Removed ROWCOUNT variable from only displaying last 200 Clinical
.           Note records
. V11.05.08 28.08.2025 DA Sarkies      TSK 0964201
.           Moved 'Emergency' into NOTEDESC for displaying codes in EMR
. V11.05.07 25.08.2025 DA Sarkies      TSK 0964664
.           Updated the date in lastupdated to CCYY-MM-DD
. V11.05.06 25.08.2025 DA Sarkies      TSK 0964663
.           Removed the extra :00 from fields that display date/time
. V11.05.05 22.08.2025 DA Sarkies      TSK 0964660
.           Added lastupdatedby FHIR extension to RESVSN00
. V11.05.04 18/08/2025 Ebon Clements   TSK 0963878
.           Save observation free text for non IP visits - ADDNDD00
. V11.05.03 08/07/2025 Don Nguyen      TSK 0961750
.           Added output tags for the delete by fields (date/time/user) of the
.           Visit Notes table (vismdtaf); VSMD2700/VSMD2800/VSMD2900
. V11.05.02 30/01/2025 Peter Vela      TSK 0955314
.           Fixed Mainpoint 4 delete for FHIR API in VISRES00
. V11.05.01 13/12/2024 Peter Vela      TSK 0955314
.           Expanded FHIR API ClinicalImpression functionality
. V11.04.22 13/08/2024 Peter Vela      TSK 0939978
.           Fixed multihospital display in MISC3420 for 004 Suburb, 005 State
. V11.04.21 09/08/2024 Alina Bhari     TSK 0946583     
.           Added ability to record clinical notes against a booking patient
.           when they have medical or theatre booking which is not yet      
.            pre-admitted/admitted-BOKRC1IO,BOKRC1FD,BOKRC1A1,GETPAT85,GETPAT86
. V11.04.20 05/08/2024 Peter Vela      TSK 0948660
.           Fixed extraction of HL7 OBR Segment Variable Copied To OBRSEQ28
. V11.04.19 29/07/2024 Peter Vela      TSK 0939978
.           Fixed Discharge Summary Version Number incrmement in MISC3800
. V11.04.18 18.07.2024 DA Sarkies      TSK 0939978 
.           Changed code to retrieve version number and add one to it, or
.           display one if none found.       
. V11.04.17 04.07.2024 Bella Turco     TSK 0943628 
.           New tag MISC4000 to check if visit has a finalised Discharge Summary
. V11.04.16 27.06.2024 DA Sarkies      TSK 0948535 
.           Recompiled for PATMSXTM
. V11.04.15 26.06.2024 DA Sarkies      TSK 0939978 
.           Removed spans for principal diagnosis
. V11.04.14 26/06/2024 Nikitha Bhaskar TSK 0947665 
.           Recomplied for OBSCNATM.       
. V11.04.13 25.06.2024 DA Sarkies             TSK 0939978
.           Added check to hospital address so that if address is blank, it uses
.           the state set address.
. V11.04.12 24.06.2024 DA Sarkies             TSK 0939978
.           Changed spelling of principle. Removed principal diagnosis line.
.           Added code to select correct description
. V11.04.11 20/06/2024 Thanh T                TSK 0947086
.           Recompiled for PMSHCGTM/PMSHCPTM changes
. V11.04.10 19.06.2024  Bella Turco    TSK 0943628
.           Added new tag MISC3900 for displaying Procedures on Dischage Summary
. V11.04.09 12.06.2024  DA Sarkies     TSK 0939978
.           Added read for hospital fax controlf value 
. V11.04.08 05.06.2024  DA Sarkies     TSK 0939978
.           Added word-wrap style to reaction comments
. V11.04.07 31.05.2024  DA Sarkies     TSK 0939978
.           Changed code to added a record for auditing when MyHR sent.
.           Added blank field if there is no date with the proceedure
. V11.04.06 29.05.2024  DA Sarkies     TSK 0939978
.           Changed styling for spancs for alerts/allergies
. V11.04.05 28.05.2024  DA Sarkies     TSK 0939978
.           Added read for the controlf details of the current hospital
. V11.04.04 04.04.2024  DA Sarkies     TSK 0939978
.           Changed proceedure description to list all as opposed to four.
. V11.04.03 14.03.2024  DA Sarkies     TSK 0939978
.           Added further sections to display information on a discharge
.           summary
. V11.04.02 05.02.2024  DA Sarkies     TSK 0936282
.           Increased size of space for testing of Health Fund Number
. V11.04.01 20/12/2023  Ebon Clements  TSK 0941521
.           Increased free format notes array from 500 to 700 lines - NOTETEXT
. V11.03.07 14.03.2024  DA Sarkies     TSK 0939978
.           Added further sections to display information on a discharge
.           summary
. V11.03.06 20/12/2023  Ebon Clements  TSK 0941521
.           Increased free format notes array from 500 to 700 lines - NOTETEXT
. V11.03.05 03/11/2023  Peter Vela     TSK 0934820
.           Added linked practice to REHCCTO in COPYT000 
.           Recompiled for CLIPRTCD - added linked practice from REHCCTO in
.           PRCPT000 
. V11.03.04 17/10/2023  Ebon Clements  TSK 0888745
.           Populate EMRHISFD created by fields - WRTHIS00
. V11.03.03 05/09/2023  Ebon Clements  TSK 0888745
.           Added clear of EMRHISFD created/update by fields - WRTHIS00
. V11.03.02 07/02/2023  Don Nguyen     TSK 0912141
.           Increased OPTFLDNM variable to 90 characters to cater for longer
.           Text (screening questions) in 'Clinical Results Header Notes' table.
. V11.03.01 29/11/2022  Thanh T        TSK 0907640
.           Changed EXPT0600 and EXPT0600 to get the expect patient note date
.           and time after reading from the Expected Patient Comments Header   
. V11.02.08 28/09/2022  Davin          TSK 0919110
.           Recompiled for DISPVISN - Added NOTEDETL=2 (Display Visit Notes tag)
. V11.02.07 01/09/2022  Thanh T        TSK 0907640
.           Added EXPT0900,EXPT1000,EXPT1100 
. V11.02.06 17/08/2022  Thanh T        TSK 0907640
.           Changed ECMTAB40 to make the Delete By name column not strike
.           through when the the note was deleted
. V11.02.05 15/08/2022  Thanh T        TSK 0907640
.           Changed ECMTAB40 to make the Delete By name column not strike
.           through when the the note was deleted  
. V11.02.04 02/08/2022  Bella Turco    TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.03 29/06/2022  Thanh T        TSK 0907640
.           Added MAIN2600, EXCMMA00, ADEXCM00 and DLEXCM00 for expected
.           patient functionality  
. V11.02.02 01/04/2022  Jill Parkinson Task 0918603
.           Changed reha length from 387 to 418 and rehd from 155 to 398
. V11.02.01 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.04 15/09/2021  Thanh T        TSK 0889595
.           Recompiled for PMSDAUFD changes
. V11.01.03 23/04/2021  Jill Parkinson Task 0903816
.           Cross browser - added id's to input fields
. V11.01.02 15/03/2021  Jill Parkinson Task 0903816
.           Recompiled for OBSCNATM
. V11.01.01 22/02/2021  J.Tan          TSK 0888639
.           Changed patmmbs counter record to DIM3
. V11.00.07 09/12/2020  Thanh T        TSK 0872840
.           Recompiled as PMSPX2TM changes
. V11.00.06 16/11/2020  Thanh T          TSK 0878747
.           Added PATATRFD PATATRIO and PATATRTD for CLIPRTCD
. V11.00.05 21/10/2020  Ebon Clements   TSK 0886441
.           Added No Notes Recorded for this Patient Visit - PMSTTB00
. V11.00.04 21/10/2020  Ebon Clements   TSK 0886441
.           Added medical history table layout 2. No created by details
.           OBSN1100 - OBSTAB00
. V11.00.03 10/09/2020  Thanh T         TSK 0881752
.           Recompiled for OBSCNAPR changes
. V11.00.02 31/08/2020  Thanh T         TSK 0881752
.           Added MAIN2500 for patient attribute locking
.           type = 109
. V11.00.01 03/04/2020  Thanh T         TSK 0879163
.           Recompiled for CLIPRTCD 
.----------------------------------------------------------------------
. V10.15.01 26/11/2019  Don Nguyen      TSK 0880715
.           Added REQUSRID to use a different User Id for Diagnostic Service
.           Request; updated Clinical Results Header accordingly (HEAVAR00).
.           Removed code to build Clinical Results (year-based) tables; RESOPN90
. V10.14.09 04/09/2019  Sunny           TSK 0879924
.           Modified error message at CHKVIS90 
. V10.14.08 04/09/2019  Ebon Clements   TSK 0839582
.           Added update of notes with audit trail to report 6 
.           VISNOT00 - allowupd cgi - Save original notes as a deleted copy
. V10.14.07 11/07/2019  Peter Vela      TSK 0878145
.           Added traps around WRVSCTM1 call
. V10.14.06 21/05/2019  Thanh T.        TSK 0873251
.           Changed ADVSCM00 and ADURCM00 to setup KEY10 with USERID before
.           calling RDWBSE1            
. V10.14.05 03/05/2019  Don Nguyen      TSK 0833548
.           Modified Visit Note Maintenance (VISNOT00) for Add of 
.           Final Discharge Text (Note Type "015") to use the correct 
.           User ID when deleting the Draft Discharge Text (Note Type "014").
.           Added new Update Type (emrhisaf) "DTDRF" / "DTFIN" for 
.           Note Type "014" / "015" and "APNOT" for "016".
. V10.14.04 14/03/2019  J.Tan           TSK 0869642
.           Mod Clinical Notes EMRN0000 to display VSMTTPE=011 & 012
. V10.14.03 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.02 27/02/2019  Thanh T.        TSK 0862617
.           Added UPVSCS00/UPURCS00 for handling the update of UR comments
.           and Visit comments by Supervisor   
. V10.14.01 08/02/2019  Don Nguyen      TSK 0833548
.           Modified VISNOT00 to delete Emergency Discharge Text Draft
.           (Type 014) when adding Emergency Discharge Text Final (Type 015).
.           Added new tags for Emergency Discharge Text (VSMD2400-VSMD2600).
.----------------------------------------------------------------------
. V10.13.02 20/12/2018  Don Nguyen      TSK 0860557
.           Increased size of print VARIABLE to 300
. V10.13.01 12/12/2018  Don Nguyen      TSK 0860557
.           Increased size of OBRSEQ13 (HL7) to 300 for longer Clinical Notes
.----------------------------------------------------------------------
. V10.12.03 28/06/2018  Jill Parkinson Tsk 0859397 
.           Changed update of comments to NOT  change input date/time 
.           when updating a record 
. V10.12.02 18/05/2018  Thanh T.        TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.01 21/02/2018  Thanh Tieu      TSK 0852729          
.           Added nextpage=6 close dframe - WINEXT00
.----------------------------------------------------------------------
. V10.11.14 03/01/2017  Ania P          TSK 0850218 
.           Recompiled for CLIPRTCD
. V10.11.13 14/12/2017  B.G.Ackland     TSK 0835482 
.           Fix FHIR status in ClinicalImpression Output
.           Add CLIWEB06.01.217 for Output of ClinicalImpression
.           22/12/2017  Ania P          TSK 0850218
.           Recompiled for CLIWEB06
. V10.11.12 06/12/2017  Ebon Clements   TSK 0841235
.           Removed send document to MyHR functionality from report 9
. V10.11.11 30/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.10 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.09 03/11/2017  Davin            TSK 0837347 
.           Added Visit Referring hcp/practice tags (hppr0000/misc3300)
. V10.11.08  14.09.2017  B.G.Ackland     TSK 0835482 
.           Added FHIR ClinicalImpression List Output
. V10.11.07 12/10/2017  Ebon Clements     TSK 0841235
.           Added send document to MyHR functionality to report 9
. V10.11.06 28/09/2017  Thanh T.          TSK 0821710
.           Admission/Outpatient Visit Comments enhancement
. V10.11.05 18/09/2017  Thanh T.          TSK 0821710
.           Admission/Outpatient Visit Comments enhancement
. V10.11.04 15.09.2017  B.G.Ackland    TSK 0835482 
.           Fix Cancel Order Update Type C2 to Cancel all associated
. V10.11.03 23/08/2017  Richa Phogat      TSK 0816889
.           Added tag field WBSEGENR in VSMD2300
. V10.11.02 28/07/2017  Thanh T.          TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 20/07/2017  Thanh T.          TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.05 15/07/2017  Thanh T.          TSK 0821710
.           Admission/Outpatient Visit Comments enhancement
. V10.10.04 15/07/2017  Thanh T.          TSK 0821710
.           Admission/Outpatient Visit Comments enhancement
. V10.10.03 21/06/2017  J.Tan             TSK 0840098
.           Added HPFX0000 - Practice Fax number if GP fax no is blank
. V10.10.02 04/05/2017  Don Nguyen        TSK 0837299
.           Fixed MISC3100 (tag %CLIWEB06.09.631) to output PMVXMHOS and added
.           GOTO MISC9999.
. V10.10.01 22/03/2017 Richa Phogat   TSK 0832066                     
.           Changed DVA Card Number and DVA Card colour to be collected from 
.           PMCDCNUM.PMSCCDFD and PMCDDVAC.PMSPX2FD instead of PREPAT.PMIMA1FD
.           and PMPXDVAC.PMIMA1FD          
. V10.08.04 02.11.2016  Ebon Clements     TSK 0305048
.           Added clinical note enquiry functionality
. V10.08.03 27.06.2016  B.G.Ackland       TSK 0821146
.           Added deleted by user name to align column output in 
.           Emergency Notes to Match Notes.
. V10.08.02 20.06.2016  B.G.Ackland       TSK 0821135
.           Secuity fix for reads on WBSE7 index
. V10.08.01 12.05.2016  Ania P          CAR 309601
.           Fixed CLIB90000 writing wrong userid
. V10.07.04 11.01.2016  Ania P          CAR 309601 
.           Added functionality for clinical notes audit
. V10.07.03 21.12.2015  B.G.Ackland     CAR 0807942 
.           New Notes Output Format for HealthECare
. V10.07.02 05/11/2015  Steve Armstrong CAR 303363
.           Recompiled for changes to RESHEAFD
. V10.07.01 19/10/2015  Don Nguyen      CAR 316625
.           Added ALLCASFD/IO and opened file
.----------------------------------------------------------------------
. V10.06.11 21/09/2015  Peter Vela      CAR 315544
.           Fixed previous visit validation in OBFTXR10
. V10.06.10 13/08/2015  Don Nguyen      CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
. V10.06.09 05/08/2015  Ania P          CAR 306161
.           Changes to handle new obsmedaf fields
. V10.06.08 24/07/2015  Davin           CAR 308063
.           Use userid to read security server table (RDWBST1 @ visn1000)
.           Recompiled for OBSCNATM
. V10.06.07 29/06/2015  Ania P          CAR 306161
.           Added include CLOBSMED
.           02.07.2015  B.G.Ackland     CAR
.           Add new tag for Medical History in snippet for Tinymce Template CLIWEB06.03.110
.           Add new tag for Medications in snippet for Tinymce Template CLIWEB06.01.317
. V10.06.06 23/06/2015 Jill Parkinson CAR 3184373             
.           Recompiled for OBSDIATM and added TFILENAM calls to INIT000
. V10.06.05 01/06/2015  Peter Vela      CAR 317493 - 284803
.           Recompiled for OBSCNATM
. V10.06.04 16/04/2015  Ania P          CAR 261630
.           Recompiled for OBSDIATM
. V10.06.03 02/04/2015  J.Tan           CAR 244314
.           Mods to update Dr Billing Complete
. V10.06.02 01/04/2015  Ania P          CAR 306161
.           Added OBMED000
. V10.06.01 18/03/2015  Ania P          CAR 306161
.           Recompiled for OBSMED
. V10.05.10 03/03/2015  Davin           CAR 312550
.           Don't validate admissno on patmi1af if billing comments (eclnot00)
. V10.05.09 26.02.2015  Ebon Clements   CAR 313396
.           Move one to exit after WEBERR00 - VISRES90
.           Branch on exit after call to CANSV000 if a WEBERROR
. V10.05.08 17.02.2015  B.G.Ackland     CAR 312898
.           Fix opening of Results File for Future Dated Orders
. V10.05.07 12/02/2015  Peter Vela      CAR 304847
.           Added deleted by column in DSPTAB00
. V10.05.06 02/02/2015  Ebon Clements   CAR 311919
.           Fixed deleted billing comments display - NOTTAB00
. V10.05.05 27/01/2015  Peter Vela      CAR 304847
.           Move spaces to strikeout variables DSPTAB00
.           Improved %diag handling in EMRDIA00
. V10.05.04 19/12/2015  Peter Vela      CAR 304847
.           Added subfinal flag functionality for EMR Disposition Plan in
.           VISNOT00
.           Added tag for EMR Disposition Plan in VSCT0000 
.           Added tag for EMR Disposition plan table display VSMD1200
.           Added tag for EMRDCM record VSMD1300
.           Added Update Formaction in VISNOT00
.           15/12/2014  Jill Parkinson  CAR 308063
.           Mods to check cliweb06 security level before adding note
. V10.05.03 20/10/2014  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.05.02 05.07.2014  B.G.Ackland     CAR 304489
.           Ignore Delete Notes in Printing of Notes for Template Based Printing
. V10.05.01 21/07/2014  J.Tan           CAR 291099
.           Mods for Billing Comments
. V10.04.10 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.09 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.08 18/03/2014  Don Nguyen     CAR 295659
.           Modified OBFTXR00 to return previous visit notes (matching type)
. V10.04.07 14.03.2014  Peter McMullen CAR 294083
.           read websecaf using index 7 for SECUREID
. V10.04.06 28.02.2014  B.G.Ackland    CAR 298007
.           Array Out of Bounds Error on COPTOEND not set to Zero
. V10.04.05 21.02.2014  B.G.Ackland    CAR 289483
.           Change OBR-6 to be Requested For Date Time, not Current Date
.           Add Request Date into OBR-27
. V10.04.04 17.01.2014  B.G.Ackland    CAR 289483
.           Make all stationary date field consistent for Century and Year
.           in dates
. V10.04.03 17.01.2014  B.G.Ackland    CAR 289483
.           Replace code removing whitespace from PURNO table variable
. V10.04.02 16.12.2013  B.G.Ackland    CAR 289483
.           Fix Cancel Order Processing option C2
. V10.04.01 13.01.2014  Jill Parkinson CAR 293909
.           Removed ; from write in OBFTX000
.----------------------------------------------------------------------
. V10.03.48 04.12.2013  B.G.Ackland    CAR 289483
.           Don't write clinical note when NULL ADMISSNO Stop I * D
. V10.03.47 25.11.2013  B.G.Ackland    CAR 289483
.           Fix Printing Order by HCP fields 215-231
. V10.03.46 18.11.2013  B.G.Ackland    CAR 289483
.           Added Carat to PV1-3 Location
. V10.03.45 15.11.2013  Patrick Adair  CAR 287361
.           Added option to display/hide Deleted Notes
. V10.03.44 12.11.2013  B.G.Ackland    CAR 289483
.           Added Bed Description to PV1-3 Location
. V10.03.43 12.11.2013  B.G.Ackland    CAR 289483
.           Squeeze spaces from Provider Code for Messaging.
. V10.03.42 08.11.2013  B.G.Ackland    CAR 289483
.           Uppercase the Priority Code
. V10.03.41 08.11.2013  B.G.Ackland    CAR 289483
.           Remove duplicated IN1-26 field 
. V10.03.40 08.11.2013  B.G.Ackland    CAR 289483
.           Added Priority to OBR-27 component 6,8
.           Added PV1-03 for Emergency patients
. V10.03.39 07.11.2013  B.G.Ackland    CAR 289483
.           Strip White Space from Ward Code
. V10.03.38 23.10.2013  B.G.Ackland    CAR 289483
.           Change to printing orders for cabrini.
.           If users profile doctor code is blank then ordering doctor details
.           will be based on the attending doctor.
.           New variable 234 to output the User Name.
. V10.03.37 22.10.2013  B.G.Ackland    CAR 289483
.           Added Hospital Code to PV1-3 Location for inpatients
. V10.03.36 16.10.2013  B.G.Ackland    CAR 289483
.           Don't write progress note on Lab/Path Request if No Admissno
. V10.03.35 24.09.2013  B.G.Ackland    CAR 289483
.           New Tags for Visit Notes Table Printing
. V10.03.34 24.09.2013  B.G.Ackland    CAR 289483
.           New Tags for Visit Notes Table Printing
. V10.03.33 24.09.2013  B.G.Ackland    CAR 288233
.           Added Expected Discharge Date in PV2 for Orders.
. V10.03.32 10/09/2013  Ania P         CAR 290145
.           Added tag %CLIWEB06.09.631 - hospital code
. V10.03.31 03.09.2013  B.G.Ackland    CAR 288233
.           Enable Ordered By Doctor Capture for Nurse based Orders
. V10.03.30 02.09.2013  B.G.Ackland    CAR 288233
.           Write Result Audit Record on New Order
. V10.03.29 29/08/2013  Peter Vela     CAR 290878
.           Move spaces to PMFET001 in CLRPAR00
. V10.03.28 20/08/2013  Don Nguyen     CAR 281660
.           Recompiled for changes to OBSCNATM
. V10.03.27 31.07.2013  Jill Parkinson CAR 289530
.           Fixed read of obsnddaf in VISRES00 (using ADMISSNO not NOTESKEY)
. V10.03.26 15.07.2013  B.G.Ackland   CAR 288223
.           Return latest 50 notes rather than first 50 notes for a visit
. V10.03.25 28.05.2013  Ebon Clements CAR 285948
.           Fixed infinite loop at nursing diagnosis error - UPDNDD90
. V10.03.24 13.05.2013  Peter Vela    CAR 282961
.           Fixed linebreaks @ OBFTX000, for Nursing Diagnosis and
.           Discharge Summary
. V10.02.23 01.05.2013  B.G.Ackland   CAR 
.           Added new note printing tags 210,211 with output of html linebreaks
. V10.03.22 01/05/2013  Don Nguyen        CAR 284625
.           Modified OBSTAB00 & PMSTAB00 to display web user name instead of id
. V10.03.21 22/04/2013  Ebon Clements     CAR 261630
.           Removed port number from temp file name
. V10.03.20 22.04.2013  Peter Vela    CAR 282961
.           Added html linebreaks in OBFTX000
. V10.03.19 05.04.2013  B.G.Ackland   CAR 283694
.           New Template Item form Hospital PMVXMHOS in Order Printing
. V10.03.18 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.17 18.03.2013  B.G.Ackland   CAR 282723
.           Added IN1 Segment to HL7 Order Message 
. V10.03.16 05/03/2013  Patrick Adair   CAR 281898
.           Corrected key for patecda1 and patecoa1 from KEY12 to KEY13
. V10.03.15 19.02.2013  Davin         CAR 281310
.           Added tags for pathspaf (misc2400-misc3000)
. V10.03.14 25.01.2013  Davin         CAR 279636
.           Update adiag1 when adding nursing diagnosis (addndd00)
. V10.03.13 16.01.2013  Davin         CAR 277938
.           Added tag to default past notes for a UR (obftxr00)
. V10.03.12 21.12.2012  B.G.Ackland   CAR 275970 
.           increase Note text Array from 99 to 500 to allow for very big notes
. V10.03.11 16.11.2012  Davin         CAR 256150
.           Added tags for mbs item desc & date (misc2200,misc2300)
. V10.03.10 29.10.2012  Davin         CAR 256150
.           Added 5 new obs text areas (obftx013-obftx017)
. V10.03.09 11.10.2012  Peter Vela    CAR 274563
.           Added zero ur validation to PATNOT00
. V10.03.08 19.09.2012  B.G.Ackland    CAR
.           Add Filter for Printing Notes by Occupational Group
. V10.03.07 28.03.2012  B.G.Ackland    CAR
.           Changes for Cabrini Clinical Orders Messaaging
. V10.03.06 28.03.2012  B.G.Ackland    CAR
.           Changes for Cabrini Printing
. V10.03.05 17.09.2012  Ebon Clements  CAR 273077
.           Open default OP files in user had no OP site - OUTFIL00
. V10.03.04 28.03.2012  B.G.Ackland    CAR 265085
.           Option 9 Failed Read on PATMISAF to Call Clear PATMIS and Not PATMAS
. V10.03.03 21.03.2012  B.G.Ackland
.           Extra Move of OVRCD to EMRFLAG in INIT Section Removed
.           Branch in GETPAT to VISRES fixed
.           Formated Notes Output for Printing Template %CLIWEB06.01.306
.           Add Medication JSON Output
.           Added h4 tag in Notes Print Output to for Bookmarks in PDF Generation
. V10.03.02 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.01 29/11/2011  Jill Parkinson CAR 249362
.           Changed keys for alert tables
. V10.02.02 20/10/2011  Jill Parkinson CAR 251548
.           Added output of outtimXX for discharge summary
. V10.02.01 28/03/2011  Mike Laming   CAR 240107
.           Mods to PATECDaf & PATECOaf variables & Keys - file change
. V10.01.04 28/02/2011  Jill Parkinson  CAR 
.           Fixed rep " 0" for OBACTME
. V10.01.03 18/01/2011  Jill Parkinson  CAR 236825
.           Fixed setting of obftx010
. V10.01.02 23/11/2010  Jill Parkinson  CAR 233199
.           Added MEDCD001 - Coming from coding screen
. V10.01.01 09/11/2010  Davin            CAR 233227
.           Added option 12 - Eclipse Notes
. V10.00.06 14/10/2010  Davin            CAR 225374
.           Added option 11 - fees estimate text maintenance
. V10.00.05 04/10/2010  Jill Parkinson   CAR 207094
.           Added new care plan fields - obsftxaf
. V10.00.04 15/09/2010  Saroeun Soeur    CAR 230973
.           Recomplied for OBSCNATM
. V10.00.03 18/08/2010  Davin            CAR 223805
.           Recompiled for PATVISTM
. V10.00.02 05/05/2010  Jill Parkinson  CAR 207094
.           Added output of COUNTVER
. V10.00.01 23/02/2010  Jill Parkinson  CAR 207094
.           Added output of OBCATX1 
. V9.12.06  18/02/2010  Jill Parkinson  CAR 188324
.           Added icd descriptions              
. V9.12.05  11/02/2010  Jill Parkinson  CAR 188324
.           Added GP fax number and allergies
. V9.12.04  07/01/2009  Jill Parkinson CAR 207094
.           Added MISC0000 for hea discharge summary
. V9.12.03  16/09/2009  WeeLee Koo     CAR 188324
.           Added Admission Date,Discharge Date, Attending Doc and
.           Secondary Doc (GPDT00)
. V9.12.02  03/08/2009  WeeLee Koo     CAR 188324
.           Changed Admitting Diagnosis Display (GPDT1600)
. V9.12.01  22/07/2009  WeeLee Koo     CAR 188324
.           Added GPDT0000 to display GP details
. V9.11.01  17/10/2008  Peter Vela     CAR 180951
.           Changed NOTTAB00 to display full user name instead of user code.
. V9.09.02  13/11/2007  Peter Vela     CAR 151199
.           Added status 4 cancelled emergency visits  
. V9.09.01  05/07/2007  Jill Habasque  CAR 140514
.           Recompiled for OBSCNATM
. V9.08.06  12/04/2007  Jill Habasque  CAR 135870 and 136143
.           Change onblur to onchange MEDDET00 and added quotes around OBMEDURA
. V9.08.05  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.04  21/12/2006  Jill Habasque CAR 128819
.           Mods to delete obscnbaf records and then rewrite
. V9.08.03  30/11/2006  Jill Habasque CR  121320
.           Recompiled for OBSCNATM
. V9.08.02  26/10/2006  Jill Habasque CAR 121320
.           Added medication code field 
. V9.08.01  25/10/2006  Jill Habasque CAR 121320
.           Added copy Discharge Summary
. V9.07.01  06/09/2006  Jill Habasque CAR 103377
.           Added New Discharge Summary                          
. V9.06.01  26/04/2006  Ebon Clements CAR 102727
.           Fixed display of blank lines in VSMD0900             
.           Do not save more than one blank line in ADDNOT00
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B02 23/12/2005 Davin S       CAR 76341
.           Added report option 8 (encounter notes)
. V9.05.B01 14/12/2005 Davin S       CAR 76341
.           Added report option 7 (referral notes)
. V9.04.06  22/09/2005 Ebon Clements CAR 71778
.           Added next and prev for note type maintenance
. V9.04.05  19/08/2005 Ebon Clements CAR 71403
.           Added deleted by details to OBSMDTFD and added supervisor delete
. V9.04.04  18/08/2005 Ebon Clements CAR 70778
.           Changed error message text when deleting notes
. V9.04.03  20/06/2005 Ebon Clements CAR 59678
.           Added Doctor notes to report 6 history - Update type DCNOT
. V9.04.02  30/05/2005 Ebon Clements CAR 59676
.           Added write to emergency history to report 6 visit based notes
. V9.04.01  13/01/2005 Ebon Clements CAR 56056
.           Added report 6 visit based comments
. V9.03.04  09/07/2004 Peter Vela CAR 50359
.           Added "Delete By" column in Patient Notes table
.           Added functionality to enter username and password in delete patient
.           notes supervisor screen
. V9.03.03  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.02  26/03/2004  Peter Vela CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter 
.           10/02/2004  Peter Vela CAR 38290
.           Added functionality for opening yearly RESLNKFD files
.           (reln1999, reln2000, reln2001, reln2002, etc...)
. V9.03.01  13/10/2003  Davin         CAR 39038
.           Recompiled for change to viscmtfd
. V9.02.05  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.04  16/12/2002 Jill Habasque SRF 34657
.           Added attending and referring doctor link types (07 and 08)
. V9.02.03  13/11/2002 Ebon Clements            SRF 22705
.           Added report 5 for patient notes.           
. V9.02.02  09/10/2002 Peter Vela               SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.01  03/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.02  12.08.2001 Kuldeep- HPS
.           Updating existing notes causes part of the notes to disappear
. V9.00.01  15.07.2001 Bronko Sosic   
.           Added Option 3 & 4     
. V9.00.B03 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B02 14.06.2001 B.G.Ackland
.           Fix Codes Output
.----------------------------------------------------------------------
.                 V5.09.02 12/01/2001 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.03 28/09/2000 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.02 16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.01 07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM
.                 V5.08.00 19/04/2000 Pat Dirito
.                          Fixed Option 2 to use UPDTTYPE 
.-----------------------------------------------------------------------
.                 V5.07.08 23/03/2000 Bronko Sosic
.                          Added startkey for GOTO button
.                 V5.07.07 15/02/2000 Pat Dirito    
.                          Added javascript control to ShowDetail
.                 V5.07.06 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.05 12/01/2000  Bronko Sosic
.                          Recompiled for OBSCNATM
.                 V5.07.04 12/01/2000  Bronko Sosic
.                          Fixed CYY, Added REP " 0"
.                 V5.07.03 20/12/1999  Katie Nelson      
.                          Recompiled for IBAWEBDF/IBAWEBCD 
.                 V5.07.02 03/11/1999  Katie Nelson      
.                          Recompiled for WEBDATCD/DAYOFWEK 
.                 V5.07.01 19/09/1999  Nicole Harrington
.                          Port from 6.06
.----------------------------------------------------------------------
. Modifications : V6.05.01 02.02.1999 Andrew Peel
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       OBSDIATD
          INC       VISCMTDF
          INC       PATDHEAD/INC
.
          INC       ALLCASFD/INC
          INC       ALLCONFD/INC
          INC       ALLENCFD/INC
          INC       ALLREFFD/INC
          INC       ALLMDTFD/INC
          INC       ALLMTXFD/INC
          INC       APSMASFD/INC
.
          INC       BOKRC1FD/INC  
.
          INC       EMRDCMFD/INC
          INC       EMRVISFD/INC
          INC       EMRHISFD/INC
          INC       EMRUNKFD/INC
          INC       OBSPCOFD/INC
          INC       OBSNDDFD/INC
          INC       OBSFTXFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       OUTMA1FD/INC
          INC       PATALRFD/INC
          INC       PMSWORFD/INC
          INC       PMSALAFD/INC
          INC       PMSALNFD/INC
          INC       PATASFFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATHSPFD/INC
          INC       PATIN1FD/INC
          INC       PATPR1FD/INC
          INC       PATCALAG/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       EMREXPFD/INC
          INC       EMRECHFD/INC
          INC       EMRECLFD/INC
.
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATVISFD/INC
          INC       PMSVX1FD/INC
          INC       PMSPODFD/INC
          INC       PATMA1FD/INC
          INC       PATCMCFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATITMFD/INC
          INC       PATMMBFD/INC
          INC       PATRE1FD/INC
          INC       PATATRFD/INC
          INC       PMSADCFD/INC
          INC       PMSFETFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATDSCFD/INC
          INC       PATMI1FD/INC
          INC       PATTRNFD/INC
          INC       PATNURFD/INC
          INC       PATWR1FD/INC
          INC       HL7CODFD/INC
          INC       PMSHCLFD/INC
          INC       RESAUDFD/INC
          INC       RESCTAFD/INC
          INC       RESLNKFD/INC
          INC       RESLURFD/INC
          INC       RESHEAFD/INC
          INC       RESHEBFD/INC
          INC       RESHEDFD/INC
          INC       RESHECFD/INC
          INC       PMSCCDFD/INC
          INC       RESLABFD/INC
          INC       TFILEVAR/INC
          INC       OUTSITFD/INC
          INC       PATFN1FD/INC
          INC       MRTMASFD/INC
          INC       PMSDAUFD/INC
.
          INC       PATATRTD/INC
.
          INC       OBSCNAFD/INC
          INC       OBSCNBFD/INC
          INC       OBSCNCFD/INC
          INC       OBSDIAFD/INC
          INC       OBSDITFD/INC
          INC       OBSMEDFD/INC
          INC       OBSRESFD/INC
          INC       OBSBHIFD/INC
          INC       OBSBPHFD/INC
          INC       OBSLABFD/INC
          INC       OBSPHYFD/INC
          INC       OBSCALFD/INC
          INC       OBSPROFD/INC
          INC       OBSREAFD/INC
          INC       OBSPINFD/INC
.
          INC       OBSMDTFD/INC
          INC       OBSMTXFD/INC
          INC       PMSMDTFD/INC
          INC       PMSMTXFD/INC
          INC       VISCTMFD/INC
          INC       VISCMTFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       IBATMDFD/INC
.
          INC       PATWVEFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATMISTD/INC
.
ALLOWUPD  DIM       1                       * Allow update of notes
AUDHRS    DIM       2
AUDMIN    DIM       2
AUDTIME   DIM       5
AUDDATE   DIM       8
AUDUSER   DIM       10
DISPDATE  DIM       11
DISPTIME  DIM       8
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
VSTXUNIQ  FORM      3
URCMTFLG  FORM      1
URCMTLIN  FORM      3
URTXUNIQ  FORM      3
EXPCMFLG  FORM      1
EXPCMLIN  FORM      3
CLINECNT  FORM      3
QRYDATA1  DIM       240
.
HTMLOUTF  FORM      1
BLNKFLAG  FORM      1
CASEKEYS  DIM       28
COUNT     FORM      3  
COUNTVER  FORM      3
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
CHKNTSEC  FORM      1
DISUM002  DIM       8
DISUM003  DIM       8
FRSTPASS  FORM      1        * First pass flag (1 - true)
MEDCD001  DIM       1
.
PREVVISN  DIM       8
.
UNILABC   DIM       3
UNISEGF   DIM       5
UNISCHE   DIM       12
UNICODE   DIM       12
UNIDESC   DIM       50
.
SAVKEY11  DIM       11
SAVKEY12  DIM       12
SAVKEY13  DIM       13
SAVKEY15  DIM       15
SERVPRI   DIM       15
SERVCODE  DIM       10
SERVDESC  DIM       40
SERVDSSC  DIM       5 
SERVLABC  DIM       3 
.
RESULTKY  DIM       17
RESULTYR  DIM       4
YEAROPEN  DIM       4
UNIQUEID  FORM      4
PREAEA    INIT      "reau"   
PREHEA    INIT      "reha"
PREHEB    INIT      "rehb"
PREHEC    INIT      "rehc"
PREHED    INIT      "rehd"
PREDEA    INIT      "reda"
PREDEB    INIT      "redb"
PREDEC    INIT      "redc"
PRELEN    INIT      "reln"    * I CAR 38290
.
CMNDLINE  DIM       127
LINKTYPE  DIM       2
LINKKEYS  DIM       10
MEDCOUNT  FORM      3
.
UPDTTYPE  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
UPDATETY  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
UPDATET2  FORM      1
. for medical notes
EXISTFLG  DIM       1         * Comment Exist flag
COMUPFLG  DIM       1         * Comment update flag
COMMTYPE  DIM       1         * Comment type
CURRDATE  DIM       8         * Current date
CURRTIME  DIM       8         * Current time
SHOWCOMM  DIM       1         * Show visit comments type (C)comments
.                                                        (D)Deleted comments
CMNTDATE  DIM       11  
CMNTTIME  DIM       8
EXPTUNIQ  DIM       10
DELTFLAG  DIM       1
.
COMFILAF  FILE      ASCII, FIXED=127
COMFILBF  FILE      ASCII, FIXED=127
COMFILVF  FILE      ASCII, FIXED=127        * For visit Notes
FTXFILAA  FILE      ASCII, FIXED=127
FTXFILBB  FILE      ASCII, FIXED=127
FTXFILCC  FILE      ASCII, FIXED=127
FTXFILDD  FILE      ASCII, FIXED=127
FTXFILEE  FILE      ASCII, FIXED=127
FTXFILFF  FILE      ASCII, FIXED=127
FTXFILGG  FILE      ASCII, FIXED=127
FTXFILHH  FILE      ASCII, FIXED=127
FTXFILII  FILE      ASCII, FIXED=127
FTXFILJJ  FILE      ASCII, FIXED=127
FTXFILKK  FILE      ASCII, FIXED=127
FTXFILLL  FILE      ASCII, FIXED=127
FTXFILMM  FILE      ASCII, FIXED=127
FTXFILNN  FILE      ASCII, FIXED=127
FTXFILOO  FILE      ASCII, FIXED=127
FTXFILPP  FILE      ASCII, FIXED=127
FTXFILQQ  FILE      ASCII, FIXED=127
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
COMURCAF  FILE      ASCII, FIXED=127
COMURCNM  DIM       8
COMEXPAF  FILE      ASCII, FIXED=127
COMEXPNM  DIM       8
.
COMFILNM  DIM       8
COMFILNB  DIM       8
COMFILNV  DIM       8
.
EXCMTTYP  INIT      "001"      Expect Patient Comment Type
EXCMLINE  DIM       100        Expect Patient Comment Line
EXCMUSRN  DIM       30         Expect Patient Comment User Name
EXCMDATE  DIM       12         Expect Patient Comment Date
EXCMNOFS  FORM      3          Expect Patient Number of comment to be shown
.
FTXNAMAA  DIM       8
FTXNAMBB  DIM       8
FTXNAMCC  DIM       8
FTXNAMDD  DIM       8
FTXNAMEE  DIM       8
FTXNAMFF  DIM       8
FTXNAMGG  DIM       8
FTXNAMHH  DIM       8
FTXNAMII  DIM       8
FTXNAMJJ  DIM       8
FTXNAMKK  DIM       8
FTXNAMLL  DIM       8
FTXNAMMM  DIM       8
FTXNAMNN  DIM       8
FTXNAMOO  DIM       8
FTXNAMPP  DIM       8
FTXNAMQQ  DIM       8
.
CLNOTEID  DIM       4                       * Clinical Note ID 
CLNOT001  DIM       3                       * Type fo Note 
CLNOT002  DIM       3                       * Highlight Level
CLNOT003  DIM       2                       * Security Level
CLNOT004  DIM       1                       * Inactive 0=No 1=Yes
CLNOT005  DIM       6                       * Time Used in Minutes
CLNOT006  DIM       60                      * Main Point 1
CLNOT007  DIM       60                      * Main Point 2
CLNOT008  DIM       60                      * Main Point 3
CLNOT009  DIM       60                      * Main Point 4
CLNOT010  DIM       3                       * User Def Code 1 (Cat xx)
CLNOT011  DIM       3                       * User Def Code 2 (Cat xx)
CLNOT012  DIM       3                       * User Def Code 3 (Cat xx)
CLNOT013  DIM       3                       * User Def Code 4 (Cat xx)
CLNOT014  DIM       3                       * User Def Code 5 (Cat xx)
CLNOT015  DIM       3                       * User Def Code 6 (Cat xx)
CLNOT016  DIM       3                       * User Def Code 7 (Cat xx)
CLNOT017  DIM       3                       * User Def Code 8 (Cat xx)
CLNOT018  DIM       1                       * User Def Y/N 1
CLNOT019  DIM       1                       * User Def Y/N 2
CLNOT020  DIM       1                       * User Def Y/N 3
CLNOT021  DIM       1                       * User Def Y/N 4
CLNOT022  DIM       8                       * User Def Date 1 
CLNOT023  DIM       8                       * User Def Date 2 
CLNOT024  DIM       35                      * Type of Note Description 
CLNOT025  DIM       3                       * Input Template ID 
CLNOT026  DIM       3                       * Output Template ID 
CLNOT027  DIM       8                       * User Def Time 1 
CLNOT028  DIM       8                       * User Def Time 2 
CLNOT029  DIM       127                     * Free text field
.
MBIRURNO  DIM       8
MBIRTYOR  DIM       24
.
OBNDD001  DIM       8
OBNDD002  DIM       80
OBNDD003  DIM       80
OBNDD004  DIM       80
OBNDD005  DIM       80
OBNDD006  DIM       80
OBNDD007  DIM       80
OBNDD008  DIM       80
OBNDD009  DIM       80
OBNDD010  DIM       80
OBNDD011  DIM       80
OBNDD012  DIM       80
OBNDD013  DIM       80 
ORDERHCP  DIM       10 
.
ADMDATE   DIM       8                       * Admission Date
DSCDATE   DIM       8                       * Discharge Date
DSCDCODE  DIM       3                       * Discharge Destination Code
DSCDEST   DIM       20                      * Discharge Destination Desc
DISP200   DIM       200
CMO       DIM       50                      * Secondary Doc
VMO       DIM       50                      * Attending Doc
LMO       DIM       50                      * Local/Registered GP
RP        DIM       80
DIAGNOS   DIM       50                      * All Diagnosis
DIAGNOS1  DIM       9
DIAGNOS2  DIM       9
DIAGNOS3  DIM       9
DIAGNOS4  DIM       9
PROCED    DIM       50                      * All Operation Procedures
PROC1     DIM       9
PROC2     DIM       9
PROC3     DIM       9
PROC4     DIM       9
TPROCED   DIM       50                      * All Theatre Procedures
TPROC1    DIM       9
TPROC2    DIM       9
TPROC3    DIM       9
TPROC4    DIM       9
ADMDIAG   DIM       101
UNPLANRE  DIM       20
ADVERSE   DIM       300                     * All Adverse Outcomes
ADVERS1   DIM       30
ADVERS2   DIM       30
ADVERS3   DIM       30
ADVERS4   DIM       30
ADVERS5   DIM       30
ADVERS6   DIM       30
ADVERS7   DIM       30
ADVERS8   DIM       30
GP        DIM       10      
GPPRAC    DIM       10
GPADD1    DIM       60
GPADD2    DIM       60
GPADD3    DIM       60
GPADD4    DIM       60
GPADD5    DIM       60
GPADD6    DIM       60
GPPCODE   DIM       8
GPSTATE   DIM       4
DIM3      DIM       3
DIM4      DIM       4
.
OPTFLDNM  DIM       90[100]                 * Option Field Name
OPTFLDVL  DIM       70[100]                 * Option Field Value
.
ADIAGNDD  DIM       80                      * admission reason (adiag1)
CLILDESC  DIM       25
DIM5      DIM       5
INCLSUMM  DIM       12[100]
OBMDT001  DIM       6                       * Note Number             
OUTCDESC  DIM       25
VSCTM001  DIM       3                       * comment type
VSCTM002  DIM       70[99]                  * comment
VSCTMIDX  FORM      2
VTYPDESC  DIM       25
.
PMFET001  DIM       3                       * fees est text type
PMFET002  DIM       80[999]                 * fees est text
PMFETIDX  FORM      3
.
SAVEDOCT  DIM       10
SAVENURS  DIM       10
SAVEDRDT  DIM       8
SAVEDRTM  DIM       6
SAVENRDT  DIM       8
SAVENRTM  DIM       6
SERVICEC  DIM       58[50]                  * Multiple Services
COPIESTO  DIM       55[50]                  * Multiple Services
SERVEND   FORM      2                       * Multiple Service End Flag
SERVCNT   FORM      2                       * Multiple Service End Flag
SVPXABRG  DIM       3                       * Aboriginality (Cat VA
SVPXHOML  DIM       1                       * Homeless (Y/N)
SVPXINTR  DIM       1                       * Interpreter Required? (Y/N)
.
DIM2A     DIM       2                       * Time in Hours 
DIM2B     DIM       2                       * Time in Minutes
DIM50     DIM       50
DIM100    DIM       100
DIM127A   DIM       127
DOCTCODE  DIM       6                       * Doctor Code
ENCOUNTN  DIM       8                       * encounter number
ENCOUTKY  DIM       16                      * admission & encounter number
FORMACTN  DIM       2                       * Form Action 
ORDERTYP  DIM       1                       * order type ORC
FORM8     FORM      8                       * Form 8
HISTTYPE  DIM       5                       * History file record type
HOUR      DIM       2
FTX001EX  FORM      3                       * obftx001 field exists on page
FTX002EX  FORM      3                       * obftx002 field exists on page
FTX003EX  FORM      3                       * obftx003 field exists on page
FTX004EX  FORM      3                       * obftx004 field exists on page
FTX005EX  FORM      3                       * obftx005 field exists on page
FTX006EX  FORM      3                       * obftx006 field exists on page
FTX007EX  FORM      3                       * obftx007 field exists on page
FTX008EX  FORM      3                       * obftx008 field exists on page
FTX009EX  FORM      3                       * obftx009 field exists on page
FTX010EX  FORM      3                       * obftx010 field exists on page
FTX011EX  FORM      3                       * obftx011 field exists on page
FTX012EX  FORM      3                       * obftx012 field exists on page
FTX013EX  FORM      3                       * obftx013 field exists on page
FTX014EX  FORM      3                       * obftx014 field exists on page
FTX015EX  FORM      3                       * obftx015 field exists on page
FTX016EX  FORM      3                       * obftx016 field exists on page
FTX017EX  FORM      3                       * obftx017 field exists on page
LASTDRUG  FORM      3
LASTDOSF  FORM      3
LASTDOSA  FORM      3
LASTFREQ  FORM      3
LASTDURA  FORM      3
LASTQUAN  FORM      3
LASTINST  FORM      3
LASTMCOD  FORM      3
LASTSTAT  FORM      3
LASTCHGD  FORM      3
LASTCHGR  FORM      3
LASTNOTE  FORM      3
LASTREAS  FORM      3
LASTSCDT  FORM      3
LASTDRBR  FORM      3
LASTINCL  FORM      3
LASTITEM  FORM      3                       * Last Item of FF Notes
LSTFT001  FORM      3                       * Last Item of obftx001 field
LSTFT002  FORM      3                       * Last Item of obftx002 field
LSTFT003  FORM      3                       * Last Item of obftx003 field
LSTFT004  FORM      3                       * Last Item of obftx004 field
LSTFT005  FORM      3                       * Last Item of obftx005 field
LSTFT006  FORM      3                       * Last Item of obftx006 field
LSTFT007  FORM      3                       * Last Item of obftx007 field
LSTFT008  FORM      3                       * Last Item of obftx008 field
LSTFT009  FORM      3                       * Last Item of obftx009 field
LSTFT010  FORM      3                       * Last Item of obftx010 field
LSTFT011  FORM      3                       * Last Item of obftx011 field
LSTFT012  FORM      3                       * Last Item of obftx012 field
LSTFT013  FORM      3                       * Last Item of obftx013 field
LSTFT014  FORM      3                       * Last Item of obftx014 field
LSTFT015  FORM      3                       * Last Item of obftx015 field
LSTFT016  FORM      3                       * Last Item of obftx016 field
LSTFT017  FORM      3                       * Last Item of obftx017 field
LASTUPDT  DIM       8                       * Last Update Date
LASTUPTM  DIM       8                       * Last Update Time 
LINKTYP   DIM       1                       * 0=Desc 1=Code 2=Select List
LINKNUM   DIM       2                       * Number of Notes to Display
MBSDESC   DIM       40
MEDDET    FORM      1                       * Flag for std (0) or hea (1) html layout
MIN       DIM       2
NEXTPAGE  FORM      1                       * Next Page ?
NOTEID    FORM      4                       * Note ID
NOTEDETL  DIM       1                       * Note display details flag
NOTEFILT  DIM       3                       * Note display filter (Note Type)
NOTEORDR  FORM      1                       * Display notes order
NOTESKEY  DIM       12                      * Noteskey
NOTETEXT  DIM       127[700]                * FF Notes Text 
NOTEUSER  DIM       10                      * Note User ID (VSMDUSER)
SAVEUSER  DIM       10                      * Saved Note User ID
RESLNKFL  DIM       8                       * File name var for reslnk CAR 38290
SEC       DIM       2
SELECTIO  DIM       1                       * Select IO Template No.
SP60      DIM       60                      * Space 60
STARTNOT  FORM      4                       * Start Number of Notes to Display
STARTKEY  DIM       10                      * Starting Key
SUBFINAL  DIM       1
TXTLEN    FORM      3                       * Text Length
UPDATEKY  DIM       16                      * Update Key
CTR       FORM      1                       * Counter
NOTENUMB  DIM       6                       * note number
NOTETYPE  DIM       3                       * note type  
OCCGROUP  DIM       3                       * occupational group
NILOPRTN  DIM       1                       * Display "X" (no operation perform)
NILADVOC  DIM       1                       * Display "X" (no adverse outcomes)
FBOKDATE  DIM       12                      * Display Date 
FDELDATE  DIM       12                      * Display Delete Date
SHOWDLTD  DIM       1                       * Show Deleted Comments
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
SUPRFLAG  DIM       1                       * Supervisor flag for del pat notes
.                                                                      *I-50359
CROSS     INIT      "X"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATOCG    INIT      "w0"                    * Category Occupational Group
CATHLV    INIT      "w2"                    * Category Highlight Level
CATUC1    INIT      "wa"                    * Category User Def Code 1
CATUC2    INIT      "wb"                    * Category User Def Code 2  
CATUC3    INIT      "wc"                    * Category User Def Code 3 
CATUC4    INIT      "wd"                    * Category User Def Code 4
CATUC5    INIT      "we"                    * Category User Def Code 5
CATUC6    INIT      "wf"                    * Category User Def Code 6
CATUC7    INIT      "wg"                    * Category User Def Code 7
CATUC8    INIT      "wh"                    * Category User Def Code 8 
CATWI     INIT      "wi"
CATW0     INIT      "w0"
CATW2     INIT      "w2"
C0601017  INIT      "cliweb0601017"
.
DRUCODES  DIM       70[100]                 * Array of Drugs
DOSEFORM  DIM       3[100]                  * Array of Dose Form
DOSAGE    DIM       20[100]                 * Array of Doses
FREQENCY  DIM       3[100]                  * Array of Frequency
DURATION  DIM       20[100]                 * Array of Duration 
QUANTITY  DIM       6[100]                  * Array of Quantity 
INSTRUCT  DIM       127[100]                * Array of Instruction
MEDCODES  DIM       9[100]                  * Array of Medication codes
MEDREASN  DIM       3[100]                  * Array of Medication Reason
MEDSTATS  DIM       3[100]                  * Array of Medication Status
MEDCHNGD  DIM       80[100]                 * Array of Change Description
MEDCHNGR  DIM       3[100]                  * Array of Change Reason
MEDNOTES  DIM       80[100]                 * Array of Notes
MEDDATES  DIM       8[100]                  * Array of Dates
MEDDRBR2  DIM       40[100]                 * Array of 
UNKFLAG   FORM      1
VISITNUM  DIM       4                       * Visit Number
VERSNUMB  FORM      4                       * Discharge Summary Version Number
WEBUSEID  DIM       10                      * Web user id
WBSEC008  DIM       3
EMRFLAG   FORM      1
RESULTSK  DIM       17[50]                  * Multiple Services
.
REQUSRID  DIM       10       * Request User Id (for Diagnostic Service Requests)
.
.------------------------------------------------------------------------------
. hl7 - health level 7 variables
.------------------------------------------------------------------------------
ENCDCHAR  INIT      "^~\&"
PIPE      INIT      "|"
CARAT     INIT      "^"
TILDA     INIT      "~"
AMPERSAN  INIT      "&"
BLANK     INIT      ""
NULL      INIT      "#"#""
MSH       INIT      "MSH"
PID       INIT      "PID"
PV1       INIT      "PV1"
PV2       INIT      "PV2"
IN1       INIT      "IN1"
ORC       INIT      "ORC"
OBR       INIT      "OBR"
HL7V      INIT      "2.3.1"
.
ANSNW     INIT      "NW"
ANSCA     INIT      "CA"
SNDAPP    INIT      "webPAS.cliweb06"
RCVFAC    INIT      "MSP"
PROCID    INIT      "P"
MSGTYPE   INIT      "ORM^O01"
ACCATYP   INIT      "NE"
APPATYP   INIT      "AL"
CTRYCODE  INIT      "AU"
MPS       INIT      "MPS"
.
PRN       INIT      "PRN"                         * primary residence number
WPN       INIT      "WPN"                         * primary number
XTNPH     INIT      "PH"                          * xtn id ph = telephone
ZEROFOUR  INIT      "04"
CODINSYS  INIT      "L           "
.
ORDERSFL  INIT      "cli"
ORDRFILE  FILE      ASCII, FIXED=500              * order text file
.
CSEC      DIM       2
DATETIME  DIM       14
DIM6      DIM       6
DIM8      DIM       8
DIM8A     DIM       8
DIM10     DIM       10
DIM12     DIM       12
F12       FORM      12
COPTOCNT  FORM      2
COPTOEND  FORM      2
CMDLINE   DIM       127       * Command line instruction
+
.------------------------------------------------------------------------------
. hl7 - MSH section variables
.------------------------------------------------------------------------------
.
MSHSEQ01  DIM       1                             
MSHSEQ02  DIM       4                             * encoding characters
MSHSEQ03  DIM       180                           * sending application
MSHSEQ04  DIM       180                           * sending facility
MSHSEQ05  DIM       180                           * receiving application
MSHSEQ06  DIM       180                           * receiving facility
MSHSEQ07  DIM       26                            * date time of message
MSHSEQ09  DIM       7                             * message type
MSHSEQ10  DIM       20                            * message control id
MSHSEQ11  DIM       3                             * process id
MSHSEQ12  DIM       60                            * version id
MSHSEQ13  DIM       15                            * sequence number
MSHSEQ15  DIM       2                             * accept ack
MSHSEQ16  DIM       2                             * application ack
MSHSEQ17  DIM       3                             * country code
+
.-----------------------------------------------------------------------------
. hl7 - PID section variables
.-----------------------------------------------------------------------------
.
PIDSEQ01  DIM       4                             * set id
PIDSEQ02  DIM       20                            * patient id
PIDSEQ03  DIM       100                           * patient identifier list
PIDSEQ04  DIM       20                            * alternative patient id
PIDSEQ05  DIM       48                            * patient name
PIDSEQ06  DIM       48                            * mothers maiden name
PIDSEQ07  DIM       26                            * date time of birth
PIDSEQ08  DIM       1                             * sex
PIDSEQ11  DIM       106                           * patient address
PIDSEQ13  DIM       40                            * home phone number
PIDSEQ14  DIM       40                            * business phone number
+
.------------------------------------------------------------------------------
. hl7 - OBR section variables
.------------------------------------------------------------------------------
.
OBRSEQ01  DIM       4                             * set id                    
OBRSEQ02  DIM       22                            * place order number
OBRSEQ04  DIM       200                           * universal service id
OBRSEQ06  DIM       26                            * requested date time
OBRSEQ10  DIM       60                            * collection identifier
OBRSEQ11  DIM       1                             * specimen action code
OBRSEQ13  DIM       300                           * relevant clinical info
OBRSEQ16  DIM       120                           * ordering provider
OBRSEQ24  DIM       10                            * diagnostic service section id
OBRSEQ25  DIM       1                             * result status
OBRSEQ27  DIM       200                           * quantity timing
OBRSEQ28  DIM       300                           * result copies to
+
.-------------------------------------------------------------------------------
. hl7 - OCR section variables
.-------------------------------------------------------------------------------
.
ORCSEQ01  DIM       26                            * order control
ORCSEQ02  DIM       22                            * place order number
ORCSEQ04  DIM       22                            * place group number
ORCSEQ05  DIM       2                             * order status Table 0038.  IP In Progress/CA Cancel
ORCSEQ10  DIM       120                           * entered by
ORCSEQ12  DIM       120                           * ordering provider
+
.------------------------------------------------------------------------------
. hl7 - PV1 section variables
.------------------------------------------------------------------------------
.
PV1SEQ01  DIM       4                             * set id - pv1
PV1SEQ02  DIM       1                             * patient class
PV1SEQ03  DIM       80                            * assigned patient location
PV1SEQ09  DIM       60                            * consulting doctor
PV1SEQ16  DIM       2                             * vip indicator
PV1SEQ20  DIM       50                            * financial class
.------------------------------------------------------------------------------
. hl7 - PV2 section variables
.------------------------------------------------------------------------------
PV2SEQ09  DIM       26                            * Expected Discharge Date and Time - pv2
.------------------------------------------------------------------------------
. hl7 - IN1 section variables
.------------------------------------------------------------------------------
IN1SEQ01  DIM       4                             * set id - pv1
IN1SEQ02  DIM       60                            * Insurance Table
IN1SEQ03  DIM       59                            * Insurance Company
IN1SEQ36  DIM       15                            * Insurance Memebership
+
AMPRSEQN  INIT      "\T\"
.
BEDSTRNG  DIM       3
BLANKSTR  INIT      "#"#""
.
CARDTYPE  FORM      1             * concession card type
FIELDSTR  DIM       200           * string buffer
CATCT     INIT      "ct"
FORM3     FORM      3
FORM5     FORM      5
.                                    3 = DVA
STRBUFFR  DIM       200           * temporary buffer used for converting
.                                          HL7 special characters
DIM20     DIM       20
TILDA40   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
BSLASEQN  INIT      "\E\"
PIPESEQN  INIT      "\F\"
TILDSEQN  INIT      "\R\"
CARTSEQN  INIT      "\S\"
AMPRSAND  INIT      "&"
VARIABLE  DIM       300
HL7TAB    DIM       4
HL7COD    DIM       10
PRNTSTRT  FORM      3
XAGE      DIM       3
XWKAGE    DIM       2
CURRROW   FORM      3
LASTROW   FORM      3
STATNCOD  DIM       6
SAVADMNO  DIM       8
DUDESC    DIM       25
DWDESC    DIM       25
MBDESC    DIM       25
MCDESC    DIM       25
MNDESC    DIM       25
.
ORDERCNT  FORM      3
SAUSPROV  INIT      "^^^AUSPROV"
DASH      INIT      "-"
CLMDET1   DIM       50
CLMDET2   DIM       50
ZERO4     INIT      "0000"
CLAIMCOD  DIM       3
OUTVAR    DIM       127
NOTECODE  DIM       3
NOTEDESC  DIM       20
VISTDESC  DIM       30
EDVISDES  INIT     "Emergency Visit"
OPVISDEC  INIT     "Outpatient Attendance"
IPVISDES  INIT     "Inpatient Episode"
OTVISDES  INIT     "Other Event"
EDVISDAY  INIT     "Day Case"
OPVISCOM  INIT     "Community Visit"
IPVISWRD  INIT     "Ward Attendence"
OTVISAHC  INIT     "Ad-hoc Attendance"
EDVISEVT  INIT     "Event"
OPVISALL  INIT     "Allied Health Visit"
FORMTYPE  DIM       3                       * Form Type for Printing
ORDERDTE  DIM       8
ORDERTIM  DIM       5
LINBREAK  FORM      1
.
ORDERNUM  DIM       20    * Unique Order Number 
APPLICID  DIM       6     * Application ID
PCKDURNO  DIM       8     * UR Stripped of Spaces
FORMATTY  FORM      1     * Output Format Flag
NOTEFORM  FORM      1     * Notes Output Format 
FHIRLOCH  DIM       50
FHIRSTAT  DIM       20
FHRRECID  DIM       21
FHRPATID  DIM       8
FHRENCID  DIM       16
FHRSTAT   DIM       20
TIMEZONE  DIM       20
TZFILE    FILE      ASCII, FIXED=256
.
.------------------------------------------------------------
PRGID     INIT      "CLIWEB06"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Clinical Notes Server"
.------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MAIN1000
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00  * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      VISRES00                *  Output Table of Clinical Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000              
          GOTO      MAIN1000
.
MAIN1200  CALL      DISNOT00                *  Output Table of Clinical Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1300  CALL      MEDNOT00                *  Output Table of Medical Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1400  CALL      VSCMTM00                * Visit Comment Template 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1500  CALL      PATNOT00                *  Output Table of Patient Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1600  CALL      VISNOT00                *  Output Table of Visit Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1700  CALL      REFNOT00                *  Output Table of Referral Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1800  CALL      ENCNOT00                *  Output Table of Encounter Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN1900  CALL      DISSUM00                * Print Discharge Summary
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN2000  CALL      CPDIS000                * Copy discharge summary
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN2100  CALL      FETXTM00                * Fees Estimate Text Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN2200  CALL      ECLNOT00                *  Output Table of Eclipse Notes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN2300  CALL      VSCMMA00                *  Visit Comment Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN2400  CALL      URCMMA00                *  UR Comment Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN2500  CALL      PATATR00                *  Patient Attribute Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN2600  CALL      EXCMMA00                * Expected Patient Comment Maint
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                *  next page
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.------------------------------------------------------------
.  Next Page
.------------------------------------------------------------
NXTPG000  IF        FHIRTYPE=1
            MATCH     "A",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Create Success
              GOTO      NXTPG999
            ENDIF
            MATCH     "D0",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Mark as Deleted Success
              GOTO      NXTPG999
            ENDIF
            MATCH     "D1",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Mark as Deleted Success
              GOTO      NXTPG999
            ENDIF
            MATCH     "D2",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Mark as Deleted Success
              GOTO      NXTPG999
            ENDIF
            MATCH     "D3",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Mark as Deleted Success
              GOTO      NXTPG999
            ENDIF
            MATCH     "D4",FORMACTN
            IF        @EQUAL
              CALL      FHREXT00              * FHIR Mark as Deleted Success
              GOTO      NXTPG999
            ENDIF
          ENDIF
.
          IF        NEXTPAGE=0
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF
.
          IF        NEXTPAGE=1
            CALL      DISPLY00
          ENDIF
.
          IF        NEXTPAGE=2
            CALL      RDIREC00
          ENDIF
.
          IF        NEXTPAGE=3
            CALL      GOBACK10
          ENDIF
.
          IF        NEXTPAGE=4
            CALL      GOBACK20
          ENDIF
.
          IF        NEXTPAGE=5
            CALL      AJAXRT00              * AJAX Post Return
          ENDIF
.
          IF        NEXTPAGE=6
            CALL      WINEXT00              * Close Window
          ENDIF
.
NXTPG999  RETURN
.
.------------------------------------------------------------
.  Redisplay Page - Refresh Screen
.------------------------------------------------------------
AJAXRT00  MOVE      ZERO,EXIT
          CALL      OPENHTML
          BRANCH    EXIT,AJAXRT99
          WRITE     HTMLFILE;"PROCESSING|OK"
          CALL      CLOSHTML
AJAXRT99  RETURN

.
.------------------------------------------------------------
.  Redisplay Page - Refresh Screen 
.------------------------------------------------------------
DISPLY00  CALL      OPENHTML
          BRANCH    EXIT,DISPLY99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    opener.history.go(0);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
DISPLY99  RETURN
.------------------------------------------------------------
.  Go Back 1 Page
.------------------------------------------------------------
GOBACK10  CALL      OPENHTML
          BRANCH    EXIT,GOBACK19
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
GOBACK19  RETURN
.------------------------------------------------------------
.  Go Back 2 Pages
.------------------------------------------------------------
GOBACK20  CALL      OPENHTML
          BRANCH    EXIT,GOBACK29
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    self.close();":
                             "    opener.history.go(-2);":
                             "}":
                             "</script>"
          CALL      OPENHTML
GOBACK29  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00
          CALL      GETTZ000
.
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPDFA1,"ibapdfaf"     * For default printer selection
.
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLMDTA1,"allmdtaf"
          OPEN      ALLMTXA1,"allmtxaf"
.
          OPEN      BOKRC1A1,"bokrc1af"
.
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATNURS1,"patnursm"
          OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSTEA1,"websteaf"
          OPEN      OBSFTXA1,"obsftxaf"
          OPEN      OBSNDDA1,"obsnddaf"
          OPEN      OBSPCOA2,"obspcoaf"
          OPEN      OBSCNAA1,"obscnaaf"
          OPEN      OBSCNBA1,"obscnbaf"
          OPEN      OBSCNCA1,"obscncaf"
          OPEN      OBSCNCA2,"obscncaf"
          OPEN      OBSMDTA1,"obsmdtaf"
          OPEN      OBSMTXA1,"obsmtxaf"
          OPEN      OBSPINA1,"obspinaf"
          OPEN      PMSADCA1,"pmsadcaf"
          OPEN      PMSMDTA1,"pmsmdtaf"
          OPEN      PMSMTXA1,"pmsmtxaf"
          OPEN      PMSPODA1,"pmspodaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf" 
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSHCLA2,"pmshclaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISCTMA1,"visctmaf"    
          OPEN      VISMDTA1,"vismdtaf"    
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PMSUCHA1,"pmsuchaf"    
          OPEN      PMSUCDA1,"pmsucdaf"
          OPEN      EMREXPA1,"emrexpaf"
          OPEN      EMRECHA1,"emrechaf"
          OPEN      EMRECLA1,"emreclaf"
.
          OPEN      EMRDCMA1,"emrdcmaf"     * Diagnosis comment file
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRHISA1,"emrhisaf"
          OPEN      OBSDIAA1,"obsdiaaf"
          OPEN      OBSDITA1,"obsditaf"
          OPEN      OBSMEDA1,"obsmedaf"
          OPEN      OBSRESA1,"obsresaf"
          OPEN      OBSPHYA1,"obsphyaf"
          OPEN      OBSCALA1,"obscalaf"
          OPEN      OBSPROA1,"obsproaf"
          OPEN      OBSREAA1,"obsreaaf"
          OPEN      OBSBHIA1,"obsbhiaf"
          OPEN      OBSBPHA1,"obsbphaf"
          OPEN      OBSLABA1,"obslabaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PMSALNA1,"pmsalnaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSDAUA1,"pmsdauaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      PATATRA3,"patatraf"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSFETA1,"pmsfetaf"
          TRAPCLR   IO
.
          CALL      OPICD1                  * Open ICD Disease files
          CALL      OPICO1                  * Open ICD Operation files
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRUNKA1,"emrunkaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSCCDA1,"pmsccdaf"
          TRAPCLR   IO
.
          OPEN      HL7CODA1,"hl7codaf"
          OPEN      RESLURA1,"resluraf"
          OPEN      RESCTAA1,"resctaaf"
          OPEN      RESLABA1,"reslabaf"
.         OPEN      RESLNKA1,"reslnkaf"            * D CAR 38290
.         OPEN      RESLNKA3,"reslnkaf"            * D CAR 38290
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBATMHA1,"ibatmhaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND14;*87,PTCNRSAP,*95,PTCNRSFC,*103,PTCNRRAP:
                                    *111,PTCNRRFC,*119,PTCNRMIC,*131,PTCNRHLV
          READ      CONTROLF,HUND25;*238,PTCNNRTD
          READ      CONTROLF,TEN3;*1,CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2:
                                     CHPPOST,CHTELEB
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          OPEN      OUTSITA2,"outsitaf"
          MOVE      "out",CFILEPRE       * Save Current File Prefix
          CALL      OPNOUT00
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMVISNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMURCNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMEXPNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNB
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNV
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMAA
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMBB
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMCC
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMDD
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMEE
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMFF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMGG
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMHH
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMII
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMJJ
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMKK
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMLL
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMMM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMNN
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMOO
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMPP
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FTXNAMQQ
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSDIFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSPRFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSREFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSBHFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSBPFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSLBFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSRSFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSPHFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSDTFNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,OBSCAFNM
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.*******************************************************************************
.                    Open Outpateint Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CLIA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
.
OPNOUT99  RETURN
+
.*******************************************************************************
.                     Check Correct Files are Open for System
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
          MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
OUTFIL99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      SP70,NOTENUMB
          MOVE      SP70,NOTETYPE
          MOVE      SP70,FHIRSTAT
          MOVE      SP70,ORDERHCP
          MOVE      SP70,RESULTKY
          MOVE      SP70,FHRRECID
          MOVE      SP70,OCCGROUP
          MOVE      SP70,FORMTYPE
          MOVE      SP70,ORDERDTE
          MOVE      SP70,ORDERTIM
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,ENCOUNTN
          MOVE      SP70,ENCOUTKY
          MOVE      SP70,STARTKEY
          MOVE      SP70,SUBFINAL
          MOVE      SP70,MEDCD001
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,UPDATETY
          MOVE      ZERO,UPDATET2
          MOVE      SP70,SHOWCOMM
          MOVE      SP70,OBMDT001
          MOVE      SP70,VSCTM001
          MOVE      ZERO,COUNT     
          MOVE      ZERO,CHKNTSEC  
          MOVE      ZERO,VSCMTFLG
          MOVE      ZERO,VSCMTLIN
          MOVE      ZERO,URCMTFLG
          MOVE      ZERO,URCMTLIN
          MOVE      ZERO,EXPCMFLG
          MOVE      ZERO,EXPCMLIN
          MOVE      Z70,ALLOWUPD
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
.
          MOVE      SP10,FORMACTN
          MOVE      SP10,ORDERTYP
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP10,UPDATEKY
          MOVE      SP20,NOTESKEY
          MOVE      SP4,CLNOTEID
.
          MOVE      SP3,CLNOT001  
          MOVE      SP1,CLNOT002  
          MOVE      SP1,CLNOT003  
          MOVE      SP1,CLNOT004  
          MOVE      SP6,CLNOT005  
          MOVE      SP60,CLNOT006  
          MOVE      SP60,CLNOT007  
          MOVE      SP60,CLNOT008  
          MOVE      SP60,CLNOT009  
          MOVE      SP3,CLNOT010  
          MOVE      SP3,CLNOT011  
          MOVE      SP3,CLNOT012  
          MOVE      SP3,CLNOT013  
          MOVE      SP3,CLNOT014  
          MOVE      SP3,CLNOT015  
          MOVE      SP3,CLNOT016  
          MOVE      SP3,CLNOT017  
          MOVE      SP1,CLNOT018  
          MOVE      SP1,CLNOT019  
          MOVE      SP1,CLNOT020  
          MOVE      SP1,CLNOT021  
          MOVE      SP8,CLNOT022  
          MOVE      SP8,CLNOT023  
          MOVE      SP70,CLNOT024  
          MOVE      SP3,CLNOT025  
          MOVE      SP3,CLNOT026  
          PACK      CLNOT027,SP70
          PACK      CLNOT028,SP70
          PACK      CLNOT029,SP70,SP70
          MOVE      ZERO,NORECORD
          MOVE      ZERO,STARTNUM
          PACK      SP60,SP20,SP20,SP20
          MOVE      ZERO,COPTOEND
          MOVE      ZERO,SERVEND
          MOVE      SP70,WEBUSEID
          CALL      CLROBD00
          MOVE      Z70,OBSPN001
          MOVE      Z70,OBSPN002
          MOVE      Z70,OBSPN003
          MOVE      Z70,DISUM002
          MOVE      Z70,DISUM003
          MOVE      SP70,WBSEC008
          MOVE      Z70,PREVVISN
.
          MOVE      ZERO,LSTFT001
          MOVE      ZERO,LSTFT002
          MOVE      ZERO,LSTFT003
          MOVE      ZERO,LSTFT004
          MOVE      ZERO,LSTFT005
          MOVE      ZERO,LSTFT006
          MOVE      ZERO,LSTFT007
          MOVE      ZERO,LSTFT008
          MOVE      ZERO,LSTFT009
          MOVE      ZERO,LSTFT010
          MOVE      ZERO,LSTFT011
          MOVE      ZERO,LSTFT012
          MOVE      ZERO,LSTFT013
          MOVE      ZERO,LSTFT014
          MOVE      ZERO,LSTFT015
          MOVE      ZERO,LSTFT016
          MOVE      ZERO,LSTFT017
.
          MOVE      ZERO,FTX001EX
          MOVE      ZERO,FTX002EX
          MOVE      ZERO,FTX003EX
          MOVE      ZERO,FTX004EX
          MOVE      ZERO,FTX005EX
          MOVE      ZERO,FTX006EX
          MOVE      ZERO,FTX007EX
          MOVE      ZERO,FTX008EX
          MOVE      ZERO,FTX009EX
          MOVE      ZERO,FTX010EX
          MOVE      ZERO,FTX011EX
          MOVE      ZERO,FTX012EX
          MOVE      ZERO,FTX013EX
          MOVE      ZERO,FTX014EX
          MOVE      ZERO,FTX015EX
          MOVE      ZERO,FTX016EX
          MOVE      ZERO,FTX017EX
.
          MOVE      Z70,OBNDD001
          MOVE      Z70,OBNDD002
          MOVE      Z70,OBNDD003
          MOVE      Z70,OBNDD004
          MOVE      Z70,OBNDD005
          MOVE      Z70,OBNDD006
          MOVE      Z70,OBNDD007
          MOVE      Z70,OBNDD008
          MOVE      Z70,OBNDD009
          MOVE      Z70,OBNDD010
          MOVE      Z70,OBNDD011
          MOVE      Z70,OBNDD012
          MOVE      Z70,OBNDD013
          CALL      CLOBSNDD
.
          MOVE      SP70,ADMDATE
          MOVE      SP70,DSCDATE
          MOVE      SP70,CMO
          PACK      RP,SP70,SP10         
          MOVE      SP70,DIAGNOS
          MOVE      SP70,DIAGNOS1
          MOVE      SP70,DIAGNOS2
          MOVE      SP70,DIAGNOS3
          MOVE      SP70,DIAGNOS4
          MOVE      SP70,PROCED
          MOVE      SP70,PROC1
          MOVE      SP70,PROC2
          MOVE      SP70,PROC3
          MOVE      SP70,PROC4
          MOVE      SP70,TPROCED
          MOVE      SP70,TPROC1
          MOVE      SP70,TPROC2
          MOVE      SP70,TPROC3
          MOVE      SP70,TPROC4
          MOVE      SP70,NILOPRTN
          MOVE      SP70,ADMDIAG
          MOVE      SP70,UNPLANRE
          MOVE      SP70,NILADVOC
          MOVE      SP70,ADVERSE
          MOVE      SP70,ADVERS1
          MOVE      SP70,ADVERS2
          MOVE      SP70,ADVERS3
          MOVE      SP70,ADVERS4
          MOVE      SP70,ADVERS5
          MOVE      SP70,ADVERS6
          MOVE      SP70,ADVERS7
          MOVE      SP70,ADVERS8
          MOVE      SP70,GP
          MOVE      SP70,GPPRAC
          MOVE      SP70,GPADD1
          MOVE      SP70,GPADD2
          MOVE      SP70,GPADD3
          MOVE      SP70,GPADD4
          MOVE      SP70,GPADD5
          MOVE      SP70,GPADD6
          MOVE      SP70,GPPCODE
          MOVE      SP70,GPSTATE
          MOVE      SP70,FHIRLOCH
          PACK      DISP200,SP70,SP70,SP70,SP70
.
          MOVE      ONE,COUNT
          WHILE     COUNT <= 100
            MOVE      SP70,OPTFLDNM[COUNT]
            MOVE      SP70,OPTFLDVL[COUNT]
            MOVE      SP70,DRUCODES[COUNT]
            MOVE      SP70,DOSEFORM[COUNT]
            MOVE      SP70,DOSAGE[COUNT]
            MOVE      SP70,FREQENCY[COUNT]
            MOVE      SP70,DURATION[COUNT]
            MOVE      SP70,QUANTITY[COUNT]
            MOVE      SP70,INSTRUCT[COUNT]
            MOVE      SP70,MEDCODES[COUNT]
            MOVE      SP70,MEDREASN[COUNT]
            MOVE      SP70,MEDSTATS[COUNT]
            MOVE      SP70,MEDCHNGD[COUNT]
            MOVE      SP70,MEDCHNGR[COUNT]
            MOVE      SP70,MEDNOTES[COUNT]
            MOVE      SP70,MEDDATES[COUNT]
            MOVE      SP70,MEDDRBR2[COUNT]
            ADD       ONE,COUNT
          DO
.
          MOVE      ZERO,F3
CLRPAR50  ADD       ONE,F3                  * Clear FF Notes Array
          IF        F3<=700
            PACK      NOTETEXT[F3],SP70,SP70,SP70
            GOTO      CLRPAR50
          ENDIF
.
          MOVE      ZERO,F3
CLRPAR60  ADD       ONE,F3                  * Clear MD Notes Array
          IF        F3<=99 
            PACK      VSCTM002[F3],SP70,SP70,SP70
            GOTO      CLRPAR60
          ENDIF
.
          MOVE      ZERO,F3
CLRPAR70  ADD       ONE,F3                  * Clear Fees Est Text Array
          PACK      PMFET002[F3],SP70,SP70,SP70
          IF        F3<999
            GOTO      CLRPAR70
          ENDIF
.
          MOVE      ZERO,F3
CLRPAR80  ADD       ONE,F3                  * Clear FF Notes Array
          IF        F3<=50
            PACK      COPIESTO[F3],SP70,SP70,SP70
            PACK      SERVICEC[F3],SP70,SP70,SP70
            PACK      RESULTSK[F3],SP70,SP70,SP70
            GOTO      CLRPAR80
          ENDIF
.
          MOVE      ZERO,VSCTMIDX  
          MOVE      ZERO,PMFETIDX  
          MOVE      SP70,SUPRFLAG           * Clear supervisor flag for del pat
.                                           * notes                    *I-50359
          MOVE      Z70,ADIAGNDD
          PACK      SHOWDLTD,SP70
.
          MOVE      SP70,PMFET001
          MOVE      SP70,NOTEUSER
          MOVE      SP70,REQUSRID
          MOVE      SP70,EXPTUNIQ
          MOVE      SP70,DELTFLAG
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notetype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTETYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrrecid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRRECID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "resultky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESULTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "occgroup=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OCCGROUP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "orderdte=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11         * Change Date format
            PACK      KEY11,KEY11,SP70
            MATCH     SP70,KEY11
            GOTO      SETPAR99 IF EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      ORDERDTE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ORDERDTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ordertim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ORDERTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notenumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTENUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optnam",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY6,KEY2
            MOVE      ZERO,F2
            MOVE      KEY2,F2
            IF        F2>0
              IF        F2<100
                PACK      OPTFLDNM[F2],QRYDATA,SP70
              ENDIF
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "optfld",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY6,KEY2
            MOVE      ZERO,F2
            MOVE      KEY2,F2
            IF        F2>0
              IF        F2<100
                PACK      OPTFLDVL[F2],QRYDATA,SP70
              ENDIF
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servicec=",QRYNAME
          IF        @EQUAL
            ADD       ONE,SERVEND
            PACK      SERVICEC[SERVEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copiesto=",QRYNAME
          IF        @EQUAL
            ADD       ONE,COPTOEND
            PACK      COPIESTO[COPTOEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ordertyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ORDERTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "orderhcp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ORDERHCP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatet2=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATET2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cmntdate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      CMNTDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cmnttime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CMNTTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formactn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMACTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updateky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exptuniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXPTUNIQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deltflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DELTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medcd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nzteskey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTESKEY
            REP       "+ ",NOTESKEY
            UNPACK    NOTESKEY,ADMISSNO,CLNOTEID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clnot",QRYNAME
          IF        @EQUAL
            CALL      CLNOT000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "obndd",QRYNAME
          IF        @EQUAL
            CALL      OBNDD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notetext=",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsdiags=",QRYNAME
          IF        @EQUAL
            CALL      SETOBD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsprocs=",QRYNAME
          IF        @EQUAL
            CALL      SETOBP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsreada=",QRYNAME
          IF        @EQUAL
            CALL      SETOBA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsbhist=",QRYNAME
          IF        @EQUAL
            CALL      SETOBH00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsbphys=",QRYNAME
          IF        @EQUAL
            CALL      SETOBE00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obslabrs=",QRYNAME
          IF        @EQUAL
            CALL      SETOBL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsrestr=",QRYNAME
          IF        @EQUAL
            CALL      SETRES00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsphysi=",QRYNAME
          IF        @EQUAL
            CALL      SETPHY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obsdietd=",QRYNAME
          IF        @EQUAL
            CALL      SETDIT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obscalld=",QRYNAME
          IF        @EQUAL
            CALL      SETCAL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnot=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNOT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "typenote=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTETYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obmdt001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OBMDT001
            PACK      OBMDT001,OBMDT001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obmtx001=",QRYNAME
          IF        @EQUAL
            CALL      GETCOM00 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx001=",QRYNAME
          IF        @EQUAL
            CALL      GETFX100 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx002=",QRYNAME
          IF        @EQUAL
            CALL      GETFX200 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx003=",QRYNAME
          IF        @EQUAL
            CALL      GETFX300 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx004=",QRYNAME
          IF        @EQUAL
            CALL      GETFX400 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx005=",QRYNAME
          IF        @EQUAL
            CALL      GETFX500 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx006=",QRYNAME
          IF        @EQUAL
            CALL      GETFX600 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx007=",QRYNAME
          IF        @EQUAL
            CALL      GETFX700 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx008=",QRYNAME
          IF        @EQUAL
            CALL      GETFX800 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx009=",QRYNAME
          IF        @EQUAL
            CALL      GETFX900 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx010=",QRYNAME
          IF        @EQUAL
            CALL      GETF1000 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx011=",QRYNAME
          IF        @EQUAL
            CALL      GETF1100 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx012=",QRYNAME
          IF        @EQUAL
            CALL      GETF1200 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "obftx013=",QRYNAME
          IF        @EQUAL
            CALL      GETF1300
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obftx014=",QRYNAME
          IF        @EQUAL
            CALL      GETF1400
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obftx015=",QRYNAME
          IF        @EQUAL
            CALL      GETF1500
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obftx016=",QRYNAME
          IF        @EQUAL
            CALL      GETF1600
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obftx017=",QRYNAME
          IF        @EQUAL
            CALL      GETF1700
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmmtx001=",QRYNAME
          IF        @EQUAL
            CALL      GETPCM00 
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "visnotes=",QRYNAME
          IF        @EQUAL
            CALL      GETNOT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVSCM00              * Read in Adm Comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,URCMTFLG
            CALL      GTURCM00              * Read in UR Comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exptcmnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,EXPCMFLG
            CALL      GTEXCM00               * Read in expected pat comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsctm001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VSCTM001
            PACK      VSCTM001,VSCTM001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsctm002=",QRYNAME
          IF        @EQUAL
            CALL      GETCMT00
            GOTO      SETPAR99
          ENDIF      
.
          MATCH     "suprflag=",QRYNAME                                *I-50359
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "webuseid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WEBUSEID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encountn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUNTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoutky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUTKY
            UNPACK    ENCOUTKY,ADMISSNO,ENCOUNTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "meddet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDDET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obspn001=",QRYNAME
          IF        @EQUAL
            PACK      OBSPN001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obspn002=",QRYNAME
          IF        @EQUAL
            PACK      OBSPN002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "obspn003=",QRYNAME
          IF        @EQUAL
            PACK      OBSPN003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disum002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      DISUM002,CCENT,CYEAR,CMON,CDAY
            REP       " 0",DISUM002
          ENDIF
.
          MATCH     "disum003=",QRYNAME
          IF        @EQUAL
            PACK      DISUM003,QRYDATA,SP70
          ENDIF
.
          MATCH     "prevvisn=",QRYNAME
          IF        @EQUAL
            PACK      PREVVISN,QRYDATA,SP70
          ENDIF
.
          MATCH     "drugs",QRYNAME
          IF        @EQUAL
            CALL      STDRU000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dosef",QRYNAME
          IF        @EQUAL
            CALL      STDOS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dosea",QRYNAME
          IF        @EQUAL
            CALL      STDOA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frequ",QRYNAME
          IF        @EQUAL
            CALL      STFRE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "durat",QRYNAME
          IF        @EQUAL
            CALL      STDUR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "quant",QRYNAME
          IF        @EQUAL
            CALL      STQUA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "instr",QRYNAME
          IF        @EQUAL
            CALL      STINS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mcode",QRYNAME
          IF        @EQUAL
            CALL      STMED000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdrbr",QRYNAME
          IF        @EQUAL
            CALL      STDRB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasm",QRYNAME
          IF        @EQUAL
            CALL      STREA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "stats",QRYNAME
          IF        @EQUAL
            CALL      STSTA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngd",QRYNAME
          IF        @EQUAL
            CALL      STCHD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngr",QRYNAME
          IF        @EQUAL
            CALL      STCHR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notes",QRYNAME
          IF        @EQUAL
            CALL      STNOT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdate",QRYNAME
          IF        @EQUAL
            CALL      STDAT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "incls",QRYNAME
          IF        @EQUAL
            CALL      STINC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admdate=",QRYNAME
          IF        @EQUAL
            PACK      ADMDATE,QRYDATA,SP70
          ENDIF
.
          MATCH     "dscdate=",QRYNAME
          IF        @EQUAL
            PACK      DSCDATE,QRYDATA,SP70
          ENDIF
.
          MATCH     "cmo=",QRYNAME
          IF        @EQUAL
            PACK      CMO,QRYDATA,SP70
          ENDIF
.
          MATCH     "rp=",QRYNAME
          IF        @EQUAL
            PACK      RP,QRYDATA,SP70,SP10
          ENDIF
.
          MATCH     "diagnos=",QRYNAME
          IF        @EQUAL
            PACK      DIAGNOS,QRYDATA,SP70
          ENDIF
.
          MATCH     "diagnos1=",QRYNAME
          IF        @EQUAL
            PACK      DIAGNOS1,QRYDATA,SP70
          ENDIF
.
          MATCH     "diagnos2=",QRYNAME
          IF        @EQUAL
            PACK      DIAGNOS2,QRYDATA,SP70
          ENDIF
.
          MATCH     "diagnos3=",QRYNAME
          IF        @EQUAL
            PACK      DIAGNOS3,QRYDATA,SP70
          ENDIF
.
          MATCH     "diagnos4=",QRYNAME
          IF        @EQUAL
            PACK      DIAGNOS4,QRYDATA,SP70
          ENDIF
.
          MATCH     "proced=",QRYNAME
          IF        @EQUAL
            PACK      PROCED,QRYDATA,SP70
          ENDIF
.
          MATCH     "proc1=",QRYNAME
          IF        @EQUAL
            PACK      PROC1,QRYDATA,SP70
          ENDIF
.
          MATCH     "proc2=",QRYNAME
          IF        @EQUAL
            PACK      PROC2,QRYDATA,SP70
          ENDIF
.
          MATCH     "proc3=",QRYNAME
          IF        @EQUAL
            PACK      PROC3,QRYDATA,SP70
          ENDIF
.
          MATCH     "proc4=",QRYNAME
          IF        @EQUAL
            PACK      PROC4,QRYDATA,SP70
          ENDIF
.
          MATCH     "tproced=",QRYNAME
          IF        @EQUAL
            PACK      TPROCED,QRYDATA,SP70
          ENDIF
.
          MATCH     "tproc1=",QRYNAME
          IF        @EQUAL
            PACK      TPROC1,QRYDATA,SP70
          ENDIF
.
          MATCH     "tproc2=",QRYNAME
          IF        @EQUAL
            PACK      TPROC2,QRYDATA,SP70
          ENDIF
.
          MATCH     "tproc3=",QRYNAME
          IF        @EQUAL
            PACK      TPROC3,QRYDATA,SP70
          ENDIF
.
          MATCH     "tproc4=",QRYNAME
          IF        @EQUAL
            PACK      TPROC4,QRYDATA,SP70
          ENDIF
.
          MATCH     "niloprtn=",QRYNAME
          IF        @EQUAL
            PACK      NILOPRTN,QRYDATA,SP70
          ENDIF
.
          MATCH     "admdiag=",QRYNAME
          IF        @EQUAL
            PACK      ADMDIAG,QRYDATA,SP70
          ENDIF
.
          MATCH     "unplanre=",QRYNAME
          IF        @EQUAL
            PACK      UNPLANRE,QRYDATA,SP70
          ENDIF
.
          MATCH     "niladvoc=",QRYNAME
          IF        @EQUAL
            PACK      NILADVOC,QRYDATA,SP70
          ENDIF
.
          MATCH     "adverse=",QRYNAME
          IF        @EQUAL
            PACK      ADVERSE,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers1=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS1,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers2=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS2,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers3=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS3,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers4=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS4,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers5=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS5,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers6=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS6,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers7=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS7,QRYDATA,SP70
          ENDIF
.
          MATCH     "advers8=",QRYNAME
          IF        @EQUAL
            PACK      ADVERS8,QRYDATA,SP70
          ENDIF 
.
          MATCH     "gp=",QRYNAME
          IF        @EQUAL
            PACK      GP,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpprac=",QRYNAME
          IF        @EQUAL
            PACK      GPPRAC,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd1=",QRYNAME
          IF        @EQUAL
            PACK      GPADD1,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd2=",QRYNAME
          IF        @EQUAL
            PACK      GPADD2,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd3=",QRYNAME
          IF        @EQUAL
            PACK      GPADD3,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd4=",QRYNAME
          IF        @EQUAL
            PACK      GPADD4,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd5=",QRYNAME
          IF        @EQUAL
            PACK      GPADD5,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpadd6=",QRYNAME
          IF        @EQUAL
            PACK      GPADD6,QRYDATA,SP70
          ENDIF
.
          MATCH     "gppcode=",QRYNAME
          IF        @EQUAL
            PACK      GPPCODE,QRYDATA,SP70
          ENDIF
.
          MATCH     "gpstate=",QRYNAME
          IF        @EQUAL
            PACK      GPSTATE,QRYDATA,SP70
          ENDIF
.
          MATCH     "pmfet001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMFET001
            PACK      PMFET001,PMFET001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmfet002=",QRYNAME
          IF        @EQUAL
            CALL      GETFET00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "adiagndd=",QRYNAME
          IF        @EQUAL
            PACK      ADIAGNDD,QRYDATA,SP70
          ENDIF
.
          MATCH     "showdltd=",QRYNAME
          IF        @EQUAL
            PACK      SHOWDLTD,QRYDATA,SP70
          ENDIF
.
          MATCH     "fhirstat=",QRYNAME
          IF        @EQUAL
            PACK      FHIRSTAT,QRYDATA,SP70
          ENDIF
.
          MATCH     "subfinal=",QRYNAME
          IF        @EQUAL
            PACK      SUBFINAL,QRYDATA,SP70
          ENDIF
.
          MATCH     "noteuser=",QRYNAME
          IF        @EQUAL
            PACK      NOTEUSER,QRYDATA,SP70
          ENDIF
.
          MATCH     "allowupd=",QRYNAME
          IF        @EQUAL
            PACK      ALLOWUPD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requsrid=",QRYNAME
          IF        @EQUAL
            PACK      REQUSRID,QRYDATA,SP70
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
SETPAR99 RETURN
+
.-----------------------------------------------------------------
. Set Parameters for Discharge Medications
.-----------------------------------------------------------------
STDRU000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDRU999 IF EQUAL
.
          PACK      DRUCODES[F3],QRYDATA,SP70
          MOVE      F3,LASTDRUG
.
STDRU999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Dose Form
.-----------------------------------------------------------------
STDOS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDOS999 IF EQUAL
.
          PACK      DOSEFORM[F3],QRYDATA,SP70
          MOVE      F3,LASTDOSF
.
STDOS999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Dosage  
.-----------------------------------------------------------------
STDOA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDOA999 IF EQUAL
.
          PACK      DOSAGE[F3],QRYDATA,SP70
          MOVE      F3,LASTDOSA
.
STDOA999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Frequency
.-----------------------------------------------------------------
STFRE000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STFRE999 IF EQUAL
.
          PACK      FREQENCY[F3],QRYDATA,SP70
          MOVE      F3,LASTFREQ
.
STFRE999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Duration 
.-----------------------------------------------------------------
STDUR000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDUR999 IF EQUAL
.
          PACK      DURATION[F3],QRYDATA,SP70
          MOVE      F3,LASTDURA
.
STDUR999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Quantity 
.-----------------------------------------------------------------
STQUA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STQUA999 IF EQUAL
.
          PACK      QUANTITY[F3],QRYDATA,SP70
          MOVE      F3,LASTQUAN
.         
STQUA999  RETURN    
.-----------------------------------------------------------------
. Set Parameters for Instructions
.-----------------------------------------------------------------
STINS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STINS999 IF EQUAL
.
          PACK      INSTRUCT[F3],QRYDATA,SP70
          MOVE      F3,LASTINST
.
STINS999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Codes
.-----------------------------------------------------------------
STMED000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STMED999 IF EQUAL
.         
          PACK      MEDCODES[F3],QRYDATA,SP70
          MOVE      F3,LASTMCOD
.         
STMED999  RETURN    
.-----------------------------------------------------------------
. Set Parameters for Medication Reason
.-----------------------------------------------------------------
STDRB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDRB999 IF EQUAL
.
          PACK      MEDDRBR2[F3],QRYDATA,SP70
          MOVE      F3,LASTDRBR
.
STDRB999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Reason
.-----------------------------------------------------------------
STREA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STREA999 IF EQUAL
.
          PACK      MEDREASN[F3],QRYDATA,SP70
          MOVE      F3,LASTREAS
.
STREA999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Status
.-----------------------------------------------------------------
STSTA000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STSTA999 IF EQUAL
.
          PACK      MEDSTATS[F3],QRYDATA,SP70
          MOVE      F3,LASTSTAT
.
STSTA999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Change Description 
.-----------------------------------------------------------------
STCHD000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCHD999 IF EQUAL
.
          PACK      MEDCHNGD[F3],QRYDATA,SP70
          MOVE      F3,LASTCHGD
.
STCHD999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Change Reason
.-----------------------------------------------------------------
STCHR000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCHR999 IF EQUAL
.
          PACK      MEDCHNGR[F3],QRYDATA,SP70
          MOVE      F3,LASTCHGR
.
STCHR999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Notes
.-----------------------------------------------------------------
STNOT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STNOT999 IF EQUAL
.
          PACK      MEDNOTES[F3],QRYDATA,SP70
          MOVE      F3,LASTNOTE
.
STNOT999  RETURN
.-----------------------------------------------------------------
. Set Parameters for Medication Dates
.-----------------------------------------------------------------
STDAT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,DIM5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STDAT999 IF EQUAL
.
          PACK      MEDDATES[F3],QRYDATA,SP70
          MOVE      F3,LASTSCDT
.
STDAT999  RETURN
.-----------------------------------------------------------------
. Set Parameters for notes to include in Discharge summary
.-----------------------------------------------------------------
STINC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STINC999 IF EQUAL
.
          PACK      INCLSUMM[F3],QRYDATA,SP70
          MOVE      F3,LASTINCL
.
STINC999  RETURN
.------------------------------------------------------------
.   Set Parameters for Master Details
.------------------------------------------------------------
CLNOT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3,KEY1
          MOVE      KEY3,F3
          BRANCH    F3,CLNOT040,CLNOT080,CLNOT120,CLNOT160,CLNOT200:
                       CLNOT240,CLNOT280,CLNOT320,CLNOT360,CLNOT400: 
                       CLNOT440,CLNOT480,CLNOT520,CLNOT560,CLNOT600: 
                       CLNOT640,CLNOT680,CLNOT720,CLNOT760,CLNOT800: 
                       CLNOT840,CLNOT880,CLNOT920,CLNOT930,CLNOT940:
                       CLNOT950,CLNOT960,CLNOT970,CLNOT980
.                      
          MOVE      ONE,EXIT
          GOTO      CLNOT990
.
CLNOT040  MOVE      QRYDATA,CLNOT001
          GOTO      CLNOT990
CLNOT080  MOVE      QRYDATA,CLNOT002
          GOTO      CLNOT990
CLNOT120  MOVE      QRYDATA,CLNOT003
          GOTO      CLNOT990
CLNOT160  MOVE      QRYDATA,CLNOT004
          GOTO      CLNOT990
CLNOT200  MOVE      QRYDATA,CLNOT005
          GOTO      CLNOT990
CLNOT240  MOVE      QRYDATA,CLNOT006
          GOTO      CLNOT990
CLNOT280  MOVE      QRYDATA,CLNOT007
          GOTO      CLNOT990
CLNOT320  MOVE      QRYDATA,CLNOT008
          GOTO      CLNOT990
CLNOT360  MOVE      QRYDATA,CLNOT009
          GOTO      CLNOT990
CLNOT400  MOVE      QRYDATA,CLNOT010
          GOTO      CLNOT990
CLNOT440  MOVE      QRYDATA,CLNOT011
          GOTO      CLNOT990
CLNOT480  MOVE      QRYDATA,CLNOT012
          GOTO      CLNOT990
CLNOT520  MOVE      QRYDATA,CLNOT013
          GOTO      CLNOT990
CLNOT560  MOVE      QRYDATA,CLNOT014
          GOTO      CLNOT990
CLNOT600  MOVE      QRYDATA,CLNOT015
          GOTO      CLNOT990
CLNOT640  MOVE      QRYDATA,CLNOT016
          GOTO      CLNOT990
CLNOT680  MOVE      QRYDATA,CLNOT017
          GOTO      CLNOT990
CLNOT720  MOVE      QRYDATA,CLNOT018
          GOTO      CLNOT990
CLNOT760  MOVE      QRYDATA,CLNOT019
          GOTO      CLNOT990
CLNOT800  MOVE      QRYDATA,CLNOT020
          GOTO      CLNOT990
CLNOT840  MOVE      QRYDATA,CLNOT021
          GOTO      CLNOT990
CLNOT880  MATCH     SP70,QRYDATA
          GOTO      CLNOT990 IF EQUAL
          GOTO      CLNOT990 IF EOS
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00              * Set CMON from MTHNAM3
          PACK      CLNOT022,CCENT,CYEAR,CMON,CDAY
          GOTO      CLNOT990
CLNOT920  MATCH     SP70,QRYDATA
          GOTO      CLNOT990 IF EQUAL
          GOTO      CLNOT990 IF EOS
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00              * Set CMON from MTHNAM3
          PACK      CLNOT023,CCENT,CYEAR,CMON,CDAY
          GOTO      CLNOT990
CLNOT930  MOVE      QRYDATA,CLNOT024
          GOTO      CLNOT990
CLNOT940  MOVE      QRYDATA,CLNOT025
          GOTO      CLNOT990
CLNOT950  MOVE      QRYDATA,CLNOT026
          GOTO      CLNOT990
CLNOT960  MOVE      QRYDATA,CLNOT027
          GOTO      CLNOT990
CLNOT970  MOVE      QRYDATA,CLNOT028
          GOTO      CLNOT990
CLNOT980  MOVE      QRYDATA,CLNOT029
          GOTO      CLNOT990
.
CLNOT990  RETURN
.------------------------------------------------------------
.   Set Parameters for nursing diagnosis detail
.------------------------------------------------------------
OBNDD000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3,KEY1
          MOVE      KEY3,F3
          BRANCH    F3,OBNDD010,OBNDD020,OBNDD030,OBNDD040,OBNDD050:
                       OBNDD060,OBNDD070,OBNDD080,OBNDD090,OBNDD100:
                       OBNDD110,OBNDD120,OBNDD130
.
          MOVE      ONE,EXIT
          GOTO      OBNDD990
.
OBNDD010  MOVE      QRYDATA,OBNDD001
          GOTO      OBNDD990
OBNDD020  MOVE      QRYDATA,OBNDD002
          GOTO      OBNDD990
OBNDD030  MOVE      QRYDATA,OBNDD003
          GOTO      OBNDD990
OBNDD040  MOVE      QRYDATA,OBNDD004
          GOTO      OBNDD990
OBNDD050  MOVE      QRYDATA,OBNDD005
          GOTO      OBNDD990
OBNDD060  MOVE      QRYDATA,OBNDD006
          GOTO      OBNDD990
OBNDD070  MOVE      QRYDATA,OBNDD007
          GOTO      OBNDD990
OBNDD080  MOVE      QRYDATA,OBNDD008
          GOTO      OBNDD990
OBNDD090  MOVE      QRYDATA,OBNDD009
          GOTO      OBNDD990
OBNDD100  MOVE      QRYDATA,OBNDD010
          GOTO      OBNDD990
OBNDD110  MOVE      QRYDATA,OBNDD011
          GOTO      OBNDD990
OBNDD120  MOVE      QRYDATA,OBNDD012
          GOTO      OBNDD990
OBNDD130  MOVE      QRYDATA,OBNDD013
          GOTO      OBNDD990
.
OBNDD990  RETURN
.

.------------------------------------------------------------
. Get Mecical Comments
.------------------------------------------------------------
GETCOM00  PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCOM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCOM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCOM90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
GETCOM99  RETURN
.------------------------------------------------------------
. Get FTX001 textarea
.------------------------------------------------------------
GETFX100  PREP      FTXFILAA,FTXNAMAA
          MOVE      ONE,FTX001EX
          MOVE      ONE,F3
          WRITE     FTXFILAA,SEQ;QRYDATA
.
GETFX110  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX190 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX180 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILAA,SEQ;QRYDATA
          GOTO      GETFX110
.
GETFX180  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX190  MOVE      F3,LSTFT001
          OPEN      FTXFILAA,FTXNAMAA
GETFX199  RETURN
+
.------------------------------------------------------------
. Get FTX002 textarea
.------------------------------------------------------------
GETFX200  PREP      FTXFILBB,FTXNAMBB
          MOVE      ONE,FTX002EX
          MOVE      ONE,F3
          WRITE     FTXFILBB,SEQ;QRYDATA
.
GETFX210  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX290 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX280 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILBB,SEQ;QRYDATA
          GOTO      GETFX210
.
GETFX280  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX290  MOVE      F3,LSTFT002
          OPEN      FTXFILBB,FTXNAMBB
GETFX299  RETURN
+
.------------------------------------------------------------
. Get FTX003 textarea
.------------------------------------------------------------
GETFX300  PREP      FTXFILCC,FTXNAMCC
          MOVE      ONE,FTX003EX
          MOVE      ONE,F3
          WRITE     FTXFILCC,SEQ;QRYDATA
.
GETFX310  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX390 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX380 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILCC,SEQ;QRYDATA
          GOTO      GETFX310
.
GETFX380  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX390  MOVE      F3,LSTFT003
          OPEN      FTXFILCC,FTXNAMCC
GETFX399  RETURN
+
.------------------------------------------------------------
. Get FTX004 textarea
.------------------------------------------------------------
GETFX400  PREP      FTXFILDD,FTXNAMDD
          MOVE      ONE,FTX004EX
          MOVE      ONE,F3
          WRITE     FTXFILDD,SEQ;QRYDATA
.
GETFX410  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX490 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX480 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILDD,SEQ;QRYDATA
          GOTO      GETFX410
.
GETFX480  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX490  MOVE      F3,LSTFT004
          OPEN      FTXFILDD,FTXNAMDD
GETFX499  RETURN
+
.------------------------------------------------------------
. Get FTX005 textarea
.------------------------------------------------------------
GETFX500  PREP      FTXFILEE,FTXNAMEE
          MOVE      ONE,FTX005EX
          MOVE      ONE,F3
          WRITE     FTXFILEE,SEQ;QRYDATA
.
GETFX510  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX590 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX580 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILEE,SEQ;QRYDATA
          GOTO      GETFX510
.
GETFX580  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX590  MOVE      F3,LSTFT005
          OPEN      FTXFILEE,FTXNAMEE
GETFX599  RETURN
+
.------------------------------------------------------------
. Get FTX006 textarea
.------------------------------------------------------------
GETFX600  PREP      FTXFILFF,FTXNAMFF 
          MOVE      ONE,FTX006EX
          MOVE      ONE,F3
          WRITE     FTXFILFF,SEQ;QRYDATA
.
GETFX610  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX690 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX680 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILFF,SEQ;QRYDATA
          GOTO      GETFX610
.
GETFX680  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX690  MOVE      F3,LSTFT006
          OPEN      FTXFILFF,FTXNAMFF
GETFX699  RETURN
+
.------------------------------------------------------------
. Get FTX007 textarea
.------------------------------------------------------------
GETFX700  PREP      FTXFILGG,FTXNAMGG
          MOVE      ONE,FTX007EX
          MOVE      ONE,F3
          WRITE     FTXFILGG,SEQ;QRYDATA
.
GETFX710  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX790 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX780 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILGG,SEQ;QRYDATA
          GOTO      GETFX710
.
GETFX780  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX790  MOVE      F3,LSTFT007
          OPEN      FTXFILGG,FTXNAMGG
GETFX799  RETURN
+
.------------------------------------------------------------
. Get FTX008 textarea
.------------------------------------------------------------
GETFX800  PREP      FTXFILHH,FTXNAMHH
          MOVE      ONE,FTX008EX
          MOVE      ONE,F3
          WRITE     FTXFILHH,SEQ;QRYDATA
.
GETFX810  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX890 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX880 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILHH,SEQ;QRYDATA
          GOTO      GETFX810
.
GETFX880  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX890  MOVE      F3,LSTFT008
          OPEN      FTXFILHH,FTXNAMHH
GETFX899  RETURN
+
.------------------------------------------------------------
. Get FTX009 textarea
.------------------------------------------------------------
GETFX900  PREP      FTXFILII,FTXNAMII
          MOVE      ONE,FTX009EX
          MOVE      ONE,F3
          WRITE     FTXFILII,SEQ;QRYDATA
.
GETFX910  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETFX990 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETFX980 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILII,SEQ;QRYDATA
          GOTO      GETFX910
.
GETFX980  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFX990  MOVE      F3,LSTFT009
          OPEN      FTXFILII,FTXNAMII
GETFX999  RETURN
+
.------------------------------------------------------------
. Get FTX010 textarea
.------------------------------------------------------------
GETF1000  PREP      FTXFILJJ,FTXNAMJJ
          MOVE      ONE,FTX010EX
          MOVE      ONE,F3
          WRITE     FTXFILJJ,SEQ;QRYDATA
.
GETF1010  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1090 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1080 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILJJ,SEQ;QRYDATA
          GOTO      GETF1010
.
GETF1080  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1090  MOVE      F3,LSTFT010
          OPEN      FTXFILJJ,FTXNAMJJ
GETF1099  RETURN
+
.------------------------------------------------------------
. Get FTX011 textarea
.------------------------------------------------------------
GETF1100  PREP      FTXFILKK,FTXNAMKK
          MOVE      ONE,FTX011EX
          MOVE      ONE,F3
          WRITE     FTXFILKK,SEQ;QRYDATA
.
GETF1110  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1190 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1180 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILKK,SEQ;QRYDATA
          GOTO      GETF1110
.
GETF1180  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1190  MOVE      F3,LSTFT011
          OPEN      FTXFILKK,FTXNAMKK
GETF1199  RETURN
+
.------------------------------------------------------------
. Get FTX012 textarea
.------------------------------------------------------------
GETF1200  PREP      FTXFILLL,FTXNAMLL
          MOVE      ONE,FTX012EX
          MOVE      ONE,F3
          WRITE     FTXFILLL,SEQ;QRYDATA
.
GETF1210  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1290 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1280 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILLL,SEQ;QRYDATA
          GOTO      GETF1210
.
GETF1280  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1290  MOVE      F3,LSTFT012
          OPEN      FTXFILLL,FTXNAMLL
GETF1299  RETURN
+
.------------------------------------------------------------
. Get FTX013 textarea
.------------------------------------------------------------
GETF1300  PREP      FTXFILMM,FTXNAMMM
          MOVE      ONE,FTX013EX
          MOVE      ONE,F3
          WRITE     FTXFILMM,SEQ;QRYDATA
.
GETF1310  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1390 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1380 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILMM,SEQ;QRYDATA
          GOTO      GETF1310
.
GETF1380  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1390  MOVE      F3,LSTFT013
          OPEN      FTXFILMM,FTXNAMMM
GETF1399  RETURN
+
.------------------------------------------------------------
. Get FTX014 textarea
.------------------------------------------------------------
GETF1400  PREP      FTXFILNN,FTXNAMNN
          MOVE      ONE,FTX014EX
          MOVE      ONE,F3
          WRITE     FTXFILNN,SEQ;QRYDATA
.
GETF1410  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1490 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1480 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILNN,SEQ;QRYDATA
          GOTO      GETF1410
.
GETF1480  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1490  MOVE      F3,LSTFT014
          OPEN      FTXFILNN,FTXNAMNN
GETF1499  RETURN
+
.------------------------------------------------------------
. Get FTX015 textarea
.------------------------------------------------------------
GETF1500  PREP      FTXFILOO,FTXNAMOO
          MOVE      ONE,FTX015EX
          MOVE      ONE,F3
          WRITE     FTXFILOO,SEQ;QRYDATA
.
GETF1510  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1590 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1580 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILOO,SEQ;QRYDATA
          GOTO      GETF1510
.
GETF1580  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1590  MOVE      F3,LSTFT015
          OPEN      FTXFILOO,FTXNAMOO
GETF1599  RETURN
+
.------------------------------------------------------------
. Get FTX016 textarea
.------------------------------------------------------------
GETF1600  PREP      FTXFILPP,FTXNAMPP
          MOVE      ONE,FTX016EX
          MOVE      ONE,F3
          WRITE     FTXFILPP,SEQ;QRYDATA
.
GETF1610  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1690 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1680 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILPP,SEQ;QRYDATA
          GOTO      GETF1610
.
GETF1680  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1690  MOVE      F3,LSTFT016
          OPEN      FTXFILPP,FTXNAMPP
GETF1699  RETURN
+
.------------------------------------------------------------
. Get FTX017 textarea
.------------------------------------------------------------
GETF1700  PREP      FTXFILQQ,FTXNAMQQ
          MOVE      ONE,FTX017EX
          MOVE      ONE,F3
          WRITE     FTXFILQQ,SEQ;QRYDATA
.
GETF1710  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETF1790 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETF1780 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     FTXFILQQ,SEQ;QRYDATA
          GOTO      GETF1710
.
GETF1780  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETF1790  MOVE      F3,LSTFT017
          OPEN      FTXFILQQ,FTXNAMQQ
GETF1799  RETURN
+
.------------------------------------------------------------
. Get Visit Comments
.------------------------------------------------------------
GETCMT00  PACK      QRYDATA,QRYDATA,SP70,SP70
          MATCH     SP70,QRYDATA
          GOTO      GETCMT10 IF EQUAL
.
          ADD       ONE,VSCTMIDX
          MOVE      QRYDATA,VSCTM002[VSCTMIDX]
          RESET     VSCTM002[VSCTMIDX]
.
GETCMT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETCMT99 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETCMT80 IF NOT EQUAL
          ADD       ONE,VSCTMIDX             * Increment Array Counter
          PACK      VSCTM002[VSCTMIDX],QRYDATA,SP70 * Input Note to Array
          GOTO      GETCMT10
.
GETCMT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMT99  RETURN
.------------------------------------------------------------
. Get Fees Estimate Text
.------------------------------------------------------------
GETFET00  PACK      QRYDATA,QRYDATA,SP70,SP70
          MATCH     SP70,QRYDATA
          GOTO      GETFET10 IF EQUAL
.
          ADD       ONE,PMFETIDX
          MOVE      QRYDATA,PMFET002[PMFETIDX]
          RESET     PMFET002[PMFETIDX]
.
GETFET10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETFET99 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETFET80 IF NOT EQUAL
          ADD       ONE,PMFETIDX             * Increment Array Counter
          PACK      PMFET002[PMFETIDX],QRYDATA,SP70 * Input Note to Array
          GOTO      GETFET10
.
GETFET80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETFET99  RETURN
.------------------------------------------------------------
. Get Text from New Note  
.------------------------------------------------------------
GETEXT00  MOVE      ONE,F3
          MOVE      QRYDATA,NOTETEXT[F3]
          RESET     NOTETEXT[F3]
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETEXT90 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETEXT80 IF NOT EQUAL
          PACK      QRYDATA,QRYDATA,SP70
          ADD       ONE,F3                       * Increment Array Counter
          MOVE      QRYDATA,NOTETEXT[F3]         * Input Note to Array 
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next Parameter
.
GETEXT90  MOVE      F3,LASTITEM                  * Set length of FF Note 
.
GETEXT99  RETURN
.
.------------------------------------------------------------
. Add/Update Principle Details if clinical summary note
.------------------------------------------------------------
PRDET000  MATCH     "006",OBCATYP
          GOTO      PRDET999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDOBPIN1
          BRANCH    OVRCD,PRDET500
.
          MOVE      SP70,OBPNPDIA
          MOVE      SP70,OBPNPPRO
          MOVE      SP70,OBPNREAA
.
PRDET500  MATCH     Z70,OBSPN001
          IF        !@EQUAL
            MOVE      OBSPN001,OBPNPDIA
          ENDIF
.
          MATCH     Z70,OBSPN002
          IF        !@EQUAL
            MOVE      OBSPN002,OBPNPPRO
          ENDIF
.
          MATCH     Z70,OBSPN003
          IF        !@EQUAL
            MOVE      OBSPN003,OBPNREAA
          ENDIF
.
          PACK      OBPNVISN,ADMISSNO,SP70
          PACK      KEY8,OBPNVISN,SP70
          CALL      RAOBPIN1
          IF        OVRCD=1
            CALL      WROBPIN1
          ELSE 
            CALL      UPOBPIN1 
          ENDIF
          MOVE      ZERO,EXIT
.
PRDET999  RETURN
+
.------------------------------------------------------------
. Add/Update Medication Details if Discharge Medication note
.------------------------------------------------------------
MDDET000  MATCH     "008",OBCATYP
          GOTO      MDDET999 IF NOT EQUAL
.
MDDET020  PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
          CALL      RKOBMED1
          BRANCH    OVRCD,MDDET050
.
          MATCH     ADMISSNO,OBMEVISN
          GOTO      MDDET050 IF NOT EQUAL
.
          PACK      KEY11,OBMEVISN,OBMECNTR,SP70
          CALL      DEOBMED1
          GOTO      MDDET020
.
MDDET050  MOVE      ZERO,F3
          MOVE      ZERO,MEDCOUNT
          WHILE     F3<LASTDRUG
            ADD       ONE,F3
            CALL      CLOBSMED              * Clear File Variables
            CALL      SAVMED00              * Moving Cgi variables To File Var.
.
            MATCH     SP70,OBMEDRUG
            IF        !@EQUAL
              ADD       ONE,MEDCOUNT
              MOVE      MEDCOUNT,OBMECNTR
              PACK      KEY11,ADMISSNO,OBMECNTR,SP70
              CALL      RAOBMED1
              IF        OVRCD=1
                CALL      WROBMED1        * Write to Observation medication table
              ELSE
                CALL      UPOBMED1        * Update to Observation medication table
              ENDIF
            ENDIF
          DO
.
MDDET999  RETURN
+
.******************************************************************************
.*       Moving Cgi Variables To File Variables  for medication details       *
.******************************************************************************
SAVMED00    PACK    OBMEVISN,ADMISSNO,SP70
            PACK    OBMEDRUG,DRUCODES[F3],SP70
            PACK    OBMEDOSF,DOSEFORM[F3],SP70
            PACK    OBMEDOSE,DOSAGE[F3],SP70
            PACK    OBMEFREQ,FREQENCY[F3],SP70
            PACK    OBMEDURA,DURATION[F3],SP70
            PACK    OBMEQUAN,QUANTITY[F3],SP70
            PACK    OBMEINST,INSTRUCT[F3],SP70
            PACK    OBMEMCOD,MEDCODES[F3],SP70
            PACK    OBMEREAS,MEDREASN[F3],SP70
            PACK    OBMESTAT,MEDSTATS[F3],SP70
            PACK    OBMECHGD,MEDCHNGD[F3],SP70
            PACK    OBMECHGR,MEDCHNGR[F3],SP70
            PACK    OBMENOTE,MEDNOTES[F3],SP70
            PACK    OBMESCDT,MEDDATES[F3],SP70
            PACK    OBMEDRBR,MEDDRBR2[F3],SP70
.
SAVMED99    RETURN
.------------------------------------------------------------
. Add Multiple New Notes for Service Orders
.------------------------------------------------------------
ADDML000  MOVE      ZERO,SERVCNT
ADDML100  ADD       ONE,SERVCNT
          IF        SERVCNT>SERVEND
            GOTO      ADDML900 
          ENDIF
          MATCH     SP70,SERVICEC[SERVCNT]
          GOTO      ADDML100 IF EQUAL
          MOVE      SERVICEC[SERVCNT],CLNOT007
          CALL      ADDNT000
          GOTO      ADDML100
.
ADDML900  MOVE      ZERO,EXIT
.
ADDML999  RETURN
.------------------------------------------------------------
. Add New Clinical Note 
.------------------------------------------------------------
ADDNT000  PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          GOTO      ADDNT999 IF EQUAL
.
          PACK      KEY12,ADMISSNO,Z70         * New Note has been created
          CALL      RSOBCA1                    * Positional Read
          CALL      RPOBCA1                    * Read Prior Record
          MATCH     ADMISSNO,OBCAVIS
          IF        @EQUAL
            MOVE      OBCACID,NOTEID           * Copy Note ID to FORM
            ADD       ONE,NOTEID
            MOVE      NOTEID,CLNOTEID          * Move back to DIM
          ELSE
            MOVE      "   1",CLNOTEID          * First New Note
          ENDIF
.
          PACK      NOTESKEY,ADMISSNO,CLNOTEID,SP20   * Set Noteskey ?
.
          MOVE      ADMISSNO,OBCAVIS        * Set all record values       
          MOVE      CLNOTEID,OBCACID
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OBCADTE
          MOVE      CTIMEIS,OBCATME
          MOVE      USERID,OBCAUID
.
          PACK      KEY10,USERID            * Determine Current User 
          CALL      RDWBSE1                 * Occupational Group
          MOVE      WBSEOCG,OBCAOCG
.
          MOVE      CLNOT001,OBCATYP
          MOVE      "0",OBCAMDL             * All of note is not deleted
.          MOVE      CLNOT004,OBCAMDL
          MOVE      CLNOT002,OBCAHLV
.
          PACK      KEY3,OBCATYP           
          CALL      RDOBCC1                 * Determine Note Security Level
          MOVE      OBCCSLV,OBCASLV         * From Note Type
.
. ***** check user has security to view/add these notes ******
          MOVE      ZERO,F2
          MOVE      OBCASLV,F2
          COMPARE   ZERO,F2
          GOTO      ADDNT100 IF EQUAL
.
          PACK      KEY18,WBSEUID,PRGID,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,ADDNT950
.
          COMPARE   F2,WBSTLEV
          GOTO      ADDNT950 IF LESS
.
ADDNT100  MOVE      CLNOT005,OBCAMIN
.
          RESET     CLNOT006
          MOVE      CLNOT006,OBCAPT1
          MOVE      "0",OBCAP1D             * Set Point 1 as not deleted
.
          RESET     CLNOT007
          MOVE      CLNOT007,OBCAPT2
          MOVE      "0",OBCAP2D             * Set Point 2 as not deleted
.
          RESET     CLNOT008
          MOVE      CLNOT008,OBCAPT3
          MOVE      "0",OBCAP3D             * Set Point 3 as not deleted
.
          RESET     CLNOT009
          MOVE      CLNOT009,OBCAPT4
          MOVE      "0",OBCAP4D             * Set Point 4 as not deleted
.
          MOVE      CLNOT010,OBCAUC1
          MOVE      CLNOT011,OBCAUC2
          MOVE      CLNOT012,OBCAUC3
          MOVE      CLNOT013,OBCAUC4
          MOVE      CLNOT014,OBCAUC5
          MOVE      CLNOT015,OBCAUC6
          MOVE      CLNOT016,OBCAUC7
          MOVE      CLNOT017,OBCAUC8
          MOVE      CLNOT018,OBCAUD1
          MOVE      CLNOT019,OBCAUD2
          MOVE      CLNOT020,OBCAUD3
          MOVE      CLNOT021,OBCAUD4
          MOVE      CLNOT022,OBCADD1
          MOVE      CLNOT023,OBCADD2
          MOVE      CLNOT027,OBCAAT1
          MOVE      CLNOT028,OBCAAT2
          MOVE      CLNOT029,OBCATX1
          MOVE      OBCADTE,OBCADLU         * Last Update Date is Current Date
          MOVE      OBCATME,OBCATLU         * Last Update Time is Current Time
          MOVE      OBCAUID,OBCALID         * Last Update User is Current User

          PACK      KEY12,NOTESKEY,SP20
          CALL      WROBCA1                 * Write New Note to File
          REP       " -",KEY12
          CLEAR     FHIRLOCH
          APPEND    "ClinicalImpression/VSN-",FHIRLOCH
          APPEND    KEY12,FHIRLOCH
          RESET     FHIRLOCH
          REP       "- ",KEY12
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          IF        OVRCD=0
            MATCH     "1",PTMXSIN3
            IF        !@EQUAL
              MOVE      "1",PTMXSIN3
              CALL      UPMAST1
            ENDIF
          ENDIF
.                                           
          MATCH     SP70,NOTETEXT[001]      * If FF Note is Empty ?
          GOTO      ADDNT999 IF EQUAL
          MOVE      ZERO,F3
ADDNT900  ADD       ONE,F3
          IF        F3<=LASTITEM
            MOVE      ADMISSNO,OBCBVIS      * Visit Number
            MOVE      CLNOTEID,OBCBCID      * Clinical Note ID
            MOVE      F3,OBCBLNO            * Line No.
            MOVE      NOTETEXT[F3],OBCBLDT  * Line Details
            PACK      KEY15,NOTESKEY,F3,SP20
            CALL      WROBCB1               * Write FF Note to File
            GOTO      ADDNT900
          ENDIF 
.          
          MOVE      ZERO,EXIT
          GOTO      ADDNT999
.
ADDNT950  MOVE      "Invalid Security Level for this Note Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDNT999
.
ADDNT999  RETURN
.
.------------------------------------------------------------
. Update Clinical Note
.------------------------------------------------------------
UPDNT000  PACK      KEY12,NOTESKEY,SP70
          CALL      RDOBCA1
          BRANCH    OVRCD,UPDNT900
.
          MATCH     Z70,DISUM002
          IF        !@EQUAL
            PACK      OBCADTE,DISUM002
          ENDIF
.
          MATCH     Z70,DISUM003
          IF        !@EQUAL
            PACK      OBCATME,DISUM003
          ENDIF
.
          MATCH     Z70,CLNOT002
          IF        !@EQUAL
            MOVE      CLNOT002,OBCAHLV
          ENDIF
.
          MATCH     Z70,CLNOT002
          IF        !@EQUAL
            MOVE      CLNOT005,OBCAMIN
          ENDIF
.
          MATCH     Z70,CLNOT002
          IF        !@EQUAL
            RESET     CLNOT006
            MOVE      CLNOT006,OBCAPT1
          ENDIF
.
          RESET     CLNOT007
          MOVE      CLNOT007,OBCAPT2
          MOVE      "0",OBCAP2D             * Set Point 2 as not deleted
.
          RESET     CLNOT008
          MOVE      CLNOT008,OBCAPT3
          MOVE      "0",OBCAP3D             * Set Point 3 as not deleted
.
          RESET     CLNOT009
          MOVE      CLNOT009,OBCAPT4
          MOVE      "0",OBCAP4D             * Set Point 4 as not deleted
.
          MOVE      CLNOT010,OBCAUC1
          MOVE      CLNOT011,OBCAUC2
          MOVE      CLNOT012,OBCAUC3
          MOVE      CLNOT013,OBCAUC4
          MOVE      CLNOT014,OBCAUC5
          MOVE      CLNOT015,OBCAUC6
          MOVE      CLNOT016,OBCAUC7
          MOVE      CLNOT017,OBCAUC8
          MOVE      CLNOT018,OBCAUD1
          MOVE      CLNOT019,OBCAUD2
          MOVE      CLNOT020,OBCAUD3
          MOVE      CLNOT021,OBCAUD4
          MOVE      CLNOT022,OBCADD1
          MOVE      CLNOT023,OBCADD2
          MOVE      CLNOT027,OBCAAT1
          MOVE      CLNOT028,OBCAAT2
          MOVE      CLNOT029,OBCATX1
          CALL      IBACLOCK
          PACK      OBCADLU,CCC,CYY,CMM,CDD
          REP       " 0",OBCADLU
          CLOCK     TIME,CTIMEIS
          PACK      OBCATLU,CTIMEIS         * Last Update Time is Current Time
          MOVE      USERID,OBCALID          * Last Update User is Current User

          PACK      KEY12,NOTESKEY,SP70
          CALL      UPOBCA1                 * Update Note to File
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          IF        OVRCD=0
            MATCH     "1",PTMXSIN3
            IF        !@EQUAL
              MOVE      "1",PTMXSIN3
              CALL      UPMAST1
            ENDIF
          ENDIF
.
UPDNT700  PACK      KEY15,ADMISSNO,OBCACID,SP70
          CALL      RSOBCB1
          CALL      RKOBCB1
          BRANCH    OVRCD,UPDNT750
.
          MATCH     ADMISSNO,OBCBVIS
          GOTO      UPDNT750 IF NOT EQUAL
.
          MATCH     OBCACID,OBCBCID
          GOTO      UPDNT750 IF NOT EQUAL
.
          PACK      KEY15,OBCBVIS,OBCBCID,OBCBLNO,SP70
          CALL      DEOBCB1
          GOTO      UPDNT700
.
UPDNT750  MATCH     SP70,NOTETEXT[001]      * If FF Note is Empty ?
          GOTO      UPDNT999 IF EQUAL
          MOVE      ZERO,F3
UPDNT800  ADD       ONE,F3
          IF        F3<=LASTITEM
            MOVE      ADMISSNO,OBCBVIS      * Visit Number
            MOVE      OBCACID,OBCBCID       * Clinical Note ID
            MOVE      F3,OBCBLNO            * Line No.
            PACK      KEY15,NOTESKEY,F3,SP20
            CALL      RDOBCB1
            MOVE      NOTETEXT[F3],OBCBLDT  * Line Details
            PACK      KEY15,NOTESKEY,F3,SP20
            CALL      RAOBCB1
            IF        OVRCD=1
              CALL      WROBCB1               * Write FF Note to File
            ELSE
              CALL      UPOBCB1               * Write FF Note to File
            ENDIF
            GOTO      UPDNT800
          ENDIF
          GOTO      UPDNT999
.
UPDNT900  MOVE      "Missing clinical note ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDNT999
.
UPDNT950  MOVE      ZERO,EXIT                * Return to another Screen ?
.
UPDNT999  RETURN
+
.------------------------------------------------------------
. Check Update Key is equal to last Update Date and Time 
. and Update Record with New Update Date,Time & User
.------------------------------------------------------------
UPDATE00  MOVE      ZERO,EXIT 
          PACK      KEY12,NOTESKEY,SP20
          CALL      RLOBCA1                 * Read and Lock File
          BRANCH    OVRCD,UPDATE60
          UNPACK    UPDATEKY,LASTUPDT,LASTUPTM
          MATCH     LASTUPDT,OBCADLU        * Compare Update Dates
          GOTO      UPDATE50 IF NOT EQUAL
          MATCH     LASTUPTM,OBCATLU        * Compare Update Times
          GOTO      UPDATE50 IF NOT EQUAL
.
          CALL      IBACLOCK                * Determine current Date & Time
          MOVE      CCC,CCENT
          MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          REP       " 0",CYEAR
          REP       " 0",CMON
          REP       " 0",CDAY
          PACK      OBCADLU,CCENT,CYEAR,CMON,CDAY,SP10   * Date Last Updated
          MOVE      CTIMEIS,OBCATLU         * Time Last Updated
          MOVE      USERID,OBCALID          * Last Updated User ID
          GOTO      UPDATE99
.
UPDATE50  CALL      UUOBCA1                 * Unlock File
          MOVE      "Last Update Date & Time Error!",WEBTITLE
          MOVE      ZERO,NEXTPAGE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDATE99
.
UPDATE60  CALL      UUOBCA1                 * Unlock File
          MOVE      "Invalid Note Key!",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,NEXTPAGE
          MOVE      ONE,EXIT
          GOTO      UPDATE99
. 
UPDATE99  RETURN
.--------------------------------------------------------------------------
. * Add New Type of Note SubRoutine
.--------------------------------------------------------------------------
ADDNTN00  MOVE      CLNOT001,OBCCTYP
          MOVE      CLNOT002,OBCCDHL
          MOVE      CLNOT003,OBCCSLV
          MOVE      CLNOT024,OBCCDES
          MOVE      CLNOT025,OBCCTMI
          MOVE      CLNOT026,OBCCTMO
.
          PACK      KEY3,CLNOT001,SP3
          CALL      WROBCC1
.
ADDNTN99  RETURN
.--------------------------------------------------------------------------
. * Update Type of Note SubRoutine 
.--------------------------------------------------------------------------
UPDNTN00  PACK      KEY3,CLNOT001,SP3
          CALL      RDOBCC1
          MOVE      CLNOT001,OBCCTYP
          MOVE      CLNOT002,OBCCDHL
          MOVE      CLNOT003,OBCCSLV
          MOVE      CLNOT024,OBCCDES
          MOVE      CLNOT025,OBCCTMI
          MOVE      CLNOT026,OBCCTMO
          CALL      UPOBCC1
.
UPDNTN99  RETURN
.--------------------------------------------------------------------------
. * Delete of Note SubRoutine 
.--------------------------------------------------------------------------
DELNTN00  PACK      KEY3,CLNOT001,SP3
          CALL      DEOBCC1
.
DELNTN99  RETURN
.
.--------------------------------------------------------------------------
. * Clear Nursing Diagnosis
.--------------------------------------------------------------------------
CLOBSNDD  PACK      OBNDVISN,SP70
          PACK      OBNDNDG1,SP70
          PACK      OBNDACP1,SP70
          PACK      OBNDNDG2,SP70
          PACK      OBNDACP2,SP70
          PACK      OBNDNDG3,SP70
          PACK      OBNDACP3,SP70
          PACK      OBNDNDG4,SP70
          PACK      OBNDACP4,SP70
          PACK      OBNDNDG5,SP70
          PACK      OBNDACP5,SP70
          PACK      OBNDNDG6,SP70
          PACK      OBNDACP6,SP70
.
          RETURN
.--------------------------------------------------------------------------
. * Move Nursing Diagnosis cgi's to file variables
.--------------------------------------------------------------------------
MVOBSNDD  MOVE      OBNDD001,OBNDVISN
.
          MATCH     Z70,OBNDD002
          IF        !@EQUAL
            MOVE      OBNDD002,OBNDNDG1
          ENDIF
          MATCH     Z70,OBNDD003
          IF        !@EQUAL
            MOVE      OBNDD003,OBNDACP1
          ENDIF
          MATCH     Z70,OBNDD004
          IF        !@EQUAL
            MOVE      OBNDD004,OBNDNDG2
          ENDIF
          MATCH     Z70,OBNDD005
          IF        !@EQUAL
            MOVE      OBNDD005,OBNDACP2
          ENDIF
          MATCH     Z70,OBNDD006
          IF        !@EQUAL
            MOVE      OBNDD006,OBNDNDG3
          ENDIF
          MATCH     Z70,OBNDD007
          IF        !@EQUAL
            MOVE      OBNDD007,OBNDACP3
          ENDIF
          MATCH     Z70,OBNDD008
          IF        !@EQUAL
            MOVE      OBNDD008,OBNDNDG4
          ENDIF
          MATCH     Z70,OBNDD009
          IF        !@EQUAL
            MOVE      OBNDD009,OBNDACP4
          ENDIF
          MATCH     Z70,OBNDD010
          IF        !@EQUAL
            MOVE      OBNDD010,OBNDNDG5
          ENDIF
          MATCH     Z70,OBNDD011
          IF        !@EQUAL
            MOVE      OBNDD011,OBNDACP5
          ENDIF
          MATCH     Z70,OBNDD012
          IF        !@EQUAL
            MOVE      OBNDD012,OBNDNDG6
          ENDIF
          MATCH     Z70,OBNDD013
          IF        !@EQUAL
            MOVE      OBNDD013,OBNDACP6
          ENDIF
.
          RETURN
.--------------------------------------------------------------------------
. * Add New Nursing Diagnosis
.--------------------------------------------------------------------------
ADDNDD00  CALL      CLOBSNDD
          MATCH     Z70,OBNDD001
          GOTO      ADDNDD99 IF EQUAL
.
          MATCH     SP70,OBNDD001
          GOTO      ADDNDD99 IF EQUAL
.
          CALL      MVOBSNDD
          PACK      KEY8,OBNDVISN,SP70
          CALL      RAOBNDD1
          IF        OVRCD=1
            CALL      WROBNDD1
          ENDIF
.
          PACK      KEY8,OBNDVISN,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MATCH     Z70,ADIAGNDD
            IF        !@EQUAL
              MOVE      ADIAGNDD,ADIAG1              * update admission reason
              CALL      UPMISS1
            ENDIF
          ENDIF
.
          CALL      ADFTX100              * Write requested follow up
          CALL      ADFTX200              * Write Patient Instruction
          CALL      ADFTX300              * Write Recommendation to GP
          CALL      ADFTX400              * Write Pathology Results
          CALL      ADFTX500              * Write Diagnostic Imaging
          CALL      ADFTX600              * Write Other Investigations
          CALL      ADFTX700              * Write Care Plan 1
          CALL      ADFTX800              * Write Care Plan 2
          CALL      ADFTX900              * Write Care Plan 3
          CALL      ADFT1000              * Write Care Plan 4
          CALL      ADFT1100              * Write Care Plan 5
          CALL      ADFT1200              * Write Care Plan 6
          CALL      ADFT1300              * Write Past Medical History
          CALL      ADFT1400              * Write Admission Progress
          CALL      ADFT1500              * Write Allied Health Discharge
          CALL      ADFT1600              * Write Trans Facility Handover
          CALL      ADFT1700              * Write Observations
.
ADDNDD99  RETURN
+
.--------------------------------------------------------------------------
. * Add New Requested follow up to obsftxaf
.--------------------------------------------------------------------------
ADFTX100  MOVE      OBNDVISN,OBFTVISN
          MOVE      "001",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX190  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT001
            GOTO     ADFTX199
          ENDIF
.
          READ      FTXFILAA,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX190 IF EQUAL
            GOTO      ADFTX190 IF EOS
          ENDIF
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX190
.
ADFTX199  RETURN
+
.--------------------------------------------------------------------------
. * Add New Patient Instructions to obsftxaf
.--------------------------------------------------------------------------
ADFTX200  MOVE      OBNDVISN,OBFTVISN
          MOVE      "002",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX290  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT002
            GOTO     ADFTX299
          ENDIF
.
          READ      FTXFILBB,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX290 IF EQUAL
            GOTO      ADFTX290 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX290
.
ADFTX299  RETURN
+
.--------------------------------------------------------------------------
. * Add New Pathology Results to obsftxaf
.--------------------------------------------------------------------------
ADFTX300  MOVE      OBNDVISN,OBFTVISN
          MOVE      "003",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX390  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT003
            GOTO     ADFTX399
          ENDIF
.
          READ      FTXFILCC,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX390 IF EQUAL
            GOTO      ADFTX390 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX390
.
ADFTX399  RETURN
+
.--------------------------------------------------------------------------
. * Add New Recommendations to GP to obsftxaf
.--------------------------------------------------------------------------
ADFTX400  MOVE      OBNDVISN,OBFTVISN
          MOVE      "004",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX490  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT004
            GOTO     ADFTX499
          ENDIF
.
          READ      FTXFILDD,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX490 IF EQUAL
            GOTO      ADFTX490 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX490
.
ADFTX499  RETURN
+
.--------------------------------------------------------------------------
. * Add New Diagnostic Imaging to obsftxaf
.--------------------------------------------------------------------------
ADFTX500  MOVE      OBNDVISN,OBFTVISN
          MOVE      "005",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX590  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT005
            GOTO     ADFTX599
          ENDIF
.
          READ      FTXFILEE,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX590 IF EQUAL
            GOTO      ADFTX590 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX590
.
ADFTX599  RETURN
+
.--------------------------------------------------------------------------
. * Add New Other Investigations to obsftxaf
.--------------------------------------------------------------------------
ADFTX600  MOVE      OBNDVISN,OBFTVISN
          MOVE      "006",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX690  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT006
            GOTO     ADFTX699
          ENDIF
.
          READ      FTXFILFF,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX690 IF EQUAL
            GOTO      ADFTX690 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX690
.
ADFTX699  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 1 to obsftxaf
.--------------------------------------------------------------------------
ADFTX700  MOVE      OBNDVISN,OBFTVISN
          MOVE      "007",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX790  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT007
            GOTO     ADFTX799
          ENDIF
.
          READ      FTXFILGG,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX790 IF EQUAL
            GOTO      ADFTX790 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX790
.
ADFTX799  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 2 to obsftxaf
.--------------------------------------------------------------------------
ADFTX800  MOVE      OBNDVISN,OBFTVISN
          MOVE      "008",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX890  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT008
            GOTO     ADFTX899
          ENDIF
.
          READ      FTXFILHH,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX890 IF EQUAL
            GOTO      ADFTX890 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX890
.
ADFTX899  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 3 to obsftxaf
.--------------------------------------------------------------------------
ADFTX900  MOVE      OBNDVISN,OBFTVISN
          MOVE      "009",OBFTTYPE
          MOVE      ZERO,F3
.
ADFTX990  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT009
            GOTO     ADFTX999
          ENDIF
.
          READ      FTXFILII,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFTX990 IF EQUAL
            GOTO      ADFTX990 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFTX990
.
ADFTX999  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 4 to obsftxaf
.--------------------------------------------------------------------------
ADFT1000  MOVE      OBNDVISN,OBFTVISN
          MOVE      "010",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1090  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT010
            GOTO     ADFT1099
          ENDIF
.
          READ      FTXFILJJ,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1090 IF EQUAL
            GOTO      ADFT1090 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFT1090
.
ADFT1099  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 5 to obsftxaf
.--------------------------------------------------------------------------
ADFT1100  MOVE      OBNDVISN,OBFTVISN
          MOVE      "011",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1190  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT011
            GOTO     ADFT1199
          ENDIF
.
          READ      FTXFILKK,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1190 IF EQUAL
            GOTO      ADFT1190 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          GOTO      ADFT1190
.
ADFT1199  RETURN
+
.--------------------------------------------------------------------------
. * Add New Care Plan 6 to obsftxaf
.--------------------------------------------------------------------------
ADFT1200  MOVE      OBNDVISN,OBFTVISN
          MOVE      "012",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1290  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT012
            GOTO     ADFT1299
          ENDIF
.
          READ      FTXFILLL,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1290 IF EQUAL
            GOTO      ADFT1290 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT012
            GOTO     ADFT1299
          ENDIF
          GOTO      ADFT1290
.
ADFT1299  RETURN
+
.--------------------------------------------------------------------------
. * Add New Past Medical History to obsftxaf
.--------------------------------------------------------------------------
ADFT1300  MOVE      OBNDVISN,OBFTVISN
          MOVE      "013",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1390  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT013
            GOTO     ADFT1399
          ENDIF
.
          READ      FTXFILMM,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1390 IF EQUAL
            GOTO      ADFT1390 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT013
            GOTO     ADFT1399
          ENDIF
          GOTO      ADFT1390
.
ADFT1399  RETURN
+
.--------------------------------------------------------------------------
. * Add New Admission Progress to obsftxaf
.--------------------------------------------------------------------------
ADFT1400  MOVE      OBNDVISN,OBFTVISN
          MOVE      "014",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1490  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT014
            GOTO     ADFT1499
          ENDIF
.
          READ      FTXFILNN,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1490 IF EQUAL
            GOTO      ADFT1490 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT014
            GOTO     ADFT1499
          ENDIF
          GOTO      ADFT1490
.
ADFT1499  RETURN
+
.--------------------------------------------------------------------------
. * Add New Allied Health Discharge to obsftxaf
.--------------------------------------------------------------------------
ADFT1500  MOVE      OBNDVISN,OBFTVISN
          MOVE      "015",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1590  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT015
            GOTO     ADFT1599
          ENDIF
.
          READ      FTXFILOO,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1590 IF EQUAL
            GOTO      ADFT1590 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT015
            GOTO     ADFT1599
          ENDIF
          GOTO      ADFT1590
.
ADFT1599  RETURN
+
.--------------------------------------------------------------------------
. * Add New Trans Facility Handover to obsftxaf
.--------------------------------------------------------------------------
ADFT1600  MOVE      OBNDVISN,OBFTVISN
          MOVE      "016",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1690  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT016
            GOTO     ADFT1699
          ENDIF
.
          READ      FTXFILPP,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1690 IF EQUAL
            GOTO      ADFT1690 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT016
            GOTO     ADFT1699
          ENDIF
          GOTO      ADFT1690
.
ADFT1699  RETURN
+
.--------------------------------------------------------------------------
. * Add New Observations to obsftxaf
.--------------------------------------------------------------------------
ADFT1700  MOVE      OBNDVISN,OBFTVISN
          MOVE      "017",OBFTTYPE
          MOVE      ZERO,F3
.
ADFT1790  ADD       ONE,F3
          MOVE      F3,OBFTLINE
.
          IF        F3>LSTFT017
            GOTO     ADFT1799
          ENDIF
.
          READ      FTXFILQQ,SEQ;OBFTDATA
.
          IF        F3=1|F3=2
            MATCH     SP70,OBFTDATA
            GOTO      ADFT1790 IF EQUAL
            GOTO      ADFT1790 IF EOS
          ENDIF
.
          PACK      KEY14,OBFTVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      RAOBFTX1
          IF        OVRCD=1
            CALL      WROBFTX1
          ENDIF
          IF        F3>=LSTFT017
            GOTO     ADFT1799
          ENDIF
          GOTO      ADFT1790
.
ADFT1799  RETURN
+
.--------------------------------------------------------------------------
. * Update Nursing Diagnosis
.--------------------------------------------------------------------------
UPDNDD00  MOVE      ZERO,EXIT
          MATCH     Z70,OBNDD001
          GOTO      UPDNDD99 IF EQUAL
.
          PACK      KEY8,OBNDD001,SP70
          CALL      RDOBNDD1
          BRANCH    OVRCD,UPDNDD90
.
          CALL      MVOBSNDD
          CALL      UPOBNDD1
.
          PACK      KEY8,OBNDVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPDNDD99
.
          MATCH     Z70,ADIAGNDD
          IF        !@EQUAL
            MOVE      ADIAGNDD,ADIAG1              * update admission reason
            CALL      UPMISS1
          ENDIF
.
          GOTO      UPDNDD99
.
UPDNDD90  MOVE      "Invalid Nursing Diagnosis Record ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDNDD99
.
UPDNDD99  RETURN
.--------------------------------------------------------------------------
. * Update obsftxaf details 
.--------------------------------------------------------------------------
UPDFTX00  COMPARE   "1",FTX001EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,ONE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX100
          ENDIF
.
          COMPARE   "1",FTX002EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,TWO,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX200
          ENDIF
.
          COMPARE   "1",FTX003EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,THREE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX300
          ENDIF
.
          COMPARE   "1",FTX004EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,FOUR,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX400
          ENDIF
.
          COMPARE   "1",FTX005EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,FIVE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX500
          ENDIF
.
          COMPARE   "1",FTX006EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,SIX,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX600
          ENDIF
.
          COMPARE   "1",FTX007EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,SEVEN,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX700
          ENDIF
.
          COMPARE   "1",FTX008EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,EIGHT,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX800
          ENDIF
.
          COMPARE   "1",FTX009EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ZERO,NINE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFTX900
          ENDIF
.
          COMPARE   "1",FTX010EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,ZERO,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1000
          ENDIF
.
          COMPARE   "1",FTX011EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,ONE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1100
          ENDIF
.
          COMPARE   "1",FTX012EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,TWO,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1200
          ENDIF
.
          COMPARE   "1",FTX013EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,THREE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1300
          ENDIF
.
          COMPARE   "1",FTX014EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,FOUR,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1400
          ENDIF
.
          COMPARE   "1",FTX015EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,FIVE,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1500
          ENDIF
.
          COMPARE   "1",FTX016EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,SIX,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1600
          ENDIF
.
          COMPARE   "1",FTX017EX
          IF        @EQUAL
            PACK      KEY3,ZERO,ONE,SEVEN,SP70   * save record type to delete
            CALL      DELFTX00
            CALL      ADFT1700
          ENDIF
.
UPDFTX99  RETURN
+
.--------------------------------------------------------------------------
. * Delete obsftxaf details 
.--------------------------------------------------------------------------
DELFTX00  PACK      KEY14,OBNDVISN,KEY3,SP70
          CALL      RSOBFTX1
          CALL      RKOBFTX1
          BRANCH    OVRCD,DELFTX99
.
          MATCH     OBNDVISN,OBFTVISN   * same visit?
          GOTO      DELFTX99 IF NOT EQUAL
.
          MATCH     KEY3,OBFTTYPE        * same record type?
          GOTO      DELFTX99 IF NOT EQUAL
.
          PACK      KEY14,OBNDVISN,OBFTTYPE,OBFTLINE,SP70
          CALL      DEOBFTX1
          GOTO      DELFTX00
.
DELFTX99  RETURN
+
.--------------------------------------------------------------------------
. * Delete of Nursing Diagnosis
.--------------------------------------------------------------------------
DELNDD00  PACK      KEY8,OBNDD001,SP70
          CALL      DEOBNDD1
.
DELNDD99  RETURN
.


.------------------------------------------------------------
. Flag Clinical Note as Deleted 
.------------------------------------------------------------
DELTP000  MOVE      "1",OBCAMDL             * Set all Points & Note to deleted 
          MOVE      "1",OBCAP1D      
          MOVE      "1",OBCAP2D      
          MOVE      "1",OBCAP3D      
          MOVE      "1",OBCAP4D      
          CALL      UPOBCA1                 * Update File
          CALL      UUOBCA1                 * Unlock File
.         
DELTP099  RETURN
.
.------------------------------------------------------------
. Flag Clinical Note Point 1 as Deleted 
.------------------------------------------------------------
DELTP100  MOVE      "1",OBCAP1D             * Set Point 1 as deleted 
          CALL      UPOBCA1                 * Update File
          CALL      UUOBCA1                 * Unlock File
.         
DELTP199  RETURN
.
.------------------------------------------------------------
. Flag Clinical Note Point 2 as Deleted 
.------------------------------------------------------------
DELTP200  MOVE      "1",OBCAP2D             * Set Point 2 as deleted       
          CALL      UPOBCA1                 * Update File
          CALL      UUOBCA1                 * Unlock File
.         
DELTP299  RETURN
.
.------------------------------------------------------------
. Flag Clinical Note Point 3 as Deleted 
.------------------------------------------------------------
DELTP300  MOVE      "1",OBCAP3D             * Set Point 3 as deleted        
          CALL      UPOBCA1                 * Update File
          CALL      UUOBCA1                 * Unlock File
.         
DELTP399  RETURN
.
.------------------------------------------------------------
. Flag Clinical Note Point 4 as Deleted 
.------------------------------------------------------------
DELTP400  MOVE      "1",OBCAP4D             * Set Point 4 as deleted        
          CALL      UPOBCA1                 * Update File
          CALL      UUOBCA1                 * Unlock File
.         
DELTP499  RETURN
.
SETPAT00  MATCH     SP70,FHRRECID
          GOTO      SETPAT99 IF EQUAL
          UNPACK    FHRRECID,KEY4,ADMISSNO
          PACK      KEY8,ADMISSNO
          CALL      RDVISA1
          IF        OVRCD=0
            MOVE      PVIURNO,URNUMBER
          ENDIF
SETPAT99  RETURN
.---------------------------------------------------------------
. List Clinical Notes by Noteskey (Visit No. + Clinical Note ID) 
.---------------------------------------------------------------
VISRES00  IF        FHIRTYPE=1
            CALL      SETPAT00
          ENDIF
          MOVE      ZERO,EXIT
          PACK      KEY12,NOTESKEY,SP20
          CALL      RDOBCA1
          IF        OVRCD=1
            CALL      CLROBA00
          ENDIF
.
          PACK      KEY12,NOTESKEY,SP20
          CALL      RDOBCB1
          IF        OVRCD=1
            MOVE      SP70,OBCBLDT
          ENDIF
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDOBPIN1
          IF        OVRCD=1
            CALL      CLROBPIN
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDOBNDD1
          IF        OVRCD=1
            CALL      CLOBSNDD
          ENDIF
.
          MATCH     "A0",FORMACTN           * A0 = Add New Note
          IF        @EQUAL
            MOVE      "1",CHKNTSEC          * Check note type security
            CALL      ADDNT000              * Add New Note SubRoutine
            BRANCH    EXIT,VISRES99
            CALL      ADDNDD00              * Add Nursing Diagnosis
            CALL      UPNTD000              * Update note details
            CALL      PRDET000              * Update principle details
.           IF        MEDDET=0
              CALL      MDDET000            * Update medication details
.           ENDIF
            GOTO      VISRES91
          ENDIF
.
          MATCH     "U0",FORMACTN           * A0 = Add New Note
          IF        @EQUAL
            CALL      UPDNT000              * Update clinical summary
            CALL      UPDNDD00              * Update Nursing Diagnosis
            BRANCH    EXIT,VISRES99
.
            CALL      UPDFTX00              * Update obsftxaf records 
            CALL      UPNTD000              * Update note details
            CALL      PRDET000              * Update principle details
.           IF        MEDDET=0
              CALL      MDDET000            * Update medication details
.           ENDIF
            GOTO      VISRES91
          ENDIF
.
          MATCH     "A1",FORMACTN        * A1 = Add Multiple Service Order Notes
          IF        @EQUAL
            CALL      ADDML000           * Add New Note SubRoutine
            GOTO      VISRES91
          ENDIF
.
          MATCH     "A2",FORMACTN        * A2 = Add Pathology/Radiology Services
          IF        @EQUAL
            CALL      ADDSV000           * Add New Note SubRoutine
            GOTO      VISRES91
          ENDIF
.
          MATCH     "C2",FORMACTN        * C2 = Cancel Pathology/Radiology Services
          IF        @EQUAL
            CALL      CANSV000           * Add New Note SubRoutine
            BRANCH    EXIT,VISRES99
.
            GOTO      VISRES91
          ENDIF
.
          MATCH     "D0",FORMACTN           * D0 = Flag Note as Deleted
          IF        @EQUAL
            CALL      UPDATE00              * Check that Update key is OK
            BRANCH    EXIT,VISRES99
            CALL      DELTP000            * Delete Note SubRoutine
            CALL      DELNDD00              * Delete Type of Note SubRoutine
            GOTO      VISRES91
          ENDIF
.
          MATCH     "D1",FORMACTN           * D1 = Flag Point 1 as Deleted
          IF        @EQUAL
            CALL      UPDATE00              * Check that Update key is OK
            BRANCH    EXIT,VISRES99
            CALL      DELTP100            * Delete Point 1 SubRoutine
.
            IF        FHIRTYPE=1
              GOTO      VISRES91
            ENDIF
.
            GOTO      VISRES50
          ENDIF
.
          MATCH     "D2",FORMACTN           * D0 = Flag Point 2 as Deleted
          IF        @EQUAL
            CALL      UPDATE00              * Check that Update key is OK
            BRANCH    EXIT,VISRES99
            CALL      DELTP200            * Delete Point 2 SubRoutine
.
            IF        FHIRTYPE=1
              GOTO      VISRES91
            ENDIF
.
            GOTO      VISRES50
          ENDIF
.
          MATCH     "D3",FORMACTN           * D0 = Flag Point 3 as Deleted
          IF        @EQUAL
            CALL      UPDATE00              * Check that Update key is OK
            BRANCH    EXIT,VISRES99
            CALL      DELTP300            * Delete Point 3 SubRoutine
.
            IF        FHIRTYPE=1
              GOTO      VISRES91
            ENDIF
.
            GOTO      VISRES50
          ENDIF
.
          MATCH     "D4",FORMACTN           * D0 = Flag Point 4 as Deleted
          IF        @EQUAL
            IF        FHIRTYPE=1
              CALL      UPDATE00              * Check that Update key is OK
              BRANCH    EXIT,VISRES99
              CALL      DELTP400            * Delete Point 3 SubRoutine
              GOTO      VISRES91
            ELSE
              CALL      UPDATE00              * Check that Update key is OK
              IF        EXIT=0
                CALL      DELTP400            * Delete Point 4 SubRoutine
                GOTO      VISRES50
              ENDIF
              GOTO      VISRES91
            ENDIF
          ENDIF
.
          MATCH     "V0",FORMACTN           * V0 = View All
          IF        @EQUAL
            CALL      PMDU0000              * Show all records from pmsdauaf for UR
            GOTO      VISRES91
          ENDIF
.
VISRES40  CALL      GETPAT00
          BRANCH    EXIT,VISRES90
.
VISRES50  CALL      PATNAA00                * Format Name without Bold Tags
.
          CLEAR     WEBTITLE
          APPEND    "Clinical Notes for ",WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VISRES99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      VISRES99
.
VISRES90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VISRES99
.
VISRES91  MOVE      ZERO,EXIT                * Return to another Screen ?
.
VISRES99  CLOSE     FTXFILAA,DELETE
          CLOSE     FTXFILBB,DELETE
          CLOSE     FTXFILCC,DELETE
          CLOSE     FTXFILDD,DELETE
          CLOSE     FTXFILEE,DELETE
          CLOSE     FTXFILFF,DELETE
          CLOSE     FTXFILGG,DELETE
          CLOSE     FTXFILHH,DELETE
          CLOSE     FTXFILII,DELETE
          CLOSE     FTXFILJJ,DELETE
          CLOSE     FTXFILKK,DELETE
          CLOSE     FTXFILLL,DELETE
          CLOSE     FTXFILMM,DELETE
          CLOSE     FTXFILNN,DELETE
          CLOSE     FTXFILOO,DELETE
          CLOSE     FTXFILPP,DELETE
          CLOSE     FTXFILQQ,DELETE
.
          RETURN
+
.-------------------------------------------------------------------------------
. PMDU0000 - Show all records for a particular visit from pmsdauaf
.-------------------------------------------------------------------------------
PMDU0000  CALL      XMLHED00
          WRITE     HTMLFILE;"|";
.
          PACK      KEY27,URNUMBER,Z70
          CALL      RSPMDAU1
PMDU0100  CALL      RPPMDAU1
          BRANCH    OVRCD,PMDU9000
.
          MATCH     PMDEURNO,URNUMBER
          GOTO      PMDU9000 IF NOT EQUAL
.
          MATCH     "004",PMDERTYP
          GOTO      PMDU0100 IF NOT EQUAL
.
          PACK      KEY10,PMDECUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMDECUID,WBSENAM
          ENDIF
.
          UNPACK    PMDECDAT,DIM4,DIM2,D2
          PACK      DIM10,D2,SLASH,DIM2,SLASH,DIM4
.          
          WRITE     HTMLFILE;"<tr><td>",WBSENAM,"</td><td>":
                             DIM10," ",PMDECTIM:
                             "</td><td>",PMDEFL01,"</td><tr>";
.
          GOTO      PMDU0100
.
PMDU9000  WRITE     HTMLFILE;"|";
          CALL      XMLEND00
.
PMDU9999  RETURN
+
.------------------------------------------------------------
. Update detail tables 
.------------------------------------------------------------
UPNTD000  CALL      UPOBD000
          CALL      UPOBP000
          CALL      UPOBA000
          CALL      UPOBH000
          CALL      UPOBE000
          CALL      UPOBL000
          CALL      UPRES000
          CALL      UPPHY000
          CALL      UPDIT000
          CALL      UPCAL000
.
          RETURN
.------------------------------------------------------------
. Get Patient Details
.------------------------------------------------------------
GETPAT00  CALL      CLPATMAS
          CALL      CLPMSPX2
          IF        FHIRTYPE=1
            CALL      CLPATMIS
            CALL      CLPMSVX1
            MATCH     SP70,ADMISSNO
            GOTO      GETPAT20 IF EQUAL
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      ADMISSNO,KEY8           * Check for Valid Visit No.
          CALL      RDVISA1
          BRANCH    OVRCD,GETPAT80
.
          MATCH     PVIURNO,ZEROUR
          IF        @EQUAL
            CALL      GETVIS00
            BRANCH    EXIT,GETPAT99
          ELSE
.
            IF        FHIRTYPE=ONE
               MATCH    SP70,URNUMBER
               IF       @EQUAL | @EOS
                 MOVE     PVIURNO,URNUMBER
               ENDIF
            ENDIF
.
            MOVE      URNUMBER,KEY8           * Check for Valid U/R No.
            CALL      RDMAST1
            BRANCH    OVRCD,GETPAT90
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT20  MOVE      URNUMBER,KEY8           * Check for Valid U/R No.
          CALL      RDMAST1
          BRANCH    OVRCD,GETPAT90
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT80  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,GETPAT85
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT85  BRANCH    EMRFLAG,GETPAT90
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,GETPAT86
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT86  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1               * check if has booking 
          BRANCH    OVRCD,GETPAT90
.
          COMPARE   ZERO,BKRESTAT          * check if booked
          GOTO      GETPAT90 IF NOT EQUAL
.
          MOVE      URNUMBER,KEY8           * Check for Valid U/R No.
          CALL      RDMAST1
          BRANCH    OVRCD,GETPAT90
          MOVE      PURNO,KEY8
          CALL      RDPMPX21            
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GETPAT99
.
GETPAT90  MOVE      ONE,EXIT
.
GETPAT99  RETURN
.------------------------------------------------------------
. Get Name from Visit Based Tables
.------------------------------------------------------------
GETVIS00  BRANCH    PVITYPE,GETVIS10,GETVIS20,GETVIS20
          MOVE      ONE,EXIT
          GOTO      GETVIS99
.
GETVIS10  BRANCH    EMRFLAG,GETVIS90
          MOVE      PVIBILL,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,GETVIS90
.
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      GETVIS99
.
GETVIS20  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,GETVIS90
          MOVE      ZERO,EXIT
          GOTO      GETVIS99
.
GETVIS30  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,GETVIS90
          MOVE      ZERO,EXIT
          GOTO      GETVIS99
.
GETVIS90  MOVE      ONE,EXIT
.
GETVIS99  RETURN
.------------------------------------------------------------
. Clinical Note Details
.------------------------------------------------------------
DISNOT00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      DISNOT40 IF EQUAL
.
          MATCH     "A",UPDTTYPE           * Add Formaction
          GOTO      DISNOT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE           * Update Formaction
          GOTO      DISNOT20 IF EQUAL
.
          MATCH     "D",UPDTTYPE           * Delete Formaction
          GOTO      DISNOT30 IF EQUAL
.
          GOTO      DISNOT93
.
.         ************ ADD FORMACTION ***********
.
DISNOT10  CALL      CHKNOT00    * Checks mandatory fields and for blanks
          BRANCH    EXIT,DISNOT99
          RESET     CLNOT001
          PACK      KEY3,CLNOT001,SP70
          CALL      RDOBCC1     * Check if Note already exists
          COMPARE   ZERO,OVRCD
          GOTO      DISNOT92 IF EQUAL
          CALL      ADDNTN00              * Add New Type of Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      DISNOT99
.
.         ************ UPDATE FORMACTION **********
.
DISNOT20  CALL      CHKNOT00    * Checks mandatory fields and for blanks
          BRANCH    EXIT,DISNOT99
          CALL      UPDNTN00              * Update Type of Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      DISNOT99
.
.         ************ DELETE FORMACTION **********
.
DISNOT30  CALL      DELNTN00              * Delete Type of Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      DISNOT99
.
.         ************ DISPLAY FORMACTION **********
.
DISNOT40  PACK      KEY3,NOTETYPE,SP70
          CALL      RDOBCC1
          IF        OVRCD=1
            CALL      CLRDIS00     * Clear all the file variables
          ENDIF
.
          MOVE      "Note Type Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DISNOT99
.
DISNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISNOT99
.
DISNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISNOT99
.
DISNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISNOT99
.
DISNOT99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRDIS00  MOVE      SP70,OBCCTYP   *  Type of Note
          MOVE      SP70,OBCCDES   *  Description
          MOVE      SP70,OBCCTMI   *  Input Template ID
          MOVE      SP70,OBCCTMO   *  Output Template ID
          MOVE      SP70,OBCCSLV   *  Security Level
          MOVE      SP70,OBCCDHL   *  Default Highlight Level
.
CLRDIS99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLROBPIN  MOVE      SP70,OBPNVISN
          MOVE      SP70,OBPNPDIA
          MOVE      SP70,OBPNPPRO
          MOVE      SP70,OBPNREAA
.
          RETURN
+
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRMED00  MOVE      SP70,OBMDURNO  *  UR NUMBER
          MOVE      SP70,OBMDNOTE  *  Note Number
          MOVE      SP70,OBMDDATE  *  Date 
          MOVE      SP70,OBMDTIME  *  TIME   
          MOVE      SP70,OBMDUSER  *  User
          MOVE      SP70,OBMDOCCG  *  Occupational Gp.
          MOVE      SP70,OBMDDELT  *  Delete Indicator
          MOVE      SP70,OBMDDDAT  *  Delete Date
          MOVE      SP70,OBMDDTIM  *  Delete Time
          MOVE      SP70,OBMDDUSE  *  Delete User
.
          MOVE      SP70,OBMTURNO  *  UR Number
          MOVE      SP70,OBMTNOTE  *  Note
          MOVE      SP70,OBMTUNIQ  *  Uniq line number
          PACK      OBMTCMNT,SP70,SP70  *  Comment line
          MOVE      SP70,OBCCSPA   *  Spare
.
CLRMED99  RETURN
.------------------------------------------------------------
. Visit Comment Template Maintenance
.------------------------------------------------------------
VSCMTM00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      VSCMTM40 IF EQUAL
.
          MATCH     SP70,VSCTM001
          GOTO      VSCMTM95 IF EQUAL
.
          MATCH     "U",UPDATETY           * Update Formaction
          GOTO      VSCMTM20 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete Formaction
          GOTO      VSCMTM30 IF EQUAL
.
          GOTO      VSCMTM91
.
.         ************ UPDATE FORMACTION ***********
.
VSCMTM20  MOVE      VSCTM001,CODE
          MOVE      "VO",CATEGORY
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VSCMTM90
.
          CALL      UPDVSC00                * Update Routine for visit comment  
          BRANCH    EXIT,VSCMTM99
.  
          MOVE      ZERO,EXIT
          GOTO      VSCMTM99
.
.         ************ DELETE FORMACTION **********
.
VSCMTM30  MOVE      VSCTM001,CODE
          MOVE      "VO",CATEGORY                                              
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VSCMTM90 
.
          CALL      DELVSC00              * Delete SubRoutine for visit comment
          BRANCH    EXIT,VSCMTM99
.  
          MOVE      ZERO,EXIT
          GOTO      VSCMTM99
.  
.         ************ DISPLAY FORMACTION **********
.
VSCMTM40  MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,VSCMUNQ 
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70
.
          CALL      RDVSCTM1 
          IF        OVRCD=1
            CALL      CLRVSC00              * Clear all the file variables
          ENDIF
.
          MOVE      "Visit Comment Template Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VSCMTM99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      VSCMTM99
.
VSCMTM90  MOVE      "Invalid Template Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VSCMTM99
.
VSCMTM91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VSCMTM99
.
VSCMTM95  MOVE      "Invalid Selection",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VSCMTM99
.
VSCMTM98  MOVE      ZERO,EXIT
.
VSCMTM99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRVSC00  MOVE      SP70,VSCMTEM           * Template code (CAT VO)
          MOVE      SP70,VSCMUNQ           * Line No
          MOVE      SP70,VSCMCMT           * Comment Line
          MOVE      SP70,VSCMSPA           * Spare Variable  
.
CLRVSC99  RETURN
.
.------------------------------------------------------------
. Patient Medical Note Maintenance
.------------------------------------------------------------
MEDNOT00  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,MEDNOT90
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      MEDNOT40 IF EQUAL
.
          MATCH     "A",UPDATETY           * Add Formaction
          GOTO      MEDNOT10 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete Formaction
          GOTO      MEDNOT30 IF EQUAL
.
          GOTO      MEDNOT93
.
.         ************ ADD FORMACTION ***********
.
MEDNOT10  CALL      CHKMED00    * Checks mandatory fields and for blanks
          BRANCH    EXIT,MEDNOT99
.
          CALL      ADDMED00              * Add New Type of Note SubRoutine
          MOVE      ZERO,EXIT
          GOTO      MEDNOT99
.
.         ************ DELETE FORMACTION **********
.
MEDNOT30  CALL      DELMED00              * Delete Type of Note SubRoutine
          BRANCH    EXIT,MEDNOT99
.
          MOVE      ZERO,EXIT
          GOTO      MEDNOT99
.
.         ************ DISPLAY FORMACTION **********
.
MEDNOT40  *MOVE      URNUMBER,OBMDURNO   *  UR number
.
          PACK      KEY14,URNUMBER,NOTENUMB,SP70 
          CALL      RDOBMDT1 
          IF        OVRCD=1
            CALL      CLRMED00     * Clear all the file variables
          ENDIF
.
          MOVE      "Note Type Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEDNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEDNOT99
.
MEDNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDNOT99
.
MEDNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDNOT99
.
MEDNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDNOT99 
.
MEDNOT99  CLOSE     COMFILAF,DELETE
          RETURN
.
.-----------------------------------------------------------
. Delete a Medical Note for a Patient
.-----------------------------------------------------------
DELMED00  MATCH     SP70,URNUMBER
          GOTO      DELMED90 IF EQUAL     
.         
          MOVE      URNUMBER,OBMDURNO   *  UR number 
.
          PACK      KEY14,URNUMBER,NOTENUMB,SP70
          CALL      RDOBMDT1
          BRANCH    OVRCD,DELMED99
.
          MATCH     "1",SUPRFLAG
          IF          !@EQUAL
            MATCH     USERID,OBMDUSER         
            GOTO      DELMED91 IF NOT EQUAL  
          ENDIF
.
          MOVE      "1",OBMDDELT           * Delete Indicator
.
          PACK      OBMDDDAT,CCC,CYY,CMM,CDD
          REP       " 0",OBMDDDAT          * Delete Date
          CLOCK     TIME,OBMDDTIM          * Delete Time
          MOVE      USERID,OBMDDUSE        * Delete User
.
          PACK      KEY14,URNUMBER,NOTENUMB,SP70
          CALL      UPOBMDT1               * Write Record
          GOTO      DELMED98
.
DELMED90  MOVE      "U/R number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT 
          GOTO      DELMED99
.
DELMED91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT 
          GOTO      DELMED99
.
DELMED98  MOVE      ZERO,EXIT 
.
DELMED99  RETURN
.
.-----------------------------------------------------------
. * Checks mandatory fields, Checks U/R Number :cannot be blank
.------------------------------------------------------------
CHKMED00  RESET     URNUMBER
          MATCH     SP70,URNUMBER
          GOTO      CHKMED90 IF EQUAL
          GOTO      CHKMED98
.
CHKMED90  MOVE      "U/R number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKMED99
.
CHKMED98  MOVE      ZERO,EXIT
.
CHKMED99  RETURN
.
.-----------------------------------------------------------
. * Checks mandatory fields, Checks Type of note:cannot be blank
.------------------------------------------------------------
CHKNOT00  RESET     CLNOT001            * Lookup ID cannot be blank
          MATCH     SP70,CLNOT001
          GOTO      CHKNOT90 IF EQUAL
. 
          RESET     CLNOT024
          MATCH     SP70,CLNOT024
          GOTO      CHKNOT91 IF EQUAL
          GOTO      CHKNOT98
.
CHKNOT90  MOVE      "Type of Note cannot be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKNOT99
.
CHKNOT91  MOVE      "Description is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKNOT99
.
CHKNOT98  MOVE      ZERO,EXIT
.
CHKNOT99  RETURN
.
.-----------------------------------------------------------
. update visit comment template maintenance 
.-----------------------------------------------------------
UPDVSC00  PACK      KEY6,VSCTM001,SP70
          CALL      RSVSCTM1
UPDVSC10  CALL      RKVSCTM1
          BRANCH    OVRCD,UPDVSC20
          MATCH     VSCTM001,VSCMTEM
          GOTO      UPDVSC20 IF NOT EQUAL
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70 
          CALL      DEVSCTM1
          GOTO      UPDVSC10
.
.         now write the visit notes
.
UPDVSC20  MOVE      VSCTM001,VSCMTEM 
          COMPARE   ZERO,VSCTMIDX
          GOTO      UPDVSC99 IF EQUAL
          MOVE      ZERO,F3
UPDVSC30  ADD       ONE,F3
          MOVE      F3,VSCMUNQ
          PACK      KEY6,VSCMTEM,VSCMUNQ,SP70
          CALL      RDVSCTM1
          IF        OVRCD=0
            MOVE      VSCTM002[F3],VSCMCMT
            CALL      UPVSCTM1
          ELSE
            MOVE      VSCTM002[F3],VSCMCMT
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRVSCTM1
            TRAPCLR   IO
          ENDIF
          COMPARE   F3,VSCTMIDX
          GOTO      UPDVSC30 IF NOT EQUAL
          GOTO      UPDVSC99
.
UPDVSC99  RETURN
.-----------------------------------------------------------
. Delete visit comment template maintenance 
.-----------------------------------------------------------
DELVSC00  PACK      KEY6,VSCTM001,SP70
          CALL      RSVSCTM1
.
DELVSC10  CALL      RKVSCTM1
          BRANCH    OVRCD,DELVSC99
.
          MATCH     VSCTM001,VSCMTEM
          GOTO      DELVSC99 IF NOT EQUAL
.
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70 
          CALL      DEVSCTM1
          GOTO      DELVSC10
.
DELVSC99  RETURN
.-----------------------------------------------------------
. Add a Medical Note for a Patient
.-----------------------------------------------------------
ADDMED00  MOVE      ZERO,F6
          MOVE      URNUMBER,OBMDURNO   *  UR number     
.
          PACK      KEY14,URNUMBER,Z70
          CALL      RSOBMDT1
          CALL      RPOBMDT1            * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,OBMDNOTE      * Note Number
          ELSE
            MATCH     URNUMBER,OBMDURNO
            IF        @EQUAL
              MOVE      OBMDNOTE,F6
              ADD       ONE,F6
              MOVE      F6,OBMDNOTE
            ELSE
              MOVE      ONE,F6
              MOVE      F6,OBMDNOTE      * Note Number
            ENDIF
          ENDIF 
.
          PACK      OBMDDATE,CCC,CYY,CMM,CDD
          REP       " 0",OBMDDATE          * Date
          CLOCK     TIME,OBMDTIME          * Time
          MOVE      USERID,OBMDUSER        * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1 
          BRANCH    OVRCD,ADDMED99
.
          MOVE      WBSEOCG,OBMDOCCG       * Occupation Group
          MOVE      "0",OBMDDELT           * Delete Indicator
          MOVE      SP70,OBMDSPAR          * Spare
          MOVE      URNUMBER,OBMDURNO
          MOVE      SP70,OBMDDDAT          * Delete Date
          MOVE      SP70,OBMDDTIM          * Delete Time
          MOVE      SP70,OBMDDUSE          * Delete User
.
          PACK      KEY14,URNUMBER,OBMDNOTE,SP70
          CALL      RDOBMDT1
          IF        OVRCD=1 
            CALL      WROBMDT1               * Write Record
          ELSE
            GOTO      ADDMED99
          ENDIF     
.

.         now write the medical notes 
.
          MOVE      URNUMBER,OBMTURNO
          MOVE      OBMDNOTE,OBMTNOTE
          MOVE      ZERO,F3
.
ADDMED90  ADD       ONE,F3
          MOVE      F3,OBMTUNIQ
.
          READ      COMFILAF,SEQ;OBMTCMNT     
.
          PACK      KEY17,OBMTURNO,OBMTNOTE,OBMTUNIQ,SP70
          CALL      WROBMTX1
          IF        F3>=LASTITEM
            GOTO     ADDMED99 
          ENDIF
          GOTO      ADDMED90 
.
.  comments 
.
.        MOVE      URNUMBER,OBMTURNO
.        MOVE      OBMDNOTE,OBMTNOTE
.        MOVE      ZERO,F3
.ADDMED90  ADD       ONE,F3
.          MOVE      F3,OBMTUNIQ
.
.         MATCH     SP70,OBMTX001[F3] 
.         GOTO      ADDMED99 IF EQUAL
.   
.         MOVE      OBMTX001[F3],OBMTCMNT
.         PACK      KEY17,OBMTURNO,OBMTNOTE,OBMTUNIQ,SP70
.         CALL      WROBMTX1
.         GOTO      ADDMED90
.
ADDMED99  RETURN
+
.------------------------------------------------------------
. Fees Estimate Text Maintenance
.------------------------------------------------------------
FETXTM00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      FETXTM40 IF EQUAL
.
          MATCH     SP70,PMFET001
          GOTO      FETXTM95 IF EQUAL
.
          MATCH     "U",UPDATETY           * Update Formaction
          GOTO      FETXTM20 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete Formaction
          GOTO      FETXTM30 IF EQUAL
.
          GOTO      FETXTM91
.
.         ************ UPDATE FORMACTION ***********
.
FETXTM20  MOVE      PMFET001,CODE
          MOVE      "FE",CATEGORY
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,FETXTM90
.
          CALL      UPDFET00                * Update Routine for fees est text
          BRANCH    EXIT,FETXTM99
.
          MOVE      ZERO,EXIT
          GOTO      FETXTM99
.
.         ************ DELETE FORMACTION **********
.
FETXTM30  MOVE      PMFET001,CODE
          MOVE      "FE",CATEGORY
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,FETXTM90
.
          CALL      DELFET00              * Delete SubRoutine for fees est text
          BRANCH    EXIT,FETXTM99
.
          MOVE      ZERO,EXIT
          GOTO      FETXTM99
.
.         ************ DISPLAY FORMACTION **********
.
FETXTM40  MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,PMFELINE
          PACK      KEY6,PMFET001,PMFELINE,SP70
.
          CALL      RDPMFET1
          IF        OVRCD=1
            CALL      CLRFET00              * Clear all the file variables
          ENDIF
.
          MOVE      "Fees Estimate Text Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,FETXTM99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      FETXTM99
.
FETXTM90  MOVE      "Invalid Fees Est Text Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FETXTM99
.
FETXTM91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FETXTM99
.
FETXTM95  MOVE      "Invalid Selection",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FETXTM99
.
FETXTM98  MOVE      ZERO,EXIT
.
FETXTM99  RETURN
+
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRFET00  MOVE      SP70,PMFETYPE          * fees est text code (CAT FE)
          MOVE      SP70,PMFELINE          * Line No
          MOVE      SP70,PMFETEXT          * Comment Line
          MOVE      SP70,PMFESPAR          * Spare Variable
CLRFET99  RETURN    
+         
.-----------------------------------------------------------
. update Fees Estimate Text
.-----------------------------------------------------------
UPDFET00  PACK      KEY6,PMFET001,SP70
          CALL      RSPMFET1
UPDFET10  CALL      RKPMFET1
          BRANCH    OVRCD,UPDFET20
          MATCH     PMFET001,PMFETYPE
          GOTO      UPDFET20 IF NOT EQUAL
          PACK      KEY6,PMFET001,PMFELINE,SP70
          CALL      DEPMFET1
          GOTO      UPDFET10
.
.         now write the Fees Estimate Text
.
UPDFET20  MOVE      PMFET001,PMFETYPE
          COMPARE   ZERO,PMFETIDX
          GOTO      UPDFET99 IF EQUAL
          MOVE      ZERO,F3
UPDFET30  ADD       ONE,F3
          MOVE      F3,PMFELINE
          PACK      KEY6,PMFET001,PMFELINE,SP70
          CALL      RDPMFET1
          IF        OVRCD=0
            MOVE      PMFET002[F3],PMFETEXT
            CALL      UPPMFET1
          ELSE
            MOVE      PMFET002[F3],PMFETEXT
            CALL      WRPMFET1
          ENDIF
          COMPARE   F3,PMFETIDX
          GOTO      UPDFET30 IF NOT EQUAL
          GOTO      UPDFET99
.
UPDFET99  RETURN
+
.-----------------------------------------------------------
. Delete Fees Estimate Text
.-----------------------------------------------------------
DELFET00  PACK      KEY6,PMFET001,SP70
          CALL      RSPMFET1
DELFET10  CALL      RKPMFET1
          BRANCH    OVRCD,DELFET99
.
          MATCH     PMFET001,PMFETYPE
          GOTO      DELFET99 IF NOT EQUAL
.
          PACK      KEY6,PMFET001,PMFELINE,SP70
          CALL      DEPMFET1
          GOTO      DELFET10
.
DELFET99  RETURN
+
.------------------------------------------------------------
. Process Templated Fields
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFLD99:
                             PROFL110,PROFL120,PROFL130,PROFL140,PROFL150: 
                             PROFL160 
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD12  CALL      CLIF0000        * Clinical Notes Details 
          GOTO      PROFLD99
.
PROFLD13  CALL      DISS0000
          GOTO      PROFLD99
.
PROFLD14  CALL      NDIA0000
          GOTO      PROFLD99
.
PROFLD15  CALL      CLIB0000
          GOTO      PROFLD99
.
PROFLD16  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD17  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22   * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD22  CALL      NOTE0000        * Note Type Maintenance 
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32   * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD32  CALL      OBSN0000        * Note Type Maintenance 
          GOTO      PROFLD99
.

PROFLD40  BRANCH    FLDSETNO,PROFLD41           * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD41  CALL      VSCT0000        * Visit Comment Template Maintenance 
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52   * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD52  CALL      PMSN0000        * Note Type Maintenance 
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63 * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD62  CALL      VSMD0000        * Visit based comments      
          GOTO      PROFLD99
.
PROFLD63  CALL      VSCT0000        * Visit Comment Template Maintenance 
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72          * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD72  CALL      VSMD0000        * Visit based comments
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82          * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD82  CALL      ENCN0000        * Encounter based comments
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95:
                             PROFLD96,PROFLD97,PROFLD98,PROFL981
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFLD92  CALL      DISS0000        * Table of Clinical Notes
          GOTO      PROFLD99
.
PROFLD93  CALL      MISF0000        * Admission Details
          GOTO      PROFLD99
.
PROFLD94  CALL      DSCF0000        * Discharge Details
          GOTO      PROFLD99
.
PROFLD95  CALL      CLIF0000        * Clinical Notes Details 
          GOTO      PROFLD99
.
PROFLD96  CALL      GPDT0000        * GP Details
          GOTO      PROFLD99
.
PROFLD97  CALL      MISC0000        * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFLD98  CALL      VISF0000        * Visit file outputs
          GOTO      PROFLD99
.
PROFL981  CALL      NDIA0000        * Nursing Diagnosis Details
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111
          GOTO      PROFLD99
.
PROFL111  CALL      FETM0000        * Fees Estimate Text Maintenance
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122          * Branch on FieldSet No.
          GOTO      PROFLD99
.
PROFL121  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFL122  CALL      VSMD0000        * Visit based comments
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132,PROFL133          
          GOTO      PROFLD99
.
PROFL131  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFL132  CALL      VSCM0000        * Visit comments
          GOTO      PROFLD99
.
PROFL133  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142          
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFL142  CALL      URCM0000        * UR comments
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFL152  CALL      PATR0000        * Patient Attribute Details
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162
          GOTO      PROFLD99
.
PROFL161  CALL      MASF0000        * Patient Master Template Enquiries
          GOTO      PROFLD99
.
PROFL162  CALL      EXPT0000        * Expected Patient Comments
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.----------------------------------------------------------------------------
. Clinical Notes JSON functions
.----------------------------------------------------------------------------
CLIB0000  BRANCH    FLDITMNO,CLIB1100,CLIB1200
          GOTO      CLIB9999
.
.  Clinical & Visit Notes inc Emergency & Referrals All Visits
.
CLIB1100  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"function AddNoteRows() {"
          ENDIF
.
. All Visits
.
CLIB1110  MOVE      ZERO,DISNUMB
          PACK      KEY24,URNUMBER,Z70
          CALL      RSPTVIS2
CLIB1120  CALL      RPPTVIS2
          BRANCH    OVRCD,CLIB1190
          MATCH     URNUMBER,PVIURNO
          GOTO      CLIB1190 IF NOT EQUAL
          MOVE      PVIBILL,ADMISSNO
          CALL      VISN0000
          CALL      EMRN0000
          GOTO      CLIB1120
.
CLIB1190  IF        FHIRTYPE=0
            WRITE     HTMLFILE;" }"
          ENDIF
          PACK      PMDEFL01,SP70,SP70
          GOTO      CLIB9000

.
.  Clinical & Visit Notes inc Emergency & Referrals Current Visit
.
CLIB1200  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"function AddNoteRows() {"
          ENDIF
          MOVE      ZERO,DISNUMB
.
          CALL      VISN0000
          CALL      EMRN0000
.
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;" }"
          ENDIF
          PACK      PMDEFL01,ADMISSNO,SP70,SP70
          GOTO      CLIB9000
.
CLIB9000  PACK      KEY27,URNUMBER,PMDECDAT,CTIMEIS,PMDERTYP
          CALL      RDPMDAU1
          IF        OVRCD=1
            CLOCK     TIME,CTIMEIS
            PACK      PMDEURNO,URNUMBER,SP70
            PACK      PMDECDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMDECDAT
            PACK      PMDECTIM,CTIMEIS
            MOVE      "004",PMDERTYP
            PACK      PMDEFL02,C0601017,SP70,SP70
            PACK      PMDECUID,USERID,SP70
            CALL      WRPMDAU1
          ENDIF
.
CLIB9999  RETURN
.--------------------------------------------------------------------------------
. Visit Heading (Not Currently Used Possible Separation of Notes for Visits)
.--------------------------------------------------------------------------------
.VISHED00  MOVE      SP70,VISTDESC
.          MOVE      PTVITYPE,F2
.          LOAD      VISTDESC,F2,EDVISDES,OPVISDEC,IPVISDES,OTVISDES:
.                                EDVISDAY,OPVISCOM,IPVISWRD,OTVISAHC:
.                                EDVISEVT,OPVISALL
.          WRITE     HTMLFILE;"t.addRow(":
.                    QUOTE,PVIDATE,"00:00",QUOTE,COMMA:
.                    QUOTE,VISTDESC,QUOTE,COMMA:
.                    QUOTE,PVIBILL,QUOTE,COMMA:
.                    QUOTE,"VISIT",QUOTE,COMMA:
.                    QUOTE,"VISIT",QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,"Previous Visit",QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,SP1,QUOTE,COMMA:
.                    QUOTE,URNUMBER,QUOTE,");"
.VISHED99  RETURN
.--------------------------------------------------------------------------------
. Visit Notes
.--------------------------------------------------------------------------------
VISN0000  PACK      KEY12,ADMISSNO,Z70
          CALL      RSOBCA1
VISN1000  CALL      RPOBCA1
          BRANCH    OVRCD,VISN9999
.
          MATCH     ADMISSNO,OBCAVIS
          GOTO      VISN9999 IF NOT EQUAL
.
          IF        FHIRTYPE=ONE
.
            MATCH     SP70,FRSTDATE
            IF        !@EQUAL & !@EOS
              MATCH     FRSTDATE,OBCADTE
              GOTO      VISN1000 IF LESS
            ENDIF
.
            MATCH     SP70,LASTDATE
            IF        !@EQUAL & !@EOS
              MATCH     OBCADTE,LASTDATE
              GOTO      VISN1000 IF LESS
            ENDIF
.
          ENDIF
.
          BRANCH    FHIRTYPE,VISN1010
.
          MATCH     "1",SHOWDLTD
          GOTO      VISN1050 IF EQUAL
.
          MATCH     "0",OBCAMDL
          GOTO      VISN1000 IF NOT EQUAL
          GOTO      VISN1050

VISN1010  MATCH     "completed",FHIRSTAT
          IF        @EQUAL
            MATCH     "0",OBCAMDL
            GOTO      VISN1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "entered-in-error",FHIRSTAT
          IF        @EQUAL
            MATCH     "0",OBCAMDL
            GOTO      VISN1000 IF EQUAL
          ENDIF
.
VISN1050  PACK      KEY3,OBCATYP,SP70
          CALL      RDOBCC1
.
          MOVE      SP70,TDESC
          MATCH     SP70,OBCAOCG
          IF        !@EQUAL
            MOVE      "w0",KEY2
            PACK      KEY5,KEY2,OBCAOCG,SP70
            CALL      RDCODE1
          ENDIF
          MATCH     "1",OBCAP1D
          IF        @EQUAL
            MOVE      SP70,OBCAPT1
          ENDIF
.
          MATCH     "1",OBCAP2D
          IF        @EQUAL
            MOVE      SP70,OBCAPT2
          ENDIF
.
          MATCH     "1",OBCAP3D
          IF        @EQUAL
            MOVE      SP70,OBCAPT3
          ENDIF
.
          MATCH     "1",OBCAP4D
          IF        @EQUAL
            MOVE      SP70,OBCAPT4
          ENDIF
.
          BRANCH    FHIRTYPE,VISN4000
.
          PACK      KEY10,OBCAUID
          CALL      RDWBSE1
.
          WRITE     HTMLFILE;"t.addRow(":
                    QUOTE,OBCADTE,OBCATME,QUOTE,COMMA:
                    QUOTE,WBSENAM,QUOTE,COMMA:
                    QUOTE,OBCAVIS,QUOTE,COMMA:
                    QUOTE,OBCACID,QUOTE,COMMA:
                    QUOTE,TDESC,QUOTE,COMMA:
                    QUOTE,OBCAPT1,QUOTE,COMMA:
                    QUOTE,OBCAPT2,QUOTE,COMMA:
                    QUOTE,OBCAPT3,QUOTE,COMMA:
                    QUOTE,OBCAPT4,QUOTE,COMMA:
                    QUOTE,OBCCDES,QUOTE,COMMA:
                    QUOTE;
.
          PACK      KEY10,OBCALID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,OBCALID,SP70
          ENDIF
.
          PACK      KEY15,OBCAVIS,OBCACID,SP70
          CALL      RSOBCB1
VISN2000  CALL      RKOBCB1
          BRANCH    OVRCD,VISN3000
          MATCH     OBCAVIS,OBCBVIS
          GOTO      VISN3000 IF NOT EQUAL
          MATCH     OBCACID,OBCBCID
          GOTO      VISN3000 IF NOT EQUAL
          REP       "#"'",OBCBLDT
          STRIP     OBCBLDT
          MOVELPTR  OBCBLDT,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      OBCBLDT,OUTVAR
          WRITE     HTMLFILE;OUTVAR,"<br>";
          GOTO      VISN2000
VISN3000
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,OBCCTMO,QUOTE,COMMA:
                             QUOTE,OBCCTMI,QUOTE,COMMA:
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,OBCAMDL,QUOTE,COMMA:
                             QUOTE,WBSENAM,QUOTE,");"
          GOTO      VISN1000
.
VISN4000  CALL      FHRVSN00
          GOTO      VISN1000
VISN9999  RETURN
.------------------------------------------------------------
. FHIR Clinical Impression
.------------------------------------------------------------
FHRVSN00  PACK      KEY12,OBCAVIS,OBCACID,SP70
          REP       " -",KEY12
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          WRITE     HTMLFILE;*+,"    {":
                                " #"fullUrl#": #"%BASEURL/ClinicalImpression/VSN-",KEY12,"#",":
                                " #"resource#": ";
          CALL      RESVSN00
          WRITE     HTMLFILE;*+,"}";
          ADD       ONE,DISNUMB
          RETURN
.------------------------------------------------------------
. FHIR Clinical Impression Visit Note
.------------------------------------------------------------
RESVSN00  PACK      FHRPATID,URNUMBER,SP70
          SQUEEZE   FHRPATID
          PACK      FHRENCID,URNUMBER,OBCAVIS,SP70
          REP       " -",FHRENCID
          MATCH     "0",OBCAMDL
          IF        @EQUAL
            MOVE      "completed",FHRSTAT
          ELSE
            MOVE      "entered-in-error",FHRSTAT
          ENDIF
          UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
.
.         Get the last updated by user information
          PACK      KEY10,OBCALID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,OBCALID,SP70
          ENDIF
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"ClinicalImpression#",":
                    " #"id#" : #"VSN-",KEY12,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-lastupdate#"":
                        " ,#"valueString#":#"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                        "T",OBCATLU,"#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-lastupdateby#"":
                        " ,#"valueReference#":":
                        " { #"reference#" : #"Practitioner/User-",OBCALID,"#",":
                            " #"display#" : #"",WBSENAM,"#" } }";
.                    " { #"url#":#"%BASEURL/extension/dxc-hc-lastupdateby#"":
.                        " ,#"valueString#":#"",OBCALID,"#"}";
.
.          MATCH     SP70,OBCAOCG
.          IF        !@EQUAL & !@EOS
.            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-group#"":
.                        " ,#"valueString#":#"",OBCAOCG,"#"}";
.          ENDIF
.
.         Get the information of User who has input the clinical note information
          PACK      KEY10,OBCAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,OBCAUID,SP70
          ENDIF
.
          MATCH    SP70,OBCAOCG
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       ,{  #"url#" : #"%BASEURL/extension/dxc-hc-group#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-w0#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OBCAOCG,"#" ";
.
            PACK      KEY5,CATW0,OBCAOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        }";
.
          ENDIF
.
          MATCH    SP70,OBCAHLV
          IF       !@EQUAL & !@EOS
.
            WRITE     HTMLFILE;"       ,{  #"url#" : #"%BASEURL/extension/dxc-hc-highlightlevel#",";
            WRITE     HTMLFILE;"           #"valueCodeableConcept#" : {";
            WRITE     HTMLFILE;"                #"coding#": [ {";
            WRITE     HTMLFILE;"                  #"system#": #"%BASEURL/ValueSet/Category-w2#", ";
            WRITE     HTMLFILE;"                  #"code#": #"",OBCAHLV,"#" ";
.
            PACK      KEY5,CATW2,OBCAHLV,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"                  ,#"display#": #"",TDESC,"#"";
            ENDIF
.
            WRITE     HTMLFILE;"                 } ]";
            WRITE     HTMLFILE;"            }";
            WRITE     HTMLFILE;"        }";
.
          ENDIF
.
          MATCH     SP70,OBCACID
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-clinicalnoteid#"":
                        " ,#"valueString#":#"",OBCACID,"#"}";
          ENDIF
.
          MATCH     SP70,OBCASLV
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-securitylevel#"":
                        " ,#"valueString#":#"",OBCASLV,"#"}";
          ENDIF
.
          MATCH     SP70,OBCATYP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,OBCATYP,SP70
            CALL      RDOBCC1
            IF        OVRCD=0
.
              MATCH     SP70,OBCCSLV
              IF        !@EQUAL & !@EOS
                WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-typeseclevel#"":
                          " ,#"valueString#":#"",OBCCSLV,"#"}";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,OBCAMIN
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-duration#"":
                        " ,#"valueString#":#"",OBCAMIN,"#"}";
          ENDIF
.
          MATCH     SP70,OBCAPT1
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint1#"":
                        " ,#"valueString#":#"",OBCAPT1,"#"}";
          ENDIF
.
          MATCH     "1",OBCAP1D
          IF        @EQUAL
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint1-deleted#"":
                        " ,#"valueBoolean#":#"true#"}";
          ELSE
.            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint1-deleted#"":
.                        " ,#"valueBoolean#":#"false#"}"
          ENDIF
.
          MATCH     SP70,OBCAPT2
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint2#"":
                        " ,#"valueString#":#"",OBCAPT2,"#"}";
          ENDIF
.
          MATCH     "1",OBCAP2D
          IF        @EQUAL
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint2-deleted#"":
                        " ,#"valueBoolean#":#"true#"}";
          ELSE
.            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint2-deleted#"":
.                        " ,#"valueBoolean#":#"false#"}"
          ENDIF
.
          MATCH     SP70,OBCAPT3
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint3#"":
                        " ,#"valueString#":#"",OBCAPT3,"#"}";
          ENDIF
.
          MATCH     "1",OBCAP3D
          IF        @EQUAL
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint3-deleted#"":
                        " ,#"valueBoolean#":#"true#"}";
          ELSE
.            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint3-deleted#"":
.                        " ,#"valueBoolean#":#"false#"}"
          ENDIF
.
          MATCH     SP70,OBCAPT4
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint4#"":
                        " ,#"valueString#":#"",OBCAPT4,"#"}";
          ENDIF
.
          MATCH     "1",OBCAP4D
          IF        @EQUAL
            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint4-deleted#"":
                        " ,#"valueBoolean#":#"true#"}";
          ELSE
.            WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-mainpoint4-deleted#"":
.                        " ,#"valueBoolean#":#"false#"}"
          ENDIF
.
          MOVE      OBCAVIS,DIM8
          REP       " +",DIM8
          MOVE      OBCACID,DIM4
          REP       " +",DIM4
          MOVE      SP70,DIM12
          PACK      DIM12,DIM8,DIM4,SP70
.
          WRITE     HTMLFILE;",{ #"url#":#"%BASEURL/extension/dxc-hc-notes-key#"":
                    " ,#"valueString#":#"",DIM12,"#"}";
.
          WRITE     HTMLFILE;" ]";
.
          MATCH     SP70,OBCATYP
          IF        !@EQUAL & !@EOS
.
            PACK      KEY3,OBCATYP
            CALL      RDOBCC1  
            IF        OVRCD=1
              MOVE      SP70,OBCCDES
            ENDIF
.
            WRITE     HTMLFILE;",#"code#" : {":
                    "  #"coding#" : [":
                    "   { #"code#"      : #"",OBCATYP,"#",":
                    "     #"system#": #"%BASEURL/ValueSet/webPAS-Note-Type#", ":
                    "     #"display#"   : #"",OBCCDES,"#" } ":
                    "  ] }";
          ENDIF
.
          WRITE     HTMLFILE;",#"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#", ":
                                     "#"display#" : #"",PATFNAME,"#"}, ":
                    " #"context#":  { #"reference#" : #"Encounter/",FHRENCID,"#"}, ":
                    " #"status#" : #"",FHRSTAT,"#",":
                    " #"date#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                    "T",OBCATME,"",TIMEZONE,"#",":
                    " #"assessor#":  { #"reference#" : #"Practitioner/User-",OBCAUID,"#",":
                                     " #"display#" : #"",WBSENAM,"#" }, ":
                    " #"summary#":  #"";
.
          PACK      OUTVAR,SP70,SP70
          PACK      KEY15,OBCAVIS,OBCACID,SP70
          CALL      RSOBCB1
RESVSN10  CALL      RKOBCB1
          BRANCH    OVRCD,RESVSN20
          MATCH     OBCAVIS,OBCBVIS
          GOTO      RESVSN20 IF NOT EQUAL
          MATCH     OBCACID,OBCBCID
          GOTO      RESVSN20 IF NOT EQUAL
          REP       "#"'",OBCBLDT
          STRIP     OBCBLDT
          MOVELPTR  OBCBLDT,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      OBCBLDT,OUTVAR
          WRITE     HTMLFILE;*+,OUTVAR," ";
          GOTO      RESVSN10
.
RESVSN20  WRITE     HTMLFILE;*+,"#" }";
.
          RETURN
.
EMRN0000  MOVE      "001",KEY3
          PACK      KEY17,ADMISSNO,KEY3,SP70
          CALL      RSVSMDT1
EMRN1000  CALL      RKVSMDT1
          BRANCH    OVRCD,EMRN9999
          MATCH     ADMISSNO,VSMDVISN
          GOTO      EMRN9999 IF NOT EQUAL
.
          IF        FHIRTYPE=ONE
.
            MATCH     SP70,FRSTDATE
            IF        !@EQUAL & !@EOS
              MATCH     FRSTDATE,VSMDDATE
              GOTO      EMRN1000 IF LESS
            ENDIF
.
            MATCH     SP70,LASTDATE
            IF        !@EQUAL & !@EOS
              MATCH     VSMDDATE,LASTDATE
              GOTO      EMRN1000 IF LESS
            ENDIF
.
          ENDIF
.
          BRANCH    FHIRTYPE,EMRN1010
.
          MATCH     "1",SHOWDLTD
          GOTO      EMRN1050 IF EQUAL
.
          MATCH     "0",VSMDDELT
          GOTO      EMRN1000 IF NOT EQUAL
          GOTO      EMRN1050

EMRN1010  MATCH     "completed",FHIRSTAT
          IF        @EQUAL
            MATCH     "0",VSMDDELT
            GOTO      EMRN1000 IF NOT EQUAL
          ENDIF
.
          MATCH     "entered-in-error",FHIRSTAT
          IF        @EQUAL
            MATCH     "0",VSMDDELT
            GOTO      EMRN1000 IF EQUAL
          ENDIF
.
EMRN1050  PACK      KEY10,VSMDUSER
          CALL      RDWBSE1
.
          MATCH     "001",VSMDTYPE
          GOTO      EMRN1100 IF EQUAL
          MATCH     "008",VSMDTYPE
          GOTO      EMRN1800 IF EQUAL
          MATCH     "011",VSMDTYPE
          GOTO      EMRN1060 IF EQUAL      * ED Discharge Disposition Plan
          MATCH     "012",VSMDTYPE
          GOTO      EMRN1060 IF EQUAL      * ED Admission Disposition Plan
.
          GOTO      EMRN1000
.
EMRN1060  MATCH     SP70,VSMDDATE
          GOTO      EMRN1000 IF EQUAL    * Not finalised
          MATCH     "1",VSMDDELT
          GOTO      EMRN1000 IF EQUAL    * Deleted
.
.                                         001 - Emergency Clinical Notes
.                                         002 - Emergency Management Notes
.                                         007 - Emergency Doctors Notes
.                                         008 - Referral Notes
.                                         009 - Bed Request Notes
.                                         010 - Eclipse Notes
.                                         011 - ED Discharge Disposition Plan
.                                         012 - ED Admission Disposition Plan
.
EMRN1100  MOVE      "Emergency",NOTEDESC
          MOVE      "EMR",NOTECODE
          GOTO      EMRN1900
.
EMRN1800  MOVE      "Referral",NOTEDESC
          MOVE      "REF",NOTECODE
          GOTO      EMRN1900
.
EMRN1900  MOVE      SP70,TDESC
          MATCH     SP70,VSMDOCCG
          IF        !@EQUAL
            MOVE      "w0",KEY2
            PACK      KEY5,KEY2,VSMDOCCG,SP70
            CALL      RDCODE1
          ENDIF
.
          BRANCH    FHIRTYPE,EMRN4000
.
          WRITE     HTMLFILE;"t.addRow(":
                    QUOTE,VSMDDATE,VSMDTIME,QUOTE,COMMA:
                    QUOTE,WBSENAM,QUOTE,COMMA:
                    QUOTE,VSMDVISN,QUOTE,COMMA:
                    QUOTE,VSMDNOTE,QUOTE,COMMA:
                    QUOTE,TDESC,QUOTE,COMMA:
                    QUOTE,SP1,QUOTE,COMMA:
                    QUOTE,SP1,QUOTE,COMMA:
                    QUOTE,SP1,QUOTE,COMMA:
                    QUOTE,SP1,QUOTE,COMMA:
                    QUOTE,NOTEDESC,QUOTE,COMMA:
                    QUOTE;
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
EMRN2000  CALL      RKVSMTX1
          BRANCH    OVRCD,EMRN3000
          MATCH     VSMDVISN,VSMTVISN
          GOTO      EMRN3000 IF NOT EQUAL
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      EMRN3000 IF NOT EQUAL
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      EMRN3000 IF NOT EQUAL
          REP       "#"'",VSMTCMNT
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      VSMTCMNT,OUTVAR
          WRITE     HTMLFILE;OUTVAR,"<br>";
          GOTO      EMRN2000
EMRN3000  PACK      WBSENAM,SP70,SP70
          MATCH     "1",VSMDDELT
          IF        @EQUAL
            PACK      KEY10,VSMDDUSE,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              PACK      WBSENAM,SP70,SP70
            ENDIF
          ENDIF
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,NOTECODE,QUOTE,COMMA:
                             QUOTE,NOTECODE,QUOTE,COMMA:
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,VSMDDELT,QUOTE,COMMA:
                             QUOTE,WBSENAM,QUOTE,");"
          GOTO      EMRN1000
.
EMRN4000  CALL      FHREMR00
          GOTO      EMRN1000
.
EMRN9999  RETURN
.------------------------------------------------------------
. FHIR Clinical Impression
.------------------------------------------------------------
FHREMR00  PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          REP       " -",KEY17
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          WRITE     HTMLFILE;*+,"    {":
                                " #"fullUrl#": #"%BASEURL/ClinicalImpression/EMN-",KEY17,"#",":
                                " #"resource#": ";
          CALL      RESEMR00
          WRITE     HTMLFILE;*+,"}";
          ADD       ONE,DISNUMB
          RETURN
.------------------------------------------------------------
. FHIR Clinical Impression Visit Note
.------------------------------------------------------------
RESEMR00  PACK      FHRPATID,URNUMBER,SP70
          SQUEEZE   FHRPATID
          PACK      FHRENCID,URNUMBER,VSMDVISN,SP70
          REP       " -",FHRENCID
          MATCH     "0",VSMDDELT
          IF        @EQUAL
            MOVE      "completed",FHRSTAT
          ELSE
            MOVE      "entered-in-error",FHRSTAT
          ENDIF
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,VSMDUSER
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,VSMDUSER,SP70
          ENDIF
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"ClinicalImpression#",":
                    " #"id#" : #"EMN-",KEY17,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-group#"":
                        " ,#"valueString#":#"",VSMDOCCG,"#"}":
                    " ],":
                    " #"code#" : {":
                    "  #"coding#" : [":
                    "   { #"code#"      : #"",NOTEDESC,"#",":
                    "     #"display#"   : #"",NOTEDESC,"#" } ":
                    "  ] },":
                    " #"subject#":  { #"reference#" : #"Patient/",FHRPATID,"#", ":
                                     "#"display#" : #"",PATFNAME,"#"}, ":
                    " #"context#":  { #"reference#" : #"Encounter/",FHRENCID,"#"}, ":
                    " #"status#" : #"",FHRSTAT,"#",":
                    " #"date#" : #"",CCENT,CYEAR,DASH,CMON,DASH,CDAY:
                    "T",VSMDTIME,"",TIMEZONE,"#",":
                    " #"assessor#":  { #"reference#" : #"Practitioner/User-",VSMDUSER,"#",":
                                     " #"display#" : #"",WBSENAM,"#" }, ":
                    " #"summary#":   #"";
.
          PACK      OUTVAR,SP70,SP70
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
RESEMR10  CALL      RKVSMTX1
          BRANCH    OVRCD,RESEMR20
          MATCH     VSMDVISN,VSMTVISN
          GOTO      RESEMR20 IF NOT EQUAL
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      RESEMR20 IF NOT EQUAL
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      RESEMR20 IF NOT EQUAL
          REP       "#"'",VSMTCMNT
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      VSMTCMNT,OUTVAR
          WRITE     HTMLFILE;*+,OUTVAR," ";
          GOTO      RESEMR10
.
RESEMR20  WRITE     HTMLFILE;*+,"#"   }";
.
          RETURN
.--------------------------------------------------------------------------
. GP details     
.--------------------------------------------------------------------------
GPDT0000  BRANCH    FLDITMNO,GPDT0100,GPDT0200,GPDT0300,GPDT0400,GPDT0500:
                             GPDT0600,GPDT0700,GPDT9999,GPDT9999,GPDT9999:
                             GPDT1100,GPDT9999,GPDT9999,GPDT9999,GPDT1500:
                             GPDT1600,GPDT1700,GPDT1800,GPDT1900,GPDT9999:
                             GPDT9999,GPDT9999,GPDT9999,GPDT9999,GPDT9999:
                             GPDT9999,GPDT2700,GPDT2800,GPDT2900,GPDT3000:
                             GPDT3100,GPDT3200,GPDT3300,GPDT3400,GPDT3500:
                             GPDT3600,GPDT3700,GPDT3800,GPDT3900
          GOTO      GPDT9999
.
GPDT0100  PACK      PMHCTITL,SP70               * Secondary Doctor (CMO)
          PACK      PMHCSNAM,SP70
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GPDT9999
.
          PACK      KEY10,PMVXEDC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GPDT9999
.
          SQUEEZE   PMHCTITL
          MOVE      PMHCGNAM,DIM1
          SQUEEZE   PMHCSNAM
.
          PACK      CMO,PMHCTITL,SP1,DIM1,SP1,PMHCSNAM
          WRITE     HTMLFILE;CMO;
          GOTO      GPDT9999
.
GPDT0200  PACK      KEY8,ADMISSNO,SP70           * Referring Practice
          CALL      RDPMVX11
          BRANCH    OVRCD,GPDT9999
.
          PACK      KEY20,PMVXRH1G,SP70
          CALL      RDPMHCL2
GPDT0250  CALL      RKPMHCL2
          BRANCH    OVRCD,GPDT9999
.
          MATCH     PMHLHCPR,PMVXRH1G
          GOTO      GPDT9999 IF NOT EQUAL
.
          MATCH     PMHLHCPC,PMVXRHC1
          GOTO      GPDT0250 IF NOT EQUAL
.
          PACK      KEY12,PMHLHCPR,SP70
          CALL      RDPMHCG1
GPDT0280  CALL      RKPMHCG1
          BRANCH    OVRCD,GPDT0250
.
          MATCH     PMHGPRAC,PMHLHCPR
          GOTO      GPDT0250 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMHGPNAM;
          GOTO      GPDT0280
.
GPDT0300  PACK      DIAGNOS,SP70                 * Final Diagnosis
          UNPACK    SP20,KEY2,KEY3                                    *C-240107
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECD1
GPDT0310  CALL      RKPTECD1
          BRANCH    OVRCD,GPDT0390
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      GPDT0390 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN                * check for Episode 1
          GOTO      GPDT0310 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT               * check for Unique Counter = 1
          IF        @EQUAL
            MOVE      PTEDCODE,DIAGNOS1
            SQUEEZE   DIAGNOS1
            APPEND    DIAGNOS1,DIAGNOS
            GOTO      GPDT0310
          ELSE
             GOTO     GPDT0320
          ENDIF
.
GPDT0320  MOVE      TWO,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     "  2",DPTEDCNT               * check for Unique Counter = 2
          IF        @EQUAL
            APPEND    COMMA,DIAGNOS
            APPEND    SP1,DIAGNOS
            MOVE      PTEDCODE,DIAGNOS2
            SQUEEZE   DIAGNOS2
            APPEND    DIAGNOS2,DIAGNOS
            GOTO      GPDT0310
          ELSE
            GOTO     GPDT0330
          ENDIF
.
GPDT0330  MOVE      THREE,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     "  3",DPTEDCNT               * check for Unique Counter = 3
          IF        @EQUAL
            APPEND    COMMA,DIAGNOS
            APPEND    SP1,DIAGNOS
            MOVE      PTEDCODE,DIAGNOS3
            SQUEEZE   DIAGNOS3
            APPEND    DIAGNOS3,DIAGNOS
            GOTO      GPDT0310
          ELSE
             GOTO     GPDT0340
          ENDIF
.
GPDT0340  MOVE      FOUR,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     "  4",DPTEDCNT               * check for Unique Counter = 4
          IF        @EQUAL
            APPEND    COMMA,DIAGNOS
            APPEND    SP1,DIAGNOS
            MOVE      PTEDCODE,DIAGNOS4
            SQUEEZE   DIAGNOS4
            APPEND    DIAGNOS4,DIAGNOS
            GOTO      GPDT0310
          ELSE
             GOTO     GPDT0390
          ENDIF
.
GPDT0390  RESET     DIAGNOS
          STRIP     DIAGNOS
          WRITE     HTMLFILE;DIAGNOS;
          GOTO      GPDT9999
.
GPDT0400  PACK      KEY8,ADMISSNO,SP70            * Admission Date
          CALL      RDMISS1
          BRANCH    OVRCD,GPDT9999
.
          MOVE      ADATE,ADMDATE
          UNPACK    ADMDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;CPCDATE;
          GOTO      GPDT9999
.
GPDT0500  PACK      KEY8,ADMISSNO,SP70            * Discharge Date
          CALL      RDDSCH1
          BRANCH    OVRCD,GPDT9999
.
          MOVE      DDATE,DSCDATE
          UNPACK    DSCDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;CPCDATE;
          GOTO      GPDT9999
.
GPDT0600  PACK      KEY8,ADMISSNO,SP70            * Discharge Destination
          CALL      RDDSCH1
          BRANCH    OVRCD,GPDT9999
.
          MOVE      DDEST,DSCDCODE
.
          MOVE      "DD",KEY2
          PACK      KEY5,KEY2,DSCDCODE
          CALL      RDCODE1
          BRANCH    OVRCD,GPDT9999
.
          MOVE      TDESC,DSCDEST
.
          WRITE     HTMLFILE;DSCDEST;
          GOTO      GPDT9999
.
GPDT0700  PACK      PROCED,SP70                   * Operation Procedures
.
          PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECO1
GPDT0710  CALL      RKPTECO1
          BRANCH    OVRCD,GPDT0790
.
          MATCH     DPTEOADM,ADMISSNO
          GOTO      GPDT0790 IF NOT EQUAL
.
          MOVE      ONE,DIM1
          PACK      DIM2A,SP1,DIM1,SP70
.
          MATCH     DIM2A,DPTEOEPN
          GOTO      GPDT0710 IF NOT EQUAL
.
          MATCH     DIM2A,DPTEOCNT
          IF        @EQUAL
            MOVE      PTEOCODE,PROC1
            SQUEEZE   PROC1
            APPEND    PROC1,PROCED
            GOTO      GPDT0710
          ELSE
             GOTO     GPDT0720
          ENDIF
.
GPDT0720  MOVE      TWO,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     DIM2,DPTEOCNT
          IF        @EQUAL
            APPEND    COMMA,PROCED
            APPEND    SP1,PROCED
            MOVE      PTEOCODE,PROC2
            SQUEEZE   PROC2
            APPEND    PROC2,PROCED
            GOTO      GPDT0710
          ELSE
             GOTO     GPDT0730
          ENDIF
.
GPDT0730  MOVE      THREE,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     DIM2,DPTEOCNT
          IF        @EQUAL
            APPEND    COMMA,PROCED
            APPEND    SP1,PROCED
            MOVE      PTEOCODE,PROC3
            SQUEEZE   PROC3
            APPEND    PROC3,PROCED
            GOTO      GPDT0710
          ELSE
             GOTO     GPDT0740
          ENDIF
.
GPDT0740  MOVE      FOUR,DIM1
          PACK      DIM2,SP1,DIM1,SP70
.
          MATCH     DIM2,DPTEOCNT
          IF        @EQUAL
            APPEND    COMMA,PROCED
            APPEND    SP1,PROCED
            MOVE      PTEOCODE,PROC4
            SQUEEZE   PROC4
            APPEND    PROC4,PROCED
            GOTO      GPDT0710
          ELSE
             GOTO     GPDT0790
          ENDIF
.
GPDT0790  RESET     PROCED
          STRIP     PROCED
          WRITE     HTMLFILE;PROCED;
          GOTO      GPDT9999
.
GPDT1100  PACK      TPROCED,SP70                 * Theatre Procedures
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
GPDT1110  CALL      RDKMMBS1
          BRANCH    OVRCD,GPDT1190
.
          MATCH     DMMADMN,ADMISSNO
          GOTO      GPDT1190 IF NOT EQUAL
.
          MOVE      ONE,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,DMMRECN
          IF        @EQUAL
            MOVE      MMCODE,TPROC1
            SQUEEZE   TPROC1
            APPEND    TPROC1,TPROCED
            GOTO      GPDT1110
          ELSE
             GOTO     GPDT1120
          ENDIF
.
GPDT1120  MOVE      TWO,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,DMMRECN
          IF        @EQUAL
            APPEND    COMMA,TPROCED
            APPEND    SP1,TPROCED
            MOVE      MMCODE,TPROC2
            SQUEEZE   TPROC2
            APPEND    TPROC2,TPROCED
            GOTO      GPDT1110
          ELSE
             GOTO     GPDT1130
          ENDIF
.
GPDT1130  MOVE      THREE,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,DMMRECN
          IF        @EQUAL
            APPEND    COMMA,TPROCED
            APPEND    SP1,TPROCED
            MOVE      MMCODE,TPROC3
            SQUEEZE   TPROC3
            APPEND    TPROC3,TPROCED
            GOTO      GPDT1110
          ELSE
             GOTO     GPDT1140
          ENDIF
.
GPDT1140  MOVE      FOUR,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,DMMRECN
          IF        @EQUAL
            APPEND    COMMA,TPROCED
            APPEND    SP1,TPROCED
            MOVE      MMCODE,TPROC4
            SQUEEZE   TPROC4
            APPEND    TPROC4,TPROCED
            GOTO      GPDT1110
          ELSE
             GOTO     GPDT1190
          ENDIF
.
GPDT1190  RESET     TPROCED
          STRIP     TPROCED
          WRITE     HTMLFILE;TPROCED;
          GOTO      GPDT9999
.
GPDT1500  PACK      KEY13,ADMISSNO,SP70          * Nil Operations Performed
          CALL      RDPTECO1
GPDT1550  CALL      RKPTECO1
          BRANCH    OVRCD,GPDT1590
.
          MATCH     DPTEOADM,ADMISSNO
          GOTO      GPDT1590 IF NOT EQUAL
.
          MOVE      SP1,NILOPRTN
          WRITE     HTMLFILE;NILOPRTN;
          GOTO      GPDT9999
.
GPDT1590  MOVE      CROSS,NILOPRTN
          WRITE     HTMLFILE;NILOPRTN;
          GOTO      GPDT9999
.
GPDT1600  PACK      KEY8,ADMISSNO,SP70           * Admitting Diagnosis
          CALL      RDMISS1
          BRANCH    OVRCD,GPDT9999
.
          STRIP     ADIAG1
          STRIP     ADIAG2
.
          PACK      ADMDIAG,ADIAG1,COMMA,ADIAG2
          WRITE     HTMLFILE;ADMDIAG;
.
          GOTO      GPDT9999
.
GPDT1700  PACK      KEY8,ADMISSNO,SP70           * Unplanned Readmission
          CALL      RDPMVX11
          BRANCH    OVRCD,GPDT9999
.
          PACK      DIM2,ANSK,ANSO
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
GPDT1750  CALL      RDKCODE1
          BRANCH    OVRCD,GPDT9999
.
          MATCH     TCODE,DIM2
          GOTO      GPDT9999 IF NOT EQUAL
.
          MATCH     ACODE,PMVXUREA
          GOTO      GPDT1750 IF NOT EQUAL
.
          WRITE     HTMLFILE;TDESC;
          GOTO      GPDT9999
.
GPDT1800  PACK      KEY11,ADMISSNO,SP70          * Nil Adverse Outcomes
          CALL      RDPMPOD1
GPDT1850  CALL      RKPMPOD1
          BRANCH    OVRCD,GPDT1890
.
          MATCH     PMPOVISN,ADMISSNO
          GOTO      GPDT1890 IF NOT EQUAL
.
          MOVE      SP1,NILADVOC
          WRITE     HTMLFILE;NILADVOC;
          GOTO      GPDT9999
.
GPDT1890  MOVE      CROSS,NILADVOC
          WRITE     HTMLFILE;NILADVOC;
          GOTO      GPDT9999
.
GPDT1900  PACK      ADVERSE,SP70                 * Adverse Outcomes
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDPMPOD1
GPDT1910  CALL      RKPMPOD1
          BRANCH    OVRCD,GPDT1990
.
          MATCH     ADMISSNO,PMPOVISN
          GOTO      GPDT1990 IF NOT EQUAL
.
          MOVE      ONE,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS1
            SQUEEZE   ADVERS1
            APPEND    ADVERS1,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1920
          ENDIF
.
GPDT1920  MOVE      TWO,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS2
            SQUEEZE   ADVERS2
            APPEND    ADVERS2,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1930
          ENDIF
.
GPDT1930  MOVE      THREE,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS3
            SQUEEZE   ADVERS3
            APPEND    ADVERS3,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1940
          ENDIF
.
GPDT1940  MOVE      FOUR,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS4
            SQUEEZE   ADVERS4
            APPEND    ADVERS4,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1950
          ENDIF
.
GPDT1950  MOVE      FIVE,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS5
            SQUEEZE   ADVERS5
            APPEND    ADVERS5,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1960
          ENDIF
.
GPDT1960  MOVE      SIX,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS6
            SQUEEZE   ADVERS6
            APPEND    ADVERS6,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1970
          ENDIF
.
GPDT1970  MOVE      SEVEN,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS7
            SQUEEZE   ADVERS7
            APPEND    ADVERS7,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1980
          ENDIF
.
GPDT1980  MOVE      EIGHT,DIM1
          PACK      DIM3,SP2,DIM1,SP70
.
          MATCH     DIM3,PMPOOCNT
          IF        @EQUAL
            APPEND    COMMA,ADVERSE
            APPEND    SP1,ADVERSE
            PACK      KEY6,PMPOCODE,SP70
            CALL      RDPMADC1
            BRANCH    OVRCD,GPDT1990
.
            MOVE      PMACDESC,ADVERS8
            SQUEEZE   ADVERS8
            APPEND    ADVERS8,ADVERSE
            GOTO      GPDT1910
          ELSE
             GOTO     GPDT1990
          ENDIF
.
GPDT1990  RESET     ADVERSE
          STRIP     ADVERSE
          WRITE     HTMLFILE;ADVERSE;
          GOTO      GPDT9999
.
GPDT2700  PACK      PMHCTITL,SP70
          PACK      PMHCSNAM,SP70
.
          PACK      KEY8,URNUMBER,SP70           * Local/Registered GP(LMO)
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GPDT9999
.
          SQUEEZE   PMHCTITL
          MOVE      PMHCGNAM,DIM1
          SQUEEZE   PMHCSNAM

          PACK      LMO,PMHCTITL,SP1,DIM1,SP1,PMHCSNAM
          WRITE     HTMLFILE;LMO;
.
          GOTO      GPDT9999
.
GPDT2800  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Practice
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          PACK      KEY12,PMPXRH1G,SP70
          CALL      RDPMHCG1
GPDT2850  CALL      RKPMHCG1
          BRANCH    OVRCD,GPDT9999
.
          MATCH     PMHGPRAC,PMPXRH1G
          GOTO      GPDT9999 IF NOT EQUAL
.
          MOVE      ONE,DIM1
          PACK      DIM2,DIM1,SP70
          RJUSTIFY  DIM2
          MATCH     DIM2,PMHGCNTR
          GOTO      GPDT2850 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMHGPNAM;
          GOTO      GPDT2850
.
GPDT2900  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 1
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             STRIP     PMHCADR1
             WRITE     HTMLFILE;PMHCADR1;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT2950     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT2950 IF NOT EQUAL
.
             STRIP     PMHGADD1
             WRITE     HTMLFILE;PMHGADD1;
             GOTO      GPDT2950
          ENDIF
.
GPDT3000  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 2
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             STRIP     PMHCADR2
             WRITE     HTMLFILE;PMHCADR2;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3050     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3050 IF NOT EQUAL
.
             STRIP     PMHGADD2
             WRITE     HTMLFILE;PMHGADD2;
             GOTO      GPDT3050
          ENDIF
.
GPDT3100  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 3
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCADR3;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3150     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3150 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGADD3;
             GOTO      GPDT3150
          ENDIF
.
GPDT3200  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 4
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCADR4;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3250     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3250 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGADD4;
             GOTO      GPDT3250
          ENDIF
.
GPDT3300  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 5
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCADR5;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3350     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3350 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGADD5;
             GOTO      GPDT3350
          ENDIF
.
GPDT3400  PACK      KEY8,URNUMBER,SP70           * Local/Registered GP Address 6
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCADR6;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3450     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3450 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGADD6;
             GOTO      GPDT3450
          ENDIF
.
GPDT3500  PACK      KEY8,URNUMBER,SP70           * Postcode
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCPOST;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3550     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3550 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGPOST;
             GOTO      GPDT3550
          ENDIF
.
GPDT3600  PACK      KEY8,URNUMBER,SP70           * State
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCSTAT;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3650     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3650 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGSTAT;
             GOTO      GPDT3650
          ENDIF
.
GPDT3700  PACK      DTITL,SP70
          PACK      DSNAME,SP70
.
          PACK      KEY8,ADMISSNO,SP10            * Attending Doc (VMO)
          CALL      RDMISS1
          BRANCH    OVRCD,GPDT9999
.
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,GPDT9999
.
          SQUEEZE   DTITL
          MOVE      DGNAME,DIM1
          SQUEEZE   DSNAME
.
          PACK      VMO,DTITL,SP1,DIM1,SP1,DSNAME
          WRITE     HTMLFILE;VMO;
          GOTO      GPDT9999
.
GPDT3800  PACK      KEY8,URNUMBER,SP70           * State
          CALL      RDPMPX21
          BRANCH    OVRCD,GPDT9999
.
          MATCH     SP10,PMPXRH1G
          IF        @EQUAL
             PACK     KEY10,PMPXRHC1,SP10
             CALL      RDPMHCP1
             BRANCH    OVRCD,GPDT9999
             WRITE     HTMLFILE;PMHCFAXN;
             GOTO      GPDT9999
          ELSE
             PACK      KEY12,PMPXRH1G,SP70
             CALL      RDPMHCG1
GPDT3850     CALL      RKPMHCG1
             BRANCH    OVRCD,GPDT9999
.
             MATCH     PMPXRH1G,PMHGPRAC
             GOTO      GPDT9999 IF NOT EQUAL
.
             MOVE      ONE,DIM1
             PACK      DIM2,DIM1,SP70
             RJUSTIFY  DIM2
             MATCH     DIM2,PMHGCNTR
             GOTO      GPDT3850 IF NOT EQUAL
.
             WRITE     HTMLFILE;PMHGPFAX;
             GOTO      GPDT3850
          ENDIF
.
GPDT3900  READ      CONTROLF,HUND03;*196,PTCNCATA
.
          PACK      KEY16,URNUMBER,PTCNCATA,SP70
          CALL      RSPTALR1
GPDT3950  CALL      RKPTALR1
          BRANCH    OVRCD,GPDT9999
.
          MATCH     PTALURNO,URNUMBER            * allergy catgegory ?
          GOTO      GPDT9999 IF NOT EQUAL
.
          MATCH     PTALCATG,PTCNCATA            * allergy catgegory ?
          GOTO      GPDT9999 IF NOT EQUAL
.
          PACK      KEY5,PTCNCATA,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GPDT3950
.
          WRITE     HTMLFILE;TDESC;
          GOTO      GPDT3950
.
GPDT9999  RETURN
.
.--------------------------------------------------------------------------
. Clinical notes details     
.--------------------------------------------------------------------------
DISS0000  BRANCH    FLDITMNO,DISS0100,DISS0200,DISS0300,DISS0400,DISS0500:
                             DISS0600,DISS0700,DISS0800,DISS0900,DISS1000:
                             DISS1100,DISS1200,DISS1300,DISS1400,DISS1500:
                             DISS1600,DISS1700
          GOTO      DISS9999
.
DISS0100  PROC      CLNTAB00
          GOTO      DISS9999
.
DISS0200  CALL      NOTNXT00                 * Next Group of Notes
          GOTO      DISS9999
.
DISS0300  CALL      NOTPRE00                 * Previous Group of Notes
          GOTO      DISS9999
.
DISS0400  CALL      APPTAB00                 * Outpatient bookings    
          GOTO      DISS9999
.
DISS0500  MOVE      ZERO,MEDDET
          CALL      MEDDET00                 * Medications details
          GOTO      DISS9999
.
DISS0600  MOVE      ZERO,LINBREAK
          MOVE      ZERO,NOTEFORM
          CALL      PRNOT000                 * Notes Table For Printing by Admission No
          GOTO      DISS9999
.
DISS0700  MOVE      ZERO,LINBREAK
          MOVE      ZERO,NOTEFORM
          CALL      URNOT000                 * Notes Table For Printing by UR
          GOTO      DISS9999
.
DISS0800  CALL      MEDJSN00                 * Medications details
          GOTO      DISS9999
.
DISS0900  CALL      MEDROW00                 * Medications details
          GOTO      DISS9999
.
DISS1000  MOVE      ONE,LINBREAK
          MOVE      ZERO,NOTEFORM
          CALL      PRNOT000                 * Notes Table For Printing by Admission No
          GOTO      DISS9999
.
DISS1100  MOVE      ONE,LINBREAK
          MOVE      ZERO,NOTEFORM
          CALL      URNOT000                 * Notes Table For Printing by UR
          GOTO      DISS9999
.
DISS1200  MOVE      ZERO,LINBREAK
          CALL      PRCAN000                 * VISMDTAF Table For Printing by Admission No
          GOTO      DISS9999
.
DISS1300  MOVE      ONE,LINBREAK
          CALL      PRCAN000                 * VISMDTAF Table For Printing by Admission No
          GOTO      DISS9999
.
DISS1400  MOVE      ONE,MEDDET
          CALL      MEDDET00                 * Medications details (Branches to different output)
          GOTO      DISS9999
.
DISS1500  MOVE      ZERO,LINBREAK
          MOVE      ONE,NOTEFORM             * HealthECare Note Format
          CALL      PRNOT000                 * Notes Table For Printing by Admission No
          GOTO      DISS9999
.
DISS1600  MOVE      ONE,LINBREAK
          MOVE      ONE,NOTEFORM             * HealthECare Note Format
          CALL      PRNOT000                 * Notes Table For Printing by Admission No
          GOTO      DISS9999
.
DISS1700  MOVE      FHRRECID,KEY4
          MATCH     "VSN ",KEY4
          IF        @EQUAL
            UNPACK    FHRRECID,KEY4,KEY12
            CALL      RDOBCA1
            BRANCH    OVRCD,DISS9999
            CALL      RESVSN00
          ENDIF
.
          MATCH     "EMN ",KEY4
          IF        @EQUAL
            UNPACK    FHRRECID,KEY4,KEY17
            CALL      RDVSMDT1
            BRANCH    OVRCD,DISS9999
            MATCH     "008",VSMDTYPE
            IF        @EQUAL
              MOVE      "Referral",NOTEDESC
            ELSE
              MOVE      "Emergency",NOTEDESC
            ENDIF
            CALL      RESEMR00
          ENDIF
          GOTO      DISS9999
.
DISS9999  RETURN
.--------------------------------------------------------------------------
. Output General Note Type Comment Text for Printing for this U/R
.--------------------------------------------------------------------------
URNOT000  MOVE     ADMISSNO,SAVADMNO
          PACK     KEY24,URNUMBER,Z70
          CALL     RDSVISA2
URNOT100  CALL     RDPVISA2
          BRANCH   OVRCD,URNOT999
          MATCH    URNUMBER,PVIURNO
          GOTO     URNOT999 IF NOT EQUAL
          MOVE     PVIBILL,ADMISSNO
          CALL     PRNOT000
          GOTO     URNOT100
.
URNOT999  MOVE     SAVADMNO,ADMISSNO
          RETURN
.
.-------------------------------------------------
. Print Selected Visit Comments
.-------------------------------------------------
PRCAN000  UNPACK    DIM127,D1,NOTETYPE,DIM127
          PACK      KEY17,ADMISSNO,NOTETYPE,SP70
          CALL      RSVSMDT1
PRCAN100  CALL      RKVSMDT1
          BRANCH    OVRCD,PRCAN999
          MATCH     ADMISSNO,VSMDVISN
          GOTO      PRCAN999 IF NOT EQUAL
          MATCH     NOTETYPE,VSMDTYPE
          GOTO      PRCAN999 IF NOT EQUAL
          MATCH     "0",VSMDDELT
          GOTO      PRCAN999 IF NOT EQUAL
.
          PACK      KEY10,VSMDUSER
          CALL      RDWBSE1
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      VSMDTIME,KEY5
          WRITE     HTMLFILE;"<tr><td class=notedate><h4 class=notehead>":
                              CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," at ",KEY5:
                             " by ",WBSENAM,"</h4></td></tr>":
                             "<tr><td class=notetext>";
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
PRCAN200  CALL      RKVSMTX1
          BRANCH    OVRCD,PRCAN300
          MATCH     VSMDVISN,VSMTVISN
          GOTO      PRCAN300 IF NOT EQUAL
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      PRCAN300 IF NOT EQUAL
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      PRCAN300 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          IF        LINBREAK=0
            WRITE     HTMLFILE;VSMTCMNT;
          ELSE
            WRITE     HTMLFILE;VSMTCMNT,"<br>";
          ENDIF
          GOTO      PRCAN200
PRCAN300
          WRITE     HTMLFILE;"</td></tr>"
          GOTO      PRCAN100
.
PRCAN999  PACK      KEY80,SECUREID,SP256
          CALL      RDWBSE7
          IF        OVRCD=1
            REP       LOWUPP,KEY80
            CALL      RDWBSE7
          ENDIF
          RETURN
.
.--------------------------------------------------------------------------
. Output General Note Type Comment Text for Printing for this Visit
.--------------------------------------------------------------------------
PRNOT000  PACK      KEY12,ADMISSNO,SP70
          CALL      RSOBCA1                 * Positional Read
PRNOT100  CALL      RKOBCA1                 * Read Next Record
          BRANCH    OVRCD,PRNOT999
          MATCH     ADMISSNO,OBCAVIS
          GOTO      PRNOT999 IF NOT EQUAL
          MATCH     "1",OBCAMDL             * Check for Deleted Notes
          GOTO      PRNOT100 IF EQUAL
.
          MATCH     SP70,NOTETYPE
          IF        !@EQUAL
            MATCH     NOTETYPE,OBCATYP
            GOTO      PRNOT100 IF NOT EQUAL
          ENDIF
          MATCH     SP70,OCCGROUP
          IF        !@EQUAL
            MATCH     OCCGROUP,OBCAOCG
            GOTO      PRNOT100 IF NOT EQUAL
          ENDIF
          PACK      KEY10,OBCAUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
          UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      OBCATME,KEY5
          IF        NOTEFORM=0
            WRITE     HTMLFILE;"<tr><td class=notedate><h4 class=notehead>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," at ",KEY5:
                               " by ",WBSENAM,"</h4></td></tr>":
                               "<tr><td class=notetext>";
          ELSE
            PACK      KEY3,OBCATYP
            CALL      RDOBCC1
            WRITE     HTMLFILE;"<tr><td class=notedate><h4 class=notehead>":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," at ",KEY5:
                               " by ",WBSENAM,"(",OBCCDES,")</h4></td></tr>":
                               "<tr><td class=notetext>";
          ENDIF
          PACK      KEY15,OBCAVIS,OBCACID,SP70
          CALL      RSOBCB1                 * Positional Read
PRNOT200  CALL      RKOBCB1                 * Read Next Record
          BRANCH    OVRCD,PRNOT300
          MATCH     OBCBVIS,OBCAVIS
          GOTO      PRNOT300 IF NOT EQUAL
          MATCH     OBCBCID,OBCACID
          GOTO      PRNOT300 IF NOT EQUAL
          STRIP     OBCBLDT
          IF        LINBREAK=0
            WRITE     HTMLFILE;OBCBLDT;
          ELSE
            WRITE     HTMLFILE;OBCBLDT,"<br>";
          ENDIF
          GOTO      PRNOT200
PRNOT300
          WRITE     HTMLFILE;"</td></tr>"
          GOTO      PRNOT100
.
PRNOT999  PACK      KEY80,SECUREID,SP256
          CALL      RDWBSE7
          IF        OVRCD=1
            REP       LOWUPP,KEY80
            CALL      RDWBSE7
          ENDIF
          RETURN
.--------------------------------------------------------------------------
. Nursing Diagnosis outputs
.--------------------------------------------------------------------------
NDIA0000  BRANCH    FLDITMNO,NDIA0100,NDIA0200,NDIA0300,NDIA0400,NDIA0500:
                             NDIA0600,NDIA0700,NDIA0800,NDIA0900,NDIA1000:
                             NDIA1100,NDIA1200,NDIA1300,NDIA1400,NDIA1500:
                             NDIA1600,NDIA1700,NDIA1800
          GOTO      NDIA9999
.
NDIA0100  WRITE     HTMLFILE;OBNDVISN;
          GOTO      NDIA9999
.
NDIA0200  WRITE     HTMLFILE;OBNDNDG1;
          GOTO      NDIA9999
.
NDIA0300  WRITE     HTMLFILE;OBNDACP1;
          GOTO      NDIA9999
.
NDIA0400  WRITE     HTMLFILE;OBNDNDG2;
          GOTO      NDIA9999
.
NDIA0500  WRITE     HTMLFILE;OBNDACP2;
          GOTO      NDIA9999
.
NDIA0600  WRITE     HTMLFILE;OBNDNDG3;
          GOTO      NDIA9999
.
NDIA0700  WRITE     HTMLFILE;OBNDACP3;
          GOTO      NDIA9999
.
NDIA0800  WRITE     HTMLFILE;OBNDNDG4;
          GOTO      NDIA9999
.
NDIA0900  WRITE     HTMLFILE;OBNDACP4;
          GOTO      NDIA9999
.
NDIA1000  WRITE     HTMLFILE;OBNDNDG5;
          GOTO      NDIA9999
.
NDIA1100  WRITE     HTMLFILE;OBNDACP5;
          GOTO      NDIA9999
.
NDIA1200  WRITE     HTMLFILE;OBNDNDG6;
          GOTO      NDIA9999
.
NDIA1300  WRITE     HTMLFILE;OBNDACP6;
          GOTO      NDIA9999
.
NDIA1400  CALL      OBFTX000           * output obsftxaf textareas
          GOTO      NDIA9999
.
NDIA1500  CALL      OBFTXR00           * output obsftxaf defaults for UR
          GOTO      NDIA9999
.
NDIA1600  MOVE      ZERO,FORMATTY
          CALL      OBMED000           * Output discharge medications
          GOTO      NDIA9999
.
NDIA1700  MOVE      ONE,FORMATTY
          CALL      OBMED000           * Output medications in table format
          GOTO      NDIA9999           * for tinymce snipet
.
NDIA1800  CALL      HPFX0000           * Use Practice if GP fax no is blank
          GOTO      NDIA9999           * for tinymce snipet
.
NDIA9999  RETURN
+
.------------------------------------------------------------
.         If GP fax number is blank, use Practice fax number
.------------------------------------------------------------
HPFX0000  PACK      GENPCODE,PMPXRHC1,SP70
          MATCH     SP70,GENPCODE
          GOTO      HPFX9999 IF EQUAL
.
          PACK      KEY10,GENPCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HPFX9999
.
          MATCH     SP70,PMHCFAXN       * Blank GP Fax number?
          GOTO      HPFX1820 IF NOT EQUAL
.
          MATCH     SP70,PMPXRH1G       * Blank practice?
          GOTO      HPFX1820 IF EQUAL
.
          MOVE      ZERO,F2
          MOVE      PMPXR1GC,F2
          PACK      KEY10,PMPXRH1G,SP70
          PACK      GPPCCODE,KEY10,F2
.
          PACK      KEY12,GPPCCODE,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,HPFX9999
.
          WRITE     HTMLFILE;PMHGPFAX;      * Practice fax number
          GOTO      HPFX9999
.
HPFX1820  WRITE     HTMLFILE;PMHCFAXN;      * GP fax number
          GOTO      HPFX9999
.
HPFX9999  RETURN
+
.------------------------------------------------------------
.         Visit HCP/Practice details
.------------------------------------------------------------
HPPR0000  UNPACK    DIM127,D1,FLDITEM,DIM127
          MOVE      FLDITEM,FLDITMNO
.
          MATCH     SP70,PMVXRH1G
          GOTO      HPPR0500 IF NOT EQUAL   * set to practice details
.
          PACK      GENPCODE,PMVXRHC1,SP70
          MATCH     SP70,GENPCODE
          GOTO      HPPR9999 IF EQUAL
.
. HCP variables
.
          PACK      KEY10,GENPCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HPPR9999
.
          BRANCH    FLDITMNO,HPPR0010,HPPR0020,HPPR0030,HPPR0040,HPPR0050:
                             HPPR0060,HPPR0070,HPPR0080,HPPR0090
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      HPPR9999
.
HPPR0010  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      HPPR9999
.
HPPR0020  WRITE     HTMLFILE;PMHCADR1;
          GOTO      HPPR9999
.
HPPR0030  WRITE     HTMLFILE;PMHCADR2;
          GOTO      HPPR9999
.
HPPR0040  WRITE     HTMLFILE;PMHCADR3;
          GOTO      HPPR9999
.
HPPR0050  WRITE     HTMLFILE;PMHCADR4;
          GOTO      HPPR9999
.
HPPR0060  WRITE     HTMLFILE;PMHCADR5;
          GOTO      HPPR9999
.
HPPR0070  WRITE     HTMLFILE;PMHCADR6;
          GOTO      HPPR9999
.
HPPR0080  WRITE     HTMLFILE;PMHCPOST;
          GOTO      HPPR9999
.
HPPR0090  WRITE     HTMLFILE;PMHCFAXN;
          GOTO      HPPR9999
.
. Practice variables
.
HPPR0500  MOVE      ZERO,F2
          MOVE      PMVXRH1C,F2
          PACK      KEY10,PMVXRH1G,SP70
          PACK      GPPCCODE,KEY10,F2
.
          PACK      KEY12,GPPCCODE,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,HPPR9999
.
          BRANCH    FLDITMNO,HPPR0510,HPPR0520,HPPR0530,HPPR0540,HPPR0550:
                             HPPR0560,HPPR0570,HPPR0580,HPPR0590
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      HPPR9999
.
HPPR0510  WRITE     HTMLFILE;PMHGPNAM;
          GOTO      HPPR9999
.
HPPR0520  WRITE     HTMLFILE;PMHGADD1;
          GOTO      HPPR9999
.
HPPR0530  WRITE     HTMLFILE;PMHGADD2;
          GOTO      HPPR9999
.
HPPR0540  WRITE     HTMLFILE;PMHGADD3;
          GOTO      HPPR9999
.
HPPR0550  WRITE     HTMLFILE;PMHGADD4;
          GOTO      HPPR9999
.
HPPR0560  WRITE     HTMLFILE;PMHGADD5;
          GOTO      HPPR9999
.
HPPR0570  WRITE     HTMLFILE;PMHGADD6;
          GOTO      HPPR9999
.
HPPR0580  WRITE     HTMLFILE;PMHGPOST;
          GOTO      HPPR9999
.
HPPR0590  WRITE     HTMLFILE;PMHGPFAX;
          GOTO      HPPR9999
.
HPPR9999  RETURN
+
.------------------------------------------------------------
. Display obsftxaf record
.------------------------------------------------------------
OBFTX000  UNPACK    DIM127,D1,KEY3,DIM127        * key3=obfttype
          UNPACK    DIM127,D1,KEY1,DIM127
.
          PACK      KEY14,OBNDVISN,KEY3,SP70
          CALL      RSOBFTX1
OBFTX010  CALL      RKOBFTX1
          BRANCH    OVRCD,OBFTX999
          MATCH     OBNDVISN,OBFTVISN
          GOTO      OBFTX999 IF NOT EQUAL
          MATCH     OBFTTYPE,KEY3
          GOTO      OBFTX999 IF NOT EQUAL
          STRIP     OBFTDATA
          MOVELPTR  OBFTDATA,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      OBFTDATA,VAR
.
          MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;VAR,"<br>" 
          ELSE
            WRITE     HTMLFILE;VAR
          ENDIF
.
          SFORMAT   VAR,127
.
          GOTO      OBFTX010
OBFTX999  RETURN
+
.------------------------------------------------------------
. Display obsmedaf record
.------------------------------------------------------------
OBMED000  PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
OBMED100  CALL      RKOBMED1
          BRANCH    OVRCD,OBMED999
.
          MATCH     ADMISSNO,OBMEVISN
          GOTO      OBMED999 IF NOT EQUAL
.
          STRIP     OBMEDRBR
          STRIP     OBMEDRUG
          STRIP     OBMEDOSE
          STRIP     OBMEINST
.
          BRANCH    FORMATTY,OBMED110
          WRITE     HTMLFILE;""
          WRITE     HTMLFILE;"Date: ",OBMESCDT
          WRITE     HTMLFILE;"Medicine: ",*+,OBMEDRBR," ",*+,OBMEDRUG
          WRITE     HTMLFILE;"Form and Strength: ",*+,OBMEDOSE
          WRITE     HTMLFILE;"Instructions: ",*+,OBMEINST
          GOTO      OBMED100
.
OBMED110  UNPACK    OBMESCDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          WRITE     HTMLFILE;"<tr class=medicationRow>":
                             "<td class=medicationName>",*+,OBMEDRBR," (",*+,OBMEDRUG,")</td>":
                             "<td class=medicationDose>",*+,OBMEDOSE,"</td>":
                             "<td class=medicationInstuctions>",*+,OBMEINST,"</td></tr>";
          GOTO      OBMED100
.
OBMED999  RETURN
+
.------------------------------------------------------------
. Default obsftxaf records for a UR (based on visit number)
.------------------------------------------------------------
OBFTXR00  UNPACK    DIM127,D1,KEY3,DIM127        * key3=obfttype
          MOVE      ONE,FRSTPASS            * init first pass flag
          MOVE      ZERO,F1                 * init notes read flag
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
OBFTXR05  CALL      RDPVISA2
          BRANCH    OVRCD,OBFTXR99
.
          MATCH     URNUMBER,PVIURNO
          GOTO      OBFTXR99 IF NOT EQUAL
.
          IF        FRSTPASS=1
            MATCH     ADMISSNO,DPVIBILL     * got our visit?
            GOTO      OBFTXR05 IF NOT EQUAL * no; get prev visit
          ENDIF
.
          MOVE      ZERO,FRSTPASS
.
          PACK      KEY14,DPVIBILL,KEY3,SP70
          CALL      RSOBFTX1
OBFTXR10  CALL      RKOBFTX1
.
          IF        F1=ONE
            BRANCH    OVRCD,OBFTXR99
          ELSE
            BRANCH    OVRCD,OBFTXR05
          ENDIF
.
          MATCH     DPVIBILL,OBFTVISN       * different visit?
          IF        !@EQUAL
            COMPARE   ONE,F1                * have we read some text previously?
            GOTO      OBFTXR99 IF EQUAL     * yes; we'll bail here
.
            GOTO      OBFTXR05              * get previous visit
          ENDIF
.
          IF        F1=ONE
            MATCH     OBFTTYPE,KEY3           * same notes type?
            GOTO      OBFTXR99 IF NOT EQUAL   * no; get previous visit
          ELSE
            MATCH     OBFTTYPE,KEY3           * same notes type?
            GOTO      OBFTXR05 IF NOT EQUAL   * no; get previous visit
          ENDIF
.
          STRIP     OBFTDATA
          MOVELPTR  OBFTDATA,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      OBFTDATA,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          MOVE      ONE,F1                  * flag that some text has been read
          GOTO      OBFTXR10                * get next line for this visit
.
OBFTXR99  RETURN
+

.------------------------------------------------------------
. Link to Next List of Notes
.------------------------------------------------------------
NOTNXT00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      LINKNUM,F2
          ASSIGN    F2+STARTNOT,F4
          MOVE      F4,KEY4
          REP       " +",KEY4
          WRITE     HTMLFILE;"cliweb06.pbl?reportno=09":
                                     "&template=",TEMPLATE:
                                     "&urnumber=",URNUMBER:
                                     "&admissno=",ADMISSNO:
                                     "&startnot=",KEY4:
                                     "&clnot001=",CLNOT001:
                                     "&wbsec008=",WBSEC008;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          RETURN
.------------------------------------------------------------
. Link to Previous List of Notes
.------------------------------------------------------------
NOTPRE00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      LINKNUM,F2
          ASSIGN    STARTNOT-F2,F4
          IF        F4<1
            MOVE      ONE,F4
          ENDIF
          MOVE      F4,KEY4
          REP       " +",KEY4
          WRITE     HTMLFILE;"cliweb06.pbl?reportno=09":
                                     "&template=",TEMPLATE:
                                     "&urnumber=",URNUMBER:
                                     "&admissno=",ADMISSNO:
                                     "&startnot=",KEY4:
                                     "&clnot001=",CLNOT001:
                                     "&wbsec008=",WBSEC008;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          RETURN
.--------------------------------------------------------------------------
. Visit Comment Template Maintenance
.--------------------------------------------------------------------------
VSCT0000  BRANCH    FLDITMNO,VSCT0100,VSCT0200
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      VSCT9999
.
VSCT0100  MOVE      VSCTM001,CODE
.          MOVE      VSCMTEM,CODE
          MOVE      "VO",CATEGORY
          CALL      CODITM00 
          GOTO      VSCT9999
.
VSCT0200  PACK      KEY6,VSCMTEM,SP70
          CALL      RSVSCTM1
VSCT0210  CALL      RKVSCTM1
          BRANCH    OVRCD,VSCT9999
          MATCH     VSCMTEM,VSCTM001 
          GOTO      VSCT9999 IF NOT EQUAL 
.
          STRIP     VSCMCMT
          MOVELPTR  VSCMCMT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      VSCMCMT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      VSCT0210
.
VSCT9999  RETURN
.--------------------------------------------------------------------------
. Fees Estimate Text Maintenance
.--------------------------------------------------------------------------
FETM0000  BRANCH    FLDITMNO,FETM0100,FETM0200
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      FETM9999
.
FETM0100  MOVE      PMFET001,CODE
          MOVE      "FE",CATEGORY
          CALL      CODITM00
          GOTO      FETM9999
.
FETM0200  PACK      KEY6,PMFET001,SP70
          CALL      RSPMFET1
FETM0210  CALL      RKPMFET1
          BRANCH    OVRCD,FETM9999
          MATCH     PMFET001,PMFETYPE
          GOTO      FETM9999 IF NOT EQUAL
.
          STRIP     PMFETEXT
          MOVELPTR  PMFETEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      PMFETEXT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      FETM0210
.
FETM9999  RETURN
.--------------------------------------------------------------------------
. Miscellaneous outputs
.--------------------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300,MISC1400,MISC1500:
                             MISC1600,MISC1700,MISC1800,MISC1900,MISC2000:
                             MISC2100,MISC2200,MISC2300,MISC2400,MISC2500:
                             MISC2600,MISC2700,MISC2800,MISC2900,MISC3000:
                             MISC3100,MISC3200,MISC3300,MISC3400,MISC3500:
                             MISC3600,MISC3700,MISC3800,MISC3900,MISC4000
          GOTO      MISC9999
.
MISC0100  READ      CONTROLF,TEN3;*1,CHADD1
          WRITE     HTMLFILE;CHADD1;
          GOTO      MISC9999
.
MISC0200  READ      CONTROLF,TEN3;*31,CHADD2
          WRITE     HTMLFILE;CHADD2;
          GOTO      MISC9999
.
MISC0300  READ      CONTROLF,TEN3;*61,CHPOST
          WRITE     HTMLFILE;CHPOST;
          GOTO      MISC9999
.
MISC0400  READ      CONTROLF,TEN3;*129,CHTELEB
          WRITE     HTMLFILE;CHTELEB;
          GOTO      MISC9999
.
MISC0500  PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;WWARD;
          GOTO      MISC9999
.
MISC0600  PACK      KEY6,TWARD,TBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MISC9999
          MATCH     SP60,WEXTN
          IF        !@EQUAL
...         WRITE     HTMLFILE;WEXTN;
...         GOTO      MISC9999
          ENDIF
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;WEXTN;
          GOTO      MISC9999
.
MISC0700  MOVE      ZERO,F3
          UNPACK    DIM127,D1,D3,DIM127                               *C-240107
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RDPTECD1
MISC0750  CALL      RKPTECD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN                * check Episode No. = 1
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ANSC,PTEDTYPE
          GOTO      MISC0750 IF EQUAL
.
          ADD       ONE,F3
          MOVE      F3,KEY3                                           *C-240107
          MATCH     D3,KEY3                                           *C-240107
          GOTO      MISC0750 IF NOT EQUAL
.
          WRITE     HTMLFILE;PTEDCODE;
          GOTO      MISC9999
.
MISC0800  UNPACK    DIM127,D1,KEY3,D1,D1,DIM127
          MOVE      ZERO,F1
          MOVE      D1,F1
          PACK      KEY12,ADMISSNO,SP20
          CALL      RSOBCA1
MISC0810  CALL      RKOBCA1
          BRANCH    OVRCD,MISC9999
.
          MATCH     OBCAVIS,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     KEY3,OBCATYP
          GOTO      MISC0810 IF NOT EQUAL
.
          MATCH     "1",OBCAP1D
          GOTO      MISC0810 IF EQUAL
.
          BRANCH    F1,MISC0820,MISC0830,MISC0840,MISC0850
.
MISC0820  PACK      KEY3,OBCATYP
          CALL      RDOBCC1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OBCCDES;
          ENDIF
          GOTO      MISC9999
.
MISC0830  MATCH     SP70,OBCADTE
          GOTO      MISC9999 IF EQUAL
          UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC0840  WRITE     HTMLFILE;OBCAPT1;
          GOTO      MISC9999
.
MISC0850  WRITE     HTMLFILE;OBCATX1;
          GOTO      MISC9999
.
MISC0900  MOVE      ZERO,F3
          UNPACK    DIM127,D1,D3,DIM127                               *C-240107
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RDPTECD1
MISC0950  CALL      RKPTECD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ANSC,PTEDTYPE
          GOTO      MISC0950 IF NOT EQUAL
.
          ADD       ONE,F3
          MOVE      F3,KEY3                                           *C-240107
          MATCH     D3,KEY3                                           *C-240107
          GOTO      MISC0950 IF NOT EQUAL
          WRITE     HTMLFILE;PTEDCODE;
          GOTO      MISC9999
.
MISC1000  UNPACK    DIM127,D1,D3,D1,KEY1,DIM127                       *C-240107
          PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECO1
MISC1050  CALL      RKPTECO1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEOADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEOEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     D3,DPTEOCNT                                       *C-240107
          GOTO      MISC1050 IF NOT EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MATCH     SP70,PTEODATE
            GOTO      MISC9999 IF EQUAL
            UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;PTEOCODE;
          ENDIF
          GOTO      MISC9999
.
MISC1100  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D2,D1,KEY1,DIM127
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
MISC1150  CALL      RKPTALR1
          BRANCH    OVRCD,MISC9999
.         
          MATCH     PTALURNO,URNUMBER
          GOTO      MISC9999 IF NOT EQUAL
.         
          MATCH     "H1",PTALCATG
          IF        !@EQUAL
            MATCH     "DC",D2
            GOTO      MISC1170 IF EQUAL
            GOTO      MISC9999
          ENDIF
.         
. --      Display details for discharge Summary  ---
          MATCH     "DS",D2
          IF        @EQUAL
            GOTO      MISC1170
          ENDIF
.
. -- only print alerts with indicator 3=P ---
          PACK      KEY5,ANSH,ONE,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC1150
.
          MATCH     ANSP,TCINDC3
          GOTO      MISC1150 IF NOT EQUAL
.
          ADD       ONE,F1
          PACK      DIM2,SP1,F1
          MATCH     D2,DIM2 
          GOTO      MISC1150 IF NOT EQUAL
.         
          MATCH     "1",KEY1
          IF        @EQUAL
            MATCH     SP70,PTALDATE 
            GOTO      MISC9999 IF EQUAL
            UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            GOTO      MISC9999
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            MATCH     SP70,PTALREAC
            IF        !@EQUAL
              PACK      KEY5,PTALCATG,PTALREAC,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
            GOTO      MISC9999
          ENDIF
.
          MATCH     "3",KEY1
          IF        @EQUAL
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALN1
MISC1160    CALL      RKPMALN1
            BRANCH    OVRCD,MISC9999
.
            MATCH     PTALURNO,PMANURNO
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANACAT,PTALCATG
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANACOD,PTALCODE
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANCNTR,PTALCNTR
            GOTO      MISC9999 IF NOT EQUAL
.
            WRITE     HTMLFILE;PMANCOMM;
            GOTO      MISC1160
          ENDIF
.
          PACK      KEY5,ANSH,ONE,PTALCODE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            WRITE     HTMLFILE;TDESC;
          ENDIF
          GOTO      MISC9999
.
MISC1170  MATCH     "4",KEY1
          IF        @EQUAL
            MATCH     SP70,PTALCODE
            IF        !@EQUAL
              WRITE     HTMLFILE;"<div><span style='display:table-cell;"
              WRITE     HTMLFILE;"width:40em;word-wrap:anywhere'>"
              PACK      KEY5,PTALCATG,PTALCODE,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ELSE
                WRITE     HTMLFILE;"Invalid Code";
              ENDIF
.             MATCH     SP70,PTALREAC
.             MATCH     SP70,PTALRCOM
.             IF        !@EQUAL
              WRITE     HTMLFILE;"</span><span style='display:table-cell;"
              WRITE     HTMLFILE;"width:40em;word-wrap:anywhere'>"
.               PACK      KEY5,CATWN,PTALREAC,SP70
.               CALL      RDCODE1
.               IF        OVRCD<>1
.                 WRITE     HTMLFILE;PTALREAC," ",TDESC;     * Reaction Code
.               ELSE
.                 WRITE     HTMLFILE;"Invalid Code";
.               ENDIF
.               WRITE       HTMLFILE;PTALRCOM
.             ENDIF
              GOTO      MISC1180
MISC1171      WRITE     HTMLFILE;"</span></div>"
            ENDIF
            GOTO      MISC1150
          ENDIF
          GOTO      MISC9999
.
MISC1180  MATCH     PTALURNO,ADMISSNO     * Use Admisson based comments
          GOTO      MISC1190 IF EQUAL
.
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1              * alert comments
MISC1181  CALL      RKPMALN1
          BRANCH    OVRCD,MISC1171
          MATCH     PURNO,PMANURNO
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      MISC1171 IF NOT EQUAL
          WRITE     HTMLFILE;*+,PMANCOMM;
          GOTO      MISC1181
.
MISC1190  PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALA1              * alert comments
MISC1191  CALL      RKPMALA1
          BRANCH    OVRCD,MISC1171
          MATCH     ADMISSNO,PMANURNO
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      MISC1171 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      MISC1171 IF NOT EQUAL
          WRITE     HTMLFILE;*+,PMANCOMM;
          GOTO      MISC1191
.
MISC1200  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D2,D1,KEY1,DIM127
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
MISC1250  CALL      RKPTALR1
          BRANCH    OVRCD,MISC9999
.
          MATCH     PTALURNO,URNUMBER
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     "H1",PTALCATG
          GOTO      MISC1250 IF EQUAL
.
. -- only print alerts with indicator 3=P ---
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC1250
.
          MATCH     ANSP,TCINDC3
          GOTO      MISC1250 IF NOT EQUAL
.
          ADD       ONE,F1
          PACK      DIM2,SP1,F1
          MATCH     D2,DIM2
          GOTO      MISC1250 IF NOT EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            MATCH     SP70,PTALDATE
            GOTO      MISC9999 IF EQUAL
            UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            GOTO      MISC9999
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALN1
MISC1260    CALL      RKPMALN1
            BRANCH    OVRCD,MISC9999
.
            MATCH     PTALURNO,PMANURNO
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANACAT,PTALCATG
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANACOD,PTALCODE
            GOTO      MISC9999 IF NOT EQUAL
.
            MATCH     PMANCNTR,PTALCNTR
            GOTO      MISC9999 IF NOT EQUAL
.
            WRITE     HTMLFILE;PMANCOMM;
            GOTO      MISC1260
          ENDIF
.
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            WRITE     HTMLFILE;TDESC;
          ENDIF
          GOTO      MISC9999
.
MISC1300  MOVE      ZERO,F3
          UNPACK    DIM127,D1,D3,DIM127                               *C-240107
          PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECD1
MISC1350  CALL      RKPTECD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ANSC,PTEDTYPE
          GOTO      MISC1350 IF EQUAL
.
          ADD       ONE,F3                                            *C-240107
          MOVE      F3,KEY3                                           *C-240107
          MATCH     D3,KEY3                                           *C-240107
          GOTO      MISC1350 IF NOT EQUAL
.
          PACK      KEY9,PTEDCODE,SP10
          CALL      RDPTICD1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;DDESC;
          GOTO      MISC9999
.
MISC1400  MOVE      ZERO,F3
          UNPACK    DIM127,D1,D3,DIM127                               *C-240107
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RDPTECO1
MISC1450  CALL      RKPTECO1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEOADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEOEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          ADD       ONE,F3                                            *C-240107
          MOVE      F3,KEY3                                           *C-240107
          MATCH     D3,KEY3                                           *C-240107
          GOTO      MISC1450 IF NOT EQUAL
.
          PACK      KEY9,PTEOCODE,SP10
          CALL      RDPTICO1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;ODESC;
          GOTO      MISC9999
.
MISC1500  MOVE      ZERO,F3
          UNPACK    DIM127,D1,D3,DIM127                               *C-240107
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RDPTECD1
MISC1550  CALL      RKPTECD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ANSC,PTEDTYPE
          GOTO      MISC1550 IF NOT EQUAL
.
          ADD       ONE,F3                                            *C-240107
          MOVE      F3,KEY3                                           *C-240107
          MATCH     D3,KEY3                                           *C-240107
          GOTO      MISC1550 IF NOT EQUAL
.
          PACK      KEY9,PTEDCODE,SP10
          CALL      RDPTICD1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;DDESC;
          GOTO      MISC9999
.
MISC1600  UNPACK    DIM127,D1,KEY3,D1,D1,DIM127
          MOVE      ZERO,COUNT
          MOVE      ZERO,F1
          MOVE      D1,F1
          PACK      KEY12,ADMISSNO,SP20
          CALL      RSOBCA1
MISC1610  CALL      RKOBCA1
          BRANCH    OVRCD,MISC9999
.
          MATCH     OBCAVIS,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     "1",OBCAP1D
          GOTO      MISC1610 IF EQUAL
.
          MATCH     KEY3,OBCATYP
          GOTO      MISC1610 IF NOT EQUAL
.
          ADD       ONE,COUNT
          IF        COUNT<2
            GOTO      MISC1610
          ENDIF
.
          BRANCH    F1,MISC1620,MISC1630,MISC1640,MISC1650
.
MISC1620  PACK      KEY3,OBCATYP
          CALL      RDOBCC1
          IF        OVRCD<>1
            WRITE     HTMLFILE;OBCCDES;
          ENDIF
          GOTO      MISC9999
.
MISC1630  MATCH     SP70,OBCADTE
          GOTO      MISC9999 IF EQUAL
          UNPACK    OBCADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC1640  WRITE     HTMLFILE;OBCAPT1;
          GOTO      MISC9999
.
MISC1650  WRITE     HTMLFILE;OBCATX1;
          GOTO      MISC9999
.
MISC1700  CALL      GETVER00                * get number of DS already printed
          WRITE     HTMLFILE;COUNTVER;
          GOTO      MISC9999
.
MISC1800  PACK      GENPCODE,PMVXRHC1,SP70
          CALL      HCPDET00                * Referring gp details
          GOTO      MISC9999
.
MISC1900  WRITE     HTMLFILE;MEDCD001;      * coming from coding screen
          GOTO      MISC9999
.
MISC2000  PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MISC9999
          WRITE     HTMLFILE;WBDESC;
          GOTO      MISC9999
.
MISC2100  READ      CONTROLF,HUND18;*84,PTCNHFAX
          WRITE     HTMLFILE;PTCNHFAX;
          GOTO      MISC9999
.
MISC2200  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D2,DIM127
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
MISC2250  CALL      RDKMMBS1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DMMADMN,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          ADD       ONE,F1
          PACK      DIM2,SP1,F1
          MATCH     D2,DIM2
          GOTO      MISC2250 IF NOT EQUAL
.
          WRITE     HTMLFILE;PTMMDESC;
          GOTO      MISC9999
.
MISC2300  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D2,DIM127
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
MISC2350  CALL      RDKMMBS1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DMMADMN,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          ADD       ONE,F1
          PACK      DIM2,SP1,F1
          MATCH     D2,DIM2
          GOTO      MISC2350 IF NOT EQUAL
.
          MATCH     SP70,MMDATE
          GOTO      MISC9999 IF EQUAL
          UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      MISC9999
.
MISC2400  WRITE     HTMLFILE;PTHSADD1;
          GOTO      MISC9999
.
MISC2500  WRITE     HTMLFILE;PTHSADD2;
          GOTO      MISC9999
.
MISC2600  WRITE     HTMLFILE;PTHSADD3;
          GOTO      MISC9999
.
MISC2700  WRITE     HTMLFILE;PTHSADD4;
          GOTO      MISC9999
.
MISC2800  WRITE     HTMLFILE;PTHSPCOD;
          GOTO      MISC9999
.
MISC2900  WRITE     HTMLFILE;PTHSTELE;
          GOTO      MISC9999
.
MISC3000  WRITE     HTMLFILE;PTHSFAXN;
          GOTO      MISC9999
.
MISC3100  PACK      KEY3,SP70
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            MOVE      PMVXMHOS,KEY3
            SQUEEZE   KEY3
          ELSE
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD<>1
              MOVE      PTHSHOSP,KEY3
              SQUEEZE   KEY3
            ENDIF
          ENDIF
          WRITE     HTMLFILE;*+,KEY3,*-;
          GOTO      MISC9999
.
MISC3200
          GOTO      MISC9999
.
MISC3300  CALL      HPPR0000           * Visit Referring hcp/practice details
          GOTO      MISC9999
.
MISC3400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,MISC3410       * 0=Desc 1=Code
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      CNAME,PTHSNAME     * Use Control File Parameters if No Visit Hospital
            MOVE      CHADD1,PTHSADD1
            MOVE      CHADD2,PTHSADD2
            MOVE      SP70,PTHSADD3
            MOVE      SP70,PTHSADD4
            MOVE      CHPOST,PTHSPCOD
            MOVE      CHTELEB,PTHSTELE   *Hospital Telephone number
            READ      CONTROLF,HUND18;*84,PTCNHFAX
            MOVE      PTCNHFAX,PTHSFAXN  *Hospital Fax Number
          ENDIF
          BRANCH    F1,MISC3410,MISC3420  * 0=Desc 1=Code 3=Table Field
.
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      MISC9999
.
MISC3410  WRITE     HTMLFILE;PMVXMHOS;
          GOTO      MISC9999
.
MISC3420  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO
          IF        FLDITMNO=5
            MATCH     SP70,PTHSADD3
            IF        @EQUAL
              MOVE      33,FLDITMNO
            ENDIF
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     SP70,PTHSADD2
            IF        @EQUAL|@EOS
              MATCH     "004",KEY3
              IF        @EQUAL
                MOVE      FIVE,FLDITMNO
              ENDIF
              MATCH     "005",KEY3
              IF        @EQUAL
                MOVE      SIX,FLDITMNO
              ENDIF 
            ENDIF
          ENDIF
.
          CALL      HSPD0000
          GOTO      MISC9999
.
MISC3500  MATCH     DDATE,ADATE
          IF        @EQUAL
            WRITE     HTMLFILE;"Same Day";
          ELSE
            WRITE     HTMLFILE;"Inpatient";
          ENDIF
          GOTO      MISC9999
.
MISC3600  PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECD1
MISC3650  CALL      RKPTECD1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DPTEDADM,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     " 1",DPTEDEPN
          GOTO      MISC9999 IF NOT EQUAL
.
          MATCH     ANSP,PTEDTYPE
          GOTO      MISC1350 IF NOT EQUAL
.
          PACK      KEY9,PTEDCODE,SP10
          CALL      RDPTICD1
          BRANCH    OVRCD,MISC9999
.
.         Check which size description is being used
          MATCH     SP70,PT0DDSC2
          IF        !@EQUAL
            PACK      DISP200,PT0DDSC2,SP70,SP70,SP70    * 200 chars
          ELSE
            MATCH     SP70,PT0DDESC
            IF        !@EQUAL
              PACK      DISP200,PT0DDESC,SP70,SP70       * 100 chars
            ELSE
              PACK      DISP200,DDESC,SP70               * 70 chars
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;DISP200;
          GOTO      MISC9999
.
MISC3700  MOVE      ZERO,COUNT
          PACK      KEY13,ADMISSNO,SP70
          CALL      RDPTECO1
MISC3710  CALL      RKPTECO1
          BRANCH    OVRCD,MISC3750
.
          MATCH     DPTEOADM,ADMISSNO
          IF        !@EQUAL
            COMPARE   ZERO,COUNT
            GOTO      MISC9999 IF NOT EQUAL
            GOTO      MISC3750 IF EQUAL
          ENDIF
.
          ADD       ONE,COUNT
          MATCH     SP70,PTEODATE
          GOTO      MISC3720 IF EQUAL
          UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
MISC3720  PACK      KEY9,PTEOCODE
          CALL      RDPTICO1
          IF        OVRCD=1
            MOVE      "Invalid Code",ODESC
          ENDIF
.
          WRITE     HTMLFILE;"<div><span style='width:40em;display:":
                             "inline-block;'>",PTEOCODE,": ",ODESC;
          MATCH     SP70,PTEODATE
          IF        !@EQUAL
            WRITE     HTMLFILE;"</span><span>",CDAY,SP1,MTHNAM3,SP1:
                             CCENT,CYEAR,"</span></div>";
          ELSE
            WRITE     HTMLFILE;"</span></div>";
          ENDIF
.
          GOTO      MISC3710
.
MISC3750  PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
MISC3755  CALL      RDKMMBS1
          BRANCH    OVRCD,MISC9999
.
          MATCH     ADMISSNO,DMMADMN
          GOTO      MISC9999 IF NOT EQUAL
.
          PACK      MTHNAM3,SP70
          PACK      CCENT,SP70
          PACK      CYEAR,SP70
          PACK      CDAY,SP70
.
          COMPARE   ONE,ASTAT
          IF        @EQUAL
            UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY17,MMCODE,MMDATE,SP70
          ELSE
            CALL      IBACLOCK
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            UNPACK    CURRDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY17,MMCODE,CURRDATE,SP70
          ENDIF
.
          CALL     PATITMRD
          IF       OVRCD=1
            MOVE     "Invalid Code",IDESC
          ENDIF
.
MISC3760  WRITE     HTMLFILE;"<div><span style='width:40em;display:":
                               "inline-block;'>",MMCODE,": ",IDESC:
                               "</span><span>",CDAY,SP1,MTHNAM3,SP1:
                               CCENT,CYEAR,"</span></div>";
.
          GOTO      MISC3755
.
MISC3800  PACK      KEY28,ADMISSNO,Z70
          CALL      RSOBPC2
MISC3810  CALL      RPOBPC2
          BRANCH    OVRCD,MISC3850
.
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      MISC3850 IF NOT EQUAL
.
          MOVE      OBPCCPID,F4      
          ADD       ONE,F4 
          WRITE     HTMLFILE;F4;
          GOTO      MISC9999
.
MISC3850  WRITE     HTMLFILE;ONE;
          GOTO      MISC9999
.
MISC3900  PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
MISC3910  CALL      RDKMMBS1
          BRANCH    OVRCD,MISC9999
.
          MATCH     DMMADMN,ADMISSNO
          GOTO      MISC9999 IF NOT EQUAL 
.
          MATCH     SP70,MMDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr>":
                               "<td>",PTMMDESC,"</td>":
                               "<td></td>":
                               "</tr>"
            GOTO      MISC3910
          ENDIF
          UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",PTMMDESC,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "</tr>"
.       
          GOTO      MISC3910
.
MISC4000  MOVE      ONE,VERSNUMB
          PACK      KEY28,ADMISSNO
          CALL      RSOBPC2
MISC4010  CALL      RKOBPC2
          BRANCH    OVRCD,MISC4050
.
          MATCH     ADMISSNO,OBPCCVIS
          IF        !@EQUAL
            GOTO      MISC4050
          ENDIF
          MATCH     SP70,OBPCCTYP
          GOTO      MISC4010 IF EQUAL
          PACK      KEY5,CATWI,OBPCCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MISC4010
          MATCH     ANSD,TCINDC1
          GOTO      MISC4010 IF NOT EQUAL
          MATCH     ANSD,TCINDC5
          GOTO      MISC4010 IF NOT EQUAL
          ADD       ONE,VERSNUMB
          GOTO      MISC4010
.
MISC4050  WRITE     HTMLFILE;VERSNUMB;
          GOTO      MISC9999
.
MISC9999  RETURN
+
.--------------------------------------------------------------------------
.Get number of discharge summaries already printed for visit
.--------------------------------------------------------------------------
GETVER00  MOVE      ONE,COUNTVER
          PACK      KEY28,ADMISSNO,SP70
          CALL      RSOBPC2
GETVER10  CALL      RKOBPC2
          BRANCH    OVRCD,GETVER99
.
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      GETVER99 IF NOT EQUAL
.
          PACK      KEY5,CATWI,OBPCCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GETVER10
.
          MATCH     ANSD,TCINDC1
          GOTO      GETVER10 IF NOT EQUAL
.
          ADD       ONE,COUNTVER
          GOTO      GETVER10
.
GETVER99  RETURN
+
.--------------------------------------------------------------------------
.Patient Medical Note Maintenance
.--------------------------------------------------------------------------
OBSN0000  BRANCH    FLDITMNO,OBSN0100,OBSN0200,OBSN0300,OBSN0400,OBSN0500:
                             OBSN0600,OBSN0700,OBSN0800,OBSN0900,OBSN1000:
                             OBSN1100
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      OBSN9999
.
OBSN0100  MATCH     SP70,OBMDNOTE
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMDNOTE;
          GOTO      OBSN9999
.
OBSN0200  MATCH     SP70,OBMDDATE
          GOTO      OBSN9999 IF EQUAL
          UNPACK    OBMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      OBSN9999
.
OBSN0300  MATCH     SP70,OBMDTIME
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMDTIME;
          GOTO      OBSN9999
.
OBSN0400  MATCH     SP70,OBMDUSER
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMDUSER;
          GOTO      OBSN9999
.
OBSN0500  MATCH     SP70,OBMDOCCG
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMDOCCG;
          GOTO      OBSN9999
.
OBSN0600  MATCH     SP70,OBMDDELT
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMDDELT;
          GOTO      OBSN9999
.
OBSN0700  MATCH     SP70,OBMTCMNT 
          GOTO      OBSN9999 IF EQUAL
          WRITE     HTMLFILE;OBMTCMNT;
          GOTO      OBSN9999
.
OBSN0800  PACK      KEY17,OBMDURNO,OBMDNOTE,SP70
.          PACK      KEY17,URNUMBER,NOTENUMB,SP70
          CALL      RSOBMTX1
OBSN0810  CALL      RKOBMTX1
          BRANCH    OVRCD,OBSN9999
          MATCH     OBMDURNO,OBMTURNO
          GOTO      OBSN9999 IF NOT EQUAL 
          MATCH     OBMTNOTE,OBMDNOTE 
          GOTO      OBSN0810 IF NOT EQUAL 
.
          WRITE     HTMLFILE;OBMTCMNT;
          GOTO      OBSN0810
.
OBSN0900  MOVE      ZERO,FORMATTY
          CALL      OBSTAB00  
          GOTO      OBSN9999
.
OBSN1000  MOVE      ONE,FORMATTY
          CALL      OBSTAB00  
          GOTO      OBSN9999
.
OBSN1100  MOVE      TWO,FORMATTY
          CALL      OBSTAB00  
          GOTO      OBSN9999
.
OBSN9999  RETURN
.--------------------------------------------------------------------------
. Note Type Maintenance
.--------------------------------------------------------------------------
NOTE0000  BRANCH    FLDITMNO,NOTE0100,NOTE0200,NOTE0300,NOTE0400,NOTE0500: 
                             NOTE0600,NOTE0700,NOTE0800,NOTE0900,NOTE1000:
                             NOTE1100
.
NOTE0100  CALL      NOTAB000  * Display table of Note Types 

          GOTO      NOTE9999
.
NOTE0200  MATCH     SP70,OBCCTYP 
          GOTO      NOTE9999 IF EQUAL
          WRITE     HTMLFILE;OBCCTYP;
          GOTO      NOTE9999
.
NOTE0300  MATCH     SP70,OBCCDES
          GOTO      NOTE9999 IF EQUAL
          WRITE     HTMLFILE;OBCCDES;
          GOTO      NOTE9999
.
NOTE0400  MATCH     SP70,OBCCTMI
          GOTO      NOTE9999 IF EQUAL
          WRITE     HTMLFILE;OBCCTMI;
          GOTO      NOTE9999
.
NOTE0500  MATCH     SP70,OBCCTMO 
          GOTO      NOTE9999 IF EQUAL
          WRITE     HTMLFILE;OBCCTMO;
          GOTO      NOTE9999
.
NOTE0600  MATCH     SP70,OBCCSLV
          GOTO      NOTE9999 IF EQUAL
          WRITE     HTMLFILE;OBCCSLV;
          GOTO      NOTE9999
.
NOTE0700  MOVE      OBCCDHL,CODE
          MOVE      CATHLV,CATEGORY
          CALL      CODITM00
          GOTO      NOTE9999
.
NOTE0800  CALL      NEXTCL00
          GOTO      NOTE9999
.
NOTE0900  CALL      PRECLI00
          GOTO      NOTE9999
.
NOTE1000  CALL      NEXTTY00
          GOTO      NOTE9999
.
NOTE1100  CALL      PRETYP00
          GOTO      NOTE9999
.
NOTE9999  RETURN
.------------------------------------------------------------
. Link to Next set of Clinical Notes 
.------------------------------------------------------------
NEXTCL00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"emrweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
NEXTCL99  RETURN
.-------------------------------------------------------------------------------
. Link to previous set of Clinical Notes 
.-------------------------------------------------------------------------------
PRECLI00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          WRITE     HTMLFILE;"emrweb05.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2;
.
PRECLI99  RETURN
.------------------------------------------------------------
. Display Table of Clinical Note 
.---------------------------------------------------------------------          
OBSTAB00  IF        FORMATTY=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            CALL      OBHED000      * Output Table Heading
          ENDIF
.
          MOVE      URNUMBER,OBMDURNO
          PACK      KEY14,OBMDURNO,Z70
          CALL      RSOBMDT1
OBSTAB10  CALL      RPOBMDT1
          BRANCH    OVRCD,OBSTAB99
          MATCH     URNUMBER,OBMDURNO
          GOTO      OBSTAB99 IF NOT EQUAL
.
          MATCH     OBMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     OBSTAB40
          ENDIF
.
          UNPACK    OBMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",OBMDDELT
          IF        @EQUAL
            BRANCH     FORMATTY,OBSTAB10,OBSTAB10     * No Deleted Notes in Snipet for Letters
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",OBMDNOTE 
.
          PACK      WBSENAM,SP70
          PACK      KEY10,OBMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            STRIP     WBSENAM
          ELSE
            MOVE      OBMDUSER,WBSENAM
          ENDIF
.
OBSTAB40  BRANCH    FORMATTY,OBSTAB50,OBSTAB50
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
.                             "&template=003":
                             "&urnumber=",URNUMBER:
                             "&notenumb=",OBMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,OBMDTIME,"</td>":
                             "<td>",STRIKETG,WBSENAM," - ",OBMDOCCG,"&nbsp;":
                             STRENDTG,"</td>":
                             "<td>",STRIKETG;
          MOVE      ZERO,CTR
          CALL      OBSNOT00 
.
          PACK      WBSENAM,SP70
          PACK      KEY10,OBMDDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            STRIP     WBSENAM
          ELSE
            MOVE      OBMDDUSE,WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                             "<td>",WBSENAM," - &nbsp;":
                             STRENDTG,"</td>":
                             "</tr>"
   
          REP       "+ ",URNUMBER
          REP       "+ ",OBMDNOTE 
          GOTO      OBSTAB10
.
. Snipet Output for Tinymce Template
.
OBSTAB50  IF        FORMATTY<>2
            WRITE     HTMLFILE;"<div class=notetitle>",WBSENAM," on ",FBOKDATE:
                               " at ",OBMDTIME,"</div>";
          ENDIF
.
          WRITE     HTMLFILE;"<div class=notetext>";
.
          MOVE      ZERO,CTR
          CALL      OBSNOT00 
          WRITE     HTMLFILE;"</div>";
          GOTO      OBSTAB10

OBSTAB99  RETURN
.--------------------------------------------------------------------
. medical note display 
.--------------------------------------------------------------------
OBSNOT00  REP       "+ ",URNUMBER
          REP       "+ ",OBMDNOTE 
          PACK      KEY17,URNUMBER,OBMDNOTE,SP70  
          CALL      RSOBMTX1
OBSNOT10  CALL      RKOBMTX1
          BRANCH    OVRCD,OBSNOT99
          MATCH     OBMTURNO,URNUMBER
          GOTO      OBSNOT99 IF NOT EQUAL
          MATCH     OBMTNOTE,OBMDNOTE
          GOTO      OBSNOT99 IF NOT EQUAL
          BRANCH    FORMATTY,OBSNOT20    * Output all Note Text for Tinymce Template
          COMPARE   TWO,CTR
          GOTO      OBSNOT99 IF EQUAL
          ADD       ONE,CTR
.
OBSNOT20  WRITE     HTMLFILE;OBMTCMNT,"<br>";
          GOTO      OBSNOT10
.
OBSNOT99  RETURN
.---------------------------------------------------------------------
. Display Table of Note Types
.---------------------------------------------------------------------          
NOTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      NTHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY3,STARTKEY,SP3
          CALL      RSOBCC1                 * Positional Read
          IF        OVRCD=0
            CALL      RPOBCC1
          ENDIF
NOTAB100  CALL      RKOBCC1                 * Sequential Read
          BRANCH    OVRCD,NOTAB900
          MATCH     SP70,OBCCTYP
          GOTO      NOTAB100 IF EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      NOTAB100
          ENDIF
.
          CALL      NROWA000      * Display Note Type Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      NOTAB100 IF NOT EQUAL
          GOTO      NOTAB999
.
NOTAB900  CALL      NOMORE00      * Display No More Records Message
.
NOTAB999  RETURN
.------------------------------------------------------------
. Medical Note Summery (TABLE HEADING)
.------------------------------------------------------------
OBHED000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Date</td>":
                             "<td class=HeadingCell width=20%>Input By</td>":
                             "<td class=HeadingCell width=40%>Notes</td>":
                             "<td class=HeadingCell width=20%>Deleted By</td>":
                             "</tr>"
.
OBHED999  RETURN
.------------------------------------------------------------
.------------------------------------------------------------
. Note Type Maintenance (TABLE HEADING)
.------------------------------------------------------------
NTHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>Note</td>":
                               "<td class=HeadingCell width=40%>":
                               "Description</td>":
                             "</tr>"
.
NTHED999  RETURN
.------------------------------------------------------------
. Note Type Maintenance (TABLE ROW)
.------------------------------------------------------------
NROWA000  MATCH     SP70,OBCCDES
          IF        @EQUAL
            MOVE      "&nbsp;",OBCCDES
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&typenote=",OBCCTYP,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             OBCCTYP,"</td>":
                             "<td>",OBCCDES,"</td>":
                             "</tr>"

.
NROWA999 RETURN
.------------------------------------------------------------
. Create ORM Message for Service Order (Radiology/Pathology)
.---------------------------------------------------------------
MAKORM00  CALL      IBACLOCK
          PACK      YEAROPEN,CCC,CYY
          REP       " 0",YEAROPEN
          MOVE      YEAROPEN,RESULTYR
          MATCH     SP70,ORDERDTE
          IF        !@EQUAL
            MOVE      ORDERDTE,RESULTYR
          ENDIF
.
          CALL      RESOPN00                     * Open result tables
          BRANCH    EXIT,MAKORM99
.
          CALL      WRHEAD00
          CALL      WRLNKS00
.
MAKORM99  RETURN
.------------------------------------------------------------
. Write header record 
.----------------------------------------------------------------------
WRHEAD00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OBCADTE
          MOVE      CTIMEIS,OBCATME
.
          MATCH     SP70,ORDERDTE
          IF        !@EQUAL
            MOVE      ORDERDTE,OBCADTE
          ENDIF
          MATCH     SP70,ORDERTIM
          IF        !@EQUAL
            MOVE      ORDERTIM,OBCATME
          ENDIF
.
          PACK      KEY17,OBCADTE,OBCATME,Z70
          MOVE      ZERO,UNIQUEID
          CALL      RSREHA1
          CALL      RPREHA1
          BRANCH    OVRCD,WRHEAD10
          MATCH     REHARDT,OBCADTE
          GOTO      WRHEAD10 IF NOT EQUAL
          MATCH     REHARTM,OBCATME
          GOTO      WRHEAD10 IF NOT EQUAL
          MOVE      REHARUN,UNIQUEID
.
WRHEAD10  MOVE      OBCADTE,REHARDT
          MOVE      OBCATME,REHARTM
          MOVE      ONE,REHAFUR
          MOVE      URNUMBER,REHAPID
          MOVE      ADMISSNO,REHAVIS
.
          CALL      HEAVAR00                * Set up header values
.
          PACK      UNICODE,SERVCODE,SP70
          MOVE      CODINSYS,UNISCHE
          PACK      UNIDESC,SERVDESC,SP70
          MOVE      "OBR04",UNISEGF
          MOVE      SERVLABC,REHALAB
          MOVE      REHALAB,UNILABC
          CALL      UPRTSC00                * update result service codes
.
WRHEAD70  ADD       ONE,UNIQUEID
          MOVE      UNIQUEID,REHARUN
          PACK      KEY17,REHARDT,REHARTM,REHARUN
          PACK      REHAPOR,KEY17,SP70      * place order to have unique key
          CALL      RAREHA1
          BRANCH    OVRCD,WRHEAD80
          GOTO      WRHEAD70
.
WRHEAD80  CALL      WRREHA1
          CALL      RLREHA1
          CALL      NEWAUD00           * Write Audit Record
          PACK      KEY17,REHARDT,REHARTM,REHARUN
          MOVE      KEY17,RESULTSK[SERVCNT]
          UNPACK    KEY17,REHBRDT,REHBRTM,REHBRUN
          MOVE      SP70,REHBTXT
          MOVE      SP70,REHBSPA
          MOVE      "Priority: ",KEY10
          PACK      REHBTXT,KEY10,SERVPRI,SP70
          MOVE      ZERO,FORM3
.
WRHEAD85  ADD       ONE,FORM3
          MOVE      FORM3,REHBLIN
          PACK      KEY20,REHBRDT,REHBRTM,REHBRUN,REHBLIN
          CALL      RAREHB1
          IF        OVRCD=0
            GOTO      WRHEAD85
          ENDIF
          CALL      WRREHB1
.
WRHEAD90  MOVE      ONE,COUNT
          WHILE     COUNT <= 100
            MATCH     SP70,OPTFLDNM[COUNT]
            IF        !@EQUAL
              MATCH     SP70,OPTFLDVL[COUNT]
              IF        !@EQUAL
                CLEAR     REHBTXT
                STRIP     OPTFLDNM[COUNT]
                APPEND    OPTFLDNM[COUNT],REHBTXT
                APPEND    SP1,REHBTXT
                STRIP     OPTFLDVL[COUNT]
                APPEND    OPTFLDVL[COUNT],REHBTXT
                RESET     REHBTXT
                MOVE      ZERO,OVRCD
                WHILE     OVRCD=0
                  ADD       ONE,FORM3
                  MOVE      FORM3,REHBLIN
                  PACK      KEY20,REHBRDT,REHBRTM,REHBRUN,REHBLIN
                  CALL      RAREHB1
                DO
                CALL      WRREHB1
              ENDIF
            ENDIF
            ADD       ONE,COUNT
          DO
.
WRHEAD99  RETURN
.------------------------------------------------------------
. Update the result template by service code table
.----------------------------------------------------------------------
UPRTSC00  PACK      KEY32,UNILABC,UNISEGF,UNISCHE,UNICODE,SP70
          UNPACK    KEY32,RECTLAB,RECTSEG,RECTFLD,RECTSYS,RECTCOD
          CALL      RARECT1
          IF        OVRCD=1
            MOVE      UNIDESC,RECTDES
            MOVE      SP70,RECTSPA
            PACK      KEY32,RECTLAB,RECTSEG,RECTFLD,RECTSYS,RECTCOD,SP70
            CALL      WRRECT1
          ENDIF
.
UPRTSC99  RETURN
.------------------------------------------------------------
. Set up header variable values
.------------------------------------------------------------
HEAVAR00  MOVE      "CLIWEB06",REHASID
          MOVE      OBCADTE,REHAMDT
          MOVE      OBCATME,REHAMTM
          MOVE      SP70,REHAMID
          MOVE      "WEBPAS",REHAPAP    * should be changed to webPAS
          CLOCK     TIME,CTIMEIS
          MOVE      SP70,REHAFAP
          MOVE      SP70,REHAFOR
          PACK      REHAUSC,SERVCODE,SP70  * Code
          PACK      REHADSS,SERVDSSC,SP70  * DSS
          MOVE      CODINSYS,REHAUCS  * Coding System (Local for Demo)
          MOVE      TWO,REHANOR       * Undefined Status
          MOVE      SP8,REHACDT
          MOVE      SP5,REHACTM
          MOVE      SP70,REHACID
          MOVE      SP70,REHASDT
          MOVE      SP70,REHASTM
          MOVE      SP70,REHALOC
.
          MOVE      SP70,REHAOID
          MOVE      SP70,REHAOSN
          MOVE      SP70,REHAOGN
.
.         Get the HCP who requested the order
          MATCH     SP70,REQUSRID
          IF        !@EQUAL
            PACK      KEY10,REQUSRID,SP70  * use User Id passed in
          ELSE
            PACK      KEY10,USERID,SP70    * use User Id from web user
          ENDIF
.
          CALL      RDWBSE1
          BRANCH    OVRCD,HEDVAR10
.
          MATCH     SP70,WBSEDOC
          IF        @EQUAL
            PACK      KEY10,ORDERHCP
          ELSE
            PACK      KEY10,WBSEDOC
          ENDIF
          CALL      RDPMHCP1
          BRANCH    OVRCD,HEDVAR10
          SQUEEZE   PMHCPRV1
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          PACK      REHAOID,PMHCHCPC
          PACK      REHAOSN,PMHCSNAM
          PACK      REHAOGN,PMHCGNAM
.
HEDVAR10  MOVE      SP70,REHARRD
          MOVE      SP70,REHARRT
          MOVE      UNIQUEID,REHARUN
          MOVE      OBCADTE,REHARED
          MOVE      OBCATME,REHARET
          MATCH     SP70,ORDERDTE
          IF        !@EQUAL
            MOVE      ORDERDTE,REHARED
          ENDIF
          MATCH     SP70,ORDERTIM
          IF        !@EQUAL
            MOVE      ORDERTIM,REHARET
          ENDIF
.
          MOVE      SP70,REHARRD
          MOVE      SP70,REHARRT
          MOVE      UNIQUEID,REHARUN
          MOVE      OBCADTE,REHARED
          MOVE      OBCATME,REHARET
          MOVE      "S ",REHARST
          MOVE      SP70,REHAIBY
          MOVE      SP70,REHAADC
          MOVE      SP70,REHARDE
.
HEAVAR99  RETURN
.----------------------------------------------------------------------
.  Write results link record
.----------------------------------------------------------------------
WRLNKS00  MOVE      "01",LINKTYPE
          PACK      LINKKEYS,REHAPID,SP70
          CALL      NEWLNK00
.
          MOVE      "05",LINKTYPE
          PACK      LINKKEYS,PMPXRHC1,SP70
          CALL      NEWLNK00
.
          MATCH     SP70,ADMISSNO
          GOTO      WRLNKS99 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1            * Check for Visit No 
          BRANCH    OVRCD,WRLNKS99     * Not Valid
.
          MOVE      "02",LINKTYPE
          PACK      LINKKEYS,PVIBILL,SP70
          CALL      NEWLNK00
.
          BRANCH    PVITYPE,WRLNKS10,WRLNKS20,WRLNKS30
.
WRLNKS10  PACK      KEY8,PVIBILL
.          CALL      RDDETA1
.          BRANCH    OVRCD,WRLNKS96
.
.          MOVE      "03",LINKTYPE
.          PACK      LINKKEYS,ADADOCT,SP70
.          CALL      UPDADC00
.          CALL      NEWLNK00
.
.          MOVE      "05",LINKTYPE
.          PACK      LINKKEYS,AEDARFGP,SP70
.          CALL      NEWLNK00
..
.          MOVE      "03",LINKTYPE
.          PACK      LINKKEYS,AEDARDOC,SP70
.          CALL      NEWLNK00
          GOTO      WRLNKS99
..
WRLNKS20  MOVE      PVISITE,KEY6
.          CALL      RDSITA1
.          BRANCH    OVRCD,WRLNKS95
..
.          MOVE      OSTFILE,CFILEPRE
.          PACK      CFNAME,CFILEPRE,FILBB1A1
.          CALL      OPOTBB11
..
.          PACK      KEY8,PVIBILL
.          CALL      RDBOKB1
.          BRANCH    OVRCD,WRLNKS95
..
.          MOVE      "03",LINKTYPE
.          PACK      LINKKEYS,OBADOCT,SP70
.          CALL      UPDADC00
.          CALL      NEWLNK00
..
.          MOVE      "05",LINKTYPE
.          PACK      LINKKEYS,OTBBRFGP,SP70
.          CALL      NEWLNK00
..
.          MOVE      "06",LINKTYPE
.          PACK      LINKKEYS,PVIDOCT,SP70   * Clinic / doctor
.          CALL      NEWLNK00
..
          GOTO      WRLNKS99
.
WRLNKS30  PACK      KEY8,PVIBILL
          CALL      RDMISS1
          BRANCH    OVRCD,WRLNKS99          * No record
.
          MOVE      "04",LINKTYPE           * Ward link
          PACK      LINKKEYS,AWARD,SP70
          CALL      NEWLNK00
.
          MOVE      "03",LINKTYPE           * Attending doctor link
          PACK      LINKKEYS,ADOCTA,SP70
          CALL      UPDADC00
          CALL      NEWLNK00
.
          MOVE      "07",LINKTYPE           * Attending doctor only link
          PACK      LINKKEYS,ADOCTA,SP70
          CALL      NEWLNK00
.
          MOVE      "03",LINKTYPE           * Treating doctor link
          PACK      LINKKEYS,ADOCTT,SP70
          CALL      NEWLNK00
.
          MOVE      "03",LINKTYPE           * Referring Doctor link
          PACK      LINKKEYS,ADOCTR,SP70
          CALL      NEWLNK00
.
          MOVE      "08",LINKTYPE           * Referring Doctor only link
          PACK      LINKKEYS,ADOCTR,SP70
          CALL      NEWLNK00
          GOTO      WRLNKS99
.
WRLNKS99  RETURN
.------------------------------------------------------------
. Update Attending Doctor in Header Record
.------------------------------------------------------------
UPDADC00  PACK      KEY17,REHARDT,REHARTM,REHARUN
          CALL      RDREHA1
          BRANCH    OVRCD,UPDADC99
          MOVE      LINKKEYS,REHAADC
          CALL      UPREHA1
UPDADC99  RETURN
.------------------------------------------------------------
. Write New link Record
.----------------------------------------------------------------------
NEWLNK00  PACK      KEY29,LINKTYPE,LINKKEYS,REHARDT,REHARTM,REHARUN,SP70
          UNPACK    KEY29,RELNLTY,RELNLKY,RELNRDT,RELNRTM,RELNRUN
.
          PACK      RESLNKFL,PRELEN,RELNRDT           * I CAR 38290
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA1,RESLNKFL
          TRAPCLR   IO
.
          COMPARE   ONE,OVRCD
          GOTO      NEWLNK99 IF EQUAL                 * end I CAR 38290
.
          CALL      RDRELN1
          IF        OVRCD=1
            MOVE      ZERO,RELNMSN            * Marked as seen, 0=no.
            MOVE      SP70,RELNSDT
            MOVE      SP70,RELNSTM
            MOVE      SP70,RELNSPC
            MOVE      REHAFUR,RELNFUR
            MOVE      REHAPID,RELNPID
            MOVE      REHAUCS,RELNUCS         * coding scheme
            MOVE      REHAUSC,RELNUSC         * code
            MOVE      REHADSS,RELNDSS
            MOVE      REHANOR,RELNNOR
            MOVE      REHARST,RELNRST
            MOVE      REHALAB,RELNLAB
            MOVE      ZERO,RELNRTY            * 0=HL7
            CALL      WRRELN1
          ENDIF
.
          MATCH     "01",LINKTYPE
          GOTO      NEWLNK99 IF NOT EQUAL
.
          MOVE      LINKKEYS,KEY8
          PACK      KEY25,KEY8,REHARDT,REHARTM,REHARUN,SP70
          UNPACK    KEY25,RELUURN,RELURDT,RELURTM,RELURUN
          CALL      RDRELU1
          COMPARE   ONE,OVRCD
          GOTO      NEWLNK99 IF NOT EQUAL
          MOVE      ZERO,RELUMSN            * Marked as seen, 0=no.
          MOVE      SP70,RELUSDT
          MOVE      SP70,RELUSTM
          MOVE      SP70,RELUSPC
          MOVE      REHAFUR,RELUFUR
          MOVE      REHAPID,RELUPID
          MOVE      REHAUCS,RELUUCS         * coding scheme
          MOVE      REHAUSC,RELUUSC         * code
          MOVE      REHADSS,RELUDSS
          MOVE      REHANOR,RELUNOR
          MOVE      REHARST,RELURST
          MOVE      REHALAB,RELULAB
          MOVE      ZERO,RELURTY            * 0=HL7
          CALL      WRRELU1
          MOVE      RELUURN,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,NEWLNK99
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "1",PTMXSIN2
          GOTO      NEWLNK99 IF EQUAL
.
          MOVE      RELUURN,KEY8
          CALL      RLPTMAS1
          BRANCH    OVRCD,NEWLNK99,NEWLNK99
          MOVE      "1",PTMXSIN2
          CALL      UPMAST1
          CALL      UUPTMAS1
.
NEWLNK99  RETURN
.------------------------------------------------------------
. Open result tables
.------------------------------------------------------------
RESOPN00  CLOSE     RESHEAA1
          CLOSE     RESHEAA2
          CLOSE     RESHEBA1
          CLOSE     RESHEDA1
          CLOSE     RESHECA1
.
          PACK      FILENAME,PREHEA,RESULTYR
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESHEAA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,RESOPN90
.
          PACK      FILENAME,PREHEA,RESULTYR
          OPEN      RESHEAA2,FILENAME
.
          PACK      FILENAME,PREHEB,RESULTYR
          OPEN      RESHEBA1,FILENAME
.
          PACK      FILENAME,PREHEC,RESULTYR
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESHECA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,RESOPN90
.
          PACK      FILENAME,PREHED,RESULTYR
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESHEDA1,FILENAME
          TRAPCLR   IO
          BRANCH    OVRCD,RESOPN90

          MOVE      RESULTYR,YEAROPEN
          MOVE      ZERO,EXIT
          GOTO      RESOPN99
.
.RESOPN90  CALL      MAKRES00
.          GOTO      RESOPN00
.
RESOPN90
RESOPN99  RETURN
.------------------------------------------------------------
.  Create new files
.------------------------------------------------------------------------------
MAKRES00  MOVE      ZERO,TASKID
          CLEAR     CMNDLINE
          PACK      FILENAME,PREHEA,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 418 U1-8,9-13,14-17 ",CMNDLINE
          APPEND    "U112-117,118-137,1-8,9-13,14-17 ",CMNDLINE
          APPEND    "U19-34,150-161,138-149,1-8,9-13,14-17",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREHEB,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 158 U1-8,9-13,14-17,18-20",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREHEC,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 157 U1-8,9-13,14-17,18-19",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREDEA,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 365 U1-8,9-13,14-17,18-21 ",CMNDLINE
          APPEND    " U22-37,52-63,40-51,1-8,9-13,14-17,18-21",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREDEB,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 162 U1-8,9-13,14-17,18-21,22-24",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREDEC,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 162 U1-8,9-13,14-17,18-21,22-24",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
.
          CLEAR     CMNDLINE
          PACK      FILENAME,PREHED,RESULTYR
          APPEND    "isbuild ",CMNDLINE
          APPEND    FILENAME,CMNDLINE
          APPEND    " 398 U1-8,9-13,14-17",CMNDLINE
          RESET     CMNDLINE
          EXECUTE   CMNDLINE,TASKID
          MATCH     "0",TASKID
          GOTO      MAKRES90 IF NOT EQUAL
          GOTO      MAKRES99
.
MAKRES90  DISPLAY   *P5:6,"Unix Error - ",TASKID
          MOVE      ONE,EXIT
.
MAKRES99  RETURN
.
.------------------------------------------------------------
. Patient Medical Note Maintenance
.------------------------------------------------------------
PATNOT00  MATCH     "       0",URNUMBER
          GOTO      PATNOT94 IF EQUAL
.
          PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,PATNOT90
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      PATNOT40 IF EQUAL
.
          MATCH     "A",UPDATETY           * Add Formaction
          GOTO      PATNOT10 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete Formaction
          GOTO      PATNOT30 IF EQUAL
.
          GOTO      PATNOT93
.
.         ************ ADD FORMACTION ***********
.
PATNOT10  CALL      CHKPAT00    * Checks mandatory fields and for blanks
          BRANCH    EXIT,PATNOT99
.
          CALL      ADDPAT00              * Add New Type of Note SubRoutine
          MOVE      ZERO,EXIT
          GOTO      PATNOT99
.
.         ************ DELETE FORMACTION **********
.
PATNOT30  CALL      DELPAT00              * Delete Type of Note SubRoutine
          BRANCH    EXIT,PATNOT99
.
          MOVE      ZERO,EXIT
          GOTO      PATNOT99
.. bronko is up to here
.
.         ************ DISPLAY FORMACTION **********
.
PATNOT40  *MOVE      URNUMBER,PMMDURNO   *  UR number
.
          PACK      KEY14,URNUMBER,NOTENUMB,SP70
          CALL      RDPMMDT1
          IF        OVRCD=1
            CALL      CLRPAT00     * Clear all the file variables
          ENDIF
.
          MOVE      "Note Type Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PATNOT99
.
PATNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATNOT99
.
PATNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATNOT99
.
PATNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATNOT99
.
PATNOT94  MOVE      "Patient not Registered. Please Allocate a UR Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATNOT99
.
PATNOT99  CLOSE     COMFILBF,DELETE
          RETURN
.
.-----------------------------------------------------------
. * Checks mandatory fields, Checks U/R Number :cannot be blank
.------------------------------------------------------------
CHKPAT00  RESET     URNUMBER
          MATCH     SP70,URNUMBER
          GOTO      CHKPAT90 IF EQUAL
          GOTO      CHKPAT98
.
CHKPAT90  MOVE      "U/R number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKPAT99
.
CHKPAT98  MOVE      ZERO,EXIT
.
CHKPAT99  RETURN
.
.-----------------------------------------------------------
. Delete a Medical Note for a Patient
.-----------------------------------------------------------
DELPAT00  MATCH     SP70,URNUMBER
          GOTO      DELPAT90 IF EQUAL
.
          MOVE      URNUMBER,PMMDURNO   *  UR number
.
          PACK      KEY14,URNUMBER,NOTENUMB,SP70
          CALL      RDPMMDT1
          BRANCH    OVRCD,DELPAT99
.
          MATCH     "1",SUPRFLAG                                       *I-50359
          IF          !@EQUAL
            MATCH     USERID,PMMDUSER
            GOTO      DELPAT91 IF NOT EQUAL
          ENDIF
.
          PACK      PMMDDDAT,CCC,CYY,CMM,CDD                           *I-50359
          REP       " 0",PMMDDDAT
          CLOCK     TIME,PMMDDTIM
          MOVE      USERID,PMMDDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELPAT99
.
          MOVE      WBSEOCG,PMMDDOCC                               *end I-50359
.
          MOVE      "1",PMMDDELT           * Delete Indicator
          PACK      KEY14,URNUMBER,NOTENUMB,SP70
          CALL      UPPMMDT1               * Write Record
          GOTO      DELPAT98
.
DELPAT90  MOVE      "U/R number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELPAT99
.
DELPAT91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELPAT99
.
DELPAT98  MOVE      ZERO,EXIT
.
DELPAT99  RETURN
.-----------------------------------------------------------
. Add a Medical Note for a Patient
.-----------------------------------------------------------
ADDPAT00  MOVE      ZERO,F6
          MOVE      URNUMBER,PMMDURNO   *  UR number
.
          PACK      KEY14,URNUMBER,Z70
          CALL      RSPMMDT1
          CALL      RPPMMDT1            * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,PMMDNOTE      * Note Number
          ELSE
            MATCH     URNUMBER,PMMDURNO
            IF        @EQUAL
              MOVE      PMMDNOTE,F6
              ADD       ONE,F6
              MOVE      F6,PMMDNOTE
            ELSE
              MOVE      ONE,F6
              MOVE      F6,PMMDNOTE      * Note Number
            ENDIF
          ENDIF
.
          PACK      PMMDDATE,CCC,CYY,CMM,CDD
          REP       " 0",PMMDDATE          * Date
          CLOCK     TIME,PMMDTIME          * Time
          MOVE      USERID,PMMDUSER        * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADDPAT99
.
          MOVE      WBSEOCG,PMMDOCCG       * Occupation Group
          MOVE      "0",PMMDDELT           * Delete Indicator
          MOVE      SP70,PMMDDDAT          * Delete Date               *I-50359
          MOVE      SP70,PMMDDTIM          * Delete Time               *I-50359
          MOVE      SP70,PMMDDUSE          * Delete User ID            *I-50359
          MOVE      SP70,PMMDDOCC          * Delete Occ Group          *I-50359
          MOVE      SP70,PMMDSPAR          * Spare
          MOVE      URNUMBER,PMMDURNO
.
          PACK      KEY14,URNUMBER,PMMDNOTE,SP70
          CALL      RDPMMDT1
          IF        OVRCD=1
            CALL      WRPMMDT1               * Write Record
          ELSE
            GOTO      ADDPAT99
          ENDIF
.

.         now write the medical notes
.
          MOVE      URNUMBER,PMMTURNO
          MOVE      PMMDNOTE,PMMTNOTE
          MOVE      ZERO,F3
.
ADDPAT90  ADD       ONE,F3
          MOVE      F3,PMMTUNIQ
.
          READ      COMFILBF,SEQ;PMMTCMNT
.
          PACK      KEY17,PMMTURNO,PMMTNOTE,PMMTUNIQ,SP70
          CALL      WRPMMTX1
          IF        F3>=LASTITEM
            GOTO     ADDPAT99
          ENDIF
          GOTO      ADDPAT90
.
ADDPAT99  RETURN
.
.------------------------------------------------------------
. Get Patient Comments
.------------------------------------------------------------
GETPCM00  PREP      COMFILBF,COMFILNB
          MOVE      ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
.
GETPCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPCM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPCM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILBF,SEQ;QRYDATA
          GOTO      GETPCM10
.
GETPCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPCM90  MOVE      F3,LASTITEM
          OPEN      COMFILBF,COMFILNB
GETPCM99  RETURN
.--------------------------------------------------------------------------
.Patient Patient Note Maintenance
.--------------------------------------------------------------------------
PMSN0000  BRANCH    FLDITMNO,PMSN0100,PMSN0200,PMSN0300,PMSN0400,PMSN0500:
                             PMSN0600,PMSN0700,PMSN0800,PMSN0900,PMSN1000
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PMSN9999
.
PMSN0100  MATCH     SP70,PMMDNOTE
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMDNOTE;
          GOTO      PMSN9999
.
PMSN0200  MATCH     SP70,PMMDDATE
          GOTO      PMSN9999 IF EQUAL
          UNPACK    PMMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      PMSN9999
.
PMSN0300  MATCH     SP70,PMMDTIME
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMDTIME;
          GOTO      PMSN9999
.
PMSN0400  MATCH     SP70,PMMDUSER
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMDUSER;
          GOTO      PMSN9999
.
PMSN0500  MATCH     SP70,PMMDOCCG
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMDOCCG;
          GOTO      PMSN9999
.
PMSN0600  MATCH     SP70,PMMDDELT
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMDDELT;
          GOTO      PMSN9999
.
PMSN0700  MATCH     SP70,PMMTCMNT
          GOTO      PMSN9999 IF EQUAL
          WRITE     HTMLFILE;PMMTCMNT;
          GOTO      PMSN9999
.
PMSN0800  PACK      KEY17,PMMDURNO,PMMDNOTE,SP70
          CALL      RSPMMTX1
PMSN0810  CALL      RKPMMTX1
          BRANCH    OVRCD,PMSN9999
          MATCH     PMMDURNO,PMMTURNO
          GOTO      PMSN9999 IF NOT EQUAL
.          MATCH     PMMTNOTE,NOTENUMB
          MATCH     PMMTNOTE,PMMDNOTE
          GOTO      PMSN0810 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMMTCMNT;
          GOTO      PMSN0810
.
PMSN0900  CALL      PMSTAB00
          GOTO      PMSN9999
.
PMSN1000  CALL      PMSTTB00                * Snippet notes (Discharge summary)
          GOTO      PMSN9999
.
PMSN9999  RETURN
.
.------------------------------------------------------------
. Display Table of Clinical Note
.---------------------------------------------------------------------
PMSTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      PMHED000      * Output Table Heading
.
          MOVE      URNUMBER,PMMDURNO
          PACK      KEY14,PMMDURNO,Z70
          CALL      RSPMMDT1
PMSTAB10  CALL      RPPMMDT1
          BRANCH    OVRCD,PMSTAB99
          MATCH     URNUMBER,PMMDURNO
          GOTO      PMSTAB99 IF NOT EQUAL
.
          MATCH     PMMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     PMSTAB40
          ENDIF
.
          UNPACK    PMMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.PMSTAB20  MATCH     SP70,PMMTUNIQ            * If FF Note is Empty ?
.         GOTO      PMSTAB30 IF EQUAL
.         MOVE      PMMTUNIQ,CTR
.         MOVE      ZERO,F3
.PMSTAB30  ADD       ONE,F3
.         WHILE     F3<=CTR
.           PACK      KEY17,URNUMBER,PMMDNOTE,F3
.           CALL      RDPMMTX1
.           MOVE      PMMTCMNT,NOTETEXT[F3] * Line Details
.           ADD       ONE,F3
.         DO
.
          MATCH     "1",PMMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",PMMDNOTE
.
          PACK      WBSENAM,SP70
          PACK      KEY10,PMMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            STRIP     WBSENAM
          ELSE
            MOVE      PMMDUSER,WBSENAM
          ENDIF
.
PMSTAB40  WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
.                             "&template=003":
                             "&urnumber=",URNUMBER:
                             "&notenumb=",PMMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,PMMDTIME,"</td>":
                             "<td>",STRIKETG,WBSENAM," - ",PMMDOCCG,"&nbsp;":
                             STRENDTG,"</td>":
                             "<td>",STRIKETG;
          MOVE      ZERO,CTR
          CALL      PMSNOT00
.
          PACK      WBSENAM,SP70
          PACK      KEY10,PMMDDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD<>1
            STRIP     WBSENAM
          ELSE
            MOVE      PMMDDUSE,WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                             "<td>",WBSENAM," - ",PMMDDOCC,"&nbsp;":
                             "</td>":
                             "</tr>"

          REP       "+ ",URNUMBER
          REP       "+ ",PMMDNOTE
.
          GOTO      PMSTAB10
PMSTAB99  RETURN
.------------------------------------------------------------
. Medical Note Summery (TABLE HEADING)
.------------------------------------------------------------
PMHED000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>":
                              "Notes</td>":
                              "<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"                                   *I-50359
.
PMHED999  RETURN
.--------------------------------------------------------------------
. Patient note display
.--------------------------------------------------------------------
PMSNOT00  REP       "+ ",URNUMBER
          REP       "+ ",PMMDNOTE
          PACK      KEY17,URNUMBER,PMMDNOTE,SP70
          CALL      RSPMMTX1
PMSNOT10  CALL      RKPMMTX1
          BRANCH    OVRCD,PMSNOT99
          MATCH     PMMTURNO,URNUMBER
          GOTO      PMSNOT99 IF NOT EQUAL
          MATCH     PMMTNOTE,PMMDNOTE
          GOTO      PMSNOT99 IF NOT EQUAL
          COMPARE   TWO,CTR
          GOTO      PMSNOT99 IF EQUAL
          ADD       ONE,CTR
          WRITE     HTMLFILE;PMMTCMNT,"<br>";
          GOTO      PMSNOT10
.
PMSNOT99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRPAT00  MOVE      SP70,PMMDURNO  *  UR NUMBER
          MOVE      SP70,PMMDNOTE  *  Note Number
          MOVE      SP70,PMMDDATE  *  Date
          MOVE      SP70,PMMDTIME  *  TIME
          MOVE      SP70,PMMDUSER  *  User
          MOVE      SP70,PMMDOCCG  *  Occupational Gp.
          MOVE      SP70,PMMDDELT  *  Delete Indicator
.
          MOVE      SP70,PMMTURNO  *  UR Number
          MOVE      SP70,PMMTNOTE  *  Note
          MOVE      SP70,PMMTUNIQ  *  Uniq line number
          MOVE      SP70,PMMTCMNT  *  Comment line
          MOVE      SP70,PMMTSPAR  *  Spare
.
CLRPAT99  RETURN
.
.------------------------------------------------------------
. Encounter Note Maintenance
.------------------------------------------------------------
ENCNOT00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ENCNOT40 IF EQUAL
.         
          MATCH     "A",UPDATETY            * Add Notes Formaction
          GOTO      ENCNOT10 IF EQUAL       
.         
          MATCH     "D",UPDATETY            * Delete Notes Formaction
          GOTO      ENCNOT30 IF EQUAL       
.         
          GOTO      ENCNOT93
.         
.         ************ ADD FORMACTION ***********
.         
ENCNOT10  PACK      KEY16,ADMISSNO,ENCOUNTN,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,ENCNOT90
.
          CALL      ADDENC00                * Add Encounter Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      ENCNOT99
.
.         ************ DELETE FORMACTION **********
.
ENCNOT30  PACK      KEY16,ADMISSNO,ENCOUNTN,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,ENCNOT90
.
          CALL      DELENC00                * Delete Encounter Note SubRoutine
          BRANCH    EXIT,ENCNOT99
.
          MOVE      ZERO,EXIT
          GOTO      ENCNOT99
.
.         ************ DISPLAY FORMACTION **********
.
ENCNOT40  PACK      KEY16,ADMISSNO,ENCOUNTN,SP70
          CALL      RDALENC1
          BRANCH    OVRCD,ENCNOT90
.
          PACK      KEY25,ADMISSNO,ENCOUNTN,NOTETYPE,NOTENUMB,SP70
          CALL      RDALMDT1
          IF        OVRCD=1
            CALL      CLENOT00     * Clear all the file variables
          ENDIF
.
          MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,VSCMUNQ
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70
.
          CALL      RDVSCTM1
          IF        OVRCD=1
            CALL      CLRVSC00              * Clear all the file variables
          ENDIF
.
          MOVE      "Encounter Note Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ENCNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ENCNOT99
.
ENCNOT90  MOVE      "Invalid Patient Encounter ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNOT99
.
ENCNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNOT99
.
ENCNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNOT99
.
ENCNOT94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ENCNOT99
.
ENCNOT99  CLOSE     COMFILVF,DELETE
          RETURN
.
.------------------------------------------------------------
. Discharge Summary Display and Print
.------------------------------------------------------------
DISSUM00  MOVE      ZERO,EXIT
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DISSUM90
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDOBPIN1
          IF        OVRCD=1
            CALL      CLROBPIN
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDOBNDD1
          IF        OVRCD=1
            CALL      CLOBSNDD
          ENDIF
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD=1
            CALL      CLPATTRN
          ELSE
            MATCH     ADMISSNO,DTADMN
            IF        !@EQUAL
              CALL      CLPATTRN
            ENDIF
          ENDIF
 
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      DISSUM40 IF EQUAL
.
          MATCH     "P",UPDATETY            * Print Formaction
          GOTO      DISSUM10 IF EQUAL
.
DISSUM10
DISSUM40  MOVE      "Discharge Summary",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISSUM99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DISSUM99
.
DISSUM90  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISSUM99
.
DISSUM99  RETURN
.------------------------------------------------------------
. Referral Note Maintenance
.------------------------------------------------------------
REFNOT00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      REFNOT40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Notes Formaction
          GOTO      REFNOT10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Notes Formaction
          GOTO      REFNOT30 IF EQUAL
.
          GOTO      REFNOT93
.
.         ************ ADD FORMACTION ***********
.
REFNOT10  CALL      CHKVIS00           * Checks mandatory fields and for blanks
          BRANCH    EXIT,REFNOT99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REFNOT90
.
          CALL      ADDNOT00                * Add Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      REFNOT99
.
.         ************ DELETE FORMACTION **********
.
REFNOT30  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REFNOT90
.
          CALL      DELNOT00                * Delete Note SubRoutine
          BRANCH    EXIT,REFNOT99
.
          MOVE      ZERO,EXIT
          GOTO      REFNOT99
.
.         ************ DISPLAY FORMACTION **********
.
REFNOT40  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REFNOT90
.
          MOVE      ALREURNO,URNUMBER
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,REFNOT94
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,VSCMUNQ
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70
.
          CALL      RDVSCTM1
          IF        OVRCD=1
            CALL      CLRVSC00              * Clear all the file variables
          ENDIF
.
          MOVE      "Referral Note Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,REFNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      REFNOT99
.
REFNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFNOT99
.
REFNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFNOT99
.
REFNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFNOT99
.
REFNOT94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFNOT99
.
REFNOT99  CLOSE     COMFILVF,DELETE
          RETURN
.
.------------------------------------------------------------
. Visit Comments Maintenance
.------------------------------------------------------------
VSCMMA00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      VSCMMA40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Formaction
          GOTO      VSCMMA10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Formaction
          GOTO      VSCMMA20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Formaction
          GOTO      VSCMMA30 IF EQUAL
.
          GOTO      VSCMMA93
.
.         ************ ADD FORMACTION ***********
.
VSCMMA10  CALL      CHKVIS00                * Checks mandatory fields
          BRANCH    EXIT,VSCMMA99
.
          CALL      ADVSCM00                * Add visit comments
          BRANCH    EXIT,VSCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      VSCMMA99
.
.         ************ UPDATE FORMACTION **********
.
VSCMMA20  CALL      UPVSCM00                * Update visit comments 
          BRANCH    EXIT,VSCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      VSCMMA99
.
.         ************ DELETE FORMACTION **********
.
VSCMMA30  CALL      DELNOT00                * Delete visit comments
          BRANCH    EXIT,VSCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      VSCMMA99
.
.         ************ DISPLAY FORMACTION **********
.
VSCMMA40  MATCH     SP70,ADMISSNO
          GOTO      VSCMMA90 IF EQUAL      
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          IF        OVRCD = 1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      "Visit Comments Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VSCMMA99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      VSCMMA99
.
VSCMMA90  MOVE      "Visit Number hould not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VSCMMA99
.
VSCMMA93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VSCMMA99
.
VSCMMA99  CLOSE     COMFILVF,DELETE
          RETURN
.
.--------------------------------------------------------------
. Inserting new data into the visit comments vismdtaf/vismtxaf
.--------------------------------------------------------------
ADVSCM00  IF        VSCMTFLG <> 1
            GOTO      ADVSCM99
          ENDIF
.
          IF        VSCMTLIN = 0
            GOTO      ADVSCM99 
          ENDIF
.
          MOVE      ZERO,F6
.
          PACK      KEY17,ADMISSNO,NOTETYPE,Z70
          CALL      RSVSMDT1
          CALL      RPVSMDT1                * read back to get last record
          IF        OVRCD = 1
            MOVE      ONE,F6
            MOVE      F6,VSMDNOTE           * Note Number
          ELSE
            MATCH     ADMISSNO,VSMDVISN     * Same visit
            IF        @EQUAL
              MATCH     NOTETYPE,VSMDTYPE   * Same note type
              IF        @EQUAL
                MOVE      VSMDNOTE,F6
                ADD       ONE,F6
                MOVE      F6,VSMDNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,VSMDNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,VSMDNOTE         * Note Number
            ENDIF
          ENDIF
.
.         Insert visit comment header
.
          MOVE      ADMISSNO,VSMDVISN       * Visit number
          MOVE      NOTETYPE,VSMDTYPE       * Notes Type
.
          MOVE      CMNTDATE,VSMDDATE
          MOVE      CMNTTIME,VSMDTIME
          MOVE      USERID,VSMDUSER         * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSEOCG
          ENDIF
          MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
.
          MOVE      ZERO,VSMDDELT           * Delete Indicator
          MOVE      SP70,VSMDDDAT           * Delete Date
          MOVE      SP70,VSMDDTIM           * Delete Time
          MOVE      SP70,VSMDDUSE           * Delete User
          MOVE      SP70,VSMDDOCC           * Delete User Occupation group
          PACK      PMMDSPAR,SP70,SP70      * Spare
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RDVSMDT1
          IF        OVRCD = 1
            CALL      WRVSMDT1              * Write Record
          ELSE
            GOTO      ADVSCM99
          ENDIF
.
.         Insert visit comment details
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADVSCM99
.
          MOVE      ZERO,VSTXUNIQ 
ADVSCM40  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      ADVSCM98 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      ADVSCM98
          ENDIF
          GOTO      ADVSCM40
.
ADVSCM98  CLOSE     COMVISAF,DELETE
          MOVE      ZERO,EXIT
.
ADVSCM99  RETURN
.
.-----------------------------------------------------------
. Update Visit Comments for a Patient
.-----------------------------------------------------------
UPVSCM00  MATCH     SP70,ADMISSNO
          GOTO      UPVSCM90 IF EQUAL
.
          IF        VSCMTFLG <> 1
            GOTO      UPVSCM99
          ENDIF
.
          MOVE      ADMISSNO,VSMDVISN   *  Visit Number
.
          MATCH     "1",SUPRFLAG
          IF        @EQUAL
            CALL      UPVSCS00
            GOTO      UPVSCM99
          ENDIF
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,UPVSCM99
.
          MATCH     SP70,VSMDUSER
          IF        !@EQUAL
            MATCH     USERID,VSMDUSER
            GOTO      UPVSCM91 IF NOT EQUAL
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,UPVSCM92
.
.         Delete all the comments details before adding them back
.
UPVSCM40  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
          CALL      RKVSMTX1
          BRANCH    OVRCD,UPVSCM50          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      UPVSCM50 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      UPVSCM50 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      UPVSCM50 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      UPVSCM40
.
.         Insert comment details
. 
UPVSCM50  IF        VSCMTLIN = 0
            GOTO      UPVSCM99
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVSCM99
.
.         Insert visit comments
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVSCM60  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVSCM98 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      UPVSCM98
          ENDIF
.
          GOTO      UPVSCM60
.
UPVSCM90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVSCM99
.
UPVSCM91  MOVE      "User ID must be the same to update this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVSCM99
.
UPVSCM92  MOVE      "User ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVSCM99
.
UPVSCM98  CLOSE     COMVISAF,DELETE
          MOVE      ZERO,EXIT
.
UPVSCM99  RETURN
.
.-----------------------------------------------------------
. Update Visit Comments for a Patient by Supervisor
.-----------------------------------------------------------
UPVSCS00  MOVE      ADMISSNO,VSMDVISN       *  Visit Number
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,UPVSCS99
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,UPVSCS92
.
. Update the current comment header as deleted
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,UPVSCS91
.
          MOVE      "1",VSMDDELT            * Delete Indicator
          MOVE      USERID,VSMDDUSE
          MOVE      CURRDATE,VSMDDDAT
          MOVE      CURRTIME,VSMDDTIM
          MOVE      WBSEOCG,VSMDDOCC
          CALL      UPVSMDT1
.
. Insert new comment header/details
.
          MOVE      CURRDATE,CMNTDATE
          MOVE      CURRTIME,CMNTTIME
          CALL      ADVSCM00 
          GOTO      UPURCS99
.
UPVSCS91  MOVE      "Admission comment header not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVSCS99
.
UPVSCS92  MOVE      "User ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVSCS99
.
UPVSCS99  RETURN
.
.------------------------------------------------------------
. UR Comments Maintenance
.------------------------------------------------------------
URCMMA00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      URCMMA40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Formaction
          GOTO      URCMMA10 IF EQUAL
.
          MATCH     "U",UPDATETY            * Update Formaction
          GOTO      URCMMA20 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Formaction
          GOTO      URCMMA30 IF EQUAL
.
          GOTO      URCMMA93
.
.         ************ ADD FORMACTION ***********
.
URCMMA10  CALL      ADURCM00                * Add UR comments
          BRANCH    EXIT,URCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      URCMMA99
.
.         ************ UPDATE FORMACTION **********
.
URCMMA20  CALL      UPURCM00                * Update UR comments
          BRANCH    EXIT,URCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      URCMMA99
.
.         ************ DELETE FORMACTION **********
.
URCMMA30  CALL      DLURCM00                * Delete UR comments
          BRANCH    EXIT,URCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      URCMMA99
.
.         ************ DISPLAY FORMACTION **********
.
URCMMA40  RESET     URNUMBER
          MATCH     SP70,URNUMBER
          GOTO      URCMMA90 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,URCMMA91
.
          PACK      KEY17,URNUMBER,NOTETYPE,NOTENUMB,SP70
          CALL      RDPMUCH1
          IF        OVRCD = 1
            CALL      CLURCM00            * Clear all the file variables
          ENDIF
.
          MOVE      "UR Comments Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,URCMMA99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      URCMMA99
.
URCMMA90  MOVE      "UR Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      URCMMA99
.
URCMMA91  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      URCMMA99
.
URCMMA93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      URCMMA99
.
URCMMA99  CLOSE     COMFILVF,DELETE
          RETURN
.
.--------------------------------------------------------------
. Inserting new data into the UR comments pmsuchaf/pmsucdaf
.--------------------------------------------------------------
ADURCM00  IF        URCMTFLG <> 1
            GOTO      ADURCM99
          ENDIF
.
          IF        URCMTLIN = 0
            GOTO      ADURCM99
          ENDIF
.
          MOVE      ZERO,F6
.
          PACK      KEY17,URNUMBER,Z70
          CALL      RSPMUCH1
          CALL      RPPMUCH1                * read back to get last record
          IF        OVRCD = 1
            MOVE      ONE,F6
            MOVE      F6,PMUHCNUM           * Note Number
          ELSE
            MATCH     URNUMBER,PMUHURNO     * Same UR
            IF        @EQUAL
              MATCH     NOTETYPE,PMUHCTYP   * Same note type
              IF        @EQUAL
                MOVE      PMUHCNUM,F6
                ADD       ONE,F6
                MOVE      F6,PMUHCNUM
              ELSE
                MOVE      ONE,F6
                MOVE      F6,PMUHCNUM       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,PMUHCNUM         * Note Number
            ENDIF
          ENDIF
.
.         Insert UR comment header
.
          MOVE      URNUMBER,PMUHURNO       * UR number
          MOVE      NOTETYPE,PMUHCTYP       * Notes Type
.
          MOVE      CMNTDATE,PMUHCDAT
          MOVE      CMNTTIME,PMUHCTIM
          MOVE      USERID,PMUHCUID         * User
.
          PACK      KEY10,USERID,SP70          
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSEOCG
          ENDIF
          MOVE      WBSEOCG,PMUHOCCG        * Occupation Group
.
          MOVE      ZERO,PMUHDELT           * Delete Indicator
          MOVE      SP70,PMUHDDAT           * Delete Date
          MOVE      SP70,PMUHDTIM           * Delete Time
          MOVE      SP70,PMUHDUID           * Delete User
          MOVE      SP70,PMUHDOCG           * Delete User Occupation group
          PACK      PMMDSPAR,SP70,SP70      * Spare
.
          PACK      KEY17,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RDPMUCH1
          IF        OVRCD = 1
            CALL      WRPMUCH1              * Write Record
          ELSE
            GOTO      ADURCM99
          ENDIF
.
.         Insert UR comment details
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMURCAF,COMURCNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADURCM99
.
          MOVE      ZERO,URTXUNIQ
ADURCM40  READ      COMURCAF,SEQ;PMUCCOMM
          GOTO      ADURCM98 IF OVER
.
          ADD       ONE,URTXUNIQ            * add to line number
.
          MOVE      PMUHURNO,PMUCURNO      
          MOVE      PMUHCTYP,PMUCCTTY
          MOVE      PMUHCNUM,PMUCCNUM
          MOVE      URTXUNIQ,PMUCLNUM
          MOVE      SP70,PMUCSPAR
.
          PACK      KEY20,PMUCURNO,PMUCCTTY,PMUCCNUM,PMUCLNUM,SP70
          CALL      WRPMUCD1
.
          IF        URTXUNIQ = 99
            GOTO      ADURCM98
          ENDIF
          GOTO      ADURCM40
.
ADURCM98  CLOSE     COMURCAF,DELETE
          MOVE      ZERO,EXIT
.
ADURCM99  RETURN
.
.-----------------------------------------------------------
. Update UR Comments for a Patient
.-----------------------------------------------------------
UPURCM00  MATCH     SP70,URNUMBER
          GOTO      UPURCM90 IF EQUAL
.
          IF        URCMTFLG <> 1
            GOTO      UPURCM99
          ENDIF
.
          MATCH     "1",SUPRFLAG
          IF        @EQUAL
            CALL      UPURCS00
            GOTO      UPURCM99
          ENDIF
.
          MOVE      URNUMBER,PMUHURNO      * UR Number
.
          PACK      KEY17,URNUMBER,NOTETYPE,NOTENUMB,SP70
          CALL      RDPMUCH1
          BRANCH    OVRCD,UPURCM99
.
          MATCH     SP70,PMUHCUID
          IF        !@EQUAL
            MATCH     USERID,PMUHCUID
            GOTO      UPURCM91 IF NOT EQUAL
          ENDIF
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,UPURCM92
.
.         Delete all the comments details before adding them back
.
UPURCM40  PACK      KEY20,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RSPMUCD1
          CALL      RKPMUCD1
          BRANCH    OVRCD,UPURCM50          * end of file
.
          MATCH     PMUHURNO,PMUCURNO       * same Admission Number?
          GOTO      UPURCM50 IF NOT EQUAL
.
          MATCH     PMUHCTYP,PMUCCTTY
          GOTO      UPURCM50 IF NOT EQUAL
.
          MATCH     PMUHCNUM,PMUCCNUM
          GOTO      UPURCM50 IF NOT EQUAL
.
          PACK      KEY20,PMUCURNO,PMUCCTTY,PMUCCNUM,PMUCLNUM,SP70
          CALL      DEPMUCD1
          GOTO      UPURCM40
.
.         Insert comment details
.
UPURCM50  IF        URCMTLIN = 0
            GOTO      UPURCM99
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMURCAF,COMURCNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPURCM99
.
.         Insert UR comments
.
          MOVE      ZERO,F3
          MOVE      F3,URTXUNIQ
UPURCM60  READ      COMURCAF,SEQ;PMUCCOMM
          GOTO      UPURCM98 IF OVER
.
          ADD       ONE,URTXUNIQ            * add to line number
.
          MOVE      PMUHURNO,PMUCURNO       
          MOVE      PMUHCTYP,PMUCCTTY
          MOVE      PMUHCNUM,PMUCCNUM
          MOVE      URTXUNIQ,PMUCLNUM
          MOVE      SP70,PMUCSPAR
          PACK      KEY20,PMUCURNO,PMUCCTTY,PMUCCNUM,PMUCLNUM,SP70
          CALL      WRPMUCD1
.
          IF        URTXUNIQ = 99
            GOTO      UPURCM98
          ENDIF
.
          GOTO      UPURCM60
.
UPURCM90  MOVE      "U/R Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPURCM99
.
UPURCM91  MOVE      "User ID must be the same to update this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPURCM99
.
UPURCM92  MOVE      "User ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPURCM99
.
UPURCM98  CLOSE     COMURCAF,DELETE
          MOVE      ZERO,EXIT
.
UPURCM99  RETURN
.
.-----------------------------------------------------------
. Update a UR Comments for a Patient by Supervisor 
.-----------------------------------------------------------
UPURCS00  MOVE      URNUMBER,PMUHURNO      * UR Number
.
          PACK      KEY17,URNUMBER,NOTETYPE,NOTENUMB,SP70
          CALL      RDPMUCH1
          BRANCH    OVRCD,UPURCS99
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,UPURCS92
.
. Update the comment header as deleted
.
          PACK      KEY17,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RDPMUCH1
          BRANCH    OVRCD,UPURCS91
.
          MOVE      "1",PMUHDELT            * Delete Indicator
          MOVE      USERID,PMUHDUID
          MOVE      CURRDATE,PMUHDDAT
          MOVE      CURRTIME,PMUHDTIM
          MOVE      WBSEOCG,PMUHDOCG
          CALL      UPPMUCH1
.
. Insert new comment header/details
.
          MOVE      CURRDATE,CMNTDATE
          MOVE      CURRTIME,CMNTTIME
          CALL      ADURCM00
          GOTO      UPURCS99
.
UPURCS91  MOVE      "U/R Comment header not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPURCS99
.
UPURCS92  MOVE      "User ID does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPURCS99
.
UPURCS99  RETURN
.
.-----------------------------------------------------------
. Delete a UR Note for a Patient
.-----------------------------------------------------------
DLURCM00  MATCH     SP70,URNUMBER
          GOTO      DLURCM90 IF EQUAL
.
          MOVE      URNUMBER,PMUHURNO          * UR Number
.
          PACK      KEY17,URNUMBER,NOTETYPE,NOTENUMB,SP70
          CALL      RDPMUCH1
          BRANCH    OVRCD,DLURCM99
.
          MATCH     "1",SUPRFLAG
          IF          !@EQUAL
            MATCH     SP70,PMUHCUID
            IF        !@EQUAL
              MATCH     USERID,PMUHCUID
              GOTO      DLURCM91 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      PMUHDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMUHDDAT
          CLOCK     TIME,PMUHDTIM
          MOVE      USERID,PMUHDUID
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DLURCM99
.
          MOVE      WBSEOCG,PMUHDOCG
.
          MOVE      "1",PMUHDELT           * Delete Indicator
          PACK      KEY17,URNUMBER,NOTETYPE,NOTENUMB,SP70
          CALL      UPPMUCH1               * Write Record
          GOTO      DLURCM98
.
DLURCM90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DLURCM99
.
DLURCM91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DLURCM99
.
DLURCM98  MOVE      ZERO,EXIT
.
DLURCM99  RETURN
.
.-----------------------------------------------------------
.         Clears the UR file variables
.-----------------------------------------------------------
CLURCM00  MOVE      SP70,PMUHURNO      * UR Number
          MOVE      SP70,PMUHCTYP      * Comment Type
          MOVE      SP70,PMUHCNUM      * Note Number
          MOVE      SP70,PMUHCUID      * Input by WEB User ID (websecaf)
          MOVE      SP70,PMUHCDAT      * Input Date (CCYYMMDD)
          MOVE      SP70,PMUHCTIM      * Input Time (HH:MM:SS)
          MOVE      SP70,PMUHOCCG      * Occupational Group WEB User ID
          MOVE      SP70,PMUHDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,PMUHDUID      * Delete by WEB User ID (websecaf)
          MOVE      SP70,PMUHDDAT      * Delete Date (CCYYMMDD)
          MOVE      SP70,PMUHDTIM      * Delete Time (HH:MM:SS)
          MOVE      SP70,PMUHDOCG      * Occupational Group WEB User ID Dele
          MOVE      SP70,PMUHSPAR      * Spare Variable
.
          MOVE      SP70,PMUCURNO      * UR Number
          MOVE      SP70,PMUCCTTY      * Comment Type
          MOVE      SP70,PMUCCNUM      * Note Number
          MOVE      SP70,PMUCLNUM      * Line Number
          MOVE      SP70,PMUCCOMM      * Comment
          MOVE      SP70,PMUCSPAR      * Spare Variable
.
CLURCM99  RETURN
.
.------------------------------------------------------------
. Expected Patient Comment Maintenance
.------------------------------------------------------------
EXCMMA00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      EXCMMA70 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Formaction
          GOTO      EXCMMA10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Formaction
          GOTO      EXCMMA30 IF EQUAL
.
          GOTO      EXCMMA93
.
.         ************ ADD FORMACTION ***********
.
EXCMMA10  CALL      ADEXCM00                * Add Comments
          BRANCH    EXIT,EXCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      EXCMMA99
.
.         ************ DELETE FORMACTION **********
.
EXCMMA30  CALL      DLEXCM00                * Delete Comments
          BRANCH    EXIT,EXCMMA99
.
          MOVE      ZERO,EXIT
          GOTO      EXCMMA99
.
.         ************ DISPLAY FORMACTION **********
.
EXCMMA70  RESET     EXPTUNIQ
          MATCH     SP70,EXPTUNIQ
          GOTO      EXCMMA90 IF EQUAL
.
          PACK      KEY10,EXPTUNIQ,SP70
          CALL      RDEMEXP1
          BRANCH    OVRCD,EXCMMA91
.
          MOVE      EMEXURNO,KEY8
          CALL      RDMAST1
.
          MOVE      "Expected Patient Comment Maintenance",WEBTITLE
.
          CALL      WEBHED00   
          BRANCH    EXIT,EXCMMA99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EXCMMA99
.
EXCMMA90  MOVE      "Expected Patient Unique Number is blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXCMMA99
.
EXCMMA91  MOVE      "Invalid Expected Patient Unique Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXCMMA99
.
EXCMMA93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXCMMA99
.
EXCMMA99  CLOSE     COMFILVF,DELETE
          RETURN
.
.--------------------------------------------------------------
. Inserting new data into the comments emrechaf/emreclaf
.--------------------------------------------------------------
ADEXCM00  IF        EXPCMFLG <> 1
            GOTO      ADEXCM99
          ENDIF
.
          IF        EXPCMLIN = 0
            GOTO      ADEXCM99
          ENDIF
.
          MOVE      ZERO,F6
          MOVE      "001",NOTETYPE
.
          PACK      KEY19,EXPTUNIQ,Z70
          CALL      RSEMECH1
          CALL      RPEMECH1                * read back to get last record
          IF        OVRCD = 1
            MOVE      ONE,F6
            MOVE      F6,EMEHNOTE           * Note Number
          ELSE
            MATCH     EXPTUNIQ,EMEHUNIQ     * Same UR
            IF        @EQUAL
              MATCH     NOTETYPE,EMEHTYPE   * Same note type
              IF        @EQUAL
                MOVE      EMEHNOTE,F6
                ADD       ONE,F6
                MOVE      F6,EMEHNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,EMEHNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,EMEHNOTE         * Note Number
            ENDIF
          ENDIF
.
.         Insert comment header
.
          MOVE      EXPTUNIQ,EMEHUNIQ       * UR number
          MOVE      NOTETYPE,EMEHTYPE       * Notes Type
.
          MOVE      CMNTDATE,EMEHCDAT
          MOVE      CMNTTIME,EMEHCTIM
          MOVE      USERID,EMEHCUID         * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSEOCG
          ENDIF
          MOVE      WBSEOCG,EMEHOCCG        * Occupation Group
.
          MOVE      ZERO,EMEHDELT           * Delete Indicator
          MOVE      SP70,EMEHDDAT           * Delete Date
          MOVE      SP70,EMEHDTIM           * Delete Time
          MOVE      SP70,EMEHDUID           * Delete User
          MOVE      SP70,EMEHDOCC           * Delete User Occupation group
          MOVE      SP70,EMEHSPAR           * Spare
.
          PACK      KEY19,EMEHUNIQ,EMEHTYPE,EMEHNOTE,SP70
          CALL      RDEMECH1
          IF        OVRCD = 1
            CALL      WREMECH1              * Write Record
          ELSE
            GOTO      ADEXCM99
          ENDIF
.
.         Insert comment details
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMEXPAF,COMEXPNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADEXCM99
.
          MOVE      ZERO,CLINECNT
ADEXCM40  READ      COMEXPAF,SEQ;EMELCMNT 
          GOTO      ADEXCM98 IF OVER
.
          ADD       ONE,CLINECNT            * add to line number
.
          MOVE      EMEHUNIQ,EMELUNIQ
          MOVE      EMEHTYPE,EMELTYPE
          MOVE      EMEHNOTE,EMELNOTE
          MOVE      CLINECNT,EMELLINE
          MOVE      SP70,EMELSPAR
.
          PACK      KEY20,EMELUNIQ,EMELTYPE,EMELNOTE,EMELLINE,SP70
          CALL      WREMECL1
.
          IF        CLINECNT = 999
            GOTO      ADEXCM98
          ENDIF
          GOTO      ADEXCM40
.
ADEXCM98  CLOSE     COMEXPAF,DELETE
          MOVE      ZERO,EXIT
.
ADEXCM99  RETURN
.
.-----------------------------------------------------------
. Delete a Note for a Patient
.-----------------------------------------------------------
DLEXCM00  MATCH     SP70,EXPTUNIQ
          GOTO      DLEXCM90 IF EQUAL
.
          MOVE      EXPTUNIQ,EMEHUNIQ          * UR Number
.
          PACK      KEY19,EXPTUNIQ,NOTETYPE,NOTENUMB,SP70
          CALL      RDEMECH1
          BRANCH    OVRCD,DLEXCM99
.
          PACK      EMEHDDAT,CCC,CYY,CMM,CDD
          REP       " 0",EMEHDDAT
          CLOCK     TIME,EMEHDTIM
          MOVE      USERID,EMEHDUID
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DLEXCM99
.
          MOVE      WBSEOCG,EMEHDOCC
.
          MOVE      "1",EMEHDELT           * Delete Indicator
          PACK      KEY19,EXPTUNIQ,NOTETYPE,NOTENUMB,SP70
          CALL      UPEMECH1               
          GOTO      DLEXCM98
.
DLEXCM90  MOVE      "Expected Patient Unique Number is blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DLEXCM99
.
DLEXCM91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DLEXCM99
.
DLEXCM98  MOVE      ZERO,EXIT
.
DLEXCM99  RETURN
.
.-----------------------------------------------------------
. Clears the expected patient comment file variables
.-----------------------------------------------------------
CLEXCM00  MOVE      SP70,EMEHUNIQ      * Unique Counter
          MOVE      SP70,EMEHTYPE      * Comment Type
          MOVE      SP70,EMEHNOTE      * Note Number
          MOVE      SP70,EMEHCDAT      * Input Date (CCYYMMDD)
          MOVE      SP70,EMEHCTIM      * Input Time (HH:MM:SS)
          MOVE      SP70,EMEHCUID      * Input by WEB User ID (websecaf)
          MOVE      SP70,EMEHOCCG      * Occupational Group WEB User ID
          MOVE      SP70,EMEHDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,EMEHDDAT      * Delete Date (CCYYMMDD)
          MOVE      SP70,EMEHDTIM      * Delete Time (HH:MM:SS)
          MOVE      SP70,EMEHDUID      * Delete by WEB User ID (websecaf)
          MOVE      SP70,EMEHDOCC      * Del Occupational Group WEB User ID
          MOVE      SP70,EMEHSPAR      * Spare Variable
.
          MOVE      SP70,EMEHUNIQ      * Unique Counter 
          MOVE      SP70,EMELTYPE      * Comment Type
          MOVE      SP70,EMELNOTE      * Note Number
          MOVE      SP70,EMELLINE      * Line Number
          MOVE      SP70,EMELCMNT      * Comment
          MOVE      SP70,EMELSPAR      * Spare Variable
.
CLEXCM99  RETURN
.
.------------------------------------------------------------
. Patient Attribute Maintenance
.------------------------------------------------------------
PATATR00  MOVE      ZERO,EXIT
          RESET     URNUMBER
          MATCH     SP70,URNUMBER
          GOTO      PATATR90 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PATATR91
.
          MOVE      "Patient Attribute Details",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,URCMMA99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PATATR99
.
PATATR90  MOVE      "UR Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATATR99
.
PATATR91  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATATR99
.
PATATR99  RETURN
.
.------------------------------------------------------------
. Eclipse Note Maintenance
.------------------------------------------------------------
ECLNOT00  MOVE      ZERO,EXIT
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECLNOT40 IF EQUAL
.
          MATCH     "A",UPDATETY            * Add Notes Formaction
          GOTO      ECLNOT10 IF EQUAL
.
          MATCH     "D",UPDATETY            * Delete Notes Formaction
          GOTO      ECLNOT30 IF EQUAL
.
          GOTO      ECLNOT93
.
.         ************ ADD FORMACTION ***********
.
ECLNOT10  CALL      CHKVIS00           * Checks mandatory fields and for blanks
          BRANCH    EXIT,ECLNOT99
.
          MATCH     "003",NOTETYPE
          GOTO      ECLNOT15 IF EQUAL       * billing comments
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ECLNOT90
.
ECLNOT15  CALL      ADDNOT00                * Add Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      ECLNOT99
.
.         ************ DELETE FORMACTION **********
.
ECLNOT30  MATCH     "003",NOTETYPE
          GOTO      ECLNOT35 IF EQUAL       * billing comments
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ECLNOT90
.
ECLNOT35  CALL      DELNOT00                * Delete Note SubRoutine
          BRANCH    EXIT,ECLNOT99
.
          MOVE      ZERO,EXIT
          GOTO      ECLNOT99
.
.         ************ DISPLAY FORMACTION **********
.
ECLNOT40  MATCH     "003",NOTETYPE
          GOTO      ECLNOT45 IF EQUAL       * billing comments
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ECLNOT90
.
          MOVE      AURNO,URNUMBER
ECLNOT45  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ECLNOT94
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,VSCMUNQ
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70
.
          CALL      RDVSCTM1
          IF        OVRCD=1
            CALL      CLRVSC00              * Clear all the file variables
          ENDIF
.
          MOVE      "Eclipse Note Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ECLNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ECLNOT99
.
ECLNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECLNOT99
.
ECLNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECLNOT99
.
ECLNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECLNOT99
.
ECLNOT94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECLNOT99
.
ECLNOT99  CLOSE     COMFILVF,DELETE
          RETURN
+
.------------------------------------------------------------
. Visit Note Maintenance
.------------------------------------------------------------
VISNOT00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VISNOT90
.
          COMPARE   FOUR,EMVISTAT
          GOTO      VISNOT90 IF EQUAL
.
          CALL      CHKUR000              * Get U/R details
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      VISNOT40 IF EQUAL
.
          MATCH     "A",UPDATETY           * Add Management Notes Formaction
          GOTO      VISNOT10 IF EQUAL
.
          MATCH     "U",UPDATETY           * Update Management Notes Formaction
          GOTO      VISNOT20 IF EQUAL
.
          MATCH     "D",UPDATETY           * Delete Management Notes Formaction
          GOTO      VISNOT30 IF EQUAL
.
          GOTO      VISNOT93
.
.         ************ ADD FORMACTION ***********
.
VISNOT10  CALL      CHKVIS00    * Checks mandatory fields and for blanks
          BRANCH    EXIT,VISNOT99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VISNOT90
.
          COMPARE   FOUR,EMVISTAT
          GOTO      VISNOT90 IF EQUAL
.
          CALL      ADDNOT00           * Add Visit Based Notes
.
          MATCH     "001",NOTETYPE
          IF        @EQUAL
            MOVE      "CLNOT ",HISTTYPE
          ENDIF
.
          MATCH     "002",NOTETYPE
          IF        @EQUAL
            MOVE      "MGNOT ",HISTTYPE
          ENDIF
.
          MATCH     "007",NOTETYPE
          IF        @EQUAL
            MOVE      "DCNOT ",HISTTYPE
          ENDIF
.
          MATCH     "011",NOTETYPE
          IF        @EQUAL
            MOVE      "DDNOT ",HISTTYPE
          ENDIF
.
          MATCH     "012",NOTETYPE
          IF        @EQUAL
            MOVE      "ADNOT ",HISTTYPE
          ENDIF
.
          MATCH     "014",NOTETYPE
          IF        @EQUAL
            MOVE      "DTDRF",HISTTYPE    * Discharge Text Draft (history file)
          ENDIF
.
          MATCH     "015",NOTETYPE        * Adding Final Discharge Text?
          IF        @EQUAL
            MOVE      USERID,SAVEUSER     * Save our User ID
            MOVE      "014",NOTETYPE
            MOVE      VSMTNOTE,NOTENUMB
            MOVE      NOTEUSER,USERID     * Use Note "014" User ID (Input By)
.
            CALL      DELNOT00            * Delete Draft Discharge Text ("014")
.
            MOVE      "DTFIN",HISTTYPE    * Discharge Text Final (history file)
            MOVE      SAVEUSER,USERID
          ENDIF
.
          MATCH     "016",NOTETYPE
          IF        @EQUAL
            MOVE      "APNOT",HISTTYPE    * Advice to Patient (history file)
          ENDIF
.
          CALL      WRTHIS00              * Write history file record
.
          MOVE      ZERO,EXIT
          GOTO      VISNOT99
.
.         ************ UPDATE FORMACTION **********
.
VISNOT20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VISNOT90
.
          COMPARE   FOUR,EMVISTAT
          GOTO      VISNOT90 IF EQUAL
.
          CALL      UPDNOT00              * Update Visit Note
          BRANCH    EXIT,VISNOT99
.
          MATCH     "001",NOTETYPE
          IF        @EQUAL
            MOVE      "CLNOT ",HISTTYPE
          ENDIF
.
          MATCH     "002",NOTETYPE
          IF        @EQUAL
            MOVE      "MGNOT ",HISTTYPE
          ENDIF
.
          MATCH     "011",NOTETYPE
          IF        @EQUAL
            MOVE      "DDNOT ",HISTTYPE
          ENDIF
.
          MATCH     "012",NOTETYPE
          IF        @EQUAL
            MOVE      "ADNOT ",HISTTYPE
          ENDIF
.
          MATCH     "014",NOTETYPE
          IF        @EQUAL
            MOVE      "DTDRF",HISTTYPE    * Discharge Text Draft (history file)
          ENDIF
.
          MATCH     "015",NOTETYPE
          IF        @EQUAL
            MOVE      "DTFIN",HISTTYPE    * Discharge Text Final (history file)
          ENDIF
.
          MATCH     "016",NOTETYPE
          IF        @EQUAL
            MOVE      "APNOT",HISTTYPE    * Advice to Patient (history file)
          ENDIF
.
          CALL      WRTHIS00              * Write history file record
.
          MOVE      ZERO,EXIT
          GOTO      VISNOT99
.
.         ************ DELETE FORMACTION **********
.
VISNOT30  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VISNOT90
.
          COMPARE   FOUR,EMVISTAT
          GOTO      VISNOT90 IF EQUAL
.
          CALL      DELNOT00              * Delete Management Note SubRoutine
          BRANCH    EXIT,VISNOT99
.
          MATCH     "001",NOTETYPE
          IF        @EQUAL
            MOVE      "CLNOT ",HISTTYPE
          ENDIF
.
          MATCH     "002",NOTETYPE
          IF        @EQUAL
            MOVE      "MGNOT ",HISTTYPE
          ENDIF
.
          MATCH     "011",NOTETYPE
          IF        @EQUAL
            MOVE      "DDNOT ",HISTTYPE
          ENDIF
.
          MATCH     "012",NOTETYPE
          IF        @EQUAL
            MOVE      "ADNOT ",HISTTYPE
          ENDIF
.
          MATCH     "014",NOTETYPE
          IF        @EQUAL
            MOVE      "DTDRF",HISTTYPE    * Discharge Text Draft (history file)
          ENDIF
.
          MATCH     "015",NOTETYPE
          IF        @EQUAL
            MOVE      "DTFIN",HISTTYPE    * Discharge Text Final (history file)
          ENDIF
.
          MATCH     "016",NOTETYPE
          IF        @EQUAL
            MOVE      "APNOT",HISTTYPE    * Advice to Patient (history file)
          ENDIF
.
          CALL      WRTHIS00              * Write history file record
.
          MOVE      ZERO,EXIT
          GOTO      VISNOT99
.
.         ************ DISPLAY FORMACTION **********
.
VISNOT40  PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      CLVNOT00     * Clear all the file variables
          ENDIF
.
          MOVE      ZERO,F3
          ADD       ONE,F3
          MOVE      F3,VSCMUNQ
          PACK      KEY6,VSCTM001,VSCMUNQ,SP70
.
          CALL      RDVSCTM1
          IF        OVRCD=1
            CALL      CLRVSC00              * Clear all the file variables
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMDCM1
          IF        OVRCD=1
            CALL      CLRDCM00              * Clear all the file variables
          ENDIF
.
          MOVE      "Visit Note Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VISNOT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      VISNOT99
.
VISNOT90  MOVE      "Invalid Patient Visit Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VISNOT99
.
VISNOT92  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VISNOT99
.
VISNOT93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VISNOT99
.
VISNOT94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VISNOT99
.
VISNOT99  RETURN
.
.-----------------------------------------------------------
. * Checks mandatory fields, Checks admissno :cannot be blank
.------------------------------------------------------------
CHKVIS00  RESET     ADMISSNO
          MATCH     SP70,ADMISSNO
          GOTO      CHKVIS90 IF EQUAL
          GOTO      CHKVIS98
.
CHKVIS90  MOVE      "Visit Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKVIS99
.
CHKVIS98  MOVE      ZERO,EXIT
.
CHKVIS99  RETURN
.
.-----------------------------------------------------------
. Delete a Visit Note for a Patient
.-----------------------------------------------------------
DELNOT00  MATCH     SP70,ADMISSNO
          GOTO      DELNOT90 IF EQUAL
.
          MOVE      ADMISSNO,VSMDVISN   *  Visit Number
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,DELNOT99
.
          MATCH     "1",SUPRFLAG
          IF        !@EQUAL
            MATCH     SP70,VSMDUSER
            IF        !@EQUAL
              MATCH     USERID,VSMDUSER
              GOTO      DELNOT91 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      VSMDDDAT,CCC,CYY,CMM,CDD  
          REP       " 0",VSMDDDAT
          CLOCK     TIME,VSMDDTIM
          MOVE      USERID,VSMDDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELNOT99
.
          MOVE      WBSEOCG,VSMDDOCC         
.
          MOVE      "1",VSMDDELT           * Delete Indicator
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      UPVSMDT1               * Write Record
          GOTO      DELNOT98
.
DELNOT90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELNOT99
.
DELNOT91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELNOT99
.
DELNOT98  MOVE      ZERO,EXIT
.
DELNOT99  RETURN
.
.-----------------------------------------------------------
. Delete Encounter Note for a Patient
.-----------------------------------------------------------
DELENC00  MATCH     SP70,ADMISSNO
          GOTO      DELENC90 IF EQUAL
.
          MATCH     SP70,ENCOUNTN
          GOTO      DELENC92 IF EQUAL
.
          MOVE      ADMISSNO,ALMDVISN   *  Visit Number
          MOVE      ENCOUNTN,ALMDENCN   *  Encounter Number
.
          PACK      KEY25,ADMISSNO,ENCOUNTN,NOTETYPE,NOTENUMB,SP70
          CALL      RDALMDT1
          BRANCH    OVRCD,DELENC99
.
          MATCH     "1",SUPRFLAG
          IF          !@EQUAL
            MATCH     USERID,ALMDUSER
            GOTO      DELENC91 IF NOT EQUAL
          ENDIF
.
          PACK      ALMDDDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALMDDDAT
          CLOCK     TIME,ALMDDTIM
          MOVE      USERID,ALMDDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELENC99
.
          MOVE      WBSEOCG,ALMDDOCC
.
          MOVE      "1",ALMDDELT           * Delete Indicator
          PACK      KEY25,ADMISSNO,ENCOUNTN,NOTETYPE,NOTENUMB,SP70
          CALL      UPALMDT1               * Write Record
          GOTO      DELENC98
.
DELENC90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELENC99
.
DELENC91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELENC99
.
DELENC92  MOVE      "Encounter Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELENC99
.
DELENC98  MOVE      ZERO,EXIT
.
DELENC99  RETURN
.
.------------------------------------------------------------
.  Writing the visit Notes
.------------------------------------------------------------
ADDNOT00  MOVE      ZERO,F6
.
          PACK      KEY17,ADMISSNO,NOTETYPE,Z70
          CALL      RSVSMDT1
          CALL      RPVSMDT1                * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,VSMDNOTE           * Note Number
          ELSE
            MATCH     ADMISSNO,VSMDVISN     * Same visit
            IF        @EQUAL
              MATCH     NOTETYPE,VSMDTYPE   * Same note type
              IF        @EQUAL
                MOVE      VSMDNOTE,F6
                ADD       ONE,F6
                MOVE      F6,VSMDNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,VSMDNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,VSMDNOTE         * Note Number
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,VSMDVISN       * Visit number
          MOVE      NOTETYPE,VSMDTYPE       * Notes Type
.
          MOVE      SP70,VSMDDATE
          MOVE      SP70,VSMDTIME
          MOVE      SP70,VSMDUSER
          MOVE      SP70,VSMDOCCG
.
          MATCH     SP70,SUBFINAL
          IF        @EQUAL
            PACK      VSMDDATE,CCC,CYY,CMM,CDD
            REP       " 0",VSMDDATE          * Date
            CLOCK     TIME,VSMDTIME
            MOVE      USERID,VSMDUSER        * User
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,ADDNOT99
            MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          ELSE
            MATCH     "1",SUBFINAL
            IF        @EQUAL
              PACK      VSMDDATE,CCC,CYY,CMM,CDD
              REP       " 0",VSMDDATE          * Date
              CLOCK     TIME,VSMDTIME
              MOVE      USERID,VSMDUSER        * User
              PACK      KEY10,USERID,SP70
              CALL      RDWBSE1
              BRANCH    OVRCD,ADDNOT99
              MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
            ENDIF
          ENDIF
.
          MOVE      "0",VSMDDELT            * Delete Indicator
          MOVE      SP70,VSMDDDAT           * Delete Date
          MOVE      SP70,VSMDDTIM           * Delete Time
          MOVE      SP70,VSMDDUSE           * Delete User
          MOVE      SP70,VSMDDOCC           * Delete User Occupation group
          PACK      PMMDSPAR,SP70,SP70      * Spare
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RDVSMDT1
          IF        OVRCD=1
            CALL      WRVSMDT1              * Write Record
          ELSE
            GOTO      ADDNOT99
          ENDIF
.
.         now write the visit notes
.
          MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
ADDNOT90  ADD       ONE,F3
          MOVE      F3,VSMTUNIQ
.
          READ      COMFILVF,SEQ;VSMTCMNT
          GOTO      ADDNOT99 IF OVER
.
          MATCH     SP70,VSMTCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADDNOT90
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDNOT70                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADDNOT90          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDNOT70
          ENDIF
.
          MOVE      ZERO,BLNKFLAG
.
          SCAN      "%diag",VSMTCMNT
          IF        @EQUAL
            MATCH     "1",SUBFINAL
            IF        @EQUAL            
              CALL      EMRDIA00
              GOTO      ADDNOT90
            ENDIF
          ENDIF
.
ADDNOT70  PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
          IF        F3>=LASTITEM
            GOTO     ADDNOT99
          ENDIF
          GOTO      ADDNOT90
.
ADDNOT99  RETURN
.
.--------------------------------------------------------------------------
. Get Emergency Diagnosis Record from emrdcmaf
.--------------------------------------------------------------------------
EMRDIA00  SUB       ONE,F3
          MOVE      F3,VSMTUNIQ
.
          LENSET    VSMTCMNT
          RESET     VSMTCMNT
          REP       "% ",VSMTCMNT
          PACK      VSMTCMNT,VSMTCMNT,SP70,SP70
.
          PACK      DIM100,SP70,SP70
.
          MATCH     DIM100,VSMTCMNT
          IF        !@EQUAL
            ADD       ONE,F3
            MOVE      F3,VSMTUNIQ
            ADD       ONE,LASTITEM
.
            PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
            CALL      WRVSMTX1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMDCM1
          BRANCH    OVRCD,EMRDIA99
.
          MOVE      ZERO,FORM1
.
EMRDIA10  ADD       ONE,FORM1
          MOVE      SP70,DIM50
.
          BRANCH    FORM1,EMRDIA15,EMRDIA20,EMRDIA25,EMRDIA30,EMRDIA35:
                          EMRDIA40,EMRDIA45,EMRDIA50,EMRDIA55
.
          GOTO      EMRDIA99
.
EMRDIA15  MOVE      EMDCTXT1,DIM50
          GOTO      EMRDIA80
.
EMRDIA20  MOVE      EMDCTXT2,DIM50
          GOTO      EMRDIA80
.
EMRDIA25  MOVE      EMDCTXT3,DIM50
          GOTO      EMRDIA80
.
EMRDIA30  MOVE      EMDCTXT4,DIM50
          GOTO      EMRDIA80
.
EMRDIA35  MOVE      EMDCTXT5,DIM50
          GOTO      EMRDIA80
.
EMRDIA40  MOVE      EMDCTXT6,DIM50
          GOTO      EMRDIA80
.
EMRDIA45  MOVE      EMDCTXT7,DIM50
          GOTO      EMRDIA80
.
EMRDIA50  MOVE      EMDCTXT8,DIM50
          GOTO      EMRDIA80
.
EMRDIA55  MOVE      EMDCTXT9,DIM50
          GOTO      EMRDIA80
.
EMRDIA80  MATCH     SP70,DIM50
          IF        !@EQUAL
            ADD       ONE,F3
            MOVE      F3,VSMTUNIQ            
            ADD       ONE,LASTITEM
.
            PACK      VSMTCMNT,DIM50,SP70,SP70
.
            PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
            CALL      WRVSMTX1  
          ENDIF
          GOTO      EMRDIA10
.
EMRDIA99  RETURN
.
.------------------------------------------------------------
.  Writing the encounter Notes
.------------------------------------------------------------
ADDENC00  MOVE      ZERO,F6
.
          PACK      KEY25,ADMISSNO,ENCOUNTN,NOTETYPE,Z70
          CALL      RSALMDT1
          CALL      RPALMDT1                * read back to get last record
          BRANCH    OVRCD,ADDENC40
.
          MATCH     ADMISSNO,ALMDVISN       * Same visit
          GOTO      ADDENC40 IF NOT EQUAL
.
          MATCH     ENCOUNTN,ALMDENCN       * Same encounter
          GOTO      ADDENC40 IF NOT EQUAL
.
          MATCH     NOTETYPE,ALMDTYPE       * Same note type
          GOTO      ADDENC40 IF NOT EQUAL
.
          MOVE      ALMDNOTE,F6
          ADD       ONE,F6
          MOVE      F6,ALMDNOTE             * Note Number
          GOTO      ADDENC50
.
ADDENC40  MOVE      ONE,F6
          MOVE      F6,ALMDNOTE             * Note Number
.
ADDENC50  MOVE      ADMISSNO,ALMDVISN       * Visit number
          MOVE      ENCOUNTN,ALMDENCN       * Encounter number
          MOVE      NOTETYPE,ALMDTYPE       * Notes Type
.
          PACK      ALMDDATE,CCC,CYY,CMM,CDD
          REP       " 0",ALMDDATE           * Date
          CLOCK     TIME,ALMDTIME
          MOVE      USERID,ALMDUSER         * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADDENC99
.
          MOVE      WBSEOCG,ALMDOCCG        * Occupation Group
          MOVE      "0",ALMDDELT            * Delete Indicator
          MOVE      SP70,ALMDDDAT           * Delete Date
          MOVE      SP70,ALMDDTIM           * Delete Time
          MOVE      SP70,ALMDDUSE           * Delete User
          MOVE      SP70,ALMDDOCC           * Delete User Occupation group
          PACK      ALMDSPAR,SP70,SP70      * Spare
.
          PACK      KEY25,ALMDVISN,ALMDENCN,ALMDTYPE,ALMDNOTE,SP70
          CALL      RDALMDT1
          IF        OVRCD=1
            CALL      WRALMDT1              * Write Record
          ELSE
            GOTO      ADDENC99
          ENDIF
.
.         now write the visit notes
.
          MOVE      ALMDVISN,ALMTVISN
          MOVE      ALMDENCN,ALMTENCN
          MOVE      ALMDTYPE,ALMTTYPE
          MOVE      ALMDNOTE,ALMTNOTE
          PACK      ALMTSPAR,SP70,SP70      * Spare
          MOVE      ZERO,F3
.
ADDENC90  ADD       ONE,F3
          MOVE      F3,ALMTUNIQ
.
          READ      COMFILVF,SEQ;ALMTCMNT
.
          PACK      KEY28,ALMTVISN,ALMTENCN,ALMTTYPE,ALMTNOTE,ALMTUNIQ,SP70
          CALL      WRALMTX1
          IF        F3>=LASTITEM
            GOTO     ADDENC99
          ENDIF
          GOTO      ADDENC90
.
ADDENC99  RETURN
.
.-----------------------------------------------------------
.         Clears the visit notes file variables
.-----------------------------------------------------------
CLVNOT00  MOVE      SP70,VSMDVISN      * Visit Number
          MOVE      SP70,VSMDTYPE      * Comment Type
          MOVE      SP70,VSMDNOTE      * Note Number
          MOVE      SP70,VSMDDATE      * Input Date (CCYYMMDD)
          MOVE      SP70,VSMDTIME      * Input Time (HH:MM:SS)
          MOVE      SP70,VSMDUSER      * Input by WEB User ID (websecaf)
          MOVE      SP70,VSMDOCCG      * Occupational Group WEB User ID
          MOVE      SP70,VSMDDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,VSMDDDAT      * Delete Date (CCYYMMDD)
          MOVE      SP70,VSMDDTIM      * Delete Time (HH:MM:SS)
          MOVE      SP70,VSMDDUSE      * Delete by WEB User ID (websecaf)
          MOVE      SP70,VSMDDOCC      * Occupational Group WEB User ID Dele
          MOVE      SP70,VSMDSPAR      * Spare Variable
.
          MOVE      SP70,VSMTVISN      * Visit Number
          MOVE      SP70,VSMTTYPE      * Comment Type
          MOVE      SP70,VSMTNOTE      * Note Number
          MOVE      SP70,VSMTUNIQ      * Line Number
          MOVE      SP70,VSMTCMNT      * Comment
          MOVE      SP70,VSMTSPAR      * Spare Variable
.
CLVNOT99  RETURN
.
.-----------------------------------------------------------
.         Clears the encounter notes file variables
.-----------------------------------------------------------
CLENOT00  MOVE      SP70,ALMDVISN      * Visit Number
          MOVE      SP70,ALMDENCN      * Encounter Number
          MOVE      SP70,ALMDTYPE      * Comment Type
          MOVE      SP70,ALMDNOTE      * Note Number
          MOVE      SP70,ALMDDATE      * Input Date (CCYYMMDD)
          MOVE      SP70,ALMDTIME      * Input Time (HH:MM:SS)
          MOVE      SP70,ALMDUSER      * Input by WEB User ID (websecaf)
          MOVE      SP70,ALMDOCCG      * Occupational Group WEB User ID
          MOVE      SP70,ALMDDELT      * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,ALMDDDAT      * Delete Date (CCYYMMDD)
          MOVE      SP70,ALMDDTIM      * Delete Time (HH:MM:SS)
          MOVE      SP70,ALMDDUSE      * Delete by WEB User ID (websecaf)
          MOVE      SP70,ALMDDOCC      * Occupational Group WEB User ID Dele
          MOVE      SP70,ALMDSPAR      * Spare Variable
.
          MOVE      SP70,ALMTVISN      * Visit Number
          MOVE      SP70,ALMTENCN      * Encounter Number
          MOVE      SP70,ALMTTYPE      * Comment Type
          MOVE      SP70,ALMTNOTE      * Note Number
          MOVE      SP70,ALMTUNIQ      * Line Number
          MOVE      SP70,ALMTCMNT      * Comment
          MOVE      SP70,ALMTSPAR      * Spare Variable
.
CLENOT99  RETURN
.
.------------------------------------------------------------
. Get visit Comments
.------------------------------------------------------------
GETNOT00  PREP      COMFILVF,COMFILNV
          MOVE      ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
.
GETNOT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETNOT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETNOT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
          GOTO      GETNOT10
.
GETNOT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETNOT90  MOVE      F3,LASTITEM
          OPEN      COMFILVF,COMFILNV
GETNOT99  RETURN
.
.-----------------------------------------------------------------
. GTVSCM00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTVSCM00  PREP      COMVISAF,COMVISNM
          GOTO      GTVSCM20
.
GTVSCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVSCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVSCM80 IF NOT EQUAL
.
GTVSCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVSCM10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   "99",VSCMTLIN
          GOTO      GTVSCM99 IF EQUAL
.
          GOTO      GTVSCM10
.
GTVSCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVSCM99  RETURN
.
.-----------------------------------------------------------------
. GTURCM00 - Get U/R Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTURCM00  PREP      COMURCAF,COMURCNM
          GOTO      GTURCM20
.
GTURCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTURCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTURCM80 IF NOT EQUAL
.
GTURCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTURCM10 IF EOS
.
          ADD       ONE,URCMTLIN
          WRITE     COMURCAF,SEQ;QRYDATA
          COMPARE   "99",URCMTLIN
          GOTO      GTURCM99 IF EQUAL
.
          GOTO      GTURCM10
.
GTURCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTURCM99  RETURN
.
.-----------------------------------------------------------------
. GTEXCM00 - Get Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTEXCM00  PREP      COMEXPAF,COMEXPNM
          GOTO      GTEXCM20
.
GTEXCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTEXCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTEXCM80 IF NOT EQUAL
.
GTEXCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTEXCM10 IF EOS
.
          ADD       ONE,EXPCMLIN
          WRITE     COMEXPAF,SEQ;QRYDATA
          COMPARE   "999",EXPCMLIN
          GOTO      GTEXCM99 IF EQUAL
.
          GOTO      GTEXCM10
.
GTEXCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTEXCM99  RETURN
.
.--------------------------------------------------------------------------
. Visit Note Maintenance
.--------------------------------------------------------------------------
VSMD0000  BRANCH    FLDITMNO,VSMD0100,VSMD0200,VSMD0300,VSMD0400,VSMD0500:
                             VSMD0600,VSMD0700,VSMD0800,VSMD0900,VSMD1000:
                             VSMD1100,VSMD1200,VSMD1300,VSMD1400,VSMD1500:
                             VSMD1600,VSMD1700,VSMD1800,VSMD1900,VSMD2000:
                             VSMD2100,VSMD2200,VSMD2300,VSMD2400,VSMD2500:
                             VSMD2600,VSMD2700,VSMD2800,VSMD2900
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      VSMD9999
.
VSMD0100  MATCH     SP70,VSMDTYPE
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTYPE;
          GOTO      VSMD9999
.
VSMD0200  MATCH     SP70,VSMDNOTE
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDNOTE;
          GOTO      VSMD9999
.
VSMD0300  MATCH     SP70,VSMDDATE
          GOTO      VSMD9999 IF EQUAL
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      VSMD9999
.
VSMD0400  MATCH     SP70,VSMDTIME
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTIME;
          GOTO      VSMD9999
.
VSMD0500  MATCH     SP70,VSMDUSER
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDUSER;
          GOTO      VSMD9999
.
VSMD0600  MATCH     SP70,VSMDOCCG
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDOCCG;
          GOTO      VSMD9999
.
VSMD0700  MATCH     SP70,VSMDDELT
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDDELT;
          GOTO      VSMD9999
.
VSMD0800  MATCH     SP70,VSMTCMNT
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMTCMNT;
          GOTO      VSMD9999
.
VSMD0900  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSMD0910  CALL      RKVSMTX1
          BRANCH    OVRCD,VSMD9999
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSMD9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSMD0910 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSMD0910 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO 
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF     
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      VSMD0910
.
VSMD1000  MOVE      ZERO,NOTEORDR
          CALL      NOTTAB00
          GOTO      VSMD9999
.
VSMD1100  MOVE      ONE,NOTEORDR
          CALL      NOTTAB00
          GOTO      VSMD9999
.
VSMD1200  MOVE      ONE,NOTEORDR
          CALL      DSPTAB00
          GOTO      VSMD9999
.
VSMD1300  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMDCM1
          BRANCH    OVRCD,VSMD9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      VSMD9999 
.
VSMD1400  WRITE     HTMLFILE;EMDCTXT1;
          GOTO      VSMD9999
.
VSMD1500  WRITE     HTMLFILE;EMDCTXT2;
          GOTO      VSMD9999
.
VSMD1600  WRITE     HTMLFILE;EMDCTXT3;
          GOTO      VSMD9999
.
VSMD1700  WRITE     HTMLFILE;EMDCTXT4;
          GOTO      VSMD9999
.
VSMD1800  WRITE     HTMLFILE;EMDCTXT5;
          GOTO      VSMD9999
.
VSMD1900  WRITE     HTMLFILE;EMDCTXT6;
          GOTO      VSMD9999
.
VSMD2000  WRITE     HTMLFILE;EMDCTXT7;
          GOTO      VSMD9999
.
VSMD2100  WRITE     HTMLFILE;EMDCTXT8;
          GOTO      VSMD9999
.
VSMD2200  WRITE     HTMLFILE;EMDCTXT9;
          GOTO      VSMD9999
.
VSMD2300  WRITE     HTMLFILE;WBSEGENR;
          GOTO      VSMD9999
.
VSMD2400  UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          PACK      KEY17,ADMISSNO,NOTEFILT,SP70
          CALL      RSVSMDT1
          CALL      RKVSMDT1
          BRANCH    OVRCD,VSMD2402
.
          MATCH     VSMDVISN,ADMISSNO
          GOTO      VSMD2402 IF NOT EQUAL
.
          MATCH     VSMDTYPE,NOTEFILT
          GOTO      VSMD2402 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT       * Deleted?
          GOTO      VSMD2402 IF EQUAL
.
VSMD2401  WRITE     HTMLFILE;ONE;      * Note Type exists for admission
          GOTO      VSMD9999
.
VSMD2402  WRITE     HTMLFILE;ZERO;     * Note Type does NOT exist for admission
          GOTO      VSMD9999
.
VSMD2500  UNPACK    DIM127,D1,NOTEFILT,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,NOTEORDR
          MOVE      KEY1,NOTEORDR
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,NOTEDETL
          MOVE      KEY1,NOTEDETL
.
          PROC      DISPVISN           * Display Visit Notes
          GOTO      VSMD9999
.
VSMD2600  CALL      VCMHTM00
          GOTO      VSMD9999
.
VSMD2700  MATCH     SP70,VSMDDDAT           * Delete Date (CCYYMMDD)
          GOTO      VSMD9999 IF EQUAL
          UNPACK    VSMDDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDATE;
          GOTO      VSMD9999
.
VSMD2800  MATCH     SP70,VSMDDTIM           * Delete Time (HH:MM:SS)
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDDTIM;
          GOTO      VSMD9999
.
VSMD2900  MATCH     SP70,VSMDDUSE           * Delete by WEB User ID
          GOTO      VSMD9999 IF EQUAL
          WRITE     HTMLFILE;VSMDDUSE;
          GOTO      VSMD9999
.
VSMD9999  RETURN
+
.--------------------------------------------------------------------------
. Visit Comments Tags
.--------------------------------------------------------------------------
VSCM0000  BRANCH    FLDITMNO,VSCM0100,VSCM0200,VSCM0300,VSCM0400,VSCM0500:
                             VSCM0600,VSCM0700,VSCM0800,VSCM0900,VSCM1000:
                             VSCM1100,VSCM1200,VSCM1300,VSCM1400,VSCM1500
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      VSCM9999
.
VSCM0100  MATCH     SP70,VSMDTYPE
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTYPE;
          GOTO      VSCM9999
.
VSCM0200  MATCH     SP70,VSMDNOTE
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDNOTE;
          GOTO      VSCM9999
.
VSCM0300  MATCH     SP70,VSMDDATE
          GOTO      VSCM9999 IF EQUAL
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      VSCM9999
.
VSCM0400  MATCH     SP70,VSMDTIME
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDTIME;
          GOTO      VSCM9999
.
VSCM0500  MATCH     SP70,VSMDUSER
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDUSER;
          GOTO      VSCM9999
.
VSCM0600  MATCH     SP70,VSMDOCCG
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDOCCG;
          GOTO      VSCM9999
.
VSCM0700  MATCH     SP70,VSMDDELT
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMDDELT;
          GOTO      VSCM9999
.
VSCM0800  MATCH     SP70,VSMTCMNT
          GOTO      VSCM9999 IF EQUAL
          WRITE     HTMLFILE;VSMTCMNT;
          GOTO      VSCM9999
.
VSCM0900  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSCM0910  CALL      RKVSMTX1
          BRANCH    OVRCD,VSCM9999
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCM9999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCM0910 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCM0910 IF NOT EQUAL
.
          STRIP     VSMTCMNT
          MOVELPTR  VSMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      VSMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,100
.
          GOTO      VSCM0910
.
VSCM1000  MOVE      ZERO,NOTEORDR
          CALL      VCMTAB00
          GOTO      VSCM9999
.
VSCM1100  CALL      VCMIND00
          GOTO      VSCM9999 
.
VSCM1200  CALL      VCMUPD00
          GOTO      VSCM9999 
.
VSCM1300  WRITE     HTMLFILE;SHOWCOMM;
          GOTO      VSCM9999 
.
VSCM1400  MOVE      ONE,NOTEORDR
          CALL      VCMTAB00
          GOTO      VSCM9999
.
VSCM1500  MATCH     VSMDUSER,USERID               * Check same USERID
          IF        @EQUAL
            WRITE     HTMLFILE;"1";
          ELSE
            WRITE     HTMLFILE;"0";
          ENDIF
          GOTO      VSCM9999
.
VSCM9999  RETURN
+
.--------------------------------------------------------------------------
. Return an indicator to indicate whether the active/delete visit comments
. exists
.--------------------------------------------------------------------------
VCMIND00  MOVE      "0",EXISTFLG
          UNPACK    DIM127,D1,VSMDTYPE,DIM127
          UNPACK    DIM127,D1,COMMTYPE,DIM127
.
          MOVE      ADMISSNO,VSMDVISN
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,SP70
          PACK      KEY11,VSMDVISN,VSMDTYPE,SP70
          CALL      RSVSMDT1
VCMIND20  CALL      RKVSMDT1
          BRANCH    OVRCD,VCMIND99
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,SP70
          MATCH     KEY11,KEY17
          GOTO      VCMIND80 IF NOT EQUAL
.
          MATCH     "D",COMMTYPE
          GOTO      VCMIND40 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT             * Deleted comments
          GOTO      VCMIND20 IF NOT EQUAL
.
          MOVE      "1",EXISTFLG
          GOTO      VCMIND80
.
VCMIND40  MATCH     "0",VSMDDELT             * Active comments
          GOTO      VCMIND20 IF NOT EQUAL
.
          MOVE      "1",EXISTFLG
          GOTO      VCMIND80
.
VCMIND80  WRITE     HTMLFILE;EXISTFLG;
          GOTO      VCMIND99
.
VCMIND99  RETURN
.
.--------------------------------------------------------------------------
. Return an indicator to indicate whether the visit comments can be updated
.--------------------------------------------------------------------------
VCMUPD00  MOVE      "0",COMUPFLG
.
          MATCH     VSMDUSER,USERID               * Check same USERID
          GOTO      VCMUPD80 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          MATCH     VSMDDATE,CURRDATE             * if date > curr date
          GOTO      VCMUPD80 IF LESS
.
VCMUPD20  IF        @EQUAL
            MATCH     VSMDTIME,CURRTIME           * if time > curr time
            GOTO      VCMUPD80 IF LESS            * when same date
          ENDIF
.
          MOVE      VSMDDATE,FIRSTDAT
          UNPACK    VSMDTIME,HOUR,D1,MIN,D1,SEC
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MOVE      CURRDATE,LASTDATE
          UNPACK    CURRTIME,HOUR,D1,MIN,D1,SEC
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTDATE
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF                     * second is not included
          IF        CALCTIME < 61
            MOVE      "1",COMUPFLG
          ENDIF
.
VCMUPD80  WRITE     HTMLFILE;COMUPFLG;
          GOTO      VCMUPD99
.
VCMUPD99  RETURN
.
.--------------------------------------------------------------------------
. U/R Comments Tags
.--------------------------------------------------------------------------
URCM0000  BRANCH    FLDITMNO,URCM0100,URCM0200,URCM0300,URCM0400,URCM0500:
                             URCM0600,URCM0700,URCM0800,URCM0900,URCM1000:
                             URCM1100,URCM1200,URCM1300,URCM1400,URCM1500
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      URCM9999
.
URCM0100  MATCH     SP70,PMUHCTYP
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHCTYP;
          GOTO      URCM9999
.
URCM0200  MATCH     SP70,PMUHCNUM
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHCNUM;
          GOTO      URCM9999
.
URCM0300  MATCH     SP70,PMUHCDAT
          GOTO      URCM9999 IF EQUAL
          UNPACK    PMUHCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      URCM9999
.
URCM0400  MATCH     SP70,PMUHCTIM
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHCTIM;
          GOTO      URCM9999
.
URCM0500  MATCH     SP70,PMUHCUID
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHCUID;
          GOTO      URCM9999
.
URCM0600  MATCH     SP70,PMUHOCCG
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHOCCG;
          GOTO      URCM9999
.
URCM0700  MATCH     SP70,PMUHDELT
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUHDELT;
          GOTO      URCM9999
.
URCM0800  MATCH     SP70,PMUCCOMM
          GOTO      URCM9999 IF EQUAL
          WRITE     HTMLFILE;PMUCCOMM;
          GOTO      URCM9999
.
URCM0900  PACK      KEY20,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RSPMUCD1
URCM0910  CALL      RKPMUCD1
          BRANCH    OVRCD,URCM9999
.
          MATCH     PMUHURNO,PMUCURNO
          GOTO      URCM9999 IF NOT EQUAL
.
          MATCH     PMUHCTYP,PMUCCTTY
          GOTO      URCM0910 IF NOT EQUAL
.
          MATCH     PMUHCNUM,PMUCCNUM
          GOTO      URCM0910 IF NOT EQUAL
.
          STRIP     PMUCCOMM
          MOVELPTR  PMUCCOMM,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      PMUCCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,100
.
          GOTO      URCM0910
.
URCM1000  MOVE      ZERO,NOTEORDR
          CALL      UCMTAB00
          GOTO      URCM9999
.
URCM1100  CALL      UCMIND00
          GOTO      URCM9999
.
URCM1200  CALL      UCMUPD00
          GOTO      URCM9999
.
URCM1300  WRITE     HTMLFILE;SHOWCOMM;
          GOTO      URCM9999
.
URCM1400  MOVE      ONE,NOTEORDR
          CALL      UCMTAB00
          GOTO      URCM9999
.
URCM1500  MATCH     PMUHCUID,USERID               * Check same USERID
          IF        @EQUAL
            WRITE     HTMLFILE;"1";
          ELSE
            WRITE     HTMLFILE;"0";
          ENDIF
          GOTO      URCM9999
.
URCM9999  RETURN
.
.---------------------------------------------------------------------
. Display Table of UR Comments
.---------------------------------------------------------------------
UCMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          IF        NOTEORDR = 0
            PACK      KEY17,URNUMBER,NOTEFILT,Z70
          ELSE
            PACK      KEY17,URNUMBER,NOTEFILT,SP70
          ENDIF
.
          CALL      RSPMUCH1
UCMTAB10  IF        NOTEORDR = 0
            CALL      RPPMUCH1
          ELSE
            CALL      RKPMUCH1
          ENDIF
          BRANCH    OVRCD,UCMTAB99
.
          MATCH     URNUMBER,PMUHURNO
          GOTO      UCMTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,PMUHCTYP
          GOTO      UCMTAB99 IF NOT EQUAL
.
          MATCH     "D",SHOWCOMM
          IF        @EQUAL
            MATCH     "0",PMUHDELT
            GOTO      UCMTAB10 IF EQUAL
          ELSE
            MATCH     "1",PMUHDELT
            GOTO      UCMTAB10 IF EQUAL
          ENDIF
.
          MATCH     PMUHCDAT,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     UCMTAB40
          ENDIF
.
          UNPACK    PMUHCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
UCMTAB40  MATCH     "1",PMUHDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",PMUHCTYP
          REP       " +",PMUHCNUM
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&notetype=",PMUHCTYP:
                             "&notenumb=",PMUHCNUM,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,PMUHCTIM,"</td>";
.
          PACK      KEY10,PMUHCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",PMUHOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,PMUHCUID," - ",PMUHOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",PMUHCTYP
          REP       "+ ",PMUHCNUM
.
          MOVE      ZERO,CTR
          CALL      URCMXA00
.
          MATCH     "1",PMUHDELT
          IF        @EQUAL
            PACK      KEY10,PMUHDUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                                 "<td>",WBSENAM," - ",PMUHDOCG,"&nbsp;":
                                 "</td>":
                                 "</tr>"
            ELSE
              WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                                 "<td>",PMUHDUID," - ",PMUHDOCG,"&nbsp;":
                                 "</td>":
                                 "</tr>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"&nbsp;</td><td>&nbsp;</td></tr>"
          ENDIF
.
          GOTO      UCMTAB10
.
UCMTAB99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
URCMXA00  PACK      KEY20,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RSPMUCD1
URCMXA20  CALL      RKPMUCD1
          BRANCH    OVRCD,URCMXA99
.
          MATCH     PMUHURNO,PMUCURNO
          GOTO      URCMXA99 IF NOT EQUAL
.
          MATCH     PMUHCTYP,PMUCCTTY
          GOTO      URCMXA99 IF NOT EQUAL
.
          MATCH     PMUHCNUM,PMUCCNUM
          GOTO      URCMXA99 IF NOT EQUAL
.
          COMPARE   THREE,CTR
          GOTO      URCMXA99 IF EQUAL
          ADD       ONE,CTR
          IF        CTR=3
            WRITE     HTMLFILE;PMUCCOMM;
          ELSE
            WRITE     HTMLFILE;PMUCCOMM,"</br>";
          ENDIF
.
          GOTO      URCMXA20
.
URCMXA99  RETURN
.
.--------------------------------------------------------------------------
. Return an indicator to indicate whether the active/delete UR comments
. exists
.--------------------------------------------------------------------------
UCMIND00  MOVE      "0",EXISTFLG
          UNPACK    DIM127,D1,PMUHCTYP,DIM127
          UNPACK    DIM127,D1,COMMTYPE,DIM127
.
          MOVE      URNUMBER,PMUHURNO
.
          PACK      KEY17,PMUHURNO,PMUHCTYP,SP70
          PACK      KEY11,PMUHURNO,PMUHCTYP,SP70
          CALL      RSPMUCH1
UCMIND20  CALL      RKPMUCH1
          BRANCH    OVRCD,UCMIND99
.
          PACK      KEY17,PMUHURNO,PMUHCTYP,SP70
          MATCH     KEY11,KEY17
          GOTO      UCMIND80 IF NOT EQUAL
.
          MATCH     "D",COMMTYPE
          GOTO      UCMIND40 IF NOT EQUAL
.
          MATCH     "1",PMUHDELT             * Deleted comments
          GOTO      UCMIND20 IF NOT EQUAL
.
          MOVE      "1",EXISTFLG
          GOTO      UCMIND80
.
UCMIND40  MATCH     "0",PMUHDELT             * Active comments
          GOTO      UCMIND20 IF NOT EQUAL
.
          MOVE      "1",EXISTFLG
          GOTO      UCMIND80
.
UCMIND80  WRITE     HTMLFILE;EXISTFLG;
          GOTO      UCMIND99
.
UCMIND99  RETURN
.
.--------------------------------------------------------------------------
. Return an indicator to indicate whether the UR comments can be updated
.--------------------------------------------------------------------------
UCMUPD00  MOVE      "0",COMUPFLG
.
          MATCH     PMUHCUID,USERID               * Check same USERID
          GOTO      UCMUPD80 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
          MATCH     PMUHCDAT,CURRDATE             * if date > curr date
          GOTO      UCMUPD80 IF LESS
.
UCMUPD20  IF        @EQUAL
            MATCH     PMUHCTIM,CURRTIME           * if time > curr time
            GOTO      UCMUPD80 IF LESS            * when same date
          ENDIF
.
          MOVE      PMUHCDAT,FIRSTDAT
          UNPACK    PMUHCTIM,HOUR,D1,MIN,D1,SEC
          PACK      FIRSTIME,HOUR,MIN
          REP       " 0",FIRSTDAT
          REP       " 0",FIRSTIME
.
          MOVE      CURRDATE,LASTDATE
          UNPACK    CURRTIME,HOUR,D1,MIN,D1,SEC
          PACK      LASTTIME,HOUR,MIN
          REP       " 0",LASTDATE
          REP       " 0",LASTTIME
.
          CALL      TIMEDIFF                     * second is not included
          IF        CALCTIME < 61
            MOVE      "1",COMUPFLG
          ENDIF
.
UCMUPD80  WRITE     HTMLFILE;COMUPFLG;
          GOTO      UCMUPD99
.
UCMUPD99  RETURN
.
.---------------------------------------------------------------------
. Display Table of expected patient Comments
.---------------------------------------------------------------------
ECMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          PACK      KEY19,EXPTUNIQ,NOTEFILT,Z70
          CALL      RSEMECH1
ECMTAB10  CALL      RPEMECH1
          BRANCH    OVRCD,ECMTAB99
.
          MATCH     EXPTUNIQ,EMEHUNIQ
          GOTO      ECMTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,EMEHTYPE
          GOTO      ECMTAB99 IF NOT EQUAL
.
          MATCH     EMEHCDAT,SP70
          IF        @EQUAL
            MOVE     "",FBOKDATE
            GOTO     ECMTAB40
          ENDIF
.
          UNPACK    EMEHCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
ECMTAB40  MATCH     "1",EMEHDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",EXPTUNIQ
          REP       " +",EMEHTYPE
          REP       " +",EMEHNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:":
                             "DeleteExpectPatComment":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&exptuniq=",EXPTUNIQ:
                             "&notetype=",EMEHTYPE:
                             "&notenumb=",EMEHNOTE:
                             "&deltflag=",EMEHDELT,"#")'>":
                             "<img src='../images/MaintenanceIcon.gif' ":
                             "class=Icon></a>":
                             STRIKETG,FBOKDATE,SP1,EMEHCTIM,"</td>";
.
          PACK      KEY10,EMEHCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",EMEHOCCG:
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,EMEHCUID," - ",EMEHOCCG:
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",EXPTUNIQ
          REP       "+ ",EMEHTYPE
          REP       "+ ",EMEHNOTE
.
          MOVE      ZERO,CTR
          CALL      EXCMXA00
.
          MATCH     "1",EMEHDELT
          IF        @EQUAL
            PACK      KEY10,EMEHDUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              WRITE     HTMLFILE;STRENDTG,"</td>":
                                 "<td>",WBSENAM," - ",EMEHDOCC:
                                 "</td>":
                                 "</tr>"
            ELSE
              WRITE     HTMLFILE;STRENDTG,"</td>":
                                 "<td>",EMEHDUID," - ",EMEHDOCC:
                                 "</td>":
                                 "</tr>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"</td><td></td></tr>"
          ENDIF
.
          GOTO      ECMTAB10
.
ECMTAB99  RETURN
.
.---------------------------------------------------------------------
. Retrieve comment text details
.---------------------------------------------------------------------
EXCMXA00  PACK      KEY22,EMEHUNIQ,EMEHTYPE,EMEHNOTE,SP70
          CALL      RSEMECL1
EXCMXA20  CALL      RKEMECL1
          BRANCH    OVRCD,EXCMXA99
.
          MATCH     EMEHUNIQ,EMELUNIQ
          GOTO      EXCMXA99 IF NOT EQUAL
.
          MATCH     EMEHTYPE,EMELTYPE
          GOTO      EXCMXA99 IF NOT EQUAL
.
          MATCH     EMEHNOTE,EMELNOTE
          GOTO      EXCMXA99 IF NOT EQUAL
.
          COMPARE   THREE,CTR
          GOTO      EXCMXA99 IF EQUAL
          ADD       ONE,CTR
          IF        CTR=3
            WRITE     HTMLFILE;EMELCMNT;
          ELSE
            WRITE     HTMLFILE;EMELCMNT,"</br>";
          ENDIF
.
          GOTO      EXCMXA20
.
EXCMXA99  RETURN
.
.--------------------------------------------------------------------------
. Patient attribute Tags
.--------------------------------------------------------------------------
PATR0000  BRANCH    FLDITMNO,PATR0100
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PATR9999
.
PATR0100  CALL      PATRLS00
          GOTO      PATR9999
.
PATR9999  RETURN
.
.--------------------------------------------------------------------------
. Patient attribute locking list 
.--------------------------------------------------------------------------
PATRLS00  CALL      PATRHD00
. 
          MOVE      "109",KEY3  
          PACK      KEY35,URNUMBER,ADMISSNO,KEY3,SP70
          CALL      RSPTATR3
PATRLS20  CALL      RKPTATR3
          BRANCH    OVRCD,PATRLS99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATRLS99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      PATRLS99 IF NOT EQUAL
.
          MATCH     KEY3,PTARTYPE
          GOTO      PATRLS99 IF NOT EQUAL
.
          PACK      KEY10,PTARCUSR
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      KEY10,WBSENAM
          ENDIF
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CYEAR
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     HTMLLINK
          APPEND    "<input type=button class=button ",HTMLLINK
          APPEND    "value='Clear' ",HTMLLINK
          APPEND    "onclick=#"DeletePatAttr('",HTMLLINK
          APPEND    PTARURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARTYPE,HTMLLINK
          APPEND    "')#">",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"<tr><td>":
                             DISPDATE," at ",PTARTIME,"</td><td>":
                             "Nursing Diagnosis Clinical Notes","</td><td>":
                             WBSENAM,"</td><td>":
                             HTMLLINK,"</td></tr>"
.    
          GOTO      PATRLS20 
.
PATRLS99  RETURN
.
.------------------------------------------------------------
. Patient attribute locking header
.------------------------------------------------------------
PATRHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Date & Time":
                             "</td>":
                             "<td class=HeadingCell width=30%>Description":
                             "</td>":
                             "<td class=HeadingCell width=30%>Locking User":
                             "</td>":
                             "<td class=HeadingCell width=20%>":
                             "Clear Lock</td>";
.
          WRITE     HTMLFILE;"</tr>"
.
PATRHD99  RETURN
.
.--------------------------------------------------------------------------
. Patient attribute Tags
.--------------------------------------------------------------------------
EXPT0000  BRANCH    FLDITMNO,EXPT0100,EXPT0200,EXPT0300,EXPT0400,EXPT0500:
                             EXPT0600,EXPT0700,EXPT0800,EXPT0900,EXPT1000:
                             EXPT1100
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      EXPT9999
.
EXPT0100  WRITE     HTMLFILE;EXPTUNIQ; 
          GOTO      EXPT9999
.
EXPT0200  CALL      ECMTAB00
          GOTO      EXPT9999 
.
EXPT0300  WRITE     HTMLFILE;NOTETYPE;
          GOTO      EXPT9999
.
EXPT0400  WRITE     HTMLFILE;NOTENUMB;
          GOTO      EXPT9999
.
EXPT0500  WRITE     HTMLFILE;DELTFLAG;
          GOTO      EXPT9999
.
EXPT0600  PACK      KEY19,EXPTUNIQ,NOTETYPE,NOTENUMB,SP70
          CALL      RDEMECH1
          BRANCH    OVRCD,EXPT9999
.
          MATCH     SP70,EMEHCDAT
          GOTO      MISC9999 IF EQUAL
          UNPACK    EMEHCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXPT9999
.
EXPT0700  PACK      KEY19,EXPTUNIQ,NOTETYPE,NOTENUMB,SP70
          CALL      RDEMECH1
          BRANCH    OVRCD,EXPT9999
.
          WRITE     HTMLFILE;EMEHCTIM;
          GOTO      EXPT9999
.
EXPT0800  PACK      KEY22,EXPTUNIQ,NOTETYPE,NOTENUMB,SP70
          CALL      RSEMECL1
EXPT0810  CALL      RKEMECL1
          BRANCH    OVRCD,EXPT9999
.
          MATCH     EXPTUNIQ,EMELUNIQ
          GOTO      EXPT9999 IF NOT EQUAL
.
          MATCH     NOTETYPE,EMELTYPE
          GOTO      EXPT0810 IF NOT EQUAL
.
          MATCH     NOTENUMB,EMELNOTE
          GOTO      EXPT0810 IF NOT EQUAL
.
          STRIP     EMELCMNT
          MOVELPTR  EMELCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      EMELCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,100
.
          GOTO      EXPT0810
.
EXPT0900  WRITE     HTMLFILE;EMEXURNO;
          GOTO      EXPT9999
.
EXPT1000  WRITE     HTMLFILE;EMEXSNAM;
          GOTO      EXPT9999
.
EXPT1100  WRITE     HTMLFILE;EMEXGNAM;
          GOTO      EXPT9999
.
EXPT9999  RETURN
.
.--------------------------------------------------------------------------
. Encounter Note Maintenance
.--------------------------------------------------------------------------
ENCN0000  BRANCH    FLDITMNO,ENCN0100,ENCN0200,ENCN0300,ENCN0400,ENCN0500:
                             ENCN0600,ENCN0700,ENCN0800,ENCN0900,ENCN1000:
                             ENCN1100,ENCN1200,ENCN1300
.         
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      ENCN9999
.
ENCN0100  MATCH     SP70,ALMDTYPE
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDTYPE;
          GOTO      ENCN9999
.
ENCN0200  MATCH     SP70,ALMDNOTE
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDNOTE;
          GOTO      ENCN9999
.       
ENCN0300  MATCH     SP70,ALMDDATE
          GOTO      ENCN9999 IF EQUAL
          UNPACK    ALMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      ENCN9999
.
ENCN0400  MATCH     SP70,ALMDTIME
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDTIME;
          GOTO      ENCN9999
.
ENCN0500  MATCH     SP70,ALMDUSER
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDUSER;
          GOTO      ENCN9999
.
ENCN0600  MATCH     SP70,ALMDOCCG
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDOCCG;
          GOTO      ENCN9999
.
ENCN0700  MATCH     SP70,ALMDDELT
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMDDELT;
          GOTO      ENCN9999
.
ENCN0800  MATCH     SP70,ALMTCMNT
          GOTO      ENCN9999 IF EQUAL
          WRITE     HTMLFILE;ALMTCMNT;
          GOTO      ENCN9999
.
ENCN0900  PACK      KEY28,ALMDVISN,ALMDENCN,ALMDTYPE,ALMDNOTE,SP70
          CALL      RSALMTX1
ENCN0910  CALL      RKALMTX1
          BRANCH    OVRCD,ENCN9999
.
          MATCH     ALMDVISN,ALMTVISN
          GOTO      ENCN9999 IF NOT EQUAL
.
          MATCH     ALMDENCN,ALMTENCN
          GOTO      ENCN9999 IF NOT EQUAL
.
          MATCH     ALMDTYPE,ALMTTYPE
          GOTO      ENCN0910 IF NOT EQUAL
.
          MATCH     ALMDNOTE,ALMTNOTE
          GOTO      ENCN0910 IF NOT EQUAL
.
          STRIP     ALMTCMNT
          MOVELPTR  ALMTCMNT,LENGTH
.
          SFORMAT   VAR,LENGTH
          MOVE      ALMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      ENCN0910
.
ENCN1000  MOVE      ZERO,NOTEORDR
          CALL      ENCTAB00
          GOTO      ENCN9999
.
ENCN1100  MOVE      ONE,NOTEORDR
          CALL      ENCTAB00
          GOTO      ENCN9999
.
ENCN1200  WRITE     HTMLFILE;ENCOUNTN;
          GOTO      ENCN9999
.
ENCN1300  WRITE     HTMLFILE;ENCOUTKY;
          GOTO      ENCN9999
.
ENCN9999  RETURN
.
.---------------------------------------------------------------------
. Display Table of Visit Note
.---------------------------------------------------------------------
NOTTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          MOVE      ADMISSNO,VSMDVISN
.
          IF        NOTEORDR=0
            PACK      KEY17,ADMISSNO,NOTEFILT,Z70
          ELSE
            PACK      KEY17,ADMISSNO,NOTEFILT,SP70
          ENDIF
.
          CALL      RSVSMDT1
NOTTAB10  IF        NOTEORDR=0
            CALL      RPVSMDT1
          ELSE
            CALL      RKVSMDT1
          ENDIF
          BRANCH    OVRCD,NOTTAB99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      NOTTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE
          GOTO      NOTTAB99 IF NOT EQUAL
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     NOTTAB40
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
NOTTAB40  MATCH     "1",VSMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",VSMDTYPE
          REP       " +",VSMDNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&notetype=",VSMDTYPE:
                             "&notenumb=",VSMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,VSMDTIME,"</td>";
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,VSMDUSER," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",VSMDTYPE
          REP       "+ ",VSMDNOTE
.
          MOVE      ZERO,CTR
          CALL      VSNOTE00
.
          MOVE      SP70,DISPDATE           * Display deleted date
          MOVE      SP70,DISPTIME           * Display deleted time
.
          MATCH     SP70,VSMDDDAT           * Date deleted
          IF        !@EQUAL
            UNPACK    VSMDDDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      VSMDDTIM,DISPTIME
          ENDIF
.
          PACK      KEY10,VSMDDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;STRENDTG,"&nbsp;</td>":
                               "<td>",WBSENAM," - ",VSMDDOCC,"&nbsp;<br>":
                               DISPDATE,"&nbsp;",DISPTIME,"</td>";
          ELSE
            MOVE      " - ",D3
            MATCH     SP70,VSMDDUSE
            IF        @EQUAL
              MOVE      SP70,D3
            ENDIF
            WRITE     HTMLFILE;STRENDTG,"&nbsp;</td>":
                               "<td>",VSMDDUSE,D3,VSMDDOCC,"&nbsp;<br>":
                               DISPDATE,"&nbsp;",DISPTIME,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      NOTTAB10
.
NOTTAB99  RETURN
.
.---------------------------------------------------------------------
. Display Table of Visit Comments
.---------------------------------------------------------------------
VCMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          MOVE      ADMISSNO,VSMDVISN
.
          IF        NOTEORDR = 0
            PACK      KEY17,ADMISSNO,NOTEFILT,Z70
          ELSE
            PACK      KEY17,ADMISSNO,NOTEFILT,SP70
          ENDIF
.
          CALL      RSVSMDT1
VCMTAB10  IF        NOTEORDR = 0  
            CALL      RPVSMDT1
          ELSE
            CALL      RKVSMDT1
          ENDIF
          BRANCH    OVRCD,VCMTAB99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      VCMTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,VSMDTYPE
          GOTO      VCMTAB99 IF NOT EQUAL
.
          MATCH     "D",SHOWCOMM
          IF        @EQUAL
            MATCH     "0",VSMDDELT
            GOTO      VCMTAB10 IF EQUAL
          ELSE      
            MATCH     "1",VSMDDELT
            GOTO      VCMTAB10 IF EQUAL
          ENDIF
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     VCMTAB40
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VCMTAB40  MATCH     "1",VSMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",VSMDTYPE
          REP       " +",VSMDNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&notetype=",VSMDTYPE:
                             "&notenumb=",VSMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,VSMDTIME,"</td>";
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,VSMDUSER," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",VSMDTYPE
          REP       "+ ",VSMDNOTE
.
          MOVE      ZERO,CTR
          CALL      VSNOTE00
.
VCMTAB80  MATCH     "1",VSMDDELT
          IF        @EQUAL
            PACK      KEY10,VSMDDUSE,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                                 "<td>",WBSENAM," - ",VSMDDOCC,"&nbsp;":
                                 "</td>":
                                 "</tr>"
            ELSE
              WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                                 "<td>",VSMDDUSE," - ",VSMDDOCC,"&nbsp;":
                                 "</td>":
                                 "</tr>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"&nbsp;</td><td>&nbsp;</td></tr>"
          ENDIF
.
          GOTO      VCMTAB10
.
VCMTAB99  RETURN
.
.------------------------------------------------------------
. Display Table of Encounter Notes
.---------------------------------------------------------------------
ENCTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      NOTHD000      * Output Table Heading
.
          MOVE      ADMISSNO,ALMDVISN
          MOVE      ENCOUNTN,ALMDENCN
.
          IF        NOTEORDR=0
            PACK      KEY25,ADMISSNO,ENCOUNTN,NOTEFILT,Z70
          ELSE
            PACK      KEY25,ADMISSNO,ENCOUNTN,NOTEFILT,SP70
          ENDIF
.
          CALL      RSALMDT1
ENCTAB10  IF        NOTEORDR=0
            CALL      RPALMDT1
          ELSE
            CALL      RKALMDT1
          ENDIF
          BRANCH    OVRCD,ENCTAB99
.
          MATCH     ADMISSNO,ALMDVISN
          GOTO      ENCTAB99 IF NOT EQUAL
.
          MATCH     ENCOUNTN,ALMDENCN
          GOTO      ENCTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,ALMDTYPE
          GOTO      ENCTAB99 IF NOT EQUAL
.
          MATCH     ALMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     ENCTAB40
          ENDIF
.
          UNPACK    ALMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",ALMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",ENCOUNTN
          REP       " +",ALMDTYPE
          REP       " +",ALMDNOTE
.
ENCTAB40  WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail08":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&encountn=",ENCOUNTN:
                             "&notetype=",ALMDTYPE:
                             "&notenumb=",ALMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,ALMDTIME,"</td>":
                             "<td>",STRIKETG,ALMDUSER," - ",ALMDOCCG,"&nbsp;":
                             STRENDTG,"</td>":
                             "<td>",STRIKETG;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",ENCOUNTN
          REP       "+ ",ALMDTYPE
          REP       "+ ",ALMDNOTE
.
          MOVE      ZERO,CTR
          CALL      ENNOTE00
          WRITE     HTMLFILE;"&nbsp;",STRENDTG,"</td>":
                             "<td>",ALMDDUSE," - ",ALMDDOCC,"&nbsp;":
                             "</td>":
                             "</tr>"

          GOTO      ENCTAB10
ENCTAB99  RETURN
.------------------------------------------------------------
. Visit Not Heading (TABLE HEADING)
.------------------------------------------------------------
NOTHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>";
.
          MATCH     "003",NOTEFILT
          IF        @EQUAL
            WRITE     HTMLFILE;"Comments</td>";
          ELSE
            MATCH     "013",NOTEFILT
            IF        @EQUAL
              WRITE     HTMLFILE;"Comments</td>";
            ELSE
              WRITE     HTMLFILE;"Notes</td>";
            ENDIF
          ENDIF
.
          WRITE      HTMLFILE;"<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>" 
.
NOTHD999  RETURN
.--------------------------------------------------------------------
. Visit note display
.--------------------------------------------------------------------
VSNOTE00  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSNOTE10  CALL      RKVSMTX1
          BRANCH    OVRCD,VSNOTE99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSNOTE99 IF NOT EQUAL
.
          COMPARE   THREE,CTR
          GOTO      VSNOTE99 IF EQUAL
          ADD       ONE,CTR
          IF        CTR=3
            WRITE     HTMLFILE;VSMTCMNT;
          ELSE
            WRITE     HTMLFILE;VSMTCMNT,"<br>";
          ENDIF
          GOTO      VSNOTE10
.
VSNOTE99  RETURN
.
.--------------------------------------------------------------------
. Encounter note display
.--------------------------------------------------------------------
ENNOTE00  PACK      KEY28,ALMDVISN,ALMDENCN,ALMDTYPE,ALMDNOTE,SP70
          CALL      RSALMTX1
ENNOTE10  CALL      RKALMTX1
          BRANCH    OVRCD,ENNOTE99
.
          MATCH     ALMDVISN,ALMTVISN
          GOTO      ENNOTE99 IF NOT EQUAL
.
          MATCH     ALMDENCN,ALMTENCN
          GOTO      ENNOTE99 IF NOT EQUAL
.
          MATCH     ALMDTYPE,ALMTTYPE
          GOTO      ENNOTE99 IF NOT EQUAL
.
          MATCH     ALMDNOTE,ALMTNOTE
          GOTO      ENNOTE99 IF NOT EQUAL
.
          COMPARE   TWO,CTR
          GOTO      ENNOTE99 IF EQUAL
          ADD       ONE,CTR
          WRITE     HTMLFILE;ALMTCMNT,"<br>";
          GOTO      ENNOTE10
.
ENNOTE99  RETURN
.
.------------------------------------------------------------
.         CHKUR000 Check URNUMBER contents
.------------------------------------------------------------
CHKUR000  MOVE      ONE,UNKFLAG
.
          MOVE      EMVIURNO,URNUMBER
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
            CALL      CLPMSPX2
            MOVE      ZERO,UNKFLAG
            MOVE      ZEROUR,URNUMBER
            MATCH     SP8,ADMISSNO
            IF        @EQUAL
              MOVE      EMVIADMN,ADMISSNO
            ENDIF
            GOTO      CHKUR990
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ELSE
            MOVE      PMPXABRG,SVPXABRG
            MOVE      PMPXHOML,SVPXHOML
            MOVE      PMPXINTR,SVPXINTR
          ENDIF
.
CHKUR990  BRANCH    UNKFLAG,CHKUR999
.
          MOVE      ADMISSNO,DIM8VISN
          PACK      KEY8,DIM8VISN
          CALL      RDEMUNK1
          IF        OVRCD=1
            CALL      CUNK0000
            GOTO      CHKUR999
          ENDIF
          CALL      RDPRAM1
          MOVE      "       0",PURNO
.
          MOVE      EMUNDET2,PGNAME
          MOVE      EMUNDET1,PSNAME
          MOVE      EMUNAGE,PSAGEYRS
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNBDAT,PBDATE
          PACK      PTITL,SP70
.
CHKUR999  RETURN
.
.------------------------------------------------------------
.         CUNK0000  Clear unknown patient file variables
.------------------------------------------------------------
CUNK0000  PACK      EMUNDET1,SP70
          PACK      EMUNDET2,SP70
          PACK      EMUNSEX,SP10
          CLEAR     EMUNAGE
.
CUNK9999  RETURN
.
.------------------------------------------------------------
.         Write history record
.------------------------------------------------------------
WRTHIS00  MOVE      SP70,SAVEDRDT
          MOVE      SP70,SAVEDRTM
          MOVE      SP70,SAVENRDT
          MOVE      SP70,SAVENRTM
          MOVE      SP70,SAVEDOCT
          MOVE      SP70,SAVENURS
.
          PACK      KEY22,ADMISSNO,Z70
          CALL      RSEMHIS1
WRTHIS05  CALL      RPEMHIS1
          BRANCH    OVRCD,WRTHIS10
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      WRTHIS10 IF NOT EQUAL
.
          MOVE      EMHIDSD,SAVEDRDT
          MOVE      EMHIDST,SAVEDRTM
          MOVE      EMHINSD,SAVENRDT
          MOVE      EMHINST,SAVENRTM
          MOVE      EMHIDOC,SAVEDOCT
          MOVE      EMHINUR,SAVENURS
.
WRTHIS10  MOVE      EMVIADMN,DIM8VISN
          MOVE      DIM8VISN,EMHIVIS
          CLOCK     TIME,CTIMEIS
.
          PACK      EMHIDAT,CCC,CYY,CMM,CDD
          REP       " 0",EMHIDAT
          UNPACK    CTIMEIS,HOUR,D1,MIN,D1,SEC
          PACK      EMHITIM,HOUR,MIN,SEC
          REP       " 0",EMHITIM
.
WRTHIS20  MATCH     SAVEDOCT,EMVIDOCT       * Is this a new doctor
          IF        @EQUAL
            MOVE      SAVEDRDT,EMHIDSD        * Restore current doctor date and
            MOVE      SAVEDRTM,EMHIDST        * time
          ELSE
              PACK      EMHIDSD,CCC,CYY,CMM,CDD * New doctor so seen date and
              REP       " 0",EMHIDSD            * time are set the current and
              PACK      EMHIDST,HOUR,MIN,SEC    * time
              REP       " 0",EMHIDST
          ENDIF
.
          MATCH     SAVENURS,EMVIATNS       * Is this a new nurse
          IF        @EQUAL
            MOVE      SAVENRDT,EMHINSD        * Restore current nurse date and
            MOVE      SAVENRTM,EMHINST        * time
          ELSE
            PACK      EMHINSD,CCC,CYY,CMM,CDD * New nurse so seen date and time
            REP       " 0",EMHINSD            * are set the current and time
            PACK      EMHINST,HOUR,MIN,SEC
            REP       " 0",EMHINST
          ENDIF
.
WRTHIS40  MOVE      HISTTYPE,EMHIUPT
          MATCH     SP70,WEBUSEID
          IF        !@EQUAL
            MOVE      WEBUSEID,EMHIEUS
          ELSE
            MOVE      USERID,EMHIEUS
          ENDIF
          MOVE      EMVILOCN,EMHILOC
          MOVE      EMVIDOCT,EMHIDOC
          MOVE      EMVIATNS,EMHINUR
          PACK      EMHISPA,SP70,SP70
          PACK      EMHIDSD,EMHIDSD,SP70
          PACK      EMHIDST,EMHIDST,SP70
          PACK      EMHINSD,EMHINSD,SP70
          PACK      EMHINST,EMHINST,SP70
.
          MATCH     SP70,EMHINUR
          IF        @EQUAL
            MOVE      SP70,EMHINSD
            MOVE      SP70,EMHINST
          ENDIF
.
          MATCH     SP70,EMHIDOC
          IF        @EQUAL
            MOVE      SP70,EMHIDSD
            MOVE      SP70,EMHIDST
          ENDIF
.
          CALL      IBACLOCK
          PACK      EMHICDAT,CCC,CYY,CMM,CDD  * Date Record Created (ccyymmdd)
          REP       " 0",EMHICDAT
          CLOCK     TIME,EMHICTIM             * Time Record Created (hh:mm:ss)
          MOVE      USERID,EMHICUID           * Web User Id Created (websecaf)
.
          MOVE      SP70,EMHIUDAT      * Date Record Updated (ccyymmdd)
          MOVE      SP70,EMHIUTIM      * Time Record Updated (hh:mm:ss)
          MOVE      SP70,EMHIUUID      * Web User Id Updated (websecaf)
.
          PACK      KEY22,EMHIVIS,EMHIDAT,EMHITIM
          CALL      RAEMHIS1
          IF        OVRCD=1
            MOVE      SP70,EMHIDRBC          * Dr Billing Complete
            CALL      WREMHIS1
          ENDIF
.
          PROC      EMRDRCHR            * Update Dr Billing complete
          MOVE      ZERO,EXIT
.
WRTHIS99  RETURN
.
.------------------------------------------------------------
. Link to Next set of Clinical Notes
.------------------------------------------------------------
NEXTTY00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
.
          WRITE     HTMLFILE;"cliweb06.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
.
NEXTTY99  RETURN
.-------------------------------------------------------------------------------
. Link to previous set of Clinical Notes
.-------------------------------------------------------------------------------
PRETYP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
.
          WRITE     HTMLFILE;"cliweb06.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
.
PRETYP99  RETURN
.
.------------------------------------------------------------
. Appointment Same Day Summary
.------------------------------------------------------------
APPTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,F2
          PACK      KEY8,CCC,CYY,CMM,CDD,SP70
          REP       " 0",KEY8
          PACK      KEY36,URNUMBER,KEY8,SP70
          CALL      RDSBOKA3
APPTAB10  CALL      RDKBOKA3
          BRANCH    OVRCD,APPTAB90
          MATCH     OBAURNO,URNUMBER
          GOTO      APPTAB90 IF NOT EQUAL
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     KEY28,CASEKEYS           * Ignore Slot being Viewed
          GOTO      APPTAB10 IF EQUAL
.
          COMPARE   THREE,OBASTAT            * Ignore Extended Slots
          GOTO      APPTAB10 IF EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,APPTAB10
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CLEAR     HTMLLINK
          APPEND    "javascript:AppointLink('",HTMLLINK
          APPEND    KEY28,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      APPTAB30
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,APPTAB20
.
          MATCH     OCASITE,OBASITE
          GOTO      APPTAB30 IF EQUAL
.
          MATCH     OCACLIN,OBACLIN
          GOTO      APPTAB30 IF EQUAL
.
APPTAB20  MOVE      "No Valid Clinic at Date",OCADESC
.
APPTAB30  MOVE      "OZ",CATEGORY
          MOVE      OTBBOUTC,CODE
          CALL      GETCOD00
          MOVE      TDESC,OUTCDESC
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MOVE      "CT",CATEGORY 
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLILDESC
.
          MOVE      OBATIME,DIM5
          ADD       ONE,F2
          MOVE      F2,DIM2
          REP       " 0",DIM2
          MATCH     "1",DIM1
          IF        @EQUAL
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
            WRITE     HTMLFILE;"<input type=hidden name=outvis",DIM2:
                               " value=#"",CPCDATE,SP1,"at ",DIM5," with ":
                               OCADESC,"#"\n>" 
            WRITE     HTMLFILE;"<input type=hidden name=outcli",DIM2:
                               " value=#"",OCADESC,"#"\n>" 
            WRITE     HTMLFILE;"<input type=hidden name=outvty",DIM2:
                               " value=#"",VTYPDESC,"#"\n>" 
            WRITE     HTMLFILE;"<input type=hidden name=outpre",DIM2:
                               " value=#"",PMVXUDF1,"#"\n>" 
            WRITE     HTMLFILE;"<input type=hidden name=outdat",DIM2:
                               " value=#"",CPCDATE,"#"\n>" 
            WRITE     HTMLFILE;"<input type=hidden name=outtim",DIM2:
                               " value=#"",DIM5,"#"\n>" 
            GOTO      APPTAB10
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OBADATE,DIM5,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",CLILDESC,"#",":
                             "#"",VTYPDESC,"#",":
                     "#"<input type=checkbox name=outkey",DIM2," value=1>#",";
          ENDIF
          BRANCH    OBASTAT,APPTAB51,APPTAB52,APPTAB53,APPTAB54,APPTAB55:
                            APPTAB56
          WRITE     HTMLFILE;"#" #");"
          GOTO      APPTAB10
.
APPTAB51  WRITE     HTMLFILE;"#"Booked#");"
          GOTO      APPTAB10
APPTAB52  WRITE     HTMLFILE;"#"Not Used#");"
          GOTO      APPTAB10
APPTAB53  WRITE     HTMLFILE;"#"Extended Slot#");"
          GOTO      APPTAB10
APPTAB54  WRITE     HTMLFILE;"#"Attended#");"
          GOTO      APPTAB10
APPTAB55  WRITE     HTMLFILE;"#"DNA#");"
          GOTO      APPTAB10
APPTAB56  WRITE     HTMLFILE;"#"Suspended#");"
          GOTO      APPTAB10
.
APPTAB90  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          IF        OVRCD=1
            CALL      CLOUTBOA
            CALL      CLOUTBOB
            GOTO      APPTAB99
          ENDIF
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=1
            CALL      CLOUTBOB
          ENDIF
.
APPTAB99  RETURN
.
MEDDET00  MOVE      ZERO,F3
          ASSIGN    (F3+100),F3
          PACK      KEY3,F3,SP70
          REP       " 0",KEY3
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
MEDDET10  CALL      RKOBMED1
          BRANCH    OVRCD,MEDDET90
.
          MATCH     ADMISSNO,OBMEVISN
          GOTO      MEDDET90 IF NOT EQUAL
.
          MOVE      OBMECNTR,F3
          ASSIGN    (F3+100),F3
          PACK      KEY3,F3,SP70
          REP       " 0",KEY3
.
          IF        MEDDET=0
            WRITE     HTMLFILE;"<tr><td width=30%><input type=text name=mcode":
                               KEY3," id=mcode",KEY3:
                               " maxlength=9 size=9 value=#"":
                               OBMEMCOD,"#" onchange=validateCode(40,NewNote.mcode":
                               KEY3,",NewNote.drugs",KEY3,");>":
                               "<input type=text name=drugs",KEY3," id=drugs",KEY3:
                               " maxlength=70 size=35 value=#"":
                               OBMEDRUG,"#">":
                               " <img src=../images/SearchIcon.gif class='Icon'":
                               " onclick=javascript:DefMiscChargeSearchFrame(":
                               "mcode",KEY3,",drugs",KEY3,");></td>";
            WRITE     HTMLFILE;"<td width=10%><select name=dosef",KEY3,">":
                               "<option></option>"
            PACK      DIM127,DOT,TWO,SP70
            MOVE      "DU",CATEGORY
            MOVE      OBMEDOSF,CODE
            CALL      CODITM00
            WRITE     HTMLFILE;"</select></td>":
                               "<td width=10%><input type=text name=dosea",KEY3:
                               " id=dosea",KEY3," maxlength=20 size=10":
                               " value=#"",OBMEDOSE,"#"></td>"
            WRITE     HTMLFILE;"<td><select name=frequ",KEY3," id=frequ",KEY3,">":
                               "<option></option>";
            PACK      DIM127,DOT,TWO,SP70
            MOVE      "DW",CATEGORY
            MOVE      OBMEFREQ,CODE
            CALL      CODITM00
            WRITE     HTMLFILE;"</select></td>":
                               "<td><input type=text name=durat",KEY3:
                               " id=durat",KEY3," maxlength=20 size=10":
                               " value=#"",OBMEDURA,"#"></td>"
            WRITE     HTMLFILE;"<td><input type=text name=quant",KEY3:
                               " id=quant",KEY3," maxlength=20 size=10":
                               " value=#"",OBMEQUAN,"#"></td>"
            WRITE     HTMLFILE;"<td width=20%><input type=text name=instr",KEY3:
                               " id=instr",KEY3," value=#"",OBMEINST,"#" onblur=":
                               "SetNextRow();>":
                               " <img src=../images/ClearIcon.gif class='Icon'":
                               " onclick=clrFields(mcode",KEY3,",drugs",KEY3:
                               ",dosef",KEY3:
                               ",dosea",KEY3:
                               ",frequ",KEY3:
                               ",durat",KEY3:
                               ",quant",KEY3:
                               ",instr",KEY3:
                               ");></td></tr>";
          ELSE
            STRIP     OBMEDOSE
            STRIP     OBMEDRUG
            STRIP     OBMEDRBR
            UNPACK    OBMESCDT,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE
.
            WRITE     HTMLFILE;"<tr><td width=20% valign=top><input type=text ":
                                      "size=40 value=#"":
                                      *+,OBMEDRBR," - ",*+,OBMEDRUG,"#" Class=ReadOnly":
                                      " readonly maxlength=110><input type=hidden":
                                      " name=mdrbr",KEY3," value=",*+,OBMEDRBR,">":
                                      "<input type=hidden name=drugs",KEY3:
                                      " value=",*+,OBMEDRUG,"></td>":
                                      "<td width=10% valign=top><input type=text":
                                      " name=fdate",KEY3," value=#"",CPCDATE,"#"":
                                      " Class=ReadOnly readonly size=15>":
                                      "<input type=hidden name=mdate",KEY3:
                                      " value=",OBMESCDT,"></td>":
                                      "<td width=40% valign=top colspan=4>":
                                      "<input type=text name=dosea",KEY3," value=#"":
                                      OBMEDOSE,"#" Class=ReadOnly readonly size=90":
                                      " maxlenght=50></td>":
                                      "<td width=30% valign=top><textarea ":
                                      "name=instr",KEY3," cols=35 rows=4 Class=ReadOnly ":
                                      "readonly>",OBMEINST,"</textarea></td></tr>";
          ENDIF
.
          GOTO      MEDDET10
.
MEDDET90  WRITE     HTMLFILE;"<input type=hidden name=numbitems value=#"":
                             KEY3,"#">"
.
MEDDET99  RETURN
.
MEDJSN00  WRITE     HTMLFILE;"[";
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
MEDJSN10  CALL      RKOBMED1
          BRANCH    OVRCD,MEDJSN90
          MATCH     ADMISSNO,OBMEVISN
          GOTO      MEDJSN90 IF NOT EQUAL
.
          WRITE     HTMLFILE;"{#"obmecntr#":#"",OBMECNTR,"#",":
                              "#"obmedrug#":#"",OBMEDRUG,"#",":
                              "#"obmedosf#":#"",OBMEDOSF,"#",":
                              "#"obmedose#":#"",OBMEDOSE,"#",":
                              "#"obmefreq#":#"",OBMEFREQ,"#",":
                              "#"obmedura#":#"",OBMEDURA,"#",":
                              "#"obmequan#":#"",OBMEQUAN,"#",":
                              "#"obmeinst#":#"",OBMEINST,"#",":
                              "#"obmemcod#":#"",OBMEMCOD,"#",":
                              "#"obmereas#":#"",OBMEREAS,"#",":
                              "#"obmestat#":#"",OBMESTAT,"#",":
                              "#"obmechgd#":#"",OBMECHGD,"#",":
                              "#"obmechgr#":#"",OBMECHGR,"#",":
                              "#"obmenote#":#"",OBMENOTE,"#"},"
.                            
          GOTO      MEDJSN10
.
MEDJSN90  WRITE     HTMLFILE;"{}]";
.
MEDJSN99  RETURN
.
.
MEDROW00  PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
MEDROW10  CALL      RKOBMED1
          BRANCH    OVRCD,MEDROW90
          MATCH     ADMISSNO,OBMEVISN
          GOTO      MEDROW90 IF NOT EQUAL
          MOVE      SP70,DUDESC
          MOVE      SP70,DWDESC
          MOVE      SP70,MBDESC
          MOVE      SP70,MCDESC
          MOVE      SP70,MNDESC
.
          MOVE      "DU",CATEGORY
          MOVE      OBMEDOSF,CODE  *    Dose Form (Cat DU)
          CALL      GETCOD00
          MOVE      TDESC,DUDESC
.
          MOVE      "DW",CATEGORY
          MOVE      OBMEFREQ,CODE  *   Frequency (Cat DW)
          CALL      GETCOD00
          MOVE      TDESC,DWDESC
.
          MOVE      "MB",CATEGORY
          MOVE      OBMEREAS,CODE  *   Reason for medication (Cat MB)
          CALL      GETCOD00
          MOVE      TDESC,MBDESC
.
          MOVE      "MC",CATEGORY
          MOVE      OBMESTAT,CODE  *   Medication Status (Cat MC)   
          CALL      GETCOD00
          MOVE      TDESC,MCDESC
.
          MOVE      "MN",CATEGORY
          MOVE      OBMECHGR,CODE  *   Change Reason (Cat MN)
          CALL      GETCOD00
          MOVE      TDESC,MNDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",OBMECNTR,"#",":
                              "#"",OBMEDRUG,"#",":
                              "#"",OBMEDOSF,"#",":
                              "#"",DUDESC,"#",":
                              "#"",OBMEDOSE,"#",":
                              "#"",OBMEFREQ,"#",":
                              "#"",DWDESC,"#",":
                              "#"",OBMEDURA,"#",":
                              "#"",OBMEQUAN,"#",":
                              "#"",OBMEINST,"#",":
                              "#"",OBMEMCOD,"#",":
                              "#"",OBMEREAS,"#",":
                              "#"",MBDESC,"#",":
                              "#"",OBMESTAT,"#",":
                              "#"",MCDESC,"#",":
                              "#"",OBMECHGD,"#",":
                              "#"",OBMECHGR,"#",":
                              "#"",MNDESC,"#",":
                              "#"",OBMENOTE,"#");"
.                            
          GOTO      MEDROW10
.
MEDROW90  
MEDROW99  RETURN
.------------------------------------------------------------
.  Copy discharge summary from another visit
.------------------------------------------------------------
CPDIS000  MOVE      ZERO,EXIT
          MATCH     Z70,PREVVISN
          GOTO      CPDIS999 IF EQUAL
.
          MATCH     ANSA,UPDTTYPE        * copy all
          GOTO      CPDIS100 IF NOT EQUAL
.
          CALL      CPCNA000            * Copy obscnaaf records
          CALL      CPCNB000            * Copy obscnbaf records
          CALL      CPDIA000            * Copy obsdiaaf records
          CALL      CPPIN000            * Copy obspinaf records
          CALL      CPREA000            * Copy obsreaaf records
          CALL      CPBHI000            * Copy obsbhiaf records
          CALL      CPBPH000            * Copy obsbphaf records
          CALL      CPLAB000            * Copy obslabaf records
          CALL      CPRES000            * Copy obsresaf records
          CALL      CPPHY000            * Copy obsphyaf records
          CALL      CPDIT000            * Copy obsditaf records
          CALL      CPCAL000            * Copy obscalaf records
          CALL      CPMED000            * Copy obsmedaf records
.
CPDIS100  MATCH     ANSM,UPDTTYPE         * copy medication only
          GOTO      CPDIS999 IF NOT EQUAL
.
          CALL      CPCNM000            * Copy obscnaaf record
          CALL      CPMED000            * Copy obsmedaf records
          GOTO      CPDIS999
.
CPDIS999  RETURN
.------------------------------------------------------------
.  Copy obscnaaf records from another visit
.------------------------------------------------------------
CPCNA000  PACK      KEY12,PREVVISN,SP70
          CALL      RSOBCA1
CPCNA100  CALL      RKOBCA1
          BRANCH    OVRCD,CPCNA999
.
          MATCH     PREVVISN,OBCAVIS
          GOTO      CPCNA999 IF NOT EQUAL
.
          PACK      SAVKEY12,OBCAVIS,OBCACID,SP70
          PACK      KEY12,ADMISSNO,OBCACID,SP70
          PACK      OBCAVIS,ADMISSNO,SP70
          CALL      RAOBCA1
          IF        OVRCD=1
            CALL      WROBCA1
          ENDIF
          PACK      KEY12,SAVKEY12,SP70
          CALL      RDOBCA1
          GOTO      CPCNA100
.
CPCNA999  RETURN
+
.------------------------------------------------------------
.  Copy medication obscnaaf record from another visit
.------------------------------------------------------------
CPCNM000  PACK      KEY12,PREVVISN,SP70
          CALL      RSOBCA1
CPCNM100  CALL      RKOBCA1
          BRANCH    OVRCD,CPCNM999
.
          MATCH     PREVVISN,OBCAVIS
          GOTO      CPCNM999 IF NOT EQUAL
.
          MATCH     "008",OBCATYP
          GOTO      CPCNM100 IF NOT EQUAL
.
          PACK      SAVKEY12,OBCAVIS,OBCACID,SP70
          PACK      KEY12,ADMISSNO,OBCACID,SP70
          PACK      OBCAVIS,ADMISSNO,SP70
          CALL      RAOBCA1
          IF        OVRCD=1
            CALL      WROBCA1
          ENDIF
          PACK      KEY12,SAVKEY12,SP70
          CALL      RDOBCA1
          GOTO      CPCNM100
.
CPCNM999  RETURN
+
.------------------------------------------------------------
.  Copy obscnbaf records from another visit
.------------------------------------------------------------
CPCNB000  PACK      KEY15,PREVVISN,SP70
          CALL      RSOBCB1
CPCNB100  CALL      RKOBCB1
          BRANCH    OVRCD,CPCNB999
.
          MATCH     PREVVISN,OBCBVIS
          GOTO      CPCNB999 IF NOT EQUAL
.
          PACK      SAVKEY15,OBCBVIS,OBCBCID,OBCBLNO,SP70
          PACK      KEY15,ADMISSNO,OBCBCID,OBCBLNO,SP70
          PACK      OBCBVIS,ADMISSNO,SP70
          CALL      RAOBCB1
          IF        OVRCD=1
            CALL      WROBCB1
          ENDIF
          PACK      KEY15,SAVKEY15,SP70
          CALL      RDOBCB1
          GOTO      CPCNB100
.
CPCNB999  RETURN
+
.------------------------------------------------------------
.  Copy obsdiaaf records from another visit
.------------------------------------------------------------
CPDIA000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBDIA1
CPDIA100  CALL      RKOBDIA1
          BRANCH    OVRCD,CPDIA999
.
          MATCH     PREVVISN,OBDIVISN
          GOTO      CPDIA999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBDIVISN,OBDILINE,SP70
          PACK      KEY11,ADMISSNO,OBDILINE,SP70
          PACK      OBDIVISN,ADMISSNO,SP70
          CALL      RAOBDIA1
          IF        OVRCD=1
            CALL      WROBDIA1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBDIA1
          GOTO      CPDIA100
.
CPDIA999  RETURN
+
.------------------------------------------------------------
.  Copy obspinaf records from another visit
.------------------------------------------------------------
CPPIN000  PACK      KEY8,PREVVISN,SP70
          CALL      RDOBPIN1
          BRANCH    OVRCD,CPPIN999
.
          PACK      KEY8,ADMISSNO,SP70
          PACK      OBPNVISN,ADMISSNO,SP70
          CALL      RAOBPIN1
          IF        OVRCD=1
            CALL      WROBPIN1
          ENDIF
.
CPPIN999  RETURN
+
.------------------------------------------------------------
.  Copy obsreaaf records from another visit
.------------------------------------------------------------
CPREA000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBREA1
CPREA100  CALL      RKOBREA1
          BRANCH    OVRCD,CPREA999
.
          MATCH     PREVVISN,OBREVISN
          GOTO      CPREA999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBREVISN,OBRELINE,SP70
          PACK      KEY11,ADMISSNO,OBRELINE,SP70
          PACK      OBREVISN,ADMISSNO,SP70
          CALL      RAOBREA1
          IF        OVRCD=1
            CALL      WROBREA1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBREA1
          GOTO      CPREA100
.
CPREA999  RETURN
+
.------------------------------------------------------------
.  Copy obsbhiaf records from another visit
.------------------------------------------------------------
CPBHI000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBBHI1
CPBHI100  CALL      RKOBBHI1
          BRANCH    OVRCD,CPBHI999
.
          MATCH     PREVVISN,OBBHVISN
          GOTO      CPBHI999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBBHVISN,OBBHLINE,SP70
          PACK      KEY11,ADMISSNO,OBBHLINE,SP70
          PACK      OBBHVISN,ADMISSNO,SP70
          CALL      RAOBBHI1
          IF        OVRCD=1
            CALL      WROBBHI1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBBHI1
          GOTO      CPBHI100
.
CPBHI999  RETURN
+
.------------------------------------------------------------
.  Copy obsbphaf records from another visit
.------------------------------------------------------------
CPBPH000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBBPH1
CPBPH100  CALL      RKOBBPH1
          BRANCH    OVRCD,CPBPH999
.
          MATCH     PREVVISN,OBBPVISN
          GOTO      CPBPH999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBBPVISN,OBBPLINE,SP70
          PACK      KEY11,ADMISSNO,OBBPLINE,SP70
          PACK      OBBPVISN,ADMISSNO,SP70
          CALL      RAOBBPH1
          IF        OVRCD=1
            CALL      WROBBPH1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBBPH1
          GOTO      CPBPH100
.
CPBPH999  RETURN
+
.------------------------------------------------------------
.  Copy obslabaf records from another visit
.------------------------------------------------------------
CPLAB000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBLAB1
CPLAB100  CALL      RKOBLAB1
          BRANCH    OVRCD,CPLAB999
.
          MATCH     PREVVISN,OBLBVISN
          GOTO      CPLAB999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBLBVISN,OBLBLINE,SP70
          PACK      KEY11,ADMISSNO,OBLBLINE,SP70
          PACK      OBLBVISN,ADMISSNO,SP70
          CALL      RAOBLAB1
          IF        OVRCD=1
            CALL      WROBLAB1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBLAB1
          GOTO      CPLAB100
.
CPLAB999  RETURN
+
.------------------------------------------------------------
.  Copy obsresaf records from another visit
.------------------------------------------------------------
CPRES000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBRES1
CPRES100  CALL      RKOBRES1
          BRANCH    OVRCD,CPRES999
.
          MATCH     PREVVISN,OBRSVISN
          GOTO      CPRES999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBRSVISN,OBRSLINE,SP70
          PACK      KEY11,ADMISSNO,OBRSLINE,SP70
          PACK      OBRSVISN,ADMISSNO,SP70
          CALL      RAOBRES1
          IF        OVRCD=1
            CALL      WROBRES1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBRES1
          GOTO      CPRES100
.
CPRES999  RETURN
+
.------------------------------------------------------------
.  Copy obsphyaf records from another visit
.------------------------------------------------------------
CPPHY000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBPHY1
CPPHY100  CALL      RKOBPHY1
          BRANCH    OVRCD,CPPHY999
.
          MATCH     PREVVISN,OBPHVISN
          GOTO      CPPHY999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBPHVISN,OBPHLINE,SP70
          PACK      KEY11,ADMISSNO,OBPHLINE,SP70
          PACK      OBPHVISN,ADMISSNO,SP70
          CALL      RAOBPHY1
          IF        OVRCD=1
            CALL      WROBPHY1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBPHY1
          GOTO      CPPHY100
.
CPPHY999  RETURN
+
.------------------------------------------------------------
.  Copy obsditaf records from another visit
.------------------------------------------------------------
CPDIT000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBDIT1
CPDIT100  CALL      RKOBDIT1
          BRANCH    OVRCD,CPDIT999
.
          MATCH     PREVVISN,OBDTVISN
          GOTO      CPDIT999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBDTVISN,OBDTCNTR,SP70
          PACK      KEY11,ADMISSNO,OBDTCNTR,SP70
          PACK      OBDTVISN,ADMISSNO,SP70
          CALL      RAOBDIT1
          IF        OVRCD=1
            CALL      WROBDIT1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBDIT1
          GOTO      CPDIT100
.
CPDIT999  RETURN
+
.------------------------------------------------------------
.  Copy obscalaf records from another visit
.------------------------------------------------------------
CPCAL000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBCAL1
CPCAL100  CALL      RKOBCAL1
          BRANCH    OVRCD,CPCAL999
.
          MATCH     PREVVISN,OBCLVISN
          GOTO      CPCAL999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBCLVISN,OBCLCNTR,SP70
          PACK      KEY11,ADMISSNO,OBCLCNTR,SP70
          PACK      OBCLVISN,ADMISSNO,SP70
          CALL      RAOBCAL1
          IF        OVRCD=1
            CALL      WROBCAL1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBCAL1
          GOTO      CPCAL100
.
CPCAL999  RETURN
+
.------------------------------------------------------------
.  Copy obsmedaf records from another visit
.------------------------------------------------------------
CPMED000  PACK      KEY11,PREVVISN,SP70
          CALL      RSOBMED1
CPMED100  CALL      RKOBMED1
          BRANCH    OVRCD,CPMED999
.
          MATCH     PREVVISN,OBMEVISN
          GOTO      CPMED999 IF NOT EQUAL
.
          PACK      SAVKEY11,OBMEVISN,OBMECNTR,SP70
          PACK      KEY11,ADMISSNO,OBMECNTR,SP70
          PACK      OBMEVISN,ADMISSNO,SP70
          CALL      RAOBMED1
          IF        OVRCD=1
            CALL      WROBMED1
          ENDIF
          PACK      KEY11,SAVKEY11,SP70
          CALL      RDOBMED1
          GOTO      CPMED100
.
CPMED999  RETURN
+
CLOUTBOA  MOVE      SP70,OBASITE
          MOVE      SP70,OBACLIN
          MOVE      SP70,OBADATE
          MOVE      SP70,OBASTRT
          MOVE      SP70,DOBASLOT
          MOVE      SP70,OBATIME
          MOVE      SP70,OBACTYP
          MOVE      ZEROUR,OBAURNO
          MOVE      SP70,OBAVISIT
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,DOBASTAT
          MOVE      ZERO,OBADAY
          MOVE      ZERO,OBAEXSL
          MOVE      SP70,OBAFINST
          MOVE      SP70,OBALOCK
          MOVE      ZERO,OBAPXRAY
          MOVE      SP70,OBABKDTE
          MOVE      ZERO,OBAPULL
          MOVE      SP70,OBASESST
          MOVE      SP70,OBADISCH
          MOVE      SP70,DOTBARES
          MOVE      SP70,OBASPARA
          MOVE      ZERO,OBASLOT
          MOVE      ZEROVISN,OBAOUTNO
          MOVE      ZERO,OBASTAT
          MOVE      ZERO,OTBARESV
          RETURN
.
CLOUTBOB  MOVE      SP70,OBASRCR
          MOVE      SP70,OBACOMP
          MOVE      SP70,OBACLASS
          MOVE      SP70,OBAINS
          MOVE      SP70,OBAATTN
          MOVE      SP70,OBADOCT
          MOVE      SP70,OBACOMM
          MOVE      SP70,OTBBFUND
          MOVE      SP70,OTBBTBLE
          MOVE      SP70,DOTBBPVI
          MOVE      SP70,OTBBSPAR
          MOVE      SP70,OBADATE
          MOVE      SP70,OBACAT
          MOVE      SP70,OBAPRTY
          MOVE      SP70,OBARSCHD
          MOVE      SP70,OBBPORT
          MOVE      SP70,OBBBOOK
          MOVE      SP70,OBBCTYP
          MOVE      SP70,OBOUSR1
          MOVE      SP70,OBOUSR2
          MOVE      SP70,OBOUSR3
          MOVE      SP70,OBOUSR4
          MOVE      SP70,OBALADMN
          MOVE      SP70,OTBBDEPT
          MOVE      SP70,OTBBTRAN
          MOVE      SP70,OTBBLNGI
          MOVE      SP70,OTBBTMFS
          MOVE      SP70,OTBBTMBO
          MOVE      SP70,OTBBGPFA
          MOVE      SP70,OTBBECRA
          MOVE      SP70,OTBBRFGP
          MOVE      SP70,OTBBGPPC
          MOVE      SP70,OTBBADCS
          MOVE      SP70,OTBBCITM
          MOVE      SP70,OTBBASTM
          MOVE      SP70,OTBBDPTM
          MOVE      SP70,OTBBOUTC
          MOVE      SP70,OTBBSNDL
          MOVE      SP70,OTBBGPPT
          MOVE      SP70,OTBBDOFR
          MOVE      SP70,OTBBOPER
          MOVE      SP70,OBOUSR5
          MOVE      SP70,OBOUSR6
          MOVE      SP70,OBOUSR7
          MOVE      SP70,OBOUSR8
          MOVE      SP70,OTBBRANK
          MOVE      SP70,OTBBFLUP
          MOVE      SP70,OTBBSCAR
          MOVE      SP70,OTBBSPR1
.
          MOVE      SP70,OTBBSPCA           * Added for special arrangement
.
          RETURN
.------------------------------------------------------------
. Add Multiple New Notes for Service Orders
.------------------------------------------------------------
ADDSV000  CALL      GETPAT00
          MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      CLEMRVIS
          ENDIF
          CALL      RDBOKB1
          IF        OVRCD=1
            CALL      CLOUTBB1
          ENDIF
.
          ADD       ONE,LASTITEM                         * Increment Array Counter
          MOVE      "Request Items:",NOTETEXT[LASTITEM]     
.
          MOVE      CLNOT006,SERVPRI    * service priority, from clnot006 cgi
          MOVE      ZERO,SERVCNT
ADDSV100  ADD       ONE,SERVCNT
          IF        SERVCNT>SERVEND
            GOTO      ADDSV800 
          ENDIF
          MATCH     SP70,SERVICEC[SERVCNT]
          GOTO      ADDSV100 IF EQUAL
.                                     * etc:"HM   FBC    Full Blood Count"
          UNPACK    SERVICEC[SERVCNT],SERVDSSC,SERVCODE,SERVDESC,SERVLABC
          ADD       ONE,LASTITEM                         * Increment Array Counter
          MOVE      SERVDESC,NOTETEXT[LASTITEM]          * Input Note to Array 
.
          MOVE      SERVLABC,KEY3
          CALL      RDRELB1
.
          CALL      MAKORM00          * create ORM 
          CALL      COPYT000          * Copy To (reshecaf)
          CALL      ADDCL000          * clinical relevant (reshedaf)/ copy to (reshecaf)
          GOTO      ADDSV100          * any more services request ?
.
ADDSV800  MATCH     SP70,CLNOT001
          IF        !@EQUAL
            CALL      ADDNT000        * add note if Note Type is Set
          ENDIF
.
          CALL      PRLAB000          * process by lab print and create hl7 
.
ADDSV900  MOVE      ZERO,EXIT
.
ADDSV999  RETURN
+
.------------------------------------------------------------------------------
. Create HL7 File for Each Laboratory
.------------------------------------------------------------------------------
PRLAB000  PACK      KEY3,SP70 
          CALL      RSRELB1
PRLAB100  CALL      RKRELB1
          BRANCH    OVRCD,PRLAB999
          MOVE      ONE,SERVCNT                 * initialise count
          WHILE     SERVCNT <= SERVEND
            UNPACK    SERVICEC[SERVCNT],SERVDSSC,SERVCODE,SERVDESC,SERVLABC
            MATCH     RELBLCD,SERVLABC
            IF        @EQUAL
              MOVE      RESULTSK[SERVCNT],KEY17
              CALL      RDREHA1
.
              CALL      TXTHL000                 * Matched Lab So Create HL7 Record
              CALL      ORDPR000                 * Print Order Form for Laboratory
              MOVE      SERVEND,SERVCNT
.
            ENDIF
            ADD       ONE,SERVCNT 
          DO
.
          GOTO      PRLAB100
.
PRLAB999  RETURN
.------------------------------------------------------------------------------
. create hl7 text file
.------------------------------------------------------------------------------
TXTHL000  CALL      GMESID00            * generate next message id PTCNRMIC
          CALL      CREAT000
          CALL      ADDMES00            * add hl7 message
          BRANCH    EXIT,TXTHL999
          CALL      MTXTHL00            * move hl7 text output
TXTHL999  RETURN
+
.------------------------------------------------------------
. Move result by executing cliweb06.us1 <filename> <laboratory> <message id>
.------------------------------------------------------------
MTXTHL00  CLEAR     CMDLINE
          APPEND    "cliweb06.us1 ",CMDLINE
          APPEND    FILENAME,CMDLINE
          APPEND    ".txt ",CMDLINE
          APPEND    SERVLABC,CMDLINE
          APPEND    SP1,CMDLINE
          APPEND    PTCNRMIC,CMDLINE
          RESET     CMDLINE
          CLOSE     ORDRFILE
.
          EXECUTE   CMDLINE,TASKID
.
MTXTHL99  RETURN
+
.------------------------------------------------------------------------------
. add hl7 message
.------------------------------------------------------------------------------
ADDMES00  MOVE      ZERO,EXIT
          CALL      WRMSH000            * wriEHCRUN
          CALL      WRPID000            * write PID
          CALL      WRPVI000            * write PV1&2
          CALL      WRINI000            * write IN1
          MOVE      ZERO,ORDERCNT

          MOVE      ONE,SERVCNT                 * initialise count
          WHILE     SERVCNT <= SERVEND
            UNPACK    SERVICEC[SERVCNT],SERVDSSC,SERVCODE,SERVDESC,SERVLABC
            MATCH     RELBLCD,SERVLABC
            IF        @EQUAL
              MOVE      RESULTSK[SERVCNT],KEY17
              CALL      RDREHA1
              CALL      WRORC000            * write OCR
              CALL      WROBR000            * write OBR
              MOVE      RESULTSK[SERVCNT],KEY17
              CALL      RDREHA1
              IF        OVRCD=0
                PACK      REHAPAP,MSHSEQ04,SP70
                PACK      REHAFAP,MSHSEQ04,SP70
                PACK      REHAFOR,ORCSEQ02,SP70
                PACK      REHAPOR,ORCSEQ02,SP70
                CALL      UPREHA1
              ENDIF
            ENDIF
            ADD       ONE,SERVCNT
          DO
.
ADDMES999 RETURN
+
.------------------------------------------------------------------------------
. write OBR
.------------------------------------------------------------------------------
WROBR000  MOVE      ZERO,EXIT
          PACK      OBRSEQ01,SP70       * set id 
          PACK      OBRSEQ02,SP70       * place order number
          PACK      OBRSEQ04,SP70       * universal service id
          PACK      OBRSEQ06,SP70       * requested date/time
          PACK      OBRSEQ13,SP70       * relevant clinical info
          PACK      OBRSEQ16,SP70       * ordering provider
          PACK      OBRSEQ24,SP70       * diagnostic service section id
          PACK      OBRSEQ25,SP70       * result status
          PACK      OBRSEQ27,SP70       * quantity/timing
          PACK      OBRSEQ28,SP70       * result copies to
.
          PACK      OBRSEQ01,ONE
          UNPACK    REHARTM,CHOUR,KEY1,CMIN
          PACK      OBRSEQ06,REHARDT,CHOUR,CMIN,SP70
          STRIP     OBRSEQ06
.
          CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS
          UNPACK    CTIMEIS,CHOUR,DIM1,CMIN,DIM1,CSEC
          PACK      DATETIME,CCC,CYY,CMM,CDD,CHOUR,CMIN,CSEC
          REP       " 0",DATETIME
.
          PACK      KEY17,REHARDT,REHARTM,REHARUN,SP70
          CALL      RDREHA1 
          BRANCH    OVRCD,WROBR800
.
          PACK      KEY17,REHARDT,REHARTM,REHARUN
          CALL      RDREHD1
          IF        OVRCD=0
            PACK      OBRSEQ13,REHDRCI,SP70
            STRIP     OBRSEQ13
          ENDIF
.
          PACK      KEY32,REHALAB,OBR,ZEROFOUR,CODINSYS,REHAUSC,SP70
          CALL      RDRECT1
          BRANCH    OVRCD,WROBR800
.
          PACK      OBRSEQ02,ORCSEQ02,SP70
          STRIP     OBRSEQ02
          REP       " 0",OBRSEQ02
          STRIP     REHAUSC
          STRIP     RECTDES
          PACK      OBRSEQ04,REHAUSC,CARAT,RECTDES,CARAT,MPS
          STRIP     OBRSEQ04
          PACK      OBRSEQ24,REHADSS
          STRIP     OBRSEQ24
          PACK      OBRSEQ25,REHARST
          STRIP     OBRSEQ25
.
. Priority
.
          MOVE      SERVPRI,KEY1
          REP       UPPLOW,KEY1
          MATCH     "U",KEY1
          IF        @EQUAL
            MOVE      "S",KEY1
          ENDIF
          PACK      OBRSEQ27,CARAT,CARAT,CARAT,OBRSEQ06,CARAT,CARAT,KEY1,CARAT,CARAT,SERVPRI
          STRIP     OBRSEQ27
.
          PACK      KEY10,REHAOID
          CALL      RDPMHCP1
          IF        OVRCD <> 1
            STRIP     PMHCSNAM
            STRIP     PMHCGNAM
            STRIP     PMHCTITL
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              CALL      GPRAC000
            ENDIF
            MATCH     SP70,PMHCPRV1
            IF        !@EQUAL
              SQUEEZE   PMHCPRV1
              PACK      OBRSEQ16,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
            ENDIF
          ENDIF
.          
          PACK      KEY19,REHARDT,REHARTM,REHARUN,SP70
          CALL      RSREHC1
WROBR400  CALL      RKREHC1
          BRANCH    OVRCD,WROBR500
          MATCH     REHARDT,REHCRDT
          GOTO      WROBR500 IF NOT EQUAL
          MATCH     REHARTM,REHCRTM
          GOTO      WROBR500 IF NOT EQUAL
          MATCH     REHARUN,REHCRUN
          GOTO      WROBR500 IF NOT EQUAL
.
          SCAN      "^",REHCCTO
          GOTO      WROBR400 IF NOT EQUAL
          MOVEFPTR  REHCCTO,LENGTH
          SUB       ONE,LENGTH
          IF        LENGTH>0
            RESET     REHCCTO
            SFORMAT   VAR,LENGTH
            MOVE      REHCCTO,VAR
          ELSE
            GOTO      WROBR400
          ENDIF
.          
          PACK      KEY10,VAR,SP70
          SFORMAT   VAR,127
          CALL      RDPMHCP1
          IF        OVRCD <> 1
            STRIP     PMHCSNAM
            STRIP     PMHCGNAM
            STRIP     PMHCTITL
            MATCH     SP70,PMHCPRV1
            IF        @EQUAL
              SCAN      "^",REHCCTO
              BUMP      REHCCTO
              SCAN      "^",REHCCTO
              IF        @EQUAL
                BUMP      REHCCTO
                MOVE      REHCCTO,PMHCPRV1
                PACK      PMHCPRV1,PMHCPRV1,SP70
.
                MATCH     SP70,PMHCPRV1
                GOTO      WROBR450 IF EQUAL
                GOTO      WROBR450 IF EOS
              ELSE
WROBR450        CALL      GPRAC000
              ENDIF
            ENDIF
            MATCH     SP70,PMHCPRV1
            IF        !@EQUAL
              SQUEEZE   PMHCPRV1
              PACK      KEY80,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
              STRIP     KEY80
              APPEND    KEY80,OBRSEQ28
              APPEND    TILDA,OBRSEQ28
            ENDIF
          ENDIF
.
          GOTO      WROBR400
.
WROBR500  REPLACE   "~ ",OBRSEQ28
          MOVE      "L",OBRSEQ10
          MOVE      "L",OBRSEQ11
          RESET     OBRSEQ28
          STRIP     OBRSEQ28
          STRIP     OBRSEQ01
          STRIP     OBRSEQ02
          STRIP     OBRSEQ04
          STRIP     OBRSEQ06
          STRIP     OBRSEQ10
          STRIP     OBRSEQ11
          STRIP     OBRSEQ13
          STRIP     OBRSEQ16
          STRIP     OBRSEQ24
          STRIP     OBRSEQ25
          STRIP     OBRSEQ27
          WRITE     ORDRFILE,SEQ;*+,OBR,PIPE:
                                 *+,OBRSEQ01,PIPE:
                                 *+,OBRSEQ02,PIPE:
                                 *+,PIPE: * 3
                                 *+,OBRSEQ04,PIPE:
                                 *+,PIPE: * 5
                                 *+,OBRSEQ06,PIPE:
                                 *+,PIPE: * 7
                                 *+,PIPE: * 8
                                 *+,PIPE: * 9
                                 *+,OBRSEQ10,PIPE: * 10
                                 *+,OBRSEQ11,PIPE: * 11
                                 *+,PIPE: * 12
                                 *+,OBRSEQ13,PIPE:
                                 *+,PIPE: * 14
                                 *+,PIPE: * 15
                                 *+,OBRSEQ16,PIPE:
                                 *+,PIPE: * 17
                                 *+,PIPE: * 18
                                 *+,PIPE: * 19
                                 *+,PIPE: * 20
                                 *+,PIPE: * 21
                                 *+,PIPE: * 22
                                 *+,PIPE: * 23
                                 *+,OBRSEQ24,PIPE:
                                 *+,OBRSEQ25,PIPE:
                                 *+,PIPE: * 26
                                 *+,OBRSEQ27,PIPE: * 27
                                 *+,OBRSEQ28
.
WROBR800  MOVE      ZERO,EXIT
          GOTO      WROBR999
.
WROBR900  MOVE      ONE,EXIT
.
WROBR999  RETURN
+
.------------------------------------------------------------------------------
. write ORC
.------------------------------------------------------------------------------
WRORC000  MOVE      ZERO,EXIT
          PACK      ORCSEQ01,SP70       * order control
          PACK      ORCSEQ02,SP70       * place order number
          PACK      ORCSEQ04,SP70       * place group number
          PACK      ORCSEQ05,SP70       * order status
          PACK      ORCSEQ10,SP70       * ordering provider
          PACK      ORCSEQ12,SP70       * ordering provider
.
          MATCH     "1",ORDERTYP        * new order
          IF        @EQUAL
            PACK      ORCSEQ01,ANSNW
            MOVE      "IP",ORCSEQ05   * In Progress
            UNPACK    PTCNRMIC,KEY5,KEY7
            PACK      ORCSEQ04,KEY7,SP70
            STRIP     ORCSEQ04
            ADD       ONE,ORDERCNT
            PACK      ORCSEQ02,ORCSEQ04,DASH,ORDERCNT,SP70
            SQUEEZE   ORCSEQ02
          ENDIF
.
          MATCH     "2",ORDERTYP        * cancel order
          IF        @EQUAL
            PACK      ORCSEQ01,ANSCA
            MOVE      "CA",ORCSEQ05   * Cancel - Will need to work this out.
            PACK      ORCSEQ02,REHAPOR,SP70
            STRIP     ORCSEQ02
            MOVE      REHAPOR,KEY12
            PACK      ORCSEQ04,KEY12,SP70
            STRIP     ORCSEQ04
          ENDIF     
.
          PACK      KEY10,USERID,SP70   * get hcp who requested the order
          CALL      RDWBSE1
          BRANCH    OVRCD,WRORC010
.         
          PACK      KEY10,WBSEDOC
          MATCH     SP70,WBSEDOC
          IF        @EQUAL
            PACK      KEY10,ORDERHCP
          ENDIF
          CALL      RDPMHCP1
          BRANCH    OVRCD,WRORC010
          STRIP     PMHCGNAM
          STRIP     PMHCSNAM
          STRIP     PMHCTITL
          MATCH     SP70,PMHCPRV1
          IF        @EQUAL
            CALL      GPRAC000
          ENDIF
          SQUEEZE   PMHCPRV1
          MATCH     SP70,WBSEDOC
          IF        @EQUAL
            PACK      ORCSEQ10,WBSEUID,CARAT,WBSENAM,SP70
            PACK      ORCSEQ12,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
          ELSE
            PACK      ORCSEQ10,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
            PACK      ORCSEQ12,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
          ENDIF
.
WRORC010  STRIP     ORCSEQ01
          STRIP     ORCSEQ02
          REP       " 0",ORCSEQ02
          STRIP     ORCSEQ05
          STRIP     ORCSEQ10
          STRIP     ORCSEQ12
.
          WRITE     ORDRFILE,SEQ;*+,ORC,PIPE:
                                 *+,ORCSEQ01,PIPE:
                                 *+,ORCSEQ02,PIPE: * Order Number
                                 *+,PIPE: * 3
                                 *+,ORCSEQ04,PIPE: * Order Group
                                 *+,ORCSEQ05,PIPE: * Order Status
                                 *+,PIPE: * 6
                                 *+,PIPE: * 7
                                 *+,PIPE: * 8
                                 *+,PIPE: * 9
                                 *+,ORCSEQ10,PIPE:
                                 *+,PIPE: *11
                                 *+,ORCSEQ12
.
WRORC999  RETURN
+
.------------------------------------------------------------------------------
.  write PV1
.------------------------------------------------------------------------------
WRPVI000  
          PACK      PV1SEQ01,SP70                 * set id - pv1
          PACK      PV1SEQ02,SP70                 * patient class
          PACK      PV1SEQ03,SP70                 * assigned patient location
          PACK      PV1SEQ09,SP70                 * consulting doctor
          PACK      PV1SEQ16,SP70                 * vip indicator
          PACK      PV1SEQ20,SP70                 * financial class
          PACK      PV2SEQ09,SP70                 * expected discharge
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1            * Check for Visit No 
          BRANCH    OVRCD,WRPVI090     * Not Valid
          BRANCH    PVITYPE,WRPVI010:               * EMR
                            WRPVI020:               * Outpatient
                            WRPVI030:               * Inpatient         
                            WRPVI070:               * Other financial
                            WRPVI070:               * day center
                            WRPVI070:               * community health
                            WRPVI070:               * ward attenders
                            WRPVI070:               * ad-hoc attendees
                            WRPVI070:               * event
                            WRPVI070                * allied health
                              
.                                                 * populate patient class
.
WRPVI010  PACK      PV1SEQ02,ANSE                 * emergency
          PACK      PV1SEQ03,EMVISITE,CARAT,CARAT,EMVILOCN,CARAT,PMVXMHOS,AMPERSAN,PMVXMHOS
          SQUEEZE   PV1SEQ03
          GOTO      WRPVI090
.
WRPVI020  PACK      PV1SEQ02,ANSO                 * outpatient
          GOTO      WRPVI090
.
WRPVI030  PACK      PV1SEQ02,ANSI                 * inpatient
          GOTO      WRPVI070
.
WRPVI040  PACK      PV1SEQ02,ANSP                 * preadmit
          GOTO      WRPVI070
.         
WRPVI050  PACK      PV1SEQ02,ANSR                 * recurring patient
          GOTO      WRPVI090
.
WRPVI060  PACK      PV1SEQ02,ANSB                 * obstetrics
          GOTO      WRPVI070
.
WRPVI070  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,WRPVI090
          PACK      PV1SEQ03,AWARD,CARAT,CARAT,ABED,CARAT,PMVXMHOS,AMPERSAN,PMVXMHOS
          SQUEEZE   PV1SEQ03
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            PACK      PV1SEQ03,PV1SEQ03,CARAT,CARAT,CARAT,CARAT,CARAT,WBDESC
            STRIP     PV1SEQ03
          ENDIF
          PACK      PV1SEQ01,ONE,SP70             * populate set id
.
          CALL      GETEDD00                      * get expected discharge date
.
WRPVI090  PACK      KEY10,USERID,SP70   * get hcp who requested the order
          CALL      RDWBSE1
          IF        OVRCD=0   
            PACK      KEY10,WBSEDOC
            CALL      RDPMHCP1
            IF        OVRCD <> 1
              STRIP     PMHCGNAM
              STRIP     PMHCSNAM
              STRIP     PMHCTITL
              MATCH     SP70,PMHCPRV1
              IF        @EQUAL
                CALL      GPRAC000
              ENDIF
              MATCH     SP70,PMHCPRV1
              IF        !@EQUAL
                SQUEEZE   PMHCPRV1
                PACK      PV1SEQ09,PMHCPRV1,CARAT,PMHCSNAM,CARAT,PMHCGNAM,CARAT,CARAT,CARAT,PMHCTITL,SAUSPROV
              ENDIF
            ENDIF
          ENDIF
.
          PACK      PV1SEQ20,ACLAIM,SP70          * populate financial class
.
          STRIP     PV1SEQ01
          STRIP     PV1SEQ02
          STRIP     PV1SEQ03
          STRIP     PV1SEQ09
          STRIP     PV1SEQ16
          STRIP     PV1SEQ20
.
          WRITE     ORDRFILE,SEQ;*+,PV1,PIPE:
                                 *+,PV1SEQ01,PIPE:
                                 *+,PV1SEQ02,PIPE:
                                 *+,PV1SEQ03,PIPE:
                                 *+,PIPE: * 4
                                 *+,PIPE: * 5
                                 *+,PIPE: * 6
                                 *+,PIPE: * 7
                                 *+,PIPE: * 8
                                 *+,PV1SEQ09,PIPE:
                                 *+,PIPE: * 10
                                 *+,PIPE: * 11
                                 *+,PIPE: * 12
                                 *+,PIPE: * 13
                                 *+,PIPE: * 14
                                 *+,PIPE: * 15
                                 *+,PV1SEQ16,PIPE:
                                 *+,PIPE: * 17
                                 *+,PIPE: * 18
                                 *+,PIPE: * 19
                                 *+,PV1SEQ20
.
          STRIP     PV2SEQ09
.
          WRITE     ORDRFILE,SEQ;*+,PV2,PIPE:
                                 *+,PIPE: * 1
                                 *+,PIPE: * 2
                                 *+,PIPE: * 3
                                 *+,PIPE: * 4
                                 *+,PIPE: * 5
                                 *+,PIPE: * 6
                                 *+,PIPE: * 7
                                 *+,PIPE: * 8
                                 *+,PV2SEQ09,PIPE
WRPVI999  RETURN
.------------------------------------------------------------------------------
.  get expected discharge date and time for PV2SEQ09
.------------------------------------------------------------------------------
GETEDD00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          BRANCH    OVRCD,GETEDD99
.
          MATCH     SP70,PMWOEDAT
          IF        !@EQUAL
            PACK      PV2SEQ09,PMWOEDAT
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              UNPACK    PMWOEDTM,CHOUR,KEY1,CMIN,KEY1,CSEC
              PACK      PV2SEQ09,PMWOEDAT,CHOUR,CMIN,CSEC
            ENDIF
          ENDIF
.
GETEDD99  RETURN
.------------------------------------------------------------------------------
.  write IN1
.------------------------------------------------------------------------------
WRINI000  MOVE      "1",IN1SEQ01                  * set id - in1
          PACK      IN1SEQ02,SP70                 * insurance plan id
          PACK      IN1SEQ03,SP70                 * insurance company id
          PACK      IN1SEQ36,SP70                 * policy number
          BRANCH    PVITYPE,WRINI110:               * EMR
                            WRINI120:               * Outpatient
                            WRINI130                * Inpatient         
          GOTO      WRINI190
.                                                   * populate patient class
WRINI110  MOVE      EMVITABL,DIM8                * Emergency
          MOVE      EMVIFUND,DIM6              
          GOTO      WRINI200
.
WRINI120  MOVE      OTBBTBLE,DIM8                * O/P
          MOVE      OTBBFUND,DIM6              
          GOTO      WRINI200
.
WRINI130  MOVE      AFNDTB,DIM8                  * I/P
          MOVE      AFUNDH,DIM6              
          GOTO      WRINI200
.
WRINI190  MOVE      PFNDTB,DIM8                  * other fall back to master
          MOVE      PFUNDH,DIM6              
          GOTO      WRINI200
.
WRINI200  MATCH     SP8,DIM8                     * blank H.F. table ?
          IF        @EQUAL
            MOVE      BLANKSTR,IN1SEQ02          * yes
          ELSE
            MOVE      DIM8,FIELDSTR
            CALL      SPCHR000                   * convert special characters
            MOVE      FIELDSTR,IN1SEQ02          * set insurance plan id
            ENDSET    IN1SEQ02
            APPEND    CARAT,IN1SEQ02
            APPEND    CARAT,IN1SEQ02
            APPEND    "webPAS",IN1SEQ02
            RESET     IN1SEQ02
          ENDIF
.
          MATCH     SP6,DIM6                     * blank H.F. ?
          IF        @EQUAL
            MOVE      BLANKSTR,IN1SEQ03          * yes
          ELSE
            MOVE      DIM6,FIELDSTR
            CALL      SPCHR000                   * convert special characters
            MOVE      FIELDSTR,IN1SEQ03          * set insurance company id
          ENDIF
.
          MATCH     SP70,PMVXFNDM                * blank H.F. Policy No.?
          IF        @EQUAL
            MOVE      BLANKSTR,IN1SEQ36          * yes
          ELSE
            MOVE      PMVXFNDM,FIELDSTR
            CALL      SPCHR000                   * convert special characters
            MOVE      FIELDSTR,IN1SEQ36          * set policy number
          ENDIF
.
          STRIP     IN1SEQ01
          STRIP     IN1SEQ02
          STRIP     IN1SEQ03
          STRIP     IN1SEQ36
.
          WRITE     ORDRFILE,SEQ;*+,IN1,PIPE:
                                 *+,IN1SEQ01,PIPE:
                                 *+,IN1SEQ02,PIPE:
                                 *+,IN1SEQ03,PIPE:
                                 *+,PIPE: * 4
                                 *+,PIPE: * 5
                                 *+,PIPE: * 6
                                 *+,PIPE: * 7
                                 *+,PIPE: * 8
                                 *+,PIPE: * 9
                                 *+,PIPE: * 10
                                 *+,PIPE: * 11
                                 *+,PIPE: * 12
                                 *+,PIPE: * 13
                                 *+,PIPE: * 14
                                 *+,PIPE: * 15
                                 *+,PIPE: * 16
                                 *+,PIPE: * 17
                                 *+,PIPE: * 18
                                 *+,PIPE: * 19
                                 *+,PIPE: * 20
                                 *+,PIPE: * 21
                                 *+,PIPE: * 22
                                 *+,PIPE: * 23
                                 *+,PIPE: * 24
                                 *+,PIPE: * 25
                                 *+,PIPE: * 26
                                 *+,PIPE: * 27
                                 *+,PIPE: * 28
                                 *+,PIPE: * 29
                                 *+,PIPE: * 30
                                 *+,PIPE: * 31
                                 *+,PIPE: * 32
                                 *+,PIPE: * 33
                                 *+,PIPE: * 34
                                 *+,PIPE: * 35
                                 *+,IN1SEQ36
.
WRINI999  RETURN
.------------------------------------------------------------------------------
. write PID line
.------------------------------------------------------------------------------
WRPID000  PACK      PIDSEQ01,SP70                 * set id
          PACK      PIDSEQ02,SP70                 * patient id (external)
          PACK      PIDSEQ03,SP70                 * patient id (internal)
          PACK      PIDSEQ04,SP70                 * alternate patient id - pid   
          PACK      PIDSEQ05,SP70                 * patient name
          PACK      PIDSEQ07,SP70                 * date time of birth
          PACK      PIDSEQ08,SP70                 * sex
          PACK      PIDSEQ11,SP70                 * patient address
          PACK      PIDSEQ13,SP70                 * phone number - home
          PACK      PIDSEQ14,SP70                 * phone number - business
.
          APPEND    PURNO,PIDSEQ03
          APPEND    "^^^WEBPAS^MR",PIDSEQ03
.
.  
          MATCH     SP70,PMEDI
          IF        !@EQUAL
            STRIP     PMEDI
            APPEND    TILDA,PIDSEQ03
            APPEND    PMEDI,PIDSEQ03
            MATCH     SP2,PTMXMCCD
            IF        !@EQUAL
              SQUEEZE   PTMXMCCD
              APPEND    PTMXMCCD,PIDSEQ03
            ENDIF
            APPEND    "^^^AUSHIC^MC",PIDSEQ03
          ENDIF
.         
          CALL      ADCCD000
.
          MOVE      PURNO,PCKDURNO
          SQUEEZE   PCKDURNO
          STRIP     PCKDURNO
          STRIP     PSNAME
          STRIP     PGNAME
.
          UNPACK    PTELEP,DIM2,DIM8
          MATCH     "0",DIM2
          IF        !@EQUAL
            PACK      DIM8,PTELEP 
            PACK      DIM2,SP70
          ENDIF
.          
          UNPACK    PTELEB,DIM2A,DIM8A
          MATCH     "0",DIM2A
          IF        !@EQUAL
            PACK      DIM8A,PTELEB
            PACK      DIM2A,SP70
          ENDIF
.          
          PACK      PIDSEQ01,ONE
          PACK      PIDSEQ02,PCKDURNO
          PACK      PIDSEQ04,BLANK
          PACK      PIDSEQ05,PSNAME,CARAT,PGNAME,CARAT,CARAT,CARAT,PTITL,CARAT,CARAT,ANSL
          PACK      PIDSEQ07,PBDATE
          PACK      PIDSEQ08,PSEX
          STRIP     PADD1
          STRIP     PADD2
          STRIP     PSUBRB
          STRIP     PADD4
          STRIP     PPOST
          STRIP     DIM2
          STRIP     DIM2A
          SQUEEZE   DIM8
          SQUEEZE   DIM8A
          PACK      PIDSEQ11,PADD1,CARAT,PADD2,CARAT,PSUBRB,CARAT,PADD4,CARAT,PPOST
..          PACK      PIDSEQ13,PRN,CARAT,XTNPH,CARAT,CARAT,CARAT,DIM2,CARAT,DIM8
..          PACK      PIDSEQ14,WPN,CARAT,XTNPH,CARAT,CARAT,CARAT,DIM2A,CARAT,DIM8A
. Removed PRN/WPN identified for Sonic System? 
          PACK      PIDSEQ13,CARAT,XTNPH,CARAT,CARAT,CARAT,DIM2,CARAT,DIM8
          PACK      PIDSEQ14,CARAT,XTNPH,CARAT,CARAT,CARAT,DIM2A,CARAT,DIM8A
.
          STRIP     PIDSEQ01
          STRIP     PIDSEQ02
          STRIP     PIDSEQ03
          STRIP     PIDSEQ04
          STRIP     PIDSEQ05
          STRIP     PIDSEQ07
          STRIP     PIDSEQ08
          STRIP     PIDSEQ11
          STRIP     PIDSEQ13
          STRIP     PIDSEQ14
.
          WRITE     ORDRFILE,SEQ;*+,PID,PIPE:
                                  *+,PIDSEQ01,PIPE:
                                  *+,PIDSEQ02,PIPE:
                                  *+,PIDSEQ03,PIPE:
                                  *+,PIDSEQ04,PIPE:
                                  *+,PIDSEQ05,PIPE:
                                  *+,PIPE: * 6
                                  *+,PIDSEQ07,PIPE:
                                  *+,PIDSEQ08,PIPE:
                                  *+,PIPE: * 9
                                  *+,PIPE: * 10
                                  *+,PIDSEQ11,PIPE:
                                  *+,PIPE: * 12
                                  *+,PIDSEQ13,PIPE:
                                  *+,PIDSEQ14

.
WRPID999  RETURN
+
.------------------------------------------------------------------------------
. write message header
.------------------------------------------------------------------------------
.
WRMSH000  MOVE      ZERO,EXIT
          PACK      MSHSEQ01,SP70                           * field seperator
          PACK      MSHSEQ02,SP70                           * encoding characters
          PACK      MSHSEQ03,SP70                           * sending application
          PACK      MSHSEQ04,SP70                           * sending facility
          PACK      MSHSEQ05,SP70                           * receiving application
          PACK      MSHSEQ06,SP70                           * receiving facility
          PACK      MSHSEQ07,SP70                           * date time of message
          PACK      MSHSEQ09,SP70                           * message type
          PACK      MSHSEQ10,SP70                           * message control id
          PACK      MSHSEQ11,SP70                           * process id
          PACK      MSHSEQ12,SP70                           * version id
          PACK      MSHSEQ13,SP70                           * sequence number
          PACK      MSHSEQ15,SP70                           * accept ack
          PACK      MSHSEQ16,SP70                           * application ack
          PACK      MSHSEQ17,SP70                           * country code
.
          CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS
          UNPACK    CTIMEIS,CHOUR,DIM1,CMIN,DIM1,CSEC
          PACK      DATETIME,CCC,CYY,CMM,CDD,CHOUR,CMIN,CSEC
          REP       " 0",DATETIME
.
          CALL      STRMSH00            * strip trailing spaces for MSH
.
          MOVE      CAPPRVNO,MSHSEQ04            * set sending facility
          CALL      GFAC0000
.
          PACK      MSHSEQ02,ENCDCHAR
          PACK      MSHSEQ03,PTCNRSAP
          PACK      MSHSEQ05,RELBSAP
          PACK      MSHSEQ06,RELBDES
          PACK      MSHSEQ07,DATETIME
          PACK      MSHSEQ09,MSGTYPE  *ok
          UNPACK    PTCNRMIC,KEY5,KEY7
          PACK      MSHSEQ10,KEY7 *ok
          PACK      MSHSEQ11,PROCID   *ok
          PACK      MSHSEQ12,HL7V
          PACK      MSHSEQ13,KEY7 
          PACK      MSHSEQ17,CTRYCODE
          MOVE      "NE",MSHSEQ15
          MOVE      "AL",MSHSEQ16
          CALL      MSHCTA00
          STRIP     MSHSEQ04
          STRIP     MSHSEQ05
          STRIP     MSHSEQ06
          STRIP     MSHSEQ13
          STRIP     MSHSEQ15
          STRIP     MSHSEQ16
.
          WRITE     ORDRFILE,SEQ;*+,MSH,PIPE:
                                 *+,MSHSEQ02,PIPE:
                                 *+,MSHSEQ03,PIPE:
                                 *+,MSHSEQ04,PIPE:
                                 *+,MSHSEQ05,PIPE:
                                 *+,MSHSEQ06,PIPE:
                                 *+,MSHSEQ07,PIPE:
                                 *+,PIPE:      *8
                                 *+,MSHSEQ09,PIPE:
                                 *+,MSHSEQ10,PIPE:
                                 *+,MSHSEQ11,PIPE:
                                 *+,MSHSEQ12,PIPE:
                                 *+,MSHSEQ13,PIPE:  * 13
                                 *+,PIPE:      * 14
                                 *+,MSHSEQ15,PIPE:  * 15
                                 *+,MSHSEQ16,PIPE:  * 16
                                 *+,MSHSEQ17
.
WRMSH999  RETURN
+
.--------------------------------------------------------------------------------
. Get Message Header field from resctaaf if available
.--------------------------------------------------------------------------------
MSHCTA00  MOVE       "03",KEY2                       * Get MSH-3 Sending Application
          PACK       KEY32,RELBLCD,MSH,KEY2,SP70
          CALL       RSRECT1
          CALL       RKRECT1
          BRANCH     OVRCD,MSHCTA10
          MATCH      RELBLCD,RECTLAB
          GOTO       MSHCTA10 IF NOT EQUAL
          MATCH      MSH,RECTSEG
          GOTO       MSHCTA10 IF NOT EQUAL
          MATCH      "03",RECTFLD
          GOTO       MSHCTA10 IF NOT EQUAL
          MOVE       RECTCOD,MSHSEQ03
.
MSHCTA10  MOVE       "04",KEY2                       * Get MSH-4 Sending Facility Code
          PACK       KEY32,RELBLCD,MSH,KEY2,SP70
          CALL       RSRECT1
          CALL       RKRECT1
          BRANCH     OVRCD,MSHCTA20
          MATCH      RELBLCD,RECTLAB
          GOTO       MSHCTA20 IF NOT EQUAL
          MATCH      MSH,RECTSEG
          GOTO       MSHCTA20 IF NOT EQUAL
          MATCH      "04",RECTFLD
          GOTO       MSHCTA20 IF NOT EQUAL
          MOVE       RECTCOD,MSHSEQ04
.
MSHCTA20  MOVE       "05",KEY2                       * Get MSH-5 Receiving Application Code
          PACK       KEY32,RELBLCD,MSH,KEY2,SP70
          CALL       RSRECT1
          CALL       RKRECT1
          BRANCH     OVRCD,MSHCTA30
          MATCH      RELBLCD,RECTLAB
          GOTO       MSHCTA30 IF NOT EQUAL
          MATCH      MSH,RECTSEG
          GOTO       MSHCTA30 IF NOT EQUAL
          MATCH      "05",RECTFLD
          GOTO       MSHCTA30 IF NOT EQUAL
          MOVE       RECTCOD,MSHSEQ05
.
MSHCTA30  MOVE       "06",KEY2                       * Get MSH-6 Receiving Facility Code
          PACK       KEY32,RELBLCD,MSH,KEY2,SP70
          CALL       RSRECT1
          CALL       RKRECT1
          BRANCH     OVRCD,MSHCTA40
          MATCH      RELBLCD,RECTLAB
          GOTO       MSHCTA40 IF NOT EQUAL
          MATCH      MSH,RECTSEG
          GOTO       MSHCTA40 IF NOT EQUAL
          MATCH      "06",RECTFLD
          GOTO       MSHCTA40 IF NOT EQUAL
          MOVE       RECTCOD,MSHSEQ06
.
MSHCTA40
.
MSHCTA99  RETURN
.
.------------------------------------------------------------
. Strip trailing spaces from MSH fields
.------------------------------------------------------------
STRMSH00  STRIP     PTCNRSAP
          STRIP     PTCNRSFC
          STRIP     PTCNRRAP
          STRIP     PTCNRRFC
          STRIP     PTCNRMIC
          STRIP     PTCNRHLV
STRMSH99  RETURN
+
.------------------------------------------------------------
. Generate next message ID
.------------------------------------------------------------
GMESID00  MOVE      ZERO,F12
          MOVE      "114",PRXCODE   * System Lock Sector 114
          CALL      GETSLK00        * Get System Lock of Sector 114
          READ      CONTROLF,HUND14;*119,PTCNRMIC
          MOVE      PTCNRMIC,F12
          ADD       ONE,F12
          MOVE      F12,PTCNRMIC
          WRITAB    CONTROLF,HUND14;*119,PTCNRMIC
          CALL      RELSLK00        * Release System Lock of Sector 10
          SUB       ONE,F12
          MOVE      F12,PTCNRMIC
          REP       " 0",PTCNRMIC
.
          COMPARE   ZERO,F12
          GOTO      GMESID00 IF EQUAL       * invalid number
.
GMESID99  RETURN
+
.------------------------------------------------------------------------------
. create hl7 order text file
.------------------------------------------------------------------------------
CREAT000  UNPACK    PTCNRMIC,KEY7,KEY5
          PACK      FILENAME,ORDERSFL,KEY5
          REP       " 0",FILENAME
          CLOSE     ORDRFILE
          PREP      ORDRFILE,FILENAME
+
CREAT999  RETURN
.------------------------------------------------------------------------------
. add clinical notes
.------------------------------------------------------------------------------
ADDCL000  PACK      KEY17,REHARDT,REHARTM,REHARUN
          CALL      RAREHD1
          COMPARE   ZERO,OVRCD
          GOTO      ADDCL999 IF EQUAL
          MOVE      REHARDT,REHDRDT
          MOVE      REHARTM,REHDRTM
          MOVE      REHARUN,REHDRUN
          PACK      REHDRCI,SP70,SP70,SP70,SP70,SP70
          SFORMAT   OUTVAR,127
          MATCH     SP70,NOTETEXT[001]      * If FF Note is Empty ?
          GOTO      ADDCL999 IF EQUAL
          CLEAR     REHDRCI
          MOVE      ZERO,F3
ADDCL100  ADD       ONE,F3
          IF        F3<=LASTITEM
            MATCH     "Request Items:",NOTETEXT[F3]
            GOTO      ADDCL200 IF EQUAL
            IF        F3>1
              APPEND    COMMA,REHDRCI
              APPEND    SP1,REHDRCI
            ENDIF
            MOVE      NOTETEXT[F3],OUTVAR
            STRIP     OUTVAR
            MOVELPTR  OUTVAR,LENGTH
            COMPARE   LENGTH,ZERO
            IF        @EQUAL
              MOVE      ONE,LENGTH
            ENDIF
            SFORMAT   VAR,LENGTH
            MOVE      OUTVAR,VAR
            APPEND    VAR,REHDRCI
            SFORMAT   VAR,127
            SFORMAT   OUTVAR,127
            GOTO      ADDCL100
          ENDIF
.
ADDCL200  RESET     REHDRCI
          CALL      WRREHD1             * write clinical details to clinical
.                                       * results relevant clinical information
ADDCL999  RETURN
+
.------------------------------------------------------------------------------
. copies to 
.------------------------------------------------------------------------------
COPYT000  MOVE      ZERO,COPTOCNT
          
COPYT100  ADD       ONE,COPTOCNT
          IF        COPTOCNT>COPTOEND
            GOTO      COPYT900
          ENDIF
.
          MATCH     SP70,COPIESTO[COPTOCNT]
          GOTO      COPYT100 IF EQUAL
.
          MOVE      COPTOCNT,FORM2
          PACK      REHCRDT,REHARDT,SP70
          PACK      REHCRTM,REHARTM,SP70
          PACK      REHCRUN,REHARUN,SP70     
          MOVE      FORM2,REHCCNO
          PACK      REHCCTO,COPIESTO[COPTOCNT],SP70   * what are we storing?
.
          PACK      DIM127A,SP70,SP70
          PACK      DIM127A,COPIESTO[COPTOCNT],SP70
.
          SCAN      "^",DIM127A
          IF        @EQUAL
            MOVEFPTR  DIM127A,LENGTH
            SUB       ONE,LENGTH
            IF        LENGTH>0
              RESET     DIM127A
              SFORMAT   VAR,LENGTH
              MOVE      DIM127A,VAR
              PACK      DIM10,VAR,SP70
.
              PACK      KEY8,URNUMBER,SP70
              CALL      RDPMPX21
              IF        OVRCD=0
                MATCH     DIM10,PMPXRHC1
                IF        @EQUAL
                  MATCH     SP70,PMPXRH1G
                  IF        !@EQUAL & !@EOS
                    PACK      KEY20,PMPXRHC1,PMPXRH1G,SP70
                    CALL      RDPMHCL1
                    IF        OVRCD=0
                      MOVE      "^",DIM1
                      PACK      REHCCTO,COPIESTO[COPTOCNT],DIM1,PMHLPRV1,SP70
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
COPYT200  PACK      KEY19,REHARDT,REHARTM,REHARUN,FORM2,SP70
          CALL      RAREHC1
          IF        OVRCD = 1
            CALL      WRREHC1
            GOTO      COPYT100
          ENDIF
.
COPYT900  MOVE      ZERO,EXIT
.
COPYT999  RETURN
.------------------------------------------------------------
. ADD Concession Card details
.         Set Pension Number using concession card, if one exists, or
.         default to patma1af.ppenno
.------------------------------------------------------------
ADCCD000  MOVE      FOUR,CARDTYPE                * set for pension card type
          CALL      CONCD000                     * pension conc card ?
          BRANCH    EXIT,ADCCD010                * no
.
          APPEND    TILDA,PIDSEQ03
          MOVE      DIM20,FIELDSTR
          GOTO      ADCCD011
.
ADCCD010  MATCH     SP15,PPENNO                  * default pension number ?
          GOTO      ADCCD020 IF EQUAL            * no
.
          APPEND    TILDA,PIDSEQ03
          MOVE      PPENNO,FIELDSTR
.
ADCCD011  CALL      SPCHR000                     * convert special characters
          APPEND    FIELDSTR,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    "PEN",PIDSEQ03
.
.         Set DVA Number using concession card, if one exists
.
ADCCD020  MOVE      THREE,CARDTYPE               * set for DVA card type
          CALL      CONCD000                     * DVA conc card ?
          BRANCH    EXIT,ADCCD030                * no
.
          APPEND    TILDA,PIDSEQ03
          MOVE      DIM20,FIELDSTR
.
          CALL      SPCHR000                     * convert special characters
          APPEND    FIELDSTR,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    "AUSDVA",PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    "DV",PIDSEQ03
.
.         Set Safety Net Number using concession card, if one exists
.
ADCCD030  MOVE      TWO,CARDTYPE                 * set for safety net card type
          CALL      CONCD000                     * safety net conc card ?
          BRANCH    EXIT,ADCCD900                * no
.
          APPEND    TILDA,PIDSEQ03
          MOVE      DIM20,FIELDSTR
          CALL      SPCHR000                     * convert special characters
          APPEND    FIELDSTR,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    CARAT,PIDSEQ03
          APPEND    "SN",PIDSEQ03
.
ADCCD900  RESET     PIDSEQ03
          SQUEEZE   PIDSEQ03                       * remove blanks
          RETURN
.
.*****************************************************************************
.*                              CONCD000           Called by: ADCCD000       *
.*     See if the patient has concession card of a given type on file        *
.* Requires: CARDTYPE - Concession Card Type                                 *
.*                      2 = Safety Net                                       *
.*                      3 = DVA                                              *
.*                      4 = Pension                                          *
.*           DATETIME - date/time (ccyymmddhhmmss)                           *
.*           PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.         
CONCD000  MOVE      SP70,DIM20
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CONCD050  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CONCD910               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CONCD910 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA or Pension (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CONCD050               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CONCD050 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CONCD050 IF NOT EQUAL        * no - ignore record
.
          MOVE      TCINDC1,FORM1
          COMPARE   FORM1,CARDTYPE               * same concession card type ?
          GOTO      CONCD050 IF NOT EQUAL        * no - ignore record
.
.         A concession card of the same type has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CONCD100 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          MOVE      DATETIME,DIM8
          MATCH     DATETIME,PMCDEXDT            * card valid for date ?
          GOTO      CONCD910 IF LESS             * no - nothing found
.
.         Concession card is current
.
CONCD100  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CONCD910 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,EXIT
          GOTO      CONCD999
.
CONCD910  MOVE      ONE,EXIT
.
CONCD999  RETURN
.*****************************************************************************
.*                           SPCHR000              Called by: Lots           *
.*        Check for special HL7 characters, and if found, convert to         *
.*        the corresponding escape sequence:                                 *
.*        Field Separator         "|" becomes "\F\"                          *
.*        Component separator     "^" becomes "\S\"                          *
.*        Sub-component separator "&" becomes "\T\"                          *
.*        Repetition separator    "~" becomes "\R\"                          *
.*        Escape character        "\" becomes "\E\"                          *
.* Requires: FIELDSTR - raw field string                                     *
.* Returns : FIELDSTR - field string with converted HL7 special characters   *
.*                      and stripped of trailing blanks                      *
.*****************************************************************************
SPCHR000  STRIP     FIELDSTR                     * remove trailing spaces
          MOVELPTR  FIELDSTR,FORM3               * get string length
          COMPARE   ZERO,FORM3                   * string length zero ?
          GOTO      SPCHR999 IF EQUAL            * yes - ignore
.
          MOVE      SP30,STRBUFFR                * clear the temporary string
          CLEAR     STRBUFFR
.
.         Loop through the field string checking each character to see
.         if it is a HL7 special character
.
SCHR0500  MOVE      FIELDSTR,ANS                 * load the next character
.
.         Check if character is a pipe
.
          MATCH     PIPE,ANS                     * is character "|" ?
          IF        @EQUAL
            APPEND    PIPESEQN,STRBUFFR          * yes - load "\F\"
            GOTO      SPCHR100                   * get next character
          ENDIF
.
.         Check if character is a caret
.
          MATCH     CARAT,ANS                    * is character "^" ?
          IF        @EQUAL
            APPEND    CARTSEQN,STRBUFFR          * yes - load "\S\"
            GOTO      SPCHR100                   * get next character
          ENDIF
.
.         Check if character is an ampersand
.
          MATCH     AMPRSAND,ANS                 * is character "&" ?
          IF        @EQUAL
            APPEND    AMPRSEQN,STRBUFFR          * yes - load "\T\"
            GOTO      SPCHR100                   * get next character
          ENDIF
.
.         Check if character is a tilda
.
          MATCH     TILDA,ANS                    * is character "~" ?
          IF        @EQUAL
            APPEND    TILDSEQN,STRBUFFR          * yes - load "\R\"
            GOTO      SPCHR100                   * get next character
          ENDIF
.
.         Check if character is a backslash
.
          MATCH     "\",ANS                      * is character "\" ?
          IF        @EQUAL
            APPEND    BSLASEQN,STRBUFFR          * yes - load "\E\"
            GOTO      SPCHR100                   * get next character
          ENDIF
.
.         No HL7 special characters were found, so load this character
.         into the temporary string
.
          APPEND    ANS,STRBUFFR
.
SPCHR100  BUMP      FIELDSTR                     * position on next character
          GOTO      SPCHR900 IF EOS              * eos - finished
          GOTO      SCHR0500
.
SPCHR900  RESET     STRBUFFR
          MOVE      STRBUFFR,FIELDSTR
.
SPCHR999  RETURN
.
.*****************************************************************************
.*                           GFAC0000              Called by: WMSH0000       *
.*              Get the sending facility for a multi hospital environment    *
.*****************************************************************************
.
GFAC0000  COMPARE   ONE,IBCNMHOS                 * using multi-hospital ?
          GOTO      GFAC9999 IF NOT EQUAL        * no
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1            * Check for Visit No 
          BRANCH    OVRCD,GFAC9999     * Not Valid
.
          BRANCH    PVITYPE,GFAC1000,GFAC1000,GFAC1000
.
. Visit 
.-----------
GFAC1000  MOVE      ADMISSNO,KEY8                * load visit number
          CALL      RDPMVX11                     * visit on file ?
          BRANCH    OVRCD,GFAC9999               * no - use default parameter
          MATCH     SP3,PMVXMHOS                 * blank hospital id ?
          GOTO      GFAC9999 IF EQUAL            * yes - use default parameter
          MOVE      PMVXMHOS,KEY3                * load hospital key
          GOTO      GFAC9000
.
. Inpatient
.-----------
GFAC2000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GFAC9999
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1                      * ward on file ?
          BRANCH    OVRCD,GFAC9999               * no - use default parameter
.                            
          MATCH     SP3,PTWDHOSN                 * hospital code blank ?
          GOTO      GFAC9999 IF EQUAL            * yes - use default parameter
.                            
          MOVE      PTWDHOSN,KEY3                * set hospital key
.                            
GFAC9000  CALL      RDPTHSP1                     * hospital code on file ?
          BRANCH    OVRCD,GFAC9999               * no - use default parameter
.
          MOVE      PTHSAPPR,FIELDSTR            * set sending facility
          CALL      SPCHR000                     * convert special characters
          MOVE      FIELDSTR,MSHSEQ04
.
GFAC9999  RETURN
.
NEWMED00  PACK      KEY11,ADMISSNO,SP70
          CALL      RSOBMED1
          CALL      RKOBMED1
          BRANCH    OVRCD,NEWMED50
.
          MATCH     ADMISSNO,OBMEVISN
          GOTO      NEWMED50 IF NOT EQUAL
.
          PACK      KEY11,OBMEVISN,OBMECNTR,SP70
          CALL      DEOBMED1
          GOTO      NEWMED20
.
NEWMED50  MOVE      ZERO,F3
          MOVE      ZERO,MEDCOUNT
          WHILE     F3<LASTDRUG
            ADD       ONE,F3
            CALL      CLOBSMED              * Clear File Variables
            CALL      SAVMED00              * Moving Cgi variables To File Var.
.
            MATCH     SP70,OBMEDRUG
            IF        !@EQUAL
              ADD       ONE,MEDCOUNT
              MOVE      MEDCOUNT,OBMECNTR
              PACK      KEY11,ADMISSNO,OBMECNTR,SP70
              CALL      RAOBMED1
              IF        OVRCD=1
                CALL      WROBMED1        * Write to Observation medication table
              ELSE
                CALL      UPOBMED1        * Update to Observation medication table
              ENDIF
            ENDIF
          DO
.
NEWMED99  RETURN
.
.------------------------------------------------------------
. Write Audit Record
.------------------------------------------------------------
NEWAUD00  PACK      REAUSDT,CCC,CYY,CMM,CDD
          REP       " 0",REAUSDT
          CLOCK     TIME,REAUSTM
          MOVE      WBSEUID,REAUUID
NEWAUD10  PACK      KEY40,REHARDT,REHARTM,REHARUN,REAUSDT,REAUSTM,REAUUID,SP70
          UNPACK    KEY40,REAURDT,REAURTM,REAURUN,REAUSDT,REAUSTM,REAUUID
          MOVE      REHARST,REAURST
          MOVE      ZERO,REAUMRK
          MOVE      SP70,REAUACD
          MOVE      SP70,REAUACM
          MOVE      SP70,REAUSPA
.
          PACK      RESLNKFL,PREAEA,REAURDT  
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESAUDA1,RESLNKFL
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      NEWAUD99 IF EQUAL       
.
          CALL      RAREAU1
          IF        OVRCD=0
            UNPACK    REAUSTM,AUDHRS,KEY1,AUDMIN
            MOVE      AUDMIN,F2
            ADD       ONE,F2
            PACK      REAUSTM,AUDHRS,KEY1,F2
            REP       " 0",REAUSTM
            GOTO      NEWAUD10
          ELSE
            TRAP      OVERCOND IF IO
            CALL      WRREAU1
            TRAPCLR   IO
          ENDIF
NEWAUD99  RETURN
.------------------------------------------------------------
. Display Table of EMR Disposition Plan Notes
.---------------------------------------------------------------------
DSPTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      DSPHD000      * Output Table Heading
.
          MOVE      ADMISSNO,VSMDVISN
.
          IF        NOTEORDR=0
            PACK      KEY17,ADMISSNO,ZERO,ONE,TWO,Z70
          ELSE
            PACK      KEY17,ADMISSNO,ZERO,ONE,ONE,SP70
          ENDIF
.
          CALL      RSVSMDT1
DSPTAB10  IF        NOTEORDR=0
            CALL      RPVSMDT1
          ELSE
            CALL      RKVSMDT1
          ENDIF
          BRANCH    OVRCD,DSPTAB99
.
          MATCH     ADMISSNO,VSMDVISN
          GOTO      DSPTAB99 IF NOT EQUAL
.
          MATCH     "011",VSMDTYPE
          IF        !@EQUAL
            MATCH     "012",VSMDTYPE
            IF        !@EQUAL
              GOTO      DSPTAB99
            ENDIF
          ENDIF
.
          MATCH     VSMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp;",FBOKDATE
            GOTO     DSPTAB40
          ENDIF
.
          UNPACK    VSMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
DSPTAB40  MATCH     "1",VSMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       SP70,STRIKETG
            MOVE       SP70,STRENDTG
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",VSMDTYPE
          REP       " +",VSMDNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail06":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&admissno=",ADMISSNO:
                             "&notetype=",VSMDTYPE:
                             "&notenumb=",VSMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,VSMDTIME,"</td>";
.
          MATCH     "011",VSMDTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",STRIKETG,"Emergency Dis. Disposition Plan",STRENDTG,"</td>";
          ELSE
            MATCH     "012",VSMDTYPE
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>",STRIKETG,"Emergency Adm. Disposition Plan",STRENDTG,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",STRIKETG,"Unknown Disposition Plan",STRENDTG,"</td>";
            ENDIF
          ENDIF 
.
          PACK      KEY10,VSMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,VSMDUSER," - ",VSMDOCCG,"&nbsp;":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",VSMDTYPE
          REP       "+ ",VSMDNOTE
.
          MOVE      ZERO,CTR
          CALL      VSNOTE00
.
          WRITE     HTMLFILE;STRENDTG,"</td>";
.
          MATCH     "1",VSMDDELT
          IF        @EQUAL
.
            MATCH     VSMDDDAT,SP70
            IF        @EQUAL
              MOVE     "&nbsp;",FDELDATE
              GOTO     DSPTAB80
            ENDIF
.
            UNPACK    VSMDDDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      FDELDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
DSPTAB80    PACK      KEY10,VSMDDUSE,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",WBSENAM," ",FDELDATE," ",VSMDDTIM,"</td>";
            ELSE
            WRITE     HTMLFILE;"<td>",VSMDUSER," ",FDELDATE," ",VSMDDTIM,"</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          GOTO      DSPTAB10
DSPTAB99  RETURN
.------------------------------------------------------------
. Visit Note Heading (TABLE HEADING) EMR Displosition Plan
.------------------------------------------------------------
DSPHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                    "<td class=HeadingCell width=20%>Disposition Template</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=20%>Notes</td>":
                              "<td class=HeadingCell width=20%>Deleted By</td>":
                              "</tr>"
.
DSPHD999  RETURN
.
.------------------------------------------------------------
. Update a Visit Note for a Patient
.-----------------------------------------------------------
UPDNOT00  MATCH     SP70,ADMISSNO
          GOTO      UPDNOT90 IF EQUAL
.
          MOVE      ADMISSNO,VSMDVISN   *  Visit Number
          RJUSTIFY  NOTENUMB
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      RDVSMDT1
          BRANCH    OVRCD,UPDNOT99
.
. ALLOWUPD - Mark orginal notes as deleted and add a new set of notes
.
          MATCH     "1",ALLOWUPD
          IF        @EQUAL
            MOVE      ONE,SUPRFLAG            * Set to supervisor mode
            CALL      DELNOT00                * Flag orginal notes as deleted
            BRANCH    EXIT,UPDNOT99
.
            CALL      ADDNOT00                * Add New Visit Based Notes
            GOTO      UPDNOT98
          ENDIF
.
          MATCH     "1",SUBFINAL
          IF        @EQUAL
            PACK      VSMDDATE,CCC,CYY,CMM,CDD
            REP       " 0",VSMDDATE          * Date
            CLOCK     TIME,VSMDTIME
            MOVE      USERID,VSMDUSER        * User
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,UPDNOT98
            MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          ENDIF
.
          PACK      KEY17,ADMISSNO,NOTETYPE,NOTENUMB,SP70
          CALL      UPVSMDT1               * Write Record
.
UPDNOT40  PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
          CALL      RKVSMTX1
          BRANCH    OVRCD,UPDNOT50          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      UPDNOT50 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      UPDNOT50 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      UPDNOT50 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      UPDNOT40
.
UPDNOT50  MOVE      VSMDVISN,VSMTVISN
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
UPDNOT60  ADD       ONE,F3
          MOVE      F3,VSMTUNIQ
.
          READ      COMFILVF,SEQ;VSMTCMNT
          GOTO      UPDNOT98 IF OVER
.
          MATCH     SP70,VSMTCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,UPDNOT60
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      UPDNOT70                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,UPDNOT60          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      UPDNOT70
          ENDIF
.
          MOVE      ZERO,BLNKFLAG
.
          SCAN      "%diag",VSMTCMNT
          IF        @EQUAL
            MATCH     "1",SUBFINAL
            IF        @EQUAL
              CALL      EMRDIA00
              GOTO      UPDNOT60
            ENDIF
          ENDIF
.
UPDNOT70  PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
          IF        F3>=LASTITEM
            GOTO     UPDNOT98
          ENDIF
.
          GOTO      UPDNOT60
.
UPDNOT90  MOVE      "Admission Number should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDNOT99
.
UPDNOT98  MOVE      ZERO,EXIT
.
UPDNOT99  RETURN
.------------------------------------------------------------
. Cancel Pathology Orders
.------------------------------------------------------------
CANSV000  CALL      GETPAT00
          BRANCH    EXIT,CANSV990
          MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      CLEMRVIS
          ENDIF
          CALL      RDBOKB1
          IF        OVRCD=1
            CALL      CLOUTBB1
          ENDIF
.
          MOVE      RESULTKY,RESULTYR
          CALL      RESOPN00                     * Open result tables
          BRANCH    EXIT,CANSV990
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
          BRANCH    OVRCD,CANSV990
.
          CALL      PROORD00          * Flag all order items as cancelled
.
          PACK      KEY17,RESULTKY,SP70
          CALL      RDREHA1
          BRANCH    OVRCD,CANSV990
.
          MOVE      REHALAB,SERVLABC
.
          PACK      KEY3,REHALAB,SP70
          CALL      RDRELB1
          BRANCH    OVRCD,CANSV990
.
          CALL      GMESID00          * generate next message id PTCNRMIC
          CALL      CREAT000
          CALL      WRMSH000          * write MSH
          CALL      WRPID000          * write PID
.          CALL      WRPVI000          * write PV1&2
.          CALL      WRINI000          * write IN1
          MOVE      "2",ORDERTYP
          CALL      WRORC000          * write OCR Cancel Order
.
          CALL      MTXTHL00          * move hl7 text output
.
CANSV900  MOVE      ZERO,EXIT
          GOTO      CANSV999
.
CANSV990  MOVE      "ERROR: Cannot Process Cancellation Request.",WEBTITLE
          CALL      WEBERR00  * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
.
CANSV999  RETURN
.---------------------------------------------------------------------------
. Process Cancellation
.---------------------------------------------------------------------------
PROORD00  MOVE      REHAFOR,KEY7
          PACK      ORDERNUM,KEY7,SP70
          PACK      APPLICID,REHAFAP,SP70
          PACK      KEY43,APPLICID,ORDERNUM,SP70
          CALL      RSREHA2
PROORD20  CALL      RKREHA2
          BRANCH    OVRCD,PROORD99
          MATCH     APPLICID,REHAFAP     * Placer Order Detail in both Filler and Placer Field
          GOTO      PROORD99 IF NOT EQUAL
          MOVE      REHAFOR,KEY7
          MATCH     ORDERNUM,KEY7
          GOTO      PROORD99 IF NOT EQUAL
          MATCH     REHAPAP,REHAFAP      * Must be the Same for Order
          GOTO      PROORD20 IF NOT EQUAL
          MATCH     REHAPOR,REHAFOR      * Must be the Same for Order
          GOTO      PROORD20 IF NOT EQUAL
          MOVE      "X ",REHARST
          CALL      UPREHA2
          CALL      LNKORD00
          GOTO      PROORD20
.
PROORD99  RETURN
.---------------------------------------------------------------------------
. Update Link Tables with Result Status
.---------------------------------------------------------------------------
LNKORD00  PACK      KEY29,REHARDT,REHARTM,REHARUN,SP70
          PACK      RESLNKFL,PRELEN,KEY29    
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      RESLNKA3,RESLNKFL
          TRAPCLR   IO
.
          CALL      RSRELN3
LNKORD10  CALL      RKRELN3
          BRANCH    OVRCD,LNKORD80
          MATCH     REHARDT,RELNRDT
          GOTO      LNKORD80 IF NOT EQUAL
          MATCH     REHARTM,RELNRTM
          GOTO      LNKORD80 IF NOT EQUAL
          MATCH     REHARUN,RELNRUN
          GOTO      LNKORD80 IF NOT EQUAL   
          MOVE      "X ",RELNRST
          CALL      UPRELN3
          GOTO      LNKORD10
.
LNKORD80  MOVE      REHAPID,KEY8
          PACK      KEY25,KEY8,REHARDT,REHARTM,REHARUN,SP70
          CALL      RDRELU1
          IF        OVRCD=0
            MOVE      "X ",RELURST
            CALL      UPRELU1
          ENDIF
.
LNKORD99  RETURN
.
.------------------------------------------------------------
. CLRDCM00  Clears Variables For EMRDCMFD
.------------------------------------------------------------
CLRDCM00  MOVE      SP70,EMDCADMI
          MOVE      SP70,EMDCTXT1
          MOVE      SP70,EMDCTXT2
          MOVE      SP70,EMDCTXT3
          MOVE      SP70,EMDCTXT4
          MOVE      SP70,EMDCTXT5
          MOVE      SP70,EMDCTXT6
          MOVE      SP70,EMDCTXT7
          MOVE      SP70,EMDCTXT8
          MOVE      SP70,EMDCTXT9
          MOVE      SP70,EMDCLUID
          MOVE      SP70,EMDCSPAR
.
CLRDCM99  RETURN
.------------------------------------------------------------
. FHIR Exit Sucess
.   Return Location Header
.------------------------------------------------------------
FHREXT00  PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,FHREXT99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                             "  #"id#": #"allok#", ":
                             "  #"text#": { ":
                             "    #"status#": #"additional#", ":
                             "    #"div#": #"<div>All Ok</div>#" ":
                             "  }, ":
                             "  #"issue#": [ ":
                             "    { ":
                             "      #"severity#": #"information#", ":
                             "      #"code#": #"informational#", ":
                             "      #"details#": { ":
                             "        #"text#": #"All Ok#"":
                             "  } } ] }"
.
          CALL      CLOSHTML
FHREXT99  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
.
.---------------------------------------------------------------------
. Display Table of Clinical Notes snippet for discharge summary
.---------------------------------------------------------------------
PMSTTB00  MOVE      ZERO,F1                          * No Notes
.
          PACK      KEY14,URNUMBER,Z70
          CALL      RSPMMDT1
PMSTTB10  CALL      RPPMMDT1
          BRANCH    OVRCD,PMSTTB90
.
          MATCH     URNUMBER,PMMDURNO
          GOTO      PMSTTB90 IF NOT EQUAL
.
          MATCH     "1",PMMDDELT
          GOTO      PMSTTB10 IF EQUAL
.
          MOVE      ZERO,F2                           * No div created
.
          PACK      KEY17,PMMDURNO,PMMDNOTE,SP70
          CALL      RSPMMTX1
PMSTTB70  CALL      RKPMMTX1
          BRANCH    OVRCD,PMSTTB80
.
          MATCH     PMMDURNO,PMMTURNO
          GOTO      PMSTTB80 IF NOT EQUAL
.
          MATCH     PMMDNOTE,PMMTNOTE
          GOTO      PMSTTB80 IF NOT EQUAL
.
          MATCH     SP70,PMMTCMNT
          IF        !@EQUAL
            MOVE      ONE,F1                          * Notes exist
          ENDIF
.
          IF        F2=0
            MOVE      ONE,F2                          * Div created
            WRITE     HTMLFILE;"<div class=notetext>";
          ENDIF
.
          WRITE     HTMLFILE;PMMTCMNT,"<br>";
          GOTO      PMSTTB70
.
PMSTTB80  IF        F2=1
            WRITE     HTMLFILE;"</div>";              * End Div
          ENDIF
          GOTO      PMSTTB10
.
PMSTTB90  IF        F1=0
            WRITE     HTMLFILE;"<li style='text-align:center;'>":
                               "No Notes Recorded for this Patient Visit":
                               "</li'>";
          ENDIF
.
PMSTTB99  RETURN
.
          INC       IBAWEBCD
          INC       WEBDATCD
.
          INC       PATWVEIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PMSDAUIO/INC
.
          INC       ALLCASIO/INC
          INC       ALLENCIO/INC
          INC       ALLREFIO/INC
          INC       ALLMDTIO/INC
          INC       ALLMTXIO/INC
          INC       APSMASIO/INC
.
          INC       BOKRC1IO/INC
.
          INC       PATDGWIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PATIN1IO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATDO1IO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATALRIO/INC
          INC       PMSALAIO/INC
          INC       PMSALNIO/INC
          INC       PATASFIO/INC
          INC       PATDSCIO/INC
          INC       PATMI1IO/INC
          INC       PATTRNIO/INC
          INC       PATMMBIO/INC
          INC       PATNURIO/INC
          INC       PATWR1IO/INC
          INC       HL7CODIO/INC
          INC       RESAUDIO/INC
          INC       RESCTAIO/INC
          INC       RESLNKIO/INC
          INC       RESLURIO/INC
          INC       RESHEAIO/INC
          INC       RESHEBIO/INC
          INC       RESHEDIO/INC
          INC       RESHECIO/INC
          INC       PMSCCDIO/INC
          INC       RESLABIO/INC
          INC       OUTSITIO/INC
          INC       PATFN1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
.
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       OBSCNAPR
          INC       OBSCNATM
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATDSCTM
          INC       PATHSPTM
          INC       TFILENAM
          INC       CLPATDSC
          INC       OBSDIATM
          INC       CLOBSMED
.
          INC       PATDOCTM
          INC       DAYOFWEK
          INC       CALCAGE
          INC       NAMSTRCD
          INC       PATMA1IO/INC
          INC       PATCMCIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATRE1IO/INC
          INC       PATATRIO/INC
          INC       PATVISTM
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       EMRDRCHR
          INC       MULBIR00
          INC       PMSPODIO/INC
          INC       PMSPX2IO/INC
          INC       PMSADCIO/INC
          INC       PMSFETIO/INC
.
          INC       CLIPRTCD
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATVIS
          INC       CLPMSHCG
          INC       CLPMSHCP
          INC       CLPMSVX1
          INC       CLPATTRN
          INC       CLEMRVIS
          INC       CLOUTBB1
          INC       EMRUNKIO/INC
          INC       EMRDCMIO/INC            * Diagnosis comment file
          INC       EMRVISIO/INC
          INC       EMRHISIO/INC
          INC       PATHSPIO/INC
          INC       PATPR1IO/INC
          INC       OBSCNBIO/INC
          INC       OBSCNCIO/INC
          INC       OBSCNAIO/INC
          INC       OBSPINIO/INC
          INC       VISCMTIO/INC
          INC       VISCTMIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       OUTMA1IO/INC
          INC       OBSDIAIO/INC
          INC       OBSDITIO/INC
          INC       OBSMEDIO/INC
          INC       OBSPCOIO/INC
          INC       OBSFTXIO/INC
          INC       OBSNDDIO/INC
          INC       OBSPHYIO/INC
          INC       OBSRESIO/INC
          INC       OBSBHIIO/INC
          INC       OBSBPHIO/INC
          INC       OBSLABIO/INC
          INC       OBSCALIO/INC
          INC       OBSPROIO/INC
          INC       OBSREAIO/INC
          INC       OBSMDTIO/INC
.
.
          INC       PMSMTXIO/INC
          INC       PMSMDTIO/INC
          INC       PMSWORIO/INC
          INC       OBSMTXIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       EMREXPIO/INC
          INC       EMRECHIO/INC
          INC       EMRECLIO/INC
.
          INC       IBATMDIO/INC
          INC       LABELAGE    
          INC       DISPVISN           * Display Visit Notes
          INC       VISCMTCD
