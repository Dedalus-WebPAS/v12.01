.----------------------------------------------------------------------
. Program       : OUTWEB03
.
. Function      : Print Outpatient Forms + Invoices + Letters
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.03 30/09/2025  Thanh T        TSK 0937505
.           Recompiled for PATINVHL changes
. V12.00.02 05/09/2025  Thanh T          TSK 0949457
.           Recompiled for OUTLVLET/OUTPLTCD changes
. V12.00.01 30/05/2025  Don Nguyen     TSK 0955096
.           Alphanumeric visit number changes
.----------------------------------------------------------------------
. V11.04.08 03/09/2024  Thanh T        TSK 0911388
.           Recompiled for OUTMR3N2 changes 
. V11.04.07 05/08/2024  Ebon Clements  TSK 0893817
.           Recompiled for OUTPLTCD
. V11.04.06 22/07/2024  Thanh T        TSK 0939648
.           Recompiled for OUTLVLET changes
. V11.04.05 15/04/2024  Sunny          TSK 0893817
.           Recompiled for OUTPLTCD
. V11.04.04 19/03/2024  J.Tan          TSK 0919335
.           Commented out CODEU1
. V11.04.03 16/01/2024  Ebon Clements  TSK 0941021
.           Added unique PRGID to save SMS printer default - PRTLET90 - OUTWMSMS
. V11.04.02 28/11/2023  Peter Vela     TSK 0935874
.           Recompiled for OUTMR3N2 - Added validation for PTCNUNET = 3
.           Recompiled for OUTPLTCD - Added validation for PTCNUNET = 3
. V11.04.01 14/11/2023  Sunny          TSK 0893817
.           Recompiled for OUTPLTCD
. V11.03.07 08/11/2023  Nikitha B      TSK 0927699c
.           Read PTCNHABN for Hospital ABN number.
. V11.03.06 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.03.05 04/10/2023  Nikitha B     TSK 0927699
.           Recompiled for PATINVHL, PATINVTL - Stationary variables
. V11.03.04 08/09/2023  Thanh T.        TSK 0912156
.           Recompiled for PATPAOFS and PRTALCPW changes
. V11.03.03 15/08/2023  Don Nguyen     TSK 0935736
.           Recompiled for SMSPRXML - Skip inactive extra contacts for SMS
. V11.03.02 15/06/2023  Bella Turco    TSK 0931756
.           Recompiled for PRTINVBD             
. V11.03.01 25/05/2023  J.Tan          TSK 0923703
.           Recompiled for ABF new calculations
. V11.02.06 11/10/2022  Sunny          TSK 0924324
.           Commented out call to CASE0000 for %rggpad4 (RGGPADD4),
.           %rfgrad4 (RFGPADD4), %rgprca4 (RGPRSAD4), %rfprca4 (RFPRSAD4)
. V11.02.05 13/09/2022  Sunny          TSK 0924324
.           Commented out call to CASE0000 for %paddd (LXPADDD)
. V11.02.04 19/04/2022  Thanh T        TSK 0903453
.           Recompiled for OUTMR3N2 changes
. V11.02.03 01/04/2022  Sunny          TSK 0899215
.           Recompiled for OUTLVLET and OUTPLTCD
. V11.02.02 16/03/2022  J.Tan           TSK 0902652
.           Recompiled for OUTCATBI - Patient Invoice new functionality
. V11.02.01 21/01/2022  Jacob Jackson  TSK 0864505
.           Recompiled for OUTMR3N2 - Adding preferred name options
. V11.01.08 17/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFOTINV - Mod for Multiple NEP Values
. V11.01.07 27/09/2021  Sunny          TSK 0893817
.           Recompiled for OUTLVLET and OUTPLTCD - Added %ogpcdes
. V11.01.06 14/09/2021  Davin          TSK 0911277
.           Recompiled for PRTINVBD
. V11.01.05 10/09/2021  Davin          TSK 0911277
.           Recompiled for PATINVTL - Changed field 20 length to 12.2
. V11.01.04 31/08/2021  J.Tan          TSK 0910799
.           Recompiled for PRTINVBD - printing Referring ADF
. V11.01.03 24/08/2021  Davin          TSK 0897318
.           Recompiled for PATINVTL - added field 57(Adjustment Total)
. V11.01.02 13/07/2021  Sunny          TSK 0893817                      
.           1) Recompiled for OUTLVLET and OUTPLTCD - Added %systype          
.           2) Added OTCNGPSO - Outpatient Letter GP/Practice Source order 
.           3) Added VBOC0000 - Read to get OTBCRDAT 
. V11.01.01 02/07/2021  Ebon Clements  TSK 0900650 
.           Recompiled for SMSPRXML 
. V11.00.11 19/01/2021  J.Tan          TSK 0883075
.           Recompiled for PRTINVBD - mod to print ADF address on invoice
. V11.00.10 17/12/2020  Ebon Clements    TSK 0900728
.           Recompiled for OUTLVLET and OUTPLTCD - Rescheduled from day var
. V11.00.09 16/11/2020  Thanh T          TSK 0878747
.           Added PATATRFD PATATRIO and PATATRTD for OUTMR3N2
. V11.00.08 14/10/2020  J.Tan          TSK 0894879
.           Recompiled for PRTINVBD - Print 30 item desc.for RCH Inv.
. V11.00.07 16/07/2020  Tracey Nguyen    TSK 0893621
.           Recompiled for OUTLVLET - Added %smsusrnm (LCCSMSUN/LXXSMSUN)
. V11.00.06 01/07/2020 J.Tan           TSK 0886178
.           Recompiled for OUTCATBI - write to invoice pending details file
. V11.00.05 29/06/2020  J.Tan           TSK 0893767
.           Recompiled for ABFOTINV - Changed CALCFLAG to 01/01/2021
. V11.00.04 20/04/2020 J.Tan           TSK 0890733
.           Recompiled for ABFOTINV - ABF new 2020 calculation 
. V11.00.03 03/04/2020  Thanh T          TSK 0879163                      
.           Recompiled for OUTMR3N2
. V11.00.02 20/03/2020  Peter Vela       TSK 0889143
.           Fixed OUTLET IO calls
. V11.00.01 18/03/2020  Peter Vela       TSK 0889143
.           Recompiled for OUTLETFD
.----------------------------------------------------------------------
. V10.15.04 07/02/2020  Ebon Clements    TSK 0887235
.           Recompiled for PMSCEXCD - extra contact postal address
. V10.15.03 05/12/2019  Thanh T.          TSK 0885188
.           Added STAR30
. V10.15.02 29/10/2019  Ebon Clements    TSK 0861253
.           Added PRNTLONG print long line functionality for telehealth
. V10.15.01 11/10/2019  Peter Vela       TSK 0882906
.           Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF
.           11/10/2019  Richa Phogat      TSK 0861253
.           - Added OUTTHIFD/OUTTHIIO, CODEOM
.           - Recompiled for OUTLVLET and OUTPLTCD
.           17/10/2019  Ken Bell          TSK 0875392
.           Clear Claim Number, Associated feild if claim is cancelled
.----------------------------------------------------------------------
. V10.14.08 28/08/2019  Thanh T.          TSK 0877294
.           Changed TIME0000 to fix the issue when the Hour is 00:MM, it
.           should show as 12:MM AM and not 0:MM AM.   
. V10.14.07 07/08/2019  Thanh T.          TSK 0867186
.           Recompiled for OUTPLTCD changes
. V10.14.06 25/07/2019  Sunny             TSK 0877616
.           Recompiled for OTBBSRVD - Service delievery description
. V10.14.05 10/07/2019  Ebon Clements     TSK 0872962
.           Read next scheduled job if current record is locked - MAIN0100
. V10.14.04 14/06/2019  Ebon Clements     TSK 0875173
.           Check for a cancelled over booking when reading outbokaf - BOKA0000
. V10.14.03 13/06/2019  J.Tan             TSK 0757953
.           Fixed key reading pridoct for the Link doctor (pmhcldoc)
. V10.14.02 04/06/2019  Nicole Torrisi    TSK 0870873
.           Recompiled for OUTPLTCD            
. V10.14.01 12/03/2019  Nicole Torrisi    TSK 0870242
.           Recompiled for OUTPLTCD
. V10.13.06 11/01/2019  Peter Vela     TSK 0867807
.           Recompiled for OUTCATBI
. V10.13.05 16/10/2018  Ebon Clements   TSK 0863467
.           Allow multiple instances of server to be run.
.           Delete outlpcaf after read lock and before printing begins
.           Added save and restore routine instead of re reads
.           SOTL0000 and ROTL0000
. V10.13.04 26/10/2018  Thanh T        TSK 0859743
.           Added BULKBILL and removed CATECODE for OUTCATBI Changes
. V10.13.03 25/10/2018  Thanh T        TSK 0859743
.           Added CATECODE for OUTCATBI Changes
. V10.13.02 16/10/2018  Richa Phogat     TSK 0862844
.           Recompiled for DXPATMAS - Fixed Registered HCP name
. V10.13.01 31/07/2018  J.Tan            TSK 0848506
.           Mod PP Doctor from 6 to 10 chars
. V10.12.02 12/07/2018  Ania P         TSK 0842942
.           Added Seen By Doctor & Default Doctor
. V10.12.01 28/02/2018  J.Tan          TSK 0852351
.           Recompiled for PATINVHL-fields 226 & 227(Program Code/Desc)
. V10.11.06 28/12/2017  Thanh T.       TSK 0849654
.           Recompiled for OUTPLTCD
. V10.11.05 27/11/2017  Thanh T.       TSK 0821710
.           Recompiled as PATMISTD changed
. V10.11.04 23/08/2017  Thanh T.       TSK 0832066
.           Recompile for OUTMR3N2
. V10.11.03 11/08/2017  Ania P         TSK 0843055
.           Recomp for OUTPLTCD
. V10.11.02 19/07/2017  Ebon Clements  CAR 268970
.           Removed open of OUTCLIA3
. V10.11.01 17/07/2017  Ebon Clements  TSK 0817112
.           Recompiled for OUTPLTCD - Linked referral referring GP
.----------------------------------------------------------------------
. V10.10.02 25/05/2017  Richa Phogat   TSK 0830804
.           Recompile for OUTPLTCD - Service Delivery Mode                   
. V10.10.01 20/03/2017  Thanh T.       TSK 0832066 
.           Recompile for OUTMR3N2
. V10.09.01 07/12/2016  Jill Parkinson TSK 0822329   
.           Recompiled for OUTMR3N2
. V10.08.07 20/09/2016  Ebon Clements    TSK 0823657 
.           Recompile for OUTPLTCD - SMS letter type
. V10.08.06 16/09/2016  Ebon Clements    TSK 0823657 
.           Recompiled for OUTPLTCD - hospital name 
. V10.08.05 15/09/2016  Don Nguyen       TSK 0294154
.           Recompiled for SMSPRXML & OUTPLTCD
.           14/09/2016  Ebon Clements    TSK 0294154
.           Added CONTTYPS                         
. V10.08.04 23/08/2016  Peter Vela       TSK 0822268
.           Recompiled for OUTPLTCD 
. V10.08.03 10/08/2016  Davin            TSK 0321234
.           Recompiled for OUTMR3N2/PRTALCPW - alert care pathway fields
. V10.08.02 20/07/2016  Don Nguyen     TSK 0294154
.           Added SMSPRXML - print XML metatags for SMS (PRIN0000).
.           Recompiled for changes to OUTPLTCD.
. V10.08.01 07/06/2016  Jill Parkinson TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.07.04 11/01/2016 Ebon Clements    TSK 0294154                
.           Added %smsid, %smscode, %smskey, %smsurno, %smsuser,    
.           %smsphone                                               
. V10.07.03 23/12/2015  Peter Vela        CAR 0324687
.           Recompiled for OUTPLTCD
. V10.07.02 22/12/2015  J.Tan             CAR 0303942
.           Recompiled for OUTCATBI - additional payment types
. V10.07.01 16/11/2015  Peter Vela        CAR 323632
.           Recompiled for OUTMR3N2
. V10.06.10 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.09 11/09/2015  Peter Vela     CAR 321015
.           Added controlf reads of CAPPRVNO and CFILENO in INIT0000
. V10.06.08 07/08/2015  Davin          CAR 317002
.           Recompiled for PRTINVBD - Print pmexname for ADF MO
. V10.06.07 14/07/2015  Peter Vela     CAR 318700
.           Recompiled for PRBILCMN - Validate for deleted VISMDT record
. V10.06.06 15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.05 11/05/2015 Ebon Clements   CAR 298921
.           Recompile for changes to use OUTCLIFD index 1 instead of index 2
. V10.06.04 30/04/2015  Ebon Clements  CAR 314829
.           Recompiled for OUTPLTCD - Clinic instructions print
. V10.06.03 07/04/2015  Ania P         CAR 313236                     
.           Recompiled for PRTINVBD                                   
. V10.06.02 31/06/2015 Peter Vela      CAR 298921
.           Recompiled for OUTMR3N2
.           Changed key pack to use linked doctor from OTBBADCS
. V10.06.01 19/03/2015 Ebon Clements   CAR 298921
.           Change to use OUTCLIFD index 1 instead of index 2
.           16/03/2015 Ebon Clements   CAR 298921
.           Changed key pack using OTBBADCS to still use a DIM 6
. V10.05.07 10/02/2015 J.Tan      CAR 311717
.           Recompiled for PATINVHL
. V10.05.06 12/01/2014  Peter Vela     CAR 310738
.           Recompiled for PRTINVBD
. V10.05.05 28/10/2014 J.Tan     CAR 304455
.           Recompiled for PATINVHL - fixed Doctor Name and Provider no
. V10.05.04 24/10/2014  Ebon Clements  CAR 302677
.           Added temp file to print seris booking letter variables
.           in booking date and time order
. V10.05.03 20/10/2014  Ebon Clements  CAR 268970
.           Removed open of OUTCLIA3
. V10.05.02 13/10/2014  Ania P         CAR 303879    
.           Added HP code output
. V10.05.01 06/10/2014  Ebon Clements  CAR 268970
.           Removed OUTCLIFD index 4 open as it was not used
. V10.04.03 01/05/2014  J.Tan          CAR 261630
.           Removed port number from temp file name
.           Remove PATAUC PATAUM audit file
. V10.04.02 16/04/2014  Davin          CAR 297815 
.           Recompiled for OUTMR3N2 - Added fields 380 to 388
. V10.04.01 24/02/2014  J.Tan            CAR 285504
.           Recompiled for DXPATMAS
.           24/02/2014  Don Nguyen     CAR 291879
.           Recompiled for OUTMR3N2 - Added field 379 (IHI Number)
.           Recompiled for OUTPLTCD - Added field 543 (LXIHINUM) - IHI Number
.           20/02/2014  J.Tan          CAR 273713
.           Recompiled for PRIINVBD - Mods to print payment types of a receipt
.           27/02/2014  J.Tan          CAR 273713
.           Recompiled for PRIINVBD - print defence force claim
. V10.03.27 09/12/2013  Ania P         CAR 294740
.           Recompiled for PATINVHL
. V10.03.26 12/11/2013  Davin             CAR 292499 
.           Recompiled for OUTLVLET, OUTPLTCD - series booking day
. V10.03.25 12/09/2013  Peter Vela     CAR 271911
.           Recompiled for PATINVTL
. V10.03.24 18/07/2013  Don Nguyen     CAR 288603
.           Recompiled for changes to OUTMR3N2 - Added fields 377 & 378
. V10.03.23 05/07/2013  Don Nguyen     CAR 287965
.           Recompiled for changes to OUTPLTCD
. V10.03.22 02/07/2013  Peter Vela     CAR 286022
.           Recompiled for OUTPLTCD
. V10.03.21 20/06/2013  Davin          CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.20 23/04/2013  Ebon Clements  CAR 277862
.           Recompile for OUTPLTCD -  Location type print
. V10.03.19 18/04/2013  Ania P         CAR 281663
.           Recompile for OUTLVLET & OUTPLTCD
. V10.03.18 17/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATINVHL, PATINVTL
. V10.03.17 09/04/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN, PATINVHL, PATINVTL
. V10.03.16 26/03/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN
. V10.03.15 18/03/2013  J.Tan          CAR 280802
.           Recompiled for PATINVHL - Outpatient HF membership
. V10.03.14 08/03/2013  Jill Parkinson CAR 276982
.           Recompiled for OUTMR3N2
. V10.03.13 05/03/2013  Patrick Adair  CAR 281898
.           Recompiled for PRNTICDC
. V10.03.12 14/01/2013  Saroeun Soeur  CAR 276985
.           Recompiled for OUTMR3N2
. V10.03.11 03/12/2012  Peter Vela     CAR 262297
.           Recompiled for OUTPLTCD
.           04/12/2012  Jill Parkinson CAR 276982
.           Recompiled for OUTMR3N2
. V10.03.10 17/10/2012  Jill Parkinson CAR 273375
.           Recompiled for DATECONV
. V10.03.09 05/09/2012  Peter Vela     CAR 271262
.           Recompiled for OUTWEB03
. V10.03.08 18/07/2012  Don Nguyen     CAR 264561
.           Recompiled for PATGBCRN
. V10.03.07 25/05/2012  Ebon Clements  CAR 236299
.           Recompiled for OUTPLTCD - Clinic indicator variable
. V10.03.06 16/03/2012 Peter McMullen CAR 259857 
.           ReRmove reference to redundant file paytear
. V10.03.05 09/02/2012 J.Tan  CAR 259311
.           Recompiled for OUTMR3N2 - fixed printing patient age
. V10.03.04 01/02/2012  J.Tan            CAR 247090
.           Recompiled for OUTMR3N2 - Print indicator for Card Type
. V10.03.03 30/01/2012  Davin             CAR 257512 
.           Recompiled for changes to OUTLVLET, OUTPLTCD 
. V10.03.02 13/01/2012 J.Tan  CAR 256936
.           Recompiled for OUTMR3N2 - recalculate patient age
. V10.03.01 09/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
. V10.02.11 12/10/2011 J.Tan  CAR 235370 
.           Recompiled for PATINVHL - NHI names for SX
. V10.02.10 20/09/2011  Davin             CAR 248749 
.           Recompiled for changes to OUTLVLET, OUTPLTCD 
. V10.02.09 10/09/2011  Peter McMullen    CAR 248749 
.           Recompiled for changes to OUTLVLET, OUTPLTCD 
. V10.02.08 22/06/2011  Steve Armstrong   CAR 240722
.           Recompiled for changes to PMSCEXCD 
. V10.02.07 01/07/2011 Ebon Clements    CAR 242246
.           Recompiled for OUTMR3N2 - Clinic phone number
. V10.02.06 07/06/2011 Ebon Clements    CAR 239530
.           Added print extra contact functionality
. V10.02.05 30/05/2011 Ebon Clements    CAR 239554
.           Added printed by the OP letter history
. V10.02.04 25/05/2011  Saroeun Soeur    CAR 242008
.           Recompiled for PATSHT6
. V10.02.03 12/05/2011  Saroeun Soeur CAR 242008
.           Recompiled for PATSHT6
. V10.02.02 06/04/2011  Ebon Clements CAR 233251
.           Recompiled for OUTPLTCD - % bold and % underline
. V10.02.01 23/03/2011 Sandra Barcham   CAR 239851
.           Fix printing Visit Date on original invoice
.----------------------------------------------------------------------
. V10.01.05 08/02/2011  Ebon Clements CAR 233251
.           Recompiled for OUTPLTCD & OUTLVLET - Added % bold and underline vars
. V10.01.04 13/01/2011  Mike Laming   CAR 233084
.           Added include CLPATINV for OUTINVCD & Recompiled
. V10.01.03 20/12/2010  Ebon Clements CAR 222021
.           Recompiled for OUTMR3N2 - DVA card colour
. V10.01.02 15/12/2010  Mike Laming   CAR 233046
.           Recompiled for OUTCATBI - Mods to Misc.Charges PATMCHFD
. V10.01.01 30/10/2010 J.Tan          CAR 233043
.           Recompiled for OUTCATBI - mods to print invoice
. V10.00.02 01/09/2010  Ebon Clements CAR 226850
.           Recompiled for OUTPLTCD - doctor name variables
. V10.00.01 22/04/2010  Peter Vela    CAR 218333
.           Recompiled for OUTMR3N2
. V9.12.08  13/01/2010  Jill Parkinson CAR 207035
.           Recompiled for OUTMR3N2 - mods to print PMRLDESC for PTMXECRE 
. V9.12.07  04/12/2009  Peter Vela    CAR 202333
.           Recompiled for PATINVHL - Changed variable 88 to surname only 
. V9.12.06  12/11/2009  Peter Vela    CAR 199757
.           Recompiled for OUTMR3N2
. V9.12.05  16/10/2009  Ebon Clements CAR 190680
.           Recompiled for DXOUTDET -  Fixed pack of VAR after calls to CMPH0000
. V9.12.04  05/10/2009  J.Tan         CAR 191624                      
.           Recompiled for OUTINVS - set Deposit Applied date to Current date
. V9.12.03  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.02  20/07/2009  Mike Laming   CAR 187485
.           Someone added NZPCFNaf to PATINVHL and broke this
. V9.12.01  12/05/2009  Saroeun Soeur CAR 196152
.           Recompiled for OUTPLTCD
.----------------------------------------------------------------------
. V9.11.06  23/03/2009  Davin         CAR 178015
.           Recompiled for PATINVHL - Changed BPAY CRN to use invoice number
. V9.11.05  04/03/2009  Jill Habasque    CAR 134681
.           Mods to read patwc1af
. V9.11.04  05/12/2008  J.Tan            CAR 182320
.           Mods to read outpat master for printing form
. V9.11.03  11/11/2008  Steve Armstrong  CAR 179910
.           Recompiled for changes to OUTPLTCD.
.           05/11/2008 Steve Armstrong   CAR 182320
.           Recompiled for changes to OUTMR3N2
. V9.11.02  31/10/2008 Sandra Barcham CAR 178932
.           Recompiled for OUTLVLET - Extend Carer Name from 20 to 60 chars
. V9.11.01  14/10/2008  Peter Vela    CAR 159227
.           Recompiled for PATINVHL - Added Emergency Invoice
.           Arrival Date and Time
.----------------------------------------------------------------------
. V9.10.01  09/09/2008  Ebon Clements CAR 175728
.           Recompiled for OUTMR3N2 - Compensable vars and pmi address
.----------------------------------------------------------------------
. V9.09.11  05/02/2008 Ebon Clements    CAR 158186
.           Added population of OBASITE when printing referral letters
. V9.09.10  22/01/2008 Ebon Clements    CAR 139569
.           Recompiled for OUTLVLET -  Print Reg. GP Practice details
. V9.09.09  27/12/2007 Peter Vela       CAR 155907
.           Recompiled for PATINVTL
. V9.09.08  12/12/2007 Ebon Clements    CAR 157081
.           Recompiled for OUTMR3N2 - Patient e-mail address
. V9.09.07  05/12/2007 Peter McMullen   CAR 137137
.           Recompiled for DXOUTDET,OUTLVLET,OUTPLTDF,OUTPLTCD 
. V9.09.06  16/11/2007 Peter Vela     CAR 110766
.           Recompiled for PATINVHL
. V9.09.05  12/11/2007 Peter Vela     CAR 151199
.           Added new Emergency Cancellation status
.           13/11/2007 Mike Laming    CAR 131844
.           Recompiled for OUTLVLET & OUTPLTDF
. V9.09.04  24/10/2007 Mike Laming    CAR 131844 & 152340
.           Recompiled for OUTLVLET & OUTPLTCD - HCP Addresses & OUTPLTCD (Site)
. V9.09.03  19/09/2007 Steve Armstrong  CAR 124435
.           Recompiled for DXOUTDET new item:  102 - ACC Number
. V9.09.02  03/07/2007  Peter Vela         CAR 142173
.           Recompiled for PATINVTL
. V9.09.01  15/05/2007  Ebon Clements      CAR 131843                       
.           Recompiled for OUTPLTCD - Referral letter practice address
.----------------------------------------------------------------------
. V9.08.10  16/03/2007  Ebon Clements      CAR 135648                       
.           Recompiled for OUTMR3N2 - Clinic type I * C   
. V9.08.09  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.08  22/02/2007 Mike Laming   CAR 119436
.           Add PMSOSDTM (PROC FLAGDEBT) for Outstanding Debt Alert ind.
. V9.08.07  06/02/2007  Neelkamal Pyla    CAR 120594
.           Recompiled for PATSHT6 - Added NOK Relation and Title Desc
. V9.08.06  23/01/2007  Mike Laming       CAR 128643
.           Recompile for OUTDTRFD - Change OTSERVS to FORM 5
. V9.08.05  13/12/2006  J.Tan             CAR 127625
.           Mods to JH HRN 
. V9.08.04  27/11/2006  Steve Armstrong   CAR 126039
.           Recompiled for changes to SGCHKDIG
. V9.08.03  16/11/2006  Steve Armstrong   CAR 124160
.           Recompiled for OUTMR3N2 (Singapore HRN)
.           Recompiled for PATINVHL (Singapore HRN)
.           Recompiled for PATINVTL (Singapore HRN)
. V9.08.02  14/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
. V9.08.01  29/09/2006  Peter Vela    CAR 120319
.           Recompiled for PATINVHL
.----------------------------------------------------------------------
. V9.07.08  25/09/2006  Peter Vela    CAR 118940
.           Recompiled for PATCATBI
. V9.07.07  19/09/2006  Jill Habasque CAR 109852
.           Added procedure GETALTID for PATINVHL change
. V9.07.06  18/09/2006  Ebon Clements CAR 89365
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.07.05  01/09/2006  Peter Vela    CAR 114297
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.07.04  02/08/2006  Peter Vela    CAR 113658
.           Recompiled for PATINV21 - Fixed Date and Cash Payment
.           display
. V9.07.03  25/07/2006  Ebon Clements CAR 99899
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.07.02  21/06/2006  Peter Vela    CAR 108110
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.07.01  21/06/2006  Ebon Clements CAR 105627
.           Mods to allow UNIX letters to trigger multiple vcq letters
. V9.06.06  31/05/2006  Peter Vela    CAR 106057
.           Recompiled for OUTLVLET and OUTPLTCD
.           Added PMSRELFD and PMSRELIO
. V9.06.05  16/05/2006  Peter Vela    CAR 104103
.           Recompiled for PATCATBI - PTCNINVL=12
. V9.06.04  30/05/2006  Peter Vela    CAR 104807
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.06.03  23/05/2006  Ebon Clements CAR 792776
.           Print postal/pmi address on carer label if carer details blank
. V9.06.02  27/04/2006  Peter Vela    CAR 102166
.           Recompiled for OUTPLTCD - Changed title code to title description
. V9.06.01  24/04/2006  J.Tan         CAR 102287
.           Recompiled for PATINVHL - Added fields for multi hospital details
. V9.05.07  10/04/2006  J.Tan         CAR 96023
.           Mods to print Internal Referral
. V9.05.06  05/04/2006  Ebon Clements CAR 95803
.           Added check for cancelled appointments in UNXLET00           
. V9.05.05  29/03/2006  Peter Vela    CAR 85995
.           Modified display of LXSBTM01-10 to display with a format of 99:99 am
. V9.05.04  29/03/2006  Peter Vela    CAR 95780
.           Recompiled for PATINVHL - Added emg mobile contact numbers
. V9.05.03  27/03/2006  Peter Vela    CAR 61299
.           Recompiled for OUTMR3N2
. V9.05.02  24/03/2006  Ebon Clements CAR 79277
.           Added carer contact letter variables
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 20/02/2006  Ebon Clements     CAR 76341
.           Added referral and encounter file audit
. V9.04.34  17/11/2005  Peter Vela    CAR 84547
.           Recompiled for PATINVXX subroutines - Removed CLOSE PATFN1A1
. V9.04.33  03/11/2005  Peter Vela     CAR 79842
.           Recompiled for OUTMR3N2
.           Recompiled for OUTLVLET OUTPLTCD
. V9.04.32  28/10/2005  Ebon Clements  CAR 72700
.           Added read of websecaf to set PASSCODE for printing
. V9.04.31  18/10/2005  Peter Vela     CAR 80192
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.04.30  18/10/2005  Peter Vela     CAR 80192
.           Recompiled for OUTLVLET and OUTPLTCD
.           25/10/2005  Sandra Barcham CAR 81362
.           Recompiled for OUTINVCD
. V9.04.29  07/10/2005  Peter Vela     CAR 79300
.           Added open of outcanaf
. V9.04.28  30/08/2005  Peter Vela     CAR 62749
.           Recompiled for OUTLVLET and OUTPLTCD
.           25/08/2005  Peter Vela     CAR 73458
.           Added initialisation of series booking template variables to 
.           spaces
. V9.04.27  18/08/2005  Peter Vela     CAR 69456
.           Recompiled for OUTMR3N2
.           24/08/2005  Jill Habasque  CAR 72777
.           Recompiled for OUTPLTCD and OUTLVLET
. V9.04.26  12/08/2005  Jeni Tan       CAR 62750
.           Removed redefined variables  
. V9.04.25  08/08/2005 Peter Vela CAR 67204
.           Recompiled for OUTMR3N2
. V9.04.24  01/08/2005 J.Tan  CAR 69062
.           Changed claim index 7 to include voucher no
. V9.04.23  27/07/2005  Peter Vela    CAR 66545
.           Recompiled for OUTMR3N2
. V9.04.22  20/07/2005  Peter Vela    CAR 63023
.           Recompiled for OUTLVLET,OUTPLTCD,OUTMR3N2
. V9.04.21  14/07/2005  Peter Vela    CAR 62172
.           Recompiled for PATINVTL
. V9.04.20  07/07/2005  J.Tan         CAR 66584
.           Mods checking for the doctor Seen by 
. V9.04.19  01/07/2005  Davin         CAR 61563
.           Mods for HIC claim (DB4) - print 100% of item amount, not 85%
. V9.04.18  14/06/2005  Peter Vela    CAR 58732
.           Recompiled for OUTLVLET and OUTPLTCD
.           09/06/2005  Peter Vela    CAR 62622
.           Recompiled for OUTLVLET and OUTPLTCD
. V9.04.17  08/06/2005  Davin         CAR 56698
.           Mods for HIC claim (DB4) - print ur/claim number at top of form
. V9.04.16  06/06/2005  Davin         CAR 56698
.           Mods for HIC claim (DB4) - added two lines for 'create forms'
. V9.04.15  02/06/2005  Davin         CAR 56698
.           Mods for HIC claim (DB4) - changed referral period to form 6
.                                    - fixed referring doctor output
. V9.04.14  26/05/2005  Davin         CAR 56698
.           Mods for HIC claim (DB4) printing (medicare form HICCLM)
. V9.04.13  20/05/2005  J.Tan         CAR 56699
.           Recompiled - added amount receive to hiccitaf file
. V9.04.12  13/05/2005  Peter Vela    CAR 61796
.           Recompiled for OUTMR3N2
. V9.04.11  11/05/2005  J.Tan         CAR 61440
.           Added new field adjustment amount to hic files
. V9.04.10  09/05/2005  Ebon Clements   CAR 60456
.           Added read of outbokaf to PRTOUT00
. V9.04.09  29/04/2005  Peter Vela    CAR 57513
.           Recompiled for OUTPLTCD
.           29/04/2005  Davin         CAR 56698
.           Added HIC claim printing (medicare form HICCLM)
. V9.04.08  29/03/2005  Peter Vela    CAR 59546
.           Recompiled for OUTPLTCD
. V9.04.07  18/03/2005  Peter Vela    CAR 59618
.           Recompiled for OUTPLTCD
.           17/03/2005  Peter Vela    CAR 59277
.           Recompiled for OUTPLTCD
.           01/03/2005  Peter Vela    CAR 57244
.           Recompiled for OUTMR3N2
. V9.04.06  17/02/2005  Mike Laming   CAR 56030 
.           Re-compile for PATINV25 - fix screen painted tail printing 
. V9.04.05  14/01/2005  Peter Vela      CAR 55313
.           Recompiled for OUTPLTCD
.           Recompiled for OUTLVLET
. V9.04.04  06/10/2004  J.Tan   CAR 53798
.           Removed PATMSCDS
. V9.04.03  04/10/2004  Jill Habasque  CAR 53798 
.           Added read of pathspaf 
. V9.04.02  23/09/2004  Peter Vela      CAR 53708
.           Recompiled for OUTMR3N2
.           Recompiled for OUTPLTCD
.           Recompiled for OUTLVLET
. V9.04.01  31/08/2004  Guomin Fu       CAR 40390
.           Recompiled for OUTPLTCD (add variables to Letters)
. V9.03.18  30/06/2004  Mike Laming     CAR 40390
.           Recompiled for OUTPLTCD (add variables to Letters)
. V9.03.17 13/05/2004  Ebon Clements  CAR 48720
.          Added create form referral letter printing
. V9.03.16 12/05/2004  Ebon Clements  CAR 49743
.          Recompiled for OUTPLTCD - Comments are now in PATCMNFD
. V9.03.15 29/04/2004  J.Tan  CAR 36504
.          Recompiled for OUTCATBI - fixed displaying cash
. V9.03.14 06/04/2004  Peter Vela     CAR 48227
.          Added VARGBCRN and PATGBCRN - BPAY Reference Number
. V9.03.13 15/03/2004 Guomin Fu       CAR 47288
.          Recompiled for OUTPLTCD
. V9.03.12 09/02/2004 Sylvek Litewka  CAR 47000
.          Modified procedure PRTLET00 to allow for printing of Outpatient
.          Referral related letters.
. V9.03.11 19/12/2003 J.Tan   CAR 44093
.          Replaced patcashf with comdepaf
. V9.03.10 15/12/2003  Peter Vela CAR 45249
.          Recompiled for OUTPLTCD
. V9.03.09 07/11/2003  Peter Vela CAR 44849
.          Recompiled for PATINVTL
. V9.03.08 03/11/2003  Peter Vela CAR 44757
.          Recompiled for PATINVTL
. V9.03.07 20/10/2003  J.Tan    CAR 44172
.          Recompiled for OUTCATBI - Misc.theatre item file(pmsmitaf)
. V9.03.06 30/09/2003  Ebon Clements  CAR 43674  
.          Changed RESERV00 to check reservations for all sites
.          30/09/2003 Ebon Clements  CAR 43674
.          Close files before opening in OPNOUT00
. V9.03.05 25/09/2003  Ebon Clements  CAR 41801  
.          Added series booking letters 
. V9.03.04 15/09/2003  CAR 40497   Lina Vo       
.          Recompiled for OUTCATBI, OUTINVCD, PATMCHFD & IO. 
.          Added KEY26A for OUTCATBI & OUTINVCD.
. V9.03.03 04/09/2003  CAR 42713   Mike Laming 
.          Recompiled for PATINVTL (correct GST twice in final Total)
. V9.03.02 13/08/2003 Sylvek Litewka  CAR 41293
.          Added code to populate and clear SCHEDDSC variable with description 
.          of documents being printed.
. V9.03.01 30/07/2003 J.Tan
.          Recompiled for OUTCATBI - WEB Billing
. V9.02.18 09/04/2003 Ebon Clements CAR 38132                       
.          Recompiled for OUTPLTCD - vcq letter printing string    
. V9.02.17 26/02/2003 Sylvek Litewka CAR 36688
.          Modified procedure RESERV00 to update "outbokaf" only if OBASTAT=9.
. V9.02.16 30/11/2002 Lina Vo        SRF 22709
.          Changed program to open outpatient files with site prefix.
.          Removed duplicate opening of files in INIT0000.           
. V9.02.15 24/09/2002 Sandra Barcham SRF 22551
.          Fix site prefix problems for outlhiaf and outxwpaf
. V9.02.14 20/05.2002 Jeni Tan     
.          Recompiled for Casemix
. V9.02.13 29.04.2002 Bronko Sosic 
.          Added a number to REPORTNO so that the defult printer will be
.          saved against the userid defect : 3620
. V9.02.12 21.03.2002 Ebon Clements
.          Recompiled new outpatient letter variables       
. V9.02.11 15.02.2002 Bronko Sosic
.          Recompiled for New variables in printing
. V9.02.10 12.02.2002 B.G.Ackland
.          Performance for Unix Printed Letters
. V9.02.09 12.02.2002 B.G.Ackland
.          Performance for Unix Printed Letters
. V9.02.08 17.01.2002 Ebon Clements 
.          Recompiled for OUTPLTCD - GOTP1200 use variable SITE not IDDD     
. V9.02.07 14.01.2002 Ebon Clements 
.          Added new variables for outpatient letters - OMACOM1 and OMACOM2
. V9.02.06 20.12.2001 B.G.Ackland
.          Fixed Output of OBASITE
. V9.02.05 02.11.2001 B.G.Ackland
.          COMMIT Transaction Control
. V9.02.04 10.10.2001 B.G.Ackland
.          COMMIT Transaction Control
. V9.02.03 03.10.2001 B.G.Ackland
.          COMMIT Transaction Control for WEBINT00
.
. V9.02.02  05.09.2001 Ebon Clements 
.           Re format OTLPSTIM to be 5 character not 8                   
. V9.02.01  20.08.2001 HPS-ODC
.           Changes made for Fixing of IBA and OffShore Raised Defects
. V9.00.B02 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B01 22/05/2001  Bronko Sosic                 
.           Changes to Outpatient Form Processing to
.           Include Invoces and Letters
.----------------------------------------------------------------------
.                 V5.08.03 19/09/2000  Brian Ackland                
.                          509 Changes
.                 V5.08.02 19/09/2000  Steve Armstrong   srf 647263
.                          Recompiled for changes to OUTDSCLN
.                 V5.08.01 16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.07.02 28.01.2000 B.G.Ackland  
.                          Recompiled for New Standards
.                 V5.07.01 20.12.1999 K.C.Nelson
.                          Recompiled for IBAWEBDF/IBAWEBCD
.                 V5.07.00 27.10.1999 K.C.Nelson
.                          Port to 5.07            
.                 V5.06.00 11.11.1998 K.C.Nelson
.                          Created Program
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       TFILEVAR/INC
          INC       ALLCONFD/INC
          INC       CHKDIGVR/INC
          INC       IBATMDFD/INC
          INC       STDHLPDF
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       WEBDINVS/INC
.
          INC       COMDEPFD/INC
          INC       MLTCFNFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
.
          INC       ALLLNKFD/INC
          INC       ALLREFFD/INC
          INC       HICCITFD/INC
          INC       HICCLMFD/INC
.
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOCFD/INC    
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       OUTCONFD/INC
          INC       OUTDIAFD/INC
          INC       OUTLETFD/INC
          INC       OUTMA1FD/INC
          INC       OUTRF1FD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
          INC       OUTSITFD/INC
          INC       OUTSRVFD/INC
          INC       OUTXSCFD/INC
          INC       OUTHTRFD/INC
.
          INC       NZPFINFD/INC
          INC       NZPFIGFD/INC
          INC       NZPRFNFD/INC
          INC       NZPCFNFD/INC
.
          INC       PATECDFD/INC
          INC       PATCALAG/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATCONFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATCRAFD/INC              
          INC       PATDO1FD/INC
          INC       PATDTRFD/INC              
          INC       PATFN1FD/INC
          INC       PATICDFD/INC
          INC       PATIN1FD/INC
          INC       PMSCNOFD/INC
          INC       PMSMTIFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEVTFD/INC
          INC       PMSIHIFD/INC            * IHI Details
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
          INC       PATGO1FD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATVISFD/INC
          INC       PATVKCFD/INC
          INC       PATIPRFD/INC
          INC       PATINPFD/INC
.
          INC       IBAGSTFD/INC
          INC       PATDSCFD/INC
          INC       PATFINFD/INC
          INC       PATIRNFD/INC
          INC       PATITMFD/INC
          INC       PATINLFD/INC
          INC       PATMI1FD/INC
.
          INC       OUTCANFD/INC 
          INC       PATPR1FD/INC
          INC       PATGSRFD/INC
          INC       PATREMFD/INC
          INC       PATINVFD/INC
          INC       OUTLPCFD/INC
          INC       OUTPLTDF/INC
          INC       OUTRSHFD/INC 
          INC       OUTLHIFD/INC
          INC       OUTXWPFD/INC
          INC       PRIDOCFD/INC
.
          INC       IBAGEDFD/INC
          INC       AAEDTRFD/INC
          INC       AAEDE1FD/INC
          INC       AAECONFD/INC
          INC       OUTDTRFD/INC
          INC       PATCOMM/INC
          INC       PATDHEAD/INC
          INC       PATDRGFD/INC
          INC       PATFIGFD/INC
          INC       PATIPEFD/INC
          INC       PATTFEFD/INC
          INC       PATWC1FD/INC
          INC       PMSWX1FD/INC
          INC       PMSCEXFD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSCCDFD/INC                                       *I-59546
          INC       PMSPX2FD/INC
          INC       PMSVX1FD/INC
          INC       PMSPRGFD/INC
          INC       VARGBCRN/INC          * I-48227
          INC       RCPCRSFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBDTFD/INC
          INC       RCPBNKFD/INC
          INC       OUTLKBFD/INC
          INC       OUTSIPFD/INC
          INC       OUTTHIFD/INC
          INC       PATHGPFD/INC
          INC       VISCMTFD/INC
.
ANSLI     INIT      "i"
ANSLW     INIT      "w"
STRBTYP   DIM       3
COUNTPRT  FORM      2
COMPLETE  FORM      2
CONTTYPE  DIM       1
CURRDATE  DIM       8
.
GSTCODE   DIM       6
GSTAPP    FORM      1
.
SNETTOT   FORM      8.2
MPGEFLAG  FORM      1
FGSTFLAG  FORM      1
ATT       DIM       80
AFTDECP   FORM      2
AFTDECPF  FORM      2
.
BEFDECP   FORM      2
BEFDECPF  FORM      2
.
CASEKEYS  DIM       28
CATTC     INIT      "tc"
BULKBILL  DIM       1
CDEFPRT2  DIM       3
CFILEPRE  DIM       3
CFNAMEW   DIM       8
CHG       FORM      1
CLMDET1   DIM       50
CLMDET2   DIM       50
PRINTCNT  FORM      2
COUNT1    FORM      2
.
DECIMALP  INIT      "."
DESCBDAT  DIM       10
DESCASEN  DIM       1
DESCHFND  DIM       25
DESCINSU  DIM       20
DESCMSTA  DIM       20
DESCNTRY  DIM       20
DESCPENN  DIM       5
DESCRELG  DIM       20
DESCSEX   DIM       6
DIM2A     DIM       2 
DIM3      DIM       3 
DIM3A     DIM       3 
DIM3B     DIM       3 
DIM4A     DIM       4
DIM4B     DIM       4
DIM4C     DIM       4
DIM40     DIM       40
DOCTCODE  DIM       6
.
EMADD1    DIM       25
EMADD2    DIM       25
EMNAME    DIM       20
EMPOST    DIM       4
EMSUBR    DIM       15
EMTELEP   DIM       12
EMCNGINV  DIM       1
.
FIELDNO   FORM      5
FORM2A    FORM      2
FORM5     FORM      5
FORM52    FORM      5.2
FORM21    FORM      21
FORMAT21  FORM      21
FREETEXT  DIM       60                      * Free Text Line Scr. Painted Label
.
HDPINSU   DIM       4                       * MR3 HDP Insurance code
HDPMSTA   DIM       4                       * Marital status code
HDPRELG   DIM       4                       * Religion Code
HDPSEX    DIM       4                       * Sex type code
.
JOURTOT   FORM      6.2
.
NMPNUMB   DIM       20
.
PRNTTYPE  FORM      1
.
SERVDOCT  DIM       10
SAVKEY28  DIM       28
SERIESNO  FORM      3
SERVDATE  DIM       8
SERVPROV  DIM       30
SBWINDOW  FORM      1
.SITE      DIM       6
SRCR4     DIM       4                       * For MR3 - HCS code for Refferral
STATNCOD  DIM       6
SCRID     DIM       2
.
.LABELATT  DIM       24[80]
.LABELDAT  DIM       24[80]
LASTROW   FORM      3
LEAVPSMS  FORM      1        * Don't send overdue leave SMS to patient
LEAVFSMS  DIM       20       * First SMS number of not sending to patient
LEFTBRAK  INIT      "("
LLCNT     FORM      5
LETTNCOD  FORM      3
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       3       * Printer
SVSTNCOD  DIM       6
SAVKEY5   DIM       5
.
MBIRURNO  DIM       8                                               
MBIRTYOR  DIM       24
.
VCLIN     DIM       6                       * Working Clinic id
VDATE     DIM       8                       * Working Clinic Date
VDAY      FORM      1                       * Working Clinic Day
VSITE     DIM       6                       * Working Site
VSESS     DIM       25
VTIME     DIM       5                       * Working Time
VSTIM     DIM       5
.
AM        INIT      "am"
AST30     INIT      "                              "
.AST30     INIT      "******************************"
ATTENDED  INIT      "Attended"
.
BOOKED    INIT      "Booked"
.
CANCELED  INIT      "Cancelled"
CODECA    INIT      "CA"
CODECB    INIT      "CB"
CODECZ    INIT      "CZ"
CODES     INIT      "S "
CODESA    INIT      "SA"
CODEOB    INIT      "OB"
CODELA    INIT      "LA"
CODEOM    INIT      "OM"
CODEVK    INIT      "VK"
CODEVI    INIT      "VI"
CODEVR    INIT      "VR"
CODEVJ    INIT      "VJ"
CODEVB    INIT      "VB"
CODEVA    INIT      "VA"
CODEVP    INIT      "VP"
CODEDX    INIT      "DX"
CODEPV    INIT      "PV"
.
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
DIM4      DIM       4
DOLLAR    INIT      "$"
.
FINISH    INIT      "Finish"
MODE1     DIM       1
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
.
NONATT    INIT      "Non-attended"
.
PDUMMY    INIT      "************************************************"
PM        INIT      "pm"
.
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090" 
RESCHED   INIT      "Rescheduled from"
.                    " -----------"
SPECCHAR  INIT      "%"
SP52      INIT      "                                                    "
START     INIT      "Start "
STAR30    INIT      "******************************"
STAR52    INIT      "****************************************************"
TO        INIT      " TO "
.
VALSTAT   INIT      "BANRCbanrc"
.
Z10       INIT      "zzzzzzzzzz"
.
FIRSTC1   INIT      "   *"
FIRSTC2   INIT      "  **      ****    *****"
FIRSTC3   INIT      " * *     *          *"
FIRSTC4   INIT      "   *      ****      *"
FIRSTC5   INIT      "   *          *     *"
FIRSTC6   INIT      "   *     *    *     *"
FIRSTC7   INIT      " *****    ****      *"
.
SECONDC1  INIT      " *****"
SECONDC2  INIT      "*     *  *    *  *****"
SECONDC3  INIT      "      *  **   *  *    *"
SECONDC4  INIT      " *****   * *  *  *    *"
SECONDC5  INIT      "*        *  * *  *    *"
SECONDC6  INIT      "*        *   **  *    *"
SECONDC7  INIT      "*******  *    *  *****"
.
BCLASS1   INIT      " *****"
BCLASS2   INIT      "*     *  *         **     ****    ****"
BCLASS3   INIT      "*        *        *  *   *       *"
BCLASS4   INIT      "*        *       *    *   ****    ****"
BCLASS5   INIT      "*        *       ******       *       *"
BCLASS6   INIT      "*     *  *       *    *  *    *  *    *"
BCLASS7   INIT      " *****   ******  *    *   ****    ****"
.
BPOST1    INIT      "******"
BPOST2    INIT      "*     *   ****    ****    *****    **     ****   ******"
BPOST3    INIT      "*     *  *    *  *          *     *  *   *    *  *"
BPOST4    INIT      "******   *    *   ****      *    *    *  *       *****"
BPOST5    INIT      "*        *    *       *     *    ******  *  ***  *"
BPOST6    INIT      "*        *    *  *    *     *    *    *  *    *  *"
BPOST7    INIT      "*         ****    ****      *    *    *   ****   ******"
.
.**********************************************************************
.*                       GLOBAL VARIABLES                             *
.**********************************************************************
SRCHNUM   FORM      3
ABNORMAL  DIM       1
BANNLINE  DIM       55
BALANCE   FORM      8.2
BALDISP   DIM       12
BOTTMARG  FORM      2
BRANFR    DIM       8
BRANTO    DIM       8
CANDATE   DIM       10
CLAIMDAT  DIM       8
CLRANFR   DIM       6
CLRANTO   DIM       6
COFFDATE  DIM       8
COUNTER   FORM      4
CMDLINE   DIM       50
DATE      DIM       8
DATELINE  DIM       20
DBMFR     DIM       10
DBMTO     DIM       10
DBMRANFR  DIM       8
DBMRANTO  DIM       8
DBRANFR   DIM       10
DBRANTO   DIM       10
DCEASEFL  FORM      1
DCLRANFR  DIM       6
DCLRANTO  DIM       6
DEXT      DIM       3
DIMAGE    DIM       3
DIMOUTN   DIM       8
DIM14     DIM       14
DIM30     DIM       30
DIM33     DIM       33
DIM55     DIM       55
DIM70     DIM       70
DISPSTRN  DIM       1200
DOCLINE   DIM       33
DOCLINE2  DIM       62
DOCTNAM   DIM       33
DSSRANFR  DIM       6
DSSRANTO  DIM       6
DSTRANFR  DIM       6
DSTRANTO  DIM       6
DUMMY     DIM       1
DURRANFR  DIM       8
DURRANTO  DIM       8
ECLINTYP  DIM       6
ENDSTR    FORM      2
EOUTCOME  DIM       3
FRMTTIME  DIM       8
FDATE     DIM       19
FFOLDATE  DIM       19
FIRSTCH   FORM      1
FLAGGLET  FORM      1
FLAGIDNO  FORM      1
FLAGSURN  FORM      1
FLAGVIST  FORM      1
FLAGFOLL  FORM      1
FLAGABNY  FORM      1
FLAGABNN  FORM      1
FLAGBALN  FORM      1
FLAGLLET  FORM      1
FLAGLDAT  FORM      1
PRFIXA    INIT      "OUT71A"
PRFIXB    INIT      "OUT71B"
PRNTLONG  FORM      1
FOLLDAT1  DIM       8
FOLLDAT2  DIM       8
FOLLDAY   FORM      2
FOLFORM1  FORM      6
FOLFORM2  FORM      6
FOLLMON   FORM      2
FOLLYEAR  FORM      2
FOLTEST   DIM       6
FORM3A    DIM       3
FORM8     FORM      8
FSTATUS   FORM      1
FULLNAME  DIM       52
FVISDATE  DIM       19
IDDIM1    DIM       8
IDDIM2    DIM       8
IDNO      FORM      8
IDNO1     FORM      8
IDNO2     FORM      8
IHINUMBR  DIM       20
INITIAL   DIM       4
INVDIM    DIM       12
INVNUM    DIM       8
ISERASE   INIT      "iserase "
ITEMAMT   FORM      12.2
TOTALAMT  FORM      12.2
KEY21A    DIM       21
KEY26A    DIM       26        * required for OUTINVCD
LEFTMARG  FORM      2
LETDESC   DIM       25
LETTER    DIM       3
LETTFORM  FORM      3
LLETDAT1  DIM       8
LLETDAT2  DIM       8
LETDAY    FORM      2
LETFORM1  FORM      6
LETFORM2  FORM      6
LETMON    FORM      2
LETTEST   DIM       6
LETYEAR   FORM      2
LINE      DIM       60
LETRTYPE  DIM       1                       * S = Standard , M = Miscellaneous
LTTYPIND  DIM       1        * Letter Type Indicator, R - Referral Letter
MEDNUM    DIM       10
MFOLNDAT  DIM       10     FOR MAM DELETE LATER
MLETPLEN  FORM      3
MONTH     DIM       9
NAMELINE  DIM       52
OTLPUID   DIM       10
OTLPLOGN  DIM       80 
PATDOB    DIM       8
PATCOUNT  FORM      4
PAIDDIM   DIM       12
PCLSDATE  DIM       8
PERCPOS   FORM      2
PHYSPAGE  FORM      3
POS       FORM      2
PROVNUMB  DIM       10
PRTSTRNG  DIM       1200
PRTSTR70  DIM       70
RDOCADDA  DIM       30
RDOCADDB  DIM       30
RDOCPOST  DIM       4
RDOCSUB   DIM       15
REFDOCT   DIM       33
REFRDATE  DIM       8
REFRPERD  FORM      6
RESHFROM  DIM       20
RESHTIME  DIM       8
RESHTO    DIM       20
RESPNAME  DIM       52
RESPADDA  DIM       25
RESPADDB  DIM       25
RESPSUBR  DIM       15
RESPPOST  DIM       4
.
SAVKEY20  DIM       20
SITEDONE  FORM      1
SMFLAG    FORM      1
SAVESITE  DIM       6
SCLINTYP  DIM       6
SDFNAME   DIM       8
SP40      DIM       40
SSRANFR   DIM       5
SSRANTO   DIM       5
STATUS    DIM       1
STARTSTR  FORM      2
STATDESC  DIM       20
STRANFR   DIM       6
STRANTO   DIM       6
SURN1     DIM       20
SURN2     DIM       20
SOUTCOME  DIM       3
SPOSTCLS  DIM       1
TEMP3     FORM      3
TABLNA    DIM       60
TEMP55    DIM       55
TEMP70    DIM       70
TESTFORM  FORM      6
TODAY     DIM       8
TOPMARG   FORM      2
TOTLPAID  FORM      8.2
TOTALDIM  DIM       12
TOTALINV  FORM      8.2
VTRANFR   DIM       3
VTRANTO   DIM       3
URDIM     DIM       8
URRANFR   DIM       8
URRANTO   DIM       8
VARD127   DIM       127
VDOCADDA  DIM       30
VDOCADDB  DIM       30
VDOCPOST  DIM       4
VDOCSUB   DIM       15
VERTPOS   FORM      2
VISDAT1   DIM       8
VISDAT2   DIM       8
VISDAY    FORM      2
VISFORM1  FORM      6
VISFORM2  FORM      6
VISMON    FORM      2
VISTEST   DIM       6
VISYEAR   FORM      2
VTFR      DIM       6
VTTO      DIM       6
.
WORKGP    DIM       10
WORKDATE  DIM       8
WORKTIME  DIM       5
.
ZERO4     INIT      "0000"
ZERO8     INIT      "0000    "
Z15       INIT      "zzzzzzzzzzzzzzz"
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
ZEDS      INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
+
.
.         constants
.
XCOMMW    FILE      ASCII, FIXED=70
.
CATDO     INIT      "DO"
CODEA     INIT      "A "
CODEAC    INIT      "AC"
CODEC     INIT      "C "
CODECL    INIT      "CL"
CODECV    INIT      "CV"
CODEDA    INIT      "DA"
CODEDC    INIT      "DC"
CODEH1    INIT      "H1"
CODEH2    INIT      "H2"
CODEH3    INIT      "H3"
CATHP     INIT      "HP"
CODEM     INIT      "M "
CODEO1    INIT      "O1"
CODEO2    INIT      "O2"
CODEO3    INIT      "O3"
CODEO4    INIT      "O4"
CODEO5    INIT      "O5"
CODEO6    INIT      "O6"
CODEO7    INIT      "O7"
CODEO8    INIT      "O8"
CODEP1    INIT      "P1"
CODEP2    INIT      "P2"
CODEP3    INIT      "P3"
CODEP4    INIT      "P4"
CODEP5    INIT      "P5"
CODEP6    INIT      "P6"
CODEP     INIT      "P "
CODER     INIT      "R "
CODET     INIT      "T "
.CODEU1    INIT      "U1"
CODEV6    INIT      "V6"
CODEV7    INIT      "V7"
CODEV8    INIT      "V8"
CODEXM    INIT      "XM"
.
X20       INIT      "XXXXXXXXXXXXXXXXXXXX"
.
ADIAG     DIM       50
.
CN        INIT      "CN"
CHKRESCT  FORM      1
CODEADM   INIT      "A "
CODEBT    INIT      "BT"
CODEDP    INIT      "DP"
CURSESS   DIM       16
.
DIM9      DIM       9
DIM18A    DIM       18
DNAME     DIM       20
.
FHDUDT1   DIM       8
FHDUDT2   DIM       8
.
HCPDOCT   DIM       50
HDUDAY1   FORM      3                  * High Dependency
HDUDAY2   FORM      3
HDUFLG    FORM      "0"
.
.
LWCHG     FORM      6.2                * Labour Ward Fee
LWCODE    INIT      "LW"
LWDT      DIM       8
.
MAMLFLAG  FORM      1
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MBSLOP    FORM      2
MBSNUM    FORM      "0"
.
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCODE    INIT      "OT"
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8                  * Other Items
OTDT2     DIM       8
OTFLG     FORM      "0"
.
RADLFLAG  FORM      1
.
SAVECOL   FORM      2
SAVVERT   FORM      2
SAVHTOP   FORM      2
SURGFLG   FORM      "0"
.
THDUDT1   DIM       8
THDUDT2   DIM       8
THEACHG   FORM      6.2                * Theatre Fee
THEADT    DIM       8
THEADTE   DIM       8
.
DIM1A     DIM       1
DIM14A    DIM       14
DIM16     DIM       16
DIM18     DIM       18
.
ENDDTE    DIM       8
ENDNAM    DIM       6
.
ITEMCD    FORM      1
.
KEYFLAG   FORM      1
.
LASTREC   FORM      "0"
LINECNT   FORM      2
LNO       FORM      2
.
MINOWE    FORM      6.2
MULTAMT   FORM      8.2
MINFLD    FORM      2
MAXSCRN   FORM      2
.
OUT       INIT      "out"
ONAME     DIM       30
OPERCODE  DIM       4
.
PAGECNT   FORM      3
PSTROL    FILE      ASCII, FIXED=256
.
REGIST8   DIM       2
.
SAVSITE   DIM       6
SMCHARGE  DIM       9
SMITMTYP  FORM      1
SMMSCGRP  DIM       3
SADMNO    DIM       8
SAVADM    DIM       8
SAVDAT    DIM       8
SAVITEM   DIM       4
SAVMAMT   FORM      6.2
SAVTYP    FORM      1
SEC       FORM      5
SELFLG    FORM      "0"
SERFILNM  DIM       8
SERFILKY  INIT      " 22 UC1-8,9-13,14-21"
SP12      INIT      "            "
SP14      INIT      "              "
SPLING    FORM      2
STRTDAT   DIM       8
STRTNAM   DIM       6
.
TAMTT     FORM      6.2
TAMTP     FORM      6.2
TEMPAMT   FORM      6.2
THCFLG    FORM      2
THFUND    FORM      6.2
TPADM     FORM      6
TPREC     DIM       8
TPTRNO    FORM      3
TPUR      DIM       8
.
.**********************************************************************
.* Series booking temp print order file                               *
.**********************************************************************
TEMPSER1  IFILE     SQL, FIXED=22, KEY="U1-8,9-13,14-21"
.
.NAME     TYPE     LENGTH  PHYSICAL START DESCRIPTION
.----     ----     ------  -------- ----- -----------
XXXXDATE  DIM      8         8      1     DATE (CCYYMMDD)
XXXXTIME  DIM      5         5      9     SLOT TIME (HH:MM)
XXXXOUTN  DIM      8         8      14    OUTPATIENT NUMBER
.
.                  end of record   22
.
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FILE      ASCII, FIXED=256
.
XAMT      FORM      4.2
XMBS      FORM      5
XDESC     DIM       30
XXADM     DIM       8
XXDATE    DIM       8
XXMULT    FORM      2
XXNAM     DIM       22
.
.         Web Variables (only the include files use these variables)
.
DAYFORMT  DIM       4
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
MTHNAM3A  DIM       3
.
LETRCOMM  DIM       1                  * Letter Communication Method
.                                         0 or Blank = Printed Letter
.                                         1 = SMS Notification
CONTPNMS  DIM       200                * Pipe-delimited list of phone numbers
CONTMSGI  DIM       200                * Pipe-delimited list of msg id's
CONTTYPS  DIM       200                * Pipe-delimited list of contact types
MAXCOUNT  INIT      "10"               * Max count for SMS phone numbers
.
.         end web variables
.
ZTWO      FORM      "00"
ZEIGHT    INIT      "00000000"
.
.
.---------------------------------------------------------------------------
PRGID     INIT      "OUTWEB03"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Print Outpatient Forms"
.---------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
.
          CALL      INIT0000       * Open Files
          MOVE      ZERO,CHKRESCT  * initialise check reservations cycle counter
          COMMIT
.
.
MAIN0000  BEGIN
.
          DISPLAY   *W2
.
          ADD       ONE,CHKRESCT     * check reservations every 8 sec/4th cycle
          IF        CHKRESCT>=4
            CALL      RESSIT00       * Reservation Expiry Process by site
            MOVE      ZERO,CHKRESCT
          ENDIF
.
          COMMIT
.
          BEGIN
.
MAIN0100  PACK      KEY5,SP70
          CALL      RSOTLPC1
          CALL      RKOTLPC1
          BRANCH    OVRCD,MAIN0000
.
          MOVE      OTLPSCHE,KEY5
          CALL      RLOTLPC1
          BRANCH    OVRCD,MAIN0100,MAIN0100
.
          MOVE      OTLPSCHE,KEY5
          CALL      DEOTLPC1
.
.    move all the variables into the fields they need to be
.
          MOVE      OTLPSTIM,DIM5                * Set to 5 chars not 8
          PACK      CASEKEYS,OTLPSITE,OTLPCLIN,OTLPSDAT,DIM5,OTLPSLOT,SP70
          MOVE      OTLPPRNT,SELPRINT
          MOVE      OTLPPRNT,CDEFPRT   
          MOVE      OTLPPRNT,CDEFPRT2   
          MOVE      OTLPSTAT,HOMR3COD
          MOVE      OTLPCOPY,PRINTCNT
          MOVE      OTLPSITE,SITE
          MOVE      OTLPWEBU,WBSEUID
          MOVE      OTLPWEBU,OTLPUID
.
          PACK      KEY10,OTLPWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,PASSCODE
            MOVE      SP70,OTLPLOGN
          ELSE
            MOVE      WBSEPCD,PASSCODE       * Set Passcode for printing
            MOVE      WBSELOGN,OTLPLOGN      
          ENDIF
.
          
          MOVE      OTLPSITE,KEY6            * Key for the site file
          CALL      RDSITA1                  * Read the site record
          BRANCH    OVRCD,MAIN9000
          MATCH     OSTFILE,CFILEPRE         * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open Files
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MOVE      OTLPPTYP,F1
          BRANCH    F1,MAIN1100,MAIN1200,MAIN1300
          GOTO      MAIN9000
.
MAIN1100  MOVE      " 1",REPORTNO
          MOVE      ZERO,COUNTPRT
MAIN1110  ADD       ONE,COUNTPRT
          IF        COUNTPRT>PRINTCNT 
            GOTO       MAIN9000
          ENDIF
.
          CALL      PRTOUT00               * Print OutPatient Forms
          GOTO      MAIN1110
.
MAIN1200  MOVE      " 2",REPORTNO
          CALL      PRTLET00                 * Print OutPatient Letters
          GOTO      MAIN9000
.
MAIN1300  MOVE      " 3",REPORTNO
          CALL      PRTINV00                 * Print OutPatient Invoice
          MOVE      OTLPPRNT,SPLING  
          GOTO      MAIN9000
.
MAIN9000  COMMIT
          BEGIN
          GOTO      MAIN0100

.------------------------------------------------------------
.     Reservation Expiry Processing by site 
.------------------------------------------------------------
RESSIT00  MOVE      ZERO,SITEDONE           * This site prefix done = No
          PACK      KEY9,SP70
          CALL      RDSSITA3
RESSIT10  CALL      RDKSITA3
          BRANCH    OVRCD,RESSIT99
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEDONE         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEDONE,RESSIT10       * Skip if this site prefix is done
.
          CALL      RESERV00                * Check reservation expiry
          MOVE      ONE,SITEDONE            * This site prefix done = yes
.
          GOTO      RESSIT10
.
RESSIT99  RETURN
.------------------------------------------------------------
.     Reservation Expiry Processing
.------------------------------------------------------------
RESERV00  CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD   * Set todays date
          REP       " 0",TODAY
          CLOCK     TIME,TIMEIS
          MOVE      TIMEIS,KEY5
          PACK      KEY41,TODAY,KEY5,Z70  
          CALL      RSOTSRV2
RESERV10  CALL      RPOTSRV2
          BRANCH    OVRCD,RESERV99
.
          PACK      KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,RESERV10 
          IF        OBASTAT=9       
            MOVE      ZERO,OBASTAT     * Reset status to ZERO (Not Booked) only
            CALL      UPBOKA1          * if current status is 9 (Reserved)
          ENDIF
.
          PACK      KEY28,OTSRSITE,OTSRCLIN,OTSRSDAT,OTSRSTIM,OTSRSLOT,SP70
          CALL      RDOTSRV1
          BRANCH    OVRCD,RESERV10 
.
          CALL      DEOTSRV1
          GOTO      RESERV10      
.  
RESERV99  RETURN
.------------------------------------------------------------
.     Print OutPatients Invoice
.------------------------------------------------------------
PRTINV00  MOVE      OTLPBOOK,OBAOUTNO
          MOVE      OBAOUTNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRTINV99 
.
.        Read in Master file record record
.
          MOVE      PVIURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PRTINV99 
.
          CALL      GETB0000                 * Get patient details
          BRANCH    OVRCD,PRTINV99
.
          MOVE      ZERO,F2
PRTINV90  ADD       ONE,F2
          IF        F2>PRINTCNT
            GOTO       PRTINV99
          ENDIF
          GOTO      PRINTLN
.
PRTINV99  RETURN
.------------------------------------------------------------------------------
.         Subroutine to locate outpatient record given the Visit file details
.------------------------------------------------------------------------------
GETB0000  MOVE      ZERO,OVRCD               * Clear error flag
          MOVE      PVISITE,OBASITE          * Site code
          MOVE      PVIURNO,OBAURNO          * U/R number
.
          MOVE      PVISITE,KEY6             * For this site ...
          CALL      RDSITA1                  * Get file prefix
          BRANCH    OVRCD,OVERCOND           * No site record - error
.
          PACK      CFNAME,OSTFILE,FILBB1A2  * Set up physical filename
          CALL      OPOTBB12
          PACK      KEY16,PVIDATE,PVIBILL    * Key is date & outpatient no.
          CALL      RDBOKB2                  * Read record
          CLOSE     OUTBB1A2                 * Close logical file
          BRANCH    OVRCD,OVERCOND           * No record - error
.
          CLOSE     OUTDTRO1                 * Close currently open dtran file
          PACK      CFNAME,OSTFILE,FILDTRO1  * Set up physical filename
          OPEN      OUTDTRO1,CFNAME          * Open new dtran file
          RETURN
+
PRINTLN   DISPLAY   *P1:4,*EF;
.
.        Calculate the amount of the invoice and determine if two invoices
.        are required (already done if we are in option 5)
.
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          CALL      OPOTBB11
          MOVE      ONE,PROGFLAG
          COMPARE   FIVE,OPTION
          CALL      OUTTBI IF NOT EQUAL
.
          BRANCH    CVIEWIP,LOCKADM
          BRANCH    OPTION,LOCKADM,LOCKADM,LOCKADM
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          PACK      A8DATE,CDAY,SLASH,CMON,SLASH,CYEAR
          PACK      A10DATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          MOVE      SP8,D8DATE
.
DDETLS  
.        Lock the outpatient record to stop anyone else from using it
.
LOCKADM   MOVE      OBASITE,KEY8             * For this site ...
          CALL      RDSITA1                  * get the file prefix
.
          PACK      KEY8,OBAOUTNO            * Outpatient number is the key
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          CALL      OPOTBB11
          CALL      RLOTBOB1                 * Lock record
          MOVE      PVISITE,OBASITE          * Load site code for later use
          MOVE      PVIURNO,OBAURNO          * Load u/r no. for later use
.
          COMPARE   ZERO,GROSSTOT
          CALL      PRNTINV0 IF NOT EQUAL
          GOTO      UNLOCKA

UNLOCKA   PACK      KEY8,OBAOUTNO            * Outpatient number is the key
          CALL      UUOTBOB1                 * Lock record
          CLOSE     OUTBB1A1                 * Close file
.
.        If not a batch of invoices, goto next invoice
.
          BRANCH    OPTION OF REPEAT1,REPEAT1
.
.        INVPRTD : 0=Invoice printed
.                  1=Not printed
.                  2=Not printed & batch canceled
.
          BRANCH    INVPRTD OF REPEAT1,ENDBTCH
.
.        CINVFF : 1 = Print FF after each invoice
.                 2 = Do not print FF after each invoice
.
          BRANCH    CINVFF OF PRTFF
          GOTO      REPEAT1
.
PRTFF     IF        PTCNINVL<>9
             PRINT     *F; *Single formfeed to seperate batched invoices
          ENDIF
          GOTO      REPEAT1
.
ENDBTCH   CLOSE     PATVISA2
.
          BRANCH    OPTION OF PRTINV90,PRTINV90,PRTINV90,PRTINV90
          GOTO      PRTINV90
.
.        This is used when returning from options 2 to 6
.
REPEAT1   BRANCH    OPTION,PRTINV90,PRTINV90,PRTINV90,PRTINV90,PRTINV90,PRTINV90
          GOTO      PRTINV90
.------------------------------------------------------------
.     Print OutPatients Letters
.------------------------------------------------------------
PRTLET00  MOVE      "Outpatient Letter Printing",SCHEDDSC
          MOVE      OTLPLETT,LETTER 
.
          MOVE      OTLPWEBU,TEMPPUID            * Setup printed by user id
.
          MOVE      ZERO,FORM3
          MOVE      LETTER,LETTFORM
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,PRTLET05
          MOVE      OTLTTYPE,LTTYPIND            * Set letter type indicator
.
PRTLET05  MOVE      ONE,FORM3              
          MOVE      LETTER,LETTFORM
          PACK      KEY6,LETTFORM,FORM3
          CALL      RDOTLET1
          BRANCH    OVRCD,PRTLET10
          MATCH     "!sh",OTLTTEXT
          GOTO      PRTLET10 IF NOT EQUAL
.
          MATCH     "R",LTTYPIND            * Is this referral letter?
          IF        !@EQUAL
            CALL      UNXLET00
          ELSE
            CALL      UNXRLT00              * Referral letter
          ENDIF
.
          GOTO      PRTLET99
.
PRTLET10  MATCH     "R",LTTYPIND            * Is this referral letter?
          IF        !@EQUAL
            CALL      BOKA0000
          ELSE
            MOVE      "Referral Letter Printing",SCHEDDSC
            MOVE      OTLPURNO,OBAURNO
            MOVE      OTLPBOOK,OBAOUTNO
            MOVE      OTLPSITE,OBASITE
            MOVE      OBAURNO,TEMPURNO
            MOVE      OBAOUTNO,TEMPOUTN
          ENDIF
.
          CALL      SET0000
          BRANCH    CEXIT,PRTLET99
.
          MATCH     "1",OTLPSERS
          GOTO      PRTLET12 IF NOT EQUAL
.
          CALL      GETS0000                  * Get series booking details
.
PRTLET12  CALL      VBOA0000
          CALL      VBOC0000
          MOVE      ONE,POSTCLSS
          IF        OTCNPSTC = 1
            MOVE      OBADATE,PCLSDATE
            CALL      CPCL0000
          ENDIF
.
          CALL     GOTP0000                   * got a patient- keep going      
.
          CALL     OPNPRINT
.
          MOVE     ZERO,COMPLETE
PRTLET80  ADD      ONE,COMPLETE
          IF       COMPLETE>PRINTCNT
            GOTO     PRTLET90
          ENDIF
.
          MOVE      SP1,LETRCOMM
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      PRTLET81 IF NOT EQUAL
.
          MOVE      ZERO,FORM3              * read letter file header record
          PACK      KEY6,LETTER,FORM3
          CALL      RDOTLET1
          IF        OVRCD=0
            MOVE      OTLTCOMM,LETRCOMM     * store our Communication Method
            MATCH     "1",LETRCOMM          * SMS Notification?
            IF        @EQUAL
              CALL      PRMSGH00            * print SMS Messages XML Header tag
            ENDIF
          ENDIF
.
PRTLET81  CALL     PRIN0000                 * print letter
          GOTO     PRTLET80
.
PRTLET90  MATCH     "1",LETRCOMM            * SMS Notification?
          IF        @EQUAL
            CALL      PRMSGF00              * print SMS Messages XML Footer tag
            MOVE      "OUTPTSMS",PRGID      * SMS printer default
          ENDIF
.
          CALL     CLSPRINT
          MOVE     "OUTWEB03",PRGID         * Restore PRGID to OUTWEB03
.
PRTLET99  MOVE     SP70,SCHEDDSC
          RETURN
.------------------------------------------------------------
. Unix/VCQ Letters
.------------------------------------------------------------
UNXLET00  PACK     KEY28,CASEKEYS                           
          CALL     RDBOKA1                   
          BRANCH   OVRCD,UNXLET99
.
          PACK     KEY8,OTLPBOOK,SP70
          CALL     RDOTCAN1                 * Check if appointment cancelled
          IF       OVRCD=0         
            MOVE     OPCNURNO,OBAURNO
            MOVE     OPCNOUTN,OBAOUTNO
          ENDIF
.
          CALL     OPNPRINT
          MOVE     ZERO,COMPLETE
UNXLET10  ADD      ONE,COMPLETE
          IF        COMPLETE>PRINTCNT
            GOTO       UNXLET90
          ENDIF
.
          CALL     LETEXE00                   * print letters
          GOTO     UNXLET10
.
UNXLET90  CALL     CLSPRINT
.
UNXLET99  RETURN
.------------------------------------------------------------
. Unix/VCQ Referral Letters 
.------------------------------------------------------------
UNXRLT00  PACK     KEY8,OTLPBOOK,SP70
          CALL     RDOTRFL1
          BRANCH   OVRCD,UNXRLT99
.
          CALL     OPNPRINT
.
          MOVE     ZERO,COMPLETE
UNXRLT10  ADD      ONE,COMPLETE
          IF        COMPLETE>PRINTCNT
            GOTO       UNXRLT90
          ENDIF
.
          CALL     LETEXR00                   * print referral letters
          GOTO     UNXRLT10
.
UNXRLT90  CALL     CLSPRINT
.
UNXRLT99  RETURN
.************************************************************************
.*                          BOKA0000                                    *
.*         Initialize and read thru boka file, getting all relevent pats*
.************************************************************************
BOKA0000  PACK      KEY28,CASEKEYS                           
          CALL      RDBOKA1                   
          IF        OVRCD=1
            CALL      CLOUTBOA                 * Clear all file fields
            PACK      KEY8,OTLPBOOK,SP70
            CALL      RDOTCAN1                 * Check if appointment cancelled
            BRANCH    OVRCD,BOKA9999
.
            MOVE      OPCNSITE,OBASITE       * Site Id
            MOVE      OPCNCLIN,OBACLIN       * Clinic Id
            MOVE      OPCNDATE,OBADATE       * Date (CCYYMMDD)
            MOVE      OPCNSTRT,OBASTRT       * Start Time (HH:MM)
            MOVE      OPCNSLOT,DOBASLOT      * Slot Number
            MOVE      OPCNSLOT,OBASLOT       * Slot Number
            MOVE      OPCNTIME,OBATIME       * Slot Time  (HH:MM)
            MOVE      OPCNCTYP,OBACTYP       * Clinic Type
            MOVE      OPCNURNO,OBAURNO       * U/R Number
            MOVE      OPCNVTYP,OBAVISIT      * Visit Type (N,R,S)(CV)
            MOVE      OPCNOUTN,DOBAOUTN      * Outpatient Number
            MOVE      OPCNOUTN,OBAOUTNO      * Outpatient Number
          ENDIF
.
          CALL     VBOA0000                   * set up file variables
          MOVE     ONE,POSTCLSS
          IF       OTCNPSTC = 1
            MOVE      OBADATE,PCLSDATE        * Postage class date
            CALL     CPCL0000                 * calculate the postage class
.                                               1 = 1st class 2 = 2nd class
          ENDIF
.
BOKA9999  RETURN
.**********************************************************************
.*                           SET0000                                  *
.*             Set up the values for all the "%" variables            *
.**********************************************************************
.
.------ read the temporary file ------
.
.-------  Test if are printing postage class banners -----
.
SET0000   IF        OTCNPSTC = 1
            MATCH     SPOSTCLS,POSTCLSS
            IF        !@EQUAL
              MOVE      POSTCLSS,SPOSTCLSS
              MOVE      POSTCLSS,FORM1

              PERFORM   FORM1,FCBN0000,SCBN0000
.                             "1st" or "2nd"  Class Banners
              CALL      CPBN0000            * print "Class Postage" Banner
            ENDIF
          ENDIF
.
          MATCH     SAVESITE,SITE
          IF        !@EQUAL
            MOVE      SITE,SAVESITE
            PACK      KEY6,SITE
            CALL      RDSITA1
            BRANCH    OVRCD,SET0000
.
            IF        OTCNLHIA = 1
              PACK      CFNAME,OSTFILE,FILLHIA1
              OPEN      OUTLHIA1,CFNAME     * outpatients letter file
            ENDIF
            PACK      CFNAME,OSTFILE,FILCLIA1
            OPEN      OUTCLIA1,CFNAME
            PACK      CFNAME,OSTFILE,FILCTYA1
            OPEN      OUTCTYA1,CFNAME
            PACK      CFNAME,OSTFILE,FILBOKA1
            OPEN      OUTBOKA1,CFNAME
            PACK      CFNAME,OSTFILE,FILBB1A1
            CALL      OPOTBB11
            PACK      CFNAME,OSTFILE,FILMA1A1
            CALL      OPOTMA11
            PACK      CFNAME,CFILEPRE,FILLKBA1
            OPEN      OUTLKBA1,CFNAME
          ENDIF
.
          CALL      SEVA0000
          BRANCH    CEXIT,SET9999
.
          MOVE      FALSE,EXIT
          GOTO      SET9999
.
SET9000   MOVE      TRUE,EXIT
.
SET9999   RETURN
.*****************************************************************************
.*                                 FCBN0000                                  *
.*                        Print "1st" in banner form                         *
.*****************************************************************************
.
FCBN0000
          CALL      UND80
          PRINT     *N,*N
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,FIRSTC1,FIRSTC2,FIRSTC3,FIRSTC4,FIRSTC5:
                                     FIRSTC6,FIRSTC7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
FCBN9999  RETURN
.*****************************************************************************
.*                                 SCBN0000                                  *
.*                        Print "2nd" in banner form                         *
.*****************************************************************************
.
SCBN0000
          CALL      UND80
          PRINT     *N,*N
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,SECONDC1,SECONDC2,SECONDC3,SECONDC4:
                                     SECONDC5,SECONDC6,SECONDC7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
SCBN9999  RETURN
.*****************************************************************************
.*                                 CPBN0000                                  *
.*                        Print "Class Postage" in banner form               *
.*****************************************************************************
.
CPBN0000
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,BCLASS1,BCLASS2,BCLASS3,BCLASS4:
                                     BCLASS5,BCLASS6,BCLASS7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
          MOVE      ONE,COUNT
          WHILE     COUNT < 8
            PACK      BANNLINE,SP30,SP30
            LOAD      BANNLINE,COUNT,BPOST1,BPOST2,BPOST3,BPOST4:
                                     BPOST5,BPOST6,BPOST7
            PRINT     BANNLINE
            ADD       ONE,COUNT
          DO
          PRINT     *N,*N
          CALL      UND80
          PRINT     *F
CPBN9999  RETURN
.
.************************************************************************
.*                          CPCL0000                                    *
.*                   Calculate The Postage Class                        *
.************************************************************************
.
CPCL0000 
          MATCH     PCLSDATE,COFFDATE
.
.---   If the cut-off date is less than "appointmnet" date - send 2nd class ---
.---   If cut off date is equal to the appointment date - send first class ----
.
          IF        @LESS
            MOVE      TWO,POSTCLSS
            GOTO      CPCL9999
          ENDIF
          IF        @EQUAL
            MOVE      ONE,POSTCLSS
            GOTO      CPCL9999
          ENDIF
.
.------   If the "appointment" date is less than today then send second class
.
          MATCH     TODAY,PCLSDATE
          IF        @LESS
            MOVE      TWO,POSTCLSS
            GOTO      CPCL9999
          ENDIF

.
.------   Else we have 1st class postage -----
.
          MOVE      ONE,POSTCLSS
.
CPCL9999  RETURN
.**********************************************************************
.*                             CASE0000                               *
.*  Routine to convert all except first character of each word to     *
.*        lower case                                                  *
.**********************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL            * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW                   * test to see if char is
          GOTO      CASE1100 IF EQUAL            *   a letter
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                     * any char but a letter
          *         found
.
CASE1100  OR        040,LINE                     * actual conversion to
          RESET     UPPLOW
          *         lower case (believe it
          *         or not!)
.
CASE2000  MOVE      ZERO,FIRSTCH                 * not on first char any
.                                                   *   more
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS          * move to next char
          RESET     LINE                         * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH                  * first char was a space
          GOTO      CASE3000
.
CASE9999  RETURN
.************************************************************************
.*                              TIME0000                                *
.*       Format the time in WORKTIME output in FRMTTIME                 *
.*                   called by :  VBOA VCAN                             *
.************************************************************************
TIME0000  UNPACK    WORKTIME,CHOUR,ANS,CMIN
          MOVE      CHOUR,FORM2
.
          IF        FORM2<12
            MATCH     "00",CHOUR                 * 00:45 becomes 12:45 am
            IF        @EQUAL
              MOVE      TEN2,FORM2 
            ENDIF
            MOVE      FORM2,CHOUR
            PACK      LINE,CHOUR,COLON,CMIN,SP1,AM   * am
          ELSE
            MATCH     "12",CHOUR                 * 22:45 becomes 10:45 pm
            IF        !@EQUAL
              SUB       TEN2,FORM2
              MOVE      FORM2,CHOUR
            ENDIF
            PACK      LINE,CHOUR,COLON,CMIN,SP1,PM   * pm
          ENDIF
.
          CALL      COMP0000                * supress zeros
          MOVE      LINE,FRMTTIME
.
          RETURN
+
.**********************************************************************
.*                              FDOC0000                              *
.*                 Routine to format doctors name                     *
.**********************************************************************
..FDOC0000  CLEAR     DOCLINE
.          CALL      RDDOCT1                        * read doctor file
.          BRANCH    OVRCD,FDOC7000
.          CLEAR     INITIAL
.          APPEND    SP1,INITIAL
.          MOVE      DGNAME,ANS
.          APPEND    ANS,INITIAL
.          APPEND    ". ",INITIAL
.          RESET     INITIAL
.          PACK      DOCLINE,DTITL,INITIAL,DSNAME   * pack formatted doctors
.          MOVE      DOCLINE,LINE                   *   name
.          CALL      COMP0000                       * compress blanks
.          CALL      CASE0000                       * convert to lower case
.          MOVE      LINE,DOCLINE
.          GOTO      FDOC9999
..
..------ doctors name does not exist ------
.
.FDOC7000  MOVE      "*********************************",DOCLINE
.          GOTO      FDOC9999
..
.FDOC9999  RETURN
.**********************************************************************
.*                           FDAT0000                                 *
.*                 Routine to format the date                         *
.**********************************************************************
FDAT0000  REP       " 0",WORKDATE
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT7000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT7000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                    DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                    DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                    MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          BUMP      CDAY
.
.------ pack the formatted date ------
.
FDAT1000  REP       " 0",CYEAR
          PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT7000  MOVE      "99th December 1999",DATELINE
.
FDAT9999  RETURN
.**********************************************************************
.*                              COMP0000                              *
.*       Routine to compress excessive blanks in LINE                 *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL        * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                        * compress multiple blanks
          GOTO      COMP8000 IF EOS              *   from in-between words
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
.------------------------------------------------------------
.     Print OutPatients Forms
.------------------------------------------------------------
PRTOUT00  MATCH     SP70,CASEKEYS
          GOTO      PRTOUT20 IF NOT EQUAL
.
          MOVE      OTLPBOOK,ADMISSNO                                  *I-53708
.
          MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          COMPARE   ONE,OVRCD
          IF        @EQUAL
            PACK      DWCADMNO,SP70
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          COMPARE   ONE,OVRCD
          IF        @EQUAL
            CALL      CLPMSWX1
          ELSE
            MATCH     "3",PMWXCSTA        * Cancelled Claim
            IF        @EQUAL
              PACK      WCCLMNO,SP70
              CALL      CLPMSWX1
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,PRTOUT93 
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PRTOUT93  
.
          PACK      CASEKEYS,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDSBOKA1
PRTOUT10  CALL      RDKBOKA1
          BRANCH    OVRCD,PRTOUT93 
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH     KEY20,CASEKEYS
          GOTO      PRTOUT93 IF NOT EQUAL
          MATCH     OBAOUTNO,PVIBILL         * Set up billing number    
          GOTO      PRTOUT10 IF NOT EQUAL
.
PRTOUT20  MOVE      CASEKEYS,SAVKEY28
          MOVE      CASEKEYS,KEY28
          MOVE      CASEKEYS,SITE
.
          PACK      KEY6,SITE,SP10
          CALL      RDSITA1                                * Get Site
          BRANCH    OVRCD,PRTOUT90                         * No Site
.
          UNPACK    CASEKEYS,VSITE,VCLIN,VDATE,VTIME,DIM127
          CALL      GSES0000                * Get the session selected
          BRANCH    EXIT,PRTOUT91
.
          PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,PRTOUT93
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
.
          MOVE      OBAURNO,TEMPURNO
          MOVE      TEMPURNO,KEY8
          CALL      RDPMPX21                * Read Master Extention file
.
          MOVE      OTLPBOOK,KEY8
          CALL      RDWCOM1
          COMPARE   ONE,OVRCD
          IF        @EQUAL
            PACK      WCCLMNO,SP70
          ENDIF
.
          MOVE      OTLPBOOK,TEMPOUTN                                  *C-53708
          PACK      KEY8,TEMPOUTN           * Read Visit Extention file
          CALL      RDPMVX11
.
          MOVE      OTLPBOOK,KEY8                                      *I-53708
          CALL      RDBOKB1
          BRANCH    OVRCD,PRTOUT93
.
          MOVE      OTLPBOOK,KEY8
          CALL      RDPMWX11
          COMPARE   ONE,OVRCD
          IF        @EQUAL
            CALL      CLPMSWX1
          ELSE
            MATCH     "3",PMWXCSTA          * Cancelled Claim
            IF        @EQUAL
              PACK      WCCLMNO,SP70
              CALL      CLPMSWX1
            ENDIF
          ENDIF
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
.
          PACK      KEY25,VSITE,VCLIN,VDATE,VTIME,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PRTOUT94
.
          PACK     KEY28,OSESITE,OSECLIN,DOSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PRTOUT95
.
          IF        IBCNMHOS=1
            PACK      KEY3,OTHEHOSP,SP70
            CALL      RDPTHSP1
          ENDIF
.
          MATCH     "HICCLM",OTLPSTAT
          IF        @EQUAL
            MOVE      "Medicare Claim Form",SCHEDDSC
            CALL      PHIC0000                * Print HIC Claim Form
          ELSE
            MATCH     "INTREF",OTLPSTAT
            IF        @EQUAL
              MOVE      "Internal Referral",SCHEDDSC
              CALL      PREF0000                * Print MR3
            ELSE
              MOVE      "Outpatient Form Printing",SCHEDDSC
              CALL      PMR30000                * Print MR3
            ENDIF
          ENDIF
          MOVE      SP70,SCHEDDSC
.
          MOVE      ZERO,EXIT
          GOTO      PRTOUT99
.
PRTOUT90  CLEAR     WEBTITLE
          APPEND    "Invalid Site Code  - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
          GOTO      PRTOUT99
.
PRTOUT91  MOVE      "Session Not Found",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT        
          GOTO      PRTOUT99
.
PRTOUT93  MOVE      "Error reading booking file.",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
.
PRTOUT94  MOVE      "Session not found.",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
.
PRTOUT95  MOVE      "Schedule record not found",WEBTITLE
          CALL      PRTERR00
          MOVE      ONE,EXIT
.
PRTOUT99  RETURN
+
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATDO1A1,"patdo1af" 
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATGO1A1,"patgo1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATMA1A1,"patma1af" 
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMX1A1,"patmx1af" 
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PATRE1A1,"patre1af" 
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWMAB1,"patwmabf"                                *I-59546
          OPEN      PATWC1A1,"patwc1af"                                *I-59546
          OPEN      PMSWX1A1,"pmswx1af"                                *I-59546
          OPEN      PRIDOCT1,"pridoctf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      IBASEQA1,"ibaseqaf"
          OPEN      PMSCEXA1,"pmscexaf"
.
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATFINS1,"patfinsf"
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATIRNG1,"patirnge"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATREMD1,"patremdf"
          OPEN      PATCODE1,"patcodes"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PMSCCDA1,"pmsccdaf"                                *I-59546
.
          OPEN      WEBERRA1,"weberraf" 
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA2,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PATHGRP1,"pathgrpf"
.
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      IBAGSTA2,"ibagstaf"
.
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      HICCITA1,"hiccitaf"
          OPEN      HICCLMA2,"hicclmaf"
.
          OPEN      VISCMTA1,"viscmtaf"
.
          OPEN      OUTBOKC1,"outbokcf"
          OPEN      OUTTHIA1,"outthiaf"
          OPEN      OUTSITA1,"outsitaf"
          OPEN      OUTSITA3,"outsitaf"
          OPEN      OUTDIAG1,"outdiagf"                                *I-58732
          OPEN      OUTSIPA1,"outsipaf"
.
          CALL      TFILENAM               * Series booking print order temp
          MOVE      TFILNAME,SERFILNM      * file
.
.
          MOVE      "OUT   ",KEY6          * Key for the site file
          CALL      RDSITA1                * Read the site record
          IF        OVRCD=1
            MOVE      "      ",KEY6        * Key for the site file
            CALL      RDSSITA1             * Read the site record
            CALL      RDKSITA1             * Read the site record
          ENDIF
          MOVE      OSTFILE,CFILEPRE     * Save Current File Prefix
          MOVE      OSTFILE,UID
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00             * Open Outpatient Files
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD   * Set todays date
          REP       " 0",TODAY
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY;*196,PTCNUCRD
          READ      CONTROLF,THIRTY1;*138,HOMR3L,*139,HOMR3COD:
                                     *214,OTCNPSTC,*215,OTCNNDAY:
                                     *218,OTCNLHIA,*225,OTCNSLET
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,NINTY8;*148,PTCNINVB
          READ      CONTROLF,HUND03;*60,PTCNOPND,*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,THIRTY2;*150,OTCNGPSO
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
.-------  If we are uing postage classes then calculate the cut off date ----
.
          IF        OTCNPSTC = 1
            CALL      COFF0000
          ENDIF
.
.         Read in parameters
.
          READ      CONTROLF,ZERO;*2,CDD,CMM,CYY,CCC:
                                  *85,IBCNUGST
          READ      CONTROLF,TEN;*54,CFILENO,*66,CINVLAY,*79,CAPPRVNO:
                                 *94,CAGECOFF,*96,CNEXTINV:
                                *166,CMEMB,*183,CVIEWIP
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2,CHPPOST:
                                  CHTELEB,*211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TWENTY;*193,PTCNDCLM,*198,PTCNPIOP
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*60,PTCNCCRR,PTCNCLOR:
                                    *136,PTCNMITM,*138,PTCNNHII,*174,PTCNDONR:
                                    *178,PTCNMPTR,*190,PTCNPCON:
                                    *200,PTCNICRA,*235,PTCNDPL8,*237,PTCNPAOF
          READ      CONTROLF,THIRTY;*132,HSTANDM,HINVDES
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,OTCNCFEE,*203,OTCNPZIN:
                                     *219,OTCNIVUR
          READ      CONTROLF,THIRTY2;*57,OTCNOTIH,*63,OTCNOTIT
          READ      CONTROLF,FIFTY9;*66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR
          READ      CONTROLF,EIGHTY8;*86,CDAILYDT
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND28;*210,PTCNSTYP
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"    * IHI Details
          ENDIF
.
          UNPACK    CDAILYDT,XCENT,XYEAR,XMON,XDAY
          MOVE      XCENT,CC
          MOVE      XYEAR,YY
          MOVE      XMON,MM
          MOVE      XDAY,DD
.
          MATCH     SP3,PTCNDCLM
          GOTO      INIT0200 IF NOT EQUAL
          MOVE      "0  ",PTCNDCLM
.
.         Setting DISPROG to a one means that the comments maintenance will
.         not lock or unlock the Out Patient record (which doesn't exist for
.         outpatients anyway)
.
INIT0200  MOVE      ONE,DISPROG
.
INIT9999  RETURN
.------------------------------------------------------------
. Log Printing Error to Web Error Log
.------------------------------------------------------------
PRTERR00  CLOCK     TIME,CTIMEIS
          MOVE      "OUTWEB03",PRGID
          PACK      KEY24,PRGID,CCC,CYY,CMM,CDD,CTIMEIS,SP70
          REP       " 0",KEY24
          CALL      RDWBER1
          IF        OVRCD=0
            GOTO      PRTERR99
          ENDIF
          UNPACK    KEY24,WBERPID,WBERDAT,WBERTIM
          MOVE      WEBTITLE,WBERERR
          MOVE      USERID,WBERUID
          MOVE      REPORTNO,WBERREP
          MOVE      TEMPLATE,WBERTMP
          MOVE      URNUMBER,WBERURN
          MOVE      ADMISSNO,WBERVIS
          MOVE      PRGERRCT,F3
          MOVE      F3,WBERCNT
          MOVE      SP70,WBERSPA
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRWBER1
          TRAPCLR   IO
.
PRTERR99  RETURN
.****************************************************************************
.*                             COFF0000                                     *
.*                       Calculate the cutt-off date                        *
.****************************************************************************
COFF0000  UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       OTCNNDAY,JULDAY
          MOVE      JULYR,JWKYER
          MOVE      JULDAY,JWKDAY
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      COFFDATE,CC,YY,MM,DD
          REPLACE   " 0",COFFDATE
.
COFF9999  RETURN 
.
..------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA2  * Get the name of the BOKA2 file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA4  * Get the name of the BOKA4 file
          CLOSE     OUTBOKA4
          OPEN      OUTBOKA4,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA2 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA2 file
          CLOSE     OUTSESA2
          OPEN      OUTSESA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA1 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILLKBA1  * Get the name of the LKBA1 file
          CLOSE     OUTLKBA1
          OPEN      OUTLKBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                  * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11                  * Open the file
. 
          OPEN      OUTLETR1,"outletrf"
          OPEN      OUTLETR2,"outletrf"
          OPEN      OUTLPCA1,"outlpcaf"
          OPEN      OUTRF1A1,"outrf1af"
          OPEN      OUTRF1A5,"outrf1af"
.
          PACK      CFNAME,CFILEPRE,FILXWPA1
          CLOSE     OUTXWPA1
          OPEN      OUTXWPA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILLHIA1
          CLOSE     OUTLHIA1
          OPEN      OUTLHIA1,CFNAME           * outpatients letter file
.
          PACK      CFNAME,CFILEPRE,FILSRVA1
          CLOSE     OUTSRVA1
          OPEN      OUTSRVA1,CFNAME    
          PACK      CFNAME,CFILEPRE,FILSRVA2
          CLOSE     OUTSRVA2
          OPEN      OUTSRVA2,CFNAME    
.
          RETURN
.------------------------------------------------------------
.  Get the session for the current clinic/date/time
.------------------------------------------------------------
GSES0000  PACK      VSESS,VSITE,VCLIN,VDATE,VTIME
          PACK      KEY28,VSESS,SP6         * starting key for this session
          CALL      RDSBOKA1                * Position at the start
          CALL      RDKBOKA1                * Read first record of session
          BRANCH    OVRCD,GSES9900          * Session not found
.
          MOVE      OBADAY,VDAY             * save day
.
          MOVE      ZERO,EXIT
          GOTO      GSES9999
.
GSES9900  MOVE      ONE,EXIT
GSES9999  RETURN
.------------------------------------------------------------
. Prints MR3 - routine modified from OUTPRG66
.------------------------------------------------------------
PMR30000  MATCH     ZEROUR,OBAURNO           * Do we have a U/R Number ?
          GOTO      PMR39999 IF EQUAL        * No.
.
.------ MR3 wanted ------
.
PMR31000  MOVE      FOUR,CPPAPER             * Paper type for MR3's
          MOVE      CDEFPRT2,CDEFPRT         * Printer for MR3's
.
          OPEN      PATFN1A1,"patfn1af"
          OPEN      IBATDET1,"ibatmdaf"
          OPEN      IBATMHA1,"ibatmhaf"
.
          BRANCH    HOMR3L,PMR33000
.
.------ Print the MR3 for Layout 1 - Modbury ------
.
PMR32000  CALL      SETLMR3
          CALL      PRTMR3
.
          MOVE      "Printing Complete",WEBTITLE
          GOTO      PMR39000
.
.------ Print the MR3 for Layout 2 - User Defined Stationery ------
.
PMR33000  MOVE      HOMR3COD,KEY6
          CALL      RDIBTH1               * read the template header file
          BRANCH    OVRCD,PMR33900
.
          CALL      GVCI0000               * Get visit card information
.
          PACK      CFNAME,OSTFILE,FILXSCA1
          OPEN      OUTXSCA1,CFNAME         * extra screen file
.
          CALL      PRTMR3N2               * print the MR3
          BRANCH    EXIT,PMR33800
.
          MOVE      "Printing Complete",WEBTITLE
          GOTO      PMR39000
.
PMR33800  MOVE      "No Template details on file.  ",WEBTITLE
          MOVE      ONE,EXIT
          GOTO      PMR39000
.
PMR33900  MOVE      "Stationery Code not on file.  ",WEBTITLE
          MOVE      ONE,EXIT
PMR39000  CALL      PRTERR00
PMR39999  RETURN
+
.------------------------------------------------------------
. Print HIC Claim Form
.------------------------------------------------------------
PHIC0000  CALL      SETHIC00                * setup
          BRANCH    EXIT,PHIC9000
.
          CALL      PRTHIC00                * print
.
          GOTO      PHIC9999
.
PHIC9000  MOVE      "Error Printing Medicare Claim",WEBTITLE
          CALL      PRTERR00
PHIC9999  RETURN
+
.------------------------------------------------------------
. Setup HIC Claim Form Details
.------------------------------------------------------------
SETHIC00  PACK      KEY16,OTLPBOOK,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * read last hic claim record
          BRANCH    OVRCD,SETHIC95
.
          MATCH     OTLPBOOK,HCCLVISN
          GOTO      SETHIC95 IF NOT EQUAL   * Different visit number
.
          PACK      KEY16,HCCLVISN,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                * get referral link
          BRANCH    OVRCD,SETHIC95
.
          MATCH     HCCLVISN,ALLNLNKV
          GOTO      SETHIC95 IF NOT EQUAL   * same visit?
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                * get referral record
          BRANCH    OVRCD,SETHIC95
.
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY     
          CALL      PACDATE
          REP       " 0",CPDATE
          MOVE      CPDATE,REFRDATE         * date of referral
.
          MOVE      ZERO,REFRPERD
          PACK      KEY5,ANSR,ANSI,ALRERTYP
          CALL      RDCODE1
          BRANCH    OVRCD,SETHIC20
.
          COMPARE   ZERO,TCFORM6
          IF        @EQUAL
            MOVE    NINTY9,REFRPERD
            GOTO      SETHIC20
          ENDIF
.
          ASSIGN    ((TCFORM6/365)*12),FORM62   * referral period
          MOVE      FORM62,REFRPERD
.
SETHIC20  PACK      PROVNUMB,SP70           * initialise provider number
          PACK      HCPDOCT,SP70           * initialise referring hcp name
          MATCH     SP70,ALREFHCP
          IF        !@EQUAL
            MOVE      ALREHCPP,PROVNUMB     * hcp provider number (free format)
            MOVE      ALREFHCP,HCPDOCT      * hcp name (free format)
            GOTO      SETHIC50
          ENDIF
.
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,SETHIC50          * cannot find referring hcp
.
          PACK      KEY20,ALRERHCP,ALRERHCR,SP70
          CALL      RDPMHCL1
          IF        OVRCD<>1
            MOVE      PMHLPRV1,PROVNUMB     * hcl provider number
          ELSE
            MOVE      PMHCPRV1,PROVNUMB     * hcp provider number
          ENDIF
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                * format hcp name
          PACK      HCPDOCT,DOCFNAME,SP70
.
SETHIC50  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY     
          CALL      PACDATE
          REP       " 0",CPDATE
          MOVE      CPDATE,PATDOB          * patient date of birth
.
          UNPACK    HCCLDATE,CCENT,CYEAR,CMON,CDAY     
          CALL      PACDATE
          REP       " 0",CPDATE
          MOVE      CPDATE,CLAIMDAT        * date of claim
.
          MOVE      SP70,SERVPROV
          MATCH     SP70,OTBBADCS          * Check for actual doctor seen
          GOTO      SETHIC60 IF EQUAL
.
          PACK      KEY10,OTBBADCS,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,SETHIC60
.
          MATCH     SP70,PMHCLDOC
          GOTO      SETHIC60 IF EQUAL
.
          MOVE      PTCNOPND,PRDOPIND       * patient indicator for outpatient
.
          PACK      KEY10,PMHCLDOC,SP70
          PACK      KEY22,HCCLMPRA,KEY10,OBACOMP,PRDOPIND
          CALL      RDPRDO1
          BRANCH    OVRCD,SETHIC60
          MATCH     SP70,PRDOPROV
          GOTO      SETHIC60 IF EQUAL
.
          PACK      KEY10,PRDODOCT,SP70   * Associated Doctor
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            PACK      SERVPROV,DOCFNAME,SP70
          ELSE
            PACK      SERVPROV,PRDODOCT,SP70
          ENDIF
          MOVE      PRDOPROV,HCCLPSRV        * use the actual doctor seen
          GOTO      SETHIC70
.
SETHIC60  PACK      KEY20,HCCLSITE,HCCLCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1                *To get Clinic ID Description
          IF        OVRCD=0
            MATCH     HCCLSITE,OCASITE
            IF        @EQUAL
              MATCH     HCCLCLID,OCACLIN
              IF        @EQUAL
                MOVE      OCADESC,SERVPROV    * service provider
              ENDIF
            ENDIF
          ENDIF
.
SETHIC70  MOVE      SP1,DIM1
          SCAN      SP1,PGNAME
          GOTO      SETHIC90 IF NOT EQUAL
.
          BUMP      PGNAME
          MOVE      PGNAME,DIM1             * save given name initial
          BUMP      PGNAME,-1
          MOVEFPTR  PGNAME,CCITEM
          RESET     PGNAME
          SETLPTR   PGNAME,CCITEM           * save first given name
.
          MATCH     SP70,PSUBRB
          IF        @EQUAL
            MOVE      PADD2,DIM35
          ELSE
            MOVE      PSUBRB,DIM35
          ENDIF
.
SETHIC90  MOVE      ZERO,EXIT               * hicclaim record exists
          GOTO      SETHIC99
.
SETHIC95  MOVE      ONE,EXIT                * hicclaim record doesn't exist
SETHIC99  RETURN
+
.------------------------------------------------------------
. Print HIC Claim Form Details
.------------------------------------------------------------
PRTHIC00  MOVE      SP1,KEY1
          CALL      OPNPRINT
.
          PRINT     "CREATEFORMDB4":
                    *N,"medicaredb4":
                    *N,"MEDICARE",SP20,"DB4":
                    *N,"Assignment Form No",SP1,PURNO,"/",HCCLCLMN
.
          PRINT     *N,*1,"Medicare Number ",*17,PMEDI:
                      *50,"Ref. No. ",*59,PTMXMCCD:
                    *N,*1,"First Name ",*12,PGNAME,*38,"Initial ",*46,DIM1:
                      *50,"Surname ",*58,PSNAME:
                    *79,"Date of Birth ",*93,PATDOB:
                    *N,*1,"Residential Address ",*21,PADD1:
                    *N,*21,DIM35,*57,PPOST
.
          PRINT     *N,*1,"ServDate",*10,"MBS Item":
                      *20,"Description of Service":
                      *51,"Benefit Assignd",*67,"  Total Benefit":
                      *83,"Provider Use"
.
          MOVE      "11",CLNO                * nine lines have been printed
          MOVE      ZERO,TOTALAMT
.
PRTHIC10  PACK      KEY18,HCCLCLMN,HCCLVISN,SP70
          CALL      RSHCCIT1
PRTHIC15  CALL      RKHCCIT1                * loop through claim items
          BRANCH    OVRCD,PRTHIC90
.
          MATCH     HCCLCLMN,HCCICLMN
          GOTO      PRTHIC90 IF NOT EQUAL   * check claim number
.
          MATCH     HCCLVISN,HCCIVISN
          GOTO      PRTHIC90 IF NOT EQUAL   * check visit number
.
          UNPACK    HCCIIDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPDATE
          MOVE      CPDATE,SERVDATE         * date of service
.
          MOVE      HCCICAMT,ITEMAMT
.
          PRINT      *1,SERVDATE,*10,HCCIITMN,*20,HCCIIDES,*51,ITEMAMT:
                    *83,HCCIPUSE
.
          ADD       ITEMAMT,TOTALAMT        * add to total
          ADD       ONE,CLNO
          GOTO      PRTHIC15
.
PRTHIC90  IF        CLNO < 16
            PRINT   *N;
            ADD       ONE,CLNO              * always print 5 item lines
            GOTO    PRTHIC90
          ENDIF
          PRINT     *67,TOTALAMT
.
          PRINT     *N,*1,"Referring Practioner ":
                      *52,"Prov No. ":
                      *63,"RefrDate":
                      *72,"RefPrd "
          PRINT     *1,HCPDOCT,*52,PROVNUMB,*63,REFRDATE,*72,REFRPERD
.
          PRINT     *N,*1,"Service Provider ":
                      *52,"Prov No. "
          PRINT     *1,SERVPROV,*52,HCCLPSRV
.
          CALL      CLSPRINT
PRTHIC99  RETURN
+
.------------------------------------------------------------
. Print HIC Claim Form
.------------------------------------------------------------
PREF0000  CALL      SETHIC00                * setup
          BRANCH    EXIT,PREF9000
.
          CALL      PRTREF00                * print
.
          GOTO      PREF9999
.
PREF9000  MOVE      "Error Printing Internal Referral.",WEBTITLE
          CALL      PRTERR00
PREF9999  RETURN
+
.------------------------------------------------------------
. Print Internal Referral Details
.------------------------------------------------------------
PRTREF00  MOVE      SP1,KEY1
          CALL      OPNPRINT
.
          PRINT     "CREATEFORMREF":
                    *N,"InternalReferral"
.
          PRINT     *N,*1,"Patient Name ",*21,PGNAME,*47,DIM1:
                    *51,PSNAME:
                    *N,*1,"U/R Number",*21,PURNO
.
          PRINT     *N,"Dear Dr":
                    *N,"(Please specify Name and Department)":
                    *N,*1,"I am referring the above patient to you":
                    " for further investigation of: "
.
          PRINT     *N,*1,"Referring Doctors Name: ",*38,HCPDOCT:
                    *N,*1,"Referring Doctors Provider Number: ",*38,PROVNUMB:
                    *N,*1,"Date of Referral:",*38,REFRDATE:
                    *N,*1,"Period of Referral:",*38,REFRPERD
.
          CALL      CLSPRINT
PRTREF99  RETURN
+
.------------------------------------------------------------
.         Get the card visit information
.         Routine from OUTPRG66.
.------------------------------------------------------------
GVCI0000  MOVE      SP20,PTVKCARD
          MOVE      SP10,PTVKCEXP
          MOVE      SP10,PTVKCXMP
          MOVE      SP10,PTVKCOMP
.
          COMPARE   ONE,PTCNUCRD
          GOTO      GVCI9999 IF NOT EQUAL   * not using card information
.
          OPEN      PATVKCA1,"patvkcaf"
          MOVE      OBAOUTNO,PTVKBILL
          MOVE      PTVKBILL,KEY8
          CALL      RDPTVKC1
          CLOSE     PATVKCA1
.
GVCI9999  RETURN
.-------------------------------------------------
. Format Doctors Given Name
.-------------------------------------------------
DOCGIV00  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV00 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
.         Check for any more names
.
          SETLPTR   NAME35,35              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME35,CCITEM          * reset to this point
          PACK      KEY35,NAME35,SP70      * reset form pointer
          MOVE      KEY35,NAME35

DOCGIV10  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV10 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this Initial
.
          UNPACK    NAME35,KEY1,KEY50
          APPEND    KEY1,DISPNAME
          APPEND    SP1,DISPNAME
.
          GOTO      DOCGIV99
.
.         Rest of the string is one name
.
DOCGIV20  UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
DOCGIV99  RETURN
.------------------------------------------------------------
. Process Template Fields
.------------------------------------------------------------
PROFLD00  
PROFLD99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,SBWINDOW
          MOVE      SP70,STATNCOD
          MOVE      SP70,CASEKEYS
          MOVE      SP70,SELPRINT
          MOVE      SP70,NOCOPIES
.
          MOVE      ZERO,PRINTCNT
          MOVE      SP70,LTTYPIND
.
          MOVE      ZERO,LETRCOMM
          PACK      CONTPNMS,SP70,SP70,SP70
          PACK      CONTMSGI,SP70,SP70,SP70
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbwindow=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SBWINDOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Get detail of all series bookings linked to this master booking
.------------------------------------------------------------
GETS0000  CALL      CLRS0000                * Clear series booking print vars
          CALL      CSER0000                * Create series booking temp file
.
          PACK      KEY24,OTLPURNO,OTLPBOOK,SP70
          CALL      RDOTLKB1
          BRANCH    OVRCD,GETS9000
.
          MOVE      OTLKOBOK,OTLKLBOK
          CALL      WRTS0000                * Write booking to temp file
.
GETS1000  CALL      RKOTLKB1
          BRANCH    OVRCD,GETS7000
.
          MATCH     OTLKURNO,OTLPURNO       * Same U/R
          GOTO      GETS7000 IF NOT EQUAL
.
          MATCH     OTLKOBOK,OTLPBOOK       * Same series booking original
          GOTO      GETS7000 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      GETS1000 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      GETS7000 IF EQUAL
.
          CALL      WRTS0000                * Write booking to temp file
          GOTO      GETS1000
.
GETS7000  CALL      SETS0000                * Set series booking %vars
.
          PACK      KEY28,CASEKEYS           * Restore original booking record
          CALL      RDBOKA1
          BRANCH    OVRCD,GETS9000
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,GETS9000
.
          MOVE      "Unknown clinic",OCADESC                 * Get Clinic Name
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      GETS9000
          ENDIF
.
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,GETS9000               * Get Clinic Name
.
          MATCH     OBASITE,OCASITE
          IF        @EQUAL
            MATCH     OBACLIN,OCACLIN
            GOTO      GETS9000 IF EQUAL
          ENDIF
.
          MOVE      "Unknown clinic",OCADESC

GETS9000  CALL      DSER0000                * Delete series booking temp file
.
GETS9999  RETURN
.
.------------------------------------------------------------
. Delete the series booking print order temp file
.------------------------------------------------------------
DSER0000  CLOSE     TEMPSER1                  * close temp file
.
          CLEAR     CMDLINE                   * clear command line
          PACK      CMDLINE,ISERASE,SERFILNM  * set command line for erase
          RESET     CMDLINE                   * reset FP
          EXECUTE   CMDLINE,TASKID            * delete the temp file
.
DSER9999  RETURN
.
.------------------------------------------------------------
. Create the series booking print order temp file
.------------------------------------------------------------
CSER0000  CALL      DSER0000                * Delete series booking temp file
.
          CLEAR     CMDLINE                           * clear command line
          PACK      CMDLINE,ISBUILD,SERFILNM,SERFILKY,SP30     * set command
          RESET     CMDLINE                           * reset FP
          EXECUTE   CMDLINE,TASKID                    * build the temp file
          OPEN      TEMPSER1,SERFILNM                 * open the temp file
.
CSER9999  RETURN
.
.------------------------------------------------------------
. Write series booking to temp file for print order
.------------------------------------------------------------
WRTS0000  PACK      KEY36,OTLKLBOK,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,WRTS9999
.
          MATCH     DOBAOUTN,OTLKLBOK       * Check series booking admiss no
          GOTO      WRTS9999 IF NOT EQUAL
.
          MATCH     OBAURNO,OTLKURNO        * Check if it is the correct U/R
          GOTO      WRTS9999 IF NOT EQUAL
.
          PACK      XXXXDATE,OBADATE
          PACK      XXXXTIME,OBATIME
          PACK      XXXXOUTN,OBAOUTNO
.
          PACK      KEY21,XXXXDATE,XXXXTIME,XXXXOUTN,SP70
          CALL      RATEMPS1
          IF        OVRCD=1
            CALL      WRTEMPS1
          ENDIF
.
WRTS9999  RETURN
.
.------------------------------------------------------------
. Set the series booking % variables
.------------------------------------------------------------
SETS0000  MOVE      ONE,SERIESNO            * Start at series number 1
.
          PACK      KEY21,SP70
          CALL      RSTEMPS1
SETS1000  CALL      RKTEMPS1
          BRANCH    OVRCD,SETS9999
.
          PACK      KEY36,XXXXOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,SETS1000
.
          MATCH     DOBAOUTN,XXXXOUTN       * Check series booking admiss no
          GOTO      SETS1000 IF NOT EQUAL
.
. Clinic id
.
          STORE     OBACLIN,SERIESNO,LXSCLN01,LXSCLN02,LXSCLN03,LXSCLN04:
                                  LXSCLN05,LXSCLN06,LXSCLN07,LXSCLN08:
                                  LXSCLN09,LXSCLN10
.
. Booking date
.
          MOVE      OBADATE,WORKDATE
          CALL      FDAT0000                * format resched. from date
          STORE     DATELINE,SERIESNO,LXSBDT01,LXSBDT02,LXSBDT03,LXSBDT04:
                                      LXSBDT05,LXSBDT06,LXSBDT07,LXSBDT08:
                                      LXSBDT09,LXSBDT10
.
. Booking time
.
          MOVE      OBATIME,WORKTIME
          CALL      TIME0000
          STORE     FRMTTIME,SERIESNO,LXSBTM01,LXSBTM02,LXSBTM03,LXSBTM04:
                                     LXSBTM05,LXSBTM06,LXSBTM07,LXSBTM08:
                                     LXSBTM09,LXSBTM10
.
. Booking day
.
          LOAD      KEY10,OBADAY,DMON,DTUE,DWED,DTHU,DFRI,DSAT,DSUN
          STORE     KEY10,SERIESNO,LXSBDY01,LXSBDY02,LXSBDY03,LXSBDY04:
                                   LXSBDY05,LXSBDY06,LXSBDY07,LXSBDY08:
                                   LXSBDY09,LXSBDY10
.
          MOVE      "Unknown clinic",OCADESC                 * Get Clinic Name
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      SETS2000
          ENDIF
.
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,SETS2000               * Get Clinic Name
.
          MATCH     OBASITE,OCASITE
          IF        @EQUAL
            MATCH     OBACLIN,OCACLIN
            GOTO      SETS2000 IF EQUAL
          ENDIF
.
          MOVE      "Unknown clinic",OCADESC
.
. Clinic desc
.
SETS2000  STORE     OCADESC,SERIESNO,LXSCDS01,LXSCDS02,LXSCDS03,LXSCDS04:
                                     LXSCDS05,LXSCDS06,LXSCDS07,LXSCDS08:
                                     LXSCDS09,LXSCDS10
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SETS9000
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSC,ANST,OTMALTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETS9000
.
. Locatoin type
.
          STORE     TDESC,SERIESNO,LXSBLN01,LXSBLN02,LXSBLN03,LXSBLN04:
                                   LXSBLN05,LXSBLN06,LXSBLN07,LXSBLN08:
                                   LXSBLN09,LXSBLN10
.
SETS9000  ADD       ONE,SERIESNO            * Add one to series number
          GOTO      SETS1000
.
SETS9999  RETURN
.
.------------------------------------------------------------
. Initialise the series booking % variables to spaces
.------------------------------------------------------------
CLRS0000  PACK      LXSCLN01,SP70
          PACK      LXSCLN02,SP70
          PACK      LXSCLN03,SP70
          PACK      LXSCLN04,SP70
          PACK      LXSCLN05,SP70
          PACK      LXSCLN06,SP70
          PACK      LXSCLN07,SP70
          PACK      LXSCLN08,SP70
          PACK      LXSCLN09,SP70
          PACK      LXSCLN10,SP70
          PACK      LXSCDS01,SP70
          PACK      LXSCDS02,SP70
          PACK      LXSCDS03,SP70
          PACK      LXSCDS04,SP70
          PACK      LXSCDS05,SP70
          PACK      LXSCDS06,SP70
          PACK      LXSCDS07,SP70
          PACK      LXSCDS08,SP70
          PACK      LXSCDS09,SP70
          PACK      LXSCDS10,SP70
          PACK      LXSBDT01,SP70
          PACK      LXSBDT02,SP70
          PACK      LXSBDT03,SP70
          PACK      LXSBDT04,SP70
          PACK      LXSBDT05,SP70
          PACK      LXSBDT06,SP70
          PACK      LXSBDT07,SP70
          PACK      LXSBDT08,SP70
          PACK      LXSBDT09,SP70
          PACK      LXSBDT10,SP70
          PACK      LXSBTM01,SP70
          PACK      LXSBTM02,SP70
          PACK      LXSBTM03,SP70
          PACK      LXSBTM04,SP70
          PACK      LXSBTM05,SP70
          PACK      LXSBTM06,SP70
          PACK      LXSBTM07,SP70
          PACK      LXSBTM08,SP70
          PACK      LXSBTM09,SP70
          PACK      LXSBTM10,SP70
          PACK      LXSBLN01,SP70
          PACK      LXSBLN02,SP70
          PACK      LXSBLN03,SP70
          PACK      LXSBLN04,SP70
          PACK      LXSBLN05,SP70
          PACK      LXSBLN06,SP70
          PACK      LXSBLN07,SP70
          PACK      LXSBLN08,SP70
          PACK      LXSBLN09,SP70
          PACK      LXSBLN10,SP70
          PACK      LXSBDY01,SP70
          PACK      LXSBDY02,SP70
          PACK      LXSBDY03,SP70
          PACK      LXSBDY04,SP70
          PACK      LXSBDY05,SP70
          PACK      LXSBDY06,SP70
          PACK      LXSBDY07,SP70
          PACK      LXSBDY08,SP70
          PACK      LXSBDY09,SP70
          PACK      LXSBDY10,SP70
.
CLRS9999  RETURN
.
.------------------------------------------------------------
. Procedure to get Doctor Code from Outpatient Clinic ID
. COPTION - 1 Return DOCTCODE
.           2 Output Location
.           3 (N/A)
.           4 Output Menu Type
.           5 Output Unit
.------------------------------------------------------------
          DEFPROC  OUTDET00
.
          INC      OUTPREFD/INC
          INC      OUTCLIFD/INC
          INC      OUTBOAFD/INC
          INC      OUTMA1FD/INC
          INC      OUTBB1FD/INC
.
KEYBOA    DIM      28
KEYCLI    DIM      20
.
          MOVE     SP70,DOCTCODE
          COMPARE  ZERO,PVITYPE
          GOTO     OUTDET50 IF EQUAL
.
          PACK     KEY6,PVISITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,PVISITE,PVIDOCT,PVIDATE,SP70
          BRANCH   COPTION,OUTDET60
.
          PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYBOA,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL     RDSBOKA1
OUTDET10  CALL     RDKBOKA1
          BRANCH   OVRCD,OUTDET95
          PACK     KEYBOA,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH    KEY20,KEYBOA
          GOTO     OUTDET95 IF NOT EQUAL
          MATCH    OBAOUTNO,PVIBILL         * Set up billing number
          GOTO     OUTDET10 IF NOT EQUAL
          GOTO     OUTDET80
.
OUTDET50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     OUTPREA1,"outpreaf"   * Pre Attendance File
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
          MOVE     ADMISSNO,KEY8
          CALL     RDPREA1               * Check for Pre-Attendance
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY6,OPRSITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,OPRSITE,OPRCLIN,OPRDATE,SP70
          PACK     KEYBOA,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
.
          BRANCH   COPTION,OUTDET60,OUTDET70,OUTDET70,OUTDET70
.
OUTDET60  MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILCLIA1 * Determine Doctor from Clinic ID
          TRAP     OVERCOND IF IO
          OPEN     OUTCLIA1,KEY8         * Clinic Details
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY20,KEYCLI,Z70  * Read for Current Effective Clinic
          CALL     RDSCLIA1
          CALL     RDPCLIA1
          BRANCH   OVRCD,OUTDET95
.
          MOVE     OCADOCT,DOCTCODE
          MATCH    SP70,DOCTCODE
          IF       @EQUAL
            MOVE     OCACCONS,DOCTCODE
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET70  PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          MOVE     KEYBOA,KEY28
          CALL     RDBOKA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET80  IF       COPTION=4
            PACK     MENUTYPE,TWO,OBASTAT * Outpatient Booking
            MOVE     ZERO,EXIT
            GOTO     OUTDET99
          ENDIF
.
          IF       COPTION=5
            PACK     CFNAME,OSTFILE,FILBB1A1
            CALL     OPOTBB11
            MOVE     ADMISSNO,KEY8
            CALL     RDBOKB1
            IF       OVRCD=0
              MATCH    SP6,OTBBDEPT
              GOTO     OUTDET95 IF EQUAL
              MOVE     OTBBDEPT,CODE       * Unit code
              MOVE     ZERO,EXIT
            ENDIF
            GOTO     OUTDET99
          ENDIF
.
          MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILMA1A1  * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTMA1A1,KEY8          * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL     RDMASA1
          BRANCH   OVRCD,OUTDET95
.
          WRITE    HTMLFILE;OTMACLOC;
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET95  MOVE     ONE,EXIT
          GOTO     OUTDET99
.
          INC       OUTCLIIO/INC
          INC      OUTPREIO/INC
          INC       OUTBOAIO/INC
          INC       OUTMA1IO/INC
          INC       IBAOVRIO/INC
          INC       OUTBB1IO/INC
.
OUTDET99  ENDPROC
.------------------------------------------------------------
. Procedure to get Emergency Details
.   COPTION = 1 Return Consultant DOCTCODE
.             2 Output Location
.             3 Output Triage Status
.             4 Output Menu Type
.------------------------------------------------------------
          DEFPROC  EMRCHK00
.
          INC      EMRVISFD/INC
          INC      EMRLOCFD/INC
.
EMRCHK10  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     EMRVISA1,"emrvisaf"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRCHK90
.
          MOVE     ADMISSNO,KEY8
          CALL     RDEMVIS1
          BRANCH   OVRCD,EMRCHK90
.
          COMPARE  FOUR,EMVISTAT
          GOTO     EMRCHK90 IF EQUAL
.
          MOVE     EMVIDOCT,DOCTCODE
          IF       COPTION=4
            PACK     MENUTYPE,ONE,EMVISTAT
            GOTO     EMRCHK99
          ENDIF
          IF       COPTION=2
            IF       EMVISTAT=1
              OPEN     EMRLOCA1,"emrlocaf"
              MOVE     "Other Departments",EMLODESC
              MOVE     EMVILOCN,KEY3
              CALL     RDEMLOC1
              WRITE    HTMLFILE;"Emergency - ",EMLODESC;
            ELSE
              WRITE    HTMLFILE;"Discharged";
            ENDIF
          ENDIF
          IF       COPTION=3
            WRITE    HTMLFILE;EMVITRIG;
          ENDIF
          GOTO     EMRCHK99
.
EMRCHK90  MOVE     PVIDOCT,DOCTCODE
          IF       COPTION=2
            WRITE    HTMLFILE;"Emergency";
          ENDIF
          GOTO     EMRCHK99
.
          INC      EMRVISIO/INC
          INC      EMRLOCIO/INC
          INC       IBAOVRIO/INC
.
EMRCHK99  ENDPROC
+
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.
RATEMPS1  RESET     KEY21
          MOVE      ZERO,OVRCD
          READ      TEMPSER1,KEY21;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTEMPS1  RESET     KEY21
          READ      TEMPSER1,KEY21;;
          RETURN
.
RKTEMPS1  MOVE      ZERO,OVRCD
          READKS    TEMPSER1;XXXXDATE,XXXXTIME,XXXXOUTN
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMPS1  RESET     KEY21
          WRITE     TEMPSER1,KEY21;XXXXDATE,XXXXTIME,XXXXOUTN
          RETURN
+
.
          INC       IBAWEBCD    
          INC       AGECHK
          INC       CALCAGE
          INC       CALCYRS
          INC       CLOUTBOA
          INC       GTIHINUM
          INC       OUTDSCLN
          INC       OUTMR3N2
          INC       OUTPRMR3
          INC       PMIGTNID
          INC       PACADDRS
          INC       PATDOCCD
          INC       PATPAOFS
          INC       PRTALCPW
          INC       PMSCEXCD
          INC       OUTPLTCD
          INC       DATECONV
          INC       OUTINVCD
          INC       NAMSTRCD
          INC       CLPMSCEX
          INC       PRNTICDC
.
          INC       COMDEPIO/INC
          INC       IBAGSTIO/INC
          INC       PATDSCIO/INC
          INC       PATFINIO/INC
          INC       PATIRNIO/INC
          INC       PATITMIO/INC
          INC       PATMI1IO/INC
          INC       OUTCANIO/INC 
          INC       PATPR1IO/INC
          INC       PATGSRIO/INC
          INC       PATREMIO/INC
          INC       PATINVIO/INC
          INC       OUTLPCIO/INC
          INC       OUTRSHIO/INC 
          INC       OUTLHIIO/INC
          INC       PATDTRIO/INC
.
          INC       PATCRAIO/INC
          INC       PATECDIO/INC
          INC       PATMCHIO/INC
          INC       IBATMDIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       MLTCFNIO/INC
          INC       OUTDIAIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOCIO/INC
          INC       OUTSESIO/INC
          INC       OUTCLIIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSITIO/INC
          INC       OUTLETIO/INC
          INC       OUTRF1IO/INC
          INC       OUTXSCIO/INC
          INC       PMSEXTIO/INC
          INC       PMSEVTIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCLIO/INC
          INC       PMSTLEIO/INC
          INC       PATHSPIO/INC
          INC       OUTCTYIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATGO1IO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC
          INC       PATMA1IO/INC
          INC       PATNIDIO/INC
          INC       PATVKCIO/INC
.
          INC       IBAGSTKY
          INC       IBAGKIKY
          INC       TFILENAM
.
          INC       CLPATINV
          INC       CLPATINP
          INC       CLPMSWX1
          INC       PATGBCRN          * I-48227
          INC       OUTCATBI
          INC       PRTIPROV
          INC       PATCALFN
          INC       PATINVTL
          INC       PATINVHL
          INC       PRTINVBD
          INC       GETALTID
          INC       PMSOSDTM                * Outstanding Debt alert routine
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       SMSMESID
          INC       PRBILCMN
.
          INC       NZPFINIO/INC
          INC       NZPFIGIO/INC
          INC       NZPRFNIO/INC
          INC       NZPCFNIO/INC
.
          INC       PATINPIO/INC
          INC       PATIPRIO/INC
          INC       ALLLNKIO/INC
          INC       ALLREFIO/INC
          INC       HICCITIO/INC
          INC       HICCLMIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       OUTSRVIO/INC
          INC       PATIN1IO/INC
          INC       PATINLIO/INC
          INC       IBAGEDIO/INC
          INC       OUTDTRIO/INC
          INC       OUTXWPIO/INC
          INC       PATDRGIO/INC
          INC       PATFIGIO/INC
          INC       PATICDIO/INC
          INC       PATIPEIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATTFEIO/INC
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PMSMTIIO/INC
          INC       PMSPX2IO/INC
          INC       PMSCCDIO/INC                                       *I-59546
          INC       PMSVX1IO/INC
          INC       PMSPRGIO/INC
          INC       PRIDOCIO/INC
          INC       PATATRIO/INC
          INC       MULBIR00
.
          INC       RCPBDTIO/INC
          INC       RCPBNKIO/INC
          INC       RCPCRSIO/INC
          INC       RCPDTEIO/INC
          INC       OUTHTRIO/INC
          INC       OUTLKBIO/INC
          INC       OUTHEDIO/INC
          INC       OUTSIPIO/INC
          INC       OUTTHIIO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PATHGPIO/INC
          INC       VISCMTIO/INC
          INC       PMSIHIIO/INC       * IHI Details
.
          INC       SMSPRXML           * Print XML metatags for SMS
.
