******************************************************************************
.
.        PATCATAI.PBL  -  THIS IS FOR ALREADY INVOICED
.        ------------     -----------------------------
.
.        USED BY IBAAAE02, IBAAAE20, IBABIL09, IBABIL20, IBABIL21, IBAHOS32,
.                IBAHOS94, IBAPAT32, IBAPAT34, IBAOUT20, IBAOUT66, IBAPRI12
.                PATWEB76
.CALCTAI
.
.        VERSION :
.------------------------------------------------------------------------------
.         V12.00.03 06/10/2025  J.Tan          TSK 0966784
.                   Fixed printing ICD10 on multi page of invoice
.         V12.00.02 15/07/2025  J.Tan          TSK 0961277
.                   Mod Print Patient invoice NOT to display zero patient amt
.         V12.00.01 23/05/2025  J.Tan          TSK 0955096
.                   Added Alphanumeric visit number changes
.         V11.05.01 25/11/2024 Thanh T         TSK 0946085
.                   Changed DSNZC000 to show statement reference data when
.                   the Display Statement Reference (nzprivate) parameter
.                   is turned on.
.------------------------------------------------------------------------------
.         V11.04.03 11/06/2024  J.Tan          TSK 0946701
.                   Fixed calculating items(amt x quantity) greater than FORM6P2
.         V11.04.02 05/05/2024  J.Tan          TSK 0927259
.                   Mod checking for parameter 'Print claim' (PTCNPRCL) and 
.                   Print ICD10 (PTCNPICD - PRNTICDC)
.         V11.04.01 20/12/2023  J.Tan          TSK 0936664
.                   Mod D6WEB000 to add GST journal amount
.         V11.03.02 06.11.2023  DA Sarkies     TSK 0936664
.                   Added code to display journals to dicharge invoices where
.                   journals have been included
.         V11.03.01 10/03/2023  J.Tan          TSK 0924587
.                   Added IPATFLAG=2 for printing Patient Invoice (PTCNPPIN=1)
.         V11.00.01 11/03/2020  J.Tan          TSK 0838262
.                   Added Effective from and to date to MBS Item file
.         V10.15.02 07/01/2020  J.Tan          TSK 0882754
.                   Fixed PRACC000 to pack key with DIM1 - printing Accomm.
.         V10.15.01 03/01/2019  J.Tan          TSK 0886176
.                   Mod for ABF charge description
.         V10.14.03 19/09/2019  J.Tan          TSK 0857392
.                   Mod for ABF Outpatient
.         V10.14.02 28/06/2019  J.Tan          TSK 0857392
.                   Mod for ABF invoice
.         V10.14.01 21/03/2019  J.Tan            TSK 0857392
.                   Changed RCP Transaction count from DIM3 to DIM5
.         V10.13.01 07/12/2013 J.Tan         TSK 0859743
.                   Mod for OTRECTYP=6 for Theatre item
.         V10.07.02 29/01/2016  J.Tan         CAR 303942
.                   Mods for Payment types
.         V10.07.01 18/11/2015  J.Tan         CAR 303942
.                   Added new payment types
.         V10.06.03 08/09/2015  J.Tan          CAR 317216
.                   Fixed displaying credit notes routine to valiadate adm.no
.         V10.06.02 14/08/2015  J.Tan          CAR 320073
.                   Fixed printing unreleased cash description (DIM12A)
.         V10.06.01 03/06/2015  J.Tan          CAR 316116
.                   Fixed printing cash PDET0000 (use SAVKEY12 instead of KEY12)
.         V10.05.04 29/10/2014  J.Tan          CAR 307268
.                   Mods Mechanical Vent. item to print/display MV From date
.         V10.05.03 27/10/2014  J.Tan          CAR 302440
.                   Fixed UNRL000-incl.Unreleased Banked receipt(Alloc.Suspense)
.         V10.05.02 29/09/2014  J.Tan          CAR 291619
.                   Mods Mechanical Vent. item NOT to print/display date
.         V10.05.01 06/08/2014  Peter Vela     CAR 302164
.                   Added Rebate Reason in D8TYP100
.         V10.04.04 24/06/2014  J.Tan          CAR 302586
.                   Fixed printing cheque drawer
.         V10.04.03 23/06/2014  J.Tan          CAR 302586
.                   Fixed CHKAM000 to reposition rcpbdtaf file
.                   Fixed printing cheque drawer
.         V10.04.02 27/02/2014  J.Tan          CAR 275810
.                   Mods to print Defence force details
.         V10.04.01 03/01/2013  J.Tan          CAR 273713
.                   Mods to print payment types of a Receipt
.         V10.03.19 21/11/2013  J.Tan          CAR 294151
.                   Fixed displaying Discharge billing with zero amt of Lumpsum
.         V10.03.18 25/09/2012  J.Tan          CAR 283618
.                   Mods for Independence Services Billing
.         V10.03.17 25/09/2012  J.Tan          CAR 281515
.                   Mods Disc.billing to exclude items
.         V10.03.16 25/09/2013 Peter Vela CAR 290782
.                   Added new display wweights for
.                   ACHA in D8TYP100
.         V10.03.15 05/09/2012  J.Tan          CAR 267784
.                   Mods to Check for TCINDC19 Claim Contract Eff.'Disc.From'
.         V10.03.14 31/07/2012  J.Tan  CAR 268318
.                   Mods to display Percentage of Emergency Procedure fee
.         V10.03.13 31/07/2012  J.Tan  CAR 270216
.                   Fixed printing emergency procedure rates
.         V10.03.12 19/07/2012 J.Tan  CAR 257771
.                   Mods SX invoice to print Theatre duration column
.         V10.03.11 16/05/2012  J.Tan  CAR 265293
.                   Fixed Disch.Billing stat.for items with multiple quantity
.         V10.03.10 26/04/2012  J.Tan  CAR 264231
.                   Fixed printing Invoice total
.         V10.03.09 28/03/2012  J.Tan  CAR 262761
.                   Fixed printing unreleased cash description
.         V10.03.08 08/03/2012  J.Tan          CAR 261468
.                   Fixed to display Win/Loss for invoice with journal/cash
.         V10.03.07 02/02/2012  J.Tan          CAR 235425
.                   Fixed second line of description for printing Credit note
.         V10.03.06 06/01/2011  J.Tan  CAR 257430
.                   Fixed printing blank lumpsum description
.         V10.03.05 24/11/2011 J.Tan           CAR 237245
.                   Mods Johns Hopkins invoice - printing rounding
.         V10.03.04 16/11/2011 J.Tan           CAR 237245
.                   Mods Johns Hopkins invoice - printing negative rounding
.         V10.03.03 14/11/2011  J.Tan  CAR 235425
.                   Mods for SX invoice layout
.                   Fixed printing Credit notes for Inv.layout <> SJOG
.         V10.03.02 10/11/2011 J.Tan           CAR 237245
.                   Fixed printing the last page of JH invoice with journal
.         V10.03.01 10/11/2011  J.Tan          CAR 235425
.                   Mods SX invoice to display quantity and long item desc.
.         V10.02.07 04/11/2011 J.Tan           CAR 237245
.                   Mods Johns Hopkins invoice to print rounding amount
.         V10.02.06 24/10/2011  J.Tan  CAR 253765
.                   Fixed printing receipts date
.         V10.02.05 10/10/2011  J.Tan  CAR 252727
.                   Fixed to generate lumpsum description for blank DTR lumpsum
.         V10.02.04 23/09/2011  J.Tan  CAR 251774
.                   Fixed I*C for IBABIL21
.         V10.02.03 18/07/2011  J.Tan
.                   Mods to use maxline number of lines from parameter
.         V10.02.02 17/06/2011  Jill Parkinson CAR 242412
.                   Mods to read rcpbnkaf for aae and out before PAYD0000
.         V10.02.01 19/04/2011 J.Tan      CAR 237245
.                   Mods for Johns Hopkins invoice to print Insurance provider
.         V10.01.05 04/04/2011  Ebon Clements CAR 233156
.                   Populate transaction number in RDKDTRAN
.         V10.01.04 12/01/2011  J.Tan         CAR 230716
.                   Fixed Lumpsum with No payday
.         V10.01.03 08/12/2009  J.Tan             CAR 234706
.                   Mods SX receipt to print RECEIPT in capital letters   
.         V10.01.02 24/11/2010  Ebon Clements CAR 233156
.                   Added JournalEnquiry() link to D6WEB000
.         V10.01.01 19/11/2010  J.Tan         CAR 230716
.                   Fixed display/print Lumpsum with no payday
.         V10.00.13 25/10/2010  Davin         CAR 231481
.                   Added ward provider number (getwpr00) for tac claims
.         V10.00.12 22/10/2010 J.Tan         CAR 231497
.                   Mods to print Event visit Attending doctor for HEC
.         V10.00.11 13/10/2010 J.Tan         CAR 229937
.                   Fixed printing Cabrini multiple pages
.         V10.00.10 08/10/2010 J.Tan         CAR 231497
.                   Fixed printing service doctor for HEC
.         V10.00.09 07/10/2010 J.Tan         CAR 231497
.                   Fixed printing Emergency Attending doctor for HEC
.         V10.00.08 23/09/2010 J.Tan         CAR 230664
.                   Mods for HEC invoice layout - PTCNINVL=18
.         V10.00.07 16/09/2010 J.Tan         CAR 229937
.                   Fixed Cabrini multiple pages of invoice
.         V10.00.06 26/08/2010 J.Tan         CAR 228845
.                   Fixed lumpsum description for expired contract id
.         V10.00.05 25/08/2010 J.Tan         CAR 228192
.                   Added column for quantity on invoice screen
.         V10.00.04 28/07/2010  J.Tan             CAR 226975
.                   Fixed printing Credit note (I*C on htmlfile)
.         V10.00.03 21/06/2010  J.Tan             CAR 218905
.                   Fixed printing number of accommodation days for SJOG
.         V10.00.02 16/06/2009  J.Tan             CAR 223982
.                   Mods to display balance payable after credit note
.         V10.00.01 10/05/2009  J.Tan             CAR 218766
.                   Fixed printing Cash for SX
.         V9.12.15  01/03/2009  J.Tan             CAR 217108
.                   Mods to display SX win/loss for invoice with journals/cash
.         V9.12.14  13/01/2009  J.Tan             CAR 235378
.                   Fixed printing lumpsum for daycase
.         V9.12.13  08/12/2009  J.Tan             CAR 235378
.                   Fixed Lumpsum for No Pay Day
.         V9.12.12  24/11/2009  J.Tan             CAR 210064
.                   Fixed printing unit price of Misc.item for SJOG
.         V9.12.11  09/11/2009  J.Tan         CAR 188108
.                   Fixed printing/displaying zero lumpsum amount
.         V9.12.13  28/10/2009  J.Tan             CAR 206791
.                   Fixed printing Deposit payments for Discharge Billing Stat
.         V9.12.12  27/10/2009  J.Tan             CAR 208761
.                   Fixed Non-banked payment to check for admission number
.         V9.12.11  13/10/2009  J.Tan         CAR 188108
.                   Mods to print/display zero lumpsum amount
.         V9.12.10  25/09/2009  Saroeun Soeur     CAR 187490
.                   change format of output - remove PATIENT string if nzprivate
.         V9.12.09  26/08/2009  J.Tan             CAR 202255
.                   Fixed SJOG/Cabrini to display payee details (same as print)
.         V9.12.08  24/08/2009 J.Tan  CAR 186102
.                   Mods to display Win/Loss after invoiced
.         V9.12.07  19/08/2009  J.Tan             CAR 187486
.                   Mods to print/display the payer for SX invoice
.         V9.12.06  30/07/2009  J.Tan             CAR 200712
.                   Fixed Cabrini Discharged billing statement
.         V9.12.05  17/07/2009  J.Tan             CAR 199603
.                   Mods to print theatre banding for Pendlebury invoice
.         V9.12.04  15/07/2009 Saroeun Soeur CAR 187490
.                   Display payer name on invoice list
.         V9.12.03  09/07/2009 J.Tan      CAR 199759
.                   Mods to Pendlebury Emergency invoice
.                   Mods I*C to open patin1af file  CAR 200841
.         V9.12.02  23/06/2009 J.Tan      CAR 199114
.                   Mods to display/print desc.of HF/Insurance cash payment
.         V9.12.01  03/06/2009 J.Tan      CAR 197218
.                   Mods for Pendlebury/healthscope to print inv.without amount
.                   (PRTIFLAG=1)
.         V9.11.08  01/04/2009 J.Tan      CAR 192772
.                   Mods for Johns Hopkins invoice
.         V9.11.07  17/03/2009 J.Tan      CAR 192339
.                   Fixed printing SJOG/Cab Adjustment total
.         V9.11.06  04/03/2009 J.Tan      CAR 172912
.                   Mods SJOG to print Credit Notes details
.         V9.11.05  24/02/2009 J.Tan      CAR 188205
.                   Mods to print 'Non-bank deposit' as 'Payment recieved'
.         V9.11.04  20/01/2009 J.Tan      CAR 187842
.                   Fixed printing invoice with credit note
.         V9.11.03  02/12/2008 J.Tan      CAR 160496
.                   Mods RCH TROFF000 - Emergency reprint invoice
.         V9.11.02  30/10/2008 J.Tan      CAR 181263
.                   Mods for printing Discharge Billing Statement
.         V9.11.01  07/10/2008 J.Tan  CAR 172904
.                   Mods SX Summary invoice to print all Journals(Not totalonly)
.         V9.10.04  22/08/2008  J.Tan        CAR 170219
.                   Mods to print item description for Cabrini layout
.         V9.10.03  12/08/2008 J.Tan         CAR 175967
.                   Mods Cabrini invoice not to print Anaesthetic Codes & Times
.         V9.10.02  21/05/2008  J.Tan        CAR 164036        
.                   Mods for Cabrini invoice layout
.         V9.10.01  09/05/2008 J.Tan  CAR 167702
.                   Mods routine JGBLPY00 to add one to COUNT instead of two
.         V9.09.15  03/04/2008 J.Tan  CAR 161684
.                   Mods Checking if Service Date/Time tobe printed for ED Bill
.                   (Not applicable for SJOG invoice layout) 
.         V9.09.14  03/04/2008 J.Tan  CAR 163219
.                   Mods JH Credit notes to include rounding
.         V9.09.13  30/01/2008 J.Tan  CAR 159905
.                   Fixed Estimate rebate to include item quantity
.         V9.09.12  22/11/2007 J.Tan  CAR 155607
.                   Fixed printing SJOG cash to check for cancelled status and
.                   amount
.         V9.09.11  07/11/2007 J.Tan  CAR 151803
.                   Fixed printing miscellaneous (overlap) for SJOG layout
.         V9.09.10  21/09/2007 J.Tan  CAR 149966
.                   Mods printing SX Summary invoice
.         V9.09.09  13/09/2007 J.Tan  CAR 149664
.                   Mods no char display on screen for SX invoice (I*C)
.         V9.09.08  06/09/2007 J.Tan  CAR 149210
.                   Mods for SX to display Funder Invoice instead of Insurance.
.         V9.09.07  09/08/2007 Peter Vela CAR 146143
.                   Added No of services / Quantity to misc items SJOG
.         V9.09.06  24/07/07 Peter Vela CAR 144787
.                   Fixed Reprint Pendlebury claim type body section
.         V9.09.05  02/07/2007 Peter Vela CAR 142173
.                   Added time into procedure item Emr Billing
.         V9.09.04  01/07/2007 Peter Vela CAR 142173
.                   Fixed print layout SJOG
.         V9.09.03  29/06/2007 Peter Vela CAR 142173
.                   Added doctor surname to PSJGR000
.         V9.09.02  25/06/2007  Peter Vela     CAR 142173
.                   Added reads to emrvisaf @ D8TYP000 and P8TYP000
.         V9.09.01  14/06/2007  Peter Vela     CAR 142173
.                   Fixed line count for SJOG ED Billing
.                   14/06/2007  J.Tan          CAR 142173
.                   Mods to print Procedures from Emergency events
.         V9.08.27  08/06/2007  Mike Laming    CAR 125736
.                   Changes to PATDO1af Address lines - change DSADD3 to DSADD4
.                   and DSADD2 to DSADD3 (new DSADD2 still to go in)
.         V9.08.26  24/04/07 J.Tan      CAR 138026
.                   Fixed printing JH half day charge description
.         V9.08.25  17/04/07 J.Tan      CAR 138571
.                   Mods not to print doctor charges for outpatients
.         V9.08.24  02/03/07 J.Tan      CAR 130462
.                   Mods for JH GST
.         V9.08.23  13/02/07 Peter Vela CAR sjog-vic
.                   Added St. John of God layout 24
.         V9.08.22  23/02/07 J.Tan    CAR 120014
.                   Mods for NZ GST
.         V9.08.21  08/02/07 J.Tan    CAR 120001
.                   Mods for NZ Billing
.         V9.08.20  15/12/06 J.Tan    CAR 128467
.                   Fixed JH GST journals
.         V9.08.19  14/12/06 J.Tan    CAR 127726
.                   Fixed description for discount
.         V9.08.18  12/12/06 J.Tan    CAR 127726
.                   Mods for Johns Hopkins GST Discount
.         V9.08.07  11/12/2006  J.Tan          CAR 127646
.                   Added Reference column to JH Details invoice
.         V9.08.06  05/12/2006  J.Tan          CAR 127092
.                   Mods printing Misc.group in bold for JH Invoices
.         V9.08.05  01/12/2006  J.Tan          CAR 126763
.                   Added Qty column for JH Invoices
.         V9.08.04  10/11/2006  J.Tan          CAR 121178
.                   Fixed partial day charges description (days)
.         V9.08.03  25/10/2006  J.Tan          CAR 122541
.                   Mods to use alternate item Group (Catg FN) for JH invoice
.         V9.08.02  16/10/2006  J.Tan         CAR 121629
.                   Fixed discount from receipting
.                   16/10/2006  J.Tan          CAR 121630
.                   Mods printing bold on item code for JH invoice
.         V9.08.01  11/10/2006  J.Tan         CAR 121178
.                   Fixed Acc.desc for halfday charge on Discharged day
.         V9.07.05  25/09/2006 Peter Vela CAR 118940
.                   Fixed PTCNINVL=12 Greenslopes layout PITOT000 Invoice Tot
.         V9.07.04  18/08/2006 J.Tan  CAR 115853
.                   Fixed printing claim details for Pendlebury
.         V9.07.03  02/08/2006  Peter Vela    CAR 113658
.                   Fixed PTCNINVL=12 Greenslopes layout
.                   Fixed Cash Receipts display
.         V9.07.02  31/07/2006 J.Tan      CAR 103365
.                   Mods for Johns hopkins invoice
.         V9.07.01  24/07/2006  Peter Vela    CAR 113656
.                   Fixed PTCNINVL=12 Greenslopes layout
.                   Fixed "Journal Total" display
.         V9.06.01  16/05/2006  Peter Vela    CAR 104103
.                   Fixed PTCNINVL=12 Greenslopes layout
.                   Fixed "Credit Note Total" display
.         V9.05.B02 27/01/2006  J.Tan
.                   Mods to print invoice comments before troff  CAR 85787
.                   Mods printing amount on the first line of desc. CAR 89413
.         V9.05.B01 09/12/2005 J.Tan  CAR 59381
.                   Mods for printing split invoice
.         V9.04.22  10/10/2005  J.Tan         CAR 79727
.                   Fixed printing gross total for Pendlebury layout
.         V9.04.21  06/09/2005  J.Tan         CAR 74862
.                   Fixed layout 11 printing payment total
.                   03/08/05 J.Tan    CAR 62750 
.                   Removed redefined amount variables
.         V9.04.20  10/08/2005  J.Tan        CAR 66543
.                   Fixed printing RCH invoice tail on 2nd page
.         V9.04.19  04/08/2005  J.Tan        CAR 62750
.                   Mods not to use the redefined amount variables
.         V9.04.18  01/08/2005 J.Tan   CAR  69340
.                   Fixed position for printing credit note total
.         V9.04.17  12/07/2005 J.Tan   CAR  67096
.                   Fixed print tail of invoice (TROFF000)
.         V9.04.16  21/06/2005 J.Tan  
.                   Fixed not printing lines on the RHS for ballarat
.         V9.04.15  27/05/2005 J.Tan   CAR 61488
.                   Added field for page number
.         V9.04.14  10/05/2005  J.Tan          CAR 61488
.                   Mods for Ballarat invoice (layout 19)
.         V9.04.13  03/02/2005  J.Tan   CAR 57321
.                   Fixed SVHM inpat layout with Adjustment (one line too long)
.         V9.04.12  24/02/2005  J.Tan   CAR 58263
.                   Mods printing description of items
.         V9.04.11  06/12/2004  J.Tan   CAR 55599
.                   Fixed Holy Spirit/Calvary ACT invoice layout
.                   06/12/2004  Lina Vo CAR 54528
.                   Aligned total amounts with rest of invoice for landscape.
.         V9.04.10  16/11/2004  Guomin Fu   CAR 54768
.                   Mods for Pendlebury invoice layout(PTCNINVL=16)
.         V9.04.09  11/11/2004  J.Tan   CAR 54665 
.                   Mods for Holy spirit invoice layout
.         V9.04.08  26/10/2004  J.Tan   CAR 54380 
.                   Fixed printing unit price for Outpatient/EMG invoice
.         V9.04.07  26/10/2004  J.Tan   CAR 54532 
.                   Fixed SVHM Emergency invoice with cash
.         V9.04.06  25/10/2004 J.Tan CAR 54527
.                   Fixed STV invoice layout not to print unit price
.         V9.04.05  15/10/2004 J.Tan CAR 52765
.                   Fixed outpatient invoice layout for stv
.         V9.04.04  14/10/2004 J.Tan CAR 54312
.                   Fixed outpatient invoice layout for stv
.         V9.04.03  01/10/2004 Peter Vela 52906
.                   Fixed emergency invoice layout for stv
.                   22/09/2004 Lina Vo CAR 53660       
.                   Changed for Multi Hospital to use PTHSTFEE instead 
.                   of PTCNTFEE
.         V9.04.02  20/08/2004 J.Tan  CAR 52835       
.                   Mods checking for hospital ID record for printing MBS code
.         V9.04.01  27/08/2004 J.Tan CAR 52891
.                   Fixed printing journals overprints payments
.         V9.03.12  13/08/2004 J.Tan CAR 52504
.                   Fixed non-banked cash after invoiced  
.         V9.03.11  09/08/2004 J.Tan CAR 50558
.                   Mods invoice layout 20 for St Vincent Toowoomba
.         V9.03.10  02/08/2004 J.Tan CAR 52033
.                   Mods printing item unit price
.         V9.03.09  30/06/2004 J.Tan CAR 51112
.                   Mods printing unreleased non-banked deposit amount 
.         V9.03.08  21/04/2004 J.Tan   
.                   Fixed non-banked amount for two same invoice in one receipt
.         V9.03.07  19/04/2004 J.Tan   
.                   Fixed non-banked amount
.         V9.03.06  06/01/2004  J.Tan  
.                   Fixed displaying WEB Item desc.on invoice
.         V9.03.05  03/01/2004  J.Tan  CAR 45047
.                   Mods to display non-banked cash
.         V9.03.04  21/11/2003  J.Tan  CAR 44161  
.                   Mods to print credit note       
.         V9.03.03  01/09/2003  T.Nguyen CAR 40940
.                   Fixed reprint for Outpatient Invoices to display the
.                   Outpatient Clinic Description and HCP name
.         V9.03.02  31/07/2003  J.Tan 
.                   Fixed reprint two lines of description for C/P
.         V9.03.01  20/06/2003  J.Tan  CAR 40417
.                   Fixed reprint for SVHM 
.         V9.02.25  30/04/2003  J.Tan
.                   Mods for WEB Billing
.         V9.02.24  04/04/2003  Dean Cramer   CAR 36512
.                   Bypass screen accepts for web                            
.         V9.02.23  03/04/2003  Dean Cramer   CAR 37906
.                   Fix where SVHM journals total alters body length         
.         V9.02.22  03/01/2003  Dean Cramer   CAR 36833
.                   Fix Descriptions in accommodation display for Calvary C.
.         V9.02.21  03/01/2003  Dean Cramer   CAR 34374
.                   Fix so Misc Item Descriptions print for Calvary Cairns.
.                   Make so body length consistent for all Calvary Invoices.
.         V9.02.20  11/11/2002  J.Tan
.                   Mods to read ptcnpjci from controlf file
.         V9.02.19  26/10/2002  Dean Cramer  Defect
.                   Remove Quantity from Misc Items on Outpatient Invoices 
.                   for RCH. 
.                   17/10/2002  Dean Cramer Defect 23126
.                   Adjust for Calvary Cairns page slew in RITOT.         
.         V9.02.18  10/10/2002  Dean Cramer Defect 22662
.                   Fix St. V's format after case payment changes.        
.         V9.02.17  05/08/2002  Dean Cramer Defect 19861
.                   Fix Calvary Cairns invoice body when TAC or WC Claim.
.         V9.02.16  25/07/2002  Dean Cramer  
.                   Fix so RCH format OK when claims.               
.         V9.02.15  19/07/2002  Dean Cramer  
.                   Fix so RCH does not enter Rebates section.               
.         V9.02.14  16/07/2002  Dean Cramer  
.                   Make so multiple services with regards to misc items
.                   are indicated on the invoice.
.         V9.02.13  21/06/2002  Dean Cramer  
.                   Include mods to formats for Royal Childrens
.         V9.02.12  13/06/2002  Dean Cramer  
.                   Include formats for Royal Childrens
.         V9.02.11  30/05/2002  J.Tan  defect 17679
.                   Mods not to print theatre fees description for RCH SVH
.         V9.02.10  29/05/2002  J.Tan  defect 17679
.                   Mods to print quantity for theatre items
.         V9.02.09  28/05/2002  J.Tan           
.                   Fixed not printing estimate rebate
.         V9.02.08  21/05/2002  J.Tan           
.                   Fixed casemix billing and SVHM layout
.         V9.02.07  15/04/2002  J.Tan           
.                   Copied from r6.09 
.                   Emergency has no GST
.         V6.09.07  18/02/2002  J.Tan   SRF 16434
.                   Mods to display invoice total and journal description
.                   on the transaction screen
.         V6.09.06  21/02/2002  Tonii  Casemix Defects
.                   Realigned display of GST amount
.                   20/02/2002  Tonii  Casemix Defects
.                   Changed to display description as DIM30 if GST is applicable
.                   else display as DIM24(single line)
.         V6.09.05  08/02/2002  Greg Horvat
.                   Changed to not use the discharge DRG for casemix billing
.         V6.09.04  30/01/2002  Greg Horvat
.                   Changed to default the casemix code from the casemix code
.                   on the invoice file
.         V6.09.03  29/01/2002  Tonii
.                   Mods to print the 2 lines of casemix description before
.                   printing the amount (like IBABIL20)
.         V6.09.02  22/11/2001  Tonii  SRF 13489
.                   Fixed display screen of invoices to accommodate for new
.                   length of TPATAMTT
.         V6.09.01  02/11/2001  J.Tan  
.                   Fixed printing printed invoice
.         V6.09.B02 04/01/2001  J.Tan  SRF 3228
.                   Extend MBS Description from DIM22 to DIM25
.         V6.09.B01 07/12/2000  Jill Habasque  
.                   6.09 Casemix mods - added patient moiety & invoice breakdown
.         V6.07.12  01/12/2000  Davin  SRF 3222
.                   Changed printing of vet. affairs details (landscape) 
.         V6.07.11  30/08/2000  Davin  SRF 5540
.                   Fixed to use GST lumpsum amount for casepayment with 
.                   no additional charge
.         V6.07.10  18/08/2000  J.Tan SRF 5160
.                   Mods to parameter PTCNIDES (2 for cross reference acc.desc.)
.         V6.07.09  07/08/2000  Davin  SRF 4005,4551
.                   - Moved printing of claim details for landscape
.                   - Fixed lineup of 'estimated rebate' print
.         V6.07.08  27/07/2000  J.Tan
.                   Mods printing GST amount for Journals 
.         V6.07.07  24/07/2000  Davin
.                   Added multipage flag for templating invoice tail
.         V6.07.06  28/06/2000  Davin
.                   Save invoice total for tail template (INVCTOTL)
.         V6.07.05  19/06/2000  Davin  SRF 2684
.                   Removed linefeed after tail
.         V6.07.04  31/05/2000  Davin
.                   Fixed length of invoice body
.         V6.07.03  25/05/2000 J.Tan
.                   Fixed printing accommodation on landscape
.         V6.07.02  15/05/2000 J.Tan
.                   Mods for landscape invoice
.         V6.07.01  02/05/2000 J.Tan
.                   Fixed print the fromdate of accommodation
.         V6.07.B01 10/04/2000  Davin
.                   Mods for templating - use PATINVTL for tails
.         V6.06.07  24/03/2000 Nicole Harrington
.                   Changed HTML output to use HeadingCell class
.         V6.06.06  05/01/2000 J.Tan
.                   Fixed displaying dates 
.         V6.06.05  16/10/1999  Caleb Sharman
.                   Y2K mods
.         V6.06.04  14/09/1999  Davin                      
.                   Changed for 4 character DRGs
.         V6.06.03  21.07.1999  J.Tan                      
.                   Fixed RDKDTRAN for non-inpatient
.         V6.06.02  22.04.1999  K.C.Nelson                 
.                   Changed PATWEB71 to PATWEB76 for Web Display 
.         V6.06.01  16.04.1999  B.G.Ackland                
.                   Enable for Web Display 
.         V6.05.10  09/02/1999  Steve Armstrong  srf 630128
.                   Mods to remove century from printed date fields for WCH
.         V6.05.09  18/12/1998  N Harrington
.                   Changed to display zeros not spaces in dates 
.         V6.05.08  11/12/1998  J.Tan   
.                   Fixed reprint accommodation for day case payment
.         V6.05.07  03/11/1998  J.Tan   SRF 628691
.                   Fixed end of invoice for layout 6  
.         V6.05.06  16/10/1998  J Habasque
.                   Fixed displaying last letter sent
.         V6.05.05  15/10/1998  J Habasque
.                   Changed display to show century
.         V6.05.04  17/08/1998  Davin  605
.                   Mods to include century (displays)
.         V6.05.03  01/07/98 J.Tan
.                   Fixed printing receipt number
.         V6.05.02  26/06/1998  Nick Read                   
.                   Moved JOURTOT to FORM62 before displaying
.                   JOURTOT is a form 8.2 and doesn't fit onthe screen
.         V6.05.01  18/06/1998  Steve Armstrong   SRF 644667
.                   Fixed printing for St. Lukes Tail                 
.         V6.04.15  25/05/98 Davin  SRF 625879
.                   Don't include journal adjustments in 'amount paid'
.         V6.04.14  09/05/98 J.Tan  SRF 625661
.                   Fixed lumpsum health fund
.         V6.04.13  08/03/98 J.Tan  SRF 619732
.                   Mods to write to a text file
.         V6.04.12  15/01/98 J.Tan     SRF 623052
.                   Mods setting up the item desc. with multiple items
.         V6.04.11  14/01/98 J.Tan   SRF 623324
.                   Fixed Non-inpatients to read reminder letter file
.         V6.04.10  14/11/97 J.Tan 
.                   Fixed for daycase casemix
.         V6.04.11  22/10/1997  Davin
.                   Changes to invoice/receipt tail for Peninsula - layout 22
.         V6.04.10  20/10/1997  Davin
.                   Changes to invoice/receipt tail for Peninsula - layout 22
.         V6.04.09  25/09/97 J.Tan   SRF 621713
.                   Mods displaying invoice date for non-inpatients
.         V6.04.08  15/08/1997  Davin
.                   Added new invoice layout for Peninsula - layout 22
.         V6.04.07  23/06/1997  Greg Horvat
.                   Added new invoice layout for Greenslopes - layout 21
.                   23/06/1997  Greg Horvat      SRF 620354
.                   Changed Holy Spirit reprints to not print claim details
.         V6.04.06  17/06/1997  Greg Horvat      SRF 620238
.                   Changed to call CHKCMXPT - Check if a casemix patient & get
.                   the episode type                                           
.         V6.04.05  04/06/1997  ROD              SRF 620314         
.                   display adjust total in correct position                  
.         V6.04.12  22/04/97 J.Tan    SRF 618321
.                   Mods tail of invoice layout 6 again (print balance total 
.                   above admission number and invoice number)
.         V6.04.03  03/12/1996  Greg Horvat      Holy Spirit Mods
.                   Changed layout 20 to print the correct outstanding amount
.         V6.04.02  03/12/1996  Greg Horvat      Holy Spirit Mods
.                   Added new invoice layout for Holy Spirit - layout 20
.         V6.04.01  02/12/96 J.Tan    SRF 618111
.                   Fixed printing journal desc.on the second page of invoice
.
.         V6.03.09  11/07/1996  Greg Horvat      SRF 616044
.                   Changed to display / print A&E miscellaneous items when the
.                   item exists on the patitemn file
.         V6.03.08  04/06/1996  Greg Horvat      SRF 615400
.                   Changed to set up the attending doctor correctly when
.                   printing the invoice total for layout 6
.         V6.03.07  27/05/1996  Greg Horvat      Quote 8623
.                   Added new invoice layout for Adelaide Clinic - layout 19
.         V6.03.06  16/11/1995  Greg Horvat      SRF 611839 (Rebound)
.                   Changed layout 18 tail again
.         V6.03.05  03/11/1995  Greg Horvat      SRF 611839
.                   Added new invoice layout for Mater - layout 18
.         V6.03.04  27/10/1995  Greg Horvat      SRF 612379
.                   Changed St Andrews layout with HCA tail (good stuff!) to
.                   print 4 lines extra at the end
.         V6.03.03  04/09/1995  Greg Horvat      SRF 611419
.                   Changed to open medical service files instead of patient
.                   billing files when printing medical services' receipts
.         V6.03.02  03/07/1995  Greg Horvat      SRF 136561
.                   Added 1 line to WCH invoice & receipt normal tails
.         V6.03.01  21/06/1995  Greg Horvat      SRF 136936
.                   Fixed the reprint invoice & receipt tail's to match the
.                   print invoice tail
.         V6.03.B2  13/02/1995  Gabrielle        
.                   Again Fixed invoice layout No 6
.         V6.03.B1  07/02/1995  Gabrielle        SRF 134908
.                   Fixed invoice layout No 6
.         V6.03.B00 11/01/1995  Greg Horvat      New Release 6.03
.                   Recompiled for PATMASFD - Changed PBDATE to be CCYYMMDD
.                   Added different invoice total for type6
.         V6.03.11  30/01/97 J.Tan    SRF 618321
.                   Fixed receipt and normal tail of invoice layout 6
.
.******************************************************************************
.
.        NOT TOO SURE YET WHAT ANY FLAG DOES IN THIS INCLUDE
.                         (RE-PRINT OPTION)
.
.--------------------------------------------------------------------------
.
.        Loop over Debtors Transaction file to find all relevant records
.
.********************************************************************** 
.*                            PATCATAI                                *
.*                   Re-Display & Re-Print Invoices                   *
.********************************************************************** 
CALCTAI   CALL      CINIT000
          MOVE      ONE,CASHFLAG            * No cash
          MOVE      ONE,JOURFLAG            * No jrnl 
          MOVE      ONE,DISCFLAG            * No discount
          MOVE      ZERO,CSTYPEF
          MOVE      ZERO,CBFLAG             * flag for Invoice total displayed
          MOVE      ZERO,ROUNDAMT
          MOVE      ZERO,TOTDISC
          MOVE      ONE,RPRTFLAG
          MOVE      ZERO,RECFLAG
          MOVE      ZERO,PLINFLAG
          MOVE      ZERO,ABFFLAG
          MOVE      ZERO,IPATFLAG
.
          OPEN      PATDTRA6,"patdtraf"
          OPEN      OUTDTRO5,"outdtrof"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,THIRTY6;*113,HJNL
          READ      CONTROLF,FIFTY9;*210,PTMBSINV
          READ      CONTROLF,HUND05;*200,PTCNPJCI,*201,PTCNPFED
          READ      CONTROLF,HUND09;*247,PTCNROUN
.
          MOVE      SP70,PMVXMHOS
          OPEN      PMSVX1A1,"pmsvx1af"
          PACK      KEY8,PINVADM
          CALL      RDPMVX11
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1 
            MOVE      SP70,PTHSPMBS
            MOVE      SP70,PTHSTFEE
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
          ENDIF
.
          OPEN      PMSFCIA3,"pmsfciaf"
.
          IF        PTINCMIX=3
            MOVE      ONE,ABFFLAG             * flag for ABF Invoice
          ENDIF
.
          MOVE      PTINCMCD,CMCODE           * Casemix code
          CALL      CNTD0000
.
.         Do not print zero amount Line for New Patient Inv.functionality
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & PINVTYP=2
              MOVE      TWO,IPATFLAG
            ENDIF
          ENDIF
.
          BRANCH    PRINTFLG,CALCTAI1
          MOVE      ZERO,CRDNFLAG
.
          MATCH     "IBABIL21",PRGID
          GOTO      CALCTAIE IF EQUAL       * no invoice display on char.
.
. ------  Print Flag off - re-display Invoice  ------
.
          CALL      SCREN000                * Display the Initial Screen
.
.         No display on char screen for SX - IBABIL21 (reprint invoice)
.
          MATCH     "PATWEB76",PRGID
          IF        !@EQUAL
            IF        CFEETYP=5 & PTCNINVL=23
              GOTO      CALCTAIE
            ENDIF
          ENDIF
.
          CALL      D1TYP000                * Display Accomodation Charges
          BRANCH    EXIT,CALCTAIE
.
          IF        CFEETYP=5 & PTCNINVL=23
            CALL      GGST0000              * Get GST amount
            CALL      D8SCR000              * Display SX procedures
            CALL      D2SCR000              * Display SX Theatre fees
            CALL      D3SCR000              * Display SX Misc.items
            GOTO      CALCTAI0
          ENDIF
.
          CALL      D2TYP000                * Display Theatre Charges
          BRANCH    EXIT,CALCTAIE
.
          IF        CRDNFLAG=0 & JHFLAG=1
            CALL      D3JHP000                * Display Johns Hopkins Misc.Items
            CALL      DDISC000
          ELSE
            CALL      D3TYP000                * Display Miscellaneous Items
          ENDIF
          IF        DBSFLAG=1
            MOVE      ZERO,PAYMTTOT
            PACK      KEY12,SP4,PINVNO
            CALL      CSHP0000                * Display cash pending if any
            CALL      D5TYP000                * Display Cash Receipts
            CALL      D6TYP000                * Display Journals
            GOTO      CALCTAIE
          ENDIF
.
          CALL      D8TYP000                  * Display procedure if any
.
CALCTAI0  BRANCH    EXIT,CALCTAIE
.
          IF        IBCNUGST=2 | IBCNUGST=3
            CALL      D6TYP000                * Display Journals
            BRANCH    EXIT,CALCTAIE
          ENDIF
.
          CALL      D5TYP000                * Display Cash Receipts
          BRANCH    EXIT,CALCTAIE
.
          PACK      KEY12,SP4,PINVNO
          CALL      CSHP0000                * Display cash pending if any
.
          IF        IBCNUGST=2 | IBCNUGST=3
            GOTO      CALCTAIT
          ENDIF
.
          CALL      D6TYP000                * Display Journals
          BRANCH    EXIT,CALCTAIE
.
CALCTAIT  CALL      DENDI000                * Display End of Invoice
          GOTO      CALCTAIE
.
. ------  Print Flag on - re-print Invoice  ------
.
CALCTAI1  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN;*240,PTCNINVN
          MOVE      PTCNINVN,MAXLINE
          IF        PTCNINVL=23
            MOVE      "28",MAXLINE          * SX
          ENDIF
          IF        PTCNINVL=22
            MOVE      "30",MAXLINE          * Johns Hopkins
          ENDIF
.
          MOVE      ZERO,TOTMISC
          MOVE      ZERO,TOTAMNT
          MOVE      ZERO,GSTAMNT
.
          CALL      P1TYP000                * Print Accomodation Charges
          CALL      P2TYP000                * Print Theatre Charges
          CALL      P3TYP000                * Print Miscellaneous Items
.
          IF        PRTIFLAG=1
            MOVE     ZERO,GROSSTOT          * printing invoice without amount
            MOVE     ZERO,PAYMTTOT
            MOVE     ZERO,JOURTOT
            MOVE     ZERO,CSAMT
            MOVE     ZERO,TOTGST
            MOVE     ZERO,CREDTOT
            MOVE     ZERO,CASHTOT
            GOTO     CALCTAI9
          ENDIF
.
          IF        DBSFLAG=1
            CALL      P5TYP000              * Print Cash Receipts
            CALL      P6TYP000                * Print Journals
            GOTO      CALCTAIE
          ENDIF
.
          CALL      P8TYP000                * Print procedure if any
.
          COMPARE   "22",PTCNINVL
          GOTO      CALCTAI2 IF EQUAL       * Johns Hopkins
          COMPARE   "23",PTCNINVL
          GOTO      CALCTAI2 IF EQUAL       * SX
.
          CALL      PITOT000                * Print the Invoice Total
.
CALCTAI2  BRANCH    CRDNFLAG,CALCTAI4
.
          CALL      P5TYP000                * Print Cash Receipts
          CALL      P6TYP000                * Print Journals
.
          MOVE      ONE,COMPFLG             * flag to print
          CALL      DCRD0000                * Print credit note total
.
          IF        PTCNINVL=22
            CALL      JHEND000              * Johns Hopkins end of invoice
            GOTO      CALCTAIE
          ENDIF
.
          IF        CFEETYP=5 & PTCNINVL=23
            CALL      SXEND000              * SX end of invoice
            GOTO      CALCTAIE
          ENDIF
.
          GOTO      CALCTAI9
.
CALCTAI4  MOVE      ONE,CASHFLAG            * No cash
          MOVE      ONE,JOURFLAG            * No jrnl 
.
CALCTAI9  CALL      PENDI000                * End Invoice Total
.
CALCTAIE  RETURN
+
.********************************************************************** 
.*                            CINIT000                                *
.*                    Initialize Variables Needed                     *
.********************************************************************** 
CINIT000  MOVE      ZERO TO REBTOT
          MOVE      ZERO,LOOPTRN
          MOVE      ZERO,NOHIPAYM
          MOVE      SP2,REGIST8
          MOVE      ZERO,JOURTOT
          MOVE      ZERO,CPAGENO
.
          MOVE      ZERO,DCFLAG
          MOVE      ZERO,GROSSTOT
          MOVE      ZERO,TOTDAYS
          MOVE      ZERO,TOTGST
          MOVE      ZERO,TOTHEALTH
          MOVE      ZERO,PAYMTTOT
          MOVE      ZERO,CREDTOT
          MOVE      ZERO,FORM72         * Total payments only
          UNPACK    PINVDTE INTO XCENT,XYEAR,XMON,XDAY
.
          OPEN      PATDTRA4,"patdtraf"
.
          MOVE      SP10,PTHFBCAT           * Initialise table type
          MATCH     SP6,AFUNDH
          IF        !@EQUAL
            OPEN      PATFN1A1,"patfn1af"
            PACK      KEY14,AFUNDH,AFNDTB
            CALL      RDFUND1                 * read health fund file 
          ENDIF
.
          READ      CONTROLF,ZERO;*85,IBCNUGST
          IF        PINVSYS=1
            MOVE      TWO,PTCNPEFR               * no printing estimate rebate
          ENDIF
.
          PACK      CMCODE,PTMIPCMX,SP10 * Default to provisional DRG
          PACK      CMDRG,PTMIPCMX,SP10
.         
          IF        PINVSYS=3
            PACK      KEY8,PINVADM,SP10
            CALL      RDMISS1
            BRANCH    OVRCD,CINIT1000
          ENDIF
.
          UNPACK    SP10,KEY4,KEY5
          UNPACK    PTMIPCMX,KEY4,KEY5     * check if it was a MBS Code
.
          IF        ASTAT = 3
            CALL      RDDSCH1
            BRANCH    OVRCD,CINIT9999
.
.....            MATCH     SP4,PTDSDDRG         * check discharge DRG code
.....            IF        !@EQUAL
.....              PACK      CMCODE,PTDSDDRG,SP10
.....              PACK      CMDRG,PTDSDDRG,SP10
.....            ENDIF
.
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,DCFLAG
            ENDIF
          ENDIF
.
          MATCH     SP9,PTINCMCD
          IF        !@EQUAL
            PACK      CMCODE,PTINCMCD,SP10
            PACK      CMDRG,PTINCMCD,SP10
          ENDIF
.
          MOVE      CDD,CRDAY
          MOVE      CMM,CRMON
          MOVE      CYY,CRYEAR
          MOVE      CCC,CRCENT
          REP       " 0",CRDAY
          REP       " 0",CRMON
          REP       " 0",CRCENT
          REP       " 0",CRYEAR
.
.         Get last letter details (if any)
.
CINIT1000 MOVE      SP10,DIM10
          MOVE      PINVADM,KEY8
.         IF        INMEDFLG=1
.           OPEN      PATREMD1,"medremdf"   * Using medical services
.         ELSE
            OPEN      PATREMD1,"patremdf"   * Using patient billing
.         ENDIF
          CALL      RDREMD1
          CLOSE     PATREMD1
          BRANCH    OVRCD,CINIT999
.
          MATCH     SP8,REMLDTE
          GOTO      CINIT999 IF EQUAL
.
          UNPACK    REMLDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DIM10
          REP       " 0",DIM10
.
CINIT999  RETURN
+
.********************************************************************** 
.*                            SCREN000                                *
.*                     Display the Initial Screen                     *
.********************************************************************** 
SCREN000  MOVE      XDAY,CDAY
          MOVE      XMON,CMON
          MOVE      XCENT,CCENT
          MOVE      XYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          IF        CFEETYP=5
            CALL      SXSCR000               * SX
            GOTO      SCREN999
          ENDIF
.
          BRANCH    DBSFLAG,SCREN200         * Discharge Billing Statement
.
          MATCH     SP10,DIM10
          GOTO      SCREN100 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><td colspan=8 align=center><b>":
                             "Last Letter : ",REMLSTL,"  Sent : ",DIM10:
                             "</b></td></tr>"
.
SCREN100  MATCH     "1",PTCNPPIN
          GOTO      SCREN108 IF NOT EQUAL
.
          COMPARE   ZERO,INVTYPE
          GOTO      SCREN108 IF NOT EQUAL
.
          IF        PINVTYP=1
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                               "<td colspan=8 align=right><b>":
                               "Insurance Invoice</b></td></tr>"
              GOTO      SCREN110
          ELSE
            IF        PINVTYP=2
              WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                                 "<td colspan=8 align=right><b>":
                                 "Patient Invoice</b></td></tr>"
              GOTO      SCREN110
            ENDIF
          ENDIF
.
SCREN108
          IF        PINVTYP=1
            IF        INVTYPE=2
              WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                               "<td colspan=10 align=right><b>":
                               "Insurance Invoice</b></td></tr>"
            ELSE
              WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                               "<td colspan=7 align=right><b>":
                               "Insurance Invoice</b></td></tr>"
            ENDIF
          ENDIF
.
          IF        PINVTYP=2
            IF        INVTYPE=2
              WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                                 "<td colspan=10 align=right><b>":
                                 "Patient Invoice</b></td></tr>"
            ELSE
              WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                                 "<td colspan=7 align=right><b>":
                                 "Patient Invoice</b></td></tr>"
            ENDIF
          ENDIF
.
SCREN110  COMPARE   ONE,JHFLAG
          GOTO      SCREN120 IF NOT EQUAL
          COMPARE   TWO,INVTYPE
          GOTO      SCREN120 IF NOT EQUAL
.
.         Detailed invoice
.
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center>Date</td>":
                             "<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Reference</td>":
                             "<td class=HeadingCell>Item</td>":
                             "<td class=HeadingCell>Qty</td>":
                            "<td align=right class=HeadingCell>Unit $</td>":
                            "<td align=right class=HeadingCell>GST Exc.</td>":
                            "<td align=right class=HeadingCell>GST Amount</td>":
                            "<td align=right class=HeadingCell>Unit Total</td>":
                            "<td align=right class=HeadingCell>Amount</td>":
                            "</tr>"
          GOTO      SCREN999
.
SCREN120  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center>Date</td>":
                             "<td class=HeadingCell>Description</td>":
                             "<td class=HeadingCell>Item</td>";
.
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td class=HeadingCell>Qty</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right class=HeadingCell>Rate</td>":
                            "<td align=right class=HeadingCell>GST Exc.</td>":
                            "<td align=right class=HeadingCell>GST Amount</td>":
                            "<td align=right class=HeadingCell>Total</td>":
                            "</tr>"
          GOTO       SCREN999
.
.         Discharge Billing Statement
.
SCREN200  UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr height=10>";
.
          WRITE     HTMLFILE;"<tr>":
                             "<td width=50% class=HeadingCell align=center>":
                             "Invoice Number:",PINVNO,"</td>":
                             "<td width=50% class=HeadingCell align=center>":
                             "Invoice Date:":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<tr>";
          WRITE     HTMLFILE;"</tr></table></td>";
.
          WRITE     HTMLFILE;"<table cellspacing=0 cellpadding=1 border=1 ":
                             "width=100% align=center ><tr height=10>";
.
           WRITE      HTMLFILE;"<tr>":
                               "<td width=25% class=HeadingCell align=center>":
                               "<b> Date </b></td>":
                               "<td width=35% class=HeadingCell>":
                               "<b> Description </b></td>":
                               "<td width=10% class=HeadingCell>":
                               "<b> Item </b></td>":
                               "<td width=10%  class=HeadingCell align=right>":
                               "<b> Rate </b></td>":
                               "<td width=10% class=HeadingCell align=right>":
                               "&nbsp;</td>":
                               "<td width=10% class=HeadingCell align=right>":
                               "<b>Total</b></td>":
                               "</tr>";
SCREN999  RETURN
+
.********************************************************************** 
.*                            D1TYP000                                *
.*                       Routine Description                          *
.********************************************************************** 
D1TYP000  MOVE      "1",DIM1
          IF        ABFFLAG=1
            MOVE      "9",DIM1            * ABF record type
          ENDIF
          PACK      KEY31 WITH PINVADM,PINVNO,DIM1,SP30
          PACK      KEY23 WITH PINVADM,PINVNO,DIM1,SP30
          PACK      KEY22 WITH PINVADM,PINVNO,SP30
          IF        CRDNFLAG=1
            MOVE      "1",KEY1
          ENDIF
          MOVE      ZERO,INVBFLAG
          MOVE      ZERO,F5
.
          CALL      RDSDTRAN
D1TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD OF D1TYP950
.
          MATCH     PINVNO,TREF
          GOTO      D1TYP950 IF NOT EQUAL
.
          IF        ABFFLAG=1
            COMPARE   "9",TRECTYPE
            GOTO      D1TYP800 IF EQUAL   * ABF record type
          ENDIF
.
          COMPARE   ONE,TRECTYPE
          GOTO      D1TYP950 IF NOT EQUAL
.
          IF        DCFLAG=1
            IF        (PTDTLSPT <> 0) | (PTDTLSRB <> 0)
              MATCH     SP70,PTDTLSD1
              IF        @EQUAL
                CALL      DLUM0000      * Get desc. for daycase lumpsum amount
                MOVE      LSDESC1,PTDTLSD1
                MOVE      LSDESC2,PTDTLSD2
              ENDIF
              GOTO      D1TYP120
            ENDIF
            GOTO      D1TYP500
          ENDIF
.
          BRANCH    F5,D1TYP500
          COMPARE   ONE,PTINCMIX
          GOTO      D1TYP500 IF NOT EQUAL
.
          MATCH     SP70,PTDTLSD1
          IF        @EQUAL
            CALL      OLUM0000        * Get desc. for overnight lumpsum amount
            MOVE      LSDESC1,PTDTLSD1
            MOVE      LSDESC2,PTDTLSD2
          ENDIF
.
          IF        PTDTDTYP=0 & (PTDTLSPT<>0 | PTDTLSRB<>0)
            GOTO      D1TYP110
          ENDIF
.
          IF        (PTDTDTYP=2 | PTDTDTYP=3)
            GOTO      D1TYP110
          ENDIF
          GOTO      D1TYP500
.
D1TYP110  MOVE      ONE,F5
.
D1TYP120  MOVE      PTDTLSD1,SAVDES1
          MOVE      PTDTLSD2,SAVDES2
          BRANCH    DBSFLAG,D1TYP400  * Discharge Billing
.
          OPEN      PATIBLA1,"patiblaf"
          PACK      KEY19,AADMNO,PINVNO,SP70
          CALL      RSPTIBL1
D1TYP200  CALL      RKPTIBL1
          BRANCH    OVRCD,D1TYP300
.
          MATCH     DAADMNO,PTIBADMN
          GOTO      D1TYP300 IF NOT EQUAL
.
          MATCH     PINVNO,PTIBINVN
          GOTO      D1TYP300 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTIBBRCD
          CALL      RDCODE1
          IF        OVRCD<>0
            MOVE      "Invalid Code",SAVDES1
          ENDIF
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PTIBAMNT,FORM72
          MOVE      PTIBGAMN,PTDTGSTL
          IF        INVBFLAG=0
            ADD       PTDTLSRB,REBTOT
          ENDIF
          MOVE      ONE,INVBFLAG
          GOTO      D1TYP400
.
D1TYP300  BRANCH    INVBFLAG,D1TYP500
          MOVE      PTDTLSPT,FORM72
          ADD       PTDTLSRB,FORM72
          ADD       PTDTLSRB,REBTOT
.
D1TYP400  MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
.
          CALL      DAOV0000                   * display accommodation
          ADD       GSTAMNT,TOTGST
          ADD       FORM72,GROSSTOT
.
          BRANCH    INVBFLAG,D1TYP200
.
.         Daycase casemix patient does not have any additional charge
.
D1TYP500  
.         IF        DCFLAG = 1
            COMPARE   ZERO,TNODAYS
            GOTO      D1TYP100 IF EQUAL
.         ENDIF
.
D1TYP800  ADD       TREBATE TO REBTOT
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      TPATAMTT,FORM7P2
          MOVE      TDDESC,DIM24
          MOVE      TDDESC,DIM30A
.
          CALL      D1WEB000
.
          ADD       TPATAMTT,GROSSTOT
          ADD       TNODAYS,TOTDAYS
.
          BRANCH    ABFFLAG,D1TYP950   * ABF should only have one record
          GOTO      D1TYP100
.
D1TYP950  MOVE      FALSE,EXIT
D1TYP999  RETURN
+
.********************************************************************** 
.         Display overnight accommodation
.********************************************************************** 
DAOV0000  IF        DBSFLAG=1
            MOVE      PTDTLSPT,TOTAMNT
            IF        PTDTGSTL<>0
              MOVE      ZERO,LINEGST
              CALL      FGST0000               * Get Item GST rate
              MOVE      TOTAMNT,LINEGST
              MULT      IBGEAMNT,LINEGST       * GST amount
              DIV       "100.00",LINEGST       * Divide by 100 
              ADD       LINEGST,TOTAMNT
            ENDIF
            COMPARE   ZERO,TOTAMNT
            GOTO      DAOV9999 IF EQUAL
          ENDIF
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<tr>":
                            "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                            "<td>&nbsp;",SAVDES1;
.
          WRITE     HTMLFILE;"</td>";
.
          IF        DBSFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td align=right>",PTDTLSPT,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",TOTAMNT,"</td>":
                               "</tr>";
            ADD       TOTAMNT,TDBSAMNT
            GOTO      DAOV9999
          ENDIF
.
          MOVE      PTDTGSTL,GSTAMNT
          MOVE      FORM72,TOTAMNT
          ADD       GSTAMNT,TOTAMNT
          MOVE      GSTAMNT,GSTAMNT6
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right>",FORM72,"</td>":
                             "<td align=right>",GSTAMNT6,"</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td align=right>",TOTAMNT,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",TOTAMNT,"</td>":
                             "</tr>";
.
DAOV9999  RETURN
+
.********************************************************************** 
.         Display accommodation
.********************************************************************** 
D1WEB000  
          IF        CFEETYP=5
            CALL      X1WEB000                 * SX
            GOTO      D1WEB999
          ENDIF
.
          IF        DBSFLAG=1 | IPATFLAG=2
            MOVE      TPATAMTT,TOTAMNT
            SUB       TREBATE,TOTAMNT
            IF        PTDTGSTM<>0
              MOVE      ZERO,LINEGST
              CALL      FGST0000               * Get Item GST rate
              MOVE      TOTAMNT,LINEGST
              MULT      IBGEAMNT,LINEGST       * GST amount
              DIV       "100.00",LINEGST       * Divide by 100 
              ADD       LINEGST,TOTAMNT
            ENDIF
            COMPARE   ZERO,TOTAMNT
            GOTO      D1WEB999 IF EQUAL
          ENDIF
.
.         ABF - display the second description (DRG code) first
.
          MOVE      SP70,KEY60
          CLEAR     KEY60
          IF        PTINCMIX=3
            APPEND    PTDTDES2,KEY60
            RESET     KEY60
            STRIP     KEY60
            ENDSET    KEY60
            APPEND    SP1,KEY60
            APPEND    TDDESC,KEY60
          ELSE
            APPEND    TDDESC,KEY60
            MATCH     SP70,PTDTDES2
            IF        !@EQUAL
              RESET     KEY60
              STRIP     KEY60
              ENDSET    KEY60
              APPEND    "/",KEY60
              APPEND    PTDTDES2,KEY60
            ENDIF
          ENDIF
          APPEND    SP70,KEY60
          RESET     KEY60
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      TFMONTH,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
.         Printing ABF Charges for NON Inpatient
.
          IF        ABFFLAG=1
            IF        PINVSYS <>3
              WRITE     HTMLFILE;"</td>":
                                 "<td>";
              GOTO    D1WEB500
            ENDIF
          ENDIF
.
          PACK      KEY8,TTCENT,TTYEAR,TTMONTH,TTDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      TTMONTH,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          MOVE      TPATAMTT,FORM12P2
          DIV       TPATAMTI,FORM12P2
          MOVE      FORM12P2,FORM41         * move it to form 4.1
.
          MOVE      SP70,KEY6
          MOVE      FORM41,KEY6
          UNPACK    KEY6,KEY4,KEY2
          MATCH     ".5",KEY2               * check if the last 2 chars
          GOTO      D1WEB300 IF NOT EQUAL
.
          WRITE     HTMLFILE;" to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",FORM41," Days ";
          GOTO      D1WEB500
.
D1WEB300  WRITE     HTMLFILE;" to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",TNODAYS," Days ";
.
D1WEB500  WRITE     HTMLFILE;KEY60,"</td>";
          IF        DBSFLAG=1
            MOVE      TPATAMTT,FORM12P2
            SUB       TREBATE,FORM12P2
            DIV       TNODAYS,FORM12P2
.
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td align=right>",FORM12P2,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",TOTAMNT,"</td></tr>"
            ADD       TOTAMNT,TDBSAMNT
            GOTO      D1WEB999
          ENDIF
.
          MOVE      PTDTGSTM,GSTAMNT
          MOVE      TPATAMTT,TOTAMNT
          ADD       GSTAMNT,TOTAMNT
          MOVE      GSTAMNT,GSTAMNT6
          ADD       GSTAMNT,TOTGST
.
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",TPATAMTI,"</td>":
                             "<td align=right>",TPATAMTT,"</td>";
          IF        JHFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",GSTAMNT6,"</td>";
          ENDIF
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td align=right>",TOTAMNT,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",TOTAMNT,"</td></tr>"
.
D1WEB999  RETURN
+
.********************************************************************** 
.*                            D2TYP000                                *
.*                       Routine Description                          *
.********************************************************************** 
D2TYP000  IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,TWO,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,ONE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
          IF        CRDNFLAG=1
            MOVE      "2",KEY1
          ENDIF
.
          CALL      RDSDTRAN
D2TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD OF D2TYP950
          MATCH     PINVADM,TADMNO
          GOTO      D2TYP950 IF NOT EQUAL
          MATCH     PINVNO,TREF
          GOTO      D2TYP950 IF NOT EQUAL
.
          CALL      XCLI0000             * Check Exclude Item for Disc.Billing
          BRANCH    EXIT,D2TYP100
.
          IF        TRECTYPE<>2
            IF        TRECTYPE=3 & (PINVSYS=1 | PINVSYS=2)
.
. ----- Go thru all misc items to get theatre items for A&E & outpatients -----
.
              GOTO      D2TYP100
            ELSE
              GOTO      D2TYP950
            ENDIF
          ENDIF
.
          MOVE      TDDESC,DIM18
          MOVE      TDDESC,DIM30
.
          SCAN      " X",TDDESC
          GOTO      D2TYP200 IF NOT EQUAL
          MOVE      ZERO,FORM2
          MOVE      TDDESC,DIM5
          MOVEFPTR  TDDESC,FORM2
          IF        FORM2 > 17
            RESET     DIM18,17
            APPEND    DIM5,DIM18
            RESET     DIM18
          ENDIF
.
D2TYP200  MOVE      TREBATE,FORM12P2
          IF        TSERVS<>0
            MULT      TSERVS,FORM12P2
          ENDIF
          ADD       FORM12P2 TO REBTOT
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      TPATAMTT,FORM7P2
.
          CALL      D2WEB000
          ADD       TPATAMTT,GROSSTOT
          GOTO      D2TYP100
.
D2TYP950  MOVE      FALSE,EXIT
D2TYP999  RETURN
.
.********************************************************************** 
.         Display item
.********************************************************************** 
D2WEB000  IF        DBSFLAG=1 | IPATFLAG=2
            MOVE      TPATAMTT,TOTAMNT
            SUB       TREBATE,TOTAMNT
            MOVE      TOTAMNT,TPATAMTP
            IF        PTDTGSTM<>0
              MOVE      ZERO,LINEGST
              CALL      FGST0000               * Get Item GST rate
              MOVE      TOTAMNT,LINEGST
              MULT      IBGEAMNT,LINEGST     * GST amount
              DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
              ADD       LINEGST,TOTAMNT
            ENDIF
            COMPARE   ZERO,TOTAMNT
            GOTO      D2WEB999 IF EQUAL
          ENDIF
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          MOVE      PTDTGSTM,FORM72
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>&nbsp;",DIM30,"</td>";
.
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;",TRECEIPT,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",TITEMNO,"</td>";
.
          IF        DBSFLAG=1
            WRITE     HTMLFILE;"<td align=right>",TPATAMTP,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",TOTAMNT,"</td>";
            ADD       TOTAMNT,TDBSAMNT
            GOTO      D2WEB999
          ENDIF
.
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;",TSERVS,"</td>";
          ENDIF
.
          IF        TSERVS<>0
            MOVE      TPATAMTP,FORM12P2
            ADD       TREBATE,FORM12P2
            MULT      TSERVS,FORM12P2
            IF        FORM12P2<>TPATAMTT
              DIV       TSERVS,TPATAMTP
              DIV       TSERVS,TREBATE
            ENDIF
            MOVE      TPATAMTP,FORM12P2           * Unit price
            ADD       TREBATE,FORM12P2
            IF        JHFLAG=1 & INVTYPE=2
              WRITE     HTMLFILE;"<td>&nbsp;",TSERVS,"</td>";
            ENDIF
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
          ELSE
            IF        JHFLAG=1 & INVTYPE=2
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",FORM7P2,"</td>";
.
          IF        JHFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM72,"</td>";
          ENDIF
          ADD       PTDTGSTM,FORM7P2
          ADD       PTDTGSTM,TOTGST
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td align=right>",FORM72,"</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",FORM7P2,"</td></tr>"
D2WEB999  RETURN
+
.********************************************************************** 
.*                            D3TYP000                                *
.*                       Routine Description                          *
.********************************************************************** 
D3TYP000  IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,THREE,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,ONE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
          IF        CRDNFLAG=1
            MOVE      "3",KEY1
          ENDIF
.
          CALL      RDSDTRAN
D3TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD OF D3TYP950
.
          MATCH     PINVADM,TADMNO
          GOTO      D3TYP950 IF NOT EQUAL
.
          MATCH     PINVNO,TREF
          GOTO      D3TYP950 IF NOT EQUAL
.
          CALL      XCLI0000             * Check Exclude Item for Disc.Billing
          BRANCH    EXIT,D3TYP100
.
          IF        PINVSYS<>3
            COMPARE   THREE,TRECTYPE
            GOTO      D3TYP100 IF NOT EQUAL
          ELSE
            COMPARE   THREE,TRECTYPE
            GOTO      D3TYP950 IF NOT EQUAL
          ENDIF
.
          MOVE      TDDESC,DIM20
          MOVE      TDDESC,DIM30
.
          SCAN      " X",TDDESC
          GOTO      D3TYP200 IF NOT EQUAL
          MOVE      ZERO,FORM2
          MOVE      TDDESC,DIM5
          MOVEFPTR  TDDESC,FORM2
          IF        FORM2 > 17
            RESET     DIM20,17
            APPEND    DIM5,DIM20
            RESET     DIM20
          ENDIF
.
D3TYP200  MOVE      TREBATE,FORM12P2
          IF        TSERVS<>0
            MULT      TSERVS,FORM12P2
          ENDIF
          ADD       FORM12P2 TO REBTOT
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          IF        IPATFLAG=2
            COMPARE   ZERO,TPATAMTT
            GOTO      D3TYP100 IF EQUAL
          ENDIF
.
          MOVE      TPATAMTT,FORM7P2
          CALL      D3WEB000
          ADD       TPATAMTT,GROSSTOT
          GOTO      D3TYP100
.
D3TYP950  MOVE      FALSE,EXIT
D3TYP999  RETURN
.
.********************************************************************** 
.         Display items
.********************************************************************** 
D3WEB000  IF        DBSFLAG=1
            MOVE      TPATAMTP,TOTAMNT
            IF        TSERVS<>1
              MULT      TSERVS,TOTAMNT
            ENDIF
            IF        PTDTGSTM<>0
              MOVE      ZERO,LINEGST
              CALL      FGST0000               * Get Item GST rate
              MOVE      TOTAMNT,LINEGST
              MULT      IBGEAMNT,LINEGST     * GST amount
              DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
              ADD       LINEGST,TOTAMNT
            ENDIF
            COMPARE   ZERO,TOTAMNT
            GOTO      D3WEB999 IF EQUAL
          ENDIF
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          MOVE      PTDTGSTM,FORM72
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          IF        ISBLFLAG=1
            MOVE      KEY8,ISBLDATE
            ADD       TSERVS,ISBLDATE
            MOVE      ISBLDATE,KEY8
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                                 NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
            WRITE     HTMLFILE;" to ",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td>&nbsp;",DIM30,"</td>":
                             "<td>&nbsp;",TITEMNO,"</td>";
          IF        DBSFLAG=1
            WRITE     HTMLFILE;"<td align=right>",TPATAMTP,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",TOTAMNT,"</td>";
            ADD       TOTAMNT,TDBSAMNT
            GOTO      D3WEB999
          ENDIF
.
.         MV will not have quantity display on screen for zero amount
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            IF        PTDTEPSD=1
              IF        TPATAMTT<>0
                WRITE     HTMLFILE;"<td>&nbsp;",TSERVS,"</td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",TSERVS,"</td>";
            ENDIF
          ENDIF
.
          IF        TSERVS<>0
            MOVE      TPATAMTP,FORM12P2
            ADD       TREBATE,FORM12P2
            MULT      TSERVS,FORM12P2
            IF        FORM12P2<>TPATAMTT
              DIV       TSERVS,TPATAMTP
              DIV       TSERVS,TREBATE
            ENDIF
            MOVE      TPATAMTP,FORM12P2           * Unit price
            ADD       TREBATE,FORM12P2
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",FORM7P2,"</td>":
                             "<td align=right>",FORM72,"</td>";
          ADD       FORM72,FORM7P2
          ADD       PTDTGSTM,TOTGST
          WRITE     HTMLFILE;"<td align=right>",FORM7P2,"</td></tr>"
D3WEB999  RETURN
+
.********************************************************************** 
.*                            D3JHP000                                *
.*                     Johns Hopkins Misc.Items                       *
.********************************************************************** 
D3JHP000  MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
.
          MOVE      ZERO,TRNFLAG
          MOVE      ONE,CSTYPEF
          MOVE      SP70,SAVGCOD
.
          IF        PINVSYS=3 | PINVSYS=2
            MOVE      ONE,CSTYPEF
            IF        PINVSYS=2
              PACK      KEY26 WITH PINVADM,PINVNO,ONE,SP30
            ELSE
              PACK      KEY26 WITH PINVADM,PINVNO,THREE,SP30
            ENDIF
          ELSE
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
D3JHP100  CALL      RDKDTRAN
          BRANCH    OVRCD OF D3JHP820
.
          MATCH     PINVADM,TADMNO
          GOTO      D3JHP820 IF NOT EQUAL
.
          MATCH     PINVNO,TREF
          GOTO      D3JHP820 IF NOT EQUAL
.
          BRANCH    TRECTYPE,D3JHP820,D3JHP820,D3JHP200,D3JHP200
          BRANCH    PINVSYS,D3JHP100
          GOTO      D3JHP820
.
D3JHP200  COMPARE   ZERO,TRNFLAG
          GOTO      D3JHP300 IF EQUAL              * first record
.
          MATCH     SP70,TMISGRP
          GOTO      D3JHP300 IF EQUAL
.
          MATCH     SAVGCOD,TMISGRP
          GOTO      D3JHP300 IF EQUAL
.
.         Display/Print total item for the group   
.
          MOVE      SP70,TDESC    
          MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSN,SAVGCOD,SP70    
            CALL      RDCODE1       
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group ",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
.
          MOVE      MISCTOT,FORM12P2
          IF        INVTYPE=1
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                              "<td>",TDESC,"</td>":
                              "<td>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>",MISCTOT,"</td>":
                              "<td>&nbsp;</td>":
                              "<td align=right>",FORM12P2,"</td>":
                              "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                              "<td><b>",TDESC,"</b></td>":
                              "<td>&nbsp;",TRECEIPT,"</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>",FORM12P2,"</td>":
                              "</tr>"
          ENDIF
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
.
.         Display miscellaneous item
.
D3JHP300  ADD       TPATAMTT,GROSSTOT
          MOVE      TMISGRP,SAVGCOD
.
          ADD       TPATAMTT,MISCTOT
          MOVE      ONE,TRNFLAG
          BRANCH    INVTYPE,D3JHP100           * Summary invoice
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>&nbsp;",TDDESC,"</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;",TRECEIPT,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",TITEMNO,"</td>";
.
          MOVE      TPATAMTT,FORM12P2
          IF        TSERVS<>0
            MOVE      TPATAMTP,FORM12P2           * Unit price
            ADD       TREBATE,FORM12P2
            MULT      TSERVS,FORM12P2
            IF        FORM12P2<>TPATAMTT
              DIV       TSERVS,TPATAMTP
              DIV       TSERVS,TREBATE
            ENDIF
            MOVE      TPATAMTP,FORM12P2           * Unit price
            ADD       TREBATE,FORM12P2
            IF        INVTYPE=2
              WRITE     HTMLFILE;"<td>&nbsp;",TSERVS,"</td>";
            ENDIF
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
            MULT      TSERVS,FORM12P2
          ELSE
            IF        INVTYPE=2
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>":
                             "<td>&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
.
          BRANCH    INVTYPE,D3JHP800           * Summary
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
D3JHP800  WRITE     HTMLFILE;"</tr>";
          GOTO      D3JHP100
.
.        Print item group code
.
D3JHP820  COMPARE   ZERO,TRNFLAG
          GOTO      D3JHP999 IF EQUAL
.
          MOVE      SP70,TDESC
          MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSN,SAVGCOD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group ",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
.
          MOVE      MISCTOT,FORM12P2
          IF        INVTYPE=1
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                              "<td>",TDESC,"</td>":
                              "<td>&nbsp;</td>":
                              "<td align=right>&nbsp;</td>":
                              "<td align=right>",MISCTOT,"</td>":
                              "<td>&nbsp;</td>":
                              "<td align=right>",FORM12P2,"</td>":
                              "</tr>"
            MOVE      ZERO,MISCTOT
            MOVE      ZERO,MISCGST
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                              "<td><b>",TDESC,"</b></td>":
                              "<td>&nbsp;</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td>":
                             "</tr>"
          ENDIF
.
D3JHP900  MOVE      ZERO,CSTYPEF
D3JHP999  RETURN
+
.********************************************************************** 
.         Display procedure from Emergency event or visit if any
.********************************************************************** 
D8TYP000  COMPARE   NINE,PVITYPE
          GOTO      D8TYP025 IF NOT EQUAL
.
          MATCH     " 1",PVISYST             * check for Emergency event
          GOTO      D8TYP999 IF NOT EQUAL
.
          OPEN      PMSEVTA1,"pmsevtaf"
          MOVE      PINVADM,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,D8TYP999
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D8TYP999
          MATCH     ANSE,TCINDC1
          GOTO      D8TYP999 IF NOT EQUAL    * Not an emergency event
.
          GOTO      D8TYP050
.
D8TYP025  COMPARE   ONE,PVITYPE
          GOTO      D8TYP999 IF NOT EQUAL
.
          OPEN      EMRVISA1,"emrvisaf"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,D8TYP999
.
D8TYP050  PACK      KEY22,PINVADM,PINVNO,SP70
          CALL      RDSDTRE1
D8TYP100  CALL      RDKDTRE1
          BRANCH    OVRCD,D8TYP999
.
          MATCH     PINVADM,ATNUMB           * Same admission?
          GOTO      D8TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,ATINVNO           * Same invoice?
          GOTO      D8TYP999 IF NOT EQUAL
.
          COMPARE   FIVE,ATRECTYP
          GOTO      D8TYP100 IF NOT EQUAL    * Not a procedure record
.
          ADD       ATPATAMT,GROSSTOT
          UNPACK    ATDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          MOVE      ATDTGSTM,FORM72
.
          MOVE      ZERO,FORM52
          MOVE      ATDTSCHF,FORM52
          IF        FORM52=9.50
            MOVE      "0.50",FORM52         * Standard - 50% of Schedule fee
          ELSE
            IF        FORM52=9.55
              MOVE      "0.50",FORM52       * HEC - 50% of AMA fee
            ELSE
              IF        FORM52=9.25
                MOVE      "0.25",FORM52     * HEC - 50% of AMA fee
              ENDIF
            ENDIF
          ENDIF
.
          IF        FORM52=1.01
            MOVE      "1.00",FORM52         * ACHA - 100% + Item CF Sched Fee
          ENDIF
.
          IF        FORM52=1.02
            MOVE      "1.00",FORM52         * ACHA - 100% + Item CFD Sched Fee
          ENDIF
.
          IF        FORM52=1.03
            MOVE      "1.00",FORM52         * ACHA - 100% + Item MDO Sched Fee
          ENDIF
.
          IF        FORM52=1.04
            MOVE      "1.00",FORM52         * ACHA - 100% (Medicare)
          ENDIF
.
          IF        FORM52=1.05
            MOVE      "1.00",FORM52         * ACHA - 100% (Review)
          ENDIF
.
          MULT      "100",FORM52
          MOVE      FORM52,F3

          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>&nbsp;",ATDDESC,"</td>":
                             "<td><table width=100%><tr><td>":
                             "&nbsp;",ATITEMNO;
.
          MATCH     SP70,ATDTRBRS
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"</td><td align=right>(",F3,"%)";
          ELSE
            WRITE     HTMLFILE;"</td><td align=right>(",F3,"% - ",ATDTRBRS,")";
          ENDIF
.
          WRITE     HTMLFILE;"</td></tr></table></td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;",ATSERVS,"</td>";
          ENDIF
.
          IF        ATSERVS<>0
            MOVE      ATPATPOR,FORM12P2           * Unit price
            ADD       ATREBPOR,FORM12P2
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",ATPATAMT,"</td>":
                             "<td align=right>",ATDTGSTM,"</td>";
          MOVE      ATPATAMT,FORM12P2
          ADD       ATDTGSTM,FORM12P2
          ADD       ATDTGSTM,TOTGST
          WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td></tr>"
.
          GOTO      D8TYP100
.
D8TYP999  RETURN
+
.********************************************************************** 
.         Display discount
.********************************************************************** 
DDISC000  BRANCH    PINVSYS,DDISC999      * Emergency don't have discount
.
          MOVE      ZERO,FORM1
          MOVE      ONE,CSTYPEF
          IF        PVITYPE=2
            PACK      KEY26 WITH PINVADM,PINVNO,FIVE,SP30
          ELSE
            PACK      KEY26 WITH PINVADM,PINVNO,SEVEN,SP30
          ENDIF
          CALL      RDSDTRAN
DDISC100  CALL      RDKDTRAN
          BRANCH    OVRCD OF DDISC900
.
          MATCH     PINVADM,TADMNO
          GOTO      DDISC900 IF NOT EQUAL       * different admission
.
          MATCH     PINVNO,TREF
          GOTO      DDISC900 IF NOT EQUAL       * different invoice
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      DDISC900 IF NOT EQUAL
.
          IF        FORM1=0
            CALL      DTOTL000             * Display the Invoice Total
            MOVE      ONE,FORM1
          ENDIF
.
          ADD       TPATAMTT,GROSSTOT
          MATCH     TMISGRP,PTCNROUN       * skip Rounding adjustment
          IF        @EQUAL
            ADD       TPATAMTT,ROUNDAMT
            GOTO      DDISC100
          ENDIF
.
          MOVE      ZERO,DISCFLAG
          ADD       TPATAMTT,TOTDISC
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<tr>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>&nbsp;",TDDESC,"</td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MOVE      TPATAMTT,FORM12P2
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td>":
                             "<td>&nbsp;</td>";
.
          BRANCH    INVTYPE,DDISC300           * Summary
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>"
          GOTO      DDISC100
.
DDISC300  WRITE     HTMLFILE;"<td>&nbsp;</td></tr>"
          GOTO      DDISC100
.
DDISC900  MOVE      ZERO,CSTYPEF
DDISC999  RETURN
+
.********************************************************************** 
.*                            D5TYP000                                *
.*                       Routine Description                          *
.********************************************************************** 
D5TYP000  MOVE      ONE,CASHFLAG
.
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,FIVE,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,TWO,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
D5TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD OF D5TYP800
.
          MATCH     PINVADM,TADMNO
          GOTO      D5TYP800 IF NOT EQUAL
.
          MATCH     PINVNO,TREF
          GOTO      D5TYP800 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   FIVE,TRECTYPE
            GOTO      D5TYP100 IF NOT EQUAL
          ELSE
            COMPARE   FIVE,TRECTYPE
            GOTO      D5TYP800 IF NOT EQUAL
          ENDIF
.
          COMPARE    ONE,DBSFLAG
          GOTO       D5TYP180 IF NOT EQUAL
.
          MATCH     SP70,TDEPTYP
          GOTO      D5TYP110 IF NOT EQUAL * Deposit
.
          MATCH     "P" TO TTYPEDEB
          GOTO      D5TYP100 IF NOT EQUAL * Not a patient payment
.
          MOVE      "FROM PATIENT",TDESC
          GOTO      D5TYP120
.
D5TYP110  PACK      KEY5,ANSD,ANSP,TDEPTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            CLEAR     TDESC
            APPEND    "Invalid Deposit Type",TDESC
            APPEND    TDEPTYP,TDESC
            APPEND    SP70,TDESC
            RESET     TDESC
          ENDIF
.
D5TYP120  CLEAR     KEY50
          APPEND    TDESC,KEY50
          APPEND    " RECEIPT ## ",KEY50
          APPEND    TRECEIPT,KEY50
          APPEND    SP70,KEY50
          RESET     KEY50
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;",KEY50,"</td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",TPATAMTT,"</td></tr>";
.
          ADD       TPATAMTT,PAYMTTOT
          GOTO      D5TYP100
.
D5TYP180  COMPARE   ZERO,TREBATE
          GOTO      D5TYP200 IF EQUAL
          MOVE      ONE,NOHIPAYM
.
D5TYP200  ADD       TREBATE TO REBTOT
.
          COMPARE   ZERO,CASHFLAG        * Skip Total/Heading if not 1st time
          GOTO      D5TYP300 IF EQUAL
.
          COMPARE   THREE,IBCNUGST
          GOTO      D5TYP202 IF EQUAL      * NZ Billing
          COMPARE   TWO,IBCNUGST
          GOTO      D5TYP205 IF NOT EQUAL
.
D5TYP202  BRANCH    JOURFLAG,D5TYP205      * no jrnl printed, so printt invtot
          GOTO      D5TYP300 
.
D5TYP205  CALL      DITOT000                * Display the Invoice Total
.
D5TYP300  COMPARE   ZERO,TPATAMTT
          GOTO      D5TYP100 IF EQUAL
          MOVE      "Payment ",DIM8
          ADD       TPATAMTT,FORM72
          MOVE      TDDESC,DIM22
.
.         Check if this is a health fund payment
.
          MATCH     "H" TO TTYPEDEB
          GOTO      D5TYP400 IF NOT EQUAL
          ADD       TPATAMTT TO TOTHEALTH
.
.         Display Payment
.
D5TYP400  MOVE      SP6,DIM6
.         LOAD      DIM6 FROM TPAYTYPE OF CASH,CHEQUE,CREDIT,MERCH,MONEY
.
          MOVE      TDDESC,DIM25
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      TPATAMTT,FORM7P2
.
          CALL      D5WEB000
.
          ADD       TPATAMTT,PAYMTTOT
          MOVE      ZERO,CASHFLAG
.
          GOTO      D5TYP100
.
.         Discharge billing statement only has patient payment
.
D5TYP800  COMPARE   ONE,DBSFLAG
          GOTO      D5TYP950 IF NOT EQUAL
.
          ADD       PAYMTTOT,TDBSAMNT
          MOVE      TRUE,EXIT
          GOTO      D5TYP999
.
D5TYP950  MOVE      FALSE,EXIT
D5TYP999  RETURN
+
.********************************************************************** 
.         Display cash
.********************************************************************** 
D5WEB000  
          IF        CFEETYP=5
            CALL      X5WEB000                 * SX
            GOTO      D5WEB999
          ENDIF
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          WRITE     HTMLFILE;"<tr><td>",DIM8," - ":
                              CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MOVE      TTYPEDEB,KEY1
          MOVE      TDEPTYP,KEY3
          UNPACK    TDCODE,KEY6             * Health Fund or Insurance code
          IF        PINVSYS=1|PINVSYS=2
            PACK      KEY12,TRECEIPT,SP70
            CALL      RDRCBNK1
            IF        OVRCD<>1
              MOVE      ANSP,KEY1
              MOVE      RCBNTTYP,F1
              LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
              UNPACK    RCBNRCOD,KEY6           * Health Fund or Insurance code
            ENDIF
          ENDIF

          CALL      PAYD0000                * Get payment desc.
.
          MOVE      SP70,DIM14
          PACK      RCDTRECN,TRECEIPT,SP70
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,D5WEB200
.
          MATCH     RCDTRECN,RCBDRECN
          GOTO      D5WEB200 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          CALL      CSHDS000                * Get payment type desc.
          IF        F2=2
            MOVE      RCBDDRAW,RCBDPAYD     * Cheque use the drawer as payee
          ENDIF
.
          COMPARE   FIVE,CFEETYP            * SX ?
          GOTO      D5WEB100 IF EQUAL
.
          IF        PTCNINVL=24 | PTCNINVL=25
            MATCH     SP70,RCBDPAYD
            IF        !@EQUAL
              PACK      KEY25,RCBDPAYD   * Payee details
            ENDIF
          ENDIF
          GOTO      D5WEB200
.
D5WEB100  WRITE     HTMLFILE;"<td><b>Receipt ## </b>",TRECEIPT:
                             "<b> Payer: </b>",RCBDPAYD,"</td>";
          GOTO      D5WEB400
.
D5WEB200  WRITE     HTMLFILE;"<td>",KEY25," RECEIPT ## ",TRECEIPT,"</td>";
.
D5WEB400  WRITE     HTMLFILE;"<td>",DIM14,"</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          WRITE       HTMLFILE;"<td align=right>",FORM7P2,"</td></tr>"
D5WEB999  RETURN
.
.********************************************************************** 
.*                            CSHDS000                                *
.*                       Get Payment type description                 *
.********************************************************************** 
CSHDS000  MOVE      SP70,DIM14
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,RCBDPCOD
          CALL      RDCODE1
          BRANCH    OVRCD,CSHDS999
.
          MOVE      ZERO,F2
          SQUEEZE   PTCDNHCP
          MOVE      PTCDNHCP,F2
.
          PACK      DIM14,TDESC
          COMPARE   "3",F2                    * Check for Credit Card
          GOTO      CSHDS200 IF EQUAL
.
          COMPARE   "6",F2
          GOTO      CSHDS999 IF NOT EQUAL
.
CSHDS200  MATCH     SP70,RCBDCRDT
          GOTO      CSHDS999 IF EQUAL
.
          MOVE      "CR",KEY2
          PACK      KEY5,KEY2,RCBDCRDT
          CALL      RDCODE1
          BRANCH    OVRCD,CSHDS999
.
          PACK      DIM14,TDESC
          COMPARE   "3",F2                    * Check for Credit Card
          GOTO      CSHDS999 IF EQUAL
.
          MATCH     "1",RCBDEFTT
          GOTO      CSHDS999 IF EQUAL       * EFTPOS Cash
          MOVE      "EFT/CR",KEY6
          PACK      DIM14,KEY6,SP70
.
CSHDS999  RETURN
+
.********************************************************************** 
.*                            DCSHT000                                *
.*                       Display Cash Total                           *
.********************************************************************** 
DCSHT000  IF        CFEETYP=5
            CALL      XCSHT000           * SX
            GOTO      DCSHT999
          ENDIF
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Payment Total</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        JHFLAG=1 & INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
          ENDIF
          WRITE        HTMLFILE;"<td align=right><b>",PAYMTTOT,"</td></tr>"
DCSHT999  RETURN
+
.********************************************************************** 
.*                            D6TYP000                                *
.*                       Routine Description                          *
.********************************************************************** 
D6TYP000  MOVE      ONE,JOURFLAG
.
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,SIX,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,THREE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
D6TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,D6TYP950               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      D6TYP950 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      D6TYP950 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      D6TYP100 IF NOT EQUAL
          ELSE
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      D6TYP950 IF NOT EQUAL
          ENDIF

          IF        DBSFLAG=1
            PACK      KEY5,ANSJ,SP1,TTYPE
            CALL      RDCODE1
            IF        OVRCD=1
              GOTO      D6TYP100
            ELSE
              MATCH     "P",TCINDC8
              IF        !@EQUAL
                GOTO      D6TYP100
              ENDIF
            ENDIF
          ENDIF

          ADD       TREBATE,REBTOT
.
          MOVE      TPATAMTT,FORM72
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTDTGSTM,FORM72
          ENDIF
.
          COMPARE   ZERO TO FORM72
          GOTO      D6TYP100 IF EQUAL
.
          COMPARE   ZERO,JOURFLAG
          GOTO      D6TYP200 IF EQUAL
.
          COMPARE   ZERO,CASHFLAG
          GOTO      D6TYP200 IF EQUAL
          CALL      DITOT000                * Display the Invoice Total
.
D6TYP200  MOVE      "Journal ",DIM8
          MOVE      TDDESC,DIM22
.
          MOVE      SP6,DIM6
          COMPARE   ZERO,PTCNPJCI
          GOTO      D6TYP300 IF EQUAL
          MOVE      "JNL ",DIM4
          PACK      DIM6,DIM4,TTYPE
.
D6TYP300  MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          MOVE      TDDESC,DIM25
          MOVE      TPATAMTT,FORM7P2
          CALL      D6WEB000
.
          MOVE      ZERO,JOURFLAG
          ADD       TPATAMTT,JOURTOT
          GOTO      D6TYP100
.
D6TYP950  MOVE      FALSE,EXIT
          IF        DBSFLAG=1
            MOVE      ONE,JOURFLAG
          ENDIF
          BRANCH    JOURFLAG,D6TYP999
          CALL      DJRLT000                * Display Journal Total
.
D6TYP999  RETURN
+
.********************************************************************** 
.         Display journals
.********************************************************************** 
D6WEB000  
          IF        CFEETYP=5
            CALL      X6WEB000                 * SX
            GOTO      D6WEB999
          ENDIF
.
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          IF        DBSFLAG=1
            WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"":
                                "</td><td>",DIM25,TRECEIPT,"</td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td>",DIM8," - ":
                                CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                                "<td>",DIM25,TRECEIPT,"</td>";
          ENDIF
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MOVE      TTYPE,DIM2
.          
          IF        DBSFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp",DIM6,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp",DIM6:
                "&nbsp;<img src=../images/CommentIcon.gif class=ListIcon ":
                "onclick='JournalEnquiry(#"",DIM2,KEY8,TADMNO,TTRANSN1,"#");'>":
                 "</td>";
          ENDIF
.
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        DBSFLAG=1
            ADD       PTDTGSTM,TPATAMTT
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td align=right>",TPATAMTT,"</td></tr>";
            ADD       TPATAMTT,TDBSAMNT 
            GOTO      D6WEB999
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          IF        TRECTYPE=6
            IF        PTDTGSTM<>0
              MOVE      PTDTGSTM,FORM72
              ADD       PTDTGSTM,TPATAMTT
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td align=right>",TPATAMTT,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td align=right>",TPATAMTT,"</td>":
                                 "<td>&nbsp;</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp",TRECEIPT,"</td>":
                             "<td>&nbsp",DIM6,"</td>";
          ENDIF
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right>",TPATAMTT,"</td></tr>"
D6WEB999  RETURN
.
.********************************************************************** 
.*                            DJRLT000                                *
.*                    Display the Journal Total                       *
.********************************************************************** 
DJRLT000  MOVE      JOURTOT,FORM72
          COMPARE   "23",PTCNINVL
          GOTO      DJRLT200 IF EQUAL      * SX Invoice layout
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Adjustments Total</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right><b>",JOURTOT,"</td></tr>"
          GOTO      DJRLT999
.
DJRLT200  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Adjustments Total</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",JOURTOT,"</td></tr>"
DJRLT999  RETURN
+
.********************************************************************** 
.*                            DITOT000                                *
.*                    Display the Invoice Total                       *
.********************************************************************** 
DITOT000  BRANCH    DBSFLAG,DITOT999
          BRANCH    CBFLAG,DITOT999
          MOVE      GROSSTOT,FORM12P2
.
          COMPARE   THREE,IBCNUGST               * GST on Invoice total?
          GOTO      DITOT100 IF NOT EQUAL
.
          MOVE      PTINGSTA,GSTAMNT
          MOVE      PTINGSTA,TOTGST
          MOVE      GROSSTOT,FORM12P2
          SUB       ROUNDAMT,FORM12P2
.
DITOT100  IF        CFEETYP=5
            CALL      SITOT000                 * SX
            MOVE      ONE,CBFLAG
            GOTO      DITOT999
          ENDIF
          MOVE      GROSSTOT,TOTAMNT
          ADD       TOTGST,TOTAMNT
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Invoice Total</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          IF        INVTYPE=0 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right><b>",FORM12P2,"</td>":
                             "<td align=right><b>",TOTGST,"</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE       HTMLFILE;"<td align=right><b>",TOTAMNT,"</td></tr>"
          MOVE       ONE,CBFLAG
.
DITOT999  RETURN
+
.********************************************************************** 
.*                            DTOTL000                                *
.*              Display Total invoice before Discount and Rounding    *
.********************************************************************** 
DTOTL000  MOVE      GROSSTOT,TOTAMNT
          ADD       TOTGST,TOTAMNT
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Total Charges</b></td>";
.
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right><b>",GROSSTOT,"</td>";
.
          IF        JHFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
            IF        INVTYPE=2
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td align=right><b>",GROSSTOT,"</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<td align=right><b>",TOTGST,"</td>":
                               "<td align=right><b>",TOTAMNT,"</td></tr>"
          ENDIF
.
DTOTL999  RETURN
+
.********************************************************************** 
.*                            DREBT000                                *
.*        Display/Print Estimate rebate                               *
.********************************************************************** 
DREBT000  COMPARE   "22",PTCNINVL
          GOTO      DREBT999 IF EQUAL       * Johns Hopkins invoice layout
          COMPARE   "23",PTCNINVL
          GOTO      DREBT999 IF EQUAL       * SX invoice layout
.
          BRANCH    PRINTFLG,DREBT100
.
          BRANCH    PTCNPEFR,DREBT010,DREBT999
          COMPARE   ZERO,REBTOT
          GOTO      DREBT999 IF EQUAL
.
DREBT010  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td><b>Estimated Rebate</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td align=right><b>",REBTOT,"</td></tr>"
.
          GOTO      DREBT999
.
.         Display/Print Rebate total
.         Driven by the System parameter PTCNPEFR
.            0 = Print if not zero
.            1 = Print if no health fund or insurance payments
.            2 = Do not print rebate at all
.
DREBT100  BRANCH    PTCNPEFR,DREBT200,DREBT999
          COMPARE   ZERO,REBTOT
          GOTO      DREBT999 IF EQUAL
          GOTO      DREBT300
.
DREBT200  BRANCH    NOHIPAYM,DREBT999
         
DREBT300  COMPARE   ZERO,REBTOT
          GOTO      DREBT999 IF EQUAL
.
          BRANCH    PINVTYP OF DREBT999
          MOVE      REBTOT,LNTOTAL
          MOVE      SEVEN,RECFLAG
          CALL      PRLN0000               * Print estimate rebate
          GOTO      DREBT999
.
DREBT999  RETURN
+
.********************************************************************** 
.*                            DENDI000                                *
.*                    Display End of the Invoice                      *
.********************************************************************** 
DENDI000  COMPARE   ZERO,CASHFLAG
          GOTO      DENDI500 IF EQUAL
.
          COMPARE   ZERO,JOURFLAG
          GOTO      DENDI500 IF EQUAL
.
          CALL      DITOT000                * Display Invoice Total
.
          MOVE      TWO,COMPFLG             * flag to display
          CALL      DCRD0000                * Display credit note total
.
          MOVE      GROSSTOT,NETTOT
          ADD       CREDTOT,NETTOT
.
          COMPARE   ZERO,CREDTOT
          GOTO      DENDI600 IF NOT EQUAL   * Credit Note
.
          GOTO      DENDI800
.
DENDI500  MOVE      GROSSTOT,NETTOT
          ADD       PAYMTTOT,NETTOT
          ADD       JOURTOT,NETTOT
          ADD       CASHTOT,NETTOT          * Include Cash pending
.
          MOVE      TWO,COMPFLG             * flag to display
          CALL      DCRD0000                * Display credit note total
          ADD       CREDTOT,NETTOT  
.
DENDI600  ADD       TOTGST,NETTOT
          IF        CFEETYP=5
            CALL      SENDI000             * SX
          ELSE
            CALL      DBAL0000             * Display balance payable
          ENDIF
.         GOTO      DENDI999
. 
DENDI800  IF        CFEETYP=5
            CALL      DWLS0000             * Display Win/Loss for SX
          ENDIF
.
          CALL      DREBT000                * Display Rebate Total
.
DENDI999  RETURN
+
.********************************************************************** 
.         Display balance payable
.********************************************************************** 
DBAL0000  
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td><b>Balance Payable</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        JHFLAG=1 & INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
          IF        NETTOT<0
            WRITE     HTMLFILE;"<td align=right><font color=#FF0000><b>":
                               NETTOT,"</font></b></td></tr>"
          ELSE
            WRITE     HTMLFILE;"<td align=right><font color=#0000FF><b>":
                               NETTOT,"</font></b></td></tr>"
          ENDIF
DBAL9999  RETURN
+
.********************************************************************** 
.*                            P1TYP000                                *
.*                    Process Accom. Records (ie. TRECTYPE = 1)       *
.********************************************************************** 
P1TYP000  IF        DBSFLAG=1
            CALL      B1TYP000           * Discharge billing statement
            GOTO      P1TYP999
          ENDIF
.
          IF        CRDNFLAG=1
            MOVE      "1",KEY1
          ENDIF
.
          IF        PTCNINVL=22
            CALL      J1TYP000            * Johns Hopkins Accommodation
            GOTO      P1TYP999
          ENDIF
.
          IF        CFEETYP=5 & PTCNINVL=23
            CALL      S1TYP000            * SX Accommodation
            GOTO      P1TYP999
          ENDIF
.
          CALL      PRACC000              * Processing Accommodation
.
P1TYP999  RETURN
.
.********************************************************************** 
.         Processing Accommodation
.********************************************************************** 
PRACC000
          MOVE      "1",DIM1
          IF        ABFFLAG=1
            MOVE      "9",DIM1            * ABF record type
          ENDIF
          PACK      KEY31 WITH PINVADM,PINVNO,DIM1,SP30
          PACK      KEY23 WITH PINVADM,PINVNO,DIM1,SP30
          PACK      KEY22 WITH PINVADM,PINVNO,SP30
          MOVE      ZERO,INVBFLAG
          MOVE      ZERO,F5
.
          CALL      RDSDTRAN
PRACC100  CALL      RDKDTRAN
          BRANCH    OVRCD,PRACC999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      PRACC999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      PRACC999 IF NOT EQUAL
.
          IF        ABFFLAG=1
            COMPARE   NINE,TRECTYPE
            GOTO      PRACC800 IF EQUAL          * ABF record type
          ENDIF
.
          COMPARE   ONE,TRECTYPE                 * Check for Accom. Record
          GOTO      PRACC999 IF NOT EQUAL
.
          MOVE      TDDESC,SMDESC
          IF        DCFLAG=1
            IF        (PTDTLSPT <> 0) | (PTDTLSRB <> 0)
              MATCH     SP70,PTDTLSD1
              IF        @EQUAL
                CALL      DLUM0000        * Get desc. for daycase lumpsum amount
                MOVE      LSDESC1,PTDTLSD1
                MOVE      LSDESC2,PTDTLSD2
              ENDIF
              CALL      CIBL0000        * Check invoice breakdown
              MOVE      SMDESC,TDDESC
            ENDIF
            GOTO       PRACC500
          ENDIF
.
          BRANCH    F5,PRACC500
          COMPARE   ONE,PTINCMIX
          GOTO      PRACC500 IF NOT EQUAL
.
          MATCH     SP70,PTDTLSD1
          IF        @EQUAL
            CALL      OLUM0000        * Get desc. for overnight lumpsum amount
            MOVE      LSDESC1,PTDTLSD1
            MOVE      LSDESC2,PTDTLSD2
          ENDIF
.
          IF        PTDTDTYP=0 & (PTDTLSPT<>0 | PTDTLSRB<>0)
            GOTO      PRACC110
          ENDIF
.
          IF        (PTDTDTYP=2 | PTDTDTYP=3)
            GOTO      PRACC110      * daily charge high outlier
          ENDIF
          GOTO      PRACC500
.
PRACC110  MOVE      ONE,F5
          CALL      CIBL0000        * Check invoice breakdown
          MOVE      SMDESC,TDDESC
.
.         Daycase casemix patient does not have any additional charge
.
PRACC500  
.         IF        DCFLAG=1 & TNODAYS =0
          IF        TNODAYS =0
            GOTO      PRACC999
          ENDIF
.
PRACC800  PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY,SP70
          PACK      DTDATE,TTCENT,TTYEAR,TTMONTH,TTDAY,SP70
          MOVE      TNODAYS,NODAYS
          MOVE      TPATAMTI,LSTRATE
          MOVE      PTDTGSTM,LINEGST
          MOVE      TPATAMTT,LINETOT
.
.         Do not print zero amount of Accom.for New Patient Inv.functionality
.
          IF        IPATFLAG=2
            COMPARE   ZERO,LINETOT
            GOTO      PRACC900 IF EQUAL
          ENDIF
          MOVE      ONE,RECFLAG
          CALL      PRLN0000           * Print Accommodations
.
PRACC900  ADD       PTDTGSTM,TOTGST
          MOVE      TDDESC,REGIST8
          ADD       TPATAMTT,GROSSTOT
          ADD       TNODAYS,TOTDAYS
.
          BRANCH    ABFFLAG,PRACC999   * ABF should only have one record
          GOTO      PRACC100
.
PRACC999  RETURN
+
.**********************************************************************
.         Check Invoice breakdown
.**********************************************************************
CIBL0000  OPEN      PATIBLA1,"patiblaf"
          PACK      KEY19,AADMNO,PINVNO,SP70
          CALL      RSPTIBL1
CIBL1000  CALL      RKPTIBL1
          BRANCH    OVRCD,CIBL2000
.
          MATCH     DAADMNO,PTIBADMN
          GOTO      CIBL2000 IF NOT EQUAL
.
          MATCH     PINVNO,PTIBINVN
          GOTO      CIBL2000 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTIBBRCD
          CALL      RDCODE1
          IF        OVRCD<>0
            MOVE      "Invalid Code",SAVDES1
          ENDIF
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PTIBAMNT,FORM72
          MOVE      PTIBGAMN,PTDTGSTL
          IF        INVBFLAG=0
            ADD       PTDTLSRB,REBTOT
          ENDIF
          MOVE      ONE,INVBFLAG
          GOTO      CIBL4000
.
CIBL2000  BRANCH    INVBFLAG,CIBL9999
          MOVE      PTDTLSPT,FORM72
          ADD       PTDTLSRB,FORM72
          ADD       PTDTLSRB TO REBTOT
          PACK      SAVDES1,PTDTLSD1,SP70
          PACK      SAVDES2,PTDTLSD2,SP70
.
CIBL4000  ADD       FORM72,GROSSTOT
          ADD       PTDTGSTL,TOTGST
.
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY,SP70
          MOVE      SP70,DTDATE
.
          MOVE      ZERO,LSTRATE
          MOVE      PTDTGSTL,LINEGST
          MOVE      FORM72,LINETOT
          MOVE      ZERO,RECFLAG
          CALL      PRLN0000        * Print lumpsum
.
          ADD       TREBATE,REBTOT               * Add Rebate Total
.
          COMPARE   MAXLINE,COUNT              * Check For A Full Page
          CALL      TAIL IF NOT LESS
          BRANCH    INVBFLAG,CIBL1000
.
CIBL9999  RETURN
+
.**********************************************************************
.*                            B1TYP000                                *
.*               Process Accom. Records Discharge billing statement.  *
***********************************************************************
B1TYP000  PACK      KEY23 WITH PINVADM,PINVNO,ONE,SP30
          MOVE      ZERO,INVBFLAG
          MOVE      ZERO,F5
          CALL      RDSDTRN4
B1TYP100  CALL      RDKDTRN4
          BRANCH    OVRCD,B1TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      B1TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      B1TYP999 IF NOT EQUAL
.
          COMPARE   ONE,TRECTYPE                 * Check for Accom. Record
          GOTO      B1TYP999 IF NOT EQUAL
.
          IF        DCFLAG=1
            IF        (PTDTLSPT <> 0) | (PTDTLSRB <> 0)
              MATCH     SP70,PTDTLSD1
              IF        @EQUAL
                CALL      DLUM0000        * Get desc. for daycase lumpsum amount
                MOVE      LSDESC1,PTDTLSD1
                MOVE      LSDESC2,PTDTLSD2
              ENDIF
              GOTO      B1TYP120
            ENDIF
            GOTO      B1TYP500
          ENDIF
.
          BRANCH    F5,B1TYP500
          COMPARE   ONE,PTINCMIX
          GOTO      B1TYP500 IF NOT EQUAL
.
          MATCH     SP70,PTDTLSD1
          IF        @EQUAL
            CALL      OLUM0000        * Get desc. for overnight lumpsum amount
            MOVE      LSDESC1,PTDTLSD1
            MOVE      LSDESC2,PTDTLSD2
          ENDIF
.
          IF        PTDTDTYP=0 & (PTDTLSPT<>0 | PTDTLSRB<>0)
            GOTO      B1TYP110
          ENDIF
.
          IF        (PTDTDTYP=2 | PTDTDTYP=3)
            GOTO      B1TYP110
          ENDIF
          GOTO      B1TYP500
.
B1TYP110  MOVE      ONE,F5
.
B1TYP120  PACK      SAVDES1,PTDTLSD1,SP70
          PACK      SAVDES2,PTDTLSD2,SP70
          COMPARE   MAXLINE,COUNT                   * Check For A Full Page
          CALL      TAIL IF NOT LESS
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          MOVE      PTDTLSPT,FORM62
          IF        PTCNINVL=25
            MOVE      FORM62,FORM52
            PRINT     *1,CPDATE,*19,SAVDES1:
                      *73,FORM52
          ELSE
            PRINT     *1,CPDATE,*23,SAVDES1:
                      *71,FORM62
          ENDIF
          ADD       FORM62,TDBSAMNT
          ADD       ONE,COUNT
.
B1TYP500
          COMPARE   MAXLINE,COUNT                   * Check For A Full Page
          CALL      TAIL IF NOT LESS
.
.         Daycase casemix patient does not have any additional charge
.
.         IF        DCFLAG=1 & TNODAYS =0
          IF        TNODAYS =0
            GOTO      B1TYP999
          ENDIF
.
          MOVE      TPATAMTT,FORM62
          SUB       TREBATE,FORM62
          COMPARE   ZERO,FORM62
          GOTO      B1TYP100 IF EQUAL        * not printing zero line total
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          PRINT     *1,CPDATE;
.
          MOVE      TTDAY,CDAY
          MOVE      TTMONTH,CMON
          MOVE      TTCENT,CCENT
          MOVE      TTYEAR,CYEAR
          CALL      PACDATE
          MOVE      TNODAYS,FORM3
          UNPACK    TDDESC,KEY20
          MOVE      TPATAMTT,FORM62
          SUB       TREBATE,FORM62
          IF        TNODAYS<>0
            DIV       TNODAYS,FORM62
          ENDIF
          IF        PTCNINVL=25
            MOVE      FORM62,FORM52
            PRINT     *10,CPDATE:
                      *19,KEY20:
                      *50,FORM52:
                      *60,FORM3;
          ELSE
            PRINT     *10,CPDATE,*19,FORM3:
                      *23,KEY20:
                      *53,FORM62;
          ENDIF
.
          MOVE      TPATAMTT,FORM62
          SUB       TREBATE,FORM62           * Total patient portion
          IF        PTDTGSTM<>0
            MOVE      ZERO,LINEGST
            CALL      FGST0000               * Get Item GST rate
            MOVE      FORM62,LINEGST
            MULT      IBGEAMNT,LINEGST     * GST amount
            DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
            ADD       LINEGST,FORM62
          ENDIF
          IF        PTCNINVL=25
            MOVE      FORM62,FORM52
            PRINT     *73,FORM52
          ELSE
            PRINT     *71,FORM62
          ENDIF
          ADD       FORM62,TDBSAMNT
          ADD       ONE,COUNT
          GOTO      B1TYP100
.
B1TYP999  RETURN
+
.********************************************************************** 
.           Print Johns Hopkins accommodation
.********************************************************************** 
J1TYP000  PACK      KEY31 WITH PINVADM,PINVNO,ONE,SP30
          PACK      KEY23 WITH PINVADM,PINVNO,ONE,SP30
          PACK      KEY22 WITH PINVADM,PINVNO,SP30
          MOVE      ZERO,INVBFLAG
.
          CALL      RDSDTRAN
J1TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,J1TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      J1TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      J1TYP999 IF NOT EQUAL
.
          COMPARE   ONE,TRECTYPE                 * Check for Accom. Record
          GOTO      J1TYP999 IF NOT EQUAL
.
          MOVE      TPATAMTI,FORM6P2
.
          IF        TNODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          PACK      KEY27,SP70
          CLEAR     KEY27
          APPEND    "@",KEY27
          APPEND    FORM6P2,KEY27
          APPEND    " for",KEY27
.
          MOVE      TPATAMTT,FORM12P2
          DIV       TPATAMTI,FORM12P2
          MOVE      FORM12P2,FORM41
.
          MOVE      SP70,KEY6
          UNPACK    FORM41,KEY6
          UNPACK    KEY6,KEY4,KEY2
          MATCH     ".5",KEY2               * check if the last 2 chars
          GOTO      J1TYP300 IF NOT EQUAL
.
          MOVE      "DAYS",DAYFORMT
          MOVE      TNODAYS,FORM41
          ADD       "0.5",FORM41
          APPEND    FORM41,KEY27
          GOTO      J1TYP500
.
J1TYP300  APPEND    TNODAYS,KEY27
J1TYP500  APPEND    SP1,KEY27
          APPEND    DAYFORMT,KEY27
          APPEND    SP70,KEY27
          RESET     KEY27
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TPATAMTT,FORM7P2
.
          COMPARE   ONE,INVTYPE
          GOTO      J1TYP600 IF NOT EQUAL
.
          UNPACK    KEY27,KEY24
          PRINT     *3,TDDESC,*33,KEY24,*57,FORM7P2      * Summary
          GOTO      J1TYP800
.
J1TYP600  PRINT     *3,TDDESC,*33,KEY27,*70,FORM7P2      * Details
.
J1TYP800  ADD       TPATAMTT,TOTAMNT
          ADD       PTDTGSTM,GSTAMNT
          ADD       ONE,COUNT
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
.         Johns Hopkins will have an extra line for Accommodation dates
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          PRINT     *3,"(",CPCDATE;
.
          MOVE      TTDAY,CDAY
          MOVE      TTMONTH,CMON
          MOVE      TTCENT,CCENT
          MOVE      TTYEAR,CYEAR
          CALL      PACDATE
          PRINT     *14," to ",CPCDATE,")"
          ADD       ONE,COUNT
.
          GOTO      J1TYP100
.
J1TYP999  RETURN
+
.********************************************************************** 
.*                            P2TYP000                                *
.*                   Process Theatre Records (ie. TRECTYPE = 2)       *
.********************************************************************** 
P2TYP000  IF        DBSFLAG=1
            CALL      B2TYP000           * Discharge billing statement
            GOTO      P2TYP999
          ENDIF
.
          IF        CRDNFLAG=1
            MOVE      "2",KEY1
          ENDIF
.
          IF        PTCNINVL=22
            CALL      J2TYP000            * Johns Hopkins Theatre items
            GOTO      P2TYP999
          ENDIF
.
          IF        CFEETYP=5 & PTCNINVL=23
            CALL      S8TYP000            * SX Procedure
            CALL      S2TYP000            * SX items
            GOTO      P2TYP999
          ENDIF
.
          CALL      PRTHE000              * Processing Items
.
P2TYP999  RETURN
.
.********************************************************************** 
.         Processing items
.********************************************************************** 
PRTHE000  IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,TWO,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,ONE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          MOVE      SP70,SAVEUNIQ
          MOVE      SP70,SAVDATE1
          CALL      RDSDTRAN
PRTHE100  CALL      RDKDTRAN
          BRANCH    OVRCD,PRTHE900               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      PRTHE900 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      PRTHE900 IF NOT EQUAL
.
          IF        TRECTYPE<>2
            IF        TRECTYPE=3 & (PINVSYS=1 | PINVSYS=2)
.
. ----- Go thru all misc items to get theatre items for A&E & outpatients -----
.
              GOTO      PRTHE100
            ELSE
              GOTO      PRTHE999
            ENDIF
          ENDIF
.
          IF        PTCNINVL=24
            PACK      SAVDATE2,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
            REP       " 0",SAVDATE2
.
            MATCH     SP70,SAVDATE1
            IF        !@EQUAL
              MATCH     SAVDATE1,SAVDATE2
              IF        !@EQUAL
                CALL      GJGB0000
              ENDIF
            ENDIF
            MOVE      SAVDATE2,SAVDATE1
            MOVE      PTDTUNIQ,SAVEUNIQ
          ENDIF
.
          MOVE      TREBATE,FORM12P2
          IF        TSERVS<>0
            MULT      TSERVS,FORM12P2
          ENDIF
          ADD       FORM12P2,REBTOT               * Add Rebate Total
          MOVE      TDDESC,DIM25
.
.        Check "Hospital ID', if MBS Code should be printed on invoice
.
          IF        TRECTYPE=2
            IF        IBCNMHOS=1 
              MATCH     "1",PTHSPMBS
              IF        !@EQUAL
                MOVE      SP10,TITEMNO
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      TSERVS,NODAYS
          MOVE      TPATAMTT,LINETOT
          MOVE      TPATAMTI,LSTRATE
.
          MOVE      TPATAMTP,LSTRATE
          ADD       TREBATE,LSTRATE
          MOVE      PTDTGSTM,LINEGST
          ADD       PTDTGSTM,TOTGST
          MOVE      TITEMNO,PRTITCOD
.
          MOVE      SP70,XBANDING
          IF        PTCNINVL=16 | PTCNINVL=18
            CALL      CHKCL000                * Check if Banding to be printed
            IF        F1=1
              MOVE      PTDTSUNQ,XBANDING     *  only for WC or TAC
            ENDIF
          ENDIF
.
          IF        IPATFLAG=2
            COMPARE   ZERO,LINETOT
            GOTO      PRTHE800 IF EQUAL
          ENDIF
.
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      SP70,DTDATE
          MOVE      TWO,RECFLAG
          CALL      PRLN0000               * Print item line
.
PRTHE800  ADD       TPATAMTT,GROSSTOT
          GOTO      PRTHE100
.
PRTHE900  IF        PTCNINVL=24
            MATCH     SP70,SAVDATE1
            IF        !@EQUAL
              CALL      GJGB0000
            ENDIF
          ENDIF
PRTHE999  RETURN
+
.**********************************************************************
.*                            B2TYP000                                *
.*      Process Theatre Records (ie. TRECTYPE = 2) Disc.Billing Stat. *
.**********************************************************************
B2TYP000  PACK      KEY23 WITH PINVADM,PINVNO,TWO,SP30
          MOVE      ZERO,INVBFLAG
          CALL      RDSDTRN4
B2TYP100  CALL      RDKDTRN4
          BRANCH    OVRCD,B2TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      B2TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      B2TYP999 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      B2TYP999 IF NOT EQUAL
.
          CALL      XCLI0000             * Check Exclude Item for Disc.Billing
          BRANCH    EXIT,B2TYP100
.
          MOVE      TDDESC,DIM20
          COMPARE   MAXLINE,COUNT                * Check For A Full Page
          CALL      TAIL IF NOT LESS
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
.
.        Check "Hospital ID', if MBS Code should be printed on invoice
.
          IF        TRECTYPE=2
            IF        IBCNMHOS=1
              MATCH     "1",PTHSPMBS
              IF        !@EQUAL
                MOVE      SP10,TITEMNO
              ENDIF
            ENDIF
          ENDIF
.
.
          MOVE      TSERVS,NODAYS
          IF        NODAYS=0
            MOVE      ONE,NODAYS
          ENDIF
          MOVE      TPATAMTT,FORM62
          SUB       TREBATE,FORM62
          COMPARE   ZERO,FORM62
          GOTO      B2TYP100 IF EQUAL        * skip zero amt item
.
          MOVE      TPATAMTP,FORM62
          IF        PTCNINVL=25
            PRINT     *1,CPDATE:
                      *10,TITEMNO;
            IF        PTMBSINV<>1
              PRINT     *19,DIM20;
            ENDIF
            MOVE      FORM62,FORM52
            PRINT     *50,FORM52,*59,NODAYS;
          ELSE
            PRINT     *1,CPDATE,*18,NODAYS;
            IF        PTMBSINV<>1
              PRINT     *23,DIM20;
            ENDIF
            PRINT     *44,TITEMNO:
                      *53,FORM62;
          ENDIF
.
          MOVE      TPATAMTT,FORM62
          SUB       TREBATE,FORM62
          MOVE      ZERO,LINEGST
          IF        PTDTGSTM<>0
            CALL      FGST0000               * Get Item GST rate
            MOVE      FORM62,LINEGST
            MULT      IBGEAMNT,LINEGST     * GST amount
            DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
            ADD       LINEGST,FORM62
          ENDIF
          IF        PTCNINVL=25
            MOVE      LINEGST,FORM52
            PRINT     *64,FORM52;
            MOVE      FORM62,FORM52
            PRINT     *73,FORM52
          ELSE
            PRINT     *71,FORM62
          ENDIF
          ADD       FORM62,TDBSAMNT
.
          ADD       ONE,COUNT
          GOTO      B2TYP100
.
B2TYP999  RETURN
+
.**********************************************************************
.*                            J2TYP000                                *
.*                   Process Theatre Records (ie. TRECTYPE = 2) JH    *
.**********************************************************************
J2TYP000  COMPARE   THREE,PINVSYS
          GOTO      J2TYP999 IF NOT EQUAL
.
          PACK      KEY23 WITH PINVADM,PINVNO,TWO,SP30
          CALL      RDSDTRAN
J2TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,J2TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      J2TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      J2TYP999 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      J2TYP999 IF NOT EQUAL
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TPATAMTT,FORM7P2
          UNPACK    TDDESC,KEY25
          PACK      KEY10,TFDAY,SLASH,TFMONTH,SLASH,TFCENT,TFYEAR,SP70
          REP       " 0",KEY10
          IF        INVTYPE=1
            PRINT     *3,TITEMNO:
                      *13,KEY10:
                      *26,KEY25,*57,FORM7P2  * Summary
          ELSE
            PRINT     *3,TITEMNO:
                      *13,KEY10:
                      *26,KEY25,*52,TSERVS,*70,FORM7P2  * Details
          ENDIF
          ADD       ONE,COUNT
          ADD       TPATAMTT,TOTAMNT
          ADD       PTDTGSTM,GSTAMNT
          GOTO      J2TYP100
.
J2TYP999  RETURN
+
.********************************************************************** 
.*                            P3TYP000                                *
.*             Process Miscellaneous Records (ie. TRECTYPE = 3)       *
.********************************************************************** 
P3TYP000  IF        DBSFLAG=1
            CALL      B3TYP000           * Discharge billing statement
            GOTO      P3TYP999
          ENDIF
.
          IF        CRDNFLAG=1
            MOVE      "3",KEY1
          ENDIF
.
          IF        PTCNINVL=22
            CALL      J3TYP000            * Johns Hopkins Miscellaneous items
            GOTO      P3TYP999
          ENDIF
.
          IF        CFEETYP=5 & PTCNINVL=23
            CALL      S3TYP000            * SX Miscellaneous items
            GOTO      P3TYP999
          ENDIF
.
          CALL      PRMIS000                     * Processing Misc.Item
.
P3TYP999  RETURN
+
.********************************************************************** 
.         Processing Misc.Item
.********************************************************************** 
PRMIS000  IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,THREE,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,ONE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
PRMIS100  CALL      RDKDTRAN
          BRANCH    OVRCD,PRMIS999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      PRMIS999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      PRMIS999 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   THREE,TRECTYPE               * Check for Misc. Record
            GOTO      PRMIS100 IF NOT EQUAL
          ELSE
            COMPARE   THREE,TRECTYPE               * Check for Misc. Record
            GOTO      PRMIS999 IF NOT EQUAL
          ENDIF
.
          MOVE      TDDESC,KEY15
          MOVE      TDDESC,DIM25
          MOVE      TDDESC,DIM30A                * I-54768
.
          MOVE      TREBATE,FORM12P2
          IF        TSERVS<>0
            MULT      TSERVS,FORM12P2
          ENDIF
          ADD       FORM12P2,REBTOT               * Add Rebate Total
.
          MOVE      TDDESC,DIM25
          MOVE      TDDESC,DIM30A                * I-54768
.
          MOVE      ZERO,FORM7P2
          ADD       TPATAMTP,FORM7P2
          ADD       TREBATE,FORM7P2
.
          COMPARE   ZERO,FORM7P2
          GOTO      PRMIS200 IF NOT EQUAL
.
          COMPARE   ZERO,TPATAMTP
          GOTO      PRMIS200 IF EQUAL
.
. Therefore we have a front end deduction
.
          BRANCH    PTCNPFED,PRMIS200
          GOTO      PRMIS300
.
PRMIS200  MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
.
          MOVE      TSERVS,NODAYS
          MOVE      TPATAMTT,LINETOT
          MOVE      TPATAMTI,LSTRATE
.
          MOVE      TPATAMTP,LSTRATE
          ADD       TREBATE,LSTRATE
          MOVE      PTDTGSTM,LINEGST
          ADD       PTDTGSTM,TOTGST
          MOVE      TITEMNO,PRTITCOD
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      SP70,DTDATE
.
          IF        IPATFLAG=2
            COMPARE   ZERO,LINETOT
            GOTO      PRMIS300 IF EQUAL
          ENDIF
.
          MOVE      TWO,RECFLAG
          CALL      PRLN0000           * Print items
.
PRMIS300  ADD       TPATAMTT,GROSSTOT
          GOTO      PRMIS100
.
PRMIS999  RETURN
+
.**********************************************************************
.*                            B3TYP000                                *
.*   Process Miscellaneous Records (ie. TRECTYPE = 3) Disc.Bill.Stat. *
.**********************************************************************
B3TYP000  PACK      KEY23 WITH PINVADM,PINVNO,THREE,SP30
          CALL      RDSDTRN4
B3TYP100  CALL      RDKDTRN4
          BRANCH    OVRCD,B3TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      B3TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      B3TYP999 IF NOT EQUAL
.
          COMPARE   THREE,TRECTYPE               * Check for Misc. Record
          GOTO      B3TYP999 IF NOT EQUAL
.
          CALL      XCLI0000             * Check Exclude Item for Disc.Billing
          BRANCH    EXIT,B3TYP100
.
          MOVE      TDDESC,DIM20
          COMPARE   MAXLINE,COUNT                   * Check For A Full Page
          CALL      TAIL IF NOT LESS
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          MOVE      TSERVS,NODAYS
          IF        NODAYS=0
            MOVE      ONE,NODAYS
          ENDIF
.
          MOVE      TPATAMTP,FORM62
.
          IF        PTCNINVL=25
            PRINT     *1,CPDATE:
                      *10,TITEMNO:
                      *19,DIM20;
            MOVE      FORM62,FORM52
            PRINT     *50,FORM52,*59,NODAYS;
          ELSE
            PRINT     *1,CPDATE,*18,NODAYS:
                      *23,DIM20,*44,TITEMNO:
                      *53,FORM62;
          ENDIF
.
          MOVE      TPATAMTP,FORM62
          IF        TSERVS<>1
            MULT      TSERVS,FORM62
          ENDIF
.
          MOVE      ZERO,LINEGST
          IF        PTDTGSTM<>0
            CALL      FGST0000               * Get Item GST rate
            MOVE      FORM62,LINEGST
            MULT      IBGEAMNT,LINEGST     * GST amount
            DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
            ADD       LINEGST,FORM62
          ENDIF
          IF        PTCNINVL=25
            MOVE      LINEGST,FORM52
            PRINT     *64,FORM52;
            MOVE      FORM62,FORM52
            PRINT     *73,FORM52
          ELSE
            PRINT     *71,FORM62
          ENDIF
          ADD       ONE,COUNT
.
B3TYP300  ADD       FORM62,TDBSAMNT
          GOTO      B3TYP100
.
B3TYP999  RETURN
+
+
.**********************************************************************
.*                            J3TYP000                                *
.*             Process Miscellaneous Records (ie. TRECTYPE = 3)       *
.**********************************************************************
J3TYP000  MOVE      ZERO,TRNFLAG
.
          IF        PINVSYS=3 | PINVSYS=2
            MOVE      ONE,CSTYPEF
            IF        PINVSYS=2
              PACK      KEY26 WITH PINVADM,PINVNO,ONE,SP30
            ELSE
              PACK      KEY26 WITH PINVADM,PINVNO,THREE,SP30
            ENDIF
          ELSE
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          MOVE      ONE,CSTYPEF
          MOVE      SP70,SAVGCOD
.
          CALL      RDSDTRAN
J3TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,J3TYP600               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      J3TYP600 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      J3TYP600 IF NOT EQUAL
.
          IF        PINVSYS<>1
            BRANCH    TRECTYPE,J3TYP600,J3TYP600,J3TYP200
            GOTO      J3TYP600
          ENDIF
.
J3TYP200  COMPARE   ZERO,TRNFLAG
          GOTO      J3TYP400 IF EQUAL              * first record
.
          MATCH     SP70,TMISGRP
          GOTO      J3TYP400 IF EQUAL
.
          MATCH     SAVGCOD,TMISGRP
          GOTO      J3TYP400 IF EQUAL
.
.         Display/Print total item for the group  
.
          MOVE      SP70,TDESC   
          MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSN,SAVGCOD,SP70   
            CALL      RDCODE1      
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TOTMISC,FORM7P2
          IF        INVTYPE=1
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *58,FORM7P2
          ELSE
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *71,FORM7P2
          ENDIF
          ADD       ONE,COUNT
          MOVE      ZERO,TOTMISC
.
J3TYP400  ADD       TPATAMTT,TOTAMNT
          ADD       PTDTGSTM,GSTAMNT
          MOVE      TMISGRP,SAVGCOD
          MOVE      TPATAMTT,FORM7P2
          ADD       TPATAMTT,TOTMISC
          MOVE      ONE,TRNFLAG
          BRANCH    INVTYPE,J3TYP100           * Summary invoice
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TPATAMTT,FORM7P2
          UNPACK    TDDESC,KEY25
          PACK      KEY10,TFDAY,SLASH,TFMONTH,SLASH,TFCENT,TFYEAR,SP70
          REP       " 0",KEY10
          PRINT     *3,TITEMNO:
                    *13,KEY10:
                    *26,KEY25,*52,TSERVS,*57,FORM7P2
          ADD       ONE,COUNT
          GOTO      J3TYP100
.
J3TYP600  COMPARE   ZERO,TRNFLAG
          GOTO      J3TYP700 IF EQUAL
.
          MOVE      SP70,TDESC
          MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSN,SAVGCOD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
.         Printing item group in bold
.
          MOVE      TOTMISC,FORM7P2
          IF        INVTYPE=1
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *58,FORM7P2    * Summary
          ELSE
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *71,FORM7P2    * Details
          ENDIF
          ADD       ONE,COUNT
.
J3TYP700  MOVE      TOTAMNT,FORM7P2
.
          MOVE      MAXLINE,FORM2
          SUB       TWO,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *N,*70,"----------":
                    *N,*3,"Total Hospital Charges",*70,FORM7P2
          ADD       THREE,COUNT
.
          CALL      PDISC000                * Print discount if any
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          IF        PINVSYS=3 | PINVSYS=2
            CALL      GGST0000                * Get GST amount
          ENDIF
          MOVE      GSTAMNT,FORM7P2
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          OPEN      IBAGSTA1,"ibagstaf"
          PACK      KEY6,PTCNAGST,SP70
          CALL      RDIBGS1
          IF        OVRCD=1
            MOVE      "Add GST                     ",IBGSDESC
          ENDIF
.
          PRINT     *3,"Add ",IBGSDESC,*70,FORM7P2:
                    *N,*70,"----------"
          ADD       TWO,COUNT
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TOTAMNT,FORM12P2
          SUB       ROUNDAMT,FORM12P2         * exclude rounding adjustment
          ADD       GSTAMNT,FORM12P2
          MOVE      FORM12P2,FORM7P2
          PRINT     *3,"TOTAL HOSPITAL BILL (INCLUSIVE OF GST)",*70,FORM7P2:
                    *N
          ADD       TWO,COUNT
          MOVE      ZERO,CSTYPEF
.
          CALL      PRTDR000                  * Print doctor charges
.
          MOVE      ROUNDAMT,FORM7P2
          IF        FORM7P2<>0
            COMPARE   MAXLINE,COUNT
            CALL      TAIL IF NOT LESS
            CALL      FROU0000                * Format rounding amount
.
            MOVE      ROUNDAMT,FORM7P2
            IF        FORM7P2<0
              PRINT     *3,"Rounding",*69,"(",KEY10,")"
            ELSE
              PRINT     *3,"Rounding",*70,KEY10
            ENDIF
            ADD       ONE,COUNT
          ENDIF
.
J3TYP999  RETURN
+
.**********************************************************************
.         format rounding amount
.**********************************************************************
FROU0000  UNPACK    SP70,KEY10,KEY7,KEY1,KEY2
.
          IF        FORM7P2<0
            MULT      "-1",FORM7P2
          ENDIF
.
          MOVE      FORM7P2,KEY10
          UNPACK    KEY10,KEY7,KEY1,KEY2
          MATCH     SP70,KEY7
          IF        @EQUAL
            MOVE      "      0",KEY7
          ENDIF
          PACK      KEY10,KEY7,KEY1,KEY2,SP70
.
FROU9999  RETURN
+
.**********************************************************************
.         Print procedures if any
.**********************************************************************
P8TYP000  COMPARE   NINE,PVITYPE
          GOTO      P8TYP025 IF NOT EQUAL
.
          MATCH     " 1",PVISYST             * check for Emergency event
          GOTO      P8TYP999 IF NOT EQUAL
.
          OPEN      PMSEVTA1,"pmsevtaf"
          MOVE      PINVADM,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,P8TYP999
.
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,P8TYP999
          MATCH     ANSE,TCINDC1
          GOTO      P8TYP999 IF NOT EQUAL    * Not an emergency event
.
          GOTO      P8TYP050
.
P8TYP025  COMPARE   ONE,PVITYPE
          GOTO      P8TYP999 IF NOT EQUAL
.
          OPEN      EMRVISA1,"emrvisaf"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,P8TYP999
.
P8TYP050  PACK      KEY22,PINVADM,PINVNO,SP70
          CALL      RDSDTRE1
P8TYP100  CALL      RDKDTRE1
          BRANCH    OVRCD,P8TYP999
.
          MATCH     PINVADM,ATNUMB           * Same admission?
          GOTO      P8TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,ATINVNO           * Same invoice?
          GOTO      P8TYP999 IF NOT EQUAL
.
          COMPARE   FIVE,ATRECTYP
          GOTO      P8TYP100 IF NOT EQUAL    * Not a procedure record
.
          CALL      PSJGR000
.
          ADD       ATPATAMT,GROSSTOT
          ADD       ATDTGSTM,GROSSTOT
          GOTO      P8TYP100
.
P8TYP999  RETURN
+
.**********************************************************************
.         Get GST amount exclude Doctor charges
.**********************************************************************
GGST0000  MOVE      PTINGSTA,GSTAMNT       * GST amount for the invoice
.
.         Get total GST for doctor charges for Inpatient
.
          COMPARE   THREE,PINVSYS
          GOTO      GGST9999 IF NOT EQUAL  * No doctor charges for outpatient
.
          MOVE      "4",KEY1               * record type for doctor charges
          PACK      KEY26 WITH PINVADM,PINVNO,KEY1,SP30
          CALL      RDSDTRAN
GGST4000  CALL      RDKDTRAN
          BRANCH    OVRCD,GGST9999
.
          MATCH     PINVADM,TADMNO
          GOTO      GGST9999 IF NOT EQUAL  * different admission number
          MATCH     PINVNO,TREF
          GOTO      GGST9999 IF NOT EQUAL  * different invoice number
          MOVE      KEY1,FORM1
          COMPARE   FORM1,TRECTYPE
          GOTO      GGST9999 IF NOT EQUAL
.
          SUB       PTDTGSTM,GSTAMNT       * Doctor charges GST for the invoice
          GOTO      GGST4000
.
GGST9999  RETURN
+
.********************************************************************** 
.         Print Discount
.********************************************************************** 
PDISC000  BRANCH    PINVSYS,PDISC999      * Emergency don't have discount
.
          MOVE      ZERO,ROUNDAMT
          MOVE      ZERO,FORM1
          MOVE      ONE,CSTYPEF
          IF        PVITYPE=2
            PACK      KEY26 WITH PINVADM,PINVNO,FIVE,SP30
          ELSE
            PACK      KEY26 WITH PINVADM,PINVNO,SEVEN,SP30
          ENDIF
          CALL      RDSDTRAN
PDISC100  CALL      RDKDTRAN
          BRANCH    OVRCD OF PDISC999
.
          MATCH     PINVADM,TADMNO
          GOTO      PDISC999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF
          GOTO      PDISC999 IF NOT EQUAL
.
          COMPARE   SEVEN,TRECTYPE
          GOTO      PDISC999 IF NOT EQUAL
.
          ADD       TPATAMTT,TOTAMNT
.
          MATCH     TMISGRP,PTCNROUN       * skip Rounding adjustment
          IF        @EQUAL
            ADD       TPATAMTT,ROUNDAMT
            GOTO      PDISC100
          ENDIF
          ADD       TPATAMTT,TOTDISC
          ADD       PTDTGSTM,GSTAMNT
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
.         MOVE      "Discount",TDESC
.         PACK      KEY5,ANSF,ANSI,TMISGRP,SP70
.         CALL      RDCODE1
.
          MOVE      TPATAMTT,FORM7P2
          PRINT     *3,TDDESC,*70,FORM7P2    * Details
          ADD       ONE,COUNT
          GOTO      PDISC100
.
PDISC999  RETURN
+
.********************************************************************** 
.         Print doctor charges
.********************************************************************** 
PRTDR000  COMPARE   THREE,PINVSYS
          GOTO      PRTDR999 IF NOT EQUAL  * Only inpatients have doctor charges
.
          MOVE      ZERO,TRNFLAG
          MOVE      SP70,SAVADOC
          MOVE      ZERO,LUMPAT
          MOVE      ZERO,MISCTOT
          MOVE      ONE,CSTYPEF
          PACK      KEY26 WITH PINVADM,PINVNO,FOUR,SP30
          CALL      RDSDTRAN
PRTDR100  CALL      RDKDTRAN
          BRANCH    OVRCD OF PRTDR600
.
          MATCH     DPINVADM,DTADMNO
          GOTO      PRTDR600 IF NOT EQUAL
          MATCH     PINVNO,TREF
          GOTO      PRTDR600 IF NOT EQUAL
.
          IF        TRNFLAG=0
            COMPARE   MAXLINE,COUNT
            CALL      TAIL IF NOT LESS
            PRINT     *3,"DOCTOR CHARGES WITH GST"
            ADD       ONE,COUNT
            MOVE      ONE,TRNFLAG
          ENDIF
.
          COMPARE   FOUR,TRECTYPE
          GOTO      PRTDR600 IF NOT EQUAL
.
          MATCH     SP70,SAVADOC
          GOTO      PRTDR400 IF EQUAL       * first record
.
          MATCH     SAVADOC,TDOCTA
          GOTO      PRTDR400 IF EQUAL
.
          CALL      DRTOT0000                  * Print doctor charges
.
PRTDR400  ADD       TPATAMTT,TOTAMNT
          ADD       PTDTGSTM,TOTAMNT
          ADD       TPATAMTT,MISCTOT
          ADD       PTDTGSTM,MISCTOT
          ADD       TPATAMTT,LUMPAT
          ADD       PTDTGSTM,LUMPAT
          MOVE      TDOCTA,SAVADOC
.
          BRANCH    INVTYPE,PRTDR100            * Summary invoice
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSF,ANSI,TMISGRP,SP70
          CALL      RDCODE1
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          MOVE      TPATAMTT,FORM7P2
          ADD       PTDTGSTM,FORM7P2
          PRINT     *3,TDDESC,*33,"(",CPCDATE,")",*57,FORM7P2
          ADD       ONE,COUNT
          GOTO      PRTDR100
.
PRTDR600  MATCH     SP70,SAVADOC
          GOTO      PRTDR900 IF EQUAL
          CALL      DRTOT0000                  * Print doctor charges
.
PRTDR900  MOVE      LUMPAT,FORM7P2
          COMPARE   ZERO,TRNFLAG
          GOTO      PRTDR999 IF EQUAL          * No doctor charges
.
          MOVE      MAXLINE,FORM2
          SUB       TWO,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *N,*70,"----------":
                    *N,*3,"Total Doctor Charges",*70,FORM7P2
          ADD       THREE,COUNT
PRTDR999  RETURN
+
.********************************************************************** 
.         Print total item for the group
.********************************************************************** 
DRTOT000  MOVE      SP70,PACFNAME
          OPEN      PATDO1A1,"patdo1af"
          PACK      KEY6,SAVADOC
          CALL      RDDOCT1
          IF        OVRCD<>1
           MOVE      DSNAME,PACSNAME
           MOVE      DGNAME,PACGNAME
           MOVE      DTITL,PACTITLE
           MOVE      ONE,PACFRMT
           CALL      PACNAME
          ENDIF
.
          MOVE      SP70,KEY54
          CLEAR     KEY54
          APPEND    "Total Chargeable by ",KEY54
          APPEND    PACFNAME,KEY54
          APPEND    SP70,KEY54
          RESET     KEY54
.
          MOVE      MISCTOT,FORM7P2
.
.         Print total doctor charges
.
          MOVE      MAXLINE,FORM2
          SUB       "3",FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          IF        INVTYPE=2
            PRINT     *57,"----------";
          ENDIF
.
          PRINT     *N,*3,KEY54:
                    *57,FORM7P2:
                    *N,*57,"----------"
          ADD       THREE,COUNT
          MOVE      SP70,SAVADOC
          MOVE      ZERO,MISCTOT
.
DRTOT999  RETURN
+
.********************************************************************** 
.*                            P5TYP000                                *
.*             Process Cash Receipt Records (ie. TRECTYPE = 5)        *
.********************************************************************** 
P5TYP000  OPEN      RCPBDTA1,"rcpbdtaf"
          IF        DBSFLAG=1
            MOVE      ZERO,PAYMTTOT
            PACK      KEY12,SP4,PINVNO
            CALL      CSHP0000                * Display cash pending if any
            CALL      B5TYP000
            GOTO      P5TYP999
          ENDIF
.
          IF        PTCNINVL=22
            CALL      J5TYP000            * Print Johns Hopkins/SX cash
            GOTO      P5TYP999
          ENDIF
.
          IF        PTCNINVL=23
            CALL      S5TYP000            * Print SX cash
            GOTO      P5TYP999
          ENDIF
.
          CALL      PRCAS000              * Processing Cash
P5TYP999  RETURN
+
.********************************************************************** 
.         Processing Cash
.********************************************************************** 
PRCAS000  OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPCRSA1,"rcpcrsaf"
          MOVE      ONE,CASHFLAG
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,FIVE,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,TWO,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
PRCAS100  CALL      RDKDTRAN
          BRANCH    OVRCD,PRCAS990               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      PRCAS990 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      PRCAS990 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   FIVE,TRECTYPE                * Check for a Cash Receipt
            GOTO      PRCAS100 IF NOT EQUAL
          ELSE
            COMPARE   FIVE,TRECTYPE                * Check for a Cash Receipt
            GOTO      PRCAS990 IF NOT EQUAL
          ENDIF
.
          COMPARE   ZERO,TREBATE
          GOTO      PRCAS200 IF EQUAL
          MOVE      ONE,NOHIPAYM
.
PRCAS200  ADD       TREBATE,REBTOT
.
          COMPARE   ZERO,TPATAMTT
          GOTO      PRCAS100 IF EQUAL
.
          MATCH     ANSH,TTYPEDEB
          GOTO      PRCAS300 IF NOT EQUAL
          ADD       TPATAMTT,TOTHEALTH
.
PRCAS300  COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TDDESC,DIM25
          MOVE      TTYPEDEB,KEY1
          MOVE      TDEPTYP,KEY3
          UNPACK    TDCODE,KEY6             * Health Fund or Insurance code
          IF        PINVSYS=1|PINVSYS=2
            PACK      KEY12,TRECEIPT,SP70
            CALL      RDRCBNK1
            IF        OVRCD<>1
              MOVE      ANSP,KEY1
              MOVE      RCBNTTYP,F1
              LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
              UNPACK    RCBNRCOD,KEY6           * Health Fund or Insurance code
            ENDIF
          ENDIF

          CALL      PAYD0000                * Get payment desc.
          MOVE      KEY25,DIM25
.
          MOVE      DIM25,DIM21
          MOVE      DIM25,TDDESC
          MOVE      "Payment ",DIM8
.
          MOVE      SP6,DIM6
          LOAD      DIM6 FROM TPAYTYPE OF CASH,CHEQUE,CREDIT,MERCH,MONEY
          PACK      DIM14,DIM6,SP70
.
          MOVE      ZERO,CHGC
          PACK      RCDTRECN,TRECEIPT,SP70
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     RCDTRECN,RCBDRECN
            IF        @EQUAL
              MOVE      ONE,CHGC
              MOVE      ZERO,F1
              MOVE      RCBDPTYP,F1
              MOVE      F1,F2
              CALL      CSHDS000                * Get payment type desc.
              PACK      DIM6,DIM14,SP70
              IF        F2=2
                MOVE      RCBDDRAW,RCBDPAYD     * Chq -use the drawer as payee
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ZERO,CHGC
          GOTO      PRCAS600 IF EQUAL         * print total receipt amt only
.
.         Check if total receipts from all payments equals to Patient receipt
.
          MOVE      SP70,DEFINDIC
          PACK      DIM12,SP4,TREF       * save invoice number
          MOVE      TRECEIPT,DIM12A      * save receipt number
          CALL      CHKAM000
          BRANCH    EXIT,PRCAS700      * printed all payments details of receipt
.
.         Print total amount of receipt
.
PRCAS600  PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      TPATAMTT,LNTOTAL
          MOVE      SP70,DEFINDIC
          MOVE      FOUR,RECFLAG
          MOVE      ZERO,PLINFLAG
          CALL      PRLN0000              * Print cash details
.
PRCAS700  ADD       TPATAMTT,PAYMTTOT
          MOVE      ZERO,CASHFLAG           * A Cash Record has been Printed
          GOTO      PRCAS100
.
PRCAS990  PACK      KEY12,SP4,PINVNO
          CALL      CSHP0000                * Display cash pending if any
PRCAS999  RETURN
+
.*****************************************************************************
.         Released cash
.         Check if total payment of receipt (rcpbdtaf) equals to amt (patdtraf)
.*****************************************************************************
CHKAM000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM12P2
          PACK      KEY15,DIM12A,SP70
          CALL      RSRCBDT1
CHKAM100  CALL      RKRCBDT1
          BRANCH    OVRCD,CHKAM800
.
          MATCH     DIM12A,RCBDRECN
          GOTO      CHKAM800 IF NOT EQUAL   * different receipt number
.
          PACK      KEY15,RCBDRECN,RCBDUNIQ,SP70
          CALL      RDRCCRS1
          IF        OVRCD=1
            MOVE      ZERO,RCCRSAMN         * Surcharge amount
          ENDIF
          SUB       RCCRSAMN,RCBDPAMT
          ADD       RCBDPAMT,FORM12P2
          GOTO      CHKAM100
.
CHKAM800  MULT      "-1",FORM12P2
          COMPARE   FORM12P2,TPATAMTT
          GOTO      CHKAM900 IF NOT EQUAL
.
          CALL      PDET0000             * print payments details
          MOVE      ONE,EXIT
.
CHKAM900  PACK      KEY15,DIM12A,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     DIM12A,RCBDRECN
            IF        @EQUAL
              MOVE      ZERO,F1
              MOVE      RCBDPTYP,F1
              MOVE      F1,F2
              CALL      CSHDS000                * Get payment type desc.
              IF        F2=2
                MOVE      RCBDDRAW,RCBDPAYD     * use the drawer as payee
              ENDIF
.
              ENDSET    DIM14
              APPEND    DEFINDIC,DIM14
              APPEND    SP70,DIM14
              RESET     DIM14
.
              GOTO      CHKAM999
            ENDIF
          ENDIF
          MOVE      SP70,RCBDPAYD
          MOVE      SP70,RCBDDRAW
.
CHKAM999  RETURN
+
.**********************************************************************
.         Print payments details
.**********************************************************************
PDET0000  MOVE      ZERO,FORM2
          PACK      KEY15,DIM12A,SP70
          CALL      RDRCBDT1
PDET1000  CALL      RKRCBDT1
          BRANCH    OVRCD OF PDET9999
.
          MATCH     RCBDRECN,DIM12A
          GOTO      PDET9999 IF NOT EQUAL        * different receipt
.
          PACK      KEY15,RCBDRECN,RCBDUNIQ,SP70
          CALL      RDRCCRS1
          IF        OVRCD=1
            MOVE      ZERO,RCCRSAMN         * Surcharge amount
          ENDIF
          SUB       RCCRSAMN,RCBDPAMT
          MULT      "-1",RCBDPAMT
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          CALL      CSHDS000                * Get payment type desc.
          PACK      DIM6,DIM14,SP70
          IF        F2=2
            MOVE      RCBDDRAW,RCBDPAYD     * cheque - use the drawer as payee
          ENDIF
.
          BRANCH    FORM2,PDET2000
.
          MOVE      ONE,FORM2
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      RCBDPAMT,LNTOTAL
          MOVE      KEY25,TDDESC
          MOVE      RCBDRECN,TRECEIPT
          MOVE      FOUR,RECFLAG
          MOVE      ZERO,PLINFLAG
          CALL      PRLN0000              * Print cash details
          GOTO      PDET1000
.
.         Print next payment
.
PDET2000  MOVE      SP70,DFDATE
          MOVE      SP70,DIM25
          MOVE      SP70,TDDESC
          MOVE      SP70,TRECEIPT
          MOVE      RCBDPAMT,LNTOTAL
          MOVE      SP70,DEFINDIC
          CALL      PRLN0000              * Print cash details
          GOTO      PDET1000
.
PDET9999  RETURN
+
.**********************************************************************
.*                            B5TYP000                                *
.*     Process Cash Receipt Records (ie. TRECTYPE = 5) Discharge Bill.*
.**********************************************************************
B5TYP000  PACK      KEY23 WITH PINVADM,PINVNO,FIVE,SP30
          CALL      RDSDTRN4
B5TYP100  CALL      RDKDTRN4
          BRANCH    OVRCD,B5TYP999               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      B5TYP999 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      B5TYP999 IF NOT EQUAL
.
          COMPARE   FIVE,TRECTYPE                * Check for a Cash Receipt
          GOTO      B5TYP999 IF NOT EQUAL
.
          MATCH     SP70,TDEPTYP
          GOTO      B5TYP200 IF NOT EQUAL        * Deposit
.
          MATCH     ANSP,TTYPEDEB
          GOTO      B5TYP100 IF NOT EQUAL
.
          MOVE      "FROM PATIENT",TDESC
          GOTO      B5TYP300
.
B5TYP200  PACK      KEY5,ANSD,ANSP,TDEPTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            CLEAR     TDESC
            APPEND    "Invalid Deposit Type",TDESC
            APPEND    TDEPTYP,TDESC
            APPEND    SP70,TDESC
            RESET     TDESC
          ENDIF
.
B5TYP300  CLEAR     KEY45
          APPEND    TDESC,KEY45
          APPEND    " RECEIPT ## ",KEY45
          APPEND    TRECEIPT,KEY45
          APPEND    SP70,KEY45
          RESET     KEY45
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          ADD       TPATAMTT,PAYMTTOT
          MOVE      TPATAMTT,FORM62
          IF        PTCNINVL=25
            MOVE      FORM62,FORM52
            PRINT     *19,KEY45:
                      *73,FORM52
          ELSE
            PRINT     *23,KEY45:
                      *71,FORM62
          ENDIF
          ADD       ONE,COUNT
          GOTO      B5TYP100
.
B5TYP999  RETURN
+
.**********************************************************************
.*                            J5TYP000                                *
.*             Process Cash Receipt Records (ie. TRECTYPE = 5)        *
.**********************************************************************
J5TYP000  MOVE      ZERO,PAYMTTOT
          MOVE      ZERO,TRNFLAG
          IF        PINVSYS=3 | PINVSYS=2
            MOVE      ONE,CSTYPEF
            IF        PINVSYS=2
              PACK      KEY26 WITH PINVADM,PINVNO,TWO,SP30
            ELSE
              PACK      KEY26 WITH PINVADM,PINVNO,FIVE,SP30
            ENDIF
          ELSE
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
J5TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,J5TYP200               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      J5TYP200 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      J5TYP200 IF NOT EQUAL
.
          IF        PINVSYS=3 | PINVSYS=2
            COMPARE   FIVE,TRECTYPE                * Check for a Cash Receipt
            GOTO      J5TYP200 IF NOT EQUAL
          ELSE
            COMPARE   FIVE,TRECTYPE                * Check for a Cash Receipt
            GOTO      J5TYP100 IF NOT EQUAL
          ENDIF
.
          ADD       TPATAMTT,PAYMTTOT
          MOVE      ZERO,CASHFLAG
.         BRANCH    INVTYPE,J5TYP100               * Summary invoice
.
          IF        TRNFLAG=0
            COMPARE   MAXLINE,COUNT                * Check for room on Page
            CALL      TAIL IF NOT LESS
            PRINT     *1,"LESS PAYMENT"
            ADD       ONE,COUNT
            ADD       ONE,TRNFLAG
          ENDIF
.
          COMPARE   MAXLINE,COUNT                * Check for room on Page
          CALL      TAIL IF NOT LESS
.
          MOVE      TDDESC,DIM25
          MOVE      TPATAMTT,FORM7P2
          PRINT     *3,DIM25,*28,TRECEIPT,*57,FORM7P2
          ADD       ONE,COUNT
          GOTO      J5TYP100
.
J5TYP200  PACK      KEY12,SP4,PINVNO
          CALL      CSHP0000                * Display cash pending if any
.
          BRANCH    CASHFLAG,J5TYP900
.
          MOVE      PAYMTTOT,FORM7P2
          ADD       CASHTOT,FORM7P2
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *57,"----------":
                    *N,*3,"Total Payments",*70,FORM7P2
          ADD       TWO,COUNT
.
J5TYP900  MOVE      ZERO,CSTYPEF
J5TYP999  RETURN
+
.********************************************************************** 
.*                            P6TYP000                                *
.*                Process Journal Records (ie. TRECTYPE = 6)          *
.********************************************************************** 
P6TYP000  IF        PTCNINVL=22
            CALL      J6TYP000            * Johns Hopkins/SX print Journals
            GOTO      P6TYP999
          ENDIF
.
          IF        PTCNINVL=23
            CALL      S6TYP000            * SX print Journals
            GOTO      P6TYP999
          ENDIF
.
          CALL      PRJRN000              * Processing journals
.
P6TYP999  RETURN
+
.
.********************************************************************** 
.         Processing journals
.********************************************************************** 
PRJRN000  MOVE      ONE,JOURFLAG
.
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,SIX,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,THREE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
PRJRN100  CALL      RDKDTRAN
          BRANCH    OVRCD,PRJRN990               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      PRJRN990 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      PRJRN990 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      PRJRN100 IF NOT EQUAL
          ELSE
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      PRJRN990 IF NOT EQUAL
          ENDIF
.
          IF        DBSFLAG=1
            PACK      KEY5,ANSJ,SP1,TTYPE
            CALL      RDCODE1
            IF        OVRCD=1
              GOTO      PRJRN100
            ELSE
              MATCH     "P",TCINDC8
              IF        !@EQUAL
                GOTO      PRJRN100
              ENDIF
            ENDIF
          ENDIF
.          
          ADD       TREBATE,REBTOT               * Add Rebate Total
.
          IF        IBCNUGST=2
            ADD       PTDTGSTM,TPATAMTT
          ENDIF
.
          COMPARE   ZERO,TPATAMTT                * Ignore if Zero Total
          GOTO      PRJRN100 IF EQUAL
.
          MOVE      "Journal ",DIM8              * Set Up Description
          MOVE      TDDESC,DIM25
.
          MATCH     TTYPE,HJNL
          IF        @EQUAL
            MOVE      "Discount from Receipt",DIM25
            MOVE      "Discount from Receipt",TDDESC
          ENDIF
.
          MOVE      SP6,DIM6                     * Clear Print Variable
          COMPARE   ZERO,PTCNPJCI                * Check Parameter for Printing
          GOTO      PRJRN200 IF EQUAL
          MOVE      "JNL ",DIM4                  * Pack Print Variable
          PACK      DIM6,DIM4,TTYPE
.
PRJRN200  MOVE      TPATAMTT,LNTOTAL
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      SP70,DTDATE
          MOVE      FIVE,RECFLAG            * flag to print journal
          MOVE      ZERO,PLINFLAG
          CALL      PRLN0000                      * Print journals
.
          ADD       TPATAMTT,JOURTOT
          MOVE      ZERO,JOURFLAG           * Flag that Journals Printed
          GOTO      PRJRN100
.
PRJRN990  BRANCH    JOURFLAG,PRJRN999       * Check if Jouranls were Printed
          MOVE      JOURTOT,LNTOTAL
          MOVE      FIVE,RECFLAG            * flag to print journal
          MOVE      ONE,PLINFLAG
          CALL      PRLN0000                * Print journals total
          MOVE      ZERO,PLINFLAG
          IF        DBSFLAG=1
            ADD       LNTOTAL,TDBSAMNT
          ENDIF
.
PRJRN999  RETURN
+
.**********************************************************************
.*                            J6TYP000                                *
.*                Process Journal Records (ie. TRECTYPE = 6)          *
.**********************************************************************
J6TYP000  MOVE      ZERO,JOURTOT
          MOVE      ZERO,TRNFLAG
          IF        PINVSYS = 3
            PACK      KEY23 WITH PINVADM,PINVNO,SIX,SP30
          ELSE
            PACK      KEY31 WITH PINVADM,PINVNO,THREE,SP30
            PACK      KEY22 WITH PINVADM,PINVNO,SP30
          ENDIF
.
          CALL      RDSDTRAN
J6TYP100  CALL      RDKDTRAN
          BRANCH    OVRCD,J6TYP600               * Check for end of File
.
          MATCH     PINVADM,TADMNO
          GOTO      J6TYP600 IF NOT EQUAL
.
          MATCH     PINVNO,TREF                  * Check if Same Invoice
          GOTO      J6TYP600 IF NOT EQUAL
.
          IF        PINVSYS<>3
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      J6TYP100 IF NOT EQUAL
          ELSE
            COMPARE   SIX,TRECTYPE                 * Check for a Journal
            GOTO      J6TYP600 IF NOT EQUAL
          ENDIF
.
          ADD       PTDTGSTM,TPATAMTT
.
          BRANCH    INVTYPE,J6TYP400               * Summary invoice
.
          IF        TRNFLAG=0
            PRINT     *N;
            ADD       ONE,COUNT
          ENDIF
          MATCH     TTYPE,HJNL
          IF        @EQUAL
            MOVE      SP70,TDDESC
            MOVE      "Discount from Receipt",TDDESC
          ENDIF
          MOVE      TPATAMTT,FORM7P2
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *3,TDDESC,*57,FORM7P2
          ADD       ONE,COUNT
.
J6TYP400  ADD       TPATAMTT,JOURTOT
          MOVE      ONE,TRNFLAG
          GOTO      J6TYP100
.
J6TYP600  COMPARE   ZERO,TRNFLAG
          GOTO      J6TYP999 IF EQUAL              * No journals
          MOVE      JOURTOT,FORM7P2
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *3,"Total Journals",*70,FORM7P2
          ADD       ONE,COUNT
.
J6TYP999  RETURN
+
.********************************************************************** 
.*                            PITOT000                                *
.*                      Print the Invoice Total                       *
.********************************************************************** 
PITOT000  MOVE      "Invoice Total     ",IVTOTDES
          IF        CRDNFLAG=1
            MOVE      "Credit Note Total ",IVTOTDES
          ENDIF
.
          MOVE      GROSSTOT,XGROSTOT
          MOVE      TOTGST,XTOTGST
.
          MOVE      THREE,RECFLAG
          CALL      PRLN0000                     * Print Invoice total
.
          MOVE      GROSSTOT,XGROSTOT
          MOVE      TOTGST,XTOTGST
          MOVE      GROSSTOT,INVCTOTL            * for tail template
          IF        IBCNUGST=2
            ADD       TOTGST,INVCTOTL
          ENDIF
.
PITOT999  RETURN
+
.********************************************************************** 
.*                            PRCRD000                                *
.*                     Print the Reason for credit note               *
.********************************************************************** 
PRCRD000  MATCH     SP3,PMCNREAS
          GOTO      PRCRD999 IF EQUAL     * No reason for credit note
          MOVE      "BX",TCODE
          PACK      KEY5,TCODE,PMCNREAS
          CALL      RDCODE1
          BRANCH    OVRCD,PRCRD999
          PACK      KEY18,TDESC,SP20
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT               * Check For A Full Page
          CALL      TAIL IF NOT LESS
          PRINT     *N,*25,"REASON:",KEY18
          ADD       TWO,COUNT
PRCRD999  RETURN
.
.********************************************************************** 
.*                            JHEND000                                *
.*                     Print End of the Invoice - Johns Hopkins       *
.********************************************************************** 
JHEND000  MOVE      TOTAMNT,GROSSTOT
          ADD       GSTAMNT,GROSSTOT
.
          MOVE      GROSSTOT,NETTOT
          ADD       PAYMTTOT,NETTOT
          ADD       CASHTOT,NETTOT
          ADD       JOURTOT,NETTOT
          ADD       CREDTOT,NETTOT
          MOVE      NETTOT,FORM7P2
.
          MOVE      MAXLINE,FORM2
          SUB       "4",FORM2
          COMPARE   FORM2,COUNT               * Check For A Full Page
          CALL      TAIL IF NOT LESS
          PRINT     *70,"----------":
                    *N,*3,"BALANCE PAYABLE",*70,FORM7P2:
                    *N,*70,"==========":
              *N,*N,*3,"P L E A S E  P A Y  T H I S  A M O U N T",*70,FORM7P2
          ADD       FIVE,COUNT
.
          PACK      KEY19,AADMNO,PINVNO,SP70
          CALL      PRTIPROV                 * Print insurance provider
.
          WHILE     COUNT<MAXLINE
            PRINT     *N;
            ADD       ONE,COUNT
          DO
          CALL      SINVT000                     * set up for templating
          CALL      PRTINVTL                     * print templated invoice tail
.
          COMPARE   FORM3,IBTHLENG           * check if last line is same as
          GOTO      JHEND999 IF EQUAL        * page length
          PRINT     *N;
.
JHEND999  RETURN
+
.********************************************************************** 
.*                            PENDI000                                *
.*                     Print End of the Invoice                       *
.********************************************************************** 
PENDI000  COMPARE   "22",PTCNINVL
          GOTO      PENDI999 IF EQUAL       * Johns Hopkins invoice layout
          COMPARE   "23",PTCNINVL
          GOTO      PENDI999 IF EQUAL       * Southern Cross invoice layout
.
.         When printing credit note, the reason for credit note will be 
.         printed instead
.
          IF        CRDNFLAG=1
            CALL      PRCRD000                * Print reason for credit note
          ELSE
            CALL      DREBT000                * Display & print balance payable
          ENDIF
.
          IF        PTCNINVL=24 | PTCNINVL=25
            MOVE      GROSSTOT,NETTOT
            ADD       PAYMTTOT,NETTOT
            ADD       CASHTOT,NETTOT
            ADD       JOURTOT,NETTOT
            ADD       CREDTOT,NETTOT
            ADD       TOTGST,NETTOT
            MOVE       FOUR,RECFLAG
            MOVE       TWO,PLINFLAG
            CALL       PRLN0000             * Print balance payable
            MOVE       ZERO,PLINFLAG
          ENDIF
.
          LOAD      ACLAIM,PVITYPE,EMVICOMP,OBACOMP
          CALL      CLAIM000                * Print Claim Details
.
          MATCH     "W",RECCD               * WC
          GOTO      PENDI100 IF EQUAL
          MATCH     "M",RECCD               * TAC ?
          GOTO      PENDI120 IF NOT EQUAL
.
PENDI100  PROC      PRNTICDC                 * Print ICD10 Codes
.
PENDI120  COMPARE   "18",PTCNINVL
          GOTO      PENDI300 IF NOT EQUAL
.
          BRANCH    PVITYPE,PENDI220      * Emergency
          IF        PVITYPE=9
            MATCH     " 1",PVISYST
            GOTO      PENDI220 IF EQUAL   * Event
          ENDIF
          GOTO      PENDI300
.
PENDI220  CALL      PRAD0000              * Print Attending doctor
          PROC      PRBIL000              * Print Billing Comment
.
PENDI300  CALL      TROFF000              * Print Tear Off Section
PENDI999  RETURN
+
. *****************************************************************************
.         Print Emergency Attending doctor
. *****************************************************************************
PRAD0000  OPEN      PMSHCPA1,"pmshcpaf"
          UNPACK    SP70,KEY25,PMHCPRV1
          PACK      KEY10,SERVDOCT,SP70
.
          MATCH     "1",EMCNGINV            * Group invoice by Service Doctor
          GOTO      PRAD2000 IF EQUAL
.
          BRANCH    PVITYPE,PRAD1000      * Emergency
.
.         must be an Event visit
.
          OPEN      PMSEVTA1,"pmsevtaf"
          MOVE      PINVADM,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,PRAD9999
          PACK      KEY10,PMEVACON,SP70
          GOTO      PRAD2000
.
PRAD1000  OPEN      EMRVISA1,"emrvisaf"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,PRAD9999
          PACK      KEY10,EMVIDOCT,SP70
.
PRAD2000  CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            PACK      KEY25,DOCFNAME
          ENDIF
.
          MOVE      MAXLINE,FORM2
          SUB       "1",FORM2
          COMPARE   FORM2,COUNT               * Check For A Full Page
          CALL      TAIL IF NOT LESS
.
          PRINT    *N,*1,"Attending Doctor:",KEY25:
                   *44,"Provider Number:",PMHCPRV1
          ADD      TWO,COUNT
PRAD9999  RETURN
+
.********************************************************************** 
.*                            CLAIM000                                *
.*                      Print Claim Details                           *
.********************************************************************** 
CLAIM000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND05;*189,PTCNPRCL    * print claim code 
.
          MOVE      SP70,ANS
          MOVE      SP70,RECCD
          UNPACK    SP5 WITH TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      "CL",TCODE
          PACK      KEY5 WITH TCODE,ACLAIM
          CALL      RDCODE1
.
          MOVE      ZERO,FORM2
CLAIM100  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CLAIM999 IF NOT LESS
.
          MOVE      PINVADM,KEY8
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          MATCH     "W",ANS
          GOTO      CLAIM200 IF NOT EQUAL
.
          MOVE      ANS,RECCD                  * WC
          IF        PTCNPRCL=1
            CALL      WCOMP000
          ENDIF
          GOTO      CLAIM999
.
CLAIM200  MATCH     "M",ANS
          GOTO      CLAIM300 IF NOT EQUAL
.
          MOVE      ANS,RECCD                  * TAC
          IF        PTCNPRCL=1
            CALL      MTACC000
          ENDIF
          GOTO      CLAIM999
.
CLAIM300  MATCH     "V",ANS
          GOTO      CLAIM400 IF NOT EQUAL
.
          MOVE      ANS,RECCD                  * Veteran
          IF        PTCNPRCL=1
            CALL      VTAFF000
          ENDIF
.
CLAIM400  MATCH     "D",ANS
          GOTO      CLAIM100 IF NOT EQUAL
.
          MOVE      ANS,RECCD                  * Defence force
          IF        PTCNPRCL=1
            CALL      DFORC000                 * Defence force
          ENDIF
.
CLAIM999  RETURN
+
.********************************************************************** 
.*                            TROFF000                                *
.*                  Print Tear Off Section of Invoice                 *
.********************************************************************** 
TROFF000  
          ADD       JOURTOT,GROSSTOT        * instead of adding to PAYMTTOT
          MOVE      GROSSTOT,NETTOT
          ADD       PAYMTTOT,NETTOT
          ADD       JOURTOT,NETTOT
          ADD       CREDTOT,NETTOT
          ADD       CASHTOT,NETTOT
.
          MOVE      CASHTOT,CSAMT
          MULT      "-1",CSAMT
.
          IF        IBCNUGST=2
            ADD       TOTGST,NETTOT
          ENDIF
.
          MOVE      "- " TO SEPCHAR2
          MOVE      CNAME TO DIM30
          MOVE      CHPADD2 TO DIM20
          MOVE      CHPPOST TO DIM4
.
          MOVE      SP30 TO DIM30
          MOVE      SP30 TO CHPADD1
          MOVE      SP20 TO DIM20
          MOVE      SP4 TO DIM4
          MOVE      SP2 TO SEPCHAR2
          MOVE      SP6,DMEMB
          IF        CMEMB=1
            LOAD      DMEMB USING AMEMB OF MEMBER
           ENDIF
          CALL      NTAIL000                 * Print Normal Tail
.
TROFF999  RETURN
+
.********************************************************************** 
.*                            RDSDT000                                *
.*                  Position on Next Dtra Record                      *
.********************************************************************** 
RDSDTRAN  BRANCH     CRDNFLAG,RDSDT400       * Credit note
          BRANCH     PINVSYS OF RDSDT300,RDSDT200,RDSDT100,RDSDT200
.
RDSDT100  IF         CSTYPEF=1
            CALL       RDSDTRN6
          ELSE
            CALL       RDSDTRN4
          ENDIF
          GOTO       RDSDT999
.
RDSDT200  IF         CSTYPEF=1
            CALL       RDSDTRO5
          ELSE
            CALL       RDSDTRO1
          ENDIF
          GOTO       RDSDT999
.
RDSDT300  CALL       RDSDTRE1
          GOTO       RDSDT999
.
.         Printing Credit Notes
.
RDSDT400  OPEN       PMSFCIA3,"pmsfciaf"
          PACK       KEY31,PMCNCRNO,PMCNVISN,PMCNINVN,KEY1,SP70
          CALL       RSPMFCI3 
          MOVE       PMCNCRNO,PINVNO
          GOTO       RDSDT999
.
RDSDT999  RETURN
+
.********************************************************************** 
.*                            RDKDT000                                *
.*                      Get Next Dtra Record                          *
.********************************************************************** 
RDKDTRAN  BRANCH     CRDNFLAG,RDKDT400       * Credit note
          BRANCH     PINVSYS OF RDKDT300,RDKDT200,RDKDT100,RDKDT200
.
RDKDT100  IF         CSTYPEF=1
            CALL       RDKDTRN6
          ELSE
            CALL       RDKDTRN4
          ENDIF
          GOTO       RDKDT999
.
RDKDT200  IF         CSTYPEF=1
            CALL       RDKDTRO5
          ELSE
            CALL       RDKDTRO1
          ENDIF
          BRANCH     OVRCD OF RDKDT999
.
          MOVE       OTNUMB,TADMNO
          MOVE       OTTRANS,TTRANSN1
          MOVE       OTINVNO,TREF
          MOVE       OTDDESC,TDDESC
          MOVE       OTPATAMT,TPATAMTT
          MOVE       OTDTGSTM,PTDTGSTM
          MOVE       OTITEMNO,TITEMNO
          MOVE       OTMISGRP,TMISGRP
          UNPACK     OTBATCHN,TBATCHN
          MOVE       OTDEPTYP,TDEPTYP
.
          UNPACK     OTDDATE WITH XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,TFDAY
          MOVE       XMON,TFMONTH
          MOVE       XYEAR,TFYEAR
          MOVE       XCENT,TFCENT
.
          MOVE       OTRECEPT,TRECEIPT
          MOVE       OTTYPE,TTYPE
          MOVE       OTPAYTYP,TPAYTYPE
          MOVE       ZERO,TRECTYPE
          LOAD       TRECTYPE USING OTRECTYP OF THREE,FIVE,SIX,FOUR,SEVEN,TWO
          IF         OTRECTYP=7
            MOVE       "9",TRECTYPE           * ABF Record type
          ENDIF
          MOVE       OTREBPOR,TREBATE
          MOVE       OTPATPOR,TPATAMTP
          MOVE       OTREBPOR,TPATAMTI
          ADD        OTPATPOR,TPATAMTI
          MOVE       OTSERVS,TSERVS
          GOTO       RDKDT999
.
RDKDT300  CALL       RDKDTRE1
          BRANCH     OVRCD OF RDKDT999
.
          MOVE       ATNUMB,TADMNO
          MOVE       ATTRANS,TTRANSN1
          MOVE       ATINVNO,TREF
          MOVE       ATDDESC,TDDESC
          MOVE       ATPATAMT,TPATAMTT
          MOVE       ATDTGSTM,PTDTGSTM
.
          UNPACK     ATDDATE WITH XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,TFDAY
          MOVE       XMON,TFMONTH
          MOVE       XYEAR,TFYEAR
          MOVE       XCENT,TFCENT
.
          MOVE       ATITEMNO,TITEMNO
          MOVE       ATRECEPT,TRECEIPT
          MOVE       ATTYPE,TTYPE
          MOVE       ATPAYTYP,TPAYTYPE
          MOVE       ATSERVS,TSERVS
          MOVE       ATDEPTYP,TDEPTYP
.
          MOVE       ZERO,TRECTYPE
          LOAD       TRECTYPE USING ATRECTYP OF THREE,FIVE,SIX
          IF         ATRECTYP=6
            MOVE       "9",TRECTYPE           * ABF Record type
          ENDIF
          MOVE       ATREBPOR,TREBATE
          MOVE       ATPATPOR,TPATAMTP
          MOVE       ATREBPOR,TPATAMTI
          ADD        ATPATPOR,TPATAMTI
.
.         Check if this is theatre item
.
          COMPARE    THREE,TRECTYPE
          GOTO       RDKDT999 IF NOT EQUAL
.
          OPEN       PATITEM1,"patitemn"
          PACK       KEY17,TITEMNO,ATDDATE,SP70
          CALL       PATITMRD
          BRANCH     OVRCD OF RDKDT900
.
          COMPARE    ONE,PTMBSINV
          GOTO       RDKDT900 IF NOT EQUAL
          MOVE       TWO,TRECTYPE
          GOTO       RDKDT900
.
RDKDT400  CALL       RKPMFCI3
          BRANCH     OVRCD OF RDKDT999
.
.         SX - read DTR to get Subsequence Proc.Unique No
.
          IF         CFEETYP=5 & CRDNFLAG=1
            PACK       KEY22,PMFCVISN,PMFCINVN,PMFCTRAN,SP70
            CALL       RDDTRN1
            IF         OVRCD=0
              PACK       DIM22,TADMNO,TREF,TTRANSN1,SP70
              MATCH      DIM22,KEY22
              IF         !@EQUAL
                CALL       CLPATDTR
              ENDIF
            ENDIF
          ENDIF
.
          MOVE       PMFCVISN,TADMNO
          MOVE       PMFCCRNO,TREF
.
          MOVE       PMFCCRDA,PINVDTE
          UNPACK     PMFCTDAT WITH XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,TFDAY
          MOVE       XMON,TFMONTH
          MOVE       XYEAR,TFYEAR
          MOVE       XCENT,TFCENT
.
          MOVE       PMFCDESC,TDDESC
          MOVE       PMFCDES2,PTDTDES2
          MOVE       PMFCCAMT,TPATAMTT
          MOVE       PMFCAMTI,TPATAMTI
          MOVE       PMFCCAMT,TPATAMTP
          MOVE       PMFCRTYP,TRECTYPE
          MOVE       ZERO,TREBATE
.
          UNPACK     PMFCADAT WITH XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,TTDAY
          MOVE       XMON,TTMONTH
          MOVE       XYEAR,TTYEAR
          MOVE       XCENT,TTCENT
.
          MOVE       PMFCITEM,TITEMNO
          MOVE       SP70,TRECEIPT
          MOVE       SP70,TTYPE
          MOVE       SP70,TPAYTYPE
          MOVE       PMFCNDAY,TNODAYS
          MOVE       PMFCCLAI,TCLAIM
          MOVE       PMFCTDOC,TDOCTA
          MOVE       PMFCSERV,TSERVS
          MOVE       PMFCODOC,TDOCTO
          MOVE       PMFCSESS,TSESSION
          MOVE       PMFCMGRP,TMISGRP
          MOVE       PMFCWARD,TDWARD
          MOVE       PMFCCTYP,TCLMTYP
          MOVE       PMFCATYP,TADMTYP
          MOVE       PMFCBTCH,TBATCHN
          MOVE       PMFCNINV,TNINVS
          MOVE       PMFCPTLS,PTDTLSPT
          MOVE       PMFCRBLS,PTDTLSRB
          MOVE       PMFCDTYP,PTDTDTYP
          MOVE       PMFCADDC,PTDTCCU
          MOVE       PMFCGSTA,PTDTGSTA
          MOVE       PMFCCGST,PTDTGSTM
          MOVE       PMFCGSTL,PTDTGSTL
          MOVE       PMFCATFI,PTDTEFFD
.
RDKDT900  MOVE       ZERO,OVRCD
RDKDT999  RETURN
+
.*********************************************************************
.                   ENDMBF13
.         obtain the referral details from the mamography
.*********************************************************************
          DEFPROC   ENDMBF13
.
.         FD's required
.
          INC       MAMMASFD/INC            * mam master file
.
NAME25    DIM       25            * doctor name
.
. ******* get the mammography referring doctor *******
.
EMBF1300  
          MOVE      NETTOT,FORM62
          MOVE      OBAOUTNO,MAXNO          * mam number
          MOVE      MAXNO,KEY8
          OPEN      MAMMASX1,"mammasxf"     * open file
          CALL      RDMASX1                 * read mam file
          BRANCH    OVRCD,EMBF1350          * no details
.
          MATCH     SP6,MAXRDOCT
          GOTO      EMBF1350 IF EQUAL       * no referring doctor
.
          MOVE      MAXRDOCT,KEY6
          OPEN      PATDO1A1,"patdo1af"
          CALL      RDDOCT1
          BRANCH    OVRCD,EMBF1350          * invalid doctor
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,NAME25         * shorten name
.
          MATCH     SP10,DPROV
          GOTO      EMBF1320 IF EQUAL       * print doctor address
.
.         print the doctor name and provider number
.
          IF        PTCNITXT = 1
            PRINT     *1,"Referred by : ":
                      *N,*1,NAME25:
                      *N:
                      *N,*1,FORM62:
                      *N,*1,FORM62:
                      *N,*1,DPROV
          ELSE
            IF        IBCNUGST=2 & PTCNINVB<>0
              IF        PTCNINVB=1
                PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                          *123,FORM62:                       * line 45
                          *N,*17,DPROV:                     * line 46
                          *N,*N;
              ELSE
                PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                          *95,FORM62:                       * line 45
                          *N,*17,DPROV:                     * line 46
                          *N,*N;
              ENDIF
            ELSE
              PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                        *69,FORM62:                       * line 45
                        *N,*17,DPROV:                     * line 46
                        *N,*N;
            ENDIF
          ENDIF
          ADD        "10",COUNT
          GOTO      EMBF1399
.
.         print the doctor name and address
.
EMBF1320  IF        PTCNITXT = 1
            PRINT     *1,"Referred by : ":
                      *N,*1,NAME25:
                      *N:
                      *N,*1,FORM62:
                      *N,*1,DSADD1:
                      *N,*1,DSADD3:
                      *N,*1,DSADD4:
                      *N,*1,DSPOST
          ELSE
            IF        IBCNUGST=2 & PTCNINVB<>0
              IF        PTCNINVB=1
                PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                          *123,FORM62;                       * line 45
              ELSE
                PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                          *95,FORM62;                        * line 45
              ENDIF
            ELSE
              PRINT     *N,*N,*N,*3,"Referred by : ",NAME25:
                        *69,FORM62;                       * line 45
            ENDIF
            PRINT     *N,*17,DSADD1:                    * line 46
                      *N,*17,DSADD3:                    * line 47
                      *N,*17,DSADD4,*41,DSPOST;         * line 48
          ENDIF
          ADD       "10",COUNT
          GOTO      EMBF1399
.
.         invalid / no referring doctor
.
EMBF1350  IF        PTCNITXT = 1 
            PRINT     *1,"Referred by : ":
                      *N,*1,FORM62
          ELSE
            IF        IBCNUGST=2 & PTCNINVB<>0
              IF        PTCNINVB=1
                PRINT     *N,*N,*N,*3,"Referred by : ",*123,FORM62:   * line 45
                          *N,*N,*N;
              ELSE
                PRINT     *N,*N,*N,*3,"Referred by : ",*95,FORM62:    * line 45
                          *N,*N,*N;
              ENDIF
            ELSE
              PRINT     *N,*N,*N,*3,"Referred by : ",*69,FORM62:     * line 45
                        *N,*N,*N;
            ENDIF
          ENDIF
          ADD       "10",COUNT
          GOTO      EMBF1399
.
.         IO's required
.
OVERCOND  MOVE      ONE,OVRCD
          RETURN
+
          INC       MAMMASIO/INC            * mam master file
.
EMBF1399  IF        PTCNLASR=1
            PRINT     *F;
          ELSE
            IF        PTCNITXT <> 1
              PRINT     *N,*N,*N,*N,*N,*N,*N,*N,*N,*N;
            ENDIF
          ENDIF
          ENDPROC
+
.------------------------------------------------------------------------------
.        This subroutine prints the Invoice Total and doctor's information
.
PINVTOT  
.
. get attending doctors name and provider number
.
         OPEN      PATDO1A1,"patdo1af"
         PACK      DOCNAM38,SP20,SP20
         PACK      KEY6,ADOCTA,SP6
         CALL      RDDOCT1
         IF        OVRCD = 0
           MOVE      DTITL,PACTITLE
           MOVE      DGNAME,PACGNAME
           MOVE      DSNAME,PACSNAME
           MOVE      TWO,PACFRMT
           CALL      PACNAME
           MOVE      PACFNAME,DOCNAM38
         ENDIF
.
         MOVE      GROSSTOT,XGROSTOT
         IF        PTCNITXT = 1 
           PRINT     *1,"---------":
                     *N,*1,"DR'S NAME : ":
                     *N,*1,DOCNAM38:
                     *N,*1,IVTOTDES:
                     *N,*1,XGROSTOT:
                     *N,*1,"DR'S PROVIDER NUMBER :":
                     *N,*1,DPROV
         ELSE
           IF        IBCNUGST=2 & PTCNINVB<>0
             IF        PTCNINVB=1
               PRINT     *123,"----------"
               PRINT     *2,"DR'S NAME : ",DOCNAM38,*52,IVTOTDES:
                         *123,XGROSTOT:
                         *N,*2,"DR'S PROVIDER NUMBER : ",DPROV,*N
              ELSE
               PRINT     *95,"----------"
               PRINT     *2,"DR'S NAME : ",DOCNAM38,*52,IVTOTDES:
                         *95,XGROSTOT:
                         *N,*2,"DR'S PROVIDER NUMBER : ",DPROV,*N
              ENDIF
           ELSE
             PRINT     *69,"----------"
             PRINT     *2,"DR'S NAME : ",DOCNAM38,*52,IVTOTDES:
                       *69,XGROSTOT:
                       *N,*2,"DR'S PROVIDER NUMBER : ",DPROV,*N
           ENDIF
         ENDIF
.
           ADD      TWO,COUNT
.
           RETURN
+
.*******************************************************************************
.         Display credit note total
.         FORM=0 - Generate only, 1 - Print, 2 - Display
.*******************************************************************************
DCRD0000  MOVE      ZERO,FORM82
          MOVE      ZERO,FORM72
          MOVE      ZERO,FORM72
          MOVE      ZERO,FORM7P2
          MOVE      ZERO,CREDTOT
          MOVE      ONE,EXIT
          OPEN      PMSCNOA3,"pmscnoaf"
          MOVE      ZERO,F1
          PACK      KEY16,PINVNO,SP70
          CALL      RSPMCNO3
DCRD1000  CALL      RKPMCNO3
          BRANCH    OVRCD,DCRD2000
          MATCH     PINVNO,PMCNINVN
          GOTO      DCRD2000 IF NOT EQUAL
          MATCH     DPINVADM,PMCNVISN
          GOTO      DCRD2000 IF NOT EQUAL   * different admission
.
          ADD       PMCNAMNT,FORM82     * Total credit
          SUB       PMCNGSTM,FORM82     * exclude GST
.
          ADD       PMCNGSTM,FORM72     * Total GST
          ADD       PMCNGSTM,FORM7P2     * Total GST
          MOVE      ZERO,EXIT
.
          IF        CFEETYP=5
            CALL      SXCRD000            * Display/Print SX Credit notes
          ELSE
            CALL      JHCRD000            * Display/Print Credit notes
          ENDIF
          IF        JHFLAG=1
            ADD       ONE,F1
          ENDIF
          GOTO      DCRD1000
.
DCRD2000  ADD       FORM82,CREDTOT
          ADD       FORM7P2,CREDTOT
          BRANCH    JHFLAG,DCRD8000
          BRANCH    EXIT,DCRD9000       * no credit note
.
          COMPARE   ZERO,CREDTOT
          GOTO      DCRD9000 IF EQUAL   * No credit note
.
          BRANCH    COMPFLG,DCRD4000,DCRD3000
          GOTO      DCRD9000
.
DCRD3000  CALL      DSPC0000            * Display credit note
          GOTO      DCRD9000
.
DCRD4000  IF        PTCNINVL=22 | PTCNINVL=23
            MOVE      CREDTOT,FORM72
            PRINT     *3,"CREDIT NOTE TOTAL",*70,FORM72     * SX & Johns Hopkins
            ADD       ONE,COUNT
            GOTO      DCRD9000
          ENDIF

          MOVE      CREDTOT,TOTAMNT
          MOVE      TOTAMNT,XTOTAMNT
          IF        PTCNINVL<>24
            MOVE      TOTAMNT,LNTOTAL
            MOVE      SIX,RECFLAG
            CALL      PRLN0000              * Print Credit notes
          ENDIF
          GOTO      DCRD9000
.
DCRD8000  COMPARE   ZERO,CREDTOT
          GOTO      DCRD9000 IF EQUAL       * No credit note
          MATCH     "1",PTINCRST
          IF        @EQUAL
            SUB       PTINROUN,CREDTOT      * JH includes rounding
          ENDIF
DCRD9000  MOVE      ZERO,EXIT
DCRD9999  RETURN
+
.*******************************************************************************
.         Display credit notes
.*******************************************************************************
DSPC0000  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                             "<td><b>Credit Note Total</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right><b>",FORM82,"</td>":
                             "<td align=right><b>",FORM72,"</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right><b>":
                               CREDTOT,"</b></td></tr>"
.
DSPC9999  RETURN
+
.*******************************************************************************
.         Display/Print Credit Note for JH Invoice
.*******************************************************************************
JHCRD000  BRANCH    COMPFLG,JHCRD400,JHCRD300
          GOTO      JHCRD999
JHCRD300  MOVE      PMCNAMNT,FORM12P2   * Total credit
          SUB       PMCNGSTM,FORM12P2   * exclude GST
.
          UNPACK    PMCNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          WRITE     HTMLFILE;"<tr><td>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td><b>Credit Note No.",PMCNCRNO,"</b></td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right><b>",FORM12P2,"</td>":
                             "<td align=right><b>",PMCNGSTM,"</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        F1=0
            MATCH     "1",PTINCRST
            IF        @EQUAL
              SUB       PTINROUN,PMCNAMNT     * JH includes rounding
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td align=right><b>":
                               PMCNAMNT,"</b></td></tr>"
.
          GOTO      JHCRD999
.
JHCRD400  IF        JHFLAG=1
            MOVE      PMCNAMNT,FORM72
            PRINT     *3,"CREDIT NOTE NO.",PMCNCRNO,*70,FORM72
            ADD       ONE,COUNT
          ELSE
            IF        PTCNINVL=24
              MOVE      PMCNAMNT,LNTOTAL
              MOVE      SIX,RECFLAG
              CALL      PRLN0000              * Print Credit notes
            ENDIF
          ENDIF
.
JHCRD999  RETURN
+
.*******************************************************************************
.         Display Cash pending total
.         FORM=0 - Generate only, 1 - Print, 2 - Display
.*******************************************************************************
CSHP0000  MOVE      ZERO,FORM2
          MOVE      ZERO,CASHTOT
          MOVE      KEY12,SAVKEY12     * saved variable for invoice number
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      COMDEPA1,"comdepaf"
          MOVE      ZERO,PLINFLAG      * Flag for cash pending
.
          IF        JHFLAG=1
            CALL      JHUR0000       * Unreleased non-banked receipt for JH & SX
          ELSE
            CALL      UNRL0000       * Unreleased non-banked receipt
          ENDIF
.
CSHP9999  RETURN
+
.*******************************************************************************
.         Check for any unreleased non-banked receipt
.*******************************************************************************
UNRL0000  OPEN      RCPCRSA1,"rcpcrsaf"
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
UNRL1200  CALL      RKRCDTE3
          BRANCH    OVRCD,UNRL5000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      UNRL5000 IF NOT EQUAL
.
          MATCH     DPINVADM,RCDTVIST
          GOTO      UNRL1200 IF NOT EQUAL
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          COMPARE   ZERO,OVRCD
          GOTO      UNRL1200 IF EQUAL       * invoice printed for this payment
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,UNRL1200
.
.         MATCH     "0",RCBNSTAT             * Cash Not banked?
.         GOTO      UNRL1200 IF NOT EQUAL
.
          MATCH     "1",RCBNSTAT
          GOTO      UNRL1200 IF EQUAL        * Cancelled
.
          MATCH     "2",RCBNSTAT
          IF        @EQUAL
            MATCH     SP70,RCDTRELD
            GOTO      UNRL1200 IF NOT EQUAL
          ENDIF
.
          MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,CASHTOT
.
          COMPARE   ONE,DBSFLAG
          GOTO      UNRL2000 IF NOT EQUAL
.
          MATCH     "0",RCBNTTYP
          GOTO      UNRL1200 IF NOT EQUAL   * not a patient payment
.
          CALL      DSBL0000                * Display/Print Discharge billing
          GOTO      UNRL1200
.
UNRL2000  MOVE      ZERO,CASHFLAG           * A Cash Record has been found
          MOVE      "P",KEY1
          MOVE      RCBNTTYP,F1
          LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
          MOVE      RCDTDPTY,KEY3
          UNPACK    RCBNRCOD,KEY6           * Health Fund or Insurance code
          CALL      PAYD0000                * Get payment desc.
.
.        Read Bank detail file to get the payee
.
          MOVE      SP70,DIM14
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     RCDTRECN,RCBDRECN
            IF        @EQUAL
              MOVE      ZERO,F1
              MOVE      RCBDPTYP,F1
              MOVE      F1,F2
              CALL      CSHDS000                * Get payment type desc.
              IF        F2=2
                MOVE      RCBDDRAW,RCBDPAYD     * use the drawer as payee
              ENDIF
              IF        PTCNINVL=24 | PTCNINVL=25
                MATCH     SP70,RCBDPAYD
                IF        !@EQUAL
                  PACK      KEY25,RCBDPAYD   * Payee details
                ENDIF
.
              ENDIF
.
            ENDIF
          ENDIF
.
          PACK      DIM14,DIM14,SP70
          CLEAR     DIM14
          RESET     DIM14,13
.         ENDSET    DIM14
          APPEND    "*",DIM14
          APPEND    SP70,DIM14
          RESET     DIM14
.
          BRANCH    PRINTFLG,UNRL4000
.
          IF        CASHFLAG=1 & JOURFLAG=1
            CALL      DITOT000             * Display the Invoice Total
          ENDIF
.
          REP       " 0",RCDTTDAT
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          IF        CFEETYP=5
            CALL      DSNZC000             * Display SX payments
          ELSE
            CALL      DSCAS000             * Display payments
          ENDIF
          GOTO      UNRL1200
.
UNRL4000  COMPARE   MAXLINE,COUNT          * Check for room on Page
          CALL      TAIL IF NOT LESS
.
          REP       " 0",RCDTTDAT
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          PACK      DIM6,DIM14
          MOVE      RCDTAMNT,FORM62
          IF        PTCNINVL=23
            CALL      SXUNR000             * Print SX unreleased cash
            ADD       ONE,COUNT
          ELSE
            MOVE      "*",DEFINDIC         * for unreleased
            MOVE      RCDTINVN,DIM12       * save invoice number
            MOVE      RCDTRECN,KEY12       * save receipt number
            MOVE      RCDTAMNT,TPATAMTT
            UNPACK    RCDTTDAT,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
            MOVE      DTFCENT,TFCENT
            MOVE      DTFYEAR,TFYEAR
            MOVE      DTFMONTH,TFMONTH
            MOVE      DTFDAY,TFDAY
            MOVE      RCDTRECN,DIM12A    * save receipt number
            CALL      CHKAM000
            BRANCH    EXIT,UNRL1200
.
            MOVE      RCDTRECN,TRECEIPT
            MOVE      RCDTAMNT,LNTOTAL
            MOVE      KEY25,TDDESC
            MOVE      KEY25,DIM21
            MOVE      RCDTTDAT,DFDATE
            MOVE      FOUR,RECFLAG           * flag for printing cash details
            MOVE      ZERO,PLINFLAG
            CALL      PRLN0000               * Print unreleased cash
          ENDIF
          GOTO       UNRL1200
.
UNRL5000  BRANCH    DBSFLAG,UNRL9999
.
          COMPARE   ZERO,CASHTOT
          GOTO      UNRL5100 IF NOT EQUAL
.
          BRANCH    CASHFLAG,UNRL9999       * no cash payment
.
UNRL5100  ADD       CASHTOT,PAYMTTOT
          IF        PRINTFLG=1
            MOVE      PAYMTTOT,LNTOTAL
            MOVE      FOUR,RECFLAG
            MOVE      ONE,PLINFLAG          * Print cash total
            CALL      PRLN0000
          ELSE
            CALL      DCSHT000                * Display Cash Total
          ENDIF
          MOVE      ZERO,PLINFLAG
          SUB       CASHTOT,PAYMTTOT
UNRL9999  RETURN
+
.*******************************************************************************
.           Display SX Payments
.*******************************************************************************
DSNZC000  CALL      PAYE0000                  * Get payee details
          MOVE      RCBDPAYD,KEY50
.
DSNZC100  MATCH     "1",RCCNSTRF
          GOTO      DSNZC150 IF NOT EQUAL
.
          MATCH     "4",RCBDPTYP
          GOTO      DSNZC150 IF NOT EQUAL
.
          STRIP     RCBDPAYD
          STRIP     RCBDSTRF
.
          WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "</td>":
                             "<td><b>Receipt ##</b> ",RCDTRECN:
                             " <b>Payer:</b> ",KEY50:
                             " <b>Stmt Ref:</b> ",RCBDSTRF,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>":
                             RCDTAMNT,"</b></td></tr>"
.
          GOTO      DSNZC400
.
DSNZC150  WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "</td>":
                             "<td><b>Receipt ##</b>",RCDTRECN," <b>Payer: </b>":
                             KEY50,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>":
                             RCDTAMNT,"</b></td></tr>"
.
DSNZC400  MOVE      ZERO,CASHFLAG           * A Cash Record has been found
.
DSNZC999  RETURN
.
.*******************************************************************************
.         Display standard payments
.*******************************************************************************
DSCAS000  WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "</td>":
                             "<td>",KEY25," RECEIPT ## ",RCDTRECN,"*</td>":
                             "<td>",DIM14,"</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>":
                              RCDTAMNT,"</b></td></tr>"
          MOVE      ZERO,CASHFLAG           * A Cash Record has been found
DSCAS999  RETURN
+
.*******************************************************************************
.         Display/print discharge billing statement
.*******************************************************************************
DSBL0000  MOVE      ZERO,CASHFLAG           * A Cash Record has been found
          ADD       RCDTAMNT,PAYMTTOT   * patient payment
          MOVE      "FROM PATIENT",TDESC
          MATCH     SP70,RCDTDPTY
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSP,RCDTDPTY,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Deposit Type",TDESC
              APPEND    RCDTDPTY,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
.
          CLEAR     KEY50
          APPEND    TDESC,KEY50
          APPEND    " RECEIPT ## ",KEY50
          APPEND    RCDTRECN,KEY50
          APPEND    SP70,KEY50
          RESET     KEY50
.
          IF        PRINTFLG=1
            CALL      PRRL0000               * Print un-released cash
          ELSE
            CALL      DSRL0000               * Display un-released cash
          ENDIF
DSBL9999  RETURN
+
.*******************************************************************************
.         Display Un-released cash for Discharge billing
.*******************************************************************************
DSRL0000  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;",KEY50,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>";
DSRL9999   RETURN
+
.*******************************************************************************
.          Print Un-released cash for Discharge billing
.*******************************************************************************
PRRL0000
            COMPARE   MAXLINE,COUNT               * Check for room on Page
            CALL      TAIL IF NOT LESS
.
            UNPACK    KEY50,KEY45
            MOVE      RCDTAMNT,FORM62
            IF        PTCNINVL=25
              MOVE      FORM62,FORM52
              PRINT     *19,KEY45:
                        *73,FORM52
            ELSE
              PRINT     *23,KEY45:
                        *71,FORM62
            ENDIF
            ADD       ONE,COUNT
PRRL9999  RETURN
+
.*******************************************************************************
.         Check for any unreleased non-banked receipt for Johns Hopkins & SX
.*******************************************************************************
JHUR0000  MOVE      ZERO,FORM1
          MOVE      ZERO,DSCNFLAG
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
JHUR6200  CALL      RKRCDTE3
          BRANCH    OVRCD,JHUR7000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      JHUR7000 IF NOT EQUAL
.
          MATCH     DPINVADM,RCDTVIST
          GOTO      JHUR6200 IF NOT EQUAL
.
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          COMPARE   ZERO,OVRCD
          GOTO      JHUR6200 IF EQUAL       * invoice printed for this payment
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,JHUR6200
.         MATCH     "0",RCBNSTAT             * Cash Not banked?
.         GOTO      JHUR6200 IF NOT EQUAL
.
          MATCH     "1",RCBNSTAT
          GOTO      JHUR6200 IF EQUAL        * Cancelled
.
          MATCH     "2",RCBNSTAT
          IF        @EQUAL
            MATCH     SP70,RCDTRELD
            GOTO      JHUR6200 IF NOT EQUAL
          ENDIF
.
          MULT      "-1",RCDTAMNT
          IF        RCDTDISC<>0
            MOVE      ONE,DSCNFLAG
          ENDIF
.
          MATCH     SP70,RCBNRCOD
          IF        @EQUAL
            MOVE      "PATIENT",KEY7
          ELSE
            PACK      KEY7,RCBNRCOD,SP70
          ENDIF
.
          IF        PRINTFLG=1
            CALL      PSXJH000                    * Print SX and JH cash
          ELSE
            CALL      DSXJH000                    * Display SX & JH cash
          ENDIF
.
          ADD       RCDTAMNT,CASHTOT
          MOVE      ZERO,CASHFLAG           * A Cash Record has been found
          GOTO      JHUR6200
.
JHUR7000  BRANCH    PRINTFLG,JHUR9999
.
          COMPARE   ZERO,CASHTOT
          GOTO      JHUR8200 IF NOT EQUAL
.
.         No cash pending
.
          IF        CASHFLAG=1 & JOURFLAG=1
            CALL      DITOT000             * Display the Invoice Total
          ENDIF
          BRANCH    CASHFLAG,JHUR9999
.
JHUR8200  ADD       CASHTOT,PAYMTTOT
          CALL      DCSHT000                * Display Cash Total
          SUB       CASHTOT,PAYMTTOT
.
JHUR9999  RETURN
+
.*******************************************************************************
.         Print SX and Johns Hopkins unreleased cash
.*******************************************************************************
PSXJH000  COMPARE   MAXLINE,COUNT               * Check for room on Page
          CALL      TAIL IF NOT LESS
          MOVE      RCDTAMNT,FORM7P2
.
          IF        PTCNINVL=23
            MOVE      FORM7P2,FORM62
            CALL      SXUNR000                  * Print SX receipts
          ELSE
            PRINT     *3,KEY7," RECEIPT ## ",RCDTRECN,*57,FORM7P2
          ENDIF
.
          ADD       ONE,COUNT
PSXJH999  RETURN
.
.*******************************************************************************
.         Display SX and Johns Hopkins unreleased cash
.*******************************************************************************
DSXJH000  IF        CASHFLAG=1 & JOURFLAG=1
            CALL      DITOT000             * Display the Invoice Total
          ENDIF
.
          REP       " 0",RCDTTDAT
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                             NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          COMPARE   FIVE,CFEETYP
          GOTO      DSXJH200 IF NOT EQUAL
.
          CALL      DXUNR000                  * SX Unreleased payment
          GOTO      DSXJH9999
.
DSXJH200  WRITE     HTMLFILE;"<tr><td>Payment - ":
                            CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                            "<td>",KEY7," RECEIPT ## ",RCDTRECN,"</td>";
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1 & JHFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          IF        RCDTDISC<>0
            WRITE     HTMLFILE;"<td align=right><font color=#000080><b>":
                            RCDTAMNT,"</font></b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",RCDTAMNT,"</td></tr>"
          ENDIF
.
DSXJH999  RETURN
+
.*******************************************************************************
.         Read Bank detail file to get the payee for SXC
.*******************************************************************************
PAYE0000  PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,PAYE9000
          MATCH     RCDTRECN,RCBDRECN
          GOTO      PAYE9000 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,RCBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ZERO,F2
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
          ENDIF
          IF        F2=2
            MOVE      RCBDDRAW,RCBDPAYD     * cheque - use the drawer as payee
          ENDIF
          GOTO      PAYE9999
.
PAYE9000  MOVE      SP70,RCBDPAYD
PAYE9999  RETURN
+
.*******************************************************************************
.     Payment description
.*******************************************************************************
PAYD0000  MOVE      SP70,KEY25
          CLEAR     KEY25
          MATCH     SP70,KEY3
          GOTO      PAYD7000 IF NOT EQUAL   * Deposit
          APPEND    "FROM ",KEY25
          MATCH     SP70,KEY1
          GOTO      PAYD4000 IF EQUAL
.
          MATCH     "H",KEY1
          GOTO      PAYD1000 IF NOT EQUAL
.
          MOVE      "HEALTH FUND",KEY20
          MATCH     SP70,KEY6
          GOTO      PAYD0800 IF EQUAL       * blank health fund code
.
          MOVE      "0000    ",HFTABL
          PACK      KEY14,KEY6,HFTABL,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,KEY20
          ENDIF
PAYD0800  APPEND    KEY20,KEY25
          GOTO      PAYD8000
.
PAYD1000  MATCH     "I",KEY1
          GOTO      PAYD2000 IF NOT EQUAL
.
          MOVE      "INSURANCE  ",KEY20
          MATCH     SP70,KEY6
          GOTO      PAYD1800 IF EQUAL       * blank insurance code
.
          OPEN      PATIN1A1,"patin1af"
          CALL      RDINSR1
          IF        OVRCD=0
            MOVE      INAME,KEY20           
          ENDIF
PAYD1800  APPEND    KEY20,KEY25
          GOTO      PAYD8000
.
PAYD2000  MATCH     "G",KEY1
          GOTO      PAYD3000 IF NOT EQUAL
.
          APPEND    "GOVERNMENT DEPARTMENT",KEY25
          GOTO      PAYD8000
.
PAYD3000  MATCH     "P",KEY1
          GOTO      PAYD8000 IF NOT EQUAL
PAYD4000  APPEND    "PATIENT    ",KEY25
          GOTO      PAYD8000
.
PAYD7000  PACK      KEY5,ANSD,ANSP,KEY3,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    "DEPOSIT - ",KEY25
            APPEND    TDESC,KEY25
          ENDIF
.
PAYD8000  APPEND    SP70,KEY25
          RESET     KEY25
PAYD9999  RETURN
+
.*******************************************************************************
.        Search for any Anaesthetic Codes and Times
.*******************************************************************************
GJGB0000 COMPARE   "25",PTCNINVL
         GOTO      GJGB9999 IF EQUAL            * Do not print Anaes.for Cabrini
.
         CALL      CKTL0000
         OPEN      OPRDETA2,"oprdetaf"
         PACK      KEY31,PINVADM,ZERO,SP70
         CALL      RSOPDEA2
GJGB1000 CALL      RKOPDEA2
         BRANCH    OVRCD,GJGB9999
.
         MATCH     PINVADM,OPDAADMN
         GOTO      GJGB9999 IF NOT EQUAL
.
         COMPARE   THREE,OPDASTAT
         GOTO      GJGB9999 IF EQUAL
.
.        check if the session date matches
.
         PACK      KEY8,SAVDATE1,SP70
         REP       " 0",KEY8
         MOVE      OPDADATE,DIM8
         REP       " 0",DIM8
         MATCH     KEY8,DIM8
         GOTO      GJGB1000 IF NOT EQUAL
.
.        MOVE      OPDACASE,FORM2
.        MOVE      FORM2,XMON
.        MATCH     XMON,PMMISESS
.        GOTO      GJGB1000 IF NOT EQUAL
.
         MATCH     SAVEUNIQ,OPDAUNIQ
         GOTO      GJGB1000 IF NOT EQUAL
.
         PACK      KEY10,SAVEUNIQ,SP70                 * Direct read for Arrival
         CALL      RDOPARD1                            * and Recovery details
         BRANCH    OVRCD,GJGB9999
.
         PRINT     *30,OPDAANAE;
.
         MOVE      OPARANAS,DIM5
         MOVE      OPARANAE,DIM5A
.
         PRINT     *36,DIM5," to ",DIM5A;
         CALL      PEOL0000
.
GJGB9999 RETURN
.
. *****************************************************************************
. * PSJOG0000 : Print St. John of God Emergency Invoice Layout                 *
. *****************************************************************************
PSJGR000  MOVE     SP70,DIM18
          MOVE     SP70,PMHCPRV1
          MOVE     ZERO,FORM6P2
          MOVE     ZERO,FORM6P2B
          MOVE     ZERO,FORM9P2
.   
          OPEN     PMSHCPA1,"pmshcpaf"
          PACK     KEY10,ATDTEDAD,SP70
          CALL     RDPMHCP1
          IF       OVRCD<>1
            MOVE     PMHCTITL,FMTTITLE
            MOVE     PMHCGNAM,FMTGNAME
            MOVE     PMHCSNAM,FMTSNAME
            CALL     DOCNM000
          ENDIF
.
          MOVE     ATPATAMT,FORM6P2
          MOVE     ATDTGSTM,FORM6P2B
.
          MOVE     ATDDESC,DIM18
          ASSIGN   (ATPATAMT+ATDTGSTM),FORM9P2
.
          MOVE     ATDDATE,DFDATE
          MOVE     ATITEMNO,PRTITCOD
          MOVE     ATPATAMT,LINETOT
          MOVE     ATDTGSTM,LINEGST
          MOVE     ATPATPOR,LSTRATE
          ADD      ATREBPOR,LSTRATE
.
          MOVE     ATDDESC,TDDESC
          MOVE     TWO,RECFLAG
          CALL     PRLN0000                * print procedures
          GOTO     PSJGR999
.
PSJGR999  RETURN
+
.******************************************************************************
.* FGST0000 : Get percentage of Item GST                                      *
.******************************************************************************
FGST0000  MOVE     ZERO,IBGEAMNT            * Initialise GST percentage amount
          COMPARE  TWO,IBCNUGST
          GOTO     FGST9999 IF NOT EQUAL    * not using Aust.GST
.
          BRANCH   PTDTGSTA,FGST6000        * GST payable
          GOTO     FGST9000                 * GST free
.
FGST6000  OPEN     IBAGEDA1,"ibagedaf"
          MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY14,PTDTGSTC,KEY8
          CALL     RDIBGE1
          COMPARE  ZERO,OVRCD
          GOTO     FGST9000 IF EQUAL         * found GST amount for current date
.
          CALL     RPIBGE1                   * read previous record
          BRANCH   OVRCD,FGST8000
.
          MATCH    PTDTGSTC,IBGECODE         * Same code ?
          GOTO     FGST9000 IF EQUAL
.
FGST8000  MOVE     ZERO,IBGEAMNT
.
FGST9000  CLOSE    IBAGEDA1
FGST9999  RETURN
+
.******************************************************************************
.         Check for WC or TAC claim
.**********************************************************************
CHKCL000  MOVE      ZERO,F1
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND05;*189,PTCNPRCL    * print claim code
          COMPARE   ZERO,PTCNPRCL
          GOTO      CHKCL999 IF EQUAL             * not printing claim code
.
          UNPACK    SP5 WITH TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      "CL",TCODE
          PACK      KEY5 WITH TCODE,ACLAIM
          CALL      RDCODE1
.
          MOVE      ZERO,FORM2
CHKCL100  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CHKCL999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      CHKCL200 IF EQUAL
          CMATCH    "M",ANS
          GOTO      CHKCL100 IF NOT EQUAL
.
CHKCL200  MOVE      ONE,F1
CHKCL999  RETURN
+
.******************************************************************************
.         Get Contract ID from blank lumpsum description in dtr file
.******************************************************************************
CNTD0000  PACK      CONTRCID,PTINCNID,SP70
          MATCH     SP70,CONTRCID
          GOTO      CNTD9999 IF NOT EQUAL  * Contract id is not blank
.
          MATCH     SP70,CMCODE
          GOTO      CNTD9999 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get effective date
          BRANCH    EXIT,CNTD9999          * Not valid
.
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,CODECL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          CALL      VALCMXFN           * find Contract ID for the prov.code
.
CNTD9999  RETURN
+
.******************************************************************************
.        Check if item to be excluded from display/calculation on Disc.Billing
.******************************************************************************
XCLI0000  MOVE     ZERO,EXIT
          COMPARE  ONE,DBSFLAG
          GOTO     XCLI9999 IF NOT EQUAL   * No Disc.Billing
.
          MATCH     SP70,TMISGRP
          IF        !@EQUAL
            MOVE      "FI",KEY2
            PACK      KEY5,KEY2,TMISGRP
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "1",TCINDC8
              IF        @EQUAL
                MOVE      ONE,EXIT         * Exclude
              ENDIF
            ENDIF
          ENDIF
XCLI9999  RETURN
+
.******************************************************************************
          INCLUDE   NZPCATAI              * NZ Billing 
          INCLUDE   PRBILCMN              * Print billing comments
.
