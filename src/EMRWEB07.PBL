.----------------------------------------------------------------------
. Program       : EMRWEB07
.
. Function      : Emergency Table Maintenance
.
. Modifications : 
. V11.04.02 23/05/2024 Nikitha B        TSK 0946810 
.           Modified CHKBYP00 & CHKBYU00 to limit display of bypass records for
.           just 30 days period and modified PRDS0000 to display records only 
.           by user's site code and 30 days prior to avoid server run time error
.           Added a new tag at PBPS3400 for user's emergency site description.
. V11.04.01 23/11/2023 Bella Turco      TSK 0929360
.           Removed functionality in CHKBYP00 & CHKBYU00 to auto close previous
.           open bypass record
. V11.03.02 22/09/2023 Bella Turco      TSK 0929360
.           Rewrote CHKPRE00 bypass logic into following two routines
.           Added CHKBYP00 - Validate overlapping bypass records on add
.           Added CHKBYU00 - Validate overlapping bypass records on update
. V11.03.01 10/01/2023 Bella Turco      TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V10.08.01 27/09/2016 Jill Parkinson TSK 0814124
.                      Changed emrmtxaf to use emic9cod instead of emicvemd
. V10.05.01 06/08/2014 Don Nguyen     CAR 297703
.                      Added EMBPS020-22 (EMBPAHCP, EMBPFFNA, EMBPFFCA).
.                      Updated routines (add/update) to handle new fields.
.                      Modified PRROW000 to display new fields.
.----------------------------------------------------------------------
. V10.04.01 31.03.2014  B.G.Ackland   CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.----------------------------------------------------------------------
. V10.03.05 16/07/2013 Jill Parkinson CAR 287923
.                      Added include of PATCONFD
. V10.03.04 24/04/2013 Ebon Clements  CAR 261630
.                      Removed port number from temp file name
. V10.03.03 15/11/2012 Jill Parkinson CAR 276503
.                      Fixed site based comments from looping, also fixed output
.                      in SCMT0000 to match user's site
. V10.03.02 14/09/2012 Don Nguyen   CAR 270231
.                      Added NXTPAG40 to facilitate the closing of the DFrame
. V10.03.01 04/09/2012 Don Nguyen   CAR 270231
.                      Added output for Site-based comments/notices (report 5)
. V10.00.04 31/05/2010 Ebon Clements    221444
.                      Fixed keys for add and update diverted patients EDVP0000
. V10.00.03 07/04/2010 Ebon Clements    218773
.                      Added nextpage = 3 PWNCLS00
. V10.00.02 29/03/2010 Ebon Clements    218773
.                      Fixed keys for add and update by pass EBPS0000
. V10.00.01 26/03/2010 Ebon Clements    218773
.                      Schedule a spooled bypass report in PREP0000
. V9.12.03 02/03/2010 Peter McMullen   216521
.                     always display un-expired bypasses on tag 07.03.008
. V9.12.02 01/09/2009 WeeLee Koo   CAR 197930
.                     Added selection to filter By-Pass Type (PRDS0000)
.                     Changed Reason for By-Pass to display desc not code
.                     (PRROW100)         
. V9.12.01 22/06/2009 WeeLee Koo   CAR 197930
.                     Created new Diverted Patients module(Rpt No:4)
.                     Created new By-Pass and Pre By-Pass module(Rpt No:3)
. V9.05.01 09/03/2006 Ebon Clements CAR 78533
.                     Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.                     Mods for REDIRECT length change.
.                     Recompiled for IBAWEBDF
. V9.04.01 21/11/2005 Ebon Clements CAR 58120
.                     Added goto functionality to vemd matrix maintenance
. V9.03.01 18/06/2003 Ebon Clements CAR 37705
.                     Fixed array out of bounds for Emergency notices
. V9.02.04 03/03/2003 Lina Vo       SRF 34675
.                     Added diagnosis validation to CHKMTX00. 
.                     Called CHKMTX00 in update matrix section.
. V9.02.03 19/12/2002 Jill Habasque SRF 34675
.                     Changed to use the VEMD code            
. V9.02.02 28/03/2002 Bronko Sosic
.                     Recompiled for EMRICDFD                 
. V9.02.01 13/02/2002 Bronko Sosic
.                     Changed comments section                
. V9.00.01 02/08/2001 Ashwin - HPS  
.                     Added New Option for Emergency Comments
. V5.07.02 24/01/2000 Nicole Harrington
.                     Changed to branch on EXIT not OVRCD after WEBHED00
. V5.07.01 12/01/2000 Nicole Harrington
.                     Recompiled for new standards
. V5.07.00 03/11/1999 Nicole Harrington
.                     Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       RSHWEBDF
.
          INC       PATCONFD/INC
          INC       EMRDVPFD/INC
          INC       EMRBPSFD/INC
          INC       EMRGRCFD/INC
          INC       EMRICDFD/INC
          INC       EMRMTXFD/INC
          INC       EMRSCMFD/INC
          INC       EMRSITFD/INC
          INC       EMRCMTFD/INC                     * HPS01I
          INC       PMSHCPFD/INC
          INC       TFILEVAR/INC
          INC       ADDSECTD/INC

          INC       WEBDATDF
.
DIVERTAF  FILE      ASCII, FIXED=127        * For Diversion Reason
PRECOMAF  FILE      ASCII, FIXED=127        * For Pre/By-Pass Reason
.
. CGI Parameters
.
EMRMX001  DIM       2              * Nature of Main Injury
EMRMX002  DIM       2              * Body Region
EMRMX003  DIM       6              * Primary Diagnosis
SERMX001  DIM       2              * Save Nature of Main Injury
SERMX002  DIM       2              * Save Body Region
SERMX003  DIM       6              * Save Primary Diagnosis
STARTKEY  DIM       25             * Starting Key
NEXTPAGE  DIM       2              * Next page
UPDTTYPE  DIM       1              * Update Type - A=Add,U=Update,D=Delete
UPDATETY  DIM       1              * Update Type for Comments  (HPS01I)
EMCMT001  DIM       70[99]         * Emergency Comments/Notices(HPS01I)
.
CCYY      DIM       4
EMBPS001  DIM       3              * Emergency Site Code
EMBPS002  DIM       1              * By Pass Type(0=Pre-ByPass,1=Bypass)
EMBPS003  DIM       8              * On Pre/By Pass Date (CCYYMMDD)
EMBPS004  DIM       8              * On Pre/by Pass Time (HH:MM:SS)
EMBPS005  DIM       3              * Reason for Pre/By Pass
EMBPS006  DIM       8              * Off Pre/By Pass Date (CCYYMMDD)
EMBPS007  DIM       8              * Off Pre/By Pass Time (HH:MM:SS)
EMBPS008  DIM       100            * Free Format Line 1
EMBPS009  DIM       100            * Free Format Line 2
EMBPS010  DIM       100            * Free Format Line 3
EMBPS011  DIM       100            * Free Format Line 4
EMBPS012  DIM       100            * Free Format Line 5
EMBPS013  DIM       3              * No of Ambulances(manually recorded)
EMBPS014  DIM       10             * User who Created Record
EMBPS015  DIM       8              * Date Record Created
EMBPS016  DIM       8              * Time Record Created
EMBPS017  DIM       10             * User who Updated Record
EMBPS018  DIM       8              * Date Record Updated
EMBPS019  DIM       8              * Time Record Updated
EMBPS020  DIM       10             * Active HCP for Doctor authorisation
EMBPS021  DIM       45             * Free Format for Nurse authorisation
EMBPS022  DIM       45             * Free Format for Co-ordinator authorisation
EBPSRSON  DIM       20             * Reason for Pre/By Pass
EMBPTYPE  DIM       15             * By-Pass Type (Pre-ByPass/ ByPass)
EMBPFMDT  DIM       12             * Converted On Pre/By Pass Date
EMBPFFDT  DIM       12             * Converted Off Pre/By Pass Date
PRINTCHK  DIM       1              * Print? (1=Yes,0=No)    
PASSTYPE  DIM       1              * By Pass Filter
.
PRECOMFL  FORM      1
PRECOMNM  DIM       8
LASTPRES  FORM      3              * Last Item
RESNDATA  DIM       100            * Reason for pre/by-pass (DATA)
RECORDKY  DIM       20             * Bypass record key for update and delete
USRSITID  DIM       3              * Emergency Site Code of an user
WORKDATE  DATE      8 
.
EMDVP001  DIM       3              * Emergency Site Code
EMDVP002  DIM       8              * Diversion Date (CCYYMMDD)
EMDVP003  DIM       8              * Diversion Date (HH:MM:SS)
EMDVP004  DIM       3              * Reason for Diversion
EMDVP005  DIM       100            * Free Format Line 1
EMDVP006  DIM       100            * Free Format Line 2
EMDVP007  DIM       100            * Free Format Line 3
EMDVP008  DIM       100            * Free Format Line 4
EMDVP009  DIM       100            * Free Format Line 5
EMDVP010  DIM       10             * User who Created Record
EMDVP011  DIM       8              * Date Record Created
EMDVP012  DIM       8              * Time Record Created
EMDVP013  DIM       10             * User who Updated Record
EMDVP014  DIM       8              * Date Record Updated
EMDVP015  DIM       8              * Time Record Updated
DESCRIPT  DIM       25             * Reason for Diversion Description
DIVERTFL  FORM      1
DIVERTNM  DIM       8
LASTDIVT  FORM      3              * Last Item
REASONDV  DIM       100            * Reason for diversion (DATA)
ONFLAG1   FORM      1
OFFLAG1   FORM      1
ONDATTIM  DIM       14
OFDATTIM  DIM       14
NWONDTTM  DIM       14
NWOFDTTM  DIM       14
XXHOUR    DIM       2
XXMIN     DIM       2
XXSEC     DIM       2
SAVKEY20  DIM       20
DIM20     DIM       20
.
. Local Variable Definition
.
EMCMTIDX  FORM      2              * Index for Emergency Comment(HPS01I)
CODEDESC  DIM       127
DISPPDG   DIM       6
.
PRGID     INIT      "EMRWEB07"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Emergency Table Maintenance"
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400:    * HPS01I
                             MAIN1500
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      EMRMTX00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
. HPS Code Starts Here
MAIN1200  CALL      EMRCMT00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
. HPS Code Ends Here
.
MAIN1300  CALL      EBPS0000            * Emergency Pre By-Pass / By-Pass
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      EDVP0000            * Emergency Diverted Patients
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      EMRSCM00            * Site-based comments/notices
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      EMRBPSA1,"emrbpsaf"
          OPEN      EMRBPSA2,"emrbpsaf"
          OPEN      EMRDVPA1,"emrdvpaf"
          OPEN      EMRGRCA1,"emrgrcaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRICDA4,"emricdaf"
          OPEN      EMRMTXA1,"emrmtxaf"
          OPEN      EMRMTXA3,"emrmtxaf"
          OPEN      EMRSCMA1,"emrscmaf"          * Site-based comments/notices
          OPEN      EMRSITA1,"emrsitaf"          * Emergency Site description
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      EMRCMTA1,"emrcmtaf"                   * HPS01I
          OPEN      WEBSECA1,"websecaf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PRECOMNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,DIVERTNM
.
INIT9999  RETURN
.
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,REDIRECT
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,NORECORD
          MOVE      ZERO,STARTNUM
          MOVE      SP70,UPDATETY                          * HPS01I
          MOVE      SP70,STARTKEY
          MOVE      SP70,SCHDPRNT
          MOVE      SP70,RECORDKY
          PACK      REDIRECT,SP70,SP70,SP70,SP70
.
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          PACK      VYEARMTH,SP70
          MOVE      SP70,EMRMX001
          MOVE      SP70,EMRMX002
          MOVE      SP70,EMRMX003
          MOVE      SP70,SERMX001
          MOVE      SP70,SERMX002
          MOVE      SP70,SERMX003
          MOVE      ZERO,EMCMTIDX                         * HPS01I
.
          MOVE      SP70,EMBPS001
          MOVE      SP70,EMBPS002
          MOVE      SP70,EMBPS003
          MOVE      SP70,EMBPS004
          MOVE      SP70,EMBPS005
          MOVE      SP70,EMBPS006
          MOVE      SP70,EMBPS007
          MOVE      SP70,EMBPS008
          MOVE      SP70,EMBPS009
          MOVE      SP70,EMBPS010
          MOVE      SP70,EMBPS011
          MOVE      SP70,EMBPS012
          MOVE      SP70,EMBPS013
          MOVE      SP70,EMBPS014
          MOVE      SP70,EMBPS015
          MOVE      SP70,EMBPS016
          MOVE      SP70,EMBPS017
          MOVE      SP70,EMBPS018
          MOVE      SP70,EMBPS019
          MOVE      SP70,EMBPS020
          MOVE      SP70,EMBPS021
          MOVE      SP70,EMBPS022
          MOVE      SP70,EMBPTYPE
          MOVE      SP70,EMBPFMDT
          MOVE      SP70,EMBPFFDT
          MOVE      SP70,PRINTCHK
          MOVE      SP70,PASSTYPE
.
          MOVE      SP70,EMDVP001
          MOVE      SP70,EMDVP002
          MOVE      SP70,EMDVP003
          MOVE      SP70,EMDVP004
          MOVE      SP70,EMDVP005
          MOVE      SP70,EMDVP006
          MOVE      SP70,EMDVP007
          MOVE      SP70,EMDVP008
          MOVE      SP70,EMDVP009
          MOVE      SP70,EMDVP010
          MOVE      SP70,EMDVP011
          MOVE      SP70,EMDVP012
          MOVE      SP70,EMDVP013
          MOVE      SP70,EMDVP014
          MOVE      SP70,EMDVP015
.
          MOVE      ZERO,PRECOMFL
.
          MOVE      ZERO,DIVERTFL
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
. HPS Code Starts Here
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emcmt001=",QRYNAME
          IF        @EQUAL
            CALL      GETCMT00
            GOTO      SETPAR99
          ENDIF
. HPS Code Ends Here
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emrmx",QRYNAME
          IF        @EQUAL
            CALL      STMTX000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sermx",QRYNAME
          IF        @EQUAL
            CALL      SVMTX000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps001=",QRYNAME
          IF        @EQUAL
            PACK      EMBPS001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps002=",QRYNAME
          IF        @EQUAL
            PACK      EMBPS002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps003=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP30
            UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted/unformatted date
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,EMBPS003 * Do not change date format =(CCYYMMDD)
            ELSE
              MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
              PACK      KEY11,KEY11,SP70
              MATCH     SP70,KEY11
              IF        !@EQUAL
                UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
                CALL      SETMTH00
                PACK      EMBPS003,CCENT,CYEAR,CMON,CDAY
                REP       " 0",EMBPS003
              ENDIF
            ENDIF
          GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps004=",QRYNAME
          IF        @EQUAL
            PACK      EMBPS004,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps006=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP30
            UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted/unformatted date
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,EMBPS006 * Do not change date format =(CCYYMMDD)
            ELSE
              MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
              PACK      KEY11,KEY11,SP70
              MATCH     SP70,KEY11
              IF        !@EQUAL
                UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
                CALL      SETMTH00
                PACK      EMBPS006,CCENT,CYEAR,CMON,CDAY
                REP       " 0",EMBPS006
              ENDIF
            ENDIF
          GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps007=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS007
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "resontxt=",QRYNAME     * reason for pre/by-pass comments
          IF        @EQUAL
            CALL      GETPRE00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps013=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS013
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps014=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS014
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps015=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS015
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps016=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS016
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps017=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS017
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps018=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS018
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps019=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS019
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps020=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS020
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps021=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS021
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embps022=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPS022
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embptype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recordky=",QRYNAME
          IF        @EQUAL
            PACK      RECORDKY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "embpptyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMBPPTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "passtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PASSTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printchk=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTCHK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            REP       "~'",STARTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp002=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP30
            UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted/unformatted date
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,EMDVP002 * Do not change date format =(CCYYMMDD)
            ELSE
              MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
              PACK      KEY11,KEY11,SP70
              MATCH     SP70,KEY11
              IF        !@EQUAL
                UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
                CALL      SETMTH00
                PACK      EMDVP002,CCENT,CYEAR,CMON,CDAY
                REP       " 0",EMDVP002
              ENDIF
            ENDIF
          GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasntxt=",QRYNAME     * reason for diversion comments
          IF        @EQUAL
            CALL      GETDVC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp010=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP010
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp011=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP011
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp012=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP012
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp013=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP013
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp014=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP014
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emdvp015=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMDVP015
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.*******************************************************************************
.                 Get Reason for Pre/By-Pass Comments
.*******************************************************************************
GETPRE00  PREP      PRECOMAF,PRECOMNM
          MOVE      ONE,F3
          WRITE     PRECOMAF,SEQ;QRYDATA
          MOVE      ONE,PRECOMFL
.
GETPRE10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPRE90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPRE80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETPRE20 IF EQUAL
          GOTO      GETPRE20 IF EOS
       
GETPRE20  ADD       ONE,F3
          WRITE     PRECOMAF,SEQ;QRYDATA
          GOTO      GETPRE10
.
GETPRE80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPRE90  MOVE      F3,LASTPRES
          OPEN      PRECOMAF,PRECOMNM
GETPRE99  RETURN
.
.*******************************************************************************
.                 Get Reason for Diversion Comments
.*******************************************************************************
GETDVC00  PREP      DIVERTAF,DIVERTNM
          MOVE      ONE,F3
          WRITE     DIVERTAF,SEQ;QRYDATA
          MOVE      ONE,DIVERTFL
.
GETDVC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETDVC90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETDVC80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETDVC20 IF EQUAL
          GOTO      GETDVC20 IF EOS

GETDVC20  ADD       ONE,F3
          WRITE     DIVERTAF,SEQ;QRYDATA
          GOTO      GETDVC10
.
GETDVC80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
.
GETDVC90  MOVE      F3,LASTDIVT
          OPEN      DIVERTAF,DIVERTNM
.
GETDVC99  RETURN
.
.-------------------------------------------------------------------
.   Add Reason for Diversion text
.------------------------------------------------------------------
ADDDVC00  COMPARE   ZERO,DIVERTFL     * No Comments in Update Ignore
          GOTO      ADDDVC99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,EMDVP005
          MOVE      SP70,EMDVP006
          MOVE      SP70,EMDVP007
          MOVE      SP70,EMDVP008
          MOVE      SP70,EMDVP009
.
ADDDVC10  ADD       ONE,F3
          READ      DIVERTAF,SEQ;REASONDV
          GOTO      ADDDVC80 IF OVER
          STORE     REASONDV,F3,EMDVP005,EMDVP006,EMDVP007,EMDVP008,EMDVP009
          GOTO      ADDDVC10
.
ADDDVC80  MOVE      EMDVP005,EMDVFFL1
          MOVE      EMDVP006,EMDVFFL2
          MOVE      EMDVP007,EMDVFFL3
          MOVE      EMDVP008,EMDVFFL4
          MOVE      EMDVP009,EMDVFFL5
.
ADDDVC99  RETURN
.
.-------------------------------------------------------------------
.   Add Reason for Pre/By-Pass text
.------------------------------------------------------------------
ADDPRE00  COMPARE   ZERO,PRECOMFL     * No Comments in Update Ignore
          GOTO      ADDPRE99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,EMBPS008
          MOVE      SP70,EMBPS009
          MOVE      SP70,EMBPS010
          MOVE      SP70,EMBPS011
          MOVE      SP70,EMBPS012
. 
ADDPRE10  ADD       ONE,F3
          READ      PRECOMAF,SEQ;RESNDATA
          GOTO      ADDPRE80 IF OVER
          STORE     RESNDATA,F3,EMBPS008,EMBPS009,EMBPS010,EMBPS011,EMBPS012
          GOTO      ADDPRE10
.
ADDPRE80  MOVE      EMBPS008,EMBPFFL1
          MOVE      EMBPS009,EMBPFFL2
          MOVE      EMBPS010,EMBPFFL3
          MOVE      EMBPS011,EMBPFFL4
          MOVE      EMBPS012,EMBPFFL5
.
ADDPRE99  RETURN
.
.------------------------------------------------------------
. Diverted Patients Maintenance
.------------------------------------------------------------
EDVP0000  MATCH     SP70,UPDTTYPE
          GOTO      EDVP0700 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      EDVP0100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      EDVP0200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      EDVP0300 IF EQUAL
.
          GOTO      EDVP9000
.
.         ************ ADD FORMACTION **************
.
EDVP0100  CALL      CHKDVP00      * Checks mandatory fields
          BRANCH    EXIT,EDVP9999
.
          PACK      KEY19,EMDVP001,EMDVP002,EMDVP003,SP70
          CALL      RDEMDVP1
          COMPARE   ZERO,OVRCD
          GOTO      EDVP9100 IF EQUAL
.
          CALL      DVSV0000      * Moves input variables to file variables
.
          MOVE      WBSEUID,EMDVUSCR
          CALL      IBACLOCK
          PACK      EMDVDTRC,CCC,CYY,CMM,CDD
          REP       " 0",EMDVDTRC
          PACK      EMDVTMRC,CTIMEIS
          REP       " 0",EMDVTMRC
.
          PACK      KEY19,EMDVP001,EMDVP002,EMDVP003,SP70
          CALL      WREMDVP1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      EDVP9999
.
.         ************ UPDATE FORMACTION **************
.
EDVP0200  PACK      KEY19,EMDVP001,EMDVP002,EMDVP003,SP70
          CALL      RDEMDVP1
          BRANCH    OVRCD,EDVP9200

          MOVE      EMDVP002,EMDVDDTE
          MOVE      EMDVP003,EMDVDTIM
          MOVE      EMDVP004,EMDVRDVN
          MOVE      EMDVP005,EMDVFFL1
          MOVE      EMDVP006,EMDVFFL2
          MOVE      EMDVP007,EMDVFFL3
          MOVE      EMDVP008,EMDVFFL4
          MOVE      EMDVP009,EMDVFFL5
.
          MOVE      WBSEUID,EMDVUSUR
          CALL      IBACLOCK
          PACK      EMDVDTRU,CCC,CYY,CMM,CDD
          REP       " 0",EMDVDTRU
          PACK      EMDVTMRU,CTIMEIS
          REP       " 0",EMDVTMRU
.
          CALL      ADDDVC00
.
          CALL      UPEMDVP1
.
          MOVE      ZERO,EXIT
          GOTO      EDVP9999
.
.         ************ DELETE FORMACTION **************
.
EDVP0300  PACK      KEY19,EMDVP001,EMDVP002,EMDVP003,SP70
          CALL      RDEMDVP1
          BRANCH    OVRCD,EDVP9200

          CALL      DEEMDVP1
          MOVE      ZERO,EXIT
          GOTO      EDVP9999
.
.         ************ UPDATE POPS UP *****************
.
EDVP0700  CALL      CURPER00
          CALL      CALCDT00            * Calculate Next and Last Period Dates
          PACK      KEY19,EMDVP001,EMDVP002,EMDVP003,SP70
          CALL      RDEMDVP1
          IF        OVRCD = 1
            MOVE      SP70,EMDVSTCD
            MOVE      SP70,EMDVDDTE
            MOVE      SP70,EMDVDTIM
            MOVE      SP70,EMDVRDVN
            MOVE      SP70,EMDVFFL1
            MOVE      SP70,EMDVFFL2
            MOVE      SP70,EMDVFFL3
            MOVE      SP70,EMDVFFL4
            MOVE      SP70,EMDVFFL5
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Maintain Diversion Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EDVP9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EDVP9999
.
EDVP9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EDVP9999
.
EDVP9100  MOVE      "Record exists",WEBTITLE     * for add
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EDVP9999
.
EDVP9200  MOVE      "Invalid Date/Time",WEBTITLE  * for update and delete
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EDVP9999
.
EDVP9999  CLOSE     DIVERTAF,DELETE
          RETURN
.
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKDVP00  RESET     EMDVP002
          MATCH     SP70,EMDVP002
          GOTO      CHKDVP90 IF EQUAL
.
          RESET     EMDVP003
          MATCH     SP70,EMDVP003
          GOTO      CHKDVP91 IF EQUAL
.
          RESET     EMDVP004
          MATCH     SP70,EMDVP004
          GOTO      CHKDVP92 IF EQUAL
.
          GOTO      CHKDVP98
.
CHKDVP90  MOVE      "Diverted Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDVP99
.
CHKDVP91  MOVE      "Diverted Time is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDVP99
.
CHKDVP92  MOVE      "Reason for Diversion is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDVP99
.
CHKDVP98  MOVE      ZERO,EXIT
.
CHKDVP99  RETURN
.
.------------------------------------------------------------
. Moves cgi variables into file variables (Diversion Details)
.------------------------------------------------------------
DVSV0000  PACK      EMDVSTCD,EMDVP001,SP10
          PACK      EMDVDDTE,EMDVP002,SP10
          PACK      EMDVDTIM,EMDVP003,SP10
          PACK      EMDVRDVN,EMDVP004,SP10
          PACK      EMDVFFL1,EMDVP005,SP10
          PACK      EMDVFFL2,EMDVP006,SP10
          PACK      EMDVFFL3,EMDVP007,SP10
          PACK      EMDVFFL4,EMDVP008,SP10
          PACK      EMDVFFL5,EMDVP009,SP10
          PACK      EMDVUSCR,EMDVP010,SP10
          PACK      EMDVDTRC,EMDVP011,SP10
          PACK      EMDVTMRC,EMDVP012,SP10
          PACK      EMDVUSUR,EMDVP013,SP10
          PACK      EMDVDTRU,EMDVP014,SP10
          PACK      EMDVTMRU,EMDVP015,SP10
          CALL      ADDDVC00
.
DVSV9999  RETURN
+
.------------------------------------------------------------
. Check for Overlapping Records When Adding New By-Pass / Pre By-Pass Records
.------------------------------------------------------------
CHKBYP00  MOVE      ZERO,EXIT
          MOVE      SP70,SAVKEY20
.
          PACK      WORKDATE,CCC,CYY,CMM,CDD  * Set up current date
          REP       " 0",WORKDATE
          SUB       THIRTY,WORKDATE           * Set last 30 days of Curr date  
.
          PACK      KEY20,EMBPS001,Z70
          CALL      RSEMBPS2
CHKBYP10  CALL      RPEMBPS2
          BRANCH    OVRCD,CHKBYP95
          PACK      SAVKEY20,EMBPSTCD,EMBPONDT,EMBPONTM,EMBPPTYP,SP70
.
          MATCH     EMBPS001,EMBPSTCD
          GOTO      CHKBYP95 IF NOT EQUAL  * exit if Emerg sites don't match
.
          MATCH     WORKDATE,EMBPONDT
          GOTO      CHKBYP95 IF LESS       * exit if it passes 30 days period
.
          PACK      KEY20,EMBPS001,EMBPS003,EMBPS004,ZERO,SP70
          CALL      RAEMBPS2
          IF        OVRCD=0
            GOTO      CHKBYP80   * error if pre-bypass record already exists
          ENDIF
          PACK      KEY20,EMBPS001,EMBPS003,EMBPS004,ONE,SP70
          CALL      RAEMBPS2
          IF        OVRCD=0      
            GOTO      CHKBYP80   * error if bypass record already exists
          ENDIF
.
... Setup combined date/time variables
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPONTM,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      ONDATTIM,EMBPONDT,XXHOUR,XXMIN,XXSEC,SP70 * on dat/tim
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPOFTM,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      OFDATTIM,EMBPOFDT,XXHOUR,XXMIN,XXSEC,SP70 * off dat/tim
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPS004,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons 
          PACK      NWONDTTM,EMBPS003,XXHOUR,XXMIN,XXSEC,SP70 * new on dat/tim  
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPS007,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      NWOFDTTM,EMBPS006,XXHOUR,XXMIN,XXSEC,SP70 * new off dat/tim
.
... Check if new ON date/time overlaps the bypass range
          MOVE      ZERO,ONFLAG1
          MATCH     ONDATTIM,NWONDTTM     * match on dat/tim to new on dat/tim
          IF        !@LESS | @EQUAL
            MATCH     OFDATTIM,SP70       * is off dat/tim blank - active bypass
            IF        @EQUAL
              GOTO      CHKBYP87
            ELSE
              MATCH     OFDATTIM,NWONDTTM * match off dat/tim to new on dat/tim
              IF        @LESS | @EQUAL
                MOVE      ONE,ONFLAG1
              ENDIF
            ENDIF
          ELSE
            MATCH     NWOFDTTM,SP70
            GOTO      CHKBYP85 IF EQUAL * exit if entering a prev active bypass
            MATCH     ONDATTIM,NWOFDTTM
            IF        !@LESS | @EQUAL
              GOTO      CHKBYP85
            ENDIF
          ENDIF
.
          IF        ONFLAG1=1
            GOTO      CHKBYP85   * exit if new on dt/tm overlaps this bypass
          ENDIF
.
... Check if new OFF date/time overlaps the bypass range
          MOVE      ZERO,OFFLAG1
          MATCH     ONDATTIM,NWOFDTTM
          IF        !@LESS | @EQUAL
            MATCH     OFDATTIM,SP70
            IF        @EQUAL
              MOVE      ONE,OFFLAG1
            ENDIF
            MATCH     OFDATTIM,NWOFDTTM
            IF        @LESS | @EQUAL
              MOVE      ONE,OFFLAG1
            ENDIF
          ENDIF
.
          IF        OFFLAG1=1 
            GOTO      CHKBYP85   * exit if new off dt/tm overlaps this bypass
          ENDIF
.
          MOVE      SAVKEY20,KEY20
          CALL      RAEMBPS2                * reposition table read
          GOTO      CHKBYP10                * check next bypass record
.
CHKBYP80  MOVE      "A Bypass Record With This ON Date/Time Already Exists!",WEBTITLE
          GOTO      CHKBYP90
.
CHKBYP85  MATCH     "0",EMBPPTYP            * Pre By-Pass
          IF        @EQUAL
            MOVE      "Can't Overlap With Pre By-Pass Record!",WEBTITLE
            GOTO      CHKBYP90
          ENDIF
.
          MATCH     "1",EMBPPTYP            * By-Pass
          IF        @EQUAL
            MOVE      "Can't Overlap With By-Pass Record!",WEBTITLE
            GOTO      CHKBYP90
          ENDIF
.
          GOTO      CHKBYP95
.
CHKBYP87  MATCH     "0",EMBPPTYP            * Pre By-Pass
          IF        @EQUAL
            MOVE      "Current Pre By-Pass Record Exists!",WEBTITLE
            GOTO      CHKBYP90
          ENDIF
.
          MATCH     "1",EMBPPTYP            * By-Pass
          IF        @EQUAL
            MOVE      "Current By-Pass Record Exists!",WEBTITLE
            GOTO      CHKBYP90
          ENDIF
.
          GOTO      CHKBYP95
.
CHKBYP90  CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKBYP99
.
CHKBYP95  MOVE      ZERO,EXIT
.
CHKBYP99  RETURN
+
.------------------------------------------------------------
. Check for Overlapping Records When Updating By-Pass / Pre By-Pass Records
.------------------------------------------------------------
CHKBYU00  MOVE      ZERO,EXIT
          MOVE      SP70,SAVKEY20
.
          PACK      WORKDATE,CCC,CYY,CMM,CDD  * Set up current date
          REP       " 0",WORKDATE
          SUB       THIRTY,WORKDATE           * Set last 30 days of Curr date
.
          PACK      KEY20,EMBPS001,Z70
          CALL      RSEMBPS2
CHKBYU10  CALL      RPEMBPS2
          BRANCH    OVRCD,CHKBYU95
          PACK      SAVKEY20,EMBPSTCD,EMBPONDT,EMBPONTM,EMBPPTYP,SP70
.
          MATCH     EMBPS001,EMBPSTCD
          GOTO      CHKBYU95 IF NOT EQUAL  * exit if Emerg sites don't match
.
          MATCH     WORKDATE,EMBPONDT
          GOTO      CHKBYP95 IF LESS       * exit if it passes 30 days period
.
          PACK      DIM20,EMBPS001,EMBPPTYP,EMBPONDT,EMBPONTM,SP70
          MATCH     DIM20,RECORDKY
          IF        @EQUAL
            GOTO      CHKBYU70   * go to next record if checking itself
          ENDIF
.
... Setup combined date/time variables
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPONTM,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      ONDATTIM,EMBPONDT,XXHOUR,XXMIN,XXSEC,SP70 * on dat/tim
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPOFTM,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      OFDATTIM,EMBPOFDT,XXHOUR,XXMIN,XXSEC,SP70 * off dat/tim
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPS004,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons 
          PACK      NWONDTTM,EMBPS003,XXHOUR,XXMIN,XXSEC,SP70 * new on dat/tim  
          UNPACK    SP70,XXHOUR,D1,XXMIN,DIM1,XXSEC           * clear vars
          UNPACK    EMBPS007,XXHOUR,D1,XXMIN,DIM1,XXSEC       * remove colons
          PACK      NWOFDTTM,EMBPS006,XXHOUR,XXMIN,XXSEC,SP70 * new off dat/tim
.
... Check if new ON date/time overlaps the bypass range
          MOVE      ZERO,ONFLAG1
          MATCH     ONDATTIM,NWONDTTM     * match on dat/tim to new on dat/tim
          IF        !@LESS | @EQUAL
            MATCH     OFDATTIM,SP70       * is off dat/tim blank - active bypass
            IF        @EQUAL
              GOTO      CHKBYU87
            ELSE
              MATCH     OFDATTIM,NWONDTTM * match off dat/tim to new on dat/tim
              IF        @LESS | @EQUAL
                MOVE      ONE,ONFLAG1
              ENDIF
            ENDIF
          ELSE
            MATCH     NWOFDTTM,SP70
            GOTO      CHKBYU85 IF EQUAL * exit if entering a prev active bypass
            MATCH     ONDATTIM,NWOFDTTM
            IF        !@LESS | @EQUAL
              GOTO      CHKBYU85
            ENDIF
          ENDIF
.
          IF        ONFLAG1=1
            GOTO      CHKBYU85   * exit if new on dt/tm overlaps this bypass
          ENDIF
.
... Check if new OFF date/time overlaps the bypass range
          MOVE      ZERO,OFFLAG1
          MATCH     ONDATTIM,NWOFDTTM
          IF        !@LESS | @EQUAL
            MATCH     OFDATTIM,SP70
            IF        @EQUAL
              MOVE      ONE,OFFLAG1
            ENDIF
            MATCH     OFDATTIM,NWOFDTTM
            IF        @LESS | @EQUAL
              MOVE      ONE,OFFLAG1
            ENDIF
          ENDIF
.
          IF        OFFLAG1=1 
            GOTO      CHKBYU85   * exit if new off dt/tm overlaps this bypass
          ENDIF
.
CHKBYU70  MOVE      SAVKEY20,KEY20
          CALL      RAEMBPS2                * reposition table read
          GOTO      CHKBYU10                * check next bypass record
.
CHKBYU80  MOVE      "A Bypass Record With This ON Date/Time Already Exists!",WEBTITLE
          GOTO      CHKBYU90
.
CHKBYU85  MATCH     "0",EMBPPTYP            * Pre By-Pass
          IF        @EQUAL
            MOVE      "Can't Overlap With Pre By-Pass Record!",WEBTITLE
            GOTO      CHKBYU90
          ENDIF
.
          MATCH     "1",EMBPPTYP            * By-Pass
          IF        @EQUAL
            MOVE      "Can't Overlap With By-Pass Record!",WEBTITLE
            GOTO      CHKBYU90
          ENDIF
.
          GOTO      CHKBYU95
.
CHKBYU87  MATCH     "0",EMBPPTYP            * Pre By-Pass
          IF        @EQUAL
            MOVE      "Current Pre By-Pass Record Exists!",WEBTITLE
            GOTO      CHKBYU90
          ENDIF
.
          MATCH     "1",EMBPPTYP            * By-Pass
          IF        @EQUAL
            MOVE      "Current By-Pass Record Exists!",WEBTITLE
            GOTO      CHKBYU90
          ENDIF
.
          GOTO      CHKBYU95
.
CHKBYU90  CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKBYU99
.
CHKBYU95  MOVE      ZERO,EXIT
.
CHKBYU99  RETURN
+
.------------------------------------------------------------
. By-Pass Maintenance
.------------------------------------------------------------
EBPS0000  MATCH     SP70,UPDTTYPE
          GOTO      EBPS0700 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      EBPS0100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      EBPS0200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      EBPS0300 IF EQUAL
.
          GOTO      EBPS9000
.
.         ************ ADD FORMACTION **************
.
EBPS0100  CALL      CHKBYP00      * Checks latest record / any record overlaps
          BRANCH    EXIT,EBPS9999 
.
          CALL      CHKSIT00      * Checks mandatory fields
          BRANCH    EXIT,EBPS9999
.
          CALL      CDSV0000      * Moves input variables to file variables
.
          MOVE      WBSEUID,EMBPUSCR
          CALL      IBACLOCK
          PACK      EMBPDTRC,CCC,CYY,CMM,CDD
          REP       " 0",EMBPDTRC
          PACK      EMBPTMRC,CTIMEIS
          REP       " 0",EMBPTMRC
.
          PACK      KEY20,EMBPSTCD,EMBPPTYP,EMBPONDT,EMBPONTM,SP70
          CALL      WREMBPS1      * Writes away the data
.
          CALL      PREP0000      * Print report schedule
.
          MOVE      ZERO,EXIT
          GOTO      EBPS9999
.
.         ************ UPDATE FORMACTION **************
.
EBPS0200  CALL      CHKBYU00      * Checks for overlapping bypass records
          BRANCH    EXIT,EBPS9999
.
          PACK      KEY20,RECORDKY,SP70
          CALL      RDEMBPS1
          BRANCH    OVRCD,EBPS9200
.
          MOVE      EMBPS003,EMBPONDT
          MOVE      EMBPS004,EMBPONTM
          MOVE      EMBPS005,EMBPRSON
          MOVE      EMBPS006,EMBPOFDT
          MOVE      EMBPS007,EMBPOFTM
          MOVE      EMBPS008,EMBPFFL1
          MOVE      EMBPS009,EMBPFFL2
          MOVE      EMBPS010,EMBPFFL3
          MOVE      EMBPS011,EMBPFFL4
          MOVE      EMBPS012,EMBPFFL5
          MOVE      EMBPS013,EMBPNAMB
          MOVE      EMBPS020,EMBPAHCP
          MOVE      EMBPS021,EMBPFFNA
          MOVE      EMBPS022,EMBPFFCA
.
          MOVE      WBSEUID,EMBPUSUR
          CALL      IBACLOCK
          PACK      EMBPDTRU,CCC,CYY,CMM,CDD
          REP       " 0",EMBPDTRU
          PACK      EMBPTMRU,CTIMEIS
          REP       " 0",EMBPTMRU
.          
          CALL      ADDPRE00
.
          CALL      UPEMBPS1           * Update bypass record
.
          CALL      PREP0000      
.          
          MOVE      ZERO,EXIT
          GOTO      EBPS9999
.
.         ************ DELETE FORMACTION **************
.
EBPS0300  PACK      KEY20,RECORDKY,SP70
          CALL      RDEMBPS1
          BRANCH    OVRCD,EBPS9200

          CALL      DEEMBPS1
          MOVE      ZERO,EXIT
          GOTO      EBPS9999
.
.         ************ UPDATE POPS UP *****************
.
EBPS0700  CALL      CURPER00
          CALL      CALCDT00            * Calculate Next and Last Period Dates

          PACK      KEY20,EMBPS001,EMBPS002,EMBPS003,EMBPS004,SP70
          CALL      RDEMBPS1
          IF        OVRCD = 1
            MOVE      SP70,EMBPSTCD
            MOVE      SP70,EMBPPTYP
            MOVE      SP70,EMBPONDT
            MOVE      SP70,EMBPONTM
            MOVE      SP70,EMBPRSON
            MOVE      SP70,EMBPOFDT
            MOVE      SP70,EMBPOFTM
            MOVE      SP70,EMBPFFL1
            MOVE      SP70,EMBPFFL2
            MOVE      SP70,EMBPFFL3
            MOVE      SP70,EMBPFFL4
            MOVE      SP70,EMBPFFL5
            MOVE      SP70,EMBPNAMB
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Maintain By-Pass Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EBPS9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      EBPS9999
.
EBPS9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EBPS9999
.
EBPS9200  MOVE      "Invalid Selection",WEBTITLE  * for update and delete
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EBPS9999
.
EBPS9999  CLOSE     PRECOMAF,DELETE
          RETURN
.
.------------------------------------------------------------
. * Print Schedule for Pre/By-Pass Fields
.------------------------------------------------------------
.
PREP0000  MATCH    "0",PRINTCHK
          GOTO     PREP9999 IF EQUAL

          MOVE      "IBAEMR07",SCHDPGID
.
          MATCH     "0",EMBPPTYP 
          IF        @EQUAL      
            MOVE      "Pre By-Pass ED Status",SCHDDESC
          ELSE
            MOVE      "By-Pass ED Status",SCHDDESC
          ENDIF
.
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters for Extract
.
          MOVE      ONE,KEYSTARR[1]         * Option
.
          MOVE      ONE,KEYSTARR[2]         * Selected By Pass Report
.
          PACK      KEYSTARR[3],EMBPSTCD,EMBPPTYP,EMBPONDT,EMBPONTM,SP70
.
          MOVE      ANSY,KEYSTARR[4]        * Yes- Run Report
          MOVE      FOUR,KEYSTCNT           * Number of Keyins
.
          CALL      SCHPRO00                * Schedule Report 
.
          MATCH     "S  ",SCHDPRNT          * Schedule a spooled report
          IF        !@EQUAL
            MOVE      "S  ",SCHDPRNT
            CALL      SCHPRO00              * Schedule Report
          ENDIF
.
PREP9999  RETURN
.
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKSIT00  RESET     EMBPS001
          MATCH     SP70,EMBPS001
          GOTO      CHKSIT93 IF EQUAL
.
          RESET     EMBPS003
          MATCH     SP70,EMBPS003
          GOTO      CHKSIT90 IF EQUAL
.
          RESET     EMBPS004
          MATCH     SP70,EMBPS004
          GOTO      CHKSIT91 IF EQUAL
.
          RESET     EMBPS005
          MATCH     SP70,EMBPS005
          GOTO      CHKSIT92 IF EQUAL
.
          GOTO      CHKSIT98
.
CHKSIT90  MOVE      "On Pre/By-Pass Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSIT99
.
CHKSIT91  MOVE      "On Pre/By-Pass Time is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSIT99
.
CHKSIT92  MOVE      "Reason for Pre/By Pass is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSIT99
.
CHKSIT93  MOVE      "Emergency Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSIT99
.
CHKSIT98  MOVE      ZERO,EXIT
.
CHKSIT99  RETURN
.
.------------------------------------------------------------
. Moves cgi variables into file variables (Pre By-Pass Details)
.------------------------------------------------------------
CDSV0000  PACK      EMBPSTCD,EMBPS001,SP10
          PACK      EMBPPTYP,EMBPS002,SP10
          PACK      EMBPONDT,EMBPS003,SP10
          PACK      EMBPONTM,EMBPS004,SP10
          PACK      EMBPRSON,EMBPS005,SP10
          PACK      EMBPOFDT,EMBPS006,SP10
          PACK      EMBPOFTM,EMBPS007,SP10
          PACK      EMBPFFL1,EMBPS008,SP30
          PACK      EMBPFFL2,EMBPS009,SP30
          PACK      EMBPFFL3,EMBPS010,SP30
          PACK      EMBPFFL4,EMBPS011,SP30
          PACK      EMBPFFL5,EMBPS012,SP30
          PACK      EMBPNAMB,EMBPS013,SP10
          PACK      EMBPUSCR,EMBPS014,SP10
          PACK      EMBPDTRC,EMBPS015,SP10
          PACK      EMBPTMRC,EMBPS016,SP10
          PACK      EMBPUSUR,EMBPS017,SP10
          PACK      EMBPDTRU,EMBPS018,SP10
          PACK      EMBPTMRU,EMBPS019,SP10
          PACK      EMBPAHCP,EMBPS020,SP10
          PACK      EMBPFFNA,EMBPS021,SP10
          PACK      EMBPFFCA,EMBPS022,SP10
          CALL      ADDPRE00
.
CDSV9999  RETURN
+
.------------------------------------------------------------
. Store Matrix Fields
.------------------------------------------------------------
STMTX000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMTX001,STMTX002,STMTX003
.
STMTX001  MOVE      QRYDATA,EMRMX001
          GOTO      STMTX999
.
STMTX002  MOVE      QRYDATA,EMRMX002
          GOTO      STMTX999
.
STMTX003  MOVE      QRYDATA,EMRMX003
          GOTO      STMTX999
.
STMTX999  RETURN
.------------------------------------------------------------
. Store Save Matrix Fields
.------------------------------------------------------------
SVMTX000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SVMTX001,SVMTX002,SVMTX003
.
SVMTX001  MOVE      QRYDATA,SERMX001
          GOTO      SVMTX999
.
SVMTX002  MOVE      QRYDATA,SERMX002
          GOTO      SVMTX999
.
SVMTX003  MOVE      QRYDATA,SERMX003
          GOTO      SVMTX999
.
SVMTX999  RETURN      
.        
. HPS Code Starts Here
.-----------------------------------------------------------
. Get Emergency Comments
.------------------------------------------------------------
GETCMT00  PACK      QRYDATA,QRYDATA,SP70,SP70
          MATCH     SP70,QRYDATA
          GOTO      GETCMT10 IF EQUAL
.
          ADD       ONE,EMCMTIDX
          MOVE      QRYDATA,EMCMT001[EMCMTIDX]
          RESET     EMCMT001[EMCMTIDX]
.
GETCMT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETCMT99 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETCMT80 IF NOT EQUAL
.
          IF        EMCMTIDX >= 99
            GOTO      GETCMT10                   * Skip and read until the end
          ENDIF                                  * so all flags are set
.
          ADD       ONE,EMCMTIDX                 * Increment Array Counter
.
          PACK      EMCMT001[EMCMTIDX],QRYDATA,SP70 * Input Note to Array
          GOTO      GETCMT10
.
GETCMT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMT99  RETURN    
.                          
. HPS Code Ends Here
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40:   * HPS01I
                             PROFLD50
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  CALL      MTXF0000
          GOTO      PROFLD99
.
. HPS Code Starts Here
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      CMTF0000
          GOTO      PROFLD99
. HPS Code Ends Here
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99

PROFLD31  CALL      PBPS0000       * Emergency Pre By-Pass
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41
          GOTO      PROFLD99

PROFLD41  CALL      DVPT0000       * Emergency Diversion 
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99

PROFLD51  CALL      SCMT0000       * Site-based Comments/Notices
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. Diverted Patients Tags
.------------------------------------------------------------
.
DVPT0000  BRANCH    FLDITMNO,DVPT0100,DVPT0200,DVPT0300,DVPT0400,DVPT0500:
                             DVPT0600,DVPT0700,DVPT0800,DVPT0900,DVPT1000:
                             DVPT1100,DVPT1200,DVPT1300,DVPT1400,DVPT1500:
                             DVPT1600,DVPT1700,DVPT1800,DVPT1900,DVPT2000:
                             DVPT2100
          GOTO      DVPT9999
.
DVPT0100  CALL      NEXT0000    * Link to next day, week, month
          GOTO      DVPT9999
.
DVPT0200  CALL      PREV0000    * Link to previous day, week, month
          GOTO      DVPT9999
.
DVPT0300  CALL      CURSTD00    * Current start date
          GOTO      DVPT9999
.
DVPT0400  CALL      CUREND00    * Current End Date
          GOTO      DVPT9999
.
DVPT0500  CALL      CURYR000    * Current Year
          GOTO      DVPT9999
.
DVPT0600  CALL      CURMON00    * Current month name
          GOTO      DVPT9999
.
DVPT0700  CALL      SELV0000    * Select Date Options
          GOTO      DVPT9999
.
DVPT0800  CALL      DIVP0000          * diverted patients details
          GOTO      DVPT9999
.
DVPT0900  WRITE     HTMLFILE;TEMPLATE;  * Template no
          GOTO      DVPT9999
.
DVPT1000  WRITE     HTMLFILE;REPORTNO;  * Report no
          GOTO      DVPT9999
.
DVPT1100  WRITE     HTMLFILE;VIEWTYPE;  * View type
          GOTO      DVPT9999
.
DVPT1200  MATCH     EMDVDDTE,SP70
          GOTO      DVPT9999 IF EQUAL
          UNPACK    EMDVDDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DVPT9999
.
DVPT1300  WRITE     HTMLFILE;EMDVDTIM;
          GOTO      DVPT9999
.
DVPT1400  MOVE      "el",CATEGORY  * reason for diversion
          MOVE      EMDVRDVN,CODE
          CALL      CODITM00
          GOTO      DVPT9999
.
DVPT1500  WRITE     HTMLFILE;EMDVFFL1;
          GOTO      DVPT9999
.
DVPT1600  WRITE     HTMLFILE;EMDVFFL2;
          GOTO      DVPT9999
.
DVPT1700  WRITE     HTMLFILE;EMDVFFL3;
          GOTO      DVPT9999
.
DVPT1800  WRITE     HTMLFILE;EMDVFFL4;
          GOTO      DVPT9999
.
DVPT1900  WRITE     HTMLFILE;EMDVFFL5;
          GOTO      DVPT9999
.
DVPT2000  WRITE     HTMLFILE;EMDVSTCD;
          GOTO      DVPT9999
.
DVPT2100  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DVPT9999
.
          WRITE     HTMLFILE;WBSEESC;           * Web User Emergency Site
          GOTO      DVPT9999
.
DVPT9999  RETURN
.
.------------------------------------------------------------
. Pre By-Pass Tags
.------------------------------------------------------------
.
PBPS0000  BRANCH    FLDITMNO,PBPS0100,PBPS0200,PBPS0300,PBPS0400,PBPS0500:
                             PBPS0600,PBPS0700,PBPS0800,PBPS0900,PBPS1000:
                             PBPS1100,PBPS1200,PBPS1300,PBPS1400,PBPS1500:
                             PBPS1600,PBPS1700,PBPS1800,PBPS1900,PBPS2000:
                             PBPS2100,PBPS2200,PBPS2300,PBPS2400,PBPS2500:
                             PBPS2600,PBPS2700,PBPS2800,PBPS2900,PBPS3000:
                             PBPS3100,PBPS3200,PBPS3300,PBPS3400
          GOTO      PBPS9999
.
PBPS0100  CALL      NEXT0000    * Link to next day, week, month 
          GOTO      PBPS9999
.
PBPS0200  CALL      PREV0000    * Link to previous day, week, month
          GOTO      PBPS9999
.
PBPS0300  CALL      CURSTD00    * Current start date
          GOTO      PBPS9999
.
PBPS0400  CALL      CUREND00    * Current End Date
          GOTO      PBPS9999
.
PBPS0500  CALL      CURYR000    * Current Year
          GOTO      PBPS9999
.
PBPS0600  CALL      CURMON00    * Current month name
          GOTO      PBPS9999
.
PBPS0700  CALL      SELV0000    * Select Date Options
          GOTO      PBPS9999
.
PBPS0800  CALL      PRDS0000          * pre by-pass details
          GOTO      PBPS9999
.
PBPS0900  WRITE     HTMLFILE;TEMPLATE;  * Template no 
          GOTO      PBPS9999
.
PBPS1000  WRITE     HTMLFILE;REPORTNO;  * Report no
          GOTO      PBPS9999
.
PBPS1100  WRITE     HTMLFILE;VIEWTYPE;  * View type
          GOTO      PBPS9999
.
PBPS1200  MATCH     "1",EMBPPTYP
          IF        @EQUAL
            MOVE      "By-Pass",EMBPTYPE           * by-pass type
            WRITE     HTMLFILE;EMBPTYPE;
           ELSE
            MOVE      "Pre By-Pass",EMBPTYPE
            WRITE     HTMLFILE;EMBPTYPE;
          ENDIF
          GOTO      PBPS9999
.
PBPS1300  MATCH     EMBPONDT,SP70
          GOTO      PBPS9999 IF EQUAL
          UNPACK    EMBPONDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PBPS9999
.
PBPS1400  WRITE     HTMLFILE;EMBPONTM;
          GOTO      PBPS9999
.
PBPS1500  MOVE      "qa",CATEGORY
          MOVE      EMBPRSON,CODE
          CALL      CODITM00
          GOTO      PBPS9999
.
PBPS1600  MATCH     EMBPOFDT,SP70
          GOTO      PBPS9999 IF EQUAL
.
          UNPACK    EMBPOFDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PBPS9999
.
PBPS1700  WRITE     HTMLFILE;EMBPOFTM;
          GOTO      PBPS9999
.
PBPS1800  WRITE     HTMLFILE;EMBPFFL1;
          GOTO      PBPS9999
.
PBPS1900  WRITE     HTMLFILE;EMBPFFL2;
          GOTO      PBPS9999
.
PBPS2000  WRITE     HTMLFILE;EMBPFFL3;
          GOTO      PBPS9999
.
PBPS2100  WRITE     HTMLFILE;EMBPFFL4;
          GOTO      PBPS9999
.
PBPS2200  WRITE     HTMLFILE;EMBPFFL5;
          GOTO      PBPS9999
.
PBPS2300  WRITE     HTMLFILE;EMBPNAMB;
          GOTO      PBPS9999
.
PBPS2400  WRITE     HTMLFILE;EMBPSTCD;
          GOTO      PBPS9999
.
PBPS2500  WRITE     HTMLFILE;EMBPPTYP;  * By-Pass type
          GOTO      PBPS9999
.
PBPS2600  WRITE     HTMLFILE;PASSTYPE;  * By-Pass filter
          GOTO      PBPS9999
.
PBPS2700  WRITE     HTMLFILE;FRSTDATE;                          
          GOTO      PBPS9999
.
PBPS2800  WRITE     HTMLFILE;LASTDATE;                    
          GOTO      PBPS9999
.
PBPS2900  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PBPS9999
          WRITE     HTMLFILE;WBSEESC;           * Web User Emergency Site
          GOTO      PBPS9999
.
PBPS3000  WRITE     HTMLFILE;EMBPSTCD,EMBPPTYP,EMBPONDT,EMBPONTM;
          GOTO      PBPS9999
.
PBPS3100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PBPS3101
.
          WRITE     HTMLFILE;EMBPAHCP;
          GOTO      PBPS9999
.
PBPS3101  MOVE      SP70,DOCFNAME
          PACK      KEY10,EMBPAHCP,SP30
          CALL      RDPMHCP1
          BRANCH    OVRCD,PBPS9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PBPS9999
.
PBPS3200  WRITE     HTMLFILE;EMBPFFNA;
          GOTO      PBPS9999
.
PBPS3300  WRITE     HTMLFILE;EMBPFFCA;
          GOTO      PBPS9999
.
PBPS3400  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PBPS9999
.
          PACK      KEY3,WBSEESC,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,PBPS9999
.
          WRITE     HTMLFILE;EMSTDESC;          * Emergency Site Description
          GOTO      PBPS9999
.
PBPS9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=post >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=viewtype value=",KEY1,">"
.
          CALL      SELC0000
.
          WRITE     HTMLFILE;"<input type=submit value=Go>":
                             "</form>"
.
SELDAT99  RETURN
.
.------------------------------------------------------------
. Selects Day, Week or Month from Viewtype
.------------------------------------------------------------
SELC0000  MATCH     "1",VIEWTYPE
          GOTO      SELC2000 IF EQUAL
          MATCH     "2",VIEWTYPE
          GOTO      SELC4000 IF EQUAL
.
.Defaults to Daily Viewtype
.--------------------------
.
          WRITE     HTMLFILE;"<select name=dateselc> "
..                             "onChange=#"GoDate(this);#">";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "6",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-6",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
SELC1000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      CCYY,CCENT,CYEAR
          REP       " 0",CCYY
          MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                               DAYNAM,SP1,CDAY,SP1,MTHNAM,SP1,CCYY,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                               DAYNAM,SP1,CDAY,SP1,MTHNAM,SP1,CCYY,"</option>"
          ENDIF
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELC1000 IF NOT EQUAL
          GOTO      SELC9000
.
.Select Weekly Viewtype
.--------------------------
SELC2000  WRITE     HTMLFILE;"<select name=dateselc>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.
SELC3000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>Week of ":
                               CDAY,SP1,MTHNAM,SP1,CCENT,CYEAR,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                               CDAY,SP1,MTHNAM,SP1,CCENT,CYEAR,"</option>";
          ENDIF
          MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELC3000 IF NOT EQUAL
          GOTO      SELC9000
.
.
.Select Monthly Viewtype
.------------------------
.
SELC4000  WRITE     HTMLFILE;"<select name=dateselc>";
          UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<0
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
SELC5000  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
          MATCH     KEY6,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                               MTHNAM,SP1,F4,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY6,">":
                               MTHNAM,SP1,F4,"</option>";
          ENDIF
          ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      SELC5000 IF NOT EQUAL
.
SELC9000  WRITE     HTMLFILE;"</select>"
          RETURN
.
.-------------------------------------------------------------
. Reason for Diversion Selection List
.-------------------------------------------------------------
.
. get diversion list (cat el)
.
RSDV0000  MOVE      "el",KEY2
          PACK      KEY5,KEY2,SP5
          CALL      RDSCODE1
RSDV1000  CALL      RDKCODE1
          BRANCH    OVRCD,RSDV9999
.
          MATCH     KEY2,TCODE
          GOTO      RSDV9999 IF NOT EQUAL
.
          MATCH     TDESC,SP20
          GOTO      RSDV1000 IF EQUAL

          MATCH     EMDVRDVN,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ACODE," selected>":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ACODE,">",TDESC,"</option>"
          ENDIF
.
          GOTO      RSDV1000
.
RSDV9999  RETURN
.
.------------------------------------------------------------
. Table of Diverted Patients
.------------------------------------------------------------
DIVP0000  PACK      KEY19,STARTKEY,SP70
          CALL      RSEMDVP1
DIVP1000  CALL      RKEMDVP1
          BRANCH    OVRCD,DIVP9999
.
          MATCH     FRSTDATE,EMDVDDTE
          GOTO      DIVP1000 IF LESS
.
          MATCH     EMDVDDTE,LASTDATE
          GOTO      DIVP1000 IF LESS
.
          CALL      DESC0000      * Get Reason for Diversion Description
          CALL      PRDVN000      * Display Diverted Patients Row
          GOTO      DIVP1000
.
DIVP9999  RETURN
.
.------------------------------------------------------------
. Reason for Diversion Description
.------------------------------------------------------------
.
DESC0000  MOVE      "el",KEY2
          PACK      KEY5,KEY2,SP5
          CALL      RDSCODE1
DESC1000  CALL      RDKCODE1
          BRANCH    OVRCD,DESC9999
.
          MATCH     KEY2,TCODE
          GOTO      DESC9999 IF NOT EQUAL
.
          MATCH     TDESC,SP20
          GOTO      DESC1000 IF EQUAL
.
          MATCH     EMDVRDVN,ACODE
          GOTO      DESC1000 IF NOT EQUAL
.
          MOVE      TDESC,DESCRIPT
.
DESC9999  RETURN
.
.------------------------------------------------------------
. Diverted Patients (TABLE ROW)
.------------------------------------------------------------
PRDVN000  CLEAR     HTMLLINK
          APPEND    "javascript:Update('",HTMLLINK
          APPEND    EMDVSTCD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMDVDDTE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMDVDTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMDVSTCD,"#",":               * 1
                             "#"",EMDVDDTE,"#",":               
                             "#"",EMDVDTIM,"#",":
                             "#"",EMDVRDVN,"#",":
                             "#"",EMDVFFL1,"#",":               * 5
                             "#"",EMDVFFL2,"#",":               
                             "#"",EMDVFFL3,"#",":               
                             "#"",EMDVFFL4,"#",":
                             "#"",EMDVFFL5,"#",":
                             "#"",DESCRIPT,"#");"

.                             "#"",EMDVFFL5,"#");"
.
PRDVN999 RETURN
.
.--------------------------------------------------------------------------
. Table of Pre By-Pass : Listing of records  wrt to only User's Site Code
. By-Pass records are listed only within the 30 days prior to the FRSTDATE
.--------------------------------------------------------------------------
PRDS0000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PRDS9999
          MOVE      WBSEESC,USRSITID      * User's Site Code
.
          MOVE      FRSTDATE,WORKDATE     
          REP       " 0",WORKDATE
          SUB       THIRTY,WORKDATE       * Set date range to be 30 days prior
.
          PACK      KEY20,USRSITID,WORKDATE,SP70
          CALL      RSEMBPS2
PRDS1000  CALL      RKEMBPS2
          BRANCH    OVRCD,PRDS9999
.
          MATCH     USRSITID,EMBPSTCD      * exit if different Site Code
          GOTO      PRDS9999 IF NOT EQUAL
.
          MATCH     SP70,PASSTYPE
          GOTO      PRDS1500 IF EQUAL         
.
          MATCH     EMBPPTYP,PASSTYPE
          GOTO      PRDS1000 IF NOT EQUAL  
.
PRDS1500  MATCH     FRSTDATE,EMBPONDT
          GOTO      PRDS1600 IF LESS
          GOTO      PRDS1700
.
.  special case for bypass records that begin before out firstdate
.  but may still be current. 
PRDS1600  MATCH     SP70,EMBPOFDT           * open ended bypass? 
          GOTO      PRDS2000 IF EQUAL       * it's in
          MATCH     FRSTDATE,EMBPOFDT       * end's after startdate ?
          GOTO      PRDS2000 IF NOT LESS    * also in
          GOTO      PRDS1000                * too early, get next
. 
PRDS1700  MATCH     EMBPONDT,LASTDATE
          GOTO      PRDS1000 IF LESS
.
PRDS2000  CALL      PRROW000      * Display Pre By-Pass Row
          GOTO      PRDS1000 
.
PRDS9999  RETURN
.
.------------------------------------------------------------
. Pre By-Pass (TABLE ROW)
.------------------------------------------------------------
PRROW000  MATCH     "1",EMBPPTYP
          IF        @EQUAL
            MOVE      "By-Pass",EMBPTYPE           * by-pass type
          ELSE
            MOVE      "Pre By-Pass",EMBPTYPE
          ENDIF
.  
PRROW100  MOVE      "qa",KEY2                      * reason
          PACK      KEY5,KEY2,SP5
          CALL      RDSCODE1
PRROW200  CALL      RDKCODE1
          BRANCH    OVRCD,PRROW800
.
          MATCH     KEY2,TCODE
          GOTO      PRROW800 IF NOT EQUAL
.
          MATCH     EMBPRSON,ACODE
          IF        @EQUAL
            MOVE      TDESC,EBPSRSON
            GOTO      PRROW900
          ELSE
            GOTO      PRROW200
          ENDIF
.
PRROW800  MOVE      SP20,EBPSRSON
.           
PRROW900  CLEAR     HTMLLINK
          APPEND    "javascript:Update('",HTMLLINK
          APPEND    EMBPSTCD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMBPPTYP,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMBPONDT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMBPONTM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,EMBPAHCP,SP30
          CALL      RDPMHCP1
          IF        OVRCD <> 1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EMBPSTCD,"#",":               * 1
                             "#"",EMBPTYPE,"#",":               
                             "#"",EMBPONDT,"#",":
                             "#"",EMBPONTM,"#",":
                             "#"",EBPSRSON,"#",":               * 5
                             "#"",EMBPOFDT,"#",":               
                             "#"",EMBPOFTM,"#",":
                             "#"",EMBPFFL1,"#",":               
                             "#"",EMBPFFL2,"#",":               
                             "#"",EMBPFFL3,"#",":               * 10
                             "#"",EMBPFFL4,"#",":               
                             "#"",EMBPFFL5,"#",":               
                             "#"",EMBPNAMB,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",EMBPFFNA,"#",":               * 15
                             "#"",EMBPFFCA,"#");"
.
PRROW999 RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"emrweb07.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE;
.
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"emrweb07.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE;
.
PREV9999  RETURN
.
.------------------------------------------------------------
. Process fields routine for Injury Surveillance Matrix
.------------------------------------------------------------
MTXF0000  BRANCH    FLDITMNO,MTXF0100,MTXF0200,MTXF0300,MTXF0400,MTXF0500:
                             MTXF0600,MTXF0700
.
MTXF0100  MOVE      "A8",CATEGORY
          MOVE      EMMXNAT,CODE
          CALL      CODITM00
          GOTO      MTXF9999
.
MTXF0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,MTXF0210,MTXF0220
.
          PACK      KEY2,EMMXBRG             * 0 = Description
          CALL      RDEMGRC1
          WRITE     HTMLFILE;EMRCDESC;
          GOTO      MTXF9999
.
MTXF0210  WRITE     HTMLFILE;EMMXBRG;        * 1 = Code
          GOTO      MTXF9999
.
MTXF0220  MOVE      SP70,KEY2                * 2 = Selection List
          CALL      RSEMGRC1
MTXF0225  CALL      RKEMGRC1
          BRANCH    OVRCD,MTXF9999
.
          MATCH     EMMXBRG,EMRCCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",EMRCCODE," selected>":
                               EMRCDESC,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",EMRCCODE,">":
                               EMRCDESC,"</option>";
          ENDIF
          GOTO      MTXF0225
.
MTXF0300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,MTXF0310
.
          PACK      KEY9,EMMXPDG,SP70
          CALL      RDEMICD1
          BRANCH    OVRCD,MTXF0305
.
          MOVE      EMICDESC,CODEDESC
          GOTO      MTXF0307
.
MTXF0305  MOVE      "Invalid Emergency Diagnosis Code",CODEDESC
.
MTXF0307  WRITE     HTMLFILE;CODEDESC;
          GOTO      MTXF9999
.
MTXF0310  WRITE     HTMLFILE;EMMXPDG;
          GOTO      MTXF9999
.
MTXF0400  CALL      MXTAB000
          GOTO      MTXF9999
.
MTXF0500  CALL      NEXTEM00
          GOTO      MTXF9999
.
MTXF0600  CALL      PREEMR00
          GOTO      MTXF9999
.
MTXF0700  CALL      MXPTB000
          GOTO      MTXF9999
.
MTXF9999  RETURN
.------------------------------------------------------------
. Process for Emergency Comments/Notices - HPS Code Starts Here
.------------------------------------------------------------
CMTF0000  BRANCH    FLDITMNO,CMTF0100
          GOTO      CMTF9999
.
CMTF0100  PACK      KEY2,SP70    
          CALL      RSEMCMT1                          
CMTF0110  CALL      RKEMCMT1                         
          BRANCH    OVRCD,CMTF9999
          STRIP     EMCMCMNT
          MOVELPTR  EMCMCMNT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      EMCMCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      CMTF0110
.
CMTF9999  RETURN
. HPS Code Ends Here
+
.------------------------------------------------------------
. Process Site-based Comments/Notices 
.------------------------------------------------------------
SCMT0000  BRANCH    FLDITMNO,SCMT0100,SCMT0200
          GOTO      SCMT9999
.
SCMT0100  PACK      KEY5,WBSEESC,SP70
          CALL      RSEMSCM1
SCMT0110  CALL      RKEMSCM1
          BRANCH    OVRCD,SCMT9999
.
          MATCH     WBSEESC,EMSCSITE
          GOTO      SCMT9999 IF NOT EQUAL
.
          STRIP     EMSCCMNT
          MOVELPTR  EMSCCMNT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      EMSCCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
          GOTO      SCMT0110
.
SCMT0200  PACK      KEY3,WBSEESC,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,SCMT9999
.
          WRITE     HTMLFILE;EMSTDESC;
          GOTO      SCMT9999
.
SCMT9999  RETURN
.------------------------------------------------------------
. Process Injury Surveillance Matrix
.------------------------------------------------------------
EMRMTX00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      EMRMTX40 IF EQUAL
.
          MATCH     "A",UPDTTYPE
          GOTO      EMRMTX10 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      EMRMTX20 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      EMRMTX30 IF EQUAL
.
          GOTO      EMRMTX95
.
.         Add Matrix Combination
.
EMRMTX10  CALL      CHKMTX00
          BRANCH    EXIT,EMRMTX99
.
          PACK      EMRMX001,EMRMX001,SP70
          PACK      EMRMX002,EMRMX002,SP70
          PACK      EMRMX003,EMRMX003,SP70
          PACK      KEY10,EMRMX001,EMRMX002,EMRMX003
          CALL      RDEMMX1
          COMPARE   ZERO,OVRCD
          GOTO      EMRMTX19 IF EQUAL
.
          CALL      SAVMTX00
          PACK      EMRMX001,EMRMX001,SP70
          PACK      EMRMX002,EMRMX002,SP70
          PACK      EMRMX003,EMRMX003,SP70
          PACK      KEY10,EMRMX001,EMRMX002,EMRMX003
          CALL      WREMMX1
.
          MOVE      ZERO,EXIT
          GOTO      EMRMTX99
.
EMRMTX19  MOVE      "Matrix combination already on file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EMRMTX99
.
.         Update Matrix Combination
.
EMRMTX20  CALL      CHKMTX00
          BRANCH    EXIT,EMRMTX99
.
          PACK      KEY10,SERMX001,SERMX002,SERMX003
          CALL      RDEMMX1
          BRANCH    OVRCD,EMRMTX90
.
          CALL      SAVMTX00
..          PACK      KEY10,EMRMX001,EMRMX002,EMRMX003
          CALL      UPEMMX1
.
          MOVE      ZERO,EXIT
          GOTO      EMRMTX99
.
.         Delete Matrix Combination
.
EMRMTX30  PACK      KEY10,SERMX001,SERMX002,SERMX003
          CALL      RDEMMX1
          BRANCH    OVRCD,EMRMTX90
.
          CALL      DEEMMX1
.
          MOVE      ZERO,EXIT
          GOTO      EMRMTX99
.
.         Display (or Output Blank) Matrix Combination
.
EMRMTX40  PACK      KEY10,EMRMX001,EMRMX002,EMRMX003
          CALL      RDEMMX1
          IF        OVRCD=1
            CALL      CLMTX000
          ENDIF
.
          MOVE      "Injury Surveillance Matrix Maintenance",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,EMRMTX99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      EMRMTX99
.
EMRMTX90  MOVE      "Matrix combination not on file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
EMRMTX95  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
EMRMTX99  RETURN
.------------------------------------------------------------
. Emergency Comments Updation - HPS Code Starts Here
.------------------------------------------------------------
EMRCMT00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      EMRCMT40 IF EQUAL
.
          MATCH     "U",UPDATETY
          GOTO      EMRCMT20 IF EQUAL
.          
          GOTO      EMRCMT95
.------------------------------------------------------------
.                   Update Formaction
.------------------------------------------------------------
EMRCMT20  PACK      KEY2,SP70
          CALL      RSEMCMT1 
EMRCMT21  CALL      RKEMCMT1
          BRANCH    OVRCD,EMRCMT22
          PACK      KEY2,EMCMLINE,SP70
          CALL      DEEMCMT1
          CALL      RSEMCMT1
          GOTO      EMRCMT21
.
EMRCMT22  COMPARE   ZERO,EMCMTIDX
          GOTO      EMRCMT99 IF EQUAL
          MOVE      ZERO,F2
EMRCMT23  ADD       ONE,F2
          MOVE      F2,EMCMLINE
          PACK      KEY2,EMCMLINE,SP70
          CALL      RDEMCMT1 
          IF        OVRCD=0
            MOVE      EMCMT001[F2],EMCMCMNT
            CALL      UPEMCMT1    
          ELSE
            MOVE      EMCMT001[F2],EMCMCMNT
            CALL      WREMCMT1   
          ENDIF
          COMPARE   F2,EMCMTIDX
          GOTO      EMRCMT23 IF NOT EQUAL
          GOTO      EMRCMT99
.-----------------------------------------------------------
.                      Display Formaction
.-----------------------------------------------------------
EMRCMT40  PACK      KEY2,SP70
          CALL      RSEMCMT1
          CALL      RKEMCMT1
          IF        OVRCD=1
            CALL      CLCMT000
          ENDIF
.
          MOVE      "Emergency Comments/Notices",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,EMRCMT99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      EMRCMT99
.
EMRCMT95  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
. 
EMRCMT99  RETURN          
. HPS Code ends here
+
.------------------------------------------------------------
. Emergency Site-based Comments/Notices Display/Update action
.------------------------------------------------------------
EMRSCM00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      EMRSCM40 IF EQUAL
.
          MATCH     "U",UPDATETY
          GOTO      EMRSCM20 IF EQUAL
.
          GOTO      EMRSCM95
.
.         Update Formaction
.
EMRSCM20  PACK      KEY5,WBSEESC,SP70
          CALL      RSEMSCM1
EMRSCM21  CALL      RKEMSCM1
          BRANCH    OVRCD,EMRSCM22
          MATCH     WBSEESC,EMSCSITE
          GOTO      EMRSCM22 IF NOT EQUAL
          PACK      KEY5,EMSCSITE,EMSCLINE,SP70
          CALL      DEEMSCM1
          GOTO      EMRSCM20
.
EMRSCM22  COMPARE   ZERO,EMCMTIDX
          GOTO      EMRSCM99 IF EQUAL
          MOVE      ZERO,F2
EMRSCM23  ADD       ONE,F2
          MOVE      F2,EMSCLINE
          PACK      KEY5,WBSEESC,EMSCLINE,SP70
          CALL      RDEMSCM1
          IF        OVRCD=0
            MOVE      EMCMT001[F2],EMSCCMNT
            MOVE      WBSEESC,EMSCSITE
            CALL      UPEMSCM1
          ELSE
            MOVE      EMCMT001[F2],EMSCCMNT
            MOVE      WBSEESC,EMSCSITE
            CALL      WREMSCM1
          ENDIF
          COMPARE   F2,EMCMTIDX
          GOTO      EMRSCM23 IF NOT EQUAL
          GOTO      EMRSCM99
.
.         Display Formaction
.
EMRSCM40  PACK      KEY5,WBSEESC,SP70
          CALL      RSEMSCM1
          CALL      RKEMSCM1
          IF        OVRCD=1
            CALL      CLSCM000
          ENDIF
.
          MOVE      "Emergency Comments/Notices",WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,EMRSCM99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      EMRSCM99
.
EMRSCM95  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
EMRSCM99  RETURN
+
.------------------------------------------------------------
.  Check I.S.M Variables
.------------------------------------------------------------
CHKMTX00  MATCH     SP70,EMRMX001
          GOTO      CHKMTX90 IF EQUAL
          GOTO      CHKMTX90 IF EOS
.
          MATCH     SP70,EMRMX002
          GOTO      CHKMTX91 IF EQUAL
          GOTO      CHKMTX91 IF EOS
.
          MATCH     SP70,EMRMX003
          GOTO      CHKMTX92 IF EQUAL
          GOTO      CHKMTX92 IF EOS
.
          PACK      KEY9,EMRMX003,SP70
          CALL      RDEMICD1
          BRANCH    OVRCD,CHKMTX93
.
          PACK      EMRMX003,EMRMX003,SP70
.
          MOVE      ZERO,EXIT
          GOTO      CHKMTX99
.
CHKMTX90  MOVE      "Body Region Code is mandatory",WEBTITLE
          GOTO      CHKMTX95
.
CHKMTX91  MOVE      "Nature of Main Injury Code is mandatory",WEBTITLE
          GOTO      CHKMTX95
.
CHKMTX92  MOVE      "Primary Diagnosis is mandatory",WEBTITLE
          GOTO      CHKMTX95
.
CHKMTX93  MOVE      "Invalid Primary Diagnosis",WEBTITLE
          GOTO      CHKMTX95
.
CHKMTX95  CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKMTX99  RETURN
.------------------------------------------------------------
. Save Matrix Variables
.------------------------------------------------------------
SAVMTX00  MOVE      EMRMX001,EMMXNAT
          MOVE      EMRMX002,EMMXBRG
          MOVE      EMRMX003,EMMXPDG
          PACK      EMMXSPA,SP70
.
SAVMTX99  RETURN
.------------------------------------------------------------
. Clear Matrix Variables
.------------------------------------------------------------
CLMTX000  PACK      EMMXNAT,SP70
          PACK      EMMXBRG,SP70
          PACK      EMMXPDG,SP70
.
CLMTX999  RETURN
.------------------------------------------------------------
. Clear Comment File Variables - HPS Code Starts Here
.------------------------------------------------------------
CLCMT000  PACK      EMCMLINE,SP70
          PACK      EMCMCMNT,SP70
.
CLCMT999  RETURN
. HPS Code Ends Here
+
.------------------------------------------------------------
. Clear Site-based Comments File Variables
.------------------------------------------------------------
CLSCM000  PACK      EMSCLINE,SP70
          PACK      EMSCCMNT,SP70
.
CLSCM999  RETURN
+
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG30  CALL      PWNCLS00
          GOTO      NXTPAG99
.
NXTPAG40  CALL      DFRCLS00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------
. Refresh Parent of Parent and Close Window
.------------------------------------------------------------
PWNCLS00  CALL      OPENHTML
          BRANCH    EXIT,PWNCLS99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  reload2ParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
.
          CALL      CLOSHTML     * End of Document
.
PWNCLS99  RETURN
+
.------------------------------------------------------------
. Closes the popup (DFrame)
.------------------------------------------------------------
DFRCLS00  CALL      OPENHTML
          BRANCH    EXIT,DFRCLS99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (top.TogglePanel) {":
                             "  top.TogglePanel();}":
                             " else { ":
                             "  history.go(-1); }":
                             "</script>"
.
          CALL      CLOSHTML     * End of Document
.
DFRCLS99  RETURN
.-------------------------------------------------------------------------------
.  Goes back x number of pages
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F1
          SUB       TWO,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
.                            "    self.close();":
                             "    window.history.go(-",F1,");":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Matrix Table
.------------------------------------------------------------
MXTAB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MXHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY10,STARTKEY,SP70
          CALL      RSEMMX1
MXTAB100  CALL      RKEMMX1
          BRANCH    OVRCD,MXTAB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MXTAB100
          ENDIF
.
          CALL      MROWA000      * Display Emergency Security ID Row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MXTAB100 IF NOT EQUAL
          GOTO      MXTAB999
.
MXTAB900  CALL      NOMORE00      * Display No More Records Message
.
MXTAB999  RETURN
.------------------------------------------------------------
. Matrix Table
.------------------------------------------------------------
MXPTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MXHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY10,STARTKEY,SP70
          CALL      RSEMMX3
MXPTB100  CALL      RKEMMX3
          BRANCH    OVRCD,MXPTB999
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MXPTB100
          ENDIF
.
          CALL      MROWA000      * Display Emergency Security ID Row
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MXPTB100 IF NOT EQUAL
.
MXPTB999  RETURN
.------------------------------------------------------------
. Body Region (TABLE HEADING)
.------------------------------------------------------------
MXHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=33%>":
                               "Nature of Main Injury</td>":
                               "<td class=HeadingCell width=33%>":
                               "Body Region</td>":
                               "<td class=HeadingCell width=33%>":
                               "Primary Diagnosis</td>":
                             "</tr>"
.
MXHED999  RETURN
.------------------------------------------------------------
. Matrix Row
.------------------------------------------------------------
MROWA000  MATCH     SP70,EMMXPDG
          IF        @EQUAL | @EOS
            MOVE      "&nbsp;",DISPPDG
          ELSE
            MOVE      EMMXPDG,DISPPDG
          ENDIF
.
MROWA100  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail(#"":
                             LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&emrmx001=",EMMXNAT:
                             "&emrmx002=",EMMXBRG:
                             "&emrmx003=",EMMXPDG,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             EMMXNAT,"</td>":
                             "<td>",EMMXBRG,"</td>":
                             "<td>",DISPPDG,"</td>":
                             "</tr>"
.
MROWA999 RETURN
.-------------------------------------------------------------------------------
. Link to previous set of Emergency Maintenance Notes
.-------------------------------------------------------------------------------
PREEMR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"emrweb07.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
PREEMR99  RETURN
.------------------------------------------------------------
. Link to Next set of Emergency Maintenance Notes
.------------------------------------------------------------
NEXTEM00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       "'~",STARTKEY
.
          WRITE     HTMLFILE;"emrweb07.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
          REP       "+ ",STARTKEY
          REP       "~'",STARTKEY
.
NEXTEM99  RETURN
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
.
.------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       DAYOFWEK
          INC       RSHWEBCD
          INC       TFILENAM
          INC       NAMSTRCD
          INC       PATDOCCD
          INC       ADDSECTM
.
          INC       EMRDVPIO/INC
          INC       EMRBPSIO/INC
          INC       EMRGRCIO/INC
          INC       EMRICDIO/INC
          INC       EMRMTXIO/INC
          INC       EMRSCMIO/INC
          INC       EMRSITIO/INC
          INC       EMRCMTIO/INC
          INC       PMSHCPIO/INC
