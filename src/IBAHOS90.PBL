.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*     PROGRAM NAME:     IBAHOS90                                             *
.*                                                                            *
.*     FUNCTION:         PATIENT CENSUS REPORT                                *
.*                                                                            *
.*     DATE WRITTEN:     16/03/1988                                           *
.*                                                                            *
.*     AUTHOR:           GRAEME WILLIAMS                                      *
.*                                                                            *
.*     MODIFICATIONS:                                                         *
.*                                                                            *
.******************************************************************************
.* V12.00.01 28/05/2025 Thanh T         TSK 0955096                           *
.*           Changed for alphanumeric visit number                            *
.******************************************************************************
.*        V10.13.01 05/12/2018  Don Nguyen     TSK 0838558                    *
.*                  Deleted temp file (PSTROL) after processing               *
.*        V10.10.02 13/06/2017  J.Tan          TSK 0839991                    *
.*                  Recompiled for PATDBTYP (PATCMSTP)                        *
.*        V10.10.01 07/04/2017  Ania P         CAR 261630                     *
.*                  Remove use of PORT                                        *
.*        V10.04.01 27/05/2014  J.Tan          CAR 300784                     *
.*                  Recompiled for STEPDOWN - force stepdown prior inv.fromdat*
.*        V10.03.03 11/10/2013  J.Tan          CAR 287554                     *
.*                  Fixed TDATE after reading the last Transfer record        *
.*        V10.03.02 28/06/2013  J.Tan          CAR 287554                     *
.*                  Changed FROMDATE to KFRDATE                               *
.*        V10.03.01 06/05/2013  J.Tan          CAR 284902                     *
.*                  Recompiled for STEPDOWN - force stepdown prior Inv.Fromdat*
.*        V10.01.01 23/02/2011  Peter Vela    CAR 233034                      *
.*                  Removed PATBF2FD and PATBF2IO                             *
.*        V10.00.01 14/07/2010  J.Tan         CAR 226158                      *
.*                  Recompiled for STEPDOWN - bed fees update                 *
.*        V9.12.03  11/03/2010  J.Tan         CAR 216044                      *
.*                  Mods to include Leave days in stepdown count for TAC      *
.*        V9.12.02  19/01/2010  J.Tan         CAR 166439                      *
.*                  Recompiled for PATCMSTP - C/P additional charge stepdown  *
.*        V9.12.01  21/09/2009  J.Tan         CAR 204390                      *
.*                  Recompiled for STEPDOWN - mods to old bed fees file       *
.*        V9.08.01  02/02/2007  Ebon Clements CAR 120001                      *
.*                  Added nz private billing files                            *
.*        V9.07.01  12/09/2006  Jill Habasque CAR 109852                      *
.*                  Added output of alternate ID if PTCNDAUR=1                *
.*        V9.04.02  25/11/2004  J.Tan    CAR 79626                            *
.*                  Fixed checking for nofee after stepdown routine           *
.*        V9.04.01  29/11/2004  Mike Laming   CAR 54534                       *
.*                  Re-comple for PATCMSTP - fix Addit.Charge Description     *
.*        V9.03.01  05/08/2004  J.Tan    CAR  52141                           *
.*                  Fixed lumpsum amount                                      *
.*        V9.02.04  30/10/2002  J.Tan                                         *
.*                  Recompiled for PATCMSTP                                   *
.*        V9.02.03  06/06/2002  J.Tan                                         *
.*                  Removed checking for hospital types                       *
.*        V9.02.02  07/05/2002  J.Tan                                         *
.*                  Recompiled for release 6.09 changes                       *
.*        V9.02.01  22/09/2001  Tonii  SRF 13075                              *
.*                  Recompiled for PATDINVS                                   *
.******************************************************************************
.*        V5.08.01  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*            V5.07.06   23/11/1999  Davin                                    *
.*                       Changed for 4 character drgs                         * 
.*            V5.07.05   13/08/1999  Steve Downing                            *
.*                       Redundant code removed                               * 
.*            V5.07.04   04/08/1999  Steve Downing                            *
.*                       Recompiled for STEPDOWN                              *
.*            V5.07.03   28/07/1999  Steve Downing                            *
.*                       Simplified dates difference routines, Y2K mods       *
.*            V5.07.02   08/06/1999  C.Sharman                                *
.*                       Mods to printing layout                              *
.*            V5.07.01   10/05/1999  J.Tan                                    *
.*                       Mods for casemix funding                             *
.*            V5.07.B02  28/01/1999  Nicole Harrington                        *
.*                       507 rebounds                                         *
.*            V5.07.B01  14/11/1998  Davin                                    *
.*                       Mods for 507                                         *
.******************************************************************************
.*                       W4.01  20/07/88 Graeme Williams                      *
.*                              Fixed bug with Accomodation charges           *
.*                       W4.02  15/02/89 K.Peak            SRF 2893           *
.*                              Added Date and Time option                    *
.*                       W5.00  13/04/89 K.Peak            SRF 2893           *
.*                              Zero charge for On Leave                      *
.*                       V5.01  19/05/89 DIG                                  *
.*                              Changed to standard and modified print for 8  *
.*                              digit U/Rs etc                                *
.*                       V5.02  27/05/89 J.Tan             SRF 100750         *
.*                              Fixed Mother Adm. to Form 8 (PATMI1FD).       *
.*                       V5.03  06/06/89 J.Tan             SRF 100809         *
.*                              Mods Locking master file (PATIOMAS).          *
.*                    V5.01.01  04/07/89 K.Peak                               *
.*                              Changed Admission No. & U/R to 8 characters   *
.*                    V5.01.02  15/11/89 J.Tan             SRF 103025         *
.*                              Fixed On Leave patient                        *
.*                    V5.01.121 27/11/90 Glen Hobby                           *
.*                              Recompiled for changes to PATMX1FD            *
.*                    V5.01.122 20/09/91 i chung           SRF 110572         *
.*                              Set KDTIME for whole of Option 2; not just    *
.*                              discharged patients                           *
.*                    V5.01.123 31/03/92 i chung           SRF 113683         *
.*                              Fixed incorrect Ward/Bed when running for     *
.*                              older dates                                   *
.*                    V5.01.124 14/09/92 i chung           SRF 117291         *
.*                              Fixed I*C on temp files                       *
.*                    V5.01.125 19/04/93 DIG                                  *
.*                              Made sure the TEXTRA variable is now used for *
.*                              additional charging.                          *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
.
          INC       IBACONFD/INC
          INC       MLTCFNFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPCMTFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIBRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPPFEFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       NZPTFEFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
          INC       PATCONFD/INC
          INC       PATCFAFD/INC
          INC       PATASDFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATHSPFD/INC
          INC       PATLSDFD/INC
          INC       PATLDFFD/INC
          INC       PATAFEFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATBFEFD/INC
          INC       PATCODFD/INC
          INC       PATDINVS/INC
          INC       PATDSCFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATTRNFD/INC
          INC       PATRCAUD/INC
          INC       PATWR1FD/INC
          INC       PMSCIDFD/INC
          INC       PMSVX1FD/INC
          INC       WEBSECFD/INC
          INC       IBASEQFD/INC 
          INC       TFILEVAR/INC
          INC       WEBERRFD/INC
+
.
SRTKEY1   DIM       15
SORT1     INIT      "u1-8"
SORT2     INIT      "u9-28,1-8"
SORT3     INIT      "u29-36,9-28,1-8"
.
SRTKEY2   DIM       15
SORT4     INIT      "u1-8"
SORT5     INIT      "u9-28,1-8"
SORT6     INIT      "u38-43,9-28,1-8"
.
.          Temporary Index files for report
.
PATWORK1  IFILE     SQL, FIXED=94, KEY=SRTKEY1
PATWORK4  IFILE     SQL, FIXED=85, KEY=SRTKEY2
.
.Name      Type     Size   Physical   Start
.----      ----     ----   --------   -----
XDAADMNO   DIM       8        8         1
.PSNAME    DIM       20       20        9
.WRKDATE   DIM       8        8        29
.AURNO     FORM      8        5        37
.DDATE     DIM       8        8        42
.WRKDAYS   FORM      8        5        50
.WRKAMT    FORM      9.2      7        55
.PGNAME    DIM       25       25       62
.WRKLSUM   FORM      9.2      7        87
.End of Record                         94
+
.
.Name      Type     Size   Physical   Start
.----      ----     ----   --------   -----
.XDAADMNO  DIM       8        8         1
.PSNAME    DIM       20       20        9
.ATYPE     DIM       3        3        29
.ADOCTA    DIM       6        6        32
.AWARD     DIM       3        3        38
.ABED      DIM       3        3        41
.WRKAMT    FORM      9.2      7        44
.PGNAME    DIM       25       25       51
ONLFLG     FORM      1        2        76
.WRKLSUM   FORM      9.2      7        78
.End of Record                         85
+
.
.         VARIABLES
.
ADTIME    DIM       16
CMDLINE   DIM       30
CSEC      DIM       2
CUDATE    DIM       8
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CALDAYS   FORM      4
CDYSYEAR  FORM      2
.
DIM9      DIM       9
DIM11     DIM       11
DIM19A    DIM       19
DIM18     DIM       18
DIM18A    DIM       18
DIM30     DIM       30
DDTIME    DIM       16
DISCFLG   FORM      1
EFTDATE   DIM       8         * Effective date (ccyymmdd)
.
FNAMER    DIM       8
FNAMEI    DIM       8
FORM3A    FORM      3
.
INDAY     FORM      2 
INMON     FORM      2
INYEAR    FORM      2
.
JDAYS     FORM      3
JYEAR     FORM      2
.
KFRDATE   DIM       8
KDTIME    DIM       16
.
LYR       FORM      1                       * Leap year indicator - 0=No, 1=Yes
LSTDATE   DIM       8
SAVEDATE  DIM       8
.
OPTION1   FORM      2
OPTION2   FORM      2
OPNFLAG   FORM      1
.
PSTROL    FILE      ASCII, FIXED=256
.
SAVLSUM   FORM      9.2
SADOCTA   DIM       6
SAVBEND   FORM      3
SAVALLW   FORM      6.2
SAVDISC   FORM      6.2
SAVAMT    FORM      9.2
SAVDAY    FORM      8
SAVONL    FORM      1
SATYPE    DIM       3
SAVEXTRA  FORM      6.2
SBED      DIM       3
SWARD     DIM       3
STATUS    FORM      1
.
TTDATE    DIM       8                       * To Date in CCYYMMDD format
TDATIME   DIM       8
TDTIME    DIM       16
TOTACC    FORM      9.2
TOTLSUM   FORM      9.2
TOTBED    FORM      8
.
WDATE     DIM       8
WDATE1    DIM       8
WDATE2    DIM       8
WRKAMT    FORM      9.2
WRKDATE   DIM       8
WRKDAYS   FORM      8
WSTAT     FORM      1
WRKLSUM   FORM      9.2
.
XDAY2     DIM       2
XMON2     DIM       2
XYEAR2    DIM       2
XCENT2    DIM       2
XDATE1    DIM       8
.
.         CONSTANTS
.
LYEAR     FORM      "366"
SP14      INIT      "              "
ZERAMT    INIT      "        0.00"
.
PRGID     INIT      "IBAHOS90"
PRGNAM    INIT      "Patient Census Report"
VERSION   INIT      "V12.01.00"
+
.
.         DISPLAY SCREEN HEADER AND OPEN FILES
.
          CALL      DISPHEAD
          DISPLAY   *P56:24,"Opening patdschf";
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patward1";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"nzpbfeaf";
          OPEN      NZPBFEA1,"nzpbfeaf"
.
          DISPLAY   *P64:24,"nzpcfnaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
.
          DISPLAY   *P64:24,"nzpcmtaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
.
          DISPLAY   *P64:24,"nzpfigaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
.
          DISPLAY   *P64:24,"nzpfinaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
.
          DISPLAY   *P64:24,"nzpibraf"
          OPEN      NZPIBRA1,"nzpibraf"
.
          DISPLAY   *P64:24,"nzpmchaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA2,"nzpmchaf"
.
          DISPLAY   *P64:24,"nzppicaf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPPICA2,"nzppicaf"
.
          DISPLAY   *P64:24,"nzprbraf"
          OPEN      NZPRBRA1,"nzprbraf"
.
          DISPLAY   *P64:24,"nzprfnaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
.
          DISPLAY   *P64:24,"nzppfeaf"
          OPEN      NZPPFEA1,"nzppfeaf"
.
          DISPLAY   *P64:24,"nzpspraf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
.
          DISPLAY   *P64:24,"nzptfeaf"
          OPEN      NZPTFEA1,"nzptfeaf"
          OPEN      NZPTFEA2,"nzptfeaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA1,"oprdetaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"oprsesaf"
          OPEN      OPRSESA1,"oprsesaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
          DISPLAY   *P64:24,"pmscidaf";
          OPEN      PMSCIDA1,"pmscidaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*217,CAUDQ
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,TEN5;*247,CSTDOWN
          READ      CONTROLF,TWENTY;*164,PTRESDAY,*199,PTCNBCUT,*211,PTCNCNDY
          READ      CONTROLF,FIFTY9;*1,CDLSTEP,*212,CFEETYP
          READ      CONTROLF,EIGHTY8;*233,PTCNADES
.
          PACK      CUDATE,CCC,CYY,CMM,CDD
          REP       " 0",CUDATE
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMER
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAMEI
+
.
.         START OF PROGRAM
.
START     HLINE     *G37,2,51,80
          DISPLAY   *P1:3,*EF:
                    *P2:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P2:5,*V2LON,ONE,*HOFF," = Date Report":
                    *P2:6,*V2LON,TWO,*HOFF," = Date and Time Report":
                    *P1:8,"Select Option :";
.
START0    KEYIN     *P17:8,*EF,*DV,UNDLN1,*P17:8,*V2LON,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      ENDIT IF EQUAL
.
          BRANCH    OPTION OF DTEREP,TIMREP
          DISPLAY   *P35:8,*EL,*B,*V2LON,"** Invalid Option **",*W2;
          GOTO      START0
.
.         Option 1 - Date Report
.
DTEREP    DISPLAY   *P51:2,*V2LON,"- Date Report ",*HOFF:
                   *P2:4,*EF,*V2LON,ZERO,*HOFF," = Exit":
                    *P2:5,*V2LON,ONE,*HOFF," = Admission Number Sequence":
                    *P2:6,*V2LON,TWO,*HOFF," = Surname Sequence":
                  *P2:7,*V2LON,THREE,*HOFF," = Admission Date/Surname Sequence":
                    *P1:9,"Select Option :";
.
START2    KEYIN     *P17:9,*EF,*DV,UNDLN1,*P17:9,*V2LON,OPTION1;
.
          COMPARE   ZERO,OPTION1
          GOTO      START IF EQUAL
          DISPLAY   *P17:9,*EL,*V2LON,OPTION1;
.
          BRANCH    OPTION1 OF VALOPT,VALOPT,VALOPT
          DISPLAY   *P35:9,*EL,*B,*V2LON,"** Invalid Option **",*W2;
          GOTO      START2
.
.         Option 2 - Date and Time Report
.
TIMREP    DISPLAY   *P51:2,*V2LON,"- Date and Time Report ",*HOFF:
                   *P2:4,*EF,*V2LON,ZERO,*HOFF," = Exit":
                    *P2:5,*V2LON,ONE,*HOFF," = Admission Number Sequence":
                    *P2:6,*V2LON,TWO,*HOFF," = Surname Sequence":
                  *P2:7,*V2LON,THREE,*HOFF," = Ward/Bed Sequence":
                    *P1:9,"Select Option :";
.
START3    KEYIN     *P17:9,*EF,*DV,UNDLN1,*P17:9,*V2LON,OPTION2;
.
          COMPARE   ZERO,OPTION2
          GOTO      START IF EQUAL
          DISPLAY   *P17:9,*EL,*V2LON,OPTION2;
.
          BRANCH    OPTION2 OF VALOPT1,VALOPT1,VALOPT1
          DISPLAY   *P35:9,*EL,*B,*V2LON,"** Invalid Option **",*W2;
          GOTO      START3
.
.         Option 1 - Date Report
.
VALOPT    DISPLAY   *P1:12,*EF,"Keyin From Date :":
                        *P1:14,"Keyin  To  Date :";
.
.             Keyin From Date
.
KADAT1    MOVE      ZERO,CHIGHLT
          MOVE      TEN2,CVERT
          MOVE      TEN9,CCOL
          MOVE      TEN2,EVERT
          MOVE      "40",ECOL
.
          UNPACK    SP8 INTO CDAY,CMON,CYEAR,CCENT
.
          CALL      KEYDATE
          BRANCH    CQUEST,KADAT1
          BRANCH    OVRCD OF START2
.
          PACK      KFRDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KFRDATE
.
          MATCH     KFRDATE,CUDATE
          GOTO      INVDTE1 IF LESS
.
          UNPACK    KFRDATE,XCENT1,XYEAR1,XMON1,XDAY1
.
.             Keyin To Date
.
KADAT2    MOVE      TEN4,CVERT
          MOVE      TEN4,EVERT
.
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
.
          CALL      KEYDATE
          BRANCH    CQUEST,KADAT2
.
          PACK      TTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TTDATE
.
          MATCH     TTDATE,CUDATE
          GOTO      INVDTE2 IF LESS
.
          MATCH     KFRDATE,TTDATE
          GOTO      INVDATG IF LESS
.
NEXTD     UNPACK    TTDATE,XCENT2,XYEAR2,XMON2,XDAY2
.
.         Add one to the TTDATE. This is because initially the program did not
.         include the end date, so it looks at all the data upto but including
.         the TTDATE.
.
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          CALL      DMYCON
.
          ADD       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
.
          PACK      TTDATE,CC,YY,MM,DD
          REP       " 0",TTDATE
          GOTO      REKEY
.
VALOPT1   DISPLAY   *P1:12,*EF,"Keyin Date :";
.
          MOVE      ZERO,CHIGHLT
          MOVE      TEN2,CVERT
          MOVE      TEN4,CCOL
          MOVE      TEN2,EVERT
          MOVE      "40",ECOL
.
          UNPACK    SP8 INTO CDAY,CMON,CYEAR,CCENT
.
          CALL      KEYDATE
          BRANCH    CQUEST,VALOPT1
          BRANCH    OVRCD,START3
.
          PACK      DTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DTDATE
.
          MATCH     DTDATE,CUDATE
          GOTO      INVDATE IF LESS
.
          MOVE      DTDATE,KFRDATE
          UNPACK    KFRDATE,XCENT1,XYEAR1,XMON1,XDAY1
.
VALOPT1A  DISPLAY   *P1:14,*EF,"Keyin Time :";
.
          MOVE      SP10,TDATIME
          UNPACK    TDATIME INTO CHOUR,ANS,CMIN,ANS,CSEC
          MOVE      TEN4,CVERT
.
          CALL      KEYTIME
          BRANCH    CQUEST,VALOPT1A
.
          PACK      TDATIME WITH CHOUR,COLON,CMIN,COLON,CSEC
          REP       " 0",TDATIME
          MOVE      KFRDATE,TTDATE
          GOTO      NEXTD
.
INVDATG   DISPLAY   *P1:24,*B,*EL,*V2LON:
                    "** To Date MUST be greater than or equal From Date **   ";
          CALL      HITENTER
          GOTO      KADAT2
.
INVDTE1   DISPLAY   *P1:24,*B,*EL,*V2LON:
                    "** From Date MUST be less than or = today's date **   ";
          CALL      HITENTER
          GOTO      KADAT1
.
INVDTE2   DISPLAY   *P1:24,*B,*EL,*V2LON:
                    "** To Date MUST be less than or equal today's date **   ";
          CALL      HITENTER
          GOTO      KADAT2
.
INVDATE   DISPLAY   *P1:24,*B,*EL,*V2LON:
                    "** Date MUST be less than or equal today's date **    ";
          CALL      HITENTER
          GOTO      VALOPT1
.
.          Check if dates are OK or not
.
REKEY     CALL      CONTQST                        * Ok to Continue (Y/N/C) ?
          BRANCH    CEXIT,CNTCHK,REKEY1,REKEY2     * 1 = Yes; 2 = No; 3 = Cancel
          GOTO      REKEY
.
REKEY1    BRANCH    OPTION,VALOPT,VALOPT1
.
REKEY2    BRANCH    OPTION,START2,START3
+
.
.             PROCESS START
.             -------------
.
.         Initialize Census file
.
CNTCHK    CALL      INDZD
          BRANCH    OPCND OF START
          DISPLAY   *P1:24,*EL,*P26:24,*V2LON:
                    "** Initializing Census File **",*W2;
.
          COMPARE   ONE,OPTION
          GOTO      PROCADM IF EQUAL
          PACK      KDTIME,KFRDATE,TDATIME
.
.         Processing Current Admissions
.
PROCADM   DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing Current Admissions **",*W2,*HOFF:
                    *P1:24,*EL,*P20:24,"Current Admission No :":
                    *P60:24,"Scanning :";
.
          MOVE      TWO,WSTAT
          MOVE      SP8,DDATE
          CALL      ADMFN
.
.         Processing On Leave Admissions
.
          DISPLAY   *P1:24,*EL,*P23:24,*V2LON:
                    "** Processing On Leave Admissions **",*W2,*HOFF:
                    *P1:24,*EL,*P20:24,"On Leave Admission No :":
                    *P60:24,"Scanning :";
.
          MOVE      FOUR,WSTAT
          MOVE      SP8,DDATE
          CALL      ADMFN
.
.         Processing Discharged Admissions
.
          DISPLAY   *P1:24,*EL,*P22:24,*V2LON:
                    "** Processing Discharged Admissions **",*W2,*HOFF:
                    *P1:24,*EL,*P20:24,"Discharged Admission No :":
                    *P60:24,"Scanning :";
.
          PACK      KEY16,KFRDATE,SP20
          CALL      RDSDSCH2
NEXT3     CALL      RDKDSCH2
          BRANCH    OVRCD OF REPORT
.
          DISPLAY   *P72:24,DADMNO;
.
          MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF NEXT3
.
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      WDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",WDATE
.
          BRANCH    OPTION,DISDTE,DISTIM
.
DISTIM    PACK      ADTIME,ADATE,ATIME
          PACK      DDTIME,DDATE,DTIME
.
          MATCH     KDTIME,DDTIME
          GOTO      NEXT3 IF LESS
.
          MATCH     KDTIME,ADTIME
          GOTO      NEXT3 IF NOT LESS
          GOTO      CDISAD 
.
DISDTE    MATCH     TTDATE,WDATE
          GOTO      NEXT3 IF NOT LESS
.
CDISAD    DISPLAY   *P47:24,*V2LON,DADMNO;
          CALL      TRANS  
          GOTO      NEXT3
.
.         Create an indexed file based on port for accumulating 
.         Admission Type totals
.
INDZD     MOVE      ZERO,STATUS
.
.         Check if previously exists..if so delete it 
.
          BRANCH    OPTION,KILL1,KILL2
.
KILL1     MOVE      SORT1,SRTKEY1
          CALL      KILLIDZ
.
          PREP      PSTROL,FNAMER
          WRITE     PSTROL,SEQ;"isbuild ",FNAMEI:
                               " 94 ",SORT1,SP1,SORT2,SP1,SORT3
          WEOF      PSTROL,SEQ
.
          MOVE      ONE,STATUS
.
          CLEAR     CMDLINE
          APPEND    "sh ",CMDLINE
          APPEND    FNAMER,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
.
.         Delete rollout file
.
          CLOSE     PSTROL,DELETE
.
.         Open temp work file 1
.
          MOVE      ZERO,OPCND
          MOVE      SORT1,SRTKEY1
.
          TRAP      NOINDZ IF IO
          OPEN	    PATWORK1,FNAMEI
          TRAPCLR   IO
          RETURN
+
.
KILL2     MOVE      SORT4,SRTKEY2
          CALL      KILLIDZ
.
          PREP      PSTROL,FNAMER
          WRITE     PSTROL,SEQ;"isbuild ",FNAMEI:
                               " 85 ",SORT4,SP1,SORT5,SP1,SORT6
          WEOF      PSTROL,SEQ
.
          MOVE      ONE,STATUS
.
          CLEAR     CMDLINE
          APPEND    "sh ",CMDLINE
          APPEND    FNAMER,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
.
.         Delete rollout file
.
          CLOSE     PSTROL,DELETE
.
.         Open temp work file 2
.
          MOVE      ZERO,OPCND
          MOVE      SORT4,SRTKEY2
.
          TRAP      NOINDZ IF IO
          OPEN	    PATWORK4,FNAMEI
          TRAPCLR   IO
          RETURN
+
.
NOINDZ    MOVE      ONE,OPCND
          DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Temporary Index File ",FNAMEI," not found **    ";
          CALL      HITENTER
          TRAPCLR   IO
          RETURN
+
.
.         Deleting an indexed file based on port
.
KILLIDZ   BRANCH     OPTION,KILDZ1,KILDZ2
.
KILDZ1    CLOSE      PATWORK1
          MOVE       ZERO,STATUS
.
          DISPLAY    *P1:24,*EL,*P25:24,*V2LON:
                     "** Deleting Temp Indexed File **",*W;
.
          MOVE       ONE,STATUS
.
          CLEAR      CMDLINE
          APPEND     "iserase ",CMDLINE
          APPEND     FNAMEI,CMDLINE
          RESET      CMDLINE
.
          EXECUTE    CMDLINE,TASKID
          BRANCH     STATUS OF DELIDZF1
.
          MOVE       ONE,OPCND
          DISPLAY    *P24:24,*B,*V2LON,"** Temp Index File not deleted **",*W2;
.
DELIDZF1  RETURN
+
.
KILDZ2    CLOSE     PATWORK4
          MOVE      ZERO,STATUS
.
          DISPLAY   *P1:24,*EL,*P25:24,*V2LON:
                    "** Deleting Temp Indexed File **",*W;
.
          MOVE      ONE,STATUS
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEI,CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
          BRANCH    STATUS OF DELIDZF2
.
          MOVE      ONE,OPCND
          DISPLAY   *P24:24,*B,*V2LON,"** Temp Index File not deleted **",*W2;
.
DELIDZF2  RETURN
+
.           Read Admissions file
.
ADMFN     PACK      KEY9 WITH WSTAT,SP8
          CALL      RDSMISS2
.
NEXT5     CALL      RDKMISS2
          BRANCH    OVRCD OF CONT1
.
          COMPARE   WSTAT,ASTAT
          GOTO      CONT1 IF NOT EQUAL
.
          DISPLAY   *P72:24,AADMNO;
.
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      WDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",WDATE
.
          BRANCH    OPTION,ADMDTE,ADMTIM
.
ADMTIM    MATCH     KFRDATE,WDATE
          GOTO      CADMFN IF LESS
          GOTO      NEXT5 IF NOT EQUAL
.
          MATCH     ATIME,TDATIME
          GOTO      NEXT5 IF LESS
          GOTO      CADMFN 
.
ADMDTE    MATCH     TTDATE,WDATE
          GOTO      NEXT5 IF NOT LESS
.
CADMFN    DISPLAY   *P47:24,*V2LON,AADMNO;
          CALL      TRANS  
          GOTO      NEXT5
.
CONT1     RETURN
+
.
.           Read Transfers file
.
TRANS     MOVE      SP8,SAVEDATE
          MOVE      ZERO,SAVAMT
          MOVE      SP3,SATYPE
          MOVE      SP6,SADOCTA
          MOVE      SP3,SWARD
          MOVE      SP3,SBED
          MOVE      SP1,STMOVE
          MOVE      SP3,STATYPE
          MOVE      ZERO,WRKDAYS
          MOVE      ZERO,WRKAMT
          MOVE      ZERO,SAVONL
          MOVE      ZERO,DISCFLG
          MOVE      ZERO,SAVLSUM
          MOVE      ZERO,WRKLSUM
.
          MOVE      SP10,SIDATET
          MOVE      SP10,LSTDATE
          MOVE      ZERO,ENDFLAG
          MOVE      ALACDTE,IDATEF           * set starting date for next inv.
          MOVE      IDATEF,SIDATET           * set starting date for next inv.
.
          CALL      GTAB0000                 * get health fund table
          PACK      CMDRG,PTMIPCMX,SP20      * Default to prov.casemix code
.
          UNPACK    SP10,KEY4,KEY5
          UNPACK    PTMIPCMX,KEY4,KEY5
          MATCH     SP5,KEY5
          IF        @EQUAL
            IF        ASTAT = 3
              MATCH     SP4,PTDSDDRG
              IF        !@EQUAL
                PACK      CMDRG,PTDSDDRG,SP20        * Use discharge DRG Code
              ENDIF
            ENDIF
          ENDIF
.

          MOVE      ONE,ACDAYCS       * set one to daycase flag
          MATCH     ADATE,DDATE
          GOTO      DAYCASE IF EQUAL
          MOVE      ZERO,ACDAYCS      * not daycase 
.
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
NEXTT     CALL      RDKTRAN2
          BRANCH    OVRCD OF XXXX
.
          MATCH     TADMN,AADMNO
          GOTO      XXXX IF NOT EQUAL
.
          BRANCH    OPTION,NXT1,NXT2
.
NXT2      PACK      TDTIME,TDATE,TTIME
          MOVE      TATYPE,SATYPE
          MOVE      TADOCT,SADOCTA
.
          MATCH     TDTIME,KDTIME
          GOTO      XXXX IF LESS
          MOVE      TWARD,SWARD
          MOVE      TBED,SBED
.
NXT1      MOVE      TMOVE,STMOVE
          RESET     TDATE
          REP       " 0",TDATE
          RESET     TDATE
.
          MOVE      TDATE,XDATE1
          MOVE      TDATE,LSTDATE
.
          MATCH     "Y",PTMICMXP
          IF        @EQUAL
            MATCH     KFRDATE,TDATE
            GOTO      NXT0 IF LESS
            MATCH     TDATE,TTDATE
            GOTO      NXT0 IF LESS
            MOVE      PTTRLSPT,SAVLSUM  * lumpsum charged 
            ADD       PTTRLSRB,SAVLSUM
.
NXT0        CALL      PATCMSTP
            GOTO      NEXTT1
          ENDIF
.
.         Not a casemix funding patient
.
          COMPARE   ONE,CSTDOWN
          GOTO      NEXTT1 IF NOT EQUAL
.
          CALL      STEPDOWN 
          IF        NOFEE=1
            MOVE      XDATE1,TDATE     * no fee found
          ENDIF
.
NEXTT1    COMPARE   ZERO,ENDFLAG
          GOTO      NEXTT2 IF EQUAL
.
          MATCH     LSTDATE,TDATE
          GOTO      TSAVREC IF EQUAL
.
NEXTT2    MATCH     ANSA,TMOVE
          GOTO      ARITYPE IF EQUAL
          MATCH     ANSR,TMOVE
          GOTO      ARITYPE IF EQUAL
          MATCH     ANSC,TMOVE
          GOTO      LOTYPE IF EQUAL
          MATCH     ANSL,TMOVE
          GOTO      LOTYPE IF EQUAL
.
          MATCH     KFRDATE,TDATE
          RETURN    IF LESS
          MOVE      ONE,DISCFLG
          MATCH     TTDATE,TDATE
          GOTO      XXXX IF LESS
          MOVE      TTDATE,TDATE  
          GOTO      XXXX
.
TSAVREC   MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      PTTREPSD,SPTTREPS
          MOVE      TDATE,SIDATET
          GOTO      NEXTT
.
.         Day Case - Get last rate for this patient
.
DAYCASE   PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
DCLOOP    CALL      RDKTRAN2
          BRANCH    OVRCD OF DCCALC
.
          MATCH     TADMN,AADMNO
          GOTO      DCCALC IF NOT EQUAL
.
          MOVE      PTTRLSPT,SAVLSUM
          ADD       PTTRLSRB,SAVLSUM
.
          MOVE      TATYPE,SATYPE
          MOVE      TADOCT,SADOCTA
          MOVE      TWARD,SWARD
          MOVE      TBED,SBED
.
          MOVE      TRATEF,SAVAMT
          ADD       TRATEH,SAVAMT
          ADD       PTTRADPT,SAVAMT
          ADD       PTTRADRB,SAVAMT
          ADD       TEXTRA,SAVAMT
          SUB       TDISC,SAVAMT
          SUB       TALLW,SAVAMT
.
          CMATCH    ANSD,TMOVE
          GOTO      DCCALC IF EQUAL
.
          CMATCH    TTIME,TDATIME
          GOTO      DCCALC IF LESS
.
.         MOVE      TRATEF,SAVAMT
.         ADD       TRATEH,SAVAMT
.         ADD       PTTRADPT,SAVAMT
.         ADD       PTTRADRB,SAVAMT
.         ADD       TEXTRA,SAVAMT
.         SUB       TDISC,SAVAMT
.         SUB       TALLW,SAVAMT
.
          MOVE      PTTREPSD,SPTTREPS
          GOTO      DCLOOP
.
DCCALC    MOVE      ONE,SAVDAY
          MOVE      AADMNO,KEY8
          BRANCH    OPTION,DCALC1,DCALC2
.
DCALC1    CALL      RDWORK1
          GOTO      DCALC3
.
DCALC2    CALL      RDWORK4
.
DCALC3    BRANCH    OVRCD OF NEWREC1
.
          IF        SPTTREPS = 3
            ADD       ZERO,WRKAMT
          ELSE
            ADD       SAVAMT,WRKAMT
          ENDIF
.
          ADD       SAVLSUM,WRKLSUM
          ADD       SAVDAY,WRKDAYS
          MOVE      SAVONL,ONLFLG
          MOVE      SATYPE,ATYPE
          MOVE      SADOCTA,ADOCTA
          MOVE      SWARD,AWARD
          MOVE      SBED,ABED
          BRANCH    OPTION,UPALC1,UPALC2
.
UPALC1    CALL      UPWORK1
          GOTO      UPALC3
.
UPALC2    CALL      UPWORK4
.
UPALC3    RETURN
+
.
NEWREC1   IF        SPTTREPS = 3
            MOVE      ZERO,WRKAMT
          ELSE
            MOVE      SAVAMT,WRKAMT
          ENDIF
.
          ADD       SAVLSUM,WRKLSUM
          MOVE      SAVDAY,WRKDAYS
          MOVE      SAVLSUM,WRKLSUM
          MOVE      SAVONL,ONLFLG
          MOVE      SATYPE,ATYPE
          MOVE      SADOCTA,ADOCTA
          MOVE      SWARD,AWARD
          MOVE      SBED,ABED
          MOVE      ADATE,WRKDATE
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
.
          MOVE      AADMNO,KEY8
          BRANCH    OPTION,NEWRC1,NEWRC2
.
NEWRC1    CALL      WRWORK1
          GOTO      NEWRC3
.
NEWRC2    CALL      WRWORK4
.
NEWRC3    RETURN
+
.
.         End of a period, calculate the data needed, and then start new period
.
LOTYPE    MATCH     KFRDATE,TDATE
          GOTO      ARITYPE IF LESS
          MATCH     TTDATE,TDATE
          GOTO      CONT8 IF LESS
.
          MOVE      TTDATE,WDATE1
          MOVE      SAVEDATE,WDATE2
.
          CALL      CALC00
          RETURN
+
.
CONT8     MOVE      TDATE,WDATE1
          MOVE      SAVEDATE,WDATE2
CONT82    CALL      CALC00
.
.         Save new parameters for the start of the new period
.
ARITYPE   MATCH     TTDATE,TDATE
          RETURN    IF NOT LESS
          MATCH     KFRDATE,TDATE
          GOTO      CONT2 IF NOT LESS
          MOVE      KFRDATE,SAVEDATE
          GOTO      CONT30
.
CONT2     MOVE      TDATE,SAVEDATE
.
CONT30    MOVE      TRATEF,SAVAMT
          ADD       TRATEH,SAVAMT
          ADD       PTTRADPT,SAVAMT
          ADD       PTTRADRB,SAVAMT
          ADD       TEXTRA,SAVAMT
          SUB       TDISC,SAVAMT
          SUB       TALLW,SAVAMT
.
          MOVE      TATYPE,STATYPE
          GOTO      TSAVREC
.
XXXX      BRANCH    OPTION,XXXX1,XXXX2
.
XXXX1     MATCH     ANSL,STMOVE
          RETURN    IF EQUAL
          GOTO      XXXX3
.
XXXX2     MOVE      ZERO,SAVONL
          MATCH     ANSL,STMOVE
          GOTO      XXXX3 IF NOT EQUAL
          MOVE      ONE,SAVONL
.
XXXX3     MATCH     SP1,STMOVE
          RETURN    IF EQUAL
.
          MATCH     TADMN,AADMNO
          IF        !@EQUAL 
            MOVE      LSTDATE,TDATE
          ENDIF
.
          IF         DISCFLG = 1
            MOVE       TDATE,XDATE1
          ELSE
            PACK       XDATE1,CCC,CYY,CMM,CDD
          ENDIF
          REP       " 0",XDATE1
.
          IF        SPTTREPS = 3 | SPTTREPS = 5
            IF        SPTTREPS=3
              GOTO       CONT5
            ELSE
              MOVE      XDATE1,TDATE
              MOVE      SP1,TMOVE
              LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
              MOVE      STATYPE,TATYPE
              MOVE      STRBTYP,TRBTYP
              MOVE      STRBEND,TRBEND
              MOVE      SPTTRAEN,PTTRAEND
              MOVE      SPTTREPS,PTTREPSD
              CALL      PATCMSTP
              MOVE      ONE,ENDFLAG
              GOTO      CONT44
            ENDIF
          ENDIF
.
.         Check if stepdown is required
.
          COMPARE   ONE,CSTDOWN
          GOTO      CONT5 IF NOT EQUAL
.
          MOVE      XDATE1,TDATE
          MOVE      SP1,TMOVE
          LOAD      TMOVE,ASTAT,ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          CALL      STEPDOWN
          MOVE      ONE,ENDFLAG
          BRANCH    NOFEE,CONT5
.
.         Check if a stepdown was indicated = shown by a new TDATE
.
CONT44    MATCH     TDATE,XDATE1
          GOTO      CONT5 IF EQUAL
.
          MATCH     TDATE,LSTDATE
          GOTO      NEXTT1 IF LESS
          GOTO      TSAVREC
.
CONT5     MATCH     ANSD,STMOVE
          GOTO      CONT9 IF NOT EQUAL
.
          MATCH     TTDATE,TDATE
          GOTO      CONT9 IF NOT LESS
.
          MOVE      TDATE,WDATE1
          MOVE      SAVEDATE,WDATE2
          GOTO      CONT10
.
CONT9     MOVE      TTDATE,WDATE1
          MOVE      SAVEDATE,WDATE2
.
CONT10    CALL      CALC00
TRAN99    RETURN
+
.         calculate dates difference
.
CALC00    
         DAYSEP    WDATE2,WDATE1,TOTDAY
.
.           Read Patient Master file
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
.
          MULT      TOTDAY BY SAVAMT 
.
          COMPARE   ZERO,TOTDAY
          GOTO      NEXTDX IF NOT LESS
.
          DISPLAY   *P1:22,*EL,"*** Transfer Record Missing for ":
                               "Admission : ",*V2LON,AADMNO:
                    *HOFF," Contact I.B.A. ***";
.
          PRINT     *N,"*** Transfer Record Missing for ":
                       "Admission : ",AADMNO," Contact I.B.A. ***"
.
NEXTDX    MOVE      AADMNO,KEY8
          BRANCH    OPTION,NEXTD1,NEXTD2
.
NEXTD1    CALL      RDWORK1
          GOTO      NEXTD3
.
NEXTD2    CALL      RDWORK4
.
NEXTD3    BRANCH    OVRCD OF NEWREC2
.
          ADD       SAVLSUM,WRKLSUM
          ADD       TOTDAY,WRKDAYS
          ADD       SAVAMT,WRKAMT
          MOVE      SAVONL,ONLFLG
          MOVE      SATYPE,ATYPE
          MOVE      SADOCTA,ADOCTA
          MOVE      SWARD,AWARD
          MOVE      SBED,ABED
          BRANCH    OPTION,NEXTX1,NEXTX2
.
NEXTX1    CALL      UPWORK1
          GOTO      NEXTX3
.
NEXTX2    CALL      UPWORK4
.
NEXTX3    RETURN
+
.
NEWREC2   MOVE      TOTDAY,WRKDAYS
          MOVE      SAVLSUM,WRKLSUM
          MOVE      SAVAMT,WRKAMT
          MOVE      SAVONL,ONLFLG
          MOVE      SATYPE,ATYPE
          MOVE      SADOCTA,ADOCTA
          MOVE      SWARD,AWARD
          MOVE      SBED,ABED
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      WRKDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      AADMNO,KEY8
          BRANCH    OPTION,NREC1,NREC2
.
NREC1     CALL      WRWORK1
          GOTO      NREC3
.
NREC2     CALL      WRWORK4
.
NREC3     RETURN
+
.
.           Print Report
.
REPORT    MOVE      SP8,KEY8                * Check any record in file
          BRANCH    OPTION,RPORT1,RPORT2
.
RPORT1    CALL      RDSWORK1
          CALL      RDKWORK1
          GOTO      RPORT3
.
RPORT2    CALL      RDSWORK4
          CALL      RDKWORK4
.
RPORT3    BRANCH    OVRCD OF NOPAT
.
          MOVE      ZERO,CPAGENO
          MOVE      "60",CLNO
          MOVE      ZERO,TOTPAT
          MOVE      ZERO,TOTBED
          MOVE      ZERO,TOTACC
          MOVE      ZERO,TOTLSUM
.
          DISPLAY   *P1:24,*EL,*P29:24,*V2LON,"** Generating Report **",*W2;
          BRANCH    OPTION,REPORT1,REPORT2
.
REPORT1   CLOSE     PATWORK1
          GOTO      REPORT3
.
REPORT2   CLOSE     PATWORK4
.
REPORT3   BRANCH    OPTION,LDDTE,LDTIM
.
LDDTE     LOAD      SRTKEY1 USING OPTION1 OF SORT1,SORT2,SORT3
          OPEN      PATWORK1,FNAMEI
          GOTO      CNTLD
.
LDTIM     LOAD      SRTKEY2 USING OPTION2 OF SORT4,SORT5,SORT6
          OPEN      PATWORK4,FNAMEI
.
CNTLD     BRANCH    OPTION OF PRTDTE,PRTTIM
.
PRTDTE    BRANCH    OPTION1 OF ADMSEQ,SURSEQ,DATSEQ
.
PRTTIM    BRANCH    OPTION2 OF ADMSEQ,SURSEQ,WRDSEQ
.
ADMSEQ    DISPLAY   *P1:24,*EL,*P20:24,"Printing Admission No :";
          GOTO      PLOOP0
.
SURSEQ    DISPLAY   *P1:24,*EL,*P20:24,"Printing Surname :";
          GOTO      PLOOP0
.
DATSEQ    DISPLAY   *P1:24,*EL,*P20:24,"Printing Date :";
          GOTO      PLOOP0
.
WRDSEQ    DISPLAY   *P1:24,*EL,*P20:24,"Printing Ward :";
.
PLOOP0    MOVE      SP8,KEY8
          BRANCH    OPTION,PLOOP1,PLOOP2
.
PLOOP1    CALL      RDSWORK1
          GOTO      PLOOP3
.
PLOOP2    CALL      RDSWORK4
.
PLOOP3    BRANCH    OPTION,PLOOP,PLOOP4
.
PLOOP     CALL      RDKWORK1
          GOTO      PLOOP5
.
PLOOP4    CALL      RDKWORK4
.
PLOOP5    BRANCH    OVRCD OF ENDP
          BRANCH    OPTION OF DTEDIS,TIMDIS
.
DTEDIS    BRANCH    OPTION1 OF ADMDIS,SURDIS,DATDIS
.
TIMDIS    BRANCH    OPTION2 OF ADMDIS,SURDIS,WRDDIS
.
ADMDIS    DISPLAY   *P45:24,*V2LON,AADMNO;
          GOTO      PRTCONT
.
SURDIS    DISPLAY   *P40:24,*V2LON,PSNAME;
          GOTO      PRTCONT
.
DATDIS    CALL      PACDATE
          DISPLAY   *P37:24,CPCDATE 
          GOTO      PRTCONT
.
WRDDIS    DISPLAY   *P40:24,*V2LON,AWARD,"/",ABED;
.
PRTCONT   COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          PACK      DIM20,PGNAME
          BRANCH    OPTION,PRTCNT1,PRTCNT2
.
PRTCNT1   OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          PACK      DIM9,AURNO,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS
            MATCH     SP70,KEY20
            IF        !@EQUAL
              UNPACK    KEY20,DIM11,DIM9
            ENDIF
          ENDIF
.
          PRINT     *1,"|",*3,AADMNO,*13,"|",DIM9,*23,"|",PSNAME:
                    *44,DIM20,*66,"|";
          GOTO      PRTCNT5
.
PRTCNT2   PRINT     *1,"|",*3,AADMNO,*13,"| ",PSNAME:
                    *44,DIM20,*66,"|   ",ATYPE,*79,"|  ",ADOCTA;
.
          COMPARE   ONE,ONLFLG
          GOTO      PRTCNT3 IF NOT EQUAL
          PRINT     *91,"| ","ON LEAVE";
          PRINT     *102,"| ",ZERAMT,*117,"|",*132,"|"
          MOVE      ZERO,WRKAMT
          GOTO      PRTCNT4
.
PRTCNT3   PRINT     *91,"|  ",AWARD,"/",ABED;
          PRINT     *102,"| ",WRKAMT,*117,"|",*132,"|"
.
PRTCNT4   ADD       ONE,CLNO
          GOTO      CNTPRT2
.
PRTCNT5   UNPACK    WRKDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *68,CPCDATE;
.
          PRINT     *79,"|";
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *80,CPCDATE;
.
          BRANCH    OPTION,CNTPRT1,CNTPRT2
.
CNTPRT1   PRINT     *91,"| ",WRKDAYS,*102,"| ",WRKAMT,*117,"| ",WRKLSUM,*132,"|"
          ADD       ONE,CLNO
.
CNTPRT2   ADD       ONE,TOTPAT
          ADD       WRKDAYS,TOTBED
          ADD       WRKAMT,TOTACC
          ADD       WRKLSUM,TOTLSUM
          GOTO      PLOOP3
.
ENDP      CALL      PRTLN
.
          BRANCH    OPTION,ENDP1,ENDP2
.
ENDP1     PRINT     *1,"*** T O T A L S ***",*22,"| ",TOTPAT," Patients":
                    *66,"|",*91,"| ",TOTBED,*102,"| ",TOTACC,*117,"| ",TOTLSUM:
                    *132,"|",*N:
                    *22,"*-------------------------------------------*":
                    *91,"*----------------------------------------*"
          GOTO      ENDP3
.         
ENDP2     PRINT     *1,"*** T O T A L S ***",*22,"| ",TOTPAT," Patients":
                    *66,"|",*102,"| ",TOTACC,*117,"| ",TOTLSUM,*132,"|",*N:
                    *22,"*--------------------------------------------*":
                    *106,"*---------------------------*"
          
ENDP3     PRINT     *N,*N,"***  End of Report  ***"
.
          DISPLAY   *P1:24,*EL,*P24:24,*V2LON:
                    "** Report Generation Completed **",*W2;
          CALL      KILLIDZ
          BRANCH    OPTION,START2,START3
          GOTO      START
.
.           Headings for output
.
HEAD      COMPARE   ZERO,CPAGENO
          CALL      PRTLN IF NOT EQUAL
          MOVE      EIGHT,CLNO
.
          MOVE      ONE,CNOUNDLN
          CALL      IBACLOCK
          CALL      HEAD132
.
          BRANCH     OPTION OF HEADD,HEADT
.
HEADD     BRANCH     OPTION1 OF HEAD1,HEAD2,HEAD3
.
HEADT     BRANCH     OPTION2 OF HEAD1,HEAD2,HEAD4
.
HEAD1     PRINT     *N,*40,"(Admission Number Sequence)";
          GOTO      HEADX
.
HEAD2     PRINT     *N,*40,"(Patient Surname Sequence)";
          GOTO      HEADX
.
HEAD3     PRINT     *N,*40,"(Admission Date/Surname Sequence)";
          GOTO      HEADX
.
HEAD4     PRINT     *N,*40,"(Ward/Bed Sequence)";
.
HEADX    BRANCH     OPTION OF DTEONL,DTETIM
.
DTEONL   PRINT      *N,*40,"From Date : ",XDAY1,"/",XMON1,"/",XCENT1,XYEAR1:
                    *70,"To Date : ",XDAY2,"/",XMON2,"/",XCENT2,XYEAR2,*N
          GOTO      CNTREP
.
DTETIM    PRINT     *N,*40,"Date : ",XDAY1,"/",XMON1,"/",XCENT1,XYEAR1:
                    *70,"Time : ",TDATIME,*N
.
CNTREP    CALL      PRTLN
          BRANCH    OPTION,CNTREP1,CNTREP2
.
CNTREP1   PRINT     *1,"| Admission",*13,"|  U/R",*23,"| Patient":
                    *66,"| Admission",*79,"| Discharge",*91,"| No. Of":
                    *102,"| Accommodation ",*117,"|    Lumpsum",*132,"|":
                    *N,"|  Number  ",*13,"| Number",*23,"| Surname":
                    *44,"Given Name":
                    *66,"|   Date",*79,"|   Date",*91,"| Bed Days":
                    *102,"|    Charges ",*117,"|    Amount",*132,"|"
          GOTO      FINPRT
.
CNTREP2   PRINT     *1,"| Admission",*13,"| Patient":
                    *66,"| Admission",*79,"| Attending",*91,"| Ward / ":
                    *102,"| Accommodation ",*117,"|    Lumpsum",*132,"|":
                    *N,"|  Number  ",*13,"| Surname":
                    *44,"Given Name":
                    *66,"|   Type",*79,"| Doctor",*91,"| Bed     ":
                    *102,"|    Charges  ",*117,"|    Amount",*132,"|"
.
FINPRT    CALL      PRTLN
          RETURN
+
.
PRTLN     PRINT     *1,"*---------------------------------------":
                       "----------------------------------------":
                       "----------------------------------------------------*"
          ADD       ONE,CLNO
          RETURN
+
.              CALCULATE DATES DIFFERENCE
.
CALC      DAYSEP    WDATE2,WDATE1,CALDAYS
          ADD       CALDAYS TO NBRDAYS
          RETURN
.
.
NOPAT     DISPLAY   *P1:24,*EL,*V2LON,*P27:24,"*** No Patient Selected ***",*W3;
          CALL      KILLIDZ
          GOTO      START 
.
ENDIT     CHAIN     PGM
          STOP
+
.******************************************************************************
.
.          File I/O Requests for Census Work file - ( Admission Sequence )
.
WRWORK1   RESET     KEY8
          WRITE     PATWORK1,KEY8;KEY8,PSNAME,WRKDATE,AURNO,DDATE,WRKDAYS:
                                  WRKAMT,PGNAME,WRKLSUM
          RETURN
.
RDWORK1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PATWORK1,KEY8;XDAADMNO,PSNAME,WRKDATE,AURNO,DDATE,WRKDAYS:
                                  WRKAMT,PGNAME,WRKLSUM
          GOTO      OVERCOND IF OVER
          MOVE      XDAADMNO,AADMNO
          RETURN
.
RDKWORK1  MOVE      ZERO,OVRCD
          READKS    PATWORK1;XDAADMNO,PSNAME,WRKDATE,AURNO,DDATE,WRKDAYS,WRKAMT:
                             PGNAME,WRKLSUM
          GOTO      OVERCOND IF OVER
          MOVE      XDAADMNO,AADMNO
          RETURN
.
RDSWORK1  MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PATWORK1,KEY8;;
          GOTO      OVERCOND IF OVER
          RETURN
.
UPWORK1   MOVE      AADMNO,XDAADMNO
          UPDATE    PATWORK1;XDAADMNO,PSNAME,WRKDATE,AURNO,DDATE,WRKDAYS,WRKAMT:
                             PGNAME,WRKLSUM
          RETURN
.
.          File I/O Requests for Census Work file  - ( Surname Sequence )
.
RDSWORK2  MOVE      ZERO,OVRCD
          RESET     KEY28
          READ      PATWORK1,KEY28;;
          GOTO      OVERCOND IF OVER
          RETURN
.
.          File I/O Requests for Census Work file - ( Admission Date /
.                                                     Surname Sequence )
RDSWORK3  MOVE      ZERO,OVRCD
          RESET     KEY34
          READ      PATWORK1,KEY34;;
          GOTO      OVERCOND IF OVER
          RETURN
.
.          File I/O Requests for Census Work file - ( Admission Sequence )
.
WRWORK4   RESET     KEY8
          WRITE     PATWORK4,KEY8;KEY8,PSNAME,ATYPE,ADOCTA,AWARD,ABED:
                                  WRKAMT,PGNAME,ONLFLG,WRKLSUM
          RETURN
.
RDWORK4   MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PATWORK4,KEY8;XDAADMNO,PSNAME,ATYPE,ADOCTA,AWARD,ABED:
                                  WRKAMT,PGNAME,ONLFLG,WRKLSUM
          GOTO      OVERCOND IF OVER
          MOVE      XDAADMNO,AADMNO
          RETURN
.
RDKWORK4  MOVE      ZERO,OVRCD
          READKS    PATWORK4;XDAADMNO,PSNAME,ATYPE,ADOCTA,AWARD,ABED:
                                  WRKAMT,PGNAME,ONLFLG,WRKLSUM
          GOTO      OVERCOND IF OVER
          MOVE      XDAADMNO,AADMNO
          RETURN
.
RDSWORK4  MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PATWORK4,KEY8;;
          GOTO      OVERCOND IF OVER
          RETURN
.
UPWORK4   MOVE      AADMNO,XDAADMNO
          UPDATE    PATWORK4;XDAADMNO,PSNAME,ATYPE,ADOCTA,AWARD,ABED:
                                  WRKAMT,PGNAME,ONLFLG,WRKLSUM
          RETURN
.
.*******************************************************************************
.         Get the default charging claim code for multi hospital
.*******************************************************************************
DCLM0000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
DCLM9999  RETURN
+
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS 
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.==============================================================================
.
          INC       STD001IO
.
          INC       GETBFEES
          INC       STEPDOWN
          INC       PATCMSTP
          INC       CALCDAYS
          INC       CLNZPPIC
          INC       TFILENAM 
.
          INC       IBASEQIO/INC 
          INC       WEBERRIO/INC
          INC       MLTCFNIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPCMTIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIBRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPSPRIO/INC
          INC       NZPTFEIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       PATASDIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATLSDIO/INC
          INC       PATHSPIO/INC
          INC       PATLDFIO/INC
          INC       PATAFEIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATBFEIO/INC
          INC       PATCODIO/INC
          INC       PATCFAIO/INC
          INC       PATDSCIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATRCAIO/INC
          INC       PATTRNIO/INC
          INC       PMSCIDIO/INC
          INC       PMSVX1IO/INC
          INC       PATWR1IO/INC
          INC       GETCNEFF
+
