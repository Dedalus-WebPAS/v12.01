.------------------------------------------------------------------------------
. Program       : RCPWEB01
.
. Function      : Cash Receipting Server for Reprint receipt
.
. Modifications :
.------------------------------------------------------------------------------
. V12.00.04  27/08/2025  Alina Bhari      TSK 0954453
.            Recompiled for RCPPRTCD - Added Patient Name
. V12.00.03  28/07/2024  Zumin Y        TSK 0957448
.            Added a tag in ERCP3000 for NORECORD value to reflect 
.            parameter PTCNNRTD change.             
. V12.00.02  24/07/2025  J.Tan          TSK 0962500
.            Mod Cash payment to check for U/R number
. V12.00.01  17/07/2024  Zumin Y          TSK 0957448
.            Changed PATDEP00 - make Deposit List shows the number of lines 
.            as configured in the parameter PTCNNRTD.
. V11.04.04  08/10/2024  Thanh T          TSK 0952281
.            Recompiled for RCPPRTCD changes   
. V11.04.03  24/04/2024  J.Tan         TSK 0945867 
.            Mod SELINV00 checking for fully credited invoices
. V11.04.02  21/03/2024  Nikitha B     TSK 0944499 
.            Added RCCICHQA at CLRCID00 to clear default cheque account field.
. V11.04.01  20/03/2024  Nikitha B     TSK 0944574 
.            Changed the column name from Surname to Description at CIDHD000.
. V11.03.06  08/11/2023   Nikitha B      TSK 0927699d
.            Read CAPPRVNO and PTCNHABN for Hospital Approval and ABN number.
. V11.03.05  04/10/2023  Nikitha B     TSK 0927699
.            Recomplied for RCPPRTCD - Stationary variables
. V11.03.04  12/07/2023  J.Tan          TSK 0917199
.            Added 3rd Party Deposit code to Cash drawer
. V11.03.03  05/05/2023  J.Tan          TSK 0847250
.            Recompiled for PRIUPURE - fixed payment amount
. V11.03.02  20/03/2023  J.Tan          TSK 0847250
.            Mod for Private Practice No monies received
. V11.03.01  19/12/2022  Bella Turco    TSK 0921957
.            Added NOMORE00 - Display "No more records" at end of list
.            Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.09  06/10/2022  Jill Parkinson Task 0925127
.            Recompiled for RCPDTETM - pripractf read            
.            Added check for HSYS3 in SELMPR00                   
. V11.02.08  10/05/2022  J.Tan          TSK 0309320
.            Fixed Visit selection matching Receipt Hospital id.
. V11.02.07  29/04/2022  J.Tan          TSK 0309320
.            Fixed Visit selection for Deposit list (SELVIS00)
. V11.02.06  20/04/2022  J.Tan          TSK 0309320
.            Fixed Visit selection for Deposit list (SELVIS00)
. V11.02.05  08/04/2022  Jacob Jackson  TSK 0864505
.            Recompiled for RCPPRTCD fix - remove label in BRANCH
. V11.02.04  21/02/2022  Alina Bhari   TSK 0910971
.            Added REVRECPT cgi                       
.            Add an ability to list Deposite List in ascending/ Descending order
.            based on REVRECPT vaue 0/1 - ERCP2900,PATDEP00,NXTDEP00,PRVDEP00,
.                                         GPRDEP00,GNXDEP00 
. V11.02.03  10/02/2022  Thanh T       TSK 0905641
.            Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.02  04/02/2022  Jacob Jackson     TSK 0864505
.            Recompiled for RCPPRTCD - Adding preferred name option labels
. V11.02.01  01/12/2021  J.Tan             TSK 0309320
.            Added Transfer option on Deposit List
. V11.01.01  11/06/2021  J.Tan             TSK 0899730
.            Mod for Healthscope Register G/L Income/Control Account maintenance
. V11.00.01  09/12/2020  Thanh T           TSK 0872840
.            Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.05  28/10/2020  J.Tan             TSK 0895711
.            Mod Refund Deposit to check for Deposit status prior updating
.            29/10/2020  J.Tan                   TSK 0896343
.            Recompiled for RCPBDTTM - blank Card type for EFTPOS Type = Cash
. V11.00.04  27/07/2020  Sunny             TSK 0892373
.            Changed PRNTNAME and PRNTRNAM to DIM 80
. V11.00.03  22/07/2020  J.Tan             TSK 0888475
.            Fixed Patient deposit list (PATDEP00) Next and Previous screen
. V11.00.02  16/04/2020  Ebon Clements    TSK 0890645
.            Don't display inactive deposit refund reasons - RFOP0000
. V11.00.01 09/04/2020  J.Tan             TSK 0868813
.            Mod PRFANAME to DIM80
. V10.15.01  29/01/2020  Ebon Clements    TSK 0885534
.            Added multi hospital edit to re print receipt display - RCPPRT10
. V10.14.02  12/09/2019  Thanh T          TSK 0880190
.            Added OPEN index PMSHCPA1 for pmshcpaf table to fix the issue
.            with "READ attempted on a closed file" error  
. V10.14.01  20/03/2019  J.Tan            TSK 0857392
.            Changed RCP Transaction count from DIM3 to DIM5
. V10.13.01  26/07/2018  J.Tan            TSK 0848506
.            Recompiled for RCPPRTCD/PRINTHS1 - PP Doctor from DIM6 to DIM10
. V10.12.01  27/04/2018  J.Tan          Task 0845996
.            Mod to update CMDEUDAT,CMDEUTIM and CMDEUUID
. V10.11.04  27/11/2017  Thanh Tieu     Task 0821710
.            Recompiled as PATMASTM changed
. V10.11.03  22/11/2017  Ania P          TSK 0261630
.            Moved TFILNAME to CFNAMEDP in INIT0000
. V10.11.02  30/07/2017  Thanh T.        TSK 0821710
.            Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01  19/07/2017  Peter Vela      TSK 0831224
.            Recompiled for PMSERHFD
.------------------------------------------------------------------------------
. V10.08.06  17/11/2016  Ebon Clements   TSK 0823642
.            Added multi hospital edit to cancel receipt display - RCPPRT10 
. V10.08.05  30/08/2016  J.Tan           TSK 0819992
.            Mods RCDTALLO to 2 instead of 0 for Suspense register
. V10.08.04  29/06/2016  J.Tan            TSK 0818049
.            Mods to display ERA for receipt released by eclipse
. V10.08.03  17/06/2016  Ebon Clements    TSK 596
.            Removed next page code so all records display - TPAY0000 TRCP0000
. V10.08.02  19/05/2016  J.Tan        TSK 0818596
.            Fixed tag for payment type (CSHE2400)
. V10.08.01  18/04/2016  Peter Vela   TSK 0294177
.            Recompiled for PRINTHS1
. V10.07.03  02/03/2016  J.Tan        CAR 303942
.            Mods displaying EFTPOS payment type on view receipt
. V10.07.02  15/01/2016  J.Tan        CAR 303942
.            Mods for Payment code
. V10.07.01  17/11/2015  J.Tan        CAR 303942
.            Mods for Payment code
. V10.06.01  18/06/2015  Ebon Clement CAR 317589
.            Recompiled for RCPPRTCD - Extra contacts read
. V10.05.02  04/12/2014  Peter Vela   CAR 309543
.            Recompiled for RCPWEB01
. V10.05.01  20/11/2014  Peter Vela   CAR 308500
.            Added Date Record Updated, Time Record Updated and 
.            Web User Id Updated on Cancel Receipt in RCPPRT40
. V10.04.04  20.06.2014  J.Tan        CAR 302000
.            Recompiled for RCPPRTCD - printing deposit type desc.
. V10.04.03  07.04.2014  Peter Vela   CAR 286158
.            Recompiled for PATMASTM
. V10.04.02  31.03.2014  B.G.Ackland  CAR 299363
.            Replace META Tag Redirect with Javascript in Common RDIREC00
.            Routine
. V10.04.01  07/02/2014  Steve Armstrong  CAR 288084
.            Recompiled for changes to TMPDTEFD
.------------------------------------------------------------------------------
. V10.03.11  05/12/2013  J.Tan         CAR 294414
.            Fixed LRCP0000 routine to check Visit type against Cash Register
. V10.03.10  14/10/2013  J.Tan         CAR 292649
.            Added a tag for Credit Card surcharge register for Multi Hosp.
. V10.03.09  24/07/2013  J.Tan         CAR 288013
.            Recompiled for RCPDTETD - increased printer code to DIM6
. V10.03.08  19/07/2013  Ebon Clements   CAR 288624
.            Increased refund deposit arrays and display from 99 to 200 lines
. V10.03.07  15/02/2013  Peter Vela      CAR 281036
.            Changed DietIcon to EditIcon
. V10.03.06  15/01/2013  J.Tan           CAR 240374
.            Recompiled for RCPPRTCD - added PRFA variables from patre1af
. V10.03.05  04/09/2012  J.Tan           CAR 268233
.            Mods for Emergency Reassign Debts
. V10.03.04  12/04/2012  J.Tan           CAR 252226
.            Mods for Default Deposit/Invoice receipts register of Cash drawer
. V10.03.03  08/03/2012 Peter Vela CAR 261515
.            Commented out CNERCP00
. V10.03.02  02/02/2012  J.Tan           CAR 246107
.            Mods checking for Inactive Cash drawers
. V10.03.01  16/01/2012  Sandra Barcham  CAR 256563
.            Recompiled for PATMASTM
. V10.02.06  26/10/2011 J.Tan            CAR 253933
.            Mods to set PTMASNAM before packing patient name
. V10.02.05  12/10/2011 J.Tan  CAR 235370
.            Recompiled for RCPPRTCD - NHI names for SX
. V10.02.04  05/10/2010  J.Tan          CAR 249242
.            Mods to set Receipt Reference for SX Extract
. V10.02.03  28/07/2010  J.Tan          CAR 244159
.            Mods for Credit Card Surcharge Register 89 
. V10.02.02  18/04/2011  Mike Laming    CAR 233901
.            Correct Allocated Time in SUSROW60
. V10.02.01  04/04/2011  Jill Parkinson CAR 239574
.            Removed open of ibaprntf
. V10.01.02  22/02/2011  Mike Laming    CAR 233901
.            Billing Changes - Modify Receipt Enquiry for Suspense - at VRCP0000
.            Add "Suspense Enquiry" Report 8 - SUSENQ00
.            16/03/2011 J.Tan           CAR 233264
.            Fixed updating Unreconciled invoice file to update date/time
. V10.01.01  08/12/2010  J.Tan          CAR 234960
.            Fixed SX G/L Extract for No refund deposit entered
. V10.00.08  26/10/2010  Peter Vela      CAR 230719
.            Added nocopies to SETPAR00
. V10.00.07  27/09/2010  Mike Laming     CAR 222934
.            Changed report 5 to split TNBEFTPO & TOTEFTPO into Cr & Db values
. V10.00.06  10/08/2010 Peter Vela       CAR 181784
.            Added Date Created, Time Created and User ID to RCPLST00
. V10.00.05  03/08/2010 J.Tan            CAR 191023
.            Mods to write un-balanced invoice to un-reconciled invoice file
. V10.00.04  21/07/2010  J.Tan          CAR 226011
.            Recompiled for RCPPRTCD - printing Name for HWK Sundry debtor
. V10.00.03  18/05/2010  Peter Vela     CAR 221795
.            Modified CNERCP00 according to table changes in pmserhaf pmserdaf
.            rcpdteaf
. V10.00.02  22/04/2010  Peter Vela     CAR 216940
.            Added check to see if cancelling a suspended Eclipse Claim Rec
. V10.00.01  15/04/2010  Peter Vela     CAR 216920
.            Added check to see if cancelling an Eclipse Claim Request
. V9.12.09   03/03/2010  J.Tan          CAR 216328
.            Added parameter for Using One char of Register default ledger
. V9.12.08   29/01/2010  Jill Parkinson CAR 213823
.            Added NOCHKREC to TRCP0000
. V9.12.07   11/11/2009  J.Tan         CAR 209919
.            Added NOCHKREC - not to check NORECORD on TPAY0000
. V9.12.06   23/10/2009  Ebon Clements CAR 185901
.            Recompiled for RCPPRTCD - Print debtor number
. V9.12.05   20/07/2009  Peter Vela    CAR 186118
.            Added validation for nz to display Direct Credit in DPAY0000
. V9.12.04   09/07/2009  J.Tan         CAR 199760
.            Recompiled for RCPPRTCD - ED Receipt header/tail
. V9.12.03   26/06/2009  J.Tan         CAR 191624
.            Added option for Transfering deposit to an invoice
. V9.12.02   24/06/2009  Jill Habasque CAR 191626
.            Recompiled for RCPPRTCD - printing visit number for deposits
. V9.12.01   26/05/2009  J.Tan      CAR 197291
.            Recompiled for RCPPRTCD - Credit Card description
. V9.11.01   28/01/2009  Peter Vela CAR 188375
.            Recompiled for RCPPRTCD - Added PRFA for Inpatient Deposits (97)
. V9.10.08   11/09/2008  J.Tan      CAR 151983
.            Recompiled for RCPPRTCD - PRFA for Sundry Debtors
. V9.10.07   08/09/2008  J.Tan      CAR 170368
.            Mods checking for header/tail code prior printing receipt
. V9.10.06   27/08/2008  J.Tan      CAR 176988
.            Mods to display cheque details on receipt enquiry
. V9.10.05   12/08/2008  J.Tan      CAR 175949
.            Recompiled for IBAWEBCD - Printer selection for user id
. V9.10.04   06/08/2008  Ebon Clements CAR 175520
.            Added reconciled test to CANR0000
. V9.10.03   05/08/2008  J.Tan      CAR 175520
.            Mods not to allow to cancel receipt after been reconciled
. V9.10.02   26/05/2008  J.Tan      CAR 163654
.            Mods Refunded deposits for SX G/L Extract
. V9.10.01   13/05/2008 J.Tan              CAR 162313
.            Added Deposit status to comdepaf
. V9.09.20   27/03/2008  Ebon Clements     CAR 161156   
.            Added returnfl cgi            
. V9.09.19   26/03/2008  Peter Vela        CAR 163975
.            Recompiled for PRINTHS1
. V9.09.18   19/03/2008  Peter Vela        CAR 163975
.            Recompiled for PRINTHS1
. V9.09.17   21/02/2008  Mike Laming       CAR 161012
.            Recompiled for RCPPRTCD - added printing "Cancelled" receipts
. V9.09.16   20/02/2008  Peter Vela        CAR 162070
.            Recompiled for RCPPRTCD
. V9.09.15   07/02/2008  J.Tan             CAR 134035
.            Fixed index of tmpdteaf file
. V9.09.14   25/01/2008  Ebon Clements     CAR 160205
.            Fixed OVRCD branch at SRCHNX20 to stop infinite loop
. V9.09.13   28/12/2007  J.Tan             CAR 134035
.            Mods for Internal Receipts Comments
. V9.09.12   17/10/2007  Jill Habasque     CAR 151403
.            Fixed output of refunded description
. V9.09.11   16/10/2007  J.Tan             CAR 151560
.            Recompiled for RCPPRTCD - mods to print method of payments
. V9.09.10   15/10/2007  J.Tan             CAR 151560
.            Recompiled for RCPPRTCD - mods to print method of payments
. V9.09.09   12/10/2007  Jill Habasque     CAR 151403
.            Added check for cancelled deposits in DEPROW00
. V9.09.08   11/10/2007  J.Tan             CAR 151560
.            Fixed I*C on index 4 patwr1af file
. V9.09.07   08/10/2007  J.Tan             CAR 151560
.            Recompiled for RCPPRTCD - mods to print method of payments
. V9.09.06   27/09/2007  J.Tan             CAR 151260
.            Recompiled for RCPPRTCD - mods to printing deposits register
. V9.09.05   07/09/2007  Ebon Clements     CAR 149260 
.            Changed Payee to Payer
. V9.09.04   30/07/2007  Ebon Clements     CAR 146302
.            Recompiled for RCPPRTCD - Private Prac deposit PRFA
. V9.09.03   05/07/2007  Ebon Clements     CAR 143757
.            Added multi hospital tests to CDSLTN00 and SRCHNX00
. V9.09.02   29/06/2007  Ebon Clements     CAR 142480
.            Changed TPAY0000 and TRCP0000 norecords to 99
. V9.09.01   13/07/2007  Jill Habasque     CAR 141511
.            Mods to display "Refunded" in DEPROW00 and DRCP0000
. V9.08.12   17/05/2007  J.Tan             CAR 140282
.            Mods to parameter 'Using FMS' for Other 
. V9.08.11   19/04/2007  J.Tan             CAR 138500
.            Recompiled for RCPPRTCD - for JH Patient's name
. V9.08.10  26/02/2007 Mike Laming        CAR 133897
.            Increase size of temp Address fields PRNTADDn (from 20 to 35)
. V9.08.09   20/02/2007 Ebon Clements      CAR 132148
.            Recompiled for RCPPRTCD - Private Prac PRFA
. V9.08.08   07/02/2007  Davin          CAR 126848
.            Added code for cash receipt type 4 - fund group
.            31/01/2007  Peter Vela     CAR 127930
.            Recompiled for MRTMASFD
. V9.09.07   15/12/2006 Sandra Barcham     CAR 127625
.            Fix print deposit for JH
. V9.08.06   13/12/2006  J.Tan             CAR 127625
.            Mods to JH HRN                     
. V9.08.05   08/12/2006  J.Tan             CAR 127642
.            Added colum for Reference no for payment details
. V9.08.04   04/12/2006  J.Tan             CAR 126773
.            Recompiled for RCPPRTCD - JH receipt details
. V9.08.03   27/11/2006  Steve Armstrong   CAR 126039
.            Recompiled for changes to SGCHKDIG
. V9.08.02   16/11/2006  Steve Armstrong   CAR 124160
.            Recompiled for RCPPRTCD (Singapore HRN)
. V9.08.01   18/10/2006 Ebon Clements CAR 118900
.            Added check for cancelled receipts - DRCP0000 and DLRCP000
.------------------------------------------------------------------------------
. V9.07.04   01/09/2006 Ebon Clements CAR 111214
.            Recompiled for RCPPRTCD - Receipt date
. V9.07.03   24/08/2006 Peter Vela    CAR 117188
.            Recompiled for RCPPRTCD
. V9.07.02   27/07/2006 Peter Vela    CAR 114217
.            Recompiled for RCPPRTCD
. V9.07.01   06/07/2006 J.Tan         CAR 111587
.            Fixed schedule user id for re-printing a receipt
. V9.06.03   16/05/2006 Peter Vela    CAR 105533
.            Recompiled for RCPPRTCD
. V9.06.02   10/05/2006 Peter Vela    CAR 104751
.            Added PRNTADD4 Address Line 4
. V9.06.01   24/04/2006 J.Tan         CAR 102287
.            Recompiled for RCPPRTCD - added fields for multi hospital details
. V9.05.03   26/03/2006 Peter Vela    CAR 61299
.            Recompiled for RCPPRTCD
. V9.05.02   10/03/2006 J.Tan         CAR 90428
.            Fixed GETC0000 for GST Account 
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01  30/01/2006  Ebon Clements CAR 93186
.            Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.20   19/10/2005 J.Tan         CAR 49925
.            Recompiled for RCPPRTCD - Added RCCNRCLN (no of lines for Receipt)
. V9.04.19   12/10/2005 J.Tan  CAR 67445
.            Recompiled for RCPPRTCD - Anne Caudle receipt layout
. V9.04.18   04/08/2005   J.Tan        CAR 62750 
.            Mods not to use the redefined amount variables
. V9.04.17   31/05/2004 J.Tan         CAR 61641
.            Mods for multi hospital
. V9.04.16   27/05/2004 J.Tan         CAR 61641
.            Recompiled for RCPPRTCD - added page number
. V9.04.15   26/05/2004 J.Tan         CAR 61641
.            Recompiled for RCPPRTCD - to read dpath multi database
. V9.04.14   26/05/2004 J.Tan         CAR 61641
.            Recompiled for RCPPRTCD - Ballarat layout multiple page
. V9.04.13   23/05/2004 J.Tan         CAR 61641
.            Recompiled for RCPPRTCD - Ballarat layout
. V9.04.12   19/05/2004 J.Tan         CAR 61641
.            Recompiled for RCPPRTCD - Ballarat layout
. V9.04.11   23/05/2005  Mike Laming  CAR 58556
.            1) Recompiled for RCPREGFD/IO - New Index and field REGACTIV
.            2) Change routines for REGACTIV and tag REGCP015
. V9.04.10   07/12/2004 Lina Vo     CAR 55180
.            Recompiled for RCPPRTCD
. V9.04.09   30/11/2004 Guomin Fu   CAR 55180
.            Recompiled for RCPPRTCD ( HFORMAT=4 for Pendlebury Receipt Layout)
. V9.04.08   16/11/2004 Lina Vo             
.            Fixed Using FMS on Register for Multi Hospital    
. V9.04.07   16/11/2004 Lina Vo             
.            Recompiled for RCPPRTCD.                          
. V9.04.06   01/10/2004 J.TaN   CAR 53909
.            Added field for Using FMS system to hospital ID 
. V9.04.05   17/09/2004 Lina Vo
.            Put in extra checks for HSYS3 and HSYS6 and to not read files
.            10/09/2004 Lina Vo     CAR 53252
.            Changed Hospital ID on Register Maintenance screen to be Mandatory
. V9.04.04   08/09/2004 Lina Vo     CAR 51714
.            Added new Patient level Deposit List to report 7
.            02/09/2004 Jill Habasque     
.            Changed RCPDR007 from dim14 to 15
. V9.04.03   30/08/2004 Lina Vo CAR 53012
.            Recompile for PRINTHS1 
. V9.04.02   26/08/2004 Lina Vo CAR 53012
.            Added extra variables for PRINTHS1 called by RCPPRTCD
. V9.04.01   18/08/2004 Lina Vo CAR 52746
.            Added Multi-Hospital to Register Maintenance
. V9.03.24   05/08/2004 Lina Vo CAR 51719
.            Added Admission number to view Receipt. 
.            Fixed Display of Names on Receipts when no scanflag found. 
. V9.03.23   14/07/2004 J.Tan   CAR 50108           
.            Fixed receipt search to include un-released deposit
. V9.03.22   05/07/2004 Lina Vo   CAR 51112         
.            Fixed display of UR and Patient when there's no RCDTTCNT=1
. V9.03.21   21/06/2004 Lina Vo CAR 50822
.            Added extra system tags to REGS000                
. V9.03.20   07/06/2004 Peter Vela CAR 49016
.            2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.19   01/06/2004 J.Tan CAR 50273
.            Fixed I*C - outsitaf file
. V9.03.18   27/05/2004 J.Tan 
.            Recompiled for RCPPRTCD - print receipt for RCH
. V9.03.17   18/05/2004 Lina Vo                  CAR 49829
.            Fixed Search Receipt by Cheque number
. V9.03.16   03/05/2004 J.Tan
.            Added a tag for Refund deposit option
. V9.03.15   23.04.2004 Pat Dirito               CAR 49181
.            Added check for OPEN Account Types in GETACC00
.            23.04.2004 Lina Vo                  CAR 49254
.            Added FORM8P2 for RCPPRTCD.                      
. V9.03.14   22.04.2004 Pat Dirito               CAR 49181
.            Added check different Account Types in GETACC00
. V9.03.13   01/03/2004  Linav Vo CAR 47921
.            Removed use of PRIDBTFD & IO.     
. V9.03.12   02/02/2004  Linav Vo CAR 44087
.            Added Report 7 - Receipt Enquiry. 
. V9.03.11   02/02/2004  J.Tan  CAR 44086
.            Mods for Refund deposit
. V9.03.10   21/01/2004  J.Tan
.            Recompiled for RCPPRTCD - printing receipts for EMR
.            21/01/2004  Lina Vo CAR  44073
.            Removed VALREG00 (Report 1) - no longer required         
. V9.03.09   16/01/2004  Lina Vo CAR  44073
.            Removed all print receipt routines and put in RCPPRTCD.
. V9.03.08   15/01/2004  J.Tan   CAR  44079
.            Added option to Cancel receipts
. V9.03.07   09/01/2004  J.Tan   CAR  44078
.            Added option to re-print receipts
.            13/01/2004  Lina Vo  CAR  44073
.            Changed Default Cheque Account (RCCICHQA) tag to be a 
.            Selection List.
. V9.03.06   19/12/2003  Pat Dirito         CAR 43983      
.            Added remote script VALREG00 - Validate Register Group
. V9.03.05   17/12/2003  Lina Vo            CAR 44080      
.            Added Cash Drawer Maintenance from RCPWEB03.
.            Changed Cash Drawer Enquiry to use new receipting tables.
. V9.03.04   09/12/2003  Ebon Clements      CAR 43986      
.            Added a new tag for the cash drawer default cheque account
. V9.03.03   28/11/2003  Jill Habasque      CAR 43980      
.            Removed Cashier ID maintenance, added hospital to cash drawer
.            maintenance
. V9.03.02   06/11/2003  Pat Diirto         CAR 43981      
.            Added reportno 3 Cash Drawer ID Maintenance & report 4
.            Remote Script for Control Account Details
. V9.03.01   15/10/2003  Pat Diirto         CAR 43983      
.            Added reportno 2 Register Maintenance                    
.            15/10/2003  Ebon Clements      CAR 43980      
.            Added web user id to rcpcshaf
. V9.03.00   08/10/2003  Tracey Nguyen      CAR 43980      
.            Created new web server program for Cashier Maintenance   
.            Table (rcpcshaf).             
.------------------------------------------------------------------------------
.
.------------------------------------------------------------------------------
. FD Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBDF
          INC       WEBDATDF
.
          INC       CHKDIGVR/INC
          INC       DEBITMFD/INC
          INC       PMSECAFD/INC
          INC       PMSECTFD/INC
          INC       PMSCEXFD/INC
          INC       PMSERDFD/INC
          INC       PMSERHFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSPX2TD/INC
          INC       MRTMASFD/INC
          INC       PATFN1FD/INC
          INC       PATMI1FD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       NHIETHFD/INC
          INC       PATDO1FD/INC
          INC       PATWR1FD/INC
          INC       PATPR1FD/INC
          INC       PATALRFD/INC
          INC       APSMASFD/INC
          INC       PATGO1FD/INC
          INC       PATIN1FD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       OUTPREFD/INC
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       COMDEPFD/INC      * Deposit file
          INC       COMAUDFD/INC      * Deposit Audit file
          INC       PATCOMM/INC       * IBA Control file
          INC       IBASMAFD/INC      * Common system master file
          INC       NHIMASFD/INC
.
          INC       PATCONFD/INC
          INC       PATHSPFD/INC      * Common system master file
          INC       PATHGPFD/INC
          INC       PATDPTHV/INC
          INC       PATHOSFD/INC
          INC       PATINVFD/INC      * Invoice file
          INC       PATMA1FD/INC
          INC       PMSVX1FD/INC
          INC       PATNIDFD/INC
          INC       PATRE1FD/INC
          INC       PATVISFD/INC
          INC       PMSCCDFD/INC      * Concession Card Details
          INC       PMSPX2FD/INC
          INC       PATUREFD/INC
.
          INC       RCPCRSFD/INC      * Credit card surcharge file
          INC       RCPCMNFD/INC      * Internal Receipt Comments File
          INC       RCPBNKFD/INC      * Bank Header File
          INC       RCPBDTFD/INC      * Bank Detail File
          INC       RCPDBPFD/INC      * Receipt Detail Invoice Item payment
          INC       RCPDTEFD/INC      * Receipt Detail File
          INC       RCPCIDFD/INC      * Cash Drawer File
          INC       RCPREGFD/INC      * Register Table          
          INC       RCPSRTFD/INC      * Suspense Receipt Table
          INC       RCPCONFD/INC      * Receipting System Control File
          INC       TMPBNKFD/INC      * Temporary Bank Header File
          INC       TMPBDTFD/INC      * Temporary Bank Detail File
          INC       TMPDTEFD/INC      * Temporary Receipt Detail File
.
          INC       AAEDE1FD/INC
          INC       EMRVISFD/INC
          INC       EMRSITFD/INC
.
          INC       FMSLMAFD/INC      * Ledger Master Details
          INC       FMSDISFD/INC      * Dissection Codes
          INC       FMSRESFD/INC      * Responsibility Codes 
          INC       FMSCHQFD/INC      * Cheque Account Master Details
          INC       FMSAMAFD/INC      
          INC       FMSCSAFD/INC
          INC       FMSCAFFD/INC
.
          INC       IBAGSTFD/INC      * GST Master
          INC       IBATMDFD/INC      * Template Tail
.
          INC       PRIUREFD/INC
          INC       PRIINVFD/INC
          INC       PRIPRAFD/INC
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PRIALSFD/INC                 * Medical Prac.all user access
          INC       PRISECFD/INC                 * Medical Prac.security access
.
          INC       DEBDBTFD/INC
          INC       DEBFTHFD/INC
          INC       DEBFDTFD/INC
.
          INC       RCPBNKTD/INC
          INC       RCPBDTTD/INC
          INC       RCPDTETD/INC
          INC       NZPEXTFD/INC
          INC       TFILEVAR/INC
. 
.-----------------------------------------------------------------------------
. Variable Declarations
.-----------------------------------------------------------------------------
CODEPP    INIT      "P/P"
CODEIR    INIT      "I/R"
CODESP    INIT      "S/P"
CODESR    INIT      "S/R"
CODEPY    INIT      "Py"
DIM3A     DIM       3 
DIM11A    DIM       11
DIM11B    DIM       11
DIM15     DIM       15
DIM16A    DIM       16
DIM20     DIM       20
DIM30     DIM       30
DIM37     DIM       37
DIM50B    DIM       50
DIM60A    DIM       60
DIM60B    DIM       60
DIM100    DIM       100
CODEUR    INIT      "U/R"
IBA0      INIT      "Not Applicable                "
IBA1      INIT      "Patient Billing               "
IBA2      INIT      "Private Practice              "
IBA3      INIT      "Sundry Debtors (Phase Out)    "
IBA4      INIT      "Medical Services              "
IBA5      INIT      "Sundry Accounts Rec.          "
IBA6      INIT      "Nursing Home                  "
PPRVTYPE  INIT      "Private Practice"
EMRVTYPE  INIT      "Emergency       "
OUTVTYPE  INIT      "Outpatient      "
INPVTYPE  INIT      "Inpatient       "
INCOMCOD  DIM       12
ACCNO     DIM       12
ACCNTYPE  FORM      1
LEDNO     DIM       2
LEDNUM    DIM       1
LASTRECP  FORM      3
CFILEPRE  DIM       3                       * Site Prefix
CHNGDATE  DIM       8
BNKLEDNO  DIM       15
BNKLEDSC  DIM       35
DOCTCODE  DIM       6
DIM8      DIM       8
DIM10     DIM       10
DIM11     DIM       11            * Used by PRINTHS1
DIM12     DIM       12
DIM40     DIM       40
DISPDATE  DIM       12
DISPDTE1  DIM       12
DISPDTE2  DIM       12
DISPFLAG  FORM      1
DEBLEDNO  DIM       15
DEBLEDSC  DIM       35
FORM3     FORM      3
FORM5     FORM      5
FORM8     FORM      8
FORM12    FORM      12
FORM12P2  FORM      12.2
GSTLEDNO  DIM       15
GSTLEDSC  DIM       35
INCOMDSC  DIM       35
NEXTDKEY  DIM       25
NEXTTKEY  DIM       41
OLDRECPT  DIM       12
OUTSTAMT  FORM      12.2
PREVDKEY  DIM       25
PREVTKEY  DIM       41
PRVDFLAG  FORM      1
PRVTFLAG  FORM      1
SITECODE  DIM       6
SUSTYPE   DIM       1
SAVEKEY   DIM       39
SKEY17    DIM       17
SAVKEY25  DIM       25
SRCHTYPE  FORM      1
STATUS    DIM       10
SVINVLNE  DIM       3
TOTPAID   FORM      12.2
TOTAMT    FORM      12.2
TOTAMTPD  FORM      12.2
.
. CGI Parameters
. **************
.
NOCHKREC  FORM      1
NEXTPAGE  FORM      1         * Nextpage parameter
UPDTTYPE  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
STARTKEY  DIM       10        * Starting Key for search
IBADESC   DIM       30
VALDCODE  DIM       70        * Validation Code
LISTTYPE  FORM      1         * Account List Type
SYSTMCOD  FORM      2
REGISCOD  DIM       3
RECEIPTN  DIM       12
INVOICEN  FORM      12
TRANSNUM  DIM       17[200]     * Array of transaction count
REASFUND  DIM       3[200]     * Array of reason for refund
VISITTYP  FORM      1
VISTDATE  DIM       8
INVCDATE  DIM       12
RCPTDATE  DIM       8
RCPTDATL  DIM       11
SCANFLAG  FORM      1
MDPRAC    DIM       6[99]
MINMAMNT  FORM      12.2
MPGEFLAG  FORM      1
CHEQUENO  DIM       12
DEPSONLY  FORM      1
INVNUMBR  DIM       12
TRANSCNT  DIM       5 
TRANDATE  DIM       8
TRANTIME  DIM       8
TRNVISTP  DIM       9
TRNVISIT  DIM       8
TRNVTYPE  DIM       1
TRNMPRAC  DIM       6
TRNSDOCT  DIM       10
TRNREGIS  DIM       3
TRNDTYPE  DIM       3
ALOCDATE  DIM       8
ALOCDATL  DIM       11
SELALLOC  FORM      1
SELUNALL  FORM      1
SSRETURN  DIM       24
REVRECPT  FORM      1     * Receipt Number Order 
.
.
. Regesiter parameters (RCPREGFD)
.
REGCP001  DIM       3     * REGISTER CODE
REGCP002  DIM       35    * DESCRIPTION
REGCP003  DIM       15    * CHEQUE ACCOUNT CODE
REGCP004  DIM       14    * GENERAL LEDGER INCOME A/C
REGCP005  DIM       14    * GENERAL LEDGER CONTROL A/C
REGCP006  DIM       3     * GROUP CODE
REGCP007  FORM      2     * IBA SYSTEM CODE
REGCP008  FORM      2     * SUNDRY DEBTORS LEDGER NUMBER
REGCP009  DIM       5     * GL DISSECTION CODE
REGCP010  DIM       4     * GL RESPONSIBILITY CODE
REGCP011  DIM       14    * General ledger suspense A/C
REGCP012  DIM       6     * GST Code
REGCP013  DIM       2     * Register Group
REGCP014  DIM       3     * Multi-Hospital ID
REGCP015  DIM       1     * Register Activity Ind. 1=Inactive          *I-58556
REGCP016  DIM       14    * G/L Debtors Control A/C
REGCP017  DIM       14    * G/L GST Control A/C
REGCP018  DIM       3     * Register for Credit Card Surcharge
.
. Cash Drawer Id Maintenance (RCPCIDFD)
.
RCPDR001  DIM       6     * CASHIER CODE
RCPDR002  DIM       6     * PASSWORD
RCPDR003  DIM       20    * SURNAME
RCPDR004  DIM       20    * GIVEN NAME
RCPDR005  FORM      1     * SECURITY CODE
RCPDR006  DIM       3     * HOSPITAL
RCPDR007  DIM       15    * DEFAULT CHEQUE ACCOUNT NUMBER
RCPDR008  DIM       1     * Activity Flag
RCPDR009  DIM       1     * Charging Credit Card Surcharge
RCPDR010  DIM       3     * Default Invoice Receipt Register
RCPDR011  DIM       3     * Default Deposit Receipt Register
RCPDR012  DIM       6     * 3rd party payment source
.
. Program Variables
. *****************
.
DIM3      DIM       3
DIM5      DIM       5
COUNTER   FORM      3
CMDLINE   DIM       50
CURRROW   FORM      3
CRCPDATE  DIM       8
CSHRNAME  DIM       30        * Cashier name
CANCLMSG  DIM       35
CASHDRWR  DIM       6
CASHIERC  DIM       10
.
ECLRCINC  DIM       1
ECLRCINX  DIM       24
ECLRCIND  DIM       1
ECLRCINH  DIM       3
.
FORM8P2   FORM      8.2
.
SHOWTOTS  FORM      1
SBWINDOW  FORM      1
.
PAYMDESC  DIM       40[99]       * Array of payment type
TOTCHQ    FORM      10.2         * Total Banked Cheque
TOTCRED   FORM      10.2         * Total Banked Credit
TOTDDBT   FORM      10.2         * Total Banked Direct Debit
TOTMONOR  FORM      10.2         * Total Banked Money Order
TOTEFTCR  FORM      10.2         * Total Banked EFTPOS - Credit Card
TOTEFTDB  FORM      10.2         * Total Banked EFTPOS - Debit (cash) Card
TOTBPAY   FORM      10.2         * Total Banked BPAY
TOTHCAP   FORM      10.2         * Total Banked HICAPS
TOTMCAR   FORM      10.2         * Total Banked Medicare
TOTOTHR   FORM      10.2[99]     * Total Banked for other payment
.
TOTTOTAL  FORM      10.2
TNBCASH   FORM      10.2         * Total Not Banked Cash
TNBCHQ    FORM      10.2         * Total Not Banked Cheque
TNBCRED   FORM      10.2         * Total Not Banked Credit Card
TNBDDBT   FORM      10.2         * Total Not Banked Direct Debit
TNBMONOR  FORM      10.2         * Total Not Banked Money Order
TNBEFTCR  FORM      10.2         * Total Not Banked EFTPOS - Credit Card
TNBEFTDB  FORM      10.2         * Total Not Banked EFTPOS - Debit (cash) Card
TNBBPAY   FORM      10.2         * Total Not Banked BPAY
TNBHCAP   FORM      10.2         * Total Not Banked HICAPS
TNBMCAR   FORM      10.2         * Total Not Banked Medicare
TNBOTHR   FORM      10.2[99]     * Total Not Banked for other payment
.
MAXCLNO   FORM      2
REFERENC  DIM       20
.
PRFANAME  DIM       80
PRFAADD1  DIM       35
PRFAADD2  DIM       35
PRFAADD3  DIM       35
PRFAADD4  DIM       35
PRFAPOST  DIM       8
.
PATPROVD  DIM       20           * Patient or PP Provider
PPRAADD1  DIM       30
PPRAADD2  DIM       30
PPRASUBR  DIM       30
PPRAPOST  DIM       4
PATNAME   DIM       30                * formatted patient name
PNAM15    DIM       15
PRNTADD1  DIM       35
PRNTADD2  DIM       35
PRNTSUBR  DIM       35
PRNTADD4  DIM       35
PRNTPOST  DIM       4
PRNTNAME  DIM       80
PRNTRNAM  DIM       80
PRNTPNAM  DIM       30
PRNTPNUM  DIM       8
PRNTSTRT  FORM      3
PRNTPTYP  DIM       15               * I-55180 (payment type)
PRNTCTYP  DIM       3                * I-55180 (card type)
REF10     DIM       10
REFUNDR   FORM      3
RETURNFL  DIM       1
SHREGIS   DIM       26                      * short register decsription
SPRAFLAG  FORM      1
TMPLTFLG  FORM      1
TAILLENG  FORM      3
TOTCASH   FORM      10.2         * Total Banked Cash
XXDPATH   DIM       120
NMPNUMB   DIM       20
HEADTAIL  FORM      1
HREGFLAG  FORM      1
MRCNNOHS  FORM      2
VARIABLE  DIM       127
.
. Program Constants
. *****************
DOLLAR    INIT      "$"
NBSP      INIT      "&nbsp;"
HFHEADER  INIT      "0000    "
.
BANKED    INIT      "Banked"
CANCELLD  INIT      "Cancelled"
NOTBANKD  INIT      "Not Banked"
.
PATIENT   INIT      "Patient"
HEALTHFD  INIT      "Health Fund"
INSRCOMP  INIT      "Insurance Co."
GOVTDEPT  INIT      "Govt. Dept."
HLTHFDGP  INIT      "Fund Group"
.
AECNAERH  DIM       6         * AAE Receipt Header Code (templated)
AECNAERT  DIM       6         * AAE Receipt Tail Code (templated)
ACCTYP1   INIT      "Income"
ACCTYP2   INIT      "Expense"
ACCTYP3   INIT      "Asset"
ACCTYP4   INIT      "Liability"
ACCTYP5   INIT      "Equity"
ACCTYP6   INIT      "Total"
ACCTYP7   INIT      "Heading"
ACCTYP8   INIT      "stat posting"
ACCTYP9   INIT      "stat total"
REFUNDED  INIT      "Refunded - "
REFDASH   INIT      "Ref - "
SP37      INIT      "                                     "
+
.-----------------------------------------------------------------------------
.
PRGID     INIT      "RCPWEB01"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Re-Print Cash Receipting Server"
+
.------------------------------------------------------------------------------
.
          CALL      WEBINT00                * Initialise Fifo Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      WEBRED00                * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO          * End Server Process if Option=999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00                * Output File & Write HTML Pg Header
          GOTO      MAIN1000
.
MAIN1100                                    * No longer required               
          GOTO      MAIN1000
.
MAIN1200  CALL      RCPREG00                * Register Maintenance        
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1300  CALL      RCPCID00                * Cash Drawer Id Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1400  CALL      GETACC00                * Remote Script - 
          GOTO      MAIN1000                * Get Control Account Details
.
MAIN1500  CALL      RCPCSH00                * Cash Drawer Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1600  CALL      RCPPRT00                * Cancel Receipt /Print Receipt
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
.
...       IF        SBWINDOW<>ZERO
...         CALL      WINALT00
...       ELSE
...         CALL      DISALT00
...       ENDIF
          GOTO      MAIN1000
.
MAIN1700  CALL      RCPENQ00                * Receipt Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN1800  CALL      SUSENQ00                * Suspense Receipt Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000                * next page
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
+
.------------------------------------------------------------------------------
.  Next Page URL
.------------------------------------------------------------------------------
.
NXTPG000  IF        NEXTPAGE=0
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF

          IF        NEXTPAGE=1
            CALL      RDIREC00              * Redirect URL
          ENDIF
.
          IF        NEXTPAGE=2
            CALL      GOBACK00              * Go Back 1 html page
          ENDIF
.
          IF        NEXTPAGE=3
            CALL      DAH20000              * Go Back 2 html pages
          ENDIF
.
          IF        NEXTPAGE=4
            CALL      PREDIR00              * Go Back 2 html pages
          ENDIF
.
NXTPG999  RETURN
+
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------------------------
.  Goes back 1 page
.------------------------------------------------------------------------------
.
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"

          CALL      CLOSHTML
.
GOBACK99  RETURN
+
.------------------------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------------------------
INIT0000  OPEN      IBASMAA1,"ibasmaaf"
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      MRTMASA1,"mrtmasaf"
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATCODE5,"patcodes"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATGO1A1,"patgo1af"
          OPEN      PATHGRP1,"pathgrpf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PMSECAA1,"pmsecaaf"
          OPEN      PMSECTA4,"pmsectaf"
          OPEN      PMSECTA6,"pmsectaf"
          OPEN      PMSERHA1,"pmserhaf"
          OPEN      PMSERDA1,"pmserdaf"
          OPEN      PMSERDA2,"pmserdaf"
          OPEN      OUTSITA1,"outsitaf"
.
          OPEN      RCPCRSA1,"rcpcrsaf"
          OPEN      RCPCMNA1,"rcpcmnaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPBNKA2,"rcpbnkaf"
          OPEN      RCPBNKA3,"rcpbnkaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPBDTA3,"rcpbdtaf"
          OPEN      RCPDBPA1,"rcpdbpaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPDTEA4,"rcpdteaf"
          OPEN      RCPDTEA5,"rcpdteaf"
          OPEN      RCPREGA1,"rcpregaf"          * Register table
          OPEN      RCPREGA3,"rcpregaf"          * Register table
          OPEN      RCPREGA4,"rcpregaf"          * Register table
          OPEN      RCPCIDA1,"rcpcidaf"          
          OPEN      RCPSRTA1,"rcpsrtaf"
          OPEN      RCPSRTA2,"rcpsrtaf"
          OPEN      RCPSRTA3,"rcpsrtaf"
          OPEN      COMDEPA1,"comdepaf"
          OPEN      COMDEPA5,"comdepaf"
.
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATUREA1,"patureaf"
.
          OPEN      WEBSECA1,"websecaf"          * Web security table 
          OPEN      WEBSECA4,"websecaf"
.
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      FMSDISA1,"fmsdisaf"
          OPEN      FMSRESA1,"fmsresaf"
          OPEN      FMSCHQA1,"fmschqaf"
          OPEN      FMSAMAA1,"fmsamaaf"
          OPEN      FMSCSAA1,"fmscsaaf"
          OPEN      FMSCAFA1,"fmscafaf"
.
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      PATWR1A4,"patwr1af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*79,CAPPRVNO,*244,CHOSPNUM
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,HUND30;*1,PTCNHABN
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
          CALL      PATDPATH
.
          READ      CONTROLF,THIRTY6;*86,HSYS1,HSYS2,HSYS3,HSYS4,HSYS5,HSYS6:
                                     *106,HFORMAT,*238,RCCNLEDG:
                                     *243,RCCNCRSR
          READ      CONTROLF,NINTY8;*148,PTCNINVB
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        HSYS2=1
            OPEN      PATMA1A1,"patma1af"
            OPEN      PATMX1A1,"patmx1af"
            OPEN      PMSVX1A1,"pmsvx1af"
            OPEN      PATMI1A1,"patmi1af"
            OPEN      PATRE1A1,"patre1af"
            OPEN      PMSPX2A1,"pmspx2af"
            OPEN      PATVISA1,"patvisaf"
            OPEN      PATINVR1,"patinvrf"
            OPEN      PATINVR5,"patinvrf"
            OPEN      PATWR1A1,"patwr1af"
          ENDIF
.
.         Open files for Private Practice
.
          IF        HSYS3=1
.            OPEN      PRIDEBT1,"pridebtf"
            OPEN      PRIINVO1,"priinvof"
            OPEN      PRIPRAC1,"pripracf"
            OPEN      PRIHDBT1,"prihdbtf"
            OPEN      PRIHREF1,"prihreff"
          ENDIF
.
.         Open files for new account receivable
.
          IF        HSYS6=1
            OPEN      DEBDBTA1,"debdbtaf"
            OPEN      DEBFDTA3,"debfdtaf"
            OPEN      DEBFDTA6,"debfdtaf"
            OPEN      DEBFDTA7,"debfdtaf"
            OPEN      DEBFTHA1,"debfthaf"
            OPEN      DEBFTHA6,"debfthaf"
            OPEN      DEBFTHA7,"debfthaf"
            OPEN      DEBITMA1,"debitmaf"
          ENDIF
.
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          READ      CONTROLF,THIRTY6;*205,RCCNRCHD,RCCNRCTL
.
. open controlf file & template header and details for newer layouts
.
          PACK      CRCPDATE,CCC,CYY,CMM,CDD,SP70
.
          READ      CONTROLF,THIRTY6;*219,RCCNRCLN
          LOAD      MAXCLNO,HFORMAT,RCCNRCLN,RCCNRCLN,ZERO,ZERO,ZERO:
                                    ZERO,ZERO,THIRTY1,ZERO
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      OPNOUT00                    * Open outpatient file
          OPEN      OUTPREA1,"outpreaf"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATINVR3,"patinvrf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRISECA1,"prisecaf"
          OPEN      PRIUREA1,"priureaf"
.
          OPEN      COMAUDA1,"comaudaf"
          OPEN      COMAUDA3,"comaudaf"
.
INIT9999  RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OPNOUT10
.
          MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OPNOUT20 IF NOT EQUAL

OPNOUT10  MOVE      "out",OSTFILE          * open default prefix of out
          GOTO      OPNOUT90
.
OPNOUT20  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OPNOUT10
.
OPNOUT90  MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
OPNOUT99  RETURN
+
.------------------------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,NEXTPAGE
          MOVE      ZERO,STARTNUM
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,NORECORD
          MOVE      SP70,STARTKEY
          MOVE      SP70,VALDCODE
          MOVE      ZERO,LISTTYPE
          MOVE      ZERO,VISITTYP
          MOVE      SP70,INVCDATE
          MOVE      ZERO,SYSTMCOD
          MOVE      SP70,REGISCOD
          MOVE      SP70,RECEIPTN
          MOVE      ZERO,INVOICEN
          MOVE      SP70,SELPRINT
          MOVE      ZERO,SBWINDOW
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          UNPACK    SP70,RCPTDATE,RCPTDATL
          MOVE      ONE,SCANFLAG
          MOVE      ZERO,MINMAMNT
          MOVE      SP70,CHEQUENO
          MOVE      ZERO,DEPSONLY
          MOVE      SP70,INVNUMBR
          MOVE      SP70,TRANSCNT
          MOVE      SP70,TRANDATE
          MOVE      SP70,TRANTIME
          MOVE      SP70,TRNVISTP
          MOVE      SP70,TRNVISIT
          MOVE      SP70,TRNMPRAC
          MOVE      SP70,TRNSDOCT
          MOVE      SP70,TRNREGIS
          MOVE      SP70,TRNDTYPE
          MOVE      ZERO,NOCHKREC
          UNPACK    SP70,ALOCDATE,ALOCDATL
...       MOVE      ZERO,SELALLOC
          MOVE      ONE,SELALLOC
          MOVE      ZERO,SELUNALL
          MOVE      SP70,SSRETURN
.
          MOVE      SP70,NEXTDKEY
          MOVE      SP70,PREVDKEY
          MOVE      ZERO,PRVDFLAG
          MOVE      SP70,NEXTTKEY
          MOVE      SP70,PREVTKEY
          MOVE      ZERO,PRVTFLAG
.
          MOVE      SP70,REGCP001  
          MOVE      SP70,REGCP002  
          MOVE      SP70,REGCP003 
          MOVE      SP70,REGCP004 
          MOVE      SP70,REGCP005 
          MOVE      SP70,REGCP006 
          MOVE      ZERO,REGCP007 
          MOVE      ZERO,REGCP008 
          MOVE      SP70,REGCP009 
          MOVE      SP70,REGCP010 
          MOVE      SP70,REGCP011 
          MOVE      SP70,REGCP012 
          MOVE      SP70,REGCP013 
          MOVE      SP70,REGCP014 
          MOVE      SP70,REGCP015                                      *I-58556
          MOVE      SP70,REGCP016 
          MOVE      SP70,REGCP017 
          MOVE      SP70,REGCP018 
.
          MOVE      SP70,RCPDR001  
          MOVE      SP70,RCPDR002  
          MOVE      SP70,RCPDR003  
          MOVE      SP70,RCPDR004  
          MOVE      ZERO,RCPDR005  
          MOVE      SP70,RCPDR006  
          MOVE      SP70,RCPDR007  
          MOVE      SP70,RCPDR008  
          MOVE      SP70,RCPDR009  
          MOVE      SP70,RCPDR010  
          MOVE      SP70,RCPDR011  
          MOVE      SP70,RCPDR012
.
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
.
          MOVE      ZERO,SHOWTOTS
          MOVE      ZERO,TOTCASH
          MOVE      ZERO,TOTCHQ
          MOVE      ZERO,TOTCRED
          MOVE      ZERO,TOTDDBT
          MOVE      ZERO,TOTMONOR
          MOVE      ZERO,TOTEFTCR             * ( was TOTEFTPO )      *C-222934
          MOVE      ZERO,TOTEFTDB                                     *I-222934
          MOVE      ZERO,TOTBPAY   * Total Banked BPAY
          MOVE      ZERO,TOTHCAP   * Total Banked HICAPS
          MOVE      ZERO,TOTMCAR   * Total Banked Medicare
          MOVE      ONE,F2
          WHILE     F2<99
            MOVE      ZERO,TOTOTHR[F2] * Total Banked for other payment
            MOVE      ZERO,TNBOTHR[F2] * Total Not Banked for other payment
            ADD       ONE,F2
          DO
.
          MOVE      ZERO,TNBCASH
          MOVE      ZERO,TNBCHQ
          MOVE      ZERO,TNBCRED
          MOVE      ZERO,TNBDDBT
          MOVE      ZERO,TNBMONOR
          MOVE      ZERO,TNBEFTCR             * ( was TNBEFTPO )      *C-222934
          MOVE      ZERO,TNBEFTDB                                     *I-222934
          MOVE      ZERO,TNBBPAY              * Total Not Banked BPAY
          MOVE      ZERO,TNBHCAP              * Total Not Banked HICAPS
          MOVE      ZERO,TNBMCAR              * Total Not Banked Medicare
          MOVE      ZERO,TOTTOTAL
          MOVE      ZERO,RETURNFL
          MOVE      SP70,ECLRCINC
          MOVE      SP70,ECLRCINX
          MOVE      SP70,ECLRCINH
          MOVE      ZERO,NOCOPIES
.
          CALL      CPRCBK00       * clear rcpbnkaf cgi fields
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 200
            MOVE      SP70,TRANSNUM[COUNTER]
            MOVE      SP70,REASFUND[COUNTER]
            ADD       ONE,COUNTER
          DO
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER < 98
            MOVE      SP70,PAYMDESC[COUNTER]
            ADD       ONE,COUNTER
          DO
.
          MOVE      ZERO,REVRECPT  *Receipt Number order
.
CLRPAR99  RETURN
.------------------------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "listtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LISTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "systmcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SYSTMCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regiscod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REGISCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nochkrec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCHKREC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextdkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTDKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevdkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVDKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prvdflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRVDFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nexttkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevtkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prvtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRVTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regcp",QRYNAME
          IF        @EQUAL
            CALL      CPREG000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "rcpdr",QRYNAME
          IF        @EQUAL
            CALL      CPCID000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ssreturn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSRETURN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sbwindow=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SBWINDOW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invcdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVCDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "receiptn=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,RECEIPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,VISITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rcpbk",QRYNAME
          IF        @EQUAL
            CALL      SPRCB000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "rcpbt",QRYNAME
          IF        @EQUAL
            CALL      SPRCT000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "rcpde",QRYNAME
          IF        @EQUAL
            CALL      SPRCE000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "trann",QRYNAME
          IF        @EQUAL
            CALL      STTRN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasf",QRYNAME
          IF        @EQUAL
            CALL      STRFN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rcptdate=",QRYNAME
          IF        @EQUAL
            PACK      RCPTDATL,QRYDATA,SP20
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      RCPTDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alocdate=",QRYNAME
          IF        @EQUAL
            PACK      ALOCDATL,QRYDATA,SP20
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      ALOCDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "scanflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCANFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "minmamnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MINMAMNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chequeno=",QRYNAME
          IF        @EQUAL
            PACK      CHEQUENO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "depsonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEPSONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selalloc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELALLOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selunall=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELUNALL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transcnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSCNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnvistp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNVISTP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnmprac=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNMPRAC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsdoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnregis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNREGIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trndtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returnfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eclrcinc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECLRCINC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eclrcinx=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECLRCINX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eclrcinh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECLRCINH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "revrecpt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REVRECPT
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------------------------
. Set Parameters for Cash Drawer Id Maintenance                  
.------------------------------------------------------------------------------
CPCID000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
.
          BRANCH    F3,CPCID001,CPCID002,CPCID003,CPCID004,CPCID005,CPCID006:
                       CPCID007,CPCID008,CPCID009,CPCID010,CPCID011,CPCID012
.
          MOVE      ONE,EXIT
          GOTO      CPCID999
.
CPCID001  MOVE      QRYDATA,RCPDR001
          PACK      RCPDR001,RCPDR001,SP70
          GOTO      CPCID999
.
CPCID002  MOVE      QRYDATA,RCPDR002
          GOTO      CPCID999
.
CPCID003  MOVE      QRYDATA,RCPDR003
          GOTO      CPCID999
.
CPCID004  MOVE      QRYDATA,RCPDR004
          GOTO      CPCID999
.
CPCID005  MOVE      QRYDATA,RCPDR005
          GOTO      CPCID999
.
CPCID006  MOVE      QRYDATA,RCPDR006
          GOTO      CPCID999
.
CPCID007  MOVE      QRYDATA,RCPDR007
          GOTO      CPCID999
.
CPCID008  MOVE      QRYDATA,RCPDR008
          GOTO      CPCID999
.
CPCID009  MOVE      QRYDATA,RCPDR009
          GOTO      CPCID999
.
CPCID010  MOVE      QRYDATA,RCPDR010
          GOTO      CPCID999
.
CPCID011  MOVE      QRYDATA,RCPDR011
          GOTO      CPCID999
.
CPCID012  MOVE      QRYDATA,RCPDR012
          GOTO      CPCID999
.
CPCID999  RETURN
.------------------------------------------------------------------------------
. Set Parameters for Register Maintenance                  
.------------------------------------------------------------------------------
CPREG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
.
          BRANCH    F3,CPREG001,CPREG002,CPREG003,CPREG004,CPREG005:
                       CPREG006,CPREG007,CPREG008,CPREG009,CPREG010:
                       CPREG011,CPREG012,CPREG013,CPREG014,CPREG015:   *C-58556
                       CPREG016,CPREG017,CPREG018
.
          MOVE      ONE,EXIT
          GOTO      CPREG999
.
CPREG001  MOVE      QRYDATA,REGCP001
          PACK      REGCP001,REGCP001,SP70
          GOTO      CPREG999
.
CPREG002  MOVE      QRYDATA,REGCP002
          GOTO      CPREG999
.
CPREG003  MOVE      QRYDATA,REGCP003
          GOTO      CPREG999
.
CPREG004  MOVE      QRYDATA,REGCP004
          GOTO      CPREG999
.
CPREG005  MOVE      QRYDATA,REGCP005
          GOTO      CPREG999
.
CPREG006  MOVE      QRYDATA,REGCP006
          GOTO      CPREG999
.
CPREG007  MOVE      QRYDATA,REGCP007
          GOTO      CPREG999
.
CPREG008  MOVE      QRYDATA,REGCP008
          GOTO      CPREG999
.
CPREG009  MOVE      QRYDATA,REGCP009
          GOTO      CPREG999
.
CPREG010  MOVE      QRYDATA,REGCP010
          GOTO      CPREG999
.
CPREG011  MOVE      QRYDATA,REGCP011
          GOTO      CPREG999
.
CPREG012  MOVE      QRYDATA,REGCP012
          GOTO      CPREG999
.
CPREG013  MOVE      QRYDATA,REGCP013
          GOTO      CPREG999
.
CPREG014  MOVE      QRYDATA,REGCP014
          GOTO      CPREG999
.
CPREG015  MOVE      QRYDATA,REGCP015                                   *I-58556
          GOTO      CPREG999                                           *I-58556
.
CPREG016  MOVE      QRYDATA,REGCP016
          GOTO      CPREG999
.
CPREG017  MOVE      QRYDATA,REGCP017
          GOTO      CPREG999
.
CPREG018  MOVE      QRYDATA,REGCP018
          GOTO      CPREG999
.
CPREG999  RETURN
.
.------------------------------------------------------------------------------
.  Set parameters for receipt trans number
.------------------------------------------------------------------------------
STTRN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      TRANSNUM[F3],QRYDATA,SP70
          MOVE      F3,LASTRECP
STRN9999  RETURN
.
.------------------------------------------------------------------------------
.  Set parameters for 'reason for refund'
.------------------------------------------------------------------------------
STRFN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      REASFUND[F3],QRYDATA,SP70
STRFN999  RETURN
.
.------------------------------------------------------------
. Remote Script - Get Control Accounts
.------------------------------------------------------------
GETACC00  CALL      XMLHED00
          BRANCH    EXIT,GETACC99
.
          MOVE      SP70,BNKLEDNO
          MOVE      SP70,BNKLEDSC
          MOVE      SP70,DEBLEDNO
          MOVE      SP70,DEBLEDSC
          MOVE      SP70,FMCHCHQ
          MOVE      SP70,FMCHDES
          MOVE      SP70,GSTLEDNO
          MOVE      SP70,GSTLEDSC
          MOVE      SP70,INCOMDSC
.
          UNPACK    VALDCODE,REGGENLD
.
          BRANCH    LISTTYPE,GETACC10 
          GOTO      GETACC15
. 
. GETACC10 - Only allows Accounts :Income, Expense, Asset, Liability and Equity
.
GETACC10  PACK      KEY14,REGGENLD,SP20
          CALL      RDFMAM1             * Account Master Details
          BRANCH    OVRCD,GETACC90
.
          MOVE      FMAMTYPE,ACCNTYPE
          IF        ACCNTYPE>5
            GOTO      GETACC91
          ENDIF
.
          COMPARE   ZERO,FMAMSTAT      * Only want Status 0=Open
          GOTO      GETACC92 IF NOT EQUAL
.
GETACC15  PACK      KEY14,REGGENLD,SP20
          CALL      RDFMAM1             * Account Master Details
          BRANCH    OVRCD,GETACC90
.
          MOVE      FMAMDESC,INCOMDSC   * Income Account Desc
.
          CALL      GETC0000            * Get Control Account Details
.
.  Get Bank Ledger/Account Code and Name
.
          PACK      KEY14,FMAMLEDG,FMCSBNK,SP20
          CALL      RDFMAM1              * Account Master Details
          BRANCH    OVRCD,GETACC20
.
          PACK      BNKLEDNO,FMLALEDG,SLASH,FMCSBNK  * Bank Ledger/Acc Code
          MOVE      FMAMDESC,BNKLEDSC                * Bank Ledger/Acc Desc
.
.  Get Cheque Account
.
GETACC20  PACK      KEY14,FMLALEDG,FMCSBNK,SP70
          CALL      RDFMCA1              * Control Account Master Table
          BRANCH    OVRCD,GETACC30

          PACK      KEY15,FMCACHQ,SP70
          CALL      RDFMCH1              * Cheque Account Master Details
          BRANCH    OVRCD,GETACC30
.
.  Get Debtor Control Ledger/Account
.
GETACC30  PACK      KEY14,FMAMLEDG,FMCSDEB,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,GETACC40
.
          PACK      DEBLEDNO,FMLALEDG,SLASH,FMCSDEB  * Debtors Cont Ledger/Acc
          MOVE      FMAMDESC,DEBLEDSC                * Desc
.
.  Get GST Control Account
.
GETACC40  PACK      KEY14,FMAMLEDG,FMCSAGST,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,GETACC80
.
          PACK      GSTLEDNO,FMLALEDG,SLASH,FMCSAGST * Debtors Cont Ledger/Acc
          MOVE      FMAMDESC,GSTLEDSC                * Desc
.
GETACC80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             INCOMDSC,"|",BNKLEDNO,"|",BNKLEDSC,"|",FMCHCHQ:
                             "|",FMCHDES,"|",DEBLEDNO,"|",DEBLEDSC,"|":
                             GSTLEDNO,"|",GSTLEDSC:
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Ledger/Income Account ",REGGENLD:
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC91  LOAD      KEY20,ACCNTYPE,ACCTYP1,ACCTYP2,ACCTYP3,ACCTYP4,ACCTYP5:
                          ACCTYP6,ACCTYP7,ACCTYP8,ACCTYP9
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Account Type: ",FMAMTYPE:
                             " - ",KEY20:
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Ledger/Income Account ",REGGENLD:
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC98  CALL      XMLEND00
GETACC99  RETURN
+
.------------------------------------------------------------------------------
. Receipting Cash Drawer Enquiry
.------------------------------------------------------------------------------
.
RCPCSH00  CALL      CURPER00              * Current Date
          CALL      CALCDT00              * Calculate Next and Last Period Dates
          CALL      GPDS0000              * Get Payment description
          CALL      GETTOT00              * Get Cash Drawer Totals
.
          CLEAR     WEBTITLE
          MOVE      "Cash Drawer Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,RCPCSH99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RCPCSH99
.
RCPCSH99  RETURN
+
.------------------------------------------------------------------------------
. Get description of payment code 
.------------------------------------------------------------------------------
GPDS0000  MOVE      ZERO,F1
          MOVE      "Py",KEY2
          PACK      KEY9,KEY2,SP70
          CALL      RDSCODE5
GPDS1000  CALL      RDKCODE5
          BRANCH    OVRCD,GPDS9999
.
          MATCH     "Py",TCODE
          GOTO      GPDS9999 IF NOT EQUAL
.
          SQUEEZE   PTCDNHCP
          MOVE      ZERO,F2
          MOVE      PTCDNHCP,F2
          COMPARE   ZERO,F2
          GOTO      GPDS1000 IF EQUAL
.
          PACK      PAYMDESC[F2],TDESC,SP70
          GOTO      GPDS1000
.
GPDS9999  RETURN
+
.------------------------------------------------------------------------------
. Get Totals for Cash Drawer Enquiry
.------------------------------------------------------------------------------
.
GETTOT00  MATCH     RCPBK004,Z70
          GOTO      GETTOT99 IF EQUAL
.
          PACK      KEY26,FRSTDATE,RCPBK004,SP70
          CALL      RSRCBNK2
GETTOT10  CALL      RKRCBNK2
          BRANCH    OVRCD,GETTOT98
.
          MATCH     RCBNTDAT,LASTDATE
          GOTO      GETTOT98 IF LESS
.
          MATCH     RCPBK004,RCBNCDRW
          GOTO      GETTOT10 IF NOT EQUAL
.
          MATCH     RCPBK017,Z70
          GOTO      GETTOT15 IF EOS
          GOTO      GETTOT15 IF EQUAL
.
          MATCH     RCPBK017,RCBNCUID
          GOTO      GETTOT10 IF NOT EQUAL
.
GETTOT15  MATCH     "1",RCBNSTAT                * Cancelled
          GOTO      GETTOT10 IF EQUAL
.
          PACK      KEY15,RCBNRECN,SP70
          CALL      RSRCBDT1
GETTOT20  CALL      RKRCBDT1
          BRANCH    OVRCD,GETTOT10
.
          MATCH     RCBDRECN,RCBNRECN
          GOTO      GETTOT10 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          PACK      KEY5,CODEPY,RCBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
          ENDIF
.
          BRANCH    F2,GETTOT21:         * Cash
                       GETTOT22:         * Cheque
                       GETTOT23:         * Credit Card
                       GETTOT24:         * Direct Debit
                       GETTOT25:         * Money Order
                       GETTOT26:         * EFTPOS
                       GETTOT27:         * BPAY
                       GETTOT28:         * HICAPS
                       GETTOT29          * Medicare
          COMPARE   ZERO,F2
          GOTO      GETTOT20 IF EQUAL
.
          ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TOTOTHR[F2] * Total Banked for other payment
          ELSE
            ADD       RCBDPAMT,TNBOTHR[F2] * Total Not Banked for other payment
          ENDIF
          GOTO      GETTOT20
.
GETTOT21  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD     RCBDPAMT,TNBCASH          * Un-released
          ELSE
            ADD     RCBDPAMT,TOTCASH          * Released
          ENDIF
          GOTO      GETTOT20
.
GETTOT22  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBCHQ
          ELSE
            ADD       RCBDPAMT,TOTCHQ
          ENDIF
          GOTO      GETTOT20
.
GETTOT23  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBCRED
          ELSE
            ADD       RCBDPAMT,TOTCRED
          ENDIF
          GOTO      GETTOT20
.
GETTOT24  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBDDBT
          ELSE
            ADD       RCBDPAMT,TOTDDBT
          ENDIF
          GOTO      GETTOT20
.
GETTOT25  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBMONOR
          ELSE
            ADD       RCBDPAMT,TOTMONOR
          ENDIF
          GOTO      GETTOT20
.
GETTOT26  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
....        ADD       RCBDPAMT,TNBEFTPO                                D-222934
            MATCH     "1",RCBDEFTT            * 1=Cash, 2=Credit      *I-222934
            IF        @EQUAL
              ADD       RCBDPAMT,TNBEFTDB     * Debit Card
            ELSE
              ADD       RCBDPAMT,TNBEFTCR     * Credit card
            ENDIF
          ELSE
....        ADD       RCBDPAMT,TOTEFTPO                                D-222934
            MATCH     "1",RCBDEFTT            * 1=Cash, 2=Credit      *I-222934
            IF        @EQUAL
              ADD       RCBDPAMT,TOTEFTDB     * Debit Card
            ELSE
              ADD       RCBDPAMT,TOTEFTCR     * Credit card
            ENDIF
          ENDIF
          GOTO      GETTOT20
.
GETTOT27  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBBPAY
          ELSE
            ADD       RCBDPAMT,TOTBPAY
          ENDIF
          GOTO      GETTOT20
.
GETTOT28  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBHCAP
          ELSE
            ADD       RCBDPAMT,TOTHCAP
          ENDIF
          GOTO      GETTOT20
.
GETTOT29  ADD       RCBDPAMT,TOTTOTAL
          MATCH     "0",RCBNSTAT
          IF        @EQUAL
            ADD       RCBDPAMT,TNBMCAR
          ELSE
            ADD       RCBDPAMT,TOTMCAR
          ENDIF
          GOTO      GETTOT20
.
GETTOT98  MOVE      ONE,SHOWTOTS
GETTOT99  RETURN
.------------------------------------------------------------------------------
. Register Maintenance      
.------------------------------------------------------------------------------
RCPREG00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      RCPREG40 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      RCPREG10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      RCPREG20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      RCPREG30 IF EQUAL
.
          GOTO      RCPREG93
.
.         ************ ADD FORMACTION **********
.
RCPREG10  PACK      KEY3,REGCP001,SP70
          CALL      RDREGA1                 * Record Exists?
          COMPARE   ZERO,OVRCD              * Yes, Display error message
          GOTO      RCPREG91 IF EQUAL
.
          CALL      REGSAV00                * Save Variables for update
          CALL      WRREGA1                 * Write record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPREG99
.
.         ************ UPDATE FORMACTION **********
.
RCPREG20  PACK      KEY3,REGCP001,SP70
          CALL      RDREGA1                 * Record Exists?
          BRANCH    OVRCD,RCPREG92          * No, Display error message
.
          CALL      REGSAV00                * Save Variables for update
          CALL      UPREGA1                 * Update record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPREG99
.
.         ************ DELETE FORMACTION **********
.
RCPREG30  PACK      KEY3,REGCP001,SP70
          CALL      RDREGA1                 * Record Exists?
          BRANCH    OVRCD,RCPREG92          * No, Display error message
.
          CALL      DEREGA1                 * Delete record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPREG99
.
.         ************ DISPLAY FORMACTION **********
.
RCPREG40  PACK      KEY3,REGCP001,SP70 
          CALL      RDREGA1 
          IF        OVRCD=1
            CALL      CLRREG00              * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Register Maintenance",WEBTITLE                
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,RCPREG99
.
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RCPREG99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
RCPREG91  MOVE      "Register Code already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPREG99
.
RCPREG92  MOVE      "Register Code does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPREG99
.
RCPREG93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPREG99
.
RCPREG99  RETURN
.------------------------------------------------------------------------------
. Initialize's file data (Register Maintenance)         
.------------------------------------------------------------------------------
CLRREG00  MOVE      SP70,REGCODE    * REGISTER CODE
          MOVE      SP70,REGDESC    * DESCRIPTION
          MOVE      SP70,REGCHQCD   * CHEQUE ACCOUNT CODE
          MOVE      SP70,REGGENLD   * GENERAL LEDGER INCOME A/C
          MOVE      SP70,REGGENBK   * GENERAL LEDGER CONTROL A/C
          MOVE      SP70,REGGROUP   * GROUP CODE
          MOVE      ZERO,REGIBACD   * IBA SYSTEM CODE
          MOVE      ZERO,REGSUNDT   * SUNDRY DEBTORS LEDGER NUMBER
          MOVE      SP70,REGDISS    * GL DISSECTION CODE
          MOVE      SP70,REGRESP    * GL RESPONSIBILITY CODE
          MOVE      SP70,REGGENDS   * General ledger suspense A/C
          MOVE      SP70,REGGST     * GST Code
          MOVE      SP70,REGISTRG   * Register Group - Right Justify
          MOVE      SP70,REGHOSP    * Multi-Hospital ID              
          MOVE      SP70,REGACTIV   * Activity Ind. 1=Inactive         *I-58556
          MOVE      SP70,REGGENDB   * G/L Debtors Control A/C
          MOVE      SP70,REGGENGS   * G/L GST Control A/C
          MOVE      SP70,RCRECSUR   * Register for Credit Card Surcharge
          MOVE      SP70,REGSPARE   * Spare
.
CLRREG99  RETURN
.------------------------------------------------------------------------------
. Moves cgi variables into file variables (Register Maintenance)        
.------------------------------------------------------------------------------
REGSAV00  PACK      REGCODE,REGCP001,SP70    * REGISTER CODE
          PACK      REGDESC,REGCP002,SP70    * DESCRIPTION
          PACK      REGCHQCD,REGCP003,SP70   * CHEQUE ACCOUNT CODE
          PACK      REGGENLD,REGCP004,SP70   * GENERAL LEDGER INCOME A/C
          PACK      REGGENBK,REGCP005,SP70   * GENERAL LEDGER CONTROL A/C
          MOVE      REGCP006,REGGROUP   * GROUP CODE
          MOVE      REGCP007,REGIBACD   * IBA SYSTEM CODE
          MOVE      REGCP008,REGSUNDT   * SUNDRY DEBTORS LEDGER NUMBER
          MOVE      REGCP009,REGDISS    * GL DISSECTION CODE
          MOVE      REGCP010,REGRESP    * GL RESPONSIBILITY CODE
          MOVE      REGCP011,REGGENDS   * General ledger suspense A/C
          MOVE      REGCP012,REGGST     * GST Code
          MOVE      REGCP013,REGISTRG   * Register Group - Right Justify
          MOVE      REGCP014,REGHOSP    * Multi-Hospital ID
          MOVE      REGCP015,REGACTIV   * Register Activity Ind.       *I-58556
          MOVE      REGCP016,REGGENDB   * G/L Debtors Control A/C
          MOVE      REGCP017,REGGENGS   * G/L GST Control A/C
          MOVE      REGCP018,RCRECSUR   * Register for Credit Card Surcharge
          MOVE      SP70,REGSPARE       * Spare
.
REGSAV99  RETURN
.------------------------------------------------------------------------------
. Cash Drawer Id Maintenance      
.------------------------------------------------------------------------------
RCPCID00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      RCPCID40 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      RCPCID10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      RCPCID20 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      RCPCID30 IF EQUAL
.
          GOTO      RCPCID93
.
.         ************ ADD FORMACTION **********
.
RCPCID10  PACK      KEY6,RCPDR001,SP70
          CALL      RDCIDA1                 * Record Exists?
          COMPARE   ZERO,OVRCD              * Yes, Display error message
          GOTO      RCPCID91 IF EQUAL
.
          CALL      CIDSAV00                * Save Variables for update
          CALL      WRCIDA1                 * Write record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPCID99
.
.         ************ UPDATE FORMACTION **********
.
RCPCID20  PACK      KEY6,RCPDR001,SP70
          CALL      RDCIDA1                 * Record Exists?
          BRANCH    OVRCD,RCPCID92          * No, Display error message
.
          CALL      CIDSAV00                * Save Variables for update
          CALL      UPCIDA1                 * Update record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPCID99
.
.         ************ DELETE FORMACTION **********
.
RCPCID30  PACK      KEY6,RCPDR001,SP70
          CALL      RDCIDA1                 * Record Exists?
          BRANCH    OVRCD,RCPCID92          * No, Display error message
.
          CALL      DECIDA1                 * Delete record 
.
          MOVE      ZERO,EXIT
          GOTO      RCPCID99
.
.         ************ DISPLAY FORMACTION **********
.
RCPCID40  PACK      KEY6,RCPDR001,SP70 
          CALL      RDCIDA1 
          IF        OVRCD=1
            CALL      CLRCID00              * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Cash Drawer Id Maintenance",WEBTITLE                
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,RCPCID99
.
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RCPCID99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
RCPCID91  MOVE      "Cash Drawer Id Code already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPCID99
.
RCPCID92  MOVE      "Cash Drawer Id Code does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPCID99
.
RCPCID93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPCID99
.
RCPCID99  RETURN
.------------------------------------------------------------------------------
. Initialize's file data (Cash Draw Maintenance)         
.------------------------------------------------------------------------------
CLRCID00  MOVE      SP70,RCPCASH    * CASHIER CODE
          MOVE      SP70,RCPPASS    * PASSWORD
          MOVE      SP70,RCPSUR     * SURNAME
          MOVE      SP70,RCPGIVEN   * GIVEN NAME
          MOVE      ZERO,RCPSECUR   * SECURITY CODE
          MOVE      SP70,RCCIHOSP   * HOSPITAL  
          MOVE      SP70,RCCIACTV   * Active/Inactive
          MOVE      SP70,RCCICCRD   * Charge Credit Card Surcharge
          MOVE      SP70,RCCIINVR   * Default Deposit Receipt Register
          MOVE      SP70,RCCIDEPR   * Default Deposit Receipt Register
          MOVE      SP70,RCCI3PPS   * 3rd Party Payment Source
          MOVE      SP70,RCCICHQA   * Default Cheque Account Number
.
CLRCID99  RETURN
.------------------------------------------------------------------------------
. Moves cgi variables into file variables (Cash Drawer Maintenance)        
.------------------------------------------------------------------------------
CIDSAV00  MOVE      RCPDR001,RCPCASH   * CASHIER CODE
          MOVE      RCPDR002,RCPPASS   * PASSWORD
          MOVE      RCPDR003,RCPSUR    * SURNAME
          MOVE      RCPDR004,RCPGIVEN  * GIVEN NAME
          MOVE      RCPDR005,RCPSECUR  * SECURITY CODE
          MOVE      RCPDR006,RCCIHOSP  * HOSPITAL
          MOVE      RCPDR007,RCCICHQA  * DEFAULT CHEQUE ACCOUNT NUMBER
          MATCH     SP70,RCPDR008
          IF        @EQUAL
            MOVE      "1",RCCIACTV
          ELSE
            MOVE      RCPDR008,RCCIACTV * Activity Flag
          ENDIF
          MOVE      RCPDR009,RCCICCRD  * Charging Credit Card Surcharge
          MOVE      RCPDR010,RCCIINVR  * Default Invoice Receipt Register
          MOVE      RCPDR011,RCCIDEPR  * Default Deposit Receipt Register
          MOVE      RCPDR012,RCCI3PPS  * 3rd Party Payment Source
.
CIDSAV99  RETURN
.
.------------------------------------------------------------------------------
. Re-print receipts
.------------------------------------------------------------------------------
RCPPRT00  MOVE      ZERO,FORM12
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      RCPPRT10 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * Receipt list
          GOTO      RCPPRT20 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Check Receipt 
          GOTO      RCPPRT30 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Receipt 
          GOTO      RCPPRT40 IF EQUAL
.
          MATCH     "F",UPDTTYPE            * Refund Deposit
          GOTO      RCPPRT50 IF EQUAL
.
          MATCH     "T",UPDTTYPE            * Transfer Deposit
          GOTO      RCPPRT60 IF EQUAL
.
          MATCH     "P",UPDTTYPE            * Print
          GOTO      RCPPRT99 IF NOT EQUAL
.
          IF        HFORMAT=8 |HFORMAT=4 |HFORMAT=2 | HFORMAT=1
            CALL      STMPL000
            BRANCH    TMPLTFLG,RCPPRT95
          ENDIF
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
.
          CALL      OPNPRINT 
          CALL      PRTN0000                * Re-print Receipt
.
          MOVE      USERID,KEY10
          CALL      RDWBSE1
          CALL      CLSPRINT
.
          MOVE      "Printing Complete",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      RCPPRT99
.
RCPPRT10  MOVE      SP70,RCBNTDAT
          MOVE      SP70,RCBNCDRW
          MOVE      SP70,RCBNCUID
          MOVE      ZERO,RCBNTOTP
.
          MATCH     "004",TEMPLATE
          GOTO      RCPPRT20 IF EQUAL
.
          MATCH     RECEIPTN,Z70
          GOTO      RCPPRT80 IF EQUAL
          MATCH     RECEIPTN,SP70
          GOTO      RCPPRT80 IF EQUAL
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPPRT90
.
          MATCH     "001",TEMPLATE                * Re print Receipt
          IF        @EQUAL
            IF        IBCNMHOS=1
              MATCH    WBSEHOSP,RCBNMHOS          * Multi hospital test
              GOTO     RCPPRT96 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "003",TEMPLATE                * Cancel Receipt
          IF        @EQUAL
            IF        IBCNMHOS=1
              MATCH    WBSEHOSP,RCBNMHOS          * Multi hospital test
              GOTO     RCPPRT96 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      TRANSCNT,TRANSCNT,SP70
          MATCH     SP70,TRANSCNT
          GOTO      RCPPRT80 IF EQUAL
.
          MATCH     SP70,URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,RCPPRT80
          ENDIF
.
          PACK      KEY17,RECEIPTN,TRANSCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=1
            UNPACK    SP70,RCDTTDAT,RCDTRECN,RCDTTCNT,RCDTREGI,RCDTINVN
            UNPACK    SP70,RCDTVIST,RCDTURNO,RCDTNAME,RCDTPRAC,RCDTDPTY,RCDTSDOC
            CALL      RDCMDEP1
            IF        OVRCD=1
              UNPACK    SP70,CMDEPRAC,CMDESDOC
            ENDIF
          ENDIF
          GOTO      RCPPRT80
.
.         Display list of receipts
.
RCPPRT20  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RCPPRT80
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
.
          GOTO      RCPPRT80
.
.         check receipt
.
RCPPRT30  MATCH     RECEIPTN,Z70
          GOTO      RCPPRT80 IF EQUAL
          MATCH     RECEIPTN,SP70
          GOTO      RCPPRT80 IF EQUAL
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPPRT90
          MATCH     SP70,RCBNRDAT        * check reconciliation date
          GOTO      RCPPRT92 IF NOT EQUAL
          MATCH     SP70,RCBNRTIM        * check reconciliation time
          GOTO      RCPPRT92 IF NOT EQUAL
          MATCH     "1",RCBNSTAT
          GOTO      RCPPRT94 IF EQUAL    * Already cancelled
          GOTO      RCPPRT80
.
.         Cancel a receipt
.
RCPPRT40  MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPPRT90
.
          MATCH     SP70,RCBNRDAT           * check reconciliation date
          GOTO      RCPPRT92 IF NOT EQUAL
          MATCH     SP70,RCBNRTIM           * check reconciliation time
          GOTO      RCPPRT92 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      RCBNUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCBNUDAT
          MOVE      CTIMEIS,RCBNUTIM
          MOVE      USERID,RCBNUUID        * WEB user id
.
          MOVE      "1",RCBNSTAT            * change status to Cancel receipt
          CALL      UPRCBNK1
.
.          CALL      CNERCP00                * Cancel Eclipse Receipt
          CALL      URCN0000                * check unreconciled invoice
.
          MOVE      ZERO,EXIT
          GOTO      RCPPRT99
.
.         Refund Deposit
.
RCPPRT50  COMPARE   ZERO,LASTRECP
          GOTO      RCPPRT52 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTRECP
            MOVE      TRANSNUM[COUNTER],KEY17
            CALL      RDCMDEP1
            IF        OVRCD=0
              MOVE      REASFUND[COUNTER],CMDERRFN
              MATCH     SP70,CMDERRFN
              IF        !@EQUAL
                MATCH     "2",CMDESTAT            * check deposit status
                GOTO      RCPPRT98 IF EQUAL
.
                MOVE      "2",CMDESTAT          * Status of Refunded
                PACK      CMDEREFD,CCC,CYY,CMM,CDD
                REP       " 0",CMDEREFD
                CLOCK     TIME,CMDEREFT
                PACK      CMDEUDAT,CCC,CYY,CMM,CDD
                REP       " 0",CMDEUDAT           * date updated
                CLOCK     TIME,CMDEUTIM           * time updated
                MOVE      USERID,CMDEUUID         * web user id
                CALL      UPCMDEP1
.
                COMPARE   FIVE,CFEETYP
                CALL      GLEX0000 IF EQUAL       * G/L Extract for SX
                MOVE      ONE,F1
              ENDIF
            ENDIF
            ADD       ONE,COUNTER
          DO
.
          COMPARE   ZERO,F1
          GOTO      RCPPRT91 IF EQUAL
.
          MOVE      "Refund deposits completed.",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      RCPPRT99
.
RCPPRT52  MOVE      "No deposit to be refunded",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      RCPPRT99
.
.         Transfer deposit
.
RCPPRT60  MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP20
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPPRT90
.
          UNPACK    TRNVISTP,TRNVISIT,TRNVTYPE   * Visit number and Visit Type
.
          PACK      KEY17,RECEIPTN,SP70
          CALL      RSCMDEP1
RCPPRT62  CALL      RKCMDEP1
          BRANCH    OVRCD,RCPPRT68
.
          MATCH     RECEIPTN,CMDERECN
          GOTO      RCPPRT68 IF NOT EQUAL
.
          MATCH     "0",CMDESTAT            * check deposit status
          GOTO      RCPPRT62 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,RCPPRT62
.
          MATCH     SP70,TRNVISIT
          IF        !@EQUAL
            MATCH     TRNVISIT,CMDEADMN     * same admission ?
            GOTO      RCPPRT93 IF EQUAL
          ELSE
            MATCH     TRNMPRAC,CMDEPRAC     * same medical practice ?
            IF        @EQUAL
              MATCH     TRNSDOCT,CMDESDOC   * same service doctor ?
              GOTO      RCPPRT93 IF EQUAL
            ENDIF
          ENDIF
.
          CALL      TRNDP0000               * Transfer Deposit
          GOTO      RCPPRT62
.
RCPPRT68  MOVE      "Transfer deposit completed.",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      RCPPRT99
.
RCPPRT80  
.         MOVE      "Reprint Receipts",WEBTITLE
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,RCPPRT99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT90  MOVE      "Invalid Receipt Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT91  MOVE      "Reason for Refund must be entered",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT92  MOVE      "Receipt has already been Reconciled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT93  MOVE      "Receipt can not be transfered to same Medical Practice & Service Doctor.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT94  MOVE      "Receipt has already been Cancelled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT95  MOVE      "Receipt Header/Tail Not Setup. Contact I.B.A. - ",WEBTITLE
          CALL      WEBERR00     * Output File & Write HTML Pg Header
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT96  MOVE      "Invalid receipt number for logged in hospital.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT98  MOVE      "Error: Deposit already refunded",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPPRT99
.
RCPPRT99  RETURN
+
.*****************************************************************************
.         Transfer deposit
.*****************************************************************************
TRNDP000  CALL      GVIS0000                     * Set up visit type
.
          CALL      CLCMAU00                     * Clear fields
          CALL      WRAU0000                     * Write to Deposit Audit file
.
.         Updating comdepaf file
.
          MATCH     "4",TRNVTYPE
          IF        @EQUAL
            PACK      CMDEPRAC,TRNMPRAC,SP70     * PP Medical Practice
            PACK      CMDESDOC,TRNSDOCT,SP70     * PP Service doctor
            MOVE      SP70,CMDEADMN              * blank visit number
            MOVE      "1",CMDESFLG               * Scan Flag
          ELSE
            PACK      CMDEPRAC,SP70              * blank PP Medical Practice
            PACK      CMDESDOC,SP70              * blank PP Service doctor
            MOVE      TRNVISIT,CMDEADMN          * Visit number
            MOVE      SP70,CMDESFLG              * Scan Flag
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      TRNVTYPE,F1
          MOVE      F1,CMDESYST                  * System
          MOVE      TRNDTYPE,CMDEDTYP            * deposit type
          MOVE      "1",CMDETRSF                 * Deposit Transfered
          PACK      CMDEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",CMDEUDAT                * date updated
          CLOCK     TIME,CMDEUTIM                * time updated
          MOVE      USERID,CMDEUUID              * web user id
          CALL      UPCMDEP1
.
.         Updating rcpdteaf file
.
          MATCH     "4",TRNVTYPE
          IF        @EQUAL
            MOVE      TRNMPRAC,RCDTPRAC         * medical practice
            MOVE      TRNSDOCT,RCDTSDOC         * service doctor
            MOVE      SP70,RCDTVIST             * visit number
            MOVE      "1",RCDTSFLG              * Scan Flag
          ELSE
            MOVE      SP70,RCDTPRAC             * medical practice
            MOVE      SP70,RCDTSDOC             * service doctor
            MOVE      TRNVISIT,RCDTVIST         * visit number
            MOVE      SP70,RCDTSFLG             * Scan Flag
          ENDIF
          MOVE      CMDESFLG,RCDTSFLG           * Scan Flag
          MOVE      TRNREGIS,RCDTREGI           * register
          MOVE      TRNDTYPE,RCDTDPTY           * deposit type
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT               * date updated
          CLOCK     TIME,RCDTUTIM               * time updated
          MOVE      USERID,RCDTUUID             * web user id
          CALL      UPRCDTE1
.
TRNDP999  RETURN
+
.*****************************************************************************
.         Setup visit type
.*****************************************************************************
GVIS0000  MOVE      "4",TRNVTYPE               * default transfer to PP
.
          MATCH     SP70,TRNVISIT
          GOTO      GVIS9999 IF EQUAL
.
          MOVE      TRNVISIT,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      "3",TRNVTYPE             * Inpatient
            GOTO      GVIS9999
          ENDIF
.
.         Check for Outpatient Booking
.
          PACK      KEY36,TRNVISIT,Z70
          CALL      RDSBOKA6
GVIS1000  CALL      RDPBOKA6
          BRANCH    OVRCD,GVIS2000
.
          MATCH     DOBAOUTN,TRNVISIT
          GOTO      GVIS2000 IF NOT EQUAL     * different visit number
.
          MOVE      "2",TRNVTYPE              * Outpatient
          GOTO      GVIS9999
.
GVIS2000  MOVE      TRNVISIT,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            MOVE      "1",TRNVTYPE            * Emergency
          ENDIF
.
GVIS9999  RETURN
+
.*****************************************************************************
.         Write to Deposit audit file
.*****************************************************************************
WRAU0000  MOVE      CMDERECN,CMAURECN  * Receipt Number
          MOVE      CMDETCNT,CMAUTCNT  * Transaction Count
.
          CALL      IBACLOCK
          PACK      CMAUTDAT,CCC,CYY,CMM,CDD  * Date Deposit Transferred
          REP       " 0",CMAUTDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,CMAUTTIM   * Time Deposit Transferred
.
          MOVE      CMDEURNO,CMAUURNO  * Patient U/R No.
          MOVE      CMDEADMN,CMAUFADM  * Visit Number Deposit Transferred From
          MOVE      TRNVISIT,CMAUTADM  * Visit Number Deposit Transferred To
.
          MOVE      CMDEPRAC,CMAUFPRA  * Medical Practice Deposit From
          MOVE      TRNMPRAC,CMAUTPRA  * Medical Practice Deposit Transferred To
.
          MOVE      CMDESDOC,CMAUFSDR  * Service Doctor From
          MOVE      TRNSDOCT,CMAUTSDR  * Service Doctor To
.
          MOVE      CMDEDTYP,CMAUFDTY  * Deposit Type From
          MOVE      TRNDTYPE,CMAUTDTY  * Deposit Type To
.
          MOVE      ZERO,F1
          MOVE      CMDESYST,F1
          MOVE      F1,CMAUFVTY        * Visit Type From
          MOVE      TRNVTYPE,CMAUTVTY  * Visit Type To
.
          MOVE      RCDTREGI,CMAUFREG  * Register From
          MOVE      TRNREGIS,CMAUTREG  * Register To
          MOVE      USERID,CMAUCUID    * Web User Id Created (websecaf)
.
          PACK      KEY33,CMAURECN,CMAUTCNT,CMAUTDAT,CMAUTTIM
          CALL      WRCMAUD1
WRAU9999  RETURN
+
.*****************************************************************************
.         Write to G/L extract file for Refunded deposit
.*****************************************************************************
GLEX0000  CALL      CLNZPEXT                * clear variables
.
          CALL      RDRCDTE1
          BRANCH    OVRCD,GLEX9999
.
          MOVE      SP70,NZEXSYST           * System
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GLEX9999          * Invalid register
.
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,GLEX9999
          MATCH     RCBDRECN,RCDTRECN       * Same receipt no?
          GOTO      GLEX9999 IF NOT EQUAL
.
          MOVE      RCDTAMNT,NZEXCAMT       * refunded deposit
          MULT      "-1",NZEXCAMT
          MOVE      RCDTAMNT,NZEXDAMT
.
          MOVE      RCDTBNKA,NZEXCACC       * Credit account
          MOVE      RCDTINCA,NZEXDACC       * Debit account
.
          MOVE      "5",NZEXRTYP
          CLEAR     NZEXDESC
          APPEND    "Refund Deposit",NZEXDESC
          APPEND    SP70,NZEXDESC
          RESET     NZEXDESC
.
          MOVE      RCDTMHOS,NZEXHCOD
          MOVE      RCDTVIST,NZEXADMN
          UNPACK    RCDTINVN,KEY4,NZEXINVN
          PACK      NZEXTRNO,SP1,RCDTTCNT,SP70   * Transaction count
          MOVE      RCDTURNO,NZEXURNO
          MOVE      RCDTTDAT,NZEXTDAT
          REP       " 0",NZEXTDAT
          MOVE      RCDTRECN,NZEXRCNO
          MOVE      RCDTREFR,NZEXPREF
.
          PACK      NZEXBNAM,RCBDPAYD
          MOVE      "5",NZEXPMTH               * Direct Deposit
          PACK      NZEXRREF,RCBDSTRF
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          PACK      KEY5,CODEPY,RCBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
          ENDIF
.
          IF        F2=1
            MOVE      "1",NZEXPMTH             * Cash payment
            MOVE      SP70,NZEXRREF
          ENDIF
          IF        F2=2
            MOVE      "2",NZEXPMTH             * Cheque payment
            PACK      NZEXBNAM,RCBDDRAW,SP70
            PACK      NZEXRREF,RCBDCHQN,SP70
          ENDIF
.
          COMPARE   "3",F2
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "3",NZEXPMTH               * Credit payment
          MOVE      SP70,NZEXRREF
          PACK      KEY5,ANSC,ANSR,RCBDCRDT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GLEX4000
.
          MATCH     "C",TCINDC1
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "4",NZEXPMTH         * Merchant care payment
          MOVE      RCBDCRDT,NZEXMCTY    * Card type
          MOVE      SP70,KEY6
          MOVE      TCFORM6,KEY6
          UNPACK    KEY6,ANS,KEY4,KEY1
          MOVE      ".",ANS
          PACK      KEY6,KEY4,ANS,KEY1
          SQUEEZE   KEY6
          MOVE      KEY6,NZEXCOMS        * Commission percentage
.
GLEX4000  MOVE      "00000",NZEXGLBT
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,NZEXCDAT               * date created
          CLOCK     TIME,NZEXCTIM               * time created
          MOVE      PASSCODE,NZEXCUID           * user id
          MOVE      SP70,NZEXSPAR
.
          PACK      KEY30,NZEXADMN,NZEXINVN,NZEXGLBT,NZEXHCOD,NZEXTRNO,SP70
          OPEN      NZPEXTA2,"nzpextaf"
          CALL      WRNZEXT2                     * Write a record
GLEX9999  RETURN
+
.------------------------------------------------------------------------------
. Receipt Equiry        
.------------------------------------------------------------------------------
RCPENQ00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      RCPENQ80 IF EQUAL
.
.
RCPENQ80  MATCH     "001",TEMPLATE
          GOTO      RCPENQ85 IF EQUAL
.
          MATCH     "004",TEMPLATE
          GOTO      RCPENQ83 IF EQUAL
          MATCH     "006",TEMPLATE
          GOTO      RCPENQ83 IF EQUAL       * Transferred deposit
.
          MATCH     RECEIPTN,Z70
          GOTO      RCPENQ85 IF EQUAL
          GOTO      RCPENQ85 IF EOS
          MATCH     RECEIPTN,SP70
          GOTO      RCPENQ85 IF EQUAL
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN 
          PACK      KEY12,RECEIPTN,SP20
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPENQ90
..          IF        OVRCD=1         
..            CALL      CLRPBK00              * Clear all the file variables
..            CALL      CLRPBT00              * Clear all the file variables
..            CALL      CLRPDE00              * Clear all the file variables
..          ENDIF
.
          PACK      KEY33,RECEIPTN,TRANSCNT,TRANDATE,TRANTIME,SP70
          CALL      RDCMAUD1
          IF        OVRCD=1
            CALL      CLCMAU00          * Clear fields
          ENDIF
.
          GOTO      RCPENQ85
.
RCPENQ83  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,RCPENQ91
          CALL      RDPMPX21              * Read master extension file
          BRANCH    OVRCD,RCPENQ91
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
.
.
RCPENQ85  CLEAR     WEBTITLE
          MOVE      "Receipt Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,RCPENQ99
.
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RCPENQ99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
RCPENQ90  MOVE      "Invalid Receipt Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPENQ99
.
RCPENQ91  MOVE      "Cannot find Patient Master.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RCPENQ99
.
RCPENQ99  RETURN
+
.------------------------------------------------------------------------------
. Suspense Equiry
.------------------------------------------------------------------------------
SUSENQ00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE            * Display formaction
          GOTO      SUSENQ30 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * validate Receipt No
          GOTO      SUSENQ10 IF EQUAL
.
          GOTO      SUSENQ99
.
SUSENQ10  MATCH     RECEIPTN,Z70
          GOTO      SUSENQ30 IF EQUAL
          MATCH     RECEIPTN,SP70
          GOTO      SUSENQ30 IF EQUAL
.         
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,SUSENQ90
          MATCH     SP70,RCBNRDAT           * check reconciliation date
          GOTO      SUSENQ92 IF NOT EQUAL
          MATCH     SP70,RCBNRTIM           * check reconciliation time
          GOTO      SUSENQ92 IF NOT EQUAL
          MATCH     "1",RCBNSTAT
          GOTO      SUSENQ94 IF EQUAL       * Already cancelled
.
          GOTO      SUSENQ30
.
.
SUSENQ30  MOVE      "Suspense Receipt Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00                * Output File & Write HTML Pg Header
          BRANCH    EXIT,SUSENQ99
.
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SUSENQ99
.
.         ************ DISPLAY ERROR MESSAGE **********
.
SUSENQ90  MOVE      "Invalid Receipt Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT 
          GOTO      SUSENQ99
.         
SUSENQ92  MOVE      "Receipt has been Reconciled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SUSENQ99 
.         
SUSENQ94  MOVE      "Receipt has been Cancelled.",WEBTITLE
          CALL      WEBERR00                
          MOVE      ONE,EXIT                
          GOTO      SUSENQ99
.
SUSENQ99  RETURN
.------------------------------------------------------------------------------
. Process Fields called from WEBBOD00
.------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD99,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80
.
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      REGS0000                * Register Maintenance             
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      RCID0000                * Cash Drawer Id Maintenance
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99
.
PROFLD51  CALL      CSHE0000
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD62  CALL      RCBK0000                * Banking header fields
          GOTO      PROFLD99
.
PROFLD63  CALL      PRCP0000                * Reprint Receipt 
          GOTO      PROFLD99
.
PROFLD64  CALL      RCDE0000                * Receipt Details (rcpdteaf) tags
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74
          GOTO      PROFLD99
.
PROFLD71  CALL      ERCP0000
          GOTO      PROFLD99
.
PROFLD72  CALL      RCBK0000                * Banking header fields
          GOTO      PROFLD99
.
PROFLD73  CALL      MASF0000                * Patient Header file
          GOTO      PROFLD99
.
PROFLD74  CALL      CMAU0000                * Transferred deposit audit file
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81
          GOTO      PROFLD99
.
PROFLD81  CALL      SUSP0000                * Suspense Receipt 
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-----------------------------------------------------------
. Option 6: Print receipts
.-----------------------------------------------------------
PRCP0000  BRANCH    FLDITMNO,PRCP0100,PRCP0200,PRCP0300,PRCP0400,PRCP0500:
                             PRCP0600,PRCP0700,PRCP0800,PRCP0900,PRCP1000:
                             PRCP1100,PRCP1200,PRCP1300,PRCP1400,PRCP1500:
                             PRCP1600,PRCP1700,PRCP1800,PRCP1900,PRCP2000
          GOTO      PRCP9999
.
PRCP0100  CALL      HPAY0000             * Table of heading line
          GOTO      PRCP9999
.
PRCP0200  CALL      TPAY0000             * Table of payment types
          GOTO      PRCP9999
.
PRCP0300  CALL      HRCP0000             * Table of heading line
          GOTO      PRCP9999
.
PRCP0400  MOVE      ZERO,DISPFLAG
          CALL      TRCP0000             * Table of receipt details
          GOTO      PRCP9999
.
PRCP0500  CALL      CANR0000             * option to view Receipt 
          GOTO      PRCP9999
.
PRCP0600  CALL      RCPT0000             * receipt number
          GOTO      PRCP9999
.
PRCP0700  CALL      INVN0000             * invoice number
          GOTO      PRCP9999
.
PRCP0800  CALL      INVD0000             * invoice date
          GOTO      PRCP9999
.
PRCP0900  CALL      LRCP0000             * List of receipts for an invoice
          GOTO      PRCP9999
.
PRCP1000  CALL      URNN0000             * U/R number
          GOTO      PRCP9999
.
PRCP1100  CALL      RFND0000             * Refund table
          GOTO      PRCP9999
.
PRCP1200  CALL      VIST0000             * Visit type
          GOTO      PRCP9999
.
PRCP1300  MOVE      "$",ANS
          WRITE     HTMLFILE;ANS,RCBNTOTP;
          GOTO      PRCP9999
.
PRCP1400  WRITE     HTMLFILE;REFUNDR;
          GOTO      PRCP9999
.
PRCP1500  WRITE     HTMLFILE;RETURNFL;
          GOTO      PRCP9999
.
PRCP1600  CALL      ECLRCP00
          GOTO      PRCP9999
.
PRCP1700  WRITE     HTMLFILE;TRANSCNT;
          GOTO      PRCP9999
.
PRCP1800  CALL      SELVIS00              * Selection of visit number for U/R
          GOTO      PRCP9999
.
PRCP1900  MOVE      "DP",CATEGORY         * Selection of Deposit type
          MOVE      RCDTDPTY,CODE
          CALL      CODITM00
          GOTO      PRCP9999
.
PRCP2000  CALL      SELMPR00              * Selection of Medical practice
          GOTO      PRCP9999
PRCP9999  RETURN
+
.-----------------------------------------------------------
. Selection of visit for U/R
.-----------------------------------------------------------
SELVIS00  MOVE      SP70,SITECODE
          MOVE      SP70,RCDTVIST
.
          PACK      KEY17,RECEIPTN,TRANSCNT,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      CSIT0000             * Check Outpatient & EMR sites
          ENDIF
.
          MOVE      ZERO,F1
          WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
.         Inpatient visits
.
SELVIS20  PACK      KEY17,URNUMBER,Z70
          CALL      RSPTMI18
SELVIS22  CALL      RPPTMI18
          BRANCH    OVRCD,SELVIS30
          MATCH     URNUMBER,AURNO
          GOTO      SELVIS30 IF NOT EQUAL   * different U/R number
          COMPARE   FIVE,ASTAT
          GOTO      SELVIS22 IF EQUAL       * Cancelled
.
.         Check if invoice is raised for Onleave and Discharges
.
          MOVE      AADMNO,KEY8             * admission number
          MATCH     KEY8,RCDTVIST
          GOTO      SELVIS22 IF EQUAL       * Exclude Adm.no of the receipt
.
          MOVE      ONE,F1
          MOVE      "3",KEY1                * Inpatient
          BRANCH    ASTAT,SELVIS82,SELVIS82 * preadmission/Current
          GOTO      SELVIS80                * check if invoice is raised
.
.         Outpatient visits
.
SELVIS30  PACK      KEY36,URNUMBER,Z70
          CALL      RDSBOKA3
SELVIS32  CALL      RDPBOKA3
          BRANCH    OVRCD,SELVIS40
.
          MATCH     URNUMBER,OBAURNO
          GOTO      SELVIS40 IF NOT EQUAL   * different U/R number
.
          MOVE      DOBAOUTN,KEY8           * admission number
          MATCH     KEY8,RCDTVIST
          GOTO      SELVIS32 IF EQUAL       * Exclude Adm.no of the receipt
.
          MATCH     OBASITE,SITECODE
          GOTO      SELVIS32 IF NOT EQUAL
.
          MOVE      TWO,F1
          MOVE      "2",KEY1                * Outpatient
          BRANCH    OBASTAT,SELVIS82,SELVIS32,SELVIS32,SELVIS82,SELVIS32:
                            SELVIS82
          GOTO      SELVIS32
.
.         Emergency visits
.
SELVIS40  PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
SELVIS42  CALL      RPEMVIS3
          BRANCH    OVRCD,SELVIS90
.
          MATCH     URNUMBER,EMVIURNO
          GOTO      SELVIS90 IF NOT EQUAL   * different U/R number
.
          MOVE      DEMVIADM,KEY8           * admission number
          MATCH     KEY8,RCDTVIST
          GOTO      SELVIS42 IF EQUAL       * Exclude Adm.no of the receipt
.
          MATCH     EMVISITE,SITECODE
          GOTO      SELVIS42 IF NOT EQUAL
.
          MOVE      THREE,F1
          MOVE      "1",KEY1                * EMR
          BRANCH    EMVISTAT,SELVIS82,SELVIS82,SELVIS82
          GOTO      SELVIS42
.
.         Check if invoice has been raised
.
SELVIS80  PACK      KEY16,KEY8,SP70
          CALL      RSPTINV3
          CALL      RKPTINV3
          IF        OVRCD=0
            MATCH     KEY8,DPINVADM
            GOTO      SELVIS88 IF EQUAL     * Already invoiced
          ENDIF
.
SELVIS82  IF        IBCNMHOS=1
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS
              IF        !@EQUAL
                MATCH     RCDTMHOS,PMVXMHOS
                GOTO      SELVIS88 IF NOT EQUAL * different hospital
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY9,KEY8,KEY1
          WRITE     HTMLFILE;"<option value=#"",KEY9,"#">":
                               KEY8,"</option>"
.
SELVIS88  BRANCH    F1,SELVIS22,SELVIS32,SELVIS42
.
SELVIS90  MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            MOVE      ADMISSNO,KEY8           * restore
            CALL      RDPMVX11
          ENDIF
.
SELVIS99  RETURN
+
.-----------------------------------------------------------
.  Check Outpatient and Emergency sites
.-----------------------------------------------------------
CSIT0000  MOVE      SP70,VISTDATE
          MOVE      RCDTVIST,KEY8
          CALL      RDPREA1
          IF        OVRCD=0
            MOVE      OPRSITE,PVISITE
            MOVE      OPRDATE,VISTDATE        * Booking date
          ELSE
            CALL      RDVISA1
            BRANCH    OVRCD,CSIT4000
            COMPARE   TWO,PVITYPE
            GOTO      CSIT4000 IF NOT EQUAL
            MOVE      PVIDATE,VISTDATE        * Visit date
          ENDIF
.
.         Outpatient
.
          MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,CSIT1000
.
          MATCH     OSTFILE,CFILEPRE
          GOTO      CSIT1000 IF EQUAL
.
          MOVE      OSTFILE,CFILEPRE          * Save File Prefix
          PACK      CFNAME,CFILEPRE,FILBOKA6
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
CSIT1000  PACK      KEY36,RCDTVIST,VISTDATE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,CSIT4000
.
          MATCH     DOBAOUTN,RCDTVIST
          GOTO      CSIT4000 IF NOT EQUAL
.
          MOVE      OBASITE,SITECODE
          GOTO      CSIT9000
.
.         Check for Emergency
.
CSIT4000  CALL      RDEMVIS1
          BRANCH    OVRCD,CSIT9000
.
          MOVE      EMVISITE,SITECODE
.
CSIT9000  CALL      OPNOUT00                    * Open outpatient file
CSIT9999  RETURN
+
.-----------------------------------------------------------
.  Selection of Medical Prac.for U/R
.-----------------------------------------------------------
SELMPR00  IF        HSYS3<>1
            GOTO      SELMPR99 * don't read private prac if not using it
          ENDIF
          WRITE     HTMLFILE;"<option value=#"",SP8,"#">":
                             SP20,"</option>"
.
          CALL      INMPA000               * Initialise the array
          PACK      KEY27,URNUMBER,SP70
          CALL      RSPRHD1
SELMPR10  CALL      RKPRHD1
          BRANCH    OVRCD,SELMPR99
.
          MATCH     URNUMBER,PRHDDEBT       * Different U/R
          GOTO      SELMPR99 IF NOT EQUAL
.
          PACK      KEY27,DPRHDUNQ,SP70
          CALL      RSPRHR1
SELMPR20  CALL      RKPRHR1
          BRANCH    OVRCD,SELMPR10
.
          MATCH     DPRHDUNQ,DPRHRUNQ
          GOTO      SELMPR10 IF NOT EQUAL   * Different Unique Id
.
          COMPARE   ONE,PRHRPINV            * Invoice to be printed ?
          GOTO      SELMPR20 IF NOT EQUAL
.
          PACK      KEY6,PRHRPRAC,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,SELMPR20
.
          COMPARE   ONE,PRPRSTAT
          GOTO      SELMPR20 IF EQUAL       * Not active
.
          CALL      MPARR000                * Check Medical Practice array
	  BRANCH    EXIT,SELMPR20
.
.         check the medical practice user access
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      SELMPR80 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRHRPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,SELMPR20          * no access
.
SELMPR80  PACK      KEY8,QUOTE,PRHRPRAC,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY8,">":
                      "(",PRHRPRAC,") ",PRPRDESC,"</option>"
          GOTO      SELMPR20
.
SELMPR99  RETURN
+
.------------------------------------------------------------
.         Initialise Array of Medical Practices
.------------------------------------------------------------
INMPA000  MOVE      ONE,F2
          WHILE     F2<99
            MOVE      SP70,MDPRAC[F2]
            ADD       ONE,F2
          DO
INMPA999  RETURN
+
.------------------------------------------------------------
.         Array of Medical Practices
.------------------------------------------------------------
MPARR000  MOVE      ZERO,F2
MPARR100  ADD       ONE,F2
          MATCH     SP70,MDPRAC[F2]
          GOTO      MPARR200 IF EQUAL
.
          MATCH     PRHRPRAC,MDPRAC[F2]
          GOTO      MPARR100 IF NOT EQUAL
          GOTO      MPARR600
.
MPARR200  MOVE      PRHRPRAC,MDPRAC[F2]
          MOVE      ZERO,EXIT
          GOTO      MPARR999
.
MPARR600  MOVE      ONE,EXIT
          GOTO      MPARR999
.
MPARR999  RETURN
+
.-----------------------------------------------------------
. Table of payment details
.-----------------------------------------------------------
TPAY0000  MATCH     SP70,RECEIPTN
          GOTO      TPAY9999 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      PAYHD000      * Output Table Heading
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,KEY12
          MOVE      KEY12,RECEIPTN
.
          PACK      KEY15,RECEIPTN,SP70
          CALL      RSRCBDT1 
TPAY1000  CALL      RKRCBDT1
          BRANCH    OVRCD,TPAY9999
.
          MATCH     RECEIPTN,RCBDRECN     * same Receipt number?
          GOTO      TPAY9999 IF NOT EQUAL
.
          CALL      DPAY0000      * Display Row of invoice for the receipt
.
          GOTO      TPAY1000
.
TPAY9999  RETURN
.
.------------------------------------------------------------
. Heading for Payment type table (TABLE HEADING)
.------------------------------------------------------------
HPAY0000  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                             "<td align=center><b>Payment Details":
                             "</b></td>":
                             "</tr>"
HPAY9999  RETURN
.
.------------------------------------------------------------
. Heading for Payment type table (TABLE HEADING)
.------------------------------------------------------------
PAYHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=15%>Payment Type":
                             "</td>":
                             "<td class=HeadingCell width=15%>Reference Number":
                             "</td>":
                             "<td class=HeadingCell width=15%>Payer/Drawer":
                             "</td>":
                             "<td class=HeadingCell width=15%>":
                             "Cheque/Money Order Number":
                             "</td>":
                             "<td class=HeadingCell width=15% align=right>":
                             "Amount</td>":
                             "<td class=HeadingCell width=10% align=right>":
                             "Surcharge</td>":
                             "<td class=HeadingCell width=15% align=right>":
                             "Total</td>":
                             "</tr>"
PAYHD999  RETURN
.------------------------------------------------------------
. Display row of payment table(TABLE ROW)
.------------------------------------------------------------
DPAY0000  MOVE      RCBDSTRF,KEY40
          STRIP     KEY40
          ENDSET    KEY40
.
          MOVE      "&nbsp;  ",KEY16
          MOVE      "Invalid Payment Code",KEY20
          MOVE      "Py",KEY2
          PACK      KEY5,KEY2,RCBDPCOD
          CALL      RDCODE1
          BRANCH    OVRCD,DPAY8000
.
          PACK      KEY16,TDESC,SP70
.
          MATCH     "2",PTCDNHCP              * Cheque
          IF        @EQUAL
.           IF        CFEETYP=9
              MOVE      RCBDDRAW,RCBDPAYD       * JH display Drawer as payee
.           ENDIF
            APPEND    RCBDBANK,KEY40
            RESET     KEY40
            STRIP     KEY40
            ENDSET    KEY40
            APPEND    SP1,KEY40
            APPEND    RCBDBRCH,KEY40
          ENDIF
.
          MATCH     "3",PTCDNHCP              * Credit card
          IF        @EQUAL
            MATCH      SP70,RCBDCRDT
            IF         !@EQUAL
              PACK       KEY5,ANSC,ANSR,RCBDCRDT
              CALL       RDCODE1
              IF         OVRCD=0
                MOVE        TDESC,KEY16       * Name of credit card
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "6",PTCDNHCPP              * EFTPOS
          IF        @EQUAL
            STRIP     KEY16
            ENDSET    KEY16
            APPEND    "-",KEY16
            MATCH     "1",RCBDEFTT
            IF        @EQUAL
              APPEND    "Cash",KEY16
            ELSE
              MATCH     "2",RCBDEFTT
              IF        @EQUAL
                MATCH      SP70,RCBDCRDT
                IF         !@EQUAL
                  PACK       KEY5,ANSC,ANSR,RCBDCRDT
                  CALL       RDCODE1
                  IF         OVRCD=0
                    APPEND     TDESC,KEY16
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
DPAY8000  APPEND    SP70,KEY40
          RESET     KEY40
.
          MATCH     SP70,RCBDPAYD
          IF        @EQUAL
            MOVE      "&nbsp;",RCBDPAYD
          ENDIF
.
          MATCH     SP70,RCBDCHQN
          IF        @EQUAL
            MOVE      "&nbsp;",RCBDCHQN
          ENDIF
.
          PACK      KEY15,RCBDRECN,RCBDUNIQ,SP70
          CALL      RDRCCRS1
          IF        OVRCD=1
            MOVE      ZERO,RCCRSAMN         * Surcharge amount
          ENDIF
.
          SUB       RCCRSAMN,RCBDPAMT
          WRITE     HTMLFILE;"<tr>":
                             "<td>",KEY16,"</td>":
                             "<td>&nbsp",KEY40,"</td>":
                             "<td>",RCBDPAYD,"</td>":
                             "<td>",RCBDCHQN,"</td>":
                             "<td align=right>",RCBDPAMT,"</td>":
                             "<td align=right>",RCCRSAMN,"</td>";
. 
          ADD       RCCRSAMN,RCBDPAMT 
          WRITE     HTMLFILE;"<td align=right>",RCBDPAMT,"</td>":
                             "</tr>"    
.            
DPAY9999  RETURN
+
.-----------------------------------------------------------
. Table of receipt details
.-----------------------------------------------------------
TRCP0000  MATCH     SP70,RECEIPTN
          GOTO      TRCP9999 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        DISPFLAG=2
            CALL      RCPHE000      * Output Table Heading
          ELSE
            CALL      RCPHD000      * Output Table Heading
          ENDIF
.
          MOVE      ZERO,COUNTER
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,KEY12
          MOVE      KEY12,RECEIPTN
.
          PACK      KEY17,RECEIPTN,SP70
          CALL      RSRCDTE1 
TRCP1000  CALL      RKRCDTE1
          BRANCH    OVRCD,TRCP9999
.
          MATCH     RECEIPTN,RCDTRECN     * same Receipt number?
          GOTO      TRCP9999 IF NOT EQUAL
.
          IF        DISPFLAG=2
            CALL      VRCP0000      * Disp.invoice with option to apply Deposit
          ELSE
            CALL      DRCP0000      * Display Row of invoice for the receipt
          ENDIF
.
          GOTO      TRCP1000
.
TRCP9999  RETURN
.------------------------------------------------------------
. Heading for Receipting table (TABLE HEADING)
.------------------------------------------------------------
HRCP0000  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                             "<td align=center><b>Invoice Details":
                             "</b></td>":
                             "</tr>"
HRCP9999  RETURN
.
.------------------------------------------------------------
. Heading for Receipting table (TABLE HEADING)
.------------------------------------------------------------
RCPHD000  WRITE     HTMLFILE;"<tr><td class=HeadingCell width=20%>Register":
                             "</td>":
                             "<td class=HeadingCell width=10%>U/R Number":
                             "</td>":
                             "<td class=HeadingCell width=20%>Name":
                             "</td>":
                             "<td class=HeadingCell width=10%>Admission":
                             "</td>":
                             "<td class=HeadingCell width=10%>Invoice":
                             "</td>":
                             "<td class=HeadingCell width=10% align=right>":
                             "Amount</td>":
                             "<td class=HeadingCell width=15%>&nbsp;Status":
                             "</td>" 
.
          IF        DISPFLAG=1
            WRITE     HTMLFILE;"<td class=HeadingCell width=5%>Payments</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
RCPHD999  RETURN
.------------------------------------------------------------
. Display row of receipting table(TABLE ROW)
.------------------------------------------------------------
DRCP0000  MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "&nbsp;",REGDESC
          ENDIF
.
          MOVE      "Unreleased     ",DIM15
          MATCH     SP70,RCDTRELD
          IF        !@EQUAL
            MOVE      "Released       ",DIM15
          ENDIF
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      RDCMDEP1
          BRANCH    OVRCD,DRCP0100
.
          MATCH     "2",CMDESTAT         * refunded receipt?
          GOTO      DRCP0100 IF NOT EQUAL
.
          PACK      DIM15,REFUNDED,CMDERRFN
.
DRCP0100  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1             * read receipting bank header file
          BRANCH    OVRCD,DRCP0400
.
          MATCH     "1",RCBNSTAT         * cancelled receipt?
          IF        @EQUAL
            MOVE      "Cancelled",DIM15
          ENDIF
.
DRCP0400  MATCH     SP70,RCDTINVN
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTINVN
          ENDIF
.
          MATCH     SP70,RCDTVIST
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTVIST
          ENDIF
          CALL      PNAM0000              * Get patient name
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          BRANCH    DISPFLAG,DRCP1000
.
DRCP0500  WRITE     HTMLFILE;"<tr>";
          IF        REGIBACD=98
            WRITE     HTMLFILE;"<td><a HREF = 'javascript:IntCmnt":
                             "(#"":
                             KEY15:
                             "#")'>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon></a>",REGDESC,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td><img src=../images/DietIconTrans.gif":
                             " class=ListIcon>":
                             REGDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;",DIM15,"</td>":
                             "</tr>"
          GOTO      DRCP9999
.
DRCP1000  PACK      KEY32,RCDTRECN,RCDTTCNT,SP70
          CALL      RSRCDBP1
          CALL      RKRCDBP1
          BRANCH    OVRCD,DRCP1100
.
          MATCH     RCDTRECN,RCDBRECN
          GOTO      DRCP1100 IF NOT EQUAL
          MATCH     RCDTTCNT,RCDBTCNT
          GOTO      DRCP1100 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr>";
          IF        REGIBACD=98
            WRITE     HTMLFILE;"<td><a HREF = 'javascript:IntCmnt":
                             "(#"":
                             KEY17:
                             "#")'>":
                             "<img src=../images/EditIcon.gif":
                             " class=ListIcon></a>",REGDESC,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td><img src=../images/DietIconTrans.gif":
                             " class=ListIcon>":
                             REGDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;",DIM15,"</td>":
                             "<td align=center><img ":
                             "src=../images/InvoiceIcon.gif ":
                             "class=ListIcon onclick='showItems(#"":
                             RCDTRECN,"#",#"",RCDTTCNT,"#")'></td>":
                             "</tr>"
          GOTO      DRCP9999
.
DRCP1100  WRITE     HTMLFILE;"<tr>":
                             "<td>",REGDESC,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;",DIM15,"</td>":
                             "<td>&nbsp;</td>":
                             "</tr>"
          GOTO      DRCP9999
.
DRCP9999  RETURN
+
.------------------------------------------------------------
. Heading for Receipting table (TABLE HEADING)
.------------------------------------------------------------
RCPHE000  WRITE     HTMLFILE;"<tr><td class=HeadingCell width=15%>Register":
                             "</td>":
                             "<td class=HeadingCell width=7%>U/R Number":
                             "</td>":
                             "<td class=HeadingCell width=20%>Name":
                             "</td>":
                             "<td class=HeadingCell width=5%>Admission":
                             "</td>":
                             "<td class=HeadingCell width=5%>Invoice":
                             "</td>":
                             "<td class=HeadingCell width=5% align=center>":
                             "Apply":
                             "</td>":
                             "<td class=HeadingCell width=9% align=center>":
                             "To Invoice No.":
                             "</td>":
                             "<td class=HeadingCell width=5% align=right>":
                             "Amount</td>":
                             "<td class=HeadingCell width=7% align=center>":
                             "Allocated By</td>":
                             "<td class=HeadingCell width=20% align=left>":
                             "Released by @</td>":
                             "</tr>"
.
RCPHE999  RETURN
+
.------------------------------------------------------------
. Display row of receipting table(TABLE ROW)
.------------------------------------------------------------
VRCP0000  UNPACK    SP70,REGDESC
          MOVE      ZERO,REGIBACD
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "&nbsp;",REGDESC
          ENDIF
.
          MOVE      "&nbsp;",DIM60A         * set up "Allocated by @" data
          COMPARE   "99",REGIBACD
          IF        @EQUAL
            UNPACK    SP70,RCDTSPDT,RCDTSPTM,WBSENAM
            GOTO      VRCP0100
          ENDIF
.
          MATCH     SP70,RCDTSPDT
          IF        !@EQUAL
            MOVE      SP30,WBSENAM
            MOVE      "Unknown ",WBSENAM
            PACK      KEY10,RCDTSPUI,SP70
            CALL      RDWBSE1
.      
            UNPACK    RCDTSPDT,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CCENT
            REP       " 0",CYEAR
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      RCDTSPTM,KEY5
            CLEAR     DIM60A
            STRIP     WBSENAM
            APPEND    "Allocated by\n",DIM60A
            APPEND    WBSENAM,DIM60A
            APPEND    "\n",DIM60A
            APPEND    CDAY,DIM60A
            APPEND    SP1,DIM60A
            APPEND    MTHNAM3,DIM60A
            APPEND    SP1,DIM60A
            APPEND    CCENT,DIM60A
            APPEND    CYEAR,DIM60A
            APPEND    " @ ",DIM60A
            APPEND    KEY5,DIM60A
            RESET     DIM60A
          ENDIF
.
VRCP0100  MOVE      "&nbsp;",DIM50B         * set up "Release by @" data
          MATCH     SP70,RCDTRELD
          IF        !@EQUAL
            MOVE      SP30,WBSENAM
            MOVE      "Unknown ",WBSENAM
            PACK      KEY10,RCDTRELU,SP70
            CALL      RDWBSE1
            
            UNPACK    RCDTRELD,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CCENT
            REP       " 0",CYEAR
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      RCDTRELT,KEY5
            CLEAR     DIM50B
            STRIP     WBSENAM
            APPEND    WBSENAM,DIM50B
            APPEND    " - ",DIM50B
            APPEND    CDAY,DIM50B
            APPEND    SP1,DIM50B
            APPEND    MTHNAM3,DIM50B
            APPEND    SP1,DIM50B
            APPEND    CCENT,DIM50B
            APPEND    CYEAR,DIM50B
            APPEND    " @ ",DIM50B
            APPEND    KEY5,DIM50B
            MATCH     SP70,RCDTBATN
            IF        !@EQUAL
              APPEND    " - ERA",DIM50B
            ENDIF
            RESET     DIM50B
          ENDIF
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      RDCMDEP1
          BRANCH    OVRCD,VRCP0300
.
          MATCH     "2",CMDESTAT         * refunded receipt?
          GOTO      VRCP0300 IF NOT EQUAL
.
          PACK      DIM15,REFUNDED,CMDERRFN
.
VRCP0300  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1             * read receipting bank header file
          BRANCH    OVRCD,VRCP0400
.
          MATCH     "1",RCBNSTAT         * cancelled receipt?
          IF        @EQUAL
            MOVE      "Cancelled",DIM15
          ENDIF
.
VRCP0400  MATCH     SP70,RCDTVIST
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTVIST
          ENDIF
.
          CALL      PNAM0000              * Get patient name
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
.
          ADD       ONE,COUNTER
          MOVE      COUNTER,DIM3
          REP       " 0",DIM3
          WRITE     HTMLFILE;"<input type=hidden name=sitem",DIM3," value=#"":
                             RCDTTCNT,"#">":
                             "<input type=hidden name=recpt",DIM3," value=#"":
                             RCDTRECN,"#">":
                             "<input type=hidden name=pamnt",DIM3," value=#"":
                             RCDTAMNT,"#">":
                             "<tr><td>",REGDESC,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>";
.
.
          UNPACK    SP70,CMDESTAT,CMDEUUID
.
          MATCH     SP70,RCDTINVN
          GOTO      VRCP6000 IF NOT EQUAL * No option to apply the deposit
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      RDCMDEP1
          BRANCH    OVRCD,VRCP6000        * not a deposit receipt
          MATCH     "0",CMDESTAT          * held receipt?
          GOTO      VRCP1000 IF NOT EQUAL * only available to deposit held only
.
          MOVE      ZERO,F1               * patient system
          CALL      CHKI0000              * Check if there is any invoice
          BRANCH    EXIT,VRCP6000         * No invoice to apply to
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td align=center>":
                             "<input type=checkbox name=cstrn",DIM3:
                             " value=1 onclick='chgDEP(cstrn",DIM3:
                             ",ivtrn",DIM3:
                             ",recpt",DIM3:
                             ",sitem",DIM3:
                             ",pamnt",DIM3:
                             ")' ></td>":
                             "<td align=center>":
                             "<select disabled title='Invoice No.'":
                             " name=ivtrn",DIM3,">";
.
          CALL      SELINV00          * Display available select of invoice no
.
          WRITE     HTMLFILE;"</select></td>";
          GOTO      VRCP8000
.
VRCP1000  MATCH     "2",CMDESTAT         * refunded receipt?
          GOTO      VRCP6000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<td>REFUNDED</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
          GOTO      VRCP8000
.
VRCP6000  WRITE     HTMLFILE;"<td>&nbsp;",RCDTINVN,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
VRCP8000  WRITE     HTMLFILE;"<td align=right>",RCDTAMNT,"</td>";
.
          MATCH     SP8,RCDTSPDT 
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td><td>&nbsp;",DIM50B;
.
            MATCH     SP70,RCDTINVN
            IF        @EQUAL
              MATCH     "2",CMDESTAT         * refunded receipt?
              IF        @EQUAL
                MATCH     SP70,CMDEUUID
                IF        !@EQUAL
                  MOVE      SP70,KEY50
                  CALL      CFND0000             * refunded receipt?
                  WRITE     HTMLFILE;"<br>",KEY50,"</br>";
                ENDIF
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td nowrap><A HREF='javascript:onclick=alert":
                             "(#"",DIM60A,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4 ":
                             "border=0 align=center</a></td>":
                             "<td>&nbsp;",DIM50B,"</td>":
                             "</tr>";
          ENDIF
          GOTO      VRCP9999
.
VRCP9999  RETURN
+
.-----------------------------------------------------------------------------
.         Get Refund details
.-----------------------------------------------------------------------------
CFND0000  MOVE      SP30,WBSENAM
          MOVE      "Unknown ",WBSENAM
          PACK      KEY10,CMDEUUID,SP70
          CALL      RDWBSE1
.
          UNPACK    CMDEUDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CCENT
          REP       " 0",CYEAR
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      CMDEUTIM,KEY5
.
          CLEAR     KEY50
          APPEND    "REFUND - ",KEY50
          STRIP     WBSENAM
          APPEND    WBSENAM,KEY50
          APPEND    " - ",KEY50
          APPEND    CDAY,KEY50
          APPEND    SP1,KEY50
          APPEND    MTHNAM3,KEY50
          APPEND    SP1,KEY50
          APPEND    CCENT,KEY50
          APPEND    CYEAR,KEY50
          APPEND    " @ ",KEY50
          APPEND    KEY5,KEY50
          RESET     KEY50
.
CFND9999  RETURN
+
.-----------------------------------------------------------------------------
.         Check if there is any invoice to apply to
.-----------------------------------------------------------------------------
CHKI0000  MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CHKI9000
.
.         Check the register type of deposit
.
          COMPARE   "90",REGIBACD
          GOTO      CHKI1000 IF EQUAL     * EMR Deposit
          COMPARE   "91",REGIBACD
          GOTO      CHKI2000 IF EQUAL     * Outpatient deposit
          COMPARE   "97",REGIBACD
          GOTO      CHKI3000 IF EQUAL     * Inpatient deposit
.
          GOTO      CHKI9000              * Not from a deposit register
.
CHKI1000  MOVE      ONE,F1                * Emergency
          GOTO      CHKI5000
.
CHKI2000  MOVE      TWO,F1                * Outpatient
          GOTO      CHKI5000
.
CHKI3000  MOVE      THREE,F1              * Inpatient
.
.         Check if there is any invoice raised for the same system of the
.         Deposit register
.
CHKI5000  PACK      KEY32,RCDTURNO,Z70
          CALL      RDSINV5
CHKI6000  CALL      RDPINV5
          BRANCH    OVRCD,CHKI9000
          MATCH     RCDTURNO,PINVUR
          GOTO      CHKI9000 IF NOT EQUAL
.
          COMPARE   F1,PINVSYS            * different system
          GOTO      CHKI6000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CHKI9999
.
CHKI9000  MOVE      ONE,EXIT
CHKI9999  RETURN
+
.-----------------------------------------------------------------------------
.         Display selection of invoice numbers for this U/R (same system type)
.-----------------------------------------------------------------------------
SELINV00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
          PACK      KEY32,RCDTURNO,Z70
          CALL      RDSINV5
SELINV10  CALL      RDPINV5
          BRANCH    OVRCD,SELINV99
          MATCH     RCDTURNO,PINVUR
          GOTO      SELINV99 IF NOT EQUAL
.
          COMPARE   F1,PINVSYS
          GOTO      SELINV10 IF NOT EQUAL   * Different system type
.
          MATCH     "1",PTINCRST
          GOTO      SELINV10 IF EQUAL       * fully credited
.
          WRITE     HTMLFILE;"<option value=#"",PINVNO,"#">":
                               PINVNO,"</option>"
          GOTO      SELINV10
.
SELINV99  RETURN
+
.-----------------------------------------------------------
.  Check if it's a cancelled receipt ?
.-----------------------------------------------------------
CANR0000  MOVE      ZERO,FORM1           * default to 'No' for Receipt option
          MATCH     SP70,RECEIPTN
          GOTO      CANR9000 IF EQUAL
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1             * read receipting bank header file
          BRANCH    OVRCD,CANR9000
.
          MATCH     "1",RCBNSTAT         * cancelled receipt?
          GOTO      CANR9000 IF EQUAL
.
          MATCH     SP70,RCBNRDAT        * check reconciliation date
          IF        !@EQUAL
            MOVE      TWO,FORM1
            GOTO      CANR9000
          ENDIF
.
          MATCH     SP70,RCBNRTIM        * check reconciliation time
          IF        !@EQUAL
            MOVE      TWO,FORM1
            GOTO      CANR9000
          ENDIF
.
          MOVE      ONE,FORM1            * not cancelled, receipt option avail.
.
CANR9000  WRITE     HTMLFILE;FORM1;
CANR9999  RETURN
.
.-----------------------------------------------------------
.    Receipt number
.-----------------------------------------------------------
RCPT0000  MATCH     SP70,RECEIPTN
          GOTO      RCPT9999 IF EQUAL
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,KEY12
          MOVE      KEY12,RECEIPTN
          WRITE     HTMLFILE;RECEIPTN;
RCPT9999  RETURN
.
.-----------------------------------------------------------
.    Invoice number
.-----------------------------------------------------------
INVN0000  COMPARE   ZERO,INVOICEN
          GOTO      INVN9999 IF EQUAL
          MOVE      INVOICEN,KEY12
          IF        VISITTYP=5
            REP       " 0",KEY12
          ENDIF
          MOVE      KEY12,INVOICEN
          WRITE     HTMLFILE;INVOICEN;
INVN9999  RETURN
.
.-----------------------------------------------------------
.    U/R number
.-----------------------------------------------------------
URNN0000  WRITE     HTMLFILE;URNUMBER;
URNN9999  RETURN
.
.-----------------------------------------------------------
.    Visity type
.-----------------------------------------------------------
VIST0000  WRITE     HTMLFILE;VISITTYP;
VIST9999  RETURN
.
.-----------------------------------------------------------
. Table of refund deposit details
.-----------------------------------------------------------
RFND0000  MATCH     SP70,RECEIPTN
          GOTO      RFND9999 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      RFPHD000      * Output Table Heading
          MOVE      ZERO,REFUNDR
.
          MOVE      ZERO,FORM3 
.
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,KEY12
          MOVE      KEY12,RECEIPTN
          PACK      KEY17,RECEIPTN,SP70
          CALL      RSRCDTE1 
RFND1000  CALL      RKRCDTE1
          BRANCH    OVRCD,RFND9999
.
          MATCH     RECEIPTN,RCDTRECN     * same Receipt number?
          GOTO      RFND9999 IF NOT EQUAL
.
          CALL      RFCP0000      * Display Row of invoice for refund deposit
          GOTO      RFND1000
.
RFND9999  RETURN
.------------------------------------------------------------
. Heading for Receipting table (TABLE HEADING)
.------------------------------------------------------------
RFPHD000  WRITE     HTMLFILE;"<tr><td class=HeadingCell width=20%>Register":
                             "</td>":
                             "<td class=HeadingCell width=10%>U/R Number":
                             "</td>":
                             "<td class=HeadingCell width=20%>Name":
                             "</td>":
                             "<td class=HeadingCell width=10%>Admission":
                             "</td>":
                             "<td class=HeadingCell width=10%>Invoice":
                             "</td>":
                             "<td class=HeadingCell width=10% align=right>":
                             "Amount</td>":
                            "<td class=HeadingCell width=20%>":
                            "&nbsp;Reason for Refund</td>":
                             "</tr>"
.
RFPHD999  RETURN
.------------------------------------------------------------
. Display row of receipting table(TABLE ROW)
.------------------------------------------------------------
RFCP0000  MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "&nbsp;",REGDESC
          ENDIF
.
          MATCH     SP70,RCDTINVN
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTINVN
          ENDIF
.
          MATCH     SP70,RCDTVIST
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTVIST
          ENDIF
.
          CALL      PNAM0000              * Get patient name
          PACK      KEY17,RCDTRECN,RCDTTCNT
          CALL      RDCMDEP1
          BRANCH    OVRCD,RFCP5000
.
          MATCH     "1",CMDESTAT          * Deposit applied?
          GOTO      RFCP5000 IF EQUAL
.
          MATCH     "0",CMDESTAT          * Deposit held?
          GOTO      RFCP4000 IF NOT EQUAL
.
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,RFCP5000
.
          COMPARE   "90",REGIBACD
          GOTO      RFCP6000 IF EQUAL     * EMR Deposit
          COMPARE   "91",REGIBACD
          GOTO      RFCP6000 IF EQUAL     * Outpatient deposit
          COMPARE   "96",REGIBACD
          GOTO      RFCP6000 IF EQUAL     * Private practice deposit
          COMPARE   "97",REGIBACD
          GOTO      RFCP6000 IF EQUAL     * Inpatient deposit
          GOTO      RFCP5000
.
RFCP4000  MATCH     "2",CMDESTAT           * deposit refunded?
          GOTO      RFCP9999 IF NOT EQUAL
.
          MOVE      "&nbsp",TDESC
          PACK      KEY5,ANSD,ANSR,CMDERRFN
          CALL      RDCODE1
          WRITE     HTMLFILE;"<tr><td>",REGDESC,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;",TDESC,"</td></tr>"
          GOTO      RFCP9999
.
RFCP5000  WRITE     HTMLFILE;"<tr><td>",REGDESC,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;</td></tr>"
          GOTO      RFCP9999
.
RFCP6000  ADD       ONE,FORM3   * Increment parameter counter
          MOVE      FORM3,KEY3
          REP       " 0",KEY3 
.
          WRITE     HTMLFILE;"<input type=hidden name=trann",KEY3," value=#"":
                             KEY17,"#">":
                             "<tr><td>",REGDESC,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",RCDTINVN,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;<select name=reasf",KEY3,">"
.
          CALL      RFOP0000       * Refund deposit selection list
          WRITE     HTMLFILE;"</select></td></tr>"
          ADD       ONE,REFUNDR
RFCP9999  RETURN
.
.-----------------------------------------------------------
.         Get patient name
.-----------------------------------------------------------
PNAM0000  MOVE      "&nbsp;",PATFNAME
          MATCH     SP70,RCDTURNO
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTURNO
            PACK      PATFNAME,RCDTNAME,SP70
            GOTO      PNAM9999
          ENDIF
.                                                * Private Practice
          IF        (REGIBACD=2 | REGIBACD=96)
            GOTO      PNAM2110
          ENDIF
.                                                * Sundry debtors
          IF        REGIBACD=5
            GOTO      PNAM2130
          ENDIF
.
.         PMI 
.
PNAM2110  PACK      KEY8,RCDTURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PNAM9999
          GOTO      PNAM2190
.
.         Acc Rec Debtor 
.
PNAM2130  PACK      KEY8,RCDTURNO,SP70
          UNPACK    SP70,DBDBNA1,DBDBNA2
          MOVE      "Debtor not found",DBDBNA1
          CALL      RDDBDB1
...       BRANCH    OVRCD,PNAM9999
.
          PACK      PATFNAME,DBDBNA1,SP70
          GOTO      PNAM9999
.
PNAM2190  CALL      PATNAA00
.
PNAM9999  RETURN
+
.-----------------------------------------------------------
.         Refund deposit selection list
.-----------------------------------------------------------
RFOP0000  WRITE     HTMLFILE;"<option></option>"

          PACK      KEY2,ANSD,ANSR
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
RFOP1000  CALL      RDKCODE1
          BRANCH    OVRCD,RFCP9999
          MATCH     KEY2,TCODE
          GOTO      RFCP9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      RFOP1000 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",ACODE,"#">":
                             TDESC,"</option>"
          GOTO      RFOP1000
RFOP9999  RETURN
.
.-----------------------------------------------------------
.    Invoice date
.-----------------------------------------------------------
INVD0000  COMPARE   ZERO,INVOICEN
          GOTO      INVD9999 IF EQUAL
          WRITE     HTMLFILE;INVCDATE;
INVD9999  RETURN
.
.-----------------------------------------------------------
.    List of Receipts for an invoice
.-----------------------------------------------------------
LRCP0000  MOVE      INVOICEN,DIM12
          IF        VISITTYP=5
            REP       " 0",DIM12
          ENDIF
          CALL      RECPH000      * Output Table Heading
.
          PACK      KEY29,DIM12,SP70
          CALL      RSRCDTE3
LRCP1000  CALL      RKRCDTE3
          BRANCH    OVRCD,LRCP9999
          MATCH     DIM12,RCDTINVN
          GOTO      LRCP9999 IF NOT EQUAL    * different invoice number
.
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,LRCP1000
.
          COMPARE   "2",REGIBACD
          GOTO      LRCP4000 IF EQUAL        * Private practice
          COMPARE   "96",REGIBACD
          GOTO      LRCP4000 IF EQUAL        * Private Practice Deposit
.
          COMPARE   FOUR,VISITTYP
          GOTO      LRCP1000 IF EQUAL        * Private Practice visit
          GOTO      LRCP8000
.
LRCP4000  COMPARE   FOUR,VISITTYP
          GOTO      LRCP1000 IF NOT EQUAL    * not a private practice visit
.
LRCP8000  CALL      DLRCP000                 * display row of receipt
          GOTO      LRCP1000
.
LRCP9999  RETURN
+
.------------------------------------------------------------
. List of Receipts (TABLE HEADING)
.------------------------------------------------------------
RECPH000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Receipt Number</td>":
                               "<td class=HeadingCell width=20%>":
                               "Date</td>":
                               "<td align=right class=HeadingCell width=20%>":
                               "Amount</td>":
                               "<td align=right class=HeadingCell width=20%>":
                               "Discount</td>":
                               "<td class=HeadingCell width=20%>":
                               "Status</td>":
                             "</tr>"
.
RECPH999  RETURN
.------------------------------------------------------------
. Display Receipt row (TABLE ROW)
.------------------------------------------------------------
DLRCP000  ADD       ONE,FORM2   * Increment parameter counter
          MOVE      FORM2,KEY2
          REP       " 0",KEY2 
.
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CCENT
          REP       " 0",CYEAR
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "Unreleased",KEY10
          MATCH     SP70,RCDTRELD
          IF        !@EQUAL
            MOVE      "Released",KEY10
          ENDIF
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1             * read receipting bank header file
          BRANCH    OVRCD,DLRCP400
.
          MATCH     "1",RCBNSTAT         * cancelled receipt?
          IF        @EQUAL
            MOVE      "Cancelled",KEY10
          ENDIF
.
DLRCP400  WRITE     HTMLFILE;"<tr>":
                             "<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkReceipt(#"":
                             RCDTRECN,"#",#"",URNUMBER,"#")'>":
                             RCDTRECN,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td align=right>",RCDTDISC,"</td>":
                             "<td>",KEY10,"</td>":
                             "</tr>";
.
DLRCP999  RETURN
+
.-----------------------------------------------------------
. Option 5: Cash Drawer Enquiry
.-----------------------------------------------------------
CSHE0000  BRANCH    FLDITMNO,CSHE0100,CSHE0200,CSHE0300,CSHE0400,CSHE0500:
                             CSHE0600,CSHE0700,CSHE0800,CSHE0900,CSHE1000:
                             CSHE1100,CSHE1200,CSHE1300,CSHE1400,CSHE1500:
                             CSHE1600,CSHE1700,CSHE1800,CSHE1900,CSHE2000:
                             CSHE2100,CSHE2200,CSHE2300,CSHE2400,CSHE2500:
                             CSHE2600,CSHE2700,CSHE2800,CSHE2900,CSHE3000:
                             CSHE3100
          GOTO      CSHE9999
.
CSHE0100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,CSHE0110
          MATCH     RCPBK004,Z70
          GOTO      CSHE9999 IF EQUAL
          WRITE     HTMLFILE;RCPBK004;
          GOTO      CSHE9999

CSHE0110  MOVE      RCPBK004,CASHDRWR
          CALL      CDSLTN00
          GOTO      CSHE9999
.
CSHE0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,CSHE0210
          MATCH     RCPBK017,Z70
          GOTO      CSHE9999 IF EQUAL
          WRITE     HTMLFILE;RCPBK017;
          GOTO      CSHE9999
.
CSHE0210  MOVE      RCPBK017,CASHIERC
          CALL      CSHRSL00
          GOTO      CSHE9999
.
CSHE0300  CALL      SELV0000                       * Show date range field
          GOTO      CSHE9999
.
CSHE0400  IF        SHOWTOTS=1
            WRITE     HTMLFILE;DOLLAR,TOTTOTAL;
          ENDIF
          GOTO      CSHE9999
.
CSHE0500  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTCASH;
          ENDIF
          GOTO      CSHE9999
.
CSHE0600  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBCASH;
          ENDIF
          GOTO      CSHE9999
.
CSHE0700  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTCHQ;
          ENDIF
          GOTO      CSHE9999
.
CSHE0800  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBCHQ;
          ENDIF
          GOTO      CSHE9999
.
CSHE0900  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTCRED;
          ENDIF
          GOTO      CSHE9999
.
CSHE1000  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBCRED;
          ENDIF
          GOTO      CSHE9999
.
CSHE1100  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTDDBT;
          ENDIF
          GOTO      CSHE9999
.
CSHE1200  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBDDBT;
          ENDIF
          GOTO      CSHE9999
.
CSHE1300  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTMONOR;
          ENDIF
          GOTO      CSHE9999
.
CSHE1400  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBMONOR;
          ENDIF
          GOTO      CSHE9999
.
CSHE1500  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTEFTCR;   * (was TOTEFTPO)    *C-222934
          ENDIF
          GOTO      CSHE9999
.
CSHE1600  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBEFTCR;   * (was TNBEFTPO)    *C-222934
          ENDIF
          GOTO      CSHE9999
.
CSHE1700  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CSHE9999
.
CSHE1800  CALL      NXTPER00                       * Next Day, Week, Month
          GOTO      CSHE9999
.
CSHE1900  CALL      PREPER00                       * Previous Day, Week, Month
          GOTO      CSHE9999
.
CSHE2000  MATCH     SP70,FRSTDATE
          GOTO      CSHE9999 IF EQUAL
          GOTO      CSHE9999 IF EOS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      CSHE9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CSHE9999
.
CSHE2100  MATCH     SP70,LASTDATE
          GOTO      CSHE9999 IF EQUAL
          GOTO      CSHE9999 IF EOS
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      CSHE9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CSHE9999
.
CSHE2200  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTEFTDB;                       *I-222934
          ENDIF
          GOTO      CSHE9999
.
CSHE2300  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBEFTDB;                       *I-222934
          ENDIF
          GOTO      CSHE9999
.
CSHE2400  UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      ZERO,F2
          SQUEEZE   KEY2
          MOVE      KEY2,F2
          IF        F2=6
            UNPACK    DIM127,D1,KEY1,DIM127
          ENDIF
          COMPARE   ZERO,F2
          GOTO      CSHE9999 IF EQUAL
.
          PACK      KEY40,PAYMDESC[F2],SP70
          BRANCH    F2,CSHE2480,CSHE2480,CSHE2480,CSHE2480,CSHE2480:
                       CSHE2410
         GOTO      CSHE2480
.
CSHE2410  PACK      DIM20,PAYMDESC[F2],SP70
          MOVE      SP70,KEY40
          STRIP     DIM20
.
          MOVE      DIM20,KEY40
          MATCH     "1",KEY1
          IF        @EQUAL
            ENDSET    KEY40
            APPEND    " - Credit Card",KEY40
            APPEND    SP70,KEY40
            RESET     KEY40
          ELSE
            MOVE      SP70,KEY40
            MOVE      DIM20,KEY40
            ENDSET    KEY40
            APPEND    " - Cash",KEY40
            APPEND    SP70,KEY40
            RESET     KEY40
          ENDIF
.
CSHE2480  WRITE     HTMLFILE;KEY40;
          GOTO      CSHE9999
.
CSHE2500  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTBPAY;
          ENDIF
          GOTO      CSHE9999
.
CSHE2600  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBBPAY;
          ENDIF
          GOTO      CSHE9999
.
CSHE2700  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTHCAP;
          ENDIF
          GOTO      CSHE9999
.
CSHE2800  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBHCAP;
          ENDIF
          GOTO      CSHE9999
.
CSHE2900  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TOTMCAR;
          ENDIF
          GOTO      CSHE9999
.
CSHE3000  IF        SHOWTOTS=0
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;DOLLAR,TNBMCAR;
          ENDIF
          GOTO      CSHE9999
.
CSHE3100  COMPARE   ZERO,SHOWTOTS
          GOTO      CSHE9999 IF EQUAL
.
          MOVE      TEN,F2
CSHE3120  COMPARE   "99",F2
          GOTO      CSHE9999 IF EQUAL
.
          PACK      KEY20,PAYMDESC[F2],SP70
          MATCH     SP70,KEY20
          GOTO      CSHE9999 IF EQUAL
.
.         IF        SHOWTOTS=0
.           WRITE     HTMLFILE;"<tr><td width=40%>&nbsp;</td>":
.                              "<td>&nbsp;</td>":
.                              "<td>&nbsp;</td></tr>";
.         ELSE
            WRITE     HTMLFILE;"<tr><td width=40%>",PAYMDESC[F2],"</td>":
                          "<td align=right><b>",DOLLAR,TOTOTHR[F2],"</td>":
                          "<td align=right><b>",DOLLAR,TNBOTHR[F2],"</td></tr>";
.         ENDIF
          ADD       ONE,F2
          GOTO      CSHE3120
.
CSHE9999  RETURN
+
.-----------------------------------------------------------
.  Cash Drawer Selection List - rcpcidaf
.-----------------------------------------------------------
CDSLTN00  PACK      KEY6,SP70
          CALL      RDSCIDA1
CDSLTN10  CALL      RDKCIDA1
          BRANCH    OVRCD,CDSLTN99
.
          MATCH     "1",RCCIACTV
          GOTO      CDSLTN10 IF EQUAL   * Inactive
.
          CLEAR     FORMATNM
          APPEND    RCPGIVEN,FORMATNM
          APPEND    SP1,FORMATNM
          APPEND    RCPSUR,FORMATNM
          RESET     FORMATNM
.
          PACK      KEY8,QUOTE,RCPCASH,QUOTE
          MATCH     CASHDRWR,RCPCASH
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8,"selected>",FORMATNM:
                               "</option>";
          ELSE
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCCIHOSP
              IF        !@EQUAL
                MATCH     WBSEHOSP,RCCIHOSP
                GOTO      CDSLTN10 IF NOT EQUAL
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY8,">",FORMATNM:
                               "</option>";
          ENDIF
.
          GOTO      CDSLTN10
.
CDSLTN99  RETURN
.-----------------------------------------------------------
.  Cashier Selection List - websecaf
.-----------------------------------------------------------
CSHRSL00  PACK      KEY11,ONE,SP70
          CALL      RSWBSE4
CSHRSL10  CALL      RKWBSE4
          BRANCH    OVRCD,CSHRSL99
.
          MATCH     "1",WBSECASH
          GOTO      CSHRSL99 IF NOT EQUAL
.
          PACK      KEY12,QUOTE,WBSEUID,QUOTE
          MATCH     CASHIERC,WBSEUID
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY12,"selected>",WBSENAM:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY12,">",WBSENAM:
                               "</option>";
          ENDIF
          GOTO      CSHRSL10
.
CSHRSL99  RETURN

.------------------------------------------------------------------------------
. Cash Drawer Id Maintenance                
.------------------------------------------------------------------------------
RCID0000  BRANCH    FLDITMNO,RCID0100,RCID0200,RCID0300,RCID0400,RCID0500:
                             RCID0600,RCID0700,RCID0800,RCID0900,RCID1000:
                             RCID1100,RCID1200,RCID1300,RCID1400,RCID1500:
                             RCID1600
          GOTO      RCID9999
.
RCID0100  WRITE     HTMLFILE;RCPCASH;     * Cashier Code
          GOTO      RCID9999
.
RCID0200  WRITE     HTMLFILE;RCPPASS;     * Password
          GOTO      RCID9999
.
RCID0300  WRITE     HTMLFILE;RCPSUR;      * Surname
          GOTO      RCID9999
.
RCID0400  MATCH     SP70,RCPGIVEN         * Given Name
          GOTO      RCID9999 IF EQUAL
          WRITE     HTMLFILE;RCPGIVEN;
          GOTO      RCID9999
.
RCID0500  WRITE     HTMLFILE;RCPSECUR;    * Security Code
          GOTO      RCID9999
.
RCID0600  CALL      CIDTB000              * Cash Drawer Id Table
          GOTO      RCID9999
.
RCID0700  CALL      NEXTCS00              * Next Set of Registers
          GOTO      RCID9999
.
RCID0800  CALL      PREVCS00              * Previous Set of Registers
          GOTO      RCID9999
.
RCID0900  CALL      HOSSEL00              * Hospital Code
          GOTO      RCID9999
.
RCID1000  PACK      KEY15,SP70
          CALL      RSFMCH1
RCID1010  CALL      RKFMCH1
          BRANCH    OVRCD,RCID9999
.
          PACK      KEY17,QUOTE,FMCHCHQ,QUOTE
          MATCH     RCCICHQA,FMCHCHQ
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY17,"selected>",FMCHDES:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY17,">",FMCHDES:
                               "</option>";
          ENDIF
          GOTO      RCID1010
.
RCID1100  MATCH     SP70,RCCIACTV
          IF        @EQUAL
           WRITE     HTMLFILE;"0";        * Active
          ELSE
           WRITE     HTMLFILE;RCCIACTV;
          ENDIF
          GOTO      RCID9999
.
RCID1200  PACK      KEY1,RCCICCRD,SP70    * Charging Credit Card Surcharge
          REP       " 0",KEY1
          WRITE     HTMLFILE;KEY1;
          GOTO      RCID9999
.
RCID1300  PACK      DIM3,RCCIINVR,SP70
          MOVE      ONE,F1                * Invoice registers only
          CALL      REGSLT00
          GOTO      RCID9999
.
RCID1400  PACK      DIM3,RCCIDEPR,SP70
          MOVE      TWO,F1                * Deposit registers only
          CALL      REGSLT00
          GOTO      RCID9999
.
RCID1500  COMPARE   ONE,IBCNMHOS
          GOTO      RCID1520 IF NOT EQUAL    * No Multi hospital
.
          MATCH     SP70,WBSEHOSP
          GOTO      RCID1520 IF EQUAL        * blank hospital id
.
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,RCID1520
.
          MATCH     SP70,PTHSCRSR
          IF        !@EQUAL
            PACK      RCCNCRSR,PTHSCRSR,SP70
          ENDIF
.
RCID1520  WRITE     HTMLFILE;RCCNCRSR;
          GOTO      RCID9999
.
RCID1600  WRITE     HTMLFILE;RCCI3PPS;       * 3rd Party Payment Source
          GOTO      RCID9999
.
RCID9999  RETURN
+
.-----------------------------------------------------------
.  Register Selection List - rcpregaf
.-----------------------------------------------------------
REGSLT00  READ      CONTROLF,THIRTY6;*221,RCCNORUH
.
          PACK      KEY38,SP70
          CALL      RDSREGA4
REGSLT10  CALL      RDKREGA4
          BRANCH    OVRCD,REGSLT99
.
          MATCH     "1",REGACTIV            * 1=Inactive
          GOTO      REGSLT10 IF EQUAL       * bypass Inactive
.
          IF        IBCNMHOS=1
            MATCH     "1",RCCNORUH
            IF        @EQUAL
              MATCH     WBSEHOSP,REGHOSP
              GOTO      REGSLT10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF         F1=3
            MATCH      REGCP001,REGCODE
            GOTO       REGSLT10 IF EQUAL
            COMPARE    "89",REGIBACD
            GOTO       REGSLT80 IF EQUAL   * Credit Card surcharge register only
            GOTO       REGSLT10
          ELSE
            COMPARE    "89",REGIBACD
            GOTO       REGSLT10 IF EQUAL   * skip Credit Card surcharge register
          ENDIF
.
          BRANCH     F1,REGSLT30,REGSLT40
          GOTO       REGSLT80
.
REGSLT30  COMPARE    ONE,REGIBACD
          GOTO       REGSLT80 IF EQUAL      * Patient billing register
          COMPARE    TWO,REGIBACD
          GOTO       REGSLT80 IF EQUAL      * Private Prac.register
          GOTO       REGSLT10
.
REGSLT40  COMPARE    "90",REGIBACD
          GOTO       REGSLT80 IF EQUAL      * EMR Deposit
          COMPARE    "91",REGIBACD
          GOTO       REGSLT80 IF EQUAL      * Outpatient Deposit
          COMPARE    "97",REGIBACD
          GOTO       REGSLT80 IF EQUAL      * IP Deposit
          COMPARE    "96",REGIBACD
          GOTO       REGSLT80 IF EQUAL      * Private Prac.Deposit
          GOTO       REGSLT10
.
REGSLT80  PACK      KEY7,QUOTE,REGCODE,REGIBACD,QUOTE
          MATCH     DIM3,REGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY7,"selected>",REGDESC:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY7,">",REGDESC:
                               "</option>";
          ENDIF
          GOTO      REGSLT10
.
REGSLT99  RETURN
+
.------------------------------------------------------------
. Hospital Selection List
.------------------------------------------------------------
HOSSEL00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MATCH     SP70,RCCIHOSP
          GOTO      HOSSEL20 IF EQUAL
          PACK      KEY3,RCCIHOSP
          CALL      RDPTHSP1
          BRANCH    OVRCD,HOSSEL20
          BRANCH    F1,HOSSEL10,HOSSEL20
          WRITE     HTMLFILE;PTHSHOSP;
          GOTO      HOSSEL99
.
HOSSEL10  WRITE     HTMLFILE;PTHSNAME;
          GOTO      HOSSEL99
.
HOSSEL20  MOVE      RCCIHOSP,DIM3
          CALL      HSEL0000
          GOTO      HOSSEL99
.
HOSSEL99  RETURN
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     DIM3,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
.------------------------------------------------------------
. Table of Cash Drawer Id's                 
.------------------------------------------------------------
CIDTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      CIDHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY6,STARTKEY,SP70
          CALL      RDSCIDA1 
          IF        OVRCD=0
            CALL      RDPCIDA1
          ENDIF 
CIDTB100  CALL      RDKCIDA1
          BRANCH    OVRCD,CIDTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CIDTB100
          ENDIF
.
          CALL      CIDRW000      * Display Cash Drawer Id Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CIDTB100 IF NOT EQUAL
          GOTO      CIDTB999
.
CIDTB900  CALL      NOMORE00      * Display No More Records Message
.
CIDTB999  RETURN
.------------------------------------------------------------
. Cash Drawer Id Maintenance (TABLE HEADING)
.------------------------------------------------------------
CIDHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Cash Drawer Id":
                             "</td>":
                             "<td class=HeadingCell width=40%>Description":
                             "</td>":
                             "<td class=HeadingCell width=20%>Active":
                             "</td>":
                             "</tr>"
.
CIDHD999  RETURN
.------------------------------------------------------------
. Cash Drawer Id Maintenance (TABLE ROW)
.------------------------------------------------------------
CIDRW000  
..          MATCH     SP70,TDESC
..          IF        @EQUAL
..            MOVE      "&nbsp;",TDESC
..          ENDIF
.
.
          MOVE      "Yes",KEY3
          MATCH     "1",RCCIACTV
          IF        @EQUAL
            MOVE      "No ",KEY3              * Inactive
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&rcpdr001=",RCPCASH,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             RCPCASH,"</td>":
                             "<td>",RCPSUR,"</td>":
                             "<td>",KEY3,"</td>":
                             "</tr>"
.
CIDRW999  RETURN
.------------------------------------------------------------------------------
. Register Maintenance                
.------------------------------------------------------------------------------
REGS0000  BRANCH    FLDITMNO,REGS0100,REGS0200,REGS0300,REGS0400,REGS0500:
                             REGS0600,REGS0700,REGS0800,REGS0900,REGS1000:
                             REGS1100,REGS1200,REGS1300,REGS1400,REGS1500:
                             REGS1600,REGS1700,REGS1800,REGS1900,REGS2000:
                             REGS2100,REGS2200,REGS2300,REGS2400,REGS2500:
                             REGS2600,REGS2700,REGS2800,REGS2900,REGS3000:
                             REGS3100,REGS3200,REGS3300,REGS3400,REGS3500:
                             REGS3600,REGS3700,REGS3800,REGS3900,REGS4000:
                             REGS4100,REGS4200
          GOTO      REGS9999
.
REGS0100  WRITE     HTMLFILE;REGCODE;     * Register Code
          GOTO      REGS9999
.
REGS0200  WRITE     HTMLFILE;REGDESC;     * Description
          GOTO      REGS9999
.
REGS0300  MATCH     SP70,REGCHQCD         * Cheque Account Code
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGCHQCD;
          GOTO      REGS9999
.
REGS0400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MATCH     SP70,REGGENLD         * General Ledger Income A/C
          GOTO      REGS9999 IF EQUAL
.
          BRANCH    F1,REGS0410
.
          PACK      KEY14,REGGENLD,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,REGS9999
.
          WRITE     HTMLFILE;FMAMDESC;    * Income Account Description
          GOTO      REGS9999
.
REGS0410  MATCH     "1",RCCNLEDG          * One char of Ledger account
          IF        @EQUAL
            UNPACK    REGGENLD,LEDNUM,ACCNO
          ELSE
            UNPACK    REGGENLD,LEDNO,ACCNO
          ENDIF
          WRITE     HTMLFILE;ACCNO;       * Income Account Code
          GOTO      REGS9999
.
REGS0500  MATCH     SP70,REGGENBK         * General Ledger Control A/C
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGGENBK;
          GOTO      REGS9999
.
REGS0600  MOVE      REGGROUP,CODE         * Group Code
          MOVE      "RG",CATEGORY
          CALL      CODITM00
          GOTO      REGS9999
.
REGS0700  COMPARE   ZERO,REGIBACD         * IBA System Code
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGIBACD;
          GOTO      REGS9999
.
REGS0800  COMPARE   ZERO,REGSUNDT         * Sundry Debtors Ledger No.
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGSUNDT;
          GOTO      REGS9999
.
REGS0900  MATCH     SP70,REGDISS          * GL Dissection Code   
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGDISS;
          GOTO      REGS9999
.
REGS1000  MATCH     SP70,REGRESP          * GL Responsibilty Code   
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGRESP;
          GOTO      REGS9999
.
REGS1100  MATCH     SP70,REGGENDS         * General Ledger suspense A/C
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGGENDS;
          GOTO      REGS9999
.
REGS1200  MATCH     SP70,REGGST           * GST Code
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGGST;
          GOTO      REGS9999
.
REGS1300  MATCH     SP70,REGISTRG         * Register Group
          GOTO      REGS9999 IF EQUAL
          WRITE     HTMLFILE;REGISTRG;
          GOTO      REGS9999
.
REGS1400  MOVE      ZERO,HREGFLAG
          CALL      REGTB000              * Register Table
          GOTO      REGS9999
.
REGS1500  CALL      NEXTCS00              * Next Set of Registers
          GOTO      REGS9999
.
REGS1600  CALL      PREVCS00              * Previous Set of Registers
          GOTO      REGS9999
.
REGS1700  COMPARE   ONE,IBCNMHOS
          GOTO      REGS1710 IF EQUAL
.
          WRITE     HTMLFILE;HSYS1;       * Using General Ledger 1=Yes 0=No
          GOTO      REGS9999
.
REGS1710  MATCH     SP10,REGHOSP
          GOTO      REGS9999 IF EQUAL
          MOVE      REGHOSP,KEY3
          CALL      RDPTHSP1
          BRANCH    OVRCD,REGS9999
.
          WRITE     HTMLFILE;PTHSUFMS;     * Using fms for hospital
          GOTO      REGS9999
.
REGS1800  UNPACK    REGGENLD,LEDNO,ACCNO
          CALL      LEDGER00              * Ledger Selection List
          GOTO      REGS9999
.
REGS1900  CALL      DISS0000              * Dissection Selection List
          GOTO      REGS9999
.
REGS2000  CALL      RESPNS00              * Responsibility Selection List
          GOTO      REGS9999
.
REGS2100  CALL      IBAGST00              * GST Selection List
          GOTO      REGS9999
.
REGS2200  CALL      CHQLST00              * Cheque Account Selection List
          GOTO      REGS9999
.
REGS2300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get Bank Ledger/Account Code and Name
.
          PACK      KEY14,FMAMLEDG,FMCSBNK,SP20
          CALL      RDFMAM1              * Account Master Details
          BRANCH    OVRCD,REGS9999
          BRANCH    F1,REGS2310            
.
          WRITE     HTMLFILE;FMAMDESC;               * Bank Ledger/Acc Desc
          GOTO      REGS9999
REGS2310  PACK      KEY18,FMLALEDG,SLASH,FMCSBNK     * Bank Ledger/Acc Code
          WRITE     HTMLFILE;KEY18;
          GOTO      REGS9999

REGS2400  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get Cheque Account
.
          PACK      KEY14,FMLALEDG,FMCSBNK,SP70
          CALL      RDFMCA1              * Control Account Master Table
          BRANCH    OVRCD,REGS9999

          PACK      KEY15,FMCACHQ,SP70
          CALL      RDFMCH1              * Cheque Account Master Details
          BRANCH    OVRCD,REGS9999
          BRANCH    F1,REGS2410            
.
          WRITE     HTMLFILE;FMCHDES;    * Description
          GOTO      REGS9999
REGS2410  WRITE     HTMLFILE;FMCHCHQ;    * Code
          GOTO      REGS9999
.
REGS2500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get Debtor Control Ledger/Account
.
          PACK      KEY14,FMAMLEDG,FMCSDEB,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,REGS9999
          BRANCH    F1,REGS2510            
.
          WRITE     HTMLFILE;FMAMDESC;               * Desc
          GOTO      REGS9999
.
REGS2510  PACK      KEY18,FMLALEDG,SLASH,FMCSDEB     * Debtors Cont Ledger/Acc
          WRITE     HTMLFILE;KEY18;                  
          GOTO      REGS9999
.
REGS2600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      GETC0000              * Get Control Account Details
.
.  Get GST Control Account
.
          PACK      KEY14,FMAMLEDG,FMCSAGST,SP20
          CALL      RDFMAM1
          BRANCH    OVRCD,REGS9999
          BRANCH    F1,REGS2610            
.
          WRITE     HTMLFILE;FMAMDESC;              * Desc
          GOTO      REGS9999
.
REGS2610  PACK      KEY18,FMLALEDG,SLASH,FMCSAGST   
          WRITE     HTMLFILE;KEY18;                  
          GOTO      REGS9999
.
REGS2700  MOVE      REGSUNDT,LEDNO
          CALL      LEDGER00              * Ledger Selection List
          GOTO      REGS9999
.
REGS2800  WRITE     HTMLFILE;HSYS2;       * Using Inpatient Billing 1=Yes 0=No
          GOTO      REGS9999
.
REGS2900  WRITE     HTMLFILE;HSYS3;       * Using Private Practice 1=Yes 0=No
          GOTO      REGS9999
.
REGS3000  WRITE     HTMLFILE;HSYS6;       * Using Sundry Debtors 1=Yes 0=No
          GOTO      REGS9999
.
REGS3100  COMPARE   ONE,IBCNMHOS
          GOTO      REGS9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr valign=top>":
                             "<td class=DataLabel>Hospital ID</td>":
                             "<td><select name=regcp014 title='Hospital ID' ":
                             "class=Mandatory ":
                             "onchange='checkFMS();'>":
                             "<option></option>"
          MOVE      REGHOSP,DIM3
          CALL      HSEL0000
          WRITE     HTMLFILE;"</select></td></tr>";
          GOTO      REGS9999
.
REGS3200  WRITE     HTMLFILE;IBCNMHOS;
          GOTO      REGS9999
.
.****************************************** Start of addition          *I-58556
REGS3300  MOVE      "Active  ",KEY8       * default Active
          MOVE      "Inactive",KEY9
          MOVE      "1",KEY1
          MATCH     "1",REGACTIV          * Activity Ind. 1=Inactive
          GOTO      REGS3310 IF NOT EQUAL
.                                         * reverse descriptions
          MOVE      "Inactive",KEY8
          MOVE      "Active  ",KEY9
          MOVE      "0",KEY1
.
REGS3310  WRITE     HTMLFILE;"<option value=#"",REGACTIV,"#" selected> ":
                             KEY8,"</option>"
          WRITE     HTMLFILE;"<option value=#"",KEY1,"#"> ":
                             KEY9,"</option>"
          GOTO      REGS9999
.******************************************   End of addition          *I-58556
.
REGS3400  MATCH     "1",RCCNLEDG              * Using One char of Ledger number
          IF        @EQUAL
            UNPACK    REGGENLD,LEDNUM
            WRITE     HTMLFILE;LEDNUM;
          ELSE
            UNPACK    REGGENLD,LEDNO
            WRITE     HTMLFILE;LEDNO;
          ENDIF
          GOTO      REGS9999
.
REGS3500  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,REGS3510
.
          MATCH     "1",RCCNLEDG              * Using One char of Ledger number
          IF        @EQUAL
            UNPACK    REGGENLD,LEDNUM,ACCNO   * Income Account
          ELSE
            UNPACK    REGGENLD,LEDNO,ACCNO    * Income Account
          ENDIF
          WRITE     HTMLFILE;ACCNO;
          GOTO      REGS9999
.
REGS3510  WRITE     HTMLFILE;REGGENLD;       * Healthscope register account
          GOTO      REGS9999
.
REGS3600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,REGS3610
.
          MATCH     "1",RCCNLEDG              * Using One char of Ledger number
          IF        @EQUAL
            UNPACK    REGGENBK,LEDNUM,ACCNO     * Bank Account
          ELSE
            UNPACK    REGGENBK,LEDNO,ACCNO      * Bank Account
          ENDIF
          WRITE     HTMLFILE;ACCNO;
          GOTO      REGS9999
.
REGS3610  WRITE     HTMLFILE;REGGENBK;      * Healthscope register account
          GOTO      REGS9999
.
REGS3700  WRITE     HTMLFILE;REGCHQCD;        * Cheque Account
          GOTO      REGS9999
.
REGS3800  MATCH     "1",RCCNLEDG              * Using One char of Ledger number
          IF        @EQUAL
            UNPACK    REGGENDB,LEDNUM,ACCNO     * Debtors Control Account
          ELSE
            UNPACK    REGGENDB,LEDNO,ACCNO      * Debtors Control Account
          ENDIF
          WRITE     HTMLFILE;ACCNO;
          GOTO      REGS9999
.
REGS3900  MATCH     "1",RCCNLEDG              * Using One char of Ledger number
          IF        @EQUAL
            UNPACK    REGGENGS,LEDNUM,ACCNO     * GST Control Account 
          ELSE      
            UNPACK    REGGENGS,LEDNO,ACCNO      * GST Control Account
          ENDIF
          WRITE     HTMLFILE;ACCNO;
          GOTO      REGS9999
.
REGS4000  WRITE     HTMLFILE;REGSUNDT;        * Sundry debtors ledger number
          GOTO      REGS9999
.
REGS4100  PACK      DIM3,RCRECSUR,SP70
          MOVE      THREE,F1                  * Credit Card Surcharge reg.only
          CALL      REGSLT00
.
          PACK      KEY3,REGCP001,SP70        * Restore register fields
          CALL      RDREGA1 
          IF        OVRCD=1
            CALL      CLRREG00              * Clear all the file variables
          ENDIF
.
          GOTO      REGS9999
.
REGS4200  MOVE      ONE,HREGFLAG
          CALL      REGTB000              * Register Table
          GOTO      REGS9999
.
REGS9999  RETURN
+
.------------------------------------------------------------------------
. Get Control Account Details
.------------------------------------------------------------------------
GETC0000  UNPACK    REGGENLD,LEDNO,ACCNO
          PACK      KEY2,LEDNO
          CALL      RDFMLA1              * Ledger Master Details
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
          PACK      KEY14,REGGENLD,SP70
          CALL      RDFMCS1              * Selected Control Accounts
          BRANCH    OVRCD,GETC9000
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
.
          MOVE      FMLABNK,FMCSBNK
.
GETC0010  MATCH     SP70,FMCSDEB
          GOTO      GETC0020 IF NOT EQUAL
.
          MOVE      FMLADEB,FMCSDEB
.
GETC0020  MATCH     SP70,FMCSAGST
          GOTO      GETC9999 IF NOT EQUAL
.
          MOVE      FMLAAGST,FMCSAGST
.
          GOTO      GETC9999
.
GETC9000  MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
GETC9999  RETURN
.-------------------------------------------------
. Cheque Account Selection List
.-------------------------------------------------
CHQLST00  PACK      KEY15,SP70
          CALL      RSFMCH1
CHQLST10  CALL      RKFMCH1
          BRANCH    OVRCD,CHQLST99
.
          MATCH     REGCHQCD,FMCHCHQ
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",FMCHCHQ," selected>":
                               FMCHDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",FMCHCHQ,">":
                               FMCHDES,"</option>"
          ENDIF
          GOTO      CHQLST10
.
CHQLST99  RETURN
.-------------------------------------------------
. GST Selection List
.-------------------------------------------------
IBAGST00  PACK      KEY6,SP70
          CALL      RSIBGS1
IBAGST10  CALL      RKIBGS1
          BRANCH    OVRCD,IBAGST99
.
          COMPARE   ONE,IBGSACTV          * Active Indicator
          GOTO      IBAGST10 IF EQUAL
.
          MATCH     REGGST,IBGSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected>":
                               IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#">":
                               IBGSDESC,"</option>"
          ENDIF
          GOTO      IBAGST10
.
IBAGST99  RETURN
.-------------------------------------------------
. Responsibility Selection List
.-------------------------------------------------
RESPNS00  PACK      KEY4,SP70
          CALL      RSFMRS1
RESPNS10  CALL      RKFMRS1
          BRANCH    OVRCD,RESPNS99
.
          MATCH     REGRESP,FMRSCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",FMRSCODE," selected>":
                               FMRSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",FMRSCODE,">":
                               FMRSDESC,"</option>"
          ENDIF
          GOTO      RESPNS10
.
RESPNS99  RETURN
.-------------------------------------------------
. Dissection Selection List
.-------------------------------------------------
DISS0000  PACK      KEY5,SP10
          CALL      RSFMDS1
DISS1000  CALL      RKFMDS1
          BRANCH    OVRCD,DISS9999
.
          MATCH     FMDSCODE,REGDISS
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",FMDSCODE,"#" selected> ":
                               FMDSCODE,": ",FMDSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",FMDSCODE,"#"> ":
                               FMDSCODE,": ",FMDSDESC,"</option>"
          ENDIF
          GOTO      DISS1000
.
DISS9999  RETURN
.------------------------------------------------------------
. Ledger Selection List              
.------------------------------------------------------------
LEDGER00  PACK      KEY2,SP70
          CALL      RSFMLA1
LEDGER10  CALL      RKFMLA1
          BRANCH    OVRCD,LEDGER99
.
          MATCH     LEDNO,FMLALEDG
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",FMLALEDG," selected>":
                               FMLADESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",FMLALEDG,">":
                               FMLADESC,"</option>"
          ENDIF
          GOTO      LEDGER10
.
LEDGER99  RETURN
.------------------------------------------------------------
. Table of Registers                 
.------------------------------------------------------------
REGTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      REGHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY3,STARTKEY,SP70
          CALL      RDSREGA1 
          IF        OVRCD=0
            CALL      RDPREGA1
          ENDIF 
REGTB100  CALL      RDKREGA1
          BRANCH    OVRCD,REGTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      REGTB100
          ENDIF
.
          CALL      REGRW000      * Display Register Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      REGTB100 IF NOT EQUAL
          GOTO      REGTB999
.
REGTB900  CALL      NOMORE00      * Display No More Records
.
REGTB999  RETURN
.------------------------------------------------------------
. Register Maintenance (TABLE HEADING)
.------------------------------------------------------------
REGHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=20%>Register":
                             "</td>":
                             "<td class=HeadingCell width=40%>Description":
                             "</td>":
                             "<td class=HeadingCell width=15%>Income Account ":
                             "</td>";
.
          IF        HREGFLAG=1
            WRITE    HTMLFILE;"<td class=HeadingCell width=15%>Control Account":
                               "</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=15%>IBA System ":
                             "</td>":
                             "<td class=HeadingCell width=15%>Status   ":
                             "</td>":
                             "</tr>"
.
REGHD999  RETURN
.------------------------------------------------------------
. Register Maintenance (TABLE ROW)
.------------------------------------------------------------
REGRW000  
..MATCH     SP70,TDESC
..          IF        @EQUAL
..            MOVE      "&nbsp;",TDESC
..          ENDIF
.
          CALL      SYSCOD00      * IBA System Code Description
.
          MATCH     SP70,REGGENLD
          IF        !@EQUAL
            IF        HREGFLAG=1
              PACK      KEY15,REGGENLD,SP70
            ELSE
              MATCH     "1",RCCNLEDG          * Using One char of Ledger account
              IF        @EQUAL
                UNPACK    REGGENLD,KEY1,KEY12
                PACK      KEY15,KEY1,SLASH,KEY12
              ELSE
                UNPACK    REGGENLD,KEY2,KEY12
                PACK      KEY15,KEY2,SLASH,KEY12
              ENDIF
            ENDIF
          ELSE
            MOVE      "&nbsp;",KEY15
          ENDIF  
.
.******************************************** Start of addition        *I-58556
          MATCH     "1",REGACTIV
          IF        @EQUAL
            MOVE      "Inactive",KEY8
          ELSE
            MOVE      "Active  ",KEY8
          ENDIF
.********************************************   End of addition        *I-58556
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&regcp001=",REGCODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             REGCODE,"</td>":
                             "<td>",REGDESC,"</td>":
                             "<td>",KEY15,"</td>";
.
          IF        HREGFLAG=1
            WRITE     HTMLFILE;"<td>&nbsp;",REGGENBK,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",IBADESC,"</td>":
                             "<td>",KEY8,"</td>":                      *I-58556
                             "</tr>"
.
REGRW999  RETURN
.---------------------------------------------------------------------------
.   Get IBA System Description
.---------------------------------------------------------------------------
SYSCOD00  IF        REGIBACD > 9
             GOTO      SYSCOD05
          ENDIF
.
          ADD       ONE,REGIBACD
          LOAD      IBADESC,REGIBACD,IBA0,IBA1,IBA2,IBA3,IBA4,IBA5,IBA6
          SUB       ONE,REGIBACD
.
          GOTO      SYSCOD99
.
SYSCOD05  COMPARE   "99",REGIBACD      * Suspense
          GOTO      SYSCOD10 IF EQUAL
.
          COMPARE   "98",REGIBACD      * Internal Reciepts
          GOTO      SYSCOD11 IF EQUAL
.
          COMPARE   "97",REGIBACD      * Cash Deposits(Pat)
          GOTO      SYSCOD12 IF EQUAL
.
          COMPARE   "96",REGIBACD      * Cash Deposits(Pri)
          GOTO      SYSCOD13 IF EQUAL
.
          COMPARE   "95",REGIBACD      * Cash Sales Receipts
          GOTO      SYSCOD14 IF EQUAL
.
          COMPARE   "94",REGIBACD      * Debtors Cash Receipt
          GOTO      SYSCOD15 IF EQUAL
.
          COMPARE   "93",REGIBACD      * NOT USED!
          GOTO      SYSCOD16 IF EQUAL
.
          COMPARE   "92",REGIBACD      * GST Sundry Cash Sales
          GOTO      SYSCOD17 IF EQUAL
.
          COMPARE   "91",REGIBACD      * Cash Deposits(OUT)   
          GOTO      SYSCOD18 IF EQUAL
.
          COMPARE   "90",REGIBACD      * Cash Deposits(EMR)   
          GOTO      SYSCOD19 IF EQUAL
.
          COMPARE   "89",REGIBACD      * Credit Card Surcharge
          GOTO      SYSCOD20 IF EQUAL
.
          MOVE      "SYSTEM CODE DESCRIPTION NOT FOUND!",IBADESC
.
          GOTO      SYSCOD99

SYSCOD10  MOVE      "Suspense",IBADESC
          GOTO      SYSCOD99

SYSCOD11  MOVE      "Internal Receipts",IBADESC
          GOTO      SYSCOD99
.
SYSCOD12  MOVE      "Cash Deposits (Pat.)",IBADESC
          GOTO      SYSCOD99
.
SYSCOD13  MOVE      "Cash Deposits (Pri.)",IBADESC
          GOTO      SYSCOD99
.
SYSCOD14  MOVE      "Sundry Cash Sales",IBADESC
          GOTO      SYSCOD99
.
SYSCOD15  MOVE      "Sundry Debtor Rec.",IBADESC
          GOTO      SYSCOD99
.
SYSCOD16  MOVE      "Patient Billing/Deposits",IBADESC
          GOTO      SYSCOD99
.
SYSCOD17  MOVE      "GST Sundry Cash Sales",IBADESC
          GOTO      SYSCOD99
.
SYSCOD18  MOVE      "Cash Deposits(OUT)",IBADESC
          GOTO      SYSCOD99
.
SYSCOD19  MOVE      "Cash Deposits(EMR)",IBADESC
          GOTO      SYSCOD99
.
SYSCOD20  MOVE      "Credit Card Surcharge",IBADESC
          GOTO      SYSCOD99
.
SYSCOD99  RETURN
.------------------------------------------------------------
. Link to Next set of Receipting Cashier
.------------------------------------------------------------
NEXTCS00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       " +",URNUMBER
          REP       " +",INVNUMBR
          REP       " +",CHEQUENO
.
          MOVE      RCPTDATE,CHNGDATE
          CALL      GETDAT00
.
          WRITE     HTMLFILE;"rcpweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY:
                                 "&rcptdate=",DISPDATE:
                                 "&scanflag=",SCANFLAG:
                                 "&urnumber=",URNUMBER:
                                 "&invnumbr=",INVNUMBR:
                                 "&minmamnt=",MINMAMNT:
                                 "&chequeno=",CHEQUENO:
                                 "&depsonly=",DEPSONLY;
.
          REP       "+ ",STARTKEY
          REP       "+ ",URNUMBER
          REP       "+ ",INVNUMBR
          REP       "+ ",CHEQUENO
.
NEXTCS99  RETURN
.------------------------------------------------------------------------------
. Link to previous set of Receipting Cashier
.------------------------------------------------------------------------------
PREVCS00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",STARTKEY
          REP       " +",URNUMBER
          REP       " +",INVNUMBR
          REP       " +",CHEQUENO
.
          MOVE      RCPTDATE,CHNGDATE
          CALL      GETDAT00
.
          WRITE     HTMLFILE;"rcpweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY:
                                 "&rcptdate=",DISPDATE:
                                 "&scanflag=",SCANFLAG:
                                 "&urnumber=",URNUMBER:
                                 "&invnumbr=",INVNUMBR:
                                 "&minmamnt=",MINMAMNT:
                                 "&chequeno=",CHEQUENO:
                                 "&depsonly=",DEPSONLY;
.
          REP       "+ ",STARTKEY
          REP       "+ ",URNUMBER
          REP       "+ ",INVNUMBR
          REP       "+ ",CHEQUENO
.
PREVCS99  RETURN
+
.-----------------------------------------------------------
. Change date format from CCYYMMDD to DD MMM CCYY
. Input:  CHNGDATE
. Output: DISPDATE
.-----------------------------------------------------------
GETDAT00  MATCH     SP70,CHNGDATE
          GOTO      GETDAT90 IF EQUAL
          GOTO      GETDAT90 IF EOS
.
          UNPACK    CHNGDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      GETDAT90 IF EQUAL
.
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      GETDAT99
.
GETDAT90  MOVE      SP70,DISPDATE
GETDAT99  RETURN
.-----------------------------------------------------------
. Option 7: View  receipts
.-----------------------------------------------------------
ERCP0000  BRANCH    FLDITMNO,ERCP0100,ERCP0200,ERCP0300,ERCP0400,ERCP0500: 
                             ERCP0600,ERCP0700,ERCP0800,ERCP0900,ERCP1000:
                             ERCP1100,ERCP1200,ERCP1300,ERCP1400,ERCP1500:
                             ERCP1600,ERCP1700,ERCP1800,ERCP1900,ERCP2000:
                             ERCP2100,ERCP2200,ERCP2300,ERCP2400,ERCP2500:
                             ERCP2600,ERCP2700,ERCP2800,ERCP2900,ERCP3000
          GOTO      ERCP9999
.
ERCP0100  CALL      RCPLST00             * Receipt List           
          GOTO      ERCP9999
.
ERCP0200  CALL      PREVCS00             * previous               
          GOTO      ERCP9999
.
ERCP0300  CALL      NEXTCS00             * next                   
          GOTO      ERCP9999
.
ERCP0400  MATCH     SP70,RCPTDATE
          GOTO      ERCP9999 IF EQUAL
          GOTO      ERCP9999 IF EOS
          UNPACK    RCPTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          MATCH     "00",CDAY
          GOTO      ERCP9999 IF EQUAL
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERCP9999
.
ERCP0500  WRITE     HTMLFILE;SCANFLAG;                     
          GOTO      ERCP9999
.
ERCP0600  WRITE     HTMLFILE;URNUMBER;                     
          GOTO      ERCP9999
.
ERCP0700  WRITE     HTMLFILE;INVNUMBR;                     
          GOTO      ERCP9999
.
ERCP0800  COMPARE   ZERO,MINMAMNT
          GOTO      ERCP9999 IF EQUAL
          WRITE     HTMLFILE;MINMAMNT;                     
          GOTO      ERCP9999
.
ERCP0900  WRITE     HTMLFILE;CHEQUENO;                     
          GOTO      ERCP9999
.
ERCP1000  WRITE     HTMLFILE;DEPSONLY;                     
          GOTO      ERCP9999
.
ERCP1100  MATCH     SP1,RCBNSTAT
          GOTO      ERCP9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      RCBNSTAT,F1
          MOVE      NOTBANKD,STATUS
          LOAD      STATUS,F1,CANCELLD,BANKED
          WRITE     HTMLFILE;STATUS;
          GOTO      ERCP9999
.
ERCP1200  MATCH     SP1,RCBNTTYP
          GOTO      ERCP9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      RCBNTTYP,F1
          BRANCH    F1,ERCP1210,ERCP1220,ERCP1230,ERCP1240
          WRITE     HTMLFILE;PATIENT;
          GOTO      ERCP9999
.
ERCP1210  PACK      KEY14,RCBNRCOD,HFHEADER,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HEALTHFD," - ",HFNAME;
          ELSE
            WRITE     HTMLFILE;HEALTHFD;
          ENDIF
          GOTO      ERCP9999
.
ERCP1220  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDINSR1
          IF        OVRCD=0
            WRITE     HTMLFILE;INSRCOMP," - ",INAME;
          ELSE
            WRITE     HTMLFILE;INSRCOMP;
          ENDIF
          GOTO      ERCP9999
.
ERCP1230  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDGOVR1
          IF        OVRCD=0
            WRITE     HTMLFILE;GOVTDEPT," - ",GNAME;
          ELSE
            WRITE     HTMLFILE;GOVTDEPT;
          ENDIF
          GOTO      ERCP9999
.
ERCP1240  PACK      KEY6,RCBNRCOD,SP70
          CALL      RDPAHGP1
          IF        OVRCD=0
            WRITE     HTMLFILE;HLTHFDGP," - ",PTHGDESC;
          ELSE
            WRITE     HTMLFILE;HLTHFDGP;
          ENDIF
          GOTO      ERCP9999
.
ERCP1300  CALL      HPAY0000             * Table of heading line
          GOTO      ERCP9999
.
ERCP1400  CALL      TPAY0000             * Table of payment types
          GOTO      ERCP9999
.
ERCP1500  CALL      HRCP0000             * Table of heading line
          GOTO      ERCP9999
.
ERCP1600  MOVE      ONE,DISPFLAG
          CALL      TRCP0000             * Table of receipt details
          GOTO      ERCP9999
.
ERCP1700  CALL      INVITM00                               
          GOTO      ERCP9999
.
ERCP1800  CALL      PATDEP00             * Patient Level Deposit List
          GOTO      ERCP9999
.
ERCP1900  MOVE      ZERO,F1
          CALL      NXTDEP00             * next set of deposits
          GOTO      ERCP9999
.
ERCP2000  MOVE      ZERO,F1
          CALL      PRVDEP00             * previous set of deposits
          GOTO      ERCP9999
.
ERCP2100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERCP9999
.
ERCP2200  MOVE      TWO,DISPFLAG
          CALL      TRCP0000             * Table of receipt details
          GOTO      ERCP9999
.
ERCP2300  CALL      INVN0000             * invoice number
          GOTO      ERCP9999
.
ERCP2400  WRITE     HTMLFILE;SSRETURN;   * Suspense Enquiry return
          GOTO      ERCP9999
.
ERCP2500  CALL      PATRCP00             * Patient Level Receipt List
          GOTO      ERCP9999
.
ERCP2600  CALL      PTRDEP00             * Transferred Deposit List
          GOTO      ERCP9999
.
ERCP2700  MOVE      ONE,F1
          CALL      PRVDEP00             * previous set of deposits
          GOTO      ERCP9999
.
ERCP2800  MOVE      ONE,F1
          CALL      NXTDEP00             * next set of deposits
          GOTO      ERCP9999
.
ERCP2900  WRITE     HTMLFILE;REVRECPT;
          GOTO      ERCP9999
.
ERCP3000  COMPARE   ZERO,NORECORD
          MOVE      PTCNNRTD,NORECORD IF EQUAL    * Set Default No Records
          WRITE     HTMLFILE;NORECORD;
          GOTO      ERCP9999
.
ERCP9999  RETURN
+
.-----------------------------------------------------------
. Option 8: View Suspense Receipts
.-----------------------------------------------------------
SUSP0000  BRANCH    FLDITMNO,SUSP0100,SUSP0200,SUSP0300,SUSP0400,SUSP0500:
                             SUSP0600
.
          GOTO      SUSP9999
.
SUSP0100  CALL      SUSRLS00                * Suspense Receipts List
          GOTO      SUSP9999
.
SUSP0200  MATCH     SP70,RCPTDATE           * Receipt Date
          GOTO      SUSP9999 IF EQUAL
          GOTO      SUSP9999 IF EOS
          WRITE     HTMLFILE;RCPTDATL;      * Long date (dd mmm ccyy)
          GOTO      SUSP9999
.
SUSP0300  MATCH     SP70,ALOCDATE           * Allocated Date
          GOTO      SUSP9999 IF EQUAL
          GOTO      SUSP9999 IF EOS
          WRITE     HTMLFILE;ALOCDATL;      * Long date (dd mmm ccyy)
          GOTO      SUSP9999
.
SUSP0400  WRITE     HTMLFILE;SELALLOC;       * select allocated data
          GOTO      SUSP9999
.
SUSP0500  WRITE     HTMLFILE;SELUNALL;       * select unallocated data
          GOTO      SUSP9999
.
SUSP0600  WRITE     HTMLFILE;RECEIPTN;       * Receipt No.
          GOTO      SUSP9999
.
SUSP9999  RETURN
+
.------------------------------------------------------------------------------
. Create Suspense Receipts List 
.------------------------------------------------------------------------------
SUSRLS00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP3,DIM3A
          PACK      RECEIPTN,RECEIPTN,SP70
.
          MATCH     SP20,RECEIPTN
          IF        !@EQUAL
            SQUEEZE   RECEIPTN
            MOVE      ZERO,FORM12
            MOVE      RECEIPTN,FORM12
            MOVE      FORM12,RECEIPTN
          ENDIF
.
          COMPARE   ONE,SELUNALL
          GOTO      SUSRLS30 IF NOT EQUAL   * if Unallocated not selected
.
.                                           * Process Unallocated Suspense
          MATCH     SP20,RECEIPTN
          IF        @EQUAL | @EOS
            MATCH     SP8,RCPTDATE
            GOTO      SUSRLS30 IF EQUAL     * if RCPTDATE & RECEIPTN blank, end
          ENDIF
.                                           * read unallocated Suspense Receipts
.                                           * - these will only be in "rcpdteaf"
SUSRLS10  MOVE      "DTE",DIM3A
          PACK      KEY18,TWO,SP70        * position read on unalloc.suspense
          MATCH     SP20,RECEIPTN
          IF        !@EQUAL
            PACK      KEY18,TWO,RECEIPTN,SP70
          ENDIF
          CALL      RSRCDTE4
SUSRLS20  CALL      RKRCDTE4
          BRANCH    OVRCD,SUSRLS30
.
          MATCH     "2",RCDTALLO
          GOTO      SUSRLS30 IF NOT EQUAL
.
          MATCH     SP20,RECEIPTN
          IF        !@EQUAL
            MATCH     RECEIPTN,RCDTRECN
            GOTO      SUSRLS30 IF NOT EQUAL
          ENDIF
.
          MOVE      RCDTRECN,KEY12          * read Bank Record for this Receipt
          CALL      RDRCBNK1
          BRANCH    OVRCD,SUSRLS20
.
          MATCH     "1",RCBNSTAT
          GOTO      SUSRLS20 IF EQUAL       * Cancelled
.
          MATCH     SP8,RCPTDATE
          IF        !@EQUAL
            MATCH     RCBNTDAT,RCPTDATE     * is it selected Receipt date ?
            GOTO      SUSRLS20 IF NOT EQUAL
          ENDIF
.
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          IF        OVRCD<>1
            COMPARE   "99",REGIBACD         * dont duplicate Suspense Receipts
.                                           * that appear in both Allocated and
.                                           * Unallocated lists
            GOTO      SUSRLS20 IF NOT EQUAL
            IF        SELALLOC = 1
              MATCH     SP8,RCDTSPDT
              GOTO      SUSRLS20 IF NOT EQUAL
            ENDIF
          ENDIF
.
          CALL      SUSROW00
          GOTO      SUSRLS20
.
.
.                                           * read allocated Suspense Receipts
.                                           * - these are in "rcpsrtaf" only
SUSRLS30  MOVE      SP3,DIM3A
          COMPARE   ONE,SELALLOC
          GOTO      SUSRLS99 IF NOT EQUAL   * if Allocated is not selected, end
.
          MATCH     SP20,RECEIPTN
          IF        @EQUAL | @EOS
            MATCH     SP8,RCPTDATE
            GOTO      SUSRLS60 IF NOT EQUAL    * use "rcpsrtaf" Index 2
            MATCH     SP8,ALOCDATE
            GOTO      SUSRLS80 IF NOT EQUAL    * use "rcpsrtaf" Index 3
            GOTO      SUSRLS99
          ENDIF
.
          PACK      KEY12,RECEIPTN,SP20
          CALL      RDRCBNK1                * read Bank Record for this Receipt
          BRANCH    OVRCD,SUSRLS99
.
          MATCH     "1",RCBNSTAT
          GOTO      SUSRLS99 IF EQUAL       * Cancelled - end
.
.                                           * Process Allocated by Receipt Date
          PACK      KEY17,RECEIPTN,SP20
          CALL      RSRCSRT1
SUSRLS40  CALL      RKRCSRT1                * read by Receipt Number
          BRANCH    OVRCD,SUSRLS99
.
          MATCH     RECEIPTN,RCSRRECN
          GOTO      SUSRLS99 IF NOT EQUAL
.
          MATCH     SP8,RCPTDATE
          IF        !@EQUAL
            MATCH     RCPTDATE,RCSRTDAT     * check if same Receipt Tran. Date
            GOTO      SUSRLS40 IF NOT EQUAL
          ENDIF
          MATCH     SP8,ALOCDATE
          IF        !@EQUAL
            MATCH     ALOCDATE,RCSRALDT     * check if same Allocation Date
            GOTO      SUSRLS40 IF NOT EQUAL
          ENDIF
.
          CALL      SUSROW00
          GOTO      SUSRLS40
.                                           * Process Allocated by Receipt Date
SUSRLS60  MATCH     SP8,RCPTDATE
          GOTO      SUSRLS80 IF EQUAL
.
          PACK      KEY25,RCPTDATE,SP20
          CALL      RSRCSRT2
SUSRLS70  CALL      RKRCSRT2                * read by Receipt Date
          BRANCH    OVRCD,SUSRLS80
.
          MATCH     RCPTDATE,RCSRTDAT
          GOTO      SUSRLS80 IF NOT EQUAL
.
          MOVE      RCSRRECN,KEY12          * read Bank Record for this Receipt
          CALL      RDRCBNK1
          BRANCH    OVRCD,SUSRLS70
.
          MATCH     "1",RCBNSTAT
          GOTO      SUSRLS70 IF EQUAL       * Cancelled
.
.
          CALL      SUSROW00
          GOTO      SUSRLS70
.
.                                        * Process "Allocated" by Allocated Date
SUSRLS80  MATCH     SP8,ALOCDATE
          GOTO      SUSRLS99 IF EQUAL
.                                           * Process Allocated by allocated dat
          PACK      KEY25,ALOCDATE,SP20
          CALL      RSRCSRT3
SUSRLS90  CALL      RKRCSRT3                * read by Allocated Date
          BRANCH    OVRCD,SUSRLS99
.
          MATCH     ALOCDATE,RCSRALDT
          GOTO      SUSRLS99 IF NOT EQUAL
.
          MOVE      RCSRRECN,KEY12          * read Bank Record for this Receipt
          CALL      RDRCBNK1
          BRANCH    OVRCD,SUSRLS90
.
          MATCH     "1",RCBNSTAT
          GOTO      SUSRLS90 IF EQUAL       * Cancelled
.
          CALL      SUSROW00
          GOTO      SUSRLS90
.
SUSRLS99  RETURN
.------------------------------------------------------------------------------
. Suspense Row
.------------------------------------------------------------------------------
SUSROW00  MOVE      SP1,ANS
          MOVE      RCSRRECT,SUSTYPE
          MATCH     "DTE",DIM3A
          GOTO      SUSROW20 IF NOT EQUAL
.                                           * move data to common fields
SUSROW10  MOVE      SP1,SUSTYPE
          MOVE      RCDTRECN,RCSRRECN
          MOVE      RCDTTCNT,RCSRTCNT
          MOVE      RCDTTDAT,RCSRTDAT
          MOVE      RCDTREGI,RCSRREGI
          MOVE      RCDTINVN,RCSRINVN
          MOVE      RCDTVIST,RCSRVIST
          MOVE      RCDTNAME,RCSRNAME
          MOVE      RCDTADD1,RCSRADD1
          MOVE      RCDTADD2,RCSRADD2
          MOVE      RCDTADD3,RCSRADD3
          MOVE      RCDTADD4,RCSRADD4
          MOVE      RCDTPOST,RCSRPCOD
          MOVE      RCDTREFR,RCSRREFR
          MOVE      RCDTAMNT,RCSRAMNT
          MOVE      RCDTSPDT,RCSRCDAT
          MOVE      RCDTSPTM,RCSRCTIM
          MOVE      RCDTSPUI,RCSRCUID
          
SUSROW20  REP       " +",RCSRRECN
          REP       " +",RCSRTCNT
          CLEAR     VARIABLE
          APPEND    LINKPRG,VARIABLE
          APPEND    ".pbl?reportno=",VARIABLE
          APPEND    LINKREP,VARIABLE
          APPEND    "&template=",VARIABLE
          APPEND    LINKTEM,VARIABLE
          APPEND    "&nochkrec=1",VARIABLE
          APPEND    "&receiptn=",VARIABLE
          APPEND    RCSRRECN,VARIABLE
.
          APPEND    "&ssreturn=",VARIABLE   * remember selection criteria
          PACK      KEY24,RCPTDATL,ALOCDATL,SELALLOC,SELUNALL,SP20
          REP       " +",KEY24
          APPEND    KEY24,VARIABLE
          RESET     VARIABLE
          REP       "+ ",RCSRRECN
          REP       "+ ",RCSRTCNT
.
          PACK      KEY3,RCSRREGI,SP70      * Type, Suspense Amount, Details
          CALL      RDREGA1
          IF        OVRCD<>1
            MOVE      REGDESC,KEY20
          ENDIF
          STRIP     RCSRNAME
          STRIP     RCSRADD1
          STRIP     RCSRADD2
          STRIP     RCSRADD3
          STRIP     RCSRADD4
          STRIP     RCSRPCOD
          STRIP     REGDESC
.
          MOVE      "&nbsp;",KEY15
          MOVE      "&nbsp;",KEY20
          MOVE      "&nbsp;",DIM16A
          MOVE      "&nbsp;",DIM60A
.
          MATCH     SP20,RCSRREFR
          IF        @EQUAL
            MOVE      "&nbsp;",RCSRREFR
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      SUSTYPE,F1              * 1=Original 2=Residual 3=Allocation
          BRANCH    F1,SUSROW40,SUSROW40,SUSROW50
.
.                                           * setup unallocated Suspense recds
SUSROW30  MOVE      REGDESC,KEY20
          MOVE      RCSRAMNT,KEY15       
          PACK      DIM100,RCSRNAME,SP1,RCSRADD1,SP1,RCSRADD2,SP1,RCSRADD3:
                       SP1,RCSRADD4,SP1,RCSRPCOD
          GOTO      SUSROW70
.
.                                           * setup allocated Suspense header
SUSROW40  MATCH     "1",SUSTYPE 
          IF        @EQUAL
            MOVE      "Original Suspense",KEY20
          ELSE
            MOVE      "Residual Suspense",KEY20
          ENDIF
          MOVE      RCSRAMNT,KEY15
          PACK      DIM100,RCSRNAME,SP1,RCSRADD1,SP1,RCSRADD2,SP1,RCSRADD3:
                       SP1,RCSRADD4,SP1,RCSRPCOD
          GOTO      SUSROW70
.
. ----------------------------------------------------------------------------
.                                           * set up allocated detail records
SUSROW50  MOVE      SP1,ANS
.
          CLEAR     DIM100
          COMPARE   "99",REGIBACD
          IF        @EQUAL
            PACK      DIM60B,RCSRADD1,SP1,RCSRADD2,SP1,RCSRADD3,SP1,RCSRADD4:
                         SP1,RCSRPCOD
            APPEND    REGDESC,DIM100
            APPEND    " - ",DIM100
            APPEND    RCSRNAME,DIM100
            APPEND    SP1,DIM100
            APPEND    DIM60B,DIM100
          ELSE
            PACK      KEY17,RCSRRECN,RCSRTCNT,SP20
            CALL      RDRCDTE1
            IF        OVRCD = 0
              MATCH     SP8,RCDTRELD
              IF        @EQUAL
                MOVE      "*",ANS
              ENDIF
            ENDIF
            MOVE      "&nbsp;",KEY15
            APPEND    REGDESC,DIM100
            APPEND    " - ",DIM100
            MATCH     SP8,RCSRINVN
            IF        !@EQUAL
              APPEND    "Invoice ",DIM100
              APPEND    RCSRINVN,DIM100
              APPEND    SP1,DIM100
            ENDIF
            MATCH     SP8,RCSRVIST
            IF        !@EQUAL
              APPEND    "Visit No ",DIM100
              APPEND    RCSRVIST,DIM100
            ENDIF
            APPEND    " - ",DIM100
            APPEND    RCSRNAME,DIM100
          ENDIF
          RESET     DIM100
          PACK      DIM16A,RCSRAMNT,ANS,SP10
.
SUSROW60  MATCH     SP8,RCSRCDAT
          IF        !@EQUAL
            MOVE      SP30,WBSENAM
            MOVE      "Unknown ",WBSENAM
            PACK      KEY10,RCSRCUID,SP10
            CALL      RDWBSE1
.
            UNPACK    RCSRCDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      RCSRCTIM,KEY5
            CLEAR     DIM60A
            STRIP     WBSENAM
            APPEND    WBSENAM,DIM60A
            APPEND    " - &nbsp;",DIM60A
            APPEND    KEY11,DIM60A
            APPEND    " @ ",DIM60A
            APPEND    KEY5,DIM60A
            RESET     DIM60A
          ENDIF
          GOTO      SUSROW70
.
SUSROW70  REP       " 0",RCSRTCNT
          WRITE     HTMLFILE;"t.addRow(#"",VARIABLE,"#",":
                             "#"",RCSRRECN,"#",":
                             "#"",RCSRTDAT,"#",":
                             "#"",KEY20,"#",":                   * susp Type
                             "#"",KEY15,"#",":                   * Susp Amount
                             "#"",DIM100,"#",":                  * Details
                             "#"",RCSRREFR,"#",":                * Reference
                             "#"",DIM16A,"#",":                  * Amount Alloc
                             "#"",DIM60A,"#",":                  * Alloc By    
                             "#"",RCSRRECN,RCSRTCNT,"#");"       * sort seq
.
SUSROW99  RETURN
+
.------------------------------------------------------------
. Table of Registers                 
.------------------------------------------------------------
RCPLST00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      RCPLH000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          CALL      SRCHTP00
RCPLST10  CALL      SRCHNX00
          BRANCH    OVRCD,RCPLST99
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      RCPLST10
          ENDIF
.
          CALL      RCPRW000      * Display Receipt Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      RCPLST10 IF NOT EQUAL
.
RCPLST99  RETURN
.------------------------------------------------------------
. Receipt Enquiry (TABLE HEADING)
.------------------------------------------------------------
RCPLH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=9%>":
                             "Receipt Number</td>":
                             "<td class=HeadingCell width=9%>":
                             "Receipt Date</td>":
                             "<td class=HeadingCell width=8%>":
                             "Date Created</td>":
                             "<td class=HeadingCell width=8%>":
                             "Time Created</td>":
                             "<td class=HeadingCell width=8%>":
                             "User ID</td>":
                             "<td class=HeadingCell width=10%>":
                             "Cash Drawer</td>":
                             "<td class=HeadingCell width=9%>":
                             "U/R or Debtor Number</td>":
                             "<td class=HeadingCell width=20%>":
                             "Name</td>":
                             "<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell align=right width=9%>":
                             "Amount</td>":
                             "</tr>"
.
RCPLH999  RETURN
.------------------------------------------------------------
. Receipt Enquiry (TABLE ROW)
.------------------------------------------------------------
RCPRW000  
..          UNPACK    RCBNTDAT,CCENT,CYEAR,CMON,CDAY
..          PACK      DIM10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          MOVE      RCBNTDAT,CHNGDATE
          CALL      GETDAT00
          MOVE      DISPDATE,DISPDTE1
.
          MOVE      RCBNCDAT,CHNGDATE
          CALL      GETDAT00
          MOVE      DISPDATE,DISPDTE2
.
          MOVE      "    1",DIM5
          PACK      KEY17,RCBNRECN,DIM5,SP70
          CALL      RDRCDTE1
          COMPARE   ZERO,OVRCD
          GOTO      RCPRW100 IF EQUAL
.
          CALL      RKRCDTE1
          BRANCH    OVRCD,RCPRW120
          MATCH     RCBNRECN,RCDTRECN
          GOTO      RCPRW120 IF NOT EQUAL      
.
RCPRW100  PACK      KEY3,RCDTREGI
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      ZERO,REGIBACD
          ENDIF
          GOTO      RCPRW140 
.
RCPRW120  MOVE      ZERO,REGIBACD
          MOVE      SP70,RCDTURNO
          MOVE      SP70,RCDTNAME
          MOVE      SP70,RCDTRELD
. 
RCPRW140  MOVE      RCBNSTAT,F1
          MOVE      NOTBANKD,STATUS
          LOAD      STATUS,F1,CANCELLD,BANKED
.
          MOVE      SP70,FORMATNM
          PACK      KEY6,RCBNCDRW,SP70
          CALL      RDCIDA1
          IF        OVRCD=0       
            MOVE      SP70,PTITL
            MOVE      RCPGIVEN,PGNAME  
            MOVE      RCPSUR,PSNAME
            PACK      PTMASNAM,RCPSUR,SP70
            CALL      PATNAA00
            MOVE      PATFNAME,FORMATNM
          ELSE
            MOVE      "Unknown",FORMATNM
          ENDIF
.
          CALL      PNAM0000              * Get patient name
          MATCH     NBSP,PATFNAME
          IF        @EQUAL
            MOVE      "Unknown",PATFNAME
          ENDIF
.
          MOVE      SP70,ANS
          MATCH     SP70,RCDTRELD         * Check if it has been released
          IF        @EQUAL
            MOVE      "*",ANS             * Un-released
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:linkReceipt":
                             "(#"",RCBNRECN,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             RCBNRECN,"</td>":
                             "<td>",DISPDTE1,"</td>":
                             "<td>",DISPDTE2,"</td>":
                             "<td>",RCBNCTIM,"</td>":
                             "<td>",RCBNCUID,"</td>":
                             "<td>",FORMATNM,"</td>":
                             "<td>",RCDTURNO,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>&nbsp;",STATUS,"</td>":
                             "<td align=right>",RCBNTOTP,ANS,"</td>":
                             "</tr>"
.
RCPRW999  RETURN
.------------------------------------------------------------------------------
. Determine search Type         
.------------------------------------------------------------------------------
SRCHTP00  MOVE      ZERO,SRCHTYPE
          MOVE      SP70,OLDRECPT
          MATCH     SP70,INVNUMBR
          GOTO      SRCHTP10 IF EQUAL
          GOTO      SRCHTP10 IF EOS  
.
          MOVE      ONE,SRCHTYPE           * Search for Invoice Number
          MOVE      INVNUMBR,FORM12
          MOVE      FORM12,INVNUMBR
          IF        SCANFLAG=ZERO
            REP       " 0",INVNUMBR
          ENDIF
          PACK      KEY29,INVNUMBR,SP70
          CALL      RSRCDTE3
          GOTO      SRCHTP99
.
SRCHTP10  MATCH     URNUMBER,SP70
          GOTO      SRCHTP20 IF EQUAL
          GOTO      SRCHTP20 IF EOS
.
          MOVE      TWO,SRCHTYPE           * Search for U/R or Debtor Number
          PACK      KEY25,URNUMBER,SP70
          CALL      RSRCDTE5
          GOTO      SRCHTP99
.
SRCHTP20  MATCH     CHEQUENO,SP70
          GOTO      SRCHTP30 IF EQUAL
          GOTO      SRCHTP30 IF EOS
.
          MOVE      THREE,SRCHTYPE          * Search for Cheque Number
          PACK      KEY27,CHEQUENO,SP70
          CALL      RSRCBDT3
          GOTO      SRCHTP99
.
SRCHTP30  COMPARE   ONE,DEPSONLY
          GOTO      SRCHTP40 IF NOT EQUAL
.
          MOVE      FOUR,SRCHTYPE          * Search Deposit Only
          PACK      KEY26,RCPTDATE,SP70
          CALL      RSRCBNK2
          GOTO      SRCHTP99
.
SRCHTP40  MATCH     RCPTDATE,SP70
          GOTO      SRCHTP99 IF EQUAL
          GOTO      SRCHTP99 IF EOS
.
          MOVE      FIVE,SRCHTYPE          * Search for Receipt Date 
          PACK      KEY26,RCPTDATE,SP70
          CALL      RSRCBNK2
          GOTO      SRCHTP99
.
SRCHTP99  RETURN
.------------------------------------------------------------------------------
. Read next search record       
.------------------------------------------------------------------------------
SRCHNX00  BRANCH    SRCHTYPE,SRCHNX10,SRCHNX20,SRCHNX30,SRCHNX40,SRCHNX50
          GOTO      SRCHNX98
.
.         Read Search by Invoice Number
.
SRCHNX10  CALL      RKRCDTE3
          BRANCH    OVRCD,SRCHNX99
.
          MATCH     RCDTINVN,INVNUMBR
          GOTO      SRCHNX98 IF NOT EQUAL
.
          MATCH     OLDRECPT,RCDTRECN
          GOTO      SRCHNX10 IF EQUAL
.
          MATCH     RCPTDATE,SP70
          IF        !@EQUAL
            MATCH     RCDTTDAT,RCPTDATE
            GOTO      SRCHNX10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,SRCHNX10
.
          IF        MINMAMNT>0
            IF        RCBNTOTP<MINMAMNT
              GOTO      SRCHNX10
            ENDIF
          ENDIF
          MOVE      RCBNRECN,OLDRECPT
          GOTO      SRCHNX99
.
.         Read Search by U/R or Debtor Number
.
SRCHNX20  CALL      RKRCDTE5
          BRANCH    OVRCD,SRCHNX99
.
          MATCH     RCDTURNO,URNUMBER
          GOTO      SRCHNX98 IF NOT EQUAL
.
          MATCH     OLDRECPT,RCDTRECN
          GOTO      SRCHNX20 IF EQUAL
.
          MATCH     RCPTDATE,SP70
          IF        !@EQUAL
            MATCH     RCDTTDAT,RCPTDATE
            GOTO      SRCHNX20 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,SRCHNX20
.
          IF        MINMAMNT>0
            IF        RCBNTOTP<MINMAMNT
              GOTO      SRCHNX20
            ENDIF
          ENDIF
          MOVE      RCBNRECN,OLDRECPT
          GOTO      SRCHNX99
.
.         Read Search by Cheque Number
.
SRCHNX30  CALL      RKRCBDT3
          BRANCH    OVRCD,SRCHNX99
.
          MATCH     CHEQUENO,RCBDCHQN
          GOTO      SRCHNX98 IF NOT EQUAL
.
          MATCH     OLDRECPT,RCBDRECN
          GOTO      SRCHNX30 IF EQUAL
.
          MATCH     RCPTDATE,SP70
          IF        !@EQUAL
            MATCH     RCBDTDAT,RCPTDATE
            GOTO      SRCHNX30 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,RCBDRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,SRCHNX30
.
          IF        MINMAMNT>0
            IF        RCBNTOTP<MINMAMNT
              GOTO      SRCHNX30
            ENDIF
          ENDIF
          MOVE      RCBNRECN,OLDRECPT
          GOTO      SRCHNX99
.
.         Read Search by Deposit only
.
SRCHNX40  CALL      RKRCBNK2
          BRANCH    OVRCD,SRCHNX99
.
          MATCH     RCPTDATE,RCBNTDAT
          GOTO      SRCHNX98 IF NOT EQUAL
.
          MATCH     OLDRECPT,RCBNRECN
          GOTO      SRCHNX40 IF EQUAL
.
          IF        MINMAMNT>0
            IF        RCBNTOTP<MINMAMNT
              GOTO      SRCHNX40
            ENDIF
          ENDIF
.
          PACK      KEY17,RCBNRECN,SP70
          CALL      RSRCDTE1
SRCHNX42  CALL      RKRCDTE1
          BRANCH    OVRCD,SRCHNX40
          MATCH     RCDTRECN,RCBNRECN
          GOTO      SRCHNX40 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,RCDTMHOS
            IF        !@EQUAL
              MATCH     WBSEHOSP,RCDTMHOS
              GOTO      SRCHNX42 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY3,RCDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,SRCHNX42
          COMPARE   "90",REGIBACD
          GOTO      SRCHNX44 IF EQUAL       * EMR Deposits
          COMPARE   "91",REGIBACD
          GOTO      SRCHNX44 IF EQUAL       * OUT Deposits
          COMPARE   "96",REGIBACD
          GOTO      SRCHNX44 IF EQUAL       * PP Deposits
          COMPARE   "97",REGIBACD
          GOTO      SRCHNX42 IF NOT EQUAL   * Not Inp deposits
.
SRCHNX44  MOVE      RCBNRECN,OLDRECPT
          GOTO      SRCHNX99
.
.
.         Read Search by Receipt Date
.
SRCHNX50  CALL      RKRCBNK2
          BRANCH    OVRCD,SRCHNX99
.
          MATCH     RCPTDATE,RCBNTDAT
          GOTO      SRCHNX98 IF NOT EQUAL
.
          IF        MINMAMNT>0
            IF        RCBNTOTP<MINMAMNT
              GOTO      SRCHNX50
            ENDIF
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          GOTO      SRCHNX99 IF NOT EQUAL
.
          PACK      KEY17,RCBNRECN,SP70
          CALL      RSRCDTE1
SRCHNX52  CALL      RKRCDTE1
          BRANCH    OVRCD,SRCHNX50
.
          MATCH     RCDTRECN,RCBNRECN
          GOTO      SRCHNX50 IF NOT EQUAL
.
          MATCH     SP70,RCDTMHOS
          IF        !@EQUAL
            MATCH     WBSEHOSP,RCDTMHOS
            GOTO      SRCHNX52 IF NOT EQUAL
          ENDIF
.
          GOTO      SRCHNX99
.
SRCHNX98  MOVE      ONE,OVRCD
SRCHNX99  RETURN
.------------------------------------------------------------------------------
. Display Invoice Items Table
.------------------------------------------------------------------------------
INVITM00  COMPARE   ONE,HSYS6
          GOTO      INVITM99 IF NOT EQUAL
.
          MATCH     SP70,RECEIPTN
          GOTO      INVITM99 IF EQUAL
          GOTO      INVITM99 IF EOS
          MATCH     SP70,TRANSCNT
          GOTO      INVITM99 IF EQUAL
          GOTO      INVITM99 IF EOS
.
          PACK      KEY32,RECEIPTN,TRANSCNT,SP70
          CALL      RSRCDBP1
          CALL      RKRCDBP1
          BRANCH    OVRCD,INVITM99
.
          MATCH     RCDBRECN,RECEIPTN
          GOTO      INVITM99 IF NOT EQUAL
          MATCH     RCDBTCNT,TRANSCNT
          GOTO      INVITM99 IF NOT EQUAL
.
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTAMTPD
.
          PACK      KEY21,ONE,RCDBINVN,SP70
          CALL      RSDBFH6
          CALL      RKDBFH6
          BRANCH    OVRCD,INVITM99
.
          MATCH     "1",DBFHDTY
          GOTO      INVITM99 IF NOT EQUAL
          MATCH     RCDBINVN,DBFHDOC
          GOTO      INVITM99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td align=center colspan=2>":
                             "<b>Invoice Number: ",RCDBINVN,"</b></td></tr>":
                             "<tr><td colspan=2>":
                             "<table align=center cellspacing=0 ":
                             "cellpadding=1 border=1 width=100%>":
                             "<tr><td class=HeadingCell>Sales Item</td>":
                             "<td class=HeadingCell>Date</td>":
                             "<td class=HeadingCell align=right>Quantity</td>":
                             "<td class=HeadingCell align=right>":
                             "Item Amount</td>":
                             "<td class=HeadingCell align=right>Payment</td>":
                             "</tr>";
.
          PACK      KEY36,DBFHDEB,DBFHDOC,SP70
          CALL      RSDBFD6
INVITM10  CALL      RKDBFD6
          BRANCH    OVRCD,INVITM90
.
          MATCH     DBFHDEB,DBFDDEB
          GOTO      INVITM90 IF NOT EQUAL   * Not same debtor
          MATCH     DBFDDOC,DBFHDOC
          GOTO      INVITM90 IF NOT EQUAL   * Not same invoice
.
          MOVE      DBFDILN,SVINVLNE
          CALL      INVTOT00                * Calculate outstanding item amt
          ADD       OUTSTAMT,TOTAMT
.
          PACK      KEY8,DBFDITM
          CALL      RDDBIT1        * Read Sales Item Details
          IF        OVRCD=1
            MOVE      "UNKNOWN",DBITIDE
          ENDIF
.
          UNPACK    DBFDIDAT,CCENT,CYEAR,CMON,CDAY
          PACK      KEY10,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
.
          PACK      KEY32,RECEIPTN,TRANSCNT,DBFDINV,DBFDILN,SP70
          CALL      RDRCDBP1
          IF        OVRCD=1       
            MOVE      ZERO,RCDBPAMT
          ENDIF
          ADD       RCDBPAMT,TOTAMTPD
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;",DBITIDE:
                             "</td>":
                             "<td>&nbsp;",KEY10,"</td>":
                             "<td align=right>&nbsp;",DBFDQTY,"</td>":
                             "<td align=right>&nbsp;$",PINVAMT,"</td>":
                             "<td align=right>&nbsp;$",RCDBPAMT,"</td>":
                             "<tr>";
          GOTO      INVITM10
.
INVITM90  WRITE     HTMLFILE;"<tr><td colspan=4 align=right>":
                             "<b>Total&nbsp;</b></td>":
                             "<td align=right><b>&nbsp;$",TOTAMTPD:
                             "</td>":
                             "</tr>";
          WRITE     HTMLFILE;"</table></td></tr>";
.
INVITM99  RETURN
+
.------------------------------------------------------------------------------
. Calculate individual invoice item's outstanding amount.
.------------------------------------------------------------------------------
INVTOT00  MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
          MOVE      ZERO,OUTSTAMT
.
.         Save current invoice record
.
          PACK      SAVEKEY,DBFDDEB,DBFDINV,DBFDILN,DBFDDTY,DBFDDOC,DBFDDLN
.
.         Read Invoice item total, amount paid and adjustments
.
          PACK      KEY39,DBFHDEB,DBFHDOC,SVINVLNE,SP70
          CALL      RSDBFD7
INVTOT10  CALL      RKDBFD7
          BRANCH    OVRCD,INVTOT90
.
          MATCH     DBFHDEB,DBFDDEB
          GOTO      INVTOT90 IF NOT EQUAL
          MATCH     DBFHDOC,DBFDINV
          GOTO      INVTOT90 IF NOT EQUAL
          MATCH     SVINVLNE,DBFDILN
          GOTO      INVTOT90 IF NOT EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,INVTOT21,INVTOT22,INVTOT22,INVTOT24,INVTOT25
          GOTO      INVTOT10
.
INVTOT21  ADD       DBFDTOT,PINVAMT     * invoice amount
          ADD       DBFDTAX,PINVAMT     * Tax amount
          GOTO      INVTOT10
.
INVTOT22  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      INVTOT10
.
INVTOT24  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      INVTOT10
.
INVTOT25  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      INVTOT10
.
INVTOT90  MOVE      PINVAMT,OUTSTAMT   * Total Outstanding
          ADD       TOTPAID,OUTSTAMT
          ADD       PINVJOUR,OUTSTAMT
.
.         Re-read current invoice item
.
          MOVE      SAVEKEY,KEY39
          CALL      RDDBFD7
          BRANCH    OVRCD,INVITM99
.
INVTOT99  RETURN
.
.------------------------------------------------------------
. Patient Level Deposit List
.------------------------------------------------------------
PATDEP00  CALL      DEPHED00              * Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD   * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
.         * Previous button
.
          IF        PRVDFLAG = 1
            MATCH     SP70,PREVDKEY
            IF        !@EQUAL
              CALL      GPRDEP00            * Get previous records key
              MOVE      ZERO,STARTNUM       * Reset counters to zero
              MOVE      ZERO,RECNUMB
              MOVE      ZERO,DISNUMB
              MOVE      SP70,PREVDKEY
              GOTO      PATDEP05
            ENDIF
.
            IF        REVRECPT=0
              PACK      KEY25,URNUMBER,SP70   * Go back to start if at
            ELSE
              PACK      KEY25,URNUMBER,Z70
            ENDIF
.            
            MOVE      ZERO,STARTNUM         * the end of the list
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            GOTO      PATDEP05
          ENDIF
.
.         * Next button
.
          MATCH     SP70,NEXTDKEY
          IF        !@EQUAL
            CALL      GNXDEP00              * Check to see if at the last rec
            BRANCH    OVRCD,PATDEP99
.
            IF        REVRECPT=0
              PACK      KEY25,NEXTDKEY,SP70
            ELSE
              PACK      KEY25,NEXTDKEY,Z70
            ENDIF
.
            MOVE      ZERO,STARTNUM         * Reset counters
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            MOVE      SP70,NEXTDKEY
            GOTO      PATDEP05
          ENDIF
.           * Check the order of listing
          IF        REVRECPT=0
            PACK      KEY25,URNUMBER,SP70
          ELSE
            PACK      KEY25,URNUMBER,Z70
          ENDIF
.
.         PACK      KEY25,URNUMBER,SP70
PATDEP05  CALL      RSRCDTE5
PATDEP10  IF        REVRECPT=0
            CALL      RKRCDTE5
          ELSE
            CALL      RPRCDTE5
          ENDIF
          BRANCH    OVRCD,PATDEP99
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      PATDEP99 IF NOT EQUAL
.
          PACK      KEY3,RCDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,PATDEP10
.
          COMPARE   "90",REGIBACD        * EMR Deposits
          GOTO      PATDEP20 IF EQUAL
.
          COMPARE   "91",REGIBACD        * OUT Deposits
          GOTO      PATDEP20 IF EQUAL
.
          COMPARE   "96",REGIBACD        * PRI Deposits
          GOTO      PATDEP20 IF EQUAL
.
          COMPARE   "97",REGIBACD        * IP Deposits
          GOTO      PATDEP20 IF EQUAL
          GOTO      PATDEP10
.
PATDEP20  PACK      NEXTDKEY,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          MATCH     SP70,PREVDKEY
          IF        @EQUAL
            PACK      PREVDKEY,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PATDEP10
          ENDIF
.
          CALL      DEPROW00
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PATDEP10 IF NOT EQUAL
          GOTO      PATDEP99
.
PATDEP99  RETURN
+
.--------------------------------------------------------------------------
. GPRDEP00 - Read back one full page of records to get the
.            previous record listv start key.
.------------------------------------------------------------
GPRDEP00  PACK      SAVKEY25,SP70
          MOVE      ZERO,F2
          ADD       ONE,NORECORD
.
          IF        REVRECPT=0
            PACK      KEY25,PREVDKEY,Z70
          ELSE
            PACK      KEY25,PREVDKEY,SP70
          ENDIF
.
          CALL      RSRCDTE5                     * Position for batch #
GPRDEP10  IF        REVRECPT=0
            CALL      RPRCDTE5                   * read next record
          ELSE
            CALL      RKRCDTE5
          ENDIF
          BRANCH    OVRCD,GPRDEP91               * end of file
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      GPRDEP91 IF NOT EQUAL
.
          PACK      KEY3,RCDTREGI
          CALL      RDREGA1
          BRANCH    OVRCD,GPRDEP10
.
          COMPARE   "90",REGIBACD        * EMR Deposits
          GOTO      GPRDEP20 IF EQUAL
          COMPARE   "91",REGIBACD        * OUT Deposits
          GOTO      GPRDEP20 IF EQUAL
          COMPARE   "96",REGIBACD        * PRI Deposits
          GOTO      GPRDEP20 IF EQUAL
          COMPARE   "97",REGIBACD        * IP Deposits
          GOTO      GPRDEP20 IF EQUAL
          GOTO      GPRDEP10
.
GPRDEP20  PACK      SAVKEY25,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          ADD       ONE,F2
          COMPARE   F2,NORECORD
          GOTO      GPRDEP90 IF EQUAL
.
          GOTO      GPRDEP10
.
GPRDEP90  MOVE      SAVKEY25,KEY25          * New start key for display
          SUB       ONE,NORECORD
          GOTO      GPRDEP99
.
GPRDEP91  IF        REVRECPT=0
            PACK      KEY25,URNUMBER,SP70
          ELSE
            PACK      KEY25,URNUMBER,Z70
          ENDIF
          SUB       ONE,NORECORD
          GOTO      GPRDEP99
.
GPRDEP99  RETURN
+
.------------------------------------------------------------
. GNXDEP00 - Check to see if this is the last record displayed.
.------------------------------------------------------------
GNXDEP00  IF        REVRECPT=0
            PACK      KEY25,NEXTDKEY,SP70
          ELSE
            PACK      KEY25,NEXTDKEY,Z70
          ENDIF
. 
         CALL      RSRCDTE5                     * Position for batch #
. 
         IF        REVRECPT=0
            CALL      RKRCDTE5                   * read next record
          ELSE
            CALL      RPRCDTE5
          ENDIF
.
          BRANCH    OVRCD,GNXDEP90               * end of file
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      GNXDEP90 IF NOT EQUAL
.
          GOTO      GNXDEP99
.
GNXDEP90  IF        REVRECPT=0
            PACK      NEXTDKEY,URNUMBER,SP70
          ELSE
            PACK      NEXTDKEY,URNUMBER,Z70
          ENDIF
          MOVE      ONE,OVRCD
          GOTO      GNXDEP99                * No more record goto first record
.
GNXDEP99  RETURN
.------------------------------------------------------------
.  Table Selected Finance Letter (TABLE HEADING)
.------------------------------------------------------------
DEPHED00  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                             "<td><b> Receipt No.</b></td>":
                             "<td><b> Receipt Date</b></td>":
                             "<td><b> Register</b></td>":
                             "<td><b> Visit Number</b></td>":
                             "<td><b> Deposit Type</b></td>":
                             "<td><b> Medical Practice</b></td>":
                             "<td><b> Status</b></td>":
                             "<td width=75 align=right><b>Amount</b></td>":
                             "</tr>"
.
DEPHED99  RETURN
.------------------------------------------------------------
.         Dislay row of deposit
.------------------------------------------------------------
DEPROW00  UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MATCH     SP10,RCDTVIST
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTVIST
          ENDIF
.
          MATCH     SP10,RCDTPRAC
          IF        @EQUAL
            MOVE      "&nbsp;",RCDTPRAC
          ENDIF
.
          MOVE      "Unreleased     ",DIM30
          MATCH     SP70,RCDTRELD
          IF        !@EQUAL
            MOVE      "Released       ",DIM30
          ENDIF
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      RDCMDEP1
          BRANCH    OVRCD,DEPROW10
.
          MATCH     "2",CMDESTAT         * Deposit refunded?
          GOTO      DEPROW10 IF NOT EQUAL
.
          MATCH     SP70,CMDERRFN
          GOTO      DEPROW10 IF EQUAL
.
          PACK      KEY5,ANSD,ANSR,CMDERRFN,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      DIM30,REFUNDED,CMDERRFN
          ELSE
            PACK      DIM30,REFDASH,TDESC,SP70
          ENDIF
.
DEPROW10  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1             * read receipting bank header file
          BRANCH    OVRCD,DEPROW40
.
          MATCH     "1",RCBNSTAT         * cancelled receipt?
          IF        @EQUAL
            MOVE      "Cancelled",DIM30
          ENDIF
.
DEPROW40  MOVE      "&nbsp;",TDESC
          MATCH     SP70,RCDTDPTY
            IF        !@EQUAL
            PACK      KEY5,ANSD,ANSP,RCDTDPTY,SP10
            CALL      RDCODE1
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkReceipt(#"":
                             RCDTURNO,"#",#"",RCDTVIST,"#",#"":
                             RCDTRECN,"#")'>":
                             RCDTRECN,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",REGDESC,"</td>":
                             "<td>",RCDTVIST,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td>",RCDTPRAC,"</td>":
                             "<td>",DIM30;
.
          MATCH     "Released",DIM30
          IF        @EQUAL
            MATCH     SP70,RCDTINVN
            IF        @EQUAL
              WRITE   HTMLFILE;"<input type=button class=button value=Transfer":
                             " onclick='TransferDeposit(#"",RCDTRECN:
                             "#",#"",RCDTTCNT:
                             "#",#"",RCDTURNO:
                             "#",#"",ADMISSNO:
                             "#");'></td>";
              GOTO    DEPROW80
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
DEPROW80  WRITE     HTMLFILE;"<td align=right>",RCDTAMNT,"</td></tr>"
.
DEPROW99  RETURN
.-----------------------------------------------------------
. Link to Next Group of patients
.-----------------------------------------------------------
NXTDEP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",NEXTDKEY
          REP       " +",NEXTTKEY
.
          WRITE     HTMLFILE;"rcpweb01.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&revrecpt=",REVRECPT:
                                 "&norecord=",KEY2;
.
          IF        F1=1
            WRITE     HTMLFILE;"&nexttkey=",NEXTTKEY;
          ELSE
            WRITE     HTMLFILE;"&nextdkey=",NEXTDKEY;
          ENDIF
.
          WRITE     HTMLFILE;"&admissno=",ADMISSNO:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",NEXTDKEY
          REP       "+ ",NEXTTKEY
.
NXTDEP99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of patients
.-------------------------------------------------------------
PRVDEP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          REP       " +",PREVTKEY
          REP       " +",PREVDKEY
.
          WRITE     HTMLFILE;"rcpweb01.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&revrecpt=",REVRECPT: 
                                 "&prvdflag=",ONE;
.
          IF        F1=1
            WRITE     HTMLFILE;"&prevtkey=",PREVTKEY;
          ELSE
            WRITE     HTMLFILE;"&prevdkey=",PREVDKEY;
          ENDIF
.
          WRITE     HTMLFILE;"&admissno=",ADMISSNO:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       "+ ",PREVDKEY
          REP       "+ ",PREVTKEY
.
PRVDEP99  RETURN
.
.------------------------------------------------------------
. Patient Level Receipt List
.------------------------------------------------------------
PATRCP00  CALL      RCPHED00              * Table Heading
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          MOVE      SP70,OLDRECPT
.
.         * Previous button
.
          IF        PRVDFLAG = 1
            MATCH     SP70,PREVDKEY
            IF        !@EQUAL
              CALL      GPRRCP00            * Get previous records key
              MOVE      ZERO,STARTNUM       * Reset counters to zero
              MOVE      ZERO,RECNUMB
              MOVE      ZERO,DISNUMB
              MOVE      SP70,PREVDKEY
              GOTO      PATRCP05
            ENDIF
            PACK      KEY25,URNUMBER,SP70   * Go back to start if at
            MOVE      ZERO,STARTNUM         * the end of the list
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            GOTO      PATRCP05
          ENDIF
.
.         * Next button
.
          MATCH     SP70,NEXTDKEY
          IF        !@EQUAL
            CALL      GNXRCP00              * Check to see if at the last rec
            PACK      KEY25,NEXTDKEY,SP70
            MOVE      ZERO,STARTNUM         * Reset counters
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            MOVE      SP70,NEXTDKEY
            GOTO      PATRCP05
          ENDIF
.
          PACK      KEY25,URNUMBER,Z70
PATRCP05  CALL      RSRCDTE5
PATRCP10  CALL      RPRCDTE5
          BRANCH    OVRCD,PATRCP99
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      PATRCP99 IF NOT EQUAL
.
          MATCH     OLDRECPT,RCDTRECN
          GOTO      PATRCP10 IF EQUAL
.
          PACK      NEXTDKEY,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          MATCH     SP70,PREVDKEY
          IF        @EQUAL
            PACK      PREVDKEY,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PATRCP10
          ENDIF
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,PATRCP10
.
          CALL      RCPROW00
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PATRCP10 IF NOT EQUAL
          GOTO      PATRCP99
.
PATRCP99  RETURN
+
.--------------------------------------------------------------------------
. GPRRCP00 - Read back one full page of records to get the
.            previous record listv start key.
.------------------------------------------------------------
GPRRCP00  PACK      SAVKEY25,SP70
          MOVE      ZERO,F2
          ADD       ONE,NORECORD
.
          PACK      KEY25,PREVDKEY,Z70
          CALL      RSRCDTE5                     * Position for batch #
GPRRCP10  CALL      RPRCDTE5                     * read next record
          BRANCH    OVRCD,GPRRCP91               * end of file
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      GPRRCP91 IF NOT EQUAL
.
          PACK      SAVKEY25,RCDTURNO,RCDTRECN,RCDTTCNT,SP70
          ADD       ONE,F2
          COMPARE   F2,NORECORD
          GOTO      GPRRCP90 IF EQUAL
.
          GOTO      GPRRCP10
.
GPRRCP90  MOVE      SAVKEY25,KEY25          * New start key for display
          SUB       ONE,NORECORD
          GOTO      GPRRCP99
.
GPRRCP91  PACK      KEY25,URNUMBER,SP70
          SUB       ONE,NORECORD
          GOTO      GPRRCP99
.
GPRRCP99  RETURN
+
.------------------------------------------------------------
. GNXRCP00 - Check to see if this is the last record displayed.
.            If so the next button will go back to the start.
.------------------------------------------------------------
GNXRCP00  PACK      KEY25,NEXTDKEY,SP70
          CALL      RSRCDTE5                     * Position for batch #
          CALL      RKRCDTE5                     * read next record
          BRANCH    OVRCD,GNXRCP90               * end of file
.
          MATCH     URNUMBER,RCDTURNO
          GOTO      GNXRCP90 IF NOT EQUAL
.
          GOTO      GNXRCP99
.
GNXRCP90  PACK      NEXTDKEY,URNUMBER,SP70
          GOTO      GNXRCP99                * No more record goto first record
.
GNXRCP99  RETURN
+
.------------------------------------------------------------
.  Header for receipt list
.------------------------------------------------------------
RCPHED00  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                             "<td><b> Receipt No.</b></td>":
                             "<td><b> Receipt Date</b></td>":
                             "<td><b> Date/Time Created</b></td>":
                             "<td><b> User ID</b></td>":
                             "<td><b> Cash Drawer</b></td>":
                             "<td><b> Payer</b></td>":
                             "<td><b> Status</b></td>":
                             "<td align=right><b>Amount</b></td>":
                             "<td align=right><b>Surcharge</b></td>":
                             "<td align=right><b>Total</b></td>":
                             "</tr>"
.
RCPHED99  RETURN
+
.------------------------------------------------------------
. Receipt List (TABLE ROW)
.------------------------------------------------------------
RCPROW00  MOVE      RCBNTDAT,CHNGDATE
          CALL      GETDAT00
          MOVE      DISPDATE,DISPDTE1
.
          MOVE      RCBNCDAT,CHNGDATE
          CALL      GETDAT00
          MOVE      DISPDATE,DISPDTE2
.
          MOVE      RCBNSTAT,F1
          MOVE      NOTBANKD,STATUS
          LOAD      STATUS,F1,CANCELLD,BANKED
.
          PACK      KEY6,RCBNCDRW,SP70
          CALL      RDCIDA1
          IF        OVRCD=0
            MOVE      SP70,PTITL
            MOVE      RCPGIVEN,PGNAME
            MOVE      RCPSUR,PSNAME
            PACK      PTMASNAM,RCPSUR,SP70
            CALL      PATNAA00
            MOVE      PATFNAME,FORMATNM
          ELSE
            MOVE      "Unknown",FORMATNM
          ENDIF
.
          MOVE      SP70,ANS
          MATCH     SP70,RCDTRELD         * Check if it has been released
          IF        @EQUAL
            MOVE      "*",ANS             * Un-released
          ENDIF
.
          MOVE      ZERO,FORM12P2
          CALL      GSCR0000              * Get total surcharge for a receipt
.
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,RCPROW50
.
          MATCH     RCDTRECN,RCBDRECN     * same Receipt number?
          GOTO      RCPROW60 IF EQUAL
.
RCPROW50  MOVE       SP70,RCBDPAYD        * initialise payer
.
RCPROW60  SUB       FORM12P2,RCBNTOTP
          WRITE     HTMLFILE;"<tr>":
                             "<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkReceipt(#"":
                             RCDTURNO,"#",#"",RCDTVIST,"#",#"":
                             RCDTRECN,"#")'>":
                             RCDTRECN,"</td>":
                             "<td>",DISPDTE1,"</td>":
                             "<td>",DISPDTE2,"@",RCBNCTIM,"</td>":
                             "<td>",RCBNCUID,"</td>":
                             "<td>",FORMATNM,"</td>":
                             "<td>&nbsp;",RCBDPAYD,"</td>":
                             "<td>&nbsp;",STATUS,"</td>":
                             "<td align=right>",RCBNTOTP,ANS,"</td>":
                             "<td align=right>",FORM12P2,"</td>";
.
          ADD       FORM12P2,RCBNTOTP
          WRITE     HTMLFILE;"<td align=right>",RCBNTOTP,"</td>":
                             "</tr>"
.
RCPROW99  RETURN
+
.-------------------------------------------------------------
.         Get total surcharge for a receipt
.-------------------------------------------------------------
GSCR0000  PACK      KEY15,RCBNRECN,SP70
          CALL      RSRCCRS1
GSCR1000  CALL      RKRCCRS1
          BRANCH    OVRCD,GSCR9999
.
          MATCH     RCCRRECN,RCDTRECN
          GOTO      GSCR9999 IF NOT EQUAL
.
          ADD       RCCRSAMN,FORM12P2
          GOTO      GSCR1000
.
GSCR9999  RETURN
+
.------------------------------------------------------------
. Patient Transferred Deposit List
.------------------------------------------------------------
PTRDEP00  CALL      TRDHED00              * Table Heading
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY41,URNUMBER,SP70
PTRDEP05  CALL      RSCMAUD3
PTRDEP10  CALL      RKCMAUD3
          BRANCH    OVRCD,PTRDEP99
.
          MATCH     URNUMBER,CMAUURNO
          GOTO      PTRDEP99 IF NOT EQUAL
.
          PACK      NEXTTKEY,CMAUURNO,CMAURECN,CMAUTDAT,CMAUTTIM,CMAUTCNT,SP70
          MATCH     SP70,PREVTKEY
          IF        @EQUAL
            PACK     PREVTKEY,CMAUURNO,CMAURECN,CMAUTDAT,CMAUTTIM,CMAUTCNT,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PTRDEP10
          ENDIF
.
          CALL      TDPROW00
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PTRDEP10 IF NOT EQUAL
          GOTO      PTRDEP99
.
PTRDEP99  RETURN
+
.------------------------------------------------------------
.  Table heading for Transferred deposit
.------------------------------------------------------------
TRDHED00  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF>":
                             "<td><b> Receipt No.</b></td>":
                             "<td><b> Date Deposit Transferred</b></td>":
                             "<td><b> Time Deposit Transferred</b></td>":
                             "<td><b> Visit Type From</b></td>":
                             "<td><b> Visit Type To</b></td>":
                             "<td><b> User who Transferred Deposit</b></td>":
                             "</tr>"
.
TRDHED99  RETURN
+
.-------------------------------------------------------------
.  Display row of Transferred deposit
.-------------------------------------------------------------
TDPROW00  UNPACK    CMAUTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      ZERO,F1
          MOVE      CMAUFVTY,F1
          MOVE      PPRVTYPE,DIM16A
          LOAD      DIM16A,F1,EMRVTYPE,OUTVTYPE,INPVTYPE
.
          MOVE      ZERO,F1
          MOVE      CMAUTVTY,F1
          MOVE      PPRVTYPE,KEY16
          LOAD      KEY16,F1,EMRVTYPE,OUTVTYPE,INPVTYPE
.
          MOVE      SP30,WBSENAM
          MOVE      "Unknown ",WBSENAM
          PACK      KEY10,CMAUCUID,SP70
          CALL      RDWBSE1
.
          WRITE     HTMLFILE;"<tr>":
                             "<td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='ShowTransDeposit(#"":
                             CMAUURNO,"#",#"",CMAURECN,"#",#"":
                             CMAUTDAT,"#",#"",CMAUTTIM,"#",#"":
                             CMAUTCNT,"#")'>":
                             CMAURECN,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",CMAUTTIM,"</td>":
                             "<td>",DIM16A,"</td>":
                             "<td>",KEY16,"</td>":
                             "<td>",WBSENAM,"</td></tr>"
.
TDPROW99  RETURN
+
.-------------------------------------------------------------
. Cancel Eclipse Claim Reciept indicator
.-------------------------------------------------------------
ECLRCP00  PACK      KEY17,RCBNRECN,SP70
          CALL      RSRCDTE1
          CALL      RKRCDTE1
          BRANCH    OVRCD,ECLRCP90
.
          MATCH     RCBNRECN,RCDTRECN
          GOTO      ECLRCP90 IF NOT EQUAL
.
          MATCH     SP70,RCDTBATN
          GOTO      ECLRCP90 IF EQUAL
          GOTO      ECLRCP90 IF EOS
.
          GOTO      ECLRCP80
.
ECLRCP80  WRITE     HTMLFILE;ONE;
          GOTO      ECLRCP99
.
ECLRCP90  WRITE     HTMLFILE;ZERO;
          GOTO      ECLRCP99
.
ECLRCP99  RETURN
.
.ECLRCP00  UNPACK    DIM127,D1,DIM1,DIM127
.          MOVE      DIM1,FORM1
..
.          PACK      KEY17,RCBNRECN,SP70
.          CALL      RSRCDTE1
.          CALL      RKRCDTE1
.          BRANCH    OVRCD,ECLRCP90
..
.          MATCH     RCBNRECN,RCDTRECN
.          GOTO      ECLRCP90 IF NOT EQUAL
..
.          PACK      DIM3,RCBNRCOD,SP70
.          PACK      DIM20,RCDTINVN,SP70
.          LJUSTIFY  DIM20
..
.          PACK      KEY61,DIM3,SP70
.          CALL      RSPMERD1
.ECLRCP10  CALL      RKPMERD1
.          BRANCH    OVRCD,ECLRCP90
..
.          MATCH     DIM3,PMEDPART
.          GOTO      ECLRCP90 IF NOT EQUAL
..
.          MATCH     DIM20,PMEDARID
.          GOTO      ECLRCP10 IF NOT EQUAL
..
.          MOVE      SP70,DIM3
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
.          PACK      KEY40,PMEDTRID,DIM8,SP70
.          CALL      RSPMECT6
.          CALL      RKPMECT6
.          BRANCH    OVRCD,ECLRCP80
..
.          MATCH     PMEDTRID,PMECTRID
.          GOTO      ECLRCP80 IF NOT EQUAL
..
.          MATCH     DIM8,PMECINVN
.          GOTO      ECLRCP80 IF NOT EQUAL
..
.          MOVE      PMECHOSP,DIM3
..
.ECLRCP80  IF        FORM1=ONE
.            WRITE     HTMLFILE;ONE;
.          ELSE
.            IF        FORM1=TWO
.              WRITE     HTMLFILE;PMEDPART,PMEDRADV,PMEDPNUM;
.            ELSE
.              WRITE     HTMLFILE;DIM3;
.            ENDIF
.          ENDIF
..
.          GOTO      ECLRCP99
..
.ECLRCP90  IF        FORM1=ONE
.            WRITE     HTMLFILE;ZERO;
.          ELSE
.            IF        FORM1=TWO
.              WRITE     HTMLFILE;SP37;
.            ELSE
.              WRITE     HTMLFILE;SP3;
.            ENDIF
.          ENDIF
..
.ECLRCP99  RETURN
.
.-------------------------------------------------------------
. Cancel Eclipse Claim Reciept
.-------------------------------------------------------------
CNERCP00  MOVE      SP70,ECLRCINX
          MOVE      SP70,ECLRCINH
.
          PACK      KEY17,RCBNRECN,SP70
          CALL      RSRCDTE1
CNERCP10  CALL      RKRCDTE1
          BRANCH    OVRCD,CNERCP60
.
          MATCH     RCBNRECN,RCDTRECN
          GOTO      CNERCP60 IF NOT EQUAL
.
          MOVE      RCDTINVN,DIM12
          LJUSTIFY  DIM12
          MOVE      DIM12,DIM8
          RJUSTIFY  DIM8          
.
          PACK      KEY24,RCDTVIST,DIM8,RCDTBATN
          CALL      RDPMECT4
          BRANCH    OVRCD,CNERCP10
.
          MOVE      TEN4,PMECFLAG
          MOVE      SP70,PMECSTAT
          MOVE      SP70,PMECPDAT
          MOVE      ZERO,PMECAMTP
.
          CALL      UPPMECT4
.
          MOVE      PMECINVN,PMEAINVN
CNERCP40  CALL      IBACLOCK
          PACK      PMEADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMEADATE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMEATIME
          MOVE      PMECBATN,PMEABATN
          MOVE      TEN4,PMEASTAT
          MOVE      " 0",PMEATYPE
          MOVE      WBSEUID,PMEAOPER
          MOVE      PMECTRID,PMEATRID
          MOVE      SP70,PMEAEROR
          MOVE      "Receipt Cancelled. ERA is now unreleased.",PMEAEROT
          PACK      PMEAEROT,PMEAEROT,SP70
          MOVE      SP70,PMEASPAR
.
          PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
          CALL      RAPMECA1
          IF        OVRCD=0
            GOTO      CNERCP40
          ENDIF
.
          CALL      WRPMECA1
.
CNERCP50  PACK      KEY82,PMECTRID,PMECFTID,SP70
          CALL      RSPMERD2
          CALL      RKPMERD2
          BRANCH    OVRCD,CNERCP10
.
          MATCH     PMECTRID,PMEDTRID
          GOTO      CNERCP10 IF NOT EQUAL
.
          MATCH     PMECFTID,PMEDFTID
          GOTO      CNERCP10 IF NOT EQUAL
.
          MOVE      "0",PMEDSTAT
.
          CALL      UPPMERD2
.
          MOVE      PMEDFTID,ECLRCINX
          MOVE      PMECHOSP,ECLRCINH
.
          GOTO      CNERCP10
.
CNERCP60  MATCH     SP70,ECLRCINX
          GOTO      CNERCP99 IF EQUAL
.
          MOVE      "0",ECLRCIND
          PACK      KEY82,ECLRCINX,SP70
          CALL      RSPMERD1
CNERCP70  CALL      RKPMERD1
          BRANCH    OVRCD,CNERCP80
.         
          MATCH     PMEDFTID,ECLRCINX
          GOTO      CNERCP80 IF NOT EQUAL
.         
          MATCH     "0",PMEDSTAT
          IF        !@EQUAL
            MOVE      "1",ECLRCIND
            GOTO      CNERCP80
          ENDIF
.
          GOTO      CNERCP70
.
CNERCP80  PACK      KEY61,ECLRCINH,ECLRCINX,SP70
          CALL      RSPMERH1
          CALL      RKPMERH1
          IF        OVRCD=0
            MATCH     PMEHHOSP,ECLRCINH
            GOTO      CNERCP83 IF NOT EQUAL
.
            MATCH     PMEHFTID,ECLRCINX
            GOTO      CNERCP83 IF NOT EQUAL
.
            MOVE      ECLRCIND,PMEHSTAT
            CALL      UPPMERH1
          ELSE
.
.           if cant find the pmserh record
.           then update the first record that matches ECLRCINX
.
CNERCP83    PACK      KEY61,SP70
            CALL      RSPMERH1
CNERCP85    CALL      RKPMERH1
            BRANCH    OVRCD,CNERCP99
.
            MATCH     PMEHFTID,ECLRCINX
            GOTO      CNERCP85 IF NOT EQUAL
.
            MOVE      ECLRCIND,PMEHSTAT
            CALL      UPPMERH1
          ENDIF
.
CNERCP99  RETURN
.
.CNERCP00  PACK      KEY17,RCBNRECN,SP70
.          CALL      RSRCDTE1
.CNERCP10  CALL      RKRCDTE1
.          BRANCH    OVRCD,CNERCP60
..
.          MATCH     RCBNRECN,RCDTRECN
.          GOTO      CNERCP60 IF NOT EQUAL
..
.          PACK      KEY61,ECLRCINX,SP70
.          CALL      RSPMERD1
.CNERCP20  CALL      RKPMERD1
.          BRANCH    OVRCD,CNERCP10
..
.          PACK      DIM37,PMEDPART,PMEDRADV,PMEDPNUM,SP70
.          MATCH     ECLRCINX,DIM37
.          GOTO      CNERCP10 IF NOT EQUAL
..
.          MOVE      RCDTINVN,DIM20
.          LJUSTIFY  DIM20
.          MATCH     DIM20,PMEDARID
.          GOTO      CNERCP20 IF NOT EQUAL
..
.          MOVE      "0",PMEDSTAT
..
.          CALL      UPPMERD1                     * Update pmserdaf to received
..
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
.          PACK      KEY40,PMEDTRID,DIM8,SP70
.          CALL      RSPMECT6
.          CALL      RKPMECT6
.          BRANCH    OVRCD,CNERCP10
..
.          MATCH     PMEDTRID,PMECTRID
.          GOTO      CNERCP10 IF NOT EQUAL
..
.          MATCH     DIM8,PMECINVN
.          GOTO      CNERCP10 IF NOT EQUAL
..
.          MATCH     RCDTVIST,PMECADMN
.          GOTO      CNERCP10 IF NOT EQUAL
..
.          MOVE      TEN4,PMECFLAG
.          MOVE      SP70,PMECSTAT
.          MOVE      SP70,PMECPDAT
.          MOVE      ZERO,PMECAMTP
..
.          CALL      UPPMECT6              * Update pmsectaf to remittance rec
..
.          MOVE      PMECINVN,PMEAINVN
.CNERCP40  CALL      IBACLOCK
.          PACK      PMEADATE,CCC,CYY,CMM,CDD
.          REP       " 0",PMEADATE
.          CLOCK     TIME,CTIMEIS
.          MOVE      CTIMEIS,PMEATIME
.          MOVE      PMECBATN,PMEABATN
.          MOVE      TEN4,PMEASTAT
.          MOVE      " 0",PMEATYPE
.          MOVE      WBSEUID,PMEAOPER
.          MOVE      PMECTRID,PMEATRID
.          MOVE      SP70,PMEAEROR
.          MOVE      "Receipt Cancelled. ERA is now unreleased.",PMEAEROT
.          PACK      PMEAEROT,PMEAEROT,SP70
.          MOVE      SP70,PMEASPAR
..
.          PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEABATN,SP70
.          CALL      RAPMECA1
.          IF        OVRCD=0
.            GOTO      CNERCP40
.          ENDIF
..
.          CALL      WRPMECA1                   * Write new pmsecaaf. ERA unrel.
..
.          GOTO      CNERCP10
..
.CNERCP60  MOVE      "0",ECLRCIND
.          PACK      KEY61,ECLRCINX,SP70
.          CALL      RSPMERD1
.CNERCP70  CALL      RKPMERD1
.          BRANCH    OVRCD,CNERCP80
..
.          PACK      DIM37,PMEDPART,PMEDRADV,PMEDPNUM,SP70
.          MATCH     DIM37,ECLRCINX
.          GOTO      CNERCP80 IF NOT EQUAL
..
.          MATCH     "0",PMEDSTAT
.          IF        !@EQUAL
.            MOVE      "1",ECLRCIND
.            GOTO      CNERCP80
.          ENDIF
..
.          GOTO      CNERCP70
..
.CNERCP80  PACK      KEY40,ECLRCINH,ECLRCINX,SP70
.          CALL      RDPMERH1
.          IF        OVRCD=0
.            MOVE      ECLRCIND,PMEHSTAT
.            CALL      UPPMERH1
.          ELSE
..
..           if cant find the pmserh record
..           then update the first record that matches ECLRCINX
..
.            PACK      KEY40,SP70
.            CALL      RSPMERH1
.CNERCP85    CALL      RKPMERH1
.            BRANCH    OVRCD,CNERCP99
..         
.            PACK      DIM37,PMEHPART,PMEHRADV,PMEHPNUM,SP70
.            MATCH     DIM37,ECLRCINX
.            GOTO      CNERCP85 IF NOT EQUAL
..
.            MOVE      ECLRCIND,PMEHSTAT
.            CALL      UPPMERH1
.          ENDIF
..
.CNERCP99  RETURN
..
.------------------------------------------------------------------------------
.      Update the un-reconciled invoice file for all invoices of the receipt
.------------------------------------------------------------------------------
URCN0000  PACK      KEY17,RECEIPTN,SP70
          CALL      RSRCDTE1
URCN1000  CALL      RKRCDTE1
          BRANCH    OVRCD,URCN9999
.
          MATCH     RECEIPTN,RCDTRECN        * same receipt number?
          GOTO      URCN9999 IF NOT EQUAL
.
.         Check all invoices for the receipt
.
          PACK      SKEY17,RCDTRECN,RCDTTCNT,SP70
          MOVE      ZERO,FORM12
          MOVE      RCDTINVN,FORM12
          IF        FORM12<>0
            CALL      CREC0000               * Check if invoice is reconciled
          ENDIF
.
          MOVE      SKEY17,KEY17             * reposition
          CALL      RDRCDTE1
          GOTO      URCN1000
.
URCN9999 RETURN
+
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after cancelling the receipt
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM8P2
          MOVE      FORM12,FORM8
          MOVE      FORM8,KEY8
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC0200
.
          COMPARE   TWO,REGIBACD
          GOTO      CREC0100 IF EQUAL      * Private Practice
.
          COMPARE   "96",REGIBACD
          GOTO      CREC0200 IF NOT EQUAL  * NOT IP Deposits
.
CREC0100  CALL      RDPRIN1                * Check for Private Practice Inv.
          BRANCH    OVRCD,CREC9999
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE
          GOTO      CREC9999
.
CREC0200  CALL      RDINV1
          BRANCH    OVRCD,CREC9999
.
          MOVE      FORM12,DIM12
          PACK      KEY29,DIM12,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     DIM12,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MATCH     PINVUR,RCDTURNO      * Same U/R number?
          GOTO      CREC1000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM8P2       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM8P2,FORM12P2      * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999

          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  OPEN      AAEDE1A1,"aaede1af"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
RECN0000  
          PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      USERID,PTURCUID       * WEB user id
              MATCH     "2",PTURSTAT
              IF        @EQUAL
                MOVE      "0",PTURSTAT        * New status
              ENDIF
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      PINVPATA,PTURPAYM    * Patient payments +
          ADD       PINVHFDA,PTURPAYM    * H.F payments +
          ADD       PINVOTHA,PTURPAYM    * Other payments +
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      USERID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      USERID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.------------------------------------------------------------------------------
. I/O and Subroutine Includes
.------------------------------------------------------------------------------
.
          INC       IBAWEBCD
          INC       DAYOFWEK
          INC       WEBDATCD
          INC       PATMASTM
          INC       RCPBNKTM
          INC       RCPBDTTM
          INC       RCPDTETM
          INC       RCPSRTTM
.
          INC       AAEDE1IO/INC
          INC       EMRVISIO/INC
          INC       EMRSITIO/INC
.
          INC       DEBITMIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       MRTMASIO/INC
          INC       PATFN1IO/INC
          INC       PATMI1IO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       NHIETHIO/INC
          INC       PATDO1IO/INC
          INC       PATGO1IO/INC
          INC       PATWR1IO/INC
          INC       PATPR1IO/INC
          INC       PATALRIO/INC
          INC       PMSECAIO/INC
          INC       PMSECTIO/INC
          INC       PMSCEXIO/INC
          INC       PMSERHIO/INC
          INC       PMSERDIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
.
          INC       PRIUPURE
          INC       COMAUDTM
          INC       NAMSTRCD
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       PATDOCTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       CALCAGE
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATDOCCD
          INC       CLPMSPX2
          INC       CLNZPEXT
.
          INC       NHIMASIO/INC
          INC       COMDEPIO/INC            * Deposit file
          INC       COMAUDIO/INC            * Deposit Audit file
          INC       IBASMAIO/INC            * Common system master file
          INC       PATHSPIO/INC            * Hospital file
          INC       PATHGPIO/INC
          INC       PATINVIO/INC            * Invoice file
          INC       PATMA1IO/INC
          INC       PMSVX1IO/INC
          INC       PATNIDIO/INC
          INC       PATRE1IO/INC
          INC       PATVISIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSPX2IO/INC
          INC       NZPEXTIO/INC
          INC       PATUREIO/INC
.
          INC       RCPCRSIO/INC      * Credit card surcharge file
          INC       RCPCMNIO/INC            * Internal Receipt Comments File
          INC       RCPBNKIO/INC            * Bank Header File
          INC       RCPBDTIO/INC            * Bank Detail File
          INC       RCPDBPIO/INC            * Receipt Detail Invoice Item paymt
          INC       RCPDTEIO/INC            * Receipt Detail File
          INC       RCPREGIO/INC            * Register Table
          INC       RCPCIDIO/INC
          INC       RCPSRTIO/INC            * Suspense Receipt Table
.
          INC       FMSLMAIO/INC
          INC       FMSDISIO/INC
          INC       FMSRESIO/INC
          INC       FMSCHQIO/INC
          INC       FMSAMAIO/INC
          INC       FMSCSAIO/INC
          INC       FMSCAFIO/INC
.
          INC       PRIUREIO/INC
          INC       PRIINVIO/INC
          INC       PRIPRAIO/INC
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PRIALSIO/INC                 * Medical Prac.all user access
          INC       PRISECIO/INC                 * Medical Prac.security access
.
          INC       DEBDBTIO/INC
          INC       DEBFTHIO/INC
          INC       DEBFDTIO/INC
.
          INC       IBAGSTIO/INC
          INC       IBATMDIO/INC            * Template Tail
          INC       PATHOSIO/INC
          INC       PATDPATH
          INC       PMIGTNID
          INC       RCPPRTCD                * Print Receipt routines
          INC       GETALTID
          INC       TFILENAM 
.
