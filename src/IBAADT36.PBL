.******************************************************************************
.* System         :  Patient Billing                                          *
.* Program        :  IBAADT36                                                 *
.* Description    :  Financial Summary Listing program                        *
.******************************************************************************
.* Date           :  31/01/1997                                               *
.* Author         :  J.Tan                                                    *
.* Function       :  Full listing of patfinsf file                            *
.* Modifications  :                                                           *
.*        V12.00.01 30/05/2025 Jacob Jackson     TSK 0955096                  *
.*                  Alphanumeric changes                                      *
.*        V11.05.02 05/03/2025  J.Tan   TSK 0955356                           *
.*                  Added SKEY40 for PATCALFN                                 *
.*        V11.05.01 21/02/2025  J.Tan   TSK 0955356                           *
.*                  Added FININVN,FINADMN,FINURNO - Financial Summary         *
.*        V11.04.01 21/12/2023  J.Tan          TSK 0940154                    *
.*                  Fixed FINCODE for Misc.to use PINVCLM (instead of ACLAIM) *
.*        V11.03.01 06/12/2022  J.Tan          TSK 0927091                    *
.*                  Fixed Casepayment daycase lumpsum                         *
.*        V11.01.02 04/10/2021  J.Tan          TSK 0911440                    *
.*                  Fixed GST Credit Note amount                              *
.*        V11.01.01 18/08/2021  J.Tan          TSK 0903454                    *
.*                  Added Claim code to Lumpsum/Daily charge for CACCFEE=4    *
.*        V11.00.01 04/03/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*        V10.15.01 06/12/2019  J.Tan          TSK 0857392                    *
.*                  Fixed ABF Invoices                                        *
.*        V10.14.01 28/06/2019  J.Tan          TSK 0857392                    *
.*                  Mod for ABF invoices                                      *
.*        V10.13.01 06/12/2013 J.Tan         TSK 0859743                      *
.*                  Mod for OTRECTYP=6 for Theatre item                       *
.*        V10.12.01 15.01.2018  J.Tan   TSK 0848146                           *
.*                  Added CACCFEE=5 - Accumulation FI by Claim code           *
.*        V10.04.01 15/06/2014 Jill Parkinson CAR 301639                      *
.*                  Moved TFILENAM to INIT0000 and extra KILL0000             *
.*        V10.03.03 18/02/2013 Ania           CAR 281021                      *
.*                  Removed redundant modification of constants.              *
.*        V10.03.02 19/12/2012 Patrick Adair  CAR 261630                      *
.*                  Removed port number from temp file name                   *
.*        V10.03.01 22/05/2012  J.Tan         CAR 263557                      *
.*                  Mods Web not to update fees invoice files                 *
.*        V10.01.01 17/12/2010  Mike Laming   CAR 233046                      *
.*                  Mods to Misc.Charges PATMCHFD - Key change, logic changes *
.*        V10.00.01 30/04/2010 J.Tan         CAR 220887                       *
.*                  Mods checking for Active/Inactive of Misc.charge          *
.*        V9.12.05  11/01/2010  J.Tan   CAR 213841                            *
.*                  Fixed printing Cash from health fund group (Eclipse)      *
.*        V9.12.02  13/10/2009  J.Tan   CAR 207195                            *
.*                  Fixed printing Cash from health fund                      *
.*        V9.12.01  18/05/2009  J.Tan   CAR 194470                            *
.*                  Mods printing Cash Sub Total                              *
.*        V9.11.04  23/04/2009  J.Tan   CAR 195282                            *
.*                  Mods for Misc.group by Claim/Group                        *
.*        V9.11.03  27/03/2009  J.Tan   CAR 189115                            *
.*                  Mods for Oracle                                           *
.*        V9.11.02  24/03/2009  J.Tan   CAR 170967                            *
.*                  Fixed I*D errors                                          *
.*        V9.11.01  16/09/2008  J.Tan   CAR 170967                            *
.*                  Fixed CACCFEE - Fees invoice accumulation                 *
.*        V9.10.01  23/04/2008  J.Tan   CAR 167215                            *
.*                  Fixed generating credit notes                             *
.*        V9.08.01  21/02/2008  J.Tan   CAR 160240                            *
.*                  Fixed for Emergency procedures dtr record                 *
.*        V9.04.05  08/10/2003  J.Tan   CAR 54081                             *
.*                  Fixed lumpsum and credit notes                            *
.*        V9.04.04  21/09/2003  J.Tan   CAR 52835                             *
.*                  Mods for Multi hospitals                                  *
.*                  Mods for credit notes                                     *
.*        V9.04.03  03/09/2003  J.Tan   CAR 52687                             *
.*                  Fixed problem with caccfee=3 - looping                    *
.*        V9.04.02  03/09/2004  Ebon Clements  CAR 53142                      *
.*                  Joined fileds PINVNO and DUNIQKEY so key has 8 parts      *
.*        V9.04.01  19/08/2004  J.Tan  CAR 52835                              *
.*                  Mods for Multi hospitals                                  *
.*        V9.03.01  16/09/2003  Lina Vo   CAR 40497                           *
.*                  Changed index and read of patmchgf to include effective   *
.*                  date.                                                     *
.*        V9.02.02  04/10/2002  J.Tan                                         *
.*                  Fixed generating GST                                      *
.*        V9.02.01  26/02/2002  J.Tan                                         *
.*                  Mods to use invoice date if effective date is blank       *
.*        V9.02.00  24/02/2002  J.Tan                                         *
.*                  Ported from r5.09                                         *
.*        V6.09.04  12/04/2002  Davin                                         *
.*                  Changed to keyin starting invoice date                    *
.*        V5.09.03  04/01/2002  Davin                                         *
.*                  Changed patfinsf update option to only write 'A' records  *
.*        V5.09.02  18/12/2001  Davin                                         *
.*                  Added option to update fees invoiced file                 *
.*        V5.09.01  01/08/2001  J.Tan                                         *
.*                  Mods FINDATE for accommodation to use Invoice Date        *
.*        V5.09.B01 29/03/2001  J Habasque                                    *
.*                  Casemix mods - removed episode type                       *
.*        V5.08.03  18/08/2000  Jill Habasque                                 *
.*                  Added patdetnt variables                                  *
.*       V5.08.02   17/05/2000  J Habasque                                    *
.*                  Fixed printing of report when no data                     *
.*       V5.07.B03  14/03/2000  J.Tan                                         *
.*                  Mods for GST                                              *
.*        V5.07.01  14/07/1999  J.Tan                                         *
.*                  Fixed the breakup of accommodation                        *
.*        V6.06.01  10/02/1999  Jill Habasque                                 *
.*                  Fixed DISPHEAD display                                    *
.*                   V6.05.02  08/12/1998  Nicole Harrington                  *
.*                             Removed CCENTRY                                *
.*                   V6.04.03  08/04/97 J.Tan                                 *
.*                             Added total only option and ignore merchantcard*
.*                   V6.05.01  27/11/98 J.Tan                                 *
.*                             Mods to display adm.number for invalid period  *
.******************************************************************************
.
          INC       STD001FD
.
          INC       AAEDTRFD/INC
          INC       AAEDE1FD/INC
          INC       IBASEQFD/INC                 * Sequential Numbers File
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       PATDRGFD/INC
          INC       PATDTRFD/INC
          INC       PATDSCFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATINVFD/INC
          INC       PATITMFD/INC
          INC       PMSFCIFD/INC
          INC       PATRFNFD/INC
          INC       NZPRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATFINFD/INC
          INC       NZPFINFD/INC
          INC       PATFIGFD/INC
          INC       NZPFIGFD/INC
          INC       PATHSPFD/INC
          INC       PATCONFD/INC
          INC       PMSCNOFD/INC
          INC       PMSVX1FD/INC
          INC       PATFN1FD/INC
          INC       RCPBNKFD/INC
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
+
SPTFINS1   IFILE SQL, FIXED=156, KEY="U1-1,2-7,8-11,12-12,13-25,146-148"
SPTFINS2   IFILE SQL, FIXED=156, KEY="U146-148,1-1,2-7,8-11,12-12,13-25"
.
SPTFIGA1   IFILE SQL, FIXED=156, KEY="U1-1,2-7,8-11,12-12,13-25,146-148"
SPTFIGA2   IFILE SQL, FIXED=156, KEY="U146-148,1-1,2-7,8-11,12-12,13-25"
.
FINDFILE FILE      ASCII, FIXED=256
PATTEMP  IFILE     SQL, FIXED=63, KEY="U1-3,4-4,5-10,11-14,15-15,16-28,29-36,37-44+45-52"
.
. ----- Tempfile consists of following vars -----
.
. Name          Type      Length     Physical     Start   Description
. ----          ----      ------     --------     -----   -----------
.FINHOSP     DIM       3          3          1      Hospital ID
.DFINSYS     DIM       1          1          4      SYSTEM INDICATOR
.                                                   1= AAE, 2=OUT, 3=INP, 4=GST
.FINSITE     DIM       6          6          5      OUTPATIENT SITE
.FINYEAR     DIM       4          4         11      FINANCIAL YEAR
.FINTYPE     DIM       1          1         15      FINANCIAL TYPE
.FINCODE     DIM       13         13        16      FINANCE CODE
.PINVDTE     DIM       8          8         29      INVOICE DATE
.PINVNO      DIM       8          8         37      INVOICE NUMBER
DUNIQKEY     DIM       8          8         45      UNIQUE KEY
.FINAMT      FORM      9.2        7         53      AMOUNT
FPERIOD      FORM      3          3         60      PERIOD
.                                           63      EOR
. ----- EOR 63 -----
.
.
PGSTTOT   FORM      1
CSTRTYR   DIM       8
CURFYEAR  DIM       4
CURRDATE  DIM       8
PATSTCUR  DIM       4

JRNLCOD  DIM    2
CASHTYP  DIM    1
CASHDESC DIM    12
CRDFLAG  FORM   1
SCRDFLAG FORM   1
SKEY13   DIM    13
SKEY40   DIM    40
SCASHDES DIM    12
SFINCODE DIM    13
SUBFIN   DIM    1
NEGONE   FORM    "-1"
NOPERIOD FORM   1
DAYFLG   FORM   1
DIM3     DIM    3
DIM4     DIM    4
DIM6     DIM    6
DIM8     DIM    8
DIM9     DIM    9
DIM13    DIM    13
DIM13A   DIM    13
DIM10    DIM    10
DIM16    DIM    16
SDIM10   DIM    10
DIM10A   DIM    10
DIM22    DIM    22
FGSTFLAG FORM   1
FIGFLAG  FORM   1
FORM3    FORM   3
FORM82   FORM   8.2
FORM12P2 FORM   12.2
IBCNUGST FORM   1
IBCNMHOS FORM   1
HOSPFLAG FORM   1
ORACFLAG FORM   1
AAE      INIT   "A&E"
OUT      INIT   "OUT"
INP      INIT   "INP"
INPAT    INIT   "Inpatient "
AAEPAT   INIT   "A&E       "
OUTPAT   INIT   "Outpatient"
ALLPAT   INIT   "All       "
INVOICE  INIT   "- Invoice "
CASH     INIT   "- Cash    "
JOURNAL  INIT   "- Journals"
ALL      INIT   "- All     "
.
DEFPATH  DIM    60
LUMPFLAG FORM   1
SJRNLCOD DIM    2
SJRNGCOD DIM    2
SCASHTYP DIM    1
SFINTYPE DIM    1
SFINHOSP DIM    3
SFINSYS  FORM   1
SFINSITE DIM    5
STINDATE DIM     8
TODATE   DIM     8
TOTONLY  FORM    1
FROMDATE DIM     8
FRYEAR   DIM     2
MSCFLAG  DIM     1
MISGRP   DIM     3
.
RECFLAG  FORM    1
RECCNT   FORM    8
UPDFLAG  FORM    1
UNIQKEY  FORM    8
FNAMEI   DIM     8
FNAMES   DIM     8
GNDTOT   FORM    9.2
.
KEY21A   DIM     21
KEY26A   DIM     26
HOSPID   DIM     3
HOSPNAME DIM       50
SAVKEY31 DIM     31
SP13     INIT    "             "
SUBOPT   FORM    1
SUBTOT   FORM    9.2
TOTCRD   FORM    9.2
.
STATUS   FORM    1
SAVAMT   FORM    12.2
TOTAMT   FORM    12.2
OPCND    FORM    1
CMDLINE  DIM     80
.
PRGID     INIT      "IBAADT36"
PRGNAM    INIT      "Financial Summary Listing"
VERSION   INIT      "V12.01.00"
+
. -----------------------------------------------------------------------------
ML0000    CALL      INIT0000                     * program initialisation
          BRANCH    EXIT,ML9999
.
ML0100    CALL      OPTN0000
          COMPARE   ZERO,OPTION
          GOTO      ML9999 IF EQUAL
.
          CALL      SOPT0000
          COMPARE   ZERO,SUBOPT
          GOTO      ML0100 IF EQUAL
.
          CALL      KDAT0000                     * keyin date range
          BRANCH    EXIT,ML0100
.
          CALL      KIND0000                     * keyin starting invoice date
          CALL      TOTL0000                     * Total only ?
.
          MOVE      ZERO,HOSPFLAG 
          MOVE      SP10,HOSPID
          IF        IBCNMHOS=1
            CALL      KHOS0000                   * Hospital id
            BRANCH    EXIT,ML0100
          ENDIF
.
ML0180    CALL      CONTQST                      * OK to continue ?
          BRANCH    CEXIT,ML0200,ML0100,ML9999   * yes,no,cancel
.
ML0200    BRANCH    OPTION,ML1000,ML1000,ML1000,ML1000
          GOTO      ML9999
.
ML1000    CALL      CRTT0000
          BRANCH    EXIT,ML9999
          CALL      INVN0000
          BRANCH    NOPERIOD,ML9999
          CALL      CRDN0000
          CALL      WFIN0000         * update patfinsf
.
          CALL      PRNT0000         * Print
          CALL      KILL0000
          GOTO      ML0100
.
ML9999    CALL      KILL0000
          CHAIN     PGM
.
. -----------------------------------------------------------------------------
.         Program initialisation
. -----------------------------------------------------------------------------
INIT0000  CALL      DISPHEAD
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          DISPLAY   *P64:24,"patfinsf";
          OPEN      PATFINS1,"patfinsf"
          OPEN      PATFINS2,"patfinsf"
.
          DISPLAY   *P64:24,"patfigaf";
          OPEN      PATFIGA1,"patfigaf"
          OPEN      PATFIGA2,"patfigaf"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
.
          DISPLAY   *P64:24,"patinvrf";
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR2,"patinvrf"
.
          DISPLAY   *P64:24,"aaedtref";
          OPEN      AAEDTRE1,"aaedtref"
          OPEN      AAEDTRE2,"aaedtref"
.
          DISPLAY   *P64:24,"aaede1af";
          OPEN      AAEDE1A1,"aaede1af"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          DISPLAY   *P64:24,"patdtraf";
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA2,"patdtraf"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
.
          DISPLAY   *P64:24,"patdrgaf";
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATDRGA2,"patdrgaf" * Open the date range file
.
          DISPLAY   *P64:24,"patitemn";
          OPEN      PATITEM1,"patitemn"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patmchgf";
          OPEN      PATMCHG1,"patmchgf"
.
          DISPLAY   *P64:24,"pmscnoaf";
          OPEN      PMSCNOA4,"pmscnoaf"
.
          DISPLAY   *P64:24,"pmsfciaf";
          OPEN      PMSFCIA1,"pmsfciaf"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          OPEN      PATFN1A1,"patfn1af"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          OPEN      RCPBNKA1,"rcpbnkaf"
.
          CALL      TFILENAM                     * Generate temporary file name
          MOVE      TFILNAME,FNAMEI
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*192,CACCFEE
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,ZERO;*85,IBCNUGST
.
INIT9999  RETURN
+
. -----------------------------------------------------------------------------
.         Keyin date range
. -----------------------------------------------------------------------------
KDAT0000  DISPLAY    *P1:13,*EF,"Starting Date : "
          MOVE       "13",CVERT
          MOVE       "17",CCOL
.
          MOVE       ZERO,UPDFLAG
          MOVE       ZERO,ORACFLAG
          CALL       PATSTRYR
          UNPACK     CSTRTYR,XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,IDAY
          MOVE       XMON,IMON
          MOVE       XCENT,ICENT
          MOVE       XYEAR,IYEAR
          CALL       KEYDTE
          PACK       FROMDATE,ICENT,IYEAR,IMON,IDAY
          REP        " 0",FROMDATE
.
          DISPLAY    *P1:15,"  Ending Date :"
          MOVE       "15",CVERT
          MOVE       "17",CCOL
KDAT2000  MOVE       CDD,IDAY
          MOVE       CMM,IMON
          MOVE       CCC,ICENT
          MOVE       CYY,IYEAR
          CALL       KEYDTE
          PACK       TODATE WITH ICENT,IYEAR,IMON,IDAY
          REP        " 0",TODATE
.
          MATCH      "IBARSH",PGM
          GOTO       KDAT7000 IF EQUAL      * Running from web
.
.         Option to copy to current file available only for Generating 
.         Invoice for Inpatient
.
          COMPARE    ONE,OPTION
          GOTO       KDAT7000 IF NOT EQUAL
          COMPARE    ONE,SUBOPT
          GOTO       KDAT7000 IF NOT EQUAL
.
KDAT5000  MOVE      SP70,ANS
          DISPLAY   *P1:20,*EL,"Do you want new figures ":
                    "written to the Fees Invoiced files? ":
                    "(",*V2LON,ANSY,*HOFF,"/",*V2LON,ANSN,*HOFF,") ";
          KEYIN     ANS;
          REP       UPPLOW,ANS
          CMATCH    ANSN,ANS
          GOTO      KDAT7000 IF EQUAL
          CMATCH    ANSY,ANS
          GOTO      KDAT5800 IF EQUAL
          BEEP
          GOTO      KDAT5000
.
KDAT5800  MOVE      ONE,UPDFLAG
          MOVE      ANSN,ANS
          KEYIN     *P1:22,*EL,"Running on ORACLE (Y/N) ? (ENTER for CISAM) ":
                    *P50:22,*DV,*RV,ANS,*P50:22,*V2LON,ANS;
          REP       "yY",ANS
          CMATCH     "Y",ANS
          GOTO       KDAT6000 IF NOT EQUAL
          MOVE       ONE,ORACFLAG
.
          KEYIN      *P1:23,*EL,*V2LON:
                     "Have you Created sptfinsf/sptfigaf file (Y/N) ? ",ANS;
          REP        "yY",ANS
          CMATCH     "Y",ANS
          GOTO       KDAT9000 IF NOT EQUAL
.
.         Check if FROMDATE and TODATE are the start and end of year
.
KDAT6000  PACK       KEY14,FROMDATE,SP70     * get financial year of FROMDATE
          CALL       RDSDRGA2
          CALL       RDKDRGA2
          BRANCH     OVRCD,KDAT8000
          MATCH      DRGFDTE,FROMDATE    * Is the date before the from date ?
          GOTO       KDAT8000 IF LESS    * Yes. Date not found in file.
          MOVE       DRGYR,CURFYEAR      * Save the financial year
.
          MOVE       "01",DRGNUM
          PACK       KEY6,DRGYR,DRGNUM,SP70  * get start date of financial year
          CALL       RDDRGA1
          BRANCH     OVRCD,KDAT8000
.
.         Start date must be equal to FROMDATE
.
          MATCH      FROMDATE,DRGFDTE
          GOTO       KDAT8000 IF NOT EQUAL   * invalid date
.
.         TODATE must be for same financial year
.
          MATCH      TODATE,DRGTDTE
          GOTO       KDAT7000 IF EQUAL
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     TODATE,KEY8
          GOTO      KDAT7000 IF EQUAL   * to Current date
          GOTO      KDAT8300 IF LESS
.
.         if the End date is not current date, then it must be end date of 
.         the financial year
.
          MOVE       "12",DRGNUM
          PACK       KEY6,DRGYR,DRGNUM,SP70  * get start date of financial year
          CALL       RDDRGA1
          BRANCH     OVRCD,KDAT8200
.
          MATCH      TODATE,DRGTDTE
          GOTO       KDAT8200 IF NOT EQUAL
.
KDAT7000  MATCH      FROMDATE,TODATE
          GOTO       KDAT9800 IF NOT LESS
.
          DISPLAY    *P1:23,*V2LON,"** End Date must be >= Start Date **",*W2;
          GOTO       KDAT2000
.
KDAT8000  DISPLAY    *P1:23,*V2LON:
                     "** FROMDATE must be for the Start of Year**",*W2;
          GOTO       KDAT0000
KDAT8200  DISPLAY    *P1:23,*V2LON:
                     "** TODATE must be the End of Year **",*W2;
          GOTO       KDAT2000
KDAT8300  DISPLAY    *P1:23,*V2LON:
                     "** TODATE must not be in the Future **",*W2;
          GOTO       KDAT2000
.
KDAT9000  MOVE       ONE,EXIT
          GOTO       KDAT9999
.
KDAT9800  MOVE       ZERO,EXIT
KDAT9999  RETURN
+
. -----------------------------------------------------------------------------
.         Keyin starting invoice date
. -----------------------------------------------------------------------------
KIND0000  DISPLAY    *P1:17,*EF,"Starting Invoice Date : "
          MOVE       "25",CCOL
          MOVE       "17",CVERT
.
          UNPACK     FROMDATE,XCENT,XYEAR,XMON,XDAY
          MOVE       XDAY,IDAY
          MOVE       XMON,IMON
          MOVE       XCENT,ICENT
          MOVE       XYEAR,IYEAR
          CALL       KEYDTE
          PACK       STINDATE,ICENT,IYEAR,IMON,IDAY
          REP        " 0",STINDATE
.
KIND9999  RETURN
+
. -----------------------------------------------------------------------------
.
TOTL0000  MOVE      ZERO,TOTONLY
          DISPLAY   *P1:20,*EL,*V2LON,"Total Only ? ",*HOFF:
                    "(",*V2LON,ANSY,*HOFF,"/",*V2LON,ANSN,*HOFF,")  ";
          KEYIN     ANS;
          REP       "yYnN",ANS
          CMATCH    "N",ANS
          GOTO      TOTL9999 IF EQUAL
          CMATCH    "Y",ANS
          GOTO      TOTL9000 IF EQUAL
          BEEP
          GOTO      TOTL0000
.
TOTL9000  MOVE      ONE,TOTONLY             * total only
TOTL9999  RETURN
+
. -----------------------------------------------------------------------------
.         Select sub-options
. -----------------------------------------------------------------------------
OPTN0000  CALL      DISPHEAD
          DISPLAY   *P1:4,*EF;
.
          DISPLAY   *P1:6,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:7,*V2LON,ONE,*HOFF," = Invoices":
                    *P1:8,*V2LON,TWO,*HOFF," = Cash":
                    *P1:9,*V2LON,THREE,*HOFF," = Journals":
                    *P1:10,*V2LON,FOUR,*HOFF," = All above":
                    *P1:12,"Select Option ? ";
.
OPTN1000  KEYIN     *P17:12,*V2LON,OPTION:
                    *P17:12,*DV,OPTION
.
          BRANCH    OPTION,OPTN9999,OPTN9999,OPTN9999,OPTN9999
          COMPARE   ZERO,OPTION
          GOTO      OPTN9999 IF EQUAL
          BEEP
          GOTO      OPTN1000
.
OPTN9999  RETURN
+
. -----------------------------------------------------------------------------
SOPT0000  DISPLAY   *P1:13,*EF:
                    *P1:13,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:14,*V2LON,ONE,*HOFF," = Inpatient":
                    *P1:15,*V2LON,TWO,*HOFF," = A&E":
                    *P1:16,*V2LON,THREE,*HOFF," = Outpatient":
                    *P1:17,*V2LON,FOUR,*HOFF," = All above":
                    *P1:18,"Select Option ? ";
.
SOPT1000  KEYIN     *P17:18,*V2LON,SUBOPT:
                    *P17:18,*DV,SUBOPT
.
          BRANCH    SUBOPT,SOPT2000,SOPT3000,SOPT4000,SOPT9999
          COMPARE   ZERO,SUBOPT
          GOTO      SOPT9999 IF EQUAL
          BEEP
          GOTO      SOPT1000
.
SOPT2000  DISPLAY   *P53:2,*V2LON," - Inpatient";
          GOTO      SOPT9999
.
SOPT3000  DISPLAY   *P53:2,*V2LON," - A&E";
          GOTO      SOPT9999
.
SOPT4000  DISPLAY   *P53:2,*V2LON," - Outpatient";
.
SOPT9999  RETURN
+
. -----------------------------------------------------------------------------
.
CRTT0000  DISPLAY   *P1:12,*EL,"Building temporary file.  Please wait...";
          CALL      INDZ0000
          DISPLAY   *P1:12,*EF;
          BRANCH    OPCND OF CRTT9000
.
          MOVE      ZERO,EXIT
          GOTO      CRTT9999
.
CRTT9000  MOVE      ONE,EXIT
.
CRTT9999  RETURN
+
. -----------------------------------------------------------------------------
.         Process invoices
. -----------------------------------------------------------------------------
INVN0000  DISPLAY    *P1:24,*EL,*P10:24,"Invoice Date :";
.
          MOVE       ZERO,NOPERIOD
          MOVE       ZERO,RECCNT
          MOVE       ZERO,UNIQKEY
          PACK       KEY16,STINDATE,SP20
          CALL       RDSINV2
.
.             Main Loop
.
INVN1000  CALL       RDKINV2
          BRANCH     OVRCD OF INVN9999
.
          ADD        ONE,RECCNT
          IF         (RECCNT%50) = 0
            DISPLAY    *P30:24,*V2LON,PINVDTE,SP1,RECCNT;
          ENDIF
.
.         Ignore cancelled invoices
.
          MATCH      ZEROVISN,PINVADM
          GOTO       INVN1000 IF EQUAL
.
          MOVE       SP70,ADATE
          MOVE       SP70,DDATE
          MOVE       ZERO,DAYFLG
          PACK       KEY8,PINVADM
          CALL       RDMISS1
          IF         OVRCD<>1 & ASTAT=3
            CALL       RDDSCH1
            MATCH      ADATE,DDATE
            IF         @EQUAL
              MOVE       ONE,DAYFLG
            ENDIF
          ENDIF
.
          MOVE       SP10,PMVXMHOS
          MOVE       PINVADM,KEY8
          CALL       RDPMVX11
          IF         IBCNMHOS=1
            MATCH      SP10,HOSPID
            IF         !@EQUAL
              MATCH      PMVXMHOS,HOSPID
              GOTO       INVN1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
.         Determine which system this invoice is for
.
          BRANCH     PINVSYS,AAEI000,OUTI000,INPI000,OUTI000
.
          DISPLAY    *P1:12,*V2LON,*B,*EL,"** ERROR: Invalid PINVSYS of ":
                     PINVSYS," for invoice ",PINVNO," **";
          GOTO       INVN1000
.
. -----------------------------------------------------------------------------
.         Process this A+E invoice
. -----------------------------------------------------------------------------
AAEI000   BRANCH     SUBOPT,INVN1000,AAEI050,INVN1000
AAEI050   DISPLAY    *P50:24,"AE ";
          MOVE       PINVADM,ATNUMB
          PACK       KEY22,ATNUMB,PINVNO,SP10
          CALL       RDSDTRE1
AAEI100   CALL       RDKDTRE1
          BRANCH     OVRCD,AAEI600
.
          MATCH      PINVNO,ATINVNO
          GOTO       AAEI600 IF NOT EQUAL
.
          MATCH      ATNUMB,PINVADM
          GOTO       AAEI600 IF NOT EQUAL
.
.
.         Only interested in invoice section
.
          BRANCH     ATRECTYP,AAEI200,AAEI300,AAEI400,AAEI300,AAEI200
          COMPARE    SIX,ATRECTYP
          GOTO       AAEI200 IF EQUAL     * ABF
.
          GOTO       AAEI100
.
.         A+E misc charge
.
AAEI200   BRANCH     OPTION,AAEI205,AAEI100,AAEI100
.   
AAEI205   COMPARE    FIVE,ATRECTYP
          GOTO       AAEI210 IF EQUAL     * Procedure
          COMPARE    SIX,ATRECTYP
          GOTO       AAEI210 IF EQUAL     * ABF
.
          MATCH      SP3,ATMISGRP
          GOTO       AAEI210 IF NOT EQUAL
.
          MOVE       ATITEMNO,TITEMNO
          CALL       GETM0000             * Get the miscellaneous group code
          MOVE       MMSCGRP,ATMISGRP
.
AAEI210   MOVE       ANSA,FINTYPE
          MOVE       ONE,FINSYS
          MOVE       SP6,FINSITE
          IF         PTCNMFEE = 1
            MOVE       DATNUMB,KEY8
            CALL       RDDETA1
            PACK       FINCODE,ANSM,ADACOMP,ATMISGRP,SP20
          ELSE
            PACK       FINCODE,ANSM,ATMISGRP,ATITEMNO,SP20
          ENDIF
          MOVE       ATPATAMT,FINAMT
.
          PACK       FINDATE,PINVDTE
.         PACK       FINDATE,ATDTEFFD,SP10
          REP        " 0",FINDATE
          CALL       CFIN0000
.
          IF         IBCNUGST=2 & ATDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       ATDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
.           PACK       FINDATE,ATDTEFFD
            REP        " 0",FINDATE
            CALL       CFIN0000
            MOVE       ANSA TO FINTYPE
          ENDIF
.
          BRANCH     NOPERIOD,INVN9999
          GOTO       AAEI100
.
.         Process this cash receipt
.
AAEI300   BRANCH     OPTION,AAEI100,AAEI310,AAEI100
.
AAEI310   
.         COMPARE    FOUR,ATPAYTYP               * Merchant card ?
.         GOTO       AAEI100 IF EQUAL            * Yes, ignore
.
          MOVE       ATRECEPT,KEY12
          CALL       RDRCBNK1
          BRANCH     OVRCD,AAEI312
.
          MOVE       ZERO,FORM1
          MOVE       RCBNTTYP,FORM1
          BRANCH     FORM1,AAEI320,AAEI330,AAEI340,AAEI320
AAEI312   PACK       FINCODE,SP20
          MOVE       "ACASH -  A/E   ",FINCODE
          GOTO       AAEI350
.
AAEI320   PACK       FINCODE,ANSB,RCBNRCOD,SP70
          GOTO       AAEI350
.
AAEI330   PACK       FINCODE,ANSI,RCBNRCOD,SP70
          GOTO       AAEI350
.
AAEI340   PACK       FINCODE,ANSC,SP70
.
AAEI350   MOVE       ANSB TO FINTYPE
          MOVE       ONE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       ATPATAMT TO FINAMT
          MULT       NEGONE,FINAMT
          PACK       FINDATE,ATDTEFFD
          REP        " 0",FINDATE
.
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          GOTO       AAEI100
.
.         Process this journal
.
AAEI400   BRANCH     OPTION,AAEI100,AAEI100,AAEI410
.  
AAEI410   MOVE       ANSC TO FINTYPE
          MOVE       ONE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       ATPATAMT TO FINAMT
          MULT       NEGONE,FINAMT
.
          PACK       FINCODE,SP20
          IF         PTCNJFEE=1
            PACK       FINCODE,PINVCLM,ATTYPE,SP20
          ELSE
            PACK       FINCODE,ATTYPE,SP20
          ENDIF
.         MOVE       "JOURNAL      ",FINCODE
          PACK       FINDATE,ATDTEFFD
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          GOTO       AAEI100
.
AAEI600   PACK       KEY22,PINVADM,PINVNO,SP70
          GOTO       INVN1000
+
. -----------------------------------------------------------------------------
.       Process this outpatient invoice
. -----------------------------------------------------------------------------
OUTI000   BRANCH     SUBOPT,INVN1000,INVN1000
          DISPLAY    *P50:24,"OP ";
.
          MOVE       "out",OSTFILE
          MOVE       PINVSITE,KEY6
          CALL       RDSITA1
.
          CLOSE      OUTDTRO1
          PACK       CFNAME,OSTFILE,FILDTRO1
          OPEN       OUTDTRO1,CFNAME
.
          MOVE       PINVADM,OTNUMB
          PACK       KEY22,OTNUMB,PINVNO,SP10
          CALL       RDSDTRO1
OUTI100   CALL       RDKDTRO1
          BRANCH     OVRCD,OUTI600
.
          MATCH      PINVNO,OTINVNO
          GOTO       OUTI600 IF NOT EQUAL
.
          MATCH      OTNUMB,PINVADM
          GOTO       OUTI600 IF NOT EQUAL
.
.         Only interested in invoice section
.
          BRANCH     OTRECTYP,OUTI200,OUTI300,OUTI400
          COMPARE    SIX,OTRECTYP
          GOTO       OUTI200 IF EQUAL           * Theatre item
          COMPARE    SEVEN,OTRECTYP
          GOTO       OUTI200 IF EQUAL           * ABF
          GOTO       OUTI100
.
.         Outpatient misc charge
.
OUTI200   BRANCH     OPTION,OUTI205,OUTI100,OUTI100
.
OUTI205   COMPARE    SEVEN,OTRECTYP
          GOTO       OUTI210 IF EQUAL     * ABF
.
          MATCH      SP3,OTMISGRP
          GOTO       OUTI210 IF NOT EQUAL
.
          MOVE       OTITEMNO,TITEMNO
          CALL       GETM0000             * Get the miscellaneous group code
          MOVE       MMSCGRP,OTMISGRP
.
OUTI210   MOVE       ANSA,FINTYPE
          MOVE       TWO,FINSYS
          MOVE       PINVSITE,FINSITE
.
          IF         PTCNMFEE = 1
            MOVE       "out",OSTFILE
            MOVE       PINVSITE,KEY6
            CALL       RDSITA1
            PACK       CFNAME,OSTFILE,FILBB1A1
            CALL       OPOTBB11
.
            MOVE       OTNUMB,KEY8
            CALL       RDBOKB1
            PACK       FINCODE,ANSM,OBACOMP,OTMISGRP,SP20
          ELSE
            PACK       FINCODE,ANSM,OTMISGRP,OTITEMNO,SP20
          ENDIF
.
          MOVE       OTPATAMT,FINAMT
          PACK       FINDATE,PINVDTE
.         PACK       FINDATE,OTDTEFFD
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & OTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       OTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
.           PACK       FINDATE,OTDTEFFD
            REP        " 0",FINDATE
            CALL       CFIN0000
            MOVE       ANSA TO FINTYPE
          ENDIF
.
          GOTO       OUTI100
.
.         Process this cash receipt
.
OUTI300   BRANCH     OPTION,OUTI100,OUTI310,OUTI100
.
OUTI310   
.         COMPARE    FOUR,OTPAYTYP               * Merchant card ?
.         GOTO       OUTI100 IF EQUAL            * Yes, ignore
.
          MOVE       OTRECEPT,KEY12
          CALL       RDRCBNK1
          BRANCH     OVRCD,OUTI312
.
          MOVE       ZERO,FORM1
          MOVE       RCBNTTYP,FORM1
          BRANCH     FORM1,OUTI320,OUTI330,OUTI340,OUTI320
OUTI312   PACK       FINCODE,SP20
          MOVE       "ACASH -  O/P ",FINCODE
          GOTO       OUTI350
.
OUTI320   PACK       FINCODE,ANSB,RCBNRCOD,SP70
          GOTO       OUTI350
.
OUTI330   PACK       FINCODE,ANSI,RCBNRCOD,SP70
          GOTO       OUTI350
.
OUTI340   PACK       FINCODE,ANSC,SP70
.
OUTI350   MOVE       ANSB TO FINTYPE
          MOVE       TWO,FINSYS
          MOVE       SP6,FINSITE
          MOVE       OTPATAMT TO FINAMT
          MULT       NEGONE,FINAMT
          PACK       FINDATE,OTDTEFFD
          REP        " 0",FINDATE
.
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          GOTO       OUTI100
.
.         Process this journal
.
OUTI400   BRANCH     OPTION,OUTI100,OUTI100,OUTI410
.
OUTI410   MOVE       ANSC TO FINTYPE
          MOVE       TWO,FINSYS
          MOVE       SP6,FINSITE
          MOVE       OTPATAMT TO FINAMT
          MULT       NEGONE,FINAMT
.
          IF         PTCNJFEE=1
            PACK       FINCODE,PINVCLM,OTTYPE,SP20
          ELSE
            PACK       FINCODE,OTTYPE,SP20
          ENDIF
.         MOVE       "JOURNAL - O/P",FINCODE
          PACK       FINDATE,OTDTEFFD
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & OTDTGSTM<>0
            MOVE       ANSH,FINTYPE
            MOVE       OTDTGSTM,FINAMT
            MULT       NEGONE,FINAMT
            PACK       FINDATE,OTDTEFFD
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
.
          GOTO       OUTI100
.
OUTI600   PACK       KEY22,PINVADM,PINVNO,SP70
          GOTO       INVN1000
.
. -----------------------------------------------------------------------------
.         Process this inpatient invoice
. -----------------------------------------------------------------------------
INPI000   BRANCH     SUBOPT,INPI050,INVN1000,INVN1000
.
INPI050   DISPLAY    *P50:24,"IP ";
          PACK       KEY22,PINVADM,PINVNO,SP6
          CALL       RDSDTRN1
INPI100   CALL       RDKDTRN1
          BRANCH     OVRCD,INPI800
.
          MATCH      PINVNO,TREF
          GOTO       INPI800 IF NOT EQUAL
.
.         Only interested in invoice section
.
          BRANCH     TRECTYPE,INPI200,INPI300,INPI300,INPI100,INPI500,INPI600
          COMPARE    NINE,TRECTYPE
          GOTO       INPI200 IF EQUAL       * ABF
.
          GOTO       INPI100
.
.         Inpatient accommodation
.
INPI200   BRANCH     OPTION,INPI210,INPI100,INPI100
.
INPI210   MOVE       ANSA TO FINTYPE
          MOVE       THREE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       TPATAMTT TO FINAMT
          UNPACK     PINVDTE WITH CCENT,CYEAR,CMON,CDAY
.         SUB        TPATAMTG FROM FINAMT
.
          COMPARE    ONE,PTINCMIX
          GOTO       INPI220 IF NOT EQUAL
.
.         Casepayment pre-surgical day (ie. per diem prior casemix charge) will
.         be grouped as Accommodation charge rather than Daily charge
.
          IF         PTDTDTYP=0
            IF        (PTDTLSPT<>0 | PTDTLSRB<>0)
              GOTO       INPI216
            ENDIF
            GOTO       INPI220
          ENDIF
.
          MATCH      SP3,TCLMTYP
          IF         @EQUAL
            MOVE       PINVCLM,TCLMTYP
          ENDIF
          IF         CACCFEE=5
            PACK       FINCODE,ANSD,TCLMTYP,SP20
          ELSE
            IF         CACCFEE=4
              PACK       FINCODE,ANSD,TDWARD,TCLMTYP,SP20
            ELSE
              PACK       FINCODE,ANSD,TDWARD,SP20
            ENDIF
          ENDIF
.         PACK       FINDATE,PTDTEFFD 
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
            MOVE       ANSA TO FINTYPE
          ENDIF
.
INPI216   MATCH      SP3,TADMTYP
          GOTO       INPI218 IF NOT EQUAL
.
          MOVE       TADMNO,KEY8
          CALL       RDMISS1
          MOVE       ATYPE,TADMTYP
.
INPI218   MOVE       PTDTLSPT,FINAMT
          ADD        PTDTLSRB,FINAMT
.
          MATCH      SP3,TCLMTYP
          IF         @EQUAL
            MOVE       PINVCLM,TCLMTYP
          ENDIF
          IF         CACCFEE=5
            PACK       FINCODE,ANSC,DAYFLG,TCLMTYP,SP20
          ELSE
            IF         CACCFEE=4
             PACK       FINCODE,ANSC,DAYFLG,TADMTYP,TCLMTYP,SP20
            ELSE
              PACK       FINCODE,ANSC,DAYFLG,TADMTYP,SP20
            ENDIF
          ENDIF
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & PTDTGSTL<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTL,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
            MOVE       ANSA TO FINTYPE
          ENDIF
          GOTO       INPI100
.
INPI220   BRANCH     CACCFEE,INPI240:
                             INPI250,INPI240,INPI240,INPI222
.
.         Accommodation by admission type
.
          MATCH      SP3,TADMTYP
          GOTO       INPI221 IF NOT EQUAL
.
          MOVE       TADMNO,KEY8
          CALL       RDMISS1
          MOVE       ATYPE,TADMTYP
.
INPI221   PACK       FINCODE WITH ANSA,TADMTYP,SP20
          GOTO       INPI230
.
.         Accommodation by claim type
.
INPI222   MATCH      SP3,TCLMTYP
          GOTO       INPI223 IF NOT EQUAL
.
          MOVE       PINVCLM,TCLMTYP
.
INPI223   PACK       FINCODE WITH ANSA,TCLMTYP,SP20
.
INPI230
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         Accommodation by ward/claim type
.
INPI240   MATCH      SP3,TCLMTYP
          GOTO       INPI250 IF NOT EQUAL
.
          MOVE       PINVCLM,TCLMTYP
.
INPI250   MATCH      SP3,TDWARD
          GOTO       INPI260 IF NOT EQUAL
.
          MOVE       "(",ANS
          SCAN       ANS,TDDESC
          GOTO       INPI255 IF NOT EQUAL
.
          BUMP       TDDESC
          MOVE       TDDESC,TDWARD
          GOTO       INPI260
.
INPI255   RESET      TDDESC,19
          MOVE       TDDESC,TDWARD
.
INPI260   BRANCH     CACCFEE,INPI261,INPI262,INPI265,INPI280,INPI100
          GOTO       INPI100
.
.         1 - Ward/claim type
.
INPI261   PACK       FINCODE,ANSA,TDWARD,TCLMTYP,SP20
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         2 - Ward/Adm type
.
INPI262   MATCH      SP3,TADMTYP
          IF         @EQUAL
            MOVE       TADMNO,KEY8
            CALL       RDMISS1
            MOVE       ATYPE,TADMTYP
          ENDIF
.
          PACK       FINCODE,ANSA,TDWARD,TADMTYP,SP20
.
.         PACK       FINCODE,ANSA,TDWARD,TADMTYP,ZERO,SP20
.         MOVE       TADMNO,KEY8
.         CALL       RDMISS1
.         BRANCH     OVRCD,INPI264
.         IF         ASTAT=3
.           CALL       RDDSCH1
.           BRANCH     OVRCD,INPI264
.           MATCH      ADATE,DDATE
.           IF         @EQUAL
.             PACK       FINCODE,ANSA,TDWARD,TADMTYP,ONE,SP20
.           ENDIF
.         ENDIF
.
INPI264   
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         3 - Ward/Claim/Adm.type
.
INPI265   MATCH      SP3,TADMTYP
          GOTO       INPI272 IF NOT EQUAL
.
          MOVE       TADMNO,KEY8
          CALL       RDMISS1
          BRANCH     OVRCD,INPI272
          MOVE       ATYPE,TADMTYP
.
INPI272   PACK       FINCODE,ANSA,TDWARD,TCLMTYP,TADMTYP,SP20
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         4 - Ward/adm type/claim type
.
INPI280   MATCH      SP3,TADMTYP
          GOTO       INPI282 IF NOT EQUAL
.
          MOVE       TADMNO,KEY8
          CALL       RDMISS1
          BRANCH     OVRCD,INPI282
          MOVE       ATYPE,TADMTYP
.
INPI282   PACK       FINCODE,ANSA,TDWARD,TADMTYP,TCLMTYP,SP20
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         Inpatient misc item
.
INPI300   BRANCH     OPTION,INPI310,INPI100,INPI100
.
INPI310   MOVE       ANSA TO FINTYPE
          MATCH      SP3,TMISGRP
          GOTO       INPI320 IF NOT EQUAL
.
          CALL       GETM0000
          MOVE       MMSCGRP,TMISGRP
.
INPI320   MOVE       TADMNO,KEY8
          CALL       RDMISS1
.
          IF         PTINCMIX=1
            PACK       DIM1,DAYFLG,SP10
            IF         PTCNMFEE = 1
              PACK       FINCODE WITH ANST,DIM1,PINVCLM,TMISGRP,SP20
            ELSE
              PACK       FINCODE WITH ANST,DIM1,TMISGRP,TITEMNO,SP20
            ENDIF
          ELSE
            IF         PTCNMFEE = 1
              PACK       FINCODE WITH ANSM,PINVCLM,TMISGRP,SP20
            ELSE
              PACK       FINCODE WITH ANSM,TMISGRP,TITEMNO,SP20
            ENDIF
          ENDIF
.
          MOVE       THREE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       TPATAMTT TO FINAMT
.         PACK       FINDATE,PTDTEFFD
          PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSG,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
.         Cash
.
INPI500   BRANCH     OPTION,INPI100,INPI505,INPI100
.
INPI505   
.         COMPARE    FOUR,TPAYTYPE           * merchant card ?
.         GOTO       INPI100 IF EQUAL        * yes, ignore
.
          MOVE       TRECEIPT,KEY12
          CALL       RDRCBNK1
          BRANCH     OVRCD,INPI510
.
          MOVE       ZERO,FORM1
          MOVE       RCBNTTYP,FORM1
          BRANCH     FORM1,INPI520,INPI530,INPI540,INPI520
INPI510   PACK       FINCODE,ANSA,SP20
          GOTO       INPI550
.
INPI520   PACK       FINCODE,ANSB,RCBNRCOD,SP20
          GOTO       INPI550
.
INPI530   PACK       FINCODE,ANSI,RCBNRCOD,SP20
          GOTO       INPI550
.
INPI540   PACK       FINCODE,ANSC,SP70
.
INPI550   MOVE       ANSB,FINTYPE
          MOVE       THREE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       TPATAMTT TO FINAMT
          MULT       NEGONE,FINAMT
          PACK       FINDATE,PTDTEFFD
.         PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
.
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
          GOTO       INPI100
.
.         Process this journal
.
INPI600   BRANCH     OPTION,INPI100,INPI100,INPI610
.
INPI610   MOVE       ANSC TO FINTYPE
          MOVE       THREE,FINSYS
          MOVE       SP6,FINSITE
          MOVE       TPATAMTT TO FINAMT
          MULT       NEGONE,FINAMT
.
          PACK       FINCODE,TTYPE,SP20
          COMPARE    ONE,PTCNJFEE
          GOTO       INPI620 IF NOT EQUAL
          PACK       FINCODE,PINVCLM,TTYPE,SP20
.
INPI620   PACK       FINDATE,PTDTEFFD
.         PACK       FINDATE,PINVDTE
          REP        " 0",FINDATE
          CALL       CFIN0000
          BRANCH     NOPERIOD,INVN9999
.
          IF         IBCNUGST=2 & PTDTGSTM<>0
            MOVE       ANSH,FINTYPE
            MOVE       PTDTGSTM,FINAMT
            MULT       NEGONE,FINAMT
            PACK       FINDATE,PTDTEFFD
.           PACK       FINDATE,PINVDTE
            REP        " 0",FINDATE
            CALL       CFIN0000
          ENDIF
          GOTO       INPI100
.
INPI800   PACK       KEY22,PINVADM,PINVNO,SP70
          GOTO       INVN1000
.
INVN9999  RETURN
+
.----------------------------------------------------------------
.         Check credit notes 
.----------------------------------------------------------------
CRDN0000  PACK       KEY18,FROMDATE,SP70
          MOVE       ZERO,TOTCRD
.
          CALL       RSPMCNO4
CRDN1000  CALL       RKPMCNO4
          BRANCH     OVRCD,CRDN9999
.
          MATCH      PMCNDATE,TODATE
          GOTO       CRDN9999 IF LESS
.
          MOVE       ZERO,FORM2
          MOVE       PMCNSYST,FORM2
          BRANCH     SUBOPT,CRDN2000,CRDN3000,CRDN4000
          GOTO       CRDN6000
.
CRDN2000  COMPARE    THREE,FORM2
          GOTO       CRDN1000 IF NOT EQUAL
          GOTO       CRDN6000
.
CRDN3000  COMPARE    ONE,FORM2
          GOTO       CRDN1000 IF NOT EQUAL
          GOTO       CRDN6000
.
CRDN4000  COMPARE    TWO,FORM2
          GOTO       CRDN1000 IF NOT EQUAL
.
CRDN6000  MOVE       PMCNINVN,KEY8
          CALL       RDINV1
          BRANCH     OVRCD,CRDN1000
.
          MOVE       SP10,PMVXMHOS
          MOVE       PINVADM,KEY8
          CALL       RDPMVX11
          IF         IBCNMHOS=1
            MATCH      SP10,HOSPID
            IF         !@EQUAL
              MATCH      PMVXMHOS,HOSPID
              GOTO       CRDN1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE       ZERO,SUBTOT
          MOVE       ZERO,LUMPFLAG
          PACK       KEY22,PMCNVISN,PMCNINVN,SP70
          PACK       KEY30,KEY22,SP70
          CALL       RSPMFCI1
CRDN8000  CALL       RKPMFCI1
          BRANCH     OVRCD,CRDN8900
          PACK       DIM22,PMFCVISN,PMFCINVN,SP70
          MATCH      KEY22,DIM22
          GOTO       CRDN8900 IF NOT EQUAL
          MATCH      PMCNCRNO,PMFCCRNO
          GOTO       CRDN8000 IF NOT EQUAL
.
          CALL       UPFIN000             * Update patfinsf
          GOTO       CRDN8000
.
CRDN8900  MULT      "-1",SUBTOT
          IF        SUBTOT<>PMCNAMNT
            MOVE      PMCNAMNT,FORM12P2
            SUB       SUBTOT,FORM12P2
            ADD       FORM12P2,TOTCRD
            PRINT     *1," **** CREDIT NOTE ",PMCNCRNO,"(",PMCNVISN,")":
                      " PMSFCIAF ",SUBTOT:
                      " PMSCNOAF ",PMCNAMNT:
                      " = ",FORM12P2," TOTAL ",TOTCRD:
                      " CONTACT IBA"
          ENDIF
          GOTO      CRDN1000
.
CRDN9999  RETURN
+
.----------------------------------------------------------------
.         Update patfinsf (financial file)
.----------------------------------------------------------------
UPFIN000  MOVE      PMFCCRDA,FINDATE
          REP       " 0",FINDATE
          MOVE      "F",FINTYPE             * for credit note
.
          MOVE      "0",KEY1
          MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      "1",KEY1              * daycase
          ENDIF
.
.        update the summary financial file
.
          MOVE      PMFCRTYP,FORM1
          BRANCH    FORM1,UPFIN020,UPFIN500,UPFIN500,UPFIN999:
                          UPFIN999,UPFIN999,UPFIN999,UPFIN500:
                          UPFIN780
          GOTO      UPFIN999
.
.         Accommodation
.
UPFIN020  COMPARE   ONE,PTINCMIX
          GOTO      UPFIN200 IF NOT EQUAL  * Not C/P
.
          MATCH     "1",PTINCRST
          GOTO      UPFIN100 IF NOT EQUAL  * Not fully creditted
.
          MOVE      PMFCPTLS,FORM82
          ADD       PMFCRBLS,FORM82
.
          COMPARE   ZERO,FORM82
          GOTO      UPFIN100 IF EQUAL      * no lumpsum amount
.
          BRANCH    LUMPFLAG,UPFIN1000     * Lumpsum already been done
          MOVE      ONE,LUMPFLAG
          IF        CACCFEE=5
            PACK      FINCODE,ANSH,KEY1,PMFCCTYP,SP70
          ELSE
            IF        CACCFEE=4
              PACK      FINCODE,ANSH,KEY1,PMFCATYP,PMFCCTYP,SP70
            ELSE
              PACK      FINCODE,ANSH,KEY1,PMFCATYP,SP70
            ENDIF
          ENDIF
          MOVE      FORM82,FINAMT
          MULT      "-1",FINAMT
          ADD       FINAMT,SUBTOT
.
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      "F",FINTYPE            * for lumpsum accommodation
          CALL      CFIN0000
.
          IF        IBCNUGST=2 & PMFCGSTL<>0
            MOVE      PMFCGSTL,FINAMT
            MULT      "-1",FINAMT
            ADD       FINAMT,SUBTOT
            MOVE      "Y",FINTYPE          * for lumpsum accommodation
            MOVE      PMFCCRDA,FINDATE
            REP       " 0",FINDATE
            CALL      CFIN0000
          ENDIF
.
UPFIN100  IF          CACCFEE=5
            PACK      FINCODE,ANSJ,PMFCCTYP,SP70  * daily charge
          ELSE
            IF        CACCFEE=4
              PACK      FINCODE,ANSJ,PMFCWARD,PMFCCTYP,SP70  * daily charge
            ELSE
              PACK      FINCODE,ANSJ,PMFCWARD,SP70  * daily charge
            ENDIF
          ENDIF
          GOTO      UPFIN400
.
.         Store Fincode with subfix of G non CP, so that it appears before
.         C/P  credit notes
.
UPFIN200  MOVE      "G",ANS                * not C/P casemix credit note
          BRANCH    CACCFEE OF UPFIN210,UPFIN220,UPFIN230,UPFIN240,UPFIN242
.
.         Use Admission type as financial code
.
          PACK      FINCODE WITH ANS,PMFCATYP,SP70
          GOTO      UPFIN400
.
.         Use ward and claim type as financial code
.
UPFIN210  PACK      FINCODE WITH ANS,PMFCWARD,PMFCCTYP,SP70
          GOTO      UPFIN400
.
.         Use ward and admission type
.
UPFIN220  PACK      FINCODE,ANS,PMFCWARD,PMFCATYP,SP70
          GOTO      UPFIN400
.
.         Use ward,claim and admission type
.
UPFIN230  PACK      FINCODE,ANS,PMFCWARD,PMFCCTYP,PMFCATYP,SP70
          GOTO      UPFIN400
.
.         Use ward and claim type as financial code
.
UPFIN240  PACK      FINCODE,ANS,PMFCWARD,PMFCATYP,PMFCCTYP,SP70
          GOTO      UPFIN400
.
.         Use Claim type as financial code
.
UPFIN242  PACK      FINCODE WITH ANS,PMFCCTYP,SP70
          GOTO      UPFIN400
.
.         the amount from the financial summary file
.
UPFIN400  MOVE      PMFCCAMT,FINAMT
          MULT      "-1",FINAMT
          ADD       FINAMT,SUBTOT
          MOVE      PMFCCRDA,FINDATE
          REP       " 0",FINDATE
.
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      "F",FINTYPE              * Credit note
          CALL      CFIN0000
.
          IF        IBCNUGST=2 & PMFCCGST<>0
            MOVE      PMFCCGST,FINAMT
            MULT      "-1",FINAMT
            ADD       FINAMT,SUBTOT
            MOVE      "Y",FINTYPE            * GST Credit note
            MOVE      PMFCCRDA,FINDATE
            REP       " 0",FINDATE
            CALL      CFIN0000
          ENDIF
          GOTO      UPFIN9999
.
.        - Miscellaneous or Theatre record
.
UPFIN500  COMPARE   ONE,PTINCMIX
          GOTO      UPFIN700 IF NOT EQUAL
.
          IF        PTCNMFEE=1
            PACK      FINCODE,ANSP,KEY1,PMFCCTYP,PMFCMGRP,SP20
.                             Misc. Charge, Episode, Claim Code, Item Code
          ELSE
            PACK      FINCODE,ANSP,KEY1,PMFCMGRP,PMFCITEM,SP20
.                             Misc. Charge, Episode, Group Code, Item Code
          ENDIF
          GOTO      UPFIN800
.
UPFIN700  IF        PTCNMFEE=1
            PACK      FINCODE,ANSQ,PMFCCTYP,PMFCMGRP,SP20
.                             Misc. Charge, Claim Code, Item Code
          ELSE
            PACK      FINCODE,ANSQ,PMFCMGRP,PMFCITEM,SP20
.                             Misc. Charge, Group Code, Item Code
          ENDIF
          GOTO      UPFIN800
.
UPFIN780  PACK      FINCODE,ANSM,PMFCCTYP,SP70     * ABF
.
UPFIN800  MOVE      PMFCCAMT,FINAMT
          MULT      "-1",FINAMT
          ADD       FINAMT,SUBTOT
          MOVE      PINVSYS,FINSYS
          MOVE      PINVSITE,FINSITE
          MOVE      "F",FINTYPE              * Credit note
          MOVE      PMFCCRDA,FINDATE
          REP       " 0",FINDATE
          CALL      CFIN0000
.
          IF        IBCNUGST=2 & PMFCCGST<>0
            MOVE      PMFCCGST,FINAMT
            MULT      "-1",FINAMT
            ADD       FINAMT,SUBTOT
            MOVE      "Y",FINTYPE            * GST Credit note
            MOVE      PMFCCRDA,FINDATE
            REP       " 0",FINDATE
            CALL      CFIN0000
          ENDIF
.
UPFIN999  RETURN
+
.*******************************************************************************
.*        PRNT0000 - Print records from tempfile                               *
.*******************************************************************************
PRNT0000  MOVE       "60",CLNO
          MOVE       ZERO,SFINSYS
          MOVE       SP10,SFINSITE
          MOVE       ZERO,SUBTOT
          MOVE       ZERO,GNDTOT
          MOVE       ZERO,RECFLAG
          MOVE       ZERO,DAYFLG
          MOVE       SP20,CASHDESC
          MOVE       SP20,SCASHDES
          MOVE       SP70,SFINCODE
          MOVE       SP1,MSCFLAG   
          MOVE       SP10,SFINTYPE
          MOVE       SP10,SFINHOSP
          PACK       DIM13,SP20
          MOVE       SP20,DIM13A
          MOVE       SP10,DIM10
          MOVE       SP10,SDIM10
          MOVE       SP10,SUBFIN
          MOVE       ZERO,PGSTTOT
          MOVE       ZERO,CRDFLAG
          MOVE       ZERO,SCRDFLAG
          MOVE       SP10,JRNLCOD
          MOVE       SP10,SJRNLCOD
          MOVE       SP70,SKEY13
          PACK       KEY52,SP70
          CALL       RDSTEMP
PRNT1000  CALL       RDKTEMP
          BRANCH     OVRCD,PRNT9000
.
.         Fincode with subfix of G for Non CP credit notes
.
          MOVE       ZERO,CRDFLAG
          MATCH      "F",FINTYPE
          GOTO       PRNT1002 IF EQUAL
          MATCH      "Y",FINTYPE
          GOTO       PRNT1004 IF NOT EQUAL
.
PRNT1002  REP        "FAYG",FINTYPE        * Credit notes for Accm and GST
          MOVE       ONE,CRDFLAG
          MOVE       SP10,ANS
          UNPACK     FINCODE,ANS,KEY12
          MATCH      "G",ANS
          IF         @EQUAL
            MOVE       "N",ANS               * non C/P Acc.
            PACK       FINCODE,ANS,KEY12
          ENDIF
.
.         COMPARE    "60",CLNO
.         GOTO       PRNT1500 IF EQUAL
.
.
PRNT1004  COMPARE    ONE,HOSPFLAG
          GOTO       PRNT1010 IF NOT EQUAL
.
          MATCH      SP10,SFINHOSP
          GOTO       PRNT1010 IF EQUAL
          MATCH      FINHOSP,SFINHOSP
          IF         !@EQUAL
            CALL       PSUB0000
            CALL       PTOT0000
            GOTO       PRNT1500
          ENDIF
.
PRNT1010  MATCH      SP70,SFINTYPE
          GOTO       PRNT1015 IF EQUAL
.
          MATCH      FINTYPE,SFINTYPE
          IF         !@EQUAL
            CALL       PSUB0000
            CALL       PTOT0000
            GOTO       PRNT1500
          ENDIF
.
PRNT1015  MATCH      "A",FINTYPE
          GOTO       PRNT1020 IF EQUAL     * Fees
.
          MATCH      "B",FINTYPE
          GOTO       PRNT1300 IF EQUAL     * cash
.
          MATCH      "C",FINTYPE
          GOTO       PRNT1400 IF EQUAL     * Journal
.
          MATCH      "G",FINTYPE
          GOTO       PRNT1420 IF EQUAL     * GST 
.
          MATCH      "H",FINTYPE
          GOTO       PRNT1440 IF EQUAL     * GST Journal
.
          GOTO       PRNT8000
.
PRNT1020  
.         MOVE       ZERO,CRDFLAG
          MOVE       SP10,JRNLCOD
          MOVE       SP10,SJRNLCOD
          CMATCH     "A",FINCODE
          GOTO       PRNT1200 IF EQUAL     * Accommodation
          CMATCH     "C",FINCODE
          GOTO       PRNT1200 IF EQUAL     * casemix Accommodation
          CMATCH     "D",FINCODE
          GOTO       PRNT1200 IF EQUAL     * casemix Accommodation
.
          CMATCH     "H",FINCODE
          GOTO       PRNT1190 IF EQUAL     * Lumpsum credit note accm.
          CMATCH     "J",FINCODE
          GOTO       PRNT1190 IF EQUAL     * Daily charge credit note accm.
          CMATCH     "N",FINCODE
          GOTO       PRNT1190 IF EQUAL     * Credit note Accm.
.
.         Item
.
PRNT1100  MOVE       SP1,DIM1
          UNPACK     FINCODE,ANS
.
          MATCH      "P",ANS
          GOTO       PRNT1110 IF EQUAL     * Credit Item C/P
          MATCH      "T",ANS
          GOTO       PRNT1130 IF NOT EQUAL * Not Item C/P
          GOTO       PRNT1120
.
.         Casepayment
.
PRNT1110  
.         MOVE       ONE,CRDFLAG
.
PRNT1120  IF         PTCNMFEE=1
            UNPACK     FINCODE,ANS,DIM1,DIM3,MISGRP  * episode/clm/misc.grp
            PACK       DIM10,DIM1,DIM3,MISGRP,SP10
          ELSE
            UNPACK     FINCODE,ANS,DIM1,MISGRP,DIM9  * episode/misc.grp/itm
            PACK       DIM10,DIM1,MISGRP,SP10
            MATCH      SP3,MISGRP
            IF         @EQUAL
              PACK       DIM10,DIM1,DIM9,SP10
            ENDIF
          ENDIF
          GOTO      PRNT1150
.
.         Non Casepayment
.
PRNT1130  IF         PTCNMFEE=1
            UNPACK     FINCODE,ANS,DIM3,MISGRP       * claim/misc.group
            PACK       DIM10,DIM1,DIM3,MISGRP,SP10
          ELSE
            UNPACK     FINCODE,ANS,MISGRP,DIM9       * misc.group/item code
            PACK       DIM10,DIM1,MISGRP,SP10
            MATCH      SP3,MISGRP
            IF         @EQUAL
              PACK       DIM10,DIM1,DIM9,SP10
            ENDIF
          ENDIF
.
PRNT1150  MATCH      DIM10,SDIM10
          GOTO       PRNT1450 IF NOT EQUAL
.
          MATCH      MSCFLAG,ANS
          GOTO       PRNT1500 IF EQUAL
          GOTO       PRNT1450
.
.         Accommodation
.
PRNT1190  
.         MOVE       ONE,CRDFLAG            * flag for credit note
          MATCH      FINCODE,DIM13
          GOTO       PRNT1500 IF EQUAL
.
          CALL       PSUB0000               * print sub total
          COMPARE    CRDFLAG,SCRDFLAG
          GOTO       PRNT1500 IF EQUAL
.
          CALL       PTOT0000
          MOVE       CRDFLAG,SCRDFLAG
          GOTO       PRNT1500
.
.         Accommodation
.
PRNT1200  MATCH      FINCODE,DIM13
          GOTO       PRNT1500 IF EQUAL
          GOTO       PRNT1450
.
.         Cash
.
PRNT1300  MOVE       SP10,JRNLCOD
          MOVE       SP10,SJRNLCOD
          MOVE       ZERO,CRDFLAG
          UNPACK     FINCODE,CASHTYP,CASHDESC
          IF         FINSYS=3
            MATCH      ANSA,CASHTYP
            IF         @EQUAL
              MOVE      "PATIENT     ",CASHDESC
            ELSE
              MATCH     ANSB,CASHTYP
              IF        @EQUAL
                MOVE      "HEALTH FUND ",CASHDESC
              ELSE
                MOVE      "INSURANCE   ",CASHDESC
              ENDIF
            ENDIF
          ELSE
            MOVE      "CASH/NON-INP",CASHDESC
          ENDIF
.
.         MATCH      CASHDESC,SCASHDES
          MATCH      FINCODE,SFINCODE
          GOTO       PRNT1500 IF EQUAL
          GOTO       PRNT1450
.
.         Journals
.
PRNT1400  UNPACK     FINCODE,JRNLCOD
          MATCH      JRNLCOD,SJRNLCOD
          GOTO       PRNT1500 IF EQUAL
          GOTO       PRNT1450
.
.         GST
.
PRNT1420  MOVE       SP10,JRNLCOD
          MOVE       SP10,SJRNLCOD
          MATCH      FINCODE,DIM13A
          GOTO       PRNT1500 IF EQUAL
          CALL       PSUB0000               * print sub total
.
          COMPARE    CRDFLAG,SCRDFLAG
          GOTO       PRNT1500 IF EQUAL
.
          CALL       PTOT0000
          MOVE       CRDFLAG,SCRDFLAG
          GOTO       PRNT1500
.
.         GST Journal
.
PRNT1440  UNPACK     FINCODE,JRNLCOD
          MATCH      JRNLCOD,SJRNGCOD
          GOTO       PRNT1500 IF EQUAL
          GOTO       PRNT1450
.
PRNT1450  CALL       PSUB0000               * print sub total
          COMPARE    CRDFLAG,SCRDFLAG
          GOTO       PRNT1500 IF EQUAL
.
          CALL       PTOT0000
          MOVE       CRDFLAG,SCRDFLAG
.
.         Print the record
.
PRNT1500  COMPARE    ZERO,FINAMT
          GOTO       PRNT8000 IF EQUAL
.
          COMPARE    "59",CLNO
          CALL       HEAD0000 IF NOT LESS
.
          MOVE       ZEROVISN,PINVADM
          PACK       KEY8,PINVNO
          CALL       RDINV1
.
          BRANCH     TOTONLY,PRNT2000
          IF         OVRCD = 1
            PRINT      *1,FINSYS,*10,FINSITE,*20,FINYEAR,*25,FINTYPE:
                       *30,FINCODE,*47,PINVDTE,*62,PINVNO:
                       *82,"********",*95,FINAMT
          ELSE
            PRINT      *1,FINSYS,*10,FINSITE,*20,FINYEAR,*25,FINTYPE:
                       *30,FINCODE,*47,PINVDTE,*62,PINVNO,*82,PINVADM,*95,FINAMT
          ENDIF
          ADD        ONE,CLNO
.
PRNT2000  MOVE       SP1,DIM1
          MOVE       SP1,MSCFLAG
.
          UNPACK     FINCODE,ANS
          MATCH      "A",FINTYPE
          GOTO       PRNT6000 IF NOT EQUAL
.         MOVE       ZERO,CRDFLAG
.
          CMATCH     "M",ANS               * Misc.item ?
          GOTO       PRNT2200 IF EQUAL
          CMATCH     "Q",ANS
          GOTO       PRNT3000 IF NOT EQUAL
.
PRNT2200  IF         PTCNMFEE=1
            UNPACK     FINCODE,ANS,DIM3,MISGRP       * claim/misc.group
            MOVE       ANS,SUBFIN
            MOVE       FINCODE,SKEY13
            PACK       SDIM10,SP1,DIM3,MISGRP,SP10
          ELSE
            UNPACK     FINCODE,ANS,MISGRP,DIM9       * misc.group/item code
            MOVE       ANS,SUBFIN
            MOVE       FINCODE,SKEY13
            PACK       SDIM10,SP1,MISGRP,SP10
            MATCH      SP3,MISGRP
            IF         @EQUAL
              PACK       SDIM10,SP1,DIM9,SP10
            ENDIF
          ENDIF
          MOVE       ONE,RECFLAG
          MOVE       ANS,MSCFLAG
          GOTO       PRNT8000
.
PRNT3000  CMATCH     "T",ANS
          GOTO       PRNT3200 IF EQUAL               * C/P Credit note item
          CMATCH     "P",ANS
          GOTO       PRNT4000 IF NOT EQUAL
.
PRNT3200  IF         PTCNMFEE=1
            UNPACK     FINCODE,ANS,DIM1,DIM3,MISGRP  * epsde/clm/misc.grp
            MOVE       FINCODE,SKEY13
            MOVE       ANS,SUBFIN
            PACK       SDIM10,DIM1,DIM3,MISGRP,SP10
          ELSE
            UNPACK     FINCODE,ANS,DIM1,MISGRP,DIM9  * epsde/misc.grp/itm
            MOVE       FINCODE,SKEY13
            MOVE       ANS,SUBFIN
            PACK       SDIM10,DIM1,MISGRP,SP10
            MATCH      SP3,MISGRP
            IF         @EQUAL
              PACK       SDIM10,DIM1,DIM9,SP10
            ENDIF
          ENDIF
          MOVE      ONE,RECFLAG       * flag for mis.item
          MOVE      ANS,MSCFLAG       * "T" for casemix & "M" for normal
          GOTO      PRNT8000
.
PRNT4000  
.         CMATCH    "N",ANS
.         IF        @EQUAL
.           MOVE      ONE,SCRDFLAG
.         ENDIF
.
          MOVE      FINCODE,DIM13
          UNPACK    FINCODE,SUBFIN
          MOVE      TWO,RECFLAG       * accommodations
          GOTO      PRNT8000
.
PRNT6000  MOVE      ZERO,CRDFLAG
          MATCH     "B",FINTYPE
          IF        @EQUAL
            IF        FINSYS = 3
              UNPACK    FINCODE,CASHTYP,CASHDESC
              MATCH     ANSA,CASHTYP
              IF        @EQUAL
                MOVE      "PATIENT     ",CASHDESC
              ELSE
                MATCH     ANSB,CASHTYP
                IF        @EQUAL
                  MOVE      "HEALTH FUND ",CASHDESC
                ELSE
                  MOVE      "INSURANCE   ",CASHDESC
                ENDIF
              ENDIF
            ELSE
              MOVE      "CASH/NON-INP",CASHDESC
            ENDIF
.
            MOVE      CASHTYP,SCASHTYP
            MOVE      CASHDESC,SCASHDES
            MOVE      FINCODE,SFINCODE
            MOVE      THREE,RECFLAG          * cash
          ENDIF
.
          MATCH     "C",FINTYPE
          IF        @EQUAL
            UNPACK    FINCODE,JRNLCOD
            MOVE      JRNLCOD,SJRNLCOD
            MOVE      FOUR,RECFLAG           * journals
          ENDIF
.
          MATCH      "G",FINTYPE
          IF         @EQUAL
            MOVE       FIVE,RECFLAG          * GST
            MOVE       FINCODE,DIM13A
            MOVE       FINCODE,SUBFIN
          ENDIF
.
          MATCH      "H",FINTYPE
          IF         @EQUAL
            MOVE       SIX,RECFLAG          * GST Journal
            UNPACK     FINCODE,JRNLCOD
            MOVE       JRNLCOD,SJRNGCOD
          ENDIF
.
PRNT8000  MOVE       FINSYS,SFINSYS
          MOVE       FINSITE,SFINSITE
          MOVE       FINTYPE,SFINTYPE
          MOVE       FINHOSP,SFINHOSP
          ADD        FINAMT,SUBTOT
          ADD        FINAMT,GNDTOT
          MOVE       CRDFLAG,SCRDFLAG
          GOTO       PRNT1000
.
PRNT9000  MOVE       SP20,FINCODE
          IF         CLNO=60
            CALL       HEAD0000
          ENDIF
          CALL       PSUB0000
          CALL       PTOT0000
          PRINT      *1,"** End of Report **"
.
PRNT9999  RETURN
+
.*******************************************************************************
.*        PSUB0000 - Print sub-totals                                          *
.*******************************************************************************
PSUB0000  COMPARE    ZERO,SUBTOT
          GOTO       PSUB9999 IF EQUAL
.
          MOVE       SP10,DIM3
          LOAD       DIM3,SFINSYS,AAE,OUT,INP
.
          IF         SFINSYS=2
            MOVE       SFINSITE,DIM3
          ENDIF
.
          BRANCH     TOTONLY,PSUB0200
          CALL       UND132
PSUB0200  BRANCH     RECFLAG,PSUB1000,PSUB2000,PSUB3000,PSUB4000,PSUB5000:
                             PSUB6000
.
PSUB1000  MATCH      "Q",SUBFIN
          GOTO       PSUB1200 IF EQUAL
          MATCH      "P",SUBFIN
          GOTO       PSUB1400 IF NOT EQUAL
.
.         Credit notes
.
PSUB1200  IF         HOSPFLAG=1
            IF         PTCNMFEE=1
              PRINT      *1,SFINHOSP:
                         *5,DIM3," SUB-TOTAL CRD NOTES(CLAIM/ITEM GROUP): ":
                         SKEY13;
.                        SDIM10;
            ELSE
              PRINT      *1,SFINHOSP:
                         *5,DIM3," SUB-TOTAL CRD NOTES(MISC.ITEM GROUP): ":
                         SKEY13;
.                        SDIM10;
            ENDIF
            MOVE       SP70,SKEY13
          ELSE
            IF         PTCNMFEE=1
              PRINT   *1,DIM3," SUB-TOTAL CRD NOTES(CLAIM/ITEM GROUP): ":
.                        SDIM10;
                         SKEY13;
            ELSE
              PRINT    *1,DIM3," SUB-TOTAL CRD NOTES(MISC.ITEM GROUP): ":
.                        SDIM10;
                         SKEY13;
            ENDIF
          ENDIF
          MATCH      "P",SUBFIN
          GOTO       PSUB1800 IF NOT EQUAL     * Not C/P
          GOTO       PSUB1600
.
PSUB1400  IF         HOSPFLAG=1
            IF         PTCNMFEE=1
              PRINT      *1,SFINHOSP:
                         *5,DIM3," SUB-TOTAL (CLAIM/ITEM GROUP): ",SDIM10;
            ELSE
              PRINT      *1,SFINHOSP:
                         *5,DIM3," SUB-TOTAL (MISC.ITEM GROUP): ",SDIM10;
            ENDIF
          ELSE
            IF         PTCNMFEE=1
              PRINT      *1,DIM3," SUB-TOTAL (CLAIM/ITEM GROUP): ",SDIM10;
            ELSE
              PRINT      *1,DIM3," SUB-TOTAL (MISC.ITEM GROUP): ",SDIM10;
            ENDIF
          ENDIF
          MATCH      "T",SUBFIN
          GOTO       PSUB1800 IF NOT EQUAL     * Not C/P
.
PSUB1600  UNPACK     SDIM10,KEY1
          MATCH      "1",KEY1
          IF         @EQUAL
            PRINT      " - SAMEDAY",*93,SUBTOT
          ELSE
            PRINT      " - MSO",*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB1800  PRINT      *93,SUBTOT
          GOTO       PSUB8000
.
PSUB2000  MATCH      "H",SUBFIN
          GOTO       PSUB2300 IF EQUAL
          MATCH      "J",SUBFIN
          GOTO       PSUB2200 IF EQUAL
          MATCH      "N",SUBFIN
          GOTO       PSUB2400 IF NOT EQUAL
.
          IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP,*5,DIM3," SUB-TOTAL (CRD NOTES ACCOM): ":
                       DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (CRD NOTES ACCOM): ":
                       DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB2200  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,DIM3," SUB-TOTAL (CRD NOTES DAILY CHARGE ACCOM): ":
                       DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (CRD NOTES DAILY CHARGE ACCOM): ":
                       DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB2300  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP,*5,DIM3," SUB-TOTAL (CRD NOTES LUMPSUM): ":
                       DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (CRD NOTES LUMPSUM): ":
                       DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB2400  MATCH      "C",SUBFIN
          GOTO       PSUB2420 IF EQUAL
          MATCH      "D",SUBFIN
          GOTO       PSUB2430 IF EQUAL
.
          IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,DIM3," SUB-TOTAL (ACCOMMODATION): ",DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (ACCOMMODATION): ",DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB2420  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,DIM3," SUB-TOTAL (LUMPSUM ACCOMMODATION): ":
                       DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (LUMPSUM ACCOMMODATION): ":
                       DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB2430  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,DIM3," SUB-TOTAL (DAILY CHARGE ACCOMMODATION): ":
                       DIM13,*93,SUBTOT
          ELSE
            PRINT      *1,DIM3," SUB-TOTAL (DAILY CHARGE ACCOMMODATION): ":
                       DIM13,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB3000  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
.                      *5,DIM3," SUB-TOTAL (CASH): ",SCASHTYP," - ",SCASHDES:
                       *5,DIM3," SUB-TOTAL (CASH): ",SCASHTYP," - ",SFINCODE:
                       *93,SUBTOT
          ELSE
.           PRINT      *1,DIM3," SUB-TOTAL (CASH): ",SCASHTYP," - ",SCASHDES:
            PRINT      *1,DIM3," SUB-TOTAL (CASH): ",SCASHTYP," - ",SFINCODE:
                       *93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB4000  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (JOURNAL): ",SJRNLCOD,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (JOURNAL): ",SJRNLCOD,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5000  MATCH      "H",SUBFIN
          GOTO       PSUB5200 IF EQUAL
          MATCH      "J",SUBFIN
          GOTO       PSUB5300 IF EQUAL
          MATCH      "N",SUBFIN
          GOTO       PSUB5400 IF EQUAL
          MATCH      "Q",SUBFIN
          GOTO       PSUB5500 IF EQUAL
          MATCH      "P",SUBFIN
          GOTO       PSUB5600 IF EQUAL
.
          IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP,*5,"SUB-TOTAL (GST) : ",DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (GST) : ",DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5200  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (CRD NOTES GST LUMPSUM) : ":
                       DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (CRD NOTES GST LUMPSUM) : ":
                       DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5300  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (CRD NOTES GST DAILY CHARGE) : ":
                       DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (CRD NOTES GST DAILY CHARGE) : ":
                       DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5400  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (CRD NOTES GST ACCOMMODATION) : ":
                       DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (CRD NOTES GST ACCOMMODATION) : ":
                       DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5500  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (CRD NOTES GST MISC.ITEM) : ":
                       DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (CRD NOTES GST MISC.ITEM) : ":
                       DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB5600  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (CRD NOTES GST C/P MISC.ITEM) : ":
                       DIM13A,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (CRD NOTES GST C/P MISC.ITEM) : ":
                       DIM13A,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB6000  IF         HOSPFLAG=1
            PRINT      *1,SFINHOSP:
                       *5,"SUB-TOTAL (GST JOURNAL) : ",SJRNGCOD,*93,SUBTOT
          ELSE
            PRINT      *1,"SUB-TOTAL (GST JOURNAL) : ",SJRNGCOD,*93,SUBTOT
          ENDIF
          GOTO       PSUB8000
.
PSUB8000  CALL       UND132
          MOVE       ZERO,SUBTOT
PSUB9999  RETURN
+
.*******************************************************************************
.*        PTOT0000 - Print totals                                              *
.*******************************************************************************
PTOT0000  COMPARE    ZERO,GNDTOT
          GOTO       PTOT9999 IF EQUAL
          PRINT      *1,"TOTAL : ",*93,GNDTOT
          PRINT      "*=======================================":
                     "========================================":
                     "========================================":
                     "===========*"
          ADD        ONE,CLNO
          MOVE       ZERO,GNDTOT
PTOT9999  RETURN
+
.*******************************************************************************
.*        HEAD0000 - Heading                                                   *
.*******************************************************************************
HEAD0000  CALL       HEAD132
.
          MOVE       SP20,DIM10
          LOAD       DIM10,OPTION,INVOICE,CASH,JOURNAL,ALL
.
          MOVE       SP20,DIM10A
          LOAD       DIM10A,SUBOPT,INPAT,AAEPAT,OUTPAT,ALLPAT
.
          PRINT      *40,"System : ",DIM10A,"   ",DIM10
.
          UNPACK     FROMDATE,CCENT,CYEAR,CMON,CDAY
          CALL       PACDATE
          PRINT      *40,"Fromdate : ",CPCDATE;
          UNPACK     TODATE,CCENT,CYEAR,CMON,CDAY
          CALL       PACDATE
          PRINT      *65,"To : ",CPCDATE
.
          CALL       UND132
          PRINT      *1,"System",*10,"Site",*20,"Year",*25,"Type":
                     *30,"Financial Code",*47,"Invoice date",*62,"Invoice No":
                     *79,"Admission No.",*95,"    Amount"
          CALL       UND132
          ADD        THREE,CLNO
HEAD9999  RETURN
+
.*******************************************************************************
.         Subroutine to get the misc group of a given item
.*******************************************************************************
GETM0000   MOVE       SP3,MMSCGRP
.
.          Check if this charge is numeric (ie. a MBS Item number)
.
           TYPE      TITEMNO
           GOTO      GETM1000 IF NOT EQUAL
.
.          Code is numeric - check that it is a valid MBS item number
.
           PACK      KEY17 WITH TITEMNO,CURRDATE,SP70
           CALL      PATITMRD
           BRANCH    OVRCD OF GETM1000        * It might be a valid misc charge
.
           MOVE      IMISGRP,MMSCGRP
           GOTO      GETM9999
.
GETM1000   MOVE      "0  ",MCLMCOD
           PACK      KEY29,MCLMCOD,SP6,SP3,TITEMNO,CURRDATE,SP10
           CALL      PATMCHRD                * read Misc.Charges file 
           COMPARE   ZERO,EXIT
           GOTO      GETM9999 IF EQUAL       * it's active
.
GETM9000   MOVE       SP3,MMSCGRP
.
GETM9999   RETURN
+
.
.*******************************************************************************
.       Creating an indexed file based on port
.*******************************************************************************
INDZ0000  
.       CHECK IF PREVIOUSLY EXISTS..IF SO DELETED IT 
.
          CALL          KILL0000
          DISPLAY       *P1:12,*EF
          CLEAR         CMDLINE
          APPEND        "isbuild ",CMDLINE
          APPEND        FNAMEI,CMDLINE
        APPEND   " 63 u1-3,4-4,5-10,11-14,15-15,16-28,29-36,37-44+45-52",CMDLINE
.       APPEND   " 63 u1-4,5-10,11-14,15-15,16-28,29-36,37-44,45-52",CMDLINE
          RESET         CMDLINE
.
          EXECUTE      CMDLINE,TASKID
          MOVE         ZERO,OVRCD
          TRAP         OVERCOND IF IO
          OPEN         PATTEMP,FNAMEI
          TRAPCLR      IO
.
          MOVE         OVRCD,OPCND
          BRANCH       OPCND,INDZ8000
          GOTO         INDZ9999
.
INDZ8000  DISPLAY      *P20:24,*B,*V2LON:
                       "** The Index File Not Created **",*W2;
INDZ9999  RETURN
+
.*******************************************************************************
.       Deleting an indexed file based on port
.*******************************************************************************
KILL0000  CLOSE         PATTEMP
	  MOVE          ZERO,STATUS
.
          CLEAR         CMDLINE
          APPEND        "iserase ",CMDLINE
          APPEND        FNAMEI,CMDLINE
          RESET         CMDLINE
          EXECUTE       CMDLINE,TASKID
          DISPLAY       *P1:12,*EF
          RETURN
+
.*******************************************************************************
.         CFIN0000 - Find out which financial year and period this is in
.*******************************************************************************
CFIN0000  MOVE      ZERO,NOPERIOD
          UNPACK    FINDATE,DIM8
.
          REP       " 0",DIM8
          MATCH     "00000000",DIM8
          IF        @EQUAL
            MOVE      PINVDTE,DIM8
            REP       " 0",DIM8
            MOVE      DIM8,FINDATE
          ENDIF
.
          MATCH     FROMDATE,DIM8
          GOTO      CFIN9999 IF LESS
          MATCH     DIM8,TODATE
          GOTO      CFIN9999 IF LESS
.
          PACK      KEY14,FINDATE,SP6   * Position to this date
          CALL      RDSDRGA2            * Go to this date in the file
          CALL      RDKDRGA2            * Get the first record on or after date
          BRANCH    OVRCD,CFIN6000      * No records in file.
.
          MATCH     DRGFDTE,FINDATE     * Is the date before the from date ?
          GOTO      CFIN6000 IF LESS    * Yes. Date not found in file.
.
.         Period record found
.
          MOVE      DRGYR,FINYEAR       * Save financial year
          MOVE      DRGNUM,FORM2
          MOVE      FORM2,FOFFSET      * Save period offset
.
.         Check if this is in a prior financial year
.
          PACK      FINDATE,CCC,CYY,CMM,CDD
          REP       " 0",FINDATE
.
CFIN1000  PACK      KEY14,FINDATE,SP6   * Position to this date
          CALL      RDSDRGA2            * Go to this date in the file
          CALL      RDKDRGA2            * Get the first record on or after date
          BRANCH    OVRCD,CFIN7000      * No records in file.
.
          MATCH     DRGFDTE,FINDATE     * Is the date before the from date ?
          GOTO      CFIN7000 IF LESS    * Yes. Date not found in file.
.
          MATCH     DRGYR,FINYEAR       * Is this the same as the request date?
          GOTO      CFIN5000 IF EQUAL   * Yes. Continue Processing
.
.         If this the first day of the financial year, then let all invoiced
.         data go through as normal
.
          MATCH     "01",DRGNUM         * Is this the first period of year ?
          GOTO      CFIN3000 IF NOT EQUAL
.
          MATCH     FINDATE,DRGFDTE     * Is this date the start of period ?
          GOTO      CFIN3000 IF NOT EQUAL
.
.         Only allow invoices to go into the actual year.
.
          CMATCH    ANSA,FINTYPE
          GOTO      CFIN3000 IF NOT EQUAL
.
.         Invoice on the first day of the financial year. Allow to go into
.         previous year.
.
          GOTO      CFIN5000
.
.         Put the figures into the prior year column of report
.
CFIN3000  MOVE      TEN4,FOFFSET        * Put into the Prior year variable
          MOVE      DRGYR,FINYEAR       * Put into the current financial year
.
.         Post the data to the tempfile
.
CFIN5000  ADD       ONE,UNIQKEY
          MOVE      FOFFSET,FPERIOD
          MOVE      UNIQKEY,DUNIQKEY
          MOVE      PMVXMHOS,FINHOSP
          IF        HOSPFLAG=1
            PACK      KEY52,FINHOSP,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE:
                            PINVDTE,PINVNO,DUNIQKEY,SP20
          ELSE
            MOVE      SP10,FINHOSP
            PACK      KEY52,FINHOSP,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE:
                            PINVDTE,PINVNO,DUNIQKEY,SP20
          ENDIF
.
          CALL      WRTEMP 
.
          GOTO      CFIN9000            * Finished
.
.         The requested date does not exist in the date range file.
.
CFIN6000  UNPACK    FINDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          KEYIN     *P1:24,*EL,*V2LON,*B:
                    *DV,PINVADM," ** Date ",*DV,CPCDATE," not in Period Range":
                    " file. Hit <ENTER> to retry ",*EOFF,ANS;
.
.         CMATCH    EXITCHAR,ANS
          CMATCH    "E",ANS
          GOTO      CFIN8000 IF EQUAL
          GOTO      CFIN0000
.
.         The current date does not exist in the date range file.
.
CFIN7000  UNPACK    FINDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          KEYIN     *P1:24,*EL,*V2LON,*B:
                    *DV,PINVADM," ** Date ",*DV,CPCDATE," not in Period Range":
                    " file. Hit <ENTER> to retry ",*EOFF,ANS;
.
.         CMATCH    EXITCHAR,ANS
          CMATCH    "E",ANS
          GOTO      CFIN8000 IF EQUAL
          GOTO      CFIN1000
.
.         Finished update of fees invoice file
.
CFIN8000  MOVE      ONE,NOPERIOD
CFIN9000  
CFIN9999  RETURN
+
.*******************************************************************************
.         WFIN0000 - Write new figures to Fees Invoiced files
.*******************************************************************************
WFIN0000  BRANCH    UPDFLAG,WFIN2000
          GOTO      WFIN9999
.
WFIN2000  MOVE      ZERO,FIGFLAG
          CALL      COPY0000                * backup files
          MOVE      ONE,FIGFLAG
          CALL      COPY0000                * backup files
.
          MOVE      ZERO,FIGFLAG
          CALL      DERC0000                * delete rec.for the financial year
          MOVE      ONE,FIGFLAG
          CALL      DERC0000                * delete rec.for the financial year
          MOVE      ZERO,FIGFLAG
.
          MOVE      ZERO,TOTAMT
          PACK      SAVKEY31,SP70
          PACK      KEY52,SP70
          CALL      RDSTEMP
WFIN3000  CALL      RDKTEMP                 * get first record
          BRANCH    OVRCD,WFIN9999
.
          COMPARE   "3",FINSYS               * Inpatient?
          GOTO      WFIN3000 IF NOT EQUAL
.
          MATCH     CURFYEAR,FINYEAR        * Same financial year?
          GOTO      WFIN3000 IF NOT EQUAL
.
          MATCH     "F",FINTYPE
          GOTO      WFIN3200 IF EQUAL
          MATCH     "Y",FINTYPE
          GOTO      WFIN3400 IF NOT EQUAL
.
WFIN3200  
.         MULT      "-1",FINAMT
          REP       "FAYG",FINTYPE        * Credit notes for Accm and GST
.
WFIN3400  UNPACK    FINCODE,ANS,KEY12
          MATCH     "G",ANS
          IF        @EQUAL
            MOVE      "N",ANS               * non C/P Acc.
            PACK      FINCODE,ANS,KEY12
          ENDIF
.
          MOVE      ZERO,FIGFLAG
          MATCH     "G",FINTYPE
          IF        @EQUAL
            MOVE      ONE,FIGFLAG
            MOVE      "A",FINTYPE
            GOTO      WFIN3500
          ENDIF
.
          MATCH     "A",FINTYPE
          GOTO      WFIN3000 IF NOT EQUAL
.
WFIN3500
          MOVE       PINVNO,KEY8
          CALL       RDINV1
          IF         OVRCD=0
            PACK      FININVN,PINVNO,SP70
            MOVE      PINVADM,FINADMN
            MOVE      PINVUR,FINURNO
            MOVE      PINVDTE,FINDATE
            REP       " 0",FINDATE
            MOVE      FPERIOD,FOFFSET
.
            MOVE      ZERO,FGSTFLAG
            IF        FIGFLAG=1
              MOVE      ONE,FGSTFLAG  * GST flag
            ENDIF
            CALL      WFDE0000        * write to Financial detail file
          ENDIF
.
          MOVE      FINAMT,FINWRK
          PACK      KEY28,DFINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP,SP70
          IF        FIGFLAG=1
            CALL      RDFIGA1
          ELSE
            CALL      RDFINS1
          ENDIF
          BRANCH    OVRCD,WFIN4000
.
          MOVE      ZERO,FORM12P2
          LOAD      FORM12P2,FPERIOD,FINMTH1,FINMTH2,FINMTH3:
                                     FINMTH4,FINMTH5,FINMTH6:
                                     FINMTH7,FINMTH8,FINMTH9:
                                     FINMTH10,FINMTH11,FINMTH12:
                                     FINMTH13
          ADD       FINWRK,FORM12P2
          STORE     FORM12P2,FPERIOD,FINMTH1,FINMTH2,FINMTH3:
                                     FINMTH4,FINMTH5,FINMTH6:
                                     FINMTH7,FINMTH8,FINMTH9:
                                     FINMTH10,FINMTH11,FINMTH12:
                                     FINMTH13
          IF        FIGFLAG=1
            CALL      UPFIGA1
          ELSE
            CALL      UPFINS1
          ENDIF
          GOTO      WFIN3000                * get next tempfile record
.
WFIN4000  UNPACK    KEY28,DFINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP
          CALL      ZFLD0000
          LOAD      FORM12P2,FPERIOD,FINMTH1,FINMTH2,FINMTH3:
                                     FINMTH4,FINMTH5,FINMTH6:
                                     FINMTH7,FINMTH8,FINMTH9:
                                     FINMTH10,FINMTH11,FINMTH12:
                                     FINMTH13
          ADD       FINWRK,FORM12P2
          STORE     FORM12P2,FPERIOD,FINMTH1,FINMTH2,FINMTH3:
                                     FINMTH4,FINMTH5,FINMTH6:
                                     FINMTH7,FINMTH8,FINMTH9:
                                     FINMTH10,FINMTH11,FINMTH12:
                                     FINMTH13
          IF        FIGFLAG=1
            CALL      WRFIGA1
          ELSE
            CALL      WRFINS1
          ENDIF
          GOTO      WFIN3000               * get next tempfile record
.
WFIN9999  RETURN
+
.*******************************************************************************
.         Zero fields
.*******************************************************************************
ZFLD0000  MOVE      ZERO,FINMTH1
          MOVE      ZERO,FINMTH2
          MOVE      ZERO,FINMTH3
          MOVE      ZERO,FINMTH4
          MOVE      ZERO,FINMTH5
          MOVE      ZERO,FINMTH6
          MOVE      ZERO,FINMTH7
          MOVE      ZERO,FINMTH8
          MOVE      ZERO,FINMTH9
          MOVE      ZERO,FINMTH10
          MOVE      ZERO,FINMTH11
          MOVE      ZERO,FINMTH12
          MOVE      ZERO,FINMTH13
          MOVE      ZERO,FLSTYR
          MOVE      ZERO,FINPER
ZFLD9999  RETURN
+
.*******************************************************************************
.         DERC0000 - Delete fees invoiced for the financial year
.*******************************************************************************
DERC0000  MOVE      SP70,FINSITE
          MOVE      "A",FINTYPE
          MOVE      "3",F1
          IF        HOSPFLAG=1
            PACK      KEY28,HOSPID,F1,FINSITE,CURFYEAR,ANSA,SP70
            IF        FIGFLAG=1
              CALL      RDSFIGA2
              CALL      RDKFIGA2
            ELSE
              CALL      RDSFINS2
              CALL      RDKFINS2
            ENDIF
          ELSE
            PACK      KEY28,F1,FINSITE,FINYEAR,FINTYPE,SP70
            IF        FIGFLAG=1
              CALL      RDSFIGA1
              CALL      RDKFIGA1
            ELSE
              CALL      RDSFINS1
              CALL      RDKFINS1
            ENDIF
          ENDIF
          BRANCH    OVRCD,DERC9999
.
          IF        HOSPFLAG=1
            MATCH      FINHOSP,HOSPID
            GOTO       DERC9999 IF NOT EQUAL
          ENDIF
.
          COMPARE   "3",FINSYS               * Inpatient?
          GOTO      DERC9999 IF NOT EQUAL
.
          MATCH     SP70,FINSITE
          GOTO      DERC9999 IF NOT EQUAL
.
          MATCH     CURFYEAR,FINYEAR        * Same financial year?
          GOTO      DERC9999 IF NOT EQUAL
.
          MATCH     ANSA,FINTYPE            * only want fees
          GOTO      DERC9999 IF NOT EQUAL
.
          IF        HOSPFLAG=1
            PACK      KEY28,FINHOSP,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,SP70
            IF        FIGFLAG=1
              CALL      DEFIGA2
            ELSE
              CALL      DEFINS2
            ENDIF
          ELSE
            PACK      KEY28,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP,SP70
            IF        FIGFLAG=1
              CALL      DEFIGA1
            ELSE
              CALL      DEFINS1
            ENDIF
          ENDIF
          GOTO      DERC0000
.
DERC9999  RETURN
+
.********************************************************************
.*                          COPY0000                                *
.*  Backup file patfinsf                                            *
.********************************************************************
COPY0000  BRANCH    ORACFLAG,COPY2000
.
          CALL      DEFT0000                * get default path
          PACK      CMDLINE,SP70,SP70
          CLEAR     CMDLINE
          IF        FIGFLAG=1
            APPEND    "cp `ldat patfigaf.dat` ",CMDLINE
            APPEND    DEFPATH,CMDLINE
            APPEND    "sptfigaf.dat",CMDLINE
          ELSE
            APPEND    "cp `ldat patfinsf.dat` ",CMDLINE
            APPEND    DEFPATH,CMDLINE
            APPEND    "sptfinsf.dat",CMDLINE
          ENDIF
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      COPY9500
          ENDIF
.
          PACK      CMDLINE,SP70,SP70
          CLEAR     CMDLINE
          IF        FIGFLAG=1
            APPEND    "cp `ldat patfigaf.idx` ",CMDLINE
            APPEND    DEFPATH,CMDLINE
            APPEND    "sptfigaf.idx",CMDLINE
          ELSE
            APPEND    "cp `ldat patfinsf.idx` ",CMDLINE
            APPEND    DEFPATH,CMDLINE
            APPEND    "sptfinsf.idx",CMDLINE
          ENDIF
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          CMATCH    "0",TASKID
          IF        !@EQUAL
            GOTO      COPY9500
          ENDIF
          GOTO      COPY9000
.
COPY2000  IF        FIGFLAG=1
            OPEN      SPTFIGA1,"sptfigaf"
          ELSE
            OPEN      SPTFINS1,"sptfinsf"
          ENDIF
          PACK      KEY28,SP70
          IF        FIGFLAG=1
            CALL      RDSFIGA1
          ELSE
            CALL      RDSFINS1
          MOVE      ZERO,FIGFLAG
          ENDIF
COPY3000  IF        FIGFLAG=1
            CALL      RDKFIGA1
          ELSE
            CALL      RDKFINS1
          ENDIF
          BRANCH    OVRCD,COPY9000
.
          PACK      KEY28,FINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE,FINHOSP,SP70
          CALL      RASFIN1
          COMPARE   ZERO,OVRCD
          GOTO      COPY3000 IF EQUAL
.
          CALL      WRSFIN1
          GOTO      COPY3000
.
COPY9000  MOVE      ZERO,EXIT
          GOTO      COPY9999
.
COPY9500  MOVE      ONE,EXIT
          DISPLAY   *P1:24,*EL,*B,"Unable to backup file(s).  ":
                    "(Error: ",TASKID,")  ";
          CALL      HITENTER
COPY9999  RETURN
+
.**********************************************************************
.         Get the default directory
.**********************************************************************
DEFT0000  IF        FIGFLAG=1
            EXECUTE   "ldat patfigaf.dat > temp.txt",TASKID
          ELSE
            EXECUTE   "ldat patfinsf.dat > temp.txt",TASKID
          ENDIF
.
          PACK      DEFPATH,SP30,SP30
          CLOSE     FINDFILE
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      FINDFILE,"temp"
          TRAPCLR   IO
          BRANCH    OVRCD,DEFT3000
.
          READ      FINDFILE,SEQ;DEFPATH
          GOTO      DEFT3000 IF OVER
.
          ENDSET    DEFPATH
DEFT1000  CMATCH    "/",DEFPATH
          GOTO      DEFT2000 IF EQUAL
.
          BUMP      DEFPATH,-1
          GOTO      DEFT1000 IF NOT EOS
          GOTO      DEFT3000
.
DEFT2000  LENSET    DEFPATH
          RESET     DEFPATH
.
          PACK      DEFPATH,DEFPATH,SP30,SP30,SP30,SP30
          STRIP     DEFPATH
          ENDSET    DEFPATH
          RESET     DEFPATH
          CLOSE     FINDFILE
          MOVE      ZERO,EXIT
          GOTO      DEFT9999
.
DEFT3000  IF        FIGFLAG=1
            DISPLAY   *P1:24,*EL,*B,"Error finding patfigaf.  ";
          ELSE
            DISPLAY   *P1:24,*EL,*B,"Error finding patfinsf.  ";
          ENDIF
          CALL      HITENTER
          CLOSE     FINDFILE
          MOVE      ONE,EXIT
DEFT9999  RETURN
+
.*******************************************************************************
.         Subroutine to key in a valid date
.
KEYDTE    DISPLAY   *PCCOL:CVERT,*EL
          MOVE      IDAY,CDAY
          MOVE      IMON,CMON
          MOVE      IYEAR,CYEAR 
          MOVE      ICENT,CCENT
          MOVE      "1",CDEFDTE
          MOVE      "0",CHIGHLT
.
          CALL      KEYDATE
.
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
          MOVE      CCENT,CC
          MOVE      DD,IDAY
          MOVE      MM,IMON
          MOVE      YY,IYEAR
          MOVE      CC,ICENT
.          
          RETURN
+
. -----------------------------------------------------------------------------
.        KHOS0000: Keyin hospital ID
. -----------------------------------------------------------------------------
KHOS0000 DISPLAY    *P1:21,*EL,"Hospital Id : ";
         MOVE       TEN5,ECOL
         MOVE       "21",EVERT
         MOVE       SP3,CKYIDEF3
         MOVE       ZERO,CKYIMAND           * Not Mandatory
         OPEN       PATHSPA1,"pathspaf"
.
         CALL       PATHSPKY
         BRANCH     EXIT,KHOS1000,KHOS2000
         MOVE       PTHSHOSP,HOSPID
         MOVE       PTHSNAME,HOSPNAME
         MOVE       ONE,HOSPFLAG
         MOVE       ZERO,EXIT
         GOTO       KHOS9999
.
KHOS1000 MOVE       "All Hospitals",HOSPNAME
         MOVE       SP10,PTHSHOSP
         MOVE       ZERO,EXIT
         GOTO       KHOS9999
.
KHOS2000 MOVE       ONE,EXIT
KHOS9999 RETURN
.
.*******************************************************************************
.
WRTEMP   PACK      DPINVADM,PINVADM
         RESET     KEY52
         WRITE     PATTEMP,KEY52;KEY52,FINAMT,FPERIOD
         RETURN  
.  
RDSTEMP  RESET     KEY52
         READ      PATTEMP,KEY52;;
         RETURN 
.
RDKTEMP  MOVE      ZERO,OVRCD
         READKS    PATTEMP;FINHOSP,DFINSYS,FINSITE,FINYEAR,FINTYPE,FINCODE:
                           PINVDTE,PINVNO,DUNIQKEY,FINAMT,FPERIOD
         GOTO      OVERCOND IF OVER
         MOVE      DFINSYS,FINSYS
         MOVE      DUNIQKEY,UNIQKEY
         RETURN  
.
.
RASFIN1  MOVE      ZERO,OVRCD
         RESET     KEY28
         IF        FIGFLAG=1
           READ      SPTFIGA1,KEY28;ANS
         ELSE
           READ      SPTFINS1,KEY28;ANS
         ENDIF
         GOTO      OVERCOND IF OVER
         RETURN
.
WRSFIN1  MOVE      FINSYS,DFINSYS
         RESET     KEY28
         IF        FIGFLAG=1
           WRITE     SPTFIGA1,KEY28;DFINSYS,FINSITE,FINYEAR,FINTYPE:
                                 FINCODE,FINPER:
                                 FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                 FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                 FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                                 FINMTH13,FLSTYR,FINHOSP,FSPARE
         ELSE
           WRITE     SPTFINS1,KEY28;DFINSYS,FINSITE,FINYEAR,FINTYPE:
                                 FINCODE,FINPER:
                                 FINMTH1,FINMTH2,FINMTH3,FINMTH4:
                                 FINMTH5,FINMTH6,FINMTH7,FINMTH8:
                                 FINMTH9,FINMTH10,FINMTH11,FINMTH12:
                                 FINMTH13,FLSTYR,FINHOSP,FSPARE
         ENDIF
         RETURN
. -----------------------------------------------------------------------------
.
          INC       PATCALFN
          INC       PATITMRD
          INC       PATSTRYR
          INC       PATHSPKY
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       TFILENAM                     * Generate Temp File Name
          INC       AAEDTRIO/INC
          INC       AAEDE1IO/INC
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       OUTDTRIO/INC
          INC       OUTSITIO/INC
          INC       OUTBB1IO/INC
         INCLUDE    PATDRGIO/INC
         INC       PATDSCIO/INC
         INC       PATDTRIO/INC
         INC       PATRFNIO/INC
         INC       NZPRFNIO/INC
         INC       PATRFGIO/INC
         INC       PATFINIO/INC
         INC       NZPFINIO/INC
         INC       PATFIGIO/INC
         INC       NZPFIGIO/INC
         INC       PATHSPIO/INC
         INC       PATMCHIO/INC
         INC       PATMI1IO/INC
         INC       PATINVIO/INC
         INC       PATITMIO/INC
         INC       PMSFCIIO/INC
         INC       PMSCNOIO/INC
         INC       PMSVX1IO/INC
         INC       PATFN1IO/INC
         INC       RCPBNKIO/INC
         INCLUDE    STD001IO
          INC       WEBERRIO/INC                 * Web Server Error Logging
.
ENDIT    CHAIN      PGM
         STOP
