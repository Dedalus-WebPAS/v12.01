.******************************************************************************
.*                                                                            *
.*                        P R O G R A M   S U M M A R Y                       *
.*                        -------------   -------------                       *
.*                                                                            *
.*      PROGRAM NAME:   IBAMEH16                                              *
.*                                                                            *
.*      FUNCTION:       PRIMHD Extract for NZ                                 *
.*                                                                            *
.*                      This is a schedule program for PRIMHD Extract         *
.*                      It is used in conjunction with  MEHWEB02.PBL          *
.*                                                                            *
.*      MODIFICATIONS:                                                        *
.******************************************************************************
.*       V12.00.02  10/11/2025  Bella Turco   TSK 0968532                     *
.*                  Fixed incorrect spelling of 'HoNOS'                       *
.*       V12.00.01  27/05/2025  PJ Le Febour   TSK 0955096 AlphaNum visitnum  *
.*       V11.05.01  20/03/2025  Davin          TSK 0956210                    *
.*                  Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86) *
.*       V11.04.01  29.04.2024  DA Sarkies     TSK 0945318                    *
.*                  Added check to see if the referral has been updated       *
.*       V11.03.03  29.04.2024  DA Sarkies     TSK 0945318                    *
.*                  Added check to see if the referral has been updated       *
.*       V11.03.02  08.05.2023  Bella Turco    TSK 0931931                    *
.*                  Added ICD10 Edition 12 - XXCNCSYS = 16                    *
.*       V11.03.01  27.03.2023  Sunny          TSK 0929100                    *
.*                  Changed the PRIMHD Extract to extract HoNOSI (I1) records *
.*       V11.02.07  29.04.2024  DA Sarkies     TSK 0945318                    *
.*                  Added check to see if the referral has been updated       *
.*       V11.02.06  08.05.2023  Bella Turco    TSK 0931931                    *
.*                  Added ICD10 Edition 12 - XXCNCSYS = 16                    *
.*       V11.02.05  27.03.2023  Sunny          TSK 0929100                    *
.*                  Changed the PRIMHD Extract to extract HoNOSI (I1) records * 
.*       V11.02.04  28/07/2022  Thanh T        TSK 0910023                    *
.*                  Changed SRRD4000 to use HCP equivalent code of the        *
.*                  category lG for transfer to when referral is closed       *
.*       V11.02.03  31/03/2022  Davin          TSK 0917793                    *
.*                  Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)*
.*       V11.02.02  09/02/2022  Thanh T        TSK 0905641                    *
.*                  Recompiled as OUTHEDFD changes                            *
.*       V11.02.01  07/02/2022  Thanh T        TSK 0896905                    *
.*                  Recompiled for ALLDEPFD changes                           *
.******************************************************************************
.*       V11.01.05  08/12/2021  Davin          TSK 0913784                    *
.*                  Changed to use Cat.dh User Def Field 7 (PTCDUDF7) for     *
.*                  Family/Whanau Involvement collection start date (KHBD0000)*
.*       V11.01.04  03/12/2021  Davin          TSK 0913784                    *
.*                  Added Cat.dh User Def Field 4 PTCDUDF4 (SAVFWIDT) as      *
.*                  Family/Whanau Involvement collection start date (KHBD0000)*
.*       V11.01.03  06/09/2021  Davin          TSK 0908531                    *
.*                  Recompiled for PRMHDEXT - Family/Whanau Involvement field *
.*       V11.01.02  13/04/2021  Tracey Nguyen  Task 0900868                   *
.*                  Set XXCOFCAR to blank if Focus of Care (mehhonaf.mhhnfocu)*
.*                  is not recorded  - SHCO0000                               *
.*       V11.01.01  24/03/2021  Tracey Nguyen  Task 0901817                   *
.*                  Added functionality for XXATFAMW new data element in the  *
.*                  Activity (AT) record XML that will be used to report      *
.*                  Family/Whanau Involvement for all activity records        *
.*       V11.00.01  08/10/2020  Jill Parkinson Task 0897201                   *
.*                  Added read of Category G for gender                       *
.*       V10.15.03  27/11/2019  Tracey Nguyen  Task  0884893                  *
.*                  Checked if the matching AADMNO is found on allrsaaf to    *
.*                  retrieve the correct referral date as the start date for  *
.*                  XXRDRSTR in REFDAT00                                      *
.*       V10.15.02  08/11/2019  Tracey Nguyen  Task  0855163                  *
.*                  Do not extract RD record if there is no reportable        *
.*                  activities (ATEXISTS=0) - PLNK2400                        *
.*       V10.15.01  21/10/2019  Tracey Nguyen  Task  0855163                  *
.*                  Processed relevant HONOS records for the referral and if  *
.*                  not a primary referral then also checked for primary      *
.*                  referral for HONOS records - PLNK6000                     *
.*----------------------------------------------------------------------------*
.*       V10.14.22  23/09/2019  Tracey Nguyen  Task  0855163                  *
.*                  1)Write DELETED RD if referral was previously sent to MoH *
.*                    - PLNK2400, PREF3700                                    *
.*                  2)Commented out code to group by case team                *
.*                    - ILNK4000                                              *
.*                  3)If the linked referral does not have any HONOS records  *
.*                    then use the primary referral to check for HONOS records*
.*                    - PLNK6000                                              *
.*       V10.20.21  16/09/2019  Tracey Nguyen  Task 0855163                   *
.*                  RD records will no longer be grouped by case team, each   *
.*                  linked referral will be sent as a separate RD - ILNK6000  *
.*                  12/09/2019  Tracey Nguyen  Task 0866101                   *
.*                  Do not extract RD record if there are no reportable       *
.*                  activity (child records AT,CN,CO,OT, OI, SCR) attached    *
.*                  - PLNK2400, PREF3700                                      *
.*       V10.19.20  05/09/2019  Tracey Nguyen  Task 0869116                   *
.*                  Modified to only create 2nd activity record if there is   *
.*                  a subsequent pattranf record, ie. only send seclusion     *
.*                  records (T33) when the extract can derive an end date and *
.*                  time for the seclusion activity - TDATEAT2, SAAT0000      *
.*       V10.14.19  04/09/2019  Tracey Nguyen  Task 0879584                   *
.*                  Fixed diagnosis time and CN type:                         *
.*                  1)Moved code from SCCN5100 to SCCN5000 and:               *
.*                   1a)Skipped ICD code if AT date > CN date                 *
.*                   1b)Used AT time(+1 sec) if the AT date = CN date         *
.*                  2)Commented out code in SCCN5100                          *
.*       V10.14.18  03/09/2019  Tracey Nguyen  Task 0879584                   *
.*                  Modified SCCN5100 to skip diagnoses that are before the   *
.*                  first activity date                                       *
.*       V10.14.17  30/08/2019  Tracey Nguyen  Task 0878938                   *
.*                  MoH requested to exclude the procedure diagnosis codes    *
.*                  (patecoaf table) for Inpatient events.                    *
.*                  Modified PRIMHD extract as follows:                       *
.*                  1)Re-instated IPCOD0000                                   *
.*                  2)Modified IPCOD000 to remove extract of procedure code   *
.*                    diagnosis from patecoaf table for IP coding             *
.*       V10.14.16  26/08/2019  Tracey Nguyen  Task 0875371                   *
.*                  Added EXLRDACT flag to check if the linked referral with  *
.*                  a case team that has the status of 'Active - exclude from *
.*                  PRIMHD' to bypass this referral - SRRD0000, PLNK4000      *
.*       V10.14.15  23/08/2019  Tracey Nguyen  Task 0879097                   *
.*                  1)Removed all previous changes made for Task 0879097      *
.*                  2)Modified SCCN5000 to set up XXCNDTYP for DSM4 code as:  *
.*                    Any DSM4 code recorded will be set to "B" if other      *
.*                    diagnosis records (MHDIICD1-6) are recorded else set to *
.*                    "A" for the first record and "B" for all other records  *
.*       V10.14.14  22/08/2019  Tracey Nguyen  Task 0879097                   *
.*                  Moved setting of 1st DSMV-IV code to A inside the check   *
.*                  for F3 < 7 in SCCN5000 
.*       V10.14.13  22/08/2019  Jill Parkinson Task 0878938                   *
.*                  Re-instated MHDI0000                                      *
.*       V10.14.12  19/08/2019  Jill Parkinson Task 0878938                   *
.*                  Commented out call to IPCOD000 for discharges             *
.*       V10.14.11  15/08/2019  Jill Parkinson Task 0878938                   *
.*                  Commented out call to MHDI0000 to stop sending patecdaf   *
.*       V10.14.10  15/08/2019  Jill Parkinson Task 0879097                   *
.*                  Added setting of 1st diagnosis type to A in SCCN5000      *
.*                  15/08/2019  Jill Parkinson Task 0877765                   *
.*                  Added check for blank hdp in CKDTR000 to get correct first*
.*                  contact date/time                                         *
.*                  15/08/2019  Jill Parkinson Task 0878938                   *
.*                  Commented out call to IPCOD000                            *
.*       V10.14.09  25/07/2019  Tracey Nguyen  TSK 0858390                    *
.*                  Checked if the Collection Reason (mehhonaf.mehhnreas) is  *
.*                  to be included in the extract - CKDTR750, HONS100         *
.*       V10.14.08  18/06/2019  Tracey Nguyen  TSK 0856503                    *
.*                  Corrected Diagnosis Type XXCNDTYP for historical data     *
.*                  where MHDIDTYP1-6 is blank                                *
.*       V10.14.07  14/06/2019  Tracey Nguyen  TSK 0856503                    *
.*                  Changed Diagnosis Type XXCNDTYP                           * 
.*                  1)ICD10 Code recorded setup (SCCN5020):                   * 
.*                    a)Use MHDIDTYP1-6 if the value is NOT blank             * 
.*                    b)If MHDIDTYP1-6 is blank then set to "A" for first     *
.*                      record and "B" for all other records                  *
.*                  2) DSMV-IV code recorded set to "B" (SCCN5000)            *
.*       V10.14.06  16/04/2019  Jill Parkinson TSK 0867703                    *
.*                  Created IPCOD000 to create a CN record for inpatient      *
.*                  coded visits using patecdaf/patecoaf records              *
.*       V10.14.05  15/04/2019  Jill Parkinson TSK 0867703                    *
.*                  Changed to continue on to write a CN record for coded     *
.*                  inpatients - those that have patecdaf records             *
.*       V10.14.04  12/04/2019  Tracey Nguyen  TSK 0867703                    *
.*                  Fixed incorrect mapping of DIM170 from record type 5 (AT) *
.*                  to record type 6 (CN) in SICN0000                         *
.*       V10.14.03  05/04/2019  Ebon Clements  TSK 0867703                    *
.*                  Added ICD10 Edition 11 - SCCN0000                         *
.*       V10.14.02  12/03/2019  Ebon Clements  TSK 0867703                    *
.*                  Added ICD10 Edition 11 - XXCNCSYS = 15                    *
.*       V10.14.01  08/02/2019  Tracey Nguyen  TSK 0867829                    *
.*                  Fixed reporting of closed linked referrals in PLNK2000    *
.*                  1) If actual referral status is closed but linkstat has   *
.*                     been set to active then use linkstat                   *
.*                  2) If referral status is closed and lastrddt is available *
.*                     then use lastrddt/lastrdtm to overwrite close date/time*
.*                     (alredclo/alretclo) before calling CKDTR000 to check   *
.*                     date range                                             *
.******************************************************************************
.*       V10.13.05  26/11/2018  Tracey Nguyen  TSK 0860342                    *
.*                  1) Checked if the cancelled referral has not been         *
.*                     previously sent to MoH then ignore this cancelled      *
.*                     referral - PLNK2000, PREF3700.                         *
.*                  2) Reset XXRDDELT - PLNK1500, PLNK4100                    *
.*                  3) Set XXRDDELT to DELETED only if a record is found on   *
.*                     mehprdaf table - SRRD0000                              *
.*       V10.13.04  31/10/2018  Tracey Nguyen  TSK 0864712                    *
.*                  Removed closed date/time overwrite in PLNK2000            *
.*       V10.13.03  17/10/2018  Tracey Nguyen  TSK 0863982                    *
.*                  Modified LGST0000 to check if running in test mode then   *
.*                  bypass updating mehdlsaf record as sent                   *
.*       V10.13.02  02/08/2018  Tracey Nguyen  TSK 0859538                    *
.*                  Fixed DIAGTIME from being set to 00:00:00 on diagnosis    *
.*                  start time for CN records.                                *
.*                  1) Modified SCCN5100 to derive the DIAGTIME using the     *
.*                     actual DSMIVR Date (mhdixdat) OR ICD10 Diagnosis Date  *
.*                     (mhidat1/2/3/4/5/6) instead of the Action Date         *
.*                     (mhdidate) to compare with the first encounter date    *
.*                  2) Removed setting the DIAGDATE/DIAGTIME in PDIA0000      *
.*                     and SCCN2000                                           *
.*                  NOTE: This task is the missing functionality to           *
.*                        TSK 0292528                                         *
.*       V10.13.01  24/07/2018  Tracey Nguyen  TSK 0856086                    *
.*                  Modified LGST1500 to extract legal status records that    *
.*                  match the DHB selected when running the extract where     *
.*                  the Record Responsible DHB on Legal Status (MHCNRDHB)     *
.*                  is set                                                    *
.******************************************************************************
.*       V10.12.02  07/02/2018  Tracey Nguyen  TSK 0851539                    *
.*                  1) Modified PLNK4000/PLNK4100 to check if another RD is   *
.*                     required after the previous referral was deleted       *
.*                  2) Corrected usage of LASTRDST as an indicator to flag if *
.*                     the previous deleted referral was never sent to MoH    *
.*       V10.12.01  01/02/2018  Tracey Nguyen  TSK 0814204                    *
.*                  1)Modified SRRD0000 to read the new status in the Case    *
.*                    Team table, and if the Status is set to                 *
.*                    "Active - exclude from PRIMHD" (allcasaf.alcaactv=2)    *
.*                    the RD record will be excluded from the PRIMHD Extract. *
.*                  2)Modified SARD0000 to read Category P (Patient Type) and *
.*                    if Indicator13="X" then the RD record for a Mental      *
.*                    Health Inpatient visit will be excluded from the PRIMHD *
.*                    Extract.                                                *
.*       V10.11.04  15/12/2017  Thanh Tieu     Task 0306843                   * 
.*                  PRIMHD ADT RD Record to use Referral Date/Time Enhancement*
.*                  in REFDAT00 and SARD2000                                  *
.*       V10.11.03  21/90/2017  Ebon Clements  TSK 0836806                    *
.*                  Fixed axis code value when removing dot and dash          *
.*                  from 9 character code SICN0000 SCCN5000                   *
.*       V10.11.02  28/08/2017  Tracey Nguyen  TSK 0837897                    *
.*                  1) Removed the resetting of the cancelled date with       *
.*                     spaces in PLNK2000 so that the correct date range      *
.*                     check can be done in CKDTR000 at PLNK2400              *
.*                  2) Modified PLNK4000 to check for last saved RD status    *
.*                     to determine if a new "RD" record is required          *
.*                  3) Added LASTRDST to save the last RD referral status     *
.*       V10.11.01  27/07/2017  Tracey Nguyen  TSK 0837897                    *
.*                  Added validation to write an RD record for a cancelled    *
.*                  referral which was previously sent to MoH. This is to     *
.*                  enable MoH to correctly mark this referral as deleted.    *
.******************************************************************************
.*       V10.10.07  19/06/2017  Tracey Nguyen  TSK 0832767                    *
.*                  Added BDATACID to correct BD activity Id                  *
.*       V10.10.06  05/06/2017  Tracey Nguyen  TSK 0832767                    *
.*                  Added SAAT9010 and SAAT9020 to determine if a second AT   *
.*                  record needs to be written in the extract                 *
.*       V10.10.05  01/06/2017  Tracey Nguyen  TSK 0833934                    *
.*                  Replaced references of MEHCONFD.MHCNORID with SAVSSORG    *
.*                  for the new value of submitting Org Id value stored in    *
.*                  user defined 3 on category dh                             *
.*       V10.10.04  30/05/2017  Tracey Nguyen  TASK 0292528                   *
.*                  Added SCCN5100 to load start date for XXCNSDAT with       *
.*                  either mhixdat or mhidat1/2/3/4/5/6 for MH Diagnosis      *
.*                  Provisional Coding for CN record                          *
.*       V10.10.03  23/05/2017  Tracey Nguyen  TASK 0836629                   *
.*                  Removed resetting of EFFSDATE and EFFEDATE before calling *
.*                  SUPC0000 in DSCH5000. Start/End date range already set    *
.*                  by SETDAT00                                               *
.*       V10.10.02  17/05/2017  Tracey Nguyen  TASK 0835974                   *
.*                  Removed check for strtdate with alensdat in CKDTR250      *
.*       V10.10.01  17/03/2017  Davin          TSK 0833093     HDP 2017/2018  *
.*                  Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85) *
.*       V10.09.02  20/12/2016  Nicole Torrisi TASK 0826361                   *
.*                  Removed call to SUPC0000 for Cancelled inpatient records  *
.*       V10.09.01  20/12/2016  Nicole Torrisi TASK 0324038                   *
.*                  Removed Activity Setting of DP for Inpatient records      *
.*       V10.08.13  03/10/2016  Ebon Clements  TASK 0323697                   *
.*                  Call INPDHB00 in DSCH0000 and CANC0000 to filter IP       *
.*                  visits by DHB                                             *
.*       V10.08.12  27/09/2016  Ebon Clements  TASK 0323697                   *
.*                  Call INPDHB00 at ADMN1000 to filter IP visits by DHB      *
.*       V10.08.11  25/08/2016  Ebon Clements  TASK 0313562                   *
.*                  Changed AT T35 DNA records to use Start Time + Duration   *
.*                  for "End Time" - SEAT6000, SOAT4000 and SGAT6000          *
.*       V10.08.10  13/07/2016  Jill Parkinson TASK 0314957                   *
.*                  Added match for dastat=5 in CANC0000 - ignore if no longer*
.*                  cancelled status
.*       V10.08.09  24/05/2016  Jill Parkinson TASK 0816266                   *
.*                  Added coding system 14 for ICD10 Ed 8                     *
.*       V10.08.08  16/05/2016  Nicole Torrisi TSK 0817062                    *
.*                  Changed LGST4000 - Don't extract if Ind 9 of LS = "X"     *
.*       V10.08.07  11/05/2016  Jill Parkinson TSK 0817063                    *
.*                  Added calls to SUPC0000 for inpatients                    *
.*       V10.08.05  10/05/2016  Jill Parkinson TSK 0817063                    *
.*                  Moved call to SUPC0000 to stop calling on linked referrals*
.*       V10.08.04  05/05/2016  Jill Parkinson TSK 0817063                    *
.*                  Recompiled for Supplementary Consumer Record Tags         *
.*       V10.08.03  29/04/2016  Jill Parkinson TSK 0817063                    *
.*                  Recompiled for Supplementary Consumer Record              *
.*       V10.08.02  29/04/2016  Jill Parkinson TSK 0817063                    *
.*                  NCAMP Changes - Added Supplementary Consumer Record       *
.*       V10.08.01  20/04/2016  Nicole Torrisi TSK 0817060                    *
.*                  NCAMP Changes - Added ADOM Outcome items 21-23            *
.*       V10.07.03  21/10/2015  Jill Parkinson CAR 320401                     *
.*                  Added LASTRDVS - to store the visit number of the last    *
.*                  RD record created. Only compare the visit number if the   *
.*                  linked visit did have an RD record created.               *
.*       V10.07.02  19/10/2015  Don Nguyen     CAR 316625                     *
.*                  Modified SARD0000 to use PMVXCASE (Case Team) if exists   *
.*       V10.07.01  13/10/2015  Jill Parkinson CAR 319665                     *
.*                  Fixed CHKDHB00 to goto PREF3000 not PREF1000 if exit=1    *
.*       V10.06.05  03/07/2015  Jill Parkinson CAR 318950                     *
.*                  Modified XOIIVAL to be a dim 2 instead of dim 1           *
.*       V10.06.04  19/06/2015  Don Nguyen     CAR 306563                     *
.*                  Modified SEAT0000 to check for blank Service Type HDP     *
.*                  Equiv (ALSRMHDP) and skip the write of Activity record.   *
.*       V10.06.03  31/03/2015  Peter Vela     CAR 298921                     *
.*                  Match OTBBADCS to SP70                                    *
.*       V10.06.02  23/03/2015  Jill Parkinson CAR 303881                     *
.*                  Changed to only use first 3 chars of Category dh HDP      *
.*       V10.06.01  17/03/2015  Davin         CAR 311669      HDP 2015/16     *
.*                  Add PTCNGDV9 for ICD10 Ed.9 Go-live Date (Sect.110 Pos.77)*
.*       V10.05.05  17/11/2014  Ebon Clements  CAR 292656                     *
.*                  Added link cancelled OP visit to a referral functionality *
.*       V10.05.04  28/10/2014  Patrick Adair  CAR 303210                     *
.*                  Added 1-26 scores to extract for Secure HONOS (SM1T0000)  *
.*       V10.05.03  07/10/2014  Don Nguyen     CAR 303881                     *
.*                  Modified KHBD0000 to call PATCODKY.                       *
.*                  Modified prompt for District Health Board in KHBD0000.    *
.*       V10.05.02  29/08/2014  Don Nguyen     CAR 303881                     *
.*                  Modified ILNK0000 to filter referrals on DHB of preferred *
.*                  hospital against DHB (HDP Default) keyed in.              *
.*                  Modified main program control flow to prompt for DHB code *
.*                  - District Health Board (Cat dh). Extract patients from   *
.*                  preferred hospitals with matching DHB.                    *
.*       V10.05.01  26/08/2014  Ania P         CAR 303210                     *
.*                  Recompiled for MEHHONFD                                   *
.*       V10.04.12  17/06/2014  Don Nguyen     CAR 301904                     *
.*                  Modified PLNK2000; removed call to MOVE LINKSTAT,ALRESTAT *
.*                  17/06/2014  Don Nguyen     CAR 301817                     *
.*                  Modified PLNK4000 to default ALREUTM6 if blank            *
.*       V10.04.11  12/05/2014  Patrick Adair CAR 297326                      *
.*                  Replaced TCFORM6 with PTCDASC2 for CAT CG & P only        *
.*       V10.04.10  05/05/2014  Patrick Adair CAR 298965                      *
.*                  Recompiled for changes to PRMHDEXT                        *
.*       V10.04.09  11/04/2014  Don Nguyen     CAR 298631                     *
.*                  Modified PLNK4000 to re-read referral record before       *
.*                  calling RDRF0000. Modified PLNK2000 to include 'Inactive'.*
.*       V10.04.08  01/04/2014  Nicole Torrisi CAR 269742                     *
.*                  Added 1-12 scores to extract for Secure HONOS (SC1T1000)  *
.*       V10.04.07  01/04/2014  Don Nguyen     CAR 298949                     *
.*                  Added RFCNTLIM (count limit); increased from 201 to 999   *
.*       V10.04.06  28/03/2014  Don Nguyen     CAR 298631                     *
.*                  Modified SRRD0000 to handle 'Inactive' referrals.         *
.*                  Fixed DSCH4000 - test PTHSORID for space after RDPTHSP1.  *
.*                  Fixed SRRD6000 - test for OVRCD=0 after RDCODE1 instead.  *
.*       V10.04.05  11/02/2014  Nicole Torrisi CAR 294595                     *
.*                  Changed CANC0000 to use PTHSORID to set ORGANISATION_ID   *
.*       V10.04.04  11/02/2014  Nicole Torrisi CAR 294595                     *
.*                  Changed CANC0000 to use PTMIXWRD to set ORGANISATION_ID   *
.*       V10.04.03  04/02/2014  Nicole Torrisi CAR 295938                     *
.*                  Corrected WRTM0000 to limit records to 99999              *
.*       V10.04.02  14/01/2014  Nicole Torrisi CAR 294595                     *
.*                  Corrected CANC0000 to loop not exit after writing         *
.*       V10.04.01  06/01/2014  Nicole Torrisi CAR 294595                     *
.*                  Corrected CANC5000 to use AADMNO instead of CURREFNO      *
.*       V10.03.10  09/12/2013  Nicole Torrisi CAR 294595                     *
.*                  Changed CANC0000 to used PATUNAA3 instead of PATUNAA1     *
.*       V10.03.09  23/04/2013  Davin         CAR 284420      HDP 2013/14     *
.*                  Add PTCNGDV8 for ICD10 Ed.8 Go-live Date (Sect.110 Pos.69)*
.*       V10.03.08  01/10/2012  Mike Laming   CAR 272202                      *
.*                  Change SETDAT00 to always set EFFSTIME from ATIME         *
.*       V10.03.07  15/06/2012  Mike Laming   CAR 266318                      *
.*                  Mods to HONS0000, CTRN0000 & BDATS000 to correct dates    *
.*                  before 01/07/2008                                         *
.*       V10.03.06  04/05/2012  Mike Laming   CAR 261603                      *
.*                  Corrections made to CKDTR000 to correct "CN" Times        *
.*       V10.03.05  23/04/2012  Mike Laming   CAR 261603                      *
.*                  Corrections made to ILNK0000 & PLNK0000 & PRMHDEXT.PBL    *
.*       V10.03.04  12/04/2012  Mike Laming   CAR 261603                      *
.*                  Mods for MEHPATaf file change, Change PHUNQNUM to DIM5 -  *
.*                  see PRMHDEXT.PBL for ATNO, MHPTOCUR                       *
.*       V10.03.03  03/04/2012  Mike Laming    CAR 258616                     *
.*                  More Mods to AT & CO routines to read all Referral data   *
.*       V10.03.02  05/03/2012  Mike Laming    CAR 258616                     *
.*                  Mods to AT & CO routines to read all data for the Referral*
.*       V10.03.01  17/01/2012  Mike Laming    CAR 256500                     *
.*                  Mods to SAAT0000 to use paramater MHCNIPAT for Activity   *
.*                  Type - now uses Cat.A or Cat.BT                           *
.*       V10.02.03  05/05/2011  Mike Laming    CAR 236879                     *
.*                  Change AT "End Date/Times" to use "Start Time + Duration" *
.*                  for "End Time" - see CALL CALEND00 in SEAT6000, SOAT4000  *
.*       V10.02.02  28/03/2011  Mike Laming   CAR 240107                      *
.*                  Mods to PATECDaf & PATECOaf variables & Keys - file change*
.*       V10.02.01  23/03/2011  Mike Laming    CAR 228416                     *
.*                  Mods for ALLCASFD.ALCAORID (Org. Id) file change          *
.*       V10.00.25  28/09/2010  Mike Laming    CAR 230740                     *
.*                  Lengthen PATHNAME LCMDLINE CMDLINE & MOHFNAM,             *
.*                  use DIM250 (also in PRMHDEXT)                             *
.*       V10.00.24  24/09/2010  Mike Laming    CAR 228416                     *
.*                  Add Case Team Org.Id. (ALCAORID) at SRRD2000 for XXRDORID *
.*       V10.00.23  15/09/2010  Mike Laming    CAR 230234                     *
.*                  Change "AT" Id. to use "yymmddddmmss" at SAAT0000         *
.*       V10.00.22  24/08/2010  Mike Laming    CAR 228415                     *
.*                  Change to ensure PTHSORID is blank before read            *
.*       V10.00.21  23/08/2010  Mike Laming    CAR 228415                     *
.*                  Changes IP output to fix Organization Id.                 *
.*       V10.00.20  19/08/2010  Mike Laming    CAR 228415                     *
.*                  Changes to SRRD0000 & CKDTR000 to correct date/time formats
.*       V10.00.19  06/08/2010  Mike Laming    CAR 227068                     *
.*                  More changes - SAAT0000, CNTR0000, BDATS000 etc           *
.*       V10.00.18  06/08/2010  Mike Laming    CAR 227068                     *
.*                  More changes/fixes - I still don't know why I do this     *
.*       V10.00.17  04/08/2010  Mike Laming    CAR 227068                     *
.*                  More changes/fixes - I don't know why I do this           *
.*       V10.00.16  27/07/2010  Mike Laming    CAR 227068                     *
.*                  RAdd Referral End Dates to CNs at SCCN2200                *
.*       V10.00.15  27/07/2010  Mike Laming    CAR 227068                     *
.*                  Review SAAT0000 & CNTR0000 -                              *
.*       V10.00.14  27/07/2010  Mike Laming    CAR 227068                     *
.*                  Review SAAT0000 & CNTR0000 -                              *
.*       V10.00.13  16/07/2010  Jill Parkinson CAR 213741                     *
.*                  Commented out move of 1 to EXIT in CLIDOC00               *
.*                  Commented out the hardcode DM for the T37 records         *
.*       V10.00.12  14/07/2010  Jill Parkinson CAR 213741                     *
.*                  Removed loop in SAAT0000 - added EXIT=2                   *
.*       V10.00.11  09/07/2010  Mike Laming  CAR 213741                       *
.*                  More changes - PCOD0000 & SOAT0000                        *
.*       V10.00.10  08/07/2010  Mike Laming  CAR 213741                       *
.*                  More changes - Inpatients CTRN0000                        *
.*       V10.00.09  06/07/2010  Mike Laming  CAR 213741                       *
.*                  More changes to for "CN"s - PCOD0000                      *
.*       V10.00.08  01/07/2010  Mike Laming  CAR 213741                       *
.*                  More changes to Activity Start/End Dates - BDATS000 +     *
.*       V10.00.07  03/06/2010  Mike Laming  CAR 213741                       *
.*                  Add Date check (CKDTR000) to routine ILNK000 - slight mods*
.*                  to other Date checks                                      *
.*       V10.00.06  25/05/2010  Mike Laming  CAR 213741                       *
.*                  Mods to Test Option 2 in ILNK000 to allow 2 Primaries thru*
.*       V10.00.05  13/04/2010  Mike Laming  CAR 213741                       *
.*                  Mods to process Linked referrals as per document - see    *
.*                  new routines ILNK000 and PLNK000                          *
.*       V10.00.04  12/04/2010  Steve Armstrong   CAR 219111                  *
.*                  Recompiled for changes to PATUNAFD.                       *
.*                  Mods for change from KEY17 to KEY25 in PATUNAFD.          *
.*       V10.00.03  31/03/2010  Mike Laming  CAR 217575                       *
.*                  Recompiled for changes to MEHDIAFD                        *
.*       V10.00.02  07/04/2010  Mike Laming   CAR 219246      HDP 2010        *
.*                  Add PTCNGDV7 for ICD10 Ed.7 Go-live Date (Sect.110 Pos.61)*
.*       V10.00.01  31/03/2010  Mike Laming   CAR 216783                      *
.*                  Re-compiled for PRMHDEXT - remove <ORGANISATION_TYPE>     *
.******************************************************************************
.*        V9.12.17  07/12/2009  Mike Laming   CAR 211806                      *
.*                  Changes required as per CARs 211154, 211153 & 211511      *
.*        V9.12.16  02/12/2009  Mike Laming   CAR 210948                      *
.*                  Correct GOTO statements at PGRC2000                       *
.*        V9.12.15  26/11/2009  Mike Laming   CAR 210949                      *
.*                  Mods to "CO" <FOCUS_OF_CARE> - not output if a Child      *
.*        V9.12.14  23/11/2009 Mike Laming    CAR 210363                      *
.*                  Recompiled for PRMHDEXT - change "zip" command again      *
.*        V9.12.13  23/11/2009 Mike Laming    CAR 210363                      *
.*                  Recompiled for PRMHDEXT - change "zip" command            *
.*        V9.12.12  19/11/2009 Mike Laming    CAR 210403                      *
.*                  Fix Episode Test GOTO (which was ending routine) in both  *
.*                  ADMN0000 & DSCH0000 at ADMN6000 and DSCH6000              *
.*        V9.12.11  10/11/2009 Mike Laming    CAR 209439                      *
.*                  Re-fix "EXTRACT" time field - put IBACLOCK in PEXTR000    *
.*        V9.12.10  09/11/2009 Mike Laming    CAR 207921                      *
.*                  Mod to "Referral To" for non-Primary referral at SRRD4000 *
.*        V9.12.09  05/11/2009 Mike Laming    CAR 209439                      *
.*                  Fix "EXTRACT" Time fields for "LS" records                *
.*        V9.12.08  21/09/2009 Mike Laming    CAR 206820                      *
.*                  Correct Option 2 (programmer testing Option at DSCH1020)  *
.*        V9.12.07  21/09/2009 Mike Laming    CAR 205635                      *
.*                  Correct "Linked Referral with no "CN"" - see DIAREFNO     *
.*        V9.12.06  25/08/2009 Mike Laming    CAR 203923                      *
.*                  Send "Deleted RD" when all "AT"s are cancelled - check Hist
.*        ........  25/08/2009 Mike Laming    CAR 202855                      *
.*                  Add pre 01/07/2008 "CN" recd. where "AT"s exist after date*
.*                  - needed new routine PDOC0000 (PCOD0000 backwards)        *
.*        V9.12.05  17/08/2009 Mike Laming    CAR 203051                      *
.*                  Fix temp file key PHVISNUM to use CURREFNO at PLOP4000    *
.*        V9.12.04  11/08/2009 Mike Laming    CAR 203410                      *
.*                  Set "on leave" Activity setting at SAAT3000               *
.*        ........  11/08/2009 Mike Laming    CAR 203051                      *
.*                  Reverse Linked OP Referrals test for Encounter at PLOP3000*
.*        V9.12.03  31/07/2009 Mike Laming    CAR 202347                      *
.*                  Add test for Admissions now Discharded at INPT0000        *
.*        ........  27/07/2009 Mike Laming    CAR 201941                      *
.*                  Recompiled for PRMHDEXT - increase TOTRDNO & TOTLSNO      *
.*        V9.12.02  06/07/2009 Mike Laming    CAR 200143                      *
.*                  PRIMHD 1 July 2009 changes                                *
.*         ........ 06/07/2009 Mike Laming    CAR 200174                      *
.*                  Fix AT duplicate keys with AT test for 01/07/2008         *
.*        V9.12.01  26/06/2009 Mike Laming    CAR 199777                      *
.*                  Re-ported from V9.10 for latest changes                   *
.*        V9.10.25  26/06/2009 Mike Laming    CAR 199777                      *
.*                  Mod at CTRN2000 to stop "TMOVE=D" creating an "AT" recd   *
.*        V9.10.24  25/06/2009 Mike Laming    CAR 199520                      *
.*                  Mods for RD/CN Start Time & Classification ID             *
.*        V9.10.23  23/06/2009 Mike Laming    CAR 199247                      *
.*                  Added HONOS "CO" records for Inpatients                   *
.*        ........  23/06/2009 Mike Laming    CAR 194555                      *
.*                  Further changes to get CN Diag. Codes from MEHDIAaf right *
.*        V9.10.22  25/05/2009 Mike Laming    CAR 194554                      *
.*                  Changed PLOP2000 to accept OBASTAT of "4" or "5"          *
.*        ........  25/05/2009 Mike Laming    CAR 195060                      *
.*                  Add Open OUTBB1A1 at OUTFIL00 & Read at SOAT1000          *
.*           V9.10.21 21/05/2009 Mike Laming    CAR 194555                    *
.*                    Changed all references to MHDIDATE to MHDIDAT1          *
.*           ........ 21/05/2009 Mike Laming    CAR 194128                    *
.*                    Create Routine CKDTR000 to correct Date Range checks    *
.*           ........ 20/05/2009 Mike Laming    CAR 195060                    *
.*                    Fix to SOAT0000 to ensure correct Linked Visit          *
.*           ........ 15/05/2009 Mike Laming    CAR 190929                    *
.*                    Small fix to "Referral From/To/End Code" (cut/paste err)*
.*           V9.10.20 04/05/2009 Mike Laming    CAR 190693                    *
.*                    Add logic to retrieve Diagnosis from Prim.Referral if   *
.*                    "AT" data is on Linked Referral. Correct Prim.Referrals *
.*                    to delete the Prim.Referral "RD" if there is no "AT".   *
.*           V9.10.19 30/04/2009 Mike Laming    CAR 190929                    *
.*                    Change "Referral From/To/End Code" to use Transfer Codes*
.*                    using ALLDADaf/PATDADaf and PATVADaf (see XXRDRFFR &    *
.*                    routine TRNSRC00)                                       *
.*           V9.10.18 28/04/2009 Mike Laming    CAR 195060                    *
.*                    Add OUTCLIFD/IO and CLIDOC00 routine for "AT" Doc. CPN  *
.*           V9.10.17 21/04/2009 Mike Laming    CAR 194314                    *
.*                    Correct XML record sequence for Honos Records for "CO"s *
.*           V9.10.16 14/04/2009 Mike Laming    CAR 194314                    *
.*                    Change HONS0000 to read multiple Honos Records for "CO"s*
.*           V9.10.15 09/04/2009 Mike Laming    CAR 193844 & 194143           *
.*                    193844 - changed to use MHHNRHCP (not PHCP) at SHCO1000 *
.*                    194143 - removed test for Primary Referral (ALREUYN4=1) *
.*           V9.10.14 06/04/2009 Mike Laming    CAR 193526                    *
.*                    Corrected NHI Key (use MHDLURNO) at LGST4000            *
.*           V9.10.13 02/04/2009 Mike Laming    CAR 192907                    *
.*                    Fix return to ADMN1000 just before ADMN9999             *
.*           V9.10.12 31/03/2009 Mike Laming    CAR 191129                    *
.*                    191129 Change Activity ID to include TTIME              *
.*                    191132 Add check for CN Start Time when no AT record    *
.*                    192348 Change Extract Date/Times to 00:00:00 & 23:59:59 *
.*           V9.10.10 25/03/2009 Mike Laming    CAR 191877                    *
.*                    Recompiled for MEH Tables (PAT, PCN, PCO, POI & PLS)    *
.*           V9.10.09 17/03/2009 Mike Laming    CAR 191877                    *
.*                    Change PHUNQNUM to DIM3, change PHSRTYPE to PHSRUNQN as *
.*                    DIM3 and use as the OI Unique No. Change temp file etc. *
.*           V9.10.08 13/01/2009 Mike Laming    CAR 181181                    *
.*                    Change TeamCode to be read from ALREUHC4, ALCAACOR or   *
.*                    ALREDEPT (using Cat CG & TCFORM6)                       *
.*           V9.10.07 18/12/2008 Mike Laming    CAR 166690                    *
.*                    Add logic to ensure CN Start dat/time is >= to first AT *
.*                    record - see "* CN fix" comments                        *
.*           V9.10.06 10/12/2008 Mike Laming    CAR 166690                    *
.*                    Change nul Times to "00:00:00" and "23:59:59"           *
.*           V9.10.05 20/11/2008 Mike Laming    CAR 166690                    *
.*                    Add MEHPTFaf Transmission Table  - fix PREF8000 branch  *
.*           V9.10.04 08/10/2008 Mike Laming    CAR 166690                    *
.*                    Add PRIMHD Extract History Files to store "Sent" History*
.*           V9.10.03 08/10/2008 Mike Laming    CAR 166690                    *
.*                    Couple of changes to setups as per e-mail               *
.*           V9.10.02 18/09/2008 Mike Laming    CAR 166690                    *
.*                    Couple of changes to setups as per Eric's e-mail        *
.*           V9.10.01 18/09/2008 Mike Laming    CAR 166690                    *
.*                    Turn off Test code - see TESTIT flag                    *
.*           V9.10.00 03/06/2008 J.Tan          CAR 166690                    *
.*                    Created New.                                            *
.*                                                                            *
.******************************************************************************
.
          INC       STD001FD
          INC       STDHLPDF
          INC       STDKWSDF
          INC       PATCOMM/INC
          INC       PRMHDXML/INC
.
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       OUTSESFD/INC
          INC       OUTHEDFD/INC
.
          INC       ALLCASFD/INC
          INC       ALLREFFD/INC
          INC       ALLRSAFD/INC
          INC       ALLENCFD/INC
          INC       ALLGPAFD/INC
          INC       ALLLNKFD/INC
          INC       ALLDEPFD/INC
          INC       ALLSERFD/INC
          INC       ALLGREFD/INC
          INC       ALLCONFD/INC
          INC       ALLRLNFD/INC                                      *I-190693
          INC       ALLDADFD/INC                                      *I-190929
.
          INC       PATDADFD/INC                                      *I-190929
          INC       PATVADFD/INC                                      *I-190929
          INC       PATWR1FD/INC                                      *I-256500
.
          INC       PATCONFD/INC
          INC       MEHCONFD/INC
          INC       MEHDIAFD/INC
          INC       MEHHLSFD/INC
          INC       MEHDLSFD/INC
          INC       MEHVI1FD/INC
          INC       MEHLEGFD/INC
          INC       MEHHONFD/INC
          INC       MEHSCRFD/INC
          INC       MEHDS1FD/INC
          INC       NHIMASFD/INC
          INC       PATCODFD/INC
          INC       PATDAYFD/INC
          INC       PATHSPFD/INC
          INC       PATDSCFD/INC
          INC       PATUNAFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSHCPFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       IBAPRNFD/INC
.
.                                           * PRIMHD Extract History tables
          INC       MEHPRDFD/INC
          INC       MEHPATFD/INC
          INC       MEHPCNFD/INC
          INC       MEHPCOFD/INC
          INC       MEHPCSFD/INC
          INC       MEHPOIFD/INC
          INC       MEHPLSFD/INC
          INC       MEHPTFFD/INC
.
+
.******************************************************************************
ASTATUS   FORM      1
ATEXISTS  FORM      1
BDATACID  DIM       18                                                *C-0832767
CMDLINE   DIM       100                                               *C-230740
USEDPDOC  FORM      1
CALSTTIM  DIM       8
CALENTIM  DIM       8
CALHH     DIM       2
CALMM     DIM       2
CALSS     DIM       2
CALMINS   FORM      6
CALDURAT  DIM       8
CFILEPRE  DIM       3
CNIDCNT   FORM      2                       * CN Unique Id. No.       *I-199520
CODE      DIM       3
DHBEQUIV  DIM       3                  * District Health Board (HDP Default)
DIACOUNT  FORM      3
DIAEDATE  DIM       8
DIAETIME  DIM       8
DIAENDDT  DIM       8
DIAENDTM  DIM       8
.
DIAGICD   FORM      1
DIAGPRIM  DIM       8[500]
DIAGLINK  DIM       8[500]
DIAGMOHN  DIM       8[500]
DIAGTMID  DIM       2[500]
DIAGSDAT  DIM       8[500]
DIAGSTIM  DIM       8[500]
DIAGEDAT  DIM       8[500]
DIAGETIM  DIM       8[500]
.

DIM1A     DIM       1
DIM1B     DIM       1
DIM2A     DIM       2
DIM2B     DIM       2
DIM2C     DIM       2
DIM3A     DIM       3
DIM4A     DIM       4
DIM5A     DIM       5
DIM8B     DIM       8
DIM9A     DIM       9
DIM10     DIM      10
DIM12A    DIM      12
DIM15A    DIM      15
DIM150    DIM     150
DIM170    DIM     170
DIM250    DIM     250                                                 *I-230740
LCMDLINE  DIM     300                                                 *C-230740
LENIN     FORM      5
LENOUT    FORM      5
LENGTH    FORM      5
DIAGDATE  DIM       8
DIAGTIME  DIM       8
DIAGNUMB  FORM      1
DELFLAG   FORM      1
EFFSDATE  DIM       8
EFFSTIME  DIM       8
EFFEDATE  DIM       8
EFFETIME  DIM       8
ENDDATE   DIM       8
EXLRDACT  FORM      1           * Exclude RD flag               *T0875371
F2H       FORM      2
F2M       FORM      2
F2S       FORM      2
F3B       FORM      3
F3C       FORM      3
F3XX      FORM      3
F3OT      FORM      3
F5A       FORM      5                       * replaces F3A            *I-261603
FORM3     FORM      3
FORM5     FORM      5                                                 *I-261603
FORM6     FORM      6
FORM8     FORM      8
FOUND     FORM      1
FOUNDAT   FORM      1
FOUNDCN   FORM      1
FOUNDCO   FORM      1
FOUNDREF  FORM      1
FRSTATDT  DIM       8                       * first AT Date when reading all
FRSTATTM  DIM       8                       * first AT Time when reading all
IBCNMHOS  FORM      1
ICDEDNO   DIM       2
.                                                            * start  *I-213741
BYPASSIT  FORM      1
FOUND3    FORM      3
MOHSDATE  DIM       8                       * Start Date for MoH "RD" record
MOHSTIME  DIM       8
REFLSTAT  FORM      1                       * numeric ALRESTAT
LLREEDAT  DIM       8                       * equivalent to ALREEDAT (Psudo)
LLREETIM  DIM       8                       * equivalent to ALREETIM (Psudo)
PLNKFLAG  FORM      1
PREFFLAG  FORM      1
PREVDIAG  DIM       8
PRIMEXFL  DIM       8
PRIMSDAT  DIM       8
PRIMSTIM  DIM       8
PRIMEDAT  DIM       8
PRIMETIM  DIM       8
.
REFCOUNT  FORM      3
REFTMCNT  FORM      2
REFPRINO  DIM       8[500]                   * Primary Ref. no.
REFLNKNO  DIM       8[500]                   * Linked Ref. no.
REFMOHNO  DIM       8[500]                   * Ref. no. sent to MoH
REFDEPT   DIM       3[500]
REFTEAM   DIM      10[500]
REFRDATE  DIM       8[500]                   * start date
REFRTIME  DIM       8[500]                   * start time
REFENCDT  DIM       8[500]                   * update date
REFENCTM  DIM       8[500]                   * update time
REFEDATE  DIM       8[500]                   * end date
REFETIME  DIM       8[500]                   * end time
REFFRFID  DIM       1[500]
REFFTMID  DIM       2[500]
REFRDYN   DIM       1[500]
REFATYN   DIM       1[500]
REFCOYN   DIM       1[500]
REFSTAT   DIM       1[500]
RFCNTLIM  FORM      "999"                   * max referral count
TEAMNOID  DIM       2
TESTNO    FORM      3
.                                                            * end    *I-213741
.
OPERCODE  DIM       4
PATHNAME  DIM      50                                                 *C-230740
PATFNAME  DIM       8
.
RECFLAG   FORM      1
RSTATUS   DIM       1
.
SAVDHBCD  DIM       3                       * Save keyed in DHB code *T0856086
SAVEASC2  DIM       6                       * Save Associate Field2  *C-0832767
SAVSSORG  DIM      10                       * Save Submitting Org Id *C-0833934
SAVFWIDT  DIM       8                       * Save date recording FWI (0913784)
SERIOUS   FORM      1
STRTDATE  DIM       8
SKEY16    DIM      16
SKEY25    DIM      25
SKEY33    DIM      33                                                 *C-261603
SVATACID  DIM      20                       * Save BD AT activity ID *C-0832767
SVUNQNUM  DIM       5                                                 *C-261603
.
TDATEAT2  DIM       8   * Save AT 2nd end date (CCYYMMDD)             *T0869116
.
TRNSRCKY  DIM       5                       * Transfer Source Cat.Code Key
TRNSRCTY  DIM       1                       * Transfer Source Ref.Type
TRNSRCFT  DIM       1                       * Transfer Source From/To
TRNSRCCO  DIM       2                       * Transfer Source Returned Code
TSTREFNO  DIM       8
TSTURNO   DIM       8
.
CURRDATE  DIM       8                                                 *I-209439
CURMOHNO  DIM       8                       * current Referral for MOH*I-213741
CURPRINO  DIM       8                       * current Primary Ref.    *I-213741
CURREFNO  DIM       8                       * was XADMNO              *C-199247
CURRSTAT  FORM      1                                                 *I-203923
DIAREFNO  DIM       8                       * Diags version of CURREFNO
SAVREFNO  DIM       8
EXTRTIME  DIM       8                       * Extract Start time      *I-209439
XHOSPID   DIM       8
LASTRDDT  DIM       8
LASTRDTM  DIM       8
LASTRDVS  DIM       8
LASTRDST  FORM      1      * Previous Deleted/Excluded Ref Never sent indicator
.
.Referral Discharge (RD) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXRDFVER  DIM       3      File Version
XXRDRFID  DIM      20      Referral ID
XXRDSORG  DIM       8      Submitting Org.ID
XXRDORID  DIM       8      Organisation ID
XXRDOTYP  DIM       3      Organisation Type
XXRDFDAT  DIM      19      Extract From Date
XXRDTDAT  DIM      19      Extract To Date
XXRDDELT  DIM       7      Deleted flag
XXRDTEAM  DIM       6      Team Code
XXRDEHCU  DIM       8      Event HCU ID
XXRDPSEX  DIM       1      Sex (M,F,U or I)
XXRDPDOB  DIM      10      Date of Birth
XXRDRFFR  DIM       2      Referral from
XXRDRFTO  DIM       2      Referral to
XXRDECOD  DIM       2      Referral End Code
XXRDRSTR  DIM      19      Referral Start Date Time
XXRDREND  DIM      19      Referral End Date Time
.                  156
.
. Activity (AT) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXATRFID  DIM      20      Referral ID
XXATACID  DIM      20      Activity ID
XXATATYP  DIM       3      Activity Type
XXATASET  DIM       2      Activity Setting
XXATFAMW  DIM       1      Family/Whanau Involvement 1=Yes 2=No
XXATWCPN  DIM       6      Healthcare Worker CPN
XXATSDAT  DIM      19      Start Date Time
XXATEDAT  DIM      19      End Date Time
.                  90
.
.Classification (CN) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXCNEVID  DIM      20      Event ID
XXCNCSCD  DIM      20      Classification Code ID
XXCNCSYS  DIM       2      Clinical Coding System ID
XXCNDTYP  DIM       1      Diagnosis Type
XXCNCCOD  DIM       8      Clinical Code Value
XXCNICID  DIM       2      Issue Coding System ID
XXCNITYP  DIM       1      Issue Type
XXCNIVAL  DIM       8      Issue Code Value
XXCNSDAT  DIM      19      Start Date Time
XXCNEDAT  DIM      19      End Date Time
.                  100
.
.Collection Occasion (CO) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXCOEVID  DIM      20      Event ID
XXCOCCOD  DIM      20      Collection Occasion ID
XXCORCOL  DIM       4      Reason for Collection
XXCOCDAT  DIM      19      Collection Occasion Date
XXCOWCPN  DIM       6      Healtcare Worker CPN
XXCOOESP  DIM       9      Outcome Episode ID
XXCOPVER  DIM       4      Protocol Version
XXCOFCAR  DIM       4      Focus of Care
.                  86
.
.Outcome Tool (OT) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXOTEVID  DIM      20      Event ID
XXOTOITM  DIM       3      Outcome Item Code             ... not wanted
XXOTTYPE  DIM       2      Outcome Tool Type Version
XXOTMADM  DIM       4      Mode of Administration
XXOTCSTA  DIM       4      Collection Status
XXOTCDAT  DIM      19      Completion Date
.                  52
.
.Outcome Item (OI) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXOIEVID  DIM      20      Event ID
XXOIOITM  DIM       3      Outcome Item Code
XXOITYPE  DIM       2      Outcome Tool Type Version     ... not wanted
XXOIIVAL  DIM       2      Outcome Item Value
.                  27
.
.Legal Status (LS) record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXLSFVER  DIM       3      File Version
XXLSLSID  DIM      20      Legal Status ID
XXLSSORG  DIM       8      Submitting Organisation ID
XXLSORID  DIM       8      Organisation ID
XXLSFDAT  DIM      19      Extract From Date
XXLSTDAT  DIM      19      Extract To Date
XXLSDELT  DIM       7      Deleted flag
XXLSOTYP  DIM       3      Organisation Type
XXLSEHCU  DIM       8      Event HCU ID
XXLSPSEX  DIM       1      Sex
XXLSPDOB  DIM      10      Date of Birth (CCYY-MM-DD)
XXLSLSCD  DIM       2      Legal Status Code
XXLSRCPN  DIM       6      Responsible Clinician CPN
XXLSSDAT  DIM      19      Start Date Time
XXLSEDAT  DIM      19      End Date Time
.                  152
.
.Supplementary Consumer (SC) Record
. NAME     TYPE   LENGTH   DESCRIPTION
. ----     ----   ------   -----------
XXSCUNIQ  DIM      20      Unique Number
XXSCCOLD  DIM      10      Collection Date CCYY-MM-DD
XXSCWELP  DIM       1      Wellness Plan
XXSCACCM  DIM       1      Accommodation Code
XXSCEMPS  DIM       1      Employment Status
XXSCEDUC  DIM       1      Education Status
.                   34
.
.                                                                     *C-261603
XPRIMHED  IFILE   SQL,FIXED=210, KEY="U1-8,9-16,17-24,25-25,26-30,31-33"
. NAME     TYPE   LENGTH   START   DESCRIPTION
. ----     ----   ------   -----   -----------
PHORGNID  DIM       8        1     Organisation ID (pathspaf)
PHURNUMB  DIM       8        9     U/R Number
PHVISNUM  DIM       8       17     Visit Number or LS Unique Number
PHRECTYP  DIM       1       25     Record Type
.                                  0=HC, 1=RD, 2=CO, 3=OT, 4=OI, 5=AT,
.                                  6=CN, 7=SC 8=LS
PHUNQNUM  DIM       5       26     Unique Number             (was 3)  *C-261603
PHSRUNQN  DIM       3       31     Sub record Unique No. (for OT & OI only)
.                                  '  1'-'999' for OI record type, others '0'
PHSVRETY  DIM       1       34     * save field for original PHRECTYP value
PHFIELDS  DIM     170       35     Data
PHSPAR    DIM       5      205
.EOR              210
SVFIELDS  DIM     170
.
LINKREF1  IFILE   SQL, FIXED=99, KEY="U1-8,9-9,10-11,12-14"        * KEY14
LINKREF2  IFILE   SQL, FIXED=99, KEY="U23-30,1-8"                  * KEY16
LINKFNAM  DIM       8              * temp file name "meh16a--"
.
. NAME     TYPE   LENGTH   START   DESCRIPTION
. ----     ----   ------   -----   -----------
LINKPVIS  DIM       8        1     Primary Visit No.
LINKRFTY  DIM       1        9     Referral Type (1=Primary, 2=Linked)
LINKTMID  DIM       2       10     Team Id. (1=Team Id. for Primary)
LINKUNIQ  DIM       3       12     Unique No. to stop duplicates 
LINKMOHV  DIM       8       15     Visit no. sent to MoH
LINKVISN  DIM       8       23     Linked Visit No (Primary if Ref.Type = " 1")
LINKDEPT  DIM       3       31     Associated Department (Primary or Linked)
LINKCAST  DIM      10       34     Case team
LINKRDAT  DIM       8       44     Referral Date
LINKRTIM  DIM       8       52     Referral Time
LINKATDT  DIM       8       60     Encounter Date (1st)
LINKATTM  DIM       8       68     Encounter Time (1st)
LINKEDAT  DIM       8       76     End Date
LINKETIM  DIM       8       84     End Time
LINKRDYN  DIM       1       92     RDs Found ( = No, 1 = Yes)
LINKATYN  DIM       1       92     ATs Found ( = No, 1 = Yes)
LINKCOYN  DIM       1       93     COs Found ( = No, 1 = Yes)
LINKSTAT  DIM       1       94
LINKSPAR  DIM       4       95
.                  e-o-r    99
.
CATTL     INIT      "TL"                                              *I-203401
LANSS     INIT      "s"
CATdh     INIT      "dh"
CAThp     INIT      "hp"                                              *T0858390
COLN      INIT      ":"
DSH       INIT      "-"
SLSH      INIT      "/"
SP13      INIT      "             "
SP19      INIT      "                   "
SP26      INIT      "                          "
NSTRTTIM  INIT      "00:00:00"
NENDTIME  INIT      "23:59:59"
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
.******************************************************************************
PRGID     INIT      "IBAMEH16"
PRGNAM    INIT      "PRIMHD Extract"
VERSION   INIT      "V12.01.00"
.******************************************************************************
.*                              MAINLINE                                  *
.*                            Controlling Logic                           *
.******************************************************************************
ML0000    MOVE      ZERO,EXIT
.
          CALL      INIT0000           * initialization and open files
          BRANCH    EXIT,ML9999
.
ML0100    CALL      OPTN0000           * get select or print option
          BRANCH    OPTION,ML1000,ML1000
          GOTO      ML9999
.
ML1000    CALL      KDAT0000           * Keyin date range
          BRANCH    EXIT,ML0100
.
          CALL      KHBD0000           * Keyin DHB code
          BRANCH    EXIT,ML0100,ML0100
.
....      CALL      KHOS0000           * Keyin hospital
....      BRANCH    EXIT,ML0100
.
.                   ******** Testing Option only *****
          IF        OPTION=2
            CALL      KEYVIS00
            CALL      KEYURN00
          ENDIF
.                   ******** end Testing Option *****
.
          CALL      CONTQST            * Ok to continue ?
          BRANCH    CEXIT,ML2000:      * yes
                          ML0100:      * no
                          ML9999       * cancel
.
ML2000    IF        SERIOUS = 1
            CALL      KILL0000         * Serious error
            GOTO      ML9999
          ENDIF
.
          CALL      PEXTR000           * Process Extraction
          CALL      PRIMHDXT           * create PRINTHD XML files
          IF        OPTION <> 2
            CALL      KILL0000         * Delete tempfile
          ENDIF
          GOTO      ML0100
.
ML9999    CHAIN     PGM                * chain back to program
+
.******************************************************************************
.*                             INIT0000                                  *
.*                 Display screen header and open files                  *
.******************************************************************************
.
INIT0000  CALL      DISPHEAD
.
          DISPLAY   *P56:24,"Opening patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"mehlegaf";
          OPEN      MEHLEGA2,"mehlegaf"
.
          DISPLAY   *P64:24,"mehhonaf";
          OPEN      MEHHONA3,"mehhonaf"
.
          DISPLAY   *P64:24,"mehscraf";
          OPEN      MEHSCRA1,"mehscraf"
.
          DISPLAY   *P64:24,"mehdiaaf";
          OPEN      MEHDIAA1,"mehdiaaf"
.
          DISPLAY   *P64:24,"mehvi1af";
          OPEN      MEHVI1A1,"mehvi1af"
.
          DISPLAY   *P64:24,"nhimasaf";
          OPEN      NHIMASA2,"nhimasaf"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patecdaf";
          OPEN      PATECDA1,"patecdaf"
.
          DISPLAY   *P64:24,"patecoaf";
          OPEN      PATECOA1,"patecoaf"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patunaaf";
          OPEN      PATUNAA3,"patunaaf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"patdadaf";
          OPEN      PATDADA1,"patdadaf"
.
          DISPLAY   *P64:24,"patvadaf";
          OPEN      PATVADA1,"patvadaf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"alldadaf";
          OPEN      ALLDADA1,"alldadaf"
.
....      DISPLAY   *P64:24,"mehaudda";
....      OPEN      MEHAUDDB,"mehaudda"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          DISPLAY   *P56:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          DISPLAY   *P56:24,"outcliaf";
          OPEN      OUTCLIA1,"outcliaf"
.
          DISPLAY   *P56:24,"allcasaf";
          OPEN      ALLCASA1,"allcasaf"
.
          DISPLAY   *P56:24,"allrefaf";
          OPEN      ALLREFA1,"allrefaf"                               *I-213741
          OPEN      ALLREFA4,"allrefaf"
.
          DISPLAY   *P56:24,"allrsaaf";
          OPEN      ALLRSAA2,"allrsaaf"     
.
          DISPLAY   *P56:24,"allencaf";
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLENCA6,"allencaf"                               *I-200174
          OPEN      ALLENCA7,"allencaf"
.
          DISPLAY   *P56:24,"allgpaaf";
          OPEN      ALLGPAA2,"allgpaaf"
.
          DISPLAY   *P56:24,"alllnkaf";
          OPEN      ALLLNKA1,"alllnkaf"
.
          DISPLAY   *P56:24,"allrlnaf";                               *I-190693
          OPEN      ALLRLNA1,"allrlnaf"                               *I-213741
          OPEN      ALLRLNA2,"allrlnaf"
.
          DISPLAY   *P56:24,"alldepaf";
          OPEN      ALLDEPA1,"alldepaf"
.
          DISPLAY   *P56:24,"allseraf";
          OPEN      ALLSERA1,"allseraf"
.
          DISPLAY   *P56:24,"allgreaf";
          OPEN      ALLGREA1,"allgreaf"
.
          DISPLAY   *P56:24,"mehdlsaf";
          OPEN      MEHDLSA1,"mehdlsaf"
.
          DISPLAY   *P56:24,"mehhlsaf";
          OPEN      MEHHLSA1,"mehhlsaf"
.
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHDS1A1,"mehds1af"
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P56:24,"mehprdaf";
          OPEN      MEHPRDA1,"mehprdaf"
          OPEN      MEHPRDA2,"mehprdaf"
          OPEN      MEHPATA1,"mehpataf"
          OPEN      MEHPCNA1,"mehpcnaf"
          OPEN      MEHPCOA1,"mehpcoaf"
          OPEN      MEHPOIA1,"mehpoiaf"
          OPEN      MEHPLSA1,"mehplsaf"
          OPEN      MEHPTFA1,"mehptfaf"
          OPEN      MEHPCSA1,"mehpcsaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,SIXTY9;*102,MHCNPHED,*103,MHCNPHVR:
..........                          *111,MHCNORID,*119,MHCNOTYP:      *C-0833934
                                    *119,MHCNOTYP:
                                    *137,MHCNEDIR,*187,MHCNELIV:
                                    *188,MHCNIPAT:                    *I-256500
                                    *192,MHCNRDHB                     *T0856086
.
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND12;*239,PTCNGDV6
          READ      CONTROLF,HUND10;*61,PTCNGDV7,*69,PTCNGDV8:        *I-284420
                                    *77,PTCNGDV9,*85,PTCNGDVX         *I-0833093
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,HUND28;*231,PTCNGDX2                     *I-0917793
          READ      CONTROLF,HUND30;*86,PTCNGDX3                      *I-0956210
.
..........MOVE      MHCNORID,XHOSPID     * set Hospital Id. (default) *C-0833934
.
INIT9999  RETURN
+
.******************************************************************************
.                     Check Correct Files are Open for System
.******************************************************************************
OUTFIL00  MOVE      "out",CFILEPRE
          MOVE      ALLNSITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE          * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE        * Save Current File Prefix
          ENDIF
.
          PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
.                                                                     *I-195060
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL80  DISPLAY   *P1:24,*EL,"Invalid Web User ID"
          MOVE      ONE,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  DISPLAY   *P1:24,*EL,"Outpatient Site Invalid"
          MOVE      ONE,EXIT
OUTFIL99  RETURN
+
.******************************************************************************
.*                            OPTN0000                                        *
.*                  Main Option Screen for Web                                *
.******************************************************************************
.
OPTN0000  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Generate PRIMHD Extract":
                    *P1:6,*V2LON,"2",*HOFF," = Programmer testing only ":
                          "- Generate PRIMHD Extract":
                    *P1:8,"Select Option : ";
.
OPTN1000  KEYIN     *P17:8,*DV,UNDLN1,*P17:8,*V2LON,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      OPTN9000 IF EQUAL
.
          BRANCH    OPTION,OPTN9999,OPTN9999
          BEEP
          GOTO      OPTN1000
.
OPTN9000  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.******************************************************************************
.         Keyin range of dates                                                *
.******************************************************************************
KDAT0000  MOVE      ZERO,EXIT
          MOVE      "26",CCOL
          MOVE      "10",CVERT
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY
.
          DISPLAY   *P1:10,*EL,"From Date: ":
                    *P1:11,*EL,"  To Date: ";
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT9000
.
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
.
          MOVE      "26",CCOL
          MOVE      "11",CVERT
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY
.
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT0000
.
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          MATCH     "20080701",STRTDATE     * Referral date < 01/07/2008
          IF        @LESS
            MOVE      "20080701",STRTDATE   * Start date no less than 01/07/2008
          ENDIF
.
          GOTO      KDAT9999
.
KDAT9000  MOVE      ONE,EXIT
.
KDAT9999  RETURN
+
.******************************************************************************
.*                           KHBD0000                 Called by: ML0000       *
.*                  Keyin District Health Board code (Cat dh)                 *
.******************************************************************************
KHBD0000  MOVE      ZERO,EXIT
          MOVE      SP4,DHBEQUIV
          MOVE      SP70,SAVDHBCD                                     *T0856086
          MOVE      SP70,SAVFWIDT
          DISPLAY   *P1:14,*EF,"Enter District Health Board : ",SP30
          MOVE      "31",ECOL
          MOVE      "14",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP70,CKYIDEF3
          PACK      CODE,CATdh
          DISPLAY   *PECOL:EVERT,SP6
.
          CALL      PATCODKY
          BRANCH    EXIT,KHBD9100,KHBD9200
.
          DISPLAY   *PECOL:EVERT,*V2LON,THCSCOD,*HOFF,*P36:EVERT,TDESC
          PACK      DHBEQUIV,THCSCOD
.
          PACK      SAVDHBCD,ACODE,SP70      * Save keyed in DHB code *T0856086
          PACK      SAVSSORG,PTCDUDF3,SP70   * Save Submitting Org Id *C-0833934
          PACK      SAVFWIDT,PTCDUDF7,SP70   * Save date recording FWI (0913784)
          MATCH     SP70,SAVFWIDT
          IF        @EQUAL
            MOVE      "20210701",SAVFWIDT    * default date for FWI (0913784)
          ENDIF
.
.         KEYIN     *P1:14,*EF,"Enter District Health Board : ":
.                   *V2LON,DHBEQUIV
.
.         PACK      DHBEQUIV,DHBEQUIV,SP4
.         MATCH     SP4,DHBEQUIV
.         GOTO      KHBD9100 IF EQUAL
.
KHBD9000  MOVE      ZERO,EXIT
          GOTO      KHBD9999
.
KHBD9100  MOVE      ONE,EXIT
          GOTO      KHBD9999
.
KHBD9200  MOVE      TWO,EXIT
          GOTO      KHBD9999
.
KHBD9999  RETURN
+
.******************************************************************************
.*                                  KHOS0000              Called by: ML0000   *
.*                            Enter The hospital                              *
.*    ---------------------------- obsolete ------------------------------    *
.******************************************************************************
KHOS0000  COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          DISPLAY   *P1:14,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      "14",EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,PTHSHOSP
          MOVE      ZERO,EXIT
.
KHOS3000  CLOSE     PATHSPA1
.
          DISPLAY   *P20:14,*V2LON,PTHSNAME;
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN
+
.******************************************************************************
.*                            KEYVIS00                                        *
.*            Testing Option - Keyin a Visit or Referral No.                  *
.******************************************************************************
KEYVIS00  MOVE      ZERO,EXIT
          MOVE      SP8,TSTREFNO
          DISPLAY   *P1:16,"Visit or Referral No. : ":
                    *P40:16,"(press Enter for 'All')";
          KEYIN     *P25:16,FORM8;
.
          IF        FORM8 = 0
            DISPLAY   *P25:16,*V2LON,"All     ";
          ELSE
            MOVE      FORM8,TSTREFNO
            DISPLAY   *P25:16,*V2LON,TSTREFNO;
          ENDIF
.
KEYVIS99  RETURN
+
.******************************************************************************
.*                            KEYURN00                                        *
.*            Testing Option - Keyin a UR No. for "LS" testing                *
.******************************************************************************
KEYURN00  MOVE      ZERO,EXIT
          MOVE      SP8,TSTURNO
          DISPLAY   *P1:18,"UR No. for 'LS' test  : ";
          KEYIN     *P25:18,TSTURNO;
.
          PACK      KEY8,TSTURNO,SP10
          MATCH     SP8,KEY8
          IF        @EQUAL
            DISPLAY   *P25:18,*V2LON,"All     ";
            MOVE      KEY8,TSTURNO
          ELSE
            CALL      RJUS0000
            MOVE      KEY10,TSTURNO
            DISPLAY   *P25:18,*V2LON,TSTURNO;
          ENDIF
.
KEYURN99  RETURN
+
.******************************************************************************
.*                                  RJUS0000                                  *
.*                         Right Justify a UR Number                          *
.******************************************************************************
RJUS0000  MOVE      SP70,KEY10
          SQUEEZE   KEY8
          IF        @EOS
            MOVE      "0",KEY8
          ENDIF
          MOVELPTR  KEY8,LENIN
          MOVE      "8",LENOUT
          COMPARE   LENIN,LENOUT
          IF        @EQUAL
            MOVE      KEY8,KEY10
            GOTO      RJUS9999
          ENDIF
.
          SUB       LENIN,LENOUT
          SUB       ONE,LENOUT
          BUMP      KEY10,LENOUT
          APPEND    KEY8,KEY10
          RESET     KEY10
.
RJUS9999  RETURN
+
.******************************************************************************
.*                                  CALEND00                                  *
.*                            Calculate AT End Time                           *
.******************************************************************************
CALEND00  UNPACK    CALSTTIM,CALHH,KEY1,CALMM,KEY1,CALSS
          MOVE      ZERO,F2H
          MOVE      ZERO,F2M
          MOVE      CALHH,F2H
          MOVE      CALMM,F2M
          ASSIGN    (F2H*60) + F2M,CALMINS  * convert Hours & Mins to Minutes
.
          MOVE      ZERO,FORM6
          SQUEEZE   CALDURAT
          MOVE      CALDURAT,FORM6
          ADD       FORM6,CALMINS           * add the Duration
.
          MOVE      ZERO,F2H
          MOVE      ZERO,F2M
          ASSIGN    (CALMINS/60),F2H        * get the Hours
          ASSIGN    CALMINS - (F2H*60),F2M  * get the Minutes
.
          IF        F2H > 23
            MOVE      NENDTIME,CALENTIM
          ELSE
            MOVE      "59",KEY2
            PACK      CALSS,CALSS,KEY2
            PACK      CALENTIM,F2H,COLN,F2M,COLN,CALSS
            REP       " 0",CALENTIM
          ENDIF
.
CALEND99  RETURN
.
.******************************************************************************
.*                                    PEXTR000                                *
.*                              Perform the Extraction                        *
.******************************************************************************
PEXTR000  OPEN      PATHSPA1,"pathspaf"
          DISPLAY   *P51:2,*V2LON,"- PRIMHD ",*P1:3,*EF;
.
.                                           * set Extract Date/Time   *I-209439
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          PACK      EXTRTIME,CTIMEIS,SP10                      * end  *I-209439
.
          MOVE      "60",CLNO
          CALL      CREA0000                * Create temp files
.                                                            * start  *I-213741
          CALL      ILNK0000                * Identify MH Linked Referrals
          CALL      PLNK0000                * Process MH Linked Referrals
          CALL      PREF0000                * Process Referral
          CALL      INPT0000                * Process Inpatients
          CALL      LGST0000                * Process Legal Status
          CALL      UPXT0000                * Update date/time of Extract
.
PEXTR999  RETURN
+
.******************************************************************************
.*                           CHKDHB00                                         *
.*        Validates if the Referral's preferred hospital District Health      *
.*        Board (HDP Default) matches that of the DHB keyed in earlier.       *
.******************************************************************************
CHKDHB00  MOVE      ZERO,EXIT
          MATCH     SP70,ALREHOSN           * preferred hospital filled in ?
          GOTO      CHKDHB91 IF EQUAL       * no; invalid
.
          PACK      KEY3,ALREHOSN,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKDHB91
.
          MATCH     SP70,PTHSHDHB           * District Health Board setup?
          GOTO      CHKDHB91 IF EQUAL       * no; invalid
.
          PACK      KEY5,CATdh,PTHSHDHB,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDHB91
.
          MATCH     DHBEQUIV,THCSCOD        * matching HDP Default?
          GOTO      CHKDHB91 IF NOT EQUAL   * no; invalid

          GOTO      CHKDHB99
.
CHKDHB91  MOVE      ONE,EXIT                * doesn't match
CHKDHB99  RETURN
+
.******************************************************************************
.*                                    ILNK0000                      *I-213741 * 
.*                            Identify MH Linked Referrals                    *
.******************************************************************************
ILNK0000  MOVE      ZERO,EXIT
          MOVE      ZERO,TESTNO
          MOVE      ZERO,FORM3
          MOVE      ZERO,REFTMCNT
          MOVE      ZERO,REFCOUNT
          CALL      ILWR0000                * clear internal table
          UNPACK    SP70,CURPRINO,CURREFNO,CURMOHNO
          MOVE      ZERO,BYPASSIT
.
          DISPLAY   *P1:24,"Creating Linked Referral Table - ";
          PACK      KEY16,SP20
          CALL      RSALRLN1
ILNK1000  CALL      RKALRLN1
          BRANCH    OVRCD,ILNK9000 
.
          MATCH     CURPRINO,ALRLVISN       * same Primary Referral ?
          IF        @EQUAL
            BRANCH    BYPASSIT,ILNK1000     * check if this Referral is wanted
            GOTO      ILNK4000              * continue with current linked Ref.
          ENDIF
.
          COMPARE   ZERO,REFCOUNT
          CALL      ILWR0000 IF NOT EQUAL   * write out previous data to temp
.
.
.                                  ******** * start next group of Linked Referls
.                                           * Process New Primary referral
ILNK2000  MOVE      ZERO,BYPASSIT
.                                           ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     SP8,TSTREFNO
            GOTO      ILNK2500 IF EQUAL
            MATCH     TSTREFNO,ALRLVISN
            IF        @EQUAL
              MOVE      ONE,TESTNO
              GOTO      ILNK2500
            ENDIF
            COMPARE   ZERO,TESTNO
            GOTO      ILNK1000 IF EQUAL
            COMPARE   TWO,TESTNO
            GOTO      ILNK1000 IF EQUAL
            IF        TESTNO = 1
              ADD       ONE,TESTNO          * second Primary - drop thru
            ENDIF
          ENDIF                             ******** end Testing Option *****
.
.                                           * (ALRLVISN is the primary referral)
.                                           * (ALRLLNKV is a linked referral)
.                                           * check if this Primary is required
ILNK2500  PACK      KEY8,ALRLVISN,SP8
          CALL      RDALREF1
          BRANCH    OVRCD,ILNK8000          * set BYPASSIT
.
          CALL      CHKDHB00                * check District Health Board match
          BRANCH    EXIT,ILNK8000           * no match; skip
.
          MATCH     "1",ALREUYN4            * is this Referral a primary ?
          GOTO      ILNK8000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * on Waiting List ?
          GOTO      ILNK8000 IF EQUAL       * bypass waiting list stuff
.
          CALL      CKDTR000                * check Date Range - uses ALREVISN
          BRANCH    EXIT,ILNK8000           * if not in date range, set BYPASSIT
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT * Check for MH Department
          CALL      RDCODE1
          BRANCH    OVRCD,ILNK8000          * set BYPASSIT
.
          MATCH     "M",TCINDC4             * is it MH ?
          GOTO      ILNK8000 IF NOT EQUAL
.
          MATCH     SP10,ALREUHC4
          GOTO      ILNK8000 IF EQUAL       * bypass Primary if no Case Team
.
          DISPLAY   *P34:24,ALREVISN," selected",*W1;
.
.                                           * set up Primary Referral info
ILNK3000  MOVE      ALREVISN,REFPRINO[1]
          MOVE      "1",REFFRFID[1]         * flag as Primary
          MOVE      " 1",REFFTMID[1]        * flag as first Team No. Id.
          MOVE      ALREVISN,REFLNKNO[1]
          MOVE      ALREVISN,REFMOHNO[1]
          MOVE      ALREDEPT,REFDEPT[1]    
          MOVE      ALREUHC4,REFTEAM[1]
          MOVE      ALRERDAT,REFRDATE[1]
          MOVE      ALREUTM6,REFRTIME[1]
.
          MOVE      FRSTATDT,REFENCDT[1]    * store first Encounter date/time
          MOVE      FRSTATTM,REFENCTM[1]
          MOVE      FOUNDREF,REFRDYN[1]
          MOVE      FOUNDAT,REFATYN[1]
          MOVE      FOUNDCO,REFCOYN[1]
          MOVE      ALRESTAT,REFSTAT[1]
.
          MATCH     SP8,LLREEDAT            * set End Date from ALRESTAT data
          IF        !@EQUAL
            MOVE      LLREEDAT,REFEDATE[1]
            MOVE      LLREETIM,REFETIME[1]
          ENDIF
.
          MOVE      ALRLVISN,CURPRINO       * set Primary Ref.no
          MOVE      ALRLVISN,CURMOHNO       * set MoH Ref.no
          MOVE      ONE,REFCOUNT            * reset Linked Referrals counter
          MOVE      ONE,REFTMCNT            * reset Team counter
.
.                                           * drop thru to create linked record
.
.                                           * read Linked Referral             
ILNK4000  PACK      KEY8,ALRLLNKV,SP8
          CALL      RDALREF1
          BRANCH    OVRCD,ILNK1000          * bypass this record if not found
.
          CALL      CHKDHB00                * check District Health Board match
          BRANCH    EXIT,ILNK1000           * no match; skip
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT * Check for MH Department
          CALL      RDCODE1
          BRANCH    OVRCD,ILNK1000          * bypass this record if no Dept.
.
          MATCH     "M",TCINDC4             * is it MH ?
          GOTO      ILNK1000 IF NOT EQUAL   * bypass this record if not MH
.
          CALL      CKDTR000                * check Date Range - uses ALREVISN
          BRANCH    EXIT,ILNK1000           * if not in date range
.
          MATCH     SP8,ALREUTM6            * "Case Start Time"
          IF        @EQUAL
            MOVE      "00:00:00",ALREUTM6   * default to "00:00:00"
          ENDIF
.                                           * check if Dept. and Case team exist
.                                           * (just in case multiple MH Depts)
          MOVE      ZERO,FOUND3
.--------*T0855163-Start - No longer needs to group by case team
.-------- commented out the following lines to bypass ILNK5200 and ILNK5400
.-------- MOVE      ONE,FORM3
.-------- REPEAT                       
.--------   MATCH     ALREDEPT,REFDEPT[FORM3]    * found same Dept
.--------   IF        @EQUAL
.--------     MATCH     ALREUHC4,REFTEAM[FORM3]  * found same team
.--------     IF        @EQUAL
.--------       MOVE      FORM3,FOUND3           * refer to this data
.--------     ENDIF
.--------   ENDIF
.--------   IF      FOUND3 = 0
.--------     ADD     ONE,FORM3             * found same Pat./Dept/Team referral
.--------   ENDIF
.-------- UNTIL     FOUND3 > 0 | FORM3 > REFCOUNT
.--------*T0855163-End
.                                           * set up for Linked referral  
ILNK5000  COMPARE   ZERO,FOUND3
          IF        @EQUAL
            MOVE      ALREVISN,CURMOHNO     * a new "send to" MoH Referral No.
            ADD       ONE,REFTMCNT
            MOVE      REFTMCNT,TEAMNOID     * set next Team Id No.
            GOTO      ILNK6000
          ENDIF
.
.
.                   ***** Dept/Team combo has been found - shuffle data around
ILNK5200  MOVE      REFMOHNO[FOUND3],CURMOHNO * set up Referral re-directs
          MOVE      REFFTMID[FOUND3],TEAMNOID
.
          MATCH     SP8,FRSTATDT            * was Ecounter found in date range?
          IF        !@EQUAL
            MATCH     SP8,REFENCDT[FOUND3]  * is Dept/Team Update date blank?
            IF        @EQUAL
              MOVE      FRSTATDT,REFENCDT[FOUND3]
              MOVE      FRSTATTM,REFENCTM[FOUND3]
              MOVE      FOUNDAT,REFATYN[FOUND3]
            ELSE
              MATCH     REFENCDT[FOUND3],FRSTATDT
              IF        @LESS
                MOVE      FRSTATDT,REFENCDT[FOUND3]
                MOVE      FRSTATTM,REFENCTM[FOUND3]
                MOVE      FOUNDAT,REFATYN[FOUND3]
              ENDIF
            ENDIF
          ENDIF
.            
.                                           * copy earlier dates back to link
          MATCH     REFRDATE[FOUND3],ALRERDAT    * check Start dates
          IF        @LESS 
.                            * if Ref.date is earlier than prev Ref., change it
            MOVE      ALRERDAT,REFRDATE[FOUND3]  
            MOVE      ALREUTM6,REFRTIME[FOUND3]  
          ELSE
            MOVE      REFRDATE[FOUND3],ALRERDAT
            MOVE      REFRTIME[FOUND3],ALREUTM6
          ENDIF
.
ILNK5400  MATCH     SP8,LLREEDAT            * check End dates
          IF        @EQUAL
            MOVE      SP8,REFEDATE[FOUND3]  * make sure MoH Ref is active
            MOVE      SP8,REFETIME[FOUND3]
            MOVE      ALRESTAT,REFSTAT[FOUND3]
          ELSE                              * End date exists on current Ref
            MATCH     SP8,REFEDATE[FOUND3]  
            IF        !@EQUAL
              MATCH     LLREEDAT,REFEDATE[FOUND3]  
              IF        @LESS
.                             * if end-date greater than prev Ref. - put it in
                MOVE      LLREEDAT,REFEDATE[FOUND3]
                MOVE      LLREETIM,REFETIME[FOUND3]
              ELSE
                MOVE      REFEDATE[FOUND3],LLREEDAT
                MOVE      REFETIME[FOUND3],LLREETIM
              ENDIF
            ENDIF
          ENDIF
.
.                                            * set up the redirect table recd
ILNK6000  MOVE      SP1,KEY1
          ADD       ONE,REFCOUNT
          COMPARE   RFCNTLIM,REFCOUNT         * reached max count of 999 ?
          IF        @EQUAL
            CALL      ERRA0000                * Serious Error - ERRA0000
            GOTO      ML2000                  * exit program
          ENDIF
.                                                * set up the sequencing data
          MOVE      CURPRINO,REFPRINO[REFCOUNT]  * Primary referral no
          MOVE      "2",REFFRFID[REFCOUNT]
          MOVE      TEAMNOID,REFFTMID[REFCOUNT]
.                                                * set up the Referral data
          MOVE      ALREVISN,REFLNKNO[REFCOUNT]  * this Linked Referral no.
.--------*T0855163-Start
.---------MOVE      CURMOHNO,REFMOHNO[REFCOUNT]  * Ref.no. to send to MoH
          MOVE      ALREVISN,REFMOHNO[REFCOUNT]  * Linked ref to send to MoH
.--------*T0855163-End
          MOVE      ALREDEPT,REFDEPT[REFCOUNT]
          MOVE      ALREUHC4,REFTEAM[REFCOUNT]
.
          MOVE      ALRERDAT,REFRDATE[REFCOUNT]  * Start Date/Time
          MOVE      ALREUTM6,REFRTIME[REFCOUNT]
.
          MOVE      ALRESTAT,REFSTAT[REFCOUNT]
.
ILNK7000  MATCH     SP8,FRSTATDT                 * first Encounter Date/time
          IF        !@EQUAL
            MOVE      FRSTATDT,REFENCDT[REFCOUNT]
            MOVE      FRSTATTM,REFENCTM[REFCOUNT]
            MOVE      FOUNDAT,REFATYN[REFCOUNT]
          ENDIF
.         
          MATCH     SP8,LLREEDAT                 * End Date/times
          IF        !@EQUAL
            MOVE      LLREEDAT,REFEDATE[REFCOUNT]
            MOVE      LLREETIM,REFETIME[REFCOUNT]
          ENDIF
. 
          GOTO      ILNK1000                * read next record
.
.
ILNK8000  MOVE      ONE,BYPASSIT            * set BYPASS flag 
          GOTO      ILNK1000
.
ILNK9000  COMPARE   ZERO,REFCOUNT
          CALL      ILWR0000 IF NOT EQUAL   * write out previous data to temp
.
ILNK9999  RETURN
+
.******************************************************************************
.*                                    ILWR0000                      *I-213741 *
.*                          Write Link Temp file records                      *
.******************************************************************************
ILWR0000  MOVE      ZERO,EXIT
          COMPARE   ZERO,REFCOUNT
          GOTO      ILWR5000 IF EQUAL
.                                           * set up temp records for linked
          MOVE      ZERO,FORM3
          REPEAT
            ADD       ONE,FORM3
            MOVE      REFPRINO[FORM3],LINKPVIS 
            MOVE      REFFRFID[FORM3],LINKRFTY     * Ref. Type
            MOVE      REFFTMID[FORM3],LINKTMID     * Team No. Id
            MOVE      FORM3,LINKUNIQ               * Unique Id.
            MOVE      REFMOHNO[FORM3],LINKMOHV     * Ref.no to be sent to MoH
            MOVE      REFLNKNO[FORM3],LINKVISN
            MOVE      REFDEPT[FORM3],LINKDEPT
            MOVE      REFTEAM[FORM3],LINKCAST
            MOVE      REFRDATE[FORM3],LINKRDAT
            MOVE      REFRTIME[FORM3],LINKRTIM
            MOVE      REFENCDT[FORM3],LINKATDT
            MOVE      REFENCTM[FORM3],LINKATTM
            MOVE      REFEDATE[FORM3],LINKEDAT
            MOVE      REFETIME[FORM3],LINKETIM
            MOVE      REFRDYN[FORM3],LINKRDYN
            MOVE      REFATYN[FORM3],LINKATYN
            MOVE      REFCOYN[FORM3],LINKCOYN
            MOVE      REFSTAT[FORM3],LINKSTAT
            PACK      LINKSPAR,SP30
.
            PACK      KEY14,LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ,SP20
            CALL      WRLREF1
          UNTIL     FORM3 = REFCOUNT
.
.                                           * set up for a new Prim. Referral
ILWR5000  MOVE      ZERO,FORM3
          REPEAT                            * initilise re-direct table
            ADD       ONE,FORM3
            MOVE      SP8,REFPRINO[FORM3]   * Primary Referral
            MOVE      SP1,REFFRFID[FORM3]
            MOVE      SP2,REFFTMID[FORM3]
            MOVE      SP8,REFMOHNO[FORM3]   * Referral No. to send to MoH
            MOVE      SP8,REFLNKNO[FORM3]   * Linked Referral
            MOVE      SP3,REFDEPT[FORM3]
            MOVE      SP10,REFTEAM[FORM3]
            MOVE      SP8,REFRDATE[FORM3]
            MOVE      SP8,REFRTIME[FORM3]
            MOVE      SP8,REFENCDT[FORM3]
            MOVE      SP8,REFENCTM[FORM3]
            MOVE      SP8,REFEDATE[FORM3]
            MOVE      SP8,REFETIME[FORM3]
            MOVE      SP8,REFRDYN[FORM3]
            MOVE      SP8,REFATYN[FORM3]
            MOVE      SP8,REFCOYN[FORM3]
            MOVE      SP8,REFSTAT[FORM3]
          UNTIL     FORM3 = 500
.
          MOVE      ZERO,REFCOUNT
.
ILWR9999  RETURN
.******************************************************************************
.*                                    PLNK0000                      *I-213741 *
.*                          Process Linked Referrals                          *
.******************************************************************************
PLNK0000  MOVE      ZERO,EXIT
          MOVE      ZERO,LASTRDVS
          DISPLAY   *P1:24,*EL,*V2LON,"Processing Linked Referrals -":
                    *BLINKON," Please Wait",*HOFF;
          MOVE      ZERO,TESTNO
          MOVE      ONE,PLNKFLAG            * set "processing links" flag
          MOVE      ZERO,PREFFLAG
.
          UNPACK    SP70,CURPRINO,CURREFNO,CURMOHNO
          MOVE      ZERO,BYPASSIT
          MOVE      ZERO,CNIDCNT            * reset CN Id. counter
.
          PACK      KEY14,SP20
          CALL      RSLREF1
PLNK1000  CALL      RKLREF1
          BRANCH    OVRCD,PLNK9999
.
.                   * start processing next MOH Linked Referrals
.                                  
.                                           * Check for change of Linked group
PLNK1500  MATCH     LINKPVIS,CURPRINO       * change of Primary Referral ?
          IF        !@EQUAL
            MOVE      ZERO,CNIDCNT          * reset CN Id. counter
            UNPACK    SP70,CURREFNO,CURMOHNO
            MOVE      LINKPVIS,CURPRINO
            PACK      XXRDDELT,SP70         * Reset deleted flag     *T0860342
          ENDIF
.
          MATCH     LINKMOHV,CURMOHNO       * check if end of MOH Referral
          IF        !@EQUAL
            MOVE      ZERO,CNIDCNT          * reset CN Id. counter
            UNPACK    SP70,MOHSDATE,MOHSTIME,LASTRDDT,LASTRDTM
            MOVE      LINKRDAT,MOHSDATE     * set the "RD" Start & End Dates
            MOVE      LINKRTIM,MOHSTIME
            MATCH     SP8,LINKEDAT
            IF        !@EQUAL
              MOVE      LINKEDAT,LASTRDDT
              MOVE      LINKETIM,LASTRDTM
            ENDIF
            MOVE      LINKRDYN,FOUNDREF
            MOVE      LINKATYN,FOUNDAT
            MOVE      LINKCOYN,FOUNDCO
            MOVE      LINKMOHV,CURMOHNO
.
            PACK      KEY3,LINKDEPT         * get Dept record for new Referral
            CALL      RDALDEP1
            BRANCH    OVRCD,PLNK1000        * Dept not found - over-kill
.
............MOVE      MHCNORID,XHOSPID      * set Hospital Id. (default)
            MOVE      SAVSSORG,XHOSPID      * Default Hosp Id       *C-0833934
            IF        IBCNMHOS=1
              MOVE      SP8,PTHSORID
              MOVE      ALDEHOSP,KEY3
              CALL      RDPTHSP1            * read hospital file
              MATCH     SP8,PTHSORID
              IF        !@EQUAL
                MOVE      PTHSORID,XHOSPID  * Organisation ID
              ENDIF
            ENDIF
          ENDIF
.
.
.                           * now start processing Referrals in the Link group
PLNK2000  PACK      KEY8,LINKVISN           
          CALL      RDALREF1
          BRANCH    OVRCD,PLNK1000
.
          MATCH     "0",ALRESTAT
          GOTO      PLNK1000 IF EQUAL       * bypass "waiting" referrals
.
.                                           * set dates as calculated in ILNK000
          MOVE      MOHSDATE,ALRERDAT
          MOVE      MOHSTIME,ALREUTM6
.-------- MOVE      LINKSTAT,ALRESTAT       * CAR 301904
.
.-------- T0867829-Start
.-------- If current referral status is closed but linkstat has been set to
.-------- active then use LINKSTAT
          MATCH     "2",ALRESTAT           * Actual ref status is closed
          IF        @EQUAL
            MATCH     "1",LINKSTAT         * Ref status on tmp tbl set to active
            IF        @EQUAL
               MOVE      LINKSTAT,ALRESTAT * Use LINKSTAT
            ENDIF
          ENDIF
.-------- T0867829-end
.                                           * fix the end dates if needed
.........*T0864712-start - removed closed date/time overwrite
......... MATCH     "2",ALRESTAT            * "Closed"
......... IF        @EQUAL
.........   MOVE      LASTRDDT,ALREDCLO     * make end date later
.........   MOVE      LASTRDTM,ALRETCLO
......... ENDIF
.........*T0864712-end
.
.-------- T0867829-start
.-------- Use LASTRDDT if available otherwise use the actual closed date/time
          MATCH     "2",ALRESTAT            * "Closed"
          IF        @EQUAL
            MATCH     SP8,LASTRDDT
            IF        !@EQUAL
              MOVE      LASTRDDT,ALREDCLO   * make end date later
              MOVE      LASTRDTM,ALRETCLO
            ENDIF
          ENDIF
.-------- T0867829-end
.
          MATCH     "3",ALRESTAT            * "Inactive"
          IF        @EQUAL
            MOVE      LASTRDDT,ALREDINA     * make end date later
            MOVE      LASTRDTM,ALRETINA
          ENDIF
.
.........*C-0837897 - start - removed cancelled date/time overwrite
......... MATCH     "4",ALRESTAT            * "Cancelled"
......... IF        @EQUAL
.........   MOVE      LASTRDDT,ALREDCAN     * make end date later
.........   MOVE      LASTRDTM,ALRETCAN
......... ENDIF
.........*C-0837897 - end
.
.--------*T0860342 start - if the cancelled referral has not been previously
.-------- sent to MoH then bypass this cancelled referral
          MATCH     "4",ALRESTAT             * "Cancelled"
          IF        @EQUAL
            PACK      KEY19,ALREVISN,SP20
            CALL      RSMHPRD2               * Reads PRIMHD Transmission RD
            CALL      RKMHPRD2               * record file
            MATCH     ALREVISN,MHPDVISN      * Is this cancelled ref prev sent?
            GOTO      PLNK1000 IF NOT EQUAL  * No, bypass this cancelled ref
          ENDIF
.--------*T0860342 end
.
          MATCH     "5",ALRESTAT            * "Rejected"
          IF        @EQUAL
            MOVE      LASTRDDT,ALRESRDT     * make end date later
            MOVE      LASTRDTM,ALRESRTM
          ENDIF
.
.                   ********************** Date check *************************
.                                           * check Date Range - uses ALREVISN
PLNK2400  CALL      CKDTR000                * also checks for AT and CO
          BRANCH    EXIT,PLNK1000           * bypass if not in date range
.
.--------*T0855163-Start: Do not create an RD if no reportable activity
          COMPARE   ZERO,ATEXISTS           * No activity exists
          GOTO      PLNK1000 IF EQUAL       * Skip, read next record
.--------*T0855163-End
.
          MOVE      LINKRDYN,FOUNDREF       * replace RD,AT & CO flags with Link
          MOVE      LINKATYN,FOUNDAT
          MOVE      LINKCOYN,FOUNDCO
.                                                                     *C-258616
          IF        FOUNDREF = 0 & FOUNDAT = 0 & FOUNDCO = 0
            GOTO      PLNK1000            * no action in Date Range - don't send
          ENDIF
.
.--------*T0866101-Start: Do not create an RD if no related activity 
.-------- (child records AT,CN,CO,OT,OI,SCR) attached
.--------  and in addition for T0855163, if the referral is not cancelled 
          IF        FOUNDREF = 1 & FOUNDAT = 0 & FOUNDCO = 0
            MATCH     "4",ALRESTAT          * Referral is cancelled
            GOTO      PLNK1000 IF NOT EQUAL * No,skip, read next record
          ENDIF
.--------*T0866101-End
.
          MATCH     SP8,LINKATDT            * check first Encounter Date
          IF        !@EQUAL
            MOVE      LINKATDT,FRSTATDT     * restore First AT date/time
            MOVE      LINKATTM,FRSTATTM
          ENDIF
.
PLNK3000  MATCH     ALREURNO,PURNO          * check if already have UR No.    
          GOTO      PLNK4000 IF EQUAL
.
          MOVE      ALREURNO,PURNO          * read Patient Master & NHI Master
          MOVE      ALREURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      ALREURNO,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
.                                           * create extract records
PLNK4000  MOVE      LINKMOHV,CURMOHNO       * store base info from Referral
          MOVE      ALREVISN,CURREFNO       *
          MOVE      ALRESTAT,CURRSTAT
.
.........*C-0837897 - start
......... MATCH     LINKMOHV,LASTRDVS
......... IF        @EQUAL
.........                                   * create "RD" (if reqd by MoH)
.........   MATCH     LINKMOHV,LINKVISN     * is this referral going to MoH ?
.........   GOTO      PLNK5000 IF NOT EQUAL * if no - don't create another "RD"
......... ENDIF
.
          MATCH     LINKMOHV,LASTRDVS       * Same as last RD record?
          GOTO      PLNK4100 IF NOT EQUAL   * No, create "RD" record
.
          MATCH     LINKMOHV,LINKVISN       * Is this referral going to MoH ?
          GOTO      PLNK4100 IF EQUAL       * Yes, create "RD" record
.
.------- T0875371 - Is this a linked referral with a case team that has a 
.------- status of 'Active - exclude from PRIMHD' then bypass this referral
          COMPARE   ONE,EXLRDACT            * Is prev RD excluded?  
          GOTO      PLNK1000 IF EQUAL       * Yes,read next record

.        *C-0851539 - check previously deleted/excluded referral
          COMPARE   ONE,LASTRDST            * Is prev deleted ref never sent?
          GOTO      PLNK5000 IF EQUAL       * Yes, do not create another "RD"
.
          MATCH     "DELETED",XXRDDELT      * Is prev deleted ref sent?
          GOTO      PLNK4100 IF EQUAL       * Yes, create another "RD"
          GOTO      PLNK5000 IF NOT EQUAL   * No, do not create another "RD"
.
PLNK4100  PACK      XXRDDELT,SP70           * Reset deleted flag *T0860342
          MATCH     SP8,ALREUTM6            * "Case Start Time"  *C-0837897-end
          IF        @EQUAL
            MOVE      "00:00:00",ALREUTM6   * default to "00:00:00"
          ENDIF
.
          MOVE      ZERO,LASTRDST           * Reset flag             *C-0851539
          CALL      RDRF0000                * set up "RD" record from Referral
......... *C-0837897 - start
......... BRANCH    EXIT,PLNK1000           * Exit=1 - Deleted Ref. never sent
          IF        EXIT = 1
            MOVE    ONE,LASTRDST      * Flaged deleted Ref never sent*C-0851539
            GOTO    PLNK1000                * Deleted Ref. never sent
          ENDIF
......... *C-0837897 - end
.
          CALL      SUPC0000                * Process Supp Consumer- "SC" record
.                                           * Process all Encounter types
PLNK5000  MOVE      ZERO,F1
          CALL      PENC0000                * Process Encounter - AT record
          CALL      PGRC0000                * Process Group Contact - AT record
          CALL      PLOP0000                * Process OP Attendance - AT record
.
PLNK6000  COMPARE   ONE,ATEXISTS            * don't write any "CN"s if no "AT"
          GOTO      PLNK7000 IF NOT EQUAL
.                                           * set up data for "CN" record
          MATCH     LINKMOHV,LINKVISN       * is this a new MoH Referral ?
          IF        @EQUAL
            CALL      BDATS000              * build MEHDIA End Dates table
          ENDIF
.
          MATCH     ALREVISN,CURMOHNO       * process "CN"s for CURMOHNO
          IF        @EQUAL
            CALL      PCOD0000              * Diagnosis Prov.Coding - "CN" recd
          ENDIF
.
.--------*T0855163-Start - Get relevant HONOS records for the referral and
.-------- if not a primary referral then also check primary referral for
.-------- HONOS records
          MATCH     CURPRINO,CURREFNO       * It's a Primary referral
          GOTO      PLNK7000 IF EQUAL        * Process COs
.
.-------- It's a Linked referral
          MOVE      ZERO,KEY1
          CALL      HONS0000                 * Process COs for linked ref
.
          MOVE      CURPRINO,CURREFNO       * Use primary referal
          GOTO      PLNK7000                 * Process COs for primary ref
.--------*T0855613-End
.
PLNK7000  MOVE      ZERO,KEY1
          CALL      HONS0000                * Process HONOS Assess.- "CO" record
.
          GOTO      PLNK1000
.
PLNK9999  MOVE      ZERO,PLNKFLAG
          RETURN
+
.******************************************************************************
.*                                    PREF0000                                *
.*                               Process referrals                            *
.******************************************************************************
PREF0000  MOVE      ZERO,EXIT
          DISPLAY   *P1:24,*EL,*V2LON,"Processing Referrals -":
                    *BLINKON," Please Wait",*HOFF;
          MOVE      ZERO,PLNKFLAG           * don't set up for linked referrals
          MOVE      ONE,PREFFLAG
.
          MOVE      SP70,KEY3
          CALL      RSALDEP1
PREF1000  CALL      RKALDEP1
          BRANCH    OVRCD,PREF9999
.
          PACK      KEY5,ANSC,ANSG,ALDEDEPT * Check for MH Department
          CALL      RDCODE1
          BRANCH    OVRCD,PREF1000
.
          MATCH     "M",TCINDC4             * is it MH ?
          GOTO      PREF1000 IF NOT EQUAL
.
..........MOVE      MHCNORID,XHOSPID        * set Hospital Id. (default)
          MOVE      SAVSSORG,XHOSPID        * Default Hosp Id        *C-0833934
          IF        IBCNMHOS=1
            MOVE      SP8,PTHSORID
            MOVE      ALDEHOSP,KEY3
            CALL      RDPTHSP1              * read hospital file
            MATCH     SP8,PTHSORID
            IF        !@EQUAL
              MOVE      PTHSORID,XHOSPID  * Organisation ID
            ENDIF
          ENDIF
.
.                                 * Read through Referrals for selected Dept.
.                                 * (in Dept/Status sequence - 1 to 5)
PREF2000  MOVE      ZERO,F1
          MOVE      "1",RSTATUS
.
          PACK      KEY22,ALDEDEPT,RSTATUS,SP70
          CALL      RSALREF4
PREF3000  MOVE      ZERO,EXIT
          CALL      RKALREF4                * read next Referral
          BRANCH    OVRCD,PREF1000          * read the next Department
.
          CALL      CHKDHB00                * check District Health Board match
          BRANCH    EXIT,PREF3000           * no match; skip
.
.                                           ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     SP8,TSTREFNO
            GOTO      PREF3500 IF EQUAL
            MATCH     TSTREFNO,ALREVISN
            GOTO      PREF3000 IF NOT EQUAL
          ENDIF                             ******** end Testing Option *****
.
.                                                            * start  *I-213741
PREF3500  PACK      KEY16,ALREVISN,SP8
          CALL      RSLREF2                 * check if record is in link table
          CALL      RKLREF2
          BRANCH    OVRCD,PREF3700
          MATCH     ALREVISN,LINKVISN
          GOTO      PREF3000 IF EQUAL       * if yes, bypass - already processed
.                                                            * end    *I-213741
.
PREF3700  MATCH     ALDEDEPT,ALREDEPT       * Same department?
          GOTO      PREF1000 IF NOT EQUAL
.
.--------*T0860342 start - if the cancelled referral has not been previously
.-------- sent to MoH then bypass this cancelled referral
          MATCH     "4",ALRESTAT             * "Cancelled"
          IF        @EQUAL
            PACK      KEY19,ALREVISN,SP20
            CALL      RSMHPRD2               * Reads PRIMHD Transmission RD
            CALL      RKMHPRD2               * record file
            MATCH     ALREVISN,MHPDVISN      * Is this cancelled ref prev sent?
            GOTO      PREF3000 IF NOT EQUAL  * No, bypass this cancelled ref
          ENDIF
.--------*T0860342 end
.
.                                           * check Date Range - uses ALREVISN
          CALL      CKDTR000                * also checks for AT & CO
          BRANCH    EXIT,PREF3000           * return if not in date range
.
.                                           * has Referral changed ?  *I-258616
          IF        FOUNDREF = 0 & FOUNDAT = 0 & FOUNDCO = 0
            GOTO      PREF3000            * no action in Date Range - don't send
          ENDIF
.
.--------*T0866101-Start: Do not create an RD if no related activity
.-------- (child records AT,CN,CO,OT,OI,SCR) attached
.--------  and in addition for T0855163, if the referral is not cancelled 
          IF        FOUNDREF = 1 & FOUNDAT = 0 & FOUNDCO = 0
            MATCH     "4",ALRESTAT          * Referral is cancelled 
            GOTO      PREF3000 IF NOT EQUAL * No,skip, read next record
          ENDIF
.--------*T0866101-End
.
PREF4000  MOVE      ALREURNO,PURNO          * read Patient Master & NHI Master
          MOVE      ALREURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      ALREURNO,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
.                                           * create extract records
PREF5000  MOVE      ALREVISN,CURPRINO       * (flag as Primary just in case)
          MOVE      ALREVISN,CURREFNO       * Store base info from Referral
          MOVE      ALREVISN,CURMOHNO       * Ref.No sent to MOH
          MOVE      ALRESTAT,CURRSTAT       * Referral status        *T0883457
          MOVE      ZERO,CNIDCNT            * reset CN Id. counter
.
.
PREF5500  CALL      RDRF0000                * set up "RD" record from Referral
          BRANCH    EXIT,PREF3000
.
          CALL      SUPC0000                * Process Supp Consumer- "SC" record
          CALL      PENC0000                * Process Encounter - AT record
          CALL      PGRC0000                * Process Group Contact - AT record
          CALL      PLOP0000                * Process OP Attendance - AT record
.
PREF6000  COMPARE   ONE,ATEXISTS            * don't write any "CN"s if no "AT"
          GOTO      PREF7000 IF NOT EQUAL
.                                           * set up data for "CN" record
          CALL      BDATS000                * build Diagnosis Date/Time array
          CALL      PCOD0000                * Diagnosis Prov.Coding - "CN" recd
.
PREF7000  MATCH     "1",ALREUYN4            * is this Referral a primary ?
          GOTO      PREF3000 IF NOT EQUAL
.
          CALL      HONS0000                * Process HONOS Assess.- "CO" record
.
          GOTO      PREF3000
.
.
PREF9999  MOVE      ZERO,PREFFLAG
          RETURN
+
.******************************************************************************
.*                                CKDTR0000                           *I-194128
.*                       Check Date Range of Referral
.*  (new Encounters do not alter Referral Update date - check for new Enc.s)
.******************************************************************************
CKDTR000  MOVE      ZERO,EXIT
          UNPACK    SP70,EFFSDATE,EFFSTIME  * effective start date for referral
          UNPACK    SP70,EFFEDATE,EFFETIME  * effective end date for referral
          MOVE      "99999999",LLREEDAT     * equiv to ALREEDAT - Refl End Date
          MOVE      NENDTIME,LLREETIM       * equiv to ALREETIM - Refl End time
          MOVE      "99999999",FRSTATDT     * first "AT" for this Referral
          MOVE      "00:00:00",FRSTATTM
.                                           * set the "Found" flags
          MOVE      ZERO,FOUNDREF           * change in Referral status
          MOVE      ZERO,FOUNDAT
          MOVE      ZERO,FOUNDCO
          MOVE      ZERO,FOUNDCN
          MOVE      ZERO,ATEXISTS
.
          MOVE      ZERO,REFLSTAT           * FORM value for ALRESTAT
          MATCH     ALRERDAT,ENDDATE        * Referral date > End date?
          GOTO      CKDTR900 IF LESS        * if Yes, Referral not extracted
.
          MOVE      ALRESTAT,REFLSTAT
.                             Active   Closed   Inactiv  Cancel   Reject
.*C-0837897 BRANCH  REFLSTAT,CKDTR100,CKDTR020,CKDTR100,CKDTR900,CKDTR050
          BRANCH    REFLSTAT,CKDTR100,CKDTR020,CKDTR100,CKDTR040,CKDTR050
          GOTO      CKDTR900                * bypass Status "0" Waiting List
.
CKDTR020  MATCH     STRTDATE,ALREDCLO       * Date Closed
          IF        !@LESS
            MOVE      ALREDCLO,LLREEDAT     * set Referral End Date/Time
            MOVE      ALRETCLO,LLREETIM
            GOTO      CKDTR100
          ENDIF
          MATCH     SP70,ALREUDAT
          IF        !@EQUAL
            MATCH     STRTDATE,ALREUDAT
            IF        !@LESS
              MOVE      ALREDCLO,LLREEDAT     * set Referral End Date/Time
              MOVE      ALRETCLO,LLREETIM
              GOTO      CKDTR100
            ENDIF  
          ENDIF
          GOTO      CKDTR900                * Referral ended before Start Date

.
CKDTR040  MATCH     STRTDATE,ALREDCAN       * Date Cancelled
          IF        !@LESS
            MOVE      ALREDCAN,LLREEDAT     * set Referral End Date/Time
            MOVE      ALRETCAN,LLREETIM
            GOTO      CKDTR100
          ENDIF
          MATCH     SP70,ALREUDAT
          IF        !@EQUAL
            MATCH     STRTDATE,ALREUDAT
            IF        !@LESS
              MOVE      ALREDCAN,LLREEDAT     * set Referral End Date/Time
              MOVE      ALRETCAN,LLREETIM
              GOTO      CKDTR100
            ENDIF  
          ENDIF
          GOTO      CKDTR900                * Ref'l cancelled before Start date
.
CKDTR050  MATCH     STRTDATE,ALRESRDT       * Date Rejected
          IF        !@LESS
            MOVE      ALRESRDT,LLREEDAT     * set Referral End Date/Time
            MOVE      ALRESRTM,LLREETIM
            GOTO      CKDTR100
          ENDIF
          MATCH     SP70,ALREUDAT
          IF        !@EQUAL
            MATCH     STRTDATE,ALREUDAT
            IF        !@LESS
              MOVE      ALRESRDT,LLREEDAT     * set Referral End Date/Time
              MOVE      ALRESRTM,LLREETIM
              GOTO      CKDTR100
            ENDIF  
          ENDIF
          GOTO      CKDTR900                * Ref'l Reject is before Start date
.
.
.                                      * valid Referral - set extract date range
CKDTR100  MATCH     SP8,ALREUTM6            * used for Referral Start Time
          IF        @EQUAL
            MOVE      "00:00:00",ALREUTM6   * default to "00:00:00"
          ENDIF
.
          MOVE      ALRERDAT,EFFSDATE       * set Eff.Start date as RD Start dat
          MOVE      ALREUTM6,EFFSTIME
.
.                                           * check if Referral End-Date is
.                                           * greater than end of Date Range
CKDTR110  MATCH     LLREEDAT,ENDDATE
          IF        @LESS
            MOVE      ENDDATE,EFFEDATE      * set as End of Date Range
            MOVE      NENDTIME,EFFETIME
          ELSE
            MOVE      LLREEDAT,EFFEDATE     * set as end date of Referral
            MOVE      NENDTIME,EFFETIME
          ENDIF
          MATCH     "99999999",LLREEDAT     * reset LLREEDAT if not used above
          IF        @EQUAL
            MOVE      SP8,LLREEDAT          * Referral has no end date
          ENDIF
.
.                                           * check Referral for Status changes
.                                           * in the Date Range
          MATCH     SP8,ALREDACT            * check "Active" Date (Status = 1)
          GOTO      CKDTR120 IF EQUAL
          MATCH     STRTDATE,ALREDACT
          IF        !@LESS
            MATCH     ALREDACT,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Status change in Date Range
            ENDIF
          ENDIF
.
CKDTR120  MATCH     SP8,ALREDCLO            * check "Closed" Date (Status = 2)
          GOTO      CKDTR130 IF EQUAL
          MATCH     STRTDATE,ALREDCLO
          IF        !@LESS
            MATCH     ALREDCLO,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Status change in Date range
            ENDIF
          ENDIF
.
CKDTR130  MATCH     SP8,ALREDINA            * check "Inactive" Date (Status = 3)
          GOTO      CKDTR140 IF EQUAL                                *C-0837897
          MATCH     STRTDATE,ALREDINA
          IF        !@LESS
            MATCH     ALREDINA,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Status change in Date range
            ENDIF
          ENDIF
.
.         *C-0837897 Cancelled Referral
.
CKDTR140  MATCH     SP8,ALREDCAN            * check "Cancelled" Date (Status = 4)
          GOTO      CKDTR150 IF EQUAL
          MATCH     STRTDATE,ALREDCAN
          IF        !@LESS
            MATCH     ALREDCAN,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Status change in Date range
            ENDIF
          ENDIF
.
CKDTR150  MATCH     SP8,ALRESRDT            * check "Rejected" Date (Status = 5)
          GOTO      CKDTR160 IF EQUAL
          MATCH     STRTDATE,ALRESRDT
          IF        !@LESS
            MATCH     ALRESRDT,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Status change in Date range
            ENDIF
          ENDIF
.
CKDTR160  MATCH     SP8,ALREUDAT            * check "Referral Update"
          GOTO      CKDTR170 IF EQUAL
          MATCH     STRTDATE,ALREUDAT
          IF        !@LESS
            MATCH     ALREUDAT,ENDDATE
            IF        !@LESS
              MOVE      "1",FOUNDREF        * found Update change in Date range
            ENDIF
          ENDIF
.
CKDTR170  MOVE      ZERO,KEY1
.
.                                           * find first Referral Encounter AT
CKDTR200  MATCH     STRTDATE,ALRERDAT
          IF        @LESS
            PACK      KEY32,ALREVISN,ALRERDAT,SP30
          ELSE        
            PACK      KEY32,ALREVISN,STRTDATE,SP30 * get first Enc.in Date range
          ENDIF
CKDTR210  CALL      RSALENC6
CKDTR220  CALL      RKALENC6
          BRANCH    OVRCD,CKDTR300
.
          MATCH     ALREVISN,ALENVISN       * Same visit number?
          GOTO      CKDTR300 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      CKDTR220 IF EQUAL       * bypass Cancelled Encounter
.
          MATCH     ALENSDAT,EFFEDATE       * Check if after End date
          GOTO      CKDTR300 IF LESS
.
.  *** added for Task 0877765
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1
          IF        OVRCD=0
            MATCH     SP70,ALSRMHDP           * Ignore record if HDP is blank
            GOTO      CKDTR220 IF EQUAL
          ENDIF
.  *** end for Task 0877765
.
CKDTR250  MATCH     "20080701",ALENSDAT     * not before 01/07/2008
          GOTO      CKDTR220 IF LESS
.
          MATCH     FRSTATDT,ALENSDAT       *
          IF        @LESS
            MOVE      ALENSDAT,FRSTATDT     * save first Encounter Start date
            MOVE      ALENSTIM,FRSTATTM     * time
            MOVE      "1",ATEXISTS
..........TSK 0835974
.           MATCH     STRTDATE,ALENSDAT     * Check if before Start date
.           IF        @LESS
.             PACK      KEY32,ALREVISN,STRTDATE,SP30   * change the Key
.             GOTO      CKDTR210
.           ENDIF
          ENDIF
.
.         MATCH     STRTDATE,ALENSDAT
.         IF        !@LESS
          MOVE      "1",FOUNDAT             * found Encounter in Date range
......... ENDIF
.
.                                           * *********************************
CKDTR300  PACK      KEY16,ALREVISN,SP70     * see if any Group Contacts ("AT"s)
          CALL      RSALGPA2
CKDTR320  CALL      RKALGPA2                * ("allgraaf")
          BRANCH    OVRCD,CKDTR400
.
          MATCH     ALREVISN,ALGAREFN
          GOTO      CKDTR400 IF NOT EQUAL
.
          MATCH     "1",ALGACURP            * Current patient?
          GOTO      CKDTR320 IF EQUAL       * Yes
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CKDTR320
.
          MATCH     SP4,THCSCOD           * Cancelled? (otherwise T06, T35 etc)
          GOTO      CKDTR320 IF EQUAL
.
          MOVE      ALGACONT,KEY8
          CALL      RDALGRE1                * ("allgreaf")
          BRANCH    OVRCD,CKDTR320
.
          MATCH     "20080701",ALGEGDTE     * not before 01/07/2008
          GOTO      CKDTR320 IF LESS        
.         
          MATCH     ALGEGDTE,EFFEDATE       * Activity date <= Eff.End date ?
          GOTO      CKDTR400 IF LESS
.
          MATCH     FRSTATDT,ALGEGDTE       * is this earlyest AT record
          IF        @LESS | @EQUAL
            MOVE      ALGEGDTE,FRSTATDT     * save first Encounter Start date
            MOVE      ALGEGTIM,FRSTATTM     * time
            MOVE      "1",ATEXISTS
          ENDIF     
.         
          MATCH     STRTDATE,ALGEGDTE
          IF        !@LESS
            MOVE      "1",FOUNDAT
          ENDIF
.
.
.                                           * *********************************
CKDTR400  PACK      KEY16,ALREVISN,SP70     * any Linked OP Appointments ?
          CALL      RSALLNK1                * Referral Link file
CKDTR420  CALL      RKALLNK1                * ("alllnkaf")
          BRANCH    OVRCD,CKDTR700
          MATCH     ALREVISN,ALLNVISN       * Same visit number?
          GOTO      CKDTR700 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      CKDTR420 IF EQUAL
.         
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
CKDTR440  CALL      RDKBOKA6
          BRANCH    OVRCD,CKDTR700
.
          MATCH     ALLNLNKV,DOBAOUTN       * (OBAOUTNO)
          GOTO      CKDTR700 IF NOT EQUAL   * Different visit number
.
          MATCH     "20080701",OBADATE      * not before 01/07/2008
          GOTO      CKDTR440 IF LESS
.
          MATCH     OBADATE,EFFEDATE        * Appointment date <= End date ?
          GOTO      CKDTR420 IF LESS
.
          MATCH     FRSTATDT,OBADATE        
          IF        @LESS | @EQUAL          
            IF        OBASTAT = 4 | OBASTAT = 5
              MOVE      OBADATE,FRSTATDT    * save first Encounter Start date
              MOVE      ":00",KEY3
              PACK      FRSTATTM,OBATIME,KEY3  * Time (where OBATIME is DIM 4)
              MOVE      "1",ATEXISTS 
            ENDIF   
          ENDIF     
.
          MATCH     STRTDATE,OBADATE
          IF        !@LESS
.                                           * only Attended & not-Attended
            IF        OBASTAT = 4 | OBASTAT = 5
              MOVE      "1",FOUNDAT
            ENDIF   
          ENDIF     
          GOTO      CKDTR440
.
CKDTR700  MATCH     "99999999",FRSTATDT
          IF        @EQUAL
            UNPACK    SP70,FRSTATDT,FRSTATTM
            MOVE      "0",ATEXISTS          * no "AT" records was found
          ELSE 
            UNPACK    FRSTATTM,KEY6,KEY2
            MOVE      "0",F2S
            MOVE      KEY2,F2S
            IF        F2S < 59
              ADD       "1",F2S             * add 1 second start time
              MOVE      F2S,KEY2
              REP       " 0",KEY2
              PACK      FRSTATTM,KEY6,KEY2
            ELSE
              UNPACK    FRSTATTM,DIM2A,DIM1A,DIM2B,DIM1B,DIM2C
              MOVE      "00",DIM2C
              MOVE      ZERO,F2M
              MOVE      ZERO,F2H
              MOVE      DIM2B,F2M
              MOVE      DIM2A,F2H
              ADD       ONE,F2M
              IF        F2M > 59
                MOVE      "00",F2M
                ADD       ONE,F2H
              ENDIF
              MOVE      F2M,DIM2B
              MOVE      F2H,DIM2A
              PACK      FRSTATTM,DIM2A,DIM1A,DIM2B,DIM1B,DIM2C
              REP       " 0",FRSTATTM
            ENDIF
          ENDIF
.
CKDTR710
          MATCH     "1",ALREUYN4            * is Referral a primary ?
          GOTO      CKDTR999 IF NOT EQUAL
.
.
.                            ************************* check if any HoNoS ("CO")
          PACK      KEY24,ALREVISN,EFFSDATE,SP70
          CALL      RSMHHON3
CKDTR750  CALL      RKMHHON3                * read Honos records
          BRANCH    OVRCD,CKDTR999          
.         
          MATCH     ALREVISN,MHHNVISN
          GOTO      CKDTR999 IF NOT EQUAL
.
          MATCH     "20080701",MHHNHDAT     * not before 01/07/2008   *I-266318
          GOTO      CKDTR750 IF LESS
.                                           * check End Date
          MATCH     MHHNHDAT,EFFEDATE
          GOTO      CKDTR999 IF LESS
.
          MATCH     "1",MHHNCOMP            * Completed?
          GOTO      CKDTR750 IF NOT EQUAL
.
.---------T0858390-Start
.---------Check if the Collection reason is to be included
.---------(mehhonaf.mhhnreas does not have Indicator 7="X")
          PACK      KEY5,CAThp,MHHNREAS
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSX,TCINDC7          * Exclude ADOM?
            GOTO      CKDTR750 IF EQUAL     * Yes, read next record
          ENDIF
.---------T0858390-End
.
          MATCH     "1",MHHNACTV            * Active?
          GOTO      CKDTR750 IF NOT EQUAL
.
          MOVE      "1",FOUNDCO
.
          GOTO      CKDTR999
.
.                                           * Referral does not fit Date Range
CKDTR900  MATCH     "99999999",FRSTATDT
          IF        @EQUAL
            UNPACK    SP70,FRSTATDT,FRSTATTM
            MOVE      "0",ATEXISTS          * no "AT" records were found
          ENDIF
          MOVE      ONE,EXIT                * Referral not to be extracted
.
CKDTR999  IF        OPTION = 2 & EXIT = 0 & PLNKFLAG = 0
            CLEAR     PRNTLINE                * Clear printline
            APPEND    "Referral No.: ",PRNTLINE
            APPEND    ALREVISN,PRNTLINE
            APPEND    "  Referral ",PRNTLINE
            APPEND    FOUNDREF,PRNTLINE            
            APPEND    ",  Encounter ",PRNTLINE
            APPEND    FOUNDAT,PRNTLINE            
            APPEND    ",  HoNOS ",PRNTLINE
            APPEND    FOUNDCO,PRNTLINE            
            IF        FOUNDREF = 1 | FOUNDAT = 1 | FOUNDCO = 1
              APPEND    "   Referral selected ",PRNTLINE
            ENDIF
            CALL      PRNT0000
          ENDIF
.
          RETURN
+
.******************************************************************************
.*                                RDRF0000                                    *
.*               Referral/Discharge (RD) from Referral                        *
.******************************************************************************
RDRF0000  MOVE      ZERO,EXIT
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      ALREURNO,PHURNUMB      * U/R number
          MOVE      CURMOHNO,PHVISNUM      * Visit number             *C-213741
          MOVE      PHVISNUM,LASTRDVS
.
          MOVE      "1",PHRECTYP           * Write RD Record
          CALL      SRRD0000               * Set Referral RD record
          BRANCH    EXIT,RDRF9999                                     *I-203923
.
          CALL      WRTM0000               * Write to tempfile
.
RDRF9999  RETURN
+
.******************************************************************************
.*                            PENC0000                                        *
.*                       Processing Encounters                                *
.******************************************************************************
PENC0000  MOVE      ZERO,EXIT
.                                                * get first Enc. for Date range
          PACK      KEY32,ALREVISN,EFFSDATE,SP30 * start at Referral Start date
          CALL      RSALENC6
PENC1000  CALL      RKALENC6
          BRANCH    OVRCD,PENC9999
.
          MATCH     CURREFNO,ALENVISN       * Same visit number?
          GOTO      PENC9999 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      PENC1000 IF EQUAL       * Cancelled
.
          MATCH     "20080701",ALENSDAT     * not before 01/07/2008
          GOTO      PENC1000 IF LESS
.
          MATCH     ALENSDAT,EFFEDATE       * Check date of service
          GOTO      PENC9999 IF LESS
.
          MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      ALREURNO,PHURNUMB       * U/R number
          MOVE      CURMOHNO,PHVISNUM       * Visit number            *C-213741
.
          MOVE      "5",PHRECTYP            * Write AT Record
          CALL      SEAT0000                * Set Encounter AT record
          BRANCH    EXIT,PENC1000
.
          CALL      WRTM0000                * Write to tempfile
.
          GOTO      PENC1000
.
PENC9999  RETURN
+
.******************************************************************************
.*                            PGRC0000                                        *
.*                       Process Group Contacts                               *
.******************************************************************************
PGRC0000  MOVE      ZERO,EXIT
.
          PACK      KEY16,CURREFNO,SP70
          CALL      RSALGPA2
PGRC1000  CALL      RKALGPA2                * ("allgpaaf")
          BRANCH    OVRCD,PGRC9999
.
          MATCH     CURREFNO,ALGAREFN
          GOTO      PGRC9999 IF NOT EQUAL
.
          MATCH     "1",ALGACURP            * Current patient?
          GOTO      PGRC1000 IF EQUAL       * Yes
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PGRC1000
.
          MATCH     SP4,THCSCOD             * Cancelled? (otherwise T06,T35 etc)
          GOTO      PGRC1000 IF EQUAL
.
          MOVE      ALGACONT,KEY8
          CALL      RDALGRE1
          BRANCH    OVRCD,PGRC1000
.
PGRC2000  MATCH     "20080701",ALGEGDTE     * not before 01/07/2008
          GOTO      PGRC1000 IF LESS                                  *C-210948
.
          MATCH     EFFSDATE,ALGEGDTE       * check Start Date (Referral Start)
          GOTO      PGRC1000 IF LESS
          MATCH     ALGEGDTE,EFFEDATE       * Check End Date
          GOTO      PGRC1000 IF LESS                                  *C-210948
.
          MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      ALREURNO,PHURNUMB       * U/R number
          MOVE      CURMOHNO,PHVISNUM       * Visit number            *C-213741
.
          MOVE      "5",PHRECTYP            * Write AT Record
          CALL      SGAT0000                * Set Group Contacts AT record
          CALL      WRTM0000                * Write to tempfile
.
          GOTO      PGRC1000
.
PGRC9999  RETURN
+
.******************************************************************************
.*                            PLOP0000                                        *
.*               Process for Linked OP Appointments in MH Department          *
.******************************************************************************
PLOP0000  MOVE      ZERO,EXIT
.
          PACK      KEY16,CURREFNO,SP70 
          CALL      RSALLNK1                * Referral Link file
PLOP1000  CALL      RKALLNK1                * ("alllnkaf")
          BRANCH    OVRCD,PLOP9999
          MATCH     CURREFNO,ALLNVISN       * Same visit number?
          GOTO      PLOP9999 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT            * Cancelled
          GOTO      PLOP1000 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
PLOP2000  CALL      RDKBOKA6                * ("outbokaf")
          BRANCH    OVRCD,PLOP1000
.
          MATCH     ALLNLNKV,DOBAOUTN       * (OBAOUTNO)
          GOTO      PLOP1000 IF NOT EQUAL   * Different visit number
.
          MATCH     "20080701",OBADATE      * not before 01/07/2008
          GOTO      PLOP2000 IF LESS
.
          MATCH     EFFSDATE,OBADATE        * Appointmt date => Ref.Start date ?
          GOTO      PLOP2000 IF LESS
.
          MATCH     OBADATE,EFFEDATE        * Appointment date <= End date ?
          GOTO      PLOP2000 IF LESS
.                                                                     *I-258616
          COMPARE   FOUR,OBASTAT
          GOTO      PLOP3000 IF EQUAL       * only Attended & not-Attended
          COMPARE   FIVE,OBASTAT
          GOTO      PLOP2000 IF NOT EQUAL
.
PLOP3000  MOVE      SP70,OTHELTYP
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
.
.         Check if clinic attendance is not recorded as an encounter
.
          PACK      KEY24,ALLNLNKV,SP70     * use Linked OP Visit number
          CALL      RSALENC7
          CALL      RKALENC7
          BRANCH    OVRCD,PLOP5000          *                         *C-203051
.
          MATCH     ALENLINK,ALLNLNKV
          GOTO      PLOP2000 IF EQUAL                                 *C-203051
.
.                                      * the Linked OP Appointment does not
.                                      * have an equivalent Encounter - so add
.                                      * an "AT" to the original Referral
.
PLOP5000  MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      CURMOHNO,PHVISNUM       * Visit number            *C-213741
.
          MOVE      "5",PHRECTYP            * Write AT Record
          CALL      SOAT0000                * Set OP Appointments AT record
          CALL      WRTM0000                * Write to tempfile
.
PLOP6000  CALL      MHDI0000                * MH Diagnosis - CN record
          GOTO      PLOP1000                                          *I-203051
.
PLOP9999  RETURN
+
.******************************************************************************
.         MH Diagnosis - OP Coded Diagnosis                                   *
.******************************************************************************
MHDI0000  MOVE      SP70,ADATE
          MOVE      SP70,DDATE
.
MHDI1000  PACK      KEY13,OBAOUTNO,SP70
          CALL      RSPTECD1
MHDI2000  CALL      RKPTECD1
          BRANCH    OVRCD,MHDI6000
.
          MATCH     PTEDADMN,OBAOUTNO
          GOTO      MHDI6000 IF NOT EQUAL
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      PTEDADMN,PHVISNUM      * Visit number
.
          MOVE      PTEDACDT,KEY8
          PACK      KEY10,PTEDTYPE,PTEDCODE
          MOVE      "6",PHRECTYP           * Write CN Record
          CALL      SICN0000               * Set IP Coded Diagnosis - CN record
.
          CALL      WRTM0000               * Write to tempfile
.
          GOTO      MHDI2000
.
MHDI6000  PACK      KEY13,OBAOUTNO,SP70
          CALL      RSPTECO1
MHDI8000  CALL      RKPTECO1
          BRANCH    OVRCD,MHDI9999
.
          MATCH     PTEOADMN,OBAOUTNO
          GOTO      MHDI9999 IF NOT EQUAL
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      PTEOADMN,PHVISNUM      * Visit number
.
          MOVE      PTEODATE,KEY8
          PACK      KEY10,PTEOTYPE,PTEOCODE
          MOVE      "6",PHRECTYP           * Write CN Record
          CALL      SICN0000               * Set IP Coded Diagnosis - CN record
.
          CALL      WRTM0000               * Write to tempfile
.
          GOTO      MHDI8000
.
MHDI9999  RETURN
+
.******************************************************************************
.         MH Diagnosis - IP Coded Diagnosis                                   *
.******************************************************************************
IPCOD000  MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,IPCOD999
.
          UNPACK    SP70,DDATE,DTIME
          IF        ASTAT = 3
            CALL      RDDSCH1
            BRANCH    OVRCD,IPCOD999
          ENDIF
.
IPCOD100  PACK      KEY13,AADMNO,SP70
          CALL      RSPTECD1
IPCOD200  CALL      RKPTECD1
          BRANCH    OVRCD,IPCOD999                       *T0878938
.---------BRANCH    OVRCD,IPCOD600-----------------------*T0878938
.
          MATCH     PTEDADMN,AADMNO
          GOTO      IPCOD999 IF NOT EQUAL
.---------GOTO      IPCOD600 IF NOT EQUAL----------------*T0878938
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      PTEDADMN,PHVISNUM      * Visit number
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      DDATE,KEY8
          ELSE
            MOVE      PTEDDTCD,KEY8
          ENDIF
          PACK      KEY10,PTEDTYPE,PTEDCODE
          MOVE      "6",PHRECTYP           * Write CN Record
          CALL      SICN0000               * Set IP Coded Diagnosis - CN record
.
          CALL      WRTM0000               * Write to tempfile
.
          GOTO      IPCOD200
.
.--*T0878938-Start - commented out to exclude procedure diagnosis codes
.--                   from extract
.--IPCOD600  PACK      KEY13,AADMNO,SP70
.--          CALL      RSPTECO1
.--IPCOD800  CALL      RKPTECO1
.--          BRANCH    OVRCD,IPCOD999
.--
.--          COMPARE   PTEOADMN,AADMNO
.--          GOTO      IPCOD999 IF NOT EQUAL
.--
.--          MOVE      XHOSPID,PHORGNID       * Organisation ID
.--          MOVE      PURNO,PHURNUMB         * U/R Number
.--          MOVE      PTEOADMN,PHVISNUM      * Visit number
.--
.--          MOVE      PTEODATE,KEY8
.--          PACK      KEY10,PTEOTYPE,PTEOCODE
.--          MOVE      "6",PHRECTYP           * Write CN Record
.--          CALL      SICN0000               * Set IP Coded Diagnosis - CN record
.--
.--          CALL      WRTM0000               * Write to tempfile
.--
.--          GOTO      IPCOD800
.--
.--*T0878938-End
IPCOD999  RETURN
+
.******************************************************************************
.         HONOS Assessments - read through all Assessments to create "CO"     *
.******************************************************************************
HONS0000  MOVE      ZERO,EXIT
.
          PACK      KEY24,CURREFNO,EFFSDATE,SP70  * start at Referral Start Date
          CALL      RSMHHON3
HONS1000  CALL      RKMHHON3                * read Honos records
          BRANCH    OVRCD,HONS9999
.
          MATCH     CURREFNO,MHHNVISN
          GOTO      HONS9999 IF NOT EQUAL
.
.         Check if assessment date is less than or equal to extract end date
.
          MATCH     "20080701",MHHNHDAT     * not before 01/07/2008   *I-266318
          GOTO      HONS1000 IF LESS
.
          MATCH     MHHNHDAT,EFFEDATE       * when reading forward    *C-194314
          GOTO      HONS9999 IF LESS
.
.         Check if assessment is completed and active
.
          MATCH     "1",MHHNCOMP           * Completed?
          GOTO      HONS1000 IF NOT EQUAL
.
.---------T0858390-Start
.---------Check if the Collection reason is to be included
.---------(mehhonaf.mhhnreas does not have Indicator 7="X")
          PACK      KEY5,CAThp,MHHNREAS
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSX,TCINDC7          * Exclude ADOM?
            GOTO      HONS1000 IF EQUAL     * Yes, read next record
          ENDIF
.---------T0858390-End
.
          MATCH     "1",MHHNACTV           * Active?
          GOTO      HONS1000 IF NOT EQUAL
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      CURMOHNO,PHVISNUM      * Visit number
.
          MOVE      "2",PHRECTYP           * Write CO Record
          CALL      SHCO0000               * Set HONOS - "CO" record
          CALL      WRTM0000               * Write to tempfile
.
          MOVE      PHUNQNUM,SVUNQNUM      * get "CO" unique no. for "OT" & "OI"
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      CURMOHNO,PHVISNUM      * Visit number
.
          CALL      OTOI0000               * Set HONOS - OT and OI record
.
          GOTO      HONS1000               * allow multiple "CO" records
.
HONS9999  RETURN
+
.******************************************************************************
.         Supplementary Consumer Records                                      *
.******************************************************************************
SUPC0000  MOVE      ZERO,EXIT
.
          PACK      KEY16,ALREURNO,EFFSDATE,SP70  * start at Referral Start Date
          CALL      RDMHSCR1
          IF        OVRCD<>1
            GOTO      SUPC1500
          ENDIF
.
          PACK      KEY16,ALREURNO,EFFSDATE,SP70  * start at Referral Start Date
          CALL      RSMHSCR1
SUPC1000  CALL      RKMHSCR1                * read Supplementary Consumer Rec
          BRANCH    OVRCD,SUPC9999
.
          MATCH     ALREURNO,MHSCURNO
          GOTO      SUPC9999 IF NOT EQUAL
.
.         Check if assessment date is less than or equal to extract end date
.
SUPC1500  MATCH     "20160101",MHSCSDAT     * not before 01/07/2016
          GOTO      SUPC1000 IF LESS
.
          MATCH     MHSCSDAT,EFFEDATE       * when reading forward    *C-194314
          GOTO      SUPC9999 IF LESS
.
.         Check if assessment is completed and active
.
          MATCH     "1",MHSCSTAT           * Inactive?
          GOTO      SUPC1000 IF EQUAL
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      ALREURNO,PHURNUMB      * U/R Number
          MOVE      CURMOHNO,PHVISNUM      * Visit number
.
          MOVE      "7",PHRECTYP           * Write SC Record
          CALL      SSCR0000               * Set Supp Consumer - "SC" record
          CALL      WRTM0000               * Write to tempfile
.
          GOTO      SUPC1000               * allow multiple "CO" records
.
SUPC9999  RETURN
+
.******************************************************************************
.*                            INPT0000                                *
.******************************************************************************
INPT0000  MOVE      ZERO,EXIT
          DISPLAY   *P1:24,*EL,*V2LON,"Processing Inpatients -":
                    *BLINKON," Please Wait",*HOFF;
.
          MOVE      ZERO,DELFLAG
          MOVE      "2",ASTATUS             * process Currently admitted status
          CALL      ADMN0000                * process admission numbers
.
          MOVE      "3",ASTATUS             * process Discharged      *I-202347
          CALL      ADMN0000                * process admission numbers
.
          MOVE      "4",ASTATUS             * process On leave status
          CALL      ADMN0000                * process admission numbers
.
          CALL      DSCH0000                * process discharges
          CALL      CANC0000                * process cancelled admissions
.
INPT9999  RETURN
+
.******************************************************************************
.*                            ADMN0000                                *
.*               Process Admissions                                   *
.******************************************************************************
ADMN0000  PACK      KEY9,ASTATUS,SP8
          CALL      RDSMISS2
.
.------ read through the Admissions file ------
.
ADMN1000  CALL      RDKMISS2
          BRANCH    OVRCD,ADMN9999
.
          COMPARE   ASTATUS,ASTAT           * test the admission status
          GOTO      ADMN9999 IF NOT EQUAL
.
          MATCH     ADATE,ENDDATE           * make sure patient is not admitted
          GOTO      ADMN1000 IF LESS          after the end of the period
.
          CALL      INPDHB00                * check District Health Board match
          BRANCH    EXIT,ADMN1000           * no match skip
.
.                                            ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     SP8,TSTREFNO
            GOTO      ADMN1500 IF EQUAL
            MATCH     TSTREFNO,DAADMNO
            GOTO      ADMN1000 IF NOT EQUAL
          ENDIF                             ******** end Testing Option *****
.
ADMN1500  MOVE      AURNO,PURNO
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      AURNO,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
ADMN2000  MOVE      "P ",TCODE
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMN1000
.
          MATCH     "IM",THCSCOD
          GOTO      ADMN1000 IF NOT EQUAL   * Not a MH Admission
.
.
ADMN3000  CALL      CLPATDSC           * clear Discharge record (before reading)
          COMPARE   THREE,ASTAT                                       *I-202347
          GOTO      ADMN4000 IF NOT EQUAL   * Not discharged
.
.                                      * if the Discharge is in the date range,
.                                      * do not process this Admission - if out-
.                                      * side (after) date range, treat Admis-
.                                      * sion as still Status 2 (Admitted)
          PACK      KEY8,AADMNO,SP10
          CALL      RDDSCH1
          MATCH     DDATE,ENDDATE
          IF        @LESS
            MOVE      TWO,ASTAT             * treat as still "admitted"
          ELSE
            GOTO      ADMN1000              * will be processed in DSCH0000
          ENDIF                                                 * end *I-202347
.
ADMN4000  MOVE      SAVSSORG,XHOSPID        * Default Hosp Id        *C-0833934
          UNPACK    SP70,PMVXMHOS,PTHSORID
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
...       BRANCH    OVRCD,ADMN1000
          IF        IBCNMHOS=1
            MOVE      SP8,PTHSORID
            PACK      KEY3,PMVXMHOS,SP3
            CALL      RDPTHSP1
            MATCH     SP8,PTHSORID
            IF        !@EQUAL
              MOVE      PTHSORID,XHOSPID    * Organisation ID
            ENDIF
          ENDIF
.
ADMN5000  MOVE      AADMNO,CURREFNO         * identify current Admis/Referal
          MOVE      AADMNO,CURMOHNO         * Referral No. to send to MoH
          MOVE      ZERO,CNIDCNT            * CN Unique Id. No.       *I-199520
          CALL      SETDAT00                * set Start/End Date range
.
          MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      CURREFNO,PHVISNUM       * Visit number
.
          MOVE      "1",PHRECTYP            * Write RD Record
          CALL      SARD0000                * Set Admission - "RD" record
          BRANCH    EXIT,ADMN1000           * Exclude from PRIMHD Extract
.                                           * Read next visit         *C-0814204
          CALL      WRTM0000                * Write to tempfile
.
          PACK      ALREURNO,AURNO,SP70
          PACK      EFFSDATE,ADATE,SP70
          MOVE      ENDDATE,EFFEDATE
          CALL      SUPC0000                * Process Supplementary record
          CALL      CTRN0000                * Process Transactions for "AT" recs
.
          CALL      HONS0000                * check for Honos         *I-199247
.
          PACK      KEY13,AADMNO,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,ADMN6000
.
          MATCH     PTEDADMN,AADMNO
          GOTO      ADMN7000 IF EQUAL       * found a record (write coded "CN")
.
ADMN6000  UNPACK    SP70,LASTRDDT,LASTRDTM
          CALL      PCOD0000                * Diagnosis Prov.Coding - "CN" recd
.
          GOTO      ADMN1000                                          *I-192907
.
ADMN7000  
          CALL      IPCOD000                 * IP Coding        *T0878938
.
          GOTO      ADMN1000                                          *I-192907
ADMN9999  RETURN
+
.******************************************************************************
.*                           INPDHB00                                         *
.*        Validates if the IP visits hospital District Health                 *
.*        Board (HDP Default) matches that of the DHB keyed in earlier.       *
.******************************************************************************
INPDHB00  MOVE      ZERO,EXIT
.
          COMPARE   ONE,IBCNMHOS            * Exit if not multi hospital
          GOTO      INPDHB99 IF NOT EQUAL
.
          MATCH     SP70,PMVXMHOS           * hospital filled in ?
          GOTO      INPDHB91 IF EQUAL       * not invalid
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,INPDHB91
.
          MATCH     SP70,PTHSHDHB           * District Health Board setup?
          GOTO      INPDHB91 IF EQUAL       * not invalid
.
          PACK      KEY5,CATdh,PTHSHDHB,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,INPDHB91
.
          MATCH     DHBEQUIV,THCSCOD        * matching HDP Default?
          GOTO      INPDHB91 IF NOT EQUAL   * not invalid

          GOTO      INPDHB99
.
INPDHB91  MOVE      ONE,EXIT                * doesn't match
.
INPDHB99  RETURN
+
.******************************************************************************
.                Process discharges                                   *
.******************************************************************************
DSCH0000  PACK      KEY16,STRTDATE,SP70
          CALL      RDSDSCH2
DSCH1000  CALL      RDKDSCH2
          BRANCH    OVRCD,DSCH9999
.
          MATCH     DDATE,ENDDATE
          GOTO      DSCH9999 IF LESS
.
          MOVE      DADMNO,KEY8
.
.                                            ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     SP8,TSTREFNO
            GOTO      DSCH1500 IF EQUAL
            MATCH     TSTREFNO,DDADMNO
            GOTO      DSCH1000 IF NOT EQUAL
          ENDIF                             ******** end Testing Option *****
.
DSCH1500  CALL      RDMISS1
          BRANCH    OVRCD,DSCH1000
          CALL      RDPMVX11
          BRANCH    OVRCD,DSCH1000
.
          MATCH     ADATE,ENDDATE           * make sure patient is not admitted
          GOTO      DSCH1000 IF LESS          after the end of the period
.
          CALL      INPDHB00                * check District Health Board match
          BRANCH    EXIT,DSCH1000           * no match skip
.
          MOVE      AURNO,PURNO
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      AURNO,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
          MOVE      "P ",TCODE
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DSCH1000
.
          MATCH     "IM",THCSCOD
          GOTO      DSCH1000 IF NOT EQUAL   * Not a MH Admission
.
DSCH4000  MOVE      SAVSSORG,XHOSPID        * Default Hosp Id        *C-0833934
          UNPACK    SP70,PMVXMHOS,PTHSORID
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
...       BRANCH    OVRCD,DSCH1000
          IF        IBCNMHOS=1
            MOVE      SP8,PTHSORID
            PACK      KEY3,PMVXMHOS,SP3
            CALL      RDPTHSP1
            MATCH     SP8,PTHSORID
            IF        !@EQUAL
              MOVE      PTHSORID,XHOSPID    * Organisation ID
            ENDIF
          ENDIF
.
DSCH5000  MOVE      AADMNO,CURREFNO
          MOVE      AADMNO,CURMOHNO
          MOVE      ZERO,CNIDCNT            * CN Unique Id. No.       *I-199520
          CALL      SETDAT00                * set the Start/End Date range
.
          MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      CURREFNO,PHVISNUM       * Visit number
.
          MOVE      "1",PHRECTYP            * Write RD Record
          CALL      SARD0000                * Set Admission - "RD" record
          BRANCH    EXIT,DSCH1000           * Exclude from PRIMHD Extract then
.                                           * Read next visit         *C-0814204
          CALL      WRTM0000                * Write to tempfile
.
          PACK      ALREURNO,AURNO,SP70
..........PACK      EFFSDATE,ADATE,SP70     * TSK-0836629 Date set in SETDAT00
..........MOVE      ENDDATE,EFFEDATE        * TSK-0836629 Date set in SETDAT00
          CALL      SUPC0000                * Process Supplementary record
          CALL      CTRN0000                * Process Transactions for "AT" recs
.
          CALL      HONS0000                * check for Honos         *I-199247
.
          PACK      KEY13,AADMNO,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,DSCH6000
.
          MATCH     PTEDADMN,AADMNO
          GOTO      DSCH7000 IF EQUAL       * found a record (write coded "CN")
.
DSCH6000  MOVE      DDATE,LASTRDDT
          MOVE      DTIME,LASTRDTM
          CALL      PCOD0000                * Diagnosis Prov.Coding- "CN" recd
          GOTO      DSCH1000
.
DSCH7000  
          CALL      IPCOD000                 * IP Coding        *T0878938
          GOTO      DSCH1000
.
DSCH9999  RETURN
+
.******************************************************************************
.             Set Start/End Date Range for ADMN0000 & DSCH0000
.******************************************************************************
SETDAT00  MOVE      ONE,EXIT    
          MOVE      ADATE,EFFSDATE       * set the Start/End Date range
....      MOVE      NSTRTTIM,EFFSTIME                         * start *D-272202
....      MATCH     ADATE,STRTDATE
....      IF        @LESS
....        MOVE      ADATE,EFFSDATE
....        MOVE      ATIME,EFFSTIME
....      ENDIF                                               * end   *D-272202
          MOVE      ATIME,EFFSTIME                                    *I-272202
.
          MOVE      ENDDATE,EFFEDATE
          MOVE      NENDTIME,EFFETIME
          IF        ASTAT = 3
            MATCH     ENDDATE,DDATE
            IF        @LESS
              MOVE      DDATE,EFFEDATE
              MOVE      DTIME,EFFETIME
            ENDIF
          ENDIF
.
SETDAT99  RETURN
.
.******************************************************************************
.         Processing cancelled patients
.******************************************************************************
CANC0000  MOVE      ONE,DELFLAG
          PACK      KEY25,STRTDATE,SP70
          CALL      RDSUNAA3
CANC1000  CALL      RDKUNAA3
          BRANCH    OVRCD,CANC9999
.
.         Check if patient was un-admitted within date range
.
          MATCH     PTUNDATE,ENDDATE
          GOTO      CANC9999 IF LESS
.
          MOVE      DPTUNADM,KEY8                                     *C-213741
.                                           ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     SP8,TSTREFNO
            GOTO      CANC1500 IF EQUAL
            MATCH     TSTREFNO,DPTUNADM
            GOTO      CANC1000 IF NOT EQUAL
          ENDIF                             ******** end Testing Option *****
.
.
CANC1500  CALL      RDMISS1
          BRANCH    OVRCD,CANC1000
.
          MATCH     "5",DASTAT
          GOTO      CANC1000 IF NOT EQUAL
.
          MATCH     ADATE,ENDDATE           * make sure patient is not admitted
          GOTO      CANC1000 IF LESS          after the end of the period
.
          CALL      INPDHB00                * check District Health Board match
          BRANCH    EXIT,CANC1000           * no match skip
.
          MOVE      AURNO,PURNO
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      AURNO,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
          MOVE      "P ",TCODE
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANC1000
.
          MATCH     "IM",THCSCOD
          GOTO      CANC1000 IF NOT EQUAL   * Not a MH Admission
.
CANC4000  MOVE      SAVSSORG,XHOSPID        * Default Hosp Id       * C-0833934
.
          IF        IBCNMHOS=1
            PACK      KEY6,PTMIXWRD,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              PACK      KEY3,PTWDHOSN,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                PACK      XHOSPID,PTHSORID,SP70
              ENDIF
            ENDIF
          ENDIF
.
CANC5000  MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      AADMNO,PHVISNUM         * Visit number
          MOVE      "1",PHRECTYP            * Write RD Record
          CALL      SARD0000                * Set Admission - RD record
          BRANCH    EXIT,CANC1000           * Exclude from PRIMHD Extract then
.                                           * Read next visit         *C-0814204
          CALL      WRTM0000                * Write to tempfile
.
          PACK      ALREURNO,PURNO,SP70
          PACK      EFFSDATE,ADATE,SP70
          MOVE      ENDDATE,EFFEDATE
..          CALL      SUPC0000                * Process Supplementary record - removed 0826361
.
.          MOVE      ONE,EXIT               * Not sure if needed - NT removed - 294595
          GOTO      CANC1000
.
CANC9999  RETURN
+
.******************************************************************************
.         Process Inpatient Transactions
.******************************************************************************
.                                           * vars for setting "CN" Date/Time
CTRN0000  MOVE      ONE,F1
.
          MATCH     "20080701",ADATE        * not before 01/07/2008   *I-266318
          IF        @LESS
            MOVE      "20080701",FRSTATDT
            MOVE      "00:00:01",FRSTATTM
          ELSE                                               * (end)  *I-266318
            MOVE      ADATE,FRSTATDT        * default use Admission Date/Time
            MOVE      ATIME,FRSTATTM
          ENDIF
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
CTRN1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CTRN9999
.
CTRN2000  MATCH     AADMNO,TADMN
          GOTO      CTRN9999 IF NOT EQUAL 
.
.                                                                     *I-266318
          MATCH     FRSTATDT,TDATE          * Tran before modified Admiss Date?
          GOTO      CTRN1000 IF LESS
.
CTRN3000  MATCH     TDATE,EFFEDATE                                    *C-258616
          GOTO      CTRN9999 IF LESS
.
          MATCH     "D",TMOVE               * don't create AT for Discharge Tran
          GOTO      CTRN9999 IF EQUAL                                 *I-199777
.
          MOVE      "P ",TCODE
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTRN1000          * not found? - bypass
          MATCH     "IM",THCSCOD
          GOTO      CTRN1000 IF NOT EQUAL   * not Mental Health? - bypass
.
CTRN5000  MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      CURREFNO,PHVISNUM       * Visit number
.
          MOVE      "5",PHRECTYP            * Write "AT" Record
          CALL      SAAT0000                * Set Adm.Transaction- "AT" record
          BRANCH    EXIT,CTRN2000           * "AT" record ends before Startdate 
.
..........CALL      WRTM0000                * Write to tempfile       *C-0832767
.
          MATCH     AADMNO,TADMN            * next patient already read ?
          GOTO      CTRN9999 IF NOT EQUAL   * yes - finish
.
          GOTO      CTRN2000                * already have next Tran record
.
CTRN9999  RETURN
+
.******************************************************************************
.                                  PCOD0000                                   *
.              Process Referral Diagnosis - Provisional coding - "CN"         *
.******************************************************************************
PCOD0000  MOVE      ZERO,DIAGNUMB
          MOVE      ZERO,FOUNDCN
          MOVE      ZERO,USEDPDOC           * set "don't use 01/07/2008" stuff
.
          IF        PLNKFLAG = 1 | PREFFLAG = 1
            GOTO      PCOD5000              * use the Diagnosis Dates table
          ENDIF
.
.                                           * Process Inpatients Diagnosis
PCOD0500  PACK      KEY16,CURREFNO,EFFSDATE,SP70 * Referral/Admn. start date
          CALL      RDMHDIA1
          IF        OVRCD = 1
            CALL      RSMHDIA1
PCOD1000    CALL      RKMHDIA1
            BRANCH    OVRCD,PCOD9999
          ENDIF
.
          MATCH     CURREFNO,DMHDIADM       * correct Visit No ?
          GOTO      PCOD9999 IF NOT EQUAL
.
.                                           * Date range checked in PDIA0000
.
          CALL      PDIA0000                * process the Diagnosis "CN" record
          BRANCH    EXIT,PCOD1000           * Exit=1 - Diag record not valid
.
          GOTO      PCOD1000                * find next Diagnosis
.
.   
.                   ************* PLNK0000 & PREF0000 Referrals only **********
PCOD5000  UNPACK    SP70,DIAEDATE,DIAETIME
          MOVE      CURREFNO,SAVREFNO       * save CURREFNO
          MOVE      ONE,F3XX
          REPEAT                            * read through BDATS000 Diag Table
            MOVE      DIAGLINK[F3XX],DIAREFNO
            MOVE      DIAGSDAT[F3XX],KEY8
            MOVE      DIAGEDAT[F3XX],DIAEDATE
            MOVE      DIAGETIM[F3XX],DIAETIME
            PACK      KEY16,DIAREFNO,KEY8,SP70
PCOD5500    CALL      RDMHDIA1
            BRANCH    OVRCD,PCOD5600
.
            MOVE      DIAREFNO,CURREFNO
            CALL      PDIA0000              * process the Diagnosis "CN" record
.
PCOD5600    ADD       ONE,F3XX
          UNTIL     F3XX > DIACOUNT
.
          MOVE      SAVREFNO,CURREFNO       * restore CURREFNO
          GOTO      PCOD9999
.   
.
PCOD9999  RETURN
+
.******************************************************************************
.                                  PDIA0000                                   *
.                   Process the Diagnosis record selected (MEHDIAaf)          *
.******************************************************************************
PDIA0000  MOVE      ZERO,EXIT 
.         Check which diagnosis type is in use (will be ICD10 or AXIS not both)
.         
          MOVE      ZERO,DIAGICD
          MOVE      SP8,DIAGDATE
          MOVE      NSTRTTIM,DIAGTIME       * set default 00:00:00
          MATCH     SP9,MHDIICD1            * ICD codes
          IF        @EQUAL
            MATCH     SP9,MHDIX1CA          * AXIS (DSM4) codes
            IF        @EQUAL
              MATCH     SP9,MHDIX2CA
              IF        @EQUAL
                GOTO      PDIA9000          * didn't find a code
              ENDIF
            ENDIF
            MOVE      ZERO,DIAGICD
            MOVE      MHDIDATE,DIAGDATE     * set the AXIS Diag. Date
          ELSE
            MOVE      ONE,DIAGICD
            MOVE      MHDIDATE,DIAGDATE     * set the ICD Diag. Date
          ENDIF
.
.
.         Check if date of diagnosis is less than or equal to extract end date
.
          MATCH     DIAGDATE,EFFEDATE
          GOTO      PDIA9000 IF LESS
.
.         Check if date of diagnosis is greater than or equal to ref/adm.date
.
.                                           * check Diag. is not before "RD" or
.                                           * first "AT" record
          MATCH     "20080701",EFFSDATE                               *C-258616
          IF        @LESS
            MATCH     EFFSDATE,DIAGDATE
            GOTO      PDIA9000 IF LESS
.------------------------------------------------------------ *T0859538-start
.-------- Commented out below code and derive diagnosis start time in SCCN5100
.---------ELSE
.---------  MATCH     FRSTATDT,DIAGDATE
.---------  IF        @LESS | @EQUAL
.---------    MOVE      FRSTATDT,DIAGDATE
.---------    MOVE      FRSTATTM,DIAGTIME
.---------  ENDIF  ------------------------------------------ *T0859538-end
          ENDIF
.
.                                           * found a Diagnosis - set up "CN"
PDIA5000  MOVE      XHOSPID,PHORGNID        * Organisation ID
          MOVE      PURNO,PHURNUMB          * U/R Number
          MOVE      CURMOHNO,PHVISNUM       * Visit number
.
          MOVE      "6",PHRECTYP            * Write CN Record
          CALL      SCCN0000                * Set Diagnosis - "CN" record
          MOVE      ONE,FOUNDCN
.
          GOTO      PDIA9999                * finished processing
.
PDIA9000  MOVE      ONE,EXIT
.
PDIA9999  RETURN
+
.******************************************************************************
.                                   BDATS000                                  *
.                      Build table of MEHDIAaf End Dates                      *
.******************************************************************************
BDATS000  PACK      KEY32,SP70
          MOVE      ZERO,FORM3
          REPEAT                            * initilise re-direct table
            ADD       ONE,FORM3
            MOVE      SP8,DIAGPRIM[FORM3]   * Prinary Referral
            MOVE      SP8,DIAGLINK[FORM3]   * Linked Referral
            MOVE      SP8,DIAGMOHN[FORM3]   * Referral No. to send to MoH
            MOVE      SP2,DIAGTMID[FORM3]   * Team No.
            MOVE      SP8,DIAGSDAT[FORM3]   * Start date
            MOVE      SP8,DIAGSTIM[FORM3]   * Start time
            MOVE      SP8,DIAGEDAT[FORM3]   * End date to be established
            MOVE      SP8,DIAGETIM[FORM3]   * End time
          UNTIL     FORM3 = 500          
.
          MOVE      ZERO,FORM3
          MOVE      FORM3,DIACOUNT
          UNPACK    SP70,LASTRDDT,LASTRDTM  * Final End Date/Time
          MATCH     SP8,LLREEDAT            * check if MoH Referral is closed
          IF        !@EQUAL
            MOVE      LLREEDAT,LASTRDDT
            MOVE      LLREETIM,LASTRDTM
          ENDIF
.
          COMPARE   "1",PLNKFLAG            * is this Linked Referrals process ?
          GOTO      BDATS400 IF NOT EQUAL
.
.                                           * process Linked Referrals PLNK0000
          PACK      KEY16,LINKPVIS,SP70     * link back to Primary Referral
          CALL      RSALRLN1
BDATS100  CALL      RKALRLN1
          BRANCH    OVRCD,BDATS500
.
          MATCH     ALRLVISN,LINKPVIS       * correct Visit no ?
          GOTO      BDATS500 IF NOT EQUAL
.
          IF        FORM3 = 0
.....       MATCH     "20080701",EFFSDATE                             *D-266318
.....       IF        @LESS  
.....         CALL      BDAXX000            * find any pre 01/07/2008 Diagnosis
.....       ENDIF
.
.....       PACK      KEY16,LINKPVIS,EFFSDATE,SP10                    *C-258616
            PACK      KEY16,LINKPVIS,FRSTATDT,SP10                    *C-266318
            CALL      RDMHDIA1
            IF        OVRCD = 1
              CALL      RSMHDIA1
BDATS200      CALL      RKMHDIA1
              BRANCH    OVRCD,BDATS250
            ENDIF
            MATCH     DMHDIADM,LINKPVIS
            GOTO      BDATS250 IF NOT EQUAL
.
            CALL      BDATX000              * check Diag. for validity
            BRANCH    EXIT,BDATS200
.
            ADD       ONE,FORM3
            MOVE      LINKPVIS,DIAGPRIM[FORM3]
            MOVE      DMHDIADM,DIAGLINK[FORM3]
            MOVE      LINKMOHV,DIAGMOHN[FORM3]
            MOVE      LINKTMID,DIAGTMID[FORM3]
            MOVE      MHDIDATE,DIAGSDAT[FORM3]
            MOVE      MHDICTIM,DIAGSTIM[FORM3]
            GOTO      BDATS200
          ENDIF
.
....S250  PACK      KEY16,ALRLLNKV,EFFSDATE,SP10                      *C-258616
BDATS250  PACK      KEY16,ALRLLNKV,FRSTATDT,SP10                      *C-266318
          CALL      RDMHDIA1
          IF        OVRCD = 1
            CALL      RSMHDIA1
BDATS300    CALL      RKMHDIA1
            BRANCH    OVRCD,BDATS100
          ENDIF
          MATCH     DMHDIADM,ALRLLNKV
          GOTO      BDATS100 IF NOT EQUAL
.
          CALL      BDATX000                * check Diag. for validity
          BRANCH    EXIT,BDATS300
.
          ADD       ONE,FORM3
          MOVE      LINKPVIS,DIAGPRIM[FORM3]
          MOVE      DMHDIADM,DIAGLINK[FORM3]
          MOVE      LINKMOHV,DIAGMOHN[FORM3]
          MOVE      LINKTMID,DIAGTMID[FORM3]
          MOVE      MHDIDATE,DIAGSDAT[FORM3]
          MOVE      MHDICTIM,DIAGSTIM[FORM3]
          GOTO      BDATS300
.
.
.                                           * process Referrals from PREF0000
BDATS400  MOVE      ZERO,FORM3
          MOVE      FORM3,DIACOUNT
.....     MATCH     "20080701",EFFSDATE                               *D-266318
.....     IF        @LESS 
.....       CALL      BDAXX000              * find any pre 01/07/2008 Diagnosis
.....     ENDIF
.
.....     PACK      KEY16,CURREFNO,EFFSDATE,SP10                      *C-258616
          PACK      KEY16,CURREFNO,FRSTATDT,SP10                      *C-266318
          CALL      RDMHDIA1
          IF        OVRCD = 1
            CALL      RSMHDIA1
BDATS450    CALL      RKMHDIA1
            BRANCH    OVRCD,BDATS500
          ENDIF
          MATCH     DMHDIADM,CURREFNO
          GOTO      BDATS500 IF NOT EQUAL
.
          CALL      BDATX000                * check Diag. for validity
          BRANCH    EXIT,BDATS450
.
          ADD       ONE,FORM3
          MOVE      CURREFNO,DIAGPRIM[FORM3]
          MOVE      DMHDIADM,DIAGLINK[FORM3]
          MOVE      CURREFNO,DIAGMOHN[FORM3]
          MOVE      SP8,DIAGTMID[FORM3]
          MOVE      MHDIDATE,DIAGSDAT[FORM3]
          MOVE      MHDICTIM,DIAGSTIM[FORM3]
          GOTO      BDATS450
.
.                                           * tricky bit - set End dates
BDATS500  MOVE      FORM3,DIACOUNT
          MOVE      "1",FORM3
          REPEAT
            MOVE      "99999999",DIAGEDAT[FORM3] * set End-Date to "99999999"
            MOVE      "1",F3
            REPEAT                          * find the next date    
              IF        FORM3 <> F3
                MATCH     DIAGPRIM[FORM3],DIAGLINK[FORM3]   * is it the Primary
                IF        @EQUAL
                  MATCH     DIAGSDAT[F3],DIAGSDAT[FORM3]    * it's the Primary
                  IF        @LESS 
                    MATCH     DIAGEDAT[FORM3],DIAGSDAT[F3]
                    IF        @LESS
                      MOVE      DIAGSDAT[F3],DIAGEDAT[FORM3]
....                  MOVE      DIAGSTIM[F3],DIAGETIM[FORM3]    * why ???
                      MOVE      NENDTIME,DIAGETIM[FORM3]
                    ENDIF
                  ENDIF
                ELSE
                  MATCH     DIAGSDAT[F3],DIAGSDAT[FORM3]    * it's not Primary
                  IF        @LESS | @EQUAL
                    MATCH     DIAGEDAT[FORM3],DIAGSDAT[F3]
                    IF        @LESS
                      MOVE      DIAGSDAT[F3],DIAGEDAT[FORM3]
....                  MOVE      DIAGSTIM[F3],DIAGETIM[FORM3]    * why ???
                      MOVE      NENDTIME,DIAGETIM[FORM3]
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
              ADD       ONE,F3
            UNTIL     F3 > DIACOUNT
            ADD       ONE,FORM3 
          UNTIL     FORM3 > DIACOUNT
.
          MOVE      "1",FORM3               * insert End Date (if applic)
          REPEAT
            MATCH     "99999999",DIAGEDAT[FORM3]
            IF        @EQUAL
              MOVE      LASTRDDT,DIAGEDAT[FORM3]
              MOVE      LASTRDTM,DIAGETIM[FORM3]
            ENDIF
            MATCH     SP8,LASTRDDT
            IF        !@EQUAL
              MATCH     LASTRDDT,DIAGEDAT[FORM3]
              IF        !@LESS
                MOVE      LASTRDDT,DIAGEDAT[FORM3]
                MOVE      LASTRDTM,DIAGETIM[FORM3]
              ENDIF
            ENDIF
            ADD       ONE,FORM3 
          UNTIL     FORM3 > DIACOUNT
          
BDATS999  RETURN
.
.*****************************************************************************
.                                     BDATX000
.******************************************************************************
BDATX000  MOVE      ZERO,EXIT
                                            * bit from PDIA0000 - check if reqd.
          MATCH     SP9,MHDIICD1            * ICD codes
          IF        @EQUAL
            MATCH     SP9,MHDIX1CA          * AXIS (DSM4) codes
            IF        @EQUAL
              MATCH     SP9,MHDIX2CA
              IF        @EQUAL
                GOTO      BDATX900          * didn't find a code
              ENDIF
            ENDIF
            MOVE      MHDIDATE,DIAGDATE  
          ELSE
            MOVE      MHDIDATE,DIAGDATE   
          ENDIF
.
          MATCH     "20080701",ALRERDAT                               *C-258616
          IF        !@LESS 
            MATCH     ALRERDAT,DIAGDATE     * checking the diagnosis date
            GOTO      BDATX900 IF LESS
          ENDIF
.
          MATCH     DIAGDATE,EFFEDATE
          GOTO      BDATX900 IF LESS
          GOTO      BDATX999
.
BDATX900  MOVE      ONE,EXIT
.
BDATX999  RETURN
.
.*****************************************************************************
.                                     BDAXX000
.                       set up a pre 01/07/2008 Diagnosis
.******************************************************************************
BDAXX000  MOVE      ZERO,EXIT
          MOVE      "20080701",KEY8
          PACK      KEY16,CURREFNO,KEY8,SP10                          *C-256616
          CALL      RDMHDIA1
BDAXX100  CALL      RPMHDIA1
          BRANCH    OVRCD,BDAXX999
.
          MATCH     DMHDIADM,CURREFNO
          GOTO      BDAXX999 IF NOT EQUAL
.
          CALL      BDATX000              * check Diag. for validity
          BRANCH    EXIT,BDAXX100
.
          ADD       ONE,FORM3
          MOVE      LINKPVIS,DIAGPRIM[FORM3]
          MOVE      DMHDIADM,DIAGLINK[FORM3]
          MOVE      LINKMOHV,DIAGMOHN[FORM3]
          MOVE      LINKTMID,DIAGTMID[FORM3]
          MOVE      MHDIDATE,DIAGSDAT[FORM3]
          MOVE      MHDICTIM,DIAGSTIM[FORM3]
.
BDAXX999  MOVE      ZERO,EXIT
          RETURN
+
.******************************************************************************
.                                      LGST0000                               *
.                         Processing Legal Status                             *
.******************************************************************************
LGST0000  MOVE      ZERO,EXIT
          DISPLAY   *P1:24,*EL,*V2LON,"Processing Legal Status - ":
                    *BLINKON," Please Wait",*HOFF;
.
..........MOVE      MHCNORID,XHOSPID        * set Hospital Id. (default)
          MOVE      SAVSSORG,XHOSPID        * Default Hosp Id       * C-0833934
.
          PACK      KEY32,SP70
          CALL      RSMHDLS1
LGST1000  CALL      RKMHDLS1
          BRANCH    OVRCD,LGST9999
.
          PACK      KEY16,MHDLURNO,MHDLUNIQ,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,LGST1000
.
.                                            ******** Testing Option only *****
          IF        OPTION = 2
            MATCH     "       1",TSTURNO 
            GOTO      LGST9999 IF EQUAL
            MATCH     SP8,TSTURNO
            GOTO      LGST1500 IF EQUAL
            MATCH     TSTURNO,MHDLURNO
            GOTO      LGST1000 IF NOT EQUAL * bypass everything else
          ENDIF                             ******** end Testing Option *****
.
.-------- Check if MH control parameter - Record Resp.DHB on    *T0856086-start
.-------- Legal Status is set, then check if DHB on MH LS header
.-------- (mehhlsaf.MHHLRDHB) matches with the keyed in DHB.
LGST1500  MATCH     "1",MHCNRDHB            * Record Resp. DHB on LS ?
          IF        @EQUAL
            MATCH     SAVDHBCD,MHHLRDHB       * Resp DHB same as selected DHB?
            GOTO      LGST1000 IF NOT EQUAL    * No, read next mehhlsaf rec
          ENDIF
.                                                               *T0856086-end
.
          MOVE      ZERO,DELFLAG
          MATCH     "Y",MHDLSENT
          GOTO      LGST2000 IF EQUAL     * Already sent
.
          MATCH     "0",MHDLACTV          * Active?
          GOTO      LGST1000 IF NOT EQUAL
.
          MATCH     MHDLSDAT,ENDDATE
          GOTO      LGST1000 IF LESS
          GOTO      LGST4000
.
.         Already been sent, if it is Inactive and updated date is within
.         the Extract date range, then send a DELETED LS record
.
LGST2000  MATCH     "1",MHDLACTV          * In-Active?
          GOTO      LGST1000 IF NOT EQUAL
.
          MATCH     STRTDATE,MHDLUDAT
          GOTO      LGST1000 IF LESS
.
          MATCH     MHDLUDAT,ENDDATE
          GOTO      LGST1000 IF LESS
.
          MOVE      ONE,DELFLAG
.
.         Check if Indicator 9 of Legal status code is not equal to "X"
.
LGST4000  PACK      KEY5,ANSL,ANSS,MHDLSCOD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LGST1000
.
          MATCH     "X",TCINDC9
          GOTO      LGST1000 IF EQUAL
.
.         Check if Indic 1 of Legal status is not equal to "I" (Informal)
.
          MATCH     "I",TCINDC1
          GOTO      LGST1000 IF EQUAL
.
          MOVE      MHDLURNO,PURNO
          MOVE      MHDLURNO,KEY8
          CALL      RDMAST1
          IF        PTCNNHII=1
            MOVE      MHDLURNO,KEY8                    * was ALREURNO *C-193526
            CALL      RDNHMAS2
            IF        OVRCD=0
              MOVE      NHMAURNO,PURNO
              MOVE      NHMASEX,PSEX
              MOVE      NHMADOB,PBDATE
            ENDIF
          ENDIF
.
          MOVE      XHOSPID,PHORGNID       * Organisation ID
          MOVE      PURNO,PHURNUMB         * U/R Number
          MOVE      MHDLUNIQ,PHVISNUM      * Visit number
.
          MOVE      "8",PHRECTYP           * Write LS Record
          CALL      STLS0000               * Set Legal Status - LS record
          BRANCH    EXIT,LGST1000          * LS blank - don't send
.
          CALL      WRTM0000               * Write to tempfile
.
          BRANCH    DELFLAG,LGST1000       * Sent Deleted record
.
.-------- Check if running in test mode then DO NOT update     *T0863982-start
.-------- this MH Legal Status Detail Record as sent
          MATCH     "1",MHCNELIV
          GOTO      LGST1000 IF NOT EQUAL                      *T0863982-end
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT          * date updated
          CLOCK     TIME,MHDLUTIM          * time updated
          MOVE      PASSCODE,MHDLUUID      * web user id
.
          MOVE      "Y",MHDLSENT
          CALL      UPMHDLS1
          GOTO      LGST1000
.
LGST9999  RETURN
+
.******************************************************************************
.                 Update date/time of Extract                                 *
.******************************************************************************
UPXT0000  READ      CONTROLF,SIXTY9;*122,MHCNEDAT,*130,MHCNETIM:
                                    *134,MHCNENUM
          CALL      IBACLOCK
          MATCH     CURRDATE,MHCNEDAT           * change of date ?
          IF        @LESS
            MOVE      CURRDATE,MHCNEDAT         * set today's date
            MOVE      "000",MHCNENUM            * reset today's run number
          ENDIF
          UNPACK    CTIMEIS,KEY2,KEY1,DIM2
          PACK      MHCNETIM,KEY2,DIM2          * time updated
.
          MOVE      ZERO,F3
          MOVE      MHCNENUM,F3
          ADD       ONE,F3
          MOVE      F3,MHCNENUM                 * Last Extract Number
          REP       " 0",MHCNENUM
.
          WRITAB    CONTROLF,SIXTY9;*122,MHCNEDAT,*130,MHCNETIM:
                                    *134,MHCNENUM
.
          DISPLAY   *P1:24,*EL,"Extraction completed"
.
UPXT9999  RETURN
+
.******************************************************************************
.*                                CREA0000                                    *
.*                          Create a tempfile                                 *
.******************************************************************************
CREA0000  CLEAR     PRIMEXFL
          APPEND    "primhd",PRIMEXFL
          APPEND    PORT,PRIMEXFL
          RESET     PRIMEXFL
          REP       " 0",PRIMEXFL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      XPRIMHED,PRIMEXFL
          BRANCH    OVRCD,CREA1000
          TRAPCLR   IO
          CALL      CLER0000                * clear existing temp file
          GOTO      CREA2000
.
CREA1000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    PRIMEXFL,CMDLINE
          APPEND    " 210 u1-8,9-16,17-24,25-25,26-30,31-33",CMDLINE
          APPEND    SP30,CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
          OPEN      XPRIMHED,PRIMEXFL
.
.
CREA2000  CLEAR     LINKFNAM
          APPEND    "meh16a",LINKFNAM
          APPEND    PORT,LINKFNAM
          RESET     LINKFNAM
          REP       " 0",LINKFNAM
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      LINKREF1,LINKFNAM
          BRANCH    OVRCD,CREA3000
          TRAPCLR   IO
          CALL      CLER5000                * clear existing temp file
          GOTO      CREA9999
.
CREA3000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    LINKFNAM,CMDLINE
          APPEND    " 99 U1-8,9-9,10-11,12-14 U23-30,1-8",CMDLINE     *C-260954
          APPEND    SP30,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
....      CLEAR     CMDLINE                                           *D-260954
....      APPEND    "isadd ",CMDLINE
....      APPEND    LINKFNAM,CMDLINE
....      APPEND    " U23-30,1-8",CMDLINE
....      APPEND    SP70,CMDLINE
....      RESET     CMDLINE
....      EXECUTE   CMDLINE,TASKID
.
          OPEN      LINKREF1,LINKFNAM
          OPEN      LINKREF2,LINKFNAM                        * end    *I-213741
.
.
CREA9999  RETURN
+
.******************************************************************************
.*                                    CLER0000                                *
.*                           Delete records from tempfile                     *
.******************************************************************************
CLER0000  MOVE      SP70,KEY33
          CALL      RSPRMH1
          CALL      RKPRMH1
          BRANCH    OVRCD,CLER9999
.
          PACK      KEY33,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                          PHUNQNUM,PHSRUNQN,SP70
          CALL      DEPRMH1
          GOTO      CLER0000
          
.
CLER5000  OPEN      LINKREF1,LINKFNAM
          OPEN      LINKREF2,LINKFNAM
CLER6000  MOVE      SP70,KEY14                               * start  *I-213741
          CALL      RSLREF1
          CALL      RKLREF1
          BRANCH    OVRCD,CLER9999
.
          PACK      KEY14,LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ,SP20
          CALL      DELREF1
          GOTO      CLER6000                                 * end    *I-213741
.
CLER9999  RETURN
+
.******************************************************************************
.                                    KILL0000
.                             Clear up temp Tables              
.******************************************************************************
KILL0000  CLOSE     XPRIMHED
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    PRIMEXFL,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.         
.
KILL1000  CLOSE     LINKREF1
          CLOSE     LINKREF2
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    LINKFNAM,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
KILL9999  RETURN
+
.******************************************************************************
.                                    SRRD0000
.                         Setup RD variables for Referral
.******************************************************************************
SRRD0000  MOVE      ZERO,EXIT
          MOVE      ZERO,EXLRDACT           * Reset Exclude RD flag  *T0875375
          PACK      XXRDFVER,MHCNPHVR,SP70  * PRIMHD file version parameter
          PACK      XXRDRFID,CURREFNO,SP70
.
          PACK      XXRDSORG,SAVSSORG,SP70  * Submitting Org Id      *C-0833934
. 
          PACK      XXRDORID,XHOSPID,SP70   * Organisation Id.
          PACK      XXRDOTYP,MHCNOTYP,SP70  * Organisation Type parameter
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
.
          PACK      XXRDFDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,NSTRTTIM,SP7
.
          UNPACK    ENDDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     CURRDATE,ENDDATE                          * start *C-209439
          IF        @LESS
            PACK      XXRDTDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,NENDTIME,SP7
          ELSE
            PACK      XXRDTDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,EXTRTIME,SP7
          ENDIF                                               * end   *C-209439
.
          MOVE      ZERO,REFLSTAT                                    *C-0837897
          MOVE      ALRESTAT,REFLSTAT                                *C-0837897
.
          PACK      XXRDDELT,SP70           * test for "Deleted" "RD" record
          IF        CURRSTAT = 4 | CURRSTAT = 5 | REFLSTAT = 4
.-----------MOVE      "DELETED",XXRDDELT                             *T0860342
.                                           * check if Ref'l has ever been sent
            PACK      KEY19,CURREFNO,SP20                     * start *I-203923
            CALL      RSMHPRD2
            CALL      RKMHPRD2
            MATCH     CURREFNO,MHPDVISN
            IF        @EQUAL
              MOVE      "DELETED",XXRDDELT                           *T0860342
              GOTO      SRRD2000 IF EQUAL
            ENDIF
.                                           * Referral never sent to MoH
            MOVE      ONE,EXIT              * don't write "Deleted RD"
            PACK      XXRDDELT,SP70         * Reset "Deleted" field  *C-0851539
            GOTO      SRRD9999                                * end   *I-203923
          ENDIF
.
SRRD2000  PACK      XXRDTEAM,SP70
.
          MATCH     SP70,ALREUHC4           * blank Case Team ?
          GOTO      SRRD2500 IF EQUAL
.
          UNPACK    SP70,ALCAACOD,ALCAORID,ALCAACTV
          PACK      KEY10,ALREUHC4,SP10
          CALL      RDALCAS1
          BRANCH    OVRCD,SRRD2500                           * start  *I-228416
.
.         DO NOT write an RD record if Case Team is marked as         *C-0814204
.         Active - exclude from PRIMHD extract
          MATCH     "2",ALCAACTV     * Active - exclude from PRIMHD extract?
          IF        @EQUAL
            MOVE      ONE,EXLRDACT   * Exclude RD flag                *T0875375
            MOVE      ONE,EXIT       * Yes, then do not write this record
            GOTO      SRRD9999       * Exit
          ENDIF
.
          MATCH     SP8,ALCAORID
          IF        !@EQUAL
            PACK      XXRDORID,ALCAORID,SP20
          ENDIF                                              * end    *I-228416
.
          MATCH     SP10,ALCAACOD
          GOTO      SRRD2500 IF EQUAL
.
          PACK      XXRDTEAM,ALCAACOD,SP10
          GOTO      SRRD3000
.
SRRD2500  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      SP70,KEY6
            MOVE      PTCDASC2,KEY6
            SQUEEZE   KEY6
            PACK      XXRDTEAM,KEY6,SP70
          ENDIF
.
SRRD3000  MOVE      ALREURNO,KEY8
          SQUEEZE   KEY8                    * Event HCU Id. is char 7
          PACK      XXRDEHCU,KEY8,SP70
          PACK      XXRDPSEX,PSEX,SP70
. Task 0897201
          PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,THCSCOD
            IF        !@EQUAL
              PACK      XXRDPSEX,THCSCOD,SP70
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDPDOB,XCENT,XYEAR,DSH,XMON,DSH,XDAY,SP70
.
          PACK      TRNSRCCO,ALRESRCE,SP70                            *I-190929
          MOVE      "R",TRNSRCTY            * set ref.type to A/H "R"eferral
          MOVE      "F",TRNSRCFT            * set From/To indicator
          MOVE      "S ",KEY2
          PACK      TRNSRCKY,KEY2,ALRESRCE,SP70    * key for Cat.Codes
          CALL      TRNSRC00                * find Referral Transfer Source
          PACK      XXRDRFFR,TRNSRCCO,SP70
.
.                                           * "Referral To"
SRRD4000  PACK      XXRDRFTO,SP70
.                                                             * start *C-207921
          MOVE      ALRESTAT,KEY1
          REP       "2-3-4-5-",KEY1                                  *C-0837897
          MATCH     "-",KEY1                * check for ALRESTAT = 2,3,4 or 5
          GOTO      SRRD6000 IF NOT EQUAL
.
.                                           * a non-Master/Primary Referral ?
          MATCH     "2",ALRESTAT       
          IF        !@EQUAL
            REP       " 0",ALREUYN4
            MATCH     "0",ALREUYN4
            IF        @EQUAL
              MOVE      XXRDRFFR,XXRDRFTO     * route back to original referrer
              GOTO      SRRD6000
            ENDIF    
          ENDIF
.                                           * "Rejected" Referral ?
.         MATCH     "5",ALRESTAT
.         IF        @EQUAL
          MOVE      ZERO,F1
          MOVE      ALRESTAT,F1
..........IF        F1=3 |  F1=5                                     *C-0837897
          IF        F1=3 | F1=4 | F1=5
            MOVE      XXRDRFFR,XXRDRFTO     * route back to original referrer
            GOTO      SRRD6000
          ENDIF
.                                                               * end *C-207921
.
SRRD5000  MATCH     "2",ALRESTAT
          GOTO      SRRD6000 IF NOT EQUAL
.
          MATCH     SP70,ALREUC33                                     *C-190929
          GOTO      SRRD6000 IF EQUAL
.
          PACK      TRNSRCCO,SP70                                     *I-190929
          MOVE      "R",TRNSRCTY            * set ref.type to A/H "R"eferral
          MOVE      "T",TRNSRCFT            * set From/To indicator
          MOVE      "lG",KEY2               * Cat."lG"
          PACK      TRNSRCKY,KEY2,ALREUC33,SP70    * key for Cat.Codes
          CALL      TRNSRC00                * find Referral Transfer Source
          PACK      XXRDRFTO,TRNSRCCO,SP70
.
SRRD6000  PACK      XXRDREND,SP70           * Referral End date/time
          PACK      XXRDECOD,SP70
.
          MATCH     "2",ALRESTAT            * Closed?
          IF        @EQUAL
            MOVE      "LL",TCODE
            PACK      KEY5,TCODE,ALRERCLO,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      XXRDECOD,THCSCOD,SP70
            ENDIF
            MATCH     SP8,ALREDCLO          * test used for re-opened link Refs
            IF        !@EQUAL
              UNPACK   ALREDCLO,XCENT,XYEAR,XMON,XDAY
              PACK     XXRDREND,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALRETCLO,SP70
            ENDIF
          ENDIF
.
          MATCH     "3",ALRESTAT            * Inactive?
          IF        @EQUAL
            MOVE      "LI",TCODE
            PACK      KEY5,TCODE,ALRERINA,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      XXRDECOD,THCSCOD,SP70
            ENDIF
            MATCH     SP8,ALREDINA          * test used for re-opened link Refs
            IF        !@EQUAL
              UNPACK   ALREDINA,XCENT,XYEAR,XMON,XDAY
              PACK     XXRDREND,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALRETINA,SP70
            ENDIF
          ENDIF
.
.         *C-0837897 - Cancelled Referral
.
          MATCH     "4",ALRESTAT            * Cancelled?
          IF        @EQUAL
            MOVE      "LN",TCODE
            PACK      KEY5,TCODE,ALRERCAN,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      XXRDECOD,THCSCOD,SP70
            ENDIF
            MATCH     SP8,ALREDCAN          * test used for re-opened link Refs
            IF        !@EQUAL
              UNPACK   ALREDCAN,XCENT,XYEAR,XMON,XDAY
              PACK     XXRDREND,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALRETCAN,SP70
            ENDIF
          ENDIF
.
          MATCH     "5",ALRESTAT            * Rejected?
          IF        @EQUAL
            MOVE      "rr",TCODE
            PACK      KEY5,TCODE,ALRESREJ,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      XXRDECOD,THCSCOD,SP70
            ENDIF
            MATCH     SP8,ALRESRDT          * test used for re-opened link Refs
            IF        !@EQUAL
              UNPACK   ALRESRDT,XCENT,XYEAR,XMON,XDAY
              PACK     XXRDREND,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALRESRTM,SP70
            ENDIF
          ENDIF
.
          UNPACK    ALRERDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDRSTR,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALREUTM6,SP70
.
          PACK      DIM170,XXRDFVER,XXRDRFID,XXRDSORG,XXRDORID,XXRDOTYP:
                           XXRDFDAT,XXRDTDAT,XXRDDELT,XXRDTEAM,XXRDEHCU:
                           XXRDPSEX,XXRDPDOB,XXRDRFFR,XXRDRFTO,XXRDECOD:
                           XXRDRSTR,XXRDREND,SP70,SP70
SRRD9999  RETURN
+
.******************************************************************************
.                                   SEAT0000
.                  Setup AT variables for Referral Encounter
.******************************************************************************
SEAT0000  MOVE      ZERO,EXIT
.
          PACK      XXATRFID,CURMOHNO,SP70                            *C-213741
          MOVE      "ENC",KEY3
          PACK      XXATACID,KEY3,ALENVISN,ALENENCT,SP70
.
          PACK      XXATATYP,SP70
          PACK      KEY9,ALDEDEPT,ALENSERV,SP70
          CALL      RDALSER1
          IF        OVRCD=0
            MATCH     SP70,ALSRMHDP
            GOTO      SEAT9100 IF EQUAL
.
	    PACK      XXATATYP,ALSRMHDP,SP70   * Activity Type
          ENDIF
.
          PACK      XXATASET,SP70
          MOVE      "LD",TCODE
          PACK      KEY5,TCODE,ALENLOCA,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      XXATASET,THCSCOD,SP70    * Activity setting
          ENDIF
.
          MOVE      "2",XXATFAMW               * Family/Whanau Involvement=No
          MATCH     "1",ALENUYN9
          IF        @EQUAL
            MOVE      "1",XXATFAMW             * Family/Whanau Involvement=Yes
          ENDIF
.                                              * "AT" Healthcare Worker CPN
          PACK      XXATWCPN,SP70
          PACK      KEY10,ALENHCP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            PACK      XXATWCPN,PMHCCPER,SP70   * CPN
          ENDIF
.
          UNPACK    ALENSDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXATSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALENSTIM,SP70
.
.
SEAT6000  MOVE      NENDTIME,KEY8                                     *I-200143
          MOVE      ALENSTIM,CALSTTIM                       * start   *I-236879
          MOVE      ALENDIUN,CALDURAT
          CALL      CALEND00                * calc End Time (using Duration)
          MOVE      CALENTIM,KEY8
.
          MATCH     ALREDCLO,ALENSDAT       * check Referral Date/Time closed
          IF        @EQUAL
            MATCH     CALENTIM,ALRETCLO
            IF        @LESS
              MOVE      ALRETCLO,KEY8
            ENDIF
          ENDIF
.
....      MATCH     "T35",XXATATYP          * check if "Did not Attend"
....      IF        @EQUAL
....        MOVE      ALENSTIM,KEY8         * use Start Time as End Time
....      ENDIF                                             * end     *I-236879
.
          UNPACK    ALENSDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXATEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP70
.
.-------- PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                  XXATSDAT,XXATEDAT,XXATFAMW,SP70,SP70
          PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                           XXATWCPN,XXATSDAT,XXATEDAT,SP70,SP70
.
SEAT9000  MOVE      ZERO,EXIT
          GOTO      SEAT9999
.
SEAT9100  MOVE      ONE,EXIT
.
SEAT9999  RETURN
+
.******************************************************************************
.         Setup AT variables for Referral Group Contacts
.******************************************************************************
SGAT0000  PACK      XXATRFID,CURMOHNO,SP70                            *C-213741
          MOVE      "GRP",KEY3
          PACK      XXATACID,KEY3,ALGAREFN,ALGACONT,SP70
.
          MOVE      "2",XXATFAMW              * Family/Whanau Involvement=No
          PACK      XXATATYP,SP70
          MOVE      "GA",TCODE
          PACK      KEY5,TCODE,ALGAPSTA,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      XXATATYP,THCSCOD,SP70   * Activity Type
            MATCH     ANSF,TCINDC4
            IF        @EQUAL
              MOVE    "1",XXATFAMW            * Family/Whanau Involvement=Yes
            ENDIF
          ENDIF
.
          PACK      XXATASET,SP70
          MOVE      "PO",TCODE
          PACK      KEY5,TCODE,ALGELOCN,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      XXATASET,THCSCOD,SP70   * Activity Setting
          ENDIF
.
.                                             * "AT" Healthcare Worker CPN
          PACK      XXATWCPN,SP70             * CPN
.
          MATCH     "20080701",ALGEGDTE
          IF        @LESS
            MOVE      ONE,EXIT
            GOTO      SGAT9999
          ENDIF
.
          UNPACK    ALGEGDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXATSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALGEGTIM,SP70
.
SGAT6000  MOVE      ALGEGTIM,CALSTTIM                       * start   *I-236879
          MOVE      ALGEDURN,CALDURAT
          CALL      CALEND00                * calc End Time (using Duration)
          MOVE      CALENTIM,KEY8
.
          MATCH     ALREDCLO,ALGEGDTE       * check Referral Date/Time closed
          IF        @EQUAL
            MATCH     CALENTIM,ALRETCLO
            IF        @LESS
              MOVE      ALRETCLO,KEY8
            ENDIF
          ENDIF
.
....      MATCH     "T35",XXATATYP          * check if "Did not Attend"
....      IF        @EQUAL
....        MOVE      ALGEGTIM,KEY8         * use Start Time as End Time
....      ENDIF                                             * end     *I-236879
.
          UNPACK    ALGEGDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXATEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP70
.
.-------- PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                  XXATSDAT,XXATEDAT,SP70,SP70
          PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                           XXATWCPN,XXATSDAT,XXATEDAT,SP70,SP70
.
.
SGAT9999  RETURN
+
.******************************************************************************
.         Setup AT variables for Referral Linked OP Appointments
.******************************************************************************
SOAT0000  MOVE      ZERO,EXIT
.
          PACK      XXATRFID,CURMOHNO,SP70                            *I-213741
          MOVE      "LOP",KEY3
          PACK      XXATACID,KEY3,CURREFNO,ALLNLNKV,SP70   (or DOBAOUTN)
.
          PACK      XXATATYP,SP70
.                                                                     *I-206202
          IF        OBASTAT = 5
            MOVE      "T35",XXATATYP                                  *I-206202
          ELSE
            MOVE      "CV",TCODE
            PACK      KEY5,TCODE,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      XXATATYP,THCSCOD,SP70    * Activity type
            ENDIF
          ENDIF
.
SOAT1000  PACK      XXATASET,SP70
          MOVE      "CT",TCODE
          PACK      KEY5,TCODE,OTHELTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      XXATASET,THCSCOD,SP70    * Activity setting
          ENDIF
.
          MOVE      "2",XXATFAMW               * Family/Whanau Involvement=No
.
.                                              * "AT" Healthcare Worker CPN
SOAT2000  UNPACK    SP70,OTBBADCS
          PACK      KEY8,ALLNLNKV,SP8
          CALL      RDBOKB1                    * read Linked O/P Booking record
.
          MATCH     "20080701",OBADATE
          IF        @LESS
            MOVE      ONE,EXIT
            GOTO      SOAT9999
          ENDIF
.
          PACK      XXATWCPN,SP70              *          mods for    *C-195060
          MATCH     SP70,OTBBADCS
          IF        @EQUAL
            CALL      CLIDOC00                 * check Clinic's "on Duty" Doc.
          ELSE
            PACK      KEY10,OTBBADCS,SP70      * use Outpat "Actual Seen Doctor"
          ENDIF
          MATCH     SP10,KEY10
          IF        !@EQUAL
            CALL      RDPMHCP1
            IF        OVRCD=0
              PACK      XXATWCPN,PMHCCPER,SP70   * CPN
            ENDIF
          ENDIF
.
          MOVE      ":00",KEY3                                        *I-195060
          PACK      KEY8,OBATIME,KEY3                                 *I-195060
          UNPACK    OBADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXATSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP70
.
.                                                           * start   *I-236879
SOAT4000  MOVE      NENDTIME,KEY8           * set default Time 
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SOAT5000             
.         
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SOAT5000
.         
          PACK      CALSTTIM,OBATIME,KEY3
          MOVE      OTHEDURN,CALDURAT
          CALL      CALEND00                * calc End Time (using Duration)
          MOVE      CALENTIM,KEY8
.
          MATCH     ALREDCLO,OBADATE        * check Referral Date/Time closed
          IF        @EQUAL
            MATCH     CALENTIM,ALRETCLO
            IF        @LESS
              MOVE      ALRETCLO,KEY8
            ENDIF
          ENDIF
.         
....      MATCH     "T35",XXATATYP          * check if "Did not Attend"
....      IF        @EQUAL
....        MOVE      CALSTTIM,KEY8         * use Start Time as End Time
....      ENDIF                                             * end     *I-236879
.
SOAT5000  UNPACK    OBADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXATEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP70
.
.-------- PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                  XXATSDAT,XXATEDAT,SP70,SP70
          PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                           XXATWCPN,XXATSDAT,XXATEDAT,SP70,SP70
.
SOAT9999  RETURN
+
.******************************************************************************
.               Setup "CN" variables for MH Diagnosis - IP Coded
.******************************************************************************
SICN0000  MOVE      ZERO,EXIT
.
          PACK      XXCNEVID,PHVISNUM,SP70        * (try CURMOHNO)
          ADD       ONE,CNIDCNT             * CN Unique Id. No.       *I-199520
          MOVE      CNIDCNT,KEY2                                      *I-199520
          REP       " 0",KEY2                                         *C-211806
.
          PACK      XXCNCSCD,CURREFNO,KEY2,SP70   * (try CURREFNO)    *C-199520
.
.                                           * Coding System ID
          PACK      XXCNCSYS,SP70           * find current ICD10 Edition no.
          MATCH     KEY8,PTCNI10D           * is ICD10 Ed.0 in use?
          IF        @LESS   
            MOVE      "10",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV2          * is ICD10 Ed.2 in use?
          IF        @LESS   
            MOVE      "11",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV3          * is ICD10 Ed.3 in use?
          IF        @LESS   
            MOVE      "12",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV6          * is ICD10 Ed.6 in use?
          IF        @LESS
            MOVE      "13",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV7          * is ICD10 Ed.7 in use?    *I-219246
          IF        @LESS
            MOVE      "14",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV8          * is ICD10 Ed.8 in use?    *I-284420
          IF        @LESS
            MOVE      "14",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDV9          * is ICD10 Ed.9 in use?    *I-311669
          IF        @LESS
            MOVE      "15",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDVX          * is ICD10 Ed.10 in use?   *I-0833093
          IF        @LESS
            MOVE      "15",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDX1          * is ICD10 Ed.11 in use? 
          IF        @LESS
            MOVE      "15",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDX2          * is ICD10 Ed.12 in use?   *I-0917793
          IF        @LESS
            MOVE      "16",XXCNCSYS
          ENDIF
          MATCH     KEY8,PTCNGDX3          * is ICD10 Ed.13 in use?   *I-0956210
          IF        @LESS
            MOVE      "17",XXCNCSYS
          ENDIF
.
.
          PACK      XXCNDTYP,SP70
          PACK      XXCNCCOD,SP70
          UNPACK    KEY10,XXCNDTYP,KEY9
          REP       ". ",KEY9
          REP       "- ",KEY9
          SQUEEZE   KEY9
          PACK      XXCNCCOD,KEY9,SP70
.
          PACK      XXCNICID,SP70
          PACK      XXCNITYP,SP70
          PACK      XXCNIVAL,SP70

.
          MOVE      SP70,XXCNSDAT
          MOVE      SP70,XXCNEDAT
.
          MATCH     SP70,ADATE
          IF        !@EQUAL
            UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
            PACK      XXCNSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ATIME,SP70
          ENDIF
.
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
            PACK      XXCNEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DTIME,SP70
          ENDIF
.
          PACK      DIM170,XXCNEVID,XXCNCSCD,XXCNCSYS,XXCNDTYP,XXCNCCOD:
                         XXCNICID,XXCNITYP,XXCNIVAL,XXCNSDAT,XXCNEDAT,SP70,SP70
SICN9999  RETURN
+
.******************************************************************************
.               Setup "SC" variables for Supplementary Consumer Record
.******************************************************************************
SSCR0000  MOVE      ZERO,EXIT
.
          PACK      XXSCUNIQ,MHSCCOUN,SP70
.
          PACK      XXSCWELP,SP70
          MATCH     SP70,MHSCUC01
          IF        !@EQUAL
            PACK      KEY5,LANSS,ANSA,MHSCUC01,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXSCWELP,THCSCOD,SP70
            ENDIF
          ENDIF
.
          PACK      XXSCACCM,SP70
          MATCH     SP70,MHSCUC02
          IF        !@EQUAL
            PACK      KEY5,LANSS,ANSB,MHSCUC02,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXSCACCM,THCSCOD,SP70
            ENDIF
          ENDIF
.
          PACK      XXSCEMPS,SP70
          MATCH     SP70,MHSCUC03
          IF        !@EQUAL
            PACK      KEY5,LANSS,ANSC,MHSCUC03,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXSCEMPS,THCSCOD,SP70
            ENDIF
          ENDIF
.
          PACK      XXSCEDUC,SP70
          MATCH     SP70,MHSCUC04
          IF        !@EQUAL
            PACK      KEY5,LANSS,ANSD,MHSCUC04,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXSCEDUC,THCSCOD,SP70
            ENDIF
          ENDIF
.
          UNPACK    MHSCSDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXSCCOLD,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DTIME,SP70
.
          PACK      DIM170,XXSCUNIQ,XXSCCOLD,XXSCWELP,XXSCACCM,XXSCEMPS:
                         XXSCEDUC,SP70,SP70
SSCR9999  RETURN
+
.******************************************************************************
.                                  SARD0000                                   *
.                      Setup RD variables for Admissions                      *
.******************************************************************************
SARD0000  MOVE      ZERO,EXIT              *Initalize exit flag
.         DO NOT write an RD record if the MH Inpatient visit is      *C-0814204
.         marked as Exclude from PRIMHD Extract
          MOVE      SP70,TCINDC13
          PACK      TCODE,ANSP,SP1
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SARD0100
.
          MATCH     ANSX,TCINDC13          * Exclude from PRIMHD Extract?
          GOTO      SARD0100 IF NOT EQUAL  * No, then continue
          MOVE      ONE,EXIT               * Yes, do not write this record
          GOTO      SARD9999               * Exit
.
SARD0100  PACK      XXRDFVER,MHCNPHVR,SP70
          PACK      XXRDRFID,PHVISNUM,SP70
.
          PACK      XXRDSORG,SAVSSORG,SP70  * Submitting Org Id      *C-0833934
.
          PACK      XXRDORID,XHOSPID,SP70   * Organisation Id.
          PACK      XXRDOTYP,MHCNOTYP,SP70
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
.                                                                     *C-192348
          PACK      XXRDFDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,NSTRTTIM,SP7
.
          UNPACK    ENDDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     CURRDATE,ENDDATE                          * start *C-209439
          IF        @LESS
            PACK      XXRDTDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,NENDTIME,SP7
          ELSE
            PACK      XXRDTDAT,CCENT,CYEAR,DSH,CMON,DSH,CDAY,ANST,EXTRTIME,SP7
          ENDIF                                               * end   *C-209439
.
          PACK      XXRDDELT,SP70
          IF        DELFLAG=1
            MOVE      "DELETED",XXRDDELT
          ENDIF
.
          PACK      XXRDTEAM,SP70
          MATCH     SP70,PMVXCASE
          GOTO      SARD0800 IF EQUAL
.
          PACK      ALCAACTV,SP70
          PACK      KEY10,PMVXCASE,SP10
          CALL      RDALCAS1
          BRANCH    OVRCD,SARD0800
.
.         DO NOT write an RD record if Case Team is marked as         *C-0814204
.         Active - exclude from PRIMHD extract
          MATCH     "2",ALCAACTV     * Active - exclude from PRIMHD extract?
          IF        @EQUAL
            MOVE      ONE,EXIT       * Yes, then do not write this record
            GOTO      SARD9999       * Exit
          ENDIF
.
          MATCH     SP70,ALCAACOD
          GOTO      SARD0800 IF EQUAL
.
          PACK      XXRDTEAM,ALCAACOD,SP70
          GOTO      SARD0900
.
SARD0800  MOVE      "P ",TCODE
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      SP70,KEY6
            MOVE      PTCDASC2,KEY6
            SQUEEZE   KEY6
            PACK      XXRDTEAM,KEY6,SP70
          ENDIF
.
SARD0900  MOVE      AURNO,KEY8
          SQUEEZE   KEY8                    * Event HCU Id. is char 7
          PACK      XXRDEHCU,KEY8,SP70
          PACK      XXRDPSEX,PSEX,SP70
. Task 0897201
          PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,THCSCOD
            IF        !@EQUAL
              PACK      XXRDPSEX,THCSCOD,SP70
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDPDOB,XCENT,XYEAR,DSH,XMON,DSH,XDAY,SP70
.
SARD1000  PACK      TRNSRCCO,ASRCE,SP70                               *I-190929
          MOVE      "A",TRNSRCTY            * set ref.type to "A"dmis Referral
          MOVE      "F",TRNSRCFT            * set From/To indicator
          MOVE      "S ",KEY2
          PACK      TRNSRCKY,KEY2,ASRCE,SP70    * key for Cat.Codes
          CALL      TRNSRC00                * find Referral Transfer Source
          PACK      XXRDRFFR,TRNSRCCO,SP70  * use returned value
.
          PACK      XXRDRFTO,SP70
          PACK      XXRDECOD,SP70
          PACK      XXRDREND,SP70
          COMPARE   THREE,ASTAT
          GOTO      SARD2000 IF NOT EQUAL       * Not discharged
.
          MATCH     SP70,DSTAT
          GOTO      SARD2000 IF EQUAL
.                                                                     *I-190929
          PACK      TRNSRCCO,DSTAT,SP70
          MOVE      "A",TRNSRCTY            * set ref.type to A/H "R"eferral
          MOVE      "T",TRNSRCFT            * set From/To indicator
          MOVE      "D ",KEY2
          PACK      TRNSRCKY,KEY2,DSTAT,SP70    * key for Cat.Codes
          CALL      TRNSRC00                * find Referral Transfer Source
          PACK      XXRDRFTO,TRNSRCCO,SP70
.
          MOVE      "D ",TCODE
          PACK      KEY5,TCODE,DSTAT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SARD2000
          PACK      XXRDECOD,PTCDLDES,SP70  *first 2 chars of Long Description
.                                                                     *C-190929
.
.
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDREND,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DTIME,SP70
.
SARD2000  UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDRSTR,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ATIME,SP70
.
          CALL      REFDAT00                                          *C-0306843
.
          PACK      DIM170,XXRDFVER,XXRDRFID,XXRDSORG,XXRDORID,XXRDOTYP:
                           XXRDFDAT,XXRDTDAT,XXRDDELT,XXRDTEAM,XXRDEHCU:
                           XXRDPSEX,XXRDPDOB,XXRDRFFR,XXRDRFTO,XXRDECOD:
                           XXRDRSTR,XXRDREND,SP70,SP70
.
SARD9999  RETURN
.
.******************************************************************************
. Referral start date will be extracted from Referral record when the patient
. type code (Category P) indicator 13 = 'R' and a admission is linked to the 
. referral (TSK 0306843)
.******************************************************************************
REFDAT00  PACK      TCODE,ANSP,SP1
          PACK      KEY5,TCODE,ACLSS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,REFDAT99 
.
          MATCH     ANSR,TCINDC13
          GOTO      REFDAT99 IF NOT EQUAL
.
          PACK      KEY16,AADMNO,SP70
          CALL      RSALRSA2
          CALL      RKALRSA2
          BRANCH    OVRCD,REFDAT99 
.
          MATCH     DAADMNO,ALRALADM           * Same admno found?  *T0884893
          GOTO      REFDAT99 IF NOT EQUAL      * No, exit           *T0884893
.
          PACK      KEY8,ALRAVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REFDAT99 
.
          UNPACK    ALRERDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXRDRSTR,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,ALREUTM6,SP70
.
REFDAT99  RETURN 
+
.******************************************************************************
.                                 SAAT0000
.                 Setup AT variables for Admission Transaction
.******************************************************************************
SAAT0000  MOVE      ZERO,EXIT
          PACK      XXATRFID,TADMN,SP70
          UNPACK    TDATE,KEY2,KEY6                                   *I-230234
          UNPACK    TTIME,DIM2A,KEY1,DIM2B,KEY1,DIM2C                 *C-230234
          PACK      XXATACID,TADMN,KEY6,DIM2A,DIM2B,DIM2C             *I-230234
          PACK      BDATACID,TADMN,KEY6,DIM2A,DIM2B                   *C-0832767
.
          PACK      XXATATYP,SP70              * Activity Type
.
          MOVE      SP70,SAVEASC2              * Initialize save Assc2*C-0832767
          MOVE      SP70,PTCDASC2              * Initialize Assoc2    *C-0832767
.
          MOVE      ZERO,TCFORM6                          * start     *C-256500
          MATCH     "BT",MHCNIPAT              * IP Activity Type indicator
          IF        @EQUAL
            PACK      KEY6,TWARD,TBED,SP10
            CALL      RDWARD1
            BRANCH    OVRCD,SAAT2000
            PACK      KEY5,MHCNIPAT,WEFRBT,SP10 * Tran Bed Type in Cat.BT
            CALL      RDCODE1
            BRANCH    OVRCD,SAAT2000
          ELSE
            MOVE      "A ",TCODE               * default if MHCNIPAT not "BT"
            PACK      KEY5,TCODE,TATYPE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,SAAT2000
          ENDIF
.
          MOVE      TCFORM6,F2                 * move Associate No. to XXATATYP
          MOVE      "T",KEY1
          PACK      XXATATYP,KEY1,F2,SP10
          REP       " 0",XXATATYP                         * end       *C-256500
.
          PACK      SAVEASC2,PTCDASC2,SP70     * Save Assoc2          *C-0832767
.
SAAT2000  CMATCH    "L",TMOVE
          IF        @EQUAL
            MOVE      "T37",XXATATYP
            PACK      KEY5,CATTL,PTTRLTYP
            CALL      RDCODE1
            BRANCH    OVRCD,SAAT5000
            PACK      XXATASET,THCSCOD      * Leave Activity Setting
            GOTO      SAAT5000
          ENDIF
.
          PACK      XXATASET,SP70           * create Activity Setting
.
SAAT3000  MOVE      SP1,KEY1 
          MOVE      "IP",XXATASET           * Activity Setting
..          MATCH     ADATE,DDATE                               * removed - 0324038
..          IF        @EQUAL
..            MOVE      "DP",XXATASET
..          ENDIF                                               * end   *C-203401
.
SAAT5000  MOVE      "2",XXATFAMW            * Family/Whanau Involvement=No
.
          PACK      XXATWCPN,SP70           * "AT" Healthcare Worker CPN
          PACK      KEY10,TADOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            PACK      XXATWCPN,PMHCCPER,SP70   * CPN
          ENDIF
.
          UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXATSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,TTIME,SP70
.
.         Check if there is a next transaction record
.
          UNPACK    SP70,XXATEDAT,TDATE,TTIME,TDATEAT2                *T0869116
          MOVE      ZEROVISN,TADMN          * clear Tran record
          CALL      RDKTRAN2                * read next Tran record - careful
          BRANCH    OVRCD,SAAT9000
.
          MATCH     AADMNO,TADMN
          GOTO      SAAT9000 IF NOT EQUAL
.
.         Use the next transaction date as the end date
.
SAAT6000  UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      TDATE,TDATEAT2          * Save 2nd AT end date    *T0869116
.                                                                     *C-258616
...       MATCH     STRTDATE,TDATE          * is Tran AT record in date range
          MATCH     ADATE,TDATE             * is Tran AT record after Admn Date
          IF        @LESS
            MOVE      ONE,EXIT              * end date is before Start Date
            GOTO      SAAT9999              * dont write the record
          ENDIF
.
          PACK      XXATEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,TTIME,SP70
.
.
.                                           * set up the "AT" data string
.SAAT9000  PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATWCPN:
.                           XXATSDAT,XXATEDAT,SP70,SP70 
SAAT9000  PACK      DIM170,XXATRFID,XXATACID,XXATATYP,XXATASET,XXATFAMW:
                           XXATWCPN,XXATSDAT,XXATEDAT,SP70,SP70 
.
.
.         TSK-0832767
.         Write first AT record then check for the saved value in patcodes
.         associate field 2. If a value exists, create a second activity record.
.
SAAT9010  CALL      WRTM0000                 * Write first AT record
.
          MATCH     "IP",XXATASET            * Is this an Inpatient activity
          GOTO      SAAT9999 IF NOT EQUAL    * No, exit
.
          MATCH     SP70,SAVEASC2            * Is Asc2 populated?
          GOTO      SAAT9999 IF EQUAL        * No, exit
.
.-------- T0869116-Start Do not extract seclusion AT record (T33) if the
.-------- End Date time is blank
          MATCH     SP70,TDATEAT2
          GOTO      SAAT9999 IF EQUAL
.-------- T0869116-End
.
.         Write second AT record
.         The activity ID will be BD(visit number, date and time of transfer)
.         The activity type will be T(value in associate field 2).
.         The activity setting, healthcare worker CPN, start date and time,
.         end date and time for the second activity record will be the same
.         as the first activity record
.
SAAT9020  MOVE      "BD",KEY2
          LJUSTIFY  BDATACID                        * Remove leading spaces
          PACK      SVATACID,KEY2,BDATACID,SP70     * Save BD activity ID
.
          MOVE      "T",KEY1
          PACK      XXATATYP,KEY1,SAVEASC2,SP10
          REP       " 0",XXATATYP                   * BD activity type
.
          UNPACK    SP70,KEY1,KEY2                  * Reset
.
.-------- PACK      DIM170,XXATRFID,SVATACID,XXATATYP,XXATASET,XXATWCPN:
.--------                  XXATSDAT,XXATEDAT,SP70,SP70
          PACK      DIM170,XXATRFID,SVATACID,XXATATYP,XXATASET,XXATFAMW:
                           XXATWCPN,XXATSDAT,XXATEDAT,SP70,SP70
.
          CALL      WRTM0000                        * Write second AT
.
SAAT9999  RETURN
+
.******************************************************************************
.                                    SCCN0000                                 *
.              Set "CN" variables for Diagnosis Provisional Coding            *
.******************************************************************************
SCCN0000  MOVE      ZERO,EXIT
          MOVE      SP8,PREVDIAG
.
          PACK      XXCNEVID,CURMOHNO,SP70    (not used any more)     *C-213741
.
          COMPARE   "1",DIAGICD
          GOTO      SCCN2000 IF NOT EQUAL
.
SCCN1000  MOVE      SP2,ICDEDNO             * find current ICD10 Edition no.
          MATCH     DIAGDATE,PTCNI10D       * is ICD10 Ed.0 in use?   *C-194555
          IF        @LESS   
            MOVE      "10",ICDEDNO
          ENDIF
          MATCH     DIAGDATE,PTCNGDV2       * is ICD10 Ed.2 in use?   *C-194555
          IF        @LESS   
            MOVE      "11",ICDEDNO
          ENDIF
          MATCH     DIAGDATE,PTCNGDV3       * is ICD10 Ed.3 in use?   *C-194555
          IF        @LESS   
            MOVE      "12",ICDEDNO
          ENDIF
          MATCH     DIAGDATE,PTCNGDV6       * is ICD10 Ed.6 in use?   *C-194555
          IF        @LESS   
            MOVE      "13",ICDEDNO
          ENDIF
          MATCH     DIAGDATE,PTCNGDV7       * is ICD10 Ed.7 in use?   *C-219246
          IF        @LESS
            MOVE      "14",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDV8       * is ICD10 Ed.8 in use?
          IF        @LESS
            MOVE      "14",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDV9       * is ICD10 Ed.9 in use? 
          IF        @LESS
            MOVE      "15",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDVX       * is ICD10 Ed.10 in use? 
          IF        @LESS
            MOVE      "15",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDX1       * is ICD10 Ed.11 in use?
          IF        @LESS
            MOVE      "15",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDX2       * is ICD10 Ed.12 in use?
          IF        @LESS
            MOVE      "16",ICDEDNO
          ENDIF
.
          MATCH     DIAGDATE,PTCNGDX3       * is ICD10 Ed.13 in use?
          IF        @LESS
            MOVE      "17",ICDEDNO
          ENDIF
.
SCCN2000  PACK      XXCNICID,SP70
          PACK      XXCNITYP,SP70
          PACK      XXCNIVAL,SP70
.
          PACK      XXCNSDAT,SP70
.-----------------------------------------------------------------------------
.------- *T0859538 - XXCNSDAT section commented out and moved to SCCN5100
.                                                                     * CN fix
.-------- MOVE      NSTRTTIM,DIAGTIME       * set default 00:00:00
.-------- MATCH     "20080701",DIAGDATE
.-------- IF        !@LESS
.--------   MATCH     FRSTATDT,DIAGDATE       * check "AT" Date vs CN date
.--------   IF        @LESS | @EQUAL
.--------     MOVE      FRSTATDT,DIAGDATE
.--------     MOVE      FRSTATTM,DIAGTIME     * use "AT" Start Time
.--------   ENDIF
.-------- ENDIF
.-------- UNPACK    DIAGDATE,XCENT,XYEAR,XMON,XDAY                    *C-194555
.
.-------- PACK      XXCNSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DIAGTIME,SP7
.------------------------------------------------------------------------------
.
.
          PACK      XXCNEDAT,SP70           * set blank End Date
          PACK      SKEY16,MHDIADMN,MHDIDATE,SP70     * save current DIA key
.
.                                           * is this from Linked Referrals ?
SCCN2200  IF        PLNKFLAG = 1
            MATCH     SP8,DIAEDATE          * check for End of CN Date
            IF        !@EQUAL
              UNPACK   DIAEDATE,XCENT,XYEAR,XMON,XDAY
              PACK     XXCNEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DIAETIME,SP7
            ENDIF
            GOTO      SCCN5000
          ENDIF
.
.          ----------------------- * Process Referrals & Inpatient Diagnosis
.
.         Read next diagnosis record, if any, for the "CN" End date
.
          MOVE      MHDIDATE,DIAGDATE
          MOVE      MHDIADMN,KEY8
          CALL      RKMHDIA1                * read next MEH Diag record
          BRANCH    OVRCD,SCCN4000
.
          MATCH     DMHDIADM,KEY8
          GOTO      SCCN4000 IF NOT EQUAL
.
          MATCH     MHDIDATE,EFFEDATE
          GOTO      SCCN4000 IF LESS
.
.                                           * found a new Diag. - use its Date
.                                           * for End Date of current CN
          MOVE      NENDTIME,KEY8
          MATCH     SP70,LASTRDDT
          IF        !@EQUAL
            MATCH     LASTRDDT,MHDIDATE
            IF        !@LESS
              MOVE      LASTRDDT,MHDIDATE
              MATCH     SP8,LASTRDTM
              IF        !@EQUAL
                MOVE      LASTRDTM,KEY8
              ENDIF
            ENDIF
          ENDIF
.
          UNPACK    MHDIDATE,XCENT,XYEAR,XMON,XDAY                    *C-194555
          PACK      XXCNEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP7
.
SCCN4000  MOVE      SKEY16,KEY16            * re-position on "mehdiaaf" record
          CALL      RDMHDIA1
          BRANCH    OVRCD,SCCN9999          * if key set up was wrong
.
          MATCH     SP70,XXCNEDAT           * has it been set up ?
          IF        @EQUAL
.                                           * no - use Referral End Date
            MATCH     SP70,LASTRDDT
            IF        !@EQUAL
              UNPACK    LASTRDDT,XCENT,XYEAR,XMON,XDAY
              PACK      XXCNEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,LASTRDTM,SP7
            ENDIF
          ENDIF
.
.
SCCN5000  MOVE      ZERO,F3
.
          REPEAT
            ADD       ONE,F3
.          --------------------------------------------------------------------
.           T0879584 - The following code have been moved from label SCCN5100
.           Load start date for XXCNSDAT
.           IF ICD10 Codes THEN use Diagnosis date - MHDIDAT1/2/3/4/5/6
.           IF Axis I & II Codes THEN use DSMIVR Date - MHDIXDAT
            MOVE      SP70,KEY8
            LOAD      KEY8,F3,MHDIXDAT,MHDIXDAT,MHDIXDAT,MHDIXDAT:
                              MHDIXDAT,MHDIXDAT,MHDIDAT1,MHDIDAT2:
                              MHDIDAT3,MHDIDAT4,MHDIDAT5,MHDIDAT6
            MATCH     SP70,KEY8
            GOTO      SCCN5500 IF EQUAL        * Next ICD code

.           Derive Diagnosis start time using the actual                    
.           ICD10 Diagnosis Date/DSMIVR Date
            MOVE      NSTRTTIM,DIAGTIME        * Set default 00:00:00
            MATCH     "20080701",KEY8
            IF        !@LESS
              MATCH     FRSTATDT,KEY8          * Check "AT" Date vs CN date
              IF        @LESS
                GOTO      SCCN5500             * CN<AT, Next ICD code
              ELSE
                IF        @EQUAL
                  MOVE      FRSTATTM,DIAGTIME  * CN=AT, Use AT start time
                ENDIF
              ENDIF
            ENDIF
.
            UNPACK    KEY8,XCENT,XYEAR,XMON,XDAY
            PACK      XXCNSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DIAGTIME,SP7
.
.          --------------------------------------------------------------------
.           Load Diagnosis code for XXCNCCOD
            MOVE      SP70,KEY9
            LOAD      KEY9,F3,MHDIX1CA,MHDIX1CB,MHDIX1CC,MHDIX2CA:
                              MHDIX2CB,MHDIX2CC,MHDIICD1,MHDIICD2:
                              MHDIICD3,MHDIICD4,MHDIICD5,MHDIICD6
            MATCH     SP70,KEY9
            GOTO      SCCN5500 IF EQUAL     * Next ICD code
.
.                                           * set up & write a "CN" Diag. Code
.          --------------------------------------------------------------------
.          T0879097 - DSM4 Code recorded setup XXCNDTYP as follows:
.          Any DSM4 code recorded will be set to "B" if other diagnosis
.          records (MHDIICD1-6) are recorded else set to "A" for the first
.          record and "B" for all other records
            IF        F3 < 7
              MOVE      "07",XXCNCSYS       * Use "DSM4" code
.                                                             *T0879097-start
              MATCH     SP70,MHDIICD1            * Is first ICD code entered?
              GOTO      SCCN5040 IF EQUAL | EOS   * No,set 1st to "A" then "B" 
.                                                             *T0879097-end
              MOVE      "B",XXCNDTYP              * Yes,set to "B"
              GOTO      SCCN5080
            ELSE
              MOVE      ICDEDNO,XXCNCSYS    * Use ICD Ed.? code
              GOTO      SCCN5020
            ENDIF
.
.          --------------------------------------------------------------------
.          T0856503 - ICD10 Code recorded setup XXCNDTYP as follows:
.          1)If MHDIDTYP1-6 is NOT blank then use value in MHDIDTYP1-6
.          2)If MHDIDTYP1-6 is blank then set to "A" for first record 
.                            and "B" for all other records
SCCN5020    MOVE      SP1,D1            
            LOAD      D1,F3,SP1,SP1,SP1,SP1,SP1,SP1:
                            MHDIDTYP1,MHDIDTYP2,MHDIDTYP3,MHDIDTYP4:
                            MHDIDTYP5,MHDIDTYP6
            MATCH     SP1,D1
            GOTO      SCCN5040 IF EQUAL | EOS
.
            MOVE      D1,XXCNDTYP
            GOTO      SCCN5080
.
.           -------------------------------------------------------------------
.           Setup up XXCNDTYP as "A" on change of DIAGDATE and "B" for
.           same DIAGDATE/MHDIDATE
SCCN5040    MOVE      "A",XXCNDTYP
            MATCH     PREVDIAG,DIAGDATE
            IF        @EQUAL
              MOVE      "B",XXCNDTYP
            ENDIF
.
            MOVE      DIAGDATE,PREVDIAG
            GOTO      SCCN5080
.
SCCN5080    REP       ". ",KEY9
            REP       "- ",KEY9
            SQUEEZE   KEY9
            PACK      XXCNCCOD,KEY9,SP70
.          
.-------------------------------------------------------------------------------
.--------- T0879584-Start - the following code have been commented out and
.--------- moved to label SCCN5000
.--------- TSK-0292528
.--------- Load start date for XXCNSDAT
.--------- IF ICD10 Codes THEN use Diagnosis date - MHDIDAT1/2/3/4/5/6
.--------- IF Axis I & II Codes THEN use DSMIVR Date - MHDIXDAT
.---------
.--------- SCCN5100    MOVE      SP70,KEY8
.---------  LOAD      KEY8,F3,MHDIXDAT,MHDIXDAT,MHDIXDAT,MHDIXDAT:
.---------                    MHDIXDAT,MHDIXDAT,MHDIDAT1,MHDIDAT2:
.---------                    MHDIDAT3,MHDIDAT4,MHDIDAT5,MHDIDAT6
.---------  MATCH     SP70,KEY8
.---------  GOTO      SCCN5500 IF EQUAL      * Next ICD code
.---------
.---------  Derive Diagnosis start time using the actual    *T0859538-start
.---------  ICD10 Diagnosis Date/DSMIVR Date
.---------  MOVE      NSTRTTIM,DIAGTIME         * set default 00:00:00
.--------- 
.---------  T0879584-start
.---------  MATCH     "20080701",KEY8
.---------  IF        !@LESS
.---------    MATCH     FRSTATDT,KEY8           * check "AT" Date vs CN date
.---------    IF        @LESS | @EQUAL
.---------      MOVE      FRSTATDT,KEY8
.---------      MOVE      FRSTATTM,DIAGTIME     * use "AT" Start Time
.---------    ENDIF
.---------  ENDIF
.---------                                                  *T0859538-end
.---------  UNPACK    KEY8,XCENT,XYEAR,XMON,XDAY
.---------  PACK      XXCNSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,DIAGTIME,SP7
.---------
.--------- T0879584-end--------------------------------------------------------
.
.           ------------------------------- * Unique ID needed for every Diagnos
SCCN5400    ADD       ONE,CNIDCNT           * CN Unique Id. No.
            MOVE      CNIDCNT,KEY2
            REP       " 0",KEY2
            PACK      XXCNCSCD,CURREFNO,DIAGDATE,KEY2,SP70  * <=== Id.
.
.
.                                           * concatenate data for "write"
            PACK      DIM170,XXCNEVID,XXCNCSCD,XXCNCSYS,XXCNDTYP,XXCNCCOD:
                         XXCNICID,XXCNITYP,XXCNIVAL,XXCNSDAT,XXCNEDAT,SP70,SP70
.
            CALL      WRTM0000              * Write to tempfile
            BRANCH    EXIT,SCCN9999         * write failed - bail out
.
SCCN5500    MOVE      SP1,KEY1
          UNTIL     F3 = 12
.
SCCN9999  RETURN
+
.******************************************************************************
.         Set CO variables for HONOS assessments
.******************************************************************************
SHCO0000  PACK      XXCOEVID,MHHNVISN,SP70
          UNPACK    MHHNUNIQ,KEY2,KEY6                                *I-211806
          SQUEEZE   KEY6                                              *I-211806
          PACK      XXCOCCOD,MHHNVISN,MHHNHDAT,KEY6,SP70              *C-211806
          MOVE      "RC",KEY2
          MOVE      SP70,DIM2
          MOVE      "hp",TCODE
          PACK      KEY5,TCODE,MHHNREAS,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,DIM2
          ENDIF
          PACK      XXCORCOL,KEY2,DIM2,SP70
.          
SHCO1000  UNPACK    MHHNHDAT,XCENT,XYEAR,XMON,XDAY    * Collection Occasion date
          MOVE      NSTRTTIM,KEY8                                     *I-200143
          MATCH     EFFSDATE,MHHNHDAT
          IF        @EQUAL
            MOVE      EFFSTIME,KEY8
          ENDIF
          PACK      XXCOCDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,KEY8,SP70
.
          PACK      XXCOWCPN,SP70
          PACK      KEY10,MHHNRHCP,SP70                   * was PHCP  *C-193844
          CALL      RDPMHCP1
          IF        OVRCD=0
            PACK      XXCOWCPN,PMHCCPER,SP70   * CPN
          ENDIF
.
          UNPACK    SP70,XXCOOESP              * blank Outcome Episode ID
          UNPACK    SP70,XXCOPVER,XXCOFCAR     * blank                *C-210949
.
          MOVE      "hv",TCODE
          PACK      KEY5,TCODE,MHHNHVER,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ZERO,FORM4
            MOVE      TCFORM6,FORM4
            MOVE      FORM4,XXCOPVER            * Protocol version
            REP       " 0",XXCOPVER                                   *M-210949
          ENDIF
.
.                                                             * start *I-210949
          MOVE      "hs",TCODE
          PACK      KEY5,TCODE,MHHNHOTY,SP70
          CALL      RDCODE1
          IF        OVRCD=0
           MATCH     "C",TCINDC1
           GOTO      SHCO4000 IF EQUAL      * it' a Child - bypass FOCUS_OF_CARE
          ENDIF                                               * end   *I-210949
.
.-------- Set XXCOFCAR to blank if Focus of Care is not recorded    ' *T0900868
          MATCH     SP70,MHHNFOCU
          IF        @EQUAL | @EOS
            PACK    XXCOFCAR,SP70
            GOTO    SHCO4000
          ENDIF
.
          MOVE      "FC",KEY2
          MOVE      SP70,DIM2
          MOVE      "hf",TCODE
          PACK      KEY5,TCODE,MHHNFOCU,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,DIM2              * Focus of Care
            REP       " 0",DIM2
          ENDIF
          PACK      XXCOFCAR,KEY2,DIM2,SP70
.
SHCO4000  PACK      DIM170,XXCOEVID,XXCOCCOD,XXCORCOL,XXCOCDAT:
                           XXCOWCPN,XXCOOESP,XXCOPVER,XXCOFCAR,SP70,SP70
.
SHCO9999  RETURN
+
.******************************************************************************
.         Set OT and OI variables for HONOS assessments
.******************************************************************************
OTOI0000  PACK      XXOTEVID,SP70
          PACK      XXOTOITM,SP70
          PACK      XXOTTYPE,SP70
          PACK      XXOTMADM,SP70
          PACK      XXOTCSTA,SP70
          PACK      XXOTCDAT,SP70
.
          PACK      XXOIEVID,SP70
          PACK      XXOIOITM,SP70
          PACK      XXOITYPE,SP70
          PACK      XXOIIVAL,SP70
.
          MOVE      "hs",TCODE
          PACK      KEY5,TCODE,MHHNHOTY,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,KEY2
            REP       " 0",KEY2
            PACK      XXOTTYPE,KEY2,SP70         * Outcome tool type version
          ENDIF
.
.         Set up the Outcome item codes from Tool type
.
          MATCH     SP70,XXOTTYPE
          GOTO      OTOI9999 IF EQUAL
.
          PACK      XXOTEVID,MHHNVISN,MHHNHDAT,SP70
          PACK      XXOIEVID,MHHNVISN,MHHNHDAT,SP70
.
          MOVE      "MA",KEY2
          MOVE      SP70,DIM2
          MOVE      "hm",TCODE
          PACK      KEY5,TCODE,MHHNMODA,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,DIM2
            REP       " 0",DIM2
          ENDIF
          PACK      XXOTMADM,KEY2,DIM2,SP70        * Mode of Administration
.
          MOVE      "CS",KEY2
          MOVE      SP70,DIM2
          MOVE      "ht",TCODE
          PACK      KEY5,TCODE,MHHNCOLS,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,DIM2
            REP       " 0",DIM2
          ENDIF
          PACK      XXOTCSTA,KEY2,DIM2,SP70        * Collection status
.
          UNPACK    MHHNDATF,XCENT,XYEAR,XMON,XDAY    * Completion date
          MATCH     SP8,MHHNTIMF
          IF        @EQUAL
            PACK      MHHNTIMF,NENDTIME,SP10
          ENDIF
          PACK      XXOTCDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,MHHNTIMF,SP7
.
          MATCH     "A1",XXOTTYPE           * Outcome Tool Type
          GOTO      OTOI1000 IF EQUAL
          MATCH     "G1",XXOTTYPE
          GOTO      OTOI1000 IF EQUAL
.
          MATCH     "S1",XXOTTYPE
          GOTO      OTOI2000 IF EQUAL
          MATCH     "L1",XXOTTYPE
          GOTO      OTOI3000 IF EQUAL
          MATCH     "M1",XXOTTYPE
          GOTO      OTOI4000 IF EQUAL
          MATCH     "I1",XXOTTYPE
          GOTO      OTOI0500 IF EQUAL
.
          MATCH     "C1",XXOTTYPE
          GOTO      OTOI9999 IF NOT EQUAL
.
OTOI0500  CALL      SC1T0000           * set OT and OI record for C1 tool type
          GOTO      OTOI9999
.
OTOI1000  CALL      SAGT0000           * set OT and OI record for A1/G1 tooltype
          GOTO      OTOI9999
.
OTOI2000  CALL      SS1T0000           * set OT and OI record for S1 tool type
          GOTO      OTOI9999
.
OTOI3000  CALL      SL1T0000           * set OT and OI record for L1 tool type
          GOTO      OTOI9999
.
OTOI4000  CALL      SM1T0000           * set OT and OI record for M1 tool type
          GOTO      OTOI9999
.
OTOI9999  RETURN
+
.******************************************************************************
.         Set OT OI record for A1/G1 tool type
.******************************************************************************
SAGT0000  MOVE      ZERO,EXIT
          PACK      KEY13,MHHNADQ1,MHHNADQ2,MHHNADQ3,MHHNADQ4,MHHNADQ5:
                          MHHNADQ6,MHHNADQ7,MHHNADQ8,MHHNAQ8A,MHHNADQ9:
                          MHHNAQ10,MHHNAQ11,MHHNAQ12,SP20
          MATCH     SP13,KEY13
          GOTO      SAGT9999 IF EQUAL
.
          PACK      DIM170,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA:
                           XXOTCDAT,SP70,SP70
.
          MOVE      "3",PHRECTYP           * Write OT Record
          CALL      WRTM0000               * Write to tempfile
.
SAGT1000  MATCH      SP1,MHHNADQ1
          IF        !@EQUAL
            MOVE      "01 ",XXOIOITM
            MOVE      MHHNADQ1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ2
          IF         !@EQUAL
            MOVE      "02 ",XXOIOITM
            MOVE      MHHNADQ2,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
. 
          MATCH      SP1,MHHNADQ3
          IF         !@EQUAL
            MOVE      "03 ",XXOIOITM
            MOVE      MHHNADQ3,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ4
          IF         !@EQUAL
            MOVE      "04 ",XXOIOITM
            MOVE      MHHNADQ4,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ5
          IF         !@EQUAL
            MOVE      "05 ",XXOIOITM
            MOVE      MHHNADQ5,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ6
          IF         !@EQUAL
            MOVE      "06 ",XXOIOITM
            MOVE      MHHNADQ6,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ7
          IF         !@EQUAL
            MOVE      "07 ",XXOIOITM
            MOVE      MHHNADQ7,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ8
          IF         !@EQUAL
            MOVE      "08 ",XXOIOITM
            MOVE      MHHNADQ8,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ8A
          IF         !@EQUAL
            MOVE      "08a",XXOIOITM
            MOVE      MHHNAQ8A,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ9
          IF         !@EQUAL
            MOVE      "09 ",XXOIOITM
            MOVE      MHHNADQ9,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ10
          IF         !@EQUAL
            MOVE      "10 ",XXOIOITM
            MOVE      MHHNAQ10,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ11
          IF         !@EQUAL
            MOVE      "11 ",XXOIOITM
            MOVE      MHHNAQ11,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ12
          IF         !@EQUAL
            MOVE      "12 ",XXOIOITM
            MOVE      MHHNAQ12,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
SAGT9999  RETURN
+
.******************************************************************************
.                      Set OT OI record for S1 tool type
.******************************************************************************
SS1T0000  MOVE      ZERO,EXIT
          PACK      KEY7,MHHNSCQ1,MHHNSCQ2,MHHNSCQ3,MHHNSCQ4,MHHNSCQ5:
                         MHHNSCQ6,MHHNSCQ7,SP20
          MATCH     SP7,KEY7
          GOTO      SS1T9999 IF EQUAL
.
          PACK      DIM170,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA:
                           XXOTCDAT,SP70,SP70
.
          MOVE      "3",PHRECTYP           * Write OT Record
          CALL      WRTM0000               * Write to tempfile
.
SS1T1000  MATCH      SP1,MHHNSCQ1
          IF         !@EQUAL
            MOVE      "SA ",XXOIOITM
            MOVE      MHHNSCQ1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ2
          IF         !@EQUAL
            MOVE      "SB ",XXOIOITM
            MOVE      MHHNSCQ2,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ3
          IF         !@EQUAL
            MOVE      "SC ",XXOIOITM
            MOVE      MHHNSCQ3,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ4
          IF         !@EQUAL
            MOVE      "SD ",XXOIOITM
            MOVE      MHHNSCQ4,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ5
          IF         !@EQUAL
            MOVE      "SE ",XXOIOITM
            MOVE      MHHNSCQ5,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ6
          IF         !@EQUAL
            MOVE      "SF ",XXOIOITM
            MOVE      MHHNSCQ6,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNSCQ7
          IF         !@EQUAL
            MOVE      "SG ",XXOIOITM
            MOVE      MHHNSCQ7,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
.
.         CAR 269742 - Added 1-12 ratings for secure records
.
          MATCH      SP1,MHHNADQ1
          IF         !@EQUAL
            MOVE      "01 ",XXOIOITM
            MOVE      MHHNADQ1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ2
          IF         !@EQUAL
            MOVE      "02 ",XXOIOITM
            MOVE      MHHNADQ2,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ3
          IF         !@EQUAL
            MOVE      "03 ",XXOIOITM
            MOVE      MHHNADQ3,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ4
          IF         !@EQUAL
            MOVE      "04 ",XXOIOITM
            MOVE      MHHNADQ4,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ5
          IF         !@EQUAL
            MOVE      "05 ",XXOIOITM
            MOVE      MHHNADQ5,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ6
          IF         !@EQUAL
            MOVE      "06 ",XXOIOITM
            MOVE      MHHNADQ6,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ7
          IF         !@EQUAL
            MOVE      "07 ",XXOIOITM
            MOVE      MHHNADQ7,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ8
          IF         !@EQUAL
            MOVE      "08 ",XXOIOITM
            MOVE      MHHNADQ8,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ8A
          IF         !@EQUAL
            MOVE      "08a",XXOIOITM
            MOVE      MHHNAQ8A,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNADQ9
          IF         !@EQUAL
            MOVE      "09 ",XXOIOITM
            MOVE      MHHNADQ9,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ10
          IF         !@EQUAL
            MOVE      "10 ",XXOIOITM
            MOVE      MHHNAQ10,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ11
          IF         !@EQUAL
            MOVE      "11 ",XXOIOITM
            MOVE      MHHNAQ11,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAQ12
          IF         !@EQUAL
            MOVE      "12 ",XXOIOITM
            MOVE      MHHNAQ12,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
SS1T9999  RETURN
+
.******************************************************************************
.                     Set OT OI record for L1 tool type
.******************************************************************************
SL1T0000  MOVE      ZERO,EXIT
          PACK      KEY19,MHHNLDQ1,MHHNLDQ2,MHHNLDQ3,MHHNLD3A,MHHNLDQ4:
                          MHHNLDQ5,MHHNLDQ6,MHHNLDQ7,MHHNLDQ8,MHHNLDQ9:
                          MHHNLQ10,MHHNLQ11,MHHNLQ12,MHHNLQ13,MHHNLQ14:
                          MHHNLQ15,MHHNLQ16,MHHNLQ17,MHHNLQ18,SP20
          MATCH     SP19,KEY19
          GOTO      SL1T9999 IF EQUAL
.
          PACK      DIM170,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA:
                           XXOTCDAT,SP70,SP70
.
          MOVE      "3",PHRECTYP           * Write OT Record
          CALL      WRTM0000               * Write to tempfile
.
SL1T1000  MATCH      SP1,MHHNLDQ1
          IF         !@EQUAL
            MOVE      "01 ",XXOIOITM
            MOVE      MHHNLDQ1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ2
          IF         !@EQUAL
            MOVE      "02 ",XXOIOITM
            MOVE      MHHNLDQ2,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ3
          IF         !@EQUAL
            MOVE      "03 ",XXOIOITM
            MOVE      MHHNLDQ3,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLD3A
          IF         !@EQUAL
            MOVE      "03a",XXOIOITM
            MOVE      MHHNLD3A,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ4
          IF         !@EQUAL
            MOVE      "04 ",XXOIOITM
            MOVE      MHHNLDQ4,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ5
          IF         !@EQUAL
            MOVE      "05 ",XXOIOITM
            MOVE      MHHNLDQ5,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ6
          IF         !@EQUAL
            MOVE      "06 ",XXOIOITM
            MOVE      MHHNLDQ6,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ7
          IF         !@EQUAL
            MOVE      "07 ",XXOIOITM
            MOVE      MHHNLDQ7,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ8
          IF         !@EQUAL
            MOVE      "08 ",XXOIOITM
            MOVE      MHHNLDQ8,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLDQ9
          IF         !@EQUAL
            MOVE      "09 ",XXOIOITM
            MOVE      MHHNLDQ9,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ10
          IF         !@EQUAL
            MOVE      "10 ",XXOIOITM
            MOVE      MHHNLQ10,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ11
          IF         !@EQUAL
            MOVE      "11 ",XXOIOITM
            MOVE      MHHNLQ11,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ12
          IF         !@EQUAL
            MOVE      "12 ",XXOIOITM
            MOVE      MHHNLQ12,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ13
          IF         !@EQUAL
            MOVE      "13 ",XXOIOITM
            MOVE      MHHNLQ13,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ14
          IF         !@EQUAL
            MOVE      "14 ",XXOIOITM
            MOVE      MHHNLQ14,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ15
          IF         !@EQUAL
            MOVE      "15 ",XXOIOITM
            MOVE      MHHNLQ15,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
.
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ16
          IF         !@EQUAL
            MOVE      "16 ",XXOIOITM
            MOVE      MHHNLQ16,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ17
          IF         !@EQUAL
            MOVE      "17 ",XXOIOITM
            MOVE      MHHNLQ17,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNLQ18
          IF         !@EQUAL
            MOVE      "18 ",XXOIOITM
            MOVE      MHHNLQ18,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
SL1T9999  RETURN
+
.******************************************************************************
.         Set OT OI record for C1 tool type
.******************************************************************************
SC1T0000  MOVE      ZERO,EXIT
          PACK      KEY15,MHHNCYQ1,MHHNCYQ2,MHHNCYQ3,MHHNCYQ4,MHHNCYQ5:
                          MHHNCYQ6,MHHNCYQ7,MHHNCYQ8,MHHNCYQ9,MHHNCQ10:
                          MHHNCQ11,MHHNCQ12,MHHNCQ13,MHHNCQ14,MHHNCQ15,SP20
          MATCH     SP15,KEY15
          GOTO      SC1T9999 IF EQUAL
.
          PACK      DIM170,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA:
                           XXOTCDAT,SP70,SP70
          MOVE      "3",PHRECTYP             * Write OT Record
          CALL      WRTM0000                 * Write to tempfile
.
SC1T1000  MATCH      SP1,MHHNCYQ1
          IF         !@EQUAL
            MOVE      "01 ",XXOIOITM
            MOVE      MHHNCYQ1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ2
          IF         !@EQUAL
            MOVE      "02 ",XXOIOITM
            MOVE      MHHNCYQ2,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ3
          IF         !@EQUAL
            MOVE      "03 ",XXOIOITM
            MOVE      MHHNCYQ3,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ4
          IF         !@EQUAL
            MOVE      "04 ",XXOIOITM
            MOVE      MHHNCYQ4,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ5
          IF         !@EQUAL
            MOVE      "05 ",XXOIOITM
            MOVE      MHHNCYQ5,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ6
          IF         !@EQUAL
            MOVE      "06 ",XXOIOITM
            MOVE      MHHNCYQ6,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ7
          IF         !@EQUAL
            MOVE      "07 ",XXOIOITM
            MOVE      MHHNCYQ7,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ8
          IF         !@EQUAL
            MOVE      "08 ",XXOIOITM
            MOVE      MHHNCYQ8,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCYQ9
          IF         !@EQUAL
            MOVE      "09 ",XXOIOITM
            MOVE      MHHNCYQ9,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ10
          IF         !@EQUAL
            MOVE      "10 ",XXOIOITM
            MOVE      MHHNCQ10,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ11
          IF         !@EQUAL
            MOVE      "11 ",XXOIOITM
            MOVE      MHHNCQ11,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ12
          IF         !@EQUAL
            MOVE      "12 ",XXOIOITM
            MOVE      MHHNCQ12,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ13
          IF         !@EQUAL
            MOVE      "13 ",XXOIOITM
            MOVE      MHHNCQ13,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ14
          IF         !@EQUAL
            MOVE      "14 ",XXOIOITM
            MOVE      MHHNCQ14,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCQ15
          IF         !@EQUAL
            MOVE      "15 ",XXOIOITM
            MOVE      MHHNCQ15,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
SC1T9999  RETURN
+
.******************************************************************************
.         Set OT OI record for M1 tool type
.******************************************************************************
SM1T0000  MOVE      ZERO,EXIT
          PACK      KEY52,MHHNAM01,MHHNAM02,MHHNAM03,MHHNAM04,MHHNAM05:
                          MHHNAM06,MHHNAM7A,MHHNAM7B,MHHNAM7C,MHHNAM7D:
                          MHHNAM7F,MHHNAM08,MHHNAM9A,MHHNAM9B,MHHNAM9C:
                          MHHNAM10,MHHNAM11,MHHNAM12,MHHNAM13,MHHNAM14:
                          MHHNAM15,MHHNAM16,MHHNAM17,MHHNAM18,MHHNAM19:
                          MHHNAM20,MHHNDAYS,MHHNRFMV,MHHNCEPS,SP70
          MATCH     SP70,KEY52
          GOTO      SM1T9999 IF EQUAL
.
          PACK      DIM170,XXOTEVID,XXOTTYPE,XXOTMADM,XXOTCSTA:
                           XXOTCDAT,SP70,SP70
          MOVE      "3",PHRECTYP             * Write OT Record
          CALL      WRTM0000                 * Write to tempfile
.
          MATCH      SP1,MHHNAM01
          IF         !@EQUAL
            MOVE      "01 ",XXOIOITM
            MOVE      MHHNAM01,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM02
          IF         !@EQUAL
            MOVE      "02 ",XXOIOITM
            MOVE      MHHNAM02,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM03
          IF         !@EQUAL
            MOVE      "03 ",XXOIOITM
            MOVE      MHHNAM03,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM04
          IF         !@EQUAL
            MOVE      "04 ",XXOIOITM
            MOVE      MHHNAM04,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM05
          IF         !@EQUAL
            MOVE      "05 ",XXOIOITM
            MOVE      MHHNAM05,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM06
          IF         !@EQUAL
            MOVE      "06 ",XXOIOITM
            MOVE      MHHNAM06,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7A
          IF         !@EQUAL
            MOVE      "07a",XXOIOITM
            MOVE      MHHNAM7A,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7B
          IF         !@EQUAL
            MOVE      "07b",XXOIOITM
            MOVE      MHHNAM7B,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7C
          IF         !@EQUAL
            MOVE      "07c",XXOIOITM
            MOVE      MHHNAM7C,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7D
          IF         !@EQUAL
            MOVE      "07d",XXOIOITM
            MOVE      MHHNAM7D,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7E
          IF         !@EQUAL
            MOVE      "07e",XXOIOITM
            MOVE      MHHNAM7E,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM7F
          IF         !@EQUAL
            MOVE      "07f",XXOIOITM
            MOVE      MHHNAM7F,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM08
          IF         !@EQUAL
            MOVE      "08 ",XXOIOITM
            MOVE      MHHNAM08,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM9A
          IF         !@EQUAL
            MOVE      "09a",XXOIOITM
            MOVE      MHHNAM9A,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM9B
          IF         !@EQUAL
            MOVE      "09b",XXOIOITM
            MOVE      MHHNAM9B,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM9C
          IF         !@EQUAL
            MOVE      "09c",XXOIOITM
            MOVE      MHHNAM9C,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM10
          IF         !@EQUAL
            MOVE      "10 ",XXOIOITM
            MOVE      MHHNAM10,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM11
          IF         !@EQUAL
            MOVE      "11 ",XXOIOITM
            MOVE      MHHNAM11,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM12
          IF         !@EQUAL
            MOVE      "12 ",XXOIOITM
            MOVE      MHHNAM12,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM13
          IF         !@EQUAL
            MOVE      "13 ",XXOIOITM
            MOVE      MHHNAM13,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM14
          IF         !@EQUAL
            MOVE      "14 ",XXOIOITM
            MOVE      MHHNAM14,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM15
          IF         !@EQUAL
            MOVE      "15 ",XXOIOITM
            MOVE      MHHNAM15,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM16
          IF         !@EQUAL
            MOVE      "16 ",XXOIOITM
            MOVE      MHHNAM16,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM17
          IF         !@EQUAL
            MOVE      "17 ",XXOIOITM
            MOVE      MHHNAM17,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM18
          IF         !@EQUAL
            MOVE      "18 ",XXOIOITM
            MOVE      MHHNAM18,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM19
          IF         !@EQUAL
            MOVE      "19 ",XXOIOITM
            MOVE      MHHNAM19,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNAM20
          IF         !@EQUAL
            MOVE      "20 ",XXOIOITM
            MOVE      MHHNAM20,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNDAYS
          IF         !@EQUAL
            MOVE      "21 ",XXOIOITM
            MOVE      MHHNDAYS,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNRFMV
          IF         !@EQUAL
            MOVE      "22 ",XXOIOITM
.
            PACK      DIM1,SP70
            MATCH     "M",MHHNRFMV
            IF        @EQUAL
              MOVE      "1",DIM1
            ENDIF
            MATCH     "V",MHHNRFMV
            IF        @EQUAL
              MOVE      "2",DIM1
            ENDIF
.
            MOVE      DIM1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
          MATCH      SP1,MHHNCEPS
          IF         !@EQUAL
            MOVE      "23 ",XXOIOITM
.
            PACK      DIM1,SP70
            MATCH     "0",MHHNCEPS
            IF        @EQUAL
              MOVE      "2",DIM1
            ENDIF
            MATCH     "1",MHHNCEPS
            IF        @EQUAL
              MOVE      "1",DIM1
            ENDIF
.
            MOVE      DIM1,XXOIIVAL
            PACK      DIM170,XXOIEVID,XXOIOITM,XXOIIVAL,SP70,SP70
            MOVE      "4",PHRECTYP           * set flag for OI Record
            CALL      WRTM0000               * Write to tempfile
          ENDIF
.
SM1T9999  RETURN
+
.******************************************************************************
.         find Referral Transfer Source for Admission or A/H Referral
.******************************************************************************
TRNSRC00  MOVE      ZERO,EXIT
          PACK      KEY5,TRNSRCKY,SP70       * Cat.Code data
          CALL      RDCODE1                  * Cat."S ", "D ", or "lG"
          BRANCH    OVRCD,TRNSRC99
.
          UNPACK    PTCDNHCP,TRNSRCCO        * default PRIMHD code
          MATCH     "1",TCINDC2              * 1=Use "patvadaf" 
          GOTO      TRNSRC20 IF EQUAL
.
          UNPACK    PTCDNHCP,KEY2            * otherwise use HCP Equiv.
          PACK      TRNSRCCO,KEY2,SP70
          GOTO      TRNSRC99
.
.                                            * get info for "patvadaf"
TRNSRC20  MATCH     "R",TRNSRCTY             * Admission or A/H Referral
          IF        @EQUAL
            PACK      KEY8,CURREFNO,SP70     * use A/H Referral ALREVISN
            CALL      RDALDAD1               * read "alldadaf"
            BRANCH    OVRCD,TRNSRC99         * end if not found
            PACK      KEY5,ALDAFHOS          * set up default "From" code
            MATCH     "T",TRNSRCFT           * a "From" or "To" ?
            IF        @EQUAL
              PACK      KEY5,ALDATHOS        * set up "To" code
            ENDIF
          ELSE
            PACK      KEY8,AADMNO,SP8        * use Admission Referral AADMNO
            CALL      RDPTDAD1               * read "patdadaf"
            BRANCH    OVRCD,TRNSRC99         * end if not found
            PACK      KEY5,PTDAADTS          * set up default "From" code
            MATCH     "T",TRNSRCFT           * a "From" or "To" ?
            IF        @EQUAL
              PACK      KEY5,PTDADCTS        * set up "To" code
            ENDIF
          ENDIF
.
          CALL      RDPTVAD1                 * read Transfer Source Table
          BRANCH    OVRCD,TRNSRC99           * end if not found
.
          UNPACK    PTVAPPCD,KEY2,KEY6       * use first 2 characters
          PACK      TRNSRCCO,KEY2,SP2
.
TRNSRC99  RETURN
+
.******************************************************************************
.         Set LS variables for HONOS assessments
.******************************************************************************
STLS0000  PACK      XXLSFVER,MHCNPHVR,SP70
          MOVE      MHDLUNIQ,KEY8
          REP       " 0",KEY8
          PACK      XXLSLSID,KEY8,SP70
.
..........PACK      XXLSSORG,MHCNORID,SP70
..........PACK      XXLSORID,MHCNORID,SP70
          PACK      XXLSSORG,SAVSSORG,SP70    * Submitting Org Id *C-0833934
          PACK      XXLSORID,SAVSSORG,SP70    * Org Id            *C-0833934
.
          PACK      XXLSOTYP,MHCNOTYP,SP70
          MOVE      MHDLURNO,KEY8           * NZ Event HCU Id, is char 7
          SQUEEZE   KEY8
          PACK      XXLSEHCU,KEY8,SP70
          PACK      XXLSLSCD,SP70
          MATCH     SP70,MHDLSCOD
          IF        !@EQUAL
            MOVE      "LS",TCODE
            PACK      KEY5,TCODE,MHDLSCOD,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              UNPACK    THCSCOD,XXLSLSCD       * Legal status code
            ENDIF
          ENDIF
          MATCH     SP70,XXLSLSCD
          GOTO      STLS9000 IF EQUAL          * Do not send if blank
.
          PACK      XXLSRCPN,SP70
          PACK      KEY10,MHDLHCPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            PACK      XXLSRCPN,PMHCCPER,SP70   * CPN
          ENDIF
.
          PACK      XXLSSDAT,SP70
          MATCH     SP70,MHDLSDAT
          IF        !@EQUAL
            UNPACK    MHDLSDAT,XCENT,XYEAR,XMON,XDAY    * Start date      
            PACK      XXLSSDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,MHDLSTIM,SP7
          ENDIF
.
          PACK      XXLSEDAT,SP70
          MATCH     SP70,MHDLEDAT
          IF        !@EQUAL
            UNPACK    MHDLEDAT,XCENT,XYEAR,XMON,XDAY    * End date
            PACK      XXLSEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,MHDLETIM,SP7
          ELSE
            MATCH     SP70,MHHLEDAT
            IF        !@EQUAL
              UNPACK    MHHLEDAT,XCENT,XYEAR,XMON,XDAY    * End date
              PACK      XXLSEDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,MHHLETIM,SP7
            ENDIF
          ENDIF
.
....      CALL      IBACLOCK                                          *D-209439
          UNPACK    STRTDATE,XCENT,XYEAR,XMON,XDAY    * Extract start date
.                                                                     *C-209439
....      PACK      XXLSFDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,CTIMEIS,SP7
          PACK      XXLSFDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,NSTRTTIM,SP7
.
          UNPACK    ENDDATE,XCENT,XYEAR,XMON,XDAY    * Extract start date
....      PACK      XXLSTDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,CTIMEIS,SP7
          MATCH     CURRDATE,ENDDATE                          * start *C-209439
          IF        @LESS
            PACK      XXLSTDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,NENDTIME,SP7
          ELSE
            PACK      XXLSTDAT,XCENT,XYEAR,DSH,XMON,DSH,XDAY,ANST,EXTRTIME,SP7
          ENDIF                                               * end   *C-209439
.
          PACK      XXLSDELT,SP70
          IF        DELFLAG=1
            MOVE      "DELETED",XXLSDELT
          ENDIF
.
          PACK      XXLSPSEX,PSEX,SP70
. Task 0897201
          PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,THCSCOD
            IF        !@EQUAL
              PACK      XXLSPSEX,THCSCOD,SP70
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXLSPDOB,XCENT,XYEAR,DSH,XMON,DSH,XDAY,SP70
          PACK      DIM170,XXLSFVER,XXLSLSID,XXLSSORG,XXLSORID,XXLSOTYP:
                           XXLSEHCU,XXLSLSCD,XXLSRCPN,XXLSSDAT,XXLSEDAT:
                           XXLSFDAT,XXLSTDAT,XXLSDELT,XXLSPSEX,XXLSPDOB:
                           SP70,SP70
.
          MOVE      ZERO,EXIT
          GOTO      STLS9999
.
STLS9000  MOVE      ONE,EXIT
STLS9999  RETURN
+
.******************************************************************************
.         Check Clinic for duty Doctor                                *I-195060
.******************************************************************************
CLIDOC00  MOVE      ZERO,EXIT

          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD <> 1
            GOTO      CLIDOC20
          ENDIF
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * position on Clinic Record
CLIDOC10  CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,CLIDOC90
.
          MATCH     OCASITE,OSESITE
          GOTO      CLIDOC90 IF NOT EQUAL
.
          MATCH     OCACLIN,OSECLIN
          GOTO      CLIDOC90 IF NOT EQUAL
.
CLIDOC20  MATCH     SP70,OCADOCT
          IF        !@EQUAL
            PACK      KEY10,OCADOCT,SP10
            GOTO      CLIDOC99
          ENDIF
.
CLIDOC90  MOVE      SP10,KEY10
.
CLIDOC99  RETURN
+
.******************************************************************************
.               Write to tempfile with the next unique number
.******************************************************************************
WRTM0000  MOVE      ZERO,EXIT
.
          MATCH     "3",PHRECTYP           * setup for OT & OI records
          GOTO      WRTM5000 IF EQUAL
          MATCH     "4",PHRECTYP           * OI record
          GOTO      WRTM5000 IF EQUAL
.
          MOVE      "  0",PHSRUNQN
          MOVE      "0",F5A                              * (was F3A)  *C-261603
          MOVE      "0",F3B
          PACK      SKEY25,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP,SP70
          PACK      KEY33,SKEY25,Z70
          CALL      RSPRMH1
          CALL      RPPRMH1
          BRANCH    OVRCD,WRTM2000
.
          PACK      KEY25,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP,SP70
          MATCH     KEY25,SKEY25
          GOTO      WRTM2000 IF NOT EQUAL
.
          MOVE      PHUNQNUM,F5A                         * (was F3A)  *C-261603
          IF        F5A = 99999
            CALL      ERRB0000              * Serious Error - ERRB0000
            GOTO      ML2000                * exit program
          ENDIF
.
WRTM2000  ADD       "1",F5A                 * add 1 to Unique counter 
          MOVE      F5A,PHUNQNUM                         * (was F3A)  *C-261603
          MOVE      SP3,PHSRUNQN
          UNPACK    SKEY25,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP
          PACK      KEY33,SKEY25,PHUNQNUM,SP70
          MOVE      PHRECTYP,PHSVRETY       * save the record type
          MOVE      DIM170,PHFIELDS
          PACK      PHSPAR,SP70
.
          CALL      WRPRMH1
          MOVE      KEY33,SKEY33                                      *I-190693
          GOTO      WRTM9999
.
.
.         Write  OT and OI Records with same unique no. as CO
.
WRTM5000  MOVE      PHRECTYP,KEY1          * save PHRECTYP to put into PHSVRETY
          MOVE      "2",PHRECTYP           * write OT and OI as Rec.type "2"
          MOVE      SVUNQNUM,PHUNQNUM      * use the "CO" Unique number
          PACK      SKEY25,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP,SP70
.
WRTM6000  ADD       ONE,F3B
          MOVE      F3B,PHSRUNQN
.
WRTM7000  PACK      KEY33,SKEY25,PHUNQNUM,PHSRUNQN,SP70
          CALL      RAPRMH1
          BRANCH    OVRCD,WRTM8000
.
          GOTO      WRTM6000
.
WRTM8000  UNPACK    SKEY25,PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP
          MOVE      KEY1,PHSVRETY
          MOVE      DIM170,PHFIELDS
          PACK      PHSPAR,SP70
          CALL      WRPRMH1
          MOVE      KEY33,SKEY33                                      *I-190693
.
WRTM9999  RETURN
+
.******************************************************************************
.               -------- ERR Routines for Arrays --------
.******************************************************************************
ERRA0000  MOVE      ZERO,OVRCD
.
          CLEAR     PRNTLINE                * Clear printline
          CALL      PRNT0000                   
          APPEND    "  Start Date / End Date : ",PRNTLINE
          UNPACK    STRTDATE,DIM4A,DIM2A,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE
          UNPACK    ENDDATE,DIM4A,DIM2A,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE            
          CALL      PRNT0000
.       
          APPEND    "  Referral ",PRNTLINE
          APPEND    CURPRINO,PRNTLINE
          APPEND    " has more than 200 Linked Referrals - ",PRNTLINE
          APPEND    " last Referral Start date of ",PRNTLINE
          UNPACK    ALRERDAT,DIM4A,DIM2A,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE
          APPEND    DIM12A,PRNTLINE
          CALL      PRNT0000
          MOVE      ONE,SERIOUS
.
          GOTO      ML2000                  * exit program
.
ERRA9999  RETURN
.
ERRB0000  MOVE      ZERO,OVRCD
.
          CLEAR     PRNTLINE                * Clear printline
          CALL      PRNT0000
          APPEND    "  Start Date / End Date : ",PRNTLINE
          UNPACK    STRTDATE,DIM4A,DIM2A,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE
          UNPACK    ENDDATE,DIM4A,DIM2A,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE
          CALL      PRNT0000
.
          UNPACK    XXATSDAT,DIM4A,KEY1,DIM2A,KEY1,DIM2B
          PACK      DIM12A,DIM2B,SLSH,DIM2A,SLSH,DIM4A,SP2
          APPEND    DIM12A,PRNTLINE
          MOVE      XXRDRSTR,DIM10
          APPEND    "  Error occured in Referral ",PRNTLINE
          APPEND    CURREFNO,PRNTLINE
          APPEND    " with an Activity date of ",PRNTLINE
          APPEND    DIM12A,PRNTLINE
          CALL      PRNT0000
.
          APPEND    "  Referral exceeds 999 components in this",PRNTLINE
          APPEND    "  Date range",PRNTLINE
          CALL      PRNT0000

          MOVE      ONE,SERIOUS
          GOTO      ML2000                  * exit program
.
ERRB9999  RETURN
+
.******************************************************************************
.               -------- I/O Routines for Temporary files --------
.******************************************************************************
RAPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          READ      XPRIMHED,KEY33;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          READ      XPRIMHED,KEY33;;
          RETURN
.
RDPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          READ      XPRIMHED,KEY33;PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                                   PHUNQNUM,PHSRUNQN,PHSVRETY,PHFIELDS,PHSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          READKS    XPRIMHED;PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                             PHUNQNUM,PHSRUNQN,PHSVRETY,PHFIELDS,PHSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RPPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          READKP    XPRIMHED;PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                             PHUNQNUM,PHSRUNQN,PHSVRETY,PHFIELDS,PHSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRPRMH1   MOVE      ZERO,OVRCD
          RESET     KEY33
          WRITE     XPRIMHED,KEY33;PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                                   PHUNQNUM,PHSRUNQN,PHSVRETY,PHFIELDS,PHSPAR
          RETURN
.
UPPRMH1   UPDATE    XPRIMHED;PHORGNID,PHURNUMB,PHVISNUM,PHRECTYP:
                             PHUNQNUM,PHSRUNQN,PHSVRETY,PHFIELDS,PHSPAR
          RETURN
.
DEPRMH1   RESET     KEY33
          DELETE    XPRIMHED,KEY33
          RETURN
.
. ----------------------------------------------------------------------------
RALREF1   MOVE      ZERO,OVRCD
          RESET     KEY14
          READ      LINKREF1,KEY14;ANS
          GOTO      OVERCOND IF OVER
          RETURN    
.         
RSLREF1   MOVE      ZERO,OVRCD
          RESET     KEY14    
          READ      LINKREF1,KEY14;;
          RETURN
.
RDLREF1   MOVE      ZERO,OVRCD
          RESET     KEY14
          READ      LINKREF1,KEY14;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKETIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          GOTO      OVERCOND IF OVER
          RETURN

.
RKLREF1   MOVE      ZERO,OVRCD
          RESET     KEY14
          READKS    LINKREF1;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKRTIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RPLREF1   MOVE      ZERO,OVRCD
          RESET     KEY14
          READKP    LINKREF1;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKRTIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
WRLREF1   MOVE      ZERO,OVRCD
          RESET     KEY14
          WRITE     LINKREF1,KEY14;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKRTIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          RETURN
.
UPLREF1   UPDATE    LINKREF1;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKRTIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          RETURN
.
DELREF1   RESET     KEY14
          DELETE    LINKREF1,KEY14
          RETURN
.
.
.         
RSLREF2   MOVE      ZERO,OVRCD
          RESET     KEY16    
          READ      LINKREF2,KEY16;;
          RETURN
.
RKLREF2   MOVE      ZERO,OVRCD
          RESET     KEY16
          READKS    LINKREF2;LINKPVIS,LINKRFTY,LINKTMID,LINKUNIQ:
                                   LINKMOHV,LINKVISN,LINKDEPT,LINKCAST:
                                   LINKRDAT,LINKRTIM,LINKATDT,LINKATTM:
                                   LINKEDAT,LINKETIM,LINKRDYN,LINKATYN:
                                   LINKCOYN,LINKSTAT,LINKSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.==============================================================================
.
          INC       STD001IO
          INC       STDHLPCD
          INC       STDKWSCD
.
          INC       CLPATDSC
          INC       IBAPRINT
          INC       PATCODKY
          INC       PATHSPKY
          INC       PRMHDEXT
          INC       IBAPRNIO/INC
.
          INC       ALLCASIO/INC
          INC       ALLREFIO/INC
          INC       ALLRSAIO/INC
          INC       ALLENCIO/INC
          INC       ALLGPAIO/INC
          INC       ALLLNKIO/INC
          INC       ALLDEPIO/INC
          INC       ALLSERIO/INC
          INC       ALLGREIO/INC
          INC       ALLRLNIO/INC                                      *I-190693
          INC       ALLDADIO/INC                                      *I-190929
.
          INC       PATDADIO/INC                                      *I-190929
          INC       PATVADIO/INC                                      *I-190929
          INC       PATWR1IO/INC                                      *I-256500
.
          INC       PATCODIO/INC
          INC       MEHDIAIO/INC
          INC       MEHHLSIO/INC
          INC       MEHDLSIO/INC
          INC       MEHLEGIO/INC
          INC       MEHHONIO/INC
          INC       MEHVI1IO/INC
          INC       MEHSCRIO/INC
          INC       MEHDS1IO/INC
          INC       NHIMASIO/INC
          INC       PATDAYIO/INC
          INC       PATHSPIO/INC
          INC       PATDSCIO/INC
          INC       PATUNAIO/INC
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PMSHCPIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
.                                           * PRIMHD Extract History tables
          INC       MEHPRDIO/INC
          INC       MEHPATIO/INC
          INC       MEHPCNIO/INC
          INC       MEHPCOIO/INC
          INC       MEHPCSIO/INC
          INC       MEHPOIIO/INC
          INC       MEHPLSIO/INC
          INC       MEHPTFIO/INC
.
          INC       OUTSESIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTSITIO/INC
          INC       OUTCLIIO/INC
          INC       OUTHEDIO/INC
.
