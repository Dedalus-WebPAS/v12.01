.-------------------------------------------------------------------------------
. Program       : CLIWEB01 
.
. Function      : Patient Alerts 
.
. Modifications : 
.-------------------------------------------------------------------------------
. V12.00.02 09/10/2025  J.Tan           TSK 0966942
.           Removed checking for deleted documents attached to Alert
. V12.00.01 07/10/2025  J.Tan           TSK 0966942
.           Mod to check for deleted documents attached to Alert
. V11.05.03 24/03/2025  Davin           TSK 0956210
.           Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)
. V11.05.02 19.12.2024  DA Sarkies     Task 0954547
.           Commented out the <cat-c> codes to prevent browser incapatibility
. V11.05.01 26/11/2024  Ebon Clements  Task 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.04.03 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.02 24/06/2024  Sunny           TSK 0947645
.           Added PALT4700 - Default User Alert Security Level
. V11.04.01 27/03/2024  Ebon Clements   TSK 0944691
.           Treat alerts with a future end date as active - CHKALR00 CHKATT00
. V11.03.05 01/09/2023  Jacob Jackson   TSK 0935070
.           Recompiled for OBSFHRCD - Make reviewdate/reviewdttm extension
.           value empty if PTALRDTE is not populated
. V11.03.04 31/08/2023  Sunny           TSK 0935067 
.           Recompiled for OBSFHRCD - Changed RESALL00 for Severity description
. V11.03.03 24/08/2023  Thanh T        TSK 0935069 
.           Recompiled for OBSPALPR
. V11.03.02 31/07/2023  Peter Vela     TSK 0927262
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
.           to Practitioner User resource
. V11.03.01 30/06/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Subject include FHRSUBIN functionality
.           Added Location include FHRLOCIN functionality
.           Added Author include FHRPARIN functionality
. V11.02.04 01/09/2022  Alina Bhari    TSK 0913316
.           Displayed last updated by field as "AutoEndPgm" if record is
.           updated through "Auto-End Selected Alert Code" - PALT2600
. V11.02.03 24/08/2022  Alina Bhari    TSK 0913316
.           Displayed last updated by field as "Auto Script" if record is 
.           updated through "Auto-End Selected Alert Code" - PALT2600 
. V11.02.02 31/03/2022  Davin          TSK 0917793
.           Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)
. V11.02.01 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.01 06.07.2021  DA Sarkies     TSK 0908607
.           Switched date & time around at life 3217 and split with 'at'
. V11.00.02 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.01 06.11.2020  Sunny          TSK 0891498 
.           Modified ALTSEL15 $ ALTSLL15 to cater till Indicator 12 for 
.           Infection Status
. V10.13.01 06.11.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change for Boolean values to not have quotes
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Output Change Extension Naming
. V10.11.04 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.02 22.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR output for create alert
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Admission/outpatient visit comments. PATMISTM changed.
. V10.10.03 16/05/2017  Davin          TSK 0321570 SJOGHC
.           Added ability to add multiple alerts (PATALRTD/PATALRTM/PATALT15)
.           Added tags for cat.indicators (PALT4500) and multi alerts (ALRITM00)
. V10.10.02 11.04.2017  B.G.Ackland    TSK 0835482 
.           FHIR output of encounters
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
. V10.08.03 25/10/2016  Ebon Clements   TSK 0825341
.           Ignore alert comment line if blank - ALCMN510 & ALCMA510 
. V10.08.02 28/07/2016  Davin           TSK 0321234
.           Mods for new chronic condition alert (indc.5='C') for wahealth
. V10.08.01 07/04/2016  Peter Vela      CAR 0324306
.           Added tag for web security add alert security levels
. V10.06.03 25/06/2015  Don Nguyen      CAR 318419
.           Modified PALT1500 & PALT1600 to loop 'obspcoaf' for matching Alert
.           File Counter.
. V10.06.02 17/03/2015  Davin         CAR 311669      HDP 2015/16
.           Add PTCNGDV9 for ICD10 Ed.9 Go-live Date (Sect.110 Pos.77)
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed reference to PATCGPFD (No Longer in use)
.-------------------------------------------------------------------------------
. V10.04.02 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.-------------------------------------------------------------------------------
. V10.03.14 26/09/2013  Ania P            CAR 292045
.           Added hospital specific code check in ALTSEL10
. V10.03.13 29/08/2013  Ania P            CAR 280135
.           Added extra logic to CBDNSV00 and CBEDG152
. V10.03.12 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.11 31/05/2013  Davin         CAR 284420      HDP 2013/14
.           Add PTCNGDV8 for ICD10 Ed.8 Go-live Date (Sect.110 Pos.69)
. V10.03.10 22/04/2013  Ebon Clements     CAR 261630
.           Added trap to temp file read - ALCMN500
. V10.03.09 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.08 22/04/2013  Ebon Clements     CAR 261630
.           Removed port number from temp file name
. V10.03.07 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.06 06/06/2012  Steve Armstrong   CAR 266681
.           Mods to remove read lock prior to updating patalrtf
.           to prevent I*P
. V10.03.05 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.04 02/12/2011  Jill Parkinson CAR 249362
.           Added writes to pmsaudan
. V10.03.03 01/12/2011  Jill Parkinson CAR 249362
.           Changed pmsalnaf reads
. V10.03.02 29/11/2011  Jill Parkinson CAR 249362
.           Changed pmsaltaf reads
. V10.03.01 28/11/2011  Jill Parkinson CAR 249362
.           Changed to allow multiple of the same alerts
.-------------------------------------------------------------------------------
. V10.02.06 07/10/2011  Davin          CAR 249603
.           Added ";" to alert comment tag output to remove space (palt1100)
. V10.02.05 06/09/2011  Davin          CAR 249647
.           Added flag to display alert delete button (palt3100)
. V10.02.04 26/08/2011  Davin          CAR 248532
.           Added option to display initiating hosp desc to tag 24 (palt2400)
.           Added new tag for clinician name (palt3000)
. V10.02.03 03/08/2011  Steve Armstrong   CAR 247627
.           Added DGCLICUP triggers for write/update/delete of patalrtf
.           and this replaces previous HL7ALERT triggers.
. V10.02.02 02/08/2011  Davin          CAR 239539
.           Added new tags for alert 'user id created' and 'date created'
.           (palt2800/palt2900)
. V10.02.01 03/05/2011  Davin          CAR 239539
.           Added new fields for alerts (alert009 to alert012)
.           Added category based security functionality for adding alerts
.           (ALTSEL00)
.           Changed to allow 3 alert indicators to be saved (CHKALR00)
.-------------------------------------------------------------------------------
. V10.00.01  10/06/2010  Saroeun Soeur  CAR 223765
.           DELC0000 - move zero to exit to fix alert problem
.-------------------------------------------------------------------------------
. V9.12.03  12/01/2010  Saroeun Soeur  CAR 212595
.           added DELC0000 - delete linked clinical document
. V9.12.02  15/10/2009  Jill Parkinson CAR 206624
.           Added ADMALERT cgi
. V9.12.01  26/08/2009  Peter McMullen CAR 171901
.           remove MAPCAT00 call                         
. V9.11.01  05/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.01  17/07/2008  Jill Habasque  CAR 162660  
.           Added new alert functionality - alert indicator 4 to ptmxsin1
. V9.09.01  20/08/2007  Steve Armstrong CAR 147953
.           Added read on PMI master files prior to calls to HL7ALERT.
.           Recompiled for changes to HL7ALERT.
.-------------------------------------------------------------------------------
. V9.08.01  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
.-------------------------------------------------------------------------------
. V9.07.02  18/09/2006  Ebon Clements   CAR 107243
.           Added view deleted alert functionality
. V9.07.01  08/09/2006  Steve Armstrong CAR 107632
.           Added calls to HL7ALERT                                  
.-------------------------------------------------------------------------------
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.04  21/11/2005  Jill Habasque CAR 84770
.           Mods to check medical warnings (patmwsaf) before updating ptmxsin1
. V9.04.03  17/03/2005  Ebon Clements CAR 58443
.           Added security alerts to set PTMXSIN1 to 2 if security alerts exist
.           TCINDC4 = S
. V9.04.02  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.01  22/12/2004 Ebon Clements             CAR 56056
.           Added new tag for linked clinical document to alert 
. V9.03.02  07/06/2004 Peter Vela                CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.01  29/03/2004 Peter Vela                CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
.           23/03/2004 Pat Dirito                CAR 
.           Added Option 2 - Patient Clinical Pathways 
.-------------------------------------------------------------------------------
. V9.02.12  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.11  09/10/2002 Peter Vela SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.10  30/09/2002 Peter Vela SRF 22514
.           Added in functionality for Add Alert Security Level (ALTSEL00)
. V9.02.09  18/04/2002 B.G.Ackland
.           Update Indicator for ZERO UR in PATPX1FD
.           18/04/2002 Pat Dirito
.           Fixed routine ALCMN000 for I*D was not setting UR on initial key
. V9.02.08  23/01/2002 Pat Dirito 
.           Fixed calls to IBACLOCK and use of variable CURRDATE.
. V9.02.07  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.06  03/11/2001 Jill Habasque
.           Added ALERT008 - review date          
. V9.02.05  19/10/2001 Jill Habasque
.           Fixed storing of comments on update
. V9.02.04  10.10.2001 B.G.Ackland
.           Fix Comment Update Causing I * D
. V9.02.03  02.10.2001 Jill Habasque     
.           Mods to use pmsalnaf for unlimited alert comments
. V9.02.02  14.09.2001 Rahul Gupta - HPS
.           Changed for Redirection of Alerts
. V9.02.01  08.09.2001 Raghu - HPS
.           Changed for Alerts
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B02 13.07.2001 Sandra Barcham
.           Replaced GP with HCP
.-------------------------------------------------------------------------------
.                 V5.09.02 12.01.2001 Bronko Sosic
.                          Recompiled for PATMASTM 
.                 V5.09.01 09.01.2001 K.C.Nelson  
.                          Added control cache header
.                          05/01/2001 Pat Dirito Modified for changes to 
.                          PATALRFD
.                 V5.08.04 17.10.2000 B.G.Ackland
.                          Fix Dates
.                 V5.08.03 28/09/2000 Bronko Sosic  
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.08.02  16/08/2000  Caleb Sharman 
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.01 07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM 
.                 V5.07.02 02/02/2000 Steven Watkins    
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.01 28/01/2000  Nicole Harrington
.                          Fixed PURNO outputting spaces - PURNO blank when 
.                          PVITYPE=1 (EMR) or no patvisaf record in FINVIS00
.                 V5.07.00 15/12/1999  Pat Dirito       
.                          Created Program                                      
.
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
.
          INC       WEBDATDF
          INC       FHRDATDF
.
          INC       PATDHEAD/INC
.
          INC       PMSALAFD/INC 
          INC       APSMASFD/INC
          INC       PATFN1FD/INC 
          INC       EMRUNKFD/INC      * Unknowns Patient File
          INC       PATALRFD/INC      * Patient Alerts Code File
          INC       PATALRTD/INC      * Patient Alerts
          INC       PATMA1FD/INC
          INC       PATIN1FD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSQPTFD/INC
          INC       PATCALAG/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATPR1FD/INC      * Pre-admission master file
          INC       PATVISFD/INC
          INC       PATICDFD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       PATVADFD/INC
          INC       PATASFFD/INC
          INC       PATDADFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATCMCFD/INC
          INC       PATHSPFD/INC
          INC       PATITMFD/INC
          INC       PMSALNFD/INC      * alert comment file
          INC       PMSVX1FD/INC
          INC       PMSCLPFD/INC      * Patient Clinical Pathways
          INC       PMSTLEFD/INC
          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
.
          INC       RESLNKFD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATWR1FD/INC
          INC       PATDO1FD/INC
          INC       TFILEVAR/INC
          INC       MRTMASFD/INC
          INC       OUTSITFD/INC      * Outpatient Site File 
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OBSPCOFD/INC
          INC       OBSPCTFD/INC
          INC       PATMISTD/INC
          INC       PMSCCDFD/INC      * Concession Card Details
.
.  CGI Variables
.
NEXTPAGE  FORM      1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
ALERTKEY  DIM       12      * key to the alert table
CURRDATE  DIM       8       * Current Date
.
AFRM1     FORM      1
ALERTSEC  DIM       1       * alert security level
ALERT001  DIM       2       * Codes File Category (H1 to H9)      
ALERT002  DIM       3       * Code file code for Category
ALERT003  DIM       8       * Date       
ALERT004  DIM       1       * Life Threating Alert
ALERT005  DIM       3       * Reaction Code(wn) 
ALERT006  DIM       1       * Severity Level (0-9)
ALERT007  DIM       20      * Reaction Comment
ALERT008  DIM       8       * Review Date
ALERT009  DIM       9       * ICD10 Code
ALERT010  DIM       8       * Date Inactive
ALERT011  DIM       8       * End Date (Date Cleared)
ALERT012  DIM       10      * Requested By (HCP Code)
ALERT013  DIM       3       * Counter
ALERT014  DIM       1       * Care Pathway Activated (1=yes)
ALERT015  DIM       10      * User ID for alert comments
ALCOMMNT  DIM       70[99]  * comments
.
PMSCL001  DIM       8       * Admission Number                   
PMSCL002  DIM       3       * Clinical Pathway (Cat PW)          
PMSCL003  DIM       8       * Clinical Pathway Unique No.        
PMSCL004  DIM       9       * Diagnosis Code 1                   
PMSCL005  DIM       8       * Diagnosis Date 1 (CCYYMMDD)        
PMSCL006  DIM       8       * Diagnosis Time 1 (HH:MM:SS)        
PMSCL007  DIM       3       * Diagnosis 1 Outcome 1 (Cat PF)     
PMSCL008  DIM       3       * Diagnosis 1 Outcome 2 (Cat PF)     
PMSCL009  DIM       3       * Diagnosis 1 Outcome 3 (Cat PF)     
PMSCL010  DIM       3       * Diagnosis 1 Outcome 4 (Cat PF)     
PMSCL011  DIM       8       * Diagnosis 1 Outcome Date 1         
PMSCL012  DIM       8       * Diagnosis 1 Outcome Time 1         
PMSCL013  DIM       8       * Diagnosis 1 Outcome Date 2         
PMSCL014  DIM       8       * Diagnosis 1 Outcome Time 2         
PMSCL015  DIM       8       * Diagnosis 1 Outcome Date 3         
PMSCL016  DIM       8       * Diagnosis 1 Outcome Time 3         
PMSCL017  DIM       8       * Diagnosis 1 Outcome Date 4         
PMSCL018  DIM       8       * Diagnosis 1 Outcome Time 4         
PMSCL019  DIM       9       * Diagnosis Code 2                   
PMSCL020  DIM       8       * Diagnosis 2 Date (CCYYMMDD)        
PMSCL021  DIM       8       * Diagnosis 2 Time (HH:MM:SS)        
PMSCL022  DIM       3       * Diagnosis 2 Outcome 1 (Cat PF)     
PMSCL023  DIM       3       * Diagnosis 2 Outcome 2 (Cat PF)     
PMSCL024  DIM       3       * Diagnosis 2 Outcome 3 (Cat PF)     
PMSCL025  DIM       3       * Diagnosis 2 Outcome 4 (Cat PF)     
PMSCL026  DIM       8       * Diagnosis 2 Outcome Date 1         
PMSCL027  DIM       8       * Diagnosis 2 Outcome Time 1         
PMSCL028  DIM       8       * Diagnosis 2 Outcome Date 2         
PMSCL029  DIM       8       * Diagnosis 2 Outcome Time 2         
PMSCL030  DIM       8       * Diagnosis 2 Outcome Date 3         
PMSCL031  DIM       8       * Diagnosis 2 Outcome Time 3         
PMSCL032  DIM       8       * Diagnosis 2 Outcome Date 4         
PMSCL033  DIM       8       * Diagnosis 2 Outcome Time 4         
PMSCL034  DIM       9       * Diagnosis Code 3                   
PMSCL035  DIM       8       * Diagnosis 3 Date (CCYYMMDD)        
PMSCL036  DIM       8       * Diagnosis 3 Time (HH:MM:SS)        
PMSCL037  DIM       3       * Diagnosis 3 Outcome 1 (Cat PF)     
PMSCL038  DIM       3       * Diagnosis 3 Outcome 2 (Cat PF)     
PMSCL039  DIM       3       * Diagnosis 3 Outcome 3 (Cat PF)     
PMSCL040  DIM       3       * Diagnosis 3 Outcome 4 (Cat PF)     
PMSCL041  DIM       8       * Diagnosis 3 Outcome Date 1         
PMSCL042  DIM       8       * Diagnosis 3 Outcome Time 1         
PMSCL043  DIM       8       * Diagnosis 3 Outcome Date 2         
PMSCL044  DIM       8       * Diagnosis 3 Outcome Time 2         
PMSCL045  DIM       8       * Diagnosis 3 Outcome Date 3         
PMSCL046  DIM       8       * Diagnosis 3 Outcome Time 3         
PMSCL047  DIM       8       * Diagnosis 3 Outcome Date 4         
PMSCL048  DIM       8       * Diagnosis 3 Outcome Time 4         
PMSCL049  DIM       9       * Diagnosis Code 4                   
PMSCL050  DIM       8       * Diagnosis 4 Date (CCYYMMDD)        
PMSCL051  DIM       8       * Diagnosis 4 Time (HH:MM:SS)        
PMSCL052  DIM       3       * Diagnosis 4 Outcome 1 (Cat PF)     
PMSCL053  DIM       3       * Diagnosis 4 Outcome 2 (Cat PF)     
PMSCL054  DIM       3       * Diagnosis 4 Outcome 3 (Cat PF)     
PMSCL055  DIM       3       * Diagnosis 4 Outcome 4 (Cat PF)     
PMSCL056  DIM       8       * Diagnosis 4 Outcome Date 1         
PMSCL057  DIM       8       * Diagnosis 4 Outcome Time 1         
PMSCL058  DIM       8       * Diagnosis 4 Outcome Date 2         
PMSCL059  DIM       8       * Diagnosis 4 Outcome Time 2         
PMSCL060  DIM       8       * Diagnosis 4 Outcome Date 3         
PMSCL061  DIM       8       * Diagnosis 4 Outcome Time 3         
PMSCL062  DIM       8       * Diagnosis 4 Outcome Date 4         
PMSCL063  DIM       8       * Diagnosis 4 Outcome Time 4         
PMSCL064  DIM       1       * Active Indicator 1=Active 0=Inactive
.
ADMALERT  DIM       1
CATH3     INIT      "H3"
CATWI     INIT      "wi"
CMDLINE   DIM       127       * Command line instruction
DASH      INIT      "-"
DELETKEY  DIM       16
DIM20     DIM       20
DIM8      DIM       8
MBSDESC   DIM       70
COMFILAF  FILE      ASCII, FIXED=127
COMFILNM  DIM       8
DISPDATE  DIM       11
FORM8     FORM      8
DOCTCODE  DIM       6
EMRFLAG   FORM      1
F3A       FORM      3
FAEXISTS  DIM       1         * Food Allergy Exists (0=no, 1=yes)
LASTITEM  FORM      3
NMPNUMB   DIM       20
OUTVAR    DIM       127
PACKLINK  DIM       70      * Test
SQUOTE    INIT      "'"
SAVESIN1  DIM       1
SAVESIN7  DIM       1
SAVESIN8  DIM       1
SAVESIN9  DIM       1
SAVESN11  DIM       1
SEVLEVEL  FORM      1
ALRTREAD  DIM       50
FHIRLOCH  DIM       50
FHIRRESC  DIM       50
ALRCOMM   DIM       100
ALRTCATD  DIM       20
ALRTCODD  DIM       20
.
FHIRBUND  FORM      1
FHRSUBIN  FORM      1      * _include=Flag:subject
FHRLOCIN  FORM      1      * _include=Flag:location
FHRPARIN  FORM      1      * _include=Flag:participant
.
CATTC     INIT      "tc"
.
.---------------------------------------------------------------------------
PRGID     INIT      "CLIWEB01"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Patient Alerts"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PATALT00          * Patient Alert Details           
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      PMSCLP00          * Patient Clinical Pathways       
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINLS000
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      FHREXT00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
+
.------------------------------------------------------------
. FHIR Exit Sucess
.   Return Location Header
.------------------------------------------------------------
FHREXT00  PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,FHREXT99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                             "  #"id#": #"allok#", ":
                             "  #"text#": { ":
                             "    #"status#": #"additional#", ":
                             "    #"div#": #"<div>All Ok</div>#" ":
                             "  }, ":
                             "  #"issue#": [ ":
                             "    { ":
                             "      #"severity#": #"information#", ":
                             "      #"code#": #"informational#", ":
                             "      #"details#": { ":
                             "        #"text#": #"All Ok#"":
                             "  } } ] }"
.
          CALL      CLOSHTML
FHREXT99  RETURN
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
WINLS000  CALL      OPENHTML
          BRANCH    EXIT,WINCLS99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#" ":
                               "src=#"../js/Custom.js#"></script>":
                               "<script type=#"text/javascript#"> ":
                               " if (self.name.match(/PopUpFrame/)) {":
                               "  reloadParentFrame();}":
                               "</script>"
          CALL      CLOSHTML
WINLS999  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open Routine in PATMASTM
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRUNKA1,"emrunkaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
.
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PMSALNA1,"pmsalnaf"
          OPEN      PMSALAA1,"pmsalaaf"
          OPEN      PMSCLPA1,"pmsclpaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      OBSPCOA6,"obspcoaf"
          OPEN      OBSPCOA5,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
.
          CALL      OPICD1               * Open ICD Disease file
.
          READ      CONTROLF,SEVENTY7;*96,PTCNASEC,PTCNLIFE,PTCNLFCH
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
            OPEN      PMSAUDAN,"pmsaudan"
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"
.
INIT9999  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM 
          MOVE      ZERO,NORECORD
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER 
          MOVE      SP70,ALERTKEY
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,ADMALERT
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
.
          MOVE      SP70,ALERT001
          MOVE      SP70,ALERT002
          MOVE      SP70,ALERT003
          MOVE      SP70,ALERT004
          MOVE      SP70,ALERT005
          MOVE      SP70,ALERT006
          MOVE      SP70,ALERT007
          MOVE      SP70,ALERT008
          MOVE      SP70,ALERT009
          MOVE      SP70,ALERT010
          MOVE      SP70,ALERT011
          MOVE      SP70,ALERT012
          MOVE      SP70,ALERT013
          MOVE      SP70,ALERT014
          MOVE      SP70,ALERT015
.
          MOVE      SP70,PMSCL001
          MOVE      SP70,PMSCL002
          MOVE      SP70,PMSCL003
          MOVE      SP70,PMSCL004
          MOVE      SP70,PMSCL005
          MOVE      SP70,PMSCL006
          MOVE      SP70,PMSCL007
          MOVE      SP70,PMSCL008
          MOVE      SP70,PMSCL009
          MOVE      SP70,PMSCL010
          MOVE      SP70,PMSCL011
          MOVE      SP70,PMSCL012
          MOVE      SP70,PMSCL013
          MOVE      SP70,PMSCL014
          MOVE      SP70,PMSCL015
          MOVE      SP70,PMSCL016
          MOVE      SP70,PMSCL017
          MOVE      SP70,PMSCL018
          MOVE      SP70,PMSCL019
          MOVE      SP70,PMSCL020
          MOVE      SP70,PMSCL021
          MOVE      SP70,PMSCL022
          MOVE      SP70,PMSCL023
          MOVE      SP70,PMSCL024
          MOVE      SP70,PMSCL025
          MOVE      SP70,PMSCL026
          MOVE      SP70,PMSCL027
          MOVE      SP70,PMSCL028
          MOVE      SP70,PMSCL029
          MOVE      SP70,PMSCL030
          MOVE      SP70,PMSCL031
          MOVE      SP70,PMSCL032
          MOVE      SP70,PMSCL033
          MOVE      SP70,PMSCL034
          MOVE      SP70,PMSCL035
          MOVE      SP70,PMSCL036
          MOVE      SP70,PMSCL037
          MOVE      SP70,PMSCL038
          MOVE      SP70,PMSCL039
          MOVE      SP70,PMSCL040
          MOVE      SP70,PMSCL041
          MOVE      SP70,PMSCL042
          MOVE      SP70,PMSCL043
          MOVE      SP70,PMSCL044
          MOVE      SP70,PMSCL045
          MOVE      SP70,PMSCL046
          MOVE      SP70,PMSCL047
          MOVE      SP70,PMSCL048
          MOVE      SP70,PMSCL049
          MOVE      SP70,PMSCL050
          MOVE      SP70,PMSCL051
          MOVE      SP70,PMSCL052
          MOVE      SP70,PMSCL053 
          MOVE      SP70,PMSCL054 
          MOVE      SP70,PMSCL055 
          MOVE      SP70,PMSCL056 
          MOVE      SP70,PMSCL057 
          MOVE      SP70,PMSCL058 
          MOVE      SP70,PMSCL059 
          MOVE      SP70,PMSCL060  
          MOVE      SP70,PMSCL061  
          MOVE      SP70,PMSCL062  
          MOVE      SP70,PMSCL063  
          MOVE      SP70,PMSCL064  
          MOVE      SP70,DELETKEY
          MOVE      SP70,FHIRLOCH
          MOVE      SP70,FHIRRESC
.
          MOVE      ZERO,FHIRBUND
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
.
          CALL      CPATAL00
.
CLRPAR99  RETURN
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.          
          MATCH     "alertkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALERTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCOM00              * Read in U/R Comments
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "admalert=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMALERT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deletkey=",QRYNAME
          IF        @EQUAL
            PACK      DELETKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alert",QRYNAME
          IF        @EQUAL
            CALL      SPALT000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmscl",QRYNAME
          IF        @EQUAL
            CALL      STCLP000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptalcatg",QRYNAME
          IF        @EQUAL
            CALL      SPACAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptalcode",QRYNAME
          IF        @EQUAL
            CALL      SPACOD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirresc=",QRYNAME
          IF        @EQUAL
            PACK      FHIRRESC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirbund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRBUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 2 - Patient Clinical Pathways
.-------------------------------------------------------------------------------
STCLP000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STCLP001,STCLP002,STCLP003,STCLP004,STCLP005:
                       STCLP006,STCLP007,STCLP008,STCLP009,STCLP010:
                       STCLP011,STCLP012,STCLP013,STCLP014,STCLP015:
                       STCLP016,STCLP017,STCLP018,STCLP019,STCLP020:
                       STCLP021,STCLP022,STCLP023,STCLP024,STCLP025:
                       STCLP026,STCLP027,STCLP028,STCLP029,STCLP030:
                       STCLP031,STCLP032,STCLP033,STCLP034,STCLP035:
                       STCLP036,STCLP037,STCLP038,STCLP039,STCLP040:
                       STCLP041,STCLP042,STCLP043,STCLP044,STCLP045:
                       STCLP046,STCLP047,STCLP048,STCLP049,STCLP050:
                       STCLP051,STCLP052,STCLP053,STCLP054,STCLP055:
                       STCLP056,STCLP057,STCLP058,STCLP059,STCLP060:
                       STCLP061,STCLP062,STCLP063,STCLP064
          GOTO      STCLP999
.
STCLP001  MOVE      QRYDATA,PMSCL001
          PACK      PMSCL001,PMSCL001,SP70
          GOTO      STCLP999
.
STCLP002  MOVE      QRYDATA,PMSCL002
          PACK      PMSCL002,PMSCL002,SP70
          GOTO      STCLP999
.
STCLP003  MOVE      QRYDATA,PMSCL003
          PACK      PMSCL003,PMSCL003,SP70
          GOTO      STCLP999
.
STCLP004  MOVE      QRYDATA,PMSCL004      * Diagnosis Code 1
          PACK      PMSCL004,PMSCL004,SP70
          GOTO      STCLP999
.
STCLP005  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL005,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL005
          GOTO      STCLP999
.
STCLP006  MOVE      QRYDATA,PMSCL006
          GOTO      STCLP999
.
STCLP007  MOVE      QRYDATA,PMSCL007
          GOTO      STCLP999
.
STCLP008  MOVE      QRYDATA,PMSCL008
          GOTO      STCLP999
.
STCLP009  MOVE      QRYDATA,PMSCL009
          GOTO      STCLP999
.
STCLP010  MOVE      QRYDATA,PMSCL010
          GOTO      STCLP999
.
STCLP011  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL011,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL011
          GOTO      STCLP999
.
STCLP012  MOVE      QRYDATA,PMSCL012
          GOTO      STCLP999
.
STCLP013  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL013,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL013
          GOTO      STCLP999
.
STCLP014  MOVE      QRYDATA,PMSCL014
          GOTO      STCLP999
.
STCLP015  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL015,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL015
          GOTO      STCLP999
.
STCLP016  MOVE      QRYDATA,PMSCL016
          GOTO      STCLP999
.
STCLP017  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL017,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL017
          GOTO      STCLP999
.
STCLP018  MOVE      QRYDATA,PMSCL018
          GOTO      STCLP999
.
STCLP019  MOVE      QRYDATA,PMSCL019      * Diagnosis Code 2
          PACK      PMSCL019,PMSCL019,SP70
          GOTO      STCLP999
.
STCLP020  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL020,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL020
          GOTO      STCLP999
.
STCLP021  MOVE      QRYDATA,PMSCL021
          GOTO      STCLP999
.
STCLP022  MOVE      QRYDATA,PMSCL022
          GOTO      STCLP999
.
STCLP023  MOVE      QRYDATA,PMSCL023
          GOTO      STCLP999
.
STCLP024  MOVE      QRYDATA,PMSCL024
          GOTO      STCLP999
.
STCLP025  MOVE      QRYDATA,PMSCL025
          GOTO      STCLP999
.
STCLP026  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL026,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL026
          GOTO      STCLP999
.
STCLP027  MOVE      QRYDATA,PMSCL027
          GOTO      STCLP999
.
STCLP028  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL028,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL028
          GOTO      STCLP999
.
STCLP029  MOVE      QRYDATA,PMSCL029
          GOTO      STCLP999
.
STCLP030  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL030,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL030
          GOTO      STCLP999
.
STCLP031  MOVE      QRYDATA,PMSCL031
          GOTO      STCLP999
.
STCLP032  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL032,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL032
          GOTO      STCLP999
.
STCLP033  MOVE      QRYDATA,PMSCL033
          GOTO      STCLP999
.
STCLP034  MOVE      QRYDATA,PMSCL034      * Diagnosis Code 3
          PACK      PMSCL034,PMSCL034,SP70
          GOTO      STCLP999
.
STCLP035  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL035,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL035
          GOTO      STCLP999
.
STCLP036  MOVE      QRYDATA,PMSCL036
          GOTO      STCLP999
.
STCLP037  MOVE      QRYDATA,PMSCL037
          GOTO      STCLP999
.
STCLP038  MOVE      QRYDATA,PMSCL038
          GOTO      STCLP999
.
STCLP039  MOVE      QRYDATA,PMSCL039
          GOTO      STCLP999
.
STCLP040  MOVE      QRYDATA,PMSCL040
          GOTO      STCLP999
.
STCLP041  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL041,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL041
          GOTO      STCLP999
.
STCLP042  MOVE      QRYDATA,PMSCL042
          GOTO      STCLP999
.
STCLP043  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL043,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL043
          GOTO      STCLP999
.
STCLP044  MOVE      QRYDATA,PMSCL044
          GOTO      STCLP999
.
STCLP045  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL045,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL045
          GOTO      STCLP999
.
STCLP046  MOVE      QRYDATA,PMSCL046
          GOTO      STCLP999
.
STCLP047  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL047,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL047
          GOTO      STCLP999
.
STCLP048  MOVE      QRYDATA,PMSCL048
          GOTO      STCLP999
.
STCLP049  MOVE      QRYDATA,PMSCL049      * Diagnosis Code 4
          PACK      PMSCL049,PMSCL049,SP70
          GOTO      STCLP999
.
STCLP050  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL050,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL050
          GOTO      STCLP999
.
STCLP051  MOVE      QRYDATA,PMSCL051
          GOTO      STCLP999
.
STCLP052  MOVE      QRYDATA,PMSCL052
          GOTO      STCLP999
.
STCLP053  MOVE      QRYDATA,PMSCL053
          GOTO      STCLP999
.
STCLP054  MOVE      QRYDATA,PMSCL054
          GOTO      STCLP999
.
STCLP055  MOVE      QRYDATA,PMSCL055
          GOTO      STCLP999
.
STCLP056  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL056,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL056
          GOTO      STCLP999
.
STCLP057  MOVE      QRYDATA,PMSCL057
          GOTO      STCLP999
.
STCLP058  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL058,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL058
          GOTO      STCLP999
.
STCLP059  MOVE      QRYDATA,PMSCL059
          GOTO      STCLP999
.
STCLP060  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL060,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL060
          GOTO      STCLP999
.
STCLP061  MOVE      QRYDATA,PMSCL061
          GOTO      STCLP999
.
STCLP062  RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STCLP999 IF EQUAL 

          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      PMSCL062,CCENT,CYEAR,CMON,CDAY
          REP       " 0",PMSCL062
          GOTO      STCLP999
.
STCLP063  MOVE      QRYDATA,PMSCL063
          GOTO      STCLP999
.
STCLP064  MOVE      QRYDATA,PMSCL064
          GOTO      STCLP999
.
STCLP999  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Patient Alert Details 
.-------------------------------------------------------------------------------
SPALT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPALT001,SPALT002,SPALT003,SPALT004,SPALT005:
                       SPALT006,SPALT007,SPALT008,SPALT009,SPALT010:
                       SPALT011,SPALT012,SPALT013,SPALT014,SPALT015
.
          MOVE      ONE,EXIT
          GOTO      SPALT999
.
SPALT001  MOVE      QRYDATA,ALERT001
          GOTO      SPALT999
SPALT002  MOVE      QRYDATA,ALERT002
          GOTO      SPALT999
.
SPALT003  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      ALERT003,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALT999
.
SPALT004  MOVE      QRYDATA,ALERT004
          GOTO      SPALT999
SPALT005  MOVE      QRYDATA,ALERT005
          GOTO      SPALT999
SPALT006  MOVE      QRYDATA,ALERT006
          GOTO      SPALT999
SPALT007  MOVE      QRYDATA,ALERT007
          GOTO      SPALT999
.
SPALT008  MATCH     SP70,QRYDATA
          GOTO      SPALT999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      ALERT008,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALT999    
. 
SPALT009  MOVE      QRYDATA,ALERT009
          GOTO      SPALT999
.
SPALT010  MATCH     SP70,QRYDATA
          GOTO      SPALT999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      ALERT010,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALT999    
.
SPALT011  MATCH     SP70,QRYDATA
          GOTO      SPALT999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      ALERT011,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALT999    
.
SPALT012  MOVE      QRYDATA,ALERT012
          GOTO      SPALT999
.
SPALT013  MOVE      QRYDATA,ALERT013
          GOTO      SPALT999
.
SPALT014  MOVE      QRYDATA,ALERT014
          GOTO      SPALT999
.
SPALT015  MOVE      QRYDATA,ALERT015
          GOTO      SPALT999
.
SPALT999  RETURN
.-------------------------------------------------------------------------------
. Patient Clinical Pathways
.-------------------------------------------------------------------------------
PMSCLP00  PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
. 
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PMSCLP40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PMSCLP10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PMSCLP20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      PMSCLP30 IF EQUAL
.
          GOTO      PMSCLP91
.
.         ************ ADD FORMACTION ***********
.
PMSCLP10  MOVE      URNUMBER,KEY8         * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PMSCLP94
.
          MOVE      ADMISSNO,KEY8         * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,PMSCLP95
.
          MOVE      ADMISSNO,KEY8         * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PMSCLP96
.
          CALL      CHKACT00              * Check for Active records
          BRANCH    EXIT,PMSCLP97
.
          CALL      GENUNQ00              * Generate Unique Pathway Number
          MOVE      F8,PMSCL003
.
          CALL      CLRCLP00              * Clear all vars as still sitting on
.                                         * last read record.
.                                           
          PACK      KEY19,PMSCL001,PMSCL002,PMSCL003,SP70
          CALL      RDPMCLP1                
          COMPARE   ZERO,OVRCD
          GOTO      PMSCLP92 IF EQUAL
.
          CALL      SAVCLP00
          CALL      WRPMCLP1
.
          MOVE      ZERO,EXIT
          GOTO      PMSCLP99
.
.         ************ UPDATE FORMACTION **********
.
PMSCLP20  MOVE      URNUMBER,KEY8         * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PMSCLP94
.
          MOVE      ADMISSNO,KEY8         * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,PMSCLP95
.
          MOVE      ADMISSNO,KEY8       * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PMSCLP96
.
          PACK      KEY19,PMSCL001,PMSCL002,PMSCL003,SP70
          CALL      RDPMCLP1                
          BRANCH    OVRCD,PMSCLP93   
.
          CALL      SAVCLP00
          CALL      UPPMCLP1
.
          MOVE      ZERO,EXIT
          GOTO      PMSCLP99
.
.         ************ DELETE FORMACTION **********
.
PMSCLP30  MOVE      URNUMBER,KEY8         * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PMSCLP94
.
          MOVE      ADMISSNO,KEY8         * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,PMSCLP95
.
          MOVE      ADMISSNO,KEY8       * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PMSCLP96
.
          PACK      KEY19,PMSCL001,PMSCL002,PMSCL003,SP70
          CALL      RDPMCLP1                
          BRANCH    OVRCD,PMSCLP93   
.
          MOVE      ZERO,PMCPACTV       * Active Indicator 1=Active 0=Inactive
          CALL      UPPMCLP1
.
          MOVE      ZERO,EXIT
          GOTO      PMSCLP99
.
.         ************ DISPLAY FORMACTION **********
.
PMSCLP40  MOVE      URNUMBER,KEY8       * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PMSCLP94
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8       * Read Visit File
          CALL      RDVISA1
          BRANCH    OVRCD,PMSCLP95
.
          MOVE      ADMISSNO,KEY8       * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,PMSCLP96
.
          PACK      KEY19,PMSCL001,PMSCL002,PMSCL003,SP70
          CALL      RDPMCLP1 
          IF        OVRCD=1
            CALL      CLRCLP00
          ENDIF
. 
          CLEAR     WEBTITLE
          APPEND    "Clinical Pathways for ",WEBTITLE
          CALL      PATNAA00                * Format name with bold tags
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,PMSCLP99
.
          CALL      WEBBOD00
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      PMSCLP99
.
PMSCLP91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSCLP99
.
PMSCLP92  MOVE      "Clinical Pathways record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSCLP99
.
PMSCLP93  MOVE      "Clinical Pathways record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMSCLP99
.
PMSCLP94  MOVE      "Can't find patient Master details",WEBTITLE  
          ENDSET    WEBTITLE 
          APPEND    URNUMBER,WEBTITLE  
          RESET     WEBTITLE  
          CALL      WEBERR00
          GOTO      PMSCLP99         
.
PMSCLP95  MOVE      "Can't find patient Visit details",WEBTITLE  
          ENDSET    WEBTITLE 
          APPEND    ADMISSNO,WEBTITLE  
          RESET     WEBTITLE  
          CALL      WEBERR00
          GOTO      PMSCLP99         
.
PMSCLP96  MOVE      "Can't find patient Admission details",WEBTITLE  
          ENDSET    WEBTITLE 
          APPEND    ADMISSNO,WEBTITLE  
          RESET     WEBTITLE  
          CALL      WEBERR00
          GOTO      PMSCLP99         
.
PMSCLP97  MOVE      "There is already one active Clinical Pathway",WEBTITLE  
          ENDSET    WEBTITLE 
          APPEND    " record for this patient!",WEBTITLE  
          RESET     WEBTITLE  
          CALL      WEBERR00
          GOTO      PMSCLP99         
.
PMSCLP99  RETURN 
.------------------------------------------------------------
. Clear Patiebt Clinical Pathways Details
.------------------------------------------------------------
CLRCLP00  MOVE      SP70,PMCPADMN  * Admission Number                   
          MOVE      SP70,PMCPCLPT  * Clinical Pathway (Cat PW)          
          MOVE      SP70,PMCPUNIQ  * Clinical Pathway Unique No.        
          MOVE      SP70,PMCPDIG1  * Diagnosis Code 1                   
          MOVE      SP70,PMCPDDT1  * Diagnosis Date 1 (CCYYMMDD)        
          MOVE      SP70,PMCPDTM1  * Diagnosis Time 1 (HH:MM:SS)        
          MOVE      SP70,PMCPD1O1  * Diagnosis 1 Outcome 1 (Cat PF)     
          MOVE      SP70,PMCPD1O2  * Diagnosis 1 Outcome 2 (Cat PF)     
          MOVE      SP70,PMCPD1O3  * Diagnosis 1 Outcome 3 (Cat PF)     
          MOVE      SP70,PMCPD1O4  * Diagnosis 1 Outcome 4 (Cat PF)     
          MOVE      SP70,PMCPD1D1  * Diagnosis 1 Outcome Date 1         
          MOVE      SP70,PMCPD1T1  * Diagnosis 1 Outcome Time 1         
          MOVE      SP70,PMCPD1D2  * Diagnosis 1 Outcome Date 2         
          MOVE      SP70,PMCPD1T2  * Diagnosis 1 Outcome Time 2         
          MOVE      SP70,PMCPD1D3  * Diagnosis 1 Outcome Date 3         
          MOVE      SP70,PMCPD1T3  * Diagnosis 1 Outcome Time 3         
          MOVE      SP70,PMCPD1D4  * Diagnosis 1 Outcome Date 4         
          MOVE      SP70,PMCPD1T4  * Diagnosis 1 Outcome Time 4         
          MOVE      SP70,PMCPDIG2  * Diagnosis Code 2                   
          MOVE      SP70,PMCPDDT2  * Diagnosis 2 Date (CCYYMMDD)        
          MOVE      SP70,PMCPDTM2  * Diagnosis 2 Time (HH:MM:SS)        
          MOVE      SP70,PMCPD2O1  * Diagnosis 2 Outcome 1 (Cat PF)     
          MOVE      SP70,PMCPD2O2  * Diagnosis 2 Outcome 2 (Cat PF)     
          MOVE      SP70,PMCPD2O3  * Diagnosis 2 Outcome 3 (Cat PF)     
          MOVE      SP70,PMCPD2O4  * Diagnosis 2 Outcome 4 (Cat PF)     
          MOVE      SP70,PMCPD2D1  * Diagnosis 2 Outcome Date 1         
          MOVE      SP70,PMCPD2T1  * Diagnosis 2 Outcome Time 1         
          MOVE      SP70,PMCPD2D2  * Diagnosis 2 Outcome Date 2         
          MOVE      SP70,PMCPD2T2  * Diagnosis 2 Outcome Time 2         
          MOVE      SP70,PMCPD2D3  * Diagnosis 2 Outcome Date 3         
          MOVE      SP70,PMCPD2T3  * Diagnosis 2 Outcome Time 3         
          MOVE      SP70,PMCPD2D4  * Diagnosis 2 Outcome Date 4         
          MOVE      SP70,PMCPD2T4  * Diagnosis 2 Outcome Time 4         
          MOVE      SP70,PMCPDIG3  * Diagnosis Code 3                   
          MOVE      SP70,PMCPDDT3  * Diagnosis 3 Date (CCYYMMDD)        
          MOVE      SP70,PMCPDTM3  * Diagnosis 3 Time (HH:MM:SS)        
          MOVE      SP70,PMCPD3O1  * Diagnosis 3 Outcome 1 (Cat PF)     
          MOVE      SP70,PMCPD3O2  * Diagnosis 3 Outcome2 (Cat PF)     
          MOVE      SP70,PMCPD3O3  * Diagnosis 3 Outcome 3 (Cat PF)     
          MOVE      SP70,PMCPD3O4  * Diagnosis 3 Outcome 4 (Cat PF)     
          MOVE      SP70,PMCPD3D1  * Diagnosis 3 Outcome Date 1         
          MOVE      SP70,PMCPD3T1  * Diagnosis 3 Outcome Time 1         
          MOVE      SP70,PMCPD3D2  * Diagnosis 3 Outcome Date 2         
          MOVE      SP70,PMCPD3T2  * Diagnosis 3 Outcome Time 2         
          MOVE      SP70,PMCPD3D3  * Diagnosis 3 Outcome Date 3         
          MOVE      SP70,PMCPD3T3  * Diagnosis 3 Outcome Time 3         
          MOVE      SP70,PMCPD3D4  * Diagnosis 3 Outcome Date 4         
          MOVE      SP70,PMCPD3T4  * Diagnosis 3 Outcome Time 4         
          MOVE      SP70,PMCPDIG4  * Diagnosis Code 4                   
          MOVE      SP70,PMCPDDT4  * Diagnosis 4 Date (CCYYMMDD)        
          MOVE      SP70,PMCPDTM4  * Diagnosis 4 Time (HH:MM:SS)        
          MOVE      SP70,PMCPD4O1  * Diagnosis 4 Outcome 1 (Cat PF)     
          MOVE      SP70,PMCPD4O2  * Diagnosis 4 Outcome 2 (Cat PF)     
          MOVE      SP70,PMCPD4O3  * Diagnosis 4 Outcome 3 (Cat PF)     
          MOVE      SP70,PMCPD4O4  * Diagnosis 4 Outcome 4 (Cat PF)     
          MOVE      SP70,PMCPD4D1  * Diagnosis 4 Outcome Date 1         
          MOVE      SP70,PMCPD4T1  * Diagnosis 4 Outcome Time 1         
          MOVE      SP70,PMCPD4D2  * Diagnosis 4 Outcome Date 2         
          MOVE      SP70,PMCPD4T2  * Diagnosis 4 Outcome Time 2         
          MOVE      SP70,PMCPD4D3  * Diagnosis 4 Outcome Date 3         
          MOVE      SP70,PMCPD4T3  * Diagnosis 4 Outcome Time 3         
          MOVE      SP70,PMCPD4D4  * Diagnosis 4 Outcome Date 4         
          MOVE      SP70,PMCPD4T4  * Diagnosis 4 Outcome Time 4         
          MOVE      SP70,PMCPACTV  * Active Indicator 1=Active 0=Inactive
          MOVE      SP70,PMCPDTCR  * Date Record Created                
          MOVE      SP70,PMCPTMCR  * Time Record Created                
          MOVE      SP70,PMCPWBCR  * Web User ID Created                
          MOVE      SP70,PMCPDTUP  * Date Record Updated                
          MOVE      SP70,PMCPTMUP  * Time Record Updated                
          MOVE      SP70,PMCPWBUP  * Web User ID Updated                
          MOVE      SP70,PMCPSPAR  * Spare                              
.
CLRCLP99  RETURN
.------------------------------------------------------------
. Save Patiebt Clinical Pathways Details
.------------------------------------------------------------
SAVCLP00  MOVE      PMSCL001,PMCPADMN  * Admission Number                   
          MOVE      PMSCL002,PMCPCLPT  * Clinical Pathway (Cat PW)          
          MOVE      PMSCL003,PMCPUNIQ  * Clinical Pathway Unique No.        
.
          MATCH     SP70,PMSCL004      * Only sav Diag 1 info if Diag1 found!
          GOTO      SAVCLP10 IF EQUAL
.
          MOVE      PMSCL004,PMCPDIG1  * Diagnosis Code 1                   
          MOVE      PMSCL005,PMCPDDT1  * Diagnosis Date 1 (CCYYMMDD)        
          MOVE      PMSCL006,PMCPDTM1  * Diagnosis Time 1 (HH:MM:SS)        
          MOVE      PMSCL007,PMCPD1O1  * Diagnosis 1 Outcome 1 (Cat PF)     
          MOVE      PMSCL008,PMCPD1O2  * Diagnosis 1 Outcome 2 (Cat PF)     
          MOVE      PMSCL009,PMCPD1O3  * Diagnosis 1 Outcome 3 (Cat PF)     
          MOVE      PMSCL010,PMCPD1O4  * Diagnosis 1 Outcome 4 (Cat PF)     
          MOVE      PMSCL011,PMCPD1D1  * Diagnosis 1 Outcome Date 1         
          MOVE      PMSCL012,PMCPD1T1  * Diagnosis 1 Outcome Time 1         
          MOVE      PMSCL013,PMCPD1D2  * Diagnosis 1 Outcome Date 2         
          MOVE      PMSCL014,PMCPD1T2  * Diagnosis 1 Outcome Time 2         
          MOVE      PMSCL015,PMCPD1D3  * Diagnosis 1 Outcome Date 3         
          MOVE      PMSCL016,PMCPD1T3  * Diagnosis 1 Outcome Time 3         
          MOVE      PMSCL017,PMCPD1D4  * Diagnosis 1 Outcome Date 4         
          MOVE      PMSCL018,PMCPD1T4  * Diagnosis 1 Outcome Time 4         
.
SAVCLP10  MATCH     SP70,PMSCL019      * Only sav Diag 2 info if Diag2 found!
          GOTO      SAVCLP20 IF EQUAL
.
          MOVE      PMSCL019,PMCPDIG2  * Diagnosis Code 2                   
          MOVE      PMSCL020,PMCPDDT2  * Diagnosis 2 Date (CCYYMMDD)        
          MOVE      PMSCL021,PMCPDTM2  * Diagnosis 2 Time (HH:MM:SS)        
          MOVE      PMSCL022,PMCPD2O1  * Diagnosis 2 Outcome 1 (Cat PF)     
          MOVE      PMSCL023,PMCPD2O2  * Diagnosis 2 Outcome 2 (Cat PF)     
          MOVE      PMSCL024,PMCPD2O3  * Diagnosis 2 Outcome 3 (Cat PF)     
          MOVE      PMSCL025,PMCPD2O4  * Diagnosis 2 Outcome 4 (Cat PF)     
          MOVE      PMSCL026,PMCPD2D1  * Diagnosis 2 Outcome Date 1         
          MOVE      PMSCL027,PMCPD2T1  * Diagnosis 2 Outcome Time 1         
          MOVE      PMSCL028,PMCPD2D2  * Diagnosis 2 Outcome Date 2         
          MOVE      PMSCL029,PMCPD2T2  * Diagnosis 2 Outcome Time 2         
          MOVE      PMSCL030,PMCPD2D3  * Diagnosis 2 Outcome Date 3         
          MOVE      PMSCL031,PMCPD2T3  * Diagnosis 2 Outcome Time 3         
          MOVE      PMSCL032,PMCPD2D4  * Diagnosis 2 Outcome Date 4         
          MOVE      PMSCL033,PMCPD2T4  * Diagnosis 2 Outcome Time 4         
.
SAVCLP20  MATCH     SP70,PMSCL034      * Only sav Diag 3 info if Diag3 found!
          GOTO      SAVCLP30 IF EQUAL
.
          MOVE      PMSCL034,PMCPDIG3  * Diagnosis Code 3                   
          MOVE      PMSCL035,PMCPDDT3  * Diagnosis 3 Date (CCYYMMDD)        
          MOVE      PMSCL036,PMCPDTM3  * Diagnosis 3 Time (HH:MM:SS)        
          MOVE      PMSCL037,PMCPD3O1  * Diagnosis 3 Outcome 1 (Cat PF)     
          MOVE      PMSCL038,PMCPD3O2  * Diagnosis 3 Outcome2 (Cat PF)     
          MOVE      PMSCL039,PMCPD3O3  * Diagnosis 3 Outcome 3 (Cat PF)     
          MOVE      PMSCL040,PMCPD3O4  * Diagnosis 3 Outcome 4 (Cat PF)     
          MOVE      PMSCL041,PMCPD3D1  * Diagnosis 3 Outcome Date 1         
          MOVE      PMSCL042,PMCPD3T1  * Diagnosis 3 Outcome Time 1         
          MOVE      PMSCL043,PMCPD3D2  * Diagnosis 3 Outcome Date 2         
          MOVE      PMSCL044,PMCPD3T2  * Diagnosis 3 Outcome Time 2         
          MOVE      PMSCL045,PMCPD3D3  * Diagnosis 3 Outcome Date 3         
          MOVE      PMSCL046,PMCPD3T3  * Diagnosis 3 Outcome Time 3         
          MOVE      PMSCL047,PMCPD3D4  * Diagnosis 3 Outcome Date 4         
          MOVE      PMSCL048,PMCPD3T4  * Diagnosis 3 Outcome Time 4         
.
SAVCLP30  MATCH     SP70,PMSCL049      * Only sav Diag 4 info if Diag4 found!
          GOTO      SAVCLP40 IF EQUAL
.
          MOVE      PMSCL049,PMCPDIG4  * Diagnosis Code 4                   
          MOVE      PMSCL050,PMCPDDT4  * Diagnosis 4 Date (CCYYMMDD)        
          MOVE      PMSCL051,PMCPDTM4  * Diagnosis 4 Time (HH:MM:SS)        
          MOVE      PMSCL052,PMCPD4O1  * Diagnosis 4 Outcome 1 (Cat PF)     
          MOVE      PMSCL053,PMCPD4O2  * Diagnosis 4 Outcome 2 (Cat PF)     
          MOVE      PMSCL054,PMCPD4O3  * Diagnosis 4 Outcome 3 (Cat PF)     
          MOVE      PMSCL055,PMCPD4O4  * Diagnosis 4 Outcome 4 (Cat PF)     
          MOVE      PMSCL056,PMCPD4D1  * Diagnosis 4 Outcome Date 1         
          MOVE      PMSCL057,PMCPD4T1  * Diagnosis 4 Outcome Time 1         
          MOVE      PMSCL058,PMCPD4D2  * Diagnosis 4 Outcome Date 2         
          MOVE      PMSCL059,PMCPD4T2  * Diagnosis 4 Outcome Time 2         
          MOVE      PMSCL060,PMCPD4D3  * Diagnosis 4 Outcome Date 3         
          MOVE      PMSCL061,PMCPD4T3  * Diagnosis 4 Outcome Time 3         
          MOVE      PMSCL062,PMCPD4D4  * Diagnosis 4 Outcome Date 4         
          MOVE      PMSCL063,PMCPD4T4  * Diagnosis 4 Outcome Time 4         
.
SAVCLP40  MOVE      ONE,PMCPACTV       * Active Indicator 1=Active 0=Inactive
.
          MATCH     "A",UPDTTYPE       * Add Formaction
          IF        @EQUAL
            MOVE      CURRDATE,PMCPDTCR  * Date Record Created                
            MOVE      CTIMEIS,PMCPTMCR   * Time Record Created                
            MOVE      USERID,PMCPWBCR    * Web User ID Created                
            MOVE      SP70,PMCPDTUP      * Date Record Updated                
            MOVE      SP70,PMCPTMUP      * Time Record Updated                
            MOVE      SP70,PMCPWBUP      * Web User ID Updated                
          ELSE
            MOVE      CURRDATE,PMCPDTUP  * Date Record Updated                
            MOVE      CTIMEIS,PMCPTMUP   * Time Record Updated                
            MOVE      USERID,PMCPWBUP    * Web User ID Updated                
          ENDIF
.
          MOVE      SP70,PMCPSPAR  * Spare                              
.
SAVCLP99  RETURN
.------------------------------------------------------------
. Generate New Unique Pathway Number
.------------------------------------------------------------
GENUNQ00  MOVE      ZERO,F8
.
          PACK      KEY19,PMSCL001,PMSCL002,Z70
          CALL      RSPMCLP1
          CALL      RPPMCLP1
          BRANCH    OVRCD,GENUNQ90
.
          MATCH     PMSCL001,PMCPADMN       * Match on Visit No
          GOTO      GENUNQ90 IF NOT EQUAL
.
          MATCH     PMSCL002,PMCPCLPT       * Match on Clinical Pathway
          GOTO      GENUNQ90 IF NOT EQUAL
.
          MOVE      PMCPUNIQ,F8
          ADD       ONE,F8
          GOTO      GENUNQ99
.
GENUNQ90  MOVE      ONE,F8
.
GENUNQ99  RETURN
.------------------------------------------------------------
. Check for Active Pathway Record
.------------------------------------------------------------
CHKACT00  MOVE      ZERO,EXIT
.
          PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMCLP1
CHKACT10  CALL      RKPMCLP1
          BRANCH    OVRCD,CHKACT99
.
          MATCH     ADMISSNO,PMCPADMN       * Match on Admission No
          GOTO      CHKACT99 IF NOT EQUAL
.
          MATCH     "1",PMCPACTV       * 1=Active                 
          GOTO      CHKACT90 IF EQUAL
.
          GOTO      CHKACT10
.
CHKACT90  MOVE      ONE,EXIT
.
CHKACT99  RETURN
.-------------------------------------------------------------------------------
. Patient Alert Details
.-------------------------------------------------------------------------------
PATALT00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PATALT40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PATALT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PATALT20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      PATALT30 IF EQUAL
.
          GOTO      PATALT91
.
.         ************ ADD FORMACTION (SINGLE) ***********
.
PATALT10  IF        PTCODCNT > 0
            GOTO      PATALT15              * we have multiple alerts
          ENDIF
.
          CALL      CHKALT00      * Checks mandatory fields
          BRANCH    EXIT,PATALT99
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      ADDALT00    * Add Routine for Admission No.
            BRANCH    EXIT,PATALT92  
          ELSE 
            CALL      ADDALR00    * Add Routine for URNUMBER
            BRANCH    EXIT,PATALT92  
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PATALT99
.
.         ************ ADD FORMACTION (MULTI) ***********
.
PATALT15  MOVE      ONE,PTALRCNT
          WHILE     PTALRCNT <= PTCODCNT
            UNPACK    PTCODARR[PTALRCNT],ALERT001,ALERT002
.
            CALL      CHKALT00      * Checks mandatory fields
            BRANCH    EXIT,PATALT99
.
            MATCH     "       0",URNUMBER
            IF        @EQUAL
              CALL      ADDALT00    * Add Routine for Admission No.
              BRANCH    EXIT,PATALT92
            ELSE
              CALL      ADDALR00    * Add Routine for URNUMBER
              BRANCH    EXIT,PATALT92
            ENDIF
            ADD       ONE,PTALRCNT
          DO
.
          MOVE      ZERO,EXIT
          GOTO      PATALT99

.
.         ************ UPDATE FORMACTION **********
.
PATALT20  CALL      CHKALT00      * Checks mandatory fields
          BRANCH    EXIT,PATALT99
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      UPDALT00    * Update Routine for Admission No.
            BRANCH    EXIT,PATALT93  
          ELSE 
            CALL      UPDALR00    * Update Routine for URNUMBER
            BRANCH    EXIT,PATALT93  
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PATALT99
.
.         ************ DELETE FORMACTION **********
.
PATALT30  MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      DELALT00    * Delete Routine for Admission No.
            BRANCH    EXIT,PATALT93  
          ELSE 
            CALL      DELALR00    * Delete Routine for URNUMBER
            BRANCH    EXIT,PATALT93  
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PATALT99
.
.         ************ DISPLAY FORMACTION **********
.
PATALT40  BRANCH    CAUDA1,PATALT41         * Using alert audit
.
          MATCH     SP70,DELETKEY
          IF        !@EQUAL
            CALL      DAUD0000              * Get deleted audit record
            GOTO      PATALT45
          ENDIF 
.
PATALT41  MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      FINVIS00
            BRANCH    EXIT,PATALT94
            PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70  
            CALL      RDPTALT1      * Read Patient Alerts with ADMISSNO
            IF        OVRCD=1
              CALL      CLPATALR
            ENDIF            
          ELSE
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,PATALT94
            PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70  
            CALL      RDPTALR1      * Read Patient Alerts with U/R no.
            IF        OVRCD=1
              CALL      CLPATALR
            ENDIF            
          ENDIF
.
PATALT45  MATCH     SP70,ALERT002
          IF        @EQUAL
            CALL      CLPATALR
          ENDIF
. 
          CLEAR     WEBTITLE
          APPEND    "Patient Alerts for ",WEBTITLE
          CALL      PATNAA00                * Format name with bold tags
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      WEBHED00
          BRANCH    EXIT,PATALT99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      PATALT99
.
PATALT91  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATALT99
.
PATALT92  MOVE      "Alert record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATALT99
.
PATALT93  MOVE      "Alert record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATALT99
.
PATALT94  MOVE      "Can't find patient master details",WEBTITLE  
          APPEND    URNUMBER,WEBTITLE  
          RESET     WEBTITLE  
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATALT99         
.
PATALT99  CLOSE     COMFILAF,DELETE
          RETURN 
.-----------------------------------------------------------------------
. Add Record for a Valid U/R No. to "patalrtf"
.-----------------------------------------------------------------------
ADDALR00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ADDALR99
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ADDALR99
.
          CALL      CONC0000            * Generate Counter (ALERT013)
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
          CALL      RDPTALR1
          COMPARE   ZERO,OVRCD
          GOTO      ADDALR98 IF EQUAL
.
          CALL      IBACLOCK
          PACK      PTALCDTE,CCC,CYY,CMM,CDD  * Current Date
          REP       " 0",PTALCDTE       * Creation Date (CCYYMMDD)
          MOVE      CTIMEIS,PTALCTIM    * Creation Time (hh:mm:ss)
          MOVE      USERID,PTALUSID     * User ID Created
          MOVE      SP70,PTALUDAT       * Date Record Updated
          MOVE      SP70,PTALUTIM       * Time Record Updated
          MOVE      SP70,PTALUUID       * Web User ID Updated
          MOVE      WBSEHOSP,PTALHOSP   * Initiating Hospital
.
          CALL      SAVALT00      * Moves input variables to file variables
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
          CALL      WRPTALR1      * Writes away the data
.
          REP       " -",KEY16
          STRIP     FHIRRESC
          CLEAR     FHIRLOCH           * FHIR Location Header
          APPEND    FHIRRESC,FHIRLOCH
          APPEND    "/",FHIRLOCH
          APPEND    KEY16,FHIRLOCH
          RESET     FHIRLOCH
          STRIP     FHIRLOCH
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
          CALL      ALCMN000      * Writes away the comments
.
          MOVE      "A",KEY1      * Set Add Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
.
          CALL      CHKALR00
          GOTO      ADDALR99       
.
ADDALR98  MOVE      ONE,EXIT
ADDALR99  RETURN
.-----------------------------------------------------------------------
. Add Record for a Valid Admission No. to "pataltaf"
.-----------------------------------------------------------------------
ADDALT00  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          IF        OVRCD=1
            CALL      MAKPRA00
            BRANCH    EXIT,ADDALT99
          ENDIF
.
          CALL      CONB0000            * Generate Counter (ALERT013)
.
          PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70
          CALL      RDPTALT1
          COMPARE   ZERO,OVRCD
          GOTO      ADDALT98 IF EQUAL
.
          CALL      IBACLOCK
          PACK      PTALCDTE,CCC,CYY,CMM,CDD  * Current Date
          REP       " 0",PTALCDTE       * Creation Date (CCYYMMDD)
          MOVE      CTIMEIS,PTALCTIM    * Creation Time (hh:mm:ss)
          MOVE      USERID,PTALUSID     * User ID Created
          MOVE      SP70,PTALUDAT       * Date Record Updated
          MOVE      SP70,PTALUTIM       * Time Record Updated
          MOVE      SP70,PTALUUID       * Web User ID Updated
          MOVE      WBSEHOSP,PTALHOSP   * Initiating Hospital
.
          CALL      SAVALT00      * Moves input variables to file variables
.
          PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70
          CALL      WRPTALT1      * Writes away the data
.
          REP       " -",KEY16
          STRIP     FHIRRESC
          CLEAR     FHIRLOCH           * FHIR Location Header
          APPEND    FHIRRESC,FHIRLOCH
          APPEND    "/",FHIRLOCH
          APPEND    KEY16,FHIRLOCH
          RESET     FHIRLOCH
          STRIP     FHIRLOCH
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
.
          MOVE      "A",KEY1      * Set Add Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
          CALL      ALCMA000      * Writes away the comments
.
          CALL      CHKATT00
          MOVE      ZERO,EXIT
.
          GOTO      ADDALT99       
.
ADDALT98  MOVE      ONE,EXIT
ADDALT99  RETURN
.
MAKPRA00  CALL      CLPATMAS
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,MAKPRA90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE      EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ADMISSNO,PURNO        * Added by NMH 28/01/2000
          MOVE      ADMISSNO,KEY8
.
          MOVE      "1",PTMXSIN1          * Alerts yes
.
          PACK      KEY5,ALERT001,ALERT002,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSS,TCINDC4
            IF        @EQUAL
              MOVE      "2",PTMXSIN1      * Set security alert to yes
            ENDIF
          ENDIF
.
          CALL      RDAPRAM1
          IF        OVRCD=1
            CALL      WRPRAM1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      MAKPRA99
.
MAKPRA90  MOVE      ONE,EXIT
MAKPRA99  RETURN
.-----------------------------------------------------------------------
. Update Record for a Valid U/R No. to "patalrtf"
.-----------------------------------------------------------------------
UPDALR00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UPDALR99
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDALR99
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
          CALL      RDPTALR1
          BRANCH    OVRCD,UPDALR98
.
          MOVE      "B",KEY1      * Set Before Changes Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
.
          CALL      IBACLOCK
          PACK      PTALUDAT,CCC,CYY,CMM,CDD  * Current Date
          REP       " 0",PTALUDAT       * Update Date (CCYYMMDD)
          MOVE      CTIMEIS,PTALUTIM    * Update Time (hh:mm:ss)
          MOVE      USERID,PTALUUID     * User ID Updated
.
          CALL      SAVALT00      * Moves input variables to file variables
.
          CALL      UPPTALR1      * Writes away the data
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
          CALL      ALCMN000      * Update comments
.
          MOVE      "C",KEY1      * Set After Changes Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
.
          CALL      CHKALR00
          GOTO      UPDALR99
. 
UPDALR98  MOVE      ONE,EXIT
UPDALR99  RETURN
.-----------------------------------------------------------------------
. Update Record for a Valid Admissno No. to "pataltaf"
.-----------------------------------------------------------------------
UPDALT00  PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70
          CALL      RDPTALT1
          BRANCH    OVRCD,UPDALT98
.
          MOVE      "B",KEY1      * Set Before Changes Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
.
          PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70
          CALL      RLPTALT1      * Read Lock record 
          CALL      IBACLOCK
          PACK      PTALUDAT,CCC,CYY,CMM,CDD  * Current Date
          REP       " 0",PTALUDAT       * Update Date (CCYYMMDD)
          MOVE      CTIMEIS,PTALUTIM    * Update Time (hh:mm:ss)
          MOVE      USERID,PTALUUID     * User ID Updated
.
          CALL      SAVALT00      * Moves input variables to file variables
.
          CALL      UPPTALT1      * Writes away the data
          CALL      ULPTALT1      * Unlock record 
.
          MOVE      "C",KEY1      * Set After Changes Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
          CALL      ALCMA000      * Writes away the comments
.
          CALL      CHKATT00
          MOVE      ZERO,EXIT
.
          GOTO      UPDALT99
. 
UPDALT98  MOVE      ONE,EXIT
UPDALT99  RETURN
.-----------------------------------------------------------------------
. Delete Record for a Valid U/R No. to "patalrtf"
.-----------------------------------------------------------------------
DELALR00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,DELALR99
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,DELALR99
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,ALERT013,SP70 
          CALL      RDPTALR1
          BRANCH    OVRCD,DELALR98
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
          CALL      DEPTALR1
.
          CALL      DELC0000          * delete linked clinical document
.
          MOVE      "D",KEY1          * Set Delete Parameter for ALTAUD00
          CALL      ALTAUD00          * Write Audit File if Needed
.
          CALL      DECMN000          * delete alert comments
.
          CALL      CHKALR00
.
DELALR25  MATCH     SP70,PTMXSIN1
          GOTO      DELALR40 IF NOT EQUAL
.
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,DELALR40          * No alerts
.
          MATCH     PTMWURNO,URNUMBER       * Same ur
          GOTO      DELALR40 IF NOT EQUAL
.
          MOVE      "1",PTMXSIN1            * Yes alers for this ur
.
DELALR40  BRANCH    CAUDA1,DELALR60         * Using alert audits
.
          MATCH     "1",PMPXSIN7
          GOTO      DELALR60 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN8
          GOTO      DELALR60 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSIN9
          GOTO      DELALR60 IF EQUAL       * current alert exists
.
          MATCH     "1",PMPXSN11
          GOTO      DELALR60 IF EQUAL       * current alert exists
.
          MATCH     "0",PTMXSIN1            * Any current alerts
          IF        !@EQUAL
            MATCH     " ",PTMXSIN1          * Any current alerts
            GOTO      DELALR60 IF NOT EQUAL  
          ENDIF
.  
          PACK      KEY27,URNUMBER,SP70
          CALL      ASPTALR2
DELALR45  CALL      AKPTALR2
          BRANCH    OVRCD,DELALR60
.
          MATCH     URNUMBER,PTALURNO       
          GOTO      DELALR60 IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR           * Delete
          GOTO      DELALR45 IF NOT EQUAL
.
          MOVE      "3",PTMXSIN1            * Yes there are deleted alerts
.
DELALR60  CALL      UPMAST1
          GOTO      DELALR99
.
DELALR98  MOVE      ONE,EXIT
DELALR99  RETURN
+
.-----------------------------------------------------------------------
.         DELC0000 - delete linked clinical document
.-----------------------------------------------------------------------
.
DELC0000  PACK      KEY25,URNUMBER,ALERT001,ALERT002,ADMISSNO,SP70
          CALL      RSOBPC6
DELC1000  CALL      RKOBPC6
          BRANCH    OVRCD,DELC9999
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      DELC9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      DELC9999 IF NOT EQUAL
.
          MATCH     ALERT001,OBPCACAT
          GOTO      DELC9999 IF NOT EQUAL
.
          MATCH     ALERT002,OBPCACOD
          GOTO      DELC9999 IF NOT EQUAL
.
          PACK      KEY28,OBPCURNO,OBPCINDT,OBPCCVIS,OBPCCPID
          CALL      RDOBPC5
          BRANCH    OVRCD,DELC1000
.
          CALL      DEOBPC5
.
          GOTO      DELC1000
.
DELC9999  MOVE      ZERO,EXIT
          RETURN
+
.-----------------------------------------------------------------------
. Delete Record for a Valid Admissno No. to "pataltaf"
.-----------------------------------------------------------------------
DELALT00  PACK      KEY16,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70 
          CALL      RDPTALT1
          BRANCH    OVRCD,DELALT98
.
          CALL      DEPTALT1
.
          MOVE      "D",KEY1      * Set Delete Parameter for ALTAUD00
          CALL      ALTAUD00      * Write Audit File if Needed
          CALL      DECMA000          * delete alert comments
.
          CALL      CHKATT00
.
          GOTO      DELALT99
. 
DELALT98  MOVE      ONE,EXIT
DELALT99  RETURN
.------------------------------------------------------------
. Get Name from Visit Based Tables
.------------------------------------------------------------
FINVIS00  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,FINVIS80
.
          BRANCH    PVITYPE,FINVIS10,FINVIS20,FINVIS20
          MOVE      ONE,EXIT
          GOTO      FINVIS99
.
FINVIS10  BRANCH    EMRFLAG,FINVIS90
          MOVE      PVIBILL,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      URNUMBER,PURNO        * Added by NMH 28/01/2000
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS20  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS30  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS80  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS85
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS85  BRANCH    EMRFLAG,FINVIS90
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS90  MOVE      ONE,EXIT
.
FINVIS99  RETURN
.---------------------------------------------------------------------
. Save routine - move cgi parameters into file variables
.---------------------------------------------------------------------
SAVALT00  MATCH     "       0",URNUMBER
          IF        @EQUAL 
            MOVE      ADMISSNO,PTALURNO   * Patient's Admissno Number
          ELSE
            MOVE      URNUMBER,PTALURNO   * Patient's UR Number
          ENDIF
.
          MOVE      ALERT001,PTALCATG   * Codes file Ctegory (H1 to H9)
          MOVE      ALERT002,PTALCODE   * Codes file code (for Categ.)
          MOVE      ALERT003,PTALDATE   * Date (CCYYMMDD)
          MOVE      ALERT008,PTALRDTE   * Review Date (CCYYMMDD)
          MOVE      ALERT013,PTALCNTR   * Counter
.
          MATCH     "1",ALERT004
          IF        @EQUAL
            MOVE      PTCNLFCH,PTALLIFE
          ELSE
            MOVE      SP70,PTALLIFE
          ENDIF 
.
          MATCH     ALERT014,PTALCPAC
          IF        !@EQUAL
            MOVE      USERID,PTALUCPF   * user has changed care pathway flag
            PACK      PTALDCPU,CCC,CYY,CMM,CDD   * Current Date
            REP       " 0",PTALDCPU     * date user changed care pathway flag
          ENDIF
          MOVE      ALERT014,PTALCPAC   * Care Pathway Activated (1=Yes/0=No)
.
          MOVE      ALERT005,PTALREAC   * Reaction Code(wn)
          MOVE      ALERT006,PTALLSEV   * Severity Level (0-9)
          MOVE      ALERT007,PTALRCOM   * Reaction Comment
          MOVE      ALERT009,PTALICDC   * ICD10 Code 
          MOVE      ALERT010,PTALDTIN   * Date Inactive (ccyymmdd)
          MOVE      ALERT011,PTALEDAT   * End Date/Date Cleared (ccyymmdd)
          MOVE      ALERT012,PTALRQBY   * Requested By (HCP Code)
          MOVE      SP70,PTALSPAR       * Spare Variable
.
SAVALT99  RETURN
.------------------------------------------------------------
. * Checks mandatory fields
.------------------------------------------------------------
CHKALT00  RESET     ALERT002
          MATCH     SP70,ALERT002
          GOTO      CHKALT90 IF EQUAL
.
          RESET     ALERT003
          MATCH     SP70,ALERT003
          GOTO      CHKALT91 IF EQUAL
.
          GOTO      CHKALT98
.
CHKALT90  MOVE      "Code is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKALT99
.
CHKALT91  MOVE      "Alert Date is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKALT99
.
CHKALT98  MOVE      ZERO,EXIT
CHKALT99  RETURN
.---------------------------------------------------------------------
. Writes Patient Alerts Audit
.    Parameters :   KEY1 - Set Record Type
.---------------------------------------------------------------------
ALTAUD00  BRANCH    CAUDA1,ALTAUD99  * Check if audit needs to be written
.
          CALL      IBACLOCK
          PACK      PTALAUDD,CCC,CYY,CMM,CDD     * Date
          REP       " 0",PTALAUDD
          MOVE      CTIMEIS,PTALAUDT
          MOVE      PORT,PTALAUDP                * Port
          MOVE      KEY1,PTALAUDR                * Record Type
          MOVE      ONE,PTALAUDS                 * Not Printed
          MOVE      PASSCODE,PTALAUDO            * Operator
.
          PACK      KEY19,PTALAUDD,PTALAUDT,PTALAUDP,PTALAUDR
          CALL      AWPTALR1                     * Write Audit File
.
ALTAUD99  RETURN
.
.---------------------------------------------------------------------
. Writes Patient Alert Comments Audit
.    Parameters :   KEY1 - Set Record Type
.---------------------------------------------------------------------
ALCAUD00  BRANCH    CAUDA1,ALCAUD99  * Check if audit needs to be written
.
          MOVE      PTALAUDD,PMANAUDD            * Use date/time from the alert
          MOVE      PTALAUDT,PMANAUDT            * audit so we can link the 
.                                                * two audit files 
          MOVE      PORT,PMANAUDP                * Port
          MOVE      KEY1,PMANAUDR                * Record Type
          MOVE      ONE,PMANAUDS                 * Not Printed
          MOVE      PASSCODE,PMANAUDO            * Operator
.
          PACK      KEY19,PMANAUDD,PMANAUDT,PMANAUDP,PMANAUDR
          CALL      AWPMALN1                     * Write Audit File
.
ALCAUD99  RETURN
.
.---------------------------------------------------------------------
. Get the deleted alert details from the audit files
.---------------------------------------------------------------------
DAUD0000  PACK      KEY27,URNUMBER,DELETKEY,SP70      
          CALL      ASPTALR2                 
DAUD1000  CALL      AKPTALR2                 
          BRANCH    OVRCD,DAUD9000           
.
          MATCH     URNUMBER,PTALURNO        * For this patient ?
          GOTO      DAUD9000 IF NOT EQUAL    * no, read all alerts
.
          PACK      KEY16,PTALAUDD,PTALAUDT,SP70
          MATCH     KEY16,DELETKEY           * Deleted date/time
          GOTO      DAUD9000 IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR            * Only deleted 
          GOTO      DAUD1100 IF EQUAL
.
          MATCH     ANSB,PTALAUDR            * or before 
          GOTO      DAUD1000 IF NOT EQUAL
.
DAUD1100  MATCH     ALERT001,PTALCATG        * Correct Category
          GOTO      DAUD1000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE        * Correct Code
          GOTO      DAUD1000 IF NOT EQUAL
.        
          MATCH     ALERT013,PTALCNTR        * Correct Counter
          GOTO      DAUD1000 IF NOT EQUAL
.        
          GOTO      DAUD9999
.
DAUD9000  CALL      CLPATALR     
          UNPACK    SP70,PTALAUDD,PTALAUDT,PTALAUDP,PTALAUDR,PTALAUDO
          MOVE      ZERO,PTALAUDS
.
DAUD9999  RETURN
.
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20
          GOTO      PROFLD99
.
.      Patient Alert Details
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      PALT0000      * Patient Alert Details
          GOTO      PROFLD99   
.
.      Patient Clinical Pathways 
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD23  CALL      PMSC0000      * Patient Clinical Pathways
          GOTO      PROFLD99   
.
PROFLD99  RETURN
.-------------------------------------------------------------------------------
. Patient Clinical Alerts
.-------------------------------------------------------------------------------
PMSC0000  BRANCH    FLDITMNO,PMSC0100,PMSC0200,PMSC0300,PMSC0400,PMSC0500: 
                             PMSC0600,PMSC0700,PMSC0800,PMSC0900,PMSC1000: *10
                             PMSC1100,PMSC1200,PMSC1300,PMSC1400,PMSC1500: 
                             PMSC1600,PMSC1700,PMSC1800,PMSC1900,PMSC2000: *20
                             PMSC2100,PMSC2200,PMSC2300,PMSC2400,PMSC2500:
                             PMSC2600,PMSC2700,PMSC2800,PMSC2900,PMSC3000: *30
                             PMSC3100,PMSC3200,PMSC3300,PMSC3400,PMSC3500:
                             PMSC3600,PMSC3700,PMSC3800,PMSC3900,PMSC4000: *40
                             PMSC4100,PMSC4200,PMSC4300,PMSC4400,PMSC4500:
                             PMSC4600,PMSC4700,PMSC4800,PMSC4900,PMSC5000: *50
                             PMSC5100,PMSC5200,PMSC5300,PMSC5400,PMSC5500:
                             PMSC5600,PMSC5700,PMSC5800,PMSC5900,PMSC6000: *60
                             PMSC6100,PMSC6200,PMSC6300,PMSC6400,PMSC6500:
                             PMSC6600,PMSC6700,PMSC6800,PMSC6900,PMSC7000: *70
                             PMSC7100,PMSC7200
          GOTO      PMSC9999
.
PMSC0100  WRITE     HTMLFILE;PMCPADMN;  * Admission No 
          GOTO      PMSC9999
.
PMSC0200  MOVE      "PW",CATEGORY       * Clinical Pathway (Cat PW)     
          MOVE      PMCPCLPT,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC0300  WRITE     HTMLFILE;PMCPUNIQ;  * Unique No
          GOTO      PMSC9999
.
PMSC0400  UNPACK    DIM127,DIM1,KEY1,DIM127      * Diagnosis Code 1
          MOVE      KEY1,F1
.
          MATCH     SP70,PMCPDIG1
          GOTO      PMSC9999 IF EQUAL
.
          PACK      KEY9,PMCPDIG1,SP70
          CALL      RDPTICD1 
          IF        OVRCD=1 | ICDRDVER=1
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      PMSC9999
          ENDIF

          BRANCH    F1,PMSC0410
.
          WRITE     HTMLFILE;DDESC;            
          GOTO      PMSC9999
.
PMSC0410  WRITE     HTMLFILE;PMCPDIG1;
          GOTO      PMSC9999
.
PMSC0500  MATCH     SP70,PMCPDDT1       * Diagnosis 1 Date            
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPDDT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC0600  MATCH     SP70,PMCPDTM1       * Diagnosis 1 Time
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPDTM1;
          GOTO      PMSC9999
.
PMSC0700  MOVE      "PF",CATEGORY       * Diagnosis 1 Outcome 1 (Cat PF)
          MOVE      PMCPD1O1,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC0800  MOVE      "PF",CATEGORY   * Diagnosis 1 Outcome 2 (Cat PF)
          MOVE      PMCPD1O2,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC0900  MOVE      "PF",CATEGORY   * Diagnosis 1 Outcome 3 (Cat PF)
          MOVE      PMCPD1O3,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC1000  MOVE      "PF",CATEGORY   * Diagnosis 1 Outcome 4 (Cat PF)
          MOVE      PMCPD1O4,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC1100  MATCH     SP70,PMCPD1D1       * Diagnosis 1 Outcome Date 1           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD1D1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC1200  MATCH     SP70,PMCPD1T1       * Diagnosis 1 Outcome Time 1
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD1T1;
          GOTO      PMSC9999
.
PMSC1300  MATCH     SP70,PMCPD1D2       * Diagnosis 1 Outcome Date 2           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD1D2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC1400  MATCH     SP70,PMCPD1T2       * Diagnosis 1 Outcome Time 2
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD1T2;
          GOTO      PMSC9999
.
PMSC1500  MATCH     SP70,PMCPD1D3       * Diagnosis 1 Outcome Date 3           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD1D3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC1600  MATCH     SP70,PMCPD1T3       * Diagnosis 1 Outcome Time 3
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD1T3;
          GOTO      PMSC9999
.
PMSC1700  MATCH     SP70,PMCPD1D4       * Diagnosis 1 Outcome Date 4           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD1D4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC1800  MATCH     SP70,PMCPD1T4       * Diagnosis 1 Outcome Time 4
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD1T4;
          GOTO      PMSC9999
.
.
PMSC1900  UNPACK    DIM127,DIM1,KEY1,DIM127      * Diagnosis Code 2
          MOVE      KEY1,F1
.
          MATCH     SP70,PMCPDIG2
          GOTO      PMSC9999 IF EQUAL
.
          PACK      KEY9,PMCPDIG2,SP70
          CALL      RDPTICD1 
          IF        OVRCD=1 | ICDRDVER=1
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      PMSC9999
          ENDIF

          BRANCH    F1,PMSC1910
.
          WRITE     HTMLFILE;DDESC;            
          GOTO      PMSC9999
.
PMSC1910  WRITE     HTMLFILE;PMCPDIG2;
          GOTO      PMSC9999
.
PMSC2000  MATCH     SP70,PMCPDDT2       * Diagnosis 2 Date            
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPDDT2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC2100  MATCH     SP70,PMCPDTM2       * Diagnosis 2 Time
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPDTM2;
          GOTO      PMSC9999
.
PMSC2200  MOVE      "PF",CATEGORY   * Diagnosis 2 Outcome 1 (Cat PF)
          MOVE      PMCPD2O1,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC2300  MOVE      "PF",CATEGORY   * Diagnosis 2 Outcome 2 (Cat PF)
          MOVE      PMCPD2O2,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC2400  MOVE      "PF",CATEGORY   * Diagnosis 2 Outcome 3 (Cat PF)
          MOVE      PMCPD2O3,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC2500  MOVE      "PF",CATEGORY   * Diagnosis 2 Outcome 4 (Cat PF)
          MOVE      PMCPD2O4,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC2600  MATCH     SP70,PMCPD2D1       * Diagnosis 2 Outcome Date 1           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD2D1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC2700  MATCH     SP70,PMCPD2T1       * Diagnosis 2 Outcome Time 1
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD2T1;
          GOTO      PMSC9999
.
PMSC2800  MATCH     SP70,PMCPD2D2       * Diagnosis 2 Outcome Date 2           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD2D2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC2900  MATCH     SP70,PMCPD2T2       * Diagnosis 2 Outcome Time 2
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD2T2;
          GOTO      PMSC9999
.
PMSC3000  MATCH     SP70,PMCPD2D3       * Diagnosis 2 Outcome Date 3           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD2D3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC3100  MATCH     SP70,PMCPD2T3       * Diagnosis 2 Outcome Time 3
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD2T3;
          GOTO      PMSC9999
.
PMSC3200  MATCH     SP70,PMCPD2D4       * Diagnosis 2 Outcome Date 4           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD2D4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC3300  MATCH     SP70,PMCPD2T4       * Diagnosis 2 Outcome Time 4
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD2T4;
          GOTO      PMSC9999
.
.
PMSC3400  UNPACK    DIM127,DIM1,KEY1,DIM127      * Diagnosis Code 3
          MOVE      KEY1,F1
.
          MATCH     SP70,PMCPDIG3
          GOTO      PMSC9999 IF EQUAL
.
          PACK      KEY9,PMCPDIG3,SP70
          CALL      RDPTICD1 
          IF        OVRCD=1 | ICDRDVER=1
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      PMSC9999
          ENDIF

          BRANCH    F1,PMSC3410
.
          WRITE     HTMLFILE;DDESC;            
          GOTO      PMSC9999
.
PMSC3410  WRITE     HTMLFILE;PMCPDIG3;
          GOTO      PMSC9999
.
PMSC3500  MATCH     SP70,PMCPDDT3       * Diagnosis 3 Date            
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPDDT3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC3600  MATCH     SP70,PMCPDTM3       * Diagnosis 3 Time
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPDTM3;
          GOTO      PMSC9999
.
PMSC3700  MOVE      "PF",CATEGORY   * Diagnosis 3 Outcome 1 (Cat PF)
          MOVE      PMCPD3O1,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC3800  MOVE      "PF",CATEGORY   * Diagnosis 3 Outcome 2 (Cat PF)
          MOVE      PMCPD3O2,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC3900  MOVE      "PF",CATEGORY   * Diagnosis 3 Outcome 3 (Cat PF)
          MOVE      PMCPD3O3,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC4000  MOVE      "PF",CATEGORY   * Diagnosis 3 Outcome 4 (Cat PF)
          MOVE      PMCPD3O4,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC4100  MATCH     SP70,PMCPD3D1       * Diagnosis 3 Outcome Date 1           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD3D1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC4200  MATCH     SP70,PMCPD3T1       * Diagnosis 3 Outcome Time 1
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD3T1;
          GOTO      PMSC9999
.
PMSC4300  MATCH     SP70,PMCPD3D2       * Diagnosis 3 Outcome Date 2           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD3D2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC4400  MATCH     SP70,PMCPD3T2       * Diagnosis 3 Outcome Time 2
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD3T2;
          GOTO      PMSC9999
.
PMSC4500  MATCH     SP70,PMCPD3D3       * Diagnosis 3 Outcome Date 3           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD3D3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC4600  MATCH     SP70,PMCPD3T3       * Diagnosis 3 Outcome Time 3
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD3T3;
          GOTO      PMSC9999
.
PMSC4700  MATCH     SP70,PMCPD3D4       * Diagnosis 3 Outcome Date 4           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD3D4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC4800  MATCH     SP70,PMCPD3T4       * Diagnosis 3 Outcome Time 4
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD3T4;
          GOTO      PMSC9999
.
.
PMSC4900  UNPACK    DIM127,DIM1,KEY1,DIM127      * Diagnosis Code 4
          MOVE      KEY1,F1
.
          MATCH     SP70,PMCPDIG4
          GOTO      PMSC9999 IF EQUAL
.
          PACK      KEY9,PMCPDIG4,SP70
          CALL      RDPTICD1 
          IF        OVRCD=1 | ICDRDVER=1
            WRITE     HTMLFILE;"Invalid Diagnosis Code";
            GOTO      PMSC9999
          ENDIF

          BRANCH    F1,PMSC4910
.
          WRITE     HTMLFILE;DDESC;            
          GOTO      PMSC9999
.
PMSC4910  WRITE     HTMLFILE;PMCPDIG4;
          GOTO      PMSC9999
.
PMSC5000  MATCH     SP70,PMCPDDT4       * Diagnosis 4 Date            
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPDDT4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC5100  MATCH     SP70,PMCPDTM4       * Diagnosis 4 Time
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPDTM4;
          GOTO      PMSC9999
.
PMSC5200  MOVE      "PF",CATEGORY   * Diagnosis 4 Outcome 1 (Cat PF)
          MOVE      PMCPD4O1,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC5300  MOVE      "PF",CATEGORY   * Diagnosis 4 Outcome 2 (Cat PF)
          MOVE      PMCPD4O2,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC5400  MOVE      "PF",CATEGORY   * Diagnosis 4 Outcome 3 (Cat PF)
          MOVE      PMCPD4O3,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC5500  MOVE      "PF",CATEGORY   * Diagnosis 4 Outcome 4 (Cat PF)
          MOVE      PMCPD4O4,CODE       
          CALL      CODITM00
          GOTO      PMSC9999
.
PMSC5600  MATCH     SP70,PMCPD4D1       * Diagnosis 4 Outcome Date 1           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD4D1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC5700  MATCH     SP70,PMCPD4T1       * Diagnosis 4 Outcome Time 1
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD4T1;
          GOTO      PMSC9999
.
PMSC5800  MATCH     SP70,PMCPD4D2       * Diagnosis 4 Outcome Date 2           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD4D2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC5900  MATCH     SP70,PMCPD4T2       * Diagnosis 4 Outcome Time 2
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD4T2;
          GOTO      PMSC9999
.
PMSC6000  MATCH     SP70,PMCPD4D3       * Diagnosis 4 Outcome Date 3           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD4D3,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC6100  MATCH     SP70,PMCPD4T3       * Diagnosis 4 Outcome Time 3
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD4T3;
          GOTO      PMSC9999
.
PMSC6200  MATCH     SP70,PMCPD4D4       * Diagnosis 4 Outcome Date 4           
          GOTO      PMSC9999 IF EQUAL
          UNPACK    PMCPD4D4,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC6300  MATCH     SP70,PMCPD4T4       * Diagnosis 4 Outcome Time 4
          GOTO      PMSC9999 IF EQUAL
          WRITE     HTMLFILE;PMCPD4T4;
          GOTO      PMSC9999
.
PMSC6400  WRITE     HTMLFILE;PMCPACTV;  * Active Indicator 1=Actice 0=Not 
          GOTO      PMSC9999
.
PMSC6500  UNPACK    PMCPDTCR,CCENT,CYEAR,CMON,CDAY   * Create Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC6600  WRITE     HTMLFILE;PMCPTMCR;  * Time Record Created             
          GOTO      PMSC9999
.
PMSC6700  WRITE     HTMLFILE;PMCPWBCR;  * Web Userid Created             
          GOTO      PMSC9999
.
PMSC6800  UNPACK    PMCPDTUP,CCENT,CYEAR,CMON,CDAY   * Updated Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PMSC9999
.
PMSC6900  WRITE     HTMLFILE;PMCPTMUP;  * Time Record Updated             
          GOTO      PMSC9999
.
PMSC7000  WRITE     HTMLFILE;PMCPWBUP;  * Web Userid Updated             
          GOTO      PMSC9999
.
PMSC7100  CALL      CLPTB000            * Table of Patient Clinical Pathways
          GOTO      PMSC9999
.
PMSC7200  CALL      CHKACT00            * Output Addflag                    
          WRITE     HTMLFILE;EXIT;
          GOTO      PMSC9999
.
PMSC9999  RETURN
.------------------------------------------------------------
. Table of Patient Clinical Pathways
.------------------------------------------------------------
CLPTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMCLP1
CLPTB100  CALL      RKPMCLP1
          BRANCH    OVRCD,CLPTB999
.
          MATCH     ADMISSNO,PMCPADMN        * Admission No
          GOTO      CLPTB999 IF NOT EQUAL
.
          PACK      PACKLINK,PMCPADMN,SQUOTE,COMMA,SQUOTE,PMCPCLPT,SQUOTE:
                             COMMA,SQUOTE,PMCPUNIQ,SQUOTE,COMMA,SQUOTE:
                             PMCPACTV
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowDetail('",HTMLLINK
          APPEND    PACKLINK,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "PW",CATEGORY        * Clinical Pathway
          MOVE      PMCPCLPT,CODE
          CALL      GETCOD00
.
          PACK      KEY9,PMCPDIG1,SP70   * Diagnosis 1
          CALL      RDPTICD1
          IF        OVRCD=1 | ICDRDVER=1
            MOVE      "Invalid Diagnosis Code",DDESC
          ENDIF

          UNPACK    PMCPDDT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      PMCPACTV,F1      * 1 = Active
          BRANCH    F1,CLPTB200
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                     "#"<strike>",TDESC,"</strike>#",":    * Clinical Pathway
                     "#"<strike>",DDESC,"</strike>#",":    * Diagnosis 1 Desc
                     "#"<strike>",KEY11,"</strike>#");"    * Diagnosis 1 Date
.
          GOTO      CLPTB100 
.
CLPTB200  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",TDESC,"#",":        * Clinical Pathway
                             "#"",DDESC,"#",":        * Diagnosis 1 Desc
                             "#"",KEY11,"#");"        * Diagnosis 1 Date
.
          GOTO      CLPTB100 
.
CLPTB999  RETURN
.-------------------------------------------------------------------------------
. Patient Alerts
.-------------------------------------------------------------------------------
PALT0000  BRANCH    FLDITMNO,PALT0100,PALT0200,PALT0300,PALT0400,PALT0500:
                             PALT0600,PALT0700,PALT0800,PALT0900,PALT1000:
                             PALT1100,PALT1200,PALT1400,PALT1500,PALT1600:
                             PALT1700,PALT1800,PALT1900,PALT1950,PALT2000:
                             PALT2100,PALT2200,PALT2300,PALT2400,PALT2500:
                             PALT2600,PALT2700,PALT2800,PALT2900,PALT3000:
                             PALT3100,PALT3200,PALT3300,PALT3400,PALT3500:
                             PALT3600,PALT3700,PALT3800,PALT3900,PALT4000:
                             PALT4100,PALT4200,PALT4300,PALT4400,PALT4500:
                             PALT4600,PALT4700
          GOTO      PALT9999
.
PALT0100  MOVE      ALERT001,CATEGORY     * ALERT001 passed in from server
          MOVE      PTALCODE,CODE         * PATWEB98...
          CALL      CODITM00
          GOTO      PALT9999
.
PALT0200  MATCH     "01",PTALDATE
          GOTO      PALT9999 IF EQUAL
          MATCH     SP70,PTALDATE
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY  * ALert Date
          MATCH     SP70,CMON
          GOTO      PALT9999 IF EQUAL
          MATCH     SP70,CDAY
          GOTO      PALT9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT0300  WRITE     HTMLFILE;PTALLIFE;    * Life Threatening Alert?  
          GOTO      PALT9999
.
PALT0400  MOVE      "wn",CATEGORY         * Reaction Code 
          MOVE      PTALREAC,CODE 
          CALL      CODITM00 
          GOTO      PALT9999
.
PALT0500  WRITE     HTMLFILE;PTALLSEV;    * Severity Level (0-9)
          GOTO      PALT9999
.
PALT0600  MATCH     SP70,PTALRCOM
          GOTO      PALT9999 IF EQUAL
          WRITE     HTMLFILE;PTALRCOM;    * Reaction Comment  
          GOTO      PALT9999
.
PALT0700  WRITE     HTMLFILE;ALERT001;    * Codes File Category 
          GOTO      PALT9999
.
PALT0800  PACK      KEY5,PTALCATG,SP3     * Key is category
          CALL      RDCODE1               * Read patient codes file
          WRITE     HTMLFILE;TDESC;       * Category Desc for Update Screen!  
          GOTO      PALT9999
.
PALT0900  MATCH     SP70,PTALCDTE
          GOTO      PALT9999 IF EQUAL
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;PTALCDTE;    * Creation Date  
          ELSE
            UNPACK    PTALCDTE,CCENT,CYEAR,CMON,CDAY  * Createtion Date
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT1000  MATCH     SP70,PTALUSID
          GOTO      PALT9999 IF EQUAL
          WRITE     HTMLFILE;PTALUSID;    * User ID  
          GOTO      PALT9999
.
PALT1100  MATCH     PTALURNO,ADMISSNO     * Use Admisson based comments
          GOTO      PALT1300 IF EQUAL  
.
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1              * alert comments
PALT1110  CALL      RKPMALN1
          BRANCH    OVRCD,PALT9999
          MATCH     PURNO,PMANURNO
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      PALT9999 IF NOT EQUAL
          WRITE     HTMLFILE;*+,PMANCOMM;
          GOTO      PALT1110
.
PALT1200  MATCH     "01",PTALRDTE
          GOTO      PALT9999 IF EQUAL
          MATCH     "00",PTALRDTE
          GOTO      PALT9999 IF EQUAL
          MATCH     SP70,PTALRDTE
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALRDTE,CCENT,CYEAR,CMON,CDAY  * ALert Date
          MATCH     SP70,CMON
          GOTO      PALT9999 IF EQUAL
          MATCH     SP70,CDAY
          GOTO      PALT9999 IF EQUAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT1300  PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALA1              * alert comments
PALT1310  CALL      RKPMALA1
          BRANCH    OVRCD,PALT9999
          MATCH     ADMISSNO,PMANURNO
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      PALT9999 IF NOT EQUAL
          WRITE     HTMLFILE;*+,PMANCOMM;
          GOTO      PALT1310
.                                         * I SRF 22514
PALT1400  MOVE      ALERT001,CATEGORY     * ALERT001 passed in from server
          MOVE      PTALCODE,CODE         * PATWEB98...
          CALL      ALTSEL00
          GOTO      PALT9999              * end I SRF 22514
.
PALT1500  PACK      KEY25,PTALURNO,PTALCATG,PTALCODE,SP70     
          CALL      RSOBPC6
PALT1510  CALL      RKOBPC6
          BRANCH    OVRCD,PALT1550
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      PALT1550 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      PALT1550 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      PALT1550 IF NOT EQUAL
.
          MATCH     OBPCCNTR,PTALCNTR
          GOTO      PALT1510 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;           * Clinical document available
          GOTO      PALT9999                  
.
PALT1550  WRITE     HTMLFILE;ZERO;          * No clinical documents
          GOTO      PALT9999
.
PALT1600  PACK      KEY25,PTALURNO,PTALCATG,PTALCODE,SP70
          CALL      RSOBPC6
PALT1610  CALL      RKOBPC6
          BRANCH    OVRCD,PALT9999
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      PALT9999 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      PALT9999 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      PALT9999 IF NOT EQUAL
.
          MATCH     OBPCCNTR,PTALCNTR
          GOTO      PALT1610 IF NOT EQUAL
.
          PACK      KEY4,OBPCSLID
          CALL      RDOBPT1
          BRANCH    OVRCD,PALT9999
.
          STRIP     OBPTURLP
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CMDLINE,OBPTURLP,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CMDLINE,OBPTURLP,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CMDLINE
          REP       " 0",CMDLINE
.
          CALL      CHKSEC00
          BRANCH    EXIT,PALT9999
.
          MOVELPTR  CMDLINE,LENGTH
          SFORMAT   OUTVAR,LENGTH
          MOVE      CMDLINE,OUTVAR
.
          UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr><td class=DataLabel>":
                             "Linked Clinical Document</td><td>":
                             "<a href=#"",OUTVAR,"#" target=_blank>":
                             "<img border=0 src=../images/ClinicalNote.gif":
                             " align=absmiddle hspace=1 ></a>",DISPDATE:
                             "</td></tr>"
          GOTO      PALT9999
.
PALT1700  CALL      ACOM0000                * Display deleted alert comments
          GOTO      PALT9999
.
PALT1800  PACK      KEY14,PTALAUDO,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,PALT9999
.
          MATCH     WBSEPCD,PTALAUDO
          GOTO      PALT9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;WBSENAM; 
          GOTO      PALT9999
.
PALT1900  MATCH     PTALAUDD,SP70
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALAUDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," at ",PTALAUDT;
          GOTO      PALT9999
.
PALT1950  WRITE     HTMLFILE;ADMALERT;
          GOTO      PALT9999
.
PALT2000  WRITE     HTMLFILE;PTALICDC;           * ICD10 Code
          GOTO      PALT9999
.
PALT2100  MATCH     PTALDTIN,SP70                * Date Inactive (ccyymmdd)
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALDTIN,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT2200  MATCH     PTALEDAT,SP70                * End Date/Date Clrd (ccyymmdd)
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT2300  WRITE     HTMLFILE;PTALRQBY;           * Requested By (HCP Code)
          GOTO      PALT9999
.
PALT2400  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
          MOVE      PTALHOSP,KEY3
          CALL      RDPTHSP1         
          BRANCH    OVRCD,PALT9999
.
          BRANCH    F1,PALT2410
          WRITE     HTMLFILE;PTHSNAME;           * Initiating Hospital desc
          GOTO      PALT9999
.
PALT2410  WRITE     HTMLFILE;PTHSHOSP;           * Initiating Hospital code
          GOTO      PALT9999
.
PALT2500  CALL      GETSEV00                     * severity level list
          GOTO      PALT9999
.
PALT2600  MATCH     SP70,PTALUUID
          GOTO      PALT9999 IF EQUAL
.
          MATCH     "AutoEndPgm",PTALUUID
          IF        @EQUAL
             WRITE     HTMLFILE;"AutoEndPgm";       
             GOTO      PALT9999 
          ENDIF
.
          PACK      KEY10,PTALUUID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PALT9999
          WRITE     HTMLFILE;WBSENAM;            * User ID Updated
          GOTO      PALT9999
.
PALT2700  MATCH     PTALUDAT,SP70                * Date Record Updated
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALUDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT2800  MATCH     SP70,PTALUSID
          GOTO      PALT9999 IF EQUAL
          PACK      KEY10,PTALUSID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PALT9999
          WRITE     HTMLFILE;WBSENAM;            * User ID Created
          GOTO      PALT9999
.
PALT2900  MATCH     PTALCDTE,SP70                * Date Record Created
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT3000  MOVE      PTALRQBY,KEY10
          CALL      RDPMHCP1
          BRANCH    OVRCD,PALT9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;           * Athorising Clinician name
          GOTO      PALT9999
.
PALT3100  MATCH     WBSEHOSP,PTALHOSP       * Only initiating Hosp can delete
          GOTO      PALT3150 IF NOT EQUAL
.
.         check if category based alert security is being used
.
          MOVE      SP1,ALERTSEC
          UNPACK    PTALCATG,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
          LOAD      ALERTSEC,AFRM1,WBSEAH1L,WBSEAH2L,WBSEAH3L,WBSEAH4L,WBSEAH5L:
                                   WBSEAH6L,WBSEAH7L,WBSEAH8L,WBSEAH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEADSL,ALERTSEC   * if not, default to standard security
          ENDIF
.
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PALT9999
.
          MATCH     ALERTSEC,TCINDC2
          GOTO      PALT9999 IF EQUAL
          GOTO      PALT9999 IF LESS
.
PALT3150  WRITE     HTMLFILE;ONE;      * 1 = don't display delete button
          GOTO      PALT9999
.
PALT3200  WRITE     HTMLFILE;PTALCNTR;      * Counter
          GOTO      PALT9999
.
PALT3300  MOVE      ZERO,FAEXISTS
          PACK      KEY16,URNUMBER,CATH3,SP70
          CALL      RSPTALR1
PALT3301  CALL      RKPTALR1
          BRANCH    OVRCD,PALT3399
.
          MATCH     URNUMBER,PTALURNO
          GOTO      PALT3399 IF NOT EQUAL
.
          MATCH     CATH3,PTALCATG
          GOTO      PALT3399 IF NOT EQUAL
.
          MOVE      ONE,FAEXISTS
.
          PACK      KEY5,CATH3,PTALCODE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            WRITE     HTMLFILE;"<tr><td align=center>Unknown Code: ",PTALCODE,"</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td align=center>",TDESC,"</td></tr>"
          ENDIF
.
          GOTO      PALT3301
.
PALT3399  WRITE     HTMLFILE;"<input type=hidden id=faexists value=",FAEXISTS,">"
          GOTO      PALT9999
.
PALT3400  WRITE     HTMLFILE;WBSEAH1L,WBSEAH2L,WBSEAH3L,WBSEAH4L,WBSEAH5L:
                             WBSEAH6L,WBSEAH7L,WBSEAH8L,WBSEAH9L;
          GOTO      PALT9999
.
PALT3500  UNPACK    DIM127,D1,KEY1,DIM127        * Care Pathway Activated
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PALT3510
.
          WRITE     HTMLFILE;PTALCPAC;           * .0
          GOTO      PALT9999
.
PALT3510  MATCH     "1",PTALCPAC                 * .1
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ENDIF
          MATCH     "0",PTALCPAC
          IF        @EQUAL
            WRITE     HTMLFILE;"No";
          ENDIF
          MATCH     " ",PTALCPAC
          IF        @EQUAL
            WRITE     HTMLFILE;"Unknown";
          ENDIF
          GOTO      PALT9999
.
PALT3600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PALT3610
.
          WRITE     HTMLFILE;PTALUCPF;          * User ID Updated Care Pathway
          GOTO      PALT9999
.
PALT3610  PACK      KEY10,PTALUCPF,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PALT9999
          WRITE     HTMLFILE;WBSENAM;           * User Name Updated Care Pathway
          GOTO      PALT9999
.
PALT3700  MATCH     PTALDCPU,SP70               * Date Care Pathway Updated
          GOTO      PALT9999 IF EQUAL
          UNPACK    PTALDCPU,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;KEY11;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PALT9999
.
PALT3800  MOVE      ALERT001,CATEGORY     * ALERT001 passed in from server
          MOVE      PTALCODE,CODE         * PATWEB98...
          CALL      ALTSLL00              * Alert Code selection (long desc)
          GOTO      PALT9999
.
PALT3900  UNPACK    DIM127,D1,KEY1,DIM127
          MATCH     PTALURNO,ADMISSNO     * Use Admisson based comments
          GOTO      PALT3950 IF EQUAL
.
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1              * alert comments
PALT3910  CALL      RKPMALN1
          BRANCH    OVRCD,PALT9999
          MATCH     PURNO,PMANURNO
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     SP70,PMANCOMM
          GOTO      PALT3910 IF EQUAL
          GOTO      PALT3960
.
PALT3950  PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALA1              * alert comments
PALT3955  CALL      RKPMALA1
          BRANCH    OVRCD,PALT9999
          MATCH     ADMISSNO,PMANURNO
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      PALT9999 IF NOT EQUAL
          MATCH     SP70,PMANCOMM
          GOTO      PALT3955 IF EQUAL
          GOTO      PALT3960
.
PALT3960  MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PALT3970
.
          WRITE     HTMLFILE;PMANUSID;           * User ID Updated Comments
          GOTO      PALT9999
.
PALT3970  PACK      KEY10,PMANUSID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PALT9999
          WRITE     HTMLFILE;WBSENAM;            * User Name Updated Comments
          GOTO      PALT9999
.
PALT4000  
          MOVE      SP70,DOCFNAME
          MOVE      PTALRQBY,KEY10
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY5,PTALCATG,SP3        * Key is category
          CALL      RDCODE1                  * Read patient codes file
          MOVE      TDESC,ALRTCATD
.
          MOVE      SP70,ALRTREAD
          MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
          ENDIF

          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          REP       " -",KEY16
          CALL      RESALL00
.          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
.          REP       " -",KEY16
.          WRITE     HTMLFILE;KEY16;            * FHIR ID
          GOTO      PALT9999
.
PALT4100
          MOVE      SP70,DOCFNAME
          MOVE      PTALRQBY,KEY10
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY5,PTALCATG,SP3        * Key is category
          CALL      RDCODE1                  * Read patient codes file
          MOVE      TDESC,ALRTCATD
.
          MOVE      SP70,ALRTREAD
          MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
          ENDIF
.
          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          REP       " -",KEY16
.
          IF        FHIRBUND=0
            CALL      RESFLG00
          ELSE
.
            WRITE     HTMLFILE;*+," {":
                                  " #"fullUrl#": #"%BASEURL/Flag/",KEY16,"#",":
                                  " #"resource#": ";
            CALL      RESFLG00
            WRITE     HTMLFILE;*+," }";
.
            IF        FHRSUBIN=1
              WRITE     HTMLFILE;*+,",{":
                                    " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
              CALL      RESPAT00
              WRITE     HTMLFILE;*+," }";
            ENDIF
.
            IF        FHRLOCIN=1
.
              MATCH     SP70,PTALHOSP
              IF        !@EQUAL & !@EOS
.
                PACK      KEY3,PTALHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
.
                  CLEAR     KEY16
                  APPEND    "Hospital-",KEY16
                  APPEND    PTHSHOSP,KEY16
                  APPEND    SP70,KEY16
                  RESET     KEY16
                  STRIP     KEY16
                  STRIP     WBTPFIL  *  Template
.
                  WRITE     HTMLFILE;*+,",{":
                                        " #"fullUrl#": #"%BASEURL/Location/",KEY16,"#",":
                                        " #"resource#": ";
                  CALL      RESLOC00
                  WRITE     HTMLFILE;*+," }";
.
                ENDIF 
.
              ENDIF
.
            ENDIF
.
            IF        FHRPARIN=1
.
              MATCH     SP70,PTALUSID
              IF        !@EQUAL
.
                PACK      KEY10,PTALUSID,SP70
                CALL      RDWBSE1
                IF        OVRCD=0
.
                  WRITE     HTMLFILE;*+,",{":
                                        " #"fullUrl#": #"%BASEURL/Practitioner/User-",PTALUSID,"#",":
                                        " #"resource#": ";
                  CALL      RESPRA00
                  WRITE     HTMLFILE;*+," }";
.
                ENDIF 
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
.
.
.
.
.          MATCH     PTALEDAT,SP70                * End Date/Date Clrd (ccyymmdd)
.          GOTO      PALT9999 IF EQUAL
.          UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
.          WRITE     HTMLFILE;",#"end#" : #"",CCENT,CYEAR,"-",CMON,"-",CDAY,"#"";
          GOTO      PALT9999
.
PALT4200  MATCH     SP70,PTALRQBY
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,"   #"reporter#": {":
                      "#"reference#": #"Practitioner/HCP-",PTALRQBY,"#" },";
          ENDIF
          GOTO      PALT9999
.
PALT4300  MOVE      ZERO,F1
          PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RSPMALN1              * alert comments
PALT4310  CALL      RKPMALN1
          BRANCH    OVRCD,PALT4390
          MATCH     PURNO,PMANURNO
          GOTO      PALT4390 IF NOT EQUAL
          MATCH     PTALCATG,PMANACAT
          GOTO      PALT4390 IF NOT EQUAL
          MATCH     PTALCODE,PMANACOD
          GOTO      PALT4390 IF NOT EQUAL
          MATCH     PTALCNTR,PMANCNTR
          GOTO      PALT4390 IF NOT EQUAL
          IF        F1=0
            MOVE      ONE,F1
            WRITE     HTMLFILE;*+,",   #"note#": [ { #"text#" : #"";
          ENDIF
          WRITE     HTMLFILE;*+,PMANCOMM;
          GOTO      PALT4310
.
PALT4390  IF        F1=1
            WRITE     HTMLFILE;*+,"#"} ] ";
          ENDIF
          GOTO      PALT9999
.
PALT4400  MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      SP70,ALRTREAD
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
            STRIP     ALRTREAD
            WRITE     HTMLFILE;*+,", #"reaction#": [ { " :
                      "  #"manifestation#": [ {":
                      "    #"coding#": [ {":
                      "      #"system#": #"%BASEURL/ValueSet/Category-wn#",":
                      "      #"code#": #"",PTALREAC,"#",":
                      "      #"display#": #"",ALRTREAD,"#"":
                      "    } ]":
                      "  } ]":
                      "} ]";
          ENDIF
          GOTO      PALT9999
.
PALT4500  PACK      KEY5,ALERT001,SP3     * Key is category
          CALL      RDCODE1               * Read patient codes file
          BRANCH    OVRCD,PALT9999
.
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV
.
          WRITE     HTMLFILE;KEY40;         * category indicators
          GOTO      PALT9999
.
PALT4600  CALL      ALRITM00                * Multiple alerts
          GOTO      PALT9999
.
PALT4700  WRITE     HTMLFILE;WBSEADSL;
          GOTO      PALT9999
.      
PALT9999  RETURN
.---------------------------------------------------------------------------
. Security based on document type or document security level
.---------------------------------------------------------------------------
CHKSEC00  MOVE      ZERO,EXIT
          MOVE      ZERO,TCFORM6
          MOVE      CATwi,CATEGORY          * Get description
          MOVE      OBPCCTYP,CODE
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ZERO,TCFORM6
            MOVE      ZERO,TCINDC1
          ENDIF
          COMPARE   ZERO,TCFORM6
          GOTO      CHKSEC50 IF NOT EQUAL
          MOVE      ZERO,F2
          MOVE      OBPCSLEV,F2
          MOVE      F2,TCFORM6
          COMPARE   ZERO,TCFORM6
          GOTO      CHKSEC99 IF EQUAL
.
CHKSEC50  PACK      KEY18,WBSEUID,PRGID
          CALL      RDWBST1
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
          IF        WBSTLEV<TCFORM6
            GOTO      CHKSEC80
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      CHKSEC99
CHKSEC80  MATCH     "1",TCINDC1        * Don't Display in List if Indicator
          GOTO      CHKSEC90 IF EQUAL  * Set to 1
.
          CLEAR     CMDLINE
          APPEND    "javascript:alert('Security Level Inadequate');",CMDLINE
          APPEND    "self.close();",CMDLINE
          APPEND    SP70,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          MOVE      ZERO,EXIT
          GOTO      CHKSEC99
CHKSEC90  MOVE      ONE,EXIT
CHKSEC99  RETURN
.------------------------------------------------------------
. Get Alert Comments
.------------------------------------------------------------
GETCOM00  PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCOM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCOM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCOM90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
GETCOM99  RETURN
.------------------------------------------------------------
. Update Alert Comments                          
.------------------------------------------------------------
ALCMN000  PACK      KEY19,URNUMBER,ALERT001,ALERT002,ALERT013,SP70
          CALL      RSPMALN1
ALCMN100  CALL      RKPMALN1
          BRANCH    OVRCD,ALCMN500          * end of file
.
          MATCH     URNUMBER,PMANURNO       * same U/R Number?
          GOTO      ALCMN500 IF NOT EQUAL
.
          MATCH     ALERT001,PMANACAT          
          GOTO      ALCMN500 IF NOT EQUAL
.
          MATCH     ALERT002,PMANACOD          
          GOTO      ALCMN500 IF NOT EQUAL
.
          MATCH     ALERT013,PMANCNTR          
          GOTO      ALCMN500 IF NOT EQUAL
.
          MOVE      "B",KEY1          * Set Change Parameter for ALCAUD00
          CALL      ALCAUD00          * Write Audit File if Needed
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      DEPMALN1
          GOTO      ALCMN100
.
.         now write the new comments back
.
ALCMN500  MOVE      URNUMBER,PMANURNO          * set U/R Number
          MOVE      ALERT001,PMANACAT
          MOVE      ALERT002,PMANACOD
          MOVE      ALERT013,PMANCNTR
          MATCH     SP70,ALERT015
          IF        @EQUAL
            MOVE      USERID,PMANUSID
          ELSE
            MOVE      ALERT015,PMANUSID
          ENDIF
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,ALCMN999
.
ALCMN510  ADD       ONE,F3                  * add to line number
          MOVE      F3,PMANLNNO
          READ      COMFILAF,SEQ;PMANCOMM
.
          MATCH     SP70,PMANCOMM
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      ALCMN999
            ELSE
              GOTO      ALCMN510
            ENDIF
          ENDIF
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      RAPMALN1
          IF        OVRCD=1
            CALL      WRPMALN1
          ENDIF
          IF        F3>=LASTITEM
            GOTO      ALCMN999
          ENDIF
          MOVE      "A",KEY1          * Set Change Parameter for ALCAUD00
          CALL      ALCAUD00          * Write Audit File if Needed
.
          GOTO      ALCMN510
.
ALCMN999  RETURN
.------------------------------------------------------------
. Update Alert Comments Admisson number based                         
.------------------------------------------------------------
ALCMA000  PACK      KEY19,ADMISSNO,ALERT001,ALERT002,ALERT013,SP70
          CALL      RSPMALA1
ALCMA100  CALL      RKPMALA1
          BRANCH    OVRCD,ALCMA500          * end of file
.
          MATCH     ADMISSNO,PMANURNO       * same U/R Number?
          GOTO      ALCMA500 IF NOT EQUAL
.
          MATCH     ALERT001,PMANACAT          
          GOTO      ALCMA500 IF NOT EQUAL
.
          MATCH     ALERT002,PMANACOD          
          GOTO      ALCMA500 IF NOT EQUAL
.
          MATCH     ALERT013,PMANCNTR          
          GOTO      ALCMA500 IF NOT EQUAL
.
          MOVE      "B",KEY1          * Set Change Parameter for ALCAUD00
          CALL      ALCAUD00          * Write Audit File if Needed
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      DEPMALA1
          GOTO      ALCMA100
.
.         now write the new comments back
.
ALCMA500  MOVE      ADMISSNO,PMANURNO          * set U/R Number
          MOVE      ALERT001,PMANACAT
          MOVE      ALERT002,PMANACOD
          MOVE      ALERT013,PMANCNTR
          MATCH     SP70,ALERT015
          IF        @EQUAL
            MOVE      USERID,PMANUSID
          ELSE
            MOVE      ALERT015,PMANUSID
          ENDIF
          MOVE      ZERO,F3
.
ALCMA510  ADD       ONE,F3                  * add to line number
          MOVE      F3,PMANLNNO
          READ      COMFILAF,SEQ;PMANCOMM
.
          MATCH     SP70,PMANCOMM
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      ALCMA999
            ELSE
              GOTO      ALCMA510
            ENDIF
          ENDIF
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      WRPMALA1
          IF        F3>=LASTITEM
            GOTO      ALCMA999
          ENDIF
.
          MOVE      "A",KEY1          * Set Change Parameter for ALCAUD00
          CALL      ALCAUD00          * Write Audit File if Needed
.
          GOTO      ALCMA510
.
ALCMA999  RETURN
.------------------------------------------------------------
. Delete Alert Comments admissno based
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
DECMA000  MOVE      PTALCATG,PMANACAT
          MOVE      PTALCODE,PMANACOD
          PACK      KEY19,PTALURNO,PMANACAT,PMANACOD,PMANCNTR,SP3
          CALL      RSPMALA1
DECMA400  CALL      RKPMALA1
          BRANCH    OVRCD,DECMN999          * end of file
          MATCH     ADMISSNO,PMANURNO          * same U/R Number?
          GOTO      DECMA999 IF NOT EQUAL
.
          MATCH     PTALCATG,PMANACAT
          GOTO      DECMA999 IF NOT EQUAL
.
          MATCH     PTALCODE,PMANACOD
          GOTO      DECMA999 IF NOT EQUAL
.
          MATCH     PTALCNTR,PMANCNTR
          GOTO      DECMA999 IF NOT EQUAL
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO
          CALL      DEPMALA1
          GOTO      DECMA400
.
DECMA999  RETURN
.------------------------------------------------------------
. Delete Alert Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
DECMN000  MOVE      PTALCATG,PMANACAT
          MOVE      PTALCODE,PMANACOD
          MOVE      PTALCNTR,PMANCNTR
          PACK      KEY19,PTALURNO,PMANACAT,PMANACOD,PMANCNTR,SP3
          CALL      RSPMALN1
DECMN400  CALL      RKPMALN1
          BRANCH    OVRCD,DECMN999          * end of file
          MATCH     PURNO,PMANURNO          * same U/R Number?
          GOTO      DECMN999 IF NOT EQUAL
.
          MATCH     PTALCATG,PMANACAT
          GOTO      DECMN999 IF NOT EQUAL
.
          MATCH     PTALCODE,PMANACOD
          GOTO      DECMN999 IF NOT EQUAL
.
          MATCH     PTALCNTR,PMANCNTR
          GOTO      DECMN999 IF NOT EQUAL
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO
          CALL      DEPMALN1
.
          MOVE      "D",KEY1          * Set Delete Parameter for ALCAUD00
          CALL      ALCAUD00          * Write Audit File if Needed
.
          GOTO      DECMN400
.
DECMN999  RETURN
.------------------------------------------------------------
. Add Selection Options to Form (code value)
.------------------------------------------------------------
ALTSEL00  MOVE      SP70,TDESC                          * I SRF 22514
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
ALTSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,ALTSEL99
          MATCH     CATEGORY,TCODE
          GOTO      ALTSEL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      ALTSEL10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      ALTSEL10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,ALTSEL10
            ENDIF
          ENDIF
.
.         check if category based alert security is being used
.
          MOVE      SP1,ALERTSEC
          UNPACK    CATEGORY,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
          LOAD      ALERTSEC,AFRM1,WBSEAH1L,WBSEAH2L,WBSEAH3L,WBSEAH4L,WBSEAH5L:
                                   WBSEAH6L,WBSEAH7L,WBSEAH8L,WBSEAH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEADSL,ALERTSEC   * if not, default to standard security
          ENDIF
.
          MATCH     ALERTSEC,TCINDC2
          GOTO      ALTSEL15 IF EQUAL
          GOTO      ALTSEL15 IF LESS
          GOTO      ALTSEL10
.
ALTSEL15  PACK      KEY16,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,TCINDC12,THCSCOD
          PACK      KEY21,QUOTE,ACODE,KEY16,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY21," selected>":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY21,">",TDESC,"</option>"
          ENDIF
          GOTO      ALTSEL10
ALTSEL99  RETURN                                        * end I SRF 22514
.
.--------------------------------------------------------------
. Add Selection Options to Form (code value) - Long Description
.--------------------------------------------------------------
ALTSLL00  MOVE      SP70,PTCDLDES
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",PTCDLDES
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",PTCDLDES:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
ALTSLL10  CALL      RDKCODE2
          BRANCH    OVRCD,ALTSLL99
          MATCH     CATEGORY,TCODE
          GOTO      ALTSLL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      ALTSLL10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      ALTSLL10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,ALTSLL10
            ENDIF
          ENDIF
.
.         check if category based alert security is being used
.
          MOVE      SP1,ALERTSEC
          UNPACK    CATEGORY,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
          LOAD      ALERTSEC,AFRM1,WBSEAH1L,WBSEAH2L,WBSEAH3L,WBSEAH4L,WBSEAH5L:
                                   WBSEAH6L,WBSEAH7L,WBSEAH8L,WBSEAH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEADSL,ALERTSEC   * if not, default to standard security
          ENDIF
.
          MATCH     ALERTSEC,TCINDC2
          GOTO      ALTSLL15 IF EQUAL
          GOTO      ALTSLL15 IF LESS
          GOTO      ALTSLL10
.
ALTSLL15  PACK      KEY16,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,TCINDC12,THCSCOD
          PACK      KEY21,QUOTE,ACODE,KEY16,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY21," selected>":
                               PTCDLDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY21,">",PTCDLDES,"</option>"
          ENDIF
          GOTO      ALTSLL10
ALTSLL99  RETURN
.
.**************************************************************************
.*                               CHKALR00              Called by: PROC0000*
.*                                                                        *
.**************************************************************************
CHKALR00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKALR99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,CHKALR99
.
          MOVE      PTMXSIN1,SAVESIN1
          MOVE      PMPXSIN7,SAVESIN7
          MOVE      PMPXSIN8,SAVESIN8
          MOVE      PMPXSIN9,SAVESIN9
          MOVE      PMPXSN11,SAVESN11
          UNPACK    SP70,PTMXSIN1,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN11
.
          CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
CHKALR10  CALL      RKPTALR1
          BRANCH    OVRCD,CHKALR90
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CHKALR90 IF NOT EQUAL
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MATCH     PTALEDAT,CURRDATE            * future end date
            GOTO      CHKALR20 IF LESS
.
            GOTO      CHKALR10                     * show alert as inactive
          ENDIF
.
CHKALR20  PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKALR10
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN7               * wahealth medical alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN8               * wahealth micro alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSIN9               * wahealth risk alert
            GOTO      CHKALR10
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "1",PMPXSN11               * wahealth chronic alert
            GOTO      CHKALR10
          ENDIF
.
.         Standard alert functionality
.
          REP       "S2 1",TCINDC4
.
          MATCH     "2",TCINDC4        * check for security alert, if yes stop
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
            GOTO      CHKALR90
          ENDIF
.
          MATCH     PTMXSIN1,TCINDC4
          IF        @LESS
            PACK      PTMXSIN1,TCINDC4
          ENDIF
          MATCH     SP70,PTMXSIN1
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
          ENDIF
.
          GOTO      CHKALR10
.
CHKALR90  MATCH     PTMXSIN1,SAVESIN1
          IF        !@EQUAL
            CALL      UPMAST1
          ENDIF
.
          MATCH     PMPXSIN7,SAVESIN7
          IF        @EQUAL
            MATCH     PMPXSIN8,SAVESIN8
            IF        @EQUAL
              MATCH     PMPXSIN9,SAVESIN9
              IF        @EQUAL
                MATCH     PMPXSN11,SAVESN11
                IF        @EQUAL
                  GOTO      CHKALR99          * no wahealth indicators changed
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          CALL      UPPMPX21                * update for wahealth alerts (indc5)
.
CHKALR99  RETURN
+
.**************************************************************************
.*                               CHKATT00              Called by: PROC0000*
.*                                                                        *
.**************************************************************************
CHKATT00  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,CHKATT99
.
          MOVE      PTMXSIN1,SAVESIN1
          MOVE      SP70,PTMXSIN1
.
          CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSPTALT1
CHKATT10  CALL      RKPTALT1 
          BRANCH    OVRCD,CHKATT90
.
          MATCH     ADMISSNO,PTALURNO
          GOTO      CHKATT90 IF NOT EQUAL
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MATCH     PTALEDAT,CURRDATE            * future end date
            GOTO      CHKATT20 IF LESS
.
            GOTO      CHKATT10                     * show alert as inactive
          ENDIF
.
CHKATT20  PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKATT10
.
          MATCH     ANSR,TCINDC5
          IF        @EQUAL
            MOVE      "R",PTMXSIN1               * wahealth risk alert
            GOTO      CHKATT90                   * most important
          ENDIF
.
          MATCH     ANSM,TCINDC5
          IF        @EQUAL
            MOVE      "M",PTMXSIN1               * wahealth medical alert
            GOTO      CHKATT10                   * 2nd important
          ENDIF
.
          MATCH     ANSC,TCINDC5
          IF        @EQUAL
            MOVE      "C",PTMXSIN1               * wahealth chronic alert
            GOTO      CHKATT10                   * 3rd important
          ENDIF
.
          MATCH     ANSB,TCINDC5
          IF        @EQUAL
            MATCH     "M",PTMXSIN1
            IF        !@EQUAL
              MOVE      "B",PTMXSIN1             * wahealth micro alert
            ENDIF                                * least important
            GOTO      CHKATT10
          ENDIF
.
.         Standard alert functionality
.
          REP       "S2 1",TCINDC4
.
          MATCH     "2",TCINDC4        * check for security alert, if yes stop
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
            GOTO      CHKATT90
          ENDIF
.
          MATCH     PTMXSIN1,TCINDC4
          IF        @LESS
            PACK      PTMXSIN1,TCINDC4
          ENDIF
          MATCH     SP70,PTMXSIN1
          IF        @EQUAL
            PACK      PTMXSIN1,TCINDC4
          ENDIF
.
          GOTO      CHKATT10
.
CHKATT90  MATCH     PTMXSIN1,SAVESIN1
          IF        !@EQUAL
            CALL      UPPRAM1
          ENDIF
.
CHKATT99  RETURN
+
.------------------------------------------------------------
. Display comments from the deleted alerts audit file     
.------------------------------------------------------------
ACOM0000  PACK      KEY27,PTALURNO,PTALAUDD,PTALAUDT,SP70
          CALL      ASPMALN2
ACOM1000  CALL      AKPMALN2
          BRANCH    OVRCD,ACOM9999
.
          MATCH     PTALURNO,PMANURNO
          GOTO      ACOM9999 IF NOT EQUAL
.
          MATCH     PTALAUDD,PMANAUDD
          GOTO      ACOM9999 IF NOT EQUAL
.
          MATCH     PTALAUDT,PMANAUDT
          GOTO      ACOM9999 IF NOT EQUAL
.
          MATCH     ANSD,PMANAUDR 
          GOTO      ACOM1100 IF EQUAL
.         
          MATCH     ANSB,PMANAUDR 
          GOTO      ACOM1000 IF NOT EQUAL
.         
ACOM1100  MATCH     PTALCATG,PMANACAT
          GOTO      ACOM1000 IF NOT EQUAL
.
          MATCH     PTALCODE,PMANACOD
          GOTO      ACOM1000 IF NOT EQUAL
.
          MATCH     PTALCNTR,PMANCNTR
          GOTO      ACOM1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMANCOMM
          GOTO      ACOM1000
.
ACOM9999  RETURN
+
.------------------------------------------------------------
. Get Severity Level
.------------------------------------------------------------
GETSEV00  MOVE      ZERO,FORM1
          MOVE      ZERO,SEVLEVEL
          MOVE      PTALLSEV,SEVLEVEL
GETSEV10  PACK      KEY3,QUOTE,FORM1,QUOTE
          COMPARE   SEVLEVEL,FORM1
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY3," selected>":
                               FORM1,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY3,">":
                               FORM1,"</option>"
          ENDIF
          IF        FORM1>=9
            GOTO      GETSEV99
          ENDIF
          ADD       ONE,FORM1
          GOTO      GETSEV10
.
GETSEV99  RETURN
+
.------------------------------------------------------------
. Calculate the counter number for this U/R and alert type (patalrf)
.------------------------------------------------------------
CONC0000  MOVE      ZERO,F3                       * Set alert type counter
          READ      CONTROLF,TEN;*250,CAUDA1
.
          PACK      KEY16,URNUMBER,ALERT001,ALERT002,Z70
          CALL      RSPTALR1
          CALL      RPPTALR1
          BRANCH    OVRCD,CONC2000
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CONC2000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONC2000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONC2000 IF NOT EQUAL
.
          MOVE      PTALCNTR,F3
.
CONC2000  BRANCH    CAUDA1,CONC9000          * Check if using audit file
.
          PACK      KEY27,URNUMBER,Z70
          CALL      ASPTALR2
CONC3000  CALL      APPTALR2
          BRANCH    OVRCD,CONC9000
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CONC9000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONC3000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONC3000 IF NOT EQUAL
.
          MOVE      ZERO,F3A                    * Use audit file counter if
          MOVE      PTALCNTR,F3A                * higher
          IF        F3A>F3
            MOVE      F3A,F3
          ENDIF
          GOTO      CONC3000
.
CONC9000  ADD       ONE,F3
          MOVE      F3,ALERT013 
.
CONC9999  RETURN
+
.------------------------------------------------------------
. Calculate the counter number for this U/R and alert type (pataltaf)
.------------------------------------------------------------
CONB0000  MOVE      ZERO,F3                       * Set alert type counter
.
          PACK      KEY16,ADMISSNO,ALERT001,ALERT002,Z70
          CALL      RSPTALT1
          CALL      RPPTALT1
          BRANCH    OVRCD,CONB9000
.
          MATCH     ADMISSNO,PTALURNO
          GOTO      CONB9000 IF NOT EQUAL
.
          MATCH     ALERT001,PTALCATG
          GOTO      CONB9000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      CONB9000 IF NOT EQUAL
.
          MOVE      PTALCNTR,F3
.
CONB9000  ADD       ONE,F3
          MOVE      F3,ALERT013
.
CONB9999  RETURN
+
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
RESLOC00  STRIP     PTHSNAME
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Hospital-",KEY16
          APPEND    PTHSHOSP,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          MATCH     SP70,PTHSTELE
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",PTHSTELE,"#" }";
             MATCH    SP70,PTHSFAXN
             IF       @EQUAL
               WRITE    HTMLFILE;*+,"],";
             ELSE
               WRITE    HTMLFILE;*+,",";
             ENDIF
          ENDIF
          MATCH     SP70,PTHSFAXN
          IF        !@EQUAL
             MATCH     SP70,PTHSTELE
             IF        @EQUAL
               WRITE     HTMLFILE;*+," #"telecom#": [";
             ENDIF
             WRITE     HTMLFILE;*+,"{ #"system#": #"fax#",":
                       "  #"value#": #"",PTHSFAXN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"name#": #"",PTHSNAME,"#", ":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"si#",":
                    "   #"display#": #"Site#"  } ] }":
                    "  } ";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Recorder
.------------------------------------------------------------------------------
RESPRA00  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            MOVE      SP70,DIM20
            MOVE      "w0",CATEGORY
            PACK      KEY5,CATEGORY,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          MATCH     SP70,WBSEDOC
          IF        !@EQUAL
            PACK      KEY10,WBSEDOC,SP70
          ELSE
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      KEY10,WBSEGPCD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            MOVE      SP70,TDESC
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCSPC1
              IF        !@EQUAL
                MOVE      "DT",KEY2
                PACK      KEY5,KEY2,PMHCSPC1,SP70
                CALL      RDCODE1
                IF        OVRCD=1
                  MOVE      SP70,TDESC
                ENDIF
              ENDIF
            ENDIF
            STRIP     KEY10
          ENDIF
.
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"User-",PTALUSID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-role#"":
                        " ,#"valueString#":#"",DIM20,"#"}";
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{ #"url#": #"%BASEURL/extension/dxc-hc-hcp#"":
                                "  ,#"valueReference#" : #"Practitioner/HCP-",KEY10,"#"}";
          ENDIF
.
          MATCH     SP70,TDESC
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{#"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                                  ",#"valueString#" : #"",TDESC,"#"}";
          ENDIF
.
          WRITE     HTMLFILE;" ],":
                    " #"identifier#": {":
                    "   #"use#": #"official#",":
                    "   #"system#": #"%BASEURL#",":
                    "   #"value#": #"",WBSELOGN,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": [":
                    "{ #"use#": #"usual#",":
                    "  #"text#": #"",WBSENAM,"#",":
                    "  #"family#": #".#",":
                    "  #"given#": [#"",WBSENAM,"#"] ":
                    "} ]";
.
          MATCH     SP70,WBSEEMAI
          IF        !@EQUAL
             WRITE     HTMLFILE;*+,",";
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"email#",":
                       "  #"value#": #"",WBSEEMAI,"#" } ]";
          ENDIF
.
          WRITE     HTMLFILE;*+,"  } ";
.
RESPRA99  RETURN
+
.------------------------------------------------------------------------------
.
          INC       IBAWEBCD
.
          INC       APSMASIO/INC
          INC       EMRUNKIO/INC            * Unknowns Patient File IO
          INC       PATALRIO/INC            * Patient Alerts Code File IO
          INC       PATPR1IO/INC            * Pre-admission master file
          INC       PATVISIO/INC 
          INC       PATIN1IO/INC
          INC       PATMA1IO/INC
          INC       PMIGTNID
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PMSPX2IO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATMASTM
          INC       PATMISTM
          INC       CLPATALR
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       DAYOFWEK
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       PATALRTM
.
          INC       RESLNKIO/INC
          INC       PATMI1IO/INC
          INC       PATWR1IO/INC
          INC       OUTSITIO/INC            * Outpatient Site File 
          INC       PATDO1IO/INC
          INC       PATICDIO/INC
          INC       MRTMASIO/INC
          INC       PATFN1IO/INC 
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATVADIO/INC
          INC       PATASFIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATHSPIO/INC
          INC       PATITMIO/INC
          INC       PATCMCIO/INC
          INC       PMSVX1IO/INC
          INC       PATDADIO/INC
          INC       PATNIDIO/INC
          INC       PMSALNIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PMSALAIO/INC 
          INC       PMSCLPIO/INC      
          INC       PMSCCDIO/INC            * Concession Card Details
          INC       PMSTLEIO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
.
          INC       FHRDATCD
          INC       OBSFHRCD    
          INC       OBSPCOIO/INC
          INC       OBSPCTIO/INC
          INC       CLPATMAS                * Clear nhimasaf file variables
          INC       CLNHIMAS                * Clear nhimasaf file variables
          INC       DGCLICUP
          INC       PATDOCTM
          INC       PATDOCCD
          INC       TFILENAM
.
