.        PATCATBI :
.
.        USED BY  : IBABIL01  IBABIL91  IBAMED19  IBAPAT36
.                   IBABIL19  IBAHOS03  IBAPAT32  IBAPPP19
.                   IBABIL20  IBAHOS32  IBAPAT34  IBATHE81
.                   IBABIL60  IBAMAT03  IBAPMS32
.
.
.        NOTE : CMXFLAG  0-charge patcat, 1-Casemix , 2-user to fix matrix
.               PCFLAG   0-Casemix, 1-revert to patcat, 2-patcat & casemix
.                        3-revert to patcat from high boundary or critical care
.
.        IF PROGFLAG = 1  THEN WORK OUT THE AMOUNT TO BE INVOICED
.
.        IF PROGFLAG = 2  THEN DISPLAY NEXT INVOICE
.
.        IF PROGFLAG = 3  THEN PRINT NEXT INVOICE
.
.        IF PROGFLAG = 4  THEN UPDATE PATFINS WITH AMOUNTS TO BE INVOICED
.
.        IF PROGFLAG = 5  THEN PRINT NEXT ESTIMATE INVOICE (NO UPDATE)
.                         for Johns Hopkins Where CFEETYP=9
.
.        IF PROGFLAG = 6  THEN PRINT NEXT INVOICE (NO UPDATE) FOR
.                         Discharge Billing Statement
.
.        IF PROGFLAG = 7  THEN WORK OUT THE ACCOMMODATION TO BE INVOICED for
.                         Independent Services Billing
.
.--------------------------------------------------------------------------
.
.        VERSION  :
. 
.         V12.01.02 12/02/2026  J.Tan          TSK 0971245
.                   Mod to kill tempfiles (Disc.Billing) - DLNE9000
.         V12.01.01 24/10/2025  J.Tan          TSK 0946593
.                   Fixed COPTION generating CP Theatre fee sort
.         V12.00.05 10/10/2025  J.Tan          TSK 0946593
.                   Mod CP zero thea.fee to sort using perdiem fees (SORTDONE)
.         V12.00.04 17/07/2025  J.Tan          TSK 0961277
.                   Checking if Accom.has been included in Pat.inv. (COMFLAG)
.         V12.00.03 01/07/2025  J.Tan          TSK 0960457
.                   Mod to set PINVDTE/FINDATE in WFINS000
.         V12.00.02 23/06/2025  J.Tan          TSK 0961589
.                   Fixed invoice rebate with zero MV hours
.                   Mod to open patpgraf file
.         V12.00.01 19/05/2025  Ebon Clements  TSK 0955096
.                   Alphanueric visit number changes
.         V11.05.03 20/01/2025  J.Tan          TSK 0955356
.                   Mod to set FININVN,FINADMN,FINURNO and FGSTFLAG
.                   03/02/2025 J.Tan             TSK 0946490
.                   Mod for CWO Payment Model
.         V11.05.02 16/01/2024 J.Tan             TSK 0952533
.                   Mod Mechanical Ventilation to charge using Ventilation file
.         V11.05.01 03/12/2024 J.Tan             TSK 0953674
.                   Added a hidden tag for Total Patient invoice (ptinvamt)
.         V11.04.06 22/10/2024 J.Tan             TSK 0951821
.                   Fixed printing Item with zero amount(printed on HF inv)
.         V11.04.05 04/10/2024  J.Tan            TSK 0951441
.                   Mod ADON7800 to set STRATEH for HF No payday AddOn charge
.         V11.04.04 06/08/2024  J.Tan            TSK 0939432
.                   Added PTCNISBZ - Ind.Billing Misc.with quantity of zero
.         V11.04.03 11/06/2024  J.Tan          TSK 0946701
.                   Fixed calculating items(amt x quantity) greater than FORM6P2
.         V11.04.02 13/03/2024  J.Tan          TSK 0919335
.                   Mod checking for HF history
.         V11.04.01 04/12/2023  J.Tan          TSK 0940149
.                   Mod to save lumpsum admission type for No payday (CSMATYPE)
.         V11.03.04 12/09/2023  J.Tan          TSK 0935891
.                   Added ACCMDESC for displaying longer bed fees desc.
.         V11.03.03 20/06/2023 J.Tan    TSK 0923703
.                   Mod checking for ISBLFLAG=0 (independent services)
.         V11.03.02 22/05/2023 J.Tan    TSK 0923703
.                   Mod for ABF Admitted Mental Health Events
.         V11.03.01 10/03/2023  J.Tan          TSK 0924587
.                   Mod IPATFLAG=2 to override no of invoice for misc.item
.         V11.02.03 20/05/2022  J.Tan          TSK 0814566
.                   Removed opening patfn2af (added in PATFN2RD)
.         V11.02.02 28/03/2022  J.Tan          TSK 0814566
.                   Added PATFN2RD - read patfn2af with Hospital & Eff.date 
.         V11.02.01 25/03/2022  J.Tan          TSK 0916593
.                   Mod SCTR0000 to set FNDLRATE/PATLRATE for New contract
.         V11.01.06 18/08/2021  J.Tan          TSK 0903454
.                   Added Claim code to Lumpsum/Daily charge for CACCFEE=4
.         V11.01.05 01/07/2021  J.Tan          TSK 0908588
.                   Exclude Unqualified days for Min/Max days cut off
.         V11.01.04 26/05/2021  J.Tan          TSK 0863287
.                   Fixed displaying Rate for item
.         V11.01.03 03/05/2021  J.Tan          TSK 0863287
.                   Mod checking for DBSFLAG Discharge Billing (PTCNPPIN=1)
.         V11.01.02 16/03/2021  J.Tan          TSK 0863287
.                   Mod for New Patient Portion Inv.functionality (PTCNPPIN=1)
.                   IPATFLAG=2
.                   Fixed Casemix Theatre fee with multiple number of quantity
.                   after CMXT0000 (get theatre casemix funding)
.         V11.01.01 18/02/2021  J.Tan          TSK 0888639
.                   Added PMMITMNO - Theatre Team no
.         V11.00.06 14/07/2020  J.Tan          TSK 0892902
.                   Mod to initialise CASMXKEY (ADON0000 for No payday)
.         V11.00.05 24/06/2020  J.Tan          TSK 0886178
.                   Mod ABF Invoice to write to patinpaf - invoice pending det.
.         V11.00.04 01/07/2020  J.Tan          TSK 0892765
.                   Mod checking Low outlier, exclude Unqualified days(PATDATYP)
.         V11.00.03 29/04/2020  J.Tan          TSK 0838262
.                   Fixed MBS theatre fee
.         V11.00.02 11/03/2020  J.Tan          TSK 0838262
.                   Added Effective from and to date to MBS Item file
.         V11.00.01 17/02/2020  J.Tan           TSK 0888245
.                   Mod to set TTYPE prior writing a record to patdtraf
.         V10.15.03 16/01/2020  J.Tan           TSK 0883777
.                   Fixed MV with ADYHOSP <> 0
.                   17/01/2020  J.Tan           TSK 0887086
.                   Mod to initialise NETTOT for ABF Inv.pending report
.         V10.15.02 29/11/2019  J.Tan           TSK 0857392
.                   Mod for IBAHMS58 - ABF Comparison report
.         V10.15.01 09/10/2019  J.Tan            TSK 0882545
.                   Mod CHKACCM0 - checking for ABF charge 
.         V10.14.05 30/09/2019  J.Tan            TSK 0872482
.                   Mod MV with on Leave and Return on same day
.         V10.14.04 13/09/2019  J.Tan             TSK /0874475
.                   Fixed Inlier stepdown for MV on Adm.date(restore SFDT1)
.         V10.14.03 28/06/2019  J.Tan          TSK 0857392
.                   Mod for ABF invoice
.         V10.14.02 27/05/2019  J.Tan          TSK 0875088
.                   Fixed 'No Payday' with Oper.on Disc.date to write lumpsum
.                   to patinpaf
.         V10.14.01 21/03/2019  J.Tan            TSK 0857392
.                   Changed RCP Transaction count from DIM3 to DIM5
.         V10.13.05 12/03/2018  J.Tan          TSK 0867553
.                   Mod CCIN000 - PTCNHCCC allocating MV to use Adm.type for ICU
.         V10.13.04 23/10/2018  Tracey Nguyen  TSK 0859743
.                   Added PMMIHOSI - Hopsital Indicator on PMSMTIFD
.         V10.13.03 19/09/2018  J.Tan          TSK 0863727
.                   Added Restrictive Override code
.         V10.13.02 12/09/2018  J.Tan          TSK 0859233
.                   Fixed deleting misc.items for printing Patient Invoice
.         V10.13.01 20/08/2018  J.Tan          TSK 0859911
.                   Fixed No payday Add-On for Change rec. on same day(CHGM000)
.                   21/08/2017  J.Tan        TSK 0859742
.                   Added ECLIPSE new fields from pmsmtiaf
.         V10.12.03 18/07/2018  J.Tan          TSK 0859911
.                   Fixed No payday Add-On for bed transfer on adm.date(CHGM000)
.         V10.12.02 20/04/2018  J.Tan          TSK 0855102
.                   Fixed displaying Accom. on Patient Only invoice
.         V10.12.01 15/01/2018  J.Tan         TSK 0848146
.                   Added CACCFEE=5 group accommodation by Claim code
.         V10.11.03 08/09/2017  J.Tan         TSK 0837479
.                   Added OPCNCONS - Using Consumption type items
.         V10.11.02 24/08/2017  J.Tan         TSK 0843471
.                   Mod to initialise ptdtepsd for Daycase (FNDT0200)
.         V10.11.01 27/07/2017  J.Tan         TSK 0842559
.                   Mod CHKACCM0 to skip Current printing invoice number
.         V10.10.05 16/05/2017  J.Tan         TSK 0833067
.                   Fixed Win/Loss (HMS70) - effective date forperdiem Thea fees
.         V10.10.04 17/05/2017  J.Tan             TSK 0297904
.                   Mod for Non-Accumulative inlier ICU/CCU rule
.         V10.10.03 10/04/2017  J.Tan         TSK 0833067
.                   Fixed Win/Loss (HMS70) Pat Cat.Accom.& Thea fees(ICD10 Sug.)
.         V10.10.02 04/04/2017  J.Tan             TSK 0297904
.                   Mod for Non-Accumulative inlier ICU/CCU rule
.         V10.10.01 25/01/2017  J.Tan         TSK 0832407
.                   Mod to check for multiple bed transfer on same day for MV
.         V10.09.03 29/12/2016  J.Tan         TSK 0829362
.                   Fixed ADON0000 for No pay day on same date as Bed Transfer
.         V10.09.02 20/12/2016  J.Tan         TSK 0323541
.                   Changed SITM2353 - set up PMMIAMTT
.         V10.09.01 17/11/2016  J.Tan         TSK 0317714
.                   Mods to set ptdtepsd for MV Daycase
.                   28/11/2016  J.Tan         TSK 0827591
.                   Fixed Next invoice (Nopayday=2 where TDATE same as PCENDDTE)
.         V10.08.12 21/09/2016  J.Tan         TSK 0826370
.                   Changed MCHGARR MCHGAMT array to FORM3
.         V10.08.11 08/09/2016  J.Tan         TSK 0825719
.                   Mods CTDY0000(NoPayday) - Casemix only if Oper.date = Adate
.         V10.08.10 17/08/2016  J.Tan         TSK 0808745
.                   Mods DLNE5920 - NPDAYFLG=1 to check if Date start of
.                   casepayment is same as transfer date 
.         V10.08.09 15/08/2016  J.Tan         TSK 0823517
.                   Mods Pat.Only Inv.(IPATFLAG) to skip items with zero pat & 
.                   rebate portion
.         V10.08.08 20/07/2016  J.Tan         TSK 0819914
.                   Mods checking for -ve Non ICU MV Hours (CALCMVHR)
.         V10.08.07 10/07/2016  J.Tan         TSK 0822042
.                   Fixed Grosstotal for JH invoice
.         V10.08.06 05/07/2016  J.Tan         TSK 0819914
.                   Mods to calculate Non ICU MV Hours (CALCMVHR)
.         V10.08.05 20/06/2016  J.Tan         TSK 0820816
.                   Fixed No payday for Daycase
.         V10.08.04 02/06/2016  J.Tan         TSK 0816651
.                   Recompiled for PATCATBI - Continuous Bill.to chk for Matrix
.         V10.08.03 29/04/2016  J.Tan         TSK 0817613
.                   Mods for checking Min Max day prior No Pay day cut off
.         V10.08.02 29/04/2016  J.Tan         TSK 0817527
.                   Fixed issue where No payday cut off is greater than LOS
.         V10.08.01 29/03/2016  J.Tan         CAR 0290448
.                   Fixed Addon with No Pay Day
.         V10.07.04 29/01/2016  J.Tan         CAR 0290448
.                   Mods for Addon with No Pay Day
.         V10.07.03 29/01/2016  J.Tan         CAR 303942
.                   Mods for Payment types
.         V10.07.02 21/10/2015  J.Tan          CAR 315453
.                   Added HF new field PTFXMFEE 'Make Primary based on MBS Fee'
.                   20/10/2015  J.Tan          CAR 321345
.                   Changed checking Max/Min - CMLOS to include ADYHOSP
.                   22/10/2015  J.Tan          CAR 322643
.                   Changed GACC5700 - checking Days Hosp. equals to BF endday
.         V10.07.01 13/10/2015  J.Tan          CAR 322435
.                   Fixed bed fees description (GACC5800) for patient bdays >999
.                   15/10/2015  J.Tan          CAR 322442
.                   Set TOTDAYS to one for Daycase casemix (DLNE5680) 
.         V10.06.04 27/08/2015  J.Tan          CAR 317714
.                   Fixed issue with MV days greater than Bed days/LOS
.         V10.06.03 18/08/2015  J.Tan          CAR 317714
.                   Fixed issue with MV days greater than Bed days/LOS
.                   Changed SMVD0000 - checking MVBDATE against IDATE
.         V10.06.02 26/03/2015  J.Tan          CAR 313385
.                   Changed CBDY0000 to use AADMNO instead of ADMISSNO
.         V10.06.01 10/03/2015  J.Tan          CAR 313385
.                   Added output of hidden field ppayable -Pat.Balance Payable
.         V10.05.09 03/03/2015  Jill Parkinson CAR 313385
.                   Added output of hidden fields pcbiinvt and pcbibalp
.         V10.05.08 23/02/2015  J.Tan          CAR 311738
.                   Fixed checking field for Keyin Misc.item amount
.         V10.05.07 19/02/2015  J.Tan          CAR 311352
.                   Mods ShowStepdown script to pass on Contract id
.         V10.05.06 29/10/2014  J.Tan          CAR 307268
.                   Mods Mechanical Vent. item to print/display MV From date
.         V10.05.05 23/10/2013  J.Tan          CAR 307539
.                   Fixed displaying SX Deposits
.         V10.05.04 25/09/2014 J.Tan           CAR 291619
.                   Fixed description for zero days of MV
.         V10.05.03 25/09/2014 J.Tan           CAR 301281
.                   Mods Mechanical Ventilation item to be HF Portion not Pat.
.         V10.05.02 06/08/2014 Peter Vela      CAR 302164
.                   Added PMMIRBRS - Rebate Reason CAT Rr                   
.         V10.05.01 31/07/2014 J.Tan           CAR 303625
.                   Fixed printing invoice with stepdown prior end of Contract
.         V10.04.08 26/06/2014 J.Tan           CAR 268860
.                   Fixed Invoice with ICD10 Suggested Classification
.         V10.04.07 19/06/2014 J.Tan           CAR 302452
.                   Added INAR0000 - initialise array variable
.         V10.04.06 05/06/2014 Jill Parkinson CAR 301639 
.                   Commented out all calls to TFILENAM - needs to be in INIT000
.                   Added CLEZ0000 and CLEY0000 in case iserase failed
.         V10.04.05 23/05/2013  J.Tan          CAR 300784
.                   Fixed force stepdown prior Invoice Fromdate for Interim Inv.
.         V10.04.04 29/04/2013  J.Tan        CAR 261630
.                   Removed port number from temp file name
.         V10.04.03 27/02/2014  J.Tan        CAR 275810
.                   Mods checking for Defence force claim
.         V10.04.02 03/02/2014  J.Tan        CAR 265430
.                   Mods to display Pat.total(Disc.Billing amount) on inv.header
.         V10.04.01 17/01/2014  J.Tan        CAR 295008
.                   Mods to set PMMIDTCR,PMMITMCR,PMMIIDCR
.                   20/01/2014  J.Tan        CAR 249828
.                   Added PMMIPMBS - Patient MBS Team and Counter
.         V10.03.34 13/09/2013  J.Tan          CAR 283618
.                   Mods for Independence Services Billing
.         V10.03.33 01/10/2013 J.Tan           CAR 291588
.                   Fixed checking for stepdown before New contract applies
.         V10.03.32 14/08/2013 J.Tan           CAR 289809
.                   Mods to include Days of Hosp.before checking End of Contract
.         V10.03.31 07/08/2013 J.Tan           CAR 288416
.                   Fixed CMCODE for Discharge Billing statement
.         V10.03.30 25/06/2013 J.Tan           CAR 287218
.                   Mods to default MBS quantity to one
.         V10.03.29 10/04/2013 J.Tan           CAR 283743
.                   Mods to set PTTREPSD to zero for a new generated Stepdown
.         V10.03.28 08/03/2013 J.Tan           CAR 282313
.                   Fixed force stepdown for per-diem
.         V10.03.27 04/03/2013 J.Tan           CAR 282129
.                   Fixed seaching for a valid contract for an interim invoice
.         V10.03.26 26/12/2012 J.Tan           CAR 278330
.                   Fixed searching for valid Contract of Multiple procedures
.         V10.03.25 09/11/2012 J.Tan           CAR 262673
.                   Mods for Unqualified days/additional Casepayment perdiemrate
.                   04/12/2012  J.Tan          CAR 271474
.                   Fixed Accom.description for As at Eff.date Contract
.         V10.03.24 10/10/2012  J.Tan          CAR 274381
.                   Mods not to print zero amt daily charge for Daycase casemix
.         V10.03.23 02/10/2012  J.Tan          CAR 273452
.                   Fixed Mechanical Ventilation for bed transfer on adm.date
.         V10.03.22 12/09/2012  J.Tan          CAR 267784
.                   Mods to check TCINDC19 Claim for Contract Eff.'Disc.From'
.         V10.03.21 28/08/2012  J.Tan          CAR 269747
.                   Fixed As at Eff.date Contract for multiple stepdown after
.                   the last trans.record
.         V10.03.20 24/08/2012  J.Tan          CAR 271924
.                   Fixed As at Eff.date Contract for Trans.dat=Contract Enddate
.         V10.03.19 09/08/2012  J.Tan          CAR 269134
.                   Mods to include ADYHOSP for a change of new Contract
.         V10.03.18 06/08/2012  J.Tan          CAR 270631
.                   Fixed Eff.date for patient with last trans.date < IDATEF
.         V10.03.17 03/08/2012  J.Tan          CAR 269748
.                   Fixed Discharge billing statement patient portion
.         V10.03.16 24/07/2012  J.Tan          CAR 269748
.                   Fixed 'As at Effec.date' Contracts
.         V10.03.15 19/07/2012  J.Tan         CAR 257771
.                   Mods SX invoice to print Theatre duration column
.         V10.03.14 19/07/2012  J.Tan          CAR 267037
.                   Fixed 'As at Effective Date' Contracts
.         V10.03.13 26/06/2012  J.Tan          CAR 267037
.                   Fixed Interim invoice with multiple Contract ID
.         V10.03.02 13/06/2012  J.Tan          CAR 267037
.                   Fixed Theatre fee (using Contract Effective As At Date)
.         V10.03.01 30/04/2012  Saroeun Soeur  CAR 263106
.                   changed CCERT000 to check for PTITTCER
.                   added   CETT0000 to check for bed type certificate
.         V10.02.05 04/11/2011 J.Tan           CAR 237245
.                   Mods Johns Hopkins invoice to print rounding amount
.         V10.02.04 28/09/2011  J.Tan          CAR 252125
.                   Fixed to print claim details for SJOG
.         V10.02.03 15/09/2011  J.Tan          CAR 251202
.                   Fixed printing Lumpsum description
.         V10.02.02 05/08/2011  J.Tan          CAR 244159
.                   Fixed displaying Cash
.         V10.02.01 18/04/2011  J.Tan  CAR 237245
.                   Mods for Johns Hopkins invoice to print Insurance provider
.         V10.01.03 12/04/2011  J.Tan          CAR 233154
.                   Mods for Continuous billing
.         V10.01.02 31/03/2011 J.Tan       CAR 233195
.                   Mods for Mechanical Ventilation
.                   Checking Contract Expired date against new stepdown date
.         V10.01.05 12/01/2011  J.Tan         CAR 230716
.                   Fixed Lumpsum with No payday
.                   18/01/2011  J.Tan         CAR 233034
.                   Mods bed fees to use HF Table type
.                   Mods Multiple Procedures to validate Contract ID
.                   21/01/2011  J.Tan         CAR 233149
.                   Mods Additional fees to include Fees Inv.group to DTR
.                   24/01/2011  J.Tan         CAR 233200
.                   Replaced PTCNHCPB with PTCNHCCC 
.         V10.01.04 08/12/2010 Mike Laming   CAR 233046
.                   Mods for PATMCHFD using H/F Table Type (replacing H/F Table)
.         V10.01.03 30/11/2010 Peter Vela    CAR 233148
.                   Initialised pattranf variables before write
.                   and update to pattranf
.         V10.01.02 29/10/2010 J.Tan         CAR 230716
.                   Mods to initialise casemix matrix fields
.         V10.01.01 28/10/2010 J.Tan         CAR 230716
.                   Mods to print/display zero amount of 'No Pay Day'
.         V10.00.18 22/10/2010 J.Tan         CAR 232210
.                   Fixed Not to recalculate exploding misc.item (PMMIITYP=2)
.         V10.00.17 13/10/2010 J.Tan         CAR 229937
.                   Fixed printing Cabrini multiple pages
.         V10.00.16 12/10/2010 J.Tan         CAR 231667
.                   Fixed balance payable on invoice tail to include unreleased
.                   cash for Cabrini and SJOG layout
.         V10.00.15 11/10/2010 J.Tan         CAR 229937
.                   Fixed Cabrini invoice to print 25 line of invoice body
.         V10.00.14 23/09/2010 J.Tan         CAR 230664
.                   Mods for HEC invoice layout - PTCNINVL=18
.         V10.00.13 25/08/2010 J.Tan         CAR 228192
.                   Added column for quantity on invoice screen
.         V10.00.12 20/08/2010 J.Tan         CAR 218912
.                   Mods to display ICU/CCU/NNU in red
.         V10.00.11 18/08/2010 J.Tan         CAR 222031
.                   Mods to set PMMIDUPD and PMMITUPD
.         V10.00.10 05/07/2010  J.Tan                  CAR 227717
.                   Fixed printing Balance payable on invoice tail
.         V10.00.09 30/07/2010  J.Tan                  CAR 227319
.                   Fixed Mechanical Ventilation
.         V10.00.08 12/07/2010  J.Tan                  CAR 225932
.                   Mods to set TDATE to IDATET after reading the last record 
.                   of pattranf (DLNE8400) - per diem
.         V10.00.08 23/06/2010  J.Tan                  CAR 224446
.                   Fixed lumpsum in patdtraf file (FNDT9999)
.         V10.00.07 11/06/2010  J.Tan                  CAR 223824
.                   Fixed accom.desc.after bed fees update(PTTREPSD=2 & TMOVE=A)
.         V10.00.06 04/06/2010  Mike Laming (for Jeni) CAR 212867
.                   Fixed printing SJOG cash receipt at GCDE0000
.         V10.00.05 27/05/2010  J.Tan     CAR 219471
.                   Fixed Mechanical Ventilation billing record
.         V10.00.04 30/04/2010  J.Tan     CAR 220887
.                   Mods checking for Active/Inactive of Misc.charge
.         V10.00.03 21/04/2010  J.Tan         CAR 188985
.                   Fixed getting bed fees desc.if the previous transaction
.                   record is 'A' with no forcestepdown
.         V10.00.02 20/04/2010  J.Tan         CAR 220073
.                   Mods to include Hospitalisation to determine LOWFLAG
.         V10.00.01 14/04/2010  J.Tan         CAR 217111
.                   Fixed writing lumpsum amt to patinpaf for C/P admitted on
.                   current date
.         V9.12.17  16/02/2010  Peter Vela    CAR 215485
.                   Added check for change of Bed Type DLNE5000
.         V9.12.16  05/02/2010  Peter Vela    CAR 215485
.                   Ignore Leave if less than a day DLNE5000
.         V9.12.15  27/10/2009  J.Tan         CAR 214548
.                   Fixed automatic STEPDOWN after bed fees update
.                   27/10/2009  J.Tan         CAR 214548
.                   Mods to set MSGFLAG to zero
.         V9.12.14  08/01/2009  J.Tan         CAR 202277
.                   Fixed printing SJOG invoice with claim details
.         V9.12.13  10/12/2009  J.Tan         CAR 211762
.                   Fixed printing SJOG/Cabrini Accommodation with GST
.         V9.12.12  24/11/2009  J.Tan         CAR 207781
.                   Mods to initialise daily rates for daycase (strate/spttrad)
.         V9.12.11  19/10/2009  J.Tan         CAR 207359
.                   Fixed PTTREPSD on the last STEPDOWN
.         V9.12.10  13/10/2009  J.Tan         CAR 188108
.                   Mods to print/display zero lumpsum amount
.         V9.12.09  07/10/2009  J.Tan         CAR 203934
.                   Mods to display ICD10 Suggested Class.
.         V9.12.08  02/10/2009  J.Tan             CAR 207105
.                   Mods checking for credit note for Mechanical Vent.
.         V9.12.07  04/09/2009  J.Tan             CAR 205303
.                   Added Contract ID
.         V9.12.06  19/08/2009  J.Tan             CAR 187486
.                   Mods to print/display the payer for SX invoice
.         V9.12.05  30/07/2009  J.Tan             CAR 200712
.                   Fixed Cabrini Discharged billing statement
.         V9.12.04  17/07/2009  J.Tan             CAR 199603
.                   Mods to print theatre banding for Pendlebury invoice
.         V9.12.03  09/07/2009  J.Tan             CAR 200387
.                   Fixed printing casepayment invoice with 'No Payday'
.         V9.12.02  07/07/2009  J.Tan             CAR 200387
.                   Mods to set NPDAYFLG to zero when raising an invoice for
.                   patient who reverts to perdiem due to cut off days
.         V9.12.01  11/05/2009  J.Tan             CAR 125842
.                   Added parameter to recalculate zero amount of Misc.item
.         V9.11.14  28/04/2009  J.Tan             CAR 195596
.                   Added fields PTDTADPT PTDTADRB
.         V9.11.13  01/04/2009  J.Tan             CAR 192704
.                   Fixed field PTDTCCU
.         V9.11.12  31/03/2009  J.Tan  CAR 192772 
.                   Mods for Johns Hopkins invoice - 2 lines of Accom. Desc.
.         V9.11.11  31/03/2009  J.Tan            CAR 190946
.                   Mods writing to patinpaf file
.         V9.11.10  10/03/2009  J.Tan            CAR 188102
.                   Added Patient Only Invoice
.         V9.11.09  25/01/2009  J.Tan  CAR 190860
.                   Mods to initialise GST amount
.         V9.11.08  05/01/2009  J.Tan  CAR 188205
.                   Mods to print 'Non-bank deposit' as 'Payment recieved'
.         V9.11.07  21/01/2009  J.Tan  CAR 181844
.                   Fixed printing Cabrini's cash payment
.         V9.11.06  07/01/2009  J.Tan  CAR 186328
.                   Mods checking for casemix funding
.         V9.11.05  03/12/2008  J.Tan   CAR 181844
.                   Fixed printing deposit for Cabrini invoice
.         V9.11.04  01/12/2008  J.Tan   CAR 125842
.                   Fixed RCH recalculating zero amt of misc.charges
.         V9.11.03  24/11/2008  J.Tan   CAR 125842
.                   Fixed displaying C/P daily charge with Mechanical Vent.
.                   20/11/2008  Steve Armstrong   CAR 181373
.                   Added CKPROS00 routine (for prosthetic tracking)
.         V9.11.02  30/10/2008 J.Tan      CAR 181263
.                   Mods for printing Discharge Billing Statement
.         V9.11.01  06/10/2008 J.Tan         CAR 180188
.                   Mods to set CASMXKEY
.         V9.10.09  25/09/2008 J.Tan         CAR 178209
.                   Fixed checking for doctor change record
.         V9.10.08  05/09/2008 J.Tan         CAR 177126
.                   Mods checking for Matrix parameter in CTDY0000(cut off days)
.         V9.10.07  12/08/2008 J.Tan         CAR 175967
.                   Mods Cabrini invoice not to print Anaesthetic Codes & Times
.         V9.10.06  23/07/2008 J.Tan         CAR 174476
.                   Fixed Cabrini Theatre line total item
.         V9.10.05  08/07/2008 Sandra Barcham    173135
.                   Removed close of PATDGWA1
.         V9.10.04  26/06/2008  J.Tan        CAR 166600
.                   Fixed DC C/P with lumpsum only to write to patinpaf file
.         V9.10.03  21/05/2008  J.Tan        CAR 167702
.                   Mods for Cabrini invoice layout
.         V9.10.02  13/05/2008 J.Tan         CAR 162313
.                   Added Deposit status to comdepaf
.         V9.10.01  09/05/2008  J.Tan        CAR 167702
.                   Fixed printing SJOG 'THEATRE FEE' overlap with item code
.         V9.09.15  21/04/2008  J.Tan        CAR 166600
.                   Mods to set PTIPBAND as Item Group (Catg FI) for SJOG
.         V9.09.14  26/03/2008  J.Tan        CAR 164169
.                   Fixed checking for Keyin Rebate Misc.item for Public Hosp.
.         V9.09.13  29/02/2008  J.Tan        CAR 162893
.                   Fixed CHKACCM0 routine to check for credit notes for lumpsum
.                   28/02/2008  J.Tan        CAR 162609
.                   Fixed printing invoice for zero amount of Inv.breakdown
.         V9.09.12  19/02/2008  Peter Vela        CAR 161535
.                   Added functionality to display Type of Certificate
.         V9.09.11  28/11/2007  J.Tan             CAR 155969
.                   Mods to initialise PTDTCRST for Lumpsum record
.         V9.09.10  19/11/2007  Steve Armstrong   CAR 155206
.                   Removed CLOSE's on PATDGWA1
.         V9.09.09  14/09/2007 J.Tan  CAR 144656
.                   Mods checking for no of items for Multiple procedures
.         V9.09.08  24/08/2007 Peter Vela CAR 146143
.                   Added Single unit price to Misc Items SJOG
.                   03/09/07 J.Tan    CAR 148932
.                   Fixed Estimate rebate for items with more than one quantity
.         V9.09.07  20/08/07 J.Tan    CAR 146067
.                   Mods for Multiple procedures billing
.         V9.09.06  09/08/2007 Peter Vela CAR 146143
.                   Added No of services/Quantity to Misc Items SJOG
.         V9.09.05  11/07/07 J.Tan    CAR 143630
.                   Fixed Invoice date
.         V9.09.04  29/06/07 J.Tan    CAR 143182
.                   Fixed GST percentage for SX
.         V9.09.03  25/06/07 J.Tan    CAR 143630
.                   Mods to use Invoice date as the effective date for JH GST
.         V9.09.02  20/06/2007  Mike Laming   CAR 121641
.                   Change position of ItemNo for Inv.Layout PTCNINVL=15 STV
.         V9.09.01  13/06/2007  Mike Laming   CAR 119158
.                   Added MISCDATE to GMIS000 for Misc.Charges Effective Date
.         V9.08.25  08/06/07 J.Tan    CAR 141539
.                   Mods mtdt0000 to set ptdtcntr
.         V9.08.24  23/05/07 J.Tan    CAR 141409
.                   Fixed printing Pendlebury (PTCNINVL=16) lumpsum
.                   31/05/07 J.Tan    CAR 141297
.                   Mods for Fees Invoice with revenue breakdown (IBAINP19)
.         V9.08.22  07/05/2007 Peter Vela CAR SJOG ED Billing
.                   Initialised new pmsmtiaf variables
.         V9.08.21  08/05/2007  Mike Laming   CAR 137125 HDP 2007
.                   Add DRG Version to Key fields for reads to PATDGWaf
.         V9.08.20  16/04/07 J.Tan    CAR 138026
.                   JH - check if partial day has been charged for disc.patient
.         V9.08.19  26/03/07 J.Tan    CAR 136953
.                   Mods JH inv for patients disc.on first date of period to 
.                   include items charges on disc.date.
.         V9.08.18  14/03/07 J.Tan    CAR 135853
.                   Mods JH inv raised on 1st day of period not to
.                   include items/doctor charges for 1st day of period
.         V9.08.17  07/02/07 Peter Vela CAR sjog-vic
.                   Added 24 St. John of God layout
.         V9.08.16  20/02/07 J.Tan    CAR 130462
.                   Mods for JH GST
.         V9.08.15  08/02/07 J.Tan    CAR 120001
.                   Mods for NZ Billing
.         V9.08.14  08/02/2007  Mike Laming    CAR 130245
.                   Correct NOFEE check at DLNE5900
.         V9.08.13  14/12/06 J.Tan    CAR 127726
.                   Fixed description for discount
.         V9.08.12  12/12/2006  J.Tan          CAR 127726
.                   Mods to JH GST Discount
.         V9.08.11  11/12/2006  J.Tan          CAR 127646
.                   Added Reference column to JH Details invoice
.         V9.08.10  05/12/2006  J.Tan          CAR 127092
.                   Mods printing Misc.group in bold for JH Invoices
.         V9.08.09  30/11/2006  J.Tan          CAR 126728
.                   Mods JH invoice date to use the keyin date (backdated)
.                   04/12/2006  J.Tan          CAR 126763
.                   Add Quantity column for JH details invoice
.         V9.08.08  17/11/2006  Peter Vela     CAR 124538
.                   Added display of PATITMFD.PTITTCER
.                   Type of Certificate Type B Type C
.         V9.08.07  10/11/2006  J.Tan          CAR 121178
.                   Fixed partial day charges description (days)
.         V9.08.06  25/10/2006  J.Tan          CAR 122541
.                   Mods to use alternate item Group (Catg FN) for JH invoice
.         V9.08.05  18/10/2006  J.Tan          CAR 120502
.                   Mods to ignore Doctor Change record in trans file
.         V9.08.04  16/10/2006  J.Tan          CAR 121629
.                   Fixed Discount from receipts
.                   16/10/2006  J.Tan          CAR 121630
.                   Mods printing bold on item code for JH invoice
.         V9.08.03  12/10/2006  J.Tan          CAR 121326
.                   Mods to allow backdate invoice for JH
.         V9.08.02  11/10/2006  J.Tan          CAR 121178
.                   Fixed accom.desc.for an extra halfday charge on disch.
.         V9.08.01  05/10/2006  J.Tan          CAR 120654
.                   Fixed Lumpsum for split invoices
.         V9.07.03  25/09/2006  Peter Vela       CAR 118940
.                   Fixed PTCNINVL=12 Greenslopes layout GLUM6000
.         V9.07.02  15/09/2006  J.Tan            CAR 118964
.                   Fixed </td> displaying accommodation
.         V9.07.01  31/07/2006 J.Tan      CAR 103365
.                   Mods for Johns hopkins invoice - CFEETYP=9
.         V9.06.02  16/05/2006  Peter Vela       CAR 104103
.                   Fixed PTCNINVL=12 Greenslopes layout
.         V9.06.01  31/05/2006  J.Tan            CAR 105669
.                   Mods printing STV invoice - misc.items without unit price
.         V9.05.B04 06/01/2006  J.Tan            CAR 84567
.                   Mods for manual stepdown to use trbend to get accomm.desc.
.         V9.05.B03 04/01/2006  J.Tan            CAR 88125
.                   Mods checking for nofee flag
.         V9.05.B02 15/12/2005  J.Tan            CAR 89226
.                   Added PTCNRCAL - Recalculate theatre fees
.         V9.05.B01 09/12/2005 J.Tan  CAR 59381
.                   Mods for printing split invoice
.         V9.04.29  09/11/2005  Jeni Tan     CAR 76442
.                   Mods to recalcuate misc.charges for STV/RCH
.         V9.04.28  07/11/2005  Jeni Tan     CAR 62083
.                   Fixed bed fees description for daycase with days of Hosp.
.         V9.04.27  02/11/2005  Jeni Tan     CAR 81394
.                   Additional programming needed for 62471
.         V9.04.26  31.10.2005 J.Tan   CAR 81484
.                   Fixed Deleting item from RCH invoice layout
.         V9.04.25  25.10.2005 Sandra Barcham CAR 81362
.                   Fixed pack of fincode
.         V9.04.24  25/10/05 Ebon Clements CAR 81174 81176
.                   Changed PBXC0000 to not erase temp files if not using pabx
.         V9.04.23  16/09/05 J.Tan    CAR 52714 
.                   Fixed C/P overnight description after return from leave
.                   10/09/05 J.Tan    CAR 62471
.                   Fixed bed description with hospitalisation days
.         V9.04.22  03/08/05 J.Tan    CAR 62750 
.                   Removed redefined amount variables
.                   19/08/05 J.Tan    CAR 64493
.                   Added Bed type to dtr file
.         V9.04.21  10/05/2005  J.Tan          CAR 61488
.                   Mods for Ballarat invoice (layout 19 -landscape)
.         V9.04.20  05/04/2005  Mike Laming  CAR 59989
.                   Fixed printing of INVOICE TOTAL so that printing with/w'out
.                   Rebate is correct at NPRT5100 & 5200
.         V9.04.19  10/01/2005  J.Tan CAR 51688
.                   Fixed printing second line of accommodation description
.         V9.04.18  30/12/2004  J.Tan CAR 55988
.                   Fixed printing misc.item for pendlebury invoice layout
.         V9.04.17  16/12/2004  J.Tan CAR 55944
.                   Fixed calvary invoice for public (PTHSTFEE)
.         V9.04.16  09/12/2004  J.Tan      CAR 55293
.                   Fixed total item amount with quantity
.         V9.04.15  30/11/2004  J.Tan      CAR 55293
.                   Added uniq id to patdtraf and pmsmtiaf
.         V9.04.14  17/11/2004  Guomin Fu   CAR 54768
.                   Mods for Pendelbury invoice layout (PTCNINVL=16) 
.         V9.04.13  15/11/2004  J.Tan  CAR 54768
.                   Mods for Pendelbury invoice layout (PTCNINVL=16)
.         V9.04.12  11/11/2004  J.Tan  CAR 55071        
.                   Mods for SVHM invoice layout
.         V9.04.11  29/09/2004  J.Tan      CAR 54347
.                   Mods to initialise patient portion variable (GETIT00)
.         V9.04.10  27/10/2004  J.Tan      CAR 54648
.                   Fixed displaying backdated invoice
.         V9.04.09  22/10/2004  J.Tan      CAR 54506
.                   Fixed I*C pmsmtiaf file
.         V9.04.08  01/10/2004  J.Tan   CAR 54081
.                   Fixed fincode for patrfnaf for non exist revenue breakdown
.         V9.04.07  12/10/2004  J.Tan      CAR 54242
.                   Added parameter to print ward/bed on invoices
.         V9.04.06  05/10/2004  J.Tan   CAR 53798
.                   Mods default charging claim code for multi hospital       
.         V9.04.05  01/10/2004  J.Tan  
.                   Fixed fincode for patrfnaf for non exist revenue breakdown
.         V9.04.04  22/09/2004 Lina Vo CAR 53660
.                   Changed for Multi Hospital to use PTHSTFEE instead 
.                   of PTCNTFEE
.         V9.04.03  09/09/2004  J.Tan   CAR 53292          
.                   Mods for Holy Spirit invoice layout
.         V9.04.02  03/09/2004  J.Tan   CAR 52687          
.                   Fixed printing fees invoice date for disc.patient 
.         V9.04.01  20/08/2004 J.Tan  CAR 52835       
.                   Setup hospital ID for patfinsf
.                   Mods checking for hospital ID record for printing MBS code
.         V9.03.34  06/08/2004  J.Tan   CAR 52141          
.                   Fixing displaying invoice with No Pay Day
.         V9.03.33  04/08/2004  Mike Laming      CAR 52285
.                   Correct where Mech Vent days equal Accom. days - DTR was
.                   not being written (and Casemix Lumpsum was lost) @ FNDY2000
.         V9.03.32  30/07/2004 J.Tan CAR 52033
.                   Mods displaying and printing item unit price on invoice
.                   Fixed charging Mech.Vent. after invoice printed (CAR 52285)
.         V9.03.31  26/07/2004 J.Tan CAR 51805
.                   Fixed checking for Pre Op Cut Off for C/P.
.         V9.03.30  16/07/2004 J.Tan CAR 51688
.                   Fixed printing second lines of accommodation description.
.         V9.03.29  24/06/2004 J.Tan CAR 51112
.                   Mods checking for transaction number before writting to DTR
.         V9.03.28  24/06/2004 J.Tan CAR 47851
.                   Fixed daycase moiety
.         V9.03.27  22/06/2004 J.Tan CAR 42846
.                   Mods to include hospitalisation days for C/P
.         V9.03.26  17/06/2004 J.Tan CAR 49644
.                   Fixed problems with matrix
.         V9.03.25  08/06/2004 J.Tan CAR 50035
.                   Calculate mechanical ventilation billing days (for casemix
.                   patients insured with participating health funds).
.         V9.03.24  07/06/2004 J.Tan CAR 50019
.                   Mods for West wimmera invoice layout (PTCNINVL=19)
.         V9.03.23  27/05/2004 J.Tan CAR 50108
.                   Fixed displaying payment date
.         V9.03.22  13/05/2004 J.Tan  CAR 49827
.                   Mods to display non-banked deposit
.         V9.03.21  06/05/2004  
.                   Added delete item to RCH screen 
.         V9.03.20  20/04/2004  Mike Laming      CAR 46224
.                   Correct sequence of TMPMSCFL - Theatre Items, Type 2, need
.                   to use input sequence from SORTFILE (not DTR sequence)
.         V9.03.19  26/03/2004  Mike Laming      CAR 47732
.                   Changes made to PATCMSTP require change to DCHR0000 to
.                   move BDAYS back 1 day
.         V9.03.18  01/03/2004  Mike Laming      CAR 47546
.                   Correct summing to FORM82 for Casemix Breakdown & ADT09
.                   after calls to ACOM0000
.         V9.03.17  23/02/2004  Mike Laming      CAR 47440
.                   Add initialise TPATAMTP (Patient Portion) at CPRG5400
.         V9.03.16  23/02/2004  Henry Son        CAR 47385
.                   Added PTCNMBSF for checking if we allow more than
.                   Six MBS Items.
.         V9.03.15  12/02/2004 J.Tan  CAR 36504
.                   Mods for changing items from next invoice screen.
.         V9.03.14  03/02/2004 J.Tan  CAR 46269
.                   Mods for deleting items from next invoice screen.
.         V9.03.13  19/12/2003 J.Tan 
.                   Mods for new receipting files.
.         V9.03...  22/12/2003  Mike Laming   CAR 41072
.                   Remove BIL19 patch at GLUM8500 to correct totals       
.         V9.03.12  08/12/2003 J.Tan 
.                   Fixed displaying misc.item for charging using scheduled fee
.         V9.03.11  18/11/2003  Henry Son   CAR 39291
.                   Allow more than 7 Theatre stepdown fees.
.         V9.03.10  03/11/2003  CAR 43911   Mike Laming
.                   Change handling of LumpSum into GROSSTOT & ACCMTOT to be
.                   done in GLUM9000 only - remove from FNDT0000 & GETACCM
.         V9.03...  03/11/2003  CAR 43151   Mike Laming
.                   Alter ACOM0000 to write multiple records to "patfins" for
.                   change of Ward (not just once for Discharge Ward)
.         V9.03.09  20/10/2003  J.Tan    CAR 44172
.                   Mods to read misc.theatre item file (pmsmitaf)
.         V9.03.08  09/10/2003  CAR 36520   Lina Vo    
.                   Changed program to initialised FDAY,FMON,FYEAR,FCENT.  
.                   It was retaining old values when ALACDTE was blank and 
.                   was calculating TOTDAYS incorrectly.
.         V9.03.07  17/09/2003  CAR 40497   Lina Vo    
.                   Changed index and read of patmchgf to include effective 
.                   date.
.         V9.03.06  28/08/2003  CAR 41880   Mike Laming
.                   Correct calculation of CRITDAYS in CHKC0000 and change
.                   test for CRITDAYS in CTDY4000
.         V9.03.05  22/08/2003  J.Tan                    
.                   Fixed key for patdgwaf
.         V9.03.04  11/08/2003  CAR 41072   Mike Laming
.                   Alter PATCATBI  to correct FNDT0000 and GLUM8500 to
.                   handle Lump Sums correctly in BIL19
.         V9.03.03  04/08/2003  CAR 34330/41952   Mike Laming
.                   Add second Temp file TMPMSCFL to sort DTR Misc.Items (type
.                   "3") into 'Date/DTR Seq.' sequence
.         V9.03.02  31/07/2003 J.Tan  CAR 40786
.                   Fixed printing 2 lines of descriptions for C/P WEB Billing
.         V9.03.01  13/05/2003 J.Tan  CAR 36505
.                   Fixed Estimate rebate 
.         V9.02.35  08/04/2003 J.Tan
.                   Mods for WEB Billing
.         V9.02.34  12/03/2003  Mike Laming  CAR 37244 (Ne 14894)
.                   Bypass re-read of Admission in DLINE1 for IBAHMS70 (W&Loss)
.         V9.02.33  28/01/2003  Dean Cramer 
.                   Quantity to print for Calvary all transaction types.
.         V9.02.33  12/10/2002  J.Tan
.                   Mods for changes from r6.10
.                   Fixed No pay day 
.         V9.02.32  10/10/2002  Dean Cramer  Defect 22662
.                   Mods for St. Vs format.                      
.         V9.02.31  03/10/2002  J.Tan
.                   Mods to check for front end deductable item
.         V9.02.30  19/09/2002  J.Tan
.                   Mods to use defauld claim code for charging
.                   Fixed checking zero amount of misc.charge not to recalc.
.                   Mods to check for multiple item when resorting items
.         V9.02.29  11/09/2002  J.Tan
.                   Mods for revenue breakdown
.         V9.02.28  02/09/2002  Dean Cramer 
.                   Print INVOICE TOTAL 1 line sooner for RCH
.         V9.02.27  30/08/2002  J.Tan
.                   Mods to recalculate misc. for casemix
.         V9.02.26  27/08/2002 J.Tan  20791
.                   Mods for revenue breakdown
.                   26/08/2002 Dean Cramer
.                   Initialise NODAYS in GETMISC
.                   19/08/2002 Mike Laming   SRF 17570    
.                   Copy changes from V6.10 Bug fixes to V9.02
.             ~     SRF 19940 Wins & Losses report changes
.         V9.02.25  05/08/2002 Dean Cramer   Defect 20417
.                   Fix Calvary Cairns invoice line indent when casemix.       
.         V9.02.24  05/08/2002 J.Tan
.                   Mods for caccfee -4 (ward/adm type/claim type)
.         V9.02.23  29/07/2002 J.Tan
.                   Mods not to sort items if theatre fees file is not used
.         V9.02.22  18/07/2002  Dean Cramer  SRF 19855
.                   Fix so all transaction types print the number of services
.         V9.02.21  11/07/2002  Mike Laming  SRF 16830
.                   Fix repositioning on TRAN in DLNE0000-9999              
.         V9.02.20  28/06/2002 Dean Cramer  
.                   Mods to fix RCH format error                              
.         V9.02.19  24/06/2002 J.Tan
.                   Mods to check if dtr record already exist before writes I*D
.         V9.02.18  21/06/2002  Dean Cramer 
.                   Mods for RCH format                                    
.         V9.02.17  18/06/2002  J.Tan
.                   Mods for checking critical care                        
.         V9.02.16  16/06/2002  Dean Cramer        
.                   Mods for RCH invoice line formats                      
.         V9.02.15  14/06/2002  J.Tan  defect 18605
.                   Mods bed fees desc for casepayment reverst to bedfees
.         V9.02.14  05/06/2002  J.Tan  defect 18011
.                   Mods not to use for hospital type for stepdown
.         V9.02.13  30/05/2002  J.Tan  defect 17679
.                   Mods not to print theatre fees description for RCH SVH
.         V9.02.12  29/05/2002  J.Tan  defect 17679
.                   Mods to print quantity for theatre items
.         V9.02.11  28/05/2002  J.Tan           
.                   Fixed accommodation description
.         V9.02.10  27/05/2002  J.Tan           
.                   Mods for casemix billing
.         V9.02.09  15/04/2002  J.Tan           
.                   Copied from r6.09 
.         V6.09.22  04/04/2002  J.Tan  SRF 16323
.                   Mods to update dtr after sorting for printing invoices
.                   Fixed casemix lumpsum amounts, rebate and patient portion 
.                   were wrong way around.
.         V6.09.21  27/03/2002  Raghu  SRF 12042
.                   Removed a line after printing invoice message
.         V6.09.20  18/03/2002  J.Tan  SRF 16281
.                   Fixed casemix theatre fee for more than 9 items
.         V6.09.19  28/02/2002  J.Tan      
.                   Fixed casemix theatre fee with no fees set
.         V6.09.18  21/02/2002  J.Tan      
.                   Fixed problems for Epworth and Mayne                    
.         V6.09.17  08/02/2002  Greg Horvat
.                   Changed to not use the discharge DRG for casemix billing
.         V6.09.16  25/01/2002  Greg Horvat
.                   Pretty much rewrote how the matrix/casemix/perdiem billing
.                   was initially calculated cause invoices couldnt be printed
.                   & stuff was all wrong
.                   18/01/2002  Steve Downing  SRF 13320
.                   Fixed calculation of critical care days for CC cutoff
.         V6.09.15  16/01/2002  Greg Horvat      SRF 14570
.                   Fixed a bug where casemix lump sum amounts werent being
.                   written to patfinsf when invoicing casemix patients
.                   14.01.2002  Glenn Saunders - Mayne AR Data Extraction proj 
.                   Set new 'dtr' field SAP indicator to 'N' for new records   
.                   09/01/2002  Greg Horvat      SRF 14730
.                   Fixed a bug where admitted non casemix patients were not
.                   having there accom calculated correctly in non invoicing
.                   programs
.         V6.09.14  30/11/2001  J.Tan
.                   Fixed printing outlier invoices
.         V6.09.13  23/11/2001  J.Tan
.                   Fixed not to write to transfer file when doing enquiry
.         V6.09.12  15/11/2001  J.Tan
.                   Fixed lumpsum accommodation
.         V6.09.11  14/11/2001  J.Tan
.                   Fixed posting to revenue breakdown file for daycase casemix
.         V6.09.10  12/10/2001  Greg Horvat      SRF 13579
.                   Temporary fix of I*A at update of pattranf (DLNE7500) when
.                   updating charges for casemix daycase patient
.                   27/10/2001  J.Tan
.                   Removed Episode flag for casemix funding
.         V6.09.09  27/09/2001  Tonii  SRF 9220
.                   Added read on record before update- fixed I*U error
.         V6.09.08  20/08/2001  Tonii  SRF 12075
.                   Moved AADMNO No. into correct variable to fix I*D error
.         V6.09.07  17/08/2001  Steve Downing  SRF 11796
.                   Removed CLOSE for PATFUND1 to fix I*C error
.         V6.09.06  03/08/2001  Tonii 
.                   Made program print patient Admission Number when Casemix
.                   funding error occurs
.         V6.09.05  26/07/2001  Greg Horvat      SRF 11332
.                   Initialise DCFLAG (casemix daycase flag) to zero at the
.                   start of the routine
.         V6.09.04  13/07/2001  Steve Downing  SRF 11012
.                   Fixed display of Lumpsum description for casepayment pat's
.         V6.09.03  28/06/2001  Davin
.                   Added PATINPIO & routines for invoice details extract
.         V6.09.02  25/06/2001  Jill Habasque  SRF 10921
.                   Added routine FIXTHTR if patient is reverting to patcat     
.         V6.09.01  22/06/2001  Jill Habasque
.                   Casemix -changed to compare FORM2=3 instead of NOFEE=1 after
.                   calling PATGNCMX and commented out pcflag for srf 10872
.         V6.09.B07 29/03/2001  Jill Habasque
.                   Casemix - mods to use expected length of stay for 
.                   to be invoiced
.         V6.09.B06 06/03/2001  Jill Habasque
.                   Added LFIN0000 to write lumpsum record
.         V6.09.B05 19/02/2001  Jill Habasque
.                   Added move zero to CMXFLAG in DLINE1 
.         V6.09.B04 12/02/2001  Greg Horvat
.                   Replaced the call to CALC with DAYSEP
.         V6.09.B03 24/01/2001  Jill Habasque          
.                   Fixed write to patrfnaf if no revenue breakdown is set up
.         V6.09.B02 02/01/2001  Jill Habasque SRF 8036
.                   Fixed display of next invoice when no charge for daycase
.         V6.09.B01 02/01/2001  Jill Habasque SRF 6228
.                   Added write to patfigaf for PABX
.         V6.09.B00 14/12/2000  Jill Habasque  
.                   Casemix mods - changes to use matrix, revenue breakdown,
.                   invoice breakdown
.
.        This include produces the body of the next invoice for the current
.        patient. PROGFLAG is used to determine if the invoice is to be
.        displayed, printed, or just have the total calculated.
.
.        It refers to a number of subroutines that are not included in this
.        include. The main includes where these may be found (other than
.        the I/O includes) are :
.
.               PATCALFN : Include to update the Fees Invoiced Statistics
.
.               PATINVS  : Include that controls the printing of Invoices
.
.               PATINVTn : Include that contains the code that is dependent
.                          on the invoice layout (eg. Heading and Tail of
.                          the invoice, any right-hand-side, etc).
.
.---------------------------------------------------------------------------
.
.
.         This section of the include determines the date range for the invoice
.
CALCTBI   MOVE      ZERO,HFACCM              * Total rebate for Accommodation
          MOVE      ZERO,HFTHEA              *                  Theatre
          MOVE      ZERO,HFMISC              *                  Miscellaneous
          MOVE      ZERO,DCFLAG             * Casemix daycase flag - no
          MOVE      ZERO,PCFLAG
          MOVE      ZERO,CRITDAYS
          MOVE      ZERO,CPAGENO
          MOVE      ZERO,PARTFLAG
          MOVE      ZERO,WRDTFLAG
          MOVE      ZERO,DYCHRGED
          MOVE      ZERO,BDAYS
          MOVE      ZERO,BTDAYS
          MOVE      ZERO,ERDTFLAG
          MOVE      ZERO,ECTRFLAG
          MOVE      ONE,TFEEIND              * Default to use theatre fee
          MOVE      THREE,PINVSYS
          MOVE      SP70,XBANDING
          MOVE      ZERO,RPRTFLAG
          MOVE      SP70,CMENDDTE
          MOVE      SP70,NPDCONTR
          MOVE      SP70,CQLDTMOV            * Current Qualified movement
          MOVE      SP70,SQLDTMOV            * Save Qualified movement
          MOVE      ZERO,FQLDFLAG
          MOVE      SP70,CMXCONTR
          MOVE      SP70,SAVBTYP
          MOVE      SP70,ACCMDESC
          MOVE      ZERO,SORTDONE
.
          MOVE      ZERO,STEPNO
          MOVE      ZERO,SAVETRN
          MOVE      ZERO,SAVTBEND
          MOVE      ZERO,PACMCHRG
          MOVE      ZERO,PITMCHRG
          MOVE      ONE,NUMBINVR             * default to one no of Inv.
.
          MOVE      ZERO,FDAY       
          MOVE      ZERO,FMON       
          MOVE      ZERO,FYEAR      
          MOVE      ZERO,FCENT      
          MOVE      ZERO,TDAY       
          MOVE      ZERO,TMON       
          MOVE      ZERO,TYEAR      
          MOVE      ZERO,TCENT      
.
          MOVE      ZERO,CDYSDAYS
          MOVE      ZERO,WCAREFLG
          MOVE      ZERO,XTRADAY             * Assume we aren't charging
.                                            * for the day of discharge
          MOVE      ZERO,TOTDISC 
          MOVE      ZERO,DOCTTOT 
          MOVE      ZERO,ROUNDAMT
          MOVE      ZERO,MBSCOUNT
          MOVE      SP70,HBCOFKEY            * High boundary cut off key
.
          CALL      INITIVAR                 * Initialise any special vari
          MOVE      ZERO,PMCCPODY           * pre op cut off days
          MOVE      ZERO,PMCCMIND           * Min stay
          MOVE      ZERO,PMCCHBPT           * Max stay/high boundary point
          MOVE      ZERO,PMCCCCDY           * critical care cut off days
          MOVE      ZERO,PMCCNPDY           * no pay days
          MOVE      ZERO,ABFFLAG            * ABF flag
          MOVE      ZERO,PREBFLAG
          MOVE      ZERO,COMFLAG
.
          MOVE      ZERO,ACDAYCS             * Assume not a day case
          PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
.
          MOVE      SP70,PMVXMHOS
          OPEN      PMSVX1A1,"pmsvx1af"
          PACK      KEY8,AADMNO
          CALL      RDPMVX11
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY8;*248,PTCNISBZ
          READ      CONTROLF,HUND03;*198,PTCNDAYB,*199,PTCNDAYL,*204,PTCNDAYG:
                                    *209,PTCNCHGL,*210,PTCNRDWN
          READ      CONTROLF,HUND09;*247,PTCNROUN
          READ      CONTROLF,HUND13;*50,OPCNCONS
          READ      CONTROLF,HUND14;*221,PTCNCALM
          READ      CONTROLF,FIFTY9;*210,PTMBSINV
          READ      CONTROLF,HUND24;*120,PTCNMVHC
          READ      CONTROLF,HUND29;*89,PTCNPPIN
.
          OPEN      PATVENA1,"patvenaf"
.
          MATCH     "1",PTCNPPIN      * New Patient Invoice functionality
          IF        @EQUAL
            OPEN      PATHTRA1,"pathtraf"
          ENDIF
.
.         Check for an outstanding debt
.
          IF        IBCNMHOS=1 
            MOVE      SP70,PTHSTFEE
            MOVE      SP70,PTHSPMBS
            MOVE      SP70,PTHSDCLM
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
          ENDIF
.
.         Get the starting accommodation date
.
          UNPACK    ALACDTE INTO XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,FDAY
          MOVE      XMON,FMON
          MOVE      XYEAR,FYEAR
          MOVE      XCENT,FCENT
.
.         If this is Patient Only invoice, only charge Accom.if no HF portion
.         set fromdate to Current date
.
          IF        (IPATFLAG=1 | IPATFLAG=2) & NCHACCOM=1
            MOVE      CDD,FDAY
            MOVE      CMM,FMON
            MOVE      CYY,FYEAR
            MOVE      CCC,FCENT
            GOTO      CCTB8000
          ENDIF
.
          MATCH     "1",PTCNPPIN      * New Patient Invoice functionality
          IF        @EQUAL
            CALL      CKPT0000      * Check if Patient invoice is raised
          ENDIF
          PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
.
.         Check for an outstanding debt
.
          MATCH     "00000000",ADATE
          GOTO      CCTB0800 IF NOT EQUAL
          MOVE      ALACDTE,FRDATE
          CALL      CDVC0000
          GOTO      CCTB9999
.
.         If there is no discharge date, use the current date as end date
.
CCTB0800  BRANCH    DISFLG OF CCTB1000
          MATCH     SP8,DDATE
          GOTO      CCTB2000 IF NOT EQUAL
.
CCTB1000  IF        BDTEFLAG=0
            MOVE      CDD,TDAY
            MOVE      CMM,TMON
            MOVE      CYY,TYEAR
            MOVE      CCC,TCENT
          ELSE
            UNPACK    BACKDATE,XCENT,XYEAR,XMON,XDAY
            MOVE      XDAY,TDAY
            MOVE      XMON,TMON
            MOVE      XYEAR,TYEAR
            MOVE      XCENT,TCENT
.           PACK      PINVDTE,XCENT,XYEAR,XMON,XDAY
.           REP       " 0",PINVDTE
          ENDIF
          GOTO      CCTB8000
.
CCTB2000  IF        BDTEFLAG=0
            UNPACK    DDATE INTO XCENT,XYEAR,XMON,XDAY
            MOVE      XDAY,TDAY
            MOVE      XMON,TMON
            MOVE      XYEAR,TYEAR
            MOVE      XCENT,TCENT
          ELSE
            MATCH     DDATE,BACKDATE
            IF        @LESS
              UNPACK    BACKDATE,XCENT,XYEAR,XMON,XDAY
              MOVE      XDAY,TDAY
              MOVE      XMON,TMON
              MOVE      XYEAR,TYEAR
              MOVE      XCENT,TCENT
.             PACK      PINVDTE,XCENT,XYEAR,XMON,XDAY
.             REP       " 0",PINVDTE
            ELSE
              UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
              MOVE      XDAY,TDAY
              MOVE      XMON,TMON
              MOVE      XYEAR,TYEAR
              MOVE      XCENT,TCENT
.             PACK      PINVDTE,XCENT,XYEAR,XMON,XDAY
.             REP       " 0",PINVDTE
            ENDIF
          ENDIF
.
.         Johns Hopkins will have the invoice date on the keyin date
.
CCTB8000  IF      CFEETYP=9 & BDTEFLAG=1
            UNPACK    BACKDATE,XCENT,XYEAR,XMON,XDAY
            MOVE      XDAY,TDAY
            MOVE      XMON,TMON
            MOVE      XYEAR,TYEAR
            MOVE      XCENT,TCENT
            PACK      PINVDTE,XCENT,XYEAR,XMON,XDAY
            REP       " 0",PINVDTE
          ENDIF
.
          CALL      FRSDAY00            * Check for 1st day of period
          CALL      CDVC0000
.
CCTB9999  RETURN
+
.*******************************************************************************
.     Workout the new billing date
.*******************************************************************************
CLDAY000  MOVE      TCENT,CC
          MOVE      TYEAR,YY
          MOVE      TMON,MM
          MOVE      TDAY,DD
          CALL      DMYCON
          SUB       MVDAYS,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
CLDAY999  RETURN
+
.*******************************************************************************
.         Check for a day case
.*******************************************************************************
CDVC0000  MATCH     "00000000",ADATE
          GOTO      CDVC4300 IF EQUAL
.
          MATCH     ADATE,DDATE
          GOTO      CDVC4000 IF EQUAL
.
.         Calculate julian dates
.
          MOVE      ONE,AELIG
.
          PACK      CKYIDEF8,FCENT,FYEAR,FMON,FDAY
          REP       " 0",CKYIDEF8
.
          PACK      DCCYY,FCENT,FYEAR
          REP       " 0",DCCYY
          MOVE      DCCYY,FRCCYY
.
          PACK      KEY8,TCENT,TYEAR,TMON,TDAY
          REP       " 0",KEY8
.
          PACK      DCCYY,TCENT,TYEAR
          REP       " 0",DCCYY
          MOVE      DCCYY,TOCCYY
.
          DAYSEP    CKYIDEF8,KEY8,TOTDAYS
.
          COMPARE   FRCCYY,TOCCYY
          GOTO      CDVC4300 IF LESS
.
.         Check claim type if discharge invoice has NOT been printed
.
CDVC2000  BRANCH    ADSCHI OF CDVC3000
.
.         We now check for a W/Care claim with Xtra day charging
.
          PACK      KEY5 WITH CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD OF CDVC5000
.
.         Loop over the indicators - we're looking for a W and an X
.
          MOVE      SP2,DIM2
.
          MOVE      ZERO,FORM2
CDVC2200  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CDVC2600 IF EQUAL
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      CDVC2300 IF EQUAL
.
          CMATCH    "X",ANS
          GOTO      CDVC2400 IF EQUAL
.
          GOTO      CDVC2200
.
CDVC2300  RESET     DIM2,1
          CMOVE     "W",DIM2
          GOTO      CDVC2200
.
CDVC2400  RESET     DIM2,2
          CMOVE     "X",DIM2
          GOTO      CDVC2200
.
.         We have finished the scan over the indicators.
.
CDVC2600  RESET     DIM2
          MATCH     "WX",DIM2
          GOTO      CDVC2800 IF NOT EQUAL
.
          MOVE      ONE,XTRADAY    * Charge an extra day for day of discharge
.
          COMPARE   THREE,ASTAT
          GOTO      CDVC3000 IF NOT EQUAL
.
          MOVE      ONE,WCAREFLG   * Flag for Workcare patient
          ADD       XTRADAY,TOTDAYS
          GOTO      CDVC3000
.
CDVC2800  IF        (IPATFLAG=1 | IPATFLAG=2) & NCHACCOM=1
            GOTO      CDVC3000        * No accommodation charge for Pat.Invoice
          ENDIF
          CALL      CDSC0000          * Check if discharge day to be charged
.
.         Set eligabilty indicator
.
CDVC3000  MATCH     "0" TO ACLAIM
          GOTO      CDVC3200 IF EQUAL
          MATCH     " " TO ACLAIM
          GOTO      CDVC3400 IF NOT EQUAL
.
CDVC3200  MATCH     "2" TO PTYPE
          GOTO      CDVC3400 IF EQUAL
          GOTO      CDVC5000
.
CDVC3400  MOVE      TWO TO AELIG
          MOVE      ZERO TO STRATEG
          GOTO      CDVC5000
.
.         Day Case:
.         --------
.         Check if there is an accommodation record for same day invoice. If so
.         don't print another one
.
CDVC4000  MOVE      ONE,ACDAYCS        * This is a day case
.
          IF        (IPATFLAG=1 | IPATFLAG=2) & NCHACCOM=1
            GOTO      CDVC4300         * Do not charge Accommodation
          ENDIF
.
          COMPARE   ZERO,AINVPRT
          GOTO      CDVC4200 IF EQUAL  * Discharge invoice not printed yet
.
          CALL      CHKACCM0           * Check if accommodation has been charged
          BRANCH    EXIT,CDVC4300      * Found accommodation record
.
CDVC4200  MOVE      ONE,TOTDAYS
          MOVE      TWO,AELIG
          MOVE      ZERO,STRATEG
.
          GOTO      CDVC4500
.
CDVC4300  MOVE      ZERO,TOTDAYS       * Has already been charged
.
.         For day cases ( or no accommodation range ) use from-date as to-date
.
CDVC4500  MOVE      FDAY,TDAY
          MOVE      FMON,TMON
          MOVE      FYEAR,TYEAR
          MOVE      FCENT,TCENT
.
.         Set the claim type indicator if this is a claim
.
CDVC5000  MOVE      ZERO,CLAIM
          PACK      KEY5 WITH CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD OF CDVC8000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
CDVC5200  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CDVC8000 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      CDVC6000 IF EQUAL
.
          CMATCH    "M",ANS
          GOTO      CDVC6000 IF EQUAL
.
          CMATCH    "V",ANS
          GOTO      CDVC6000 IF EQUAL
.
          CMATCH    "D",ANS
          GOTO      CDVC6000 IF EQUAL         * Defence force
.
          GOTO      CDVC5200
.
.         We have a claim
.
CDVC6000  REP       "W1M2V3D4",ANS
          MOVE      ANS,CLAIM
.
.         Decide if to accumulate total, display date range, or whatever
.
CDVC8000  BRANCH    PROGFLAG OF CDVC8400,CDVC9999,CDVC9999,CDVC8200
          COMPARE   SEVEN,PROGFLAG
          GOTO      CDVC8700 IF EQUAL         * Workout a payer Accom.only
          GOTO      CDVC9999
.
.         Make sure the invoice date has been set to the current date
.
CDVC8200  PACK    PINVDTE WITH CCC,CYY,CMM,CDD
          REP     " 0",PINVDTE
.
CDVC8400  
          IF        PREBFLAG=1 & DBSFLAG=0 & ISBLFLAG=0
            CALL      RBINV000      * Printing Rebate invoice
            GOTO      CDVC9999
          ENDIF
.
          IF        CFEETYP=5
            CALL      NZINV000                * NZ Private Invoice (NZPCATBI)
          ELSE
            CALL      DLINE1                  * Standard & JH Invoice
          ENDIF
          GOTO      CDVC9999
.
CDVC8700  CALL      ISAC0000                  * Independent Services billing
.
CDVC9999  RETURN
+
.*******************************************************************************
.         Check if Discharge day need to be charged
.*******************************************************************************
CDSC0000  MOVE      ZERO,PARTFLAG
          COMPARE   THREE,ASTAT
          GOTO      CDSC9999 IF NOT EQUAL
.
.         Do not charge extra day if date for backdate invoice is prior disc.
.
          IF        BDTEFLAG=1
            MATCH     BACKDATE,DDATE
            GOTO      CDSC9999 IF NOT EQUAL
          ENDIF
.
          REP       " 0",PTCNDAYB
          MATCH     "1",PTCNDAYB
          GOTO      CDSC4000 IF EQUAL         * Full charge on discharge
.
          MATCH     "2",PTCNDAYB
          GOTO      CDSC9999 IF NOT EQUAL     * No charge on discharge
.
.         For partial charge, check the discharge time
.         If Discharge time is less than the parameter, then no charge
.
          REP       " 0",DTIME
          MATCH     DTIME,PTCNDAYL
          GOTO      CDSC9999 IF NOT LESS      * No Charge
.
          MATCH     DTIME,PTCNDAYG
          GOTO      CDSC4000 IF LESS          * Charge full fees
.
          MOVE      ONE,PARTFLAG              * Flag for partial charge
          GOTO      CDSC9999
.
.         Full charge
.
CDSC4000  MOVE      ONE,XTRADAY    * Charge an extra day for day of discharge
CDSC9999  RETURN
+
.*******************************************************************************
.         This is the main section of this include - it does the actual
.         work of calculating the body of the invoice
.*******************************************************************************
DLINE1    CALL     INVR0000                  * Initialise variables
.
          MATCH    "IBAHMS70",PRGID                                    *I-90234
          GOTO     DLNE0300 IF EQUAL                                   *I-90234
.
          MOVE     AADMNO,KEY8
          CALL     RDMISS1             * restore admission detail for Casemix
          BRANCH   OVRCD,DLNE9999
.
          BRANCH   ASTAT,DLNE9999     * Preadmission - no invoice pending
          COMPARE  FIVE,ASTAT
          GOTO     DLNE9999 IF EQUAL   * Cancel admission - no invoice pending
.
          MOVE     SP70,PMVXMHOS
          OPEN     PMSVX1A1,"pmsvx1af"
          PACK     KEY8,AADMNO
          CALL     RDPMVX11
.
          PACK     KEY9,ACLAIM,AFUNDH,SP70
          CALL     GETCNEFF               * Get Contract Effective From
.
DLNE0300  MOVE     AADMNO,TADMN                                        *C-90234
          PACK     IDATEF WITH FCENT,FYEAR,FMON,FDAY
          REP      " 0",IDATEF
          PACK     SIDATET,SP20
          PACK     IDATET,SP20
          MOVE     ZERO,LOWFLAG        * set flag to high outliers
          MOVE     SP70,CMENDDTE
.
. ----- Get GST stuff -----
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,NINTY8;*130,PTCNAGST
          CALL      AGST0000                * Get GST Accommodation if applicabl
          MOVE      IBGEAMNT,GSTPCEN        * Save GST accommodation rate
.
. ----- Check if chargeable theatre fees
.
          MOVE      ZERO,CMBSFEE
          READ      CONTROLF,HUND05;*177,PTCNTFEE       * Using theatre fees
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "1",TCINDC1
            IF        @EQUAL
              CMATCH    "1",TCINDC2
              IF        @EQUAL
                MOVE      ONE,CMBSFEE
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,WEBFLAG
          MATCH     "IBARSH",PGM
          IF        @EQUAL
            MOVE      ONE,WEBFLAG
          ENDIF
          MATCH     "PATWEB71",PRGID
          IF        @EQUAL
            MOVE      ONE,WEBFLAG
          ENDIF
          MATCH     "IBAADT09",PRGID
          GOTO      DLNE0304 IF EQUAL
.
          MATCH     "1",PTCNPPIN     * Using Patient Invoice functioanlity
          IF        @EQUAL
.
.         if we are print Discharge billing statement, check if Patient invoice
.         has been raised (PREBFLAG=1)
.
            IF        PREBFLAG=1 & DBSFLAG=1
              GOTO      DLNE8900
            ENDIF
          ENDIF
.
          BRANCH    ISBLFLAG,DLNE0304
.
          CALL      UABF0000
          BRANCH    EXIT,DLNE0304,DLNE9500,DLNE8900
          GOTO      DLNE9000
.
. ----- Get the casemix code -----
.
DLNE0304  MOVE      ZERO,EXIT
          UNPACK    SP20,CMCODE,CMDRG
          MOVE      ADATE,CMSTRTDT
.
          COMPARE   FIVE,PROGFLAG
          GOTO      DLNE1000 IF EQUAL       * Estimate invoice - not C/P
.
          MATCH     "IBAHMS70",PRGID
          IF        !@EQUAL
            CALL      ICDS0000              * Check for ICD10 Suggested Class.
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          GOTO      DLNE1000 IF NOT EQUAL   * Not charging casemix, use perdiem
.
          PACK      CMCODE,PTMIPCMX,SP10    * Default casemix code to prov DRG
          PACK      CMDRG,PTMIPCMX,SP10
.
.         If Continous billing is set to Yes and Casemix code is entered
.         charge the daily charge of Casepayment with no Lumpsum
.
          COMPARE   THREE,ASTAT
          GOTO      DLNE0310 IF NOT EQUAL   * Not discharged
          MATCH     "1",PTMICONB            * Continuous billing?
          GOTO      DLNE0310 IF NOT EQUAL
          MATCH     SP70,PTMIPCMX
          GOTO      DLNE0310 IF EQUAL
.
          MOVE      ONE,CMXFLAG             * set to Casepayment
.         GOTO      DLNE0318
.
DLNE0310  MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,CODECL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,CONTRCID
          CALL      CMXMATRX                * Check if a matrix record exists
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1             * restore health fund fields
.
          MATCH     SP70,CONTRCID
          GOTO      DLNE0320 IF NOT EQUAL
.
          BRANCH    PROGFLAG,DLNE0312   * calculate to be invoiced
          COMPARE   FOUR,PROGFLAG
          GOTO      DLNE0312 IF EQUAL
          COMPARE   TWO,PROGFLAG
          GOTO      DLNE1000 IF NOT EQUAL
.
DLNE0312
.         COMPARE   THREE,ASTAT
.         GOTO      DLNE1000 IF EQUAL    * charge per-diem
.
          IF        ASTAT=3
            MATCH     "1",PTMICONB            * Continuous billing?
            IF        @EQUAL
             MATCH     SP70,PTMIPCMX
             IF        !@EQUAL
               PACK      CMCODE,PTMIPCMX,SP10    * Default casemix to prov DRG
               PACK      CMDRG,PTMIPCMX,SP10
               MOVE      ONE,CMXFLAG             * set to Casepayment
             ENDIF
           ENDIF
          ENDIF
.
          MATCH     SP70,CMCODE
          GOTO      DLNE1000 IF EQUAL    * charge per-diem
.
DLNE0318  PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          CALL      VALCMXFN           * find Contract ID for the prov.code
          MATCH     SP70,CONTRCID
          GOTO      DLNE0330 IF NOT EQUAL
.
          MOVE      ZERO,CMXFLAG
.         IF        WEBFLAG=1
.           WRITE     HTMLFILE;"<tr><center><b>No Contract for ":
.                            "Provisional Casemix code: </b>":
.                            CMCODE,"</center></tr>";
.         ENDIF
          GOTO      DLNE1000
.
DLNE0320  CALL      CHKCMXPT           * Check Casemix funding
.
DLNE0330  IF        CMXFLAG=1
            MOVE      CONTRCID,SAVCONTR
            MOVE      CONTRCID,NPDCONTR
            CALL      CAPAT000                * Set NUMBINVR flag
          ENDIF
.
          IF        (IPATFLAG=1 | IPATFLAG=2) & NCHACCOM=1
            GOTO      DLNE8900              * Not charge Accom.for Pat.Invoice
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MATCH     SP70,CMCODE
            IF        !@EQUAL
              COMPARE   ZERO,CMXFLAG
              GOTO      DLNE0380 IF EQUAL   * not funded
            ENDIF
          ENDIF
.
          BRANCH    CMXFLAG,DLNE3000
.
DLNE0380  COMPARE   TWO,PROGFLAG
          GOTO      DLNE1000 IF NOT EQUAL
.
          COMPARE   ONE,WEBFLAG
          GOTO      DLNE1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><center><b>Patient will not":
                           " be funded by casemix funding. </b>":
                           CMCODE,"</center></tr>";
.
DLNE1000  MOVE      ZERO,CMXFLAG            * Charge perdiem
          MOVE      ONE,PCFLAG              * Charge perdiem
          UNPACK    SP20,CMCODE,CMDRG
.
.         IBAADT09 - lumpsum revenue breakdown only for casepayment
.
          MATCH     "IBAADT09",PRGID
          GOTO      DLNE9999 IF EQUAL
          GOTO      DLNE4000
.
DLNE3000  IF        CMXFLAG=1
            OPEN      CONTROLF,"controlf"
            READ      CONTROLF,HUND10;*229,PTCNMVCP
            IF        PTCNMVCP=1
              CALL      CMVDY000            * calculate mv days
              CALL      CLDAY000
              PACK      LDATE,CC,YY,MM,DD
              REP       " 0",LDATE          * end date to calculate LOS
.
              IF        MVBFLAG=1
                CALL      CCIN0000            * Check for Critical bed days
                MATCH     SP70,MVENSDAT
                IF        @EQUAL
                  CALL      SMVD0000            * Set up Mechanical Vent. period
                ELSE
                  CALL      SVVD0000            * Set up Mechanical Vent. period
                ENDIF
              ENDIF
.
            ENDIF
          ENDIF
.
          CALL      CTDY0000                * check cut off days
.         CALL      CHRB0000                * Check if revenue breakdown exists
.
DLNE4000  MOVE     SP70,STMVDATE
          MOVE     SP70,ENMVDATE
          MOVE     ZERO,MVPFLAG
          MOVE     ZERO,ENDFLAG
.
          MOVE     ZERO,PATLNTOT
          MOVE     ZERO,PATLNGST
          MOVE     ZERO,PATLRATE
.
          MOVE     ZERO,OVERPFL
          MOVE     SP10,A8DATE
          MOVE     SP10,B8DATE
          MOVE     ZERO,TRNFLAG
          MOVE     SP70,PREVTMOV
          MOVE     SP70,PREVTDAT
          MOVE     ZERO,NOSTDOWN
          MOVE     ZERO,FRSTACCM
          MOVE     ZERO,FNDFLAG
          MOVE     SP70,NPDBTYPE
          MOVE     SP70,CSMATYPE
.
          UNPACK   IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
          PACK     KEY30 WITH AADMNO,SP70
          CALL     RDSTRAN2
DLNE5000  CALL     RDKTRAN2
          BRANCH   OVRCD OF DLNE8400
.
          MATCH    TADMN,AADMNO
          GOTO     DLNE8400 IF NOT EQUAL
.
          MOVE     TRBEND,SAVTBEND
          MOVE     DAYNUM,SDAYNUM
          MOVE     ZERO,FNDFLAG
.
.         Check if we are in MV period
.
          IF       MVPFLAG=1
            MATCH     "L",STMOVE
            GOTO      DLNE5020 IF EQUAL
.
            MOVE      SAVBTYP,SDIM3         * save bed type
            CALL      PATCMSTP              * Generate casemix stepdown
            BRANCH    NOFEE,DLNE5020
.
.           If we are using MV details (patvenaf) check if we have a Transfer
.           record on MV date
.
            MATCH     SP70,MVENSDAT
            IF        !@EQUAL
              CALL      MVTR0000            * Check Transfer record on MV date
              IF        MVTRNFLG=1
                MOVE      D8,IDATET
                GOTO      DLNE5002
              ENDIF
              GOTO      DLNE5010
            ELSE
              MATCH     TDATE,STMVDATE
              GOTO      DLNE5010 IF NOT LESS
.
              MATCH     TDATE,ENMVDATE
              GOTO      DLNE5010 IF LESS
              MOVE      STMVDATE,IDATET
            ENDIF
.
.           Display ICU accomm. with NO MV days
.
DLNE5002    MOVE      IDATET,SIDATET
            MATCH     IDATEF,IDATET
            CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
            MOVE      ZERO,PATLNTOT
            MOVE      ZERO,PATLNGST
            MOVE      ZERO,PATARATE
            MOVE      ZERO,PATHRATE
            MOVE      ZERO,PATLRATE
            MOVE      ZERO,FNDLRATE
.
            MOVE      ZERO,LINETOT
            MOVE      ZERO,LINEGST
            MOVE      ZERO,LSTRATE
           
            MOVE      ZERO,SPTTRADP
            MOVE      ZERO,SPTTRADR
            MOVE      ZERO,STRATEF
            MOVE      ZERO,STRATEH
.
            MOVE      ENMVDATE,IDATET
            MOVE      IDATET,SIDATET
            MOVE      IDATET,TDATE
.
.           Display ICU MV accommodation charge
.
            MOVE      ONE,ENDFLAG
            MATCH     IDATEF,IDATET
            CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
            MOVE      ZERO,ENDFLAG
.
.           re-generate both daily and additional rate after MV
.
            MOVE      THREE,STEPFLAG      * set to generate both rates
            MOVE      ZERO,NBRDAYS
.
            UNPACK    SFDT1,XCENT,XYEAR,XMON,XDAY
            MOVE      XCENT,CC
            MOVE      XYEAR,YY
            MOVE      XMON,MM
            MOVE      XDAY,DD
            CALL      DMYCON
.           ADD       DAYNUM,JULDAY
            ADD       NODAYS,JULDAY            * MV days
            MOVE      JULDAY,JWKDAY
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON
.
            MOVE      SFDT1,XDATE       * save the fromdate
.
            PACK      STDATE,CC,YY,MM,DD
            REP       " 0",STDATE
            MOVE      STDATE,SFDT1
            MOVE      STDATE,FRDATE
.
            DAYSEP    STDATE,TDATE,NBRDAYS
            IF        NBRDAYS>=0
              MOVE      DAYNUM,BDAYS    * move in any pre-'L'eave bed-days
              ADD       NBRDAYS,BDAYS   * days from prev.trans date to current
              CALL      GDAI0000        * Get new rates
.
              IF        MVTRNFLG=1
                 MOVE      TRATEF,LSTRATE
                 ADD       TRATEH,LSTRATE
                 ADD       PTTRADPT,LSTRATE        * patient additional charge
                 ADD       PTTRADRB,LSTRATE        * rebate additional charge
                 MOVE      PTTRADPT,PATARATE       * Patient daily add on rate
                 MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
.
                 MOVE      TRATEF,PATLRATE
                 ADD       PTTRADPT,PATLRATE       * patient additional charge
                 MOVE      TRATEH,FNDLRATE
                 ADD       PTTRADRB,FNDLRATE       * rebate additional charge
.
                 MOVE      SP70,MVENSDAT
                 MOVE      SP70,MVENEDAT
                 MOVE      ZERO,MVTRNFLG
                 MOVE      ZERO,MVPFLAG
              ENDIF
            ELSE
              MOVE      XDATE,SFDT1     * restore SFDT1
              MOVE      XDATE,FRDATE
.
              MATCH     "L",TMOVE
              IF        @EQUAL
                MOVE      SDAYNUM,DAYNUM * restore DAYNUM(LMOV00 changed DAYNUM)
              ENDIF
            ENDIF
.
            MOVE      SP70,STMVDATE
            MOVE      SP70,ENMVDATE
            PACK      KEY30,AADMNO,TDATE,SP70
            CALL      RDSTRAN2
            GOTO      DLNE5000
.
          ENDIF
          GOTO     DLNE5020
.
DLNE5010  MATCH    "L",TMOVE
          GOTO     DLNE5020 IF NOT EQUAL
.
.         Check if for Leave and Return on the same day
.
          CALL      CHGR0000            * Check the next trans record
.
DLNE5020  MOVE     SDAYNUM,DAYNUM       * Restore Start day of Inlier
          MATCH    SP70,IDATET
          IF       !@EQUAL
            MATCH    IDATET,TDATE
            GOTO     DLNE5030 IF LESS
          ENDIF
          CALL     CKMV0000
.
DLNE5030  MOVE     TMOVE,PREVTMOV
          MOVE     TDATE,PREVTDAT
          MATCH    SP70,PMSGCLSS
          IF       !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
          PACK     SKEY30 WITH TADMN,TDATE,TTIME,TWARD,TBED      * moved up
          MATCH    ANSA,TMOVE
          GOTO     DLNE5200 IF EQUAL
.
          MATCH     "L",TMOVE
          IF        @EQUAL
            MOVE      TDATE,SAVTDTE
            MOVE      TWARD,SAVTWARD
            MOVE      TBED,SAVTBED
            MOVE      TRBTYP,SAVBDTYP
.
            PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
DLNE5100    CALL      RDKTRAN2
            BRANCH    OVRCD,DLNE5110
.
            MATCH     DTADMN,DAADMNO
            GOTO      DLNE5110 IF NOT EQUAL
.
            MATCH     "R",TMOVE
            GOTO      DLNE5100 IF NOT EQUAL
.
            MATCH     TDATE,SAVTDTE
            GOTO      DLNE5110 IF NOT EQUAL
.
            MATCH     TWARD,SAVTWARD
            GOTO      DLNE5110 IF NOT EQUAL
.
            MATCH     TBED,SAVTBED
            GOTO      DLNE5110 IF NOT EQUAL
.
            MATCH     TRBTYP,SAVBDTYP
            GOTO      DLNE5110 IF NOT EQUAL
.
            PACK      KEY30,SVKEY30,SP70
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
.
            GOTO      DLNE5000
.
DLNE5110    PACK      KEY30,SVKEY30,SP70
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
.
          ENDIF
.
          MATCH     "R",TMOVE
          IF        @EQUAL
            MOVE      TDATE,SAVTDTE
            MOVE      TWARD,SAVTWARD
            MOVE      TBED,SAVTBED
            MOVE      TRBTYP,SAVBDTYP
.
            PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
DLNE5150    CALL      RDPTRAN2
            BRANCH    OVRCD,DLNE5160
.
            MATCH     DTADMN,DAADMNO
            GOTO      DLNE5160 IF NOT EQUAL
.
            MATCH     "L",TMOVE
            GOTO      DLNE5150 IF NOT EQUAL
.
            MATCH     TDATE,SAVTDTE
            GOTO      DLNE5160 IF NOT EQUAL
.
            MATCH     TWARD,SAVTWARD
            GOTO      DLNE5160 IF NOT EQUAL
.
            MATCH     TBED,SAVTBED
            GOTO      DLNE5160 IF NOT EQUAL
.
            MATCH     TRBTYP,SAVBDTYP
            GOTO      DLNE5160 IF NOT EQUAL
.
            PACK      KEY30,SVKEY30,SP70
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
.
            GOTO      DLNE5000
.
DLNE5160    PACK      KEY30,SVKEY30,SP70
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
.
          ENDIF
.
.         Ignore any Doctor Change record in Transfer file
.         as Changing doctor should not change rates
.
          MATCH     ANSC,TMOVE
          GOTO      DLNE5200 IF NOT EQUAL
.
          MATCH     TADOCT,STADOCT
          GOTO      DLNE5200 IF EQUAL
.
          MATCH     TATYPE,STATYPE
          GOTO      DLNE5200 IF NOT EQUAL * Changed of adm.type
          MATCH     TRBTYP,STRBTYP
          GOTO      DLNE5200 IF NOT EQUAL * Changed of bed type
.
          MATCH     "01:00:00",TTIME
          GOTO      DLNE5200 IF EQUAL     * Stepdown record
.
          BRANCH    PTTREPSD,DLNE5200     * Force stepdown
.
          MOVE      TADOCT,STADOCT
          GOTO      DLNE5000              * Ignore doctor change record
.
DLNE5200  MOVE     TDATE,A8DATE
.
.         TMOVE means
.            A=Admitted
.            D=Discharged
.            C=Changed Details
.            L=Leave Hospital
.            R=Return to Hospital
.
          BRANCH   PCFLAG,DLNE5800,DLNE5800,DLNE5800 *1=patcat 2=patcat &casemix
          GOTO     DLNE5600
.
.         Casemix funding
.
DLNE5600  COMPARE   ZERO,LUMPFLAG
          GOTO      DLNE5630 IF EQUAL
.
          CMATCH    ANSA,TMOVE
          GOTO      DLNE5700 IF NOT EQUAL
.
DLNE5630  MOVE      ONE,LUMPFLAG
          UNPACK    ALACDTE INTO XCENT,XYEAR,XMON,XDAY
          PACK      IDATEF WITH XCENT,XYEAR,XMON,XDAY  * reset the dates
          REP       " 0",IDATEF
          PACK      SIDATET,SP20
          MOVE      TATYPE,SAVATYP
.
          MOVE      ZERO,DCFLAG
          MATCH     ADATE,DDATE         * check for daycase
          IF        @EQUAL
            MOVE      ONE,DCFLAG
            GOTO      DLNE5650
          ENDIF
.
.
          MOVE      ZERO,PATLNTOT
          MOVE      ZERO,PATLNGST
.
          MOVE      ZERO,LOWFLAG        * set flag to high outliers
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
.
          COMPARE   THREE,ASTAT
          GOTO      DLNE5650 IF NOT EQUAL
.
.         Get the length of stay
.
          MOVE      ADATE,FROMDATE
          IF        MVBFLAG=1
            MOVE      LDATE,TODATE      * don't include any mechv days
          ELSE
            MOVE      DDATE,TODATE
          ENDIF
          CALL      NHOSPDAY
          ADD       ONE,NBRDAYS
          ADD       ADYHOSP,NBRDAYS
.
          MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2
.
          IF        NPDAYFLG=2
            MATCH     SP70,CSMATYPE
            IF        !@EQUAL
              MOVE      CSMATYPE,TATYPE
            ENDIF
          ENDIF
.
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
.         check if it's outliers or inliers
.
          CALL      GTAB0000            * get table type
          CALL      OLUM0000            * Read lumpsum overnight
          MOVE      PTHLNINV,NUMINVS
          MOVE      PTHLNINV,TNINVS
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            MOVE      NUMBINVR,NUMINVS  * No of Invoice from contract
            MOVE      NUMBINVR,TNINVS
          ENDIF
.
.         check low outlier, exclude any unqualified bed days
.
          MOVE      NBRDAYS,F4          * save current no of bed days
          MOVE      ZERO,FORM4
          MOVE      "U",SAVIND12
          PROC      PATDATYP            * Get LOS for Unqualified days
          IF        NBRDAYS>0
            MOVE      NBRDAYS,FORM4
          ENDIF
          MOVE      F4,NBRDAYS
          SUB       FORM4,NBRDAYS         * subtract unqualified days
.
.
          IF        NBRDAYS <= PTHLCOFF
            MOVE      ZERO,PTTRLSPT
            MOVE      ZERO,PTTRLSRB       * no lumpsum
            MOVE      ONE,LOWFLAG         * set flag to low outliers
          ELSE
            MOVE      PTHLLPAT,PTTRLSPT
            MOVE      PTHLLREB,PTTRLSRB
          ENDIF
.
          MOVE      PTTRLSPT,SPTTRLSP
          MOVE      PTTRLSRB,SPTTRLSR
.
          IF        NBRDAYS <= PTHLCOFF
            MOVE      F4,NBRDAYS            * Restore back no of bed days
            GOTO      DLNE5700
          ENDIF
          MOVE      F4,NBRDAYS            * Restore back no of bed days
.
DLNE5650  COMPARE   ZERO,AINVPRT        *Check if this is the first invoice
          GOTO      DLNE5680 IF EQUAL
.
          CALL      CHKACCM0           * Check if accom.has been charged
          IF        EXIT=1
            MOVE      ZERO,SPTTRLSP
            MOVE      ZERO,SPTTRLSR
            GOTO      DLNE5700         * Found accommodation record
          ENDIF
.
DLNE5680  PACK      DIM30,DTADMN,TDATE,TTIME,TWARD,TBED
          IF        DBSFLAG=1
            CALL      LSDB0000            * print/display lumpsum for Disc.Bill.
          ELSE
            CALL      GLUM0000            *print/display lumpsum amount
            IF        DCFLAG=1
              MOVE      ONE,TOTDAYS       * Daycase casemix only has lumpsum
            ENDIF
          ENDIF
          IF        PROGFLAG=2
            MOVE      SP70,PTDTDES2
          ENDIF
          MOVE      DIM30,KEY30
          CALL      RDTRAN2
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE       PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
DLNE5700  IF        NPDAYFLG=2
            MOVE      ANSA,TMOVE
            PACK      SAVDATE,FCENT1,FYEAR1,FMON1,FDAY1
            REP       " 0",SAVDATE
            MOVE      SAVDATE,TDATE
            MOVE      SAVDATE,PCENDDTE
.           MOVE      PCENDDTE,TDATE      * generate casemix from pcenddte
            MOVE      PCENDDTE,IDATEF
            MOVE      ONE,NPDAYFLG
          ENDIF
.
          COMPARE   ONE,CMXFLAG
          GOTO      DLNE6000 IF NOT EQUAL
.
.         daycase patients , display DC rate
.
          BRANCH    DCFLAG,DLNE5740       * daycase
.
          CALL      PATCMSTP              * Generate casemix stepdown
          BRANCH    NOFEE,DLNE6000
.
          COMPARE   ONE,MVPFLAG
          GOTO      DLNE5720 IF NOT EQUAL * Not in MV period
.
          MATCH     TDATE,STMVDATE
          GOTO      DLNE5720 IF NOT LESS
          MATCH     ENMVDATE,TDATE
          GOTO      DLNE5720 IF NOT LESS
.
          MOVE      ENMVDATE,TDATE
          MOVE      ZERO,TRATEF
          MOVE      ZERO,TRATEH
          MOVE      ZERO,PTTRADPT
          MOVE      ZERO,PTTRADRB
.
DLNE5720  IF        TRNFLAG <>1
            MOVE      A8DATE,B8DATE
          ENDIF
          MOVE      ZERO,TRNFLAG
          GOTO      DLNE6000
.
DLNE5740  MOVE      TRBTYP,SAVBTYP
          GOTO      DLNE8000
.
.         Normal rates
.
DLNE5800  IF        PCFLAG=1 | PCFLAG=3
            GOTO      DLNE5900              * revert to patcat
          ENDIF
.
.         pcflag=2 - patcat, then casemix 
.
          COMPARE   ONE,CSTDOWN
          GOTO      DLNE5600 IF NOT EQUAL   * no stepdown
          COMPARE   ZERO,CFEETYP
          GOTO      DLNE5600 IF NOT EQUAL   * not using bed fees
.
.         Generate patcat from adate to pcenddte
.
          BRANCH    NPDAYFLG,DLNE5870       * generate stepdown
.
          MOVE      NPDCONTR,CONTRCID       * Casepayment Contract ID
          MOVE      NPDCONTR,SAVCONTR
          MOVE      "C",TMOVE
          MOVE      CMSTRTDT,TDATE
          MOVE      PCENDDTE,SAVDATE
          MOVE      PCENDDTE,IDATEF
          MOVE      ONE,CMXFLAG
          MOVE      ZERO,PCFLAG        * set flag to charge casemix
          MOVE      TWO,NPDAYFLG
          MOVE      CMSTRTDT,IDATET
          GOTO      DLNE7400
.
.         Generate stepdown bed fees prior casemix
.
DLNE5870  MOVE      ZERO,CMXFLAG
DLNE5900  COMPARE   ONE,CSTDOWN
          GOTO      DLNE6000 IF NOT EQUAL
          COMPARE   ZERO,CFEETYP
          GOTO      DLNE6000 IF NOT EQUAL
.
.         Check if Contract ID End date
.
          MATCH     SP70,CMENDDTE
          GOTO      DLNE5920 IF EQUAL
.
          CMATCH    "R",TMOVE
          GOTO      DLNE5920 IF EQUAL          * Return from leave
.
          MATCH     IDATET,CMENDDTE
          GOTO      DLNE5920 IF EQUAL
          MATCH     IDATEF,CMENDDTE
          GOTO      DLNE5910 IF LESS       * Contract Ends b/f Invoice startdate
.
.         Check if there is a stepdown due before the end of New contract
.
          MATCH     TDATE,CMENDDTE
          GOTO      DLNE5920 IF NOT LESS
.
          MOVE      ZERO,NBRDAYS
          DAYSEP    FRDATE,CMENDDTE,NBRDAYS
          MATCH     FRDATE,ADATE
          IF        @EQUAL
            ADD        ADYHOSP,NBRDAYS
          ENDIF
          COMPARE   NBRDAYS,CURMDAYS
          GOTO      DLNE5920 IF LESS
.
          CALL      RDPTRAN2      * read previous record
          BRANCH    OVRCD,DLNE8900
.
          MATCH     AADMNO,TADMN
          GOTO      DLNE8900 IF NOT EQUAL
.
          MOVE      ONE,FNDFLAG        * found a stepdown prior end of Contract
.
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE     * Use ICD10 Suggested Class.
          ENDIF
          MOVE      ANSC,TMOVE
          IF        BDTEFLAG=1
            MATCH     BACKDATE,IDATEF
            GOTO      DLNE5920 IF NOT LESS       * Inv.from date>Invoice enddate
            MATCH     CMENDDTE,BACKDATE
            IF        @LESS
              MATCH     IDATEF,IDATET
              CALL      FNDT0000 IF NOT LESS
              GOTO      DLNE8900
            ENDIF
          ENDIF
.
          MOVE      ZERO,STEPNO
          MOVE      CMENDDTE,TDATE
          MOVE      CMENDDTE,IDATET
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS   * Accom.record till end of Contract
          MOVE      TWO,STEPNO             * for GETACCM not to use STRBEND
.
.         Get bed fees from the start of New Contract
.
          MOVE      CMENDDTE,DATFIELD
          MOVE      ZERO,TEMPDAY
          CALL      SCTR0000
          IF        NOFEE=1
            CALL      RDKTRAN2          * read next record
            BRANCH    OVRCD,DLNE8900
.
            MATCH     AADMNO,TADMN
            GOTO      DLNE8900 IF NOT EQUAL
.
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE     * Use ICD10 Suggested Class.
            ENDIF
            MOVE      PREVTDAT,TDATE
            MOVE      PREVTDAT,SAVDATE
            CALL      SAVARB
            GOTO      DLNE6000
          ENDIF
          GOTO      DLNE5920
.
.         If this is an interim invoice, check if a new Contract applied
.
DLNE5910  COMPARE   ZERO,FRSTACCM
          GOTO      DLNE5920 IF NOT EQUAL      * Not the first Acc.line
          COMPARE   ZERO,AINVPRT
          GOTO      DLNE5920 IF EQUAL          * Not an interim invoice
.
          MOVE      ADYHOSP,TEMPDAY
          MOVE      ZERO,NBRDAYS
          DAYSEP    FRDATE,IDATEF,NBRDAYS
          ADD       NBRDAYS,TEMPDAY
          ADD       ONE,TEMPDAY
          MOVE      IDATEF,CEFFDATE
.
          IF        PTTREPSD=1
            MOVE      PTTRADPT,SPTTRADP
            MOVE      PTTRADRB,SPTTRADR
            MOVE      TRATEF,STRATEF
            MOVE      TRATEH,STRATEH
          ENDIF
.
          CALL      GETBFE
          IF        NOFEE=1
            MOVE      ZERO,TRATEH
            MOVE      ZERO,TRATEF
            MOVE      ZERO,PTTRADPT
            MOVE      ZERO,PTTRADRB
            MOVE      SP70,CONTRCID
            MOVE      SP70,CMENDDTE
          ENDIF
          MOVE      CONTRCID,SAVCONTR
          IF        DBSFLAG=1 | IPASS=1
            MOVE      TRATEF,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
            ENDIF
          ELSE
            MOVE      TRATEF,LSTRATE
            ADD       TRATEH,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
              ADD       PTTRADRB,LSTRATE        * rebate additional charge
              MOVE      PTTRADPT,PATARATE       * Patient daily additional rate
              MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
            ENDIF
          ENDIF
.
          MOVE      TRATEF,PATLRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,PATLRATE       * patient additional charge
          ENDIF
          MOVE      TRATEH,FNDLRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,FNDLRATE       * rebate additional charge
          ENDIF
.
          IF        PTTREPSD=1
            MOVE      SPTTRADP,PTTRADPT
            MOVE      SPTTRADR,PTTRADRB
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
          ENDIF
.
          MOVE      TRATEH,STRATEH
.
.         Check the next stepdown rate
.
DLNE5920  MOVE      TDATE,DATFIELD
          MATCH     TDATE,PREVTDAT
          IF        !@EQUAL
            ADD       ONE,DATFIELD
          ENDIF
          IF        NPDAYFLG=1
            MOVE      SAVBTYP,NPDBTYPE  * Save No payday bed type
          ENDIF
          MOVE      DATFIELD,CEFFDATE
          CALL      STEPDOWN
          IF        NOFEE=1
            MOVE      SAVDATE,TDATE     * no fee found
            MOVE      PREVTDAT,TDATE
            MOVE      ZERO,TRATEF
            MOVE      ZERO,TRATEH
            MOVE      ZERO,PTTRADPT     * patient additional charge
            MOVE      ZERO,PTTRADRB     * rebate additional charge
          ENDIF
          CALL      DCNT0000            * Check Contract Eff.for Disc.
.
.         MOVE      CONTRCID,SAVCONTR
.
          COMPARE   ZERO,NPDAYFLG
          GOTO      DLNE6000 IF EQUAL         * normal charging
.
.         if Date start of casepayment is same date as transfer date
.         then set NPDAYFLG to two to start Casepayment
.
          IF        NPDAYFLG=1
            MATCH     TDATE,PCENDDTE
            IF        @EQUAL
              MATCH     IDATEF,TDATE
              IF        !@LESS
                MOVE      TWO,NPDAYFLG          * NPDAYflg=2 for casemix
              ENDIF
              GOTO      DLNE6000
            ENDIF
          ENDIF
.
          MATCH     TDATE,PCENDDTE
          IF        @LESS
            MOVE      PCENDDTE,TDATE
            MATCH     IDATEF,TDATE
            IF        !@LESS
              MOVE      TWO,NPDAYFLG            * NPDAYflg=2 for casemix
            ENDIF
          ENDIF
.
DLNE6000  MOVE      TDATE,IDATET
.
.         If this is the Admission record, then just save the details
.
          CMATCH    "A",TMOVE
          GOTO      DLNE8000 IF EQUAL
.
          BRANCH    NPDAYFLG,DLNE7400,DLNE7400
.
.         If this is not a Change record, then write/display a record
.
          CMATCH    "C",TMOVE
          GOTO      DLNE7400 IF NOT EQUAL
.
.         If the ward or bed has changed, then write/display a record
.
          MATCH     TWARD,STWARD
          GOTO      DLNE7400 IF NOT EQUAL
.
          MATCH     TBED,STBED
          GOTO      DLNE7400 IF NOT EQUAL
.
.         If the rate amount has changed, then write/display a record
.
          BRANCH    DBSFLAG,DLNE7000
          BRANCH    IPASS OF DLNE7000,DLNE7100
.
          MOVE      TRATEF,NEWRATE
          ADD       TRATEH,NEWRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,NEWRATE        * patient additional charge
            ADD       PTTRADRB,NEWRATE        * rebate additional charge
          ENDIF
          SUB       TALLW,NEWRATE
          SUB       TDISC,NEWRATE
          GOTO      DLNE7200
.
.         Pass 1 : Patient Portion only
.
DLNE7000  MOVE      TRATEF,NEWRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,NEWRATE        * patient additional charge
          ENDIF
          SUB       TALLW,NEWRATE
          SUB       TDISC,NEWRATE
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            COMPARE   TWO,IPATFLAG
            GOTO      DLNE7200 IF EQUAL      * Printing Patient Invoice
          ENDIF
          MOVE      ZERO,TRATEH
.
          GOTO      DLNE7200
.
.         Pass 2 : Rebate Portion only
.
DLNE7100  MOVE      TRATEH,NEWRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,NEWRATE        * rebate additional charge
          ENDIF
          MOVE      ZERO,PTTRITFS
          MOVE      ZERO,TRATEF
          MOVE      ZERO,TEXTRA
.
.         Compare the old and new rates
.
DLNE7200  MATCH     "U",CQLDTMOV
          GOTO      DLNE7400 IF EQUAL         * Force a new line for Unqualified
.
          COMPARE   LSTRATE,NEWRATE
          GOTO      DLNE7400 IF NOT EQUAL
.
.         If the rebate rate has changed, then write/display a record
.
          COMPARE   TRATEH,STRATEH
          GOTO      DLNE7400 IF NOT EQUAL
.
          IF        CMXFLAG=1
            COMPARE   PTTRADRB,SPTTRADR       * additional charge
            GOTO      DLNE7400 IF NOT EQUAL
          ENDIF
.
.         If the extra rate has changed, then write/display a record
.
          COMPARE   TEXTRA,STEXTRA
          GOTO      DLNE7400 IF NOT EQUAL
.
.         If the end day of rate is changed
.
          COMPARE   TRBEND,STRBEND
          GOTO      DLNE7400 IF NOT EQUAL
.
          COMPARE   PTTRAEND,SPTTRAEN
          GOTO      DLNE7400 IF NOT EQUAL
.
.         If the bed type is changed
.
          MATCH     TRBTYP,STRBTYP
          GOTO      DLNE7400 IF NOT EQUAL
.
          IF        CMXFLAG = 1
            GOTO      DLNE5000
          ENDIF
.
.         Only Public hospitals use the chargeable status
.
.         If we are using the chargeable status in the rate (patrates) AND the
.         chargeable status has changed, then write/display a record
.
          IF        CFEETYP = 1
            MATCH     TCHSTAT,STCHSTAT
            GOTO      DLNE7400 IF NOT EQUAL
          ENDIF
.
.         If we are using the doctor type in the rate (PATNZRA1) AND the
.         attending doctor has changed, then write/display a record
.
          IF        CFEETYP = 2
            MATCH     TADOCT,STADOCT
            GOTO      DLNE7400 IF NOT EQUAL
          ENDIF
.
.         If the Admission type has altered then write/display a record
.
DLNE7300  MATCH     TATYPE,STATYPE
          GOTO      DLNE5000 IF EQUAL
.
.         If this records date is greater than or equal to the starting date,
.         then generate an accommodation record.
.
DLNE7400  MOVE      IDATET,SIDATET
          IF        BDTEFLAG=1
            MOVE      BACKDATE,DIM8
            MATCH     SP10,DDATE
            IF        !@EQUAL
              MATCH     DDATE,BACKDATE
              IF        !@LESS
                MOVE      DDATE,DIM8
              ENDIF
            ENDIF
.
            MATCH     IDATET,DIM8
            IF        @LESS
              MOVE      DIM8,IDATET
            ENDIF
          ENDIF
.
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
          COMPARE   TWO,NPDAYFLG
          GOTO      DLNE8000 IF EQUAL      
.
.         If this is the discharge record, then we have finished
.
          CMATCH    "D",TMOVE
          GOTO      DLNE7600 IF NOT EQUAL
.
.         Update the discharged record with the new bed fee, only when
.         printing invoice
.
          COMPARE   THREE,PROGFLAG
          GOTO      DLNE8900 IF NOT EQUAL
.
          IF        CMXFLAG = 1
            GOTO      DLNE7440           * update transfer record with new rate
          ENDIF
.
          COMPARE   ONE,CSTDOWN
          GOTO      DLNE8900 IF NOT EQUAL
.
DLNE7440  MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2                                            *C-90221
          IF        OVRCD=0
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      SPTTRADP,PTTRADPT
            MOVE      SPTTRADR,PTTRADRB
            MOVE      SPTTRITF,PTTRITFS
.
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ENDIF
          GOTO      DLNE8900
.
.         If this is a Leave record, then zero the rate data
.         Nursing home charges on leave days
.
DLNE7600  CMATCH    "L",TMOVE
          GOTO      DLNE7700 IF EQUAL
.
.         If this not a Return record, add up the number of days
.         of hospitalization
.
          CMATCH    "R",TMOVE
          GOTO      DLNE7800 IF EQUAL
.
DLNE7700  MOVE      ZERO,CALDAYS
          MATCH     STDATE,TDATE
          IF        !@EQUAL
            DAYSEP    STDATE,TDATE,CALDAYS
          ENDIF
          ADD       CALDAYS,NBRDAYS
          ADD       CALDAYS,BDAYSCNT
.
          CMATCH    "L",TMOVE
          GOTO      DLNE8300 IF EQUAL
.
DLNE7800  IF        CMXFLAG = 1
            GOTO      DLNE8000
          ENDIF
.
          MATCH     STATYPE,TATYPE           * Check for a change in adm type
          GOTO      DLNE8000 IF EQUAL
.
          MOVE      ZERO,BDAYSCNT            * Reset day count
          MOVE      ZERO,SUMDAYS
.
.         Save the rate and ward/bed information
.
DLNE8000  MOVE      TWARD,STWARD
          MOVE      TBED,STBED
          MOVE      TRATEF,STRATEF
          MOVE      TRATEG,STRATEG
          MOVE      TDISC,STDISC
          MOVE      TALLW,STALLW
          MOVE      TATYPE,STATYPE
          MOVE      TADOCT,STADOCT
          MOVE      TRBTYP,STRBTYP
          MOVE      TDATE,STDATE
          MOVE      TEXTRA,STEXTRA
          MOVE      TCHSTAT,STCHSTAT
.
          IF        SPTTREPS=1
            MOVE      SAVTBEND,SAVETRN
          ENDIF
          MOVE      PTTREPSD,STEPNO
          MOVE      PTTREPSD,SPTTREPS
.
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      PTTRADPT,SPTTRADP
          MOVE      PTTRADRB,SPTTRADR
          MOVE      PTTRITFS,SPTTRITF
          MOVE      TMOVE,STMOVE
          MOVE      CONTRCID,SAVCONTR
.
.         Calculate the rate amount for this record
.
          BRANCH    DBSFLAG,DLNE8100
          BRANCH    IPASS OF DLNE8100,DLNE8200
.
          MOVE      TRATEH,STRATEH
          MOVE      TRATEF,LSTRATE
          ADD       TRATEH,LSTRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,LSTRATE        * patient additional charge
            ADD       PTTRADRB,LSTRATE        * rebate additional charge
            MOVE      PTTRADPT,PATARATE       * Patient daily additional rate
            MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
          ENDIF
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
.
          MOVE      TRATEF,PATLRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,PATLRATE       * patient additional charge
          ENDIF
          SUB       TALLW,PATLRATE
          SUB       TDISC,PATLRATE
.
          MOVE      TRATEH,FNDLRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,FNDLRATE       * patient additional charge
          ENDIF
.
          COMPARE   THREE,PROGFLAG
          GOTO      DLNE8020 IF NOT EQUAL      * not printing invoice
.
          BRANCH    OVERPFL,DLNE8020
          BRANCH    FNDFLAG,DLNE8020
.
          MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2                                            *C-61001
          IF        OVRCD=0
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      SPTTRADP,PTTRADPT
            MOVE      SPTTRADR,PTTRADRB
.
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ENDIF
          GOTO      DLNE8020
.
DLNE8020  COMPARE   TWO,NPDAYFLG
          GOTO      DLNE5000 IF NOT EQUAL
.
          MOVE      SP70,CSMATYPE          * admission type for lumpsum Nopayday
.
.         Check the Ending date of Perdiem against the start of Casemix payment
.
          MATCH     CMSTRTDT,PCENDDTE
          GOTO      DLNE8050 IF NOT LESS
.
.         Need to display zero amount of No Pay days period
.
          MOVE      ZERO,PATLNTOT
          MOVE      ZERO,PATLNGST
          MOVE      ZERO,PATARATE
          MOVE      ZERO,PATHRATE
          MOVE      ZERO,PATLRATE
          MOVE      ZERO,FNDLRATE
.
          MOVE      ONE,ERDTFLAG             * flag for No Pay day description
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
          PACK      NPSTRTDT,PCENDDTE,SP70   * Start of No pay day
          PACK      IDATEF,PCENDDTE,SP70
          UNPACK    IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
          PACK      IDATET,CMSTRTDT,SP70
          MOVE      ZERO,SPTTRADP
          MOVE      ZERO,SPTTRADR
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEH
.
          MOVE      NPDCONTR,CONTRCID       * Casepayment Contract ID
          MOVE      NPDCONTR,SAVCONTR
.
          CALL      CHGM0000                * Check the next trans record
.
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
          MOVE      ZERO,ERDTFLAG
.
.         Check if there is a change record when the casepayment starts
.
DLNE8050  MOVE      CMSTRTDT,SAVTDTE       * start of Casepayment
          PACK      KEY30,DAADMNO,SAVTDTE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,DLNE8054
.
          MATCH     DTADMN,DAADMNO
          GOTO      DLNE8054 IF NOT EQUAL  * different admission
.
          MATCH     TDATE,SAVTDTE
          GOTO      DLNE8054 IF NOT EQUAL  * different transfer date
.
          CMATCH    "D",TMOVE
          GOTO      DLNE8052 IF EQUAL      * Discharged at the start of Casemix
          MATCH     "C",TMOVE
          GOTO      DLNE8054 IF NOT EQUAL  * not a Change record
.
.         Get the last change of Adm.type for lumpsum No payday
.
DLNE8052  MOVE      TATYPE,CSMATYPE        * save the Adm.type
.
DLNE8054  MOVE      SKEY30,KEY30          * reposition
          CALL      RDTRAN2
.
          MOVE      ANSA,TMOVE
          MOVE      PCENDDTE,SAVDATE
          MOVE      CMSTRTDT,TDATE
          MOVE      TDATE,STDATE
          PACK      IDATEF WITH CMSTRTDT
          REP       " 0",IDATEF
          UNPACK    IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
.
          MOVE      NPDCONTR,CONTRCID       * Casepayment Contract ID
          MOVE      NPDCONTR,SAVCONTR
          MOVE      ONE,CMXFLAG
          MOVE      ZERO,PCFLAG        * set flag to charge casemix
.
          GOTO      DLNE5630              * Generate lumpsum/casemix
.
.         Pass 1 : Patient Portion only
.
DLNE8100  MOVE      TRATEF,LSTRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,LSTRATE        * patient additional charge
          ENDIF
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
          IF        CMXFLAG=1
            MOVE      PTTRADPT,PATARATE        * Patient daily additional rate
            MOVE      PTTRADRB,PATHRATE        * HF daily additional rate
          ENDIF
.
          MOVE      TRATEF,PATLRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,PATLRATE       * patient additional charge
          ENDIF
          SUB       TALLW,PATLRATE
          SUB       TDISC,PATLRATE
.
          MOVE      TRATEH,FNDLRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,FNDLRATE       * rebate additional charge
          ENDIF
.
          MATCH     "1",PTCNPPIN
          GOTO      DLNE8180 IF NOT EQUAL
.
          BRANCH    DBSFLAG,DLNE8160
          COMPARE   TWO,IPATFLAG
          GOTO      DLNE8180 IF NOT EQUAL
.
.         print Patient Invoice
.
DLNE8160  COMPARE   TWO,NPDAYFLG
          GOTO      DLNE5000 IF NOT EQUAL     * do not clear rebate amount
          GOTO      DLNE8020
.
DLNE8180  MOVE      ZERO,STRATEH
          MOVE      ZERO,SPTTRADR
.
          GOTO      DLNE5000
.
.         Pass 2 : Rebate Portion only
.
DLNE8200  MOVE      TRATEH,LSTRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,LSTRATE        * rebate additional charge
          ENDIF
          MOVE      TRATEH,STRATEH
          MOVE      PTTRADRB,SPTTRADR
          GOTO      DLNE5000
.
.         Save values for on-leave
.
DLNE8300  MOVE      SP3,STWARD
          MOVE      SP3,STBED
.
          BRANCH    ISBLFLAG,DLNE5000         * Always charge on leave
.
          MATCH     "1",PTCNCHGL
          GOTO      DLNE5000 IF EQUAL         * Charge on leave, keep values
.
          MOVE      ZERO,STEXTRA
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEG
          MOVE      ZERO,STRATEH
          MOVE      ZERO,STDISC
          MOVE      ZERO,STALLW
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,SPTTRADP
          MOVE      ZERO,SPTTRADR
          MOVE      ZERO,SPTTRITF
          MOVE      ZERO,PATARATE
          MOVE      ZERO,PATHRATE
          MOVE      ZERO,PATLRATE
          MOVE      ZERO,FNDLRATE
.
          IF        CMXFLAG = 1
            GOTO      DLNE5000
          ENDIF
.
          MATCH     TATYPE,STATYPE
          GOTO      DLNE5000 IF EQUAL
.
          MOVE      ZERO,BDAYSCNT
          MOVE      ZERO,SUMDAYS
          GOTO      DLNE5000
.
.******************************************************************************
.         End of this admissions records in transfer file. No Discharge record
.
DLNE8400  PACK      IDATET WITH TCENT,TYEAR,TMON,TDAY
          REP       " 0",IDATET
          MOVE      ONE,OVERPFL
.
          MOVE      SP10,A8DATE
          MOVE      SP10,B8DATE
          MOVE      ZERO,TRNFLAG
.
          COMPARE   ONE,CMXFLAG
          GOTO      DLNE8500 IF NOT EQUAL
.
.         Casemix
.
          BRANCH    DCFLAG,DLNE8800
          MOVE      IDATET,TDATE
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
          MOVE      SPTTRAEN,PTTRAEND
          MOVE      SPTTREPS,PTTREPSD
          MOVE      STWARD,TWARD
          MOVE      STBED,TBED
          CALL      PATCMSTP
.
.         Check if we are in Mechanical Ventilation period
.
          MATCH     IDATET,TDATE
          CALL      CKMV0000 IF NOT LESS      * Get new period of MV if any
          COMPARE   ONE,MVPFLAG
          GOTO      DLNE8600 IF NOT EQUAL     * Not in MV period
.
          MATCH     TDATE,STMVDATE
          GOTO      DLNE8600 IF NOT LESS
.
.         No more stepdown till end of transfer
.
          MOVE      STMVDATE,IDATET
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
          MOVE      ZERO,PATLNTOT
          MOVE      ZERO,PATLNGST
          MOVE      ZERO,PATARATE
          MOVE      ZERO,PATHRATE
          MOVE      ZERO,PATLRATE
          MOVE      ZERO,FNDLRATE
.
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,SPTTRADP
          MOVE      ZERO,SPTTRADR
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEH
.
          MOVE      ENMVDATE,IDATET
          MOVE      IDATET,SIDATET
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
          GOTO      DLNE8600
.
.         Per diem - End of this admissions records in transfer file
.         Check if a stepdown is required
.
DLNE8500  COMPARE   ONE,CSTDOWN
          GOTO      DLNE8800 IF NOT EQUAL
.
          MOVE      SP1,TMOVE
          LOAD      TMOVE USING ASTAT OF ANSC,ANSC,ANSC,ANSR
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          MOVE      STRBTYP,SAVBTYP
          MOVE      STRBEND,TRBEND
          MOVE      STWARD,TWARD
          MOVE      STBED,TBED
.
          IF        ASTAT<>4 & SPTTREPS=2
            MOVE      SAVDATE,FRDATE
            MOVE      ZERO,PTTREPSD
          ELSE
            MOVE      SPTTREPS,PTTREPSD
          ENDIF
          IF        PTTREPSD=1
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
          ENDIF
.
          MATCH     SAVDATE,IDATEF
          IF        !@LESS
            MOVE      IDATEF,DATFIELD
          ELSE
            MOVE      SAVDATE,DATFIELD
            MATCH     SAVDATE,PREVTDAT
            IF        !@EQUAL
              ADD       ONE,DATFIELD
            ENDIF
          ENDIF
.
          MATCH     ANSA,PREVTMOV
          IF        @EQUAL
            IF        AINVPRT=0
              MOVE      FRDATE,DATFIELD
            ENDIF
          ENDIF
          MOVE      DATFIELD,CEFFDATE
.
          MOVE      TMOVE,PREVTMOV
.
.         Check if Contract has Expired
.
          MATCH     SP70,CMENDDTE
          IF        !@EQUAL
            MATCH     CMENDDTE,CEFFDATE
            IF        !@LESS
              MOVE      IDATEF,TDATE
              MOVE      IDATEF,DATFIELD
              MOVE      TWO,STEPNO             * for GETACCM not to use STRBEND
              MOVE      ZERO,TEMPDAY
              CALL      SCTR0000               * Get a new Contract
            ENDIF
          ENDIF
.
          MATCH     CEFFDATE,CMENDDTE
          GOTO      DLNE8600 IF EQUAL
.
          MOVE      ZERO,PTTREPSD            * reset PTTREPSD
          MOVE      IDATET,TDATE
          CALL      STEPDOWN
          BRANCH    NOFEE,DLNE8600
          CALL      DCNT0000            * Check Contract Eff.for Disc.
.
DLNE8600  IF        NOFEE=1
            MOVE      ZERO,PATARATE
            MOVE      ZERO,PATHRATE
            MOVE      ZERO,PATLRATE
            MOVE      ZERO,FNDLRATE
            MOVE      ZERO,LSTRATE
            MOVE      SP70,SAVCONTR
            GOTO      DLNE8800
          ENDIF
.
          MOVE      TRATEF,PATLRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,PATLRATE       * patient additional charge
            MOVE      PTTRADPT,PATARATE       * Patient daily additional rate
          ENDIF
          MOVE      TRATEH,FNDLRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,FNDLRATE       * healtfund additional charge
            MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
          ENDIF
.
.         Check if stepdown was indicated = shown by a new TDATE
.
          MATCH     TDATE,IDATET
          IF        @EQUAL
            MOVE      ONE,NOSTDOWN
            GOTO      DLNE8700             * No stepdown till end date
          ENDIF
.
.         There is a stepdown- Check if Contract expired prior the next stepdown
.
          MATCH     SP70,CMENDDTE
          GOTO      DLNE6000 IF EQUAL    * no End date 
.
          MATCH     TDATE,CMENDDTE
          GOTO      DLNE6000 IF NOT LESS
.
.         Contract ended before Next stepdown, process till end of Contract
.
DLNE8620
          MOVE      TRATEH,STRATEH
          IF        DBSFLAG=1
            MOVE      TRATEF,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
            ENDIF
          ELSE
            MOVE      TRATEF,LSTRATE
            ADD       TRATEH,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
              ADD       PTTRADRB,LSTRATE        * rebate additional charge
              MOVE      PTTRADPT,PATARATE       * Patient daily additional rate
              MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
            ENDIF
            MOVE      TRATEF,PATLRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,PATLRATE       * patient additional charge
            ENDIF
            MOVE      TRATEH,FNDLRATE
            IF        CMXFLAG=1
              ADD       PTTRADRB,FNDLRATE       * healtfund additional charge
            ENDIF
          ENDIF
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
          SUB       TALLW,PATLRATE
          SUB       TDISC,PATLRATE
.
          MOVE      CONTRCID,SAVCONTR
          GOTO      DLNE8720
.
.*******************************************************************************
.         No stepdown- Check if Contract expired prior the end invoice date
.
DLNE8700  BRANCH    CMXFLAG,DLNE8800
.
          MATCH     SP70,CMENDDTE
          GOTO      DLNE8800 IF EQUAL
.
          MATCH     IDATEF,CMENDDTE
          GOTO      DLNE8800 IF LESS
.
          MATCH     IDATET,CMENDDTE
          GOTO      DLNE8710 IF LESS          * Contract Ended b/w IDATEF IDATET
.
          BRANCH    NOSTDOWN,DLNE8800           * No Stepdown use the old rate
.
          MOVE      CONTRCID,SAVCONTR
          MOVE      TRATEH,STRATEH
          IF        DBSFLAG=1
            MOVE      TRATEF,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
            ENDIF
          ELSE
            MOVE      TRATEF,LSTRATE
            ADD       TRATEH,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
              ADD       PTTRADRB,LSTRATE        * rebate additional charge
              MOVE      PTTRADPT,PATARATE       * Patient daily additional rate
              MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
            ENDIF
            MOVE      TRATEF,PATLRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,PATLRATE       * patient additional charge
            ENDIF
            MOVE      TRATEH,FNDLRATE
            IF        CMXFLAG=1
              ADD       PTTRADRB,FNDLRATE       * healtfund additional charge
            ENDIF
          ENDIF
.
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
          SUB       TALLW,PATLRATE
          SUB       TDISC,PATLRATE
          GOTO      DLNE8800
.
.         Contract ended in between IDATEF and IDATET
.
DLNE8710  MOVE      ZERO,NOSTDOWN
          MATCH     IDATET,IDATEF
          GOTO      DLNE8900 IF EQUAL
.
.         No stepdown but Contract ended prior End of Invoice
.         Process stepdown from IDATE to End of Contract
.
DLNE8720  MOVE      IDATET,PREVTDAT
          MATCH     SP70,CMENDDTE
          GOTO      DLNE7400 IF EQUAL
.
          MOVE      CMENDDTE,TDATE
          MOVE      CMENDDTE,IDATET
          MOVE      ZERO,STEPNO
.
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS   * Accom.record till end of Contract
          MOVE      TWO,STEPNO             * for GETACCM not to use STRBEND
.
          MOVE      PREVTDAT,IDATET
.
.         Check if End of Contract is before Fromdate
.
          MATCH     IDATEF,CMENDDTE
          IF        @LESS
            MOVE      IDATEF,TDATE
          ENDIF
.
          MOVE      CMENDDTE,DATFIELD
          MOVE      DAYNUM,TEMPDAY
          CALL      SCTR0000      * Get bed fees for next start of New Contract
          BRANCH    NOFEE,DLNE8800
.
          MATCH     SP70,CMENDDTE
          GOTO      DLNE8500 IF EQUAL
.
          MATCH     IDATET,CMENDDTE
          GOTO      DLNE8730 IF NOT LESS
.
.
.         Check if there is a stepdown before End of New Contract
.
          MOVE      ZERO,PTTREPSD            * reset PTTREPSD
          MOVE      IDATET,TDATE
          CALL      STEPDOWN
          CALL      DCNT0000            * Check Contract Eff.for Disc.
          IF        NOFEE=0
            MATCH     TDATE,IDATET
            IF        !@EQUAL
              MATCH     CMENDDTE,TDATE
              IF        @LESS
                MOVE      TDATE,SAVDATE
                MOVE      TDATE,IDATET
                GOTO      DLNE7400
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      IDATEF,TDATE
          MOVE      IDATEF,SAVDATE
          MOVE      CMENDDTE,IDATET
          GOTO      DLNE7400
.
DLNE8730  MOVE      PREVTDAT,TDATE
          MOVE      IDATEF,SAVDATE
          GOTO      DLNE8500
.  
.         No stepdown indicated - process up to the end date
.
DLNE8800  MOVE     IDATET,SIDATET
          MOVE     IDATEF,TDATE
          CALL     CKMV0000                  * Get new period of MV if any
          IF       MVPFLAG=1
            MOVE      ZERO,PATLNTOT
            MOVE      ZERO,PATLNGST
            MOVE      ZERO,PATARATE
            MOVE      ZERO,PATHRATE
            MOVE      ZERO,PATLRATE
            MOVE      ZERO,FNDLRATE
.
            MOVE      ZERO,LINETOT
            MOVE      ZERO,LINEGST
            MOVE      ZERO,LSTRATE
            MOVE      ZERO,SPTTRADP
            MOVE      ZERO,SPTTRADR
            MOVE      ZERO,STRATEF
            MOVE      ZERO,STRATEH
          ENDIF
.
          MATCH     IDATEF,IDATET
          CALL      FNDT0000 IF NOT LESS    * display/write an Accom. record
.
.         Processing Items
.
DLNE8900  IF        DBSFLAG=1
            CALL      GDBM0000              * Get Misc.item for Disc.Billing
            GOTO      DLNE9000
          ENDIF
.
          IF        CFEETYP=9
            CALL      GJHM0000              * Get Misc.items for Johns Hopkins
            GOTO      DLNE9000
          ENDIF
.
          IF        CFEETYP=5
            CALL      GSXM0000              * Get Misc.items for Southern Cross
            GOTO      DLNE9000
          ENDIF
.
.        If theatre fees file is not used for charging (ie. RCH and STV )
.        item not need to be sorted.
.
         IF        IBCNMHOS=1
           MATCH     "1",PTHSTFEE
           GOTO      DLNE8990 IF EQUAL
         ELSE
           COMPARE   "1",PTCNTFEE
           GOTO      DLNE8990 IF EQUAL
         ENDIF
.
          MOVE      ZERO,TFEEIND            * Not using theatre fee flag
.
DLNE8990  
          MATCH     "1",PTCNPPIN      * New Patient Invoice functionality
          IF        @EQUAL
            IF        PREBFLAG=1 & DBSFLAG=0 & ISBLFLAG=0 & COMFLAG=1
              MOVE      ZERO,COMFLAG
              GOTO      DLNE9000
            ENDIF
          ENDIF
.
          CALL      GMSC0000                * Processing items
          GOTO      DLNE9200
.
DLNE9000  CALL      KTMP0000
          CALL      KLMV0000
          CALL      KT2P0000
.
DLNE9200  MOVE      ZERO,EXIT
          GOTO      DLNE9999
.
DLNE9500  MOVE      ONE,EXIT
DLNE9999  RETURN
+
.*******************************************************************************
.         Check if we have a Transfer record on start of MV date
.*******************************************************************************
MVTR0000  BRANCH    MVTRNFLG,MVTR9000
.
          MOVE      SP70,D8
          MATCH     MVENSDAT,TDATE
          GOTO      MVTR2000 IF EQUAL        * found a transfer on MV start date
.
          MATCH     MVENSDAT,TDATE
          GOTO      MVTR9999 IF LESS
.
          MOVE      SDIM3,SAVBTYP
          MOVE      MVENSDAT,D8
          MOVE      ONE,MVTRNFLG             * do MV period stepdown
          GOTO      MVTR9999
.
MVTR2000  MATCH     TDATE,MVENSDAT
          GOTO      MVTR9999 IF NOT LESS
.
          MATCH     TDATE,MVENEDAT
          GOTO      MVTR9999 IF LESS
.
          MOVE      SDIM3,SAVBTYP
          MOVE      MVENEDAT,D8
          MOVE      ONE,MVTRNFLG
          GOTO      MVTR9999
.
MVTR9000  MOVE      ZERO,MVTRNFLG
MVTR9999  RETURN
+
.*******************************************************************************
.         Check for ABF 
.*******************************************************************************
UABF0000  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND28;*105,PTCNUABF
          MATCH     "1",PTCNUABF
          GOTO      UABF9100 IF NOT EQUAL   * Not using ABF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,UABF9100
          MATCH     "A",TCINDC2
          GOTO      UABF9100 IF NOT EQUAL    * Not an ABF Funding
.
          MATCH     "IBAHMS58",PRGID
          GOTO      UABF2000 IF EQUAL        * Calc.ABF charges for comparison
.
.         Discharge Billing to display all items with No ABF Charge 
.         - zero amount for Items with HF portion
.         - the actual items amount for Patient only items(zero HF portion)
.
          IF        DBSFLAG=1
            MOVE      ONE,ABFFLAG
            GOTO      UABF9300
          ENDIF
.
.         Patient Only invoice to display Patient Only items with No ABF Charge
.
          BRANCH    IPATFLAG,UABF9300,UABF9300  * Printing Patient only invoice
          BRANCH    IPASS,UABF9300,UABF9300   * Not for split invoice
.
.         Check if ABF Invoice has been raised
.
          OPEN      PATINVR3,"patinvrf"
          PACK      KEY16,AADMNO,SP70
          CALL      RSPTINV3
UABF1000  CALL      RKPTINV3
          BRANCH    OVRCD,UABF2000
.
          MATCH     PINVADM,AADMNO
          GOTO      UABF2000 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      UABF1000 IF NOT EQUAL  * Credit note
.
          COMPARE   THREE,PTINCMIX
          GOTO      UABF0300 IF EQUAL * found an ABF Invoice
.
          GOTO      UABF1000
.
.         Check for Mental Health Events
.
UABF2000  PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          BRANCH    OVRCD,UABF9200
.
          MATCH     "11",PTCDUDF6
          IF        @EQUAL
            PROC      ABFMHINV          * Calculate ABF Invoice for MH Events
          ELSE
            PROC      ABFPTINV          * Calculate ABF Invoice
          ENDIF
          BRANCH    NOFEE,UABF9200
.
          CALL      SABF0000          * Display/Print ABF charges
.
          MOVE      ZERO,EXIT
          MATCH     "IBAHMS58",PRGID
          GOTO      UABF9999 IF EQUAL * Calc.ABF charges only for comparison
.
.         If ABF invoice has been raised, raise invoice (items) as per normal
.
UABF0300  CALL      GMSC0000          * Processing items
          MOVE      ZERO,EXIT
.
          GOTO      UABF9999
.
UABF9100  MOVE      ONE,EXIT          * NO ABF invoice - raise as per normal
          GOTO      UABF9999
.
.         Exit, if ABF PW not setup
.
UABF9200  MOVE      TWO,EXIT          * ABF PW not setup
.         IF        PROGFLAG=2 & WEBFLAG=1 & NOFEE=1
.            WRITE     HTMLFILE;"<tr><center><b>ABF Price Weight Not Setup":
.                         "</b></center></tr>";
.         ENDIF
          GOTO      UABF9999
.
UABF9300  MOVE      THREE,EXIT        * Do not show ABF Charge
          GOTO      UABF9999
.
UABF9999  RETURN
+
.*******************************************************************************
.         Check if the next Change transfer record is for same date
.*******************************************************************************
CHGM0000  MOVE      TDATE,SAVTDTE
          PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
CHGM1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CHGM8000
.
          MATCH     DTADMN,DAADMNO
          GOTO      CHGM8000 IF NOT EQUAL  * different admission
.
          MATCH     TDATE,SAVTDTE
          GOTO      CHGM8000 IF NOT EQUAL  * different transfer date
.
          MATCH     "C",TMOVE
          GOTO      CHGM8000 IF NOT EQUAL  * not a Change record
.
          PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      SAVARB
          GOTO      CHGM1000
.
CHGM8000  PACK      KEY30,SVKEY30,SP70
          CALL      RDTRAN2                * reposition
CHGM9999  RETURN
+
.*******************************************************************************
.         Check if the next Return record is for same date
.*******************************************************************************
CHGR0000  MOVE      ONE,F1
          MOVE      TDATE,SAVTDTE
          PACK      DIM9,TWARD,TBED,TRBTYP
          PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
CHGR1000  CALL      RDKTRAN2
          BRANCH    OVRCD,CHGR8000
.
          MATCH     DTADMN,DAADMNO
          GOTO      CHGR8000 IF NOT EQUAL  * different admission
.
          MATCH     TDATE,SAVTDTE
          GOTO      CHGR8000 IF NOT EQUAL  * different transfer date
.
          MATCH     "R",TMOVE
          GOTO      CHGR8000 IF NOT EQUAL  * not a Return record
.
          PACK      KEY9,TWARD,TBED,TRBTYP
          MATCH     DIM9,KEY9
          GOTO      CHGR8000 IF NOT EQUAL
.
          MOVE      ZERO,F1
          PACK      SVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      SAVARB
          GOTO      CHGR1000
.
CHGR8000  PACK      KEY30,SVKEY30,SP70
          CALL      RDTRAN2                * reposition
.
          BRANCH    F1,CHGR9999
          MOVE      "C",TMOVE
CHGR9999  RETURN
+
.*******************************************************************************
.         Check if there is an Additional charge on No pay day
.*******************************************************************************
ADON0000  OPEN      PATAFEA1,"patafeaf"
          MATCH     SP70,NPDBTYPE
          GOTO      ADON1000 IF EQUAL
.
          MATCH     SAVDATE,TDATE
          GOTO      ADON1200 IF NOT EQUAL        * Not
.
ADON1000  MOVE      SAVBTYP,NPDBTYPE
.
ADON1200  PACK      SDIM30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,NPDBTYPE,SP10
          PACK      CASMXKEY,CASMXKEY,SP70
          MATCH     SP70,CASMXKEY
          IF        !@EQUAL
            PACK      SDIM30,CASMXKEY,CMCODE,NPDBTYPE,SP10
          ENDIF
.
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,LINETOT
          MOVE      ZERO,FORM1
ADON2000  PACK      KEY34,SDIM30,SP10
          CALL      RSPTAFE1
ADON3000  CALL      RKPTAFE1
          BRANCH    OVRCD,ADON4000        * no additional charge
.
          PACK      DIM30,PTFECNID,PTFECLMN,PTFEHFND,PTFETABT,PTFECASM,PTFEBTYP
          MATCH     DIM30,SDIM30
          GOTO      ADON7000 IF EQUAL
.
ADON4000  MATCH     SP70,CASMXKEY
          GOTO      ADON4200 IF NOT EQUAL
          ADD       ONE,FORM1
          BRANCH    FORM1,ADON5000,ADON6000  * try no hf, try no claim code
ADON4200  MOVE      ONE,NOFEE
          GOTO      ADON9999                 * no addition charge
.
.         Try with no health fund
.
ADON5000  PACK      SDIM30,CONTRCID,ACLAIM,SP6,SP3,CMCODE,NPDBTYPE,SP10
          GOTO      ADON2000
.         Try with no claim code
.
ADON6000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      DCLM0000
          PACK      SDIM30,CONTRCID,PTCNDCLM,SP6,SP3,CMCODE,NPDBTYPE,SP10
          GOTO      ADON2000
.
ADON7000  MATCH     "1",PTFENPDY
          GOTO      ADON8000 IF NOT EQUAL   * No Charge on No pay day
.
          BRANCH    DBSFLAG,ADON7200
          BRANCH    IPASS OF ADON7200,ADON7400
.
          MOVE      PTFEDREB,LSTRATE        * patient additional charge
          ADD       PTFEDPAT,LSTRATE        * rebate additional charge
          GOTO      ADON7800
.
ADON7200  MOVE      PTFEDPAT,LSTRATE        * patient additional charge
          GOTO      ADON7800
.
ADON7400  MOVE      PTFEDREB,LSTRATE        * rebate additional charge
.
ADON7800  MOVE      LSTRATE,LINETOT
          MULT      NODAYS,LINETOT
          MOVE      PTFEDREB,STRATEH
.
          MOVE      PTFEDPAT,PATARATE       * Patient daily additional rate
          MOVE      PTFEDREB,PATHRATE       * rebate daily additional rate
.
          MOVE      PTFEDPAT,PATLRATE       * patient additional charge
          MOVE      PTFEDREB,FNDLRATE       * rebate additional charge
.
          MOVE      PATLRATE,PATLNTOT
          MULT      NODAYS,PATLNTOT
.
          IF        IBCNUGST=2
            MOVE      LINETOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,LINEGST
.
            MOVE      PATLNTOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PATLNGST
          ENDIF
.
          PACK      TDDESC,SP70
          CLEAR     TDDESC
          APPEND    "No Pay Day/",TDDESC
          APPEND    PTFEDES1,TDDESC
          APPEND    SP70,TDDESC
          RESET     TDDESC
.
          PACK      ACCMDESC,SP70
          CLEAR     ACCMDESC
          APPEND    "No Pay Day/",ACCMDESC
          APPEND    PTFEDES1,ACCMDESC
          APPEND    SP70,ACCMDESC
          RESET     ACCMDESC
.
          MOVE      ONE,ECTRFLAG         * flag Addon for ShowStepdown template
          GOTO      ADON9999
.
ADON8000  MOVE      TWO,ECTRFLAG         * No Addon on No payday 
.
ADON9999  RETURN
+
.*******************************************************************************
.         If Contract id is for Disc.From, check the indicator19 of claim code
.*******************************************************************************
DCNT0000  COMPARE   TWO,CNTRCEFR
          GOTO      DCNT9999 IF NOT EQUAL    * Not a 'Disc.From' Eff.Contract
.
          COMPARE   THREE,ASTAT
          GOTO      DCNT9999 IF EQUAL        * Discharged patient
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,DCNT9999
.
          MATCH     "D",TCINDC19
          GOTO      DCNT9999 IF EQUAL        * Using Current Eff.Contract
.
          MOVE      ZERO,TRATEF
          MOVE      ZERO,TRATEH
          MOVE      ZERO,PTTRADPT     * patient additional charge
          MOVE      ZERO,PTTRADRB     * rebate additional charge
DCNT9999  RETURN
+
.*******************************************************************************
.         Generate bed fees for the next Contract available
.*******************************************************************************
SCTR0000  
          MATCH     FRDATE,ADATE
          IF        @EQUAL
            MOVE      ADYHOSP,TEMPDAY
            MOVE      ZERO,NBRDAYS
            DAYSEP    FRDATE,TDATE,NBRDAYS
            ADD       NBRDAYS,TEMPDAY
            ADD       ONE,TEMPDAY
          ELSE
            MOVE      ZERO,NBRDAYS
            DAYSEP    FRDATE,DATFIELD,NBRDAYS
            ADD       NBRDAYS,TEMPDAY
          ENDIF
.
          MOVE      DATFIELD,SAVDATE
          MOVE      DATFIELD,CEFFDATE
.
          MOVE      "C",TMOVE
          MOVE      TDATE,IDATEF
          UNPACK    IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
.
          CALL      GETBFE
          IF        NOFEE=1
            MOVE      ZERO,TRATEH
            MOVE      ZERO,TRATEF
            MOVE      ZERO,PTTRADPT
            MOVE      ZERO,PTTRADRB
            MOVE      SP70,CONTRCID
            MOVE      SP70,CMENDDTE
          ENDIF
          MOVE      CONTRCID,SAVCONTR
          MOVE      TRATEH,STRATEH
          IF        DBSFLAG=1
            MOVE      TRATEF,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
            ENDIF
          ELSE
            MOVE      TRATEF,LSTRATE
            ADD       TRATEH,LSTRATE
            IF        CMXFLAG=1
              ADD       PTTRADPT,LSTRATE        * patient additional charge
              ADD       PTTRADRB,LSTRATE        * rebate additional charge
            ENDIF
          ENDIF
.
          SUB       TALLW,LSTRATE
          SUB       TDISC,LSTRATE
.
          MOVE      TRATEF,PATLRATE
          IF        CMXFLAG=1
            ADD       PTTRADPT,PATLRATE        * patient additional charge
            MOVE      PTTRADPT,PATARATE        * Patient daily additional rate
          ENDIF
          SUB       TALLW,PATLRATE
          SUB       TDISC,PATLRATE
.
          MOVE      TRATEH,FNDLRATE
          IF        CMXFLAG=1
            ADD       PTTRADRB,FNDLRATE       * healtfund additional charge
            MOVE      PTTRADRB,PATHRATE       * HF daily additional rate
          ENDIF
.
SCTR9999  RETURN
+
.*******************************************************************************
.         Initialise variables
.*******************************************************************************
INVR0000  MOVE     ZERO,PPAYABLE
          MOVE     ZERO,PATLRATE
          MOVE     SP70,MVBDATE
          MOVE     SP70,MVENSDAT
          MOVE     SP70,MVENEDAT
          MOVE     ZERO,MVTRNFLG
.
          MOVE     ZERO,PATARATE
          MOVE     ZERO,PATHRATE
          MOVE     ZERO,FNDLRATE
          MOVE     SP70,ACCCONTR
.
          MOVE     ZERO,MVDAYS                  * set mv days to zero
          MOVE     ZERO,MVBFLAG                 * set mv billing flag to "no"
          MOVE     ZERO,STALLW
          MOVE     ZERO,STDISC
          MOVE     ZERO,SPTTRITF
          MOVE     ZERO,STRATEF
          MOVE     ZERO,STRATEG
          MOVE     ZERO,STRATEH
          MOVE     ZERO,STEXTRA
          MOVE     ZERO,SPTTRADP            * patient additional charge
          MOVE     ZERO,SPTTRADR            * rebate additional charge
          MOVE     ZERO,SPTTRLSP            * patient lumpsum
          MOVE     ZERO,SPTTRLSR            * rebate lumpsum
          MOVE     ZERO,GROSSTOT
          MOVE     ZERO,NETTOT
          MOVE     ZERO,TOTGST
          MOVE     ZERO,TOTPGST
          MOVE     ZERO,ACCMTOT
          MOVE     ZERO,TOTACCM                                        *I-90226
          MOVE     ZERO,TOTMISC                                        *I-90226
          MOVE     ZERO,TOTTHEA                                        *I-90226
          MOVE     ZERO,TOTOTHR                                        *I-90226
          MOVE     ZERO,GOVTOTAL
          MOVE     ZERO,LSTRATE
          MOVE     ONE,LUMPFLAG
          MOVE     ZERO,REVEXIST
          MOVE     ZERO,NPDAYFLG
          MOVE     SP70,PMSGCLSS
          MOVE     ZERO,MSGFLAG       * display error message flag
          MOVE     ZERO,ERDTFLAG
          MOVE     SP70,SAVMSGRP
          MOVE     SP70,NPSTRTDT
          MOVE     SP70,CASMXKEY
.
          MOVE     ZERO,TOTAMNT       * Johns Hopkins total Hospital Charges
          MOVE     ZERO,GSTAMNT       * Johns Hopkins total Hospital GST Charges
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN;*240,PTCNINVN
          MOVE      PTCNINVN,MAXLINE
.
          IF        PTCNINVL=22
            MOVE      "30",MAXLINE          * Johns Hopkins
          ENDIF
.
          MOVE     ZERO,PCFLAG
          MOVE     ZERO,HFACCM              * Total rebate for Accommodation
          MOVE     ZERO,HFTHEA              *                  Theatre
          MOVE     ZERO,HFMISC              *                  Miscellaneous
          MOVE     ZERO,CMXFLAG
.
          MOVE     ONE,NUMINVS              * Assume one invoice
.
          MOVE     TOTDAYS,TOTBDAY          * For casemix funding
.
          MOVE     ZERO,TOTDAYS           *** reset to zero
          MOVE     ZERO,BDAYSCNT
          MOVE     ZERO,SUMDAYS
          ADD      ADYHOSP,BDAYSCNT
          ADD      BDAYSCNT,SUMDAYS
.
          MOVE     CDD,CRDAY
          MOVE     CMM,CRMON
          MOVE     CCC,CRCENT
          MOVE     CYY,CRYEAR
          REP      " 0",CRDAY
          REP      " 0",CRMON
          REP      " 0",CRCENT
          REP      " 0",CRYEAR
          MOVE     SP8,PCENDDTE
INVR9999  RETURN
+
.*******************************************************************************
.         Check if Revenue breakdown exists                        
.*******************************************************************************
CHRB0000  MOVE      ZERO,REVEXIST
.
          BRANCH    DCFLAG,CHRB5000
.
          OPEN      PATOVBA1,"patovbaf"
.
          PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          CALL      RSPTOVB1
          CALL      RKPTOVB1
          BRANCH    OVRCD,CHRB9000
.
          MATCH     PTOBCNID,CONTRCID        * Same Contract Id?
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTOBCODE,ACLAIM
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTOBFUND,AFUNDH
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTOBTBLT,PTHFBCAT
          GOTO      CHRB9000 IF NOT EQUAL 
.
          MATCH     PTOBCSCD,CMCODE
          GOTO      CHRB9000 IF NOT EQUAL
.
          MOVE      ONE,REVEXIST
          GOTO      CHRB9999
.
CHRB5000  OPEN      PATSRBA1,"patsrbaf"
          PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          CALL      RSPTSRB1
          CALL      RKPTSRB1
          BRANCH    OVRCD,CHRB9000
.
          MATCH     PTSBCNID,CONTRCID        * Same Contract Id?
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTSBCODE,ACLAIM
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTSBFUND,AFUNDH
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTSBTBLT,PTHFBCAT
          GOTO      CHRB9000 IF NOT EQUAL
.
          MATCH     PTSBCSCD,CMCODE
          GOTO      CHRB9000 IF NOT EQUAL
          MOVE      ONE,REVEXIST
          GOTO      CHRB9999
.
CHRB9000  MOVE      ZERO,REVEXIST
.
CHRB9999  RETURN
+
.*******************************************************************************
.         This subroutine displays/writes one accommodation record
.*******************************************************************************
FNDT0000  MOVE      ZERO,NODAYS
          IF        (IPATFLAG=1 | IPATFLAG=2) & NCHACCOM=1
            GOTO      FNDT9999           * Patient Only with No accom.charge
          ENDIF
.
          COMPARE   ONE,DCFLAG
          GOTO      FNDT0500 IF NOT EQUAL
.
          UNPACK    IDATET INTO TCENT1,TYEAR1,TMON1,TDAY1
          MOVE      ZERO,NODAYS
          CALL      CDAY0000             * calc. no of days in the period
          COMPARE   NODAYS,ZERO
          GOTO      FNDT0200 IF NOT LESS
.
          COMPARE   ONE,DISFLG
          GOTO      FNDT0100 IF NOT EQUAL
.
          CMATCH    ANSL,TMOVE
          GOTO      FNDT0100 IF EQUAL
          CMATCH    ANSR,TMOVE
          GOTO      FNDT0100 IF EQUAL
          CMATCH    ANSA,TMOVE       * not discharged, so charged on adm.
          GOTO      FNDT2000 IF NOT EQUAL
.
FNDT0100  CALL      CHKACCM0           * Check if accom.has been charged
          BRANCH    EXIT,FNDT2000      * Found accommodation record
          MOVE      ONE,NODAYS
          GOTO      FNDT5000
.
.        Real daycase will have lumpsum charge only
.
FNDT0200  MOVE      ZERO,PATLNTOT
          MOVE      ZERO,PATLNGST
          MOVE      ZERO,PATARATE
          MOVE      ZERO,PATHRATE
          MOVE      ZERO,PATLRATE
          MOVE      ZERO,FNDLRATE
.
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
          MOVE      ZERO,LSTRATE
          MOVE      ZERO,SPTTRADP
          MOVE      ZERO,SPTTRADR
          MOVE      ZERO,STRATEF
          MOVE      ZERO,STRATEH
.
          IF        PROGFLAG=3 & IPATFLAG=2
            IF        SPTTRLSP<>0 | SPTTRLSR<>0
              MOVE      ZERO,PATHRATE
              MOVE      ZERO,PATLRATE
              MOVE      ZERO,FNDLRATE
              CALL      WRHR0000          * Write Rebate portion to HF Debtor
              MOVE      ZERO,SPTTRADP
              MOVE      ZERO,SPTTRADR
            ENDIF
          ENDIF
.
          MOVE      ACCMTOT,ACTOTAL
          IF        INVDFLAG=1
            IF        SPTTRLSP<>0 | SPTTRLSR<>0
              MOVE     ZERO,STRATEF
              MOVE     ZERO,STRATEH
              MOVE     ZERO,STALLW
              MOVE     ZERO,STDISC
              CALL     WACRD000           * write to invoice details file
            ENDIF
          ENDIF
          MOVE      ZERO,PTDTEPSD
          IF        MVBFLAG=1
            MOVE      ONE,PTDTEPSD       * Flag for billing mechanical vent.
          ENDIF
          GOTO      FNDT6000
.
FNDT0500  CALL      CDAY0000       * calc. no of days in the period
.
.         Check zero bed days (ie. From date == To date)
.
          COMPARE   ZERO,NODAYS
          GOTO      FNDT5000 IF NOT EQUAL
.
.         Check if this is the "D" record
.
          CMATCH    "D",TMOVE
          GOTO      FNDT0700 IF EQUAL
.
.         Check if Current admission (admitted on current date) has a
.         lumpsum amount only
.
          IF        INVDFLAG=1 & (SPTTRLSP<>0 | SPTTRLSR<>0)
            MOVE      ZERO,PATLNTOT
            MOVE      ZERO,PATLNGST
            MOVE      ZERO,PATARATE
            MOVE      ZERO,PATHRATE
            MOVE      ZERO,PATLRATE
            MOVE      ZERO,FNDLRATE
.
            MOVE      ZERO,LINETOT
            MOVE      ZERO,LINEGST
            MOVE      ZERO,LSTRATE
            MOVE      ZERO,SPTTRADP
            MOVE      ZERO,SPTTRADR
            MOVE      ZERO,STRATEF
            MOVE      ZERO,STRATEH
            MOVE      ZERO,STRATEF
            MOVE      ZERO,STRATEH
            MOVE      ZERO,STALLW
            MOVE      ZERO,STDISC
            CALL      WACRD000           * write to invoice details file
            GOTO      FNDT9990
          ENDIF
          GOTO      FNDT9999
.
.         Check if this is really a day case
.
FNDT0700  MATCH     ADATE,DDATE
          GOTO      FNDT1200 IF NOT EQUAL
.
          COMPARE   ZERO,AINVPRT                 * Invoice printed yet ?
          GOTO      FNDT1000 IF EQUAL            * No.
.
          CALL      CHKACCM0           * Check if accommodation has been charged
          BRANCH    EXIT,FNDT2000       * Found accommodation record
.
FNDT1000  MOVE      ONE,NODAYS
          GOTO      FNDT5000
.
FNDT1200  COMPARE   ZERO,PARTFLAG
          GOTO      FNDT5000 IF NOT EQUAL        * Charge half day
.
.         Update the discharged record with the new bed fee, only when
.         printing invoice
.
FNDT2000  COMPARE   THREE,PROGFLAG
          GOTO      FNDT9990 IF NOT EQUAL
.
          BRANCH    CMXFLAG,FNDT9990
.
          COMPARE   ONE,CSTDOWN
          GOTO      FNDT9990 IF NOT EQUAL              * change label  *C-90304
.
          MOVE      SKEY30,KEY30          * reposition                 *I-90221
          CALL      RDTRAN2                                            *I-90221
.
          MOVE      STRATEF,TRATEF                                     *C-90221
          MOVE      STRATEH,TRATEH
          MOVE      SPTTRADP,PTTRADPT
          MOVE      SPTTRADR,PTTRADRB
          MOVE      SPTTRITF,PTTRITFS
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      FNDT9990                           * change label  *C-90304
.
.         Get the accommodation description and calculate the rates
.
FNDT5000  IF        CFEETYP=5
            CALL      NZACM000          * Get NZ priv.accommodation
          ELSE
            CALL      GETACCM
            MOVE      ZERO,NOFEE
          ENDIF
.
.         Display or write the accommodation record depends on the program flag
.
FNDT6000  IF        DBSFLAG=1
            CALL      DBAC0000          * Display Discharge Billing Statement
            CALL      MTDNFD00          * Move to date to next from date
            GOTO      FNDT9990
          ENDIF
.
          IF        IPATFLAG=2
            CALL      XPRG0000          * New Patient Invoice functionality
            CALL      MTDNFD00          * Move to date to next from date
            GOTO      FNDT9990
          ENDIF
.
          IF        CFEETYP=5
            CALL      SXAC0000          * Display/Print Accom.for Southern Cross
            GOTO      FNDT9990
          ENDIF
.
          IF        CFEETYP=9
            CALL      JHAC0000          * Display/Print JH Accommodation
            GOTO      FNDT9990
          ENDIF
.
          CALL      CPRG0000
.
FNDT9990  MOVE      ZERO,SPTTRLSP       * initialise lumpsum amount    *C-90304
          MOVE      ZERO,SPTTRLSR
          MOVE      SP70,PTDTDES2
          UNPACK    SP70,PTDTLSD1,PTDTLSD2
          UNPACK    SP70,LSDESC1,LSDESC2
.
FNDT9999  RETURN
+
.*******************************************************************************
.         Calculate the number of days in period
.*******************************************************************************
CDAY0000  UNPACK    IDATET INTO TCENT1,TYEAR1,TMON1,TDAY1
          DAYSEP    IDATEF,IDATET,NODAYS
.
          BRANCH    ENDFLAG,CDAY9999
.
          MATCH     "U",SQLDTMOV
          GOTO      CDAY1000 IF EQUAL     * previous movement was Unqualified
.
          MATCH     "R",TMOVE
          IF        !@EQUAL
            ADD       NODAYS,SUMDAYS
          ENDIF
.
.         Check if an extra day is to be charged (for day of discharge or
.         day of leave)
.
CDAY1000  MATCH     ANSD,TMOVE                   * discharge - so charge extra
          GOTO      CDAY8000 IF EQUAL
.
.         Non workcare patient, will not charge on leave
.
          COMPARE   ZERO,WCAREFLG
          GOTO      CDAY9999 IF EQUAL
.
          MATCH     ANSL,TMOVE                   * on leave - so charge extra
          GOTO      CDAY2000 IF EQUAL
.
          GOTO      CDAY9999                     * don't charge extra day
.
CDAY2000  MOVE      TDATE,XDATE                  * save transfer date
          CALL      RDKTRAN2                     * read next transfer record
          BRANCH    OVRCD,CDAY4000               * end of file
.
          MATCH     DTADMN,DAADMNO               * same patient ?
          GOTO      CDAY4000 IF NOT EQUAL        * no
.
          MATCH     TDATE,XDATE                  * same transfer date ?
          GOTO      CDAY4000 IF NOT EQUAL        * no
.
          GOTO      CDAY5000
.
CDAY4000  ADD       XTRADAY,NODAYS
CDAY5000  CALL      RDPTRAN2                     * read original record
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE     * Use ICD10 Suggested Class.
          ENDIF
          GOTO      CDAY9999
.
CDAY8000  ADD       XTRADAY,NODAYS
.
CDAY9999  RETURN
+
.*******************************************************************************
.         Initialize the description
.*******************************************************************************
GETACCM   MOVE      SP30,TDDESC
          MOVE      SP30,TEDESC
          MOVE      ZERO,TOTXTRA
          MOVE      SP70,BEDDESC
          MOVE      SP70,ACCMDESC
          MOVE      ZERO,PTDTEPSD       * Flag for billing mechanical vent.
          MOVE      ZERO,LSTDAYS
.
          IF        MVBFLAG=1
            MATCH     IDATET,ENMVDATE
            IF        @EQUAL
              CLEAR     TDDESC
              APPEND    "Mechanical Ventilation ",TDDESC
              APPEND    "(",TDDESC
              APPEND    STWARD,TDDESC
              APPEND    SLASH,TDDESC
              APPEND    STBED,TDDESC
              APPEND    ")",TDDESC
              APPEND    SP70,TDDESC
              RESET     TDDESC
.
              CLEAR     ACCMDESC
              APPEND    "Mechanical Ventilation ",ACCMDESC
              APPEND    "(",ACCMDESC
              APPEND    STWARD,ACCMDESC
              APPEND    SLASH,ACCMDESC
              APPEND    STBED,ACCMDESC
              APPEND    ")",ACCMDESC
              APPEND    SP70,ACCMDESC
              RESET     ACCMDESC
.
              MOVE      ONE,PTDTEPSD       * Flag for billing mechanical vent.
              CALL      CBED0000           * Check for ICU/CCU/NNU bed
              GOTO      GACC8000
            ENDIF
          ENDIF
.
          IF        ERDTFLAG=1
            MOVE      "No Pay Day             ",TDDESC
            MOVE      "No Pay Day             ",ACCMDESC
            CALL      ADON0000                * Check Add on on No Pay day
            GOTO      GACC8000
          ENDIF
.
          COMPARE   ONE,CMXFLAG
          IF        @EQUAL
            MATCH     "U",SQLDTMOV
            GOTO      GACC4000 IF EQUAL
          ENDIF
.
.         Check if this is an on-leave period
.
          MATCH     SP3,STWARD
          GOTO      GACC1000 IF NOT EQUAL
.
.         Description for on-leave
.
          MOVE      "PATIENT ON LEAVE         ",TDDESC
          MOVE      "PATIENT ON LEAVE         ",ACCMDESC
.
          MOVE      ZERO,PATLNTOT
          MOVE      ZERO,PATLNGST
.
          MOVE      ZERO,LINETOT
          MOVE      ZERO,LINEGST
.
          BRANCH    ISBLFLAG,GACC0800         * Always charge on leave
          MATCH     "1",PTCNCHGL
          GOTO      GACC8000 IF NOT EQUAL     * on leave - no charge
.
GACC0800  MOVE      LSTRATE,LINETOT
          MULT      NODAYS,LINETOT
.
          MOVE      PATLRATE,PATLNTOT
          MULT      NODAYS,PATLNTOT
.
GACC0900
          IF        IBCNUGST=2
            MOVE      LINETOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,LINEGST
.
            MOVE      PATLNTOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PATLNGST
          ENDIF
.
          GOTO      GACC7900
.
.         Normal Accommodation record
.
GACC1000  COMPARE   ONE,CMXFLAG
          GOTO      GACC2020 IF NOT EQUAL   * Not a casepayment
.
          BRANCH    DCFLAG,GACC2010
.
.         Overnight
.
          MOVE      BDAYS,FORM4B   * save the bed days
          MOVE      SUMDAYS,BDAYS
.
.         If this is pre-op casepayment, we need to subtract no days of
.         perdiem prior casemix
.
          IF        NPDAYFLG<>0
            MOVE      ZERO,FORM4
            DAYSEP    ADATE,PCENDDTE,FORM4
            IF        FORM4<BDAYS
              SUB       FORM4,BDAYS
            ENDIF
          ENDIF
.
          CALL      DCHR0000     * get desc.for daily charge
.
.         Additional rate stepdown
.
          MOVE      ZERO,BTDAYS
          MOVE      TDATE,TODATE
          MOVE      SAVBTYP,DIM3      * save the current bed type
          MOVE      STRBTYP,SAVBTYP
          MOVE      STEPFLAG,FORM2    * Save
          MOVE      ZERO,STEPFLAG     * get desc.without extra day
          CALL      ADIP0000          * get desc from additional rate fee
          MOVE      FORM2,STEPFLAG
          MOVE      DIM3,SAVBTYP
.
          MOVE      FORM4B,BDAYS   * restore the bed days
          GOTO      GACC2015
.
.         sameday patient
.
GACC2010  CALL      GTAB0000       * get table type
          CALL      ADID0000       * get desc.from additional charge file
.
GACC2015  PACK      SAVDES1,SAVDES1,SP70
          PACK      SAVDES2,SAVDES2,SP70
.
          MATCH     SP30,SAVDES1
          IF        @EQUAL
            PACK      KEY6 WITH STWARD,STBED
            CALL      RDWARD1
            PACK      TDDESC,WBDESC,SP70
            PACK      ACCMDESC,WBDESC,SP70
          ELSE
            PACK      TDDESC,SAVDES1,SP70
            PACK      ACCMDESC,SAVDES1,SP70
            PACK      PTDTDES2,SAVDES2,SP70
          ENDIF
          RESET     TDDESC,20
          STRIP     ACCMDESC
          ENDSET    ACCMDESC
.
          GOTO      GACC7000
.
.         Per-diem
.
GACC2020  COMPARE   ZERO,CFEETYP
          GOTO      GACC4000 IF EQUAL
.
          BRANCH    JHFLAG,GACC4000          * get acc.desc.for Johns Hopkins
.
          BRANCH    CFEETYP,GACC3000,GACC7000,GACC7000,GACC2100
          GOTO      GACC7000
.
.         Get the board rate description, and set the number of invoice flag
.
GACC2100  PROC      BRDDS000                 * get the description
          GOTO      GACC7000
.
.         Set up description for public hospital
.
GACC3000  OPEN      PATRATE1,"patratef"
          PACK      KEY12 WITH ACLAIM,STATYPE,ACLSS,STCHSTAT
.
          CALL      RDRATE1
          BRANCH    OVRCD OF GACC3600
.
          MOVE      RCEDES,TEDESC
          RESET     TEDESC,20
          IF        !(PROGFLAG=3 & PTCNPRWD=1)
            APPEND    "(",TEDESC
            APPEND    STWARD,TEDESC
            APPEND    SLASH,TEDESC
            APPEND    STBED,TEDESC
            APPEND    ")",TEDESC
          ENDIF
          RESET     TEDESC
.
          MOVE      RCPDES,TDDESC
          RESET     TDDESC,20
.
          MOVE      RCPDES,ACCMDESC
          STRIP     ACCMDESC
          ENDSET    ACCMDESC
.
          PACK      PTDTDES2,SP20,SP20
.
GACC3600  CLOSE     PATRATE1
          GOTO      GACC7000
.
.         Using the PATBFEE file for rate.
.
GACC4000  OPEN      PATBFEE1,"patbfeef"
          IF        CFEETYP=9
            OPEN      JHSBFEA1,"jhsbfeaf"
          ENDIF
          MOVE      ZERO,USEDEF
.
          MATCH     SP3,STRBTYP
          GOTO      GACC4400 IF NOT EQUAL
.
          PACK      KEY6 WITH STWARD,STBED
          CALL      RDWARD1
          BRANCH    OVRCD OF GACC6000
.
          MOVE      WEFRBT,STRBTYP
.
GACC4400  CALL      GTAB0000       * get table type
          PACK      DIM24 WITH SAVCONTR,ACLAIM,AFUNDH,PTHFBCAT,STATYPE,STRBTYP
          PACK      DIM23 WITH ACLAIM,AFUNDH,AFNDTB,STATYPE,STRBTYP
          GOTO      GACC4800
.
GACC4500  PACK      DIM24,SAVCONTR,ACLAIM,SP6,SP3,STATYPE,STRBTYP
          PACK      DIM23 WITH ACLAIM,SP6,SP8,STATYPE,STRBTYP
          MOVE      ONE,USEDEF
          GOTO      GACC4800
.
GACC4600  CALL      DCLM0000                * Check Hospital claim code charging
          PACK      DIM24,SAVCONTR,PTCNDCLM,SP6,SP3,STATYPE,STRBTYP
          PACK      DIM23 WITH PTCNDCLM,SP6,SP8,STATYPE,STRBTYP
          MOVE      TWO,USEDEF
.
.         Read in the description
.
GACC4800  BRANCH    PCFLAG,GACC4900,GACC4900,GACC4900
.
          PACK      KEY5,ANSB,ANST,STRBTYP
          CALL      RDCODE1
          IF        OVRCD=0
            REP        " 0",TCINDC6
            MOVE       ZERO,FORM1
            MOVE       TCINDC6,FORM1        * check for specialty bedtype
            COMPARE    ZERO,FORM1
            GOTO       GACC5000 IF EQUAL    * normal bed type
            GOTO       GACC4900             * Specialty bed
          ENDIF
          GOTO      GACC5000
.
GACC4900  BRANCH    STEPNO,GACC4920       * manual stepdown
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MATCH     ANSA,STMOVE
            GOTO      GACC5000 IF EQUAL     * recalculate 
          ENDIF
.
          MATCH     IDATEF,ADATE
          IF        @EQUAL
            COMPARE   ZERO,ADYHOSP
            GOTO      GACC5000 IF NOT EQUAL
          ENDIF
.
.         If the previous transaction record is 'A',  we need to recalculate
.         the fees, just in case Days of hospitalisations has been changed
.
GACC4920  MATCH     ANSA,STMOVE
          GOTO      GACC4930 IF NOT EQUAL
.
          COMPARE   ZERO,STEPNO
          GOTO      GACC5000 IF EQUAL            * Not a force stepdown
.
GACC4930  MOVE      ZERO,F3
          IF        STEPNO=2
            MOVE      ZERO,CALDAYS
            DAYSEP    FRDATE,IDATEF,CALDAYS
            ADD       ADYHOSP,CALDAYS
            MOVE      CALDAYS,LSTDAYS
            GOTO      GACC5000            * Accom.from Start of New Contract
          ENDIF
.
          IF        STEPNO=1
            MOVE      SAVETRN,F3
          ELSE
            MOVE      STRBEND,F3
          ENDIF
          COMPARE   ZERO,F3
          GOTO      GACC5000 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          IF        CFEETYP<>9
            BRANCH    EXIT,GACC7000        * Invalid Contract Effective details
            OPEN      PATBFEE3,"patbfeef"
            PACK      KEY27 WITH DIM24,F3,SP70
            CALL      RDBFEE3
          ELSE
            PACK      KEY26 WITH DIM23,STRBEND
            CALL      RDJHBFE1
          ENDIF
          COMPARE   ZERO,OVRCD
          GOTO      GACC6400 IF EQUAL
.
GACC5000  PACK      KEY27 WITH DIM24,SP3
          PACK      KEY26 WITH DIM23,SP3
          IF        CFEETYP=9
            CALL      RSJHBFE1
          ELSE
            OPEN      PATBFEE3,"patbfeef"
            CALL      RDSBFEE3
          ENDIF
GACC5600  IF        CFEETYP=9
            CALL      RKJHBFE1
          ELSE
            CALL      RDKBFEE3
          ENDIF
          BRANCH    OVRCD OF GACC6000
.
          IF        CFEETYP=9
            PACK      DIM23A,BFCLM,BFHFUND,BFHFTAB,BFATYPE,BFBTYPE
            MATCH     DIM23,DIM23A
            GOTO      GACC6000 IF NOT EQUAL
          ELSE
            PACK      DIM24A,PTBFCNID,BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE
            MATCH     DIM24,DIM24A
            GOTO      GACC6000 IF NOT EQUAL
          ENDIF
.
.         Check if this is a manual stepdown on daycase rate
.
GACC5680  COMPARE   ZERO,BFENDDY
          GOTO      GACC5700 IF NOT EQUAL
.
          COMPARE   ZERO,BDAYSCNT
          GOTO      GACC5800 IF NOT EQUAL
.
          BRANCH    STEPNO,GACC6400       * manual stepdown using daycase
.
          BRANCH    ACDAYCS OF GACC6400
          GOTO      GACC5600
.
GACC5700  COMPARE   ONE,ACDAYCS
          GOTO      GACC5800 IF NOT EQUAL       * not a daycase
          COMPARE   BDAYSCNT,ADYHOSP
          GOTO      GACC5800 IF NOT EQUAL
.
.         COMPARE   BDAYSCNT,BFENDDY
.         GOTO      GACC5600 IF LESS
.
.         If days of Hosp. equals to Endday, get the next Bed fees Desc.
.
          COMPARE   BFENDDY,BDAYSCNT
          GOTO      GACC5600 IF NOT LESS
.
          GOTO      GACC6400
.
.         Check the number of days
.
GACC5800  IF        STEPNO=2
            IF        (BFENDDY=999) & (LSTDAYS>999)
              GOTO      GACC6400
            ENDIF
            COMPARE   BFENDDY,LSTDAYS           * Days to Start of New Contract
            GOTO      GACC6400 IF LESS
          ELSE
            IF        (BFENDDY=999) & (BDAYSCNT>999)
              GOTO      GACC6400
            ENDIF
            COMPARE   BFENDDY,BDAYSCNT
            GOTO      GACC6400 IF LESS
          ENDIF
.
          GOTO      GACC5600
.
GACC6000  BRANCH    USEDEF OF GACC4600,GACC7000
          GOTO      GACC4500
.
.         We have found the description
.
GACC6400  MOVE      BFDESC,TDDESC
          RESET     TDDESC,20
.
          MOVE      BFDESC,ACCMDESC
          STRIP     ACCMDESC
          ENDSET    ACCMDESC
.
          PACK      PTDTDES2,SP20,SP20
.
          BRANCH    JHFLAG,GACC7200
.
.         Check if two invoices are wanted
.
          LOAD      NUMINVS USING BFNINV OF NUMINVS,TWO
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            MOVE      NUMBINVR,NUMINVS  * No of Invoice from contract
          ENDIF
.
.         Add the ward/bed to the description
.
GACC7000  IF        !(PROGFLAG=3 & PTCNPRWD=1)
            APPEND    "(",TDDESC
            APPEND    STWARD,TDDESC
            APPEND    SLASH,TDDESC
            APPEND    STBED,TDDESC
            APPEND    ")",TDDESC
.
            APPEND    " (",ACCMDESC
            APPEND    STWARD,ACCMDESC
            APPEND    SLASH,ACCMDESC
            APPEND    STBED,ACCMDESC
            APPEND    ")",ACCMDESC
          ENDIF
          RESET     TDDESC
          RESET     ACCMDESC
.
          CALL      CBED0000           * Check for ICU/CCU/NNU bed
.
.         Calculate the amount of rate extra charge for Public Hospital
.
          MOVE      STEXTRA,TOTXTRA
          MULT      NODAYS,TOTXTRA
.
.         Calculate the amount for the accommodation line
.
GACC7200  MOVE      LSTRATE,LINETOT
          MULT      NODAYS,LINETOT
.
          MOVE      PATLRATE,PATLNTOT
          MULT      NODAYS,PATLNTOT
.
          MOVE      ZERO,LINEGST
          MOVE      ZERO,PATLNGST
          IF        IBCNUGST=2
            MOVE      LINETOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,LINEGST
.
            MOVE      PATLNTOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PATLNGST
          ENDIF
.
          COMPARE   ONE,PARTFLAG
          GOTO      GACC7900 IF NOT EQUAL     * Not partial charge
.
          PACK      KEY8,TCENT1,TYEAR1,TMON1,TDAY1
          REP       " 0",KEY8
          MATCH     KEY8,DDATE
          GOTO      GACC7900 IF NOT EQUAL     * Not a discharge record
.
          MOVE      LSTRATE,FORM12P2
          DIV       TWO,FORM12P2              * 50% discount
          ADD       FORM12P2,LINETOT
          IF        IBCNUGST=2
            MOVE      FORM12P2,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            ADD       GSTWORK,LINEGST
          ENDIF
.
          MOVE      PATLRATE,FORM12P2
          DIV       TWO,FORM12P2              * 50% discount
          ADD       FORM12P2,PATLNTOT
          IF        IBCNUGST=2
            MOVE      FORM12P2,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            ADD       GSTWORK,PATLNGST
          ENDIF
.
.         Add up the health fund accommodation
.
GACC7900  MOVE      STRATEH,FORM62
          IF        CMXFLAG=1
            ADD       SPTTRADR,FORM62
          ENDIF
          MULT      NODAYS,FORM62
          ADD       FORM62,HFACCM
.
.         Add up the total number of days
.
          ADD       NODAYS,TOTDAYS
.
.         Calculate Government Subsidy (if any)
.
          MOVE      ZERO,SAMTG
          COMPARE   TWO,AELIG
          GOTO      GACC8000 IF EQUAL
.
          MOVE      STRATEG,SAMTG
          MULT      NODAYS,SAMTG
          ADD       SAMTG,GOVTOTAL
.
.         Add up Gross total and Accommodation total
.
GACC8000  ADD       LINETOT,GROSSTOT
          ADD       TOTXTRA,GROSSTOT
          IF        IBCNUGST=2
            ADD       LINEGST,TOTGST
          ENDIF
.
          ADD       LINETOT,ACCMTOT
          ADD       TOTXTRA,ACCMTOT
          ADD       LINETOT,TOTACCM                                    *I-90226
          ADD       TOTXTRA,TOTACCM                                    *I-90226
.
GACC8300  MOVE      ACCMTOT,ACTOTAL
.
.         Get rid of leading zero's for date display
.
          MOVE      FDAY1,DD
          MOVE      FMON1,MM
          MOVE      FYEAR1,YY
          MOVE      FCENT1,CC
          MOVE      DD,FDAY1
          MOVE      MM,FMON1
          MOVE      YY,FYEAR1
          REP       " 0",FYEAR1
          MOVE      CC,FCENT1
.
          MOVE      TDAY1,DD
          MOVE      TMON1,MM
          MOVE      TYEAR1,YY
          MOVE      TCENT1,CC
          MOVE      DD,TDAY1
          MOVE      MM,TMON1
          MOVE      YY,TYEAR1
          REP       " 0",TYEAR1
          MOVE      CC,TCENT1
.
          CALL      PROACC00     * Do any miscellaneous Accommodation proc
.
          IF        INVDFLAG=1
            CALL      WACRD000              * write to invoice details file
          ENDIF
GACC9999  RETURN
+
.*******************************************************************************
.         Check for CCU/ICU/NNU bed
.*******************************************************************************
CBED0000  MOVE      SP70,BEDDESC
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*228,PTCNHCCC
          BRANCH    PTCNHCCC,CBED2000
.
.         Using admin type for CCU/ICU/NNU
.
          MATCH     SP3,STATYPE
          GOTO      CBED9999 IF EQUAL
.
          PACK      KEY5,ANSA,SP1,STATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CBED9999
          GOTO      CBED3000
.
.         Using bed type for CCU/ICU/NNU
.
CBED2000  MATCH     SP3,STRBTYP
          GOTO      CBED9999 IF EQUAL
.
          PACK      KEY5,ANSB,ANST,STRBTYP
          CALL      RDCODE1
          BRANCH    OVRCD,CBED9999
.
CBED3000  MATCH     "1",TCINDC2
          GOTO      CBED4000 IF EQUAL
.
          MATCH     "1",TCINDC9
          GOTO      CBED4000 IF EQUAL            * ICU
.
          MATCH     "3",TCINDC9
          GOTO      CBED5000 IF EQUAL            * CCU
.
          MATCH     "6",TCINDC9
          GOTO      CBED6000 IF EQUAL            * NNU
          GOTO      CBED9999
.
CBED4000  APPEND    "(ICU",BEDDESC
          GOTO      CBED8000
.
CBED5000  APPEND    "(CCU",BEDDESC
          GOTO      CBED8000
.
CBED6000  APPEND    "(NNU",BEDDESC
.
CBED8000  APPEND    " Certificate)",BEDDESC
          APPEND    SP70,BEDDESC
          RESET     BEDDESC
.
CBED9999  RETURN
+
.*******************************************************************************
.         DCHR0000- get description for casemix daily charge
.               Normal daily rate stepdown
.*******************************************************************************
DCHR0000  MOVE      ZERO,EXIT
.
.         Both DLOW0000 & DCHC0000 use BDAYS to get the current Rates -
.         we need the previous Description, so back up 1 day
.
          IF        SPTTREPS=1
            MOVE      STRBEND,BDAYS
          ENDIF
          SUB       ONE,BDAYS
.
          IF        ASTAT = 3 & LOWFLAG = 1
            CALL      DLOW0000   * get desc.from low outliers daily fee
          ELSE
            CALL      DHGH0000    * get desc.from high outliers dailyfee 
            LOAD      LOWFLAG,PTHDDTYP,TWO,THREE
          ENDIF
.
          ADD       ONE,BDAYS               * restore Bed-days         *I-47732
.
DCHR9999  RETURN
+
.*******************************************************************************
.         CPRG0000- Display/write accommodation record depends on the 
.                   program flag
.*******************************************************************************
CPRG0000  MOVE      LSTRATE,XLSTRATE
          MOVE      LINETOT,XLINETOT
          MOVE      LINEGST,XLINEGST
.
          MOVE      ONE,FRSTACCM
          ADD       PATLNGST,PATLNTOT
.
.         Include Accommodation Patient payable if HF portion is zero
.
          MATCH     "1",PTCNPPIN
          GOTO      CPRG0400 IF NOT EQUAL
.
          COMPARE   ZERO,PACMCHRG
          GOTO      CPRG0400 IF EQUAL
.
          IF        PACMCHRG=1 & HFACCM=0
            GOTO      CPRG0400
          ENDIF
          GOTO      CPRG1000
.
CPRG0400  ADD       PATLNTOT,PPAYABLE
          ADD       PATLNGST,TOTPGST
.
CPRG1000  BRANCH    PROGFLAG OF CPRG8000,CPRG2000,CPRG5000,CPRG6000,CPRG9999
.
CPRG2000  CALL      DACM0000       * Display accommodation record
          CALL      SCPAY0000      * Set co-payment for private/shared
          GOTO      CPRG8000
.
.         Print the accommodation line
.
CPRG5000  MOVE      STATYPE,TADMTYP
          PACK      DFDATE,FCENT1,FYEAR1,FMON1,FDAY1,SP70
          PACK      DTDATE,TCENT1,TYEAR1,TMON1,TDAY1,SP70
.
          IF        CMXFLAG=1
            MATCH     ADATE,DDATE
            IF        @EQUAL
              IF        LSTRATE = 0
                GOTO      CPRG5400          * daycase without daily charge
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ONE,RECFLAG     * flag for printing accommodation
          CALL      PRLN0000        * Print line of invoice
.
.         Set up DTRAN record ready for writing
.
CPRG5400  CALL      WADT0000                  * Write DTR fro accommodation
.
CPRG6000  CALL      WAFN0000                  * Set up key for a call to PATCALF
.
CPRG8000  CALL      MTDNFD00                  * Move to date to next from date
.
CPRG9000  MOVE      ZERO,EXIT
CPRG9999  RETURN
+
.*******************************************************************************
.         Write accommodation to DTR
.*******************************************************************************
WADT0000  IF        CMXFLAG = 1 & DCFLAG=1
            BRANCH    ADSCHI,WADT9999   * patient discharged invoiced
          ENDIF
.
          MOVE      ZERO,TPAYTYPE
          MOVE      "P" TO TTYPEDEB
          MOVE      "DB",TTYPE
          MOVE      ONE,TRECTYPE      (1 = ACCOMMODATION)
          MOVE      ZERO,TCLAIM      *** set up as not yet claimed 3/9/86
.
          MOVE      LINETOT,TPATAMTT
          MOVE      LSTRATE,TPATAMTI
          MOVE      ZERO,TPATAMTP                                      *I-47440
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MOVE      SP70,TMISGRP
.
          MOVE      STRATEF,TPATAMTH         *** save original rate
          MOVE      STRATEH,TREBATE
          IF        CMXFLAG=1
            ADD       SPTTRADP,TPATAMTH
            ADD       SPTTRADR,TREBATE
            MOVE      SPTTRADP,PTDTADPT
            MOVE      SPTTRADR,PTDTADRB
            IF        PTDTADPT<>0 | PTDTADRB<>0
              MOVE      SAVMSGRP,TMISGRP     * Category FI for additional rate
            ENDIF
          ENDIF
          MOVE      SPTTRLSR,PTDTLSRB
          MOVE      SPTTRLSP,PTDTLSPT
          MOVE      LSDESC1,PTDTLSD1
          MOVE      LSDESC2,PTDTLSD2
.
          IF        IPASS=1 | DBSFLAG=1
            MOVE      SPTTRLSP,PTDTLSPT
            MOVE      ZERO,PTDTLSRB
          ELSE
            IF        IPASS=2
              MOVE      SPTTRLSR,PTDTLSRB
              MOVE      ZERO,PTDTLSPT
            ENDIF
          ENDIF
.
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTL
          MOVE      SP10,PTDTGSTC
          IF        IBCNUGST=2
            MOVE      TPATAMTT,PTDTGSTM
            MULT      GSTPCEN,PTDTGSTM     * GST amount
            DIV       "100.00",PTDTGSTM    * Divide by 100 to get wanted fig.
            MOVE      PTCNAGST,PTDTGSTC    * Accommodation GST code
.
            MOVE      PTDTLSRB,PTDTGSTL
            ADD       PTDTLSPT,PTDTGSTL    * lumpsum
            MULT      GSTPCEN,PTDTGSTL     * GST amount
            DIV       "100.00",PTDTGSTL    * Divide by 100 to get wanted fig.
          ENDIF
          MULT      NODAYS,TREBATE
.
          MOVE      SAMTG,TPATAMTG
.
          MOVE      NODAYS,TNODAYS
.
          MOVE      STWARD,TDWARD          * set up new DTRAN variables
          MOVE      STATYPE,TADMTYP        * when printing invoice
          MOVE      ACLAIM,TCLMTYP
          MOVE      STRBTYP,PTDTBTYP
.
          MOVE      ZERO,FORM62
          IF        CMXFLAG=1
            MOVE      SPTTRADP,FORM62
            ADD       SPTTRADR,FORM62
          ENDIF
          IF        FORM62 = 0
            MOVE      ZERO,PTDTCCU         * no additional charges
          ELSE
            MOVE      ONE,PTDTCCU          * flag for CCU
          ENDIF
.
          MOVE      ACLAIM,PTTRCLTY
          MOVE      CONTRCID,PTDTCNID      * Contract ID
          MOVE      SP1,PTDTCRST
          CALL      WRITETRN
.
.         If we have extra's, then write a DTRA record for them too
.
          COMPARE   ZERO,STEXTRA
          GOTO      WADT9999 IF EQUAL
.
          MOVE      TOTXTRA,TPATAMTT
          MOVE      STEXTRA,TPATAMTI
          MOVE      ZERO,TPATAMTG
          MOVE      STEXTRA,TPATAMTH         *** save original rate
          MOVE      ZERO,TREBATE
          MOVE      TEDESC,TDDESC
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTL
          MOVE      SP10,PTDTGSTC
          MOVE      ZERO,TPAYTYPE
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
.
          IF        IBCNUGST=2
            MOVE      TPATAMTT,PTDTGSTM
            MULT      GSTPCEN,PTDTGSTM     * GST amount
            DIV       "100.00",PTDTGSTM    * Divide by 100 to get wanted fig.
            MOVE      PTCNAGST,PTDTGSTC    * Accommodation GST code
          ENDIF
.
          CALL      WRITETRN
.
WADT9999  RETURN
+
.*******************************************************************************
.         Write accommodation to financial file
.*******************************************************************************
WAFN0000
.         Set up key for a call to PATCALF
          PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
.
          MOVE      LINETOT,FINAMT
          ADD       TOTXTRA,FINAMT
.
          MOVE      SAMTG,TPATAMTG
          SUB       SAMTG,FINAMT
          MOVE      "A",FINTYPE
.
          IF        CMXFLAG = 1
            MOVE      ANSD,ANS
            IF        CACCFEE=5
              PACK      FINCODE,ANS,ACLAIM,SP20        * Daily charge (casemix)
            ELSE
              IF        CACCFEE=4
                PACK      FINCODE,ANS,STWARD,ACLAIM,SP20 * Ward/claim
              ELSE
                PACK      FINCODE,ANS,STWARD,SP20      * Daily charge (casemix)
              ENDIF
            ENDIF
            GOTO      WAFN7000
          ENDIF
.
          MOVE      "A",ANS
          BRANCH    CACCFEE,WAFN6400:                * ward/bed claim
                            WAFN6600:                * ward/adm. type
                            WAFN6800:               * ward/claim/adm.type
                            WAFN6900:               * ward/adm.type/claim
                            WAFN6910                * claim
          PACK      FINCODE WITH ANS,STATYPE,SP20
          GOTO      WAFN7000
.
WAFN6400  PACK      FINCODE WITH ANS,STWARD,ACLAIM,SP20
          GOTO      WAFN7000
.
WAFN6600  PACK      FINCODE,ANS,STWARD,STATYPE,SP20
          GOTO      WAFN7000
.
WAFN6800  PACK      FINCODE,ANS,STWARD,ACLAIM,STATYPE,SP20
          GOTO      WAFN7000
.
WAFN6900  PACK      FINCODE,ANS,STWARD,STATYPE,ACLAIM,SP20
          GOTO      WAFN7000
.
WAFN6910  PACK      FINCODE WITH ANS,ACLAIM,SP20
          GOTO      WAFN7000
.
WAFN7000  MATCH     "IBAINP19",PRGID        * Generate all accommodation
          IF        !@EQUAL
            BRANCH    REVBFLAG,WAFN9999     * ADT09 only include lumpsum
          ENDIF
          CALL      WFINS000                * Write a record to patfinsf
WAFN9999  RETURN
+
.*******************************************************************************
.         Display Accommodation line
.*******************************************************************************
DACM0000  PACK      ACCMDESC,ACCMDESC,SP70
          MATCH     SP70,ACCMDESC
          IF        @EQUAL
            PACK      ACCMDESC,TDDESC,SP70    * longer var for Accom.description
          ENDIF
.
          COMPARE   ONE,DCFLAG
          GOTO      DACM2500 IF NOT EQUAL
.
          COMPARE   ZERO,NODAYS
          GOTO      DACM9999 IF EQUAL          * no additional charge
.
          COMPARE   ONE,WEBFLAG
          GOTO      DACM9999 IF NOT EQUAL
.
          MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3A,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL:
                              NAUG,NSEP,NOCT,NNOV,NDEC
.
          MOVE      SP70,ANS
          PACK      KEY5,ANSA,SP1,STATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC12,ANS
          ENDIF
.
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          MOVE      LINETOT,FORM12P2
          ADD       LINEGST,FORM12P2
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4:
                               " to ";
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;TDAY1,SP1,MTHNAM3A,SP1,KEY4;
.
          WRITE     HTMLFILE;"</td><td><table width=100%><tr><td>",ACCMDESC;
.
          MATCH     SP70,BEDDESC
          IF        !@EQUAL
             MOVE    ZERO,EXIT
             PROC    CETT0000         *certificat type
             IF        EXIT=1
               WRITE    HTMLFILE;"<font color=red>",BEDDESC,"</font>";
             ELSE
               WRITE    HTMLFILE;"<font color=green>",BEDDESC,"</font>";
             ENDIF
          ENDIF
.
          MATCH     SP70,PTDTDES2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<font color=red>/",PTDTDES2,"</font>";
          ENDIF
.
          PACK      KEY8,FCENT1,FYEAR1,FMON1,FDAY1,SP70
          REP       " 0",KEY8
          WRITE     HTMLFILE;"</td><td align=right>":
                             "<img src=../images/CommentIcon.gif ":
                             " class=ListIcon onclick='ShowStepdown(#"":
                             AURNO,"#",#"":
                             AADMNO,"#",#"":
                             KEY8,"#",#"":
                             ANS,"#",#"",SAVCONTR,"#")'></td></tr></table>";
.
          IF        INVTYPE=0
            WRITE     HTMLFILE;"</td><td>&nbsp;",SAVCONTR:  * contract id
                               "</td><td>&nbsp;":
                               "</td><td>&nbsp;";
          ENDIF
.
          IF        INVTYPE=1
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td>&nbsp;":
                               "</td><td>&nbsp;":
                               "</td><td>&nbsp;";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"</td><td align=right>",FNDLRATE:
                                 "</td><td align=right>",PATLRATE;
              GOTO      DACM1000
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</td><td align=right>",LSTRATE;
.
DACM1000  WRITE     HTMLFILE;"</td><td align=right>",LINETOT:
                             "</td><td align=right>",LINEGST:
                             "</td><td align=right>",FORM12P2;
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td align=right>",FORM12P2;
          ENDIF
          WRITE     HTMLFILE;"</td></tr>"
          GOTO      DACM9999
.
..............................................................................
.         Overnight
..............................................................................
DACM2500  COMPARE   ONE,CMXFLAG
          GOTO      DACM2800 IF NOT EQUAL
.
          MATCH     ADATE,DDATE
          IF        @EQUAL
            IF        LSTRATE = 0
              GOTO      DACM9999          * daycase without daily charge
            ENDIF
          ENDIF
.
DACM2800  COMPARE   ONE,WEBFLAG
          GOTO      DACM9999 IF NOT EQUAL
.
          MOVE      SP70,KEY70
          CLEAR     KEY70
.         APPEND    TDDESC,KEY70
          APPEND    ACCMDESC,KEY70
          MATCH     SP70,PTDTDES2
          IF        !@EQUAL
            RESET     KEY70
            STRIP     KEY70
            ENDSET    KEY70
            APPEND    "/",KEY70
            APPEND    PTDTDES2,KEY70
          ENDIF
          APPEND    SP70,KEY70
          RESET     KEY70
.
          MOVE      SP70,ANS
          PACK      KEY5,ANSA,SP1,STATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC12,ANS
          ENDIF
.
          MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3A,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                     NSEP,NOCT,NNOV,NDEC
.
          IF        NODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          MOVE      LINETOT,FORM12P2
          ADD       LINEGST,FORM12P2
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4;
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;" to ":
                                 TDAY1,SP1,MTHNAM3A,SP1,KEY4;
.
.         COMPARE   NINE,CFEETYP
.         GOTO      DACM2824 IF NOT EQUAL      * Not Johns Hopkins
          COMPARE   ONE,PARTFLAG
          GOTO      DACM2824 IF NOT EQUAL      * Not partial charges
.
          MOVE      NODAYS,FORM41
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TYEAR1,CYEAR
          MOVE      TCENT1,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     DDATE,KEY8
          IF        @EQUAL
            ADD       "0.5",FORM41
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>":
                              FORM41,SP1,DAYFORMT,SP1,ACCMDESC;
          GOTO      DACM2828
.
DACM2824  WRITE     HTMLFILE;"</td><td><table width=100%><tr><td>":
                             NODAYS,SP1,DAYFORMT,SP1,KEY70;
          MATCH     SP70,BEDDESC
          IF        !@EQUAL
             MOVE    ZERO,EXIT
             PROC    CETT0000         *certificat type
             IF        EXIT=1
               WRITE    HTMLFILE;"<font color=red>",BEDDESC,"</font>";
             ELSE
               WRITE    HTMLFILE;"<font color=green>",BEDDESC,"</font>";
             ENDIF
          ENDIF
.
DACM2828  PACK      KEY8,FCENT1,FYEAR1,FMON1,FDAY1,SP70
          REP       " 0",KEY8
          WRITE     HTMLFILE;"</td>":
                             "<td align=right>";
.
          MATCH     "Mechanical Ventilation",TDDESC
          GOTO      DACM3000 IF NOT EQUAL
.
          COMPARE   ZERO,LSTRATE
          GOTO      DACM3000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<img src=../images/DietIconTrans.gif ";
          GOTO      DACM4000
.
DACM3000  IF        CMXFLAG=0 & ECTRFLAG=2
            WRITE     HTMLFILE;"</td></tr></table>";
            GOTO      DACM5000             * No pay day
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/CommentIcon.gif ";
.
DACM4000  WRITE     HTMLFILE;" class=ListIcon onclick='ShowStepdown(#"":
                             AURNO,"#",#"":
                             AADMNO,"#",#"":
                             KEY8,"#",#"":
                             ANS,"#",#"",SAVCONTR,"#")'></td></tr></table>";
.
DACM5000
          IF        INVTYPE=0
            WRITE     HTMLFILE;"</td><td>&nbsp;",SAVCONTR:  * contract id
                               "</td><td>&nbsp;":
                               "</td><td>&nbsp;";
          ENDIF
          IF        INVTYPE=1
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td>&nbsp;":
                               "</td><td>&nbsp;":
                               "</td><td>&nbsp;";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"</td><td align=right>",FNDLRATE:
                                 "</td><td align=right>",PATLRATE;
              GOTO      DACM6000
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</td><td align=right>",LSTRATE;
.
DACM6000  WRITE     HTMLFILE;"</td><td align=right>",LINETOT:
                             "</td><td align=right>",LINEGST:
                             "</td><td align=right>",FORM12P2;
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td align=right>",FORM12P2;
          ENDIF
          WRITE     HTMLFILE;"</td></tr>"
.
DACM9999  RETURN
+
.*******************************************************************************
.          Display/write accommodation record for Johns hopkins
.*******************************************************************************
JHAC0000  MOVE      LSTRATE,XLSTRATE
          MOVE      LINETOT,XLINETOT
          BRANCH    PROGFLAG OF JHAC8000,JHAC2000,JHAC5000,JHAC4000,JHAC5000
.
.         Display accommodation record
.
JHAC2000  COMPARE   ONE,DCFLAG
          GOTO      JHAC2500 IF NOT EQUAL
.
          COMPARE   ZERO,NODAYS
          GOTO      JHAC8000 IF EQUAL          * no additional charge
.
          MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3A,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL:
                              NAUG,NSEP,NOCT,NNOV,NDEC
.
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          MOVE      LINETOT,FORM12P2
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4:
                               " to ";
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;TDAY1,SP1,MTHNAM3A,SP1,KEY4:
                             "</td><td>",TDDESC;
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td>&nbsp;";
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>&nbsp;":
                                   "</td><td align=right>",LSTRATE:
                                   "</td><td align=right>",LINETOT:
                                   "</td><td>&nbsp;":
                                   "</td><td align=right>",FORM12P2;
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td align=right>",FORM12P2;
          ENDIF
          WRITE     HTMLFILE;"</td></tr>"
          ADD       ONE,VERT
          GOTO      JHAC8000
.
JHAC2500  MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3A,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                     NSEP,NOCT,NNOV,NDEC
.
          IF        NODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          MOVE      LINETOT,FORM12P2
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4;
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;" to ":
                                 TDAY1,SP1,MTHNAM3A,SP1,KEY4;
.
          COMPARE   ONE,PARTFLAG
          GOTO      JHAC2824 IF NOT EQUAL      * Not partial charges
.
          MOVE      NODAYS,FORM41
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TYEAR1,CYEAR
          MOVE      TCENT1,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     DDATE,KEY8
          IF        @EQUAL
            ADD       "0.5",FORM41
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          WRITE     HTMLFILE;"</td><td>",FORM41,SP1,DAYFORMT,SP1,TDDESC;
          GOTO      JHAC2828
.
JHAC2824  WRITE     HTMLFILE;"</td><td>",NODAYS,SP1,DAYFORMT,SP1,TDDESC;
.
JHAC2828  WRITE     HTMLFILE;"</td><td>&nbsp;";
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td>&nbsp;":
                               "</td><td>&nbsp;";
          ENDIF
          WRITE     HTMLFILE;"</td><td align=right>",LSTRATE:
                             "</td><td align=right>",LINETOT:
                             "</td><td>&nbsp;":
                             "</td><td align=right>",FORM12P2;
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"</td><td align=right>",FORM12P2;
          ENDIF
          WRITE     HTMLFILE;"</td></tr>"
          ADD       ONE,VERT
          GOTO      JHAC8000
.
.         Set up key for a call to PATCALF
.
JHAC4000  PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
.
          MOVE      LINETOT,FINAMT
          ADD       TOTXTRA,FINAMT
.
          MOVE      SAMTG,TPATAMTG
          SUB       SAMTG,FINAMT
          MOVE      "A",FINTYPE
          GOTO      JHAC6000
.
.         Print the accommodation line
.
JHAC5000  CALL     PJAC0000                * Print Johns Hopkins Accommodation
.
.         Set up DTRAN record ready for writing
.
          MOVE      "P" TO TTYPEDEB
          MOVE      "DB",TTYPE
          MOVE      ONE,TRECTYPE      (1 = ACCOMMODATION)
          MOVE      ZERO,TCLAIM      *** set up as not yet claimed 3/9/86
.
          MOVE      LINETOT,TPATAMTT
          MOVE      LSTRATE,TPATAMTI
          MOVE      ZERO,TPATAMTP                                      *I-47440
.
          MOVE      STRATEF,TPATAMTH         *** save original rate
          MOVE      STRATEH,TREBATE
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTL
          MOVE      SP10,PTDTGSTC
          MULT      NODAYS,TREBATE
          MOVE      NODAYS,TNODAYS
          MOVE      STWARD,TDWARD          * set up new DTRAN variables
          MOVE      STATYPE,TADMTYP        * when printing invoice
          MOVE      ACLAIM,TCLMTYP
          MOVE      STRBTYP,PTDTBTYP
          MOVE      SP1,PTDTCRST
          MOVE      ZERO,PTDTCCU         * no additional charges
          MOVE      ZERO,PTDTADPT
          MOVE      ZERO,PTDTADRB
          MOVE      SP70,TMISGRP
          CALL      WRITETRN
.
.         If we have extra's, then write a DTRA record for them too
.
          COMPARE   ZERO,STEXTRA
          GOTO      JHAC6000 IF EQUAL
.
          MOVE      TOTXTRA,TPATAMTT
          MOVE      STEXTRA,TPATAMTI
          MOVE      ZERO,TPATAMTG
          MOVE      STEXTRA,TPATAMTH         *** save original rate
          MOVE      ZERO,TREBATE
          MOVE      TEDESC,TDDESC
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTA
          MOVE      ZERO,PTDTGSTL
          MOVE      SP10,PTDTGSTC
          MOVE      ZERO,TPAYTYPE
          CALL      WRITETRN
.
.         Set up key for a call to PATCALF
.
JHAC6000  MOVE      "A",ANS
          BRANCH    CACCFEE,JHAC6400:                * ward/bed claim
                            JHAC6600:                * ward/adm. type
                            JHAC6800:               * ward/claim/adm.type
                            JHAC6900:               * ward/adm.type/claim
                            JHAC6910                * claim
          PACK      FINCODE WITH ANS,STATYPE,SP20
          GOTO      JHAC7000
.
JHAC6400  PACK      FINCODE WITH ANS,STWARD,ACLAIM,SP20
          GOTO      JHAC7000
.
JHAC6600  PACK      FINCODE,ANS,STWARD,STATYPE,SP20
          GOTO      JHAC7000
.
JHAC6800  PACK      FINCODE,ANS,STWARD,ACLAIM,STATYPE,SP20
          GOTO      JHAC7000
.
JHAC6900  PACK      FINCODE,ANS,STWARD,STATYPE,ACLAIM,SP20
          GOTO      JHAC7000
.
JHAC6910  PACK      FINCODE WITH ANS,ACLAIM,SP20
          GOTO      JHAC7000
.
JHAC7000  CALL      WFINS000                * Write a record to patfinsf
JHAC8000  CALL      MTDNFD00                * Move to date to next from date
JHAC9999  RETURN
+
.******************************************************************************
.*                                  PJAC0000                                  *
.*                     Print Johns Hopkins Accommodation line                 *
.******************************************************************************
PJAC0000  MOVE      ZERO,TPAYTYPE
          MOVE      NODAYS,FORM41
          IF        NODAYS=1
            MOVE      "DAY",DAYFORMT
          ELSE
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
          COMPARE   ONE,PARTFLAG
          GOTO      PJAC1000 IF NOT EQUAL       * Not partial charges
.
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TYEAR1,CYEAR
          MOVE      TCENT1,CCENT
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     DDATE,KEY8
          IF        @EQUAL
            ADD       "0.5",FORM41
            MOVE      "DAYS",DAYFORMT
          ENDIF
.
PJAC1000  PACK      KEY25,SP70
          MOVE      LSTRATE,XLSTRATE
          CLEAR     KEY25
          APPEND    "@",KEY25
          APPEND    XLSTRATE,KEY25
          APPEND    " for",KEY25
          APPEND    FORM41,KEY25
          APPEND    DAYFORMT,KEY25
          APPEND    SP1,KEY25
          APPEND    SP70,KEY25
          RESET     KEY25
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      LINETOT,FORM7P2
          IF        INVTYPE=1
            UNPACK    KEY25,KEY24
            PRINT     *3,TDDESC,*33,KEY24:
                      *57,FORM7P2
          ELSE
            PRINT     *3,TDDESC,*33,KEY25:
                      *70,FORM7P2
          ENDIF
.
          ADD       LINETOT,TOTAMNT
          ADD       ONE,COUNT
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      FDAY1,CDAY
          MOVE      FMON1,CMON
          MOVE      FCENT1,CCENT
          MOVE      FYEAR1,CYEAR
          CALL      PACDATE
          PRINT     *3,"(",CPCDATE;
.
          MOVE      TDAY1,CDAY
          MOVE      TMON1,CMON
          MOVE      TCENT1,CCENT
          MOVE      TYEAR1,CYEAR
          CALL      PACDATE
          PRINT     *14," to ",CPCDATE,")"
          ADD       ONE,COUNT
.
PJAC9999  RETURN
+
.******************************************************************************
.*                                  WFINS000              Called by: LFIN0000 *
.*                         Write A record To patfinsf                         *
.******************************************************************************
WFINS000  COMPARE   FIVE,PROGFLAG
          GOTO      WFINS999 IF EQUAL          * Print only - no update
          COMPARE   SIX,PROGFLAG
          GOTO      WFINS999 IF EQUAL          * Print Discharge billing 
.
          COMPARE   FIVE,CFEETYP
          GOTO      WFINS999 IF EQUAL          * NZ Private
.
          MOVE      LINETOT,FINAMT
          ADD       TOTXTRA,FINAMT
          SUB       TPATAMTG,FINAMT
          MOVE      "A",FINTYPE
.
.         Add up financial statistics
.
          COMPARE   ZERO,FINAMT
          GOTO      WFINS900 IF EQUAL
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          PACK      PINVDTE WITH CCC,CYY,CMM,CDD
          REP       " 0",PINVDTE
.
          MOVE      PINVDTE,FINDATE
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
.
          IF        IBCNUGST=2
            IF        LINEGST<>0
              MOVE      ONE,FGSTFLAG
              MOVE      PINVDTE,FINDATE
              REP       " 0",FINDATE
              MOVE      LINEGST,FINAMT
              MOVE      PMVXMHOS,FINHOSP
              CALL      PATCALF
              MOVE      ZERO,FGSTFLAG
            ENDIF
          ENDIF
.
          PACK      FINCODE,ANSG,SP20
          MOVE      TPATAMTG,FINAMT
          IF        FINAMT<>0
            MOVE      PINVDTE,FINDATE
            REP       " 0",FINDATE
            MOVE      THREE,FINSYS
            MOVE      SP6,FINSITE
            MOVE      PMVXMHOS,FINHOSP
            CALL      PATCALF
          ENDIF
.
WFINS900  MOVE      ZERO,EXIT
WFINS999  RETURN
+
.******************************************************************************
.*                                  MTDNFD00              Called by: LFIN0000 *
.*                       Move To Date To Next From Date                       *
.******************************************************************************
MTDNFD00  MOVE      TDAY1,FDAY1
          MOVE      TMON1,FMON1
          MOVE      TYEAR1,FYEAR1
          MOVE      TCENT1,FCENT1
          PACK      IDATEF,FCENT1,FYEAR1,FMON1,FDAY1
          REP       " 0",IDATEF
          RESET     IDATEF
.
          PACK      IDATET,TCENT,TYEAR,TMON,TDAY
          REP       " 0",IDATET
          RESET     IDATET
.
MTDNFD90  MOVE      ZERO,EXIT
MTDNFD99  RETURN
+
.*******************************************************************************
.        Search for any miscellaneous items for this invoice for theatre fees
.*******************************************************************************
GMSC0000 MOVE      ZERO,MISCTOT
         MOVE      ZERO,HFTHEA
         MOVE      ZERO,HFMISC
         MOVE      ZERO,TOTMISC
         MOVE      ZERO,TOTTHEA
         MOVE      ZERO,TOTOTHR
.
         COMPARE   ONE,TFEEIND
         GOTO      GMSC1000 IF NOT EQUAL * Not using theatre fee file
.
         CALL      CTMP0000             * create & create tempfile to sort items
         CALL      PT2P0000             * create misc item file      *I-90303
.
         MOVE      SP8,TREF
         REP       " 0",TREF
         MOVE      SP10,DIM9         * Initialise misc.item code
         MOVE      ZERO,COUNTA
.
         CALL      PSRT0000          * Process items sort file
.
GMSC1000 MOVE      ZERO,COPTION
         MOVE      SP20,CURSESS
         IF        IPATFLAG=2
           CALL      XENI0000         * Generating items for New Patient Inv.
         ELSE
           CALL      GENI0000         * Generating items
         ENDIF
.
.        End of this invoice's details
.
GMSC9000 COMPARE   SEVEN,PROGFLAG
         GOTO      GMSC9999 IF EQUAL
.
         CALL      PBXC0000          * Print pabx
         CALL      EINV0000        * End of invoice
.
         COMPARE   TWO,PROGFLAG
         GOTO      GMSC9999 IF NOT EQUAL      * Not displaying invoice
.
         WRITE     HTMLFILE;"<input type=hidden name=cmixflag ":
                            "value=#"",CMXFLAG,"#">";
.
GMSC9999 RETURN
+
.*******************************************************************************
.        Generate items      
.*******************************************************************************
GENI0000 CALL      RSIT0000                 * Read item file
         BRANCH    EXIT,GENI2320
.
GENI2300 CALL      RKIT0000
         BRANCH    EXIT,GENI9000
.
GENI2320 CALL      SITM0000                 * Setup items
         BRANCH    NEXTFLAG,GENI2300
.
         MOVE      LINETOT,XLINETOT
         MOVE      LINEGST,XLINEGST
         PACK      DIM25,TDDESC,SP20
         PACK      DIM30,TDDESC,SP70
.
         ADD       PATLNGST,PATLNTOT
.
         IF        PITMCHRG=0
           ADD       PATLNTOT,PPAYABLE        * Patient balance payable
           ADD       PATLNGST,TOTPGST
         ENDIF
.
         BRANCH    PROGFLAG,GENI2300,GENI2600,GENI2800,GENI8800
         COMPARE   SEVEN,PROGFLAG
         GOTO      GENI9200 IF EQUAL     * Independence Service billing
.
.        Do not display zero amount patient portion items
.
GENI2600 CALL      DSIM0000        * Display miscellaneous item
         GOTO      GENI2300        * read next DTR
.
.        Print miscellaneous item
.
. This code calculates whether the item is a front end deduction and if
. so it then only prints it depending on the system parameter
. PTCNPFED.
.
GENI2800  CALL      PITM0000        * Print Item line
          CALL      UITM0000        * Update the debtor & Financial record
.
.        Update the Fees Invoiced Summary file
.
GENI8800  CALL      UFIN0000        * Update Financial summary file
          GOTO      GENI2300        * read next DTR
.
GENI9000  COMPARE   THREE,PROGFLAG
          GOTO      GENI9999 IF NOT EQUAL   * not printing invoice
.
          CALL      RITM0000      * Remove all un-used items if any
.
          IF        PTCNINVL=24
            MATCH    SP70,SAVDATE1
            IF       !@EQUAL
              CALL     GJGA0000
            ENDIF
          ENDIF
          GOTO      GENI9999
.
GENI9200  CALL      ISIT0000      * Process Independence Services items
          GOTO      GENI2300        * read next DTR
.
GENI9999  RETURN
+
.*******************************************************************************
.        Read the sort file (if using theatre fee) or pmsmtiaf file if not
.*******************************************************************************
RSIT0000 MOVE     ZERO,MBSCOUNT
         MOVE     SP70,SAVEUNIQ
         MOVE     SP70,SAVDATE1
         MOVE     ZERO,EXIT
.
         COMPARE  ONE,TFEEIND
         GOTO     RSIT6000 IF NOT EQUAL   * Not using theatre fee
.
         PACK     KEY15,SP70
         CALL     RDSSRTM1
         MOVE     ZERO,EXIT
         GOTO     RSIT9999
.
.        Not using theatre fees
.
RSIT6000 MOVE      AADMNO,TADMNO
         MOVE      AADMNO,DTADMNO
         PACK      KEY14,AADMNO,SP20
         CALL      RSPMMTI1
.
         IF        CMXFLAG=1 & MVBFLAG=1
           CALL      PMVBR000             * populate dtr fields for mv billing
           MOVE      PMMITRAN,SAVTRNNO
           CALL      MTDT0000             * Move pmsitm to dtraf fields
           MOVE      ONE,EXIT
           GOTO      RSIT9999
         ENDIF
         MOVE      ZERO,EXIT
         GOTO      RSIT9999
.
RSIT9000 MOVE      ONE,EXIT
RSIT9999 RETURN
+
.*******************************************************************************
.        Read next item 
.*******************************************************************************
RKIT0000 COMPARE  ONE,TFEEIND
         GOTO     RKIT6000 IF NOT EQUAL    * Not using theatre fee
.
RKIT2335 CALL     RDKSRTM1
         BRANCH   OVRCD,RKIT9000
.
         MATCH     "IBAHMS70",PRGID
         IF        @EQUAL
           MOVE      TMPDTRDT,PMMITDAT
         ENDIF
.
         MATCH    "     +",TMPZUNIQ
         IF       @EQUAL
           CALL     PMVBR000              * populate dtr fields for mv billing
           CALL     MTDT0000              * move var from pmsmti to dtr 
           GOTO     RKIT2340
         ENDIF
.
         MATCH     "IBAHMS70",PRGID 
         GOTO      RKIT2337 IF NOT EQUAL
         PACK      KEY22,AADMNO,TMPREFNC,TMPTRNSC
         CALL      RDDTRN1
         BRANCH    OVRCD,RKIT2337
.
         PACK      PMMITDAT,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
         REP       " 0",PMMITDAT
.
         GOTO      RKIT2339
.
RKIT2337 PACK      KEY14,AADMNO,TMPTRNSC
         CALL      RDPMMTI1
         BRANCH    OVRCD,RKIT2335
         MOVE      PMMITRAN,SAVTRNNO
         CALL      MTDT0000             * move fields
         IF        TRECTYPE=2
           ADD       ONE,MBSCOUNT
         ENDIF
.
         MOVE      TMPMNINV,TNINVS
         MOVE      TMPAMNTP,TPATAMTP
         MOVE      TMPREBAT,TREBATE
         MOVE      TMPAMNTP,TPATAMTT
         ADD       TMPREBAT,TPATAMTT
         MULT      TSERVS,TPATAMTT
.
RKIT2339 MOVE      TMPAMNTP,PMMIAMTP
         MOVE      TMPREBAT,PMMIRBAT
         MOVE      TMPAMNTP,PMMIAMTT
         ADD       TMPREBAT,PMMIAMTT
         MULT      TSERVS,PMMIAMTT
         MOVE      TMPMNINV,PMMIINVN
         MOVE      TMPMNINV,MNINV
.
RKIT2340 MOVE      ZERO,EXIT
         GOTO      RKIT9999
.
.        Not using theatre fees
.
RKIT6000 CALL      RKPMMTI1
         BRANCH    OVRCD,RKIT9000
.
         MATCH     DTADMNO,PMMIVISN
         GOTO      RKIT9000 IF NOT EQUAL
.
         CALL      CONTY0000              * Check for Consumption type
         BRANCH    EXIT,RKIT6000          * Skip un-used item
.
         MOVE      PMMITRAN,SAVTRNNO
         CALL      MTDT0000               * Move pmsitm to dtraf fields
         MOVE      ZERO,EXIT
         GOTO      RKIT9999
.
RKIT9000 MOVE      ONE,EXIT
RKIT9999 RETURN
+
.*******************************************************************************
.        Set up item fields
.*******************************************************************************
SITM0000  MOVE     ZERO,NEXTFLAG
.
. If we are backdating invoices then check if we have passed the specified
. date
         IF       BDTEFLAG = 1
           MOVE     TYEAR,CYEAR
           MOVE     TMON,CMON
           MOVE     TDAY,CDAY
           MOVE     TCENT,CCENT
           PACK     KEY8,CCENT,CYEAR,CMON,CDAY
           IF        CMXFLAG=1 & MVBFLAG=1
             PACK     KEY8,TCENT1,TYEAR1,TMON1,TDAY1
           ENDIF
           REP      " 0",KEY8

           MOVE     TFDAY,CDAY
           MOVE     TFMONTH,CMON
           MOVE     TFYEAR,CYEAR
           MOVE     TFCENT,CCENT
           PACK     CKYIDEF8,CCENT,CYEAR,CMON,CDAY
           REP       " 0",CKYIDEF8 
.
           MATCH    CKYIDEF8,KEY8
           GOTO     SITM9000 IF LESS        * Return to read next DTR  *I-90303
         ENDIF
.
.        If it has already been printed, then ignore it
.
         MATCH     "IBAHMS70",PRGID                                    *I-90226
         GOTO      SITM2350 IF EQUAL                                   *I-90226
.
         BRANCH    TINVPRT,SITM9000         * Return to read next DTR  *I-90303
.
.        Check if two invoices are wanted
.
SITM2350 LOAD      NUMINVS,TNINVS,NUMINVS,TWO                          *C-90226
.
         MOVE      SP70,MBSCONTR
         MOVE      SP70,PTITTCER
         MOVE      SP70,PTITIWRN
.
         IF        TRECTYPE=2
           MOVE      ZERO,SORTDONE     * flag for Creating sort file
           MOVE      ONE,CBFLAG
           CALL      GETIT00           * re-calculate theatre fees
           MOVE      ZERO,CBFLAG
.
           IF        IPATFLAG=2
             MOVE      ONE,NUMINVS
             LOAD      NUMINVS,TNINVS,NUMINVS,TWO
             COMPARE   TWO,TNINVS
             GOTO      SITM2351 IF EQUAL   * New Patient Inv.functionality
           ENDIF
.
.          If we are printing Patient Only Invoice, skip item with HF portion
.
           IF        IPATFLAG=1 | IPATFLAG=2
             COMPARE   ZERO,PMMIRBAT
             GOTO      SITM9000 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,PMMIAMTP
             GOTO      SITM9000 IF EQUAL     * skip zero amt of Pat.& HF 
           ENDIF
         ENDIF
.
SITM2351
         IF        IPATFLAG=2
           MATCH     "1",PMCIPINV
           IF        !@EQUAL
             MOVE      ONE,PITMCHRG          * Item is not Patient payable
           ENDIF
           LOAD      IPASS USING NUMINVS OF ZERO,ONE    * Start with pat. inv
         ENDIF
.
.        If we are using theatre fee items, the charges had been calculated 
.        prior being written to the items sort file
.
         BRANCH    TFEEIND,SITM2354        * Using Theatre fee
.
         COMPARE   THREE,TRECTYPE
         GOTO      SITM2354 IF NOT EQUAL   * not miscellaneous charge
.
         MATCH     "2",PMMIITYP
         GOTO      SITM2354 IF EQUAL       * Exploding item - no recalculate
.
         CALL      GMIS0000                * recalculate misc.
         BRANCH    EXIT,SITM2354
.
         IF        IPATFLAG=2
           MOVE      TWO,MNINV             * override No of invoice from item
           LOAD      NUMINVS,MNINV,NUMINVS,TWO                          *C-90226
           LOAD      IPASS,MNINV,ZERO,ONE
           GOTO      SITM2352
         ENDIF

.        If we are printing Patient Only Invoice, skip item with HF portion
.
          IF        IPATFLAG=1
           MATCH     "Y",PTMCKREB
           IF        @EQUAL
             COMPARE   ZERO,TREBATE
             GOTO      SITM9000 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,TPATAMTP
             GOTO      SITM9000 IF EQUAL     * skip zero amt of Pat.& HF 
           ELSE
             COMPARE   ZERO,MHFPOR
             GOTO      SITM9000 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,MPATPOR
             GOTO      SITM9000 IF EQUAL     * skip zero amt of Pat.& HF 
           ENDIF
         ENDIF
.
SITM2352 MATCH     "Y",PTMCKREB
         GOTO      SITM2354 IF EQUAL       * manual change for rebate
.
         MOVE      MPATPOR,FORM12P2
         ADD       MHFPOR,FORM12P2
.
.        Check if it's a Front end deductable item, only if the sum of
.        HF and patient portion is zero and at least one of them is not zero.
.
          IF        FORM12P2=0 & MPATPOR<>0
            GOTO      SITM2354          * front end deductable - don't change
          ENDIF
.
.        Check if this item was entered manually.
.
         IF        MPATPOR=0 & MHFPOR=0
.
.        Check with parameter if Zero amount of item to be recalculated
.
           MATCH     "1",PTCNCALM
           GOTO      SITM2353 IF EQUAL
           GOTO      SITM2354           *  do not change the amount
         ENDIF
.
SITM2353 COMPARE   TWO,MNINV
         GOTO      SITM2354 IF EQUAL    *  split invoices - don't change amount
         MOVE      MPATPOR,TPATAMTP
         MOVE      MHFPOR,TREBATE
.
.        Check for multiple items
.
         MOVE      TPATAMTP,TPATAMTT
         ADD       TREBATE,TPATAMTT
         IF        TSERVS<>0
           MULT      TSERVS,TPATAMTT
         ENDIF
         MOVE      TPATAMTP,PMMIAMTP
         MOVE      TREBATE,PMMIRBAT
         MOVE      TPATAMTT,PMMIAMTT
.
SITM2354 IF        PROGFLAG=3
           MATCH     "     +",TMPZUNIQ
           IF        @EQUAL
             CALL      WMVBR000          * write a mechv record to pmsmtiaf
             MOVE      PMMITRAN,TTRANSN1
             MOVE      PMMITRAN,SAVTRNNO
           ELSE
             IF        IPASS=2
               MOVE      ZERO,PMMIAMTP   * zero to patient portion
               MOVE      PMMIRBAT,PMMIAMTT
               MULT      PMMISERV,PMMIAMTT
             ENDIF
             PACK      PMMIDUPD,CCC,CYY,CMM,CDD
             REP       " 0",PMMIDUPD
             CALL      IBACLOCK
             MOVE      CTIMEIS,PMMITUPD
             MOVE      PASSCODE,PMMIWUSR
             CALL      UPPMMTI1          * update new item amount 
           ENDIF
         ENDIF
.
.        If we are doing two invoices, then we are only interested in certain
.        miscellaneous items, depending on which invoice is being printed
.
         BRANCH    IPASS,SITM2355,SITM2360
.
.        Display an ABF invoice :
.         - display the Actual amount of Patient Only items
.           (ie items with No HF Portion)
.         - display zero amount for Items with HF portion 
.
.        Printing an ABF Invoice :
.         - will NOT print Patient Only items (ie items with No HF Portion) 
.         - print zero amount for all Items with HF portion
.
         IF        ABFFLAG=1
           IF        PMMIRBAT<>0
             MOVE      ZERO,PMMIRBAT
             MOVE      ZERO,PMMIAMTP
             MOVE      ZERO,PMMIAMTT
             MOVE      ZERO,TREBATE
             MOVE      ZERO,TPATAMTP
             MOVE      ZERO,TPATAMTT
           ELSE
             IF        PMMIAMTP<>0
               COMPARE   THREE,PROGFLAG
               GOTO      SITM9000 IF EQUAL  * Print inv - skip Patient only item
             ELSE
               MOVE      ZERO,PMMIAMTT
               MOVE      ZERO,TREBATE
               MOVE      ZERO,TPATAMTP
               MOVE      ZERO,TPATAMTT
             ENDIF
           ENDIF
         ENDIF
.
         MOVE      TPATAMTT,LINETOT
.
         MOVE      TPATAMTP,PATLNTOT
         MULT      TSERVS,PATLNTOT
.
         IF        TRECTYPE=3
           MOVE      ZERO,PITMCHRG        * Included in Patient Payable amt
           IF        MNINV=1
            IF        TREBATE<>0
             MOVE      ONE,PITMCHRG       * Item is not Patient payable
            ENDIF
           ENDIF
         ENDIF
.
         LOAD      FORM12P2,TRECTYPE,HFACCM,HFTHEA,HFMISC
.
         IF        TRECTYPE=2 | TRECTYPE=3
           IF        TSERVS=0
             MATCH     "     +",TMPZUNIQ   * check for MV record
             IF        !@EQUAL
               MOVE      ONE,TSERVS
             ENDIF
           ENDIF
           MOVE      ZERO,FORM9P2
           MOVE      TREBATE,FORM9P2
           MULT      TSERVS,FORM9P2
           ADD       FORM9P2,FORM12P2
         ELSE
           ADD       TREBATE,FORM12P2
         ENDIF
         STORE     FORM12P2,TRECTYPE,HFACCM,HFTHEA,HFMISC
         GOTO      SITM2400
.
.        Pass 1 : Patient Portion only
.
SITM2355 MATCH     "1",PTCNPPIN
         IF        !@EQUAL
           COMPARE   ZERO,TPATAMTP                                   *I-90303
           GOTO      SITM9000 IF EQUAL      * read next DTR          *I-90303
         ENDIF
.
         MOVE      TPATAMTP,LINETOT
         MULT      TSERVS,LINETOT
.
         MOVE      TPATAMTP,PATLNTOT
         MULT      TSERVS,PATLNTOT
.
         GOTO      SITM2400
.
.        Pass 2 : Rebate Portion only
.
SITM2360 COMPARE   ZERO,TPATAMTP
         GOTO      SITM2380 IF EQUAL
.
         COMPARE   ZERO,TREBATE               * ignore if zero
         GOTO      SITM9000 IF EQUAL          * read next DTR          *I-90303
.
SITM2380 MOVE      TREBATE,LINETOT
         MULT      TSERVS,LINETOT
.
         LOAD      FORM12P2,TRECTYPE,HFACCM,HFTHEA,HFMISC
.
         IF        TRECTYPE=2 | TRECTYPE=3
           IF        TSERVS=0
             MOVE      ONE,TSERVS
           ENDIF
           MOVE      ZERO,FORM9P2
           MOVE      TREBATE,FORM9P2
           MULT      TSERVS,FORM9P2
           ADD       FORM9P2,FORM12P2
         ELSE
           ADD       TREBATE,FORM12P2
         ENDIF
         STORE     FORM12P2,TRECTYPE,HFACCM,HFTHEA,HFMISC
.
.    Process this miscellaneous item
.
SITM2400 MOVE      ZERO,LINEGST
         MOVE      ZERO,PATLNGST
         IF        IBCNUGST=2 & PTDTGSTA=1
           CALL      IGST0000               * Get Item GST rate
           MOVE      LINETOT,LINEGST
           MULT      IBGEAMNT,LINEGST     * GST amount
           DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
           ADD       LINEGST,TOTGST
.
           MOVE      PATLNTOT,PATLNGST
           MULT      IBGEAMNT,PATLNGST    * GST amount
           DIV       "100.00",PATLNGST    * Divide by 100 to get wanted fig.
         ENDIF
.
         ADD       LINETOT,GROSSTOT
         ADD       LINETOT,MISCTOT
.                                           * Accumulate totals        *I-90226
         LOAD      FORM12P2,TRECTYPE,TOTACCM,TOTTHEA,TOTMISC,TOTOTHR,TOTOTHR
         ADD       TPATAMTT,FORM12P2
         STORE     FORM12P2,TRECTYPE,TOTACCM,TOTTHEA,TOTMISC,TOTOTHR,TOTOTHR
.
         MOVE      SP9,PRTITCOD
.
.        If this is a theatre charge, do any theatre charge processing
.
.        Check "Hospital ID', if MBS Code should be printed on invoice
.
         IF        TRECTYPE=2
           MOVE      TITEMNO,PRTITCOD     * Print MBS item
           IF        IBCNMHOS=1 
             MATCH     "1",PTHSPMBS
             IF        !@EQUAL
               MOVE      SP10,PRTITCOD
             ENDIF
           ENDIF
         ENDIF
.
.        If this is a miscellaneous charge, do any miscellaneous processing
.
         IF        TRECTYPE=3
           MOVE      SP10,PRTITCOD
           CALL      PROCMISC
           IF        PTCNPMIS=1
             MOVE      TITEMNO,PRTITCOD     * Print miscellaneous item
           ENDIF
         ENDIF
.
          IF        INVDFLAG=1
            CALL      WMCRD000              * write to invoice details file
          ENDIF
          MOVE      ZERO,NEXTFLAG
          GOTO      SITM9999
.
SITM9000  MOVE      ONE,NEXTFLAG             * flag to read next dtr record
SITM9999  RETURN
+
.*******************************************************************************
.*******************************************************************************
.        Update Patient Debtor and Financial record
.*******************************************************************************
UITM0000 PACK      DIM23 WITH TADMNO,TREF,TRECTYPE,TTRANSN1
.                                             * Save the key of this rec
.
.        If this item has both a patient portion and a rebate portion, and
.        we are printing two invoices, then split this item into two records
.
         MATCH     "IBAHMS70",PRGID
         GOTO      UITM8382 IF NOT EQUAL
         PACK      KEY22,TADMNO,TREF,TTRANSN1
         CALL      RDDTRN1
         BRANCH    OVRCD,UITM8382
         GOTO      UITM8384
.
UITM8382 PACK      KEY14,TADMNO,TTRANSN1
         CALL      RDPMMTI1
         CALL      MTDT0000          * move fields to dtr
.
UITM8384 BRANCH    IPASS OF UITM8400
         GOTO      UITM8600
.
.        Print Items with total amount of zero on HF invoice
.
UITM8400 MATCH     "1",PTCNPPIN
         IF        @EQUAL
           IF        IPATFLAG=2
             IF        TREBATE=0 & TPATAMTP=0
               GOTO      UITM8402
             ENDIF
           ENDIF
         ENDIF
.
         COMPARE   ZERO,TREBATE
         GOTO      UITM8600 IF EQUAL
.
UITM8402 MOVE      TREBATE,FORM12P2     * Save rebate portion
.
.        Splitting miscellaneous charge
.
.        This item has both patient and rebate portions
.        First, update this record with the new invoice number,
.        then create a new record with just the rebate portion.
.
         MOVE      ZERO,TREBATE         * Patient invoice -> no rebate portion
         MOVE      TPATAMTP,TPATAMTT    * Patient portion is full amount
         MULT      TSERVS,TPATAMTT
.
         CALL      WDDT0000             * Write to DTR file
.
         MATCH     "1",PTCNPPIN
         GOTO      UITM8406 IF NOT EQUAL
.
.        If we are printing New Patient Invoice functionality, write the Rebate
.        portion to pathtraf file (HF debtor transaction)
.
         CALL      CLPATHTR
         CALL      MDHT0000             * Move DTR fields to pathtraf

         MOVE      CNEXTINV,PTHTPINV    * Patient invoice number
         MOVE      TTRANSN1,PTHTPTRN    * Transaction number
.
         MOVE      SP70,PTHTTREF
         MOVE      TTRANSN1,PTHTTRN1
.
         MOVE      FORM12P2,PTHTRBAT    * Restore rebate portion
         MOVE      ZERO,PTHTAMTP        * zero patient portion
         MOVE      FORM12P2,PTHTAMTT    * Rebate portion is full amount
         MULT      PTHTSERV,PTHTAMTT
.
         MOVE      ZERO,PTHTGSTM
         IF        IBCNUGST=2
           CALL      IGST0000             * Get item GST rate
           MOVE      PTHTAMTT,PTHTGSTM
           MULT      IBGEAMNT,PTHTGSTM    * GST amount
           DIV       "100.00",PTHTGSTM    * Divide by 100 to get wanted fig.
         ENDIF
         GOTO      UITM8405
.
UITM8404 CALL      NXTTRAN1      * Get the next transaction number
         MOVE      TTRANSN1,PTHTTRN1
.
UITM8405 PACK      KEY22,PTHTADMN,PTHTTREF,PTHTTRN1
         CALL      RAPTHTR1
         COMPARE   ZERO,OVRCD
         GOTO      UITM8404 IF EQUAL
.
         CALL      WRPTHTR1
.
         GOTO      UITM9999
.
.        Now create the rebate portion miscellaneous charge record
.
UITM8406 MOVE      FORM12P2,PMMIRBAT    * Restore rebate portion
         MOVE      ZERO,PMMIAMTP        * Zero patient portion
         MOVE      FORM12P2,PMMIAMTT    * Rebate portion is full amount
         MULT      PMMISERV,TPATAMTT
         MOVE      ZERO,PMMIGSTA
         MOVE      SP10,PMMIGSTC
         MOVE      ZERO,PMMIGSTM
.
UITM8410 PACK      KEY14,PMMIVISN,PMMITRAN
         CALL      RAPMMTI1
         IF        OVRCD=0
           MOVE      PMMIVISN,KEY8
           CALL      TRVISA1
           MOVE      PVITRAN,PMMITRAN
           MOVE      PMMITRAN,ATRANNO
           GOTO      UITM8410
         ENDIF
         UNPACK    SP70,PMMICNTR,PMMISUNQ
         MOVE      SP70,PMMIINCT
         MOVE      SP70,PMMISUBN
         MOVE      SP70,PMMIEDAD
         MOVE      SP70,PMMISVTM
         MOVE      SP70,PMMIDUPD
         MOVE      SP70,PMMITUPD
         MOVE      SP70,PMMIWUSR
         PACK      PMMIDTCR,CCC,CYY,CMM,CDD
         REP       " 0",PMMIDTCR
         CALL      IBACLOCK
         MOVE      CTIMEIS,PMMITMCR
         MOVE      PASSCODE,PMMIIDCR
         MOVE      SP70,PMMITMNO
         MOVE      SP70,PMMIPMBS
         MOVE      SP70,PMMIRBRS
         MOVE      SP70,PMMICTYP
         PACK      PMMIACOI,SP70       * After Care Override Indicator
         PACK      PMMIDSOV,SP70       * Duplicate Service Override
         PACK      PMMISTXT,SP70       * Service Text
         PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
         PACK      PMMIMPOV,SP70       * Multi Procedure Override
         PACK      PMMINMPT,SP70       * Number of Patients Seen
         PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
         PACK      PMMITDUR,SP70       * Time Duration (Mins)
         PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
         PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
         PACK      PMMISPAR,SP70,SP70
         CALL      WRPMMTI1             * write a new item record
         GOTO      UITM9999
.
.        Not splitting miscellaneous charge.
.        Add the invoice number and invoice date to the DTRAN record
.
.        If we are printing ABF Invoice, all items will have zero amounts
.
UITM8600 IF        ABFFLAG=1
           MOVE      ZERO,TREBATE
           MOVE      ZERO,TPATAMTP
           MOVE      ZERO,TPATAMTT
         ENDIF
.
         CALL      WDDT0000             * Write to DTR file
UITM9999 RETURN
+
.*******************************************************************************
.        Update Financial summary file
.*******************************************************************************
UFIN0000
         MATCH     "IBAINP19",PRGID
         IF        !@EQUAL
           BRANCH    REVBFLAG,UFIN9999      * Read next DTR            *I-90303
         ENDIF
.
         MOVE      LINETOT,FINAMT
         MOVE      "A",FINTYPE
.
         IF        CMXFLAG = 1
           MOVE      "T",ANS
           IF        PTCNMFEE = 1
             PACK      FINCODE,ANS,DCFLAG,ACLAIM,TMISGRP,SP20
           ELSE
             PACK      FINCODE,ANS,DCFLAG,TMISGRP,TITEMNO,SP20
           ENDIF
         ELSE
           MOVE      "M",ANS
           IF        PTCNMFEE = 1
             PACK      FINCODE WITH ANS,ACLAIM,TMISGRP,SP20
           ELSE
             PACK      FINCODE WITH ANS,TMISGRP,TITEMNO,SP20
           ENDIF
         ENDIF
.
         UNPACK    SP70,FININVN,FINADMN,FINURNO
         IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
         ENDIF
.
         UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
         PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
         REP       " 0",FINDATE
         MOVE      THREE,FINSYS
         MOVE      SP6,FINSITE
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
.
         IF        IBCNUGST=2 & LINEGST<>0
           MOVE      ONE,FGSTFLAG
           PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
           REP       " 0",FINDATE
           MOVE      LINEGST,FINAMT
           MOVE      PMVXMHOS,FINHOSP
           CALL      PATCALF
           MOVE      ZERO,FGSTFLAG
         ENDIF
UFIN9999  RETURN
+
.*******************************************************************************
.        Write to DTR File 
.*******************************************************************************
WDDT0000
         MOVE      CNEXTINV,TREF        * Update invoice number
         MOVE      ONE,TINVPRT          * Flag as being printed
         PACK      PTDTEFFD,PINVDTE     * Effective date to fees invoiced
         MOVE      ZERO,PTDTGSTM
         MOVE      ZERO,PTDTGSTL
         IF        IBCNUGST=2 & PTDTGSTA=1
           MOVE      TPATAMTT,PTDTGSTM
           MULT      IBGEAMNT,PTDTGSTM  * Item GST Amount
           DIV       "100.00",PTDTGSTM
         ENDIF
.
WDDT8405 CALL      NXTTRAN1      * Get the next transaction number
         PACK      KEY22 WITH TADMNO,TREF,TTRANSN1
         CALL      RDADTRN1
         COMPARE   ZERO,OVRCD
         GOTO      WDDT8405 IF EQUAL
.
         MATCH     "     +",TMPZUNIQ
         IF        @EQUAL
           MOVE      ONE,PTDTEPSD       * Flag for billing mechanical vent.
           PACK      DIM30,SP70
.          IF        MVDAYS<>0
             MOVE      MVDAYS,KEY4
             SQUEEZE   KEY4
             CLEAR     DIM30
             APPEND    KEY4,DIM30
             APPEND    SP1,DIM30
             APPEND    TDDESC,DIM30
             APPEND    SP70,DIM30
             RESET     DIM30
.          ENDIF
           PACK      TDDESC,DIM30,SP70
         ENDIF
         PACK      PTDTCNID,MBSCONTR,SP70   * Contract ID
         MOVE      ACLAIM,PTTRCLTY
         CALL      WRDTRN1              * Write Misc.Charge
.
         PROC      CKPROS00             * Check for prosthetic tracking
.
         PACK      KEY14,TADMNO,SAVTRNNO
         CALL      DEPMMTI1             * remove item pending recod
.
WDDT9999 RETURN
+
.*******************************************************************************
.        Remove all un-used items and write to Theatre Consumption file
.*******************************************************************************
RITM0000  BRANCH    ABFFLAG,RITM9999       * printing ABF Invoice
.
          MATCH     "IBAHMS70",PRGID
          GOTO      RITM9999 IF EQUAL
.
          MATCH     "1",OPCNCONS
          GOTO      RITM9999 IF NOT EQUAL  * Not using Consumption type
.
          PACK      KEY14,AADMNO,SP20
          CALL      RSPMMTI1
RITM1000  CALL      RKPMMTI1
          BRANCH    OVRCD,CTMP9999
.
          MATCH     DAADMNO,PMMIVISN
          GOTO      CTMP9999 IF NOT EQUAL
.
          MATCH     "3",PMMIRTYP
          GOTO      RITM1000 IF NOT EQUAL  * Not a Misc.item
.
          COMPARE   ONE,IPATFLAG
          GOTO      RITM2000 IF NOT EQUAL  * not printing patient only invoice
.
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMMIITEM,TITEMNO
          CALL      GMIS0000                * recalculate misc.
          BRANCH    EXIT,RITM1000
.
          IF        IPATFLAG=1
            MATCH     "Y",PTMCKREB
            IF        @EQUAL
              COMPARE   ZERO,PMMIRBAT
              GOTO      RITM1000 IF NOT EQUAL * Item with HF portion
              COMPARE   ZERO,PMMIAMTP
              GOTO      RITM1000 IF EQUAL     * skip zero amt of Pat.& HF
           ELSE
             COMPARE   ZERO,MHFPOR
             GOTO      RITM1000 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,MPATPOR
             GOTO      RITM1000 IF EQUAL     * skip zero amt of Pat.& HF
           ENDIF
          ENDIF
.
RITM2000  PROC      WRCTYP00        * Write to Consumption type item
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTI1             * remove item pending recod
.
          CALL      RSPMMTI1
          GOTO      RITM1000
.
RITM9999  RETURN
+
.*******************************************************************************
.        Display items
.*******************************************************************************
DSIM0000 MOVE      SP70,DIM20
         MATCH     SP70,PTITTCER
         IF        !@EQUAL & !@EOS
           PACK      KEY5,CATCR,PTITTCER,SP70
           CALL      RDCODE1
           IF        OVRCD=0
.            IF        TCFORM6=1 | TCFORM6=2
             MATCH     "D",TCINDC1
             IF        @EQUAL
               MOVE      TDESC,DIM20
               MOVE      ONE,CERTINDC
             ENDIF
           ENDIF
         ENDIF
.
         MOVE      SP70,DIM21
         MATCH     "1",PTITIWRN
         IF        @EQUAL
           MOVE      "Prosthetic Required  ",DIM21
         ENDIF
.
         MOVE      TFMONTH,FORM2
         LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                      NSEP,NOCT,NNOV,NDEC
         MOVE      LINETOT,FORM12P2
         ADD       LINEGST,FORM12P2
         MOVE      FORM12P2,FORM72
         PACK      KEY4,TFCENT,TFYEAR
         REP       " 0",KEY4
.
         IF        TRECTYPE=2 & PMMISERV=0
           MOVE      ONE,PMMISERV
         ENDIF
.
         MATCH     "1",PMMIMVBR
         IF        @EQUAL
           WRITE     HTMLFILE;"<tr><td>",TFDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                              "<td>",MVDAYS,"x ",DIM30,"</td>";
.
           IF        INVTYPE=0
             WRITE     HTMLFILE;"<td>&nbsp;</td>";
           ENDIF
.
           WRITE     HTMLFILE;"<td>",TITEMNO,"</td>";
.
.          MV will have no quantity if zero MV days
.
           IF        INVTYPE=0
             IF        MVDAYS<>0
               WRITE     HTMLFILE;"<td>",MVDAYS,"</td>";
             ELSE
               WRITE     HTMLFILE;"<td>&nbsp;</td>";
             ENDIF
           ENDIF
.
.          New patient portion functionality
.
           MATCH     "1",PTCNPPIN
           IF        @EQUAL
             IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
                WRITE     HTMLFILE;"<td align=right>",PMMIRBAT,"</td>":
                                  "<td align=right>",PMMIAMTP,"</td>";
                GOTO      DSIM8000
             ENDIF
           ENDIF
.
           MOVE      PMMIAMTP,FORM12D2
           ADD       PMMIRBAT,FORM12D2
           WRITE     HTMLFILE;"<td align=right>",FORM12D2,"</td>";
           GOTO      DSIM8000
         ELSE
           WRITE     HTMLFILE;"<tr><td>",TFDAY,SP1,MTHNAM3,SP1,KEY4;
.
.          If this item is from Community billing, check if this item is one
.          of the Regime
.
           COMPARE   ONE,ISBLFLAG
           GOTO      DSIM2000 IF NOT EQUAL
.
           MATCH     "1",PMMIINCT
           GOTO      DSIM2000 IF NOT EQUAL
.
.          Display the To date for item from the Regime
.
           PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
           REP       " 0",KEY8
           IF        PMMISERV<>0
             MOVE      KEY8,ISBLDATE
             ADD       PMMISERV,ISBLDATE
             MOVE      ISBLDATE,KEY8
           ENDIF
           UNPACK    KEY8,XCENT,XYEAR,XMON,XDAY
           MOVE      XCENT,TFCENT
           MOVE      XYEAR,TFYEAR
           MOVE      XMON,TFMONTH
           MOVE      XDAY,TFDAY
           PACK      KEY4,TFCENT,TFYEAR
           REP       " 0",KEY4
           MOVE      TFMONTH,FORM2
           LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                        NSEP,NOCT,NNOV,NDEC
           WRITE     HTMLFILE;" to ",TFDAY,SP1,MTHNAM3,SP1,KEY4:
                              "</td>";
           GOTO      DSIM4000
.
DSIM2000   WRITE     HTMLFILE;"</td>";
.
DSIM4000   MATCH     SP70,DIM20
           IF        @EQUAL | @EOS
             WRITE     HTMLFILE;"<td>",DIM30;
           ELSE
             STRIP     DIM20
             MOVE      ZERO,EXIT         * check certificate return parameter
             PROC      CCERT000          * Check Certificate record
             IF        EXIT=0
               WRITE     HTMLFILE;"<td>",DIM30:
                                  " (<font color=green>",DIM20,"</font>)";
             ELSE
               WRITE     HTMLFILE;"<td>",DIM30:
                                  " (<font color=red>",DIM20,"</font>)";
             ENDIF
           ENDIF
           MATCH     SP70,DIM21
           IF        !@EQUAL
             WRITE     HTMLFILE;" (<font color=red>",DIM21,"</font>)</td>";
           ELSE
             WRITE     HTMLFILE;"</td>";
           ENDIF
.
           IF        INVTYPE=0
             WRITE     HTMLFILE;"<td>&nbsp;",MBSCONTR,"</td>";
           ENDIF
.
           MOVE      "0",KEY1              * Set 'No' to Change item desc.
           MOVE      "0",DIM1              * Set 'No' to Change item amount
           IF        TRECTYPE=3
             MATCH     "2",PMMIITYP        * Exploding item?
             IF        !@EQUAL
               CALL      GMIS0000                * recalculate misc.
.
               IF        TRECTYPE=3
                 COMPARE   ONE,MINDIC
                 IF        @EQUAL
                   MOVE      "1",KEY1          * Set 'Yes' to Change item desc.
                 ENDIF
               ENDIF
               IF        TRECTYPE=3
                 MATCH     "Y",PTMCKREB
                 IF        @EQUAL
                   MOVE      "1",DIM1          * Set 'Yes' to Change item amount
                 ENDIF
               ENDIF
             ENDIF
           ENDIF
.
           WRITE     HTMLFILE;"<td><img src=../images/EditIcon.gif ":
                              " class=ListIcon onclick='DeleteItem(#"":
                              AURNO,"#",#"":
                              AADMNO,"#",#"":
                              PMMITRAN,"#",#"":
                              KEY1,"#",#"":
                              DIM1,"#",#"":
                              PMMIAMTP,"#",#"",PMMIRBAT,"#")'>":
                              TITEMNO,"</td>";
         ENDIF
.
         MATCH     "1",PTCNPPIN
         GOTO      DSIM7800 IF NOT EQUAL
.
.        New patient portion functionality
.
         IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
.
           IF        PMMISERV<>0
             WRITE     HTMLFILE;"<td>",PMMISERV,"</td>":
                                "<td align=right>",PMMIRBAT,"</td>":
                                "<td align=right>",PMMIAMTP,"</td>";
           ELSE
             WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>";
           ENDIF
           GOTO      DSIM8000
.
         ENDIF
.
DSIM7800 IF        PMMISERV<>0
           IF        INVTYPE=0
             WRITE     HTMLFILE;"<td>",PMMISERV,"</td>";
           ENDIF
           MOVE      PMMIAMTP,FORM12D2
           ADD       PMMIRBAT,FORM12D2
           WRITE     HTMLFILE;"<td align=right>",FORM12D2,"</td>";
         ELSE
           IF        INVTYPE=0
             IF        ISBLFLAG=1
               MATCH     "1",PTCNISBZ      * Ind.Billing with Quantity of zero
               IF        @EQUAL
                 WRITE     HTMLFILE;"<td>",PMMISERV,"</td>";
                 GOTO      DSIM7820
               ENDIF
             ENDIF
             WRITE     HTMLFILE;"<td>&nbsp;</td>";
           ENDIF
DSIM7820   WRITE     HTMLFILE;"<td>&nbsp;</td>";
         ENDIF
.
DSIM8000 WRITE     HTMLFILE;"<td align=right>",LINETOT,"</td>":
                            "<td align=right>",LINEGST,"</td>":
                            "<td align=right>",FORM12P2,"</td>":
                            "</tr>"
DSIM9999  RETURN
+
.*******************************************************************************
.       Processing items sort file
.*******************************************************************************
PSRT0000 MOVE      ZERO,FORM6
         MOVE      SP20,CURSESS
         PACK      KEY39,SP70
         CALL      RDSSORT1
PSRT2300 CALL      RDKSORT1
         BRANCH    OVRCD,PSRT9000
.
         MOVE      PINVNO,TREF
         MATCH     "IBAHMS70",PRGID
         GOTO      PSRT2310 IF NOT EQUAL
.
         PACK      KEY22,AADMNO,TREF,ZTRNN
         CALL      RDDTRN1
         BRANCH    OVRCD,PSRT2310
         MOVE      SP70,PMMIITYP
         GOTO      PSRT2315
.
PSRT2310 PACK      KEY14,AADMNO,ZTRNN
         CALL      RDPMMTI1
         BRANCH    OVRCD,PSRT2300
         CALL      MTDT0000                  * move fields
.
PSRT2315 MOVE      ONE,MNINV                 * default to one invoice
         MATCH     "3",ZRECTYP
         GOTO      PSRT2328 IF NOT EQUAL   * not miscellaneous item    *C-90303
.
.        Process Miscellaneous Items (DTRs)
.
         COMPARE   ONE,CMXFLAG
         GOTO      PSRT2320 IF NOT EQUAL   * not casepayment
.
.        accummulate no of items to see if this item tobe charged for casemix
.
         MATCH     DIM9,ZMISC
         IF        @EQUAL
           ADD       ONE,COUNTA
         ELSE
           MOVE      ONE,COUNTA
           MOVE      ZMISC,DIM9          * save the new item code
         ENDIF
.
PSRT2320 MATCH     "2",PMMIITYP
         GOTO      PSRT2328 IF EQUAL       * Exploding item - no recalculate
.
         CALL      GMIS0000                * recalculate misc.
         BRANCH    EXIT,PSRT2328
.
         COMPARE   TWO,IPATFLAG
         GOTO      PSRT2321 IF NOT EQUAL
.
         MOVE      TWO,MNINV               * override No of invoice from item
         LOAD      NUMINVS,MNINV,NUMINVS,TWO
         COMPARE   TWO,MNINV
         GOTO      PSRT2322 IF EQUAL
.
.        If we are printing Patient Only Invoice, skip item with HF portion
.
PSRT2321 IF        IPATFLAG=1
           MATCH     "Y",PTMCKREB
           IF        @EQUAL
             COMPARE   ZERO,TREBATE
             GOTO      PSRT2300 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,TPATAMTP
             GOTO      PSRT2300 IF EQUAL     * skip zero amt of Pat.& HF 
           ELSE
             COMPARE   ZERO,MHFPOR
             GOTO      PSRT2300 IF NOT EQUAL * Item with HF portion
             COMPARE   ZERO,MPATPOR
             GOTO      PSRT2300 IF EQUAL     * skip zero amt of Pat.& HF 
           ENDIF
         ENDIF
.
PSRT2322
         MATCH     "Y",PTMCKREB
         GOTO      PSRT2328 IF EQUAL       * manual change for rebate
.
         COMPARE   ONE,CMXFLAG
         GOTO      PSRT2323 IF NOT EQUAL   * not casemix, just charge item
.
         COMPARE   ZERO,PTMCCFCY           * No charge on all items
         GOTO      PSRT2325 IF EQUAL
.
         COMPARE   PTMCCFCY,COUNTA         * Charge from item number ?
         GOTO      PSRT2325 IF LESS
.
.        Check for front end deductable item
.
PSRT2323 MOVE      MPATPOR,FORM12P2
         ADD       MHFPOR,FORM12P2
.
.        Check if it's a Front end deductable item, only if the sum of
.        HF and patient portion is zero and at least one of them is not zero.
.
          IF        FORM12P2=0 & MPATPOR<>0
             GOTO      PSRT2327        * front end deductable - don't change
          ENDIF
.
.        Check if this item was entered manually.
.
         IF        MPATPOR=0 & MHFPOR=0
.
.        Check with parameter if Zero amount of item to be recalculated
.
           MATCH     "1",PTCNCALM
           GOTO      PSRT2324 IF EQUAL
           GOTO      PSRT2327           *  do not change the amount
         ENDIF
.
PSRT2324 COMPARE   TWO,MNINV
         GOTO      PSRT2327 IF EQUAL    *  split invoices - don't change amount
.
         MOVE      MPATPOR,TPATAMTP
         MOVE      MHFPOR,TREBATE
         GOTO      PSRT2327
.
PSRT2325 MOVE      ZERO,TPATAMTP
         MOVE      ZERO,TREBATE
.
PSRT2327 MOVE      TPATAMTP,TPATAMTT
         ADD       TREBATE,TPATAMTT
         IF        TSERVS<>0
           MULT      TSERVS,TPATAMTT
         ENDIF
.
         GOTO      PSRT2329
.
.        Make sure total of patient and rebate portion equal to tatal (tpatamtt)
.
PSRT2328 COMPARE   ZERO,TSERVS
         GOTO      PSRT2329 IF EQUAL
         MOVE      TPATAMTP,FORM12P2
         ADD       TREBATE,FORM12P2
         MULT      TSERVS,FORM12P2
         COMPARE   TPATAMTT,FORM12P2
         GOTO      PSRT2329 IF EQUAL
         DIV       TSERVS,TPATAMTP
         DIV       TSERVS,TREBATE
.
.        End of Miscellaneous Items (DTRs)  - Type "3" Process
.        Write Type "2" & "3" to Tempfile
.
PSRT2329 MOVE      ZERO,OVRCD
         MOVE      DTRECTYP,TMPRECTY
         PACK      TMPDTRDT,TFCENT,TFYEAR,TFMONTH,TFDAY
         REP       " 0",TMPDTRDT
         IF        TRECTYPE=2
.....      MOVE      ZUNIQ,TMPZUNIQ                                     D-46224
           ADD       ONE,FORM6              * use input seq from 1st   *I-46224
           MOVE      FORM6,TMPZUNIQ         * work file - SORTFILE     *I-46224
         ELSE
           MOVE      DTTRANSN1,TMPZUNIQ
         ENDIF
         MOVE      DTTRANSN1,TMPTRNSC
         MOVE      TREF,TMPREFNC
         MOVE      TPATAMTP,TMPAMNTP
         MOVE      TREBATE,TMPREBAT
         MOVE      MNINV,TMPMNINV
         PACK      KEY15,TMPRECTY,TMPDTRDT,TMPZUNIQ
         CALL      WRSRTM1
.
         GOTO      PSRT2300
.
.        Write a mechv billing record if required. We want this to appear as the
.        first misc. charge on the invoice (directly under accommodation).
.
PSRT9000 IF        CMXFLAG=1 & MVBFLAG=1
           MOVE      "1",TMPRECTY           * want this to be first record
           MOVE      MVBDATE,TMPDTRDT
           MOVE      "     +",TMPZUNIQ       * dummy transaction number
           MOVE      MNINV,TMPMNINV
           PACK      KEY15,TMPRECTY,TMPDTRDT,TMPZUNIQ
           CALL      WRSRTM1
         ENDIF
.
PSRT9999  RETURN
+
.*******************************************************************************
.         Endi of invoice
.*******************************************************************************
EINV0000  CALL      KTMP0000
          CALL      KLMV0000
          CALL      KT2P0000
.
          MOVE      GROSSTOT,NETTOT
          MOVE      ZERO,REBTOT
          ADD       HFACCM,REBTOT
          ADD       HFTHEA,REBTOT
          ADD       HFMISC,REBTOT
.
          CALL      NPRT0000                * Display/Print end of invoice
EINV9999  RETURN
+
.*******************************************************************************
.         Print Item line
.*******************************************************************************
PITM0000  
          CALL      CKTL0000     * check if tail needs to be printed
.
          IF        IBCNUGST=2
            MOVE      LINETOT,FORM12P2
            ADD       LINEGST,FORM12P2
            MOVE      FORM12P2,FORM72
          ENDIF
.
          MOVE      SP70,XBANDING
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND05;*189,PTCNPRCL
          IF        PTCNINVL=16 | PTCNINVL=18
            IF        PTCNPRCL=1 & TRECTYPE=2
              IF        CLAIM=1 | CLAIM=2
                MOVE      PTDTSUNQ,XBANDING
              ENDIF
             ENDIF
          ENDIF
.
          IF        PTCNINVL=24 & TRECTYPE=2
            MATCH     SP70,SAVDATE1
            IF        !@EQUAL
              MATCH     SAVDATE1,TMPDTRDT
              IF        !@EQUAL
                CALL      GJGA0000
              ENDIF
            ENDIF
            MOVE      TMPDTRDT,SAVDATE1
            MOVE      PMMIUNIQ,SAVEUNIQ
          ENDIF
.
          PACK      DFDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          MOVE      SP70,DTDATE
          MOVE      PMMIAMTP,LSTRATE
          IF        IPATFLAG<>2
            ADD       PMMIRBAT,LSTRATE
          ELSE
            COMPARE   ZERO,LSTRATE
            GOTO      PITM9999 IF EQUAL    * Item with zero amount
          ENDIF
          MOVE      TSERVS,NODAYS
          MOVE      TWO,RECFLAG     * flag for printing items
          CALL      PRLN0000        * Print line of invoice
.
PITM9999  RETURN
+
.*******************************************************************************
.* PBXC0000  :  handle all phone charges (PABX)                            
.*******************************************************************************
PBXC0000  MOVE      ZERO,CANCINV              * we are not cancelling invoice
          CALL      PCALL000                  * get all calls into a temp file
.
          MATCH     SP9,IBCNPBXI              * not using this feature
          GOTO      PBXC9999 IF EQUAL
.
          MOVE      IBCNPBXI,TITEMNO          * set up item no.
          PACK      MISCDATE,CCC,CYY,CMM,CDD  * set current date
          REP       " 0",MISCDATE
          MOVE      SP3,MMSCGRP
          CALL      DCLM0000                * Check Hospital claim code charging
          PACK      KEY29,PTCNDCLM,SP6,SP3,IBCNPBXI,MISCDATE
          CALL      PATMCHRD              * read Misc.Charges file (single read)
          MOVE      MMSCGRP,TMISGRP
.
          PACK      KEY1,SP1
          CALL      RSTMP21 
PBXC2300  CALL      RKTMP21
          BRANCH    OVRCD,PBXC9000
.
.        Check if two invoices are wanted
.
.. ?????? LOAD      NUMINVS,TNINVS,NUMINVS,TWO
.
          MOVE      XTOTCOST,LINETOT                * load amount for line total
          MOVE      LINETOT,XLINETOT
          
.
.    Process this miscellaneous item
.
PBXC2400  ADD       LINETOT,GROSSTOT
          ADD       LINETOT,MISCTOT
.
         MOVE      PTMCGSTA,PTDTGSTA
         MOVE      PTMCGSTC,PTDTGSTC
         MOVE      ZERO,LINEGST
         IF        IBCNUGST=2 & PTDTGSTA=1
           CALL      IGST0000               * Get Item GST rate
           MOVE      LINETOT,LINEGST
           MULT      IBGEAMNT,LINEGST     * GST amount
           DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
           ADD       LINEGST,TOTGST
         ENDIF
.
          MOVE      SP9,PRTITCOD
.
          IF        PTCNPMIS=1
            MOVE      TITEMNO,PRTITCOD     * Print miscellaneous item
          ENDIF
.
          BRANCH    PROGFLAG,PBXC2300,PBXC2600,PBXC2800,PBXC8800,PBXC9999:
                             PBXC2800
.
.  --- Display miscellaneous item ---
.
PBXC2600  UNPACK    XCALDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
.
          LOAD      KEY30,XTYPE,CLLOCLNG,CLSTDLNG,CLISDLNG
.
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          MOVE      LINETOT,FORM12P2
          ADD       LINEGST,FORM12P2
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>":
                              CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                              "<td>",KEY30,"</td>":
                              "<td>",IBCNPBXI,"</td>";
.
           IF        INVTYPE=0
             WRITE     HTMLFILE;"<td>&nbsp;</td>";
           ENDIF
.
           MATCH     "1",PTCNPPIN
           IF        @EQUAL
             IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
               WRITE     HTMLFILE;"<td>&nbsp;</td>";
             ENDIF
           ENDIF
.
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td align=right>",LINETOT,"</td>":
                              "<td align=right>",LINEGST,"</td>":
                              "<td align=right>",FORM12P2,"</td>":
                              "</tr>"
.
PBXC2680  ADD       ONE,VERT
          GOTO      PBXC2300                         * get next item for display
.
.  --- Print miscellaneous item ---
.
PBXC2800  MOVE      XTOTCOST,FORM12P2                 * set up amount
.
          UNPACK    XCALDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
.
          LOAD      KEY30,XTYPE,CLLOCLNG,CLSTDLNG,CLISDLNG
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
            PRINT     *2,CPDATE:
                      *25,KEY30,*51,IBCNPBXI;
            IF        IBCNUGST=2
              MOVE      LINETOT,FORM12P2
              ADD       LINEGST,FORM12P2
              MOVE      FORM12P2,FORM72
              PRINT     *N,*39,XLINETOT,*53,XLINEGST;
            ENDIF
            PRINT     *69,FORM72
.
          CALL      PEOL0000
          CALL      CKTL0000     * check if tail needs to be printed
.
.  write a patdtraf record
.
PBXC8380 COMPARE   SIX,PROGFLAG
         GOTO      PBXC2300 IF EQUAL           * Printing discharge billing
.
         CALL      WRDTR000                    * from PABXBILL.PBL
.
.        Update the Fees Invoiced Summary file
.
PBXC8800  MATCH     "IBAINP19",PRGID
          IF        !@EQUAL
            BRANCH    REVBFLAG,PBXC2300     * ADT09 only have breakdown lumpsum
          ENDIF
.
          MOVE      LINETOT,FINAMT
          MOVE      "A",FINTYPE
.
          IF        CMXFLAG = 1
            MOVE      "T",ANS
            IF        PTCNMFEE = 1
              PACK      FINCODE,ANS,DCFLAG,ACLAIM,TMISGRP,SP20
            ELSE
              PACK      FINCODE,ANS,DCFLAG,TMISGRP,TITEMNO,SP20
            ENDIF
          ELSE
            IF        PTCNMFEE = 1
              PACK      FINCODE,ANSM,ACLAIM,TMISGRP,SP20
            ELSE
              PACK      FINCODE,ANSM,TMISGRP,TITEMNO,SP20
            ENDIF
          ENDIF
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          UNPACK    PINVDTE,XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          IF        IBCNUGST=2
            IF        LINEGST<>0
              MOVE      ONE,FGSTFLAG
              PACK      FINDATE,CC,YY,MM,DD
              REP       " 0",FINDATE
              MOVE      LINEGST,FINAMT
              MOVE      PMVXMHOS,FINHOSP
              CALL      PATCALF
              MOVE      ZERO,FGSTFLAG
            ENDIF
          ENDIF
          GOTO      PBXC2300                     * get next call from temp file
.
PBXC9000  IF        PROGFLAG=3 
            CALL      UPPBX000     * update ibapabxf to say we have billed call
          ENDIF
.
PBXC9500  CALL      KILLP000                     * erase temp file -PABXBILL.PBL
.
PBXC9999 RETURN
+
.*******************************************************************************
.* PBZZ0000  :  handle all phone charges (PABX)                            
.*                                                                         
.* 
.*                                                                         
.*  This routine is not called, however it is left here in case a site     
.*  would like ALL calls to be listed on the bill                          
.*                                                                         
.*                                                                         
.*                                                                         
.*******************************************************************************
PBZZ0000  MOVE      ZERO,CANCINV              * we are not cancelling invoice
          CALL      PCALL000                  * get all calls into a temp file
.
          MOVE      IBCNPBXI,TITEMNO          * set up item no.
          MOVE      SP3,MMSCGRP
          CALL      MCHDFL00        * Check Hospital claim code charging
          PACK      MISCDATE,CCC,CYY,CMM,CDD
          REP       " 0",MISCDATE
          PACK      KEY29,PTCNDCLM,SP6,SP3,IBCNPBXI,MISCDATE,SP20
          CALL      PATMCHRD                  * get misc. item group (single)
          MOVE      MMSCGRP,TMISGRP
.
          PACK      KEY21,SP30
          CALL      RSTEMP1
PBZZ2300  CALL      RKTEMP1
          BRANCH    OVRCD,PBZZ9000
.
.        Check if two invoices are wanted
.
.. ?????? LOAD      NUMINVS,TNINVS,NUMINVS,TWO
.
          MOVE      XAMOUNT,LINETOT                * load amount for line total
          MOVE      LINETOT,XLINETOT
.
.    Process this miscellaneous item
.
PBZZ2400  ADD       LINETOT,GROSSTOT
          ADD       LINETOT,MISCTOT
.
          MOVE      SP9,PRTITCOD
.
          IF        PTCNPMIS=1
            MOVE      TITEMNO,PRTITCOD     * Print miscellaneous item
          ENDIF
.
          BRANCH    PROGFLAG,PBZZ2300,PBZZ2600,PBZZ2800,PBZZ8800
.
.  --- Display miscellaneous item ---
.
PBZZ2600  UNPACK    XCALDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
.
          LOAD      KEY5,XTYPE,CLLOC,CLSTD,CLISD
          PACK      KEY30,KEY5,SP1,XCDESC
.
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>":
                             CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td>",KEY30,"</td>":
                             "<td>",IBCNPBXI,"</td>";
.
          IF        INVTYPE=0
           WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td align=right>",LINETOT,"</td></tr>"
          ADD       ONE,VERT
          GOTO      PBZZ2300                         * get next item for display
.
.  --- Print miscellaneous item ---
.
PBZZ2800  MOVE      XAMOUNT,FORM12P2                 * set up amount
.
          COMPARE   "21",COUNT
          CALL      TAIL IF NOT LESS
.
          UNPACK    XCALDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          CALL      PACDATE
.
          LOAD      KEY5,XTYPE,CLLOC,CLSTD,CLISD
          PACK      KEY30,KEY5,SP1,XCDESC
.
          PRINT     *2,CPDATE:
                    *25,KEY30,SP1,IBCNPBXI,*69,XLINETOT;
.
          CALL      PEOL0000
          CALL      CKTL0000     * check if tail needs to be printed
.
.  write a patdtraf record
.
PBZZ8380  CALL      WRDTR000                    * from PABXBILL.PBL
.
.        Update the Fees Invoiced Summary file
.
PBZZ8800  MATCH     "IBAINP19",PRGID
          IF        !@EQUAL
            BRANCH    REVBFLAG,PBZZ2300     * ADT09 only have breakdown lumpsum
          ENDIF
.
          MOVE      LINETOT,FINAMT
          MOVE      "A",FINTYPE
.
          IF        CMXFLAG = 1
            MOVE      "T",ANS
            IF        PTCNMFEE = 1
              PACK      FINCODE,ANS,DCFLAG,ACLAIM,TMISGRP,SP20
            ELSE
              PACK      FINCODE,ANS,DCFLAG,TMISGRP,TITEMNO,SP20
            ENDIF
          ELSE
            IF        PTCNMFEE = 1
              PACK      FINCODE,ANSM,ACLAIM,TMISGRP,SP20
            ELSE
              PACK      FINCODE,ANSM,TMISGRP,TITEMNO,SP20
            ENDIF
          ENDIF
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
          ENDIF
.
          UNPACK    PINVDTE,XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          IF        IBCNUGST=2
            IF        LINEGST<>0
              MOVE      ONE,FGSTFLAG
              PACK      FINDATE,CC,YY,MM,DD
              REP       " 0",FINDATE
              MOVE      LINEGST,FINAMT
              MOVE      PMVXMHOS,FINHOSP
              CALL      PATCALF
              MOVE      ZERO,FGSTFLAG
            ENDIF
          ENDIF
          GOTO      PBZZ2300                     * get next call from temp file
.
PBZZ9000  CALL      KILLP000                     * erase temp file -PABXBILL.PBL
.
PBZZ9999 RETURN
+
.*******************************************************************************
.        NPRT0000 - Display/print the goverment subsidy and the invoice total
.*******************************************************************************
NPRT0000 MOVE      FDAY,CDAY
         MOVE      FMON,CMON
         MOVE      FCENT,CCENT
         MOVE      FYEAR,CYEAR
         CALL      PACDATE
         MOVE      GROSSTOT,XGROSTOT
         MOVE      TOTGST,XTOTGST
.
         BRANCH    PROGFLAG OF NPRT9000,NPRT1000,NPRT4000,NPRT9000
.
.        Do not print Goverment Subsidy with zero total
.
NPRT1000  COMPARE   ZERO,GOVTOTAL
          GOTO      NPRT1200 IF EQUAL
.
          MOVE      GROSSTOT,FORM12P2
          ADD       TOTGST,FORM12P2
          CALL      DGOV0000                * Display Gov.Subsidy
          SUB       GOVTOTAL,GROSSTOT
.
.        Display invoice total and check if there was any cash received
.
NPRT1200  MOVE      GROSSTOT,FORM12P2
          ADD       TOTGST,FORM12P2
          IF        PREBFLAG=1 & DBSFLAG=0 & ISBLFLAG=0
            CALL      RSIN0000                * Display rebate invoice total
          ELSE
            CALL      DSIN0000                * Display invoice total
          ENDIF
.
          CALL      DEFR0000                * Display EFR message
          BRANCH    EXIT,NPRT1600
.
          SUB       REBTOT,NETTOT
          SUB       PMOIETY,NETTOT
.
NPRT1600 SUB       CSAMT,NETTOT
         SUB       NBNKAMNT,NETTOT
.
         CALL      DCSH0000                 * Display Cash payment
.
         CALL      DBPY0000                 * Display balance payable
         GOTO      NPRT9999
.
.        Print Goverment Subsidy amount if it is non-zero
.
NPRT4000 COMPARE   ZERO,GOVTOTAL
         GOTO      NPRT4300 IF EQUAL
.
         CALL      PGOV0000             * Print Gov.Subsidy
         CALL      WGOV0000             * Write DTR to Gov.Subsidy
.
NPRT4300 COMPARE   NINE,CFEETYP
         GOTO      NPRT9000 IF EQUAL    * Johns Hopkins
.
         CALL      RPRT0000             *  Print Invoice total
         GOTO      NPRT9999
.
.        Just calculating total : Subtract Government Subsidy from net total
.
NPRT9000 SUB       GOVTOTAL,NETTOT
         IF        IBCNUGST=2
           ADD       TOTGST,NETTOT
         ENDIF
.
NPRT9999 RETURN
+
.*******************************************************************************
.        Display Government subside if any
.*******************************************************************************
DGOV0000
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                            "<td><b>Sub-Total</b></td>":
                            "<td>&nbsp;</td>";
.
          IF        INVTYPE=0 & DBSFLAG<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right>",GROSSTOT,"</td>":
                             "<td align=right>",XTOTGST,"</td>":
                             "<td align=right>",FORM12P2,"</td>":
                             "</tr>"
          MOVE      TMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,TCENT,TYEAR
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>":
                             TDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td>Govt. Bed Subsidy</td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",STRATEG,"</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>&nbsp;</td>":
                             "<td align=right>",GOVTOTAL,"</td></tr>"
.
DGOV9999  RETURN
+
.*******************************************************************************
.         Display  invoice total
.*******************************************************************************
DSIN0000  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                "<td>&nbsp;</td>":
                                "<td>&nbsp;</td>";
.
          IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "</tr>":
                              "<tr><td>&nbsp;</td>":
                                  "<td><b> Invoice Total </b></td>":
                                  "<td>&nbsp;</td>";
          IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          BRANCH    ISBLFLAG,DSIN2000
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              MOVE       PPAYABLE,FORM12P2
              SUB        TOTPGST,FORM12P2
              WRITE      HTMLFILE;"<td>&nbsp;</td>":
                              "<td align=right><b>",FORM12P2,"</b></td>":
                              "<td align=right><b>",TOTPGST,"</b></td>":
                              "<td align=right><b>",PPAYABLE,"</b></td>":
                              "</tr>" 
              MOVE      PPAYABLE,NETTOT
              MOVE      PPAYABLE,FORM12P2
              GOTO      DSIN8000
            ENDIF
          ENDIF
.
DSIN2000  WRITE      HTMLFILE;"<td>&nbsp;</td>":
                              "<td align=right><b>",GROSSTOT,"</b></td>":
                              "<td align=right><b>",TOTGST,"</b></td>":
                              "<td align=right><b>",FORM12P2,"</b></td>":
                              "</tr>" 
.
          MOVE      GROSSTOT,NETTOT
          IF        IBCNUGST=2
            ADD       TOTGST,NETTOT
          ENDIF
.
DSIN8000  WRITE      HTMLFILE;"<input type=hidden name=pcbiinvt ":
                              "value='",FORM12P2,"'>"
DSIN9999  RETURN
+
.*******************************************************************************
.         Don't display E.F.R message if we are doing two invoices
.*******************************************************************************
DEFR0000  BRANCH    IPASS OF DEFR9000,DEFR9000
.
          BRANCH    PTCNPEFR,DEFR1300,DEFR9000
.
          COMPARE   ZERO,REBTOT
          GOTO      DEFR9000 IF EQUAL
.
DEFR1300  BRANCH    CLAIM OF DEFR1400,DEFR1400,DEFR1400
.
.         Display the total rebate
.
          CALL      PMOI0000
          IF        PMOIETY<REBTOT
            SUB       PMOIETY,REBTOT
          ELSE
            MOVE      REBTOT,PMOIETY
            MOVE      ZERO,REBTOT
          ENDIF
          MOVE      PMOIETY,PTINPMAM
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>Estimated Fund Rebate </td>":
                             "<td>&nbsp;</td>";
.
          IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",REBTOT,"</td>":
                             "</tr>"
.
          IF        PMOIETY<>0
            MOVE      "Patient Moiety",KEY30
            MATCH     SP70,PTHFDSC1
            IF        !@EQUAL
              PACK      KEY30,PTHFDSC1,SP70
            ENDIF
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>",KEY30,"</td>":
                             "<td>&nbsp;</td>";
.
            IF        INVTYPE=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                 "<td>&nbsp;</td>";
            ENDIF
.
            MATCH     "1",PTCNPPIN
            IF        @EQUAL
              IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td align=right>",PMOIETY,"</td>":
                            "</tr>"
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DEFR9999
.
DEFR1400  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>Estimated Insurer Rebate </td>":
                               "<td>&nbsp;</td>";
.
          IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><font color=#FF0000><b>":
                             REBTOT,"</font></b></td>":
                             "</tr>"
         MOVE       ZERO,EXIT
         GOTO       DEFR9999
.
DEFR9000 MOVE       ONE,EXIT
DEFR9999 RETURN
+
.*******************************************************************************
.        Display balance payable
.*******************************************************************************
DBPY0000 WRITE      HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td><b>Balance Payable </b></td>":
                             "<td>&nbsp;</td>";
.
         IF        INVTYPE=0
           WRITE      HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
         ENDIF
.
         MATCH     "1",PTCNPPIN
         IF        @EQUAL
           IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
             WRITE     HTMLFILE;"<td>&nbsp;</td>";
           ENDIF
         ENDIF
.
         WRITE      HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",NETTOT,"</b></td></tr>"
         WRITE     HTMLFILE;"<input type=hidden name=pcbibalp ":
                            "value='",NETTOT,"'>";
.
         MOVE      ZERO,TDBSAMNT
         CALL      CELG0000                 * generate Eligibility Check amt
.
.        tag for the Total Patient invoice amount prior Excess/payment
.
         WRITE     HTMLFILE;"<input type=hidden name=ptinvamt ":
                              "value='",PPAYABLE,"'>"
.
         ADD       TDBSAMNT,PPAYABLE
.
         WRITE     HTMLFILE;"<input type=hidden name=ppayable ":
                              "value='",PPAYABLE,"'>"
.
DBPY9999 RETURN
+
.*******************************************************************************
.        Generate Eligibility Check amount
.*******************************************************************************
CELG0000  MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      ZERO,CPAYPRIV
            MOVE      ZERO,CPAYSHRD
            MOVE      ZERO,CPAYCCUH           * Co-payment for CCU/ICU/SCN/HDU
          ELSE
            CALL      CBDY0000           * Check for invoiced accomm.bed days
          ENDIF
.
          MOVE      PTELPPUT,MAXCOPAY    * Max copayment $ amount
          MOVE      ZERO,SUMCOPAY        * Sum of copayment $ amount
          MOVE      CPAYPRIV,FORM12P2
          IF        PTELPPUT<>0
            IF        CPAYPRIV>PTELPPUT
              MOVE      PTELPPUT,FORM12P2
            ENDIF
          ENDIF
.
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
          ADD       FORM12P2,TDBSAMNT
.
          MOVE      CPAYSHRD,FORM12P2
          IF        PTELPSUT<>0
            IF        CPAYSHRD>PTELPSUT
              MOVE      PTELPSUT,FORM12P2
            ENDIF
          ENDIF
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
          ADD       FORM12P2,TDBSAMNT
.
          MOVE      ZERO,FORM12P2
          MATCH     DDATE,ADATE
          IF        @EQUAL
            MOVE      PTELPSDY,FORM12P2
            IF        PTELPSDU<>0
              IF        PTELPSDY>PTELPSDU
                MOVE      PTELPSDU,FORM12P2
              ENDIF
            ENDIF
          ENDIF
          IF        MAXCOPAY<>0
            IF        SUMCOPAY>=MAXCOPAY
              MOVE      ZERO,FORM12P2                   * Max reached
            ELSE
              IF (SUMCOPAY+FORM12P2)>MAXCOPAY
                ASSIGN    MAXCOPAY-SUMCOPAY,FORM12P2
                ADD       FORM12P2,SUMCOPAY
              ELSE
                ADD       FORM12P2,SUMCOPAY
              ENDIF
            ENDIF
          ENDIF
          ADD       FORM12P2,TDBSAMNT
.
          MOVE      CPAYCCUH,FORM12P2
          IF        PTELPCUT<>0
            IF        CPAYCCUH>PTELPCUT
              MOVE      PTELPCUT,FORM12P2
            ENDIF
          ENDIF
.
          ADD       FORM12P2,TDBSAMNT
          MOVE      PTELPHSP,FORM12P2
.         MOVE      ASTAY,F3              * default to Expected LOS
          IF        DYCHRGED=0
            MOVE      ONE,F3              * treat LOS as 1
          ELSE
            MOVE      DYCHRGED,F3         * use the actual LOS
          ENDIF
          MULT      F3,FORM12P2
          IF        PTELPHSU<>0
            IF        FORM12P2>PTELPHSU
              MOVE      PTELPHSU,FORM12P2
            ENDIF
          ENDIF
.
          ADD       FORM12P2,TDBSAMNT
          ADD       PTELPTHE,TDBSAMNT
          IF        ASTAT=3
            MATCH     DDATE,ADATE
            IF        @EQUAL
              ADD       PTELXCSD,TDBSAMNT
              GOTO      CELG1000
            ENDIF
          ENDIF
          ADD       PTELXCSS,TDBSAMNT
.
.         Check for any payments
.
CELG1000  PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
CELG2000  CALL      RKRCDTE6
          BRANCH    OVRCD,CELG9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      CELG9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      CELG2000 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,CELG2000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      CELG2000 IF EQUAL
.
          MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,TDBSAMNT
.
          GOTO      CELG2000
CELG9999  RETURN
+
.------------------------------------------------------------------------------
.   Calculate invoiced accommodation bed days for Private and Shared Co-payment
.------------------------------------------------------------------------------
CBDY0000  MOVE      "1",DIM1             * Accommodation record
          PACK      KEY18,AADMNO,DIM1,SP70
          CALL      RDSDTRN3
CBDY1000  CALL      RDKDTRN3
          BRANCH    OVRCD,CBDY9999
.
          MATCH     AADMNO,TADMNO
          GOTO      CBDY9999 IF NOT EQUAL
.
          MATCH     DTRECTYP,DIM1
          GOTO      CBDY9999 IF NOT EQUAL * Not accommodation record
.
          MATCH     "1",PTDTCRST
          GOTO      CBDY1000 IF EQUAL     * Credit note
.
          COMPARE   ZERO,TNODAYS
          GOTO      CBDY1000 IF EQUAL
.
          MOVE      PTDTBTYP,STRBTYP
          MOVE      TNODAYS,NODAYS
          CALL      SCPAY0000             * from DBSCATBI (setup co-payment)
          GOTO      CBDY1000
CBDY9999  RETURN
+
.*******************************************************************************
.        Print Goverment Subsidy amount if it is non-zero
.*******************************************************************************
PGOV0000 CALL      PEOL0000
         CALL      CKTL0000     * check if tail needs to be printed
.
           IF        IBCNUGST=2
             MOVE      GROSSTOT,FORM12P2
             ADD       TOTGST,FORM12P2
             MOVE      FORM12P2,FORM72
             IF        PTCNINVB<>0
               IF        PTCNINVB=1 
                 PRINT     *25,"SUB-TOTAL",*96,XGROSTOT:
                           *107,XTOTGST,*123,FORM72;
               ELSE
                 PRINT     *25,"SUB-TOTAL",*74,XGROSTOT:
                           *85,XTOTGST,*94,FORM72;
               ENDIF
             ELSE
               IF        PTCNINVL=16 | PTCNINVL=18
                 PRINT     *25,"SUB-TOTAL",*46,XGROSTOT:
                           *56,XTOTGST,*69,FORM72;
               ELSE
                 PRINT     *25,"SUB-TOTAL",*39,XGROSTOT:
                           *53,XTOTGST,*69,FORM72;
               ENDIF
             ENDIF
           ELSE
             PRINT     *52,"SUB-TOTAL",*69,XGROSTOT;
           ENDIF
.
           CALL      PEOL0000
.
           IF        PTCNINVL=16 | PTCNINVL=18
             PRINT     *3,CPDATE;
           ELSE
             PRINT     *2,CPDATE;
           ENDIF
           MOVE      TDAY,CDAY
           MOVE      TMON,CMON
           MOVE      TCENT,CCENT
           MOVE      TYEAR,CYEAR
           CALL      PACDATE
           IF        PTCNINVB<>0
             PRINT     *11,CPDATE,*20,TOTDAYS;
             IF        PTCNINVB=1
               PRINT     *25,"GOVT. BED SUBSIDY",*107,STRATEG,*123,GOVTOTAL;
             ELSE
               PRINT     *25,"GOVT. BED SUBSIDY",*85,STRATEG,*94,GOVTOTAL;
             ENDIF
           ELSE
             IF        PTCNINVL=16 | PTCNINVL=18
               PRINT     *12,CPDATE,*20,TOTDAYS:
                         *25,"GOVT. BED SUBSIDY",*56,STRATEG,*69,GOVTOTAL;
             ELSE
               PRINT     *11,CPDATE,*20,TOTDAYS:
                         *25,"GOVT. BED SUBSIDY",*60,STRATEG,*69,GOVTOTAL;
             ENDIF
           ENDIF
.
         CALL      PEOL0000
.
PGOV9999 RETURN
+
.*******************************************************************************
.        Write Government Subsidy record to DTRAN file
.*******************************************************************************
WGOV0000 MOVE      SP30,TDDESC
         MOVE      "GOVT. BED SUBSIDY",TDDESC
         MOVE      GOVTOTAL,TPATAMTT
         MOVE      "G" TO TTYPEDEB
         MOVE      ZERO,TCLAIM      *** set up as not yet claimed 3/9/86
         MOVE      STRATEG,TPATAMTI
         MOVE      GOVTOTAL,TPATAMTG
         MOVE      ZERO,TPATAMTH
         MOVE      ZERO,TPATAMTP
         MOVE      "GS",TTYPE
         MOVE      TOTDAYS,TNODAYS
         MOVE      "4",TRECTYPE   (4 = GOVERMENT SUBSIDY)
         MOVE      ZERO,PTDTCCU
         MOVE      ZERO,PTDTGSTA
         MOVE      SP10,PTDTGSTC
         MOVE      ZERO,PTDTGSTM
         MOVE      ZERO,PTDTGSTL
         MOVE      SP70,PTDTBTYP
         MOVE      ZERO,TPAYTYPE
.
         MOVE      FDAY,FDAY1
         MOVE      FMON,FMON1
         MOVE      FCENT,FCENT1
         MOVE      FYEAR,FYEAR1
         MOVE      TDAY,TDAY1
         MOVE      TMON,TMON1
         MOVE      TYEAR,TYEAR1
         MOVE      TCENT,TCENT1
         MOVE      ZERO,PTDTCCU         * no additional charges
         MOVE      SP1,PTDTCRST
         MOVE      ZERO,PTDTADPT
         MOVE      ZERO,PTDTADRB
         MOVE      SP70,TMISGRP
.
         CALL      WRITETRN
         SUB       GOVTOTAL,GROSSTOT
WGOV9999 RETURN
+
.*******************************************************************************
.        Display Cash and Non-banked deposits
.*******************************************************************************
DCSH0000  
.
.         If there is no cash to be invoiced, or if this is the insurance
.         invoice, don't display cash.
.
          IF        CASHFLAG = 0 | IPASS = 2
            GOTO      DCSH2000
          ENDIF
.
          OPEN      COMDEPA2,"comdepaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          MOVE      AADMNO,DAADMNO
          MOVE      "0",CMDESTAT
          PACK      KEY26,AADMNO,CMDESTAT,SP70
          CALL      RSCMDEP2
DCSH1000  CALL      RKCMDEP2
          BRANCH    OVRCD,DCSH2000
.
          MATCH     DAADMNO,CMDEADMN
          GOTO      DCSH2000 IF NOT EQUAL
          MATCH     "0",CMDESTAT
          GOTO      DCSH2000 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,DCSH1000
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,DCSH1000
.
          MOVE      SP70,DIM4
          UNPACK    CMDETDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DISR0000               * Display record
.
          GOTO      DCSH1000
.
.         Check for any non-banked deposits
.
DCSH2000  MOVE      ZERO,NBNKAMNT
          PACK      KEY25,AADMNO,SP70
          CALL      RSRCDTE6
DCSH3000  CALL      RKRCDTE6
          BRANCH    OVRCD,DCSH9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      DCSH9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN          * Invoice number must be blank
          GOTO      DCSH3000 IF NOT EQUAL
          MATCH     SP70,RCDTRELD
          GOTO      DCSH3000 IF NOT EQUAL   * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,DCSH3000
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      DCSH3000 IF EQUAL
.
          MOVE      " (*)",DIM4             * flag for non-banked deposit
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DISR0000               * Display record
.
          GOTO      DCSH3000
.
DCSH9999  RETURN
+
.*******************************************************************************
.         Display Cash record
.*******************************************************************************
DISR0000  
.         for Patient Only invoice, check if Deposits can be applied
.
          IF        IPATFLAG=1
            MATCH     "1",PTCNADEP
            GOTO      DISR9999 IF NOT EQUAL    * No deposits can be applied
          ENDIF
.
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
.
          WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>";
.
          MATCH     SP70,RCDTDPTY
          GOTO      DISR2000 IF NOT EQUAL        * must be deposit
.
          MOVE      "P",KEY1
          MOVE      RCBNTTYP,F1
          LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
.
          COMPARE   FIVE,CFEETYP
          GOTO      DISR2700 IF EQUAL          * SX
.
          MATCH     "H",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>FROM HEALTH FUND RECEIPT ##",RCDTRECN,DIM4:
                               "</td>";
          ELSE
            MATCH     "I",KEY1
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>FROM INSURANCE RECEIPT ##",RCDTRECN,DIM4:
                                 "</td>";
            ELSE
              WRITE     HTMLFILE;"<td>FROM PATIENT RECEIPT ##",RCDTRECN,DIM4:
                                 "</td>";
            ENDIF
          ENDIF
.
          COMPARE   ONE,IPATFLAG
          GOTO      DISR1200 IF NOT EQUAL
.
.         Patient Only Invoice has option to include/exclude deposit
.
          WRITE     HTMLFILE;"<td><input type=checkbox name=rmdepost":
                             " value=1 onclick=#"SetReceipt(this":
                             ",'",RCDTRECN,"','",RCDTTCNT,"'":
                             ");#"></td>";
          GOTO      DISR1400
.
DISR1200  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
DISR1400  IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>"
          GOTO      DISR9999
.
DISR2000  MOVE      SP70,KEY20
          PACK      KEY5,ANSD,ANSP,RCDTDPTY,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ENDIF
.
          COMPARE   FIVE,CFEETYP
          GOTO      DISR2800 IF EQUAL          * SX
.
          WRITE     HTMLFILE;"<td>DEPOSIT - ",KEY20,"  ##",RCDTRECN,DIM4:
                             "</td>";
.
          COMPARE   TWO,IPATFLAG
          GOTO      DISR2100 IF EQUAL          * Patient Invoice
          COMPARE   ONE,IPATFLAG
          GOTO      DISR2200 IF NOT EQUAL
.
DISR2100  WRITE     HTMLFILE;"<td align=right>Apply":
                             "<input type=checkbox name=rmdepost":
                             " value=1 onclick=#"SetReceipt(this":
                             ",'",RCDTRECN,"','",RCDTTCNT,"'":
                             ");#"></td>";
          GOTO      DISR2400
.
DISR2200  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
DISR2400  IF        INVTYPE=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>"
          GOTO      DISR9999
.
.         SX
.
DISR2700  CALL      PYEE0000            * Get the payee
          MATCH     "H",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>FROM HEALTH FUND RECEIPT ##",RCDTRECN,DIM4:
                               "<b> Payer: </b>",RCBDPAYD,"</td>";
          ELSE
            MATCH     "I",KEY1
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>FROM INSURANCE RECEIPT ##",RCDTRECN,DIM4:
                                 "<b> Payer: </b>",RCBDPAYD,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>FROM PATIENT RECEIPT ##",RCDTRECN,DIM4:
                                 "<b> Payer: </b>",RCBDPAYD,"</td>";
            ENDIF
          ENDIF
          GOTO      DISR2900
.
DISR2800  CALL      PYEE0000            * Get the payee
          WRITE     HTMLFILE;"<td>DEPOSIT - ",KEY20,"  ##",RCDTRECN,DIM4:
                             "<b> Payer: </b>",RCBDPAYD,"</td>";
.
DISR2900  WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
         WRITE     HTMLFILE;"<td align=right>",RCDTAMNT,"</td></tr>"
.
DISR9999  RETURN
+
.*******************************************************************************
.        PYEE0000 - Get the payer
.*******************************************************************************
PYEE0000  OPEN      RCPBDTA1,"rcpbdtaf"
          MOVE      SP70,RCBDPAYD
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,PYEE9000
.
          MATCH     RCDTRECN,RCBDRECN
          GOTO      PYEE9000 IF NOT EQUAL
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          PACK      KEY5,CODEPY,RCBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
          ENDIF
          COMPARE   "2",F2                  * Cheque
          GOTO      PYEE9999 IF NOT EQUAL
.
          MOVE      RCBDDRAW,RCBDPAYD     * use the drawer as payee
          GOTO      PYEE9999
.
PYEE9000  MOVE      SP70,RCBDPAYD
PYEE9999  RETURN
+
.*******************************************************************************
.         RPRT0000 - print the invoice total 
.*******************************************************************************
RPRT0000  MOVE      "Invoice Total ",IVTOTDES
          MOVE      THREE,RECFLAG
          CALL      PRLN0000                  * Print line of total invoice
.
          IF        IBCNUGST=2
            MOVE      FORM12P2,INVCTOTL        * save total for tail template
          ELSE
            MOVE      GROSSTOT,INVCTOTL        * save total for tail template
          ENDIF
          MOVE       GROSSTOT TO NETTOT
.
.        Print Rebate
.
          IF        PTCNPEFR<>2
            CALL      CKTL0000
            CALL      PREBATE                * Print the rebate portion
          ENDIF
.
.        Print the tail end of the invoice
.
         SUB       REBTOT,NETTOT
         SUB       PMOIETY,NETTOT
         SUB       CSAMT,NETTOT
         IF        IBCNUGST=2
           ADD       TOTGST,NETTOT
         ENDIF
.
         IF        PTCNPCOM=1
           CALL      PATIVMES              * handle printing of messages
         ENDIF                             * depending on claim type
.
         ADD       REBTOT,NETTOT
         ADD       CSAMT,NETTOT
.
         MOVE      GROSSTOT TO NETTOT
         IF        IBCNUGST=2
           ADD       TOTGST,NETTOT
         ENDIF
.
          MOVE      ZERO,PAYMTTOT
          MOVE      ZERO,CREDTOT
          CALL      ENDPRT00                  * Print Cash/payments
.
RPRT9999  RETURN
+
.*******************************************************************************
.
.         Although the invoice had been printed, we still need to check if
.         the accommodation was charged on the first invoice. Daycase patient
.         does not get charged until they discharged, so if the invoice was
.         printed before they discharged, the invoice would not include the
.         accommodation, therefore we have to charge it on the next invoice.
.
.         If purge had been done, do not check for accommodation in patdtraf
.         (we assume the accommodation had been charged)
.
CHKACCM0  BRANCH    APURGE,CHKACCM2,CHKACCM2
.
          MOVE      SP70,DIM8
          MOVE      CNEXTINV,DIM8
.
          MOVE      ZERO,EXIT
          PACK      KEY22 WITH AADMNO,SP20
          CALL      RDSDTRN1
CHKACCM1  CALL      RDKDTRN1
          BRANCH    OVRCD OF CHKACCM3
.
          MATCH     AADMNO,TADMNO
          GOTO      CHKACCM3 IF NOT EQUAL
.
          MATCH     "1",PTDTCRST
          GOTO      CHKACCM1 IF EQUAL  * fully credited
.
.         Inv.with No pay day where per diem accom.records generated prior
.         casepayment, skip records for current printing Inv.no
.
          IF        PROGFLAG=3
            MATCH     DIM8,TREF
            GOTO      CHKACCM1 IF EQUAL   * skip current printing inv.no
          ENDIF
.
          BRANCH    TRECTYPE,CHKACCM2  * Found an accommodation record
.
          MATCH     "1",PTCNUABF       * check if using ABF
          IF        @EQUAL
            PACK      KEY5,ANSC,ANSL,ACLAIM
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "A",TCINDC2
              IF        @EQUAL
                COMPARE   NINE,TRECTYPE
                GOTO      CHKACCM2 IF EQUAL    * Found ABF charge
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      CHKACCM1
.
CHKACCM2  MOVE      ONE,EXIT
CHKACCM3  RETURN
+
.*******************************************************************************
.         Generate the lumpsum description
.*******************************************************************************
GLUM0000  CALL      GTAB0000         *get table type
          MOVE      SP30,TEDESC
          PACK      TDDESC,SP20,SP20
          PACK      PTDTDES2,SP20,SP20
          MOVE      PTTRLSPT,SPTTRLSP
          MOVE      PTTRLSRB,SPTTRLSR
.
.
.         If patient discharged and it's a daycase, get desc. from daycase rate
.
          COMPARE   ZERO,DCFLAG
          GOTO      GLUM0070 IF EQUAL    * overnight
.
. ------  sameday ------
.
          CALL      DLUM0000         * Get desc. for daycase lumpsum amount
          MOVE      LSDESC1,SAVDES1
          MOVE      LSDESC2,SAVDES2
          MOVE      KEY27,SKEY27     * save the key
          IF        NOFEE=0
            MOVE      PTLSLREB,PTTRLSRB
            MOVE      PTLSLPAT,PTTRLSPT
            MOVE      PTTRLSPT,SPTTRLSP
            MOVE      PTTRLSRB,SPTTRLSR
            MOVE      SPTTRLSP,PATLNTOT   * patient lumpsum
          ENDIF
.
          MOVE      PTLSNINV,NUMINVS
          MOVE      PTLSNINV,TNINVS
          IF        IPATFLAG=2
            MOVE      NUMBINVR,NUMINVS   * No of Invoice from contract
            MOVE      NUMBINVR,TNINVS
          ENDIF
.
          BRANCH    PROGFLAG,GLUM0900    * workout to be invoiced only
.
. ------  detailed invoice ------
.
          BRANCH    REVBFLAG,GLUM0030       * revenue breakdown
.
          COMPARE   TWO,TNINVS
          GOTO      GLUM0900 IF EQUAL
.
          COMPARE   ONE,PTCMDIFG            * invoice breakdown
          GOTO      GLUM0900 IF NOT EQUAL
.
. ------  Invoice breakdown for daycase ------
.
          OPEN      PMSSINA1,"pmssinaf"
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPMSIN1
          CALL      SINV0000
          IF        EXIT=1
            MOVE      ZERO,PTCMDIFG
            GOTO      GLUM0900
          ENDIF
.
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY20,SKEY27,SP70
          CALL      RSPMSIN1
GLUM0020  BRANCH    REVBFLAG,GLUM0040
          CALL      SINV0000         * read next record
          BRANCH    EXIT,GLUM8100
          GOTO      GLUM0900
.
. ------  Revenue breakdown for daycase  ------
.
GLUM0030  OPEN      PATSRBA1,"patsrbaf"
.
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTSRB1
GLUM0040  CALL      SREV0000            * read next record 
          BRANCH    EXIT,GLUM8100
          GOTO      GLUM0900
.
. ------ overnight lumpsum ------
.
GLUM0070  CALL      OLUM0000         * Get desc. & cut off for lumpsum amount
          MOVE      LSDESC1,SAVDES1
          MOVE      LSDESC2,SAVDES2
          MOVE      KEY27,SKEY27      * save the key
          IF        NOFEE=0
            MOVE      PTHLLREB,PTTRLSRB
            MOVE      PTHLLPAT,PTTRLSPT
.
            MOVE      PTTRLSPT,SPTTRLSP
            MOVE      PTTRLSRB,SPTTRLSR
            MOVE      SPTTRLSP,LINETOT    * patient lumpsum
            ADD       SPTTRLSR,LINETOT    * rebate lumpsum
.
            MOVE      SPTTRLSP,PATLNTOT
          ENDIF
.
          BRANCH    PROGFLAG,GLUM0900    * workout to be invoiced only
.
          MOVE      PTHLNINV,NUMINVS
          MOVE      PTHLNINV,TNINVS
          IF        IPATFLAG=2
            MOVE      NUMBINVR,NUMINVS   * No of Invoice from contract
            MOVE      NUMBINVR,TNINVS
          ENDIF
.
. ------  detailed invoice ------
.
          BRANCH    REVBFLAG,GLUM0150          * revenue breakdown
.
          COMPARE   TWO,TNINVS
          GOTO      GLUM0900 IF EQUAL
.
          COMPARE   ONE,PTCMDIFG               * invoice breakdown
          GOTO      GLUM0900 IF NOT EQUAL
.
. ------  Invoice breakdown for overnight ------
.
          OPEN      PATIOVA1,"patiovaf"
.         PACK      KEY30,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTIOV1
          CALL      OINV0000
          IF        EXIT=1
            MOVE      ZERO,PTCMDIFG
            GOTO      GLUM0900
          ENDIF     
.
.         PACK      KEY30,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTIOV1
GLUM0100  BRANCH    REVBFLAG,GLUM0200
          CALL      OINV0000            * read next record 
          BRANCH    EXIT,GLUM8100
          GOTO      GLUM0900
.
. ------ Revenue breakdown for overnight ------
.
GLUM0150  OPEN      PATOVBA1,"patovbaf"
.         PACK      KEY30,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTOVB1
GLUM0200  CALL      OREV0000            * read next record 
          BRANCH    EXIT,GLUM8100
.
GLUM0900  BRANCH    IPASS OF GLUM1000,GLUM2000
.
          MOVE      PTTRLSPT,LINETOT    * lumpsum
          ADD       PTTRLSRB,LINETOT
.
          MOVE      PTTRLSPT,PATLNTOT
.
. ------  calculate the portion of the lump sum based on the expected ------
. ------  los if the patient is not discharged (revenue breakdown only) ----
.
          IF        ASTAT<>3 & REVBFLAG=1
            MOVE      ZERO,CMLOS
            MOVE      ADATE,FROMDATE
            PACK      TODATE,CCC,CYY,CMM,CDD
            REP       " 0",TODATE
            PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
            CALL      NHOSPDAY
            MOVE      DIM30,KEY30
            CALL      RDTRAN2
.
            IF        NPDAYFLG=2
              MATCH     SP70,CSMATYPE
              IF        !@EQUAL
                MOVE      CSMATYPE,TATYPE
              ENDIF
            ENDIF
.
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
.
            MOVE      NBRDAYS,CMLOS
            COMPARE   NBRDAYS,PTCMXLOS
            IF        !@LESS
              ASSIGN    (LINETOT/PTCMXLOS),LINETOT
              ASSIGN    (LINETOT*NBRDAYS),LINETOT
            ENDIF
          ENDIF
          GOTO      GLUM3000
.
GLUM1000  MOVE      PTTRLSPT,LINETOT    * patient lumpsum
          GOTO      GLUM3000
.
GLUM2000  MOVE      PTTRLSRB,LINETOT    * rebate lumpsum
.
GLUM3000  IF        IBCNUGST=2
            MOVE      LINETOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,LINEGST
            ADD       LINEGST,TOTGST
.
            MOVE      PATLNTOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PATLNGST
            ADD       GSTWORK,PATLNTOT
          ENDIF
.
          IF        PACMCHRG=0
            ADD       PATLNTOT,PPAYABLE   * Patient balance payable
            ADD       PATLNGST,TOTPGST
          ENDIF
.
          MOVE      LINEGST,XLINEGST
          BRANCH    PROGFLAG,GLUM9000   * workout to be invoiced only
.
.         COMPARE   ZERO,LINETOT
.         GOTO      GLUM9000 IF EQUAL
.
          COMPARE   ZERO,LINETOT
          GOTO      GLUM3600 IF NOT EQUAL
.
          BRANCH    REVBFLAG,GLUM9000
.
          COMPARE   TWO,TNINVS
          GOTO      GLUM9000 IF EQUAL
.
.         COMPARE   ONE,PTCMDIFG              * check for detailed invoice
.         GOTO      GLUM9000 IF NOT EQUAL
.
GLUM3600  COMPARE   TWO,PROGFLAG
          GOTO      GLUM5000 IF NOT EQUAL    * print invoice
.
          CALL      DSLM0000                 *  Display next invoice
.
          IF        REVBFLAG<>1
            COMPARE   ONE,PTCMDIFG              * check for detailed invoice
            GOTO      GLUM8100 IF NOT EQUAL
          ENDIF
          BRANCH    DCFLAG,GLUM0020           * next invoice breakdown sameday
          GOTO      GLUM0100                  * next invoice breakdown overnight
.
GLUM4500  COMPARE   TWO,TNINVS
          GOTO      GLUM9000 IF EQUAL
.
          IF        REVBFLAG<>1
            COMPARE   ONE,PTCMDIFG              * check for detailed invoice
            GOTO      GLUM8100 IF NOT EQUAL
          ENDIF
          BRANCH    DCFLAG,GLUM0020           * next invoice breakdown sameday
          GOTO      GLUM0100                  * next invoice breakdown overnight
.
.         Check if we are printing invoice or update patfins only
.
GLUM5000  MOVE      LINETOT,XLINETOT
          COMPARE   THREE,PROGFLAG
          GOTO      GLUM8100 IF NOT EQUAL     * must be update patfins only
.
.         PACK      SAVDES1,PTDTLSD1,SP70
.         PACK      SAVDES2,PTDTLSD2,SP70
.
          PACK      DFDATE,FCENT1,FYEAR1,FMON1,FDAY1,SP70
          PACK      DTDATE,SP70
          MOVE      ZERO,RECFLAG              * flag for printing lumpsum
          CALL      PRLN0000                  * Print line of invoice
.
          COMPARE   TWO,TNINVS
          GOTO      GLUM8100 IF EQUAL
.
.         Printing invoice write to invoice breakdown file 
.
          IF        REVBFLAG<>1
            COMPARE   ONE,PTCMDIFG            * check for detailed invoice
            GOTO      GLUM8100 IF NOT EQUAL
            CALL      WRIN0000                * write to the invoice breakdown
          ENDIF
          BRANCH    DCFLAG,GLUM0020           * next invoice breakdown sameday
          GOTO      GLUM0100                  * next invoice breakdown overnight
.
.         Check if patfins/patrfn needs to be updated
.
GLUM8100  BRANCH    IPASS,GLUM8120,GLUM8140
.
          MOVE      SPTTRLSP,LINETOT          * patient lumpsum
          ADD       SPTTRLSR,LINETOT          * rebate lumpsum
.
          MOVE      SPTTRLSP,PATLNTOT
          GOTO      GLUM8160
.
GLUM8120  MOVE      SPTTRLSP,LINETOT          * patient lumpsum
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            COMPARE   TWO,IPATFLAG           * printing patient invoice
            GOTO      GLUM8160 IF EQUAL      * do not clear lumpsum rebate
          ENDIF
.
          MOVE      ZERO,SPTTRLSR
          GOTO      GLUM8160
.
GLUM8140  MOVE      SPTTRLSR,LINETOT          * rebate lumpsum
          MOVE      ZERO,SPTTRLSP
.
GLUM8160  BRANCH    PROGFLAG,GLUM9000:        * workout to be invoiced only
                             GLUM9000:        * display next invoice
                             GLUM8200:        * print invoice
                             GLUM8500         * update temporary patfins
          GOTO      GLUM9000
.
.         Print invoice, write to patfins and patrfnaf for breakdown
.
GLUM8200  CALL      LFIN0000                * BIL19 -write lumpsum to patfins
          OPEN      PATRFNA1,"patrfnaf"
          MOVE      TWO,FGSTFLAG
.
.         write to patrblaf and patrfnaf file
.
          IF        DCFLAG=0
            CALL      WRRB0000          * write to revenue breakdown overnight
          ELSE
            CALL      WSRB0000          * write to revenue breakdown sameday
          ENDIF
          MOVE      ZERO,FGSTFLAG
          GOTO      GLUM9000
.
.         Update patfins temporary file (for tobeinvoiced sec. of Fees Invoice)
.
GLUM8500  BRANCH    REVBFLAG,GLUM8800       * ADT09 only have breakdown lumpsum
.
.* ****************************************** Code deleted for CAR41072 - 90313
.
          CALL      LFIN0000                * BIL19 -write lumpsum to patfins
          GOTO      GLUM9000
.
.         Breakdown revenue, update temporary  patrfnaf file
.
GLUM8800  IF        DCFLAG=0
            CALL      WRRB0000          * write to revenue breakdown overnight
          ELSE
            CALL      WSRB0000          * write to revenue breakdown sameday
          ENDIF
          GOTO      GLUM9000
.
GLUM9000  MOVE      ZERO,EXIT
          BRANCH    IPASS,GLUM9120,GLUM9140
          MOVE      SPTTRLSP,LINETOT          * patient lumpsum
          ADD       SPTTRLSR,LINETOT          * rebate lumpsum
.
          GOTO      GLUM9800
.
GLUM9120  MOVE      SPTTRLSP,LINETOT          * patient lumpsum
          GOTO      GLUM9800
.
GLUM9140  MOVE      SPTTRLSR,LINETOT          * rebate lumpsum
.
GLUM9800  ADD       LINETOT,GROSSTOT    * add Lumpsum into GROSSTOT    *I-90310
          ADD       LINETOT,ACCMTOT                                    *I-90310
          ADD       SPTTRLSR,HFACCM     * add HF rebate to HFACCM      *I-90310
.
.         If 'No Payday' with Operation date on Discharged date, then Charge
.         Lumpsum amount only
.
          COMPARE   TWO,NPDAYFLG
          GOTO      GLUM9999 IF NOT EQUAL
          MATCH     CMSTRTDT,DDATE
          GOTO      GLUM9999 IF NOT EQUAL
          CALL      WLSD0000
.
          IF        INVDFLAG=1 & (SPTTRLSP<>0 | SPTTRLSR<>0)
            MOVE      LINETOT,FORM12P2
            MOVE      ZERO,LINETOT
            CALL      WACRD000              * write to invoice details file
            MOVE      FORM12P2,LINETOT
          ENDIF
.
GLUM9999  RETURN
+
.******************************************************************************
.        Write Lumpsum amount only to DTR file
.******************************************************************************
WLSD0000 COMPARE   THREE,PROGFLAG
         GOTO      WLSD9999 IF NOT EQUAL
.
         CALL      CLPATDTR
         MOVE      AADMNO,TADMNO
.
WLSD1000 CALL      NXTTRAN1
         MOVE      CNEXTINV,TREF
         PACK      KEY22 WITH AADMNO,TREF,TTRANSN1
         CALL      RDADTRN1
         COMPARE   ZERO,OVRCD
         GOTO      WLSD1000 IF EQUAL     * Try the next transaction number
.
         MOVE      "P" TO TTYPEDEB
         MOVE      "DB",TTYPE
         UNPACK    CMSTRTDT,XCENT,XYEAR,XMON,XDAY
         MOVE      XDAY,TFDAY
         MOVE      XMON,TFMONTH
         MOVE      XCENT,TFCENT
         MOVE      XYEAR,TFYEAR
         MOVE      XDAY,TTDAY
         MOVE      XMON,TTMONTH
         MOVE      XCENT,TTCENT
         MOVE      XYEAR,TTYEAR
         MOVE      ONE,TINVPRT
         MOVE      ONE,TRECTYPE      (1 = ACCOMMODATION)
         MOVE      SAVDES1,TDDESC
         MOVE      SAVDES2,PTDTDES2
         MOVE      SPTTRLSP,PTDTLSPT         * patient lumpsum
         MOVE      SPTTRLSR,PTDTLSRB         * rebate lumpsum
         IF        IPATFLAG=2
           MOVE      ZERO,PTDTLSRB
         ENDIF
         IF        IBCNUGST=2
           MOVE      PTDTLSRB,PTDTGSTL
           ADD       PTDTLSPT,PTDTGSTL    * lumpsum
           MULT      GSTPCEN,PTDTGSTL     * GST amount
           DIV       "100.00",PTDTGSTL    * Divide by 100 to get wanted fig.
         ENDIF
         PACK      PTDTEFFD,CCC,CYY,CMM,CDD
         REP       " 0",PTDTEFFD
         PACK      PTDTLSD1,LSDESC1,SP20
         PACK      PTDTLSD2,LSDESC2,SP20
.
         MOVE      ACLAIM,PTTRCLTY
         MOVE      TATYPE,TADMTYP         * when printing invoice
         MATCH     SP70,TADMTYP
         IF        @EQUAL
           MOVE      ATYPE,TADMTYP
         ENDIF
.
         MOVE      SP70,PTTRSPAR
         PACK      KEY22 WITH TADMNO,TREF,TTRANSN1
         CALL      WRDTRN1
.
WLSD9999 RETURN
+
.******************************************************************************
.         Display lumpsum amount
.******************************************************************************
DSLM0000  MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                NSEP,NOCT,NNOV,NDEC
          MOVE      LINETOT,FORM12P2
          ADD       LINEGST,FORM12P2
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4:
                             "</td>":
                             "<td><table width=100%><tr><td>":
                             SAVDES1;
.
          PACK      KEY8,FCENT1,FYEAR1,FMON1,FDAY1,SP70
          REP       " 0",KEY8
          MOVE      SP70,ANS
          WRITE     HTMLFILE;"</td><td align=right>":
                             "<img src=../images/CommentIcon.gif ":
                             " class=ListIcon onclick='ShowStepdown(#"":
                             AURNO,"#",#"":
                             AADMNO,"#",#"":
                             KEY8,"#",#"":
                             ANS,"#",#"",CONTRCID,"#")'></td></tr></table>";
.
          WRITE     HTMLFILE;"<td>&nbsp;",CONTRCID,"</td>":  * contract id
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          MATCH     "1",PTCNPPIN
          IF        @EQUAL
            IF        INVTYPE=0 & IPATFLAG=0 & ISBLFLAG=0
              WRITE     HTMLFILE;"<td align=right>",PTTRLSRB,"</td>":
                                 "<td align=right>",PTTRLSPT,"</td>";
              GOTO      DSLM2000
            ELSE
              IF        IPATFLAG=2
                MOVE      PATLNTOT,FORM12P2
                SUB       PATLNGST,FORM12P2
.
                WRITE     HTMLFILE;"<td>&nbsp;</td>":
                                   "<td align=right>",FORM12P2,"</td>":
                             "<td align=right>",PATLNGST,"</td>":
                             "<td align=right>",PATLNTOT,"</td>";
                WRITE     HTMLFILE;"</tr>";
                GOTO      DSLM9999
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
DSLM2000  WRITE     HTMLFILE;"<td align=right>",LINETOT,"</td>":
                             "<td align=right>",LINEGST,"</td>":
                             "<td align=right>",FORM12P2,"</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
DSLM9999  RETURN
+
.******************************************************************************
.* LFIN0000 : Write lumpsum record to patfins                                 *
.******************************************************************************
LFIN0000  IF        IBCNUGST=2
            MOVE      LINETOT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,LINEGST
.           ADD       LINEGST,TOTGST
          ENDIF
.
          IF        CACCFEE=5
            PACK      FINCODE WITH ANSC,DCFLAG,ACLAIM,SP20
          ELSE
            IF        CACCFEE=4
              PACK      FINCODE WITH ANSC,DCFLAG,TATYPE,ACLAIM,SP20
            ELSE
              PACK      FINCODE WITH ANSC,DCFLAG,TATYPE,SP20
            ENDIF
          ENDIF
          CALL      WFINS000                * Write a record to patfinsf
          CALL      MTDNFD00                * Move to date to next from date
.
          COMPARE   TWO,NPDAYFLG
          GOTO      LFIN8000 IF EQUAL
.
          UNPACK    ALACDTE INTO XCENT,XYEAR,XMON,XDAY
          PACK      IDATEF WITH XCENT,XYEAR,XMON,XDAY  * reset the dates
          REP       " 0",IDATEF
.
LFIN8000  MOVE      SP10,SIDATET
          UNPACK    IDATEF INTO FCENT1,FYEAR1,FMON1,FDAY1
.....          PACK       SAVDES1,SP20,SP20
.....          PACK       SAVDES2,SP20,SP20
.
LFIN9000  MOVE      ZERO,EXIT
LFIN9999  RETURN
+
.******************************************************************************
.* SINV0000 : Display sameday invoice breakdown                               *
.******************************************************************************
SINV0000  CALL      RKPMSIN1
          BRANCH    OVRCD,SINV9500
.
          PACK      DIM27,PMSICNID,PMSICODE,PMSIFUND,PMSITBLT,PMSICSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      SINV9500 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PMSIBKCD
          CALL      RDCODE1
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PMSIAMNT,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.
SINV9000  MOVE      ZERO,EXIT
          GOTO      SINV9999
.
SINV9500  MOVE      ONE,EXIT
SINV9999  RETURN
+
.******************************************************************************
.* SREV0000 : Display sameday revenue breakdown                               *
.******************************************************************************
SREV0000  CALL      RKPTSRB1
          BRANCH    OVRCD,SREV9500
.
          PACK      DIM27,PTSBCNID,PTSBCODE,PTSBFUND,PTSBTBLT,PTSBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      SREV9500 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTSBBRCD
          CALL      RDCODE1
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PTSBAMNT,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.
SREV9000  MOVE      ZERO,EXIT
          GOTO      SREV9999
.
SREV9500  MOVE      ONE,EXIT
SREV9999  RETURN
+
.******************************************************************************
.* OINV0000 : Display overnight invoice breakdown                             *
.******************************************************************************
OINV0000  CALL      RKPTIOV1
          BRANCH    OVRCD,OINV9500
.
          PACK      DIM27,PTIOCNID,PTIOCODE,PTIOFUND,PTIOTBLT,PTIOCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      OINV9500 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTIOBRCD
          CALL      RDCODE1
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PTIOAMNT,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.
OINV9000  MOVE      ZERO,EXIT
          GOTO      OINV9999
.
OINV9500  MOVE      ONE,EXIT
OINV9999  RETURN
+
.******************************************************************************
.* OREV0000 : Display overnight revenue breakdown                             *
.******************************************************************************
OREV0000  CALL      RKPTOVB1
          BRANCH    OVRCD,OREV9500
.
          PACK      DIM27,PTOBCNID,PTOBCODE,PTOBFUND,PTOBTBLT,PTOBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      OREV9500 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTOBBRCD
          CALL      RDCODE1
          MOVE      TDESC,SAVDES1
          MOVE      SP70,SAVDES2
          MOVE      PTOBAMNT,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.
OREV9000  MOVE      ZERO,EXIT
          GOTO      OREV9999
.
OREV9500  MOVE      ONE,EXIT
OREV9999  RETURN
+
.******************************************************************************
.* WRIN0000 : Write to the invoice breakdown file                             *
.******************************************************************************
WRIN0000  OPEN      PATIBLA1,"patiblaf"
.
          MOVE      CNEXTINV,PTIBINVN
          MOVE      AADMNO,PTIBADMN
          IF        DCFLAG=1
            MOVE      PMSIBKCD,PTIBBRCD     * Sameday invoice breakdown
          ELSE
            MOVE      PTIOBRCD,PTIBBRCD     * Overnight invoice breakdown
          ENDIF
          MOVE      LINETOT,PTIBAMNT
          MOVE      LINEGST,PTIBGAMN
.
          PACK      KEY19,PTIBADMN,PTIBINVN,PTIBBRCD,SP70
          CALL      RAPTIBL1
          IF        OVRCD=1
            CALL      WRPTIBL1
          ELSE
            CALL      UPPTIBL1
          ENDIF
.
WRIN9000  MOVE      ZERO,EXIT
WRIN9999  RETURN
+
.******************************************************************************
.* IGST0000 : Get percentage of Item GST                                      *
.******************************************************************************
IGST0000  MOVE     ZERO,IBGEAMNT            * Initialise GST percentage amount
          COMPARE  TWO,IBCNUGST
          GOTO     IGST9999 IF NOT EQUAL    * not using Aust.GST
.
          BRANCH   PTDTGSTA,IGST6000        * GST payable
          GOTO     IGST9000                 * GST free
.
IGST6000  OPEN     IBAGEDA1,"ibagedaf"
          MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY14,PTDTGSTC,KEY8
          CALL     RDIBGE1
          COMPARE  ZERO,OVRCD
          GOTO     IGST9000 IF EQUAL         * found GST amount for current date
.
          CALL     RPIBGE1                   * read previous record
          BRANCH   OVRCD,IGST8000
.
          MATCH    PTDTGSTC,IBGECODE         * Same code ?
          GOTO     IGST9000 IF EQUAL
.
IGST8000  MOVE     ZERO,IBGEAMNT
.
IGST9000  CLOSE    IBAGEDA1
IGST9999  RETURN
+
.******************************************************************************
.* AGST0000 : Get percentage of accommodation GST                             *
.******************************************************************************
AGST0000  MOVE     ZERO,IBGEAMNT            * Initialise GST percentage amount
          OPEN     IBAGEDA1,"ibagedaf"
          COMPARE  THREE,IBCNUGST
          GOTO     AGST2000 IF NOT EQUAL
.
          COMPARE  ONE,BDTEFLAG
          GOTO     AGST6000 IF NOT EQUAL     * Not backdated
.         
.         GST is calculated on the Invoice total 
.
          MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     PINVDTE,PINVDTE,SP70
.
          MATCH    SP70,PINVDTE
          GOTO     AGST6000 IF EQUAL
.
          MOVE     PINVDTE,KEY8              * use the invoice date
          REP      " 0",KEY8
          GOTO     AGST7000
.         
AGST2000  COMPARE  TWO,IBCNUGST
          GOTO     AGST9999 IF NOT EQUAL    * not using Aust.GST
.
.         For dipslaying the "To be Invoiced" and printing invoice,we use 
.         admission GST to determine the Accommodation GST.
.         If the admission GST is not set and it's not the first invoice 
.         then we use the primary MBS to determine the Accommodation GST.
.
          COMPARE  ZERO,AINVPRT             * Invoice printed yet ?
          GOTO     AGST5000 IF NOT EQUAL    * no.
.
          BRANCH   PROGFLAG,AGST5000,AGST5000   * to be invoiced section
.
          MATCH    ANSU,PTMIGSTA            * Admission GST set ?
          GOTO     AGST5000 IF NOT EQUAL    * yes.
.
          CALL     XMBS0000                 * Get the most expensive MBS entered
          MATCH    SP9,PRIMMBS
          GOTO     AGST9000 IF EQUAL        * No MBS, no GST for accommodation
.
.         If the primary item is GST payable, then accommodation will be GST too
.
          BRANCH   FORM1,AGST6000           * GST payable
          GOTO     AGST9000                 * GST free
.
AGST5000  MATCH    ANSY,PTMIGSTA            * check the admission GST
          GOTO     AGST9000 IF NOT EQUAL    * no accommodation charge
.
AGST6000  MOVE     ZERO,IBGEAMNT             * zero GST percentage
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
.
AGST7000  PACK     KEY14,PTCNAGST,KEY8
          CALL     RDIBGE1
          COMPARE  ZERO,OVRCD
          GOTO     AGST9000 IF EQUAL         * found GST amount for current date
.
          CALL     RPIBGE1                   * read previous record
          BRANCH   OVRCD,AGST8000
.
          MATCH    PTCNAGST,IBGECODE         * Same code ?
          GOTO     AGST9000 IF EQUAL
.
AGST8000  MOVE     ZERO,IBGEAMNT
.
AGST9000  CLOSE    IBAGEDA1
AGST9999  RETURN
+
.******************************************************************************
.* XMBS000 : Get the primary MBS (most expensive MBS)                         *
.******************************************************************************
XMBS0000  MOVE      SP10,PRIMMBS            * initialise primary MBS code
          MOVE      ZERO,FORM1
          MOVE      ZERO,FORM12
          OPEN      PMSMTIA2,"pmsmtiaf"
          MOVE      "2",PMMIRTYP
          PACK      KEY15,AADMNO,PMMIRTYP,SP20
          CALL      RSPMMTI2
XMBS1000  CALL      RKPMMTI2
          BRANCH    OVRCD,XMBS9999
.
          MATCH     AADMNO,PMMIVISN            * compare admission number
          GOTO      XMBS9999 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      XMBS9999 IF NOT EQUAL   * not a theatre item
.
          OPEN      PATITEM1,"patitemn"
          PACK      KEY17,PMMIITEM,PMMITDAT,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,XMBS1000          * not a valid item code
.
          MOVE      PMMIAMTP,FORM12A        * secondary item
          ADD       PMMIRBAT,FORM12A
          COMPARE   FORM12A,FORM12
          GOTO      XMBS1000 IF NOT LESS
.
          MOVE      PMMIITEM,PRIMMBS         * set primary MBS code
          MOVE      PMMIGSTA,FORM1          * save the flag for GST applicable
          MOVE      FORM12A,FORM12
          GOTO      XMBS1000
.
XMBS9999  RETURN
+
.******************************************************************************
.* CTDY0000: Check cut off days for casemix patients                          *
.* RETURNS : PCFLAG     0 = casemix funding only                              *
.*                      1 = reverts to patient classification                 *
.*                      2 = patient classification & casemix                  *
.******************************************************************************
CTDY0000  COMPARE   ONE,CMXFLAG
          GOTO      CTDY9999 IF NOT EQUAL
.
          MOVE      ADATE,OPRDATE
          BRANCH    PTCNNWCM,CTDY0200       * Using matrix
.
          OPEN      PATFN1A1,"patfn1af"
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          BRANCH    OVRCD,CTDY9999
.
          BRANCH    PTHFUCMX,CTDY0200       * HF Using matrix
.
          OPEN      PATCFAA1,"patcfaaf"
          MOVE      ACLAIM,KEY3 
          CALL      RDPTCFA1
          IF        OVRCD=0 
            MATCH     "3",PTCFCEFR            * Not in use?
            IF        !@EQUAL
              MATCH     "1",PTCFMCPS
              GOTO      CTDY0200 IF EQUAL     * Claim code Using matrix
            ENDIF   
          ENDIF     
.
          GOTO      CTDY9999
.
CTDY0200  MOVE      ADATE,CMSTRTDT
          MOVE      ZERO,PCFLAG
          MOVE      ZERO,NPDAYFLG
.
          COMPARE   ZERO,PMCCMIND           * Min days stay
          GOTO      CTDY1000 IF NOT EQUAL
.
          COMPARE   ZERO,PMCCHBPT           * Max days stay
          GOTO      CTDY1000 IF NOT EQUAL
.
          COMPARE   ZERO,PMCCPODY           * pre op cut off days
          GOTO      CTDY1000 IF NOT EQUAL
.
          COMPARE   ZERO,PMCCCCDY           * critical care cut off days
          GOTO      CTDY1000 IF NOT EQUAL
.
          COMPARE   ZERO,PMCCNPDY           * no pay days
          GOTO      CTDY9999 IF EQUAL       * casemix invoice only        
.
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            GOTO      CTDY9999 IF EQUAL     * casemix invoice only        
          ENDIF
.
.         if PMCCNPDY=999999, casepayment starts from operation date
.         if PMCCNPDY=0, casepayment from admission date
.            else patcat from admission date followed by casepayment,
.                 casepayment from (operation date - NPD cut off)
.
CTDY1000  MOVE      ADATE,FROMDATE
          MOVE      DDATE,TODATE
          PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
          CALL      NHOSPDAY                * calculate length of stay
          MOVE      DIM30,KEY30
          CALL      RDTRAN2
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
.         Exclude any Unqualified days
.
          MOVE      NBRDAYS,F4          * save current no of bed days
          MOVE      ZERO,FORM4
          MOVE      "U",SAVIND12
          PROC      PATDATYP            * Get LOS for Unqualified days
          IF        NBRDAYS>0
            MOVE      NBRDAYS,FORM4
          ENDIF
          MOVE      F4,NBRDAYS
          SUB       FORM4,NBRDAYS         * subtract unqualified days
.
.
          MOVE      NBRDAYS,CMLOS
.
          MOVE      CMLOS,FORM5A
          ADD       ADYHOSP,FORM5A            * include Days of Hospitalisation
.
          COMPARE   ZERO,PMCCMIND
          GOTO      CTDY1020 IF EQUAL
.
          COMPARE   PMCCMIND,FORM5A       * Check Minimum days stay
          GOTO      CTDY3200 IF LESS
.
CTDY1020  COMPARE   ZERO,PMCCHBPT
          GOTO      CTDY1040 IF EQUAL
.
          COMPARE   FORM5A,PMCCHBPT       * Check Maximum days stay
          GOTO      CTDY3200 IF LESS
.
CTDY1040  COMPARE   ZERO,PMCCNPDY
          GOTO      CTDY1100 IF NOT EQUAL       * no no-pay days
.
          COMPARE   ZERO,PMCCPODY
          GOTO      CTDY4000 IF EQUAL           * pre-op cut off
.
. ------ find the operation date from pmsmtiaf ------
.
CTDY1100  OPEN      PMSMTIA2,"pmsmtiaf"
          MOVE      "2",PMMIRTYP
          PACK      KEY15,AADMNO,PMMIRTYP,SP20
          CALL      RSPMMTI2
CTDY1200  CALL      RKPMMTI2
          BRANCH    OVRCD,CTDY1500
.
          MATCH     AADMNO,PMMIVISN         * compare admission number
          GOTO      CTDY1500 IF NOT EQUAL
.
          MATCH     "2",PMMIRTYP
          GOTO      CTDY1500 IF NOT EQUAL   * not a theatre item
.
          MOVE      PMMITDAT,OPRDATE        * set operation date
          GOTO      CTDY2100
          
. ------ find the operation date from patdtraf ------
.
CTDY1500  PACK      KEY22,AADMNO,SP70
          CALL      RDSDTRN1
CTDY2000  CALL      RDKDTRN1
          BRANCH    OVRCD,CTDY9999
.
          MATCH     AADMNO,TADMNO
          GOTO      CTDY9999 IF NOT EQUAL
.
          COMPARE   TWO,TRECTYPE
          GOTO      CTDY2000 IF NOT EQUAL
.
          MATCH     "1",PTDTCRST
          GOTO      CTDY2000 IF EQUAL            * Fully Credit note
.
          PACK      OPRDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          REP       " 0",OPRDATE
.
CTDY2100  MOVE      ADATE,FROMDATE
          MOVE      OPRDATE,TODATE
.
          PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
          CALL      NHOSPDAY
          MOVE      DIM30,KEY30
          CALL      RDTRAN2 
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
          MOVE      NBRDAYS,CMLOS
          MOVE      OPRDATE,CMSTRTDT     * casemix start date
          MOVE      OPRDATE,PCENDDTE     * set patcat ends at operation date
          REP       " 0",PCENDDTE
.
          COMPARE   "999999",PMCCNPDY
          GOTO      CTDY2200 IF EQUAL    * start casemix from operation date
.
          MOVE      CMLOS,FORM5A         * LOS from adate to oper.date
          IF        FORM5A=0 & PMCCNPDY=0
            MOVE      ZERO,PCFLAG        * casemix only
            GOTO      CTDY9999
          ENDIF
.
.         If  Operation date is same as Adate, then Casemix only
.
          MATCH     ADATE,OPRDATE      * Admission date = operation date
          IF        @EQUAL
            MOVE      ZERO,PCFLAG      * casemix only
            GOTO      CTDY9999
          ENDIF
.
.         check if No Payday cutoff is greater than LOS of Adm.date - Oper.date
.
          MOVE      PMCCNPDY,F6
          ADD       ONE,FORM5A
          COMPARE   FORM5A,PMCCNPDY
          IF        !@LESS
.           MOVE      ZERO,PCFLAG        * casemix only
            MOVE      FORM5A,F6
            SUB       ONE,F6
.           PACK      NPSTRTDT,ADATE,SP70   * set Start of No Payday to ADATE
.           GOTO      CTDY9999
          ENDIF
.
          UNPACK    OPRDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          SUB       F6,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
.
          PACK      PCENDDTE,CC,YY,MM,DD  * patcat end date
          REP       " 0",PCENDDTE
.
CTDY2200  MOVE      TWO,PCFLAG           * patcat & casemix funding
          MOVE      ONE,NPDAYFLG
          MOVE      ZERO,LUMPFLAG
.
.         Recalculate bed days to discharged date
.
          MOVE      ADATE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD
          REP       " 0",TODATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE
          ENDIF
          PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
          CALL      NHOSPDAY
          MOVE      DIM30,KEY30
          CALL      RDTRAN2
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
          MOVE      NBRDAYS,CMLOS
          GOTO      CTDY4000
.
CTDY3200  CALL      CMPR0000                * Check for Multiple procedures
.
          MOVE      THREE,PCFLAG            * los >= high boundary cut off
          MOVE      ZERO,CMXFLAG
          MOVE      ZERO,NPDAYFLG
          IF        PROGFLAG=2
            WRITE     HTMLFILE;"<tr><center><b>Warning: Patient":
                               " will revert to Patient Classification, ":
                               " NOT within Days Stay range. </b>":
.                              " high boundary cut off. </b>":
                               "</center></tr>";
            MOVE      ANSN,PTMICMXP
            MOVE      ONE,PCFLAG           * patcat
            CALL      HITENTER
            DISPLAY   *P1:23,*EL;
          ENDIF
          GOTO      CTDY9999
.
CTDY4000  COMPARE   ZERO,PMCCCCDY         * check critical care cut off
          GOTO      CTDY5000 IF EQUAL
.
          CALL      CRIT0000              * calculate critical care days
.
.....     COMPARE   PMCCCCDY,CRITDAYS                                   D-90306
.....     GOTO      CTDY5000 IF LESS                                    D-90306
          COMPARE   CRITDAYS,PMCCCCDY                                  *I-90306
          GOTO      CTDY5000 IF NOT LESS                               *I-90306
.
          MOVE      THREE,PCFLAG           * critical care los > cc cut off
          MOVE      ZERO,CMXFLAG
          MOVE      ZERO,NPDAYFLG
          IF        PROGFLAG=2
            WRITE     HTMLFILE;"<tr><center><b>Warning: Patient":
                               " will revert to Patient Classification, ":
                               " critical care cut off. </b>":
                               "</center></tr>";
            MOVE      ANSN,PTMICMXP
            MOVE      ONE,PCFLAG           * patcat 
            CALL      HITENTER
            DISPLAY   *P1:23,*EL;
          ENDIF
          GOTO      CTDY9999
.
CTDY5000  COMPARE   ZERO,PMCCPODY         * check pre-op cut off
          GOTO      CTDY9999 IF EQUAL
.
          MOVE      ADATE,FROMDATE
          MOVE      OPRDATE,TODATE
          PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
          CALL      NHOSPDAY
          MOVE      DIM30,KEY30
          CALL      RDTRAN2
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
          COMPARE   PMCCPODY,NBRDAYS
          GOTO      CTDY9999 IF LESS
.
          MOVE      THREE,PCFLAG           * critical care los > cc cut off
          MOVE      ZERO,CMXFLAG
          MOVE      ZERO,NPDAYFLG
          IF        PROGFLAG=2
            WRITE     HTMLFILE;"<tr><center><b>Warning: Patient":
                               " will revert to Patient Classification, ":
                               " pre-op cut off. </b>":
                               "</center></tr>";
            MOVE      ONE,PCFLAG           * patcat
            CALL      HITENTER
            DISPLAY   *P1:23,*EL;
          ENDIF
.
CTDY9999  RETURN
+
.******************************************************************************
.* CRIT0000: Calculate the number of critical care days                       *
.******************************************************************************
CRIT0000  MOVE      ZERO,CRITDAYS
          MOVE      ZERO,F1
          PACK      KEY30,AADMNO,SP20
          CALL      RDSTRAN2                * Position on & read the transfer
CRIT1000  CALL      RDKTRAN2                * file
          BRANCH    OVRCD,CRIT7000
.
          MATCH     AADMNO,TADMN
          GOTO      CRIT7000 IF NOT EQUAL   * Error
.
          CMATCH    ANSA,TMOVE
          GOTO      CRIT2000 IF EQUAL       * Admission record
.
          CMATCH    ANSL,TMOVE
          GOTO      CRIT3000 IF EQUAL       * Leave record
.
          CMATCH    ANSR,TMOVE
          GOTO      CRIT4000 IF EQUAL       * Return from leave record
.
          CMATCH    ANSC,TMOVE
          GOTO      CRIT5000 IF EQUAL       * Change record
.
          CMATCH    ANSD,TMOVE
          GOTO      CRIT6000 IF EQUAL       * Discharge record
.
          GOTO      CRIT5000                * Assume change record
.
. ----- Admission Record -----
.
CRIT2000  CALL      LSAV0000                * Save details
          GOTO      CRIT1000
.
. ----- Leave Record -----
.
CRIT3000  CALL      LEND0000                * Process end of a period
          GOTO      CRIT1000
.
. ----- Return Record -----
.
CRIT4000  CALL      LSAV0000                * Save details
          GOTO      CRIT1000
.
. ----- Change Record -----
.
CRIT5000  CALL      LEND0000                * Process end of a period
          CALL      LSAV0000                * Save new details
          GOTO      CRIT1000
.
. ----- Discharge Record -----
.
CRIT6000  CALL      LEND0000                * Process end of a period
          GOTO      CRIT9999
.
. ----- Error -----
.
CRIT7000  MOVE      DDATE,TDATE             * Assume discharge date
          CALL      LEND0000                * Process end of a period
.
CRIT9000  MOVE      ZERO,EXIT
CRIT9999  RETURN
+
.******************************************************************************
.*                                  LSAV0000              Called by: CLOS0000 *
.*         Save Start Of Period Details For Length Of Stay Calculations       *
.******************************************************************************
LSAV0000  PACK      CDYSFDTE,TDATE
          MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
LSAV9000  MOVE      ZERO,EXIT
LSAV9999  RETURN
+
.******************************************************************************
.*                                  LEND0000              Called by: CLOS0000 *
.*              Process End Of Period Details For Length Of Stay              *
.******************************************************************************
LEND0000  PACK      CDYSTDTE,TDATE
          MATCH     CDYSTDTE,CDYSFDTE
          GOTO      LEND8000 IF NOT LESS
.
          CALL      CALCDAYS                * Calculate diff between dates
          SUB       ONE,CDYSDAYS            * We dont want inclusive dates
          CALL      CHKC0000                * Check if stay in a ICU
          IF        PTCNHCCC=1
            IF        (F1=0 & EXIT=1) | (F1=1 & EXIT=1)
              ADD       CDYSDAYS,CRITDAYS
            ENDIF
          ELSE
.....       IF        (F1=1 & EXIT=1) | (F1=1 & EXIT=0)                 D-90306
            IF        (F1=0 & EXIT=1) | (F1=1 & EXIT=1)
              ADD       CDYSDAYS,CRITDAYS
            ENDIF
          ENDIF
.
          BRANCH    F1,LEND8000             * move EXIT to F1 if F1=0  *I-90306
          MOVE      EXIT,F1
          MOVE      ZERO,EXIT
.
LEND8000  MOVE      TDATE,STDATE            * Save transfer date for leave days
.         MOVE      PTTRLTYP,STRLTYP
.
LEND9000  MOVE      ZERO,EXIT
LEND9999  RETURN
+
.******************************************************************************
.*                                  CHKC0000                                  *
.*                   Check For A Stay In A Critical Care Unit                 *
.******************************************************************************
CHKC0000  MOVE      ZERO,EXIT               * Default normal/HDU bed stay
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*228,PTCNHCCC
.
. ****************************************** Change all references to  *C-90306
. ****************************************** TATYPE & TRBTYP to STATYPE and
. ****************************************** STRBTYP (in prev TRAN rec)*C-90306
          IF        PTCNHCCC=1
.                                           * Using bed type for CCU/ICU
            MATCH     SP3,STRBTYP                                      *C-90306
            GOTO      CHKC9000 IF EQUAL     * Dont allow blank codes
.
            PACK      KEY5,ANSB,ANST,STRBTYP                           *C-90306
            CALL      RDCODE1
            BRANCH    OVRCD,CHKC9000
.
            MATCH     ANSI,TCINDC1
            GOTO      CHKC9000 IF NOT EQUAL * CCU/ICU stay
          ELSE
.                                           * Using admin type for CCU/ICU
            MATCH     SP3,STATYPE                                      *C-90306
            GOTO      CHKC9000 IF EQUAL * Dont allow blank codes
.
            PACK      KEY5,ANSA,SP1,STATYPE                            *C-90306
            CALL      RDCODE1
            BRANCH    OVRCD,CHKC9000
.
            COMPARE   ONE,TCFORM6
            GOTO      CHKC9000 IF NOT EQUAL     * CCU/ICU stay
          ENDIF
.
          MOVE      ONE,EXIT                * CCU/ICU stay (not HDU)
          GOTO      CHKC9999
.
CHKC9000  MOVE      ZERO,EXIT
.
CHKC9999  RETURN
+
.***************************************************************************
.*        PMOI0000  - Calculate the patient moeity                         *
.***************************************************************************
PMOI0000  MOVE      ZERO,PMOIETY
          MOVE      SP70,PTHFDSC1
          MATCH     SP8,AFUNDH
          GOTO      PMOI9999 IF EQUAL
.
          OPEN      PATFN1A1,"patfn1af"
.
          PACK      KEY14,AFUNDH,AFNDTB
          CALL      RDFUND1
          BRANCH    OVRCD,PMOI9999
.
          OPEN      PATFMOA1,"patfmoaf"
.
          PACK      KEY17,AFUNDH,AFNDTB,TRBTYP
          CALL      RDPTFMO1
          BRANCH    OVRCD,PMOI9999
.
          IF        ACDAYCS=0
            MOVE      PTFMOVAM,PMOIETY         * overnight
          ELSE
            MOVE      PTFMSDAM,PMOIETY         * sameday
          ENDIF
.
.
.         MULT      NBRDAYS,PMOIETY
          MULT      TOTDAYS,PMOIETY
          COMPARE   PTHFMAXM,PMOIETY
          GOTO      PMOI9999 IF LESS
.
          MOVE      PTHFMAXM,PMOIETY
.
PMOI9999  
.         MOVE      PMOIETY,PTINPMAM
          RETURN
+
.*******************************************************************************
.         SAVRATE - Save original rates
.*******************************************************************************
SAVRATE   MOVE      DAYPAT,SDAYPAT
          MOVE      DAYHF,SDAYHF
          MOVE      ADDPAT,SADDPAT
          MOVE      ADDHF,SADDHF
          MOVE      DAYEND,SDAYEND
          MOVE      ADDEND,SADDEND
          MOVE      DAYCOL,DEFDCOL       * Default daily charge column
          MOVE      ADDCOL,DEFACOL       * Default additional charge column
SAVRATE9  RETURN
+
.*******************************************************************************
.         RESTRATE - Restore original rates
.*******************************************************************************
RESTRATE  MOVE      SDAYPAT,DAYPAT
          MOVE      SDAYHF,DAYHF
          MOVE      SADDPAT,ADDPAT
          MOVE      SADDHF,ADDHF
          MOVE      SDAYEND,DAYEND
          MOVE      SADDEND,ADDEND
          MOVE      DEFDCOL,DAYCOL
          MOVE      DEFACOL,ADDCOL
RESTRAT9  RETURN
+
.******************************************************************************
.       Update the control file with the transfer date if neccessary
.******************************************************************************
UPCNT     READ      CONTROLF,EIGHTY8;*148,CFRDTE
          MATCH     CFRDTE,TDATE
          GOTO      CHKMM3 IF NOT LESS
          MOVE      TDATE,CFRDTE
          WRITAB    CONTROLF,EIGHTY8;*148,CFRDTE
.
CHKMM3    READ      CONTROLF,EIGHTY8;*154,CMMHDT
          MATCH     CMMHDT,TDATE
          RETURN    IF NOT LESS
          MOVE      TDATE,CMMHDT
          WRITAB    CONTROLF,EIGHTY8;*154,CMMHDT
          RETURN
.
.******************************************************************************
.        Routine to get the bed fee rate
.******************************************************************************
GETBF00   MOVE      ZERO,COUNT
          MOVE      ZERO,DEFAULT
          MOVE      ZERO,FORM2
.
.         Display the Bed Fee for the above codes
.
          COMPARE   THREE,CNTRCEFR
          GOTO      GETBF80 IF EQUAL        * Invalid Contract Effective date
.
          MOVE      TDATE,CEFFDATE          * Set date for 'As at date'
          PACK      KEY27 WITH ACLAIM,AFUNDH,AFNDTB,ATYPE,SAVBTYP
          CALL      GETBFEES
          COMPARE   ZERO,EXIT
          GOTO      GETBF99 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><center><b>Default Not Yet ":
                             " Set Up. </b>":
                             "</center></tr>";
          GOTO      GETBF90
.
GETBF80   WRITE     HTMLFILE;"<tr><center><b>Contract Effective Detail":
                             " NOT found. </b>":
                             "</center></tr>";
GETBF90   MOVE      ONE,DEFAULT
GETBF99   RETURN
+
.------------------------------------------------------------
. CTME0000  : Set Transfer time to be one second before current time
. Return values : TDATE,TTIME
.------------------------------------------------------------
CTME0000  UNPACK    TTIME,CHOUR,ANS,CMIN,KEY3
          MOVE      CHOUR,FORM2
          MOVE      FORM2,FORM4
          MULT      "60",FORM4
          MOVE      CMIN,FORM2
          ADD       FORM2,FORM4            * This is now total time in minutes
          ADD       ONE,FORM4              * Add minutes
.
          MOVE      FORM4,FORM4A          * Save the total time
          IF        FORM4>=1440
            UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CCENT,CC
            MOVE      CYEAR,YY
            MOVE      CMON,MM
            MOVE      CDAY,DD
            CALL      DMYCON
            ADD       ONE,JULDAY
            MOVE      JULDAY,JWKDAY
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON
            PACK      TDATE,CC,YY,MM,DD
            REP       " 0",TDATE
          ENDIF
.
          ASSIGN    FORM4/SIXTY,FORM4
          ASSIGN    FORM4*SIXTY,FORM4
          SUB       FORM4,FORM4A
          MOVE      FORM4A,F2
          MOVE      CMIN,FORM2
          IF        F2<FORM2
            MOVE      CHOUR,FORM2
            IF        FORM2=23
              ASSIGN    ZERO,FORM2          * If Hours are 23,make it as 00
            ELSE
              ADD       ONE,FORM2           * Increment Hours by 1
            ENDIF
            MOVE      FORM2,CHOUR
            REP       " 0",CHOUR
          ENDIF
          MOVE      F2,CMIN
          REP       " 0",CMIN
          PACK      TTIME,CHOUR,COLON,CMIN,KEY3
.
CTME9999  RETURN
+
.*******************************************************************************
.         Check if we are using New Patient Portion functionality
.         for Accommodation 
.*******************************************************************************
CAPAT000  MOVE      ONE,NUMBINVR                   * default to one no of Inv.
          MATCH     "1",PTCNPPIN
          GOTO      CAPAT999 IF NOT EQUAL
.
          MOVE      CONTRCID,ACCCONTR              * save Accommodation Contract
          PACK      KEY6,CONTRCID
          CALL      RDPMCID1
          BRANCH    OVRCD,CAPAT999
.
          MOVE      ZERO,IPASS
.
          BRANCH    IPATFLAG,CAPAT999,CAPAT200
          MATCH     "1",PMCIPINV
          IF        !@EQUAL
            MOVE      ONE,PACMCHRG        * do not include to Patient payable
          ENDIF
          GOTO      CAPAT999
.
.     Check 'Use Patient Portion Invoicing' field from Contract
.
CAPAT200  MATCH     "1",PMCIPINV            
          GOTO      CAPAT999 IF NOT EQUAL
.
          MOVE      TWO,NUMBINVR          * New Patient Portion Inv.

          MOVE      ONE,IPASS
          MOVE      ZERO,NCHACCOM         * Charge Accommodation
          IF        ADSCHI=1
            MOVE      ONE,NCHACCOM        * No Accom - Printed Disc.Invoice
          ENDIF
          GOTO      CAPAT999
.
CAPAT999  RETURN
+
.*******************************************************************************
.         Check Number of Invoice for Theatre fee based on Contract ID setup
.*******************************************************************************
CIPAT000  MOVE      ZERO,PITMCHRG
          MATCH     "1",PTCNPPIN
          GOTO      CIPAT999 IF NOT EQUAL
.
          MATCH     SP70,MBSCONTR
          GOTO      CIPAT9999 IF EQUAL
.
          PACK      KEY6,MBSCONTR           * check item contract
          CALL      RDPMCID1
          BRANCH    OVRCD,CIPAT999
.
          MATCH     "1",PMCIPINV
          IF        !@EQUAL
            MOVE      ONE,PITMCHRG      * Item is not Patient payable
          ENDIF
.
          BRANCH    IPATFLAG,CIPAT999,CIPAT200
          GOTO      CIPAT999
.
CIPAT200  MOVE      ZERO,IPASS
          MOVE      ONE,MNINV
          MOVE      ONE,TNINVS
          MATCH     "1",PMCIPINV
          IF        @EQUAL
            MOVE      TWO,MNINV         * Patient Invoice for Theatre fee
            MOVE      TWO,TNINVS
          ENDIF
CIPAT999  RETURN
+
.*******************************************************************************
.         Create Mechanical Ventilation tempfile
.*******************************************************************************
CRMV0000  
...      ** removed file name generation - needs to be in INIT0000 functions
...      ** to stop extra temp files 
...          CALL      TFILENAM                * Get temp file name
...          MOVE      TFILNAME,FNAMEX
.
          CALL      KLMV0000
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEX,CMDLINE
          APPEND    " 34 U1-1,2-9",CMDLINE
          APPEND    " U26-33,1-1,2-9",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMMVFIL1,FNAMEX         * open file pointer
          OPEN      TMMVFIL2,FNAMEX         * open file pointer
.
          CALL      CLTM0000                * Clear tempfile
CRMV9999  RETURN
+
.*******************************************************************************
.         Kill misc item tempfile
.*******************************************************************************
KLMV0000  CLOSE     TMMVFIL1
          CLOSE     TMMVFIL2
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEX,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
KLMV9999  RETURN
.
.*******************************************************************************
.         Clear tempfile
.*******************************************************************************
CLTM0000  MOVE      SP70,KEY9
          CALL      RSTMMVA1
          CALL      RKTMMVA1
          BRANCH    OVRCD,CLTM9999
.
          PACK      KEY9,INTCTYPE,INTCTDAT,SP70
          CALL      DETMMVA1
          GOTO      CLTM0000
.
CLTM9999  RETURN
+
.*******************************************************************************
.        I/O for misc item tempfile
.*******************************************************************************
RKTMMVA1  MOVE      ZERO,OVRCD
          READKS    TMMVFIL1;INTCTYPE,INTCTDAT,INTCFDAT:
                             INTCDAYS,INTCNCHR,INTCNBDT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMMVA1  MOVE      ZERO,OVRCD
          READKP    TMMVFIL1;INTCTYPE,INTCTDAT,INTCFDAT:
                             INTCDAYS,INTCNCHR,INTCNBDT
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMMVA1  MOVE      ZERO,OVRCD
          RESET     KEY9
          READ      TMMVFIL1,KEY9;;
          GOTO      OVERCOND IF OVER
          RETURN
.
RATMMVA1  MOVE      ZERO,OVRCD
          RESET     KEY9
          READ      TMMVFIL1,KEY9;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMMVA1  RESET     KEY9
          WRITE     TMMVFIL1,KEY9;INTCTYPE,INTCTDAT,INTCFDAT:
                                  INTCDAYS,INTCNCHR,INTCNBDT
          GOTO      OVERCOND IF OVER
          RETURN
.
UPTMMVA1  UPDATE    TMMVFIL1;INTCTYPE,INTCTDAT,INTCFDAT:
                             INTCDAYS,INTCNCHR,INTCNBDT
          RETURN
.
DETMMVA1  MOVE      ZERO,OVRCD
          RESET     KEY9
          DELETE    TMMVFIL1,KEY9
          RETURN
.
RKTMMVA2  MOVE      ZERO,OVRCD
          READKS    TMMVFIL2;INTCTYPE,INTCTDAT,INTCFDAT:
                             INTCDAYS,INTCNCHR,INTCNBDT
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMMVA2  MOVE      ZERO,OVRCD
          RESET     KEY17
          READ      TMMVFIL2,KEY17;;
          GOTO      OVERCOND IF OVER
          RETURN
.
.-------------------------------------------------------------------------------
. Check if Patient invoice has been raised (ie record exist in HF Debtors)
.-------------------------------------------------------------------------------
CKPT0000  COMPARE   TWO,IPATFLAG
          GOTO      CKPT9999 IF EQUAL          * printing Patient invoice
.
.         Check if there is a rebate invoice to be printed
.
          PACK      KEY22 WITH AADMNO,SP70
          CALL      RSPTHTR1
CKPT1000  CALL      RKPTHTR1
          BRANCH    OVRCD,CKPT9999
.
          MATCH     DAADMNO,PTHTADMN
          GOTO      CKPT9999 IF NOT EQUAL
.
          MATCH     SP70,PTHTTREF              * Blank Rebate Invoice no?
          GOTO      CKPT9999 IF NOT EQUAL
.
.         Rebate invoice has not been raised, check if the patient invoice
.         has been credited 
.
          OPEN      PATINVR1,"patinvrf"
          MOVE      PTHTPINV,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,CKPT1000
.
          MATCH     "1",PTINCRST
          GOTO      CKPT1000 IF EQUAL     * fully credited
.
.         found a Patient invoice with Rebate invoice NOT raised yet
.
          MOVE      ONE,PREBFLAG          * flag for printing Rebate patient
          MATCH     "1",PTHTRECT
          IF        @EQUAL
            MOVE      PTHTFCEN,FCENT
            MOVE      PTHTFYER,FYEAR
            MOVE      PTHTFMON,FMON
            MOVE      PTHTFDAY,FDAY
          ENDIF
.
CKPT9999  RETURN
+
.******************************************************************************
.         Check if Certificate record exists
.******************************************************************************
          DEFPROC   CCERT000
.
          INC       PATCERFD/INC
.
CCERT000  MOVE      "99991231",DIM8
          COMPARE   THREE,ASTAT
          GOTO      CCERT100 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=0
            MOVE      DDATE,DIM8            * set discharge date
          ENDIF
.
CCERT100  OPEN      PATCERA1,"patceraf"
          PACK      KEY19,AURNO,SP70
          CALL      RSPTCER1 
CCERT200  CALL      RKPTCER1
          BRANCH    OVRCD,CCERT900
.
          MATCH     AURNO,PTCEURNO
          GOTO      CCERT900 IF NOT EQUAL
.
.         Check if the Certificate is for the current visit
.
          MATCH     PTITTCER,PTCETYPE
          GOTO      CCERT200 IF NOT EQUAL
.          
          MATCH     ADATE,PTCETDAT
          GOTO      CCERT200 IF LESS
.
          MATCH     PTCEFDAT,DIM8
          GOTO      CCERT200 IF LESS
.
          MOVE      ZERO,EXIT
          GOTO      CCERT999
.                                  
CCERT900  MOVE      ONE,EXIT
CCERT999  GOTO      ENDCERTF
.
          INC       PATCERIO/INC
          INC       IBAOVRIO/INC
ENDCERTF  ENDPROC
.
+
.******************************************************************************
.* BRDDS000 : Get the rate description when using the board charging files    *
.******************************************************************************
.
          DEFPROC   BRDDS000
.
          INC       OUTBCHFD/INC             * outpatient/daycase rates file
          INC       PATBCHFD/INC             * inpatient rates file
          INC       PATCALAG/INC             * variables for CALCAGE
.
BJDAY     FORM      3
CJDAY     FORM      3
ENDAGE    FORM      3
.
BRDDS000  BRANCH    ACDAYCS,BRDDS500         * daycase patient
.
.         Get the rate for a non-daycase patient
.
          CALL      INPCH000                 * inpatient charging
          MOVE      PTBCDESC,TDDESC          * rate description
          RESET     TDDESC,20                * set position for appending ward
.
          LOAD      NUMINVS,PTBCNINV,NUMINVS,TWO
          GOTO      BRDDS999
.
.         Get the rate for a daycase patient
.
BRDDS500  CALL      OUTCH000                 * outpatient charging
          MOVE      OTBCDESC,TDDESC          * rate description
          RESET     TDDESC,20                * set position for appending ward
.
          LOAD      NUMINVS,OTBCNINV,NUMINVS,TWO
.
BRDDS999  GOTO      ENDBRDDS
.
.******************************************************************************
.* INPCH000 : Get the rate description for an inpatient transfer record       *
.******************************************************************************
.
INPCH000  OPEN      PATBCHA1,"patbchaf"      * open charging file
.
          PACK      KEY15,ACLAIM,AFUNDH,STDEPT,STRBEND
          CALL      RDPTBCH1                 * get record
          BRANCH    OVRCD,INPCH200           * missing record
.
          GOTO      INPCH990                 * go record
.
.         Missing record. Blank description
.
INPCH200  MOVE      SP30,PTBCDESC            * no description
          MOVE      ONE,PTBCNINV             * assume only one invoice
.
INPCH990  CLOSE     PATBCHA1                 * close charging file
INPCH999  RETURN
.
. *****************************************************************************
. * OUTCH000 : Get the rate description for a daycase patient                 *
. *****************************************************************************
.
OUTCH000  PACK      AGEDATE,DDATE
          CALL      CALCAGE                  * calculate patients age
.
          OPEN      OUTBCHA1,"outbchaf"
          PACK      KEY18,ACLAIM,AFUNDH,STATYPE,PSAGEYRS,SP20
          CALL      RSOTBCH1
          CALL      RKOTBCH1
          BRANCH    OVRCD,DYRAT900           * no record -> no rate
.
          MATCH     OTBCCLM,ACLAIM           * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          MATCH     OTBCBRD,AFUNDH           * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          MATCH     OTBCDEPT,STATYPE         * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          MOVE      OTBCAGEG,ENDAGE          * save the ending age in age group
.
.         Get the rate for the number of visits
.
          PACK      KEY18,ACLAIM,AFUNDH,STATYPE,ENDAGE,PTMIPVIS
          CALL      RSOTBCH1
          CALL      RKOTBCH1
          BRANCH    OVRCD,DYRAT900           * no record -> no rate
.
          MATCH     OTBCCLM,ACLAIM           * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          MATCH     OTBCBRD,AFUNDH           * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          MATCH     OTBCDEPT,STATYPE         * correct code ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
          COMPARE   OTBCAGEG,ENDAGE          * correct age group ?
          GOTO      DYRAT900 IF NOT EQUAL    * no -> no rate
.
.         We have the rate
.
          GOTO      DYRAT990
.
.         No rate on file
.
DYRAT900  MOVE      SP30,OTBCDESC            * no description
          MOVE      ONE,OTBCNINV             * assume one invoice
.
DYRAT990  CLOSE     OUTBCHA1
.
DYRAT999  RETURN
.
          INC       CALCAGE
          INC       OUTBCHIO/INC
          INC       PATBCHIO/INC
          INC       IBAOVRIO/INC
.
ENDBRDDS  ENDPROC
.
+
.******************************************************************************
. PRBTTL00 - Print the rebate total
.******************************************************************************
.
.         Driven by the system parameter PTCNPEFR
.           0 = Print E.F.R. if not zero
.           1 = Print E.F.R. if no health fund or insurance payments. There
.               can't be a HF or insurance payment before an invoice is
.               printed. Therefore this option will always print an E.F.R.
.               amount.
.           2 = Don't print E.F.R. rebate at all
.
PRBTTL00  MOVE      CSAMT,FORM62
          COMPARE   CSAMT,NETTOT
          GOTO      PRBTTL20 IF EQUAL       * Invoice fully paid
.
          BRANCH    IPASS,PRBTTL20,PRBTTL20
.
          BRANCH    PTCNPEFR,PRBTTL10,PRBTTL20
.
          COMPARE   ZERO,REBTOT
          GOTO      PRBTTL20 IF EQUAL       * No rebate total
.
PRBTTL10  PRINT     *12,"(We Expect a Rebate of $ ",REBTOT," from your ";
          IF        CLAIM=1 | CLAIM=2 | CLAIM=3
            PRINT     "Insurer)";
          ELSE
            PRINT     "Health Fund)";
          ENDIF
.
PRBTTL20  CALL      PEOL0000
          COMPARE   CSAMT,NETTOT
          GOTO      PRBTTL99 IF EQUAL       * Invoice fully paid
.
          COMPARE   SIX,PTCNINVL
          GOTO      PRBTTL99 IF EQUAL       * Don't print payment due for
.                                             patient for invoice layout 6
.
          BRANCH    PTCNPEFR,PRBTTL40,PRBTTL99
.
          COMPARE   ZERO,REBTOT
          GOTO      PRBTTL99 IF EQUAL       * No rebate total
.
PRBTTL40  SUB       REBTOT,NETTOT           * Set up payment due from patient
          SUB       PMOIETY,NETTOT
          COMPARE   "2",PTCNPEFR
          GOTO      PRBTTL99 IF EQUAL       * Don't print E.F.R.
.
          PRINT     *15,"ESTIMATED PAYMENT DUE FROM PATIENT";
.
          IF        IBCNUGST=2
            MOVE      NETTOT,TOTAMNT
            ADD       TOTGST,TOTAMNT
            IF        PTCNINVL=16 | PTCNINVL=18
              MOVE      TOTAMNT,FORM62
              PRINT     *56,"$",FORM62;
            ELSE
              PRINT     *53,"$",FORM62;
            ENDIF
          ELSE
            MOVE      NETTOT,FORM62
            PRINT     *53,"$",FORM62;
          ENDIF
          ADD       ONE,COUNT
.
PRBTTL99  RETURN
+
.******************************************************************************
.* WSRB0000 : Write to the revenue breakdown file (Sameday)                   *
.******************************************************************************
WSRB0000  MOVE      ZERO,FORM4
          MOVE      ZERO,FORM12P2
.
.         Check if actual lumpsum amount is equal to the rev.breakdown
.
          CALL      CHSR0000
          BRANCH    EXIT,WSRB3000              * use the actual amount
.
          MATCH     "IBAADT09",PRGID
          GOTO      WSRB0100 IF EQUAL
          MATCH     "IBAINP19",PRGID
          GOTO      WSRB0100 IF EQUAL
.
.         COMPARE   ONE,PTCMDIFG
.         GOTO      WSRB3000 IF NOT EQUAL      * no revenue breakdown
.
WSRB0100  OPEN      PATRBLA1,"patrblaf"
          OPEN      PATSRBA1,"patsrbaf"
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTSRB1
WSRB1000  CALL      RKPTSRB1
          BRANCH    OVRCD,WSRB3000
.
          PACK      DIM27,PTSBCNID,PTSBCODE,PTSBFUND,PTSBTBLT,PTSBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      WSRB3000 IF NOT EQUAL
.
          ADD       ONE,FORM4
          MOVE      CNEXTINV,PTRBINVN
          MOVE      AADMNO,PTRBADMN          * Srf 12075
          MOVE      PTSBBRCD,PTRBBRCD
          MOVE      PTSBAMNT,PTRBAMNT
          MOVE      ZERO,PTRBGAMN
          IF        IBCNUGST=2
            MOVE      PTRBAMNT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PTRBGAMN
          ENDIF
          MOVE      SP70,PTRBBTCH
.
          COMPARE   FOUR,PROGFLAG
          GOTO      WSRB1100 IF EQUAL       * update the temporary patfins only
.
          PACK      KEY19,PTRBADMN,PTRBINVN,PTRBBRCD,SP70
          CALL      RAPTRBL1
          IF        OVRCD=1
            CALL      WRPTRBL1
          ELSE
            CALL      UPPTRBL1
          ENDIF
.
. ------ write to patrfnaf ------
.
WSRB1100  PACK      KEY5,ANSF,ANSI,PTRBBRCD
          CALL      RDCODE1
          BRANCH    OVRCD,WSRB2000
          MATCH     ANSA,TCINDC2
          IF        @EQUAL
            MOVE      PTSBBRCD,PTRBBRCD                 * ? redundant
            MOVE      PTSBAMNT,PTRBAMNT                 * ? redundant
            CALL      ACOM0000                  * accomodation record
            ADD       PTRBAMNT,FORM12P2         * track total B/down   *I-47546
            GOTO      WSRB1000
          ENDIF
.
WSRB2000  MOVE      PTRBAMNT,FINAMT
          MOVE      "A",FINTYPE
.
. ------  calculate the portion of the lump sum based on the expected ------
. ------  los if the patient is not discharged (revenue breakdown only) ----
.
          IF        ASTAT<>3 & REVBFLAG=1
            MOVE      ADATE,FROMDATE
            PACK      TODATE,CCC,CYY,CMM,CDD
            REP       " 0",TODATE
            PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
            CALL      NHOSPDAY
            MOVE      DIM30,KEY30
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
            COMPARE   NBRDAYS,PTCMXLOS
            IF        !@LESS
              ASSIGN    (PTRBAMNT/PTCMXLOS),PTRBAMNT
              ASSIGN    (PTRBAMNT*NBRDAYS),PTRBAMNT
              MOVE      PTRBAMNT,FINAMT
            ENDIF
          ENDIF
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          ADD       FINAMT,FORM12P2
          MOVE      PTRBBRCD,KEY3
          CALL      SFIN0000             * set up fincode for accommodation
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          CALL      URFG0000                * Update GST Revenue breakdown
.
          GOTO      WSRB1000
.
. ------ no revenue breakdown set up ------
.
WSRB3000  COMPARE   ZERO,FORM4
          GOTO      WSRB8000 IF NOT EQUAL
.
          MOVE      LINETOT,FINAMT
.         IF        IBCNUGST=2
.           MOVE      LINETOT,GSTWORK
.           MULT      GSTPCEN,GSTWORK
.           DIV       "100.00",GSTWORK
.           ADD       GSTWORK,FINAMT     * include GST
.         ENDIF
.
          MOVE      "A",FINTYPE
          MOVE      SP10,KEY3
          CALL      SFIN0000             * set up fincode for accommodation
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
.         If this is accommodation and breakdown does not exist,
.         set fincode with fund/casemix code
.
          PACK      FINCODE,ANSX,CMCODE,AFUNDH,SP70
.
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          CALL      URFG0000                * Update GST Revenue breakdown
.
          GOTO      WSRB9000
.
.         Check if the total breakup amount equals to the actual lumpsum amount
.
WSRB8000  COMPARE   LINETOT,FORM12P2
          GOTO      WSRB9000 IF EQUAL
.
. ---------------- Lumpsum is not equal to sum of Revenue Breakdown.
. ----------------       Save the remainder to an Accrual area
.
          MOVE      LINETOT,FINAMT       * actual total of lumpsum
          SUB       FORM12P2,FINAMT      * subtract total of revenues breakdown
.
.         IF        IBCNUGST=2
.           MOVE      FINAMT,GSTWORK
.           MULT      GSTPCEN,GSTWORK
.           DIV       "100.00",GSTWORK
.           ADD       GSTWORK,FINAMT     * include GST
.         ENDIF
.
          MOVE      "A",FINTYPE
          PACK      FINCODE,ANSY,SP70
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          GOTO      WSRB9000
.
WSRB9000  MOVE      ZERO,EXIT
WSRB9999  RETURN
+
.******************************************************************************
.* CHSR0000 : Check actual amount of lumpsum with breakdown rev.              *
.******************************************************************************
CHSR0000  MOVE      ZERO,EXIT
          MOVE      ZERO,TOTAMNT
          OPEN      PATSRBA1,"patsrbaf"
.
.         PACK      KEY27,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTSRB1
CHSR1000  CALL      RKPTSRB1
          BRANCH    OVRCD,CHSR9000
.
          PACK      DIM27,PTSBCNID,PTSBCODE,PTSBFUND,PTSBTBLT,PTSBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      CHSR9000 IF NOT EQUAL
.
          ADD       PTSBAMNT,TOTAMNT
          GOTO      CHSR1000
.
CHSR9000  COMPARE   LINETOT,TOTAMNT
          GOTO      CHSR9999 IF EQUAL
          MOVE      ONE,EXIT
CHSR9999  RETURN
+
.******************************************************************************
.* WRRB0000 : Write to the revenue breakdown file (Overnight)                 *
.******************************************************************************
WRRB0000  MOVE      ZERO,FORM4
          MOVE      ZERO,FORM12P2
.
.         Check if actual lumpsum amount is equal to the rev.breakdown
.
          CALL      CHOV0000
          BRANCH    EXIT,WRRB3000              * use the actual amount
.
          MATCH     "IBAADT09",PRGID
          GOTO      WRRB0100 IF EQUAL
          MATCH     "IBAINP19",PRGID
          GOTO      WRRB0100 IF EQUAL
.
.         COMPARE   ONE,PTCMDIFG
.         GOTO      WRRB3000 IF NOT EQUAL      * no revenue breakdown
.
WRRB0100  OPEN      PATRBLA1,"patrblaf"
          OPEN      PATOVBA1,"patovbaf"
          CALL      CICU0000              * check if ICU fees
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTOVB1
WRRB1000  CALL      RKPTOVB1
          BRANCH    OVRCD,WRRB3000
.
          PACK      DIM27,PTOBCNID,PTOBCODE,PTOBFUND,PTOBTBLT,PTOBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      WRRB3000 IF NOT EQUAL
.
          ADD       ONE,FORM4
          MOVE      CNEXTINV,PTRBINVN
          MOVE      AADMNO,PTRBADMN
          MOVE      PTOBBRCD,PTRBBRCD
          MOVE      PTOBAMNT,PTRBAMNT
          MOVE      ZERO,PTRBGAMN
          IF        IBCNUGST=2
            MOVE      PTRBAMNT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,PTRBGAMN
          ENDIF
          MOVE      SP70,PTRBBTCH
.
          COMPARE   FOUR,PROGFLAG
          GOTO      WRRB1100 IF EQUAL       * update the temporary patfins only
.
          PACK      KEY19,PTRBADMN,PTRBINVN,PTRBBRCD,SP70
          CALL      RAPTRBL1
          IF        OVRCD=1
            CALL      WRPTRBL1
          ELSE
            CALL      UPPTRBL1
          ENDIF
.
. ------ write to patrfnaf ------
.
WRRB1100  PACK      KEY5,ANSF,ANSI,PTRBBRCD
          CALL      RDCODE1
          BRANCH    OVRCD,WRRB2000
          MATCH     ANSA,TCINDC2
          IF        @EQUAL
            CALL      ACOM0000                  * accomodation record
            ADD       PTRBAMNT,FORM12P2         * track total B/down   *I-47546
            GOTO      WRRB1000
          ENDIF
.
WRRB2000  MOVE      PTRBAMNT,FINAMT
          MOVE      "A",FINTYPE
.
. ------  calculate the portion of the lump sum based on the expected ------
. ------  los if the patient is not discharged (revenue breakdown only) ----
.
          IF        ASTAT<>3 & REVBFLAG=1
            MOVE      ADATE,FROMDATE
            PACK      TODATE,CCC,CYY,CMM,CDD
            REP       " 0",TODATE
            PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
            CALL      NHOSPDAY
            MOVE      DIM30,KEY30
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
            COMPARE   NBRDAYS,PTCMXLOS
            IF        !@LESS
              ASSIGN    (PTRBAMNT/PTCMXLOS),PTRBAMNT
              ASSIGN    (PTRBAMNT*NBRDAYS),PTRBAMNT
              MOVE      PTRBAMNT,FINAMT
            ENDIF
          ENDIF
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          ADD       FINAMT,FORM12P2
          MOVE      PTRBBRCD,KEY3
          CALL      SFIN0000             * set up fincode for accommodation
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          CALL      URFG0000                * Update GST Revenue breakdown
.
          GOTO      WRRB1000
.
. ------ no revenue breakdown set up ? ------
.
WRRB3000  COMPARE   ZERO,FORM4
          GOTO      WRRB8000 IF NOT EQUAL
.
. ------  write lumpsum record to patfrnaf ------
.
          MOVE      LINETOT,FINAMT
.         IF        IBCNUGST=2
.           MOVE      LINETOT,GSTWORK
.           MULT      GSTPCEN,GSTWORK
.           DIV       "100.00",GSTWORK
.           ADD       GSTWORK,FINAMT     * include GST
.         ENDIF
.
          MOVE      ANSA,FINTYPE
          MOVE      SP10,KEY3
.....     CALL      SFIN0000     * set up fincode for accommodation     D-90310
.
.         If this is accommodation and breakdown does not exist,
.         set fincode with fund/casemix code
.
          PACK      FINCODE,ANSX,CMCODE,AFUNDH,SP70
.
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          CALL      URFG0000                * Update GST Revenue breakdown
.
          GOTO      WRRB9000
.
.         Check if the total breakup amount equals to the actual lumpsum amount
.
WRRB8000  MOVE      LINETOT,FINAMT       * actual total of lumpsum
.         IF        IBCNUGST=2
.           MOVE      LINETOT,GSTWORK
.           MULT      GSTPCEN,GSTWORK
.           DIV       "100.00",GSTWORK
.           ADD       GSTWORK,FINAMT     * include GST
.         ENDIF
.
          COMPARE   THREE,ASTAT
          GOTO      WRRB9000 IF EQUAL    * if discharged, no accrual balance
.
          COMPARE   FINAMT,FORM12P2      * balanced ?
          GOTO      WRRB9000 IF EQUAL
          GOTO      WRRB9000 IF NOT LESS * to avoid negative amount
.
. ----------------  Lumpsum is not equal to sum of Revenue Breakdown.
. ----------------       Save the remainder to an Accrual area
.
          SUB       FORM12P2,FINAMT       * subtract total of revenues breakdown
.
.         IF        IBCNUGST=2
.           MOVE      FINAMT,GSTWORK
.           MULT      GSTPCEN,GSTWORK
.           DIV       "100.00",GSTWORK
.           ADD       GSTWORK,FINAMT     * include GST
.         ENDIF
.
          MOVE      "A",FINTYPE
          PACK      FINCODE,ANSY,SP70
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          CALL      PATCALF
          GOTO      WRRB9000
.
WRRB9000  MOVE      ZERO,EXIT
WRRB9999  RETURN
+
.******************************************************************************
.* CHOV0000 : Check actual amount of lumpsum with breakdown rev.              *
.******************************************************************************
CHOV0000  MOVE      ZERO,EXIT
          MOVE      ZERO,TOTAMNT
          OPEN      PATOVBA1,"patovbaf"
.
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTOVB1
CHOV1000  CALL      RKPTOVB1
          BRANCH    OVRCD,CHOV9000
.
          PACK      DIM27,PTOBCNID,PTOBCODE,PTOBFUND,PTOBTBLT,PTOBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      CHOV9000 IF NOT EQUAL
.
          ADD       PTOBAMNT,TOTAMNT
          GOTO      CHOV1000
.
CHOV9000  COMPARE   LINETOT,TOTAMNT
          GOTO      CHOV9999 IF EQUAL
          MOVE      ONE,EXIT
CHOV9999  RETURN
+
.******************************************************************************
.* CICU0000 : Check for any ICU fees invoiced breakdown (overnight)           *
.******************************************************************************
CICU0000  MOVE      ZERO,FORM1
          MOVE      ZERO,ICUFLAG
.         PACK      KEY30,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMCODE,SP70
          PACK      KEY30,SKEY27,SP70
          CALL      RSPTOVB1
CICU1000  CALL      RKPTOVB1
          BRANCH    OVRCD,CICU9999
.
          PACK      DIM27,PTOBCNID,PTOBCODE,PTOBFUND,PTOBTBLT,PTOBCSCD,SP70
          MATCH     SKEY27,DIM27
          GOTO      CICU9999 IF NOT EQUAL
.
          PACK      KEY5,ANSF,ANSI,PTOBBRCD
          CALL      RDCODE1
          BRANCH    OVRCD,CICU1000
          MATCH     ANSI,TCINDC4
          IF        @EQUAL
            MOVE      ONE,ICUFLAG               * ICU record
          ENDIF
.
          GOTO      CICU1000
.
CICU9999  RETURN
+
.******************************************************************************
.         Update GST revenue breakdown file
.******************************************************************************
URFG0000  IF        PROGFLAG=3 & IBCNUGST=2
            MOVE      FGSTFLAG,FORM1     * Save
            MOVE      THREE,FGSTFLAG
            MOVE      FINAMT,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,FINAMT
            CALL      PATCALF
            MOVE      FORM1,FGSTFLAG     * restore
          ENDIF
URFG9999  RETURN
+
.******************************************************************************
.             Write Lumpsum accommodation portion
.******************************************************************************
ACOM0000  MOVE      ZERO,F1
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ADATE,FROMDATE
          MOVE      DDATE,TODATE
          CALL      NHOSPDAY              * get the length of stay
.
. ------  calculate the portion of the lump sum based on the expected ------
. ------  los if the patient is not discharged (revenue breakdown only) ----
.
          IF        ASTAT<>3 & REVBFLAG=1
            MOVE      ADATE,FROMDATE
            PACK      TODATE,CCC,CYY,CMM,CDD
            REP       " 0",TODATE
            PACK      DIM30 WITH TADMN,TDATE,TTIME,TWARD,TBED
            CALL      NHOSPDAY
            MOVE      DIM30,KEY30
            CALL      RDTRAN2
            MATCH     SP70,PMSGCLSS
            IF        !@EQUAL
              MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
            ENDIF
            COMPARE   NBRDAYS,PTCMXLOS
            IF        !@LESS
              ASSIGN    (PTRBAMNT/PTCMXLOS),PTRBAMNT
              ASSIGN    (PTRBAMNT*NBRDAYS),PTRBAMNT
            ENDIF
          ENDIF
.
          MOVE      NBRDAYS,ACOMDAYS
          IF        ICUFLAG=1
            CALL      CRIT0000
            SUB       CRITDAYS,ACOMDAYS
          ENDIF
.
          IF        ACOMDAYS=0
            MOVE      ONE,ACOMDAYS
          ENDIF
.
          ASSIGN    (PTRBAMNT/ACOMDAYS),ACCPDAY  * accomodation amount per day
.
.* ****************************************** Start of ADT09 Changes   *C-90310
.                                        * read thru pattranf for change of ward
          UNPACK    SP20,SAVWARD,SAVBED,STATYPE,STRBTYP
          MOVE      ADATE,SAVDATE
          MOVE      ZERO,SUMACC
          PACK      KEY30,AADMNO,SP20
          CALL      RDSTRAN2
.
ACOM1000  CALL      RDKTRAN2
          BRANCH    OVRCD,ACOM1100
.
          MATCH     AADMNO,TADMN
          IF        !@EQUAL
ACOM1100    IF        ASTAT = 3
              GOTO      ACOM9000            * finished reading Transfers
            ELSE
              MOVE      ONE,F1              * flag for 'end-of-TRANs'
              CALL      RDPTRAN2            * no "D" recd - read previous recd
              BRANCH    OVRCD,ACOM9999
.
              MATCH     AADMNO,TADMN
              GOTO      ACOM9999 IF NOT EQUAL
.
              MOVE      "D",TMOVE           * make it look like a discharge
              PACK      TDATE,CCC,CYY,CMM,CDD
              REP       " 0",TDATE
            ENDIF
          ENDIF
.
          MATCH     ANSA,TMOVE              * "A"dmission transfer record
          GOTO      ACOM5000 IF EQUAL       * initialise save areas
.
          MATCH     ANSD,TMOVE              * "D"ischarge transfer record
          GOTO      ACOM3000 IF EQUAL
.
          MATCH     SAVWARD,TWARD           * change of ward
          GOTO      ACOM2000 IF NOT EQUAL
          MATCH     SAVBED,TBED             * change of bed
          GOTO      ACOM2000 IF NOT EQUAL
          GOTO      ACOM1000
.
.                                           * check if this is in CCU/ICU
ACOM2000  IF        ICUFLAG=1
            IF        PTCNHCCC=1
.                                           * Using bed type for CCU/ICU
              MATCH     SP3,STRBTYP
              GOTO      ACOM3000 IF EQUAL   * no Bed Type - not CCU/ICU
              PACK      KEY5,ANSB,ANST,STRBTYP
              CALL      RDCODE1
              BRANCH    OVRCD,ACOM3000      * no "patcodes" - not CCU/ICU
              MATCH     ANSI,TCINDC1
              GOTO      ACOM5000 IF EQUAL   * Indicator="I" - is CCU/ICU
            ELSE
.                                           * Using admin type for CCU/ICU
              MATCH     SP3,STATYPE
              GOTO      ACOM3000 IF EQUAL   * no Admiss.Type - not CCU/ICU
              PACK      KEY5,ANSA,SP1,STATYPE
              CALL      RDCODE1
              BRANCH    OVRCD,ACOM3000      * no "patcodes" - not CCU/ICU
              COMPARE   ONE,TCFORM6
              GOTO      ACOM5000 IF EQUAL   * it is a CCU/ICU stay
            ENDIF
          ENDIF
.
ACOM3000  MOVE      SAVDATE,FROMDATE
          MOVE      TDATE,TODATE
          BRANCH    F1,ACOM3500             * bypass 'save' if F1 is on
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
ACOM3500  CALL      NHOSPDAY
.
.
.                                           * setup the breakdown record
ACOM4000  MOVE      "A",FINTYPE
          MOVE      PTRBBRCD,KEY3
.                                           * restore saved fields for SFIN0000
          MOVE      SAVWARD,TWARD
          MOVE      SAVBED,TBED
          MOVE      STATYPE,TATYPE
          MOVE      STRBTYP,TRBTYP
          CALL      SFIN0000                * setup Fincode for Accom.
.
          MOVE      SAVKEY30,KEY30          * NHOSPDAY has read thru Transfers
          CALL      RDTRAN2                 * reposition on Transfer record
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
.
          MATCH     "D",TMOVE
          IF        @EQUAL | F1 = 1
            ASSIGN    (PTRBAMNT-SUMACC),FINAMT   * remainder to "D" Ward
          ELSE
            ASSIGN    (NBRDAYS*ACCPDAY),FINAMT   *
            ADD       FINAMT,SUMACC
          ENDIF
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
          PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
.
          CALL      PATCALF                 * write Financial Summary Stats
.
          CALL      URFG0000                * Update GST Revenue breakdown
.
          MATCH     "D",TMOVE
          GOTO      ACOM9000 IF EQUAL
          BRANCH    F1,ACOM9000             * finished if ASTAT = 2
.
.                                           * save Accom data before next Tran
ACOM5000  MOVE      TWARD,SAVWARD
          MOVE      TBED,SAVBED
          MOVE      TDATE,SAVDATE
          MOVE      TATYPE,STATYPE
          MOVE      TRBTYP,STRBTYP
          GOTO      ACOM1000                * go back & read next Transfer

.* ****************************************** End of ADT09 Changes     *C-90310
.
ACOM9000  MOVE      DIM30,KEY30          * reposition pattranf         *C-90310
          CALL      RDTRAN2
          MATCH     SP70,PMSGCLSS
          IF        !@EQUAL
            MOVE      PMSGCLSS,TATYPE         * Use ICD10 Suggested Class.
          ENDIF
ACOM9999  RETURN
+
.******************************************************************************
.        Get the fees for any theatre fees
.******************************************************************************
GETIT00  MOVE      ZERO,EXIT
         OPEN      CONTROLF,"controlf"
         READ      CONTROLF,HUND09;*246,PTCNRCAL
         MOVE      SP70,MBSCONTR
.
         MOVE      PMMITDAT,OPRDATE
.                                           * Start of additional code  I-90226
         MATCH     "IBAHOS03",PRGID
         GOTO      GETIT02 IF EQUAL
.
.        If the matrix is not on and it's not a casepayment patient, do not
.        recalculate theatre fees
.
         BRANCH    CMXFLAG,GETIT05
         BRANCH    PTCNNWCM,GETIT02         * using matrix, so continue
.
.        check the Fund to see if the Fund wants to use the matrix
.
         MOVE      ZERO,PTHFUCMX
         OPEN      PATFN1A1,"patfn1af"                                 *C-90226
         PACK      KEY14,AFUNDH,ZERO8
         CALL      RDFUND1
         BRANCH    PTHFUCMX,GETIT02         * using matrix, so continue
.
         BRANCH    PTCNRCAL,GETIT02         * parameter to recalculate fees
.
         GOTO      GETIT99                  * don't recalculat theatre fees
.                                           * End of additional code    I-90226
.
.        Get the MBS item record for this theatre fee
.
GETIT02  OPEN      PATITEM1,"patitemn"
         PACK      KEY17,TITEMNO,OPRDATE,SP70
         CALL      PATITMRD
         COMPARE   ZERO,OVRCD
         GOTO      GETIT10 IF EQUAL
.
         MOVE      TRECEIPT,TITEMNO
         MOVE      TRECEIPT,PMMIITEM
.
GETIT05  PACK      KEY17 WITH TITEMNO,OPRDATE,SP70
         OPEN      PATITEM1,"patitemn"
         CALL      PATITMRD
         IF        OVRCD = 1
.
.          If this is casemix, check for valid DRG
.
           IF        CMXFLAG = 1
             OPEN      PATDGWA1,"patdgwaf"
             PACK      KEY4 WITH TITEMNO,SP5
             PACK      KEY7,TITEMNO,SP10   * don't care what DRG Ver  *C-137125
             CALL      RSPTDGW1
             CALL      RKPTDGW1
.            CLOSE     PATDGWA1
             BRANCH    OVRCD,GETIT90
             MATCH     PTDWDRGC,TITEMNO    * valid DRG ? (any Ver)    *I-137125
             GOTO      GETIT90 IF NOT EQUAL                           *I-137125
             GOTO      GETIT10
           ENDIF
           GOTO      GETIT90
         ENDIF
.
.        Check for multiple items in the same session
.
GETIT10  PACK      DIM18 WITH TADMNO,TSESSION,TFCENT,TFYEAR,TFMONTH,TFDAY
         REP       " 0",DIM18
.
         MATCH     DIM18,CURSESS
         GOTO      GETIT20 IF EQUAL
.
         MOVE      ZERO,COPTION
         MOVE      DIM18,CURSESS
.
GETIT20  IF        IBCNMHOS=1
           MATCH     "1",PTHSTFEE
           GOTO      GETIT22 IF EQUAL
         ELSE
           BRANCH    PTCNTFEE,GETIT22       * using theatre fees file
         ENDIF
.
         MOVE      ZERO,PMMIAMTT
         MOVE      ZERO,PMMIAMTP
         MOVE      ZERO,PMMIRBAT
         MOVE      ZERO,TPATAMTT
         MOVE      ZERO,TPATAMTP
         MOVE      ZERO,TREBATE
         IF        CMBSFEE=1
           MOVE      QIAMT,TPATAMTP
           MOVE      QIAMT,PMMIAMTP
           MOVE      QIAMT,TPATAMTT
           MOVE      QIAMT,PMMIAMTT
         ENDIF
         GOTO      GETIT99                * get next item
.
GETIT22  MOVE      PMMITDAT,TSRVDATE        * Service date
.
.        for Casepayment - use per diem theatre fee to sort
.
         ADD       ONE,COPTION
         IF        CMXFLAG=1 & SORTDONE=1
           CALL      GTHR0000                 * get normal theatre charge
           BRANCH    EXIT OF GETIT90
.
           MOVE      TFPAT1,TPATAMTP
           MOVE      TFHF1,TREBATE
           GOTO      GETIT80
         ENDIF
.
         IF        CMXFLAG = 1
           MOVE      COPTION,FORM2          * set item sequence
           CALL      CMXT0000               * get theatre casemix funding
           BRANCH    EXIT,GETIT90
           CALL      CIPAT000               * Set No of Inv. from Contract
           IF        TREBATE=0
             MOVE      ZERO,PITMCHRG        * Included in Patient Payable
           ENDIF
           GOTO      GETIT80                * get next item
         ENDIF
.
         CALL      GTHR0000                 * get normal theatre charge
         BRANCH    EXIT OF GETIT90
         CALL      CIPAT000                 * Set No of Inv. from Contract
.
         OPEN      PATITEM1,"patitemn"
         PACK      KEY17 WITH TITEMNO,OPRDATE,SP70
         CALL      PATITMRD
         COMPARE   ZERO,OVRCD
         GOTO      GETIT30 IF EQUAL
.
.        Fix price item, just adjust rebate portion
.
         MOVE      ZERO,TREBATE
         LOAD      TREBATE USING COPTION OF TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
         MOVE      ZERO,PMMIRBAT
         LOAD      PMMIRBAT USING COPTION OF TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
.
         COMPARE   TREBATE,TPATAMTT
         GOTO      GETIT25 IF NOT LESS
.
         MOVE      TPATAMTT,TREBATE
         MOVE      PMMIAMTT,PMMIRBAT
.
GETIT25  MOVE      PMMIAMTT,TPATAMTP
         SUB       PMMIRBAT,TPATAMTP
         MOVE      TPATAMTP,PMMIAMTP
         MOVE      ZERO,PTDTEPSD
         GOTO      GETIT80
.
.        Normal theatre fee
.
GETIT30  MOVE      ZERO,TREBATE
         MOVE      ZERO,TPATAMTP
         MOVE      ZERO,PMMIRBAT
         MOVE      ZERO,PMMIAMTP
         LOAD      PMMIRBAT USING COPTION OF TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
         LOAD      PMMIAMTP USING COPTION OF TFPAT1,TFPAT2,TFPAT3,TFPAT4:
                                           TFPAT5,TFPAT6
.
.        if there are more that 6 theatre fees then use the 6th fee    *I-39291
.              Also check parameter. Default is yes.                   *I-47385
.
         IF        COPTION > 6
           IF        PTCNMBSF = 0
             MOVE      TFHF6,PMMIRBAT      *Rebate portion             *I-47385
             MOVE      TFPAT6,PMMIAMTP     *Patient portion            *I-39291
           ENDIF                                                       *I-47385
         ENDIF                                                         *I-39291
.
         MOVE      PMMIRBAT,PMMIAMTT
         ADD       PMMIAMTP,PMMIAMTT
.
         MOVE      PMMIRBAT,TREBATE
         MOVE      PMMIAMTP,TPATAMTP
         MOVE      PMMIAMTT,TPATAMTT
.
         MATCH     SP70,HBCOFKEY
         GOTO      GETIT80 IF EQUAL
.
         COMPARE   ONE,MBSCOUNT
         GOTO      GETIT90 IF NOT EQUAL
.
         CALL      MLCOD000               * Get the multiple proc.code
         GOTO      GETIT99
.
GETIT80  MOVE      ZERO,EXIT
         MOVE      TSERVS,PMMISERV
         IF        TSERVS<>0
.          MULT      TSERVS,TPATAMTP
.          MULT      TSERVS,TREBATE
.
           MOVE      TPATAMTP,TPATAMTT
           ADD       TREBATE,TPATAMTT
           MULT      TSERVS,TPATAMTT
.
           MOVE      TPATAMTP,PMMIAMTP
           MOVE      TREBATE,PMMIRBAT
           MOVE      TPATAMTT,PMMIAMTT
         ENDIF
.
         IF        TREBATE=0
           MOVE      ZERO,PITMCHRG         * Included in Patient Payable
         ENDIF
         GOTO      GETIT99
.
GETIT90  MOVE      ONE,EXIT
         MOVE      ZERO,TREBATE
         MOVE      ZERO,TPATAMTP
         MOVE      ZERO,TPATAMTT
.
         MOVE      ZERO,PMMIRBAT
         MOVE      ZERO,PMMIAMTP
         MOVE      ZERO,PMMIAMTT
GETIT99  RETURN
.
.
.         *******************
.         Casemix theatre fee
.         *******************
.
CMXT0000  MOVE      ZERO,EXIT
          MOVE      DCFLAG,PTCTDCAS         * Daycase
          MOVE      FORM2,PTCTITMS          * Item sequence
.
.         Check if this is a valid DRG Code
.
          MOVE      ONE,MBSFLAG             * default to MBS Item
          MOVE      SP10,DIM6
          UNPACK    TITEMNO,DIM3,DIM6
          MATCH     SP6,DIM6
          GOTO      CMXT1000 IF NOT EQUAL
.
          OPEN      PATDGWA1,"patdgwaf"
...       PACK      KEY4 WITH TITEMNO,SP5
          PACK      KEY7,TITEMNO,SP10       * valid DRG (any Vers)    *C-137125
          CALL      RSPTDGW1
          CALL      RKPTDGW1
.         CLOSE     PATDGWA1
          BRANCH    OVRCD,CMXT1000                                    *C-137125
          MATCH     PTDWDRGC,TITEMNO                                  *C-137125
          IF        @EQUAL
            MOVE      ZERO,MBSFLAG
            MOVE      TITEMNO,MCHARGE
          ENDIF
.
CMXT1000  MOVE      ONE,USEDEF              * to use default
          CALL      DCLM0000                * Check Hospital claim code charging
          CALL      CMGETTHR                * Get casemix theatre
          IF        OVRCD=1
            MOVE      ONE,EXIT
            BRANCH    CBFLAG,CMXT9999       * no error message
            CALL      NOCM0000              * no casemix rec so display warning
            GOTO      CMXT9999
          ENDIF
.
          MOVE      CONTRCID,MBSCONTR
          MOVE      PTCTDPAT,TPATAMTP       * Patient portion
          MOVE      PTCTDREB,TREBATE        * Rebate portion
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          MOVE      PTCTMBSB,PTDTSUNQ       * Theatre banding
.
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
          MOVE      TPATAMTT,PMMIAMTT
          MOVE      PTCTMBSB,PMMISUNQ
          MOVE      ZERO,EXIT
CMXT9999  RETURN
+
.******************************************************************************
.         Subroutine to get the appropriate miscellaneous charges record
.******************************************************************************
GMIS0000  MOVE      ZERO,EXIT
.                                           * MISCDATE has been populated
.                                         * convert "H/F Table" to "Table Type"
          CALL      GTAB0000
.
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,TITEMNO,MISCDATE,SP20
          CALL      PATMCHRD                * Read misc. charge file
          COMPARE   ZERO,EXIT 
          GOTO      GMIS9999 IF EQUAL
.
          PACK      KEY29,ACLAIM,SP6,SP3,TITEMNO,MISCDATE,SP20
          CALL      PATMCHRD                * Read misc. charge file
          COMPARE   ZERO,EXIT 
          GOTO      GMIS9999 IF EQUAL
.
          CALL      DCLM0000        * set default claim code - returns PTCNDCLM
          PACK      KEY29,PTCNDCLM,SP6,SP3,TITEMNO,MISCDATE,SP20
          CALL      PATMCHRD                * Read misc. charge file
.
GMIS9999 RETURN
+
.******************************************************************************
.         Subroutine to get the theatre fee amount
.******************************************************************************
.
GTHR0000  MOVE      ZERO,NOFEE
          OPEN      PATFN1A1,"patfn1af"
.
.         Set up the daycase rate indicator
.
          MOVE      SP1,DIM1A
          MATCH     ADATE,DDATE
          GOTO      GTHR1000 IF NOT EQUAL
          MOVE      "D",DIM1A
.
GTHR1000  PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF                * Get Contract Effective details
          BRANCH    EXIT,GTHR8000          
.         
          MOVE      PMMITDAT,CEFFDATE       * as at date
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,CODECL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY18 WITH ACLAIM,AFUNDH,AFNDTB,DIM1A
          CALL      GETTFEES
          BRANCH    EXIT,GTHR8000
.
          COMPARE   ZERO,HFBAND
          GOTO      GTHR9999 IF EQUAL
          UNPACK    DIM5,PMMISUNQ          * Theatre banding
          UNPACK    DIM5,PTDTSUNQ          * Theatre banding
          GOTO      GTHR9999
.
GTHR8000  MOVE      ONE,NOFEE
          GOTO      GTHR9999
.
GTHR9999  RETURN
+
.******************************************************************************
.*                                  WACRD000                                  *
.*                     Write Accommodation record to patinpaf                 *
.******************************************************************************
. ** NB: Any accommodation charged while the patient is in an ICU/CCU bed will
.        be written as an 'I' record. i.e. if bed type is ICU/CCU (see below)
.
WACRD000  CALL      CLPATINP                * clear patinpaf vars
.
          MOVE      AADMNO,PTIPADMN         * admission number
          MOVE      AURNO,PTIPURNO          * u/r number
          PACK      PTIPRTYP,ANSA,SP3       * record type
          MOVE      ACLAIM,PTIPCLAM         * claim type
          MOVE      AFUNDH,PTIPHFND         * health fund
          MOVE      AFNDTB,PTIPFTBL         * health fund table
.         MOVE      PTMIPCMX,PTIPPDRG       * casemix MBS/DRG code provisional
          MOVE      CMCODE,PTIPPDRG         * Casemix code
.
          MOVE      STATYPE,PTIPATYP        * admission type
          MOVE      STWARD,PTIPWARD         * ward
          MOVE      STBED,PTIPWBED          * bed
.
. Change the record type to 'I' if this is an ICU bed
.
          PACK      KEY5,ANSB,ANST,STRBTYP
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSI,TCINDC1
            IF        @EQUAL
              PACK      PTIPRTYP,ANSI,SP3   * record type='I' for ICU/CCU
            ENDIF
          ENDIF
.
          MATCH     ANSA,PTIPRTYP
          IF        @EQUAL
            ADD       ONE,ACCCOUNT
            MOVE      ACCCOUNT,PTIPTRNN   * transaction number ('A')
          ELSE
            ADD       ONE,ICUCOUNT
            MOVE      ICUCOUNT,PTIPTRNN   * transaction number ('I')
          ENDIF
.
          MATCH     SP3,STWARD
          IF        @EQUAL
            MOVE      NODAYS,PTIPLDAY       * leave days
            MOVE      ZERO,PTIPBDAY
          ELSE
            MOVE      NODAYS,PTIPBDAY       * days in bed
            MOVE      ZERO,PTIPLDAY
            MOVE      STRBTYP,PTIPBTYP      * bed type
          ENDIF
.
          MOVE      IDATEF,PTIPACCF         * accommodation date from
          MOVE      IDATET,PTIPACCT         * accommodation date to
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            MOVE      ADOCTA,PTIPADOC
          ELSE
            MOVE      STADOCT,PTIPADOC      * attending doctor code
          ENDIF
          PACK      KEY6,PTIPADOC
          CALL      RDDOCT1
          IF        OVRCD<>1
            MOVE      DSNAME,PTIPFNAM
            STRIP     PTIPFNAM
            ENDSET    PTIPFNAM
            APPEND    DGNAME,PTIPFNAM
            RESET     PTIPFNAM
            STRIP     PTIPFNAM
            ENDSET    PTIPFNAM
            APPEND    DTITL,PTIPFNAM
            RESET     PTIPFNAM              * attending doctor name
            MOVE      DRTYPE,PTIPDTYP       * attending doctor specialty
          ENDIF
.
          MOVE      LINETOT,PTIPAREV        * accommodation revenue
          MOVE      ONE,PTIPTTYP            * transaction type (1=Accomm.)
.
          MOVE      SAMTG,PTIPGPOR          * government portion amount
          ASSIGN    (STRATEF+STRATEH),PTIPORAT  * original rate
          MOVE      PTIPORAT,PTIPDRAT
          SUB       STALLW,PTIPDRAT
          SUB       STDISC,PTIPDRAT         * individual daily rate amount
          ASSIGN    (SPTTRADP+SPTTRADR),PTIPADDT  * casepayment additional rate
          ASSIGN    (STRATEH+SPTTRADR),PTIPFREB
          MULT      NODAYS,PTIPFREB         * estimated fund rebate
.
          COMPARE   ZERO,AINVPRT
          GOTO      WACRD200 IF EQUAL
.
          CALL      CHKACCM0           * Check if accommodation has been charged
          BRANCH    EXIT,WACRD300       * Found accommodation record
.
WACRD200  MOVE      SPTTRLSP,PTIPPPOR     * lump sum amount - patient portion
          MOVE      SPTTRLSR,PTIPRPOR     * lump sum amount - rebate portion
.
WACRD300  MOVE      LOWFLAG,PTIPCTYP        * casemix day type
.
          CALL      GDTA0000                * get date/time & operator id
.
          PACK      KEY16,PTIPADMN,PTIPRTYP,PTIPTRNN
          CALL      WRPTINP1
WACRD999  RETURN
+
.******************************************************************************
.*                                  WMCRD000                                  *
.*                    Write Misc. Charge record to patinpaf                   *
.******************************************************************************
WMCRD000  CALL      CLPATINP                * clear patinpaf vars
.
          MOVE      AADMNO,PTIPADMN         * admission number
          MOVE      AURNO,PTIPURNO          * u/r number
          MOVE      ACLAIM,PTIPCLAM         * claim type
          MOVE      AFUNDH,PTIPHFND         * health fund
          MOVE      AFNDTB,PTIPFTBL         * health fund table
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          MOVE      KEY8,PTIPACCF           * date of item
          PACK      KEY30,PTIPADMN,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2                * get applicable transfer record
          BRANCH    OVRCD,WMCRD500
.
          MOVE      TATYPE,PTIPATYP         * admission type
          MOVE      TWARD,PTIPWARD          * ward
          MOVE      TBED,PTIPWBED           * bed
          MOVE      TRBTYP,PTIPBTYP         * bed type
.
          MOVE      TADOCT,PTIPADOC         * attending doctor code
          PACK      KEY6,PTIPADOC
          CALL      RDDOCT1
          IF        OVRCD<>1
            MOVE      DSNAME,PTIPFNAM
            STRIP     PTIPFNAM
            ENDSET    PTIPFNAM
            APPEND    DGNAME,PTIPFNAM
            RESET     PTIPFNAM
            STRIP     PTIPFNAM
            ENDSET    PTIPFNAM
            APPEND    DTITL,PTIPFNAM
            RESET     PTIPFNAM              * attending doctor name
            MOVE      DRTYPE,PTIPDTYP       * attending doctor specialty
          ENDIF
.
WMCRD500  MOVE      TITEMNO,PTIPITEM        * item number
          PACK      PTIPITEM,PTIPITEM,SP70
          MATCH     SP70,PTIPITEM
          IF        !@EQUAL
            PACK      KEY5,ANSF,ANSI,TMISGRP
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TCINDC2,PTIPMHDP    * misc. charge group (Cat.FI, Ind.2)
            ENDIF
          ENDIF
.
          MOVE      TREBATE,PTIPFREB        * estimated fund rebate
          MOVE      TMISGRP,PTIPBAND        * Item Group (Cat FI)
.
          IF        TRECTYPE=2
            CALL      WTITM000              * write theatre item record
          ELSE
            IF        TRECTYPE=3
              CALL      WMITM000            * write misc. item record
.
.           ELSE
.             IF        TRECTYPE=4
.               CALL      WMITM000            * write misc. item record
.             ENDIF
.
            ENDIF
          ENDIF
.
WMCRD999  RETURN
+
.******************************************************************************
.*                                  WTITM000                                  *
.*                       Write Theatre record to patinpaf                     *
.******************************************************************************
WTITM000  PACK      PTIPRTYP,ANST,SP3       * record type
          MOVE      LINETOT,PTIPTREV        * theatre revenue
          MOVE      TWO,PTIPTTYP            * transaction type (2=Theatre)
          ADD       ONE,THTCOUNT
          MOVE      THTCOUNT,PTIPTRNN       * transaction number
.
          PACK      KEY14,PTIPHFND,PTIPFTBL * theatre band
          CALL      RDFUND1
          BRANCH    OVRCD,WTITM500
.
          PACK      KEY8,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",KEY8
          PACK      KEY17,PTIPITEM,KEY8,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,WTITM500
.
.         LOAD      PTIPBAND,HFBAND,IBAND1,IBAND2,IBAND3,IBAND4,IBAND5,IBAND6:
.                                IBAND7,IBAND8,IBAND9,IBAND10,IBAND11,IBAND12:
.                                IBAND13,IBAND14,IBAND15,IBAND16
.
WTITM500  MOVE      LINETOT,PTIPTREV        * theatre revenue
.
          CALL      GDTA0000                * get date/time & operator id
.
          PACK      KEY16,PTIPADMN,PTIPRTYP,PTIPTRNN
          CALL      WRPTINP1
WTITM999  RETURN
+
.******************************************************************************
.*                                  WMITM000                                  *
.*                      Write Misc. Item record to patinpaf                   *
.******************************************************************************
WMITM000  MATCH     ANSA,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANSA,SP3     * record type
            MOVE      LINETOT,PTIPAREV      * accommodation revenue
            ADD       ONE,ACCCOUNT
            MOVE      ACCCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          MATCH     ANSI,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANSI,SP3     * record type
            MOVE      LINETOT,PTIPIREV      * ICU/CCU revenue
            ADD       ONE,ICUCOUNT
            MOVE      ICUCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          MATCH     ANST,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANST,SP3     * record type
            MOVE      LINETOT,PTIPTREV      * theatre revenue
            ADD       ONE,THTCOUNT
            MOVE      THTCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          MATCH     ANSP,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANSP,SP3     * record type
            MOVE      LINETOT,PTIPPREV      * prosthesis revenue
            ADD       ONE,PRSCOUNT
            MOVE      PRSCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          MATCH     ANSD,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANSD,SP3     * record type
            MOVE      LINETOT,PTIPHREV      * pharmacy revenue
            ADD       ONE,PHRCOUNT
            MOVE      PHRCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          MATCH     ANSL,PTIPMHDP
          IF        @EQUAL
            PACK      PTIPRTYP,ANSL,SP3     * record type
            MOVE      LINETOT,PTIPLREV      * labour ward revenue
            ADD       ONE,LBWCOUNT
            MOVE      LBWCOUNT,PTIPTRNN     * transaction number
            GOTO      WMITM500
          ENDIF
.
          PACK      PTIPRTYP,ANSM,SP3       * record type
          MOVE      LINETOT,PTIPMREV        * miscellaneous charges revenue
          ADD       ONE,MISCOUNT
          MOVE      MISCOUNT,PTIPTRNN       * transaction number
.
WMITM500  MOVE      THREE,PTIPTTYP          * transaction type (3=Misc. Charge)
.
          CALL      GDTA0000                * get date/time & operator id
.
          PACK      KEY16,PTIPADMN,PTIPRTYP,PTIPTRNN
          CALL      WRPTINP1
WMITM999  RETURN
+
.******************************************************************************
.*                                  GDTA0000                                  *
.*                         Get Date/Time & Operator Id                        *
.******************************************************************************
GDTA0000  IF        ASTAT=2 | ASTAT=4
            MOVE      "Y",PTIPCURI         * Current Patient
          ELSE
            IF        ASTAT=3
              MOVE      DDATE,PTIPDDAT     * Discharged Date
              MOVE      PTDSDMDC,PTIPSMDC  * State MDC
              MOVE      PTDSDDRG,PTIPSDRG  * State DRG
            ENDIF
          ENDIF
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            OPEN      PATFN1A1,"patfn1af"
            PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
            CALL      RDFUND1
            IF        OVRCD=0
              MOVE      PTHFGRPV,PTIPGRP1    * Grouper version
            ENDIF
          ENDIF
          MOVE      ADATE,PTIPADAT         * Admission Date
          MOVE      ADOCTR,PTIPRDOC        * Referring Doctor
          MOVE      AMBS,PTIPPMBS          * Provisional MBS
.
          CALL      IBACLOCK
          PACK      PTIPCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTIPCDAT           * date record created
          MOVE      CTIMEIS,PTIPCTIM
          REP       " 0",PTIPCTIM           * time record created
          PACK      PASSCODE,PASSCODE,SP70
          MATCH     SP70,PASSCODE
          IF        !@EQUAL
            MOVE      PASSCODE,PTIPOPER     * operator id
          ELSE
            MOVE      "CMDL",PTIPOPER
          ENDIF
          IF        UGSTFLAG=1
            MOVE      "U",PTIPGSTU          * Unknown GST
          ENDIF
.
GDTA9999  RETURN
+
.*******************************************************************************
.         Sort theatre records in dtr file
.         If the patient reverts from patcat to casemix or vise versa
.         the theatre fees need to be resorted based on the first highest amount
.*******************************************************************************
CTMP0000  CALL      PTMP0000                 * create tempfile
          MOVE      ZERO,FORM6                                         *C-90226
          OPEN      SORTFILE,FNAMEZ
          OPEN      PATDTRA4,"patdtraf"
.
          MOVE      ZERO,MBSCOUNT
          MATCH     "IBAHMS70",PRGID    
          GOTO      CTMP0200 IF NOT EQUAL
.
.         Get all items that had been invoiced
.
          PACK      KEY23,AADMNO,SP70
          CALL      RDSDTRN4
CTMP0100  CALL      RDKDTRN4
          BRANCH    OVRCD,CTMP9999
.
          MATCH     AADMNO,TADMNO
          GOTO      CTMP9999 IF NOT EQUAL
.
          MATCH     "1",DTRECTYP
          GOTO      CTMP0100 IF EQUAL
.
          PACK      PMMITDAT,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",PMMITDAT
          MOVE      SP70,PMMICTYP
          GOTO      CTMP0400
.
.         Read items that haven't been invoiced
.
CTMP0200  OPEN      PMSMTIA1,"pmsmtiaf"
          PACK      KEY14,AADMNO,SP20
          CALL      RSPMMTI1
CTMP0300  CALL      RKPMMTI1
          BRANCH    OVRCD,CTMP9999
.
          MATCH     DAADMNO,PMMIVISN
          GOTO      CTMP9999 IF NOT EQUAL
.
          CALL      CONTY0000              * Check for Consumption type
          BRANCH    EXIT,CTMP0300          * Skip un-used item
.
          CALL      MTDT0000               * move fields from pmsmtiaf to dtr
          IF        TRECTYPE=2
            ADD      ONE,MBSCOUNT
          ENDIF
.
CTMP0400  MOVE      "99999999",FORM8A      * default for misc.amount   *C-90226
          MOVE      "99999",FORM5A
          MOVE      SP70,MBSCONTR
          IF        TRECTYPE=2
            MOVE      ZERO,COPTION
            MOVE      SP20,CURSESS
            MOVE      ONE,SORTDONE        * flag for Creating sort file
            MOVE      ONE,CBFLAG
            CALL      GETIT00             * get first sequence of theatre fees
            MOVE      ZERO,CBFLAG
            MOVE      ZERO,SORTDONE
.
            BRANCH    CMXFLAG,CTMP0500    * casepayment use Theatre fees to sort
.
            OPEN      PATFX1A1,"patfx1af"
            PACK      KEY6,AFUNDH,SP70
            CALL      RDPTFX11
            IF        OVRCD=0
              MATCH     "1",PTFXMFEE
              GOTO      CTMP1000 IF EQUAL    * Make Primary Based on MBS Fee
            ENDIF
.
CTMP0500    MOVE      TREBATE,FORM12A
            ADD       TPATAMTP,FORM12A
            MOVE      FORM12A,FORM8
            MOVE      "99999999",FORM8A
            SUB       FORM8,FORM8A       * Theatre fess amount
.
CTMP1000    MOVE      "99999",FORM5A
            SUB       IAMT,FORM5A         * MBS amount
          ENDIF
.
          MOVE      FORM8A,ZAMT
          MOVE      FORM5A,ZMBS
.
          MOVE      SP10,ZRECTYP
          MOVE      TRECTYPE,ZRECTYP
          PACK      ZDATE,TFCENT,TFYEAR,TFMONTH,TFDAY
          REP       " 0",ZDATE
          MOVE      TTRANSN1,ZTRNN
          MOVE      TSESSION,ZSESS
          ADD       ONE,FORM6
          MOVE      FORM6,ZUNIQ
          MOVE      SP10,ZMISC
.
.         Miscellaneous item will have index on the charge code because casemix
.         needs to check for charge from item number 
.
          IF        TRECTYPE=3
            UNPACK    SP70,ZDATE,ZSESS,ZAMT,ZMBS
            MOVE      TITEMNO,ZMISC
          ENDIF
.
          PACK      KEY39,ZRECTYP,ZDATE,ZSESS,ZAMT,ZMBS,ZMISC,ZUNIQ,SP70
          CALL      WRSORT1
.
          MATCH     "IBAHMS70",PRGID    
          GOTO      CTMP0100 IF EQUAL
          GOTO      CTMP0300
.
CTMP9999  RETURN
+
.*******************************************************************************
.         MLCOD000 - Get the Multiple procedure code amount
.*******************************************************************************
MLCOD000  OPEN      PMSMPRA1,"pmsmpraf"
          MOVE      " 0",DPMMPCNT
          PACK      KEY28,HBCOFKEY,DPMMPCNT,SP70
          CALL      RDPMMPR1
          IF        OVRCD=0
            MOVE      PMMPRAMT,TREBATE
            MOVE      PMMPPAMT,TPATAMTP
            MOVE      TREBATE,TPATAMTT
            ADD       TPATAMTP,TPATAMTT
            MOVE      PMMPRAMT,PMMIRBAT
            MOVE      PMMPPAMT,PMMIAMTP
            MOVE      TPATAMTT,PMMIAMTT
          ENDIF
MLCOD999  RETURN
+
.*******************************************************************************
.         VLUM0000 - Overnight lumpsum
.*******************************************************************************
VLUM0000  MOVE      ZERO,NOFEE
          MOVE      ZERO,PTHLLREB
          MOVE      ZERO,PTHLLPAT
          OPEN      PATHLFA1,"pathlfaf"
          PACK      KEY27,CONTRCID,ACLAIM,AFUNDH,PTHFBCAT,CMDRG
          PACK      CASMXKEY,CASMXKEY,SP70
          MATCH     SP70,CASMXKEY
          IF        !@EQUAL
            PACK      KEY27,CASMXKEY,CMDRG,SP70
          ENDIF
.
          CALL      RDPTHLFA1
          COMPARE   ZERO,OVRCD
          GOTO      VLUM9999 IF EQUAL
.
          MATCH     SP70,CASMXKEY
          GOTO      VLUM9000 IF NOT EQUAL
.
          PACK      KEY27,CONTRCID,ACLAIM,SP6,SP3,CMDRG
          CALL      RDPTHLFA1
          IF        OVRCD = 1
            CALL      DCLM0000        * Check Hospital claim code charging
            PACK      KEY27,CONTRCID,PTCNDCLM,SP6,SP3,CMDRG
            CALL      RDPTHLFA1
            BRANCH    OVRCD,VLUM9000        * no lumpsum charges
          ENDIF
          GOTO      VLUM9999
.
VLUM9000  MOVE      ONE,NOFEE
VLUM9999  RETURN
+
.*******************************************************************************
.         Set up fincode for accommodation
.*******************************************************************************
SFIN0000  PACK      FINCODE,ANSA,KEY3,SP70
          MATCH     SP3,KEY3                        * check if blank group code
          GOTO      SFIN6000 IF EQUAL
.
          PACK      KEY5,CODEFI,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,SFIN6000
.
          MATCH     ANSA,TCINDC2                    * Accommodation record ?
          GOTO      SFIN6000 IF NOT EQUAL           * Must be Misc.breakcode
.
          BRANCH    CACCFEE,SFIN1000:               * ward/bed claim
                            SFIN2000:               * ward/adm. type
                            SFIN3000:               * ward/claim/adm.type
                            SFIN4000:               * ward/adm.type/claim
                            SFIN4010                * claim
          PACK      FINCODE WITH ANSA,KEY3,TATYPE,SP70
          GOTO      SFIN9000
.
SFIN1000  PACK      FINCODE WITH ANSA,KEY3,TWARD,ACLAIM,SP70
          GOTO      SFIN9000
.
SFIN2000  PACK      FINCODE,ANSA,KEY3,TWARD,TATYPE,SP70
          GOTO      SFIN9000
.
SFIN3000  PACK      FINCODE,ANSA,KEY3,TWARD,ACLAIM,TATYPE,SP70
          GOTO      SFIN9000
.
SFIN4000  PACK      FINCODE,ANSA,KEY3,TWARD,TATYPE,ACLAIM,SP70
          GOTO      SFIN9000
.
SFIN4010  PACK      FINCODE WITH ANSA,ACLAIM,KEY3,SP70
          GOTO      SFIN9000
.
.         Miscellaneous lumpsum breakdown
.
SFIN6000  IF        PTCNMFEE = 1
            PACK      FINCODE,ANST,ACLAIM,KEY3,SP70
            MATCH     "IBAINP19",PRGID
            IF        @EQUAL
              PACK      FINCODE,ANSC,KEY3,ACLAIM,SP70
            ENDIF
          ELSE
            PACK      FINCODE,ANST,KEY3,SP70
            MATCH     "IBAINP19",PRGID
            IF        @EQUAL
              PACK      FINCODE,ANSC,KEY3,SP70
            ENDIF
          ENDIF
          GOTO      SFIN9999
.
SFIN9000  MATCH     "IBAINP19",PRGID
          IF        @EQUAL
            IF        CACCFEE=5
              UNPACK    FINCODE,KEY1,KEY3,DIM3,DIM9
              PACK      FINCODE,ANSC,DIM3,KEY3,DIM9,SP70
            ELSE
              UNPACK    FINCODE,KEY1,KEY3,DIM3,DIM9
              PACK      FINCODE,ANSC,KEY3,DIM3,DIM9,SP70
            ENDIF
          ENDIF
SFIN9999  RETURN
+
.*******************************************************************************
.         Move ptmimtiaf to patdtraf fields
.*******************************************************************************
MTDT0000  CALL      CLPATDTR
          MOVE      PMMIVISN,TADMNO
          MOVE      TADMNO,DTADMNO
          MOVE      PMMITRAN,TTRANSN1
          MOVE      PMMITRAN,DTTRANSN1
          MOVE      PMMIURNO,TDCODE
          MOVE      PMMIITEM,TITEMNO
          MOVE      PMMIDESC,TDDESC
          MOVE      PMMIDES2,PTDTDES2
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,TFCENT
          MOVE      CYEAR,TFYEAR
          MOVE      CMON,TFMONTH
          MOVE      CDAY,TFDAY
          MOVE      "DB",TTYPE
          MOVE      PMMIREFN,TRECEIPT
          MOVE      PMMIRTYP,TRECTYPE
          MOVE      PMMIRTYP,DTRECTYP
          MOVE      PMMIAMTT,TPATAMTT
          MOVE      PMMIAMTG,TPATAMTG
          MOVE      PMMIAMTH,TPATAMTH
          MOVE      PMMIAMTP,TPATAMTP
          MOVE      PMMIRBAT,TREBATE
          MOVE      PMMITDOC,TDOCTA
          MOVE      PMMIODOC,TDOCTO
          MOVE      PMMISERV,TSERVS
          MOVE      PMMISESS,TSESSION
          MOVE      PMMIMGRP,TMISGRP
          MOVE      PMMIBTCH,TBATCHN
          MOVE      PMMIGSTA,PTDTGSTA
          MOVE      PMMIGSTC,PTDTGSTC
          MOVE      PMMIGSTM,PTDTGSTM
          MOVE      PMMIUNIQ,PTDTUNIQ
          MOVE      PMMIINVN,TNINVS
          MOVE      PMMISUNQ,PTDTSUNQ
          MOVE      "0",PTDTCCU
          MOVE      PMMIINCT,PTDTCCU
          MOVE      PMMICNTR,PTDTCNTR
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMMITMNO,PTDTTMNO
          MOVE      PMMIPMBS,PTDTPMBS
MTDT9999  RETURN
+
.*******************************************************************************
.         Create a tempfile
.*******************************************************************************
PTMP0000  
...      ** removed file name generation - needs to be in INIT0000 functions
...      ** to stop extra temp files
...       CALL      TFILENAM                * Get temp file name
...       MOVE      TFILNAME,FNAMEZ
.
          CALL      KTMP0000
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEZ,CMDLINE
          APPEND    " 46 U1-1,2-9,10-11,12-19,20-24,25-33,34-39",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          OPEN      SORTFILE,FNAMEZ
          CALL      CLEZ0000      * clear file
          RETURN
+
.*******************************************************************************
.         Kill tempfile
.*******************************************************************************
KTMP0000  CLOSE     SORTFILE
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEZ,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.*******************************************************************************
.         Clear tempfile
.*******************************************************************************
CLEZ0000  MOVE      SP70,KEY39
          CALL      RDSSORT1
          CALL      RDKSORT1
          BRANCH    OVRCD,CLEZ9999
.
          PACK      KEY39,ZRECTYP,ZDATE,ZSESS,ZAMT,ZMBS,ZMISC,ZUNIQ,SP70
          CALL      DESORT1
          GOTO      CLEZ0000
.
CLEZ9999  RETURN
+ 
.*******************************************************************************
.        I/O for tempfile
.*******************************************************************************
RDKSORT1  MOVE      ZERO,OVRCD
          READKS    SORTFILE;ZRECTYP,ZDATE,ZSESS,ZAMT,ZMBS,ZMISC,ZUNIQ,ZTRNN
          GOTO      OVERCOND IF OVER
          RETURN
.
RDSSORT1  MOVE      ZERO,OVRCD
          RESET     KEY39
          READ      SORTFILE,KEY39;;
          GOTO      OVERCOND IF OVER
          RETURN
.
WRSORT1   RESET     KEY39
          WRITE     SORTFILE,KEY39;ZRECTYP,ZDATE,ZSESS,ZAMT:
                            ZMBS,ZMISC,ZUNIQ,ZTRNN
          GOTO      OVERCOND IF OVER
          RETURN
+
DESORT1   MOVE      ZERO,OVRCD
          RESET     KEY39
          DELETE    SORTFILE,KEY39
          RETURN
.
.         The To date for this record is the next From date
.
CNTACCR   MOVE      TDAY1,FDAY1
          MOVE      TMON1,FMON1
          MOVE      TYEAR1,FYEAR1
          MOVE      TCENT1,FCENT1
          PACK      IDATEF WITH FCENT1,FYEAR1,FMON1,FDAY1
          REP       " 0",IDATEF
          RESET     IDATEF
.
          PACK      IDATET WITH TCENT,TYEAR,TMON,TDAY
          REP      " 0",IDATET
          RESET    IDATET
          RETURN
+
.*******************************************************************************
.
WRESI000  PACK      TDDESC,SP20,SP20
          PACK      KEY5,ANSN,ANSH,SPTTRNHA
          CALL      RDCODE1
          IF        OVRCD=0
            PACK      TDDESC,TDESC,SP20
          ENDIF
.
          PACK      KEY4,FCENT1,FYEAR1
          REP       " 0",KEY4
          MOVE      FMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;"<tr><td>",FDAY1,SP1,MTHNAM3,SP1,KEY4;
.
          PACK      KEY4,TCENT1,TYEAR1
          REP       " 0",KEY4
          MOVE      TMON1,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                  NSEP,NOCT,NNOV,NDEC
          WRITE     HTMLFILE;" to ",TDAY1,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td>",NODAYS,SP1,TDDESC,"</td>";
          MOVE      ADPRATE,FORM62
          IF        IBCNUGST=2
            WRITE     HTMLFILE;"<td>",FORM62,"</td>";
            MULT      NODAYS,FORM62
            WRITE     HTMLFILE;"<td>",FORM62,"</td>";

            MOVE      FORM62,GSTWORK
            MULT      GSTPCEN,GSTWORK
            DIV       "100.00",GSTWORK
            MOVE      GSTWORK,GSTAMNT
            WRITE     HTMLFILE;"<td>",GSTAMNT,"</td>";

            ADD       GSTAMNT,FORM62
            WRITE     HTMLFILE;"<td>",FORM62,"</td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM62,"</td>";
            MULT      NODAYS,FORM62
            WRITE     HTMLFILE;"<td>",FORM62,"</td></tr>";
          ENDIF
.
          INC       PATINPIO/INC
+
.******************************************* Start of Addition         *I-90303
.*******************************************************************************
.         Create misc item tempfile
.*******************************************************************************
PT2P0000  
...      ** removed file name generation - needs to be in INIT0000 functions
...      ** to stop extra temp files
...       CALL      TFILENAM                * Get temp file name
...       MOVE      TFILNAME,FNAMEY
.
          CALL      KT2P0000
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAMEY,CMDLINE
          APPEND    " 50 U1-1,2-9,10-15",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPMSCFL,FNAMEY         * open file pointer
          CALL      CLEY0000       * Clear tempfile
          RETURN
+
.*******************************************************************************
.         Kill misc item tempfile
.*******************************************************************************
KT2P0000  CLOSE     TMPMSCFL
.
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    FNAMEY,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          RETURN
+
.*******************************************************************************
.         Clear tempfile
.*******************************************************************************
CLEY0000  MOVE      SP70,KEY15
          CALL      RDSSRTM1
          CALL      RDKSRTM1
          BRANCH    OVRCD,CLEY9999
.
          PACK      KEY15,TMPRECTY,TMPDTRDT,TMPZUNIQ,SP70
          CALL      DESRTM1
          GOTO      CLEY0000
.
CLEY9999  RETURN
+

.*******************************************************************************
.        I/O for misc item tempfile
.*******************************************************************************
RDKSRTM1  MOVE      ZERO,OVRCD
          READKS    TMPMSCFL;TMPRECTY,TMPDTRDT,TMPZUNIQ:
                             TMPTRNSC,TMPREFNC,TMPAMNTP,TMPREBAT,TMPMNINV
          GOTO      OVERCOND IF OVER
          RETURN
.
RDSSRTM1  MOVE      ZERO,OVRCD
          RESET     KEY15
          READ      TMPMSCFL,KEY15;;
          GOTO      OVERCOND IF OVER
          RETURN
.
WRSRTM1   RESET     KEY15
          WRITE     TMPMSCFL,KEY15;TMPRECTY,TMPDTRDT,TMPZUNIQ:
                                   TMPTRNSC,TMPREFNC,TMPAMNTP,TMPREBAT,TMPMNINV
          GOTO      OVERCOND IF OVER
          RETURN
.
DESRTM1   MOVE      ZERO,OVRCD
          RESET     KEY15
          DELETE    TMPMSCFL,KEY15
          RETURN
.
.*******************************************************************************
.         Calculate Mechanical Ventilation Days for Casemix patient
.*******************************************************************************
CMVDY000  MOVE      ZERO,MVDAYS                  * set mv days to zero
          MOVE      ZERO,MVBFLAG                 * set mv billing flag to "no"
.
          COMPARE   ZERO,AINVPRT
          GOTO      CMVDY020 IF EQUAL
.
          CALL      CHKACCM0           * Check if accommodation has been charged
          BRANCH    EXIT,CMVDY999
.
CMVDY020  MOVE      AADMNO,KEY8
          PACK      KEY22,AADMNO,SP70
          CALL      RDSDTRN1
CMVDY100  CALL      RDKDTRN1                     * check dtr for mv billing rec
          BRANCH    OVRCD,CMVDY200
.
          MATCH     AADMNO,TADMNO  
          GOTO      CMVDY200 IF NOT EQUAL
.
          MATCH     "1",PTDTCRST
          GOTO      CMVDY100 IF EQUAL            * Fully Credit note
.
          COMPARE   ONE,PTDTEPSD                 * mechv already billed?
          GOTO      CMVDY999 IF EQUAL
.
          GOTO      CMVDY100
.
CMVDY200  PACK      KEY17,AFUNDH,PMVXMHOS,ADATE
          CALL      PATFN2RD                     * read health fund file
          BRANCH    OVRCD,CMVDY999
.
          BRANCH    PTFNBMVH,CMVDY240,CMVDY220   * MV Billing EPM/CWO
          GOTO      CMVDY999
.
CMVDY220  CALL      CWOP0000                     * CWO
          BRANCH    EXIT,CMVDY999
.
.         Check if there is a record in MV details file
.
CMVDY240  MOVE      AADMNO,DAADMNO
          PACK      KEY27,DAADMNO,SP70
          CALL      RSPTVEN1
CMVDY300  CALL      RKPTVEN1
          BRANCH    OVRCD,CMVDY400
.
          MATCH     DAADMNO,PTVEVISN
          GOTO      CMVDY400 IF NOT EQUAL
.
          MOVE      "VE",KEY2
          PACK      KEY5,KEY2,PTVEVTYP
          CALL      RDCODE1
          BRANCH    OVRCD,CMVDY300
          MATCH     "2",TCINDC1
          GOTO      CMVDY300 IF NOT EQUAL      * Not Mechanical Ventilation
.
.         If the parameter for 'Using MV details to collect Non-ICU' is set,
.         use the Start of MV from the MV details with Initiation site
.         NOT in WARD
.
.         note: Initiation Site Catg II, Indc1=W for Ward (Non-ICU)
.
          MATCH     "1",PTCNMVHC         * Using MV details to collect Non-ICU
          IF        @EQUAL
            MATCH     SP70,PTVEISIT          * Check Initiation Site
            IF        !@EQUAL
              PACK      KEY5,ANSI,ANSI,PTVEISIT
              CALL      RDCODE1
              IF        OVRCD=0
                CMATCH    "W",TCINDC1            * Ward
                GOTO      CMVDY300 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PTVESDAT,MVENSDAT        * Using MV Details file
          CALL      CVEN0000                 * get MV hours from MV details file
.
          GOTO      CMVDY600
.
CMVDY400  OPEN      PATICUA1,"paticuaf"
          PACK      KEY8,AADMNO                  * Any mv hours for this
          CALL      RDPTICU1                     * admission?
          BRANCH    OVRCD,CMVDY999
.
          MATCH     "1",PTCNMVHC         * Using MV details to collect Non-ICU
          IF        @EQUAL
            PROC      CALCMVHR
            SUB       MVENHOUR,PTICUMEC
            IF        PTICUMEC<0
              MOVE      ZERO,PTICUMEC
            ENDIF
          ENDIF
.
CMVDY600  COMPARE   ZERO,PTICUMEC                * MV hours zero ?
          GOTO      CMVDY999 IF EQUAL            * yes - no - mv billing
.
          ASSIGN    (PTICUMEC%24),EXTRAHRS       * remainder of extra hours
          ASSIGN    (PTICUMEC-EXTRAHRS),MVHOURS
          ASSIGN    (MVHOURS/24),MVDAYS          * convert mv hours to days
          IF        EXTRAHRS >= PTFNHRMV
            ADD       ONE,MVDAYS                 * add extra day to mv days
          ENDIF
          MOVE      PTFNMVRT,MVBRATE             * save mv daily rate
          MOVE      ONE,MVBFLAG                  * set mv billing flag to "yes"
.
          MATCH     SP70,MVENSDAT                * Using MV Details file
          IF        !@EQUAL
            MOVE      MVENSDAT,DATFIELD
            ADD       MVDAYS,DATFIELD
            MOVE      DATFIELD,MVENEDAT          * set End of MV date
          ENDIF
.
CMVDY999  RETURN
+
.*******************************************************************************
.         Payment Model CWO
.*******************************************************************************
CWOP0000  MOVE      ZERO,OVRCD               * assume file exists
          TRAP      OVERCOND IF IO           * trap for error openning file
          OPEN      PMSHATA1,"pmshataf"      * open Hospital Attribute file
          TRAPCLR   IO
          BRANCH    OVRCD,CWOP9000           * open failed
.
          OPEN      PATPGRA1,"patpgraf"
          MOVE      ZERO,EXIT
          UNPACK    SP70,PTHFGRPV,DIM4
          MATCH     "1",PTCNDGED
          IF        @EQUAL
.
.           Determine DRG Version using NEW 'Effective DRG' table

            CALL      GHFDRG00              * Get Health Fund DRG version
            IF        EXIT=0
              MOVE      ONE,PTPGEPNO
              PACK      KEY13,AADMNO,PTPGEPNO,KEY3,SP70
               CALL      RDPTPGR1
               IF        OVRCD=0
                PACK      DIM4,PTPGNDRG,SP70
              ENDIF
            ELSE
              PACK    KEY8,AADMNO,SP70
              CALL    RDDSCH1
              IF      OVRCD=0
                PACK    DIM4,PTDSDDRG,SP70
              ENDIF
            ENDIF
          ELSE
            PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
            CALL      RDFUND1       * Read a health fund file record
            MOVE      ONE,PTPGEPNO
            PACK      KEY13,AADMNO,PTPGEPNO,PTHFGRPV,SP70
            CALL      RDPTPGR1             * Read Grouper Details
            IF        OVRCD = 0
              PACK      DIM4,PTPGNDRG,SP70
            ELSE
              PACK    KEY8,AADMNO,SP70
              CALL    RDDSCH1
              IF      OVRCD = 0
                PACK    DIM4,PTDSDDRG,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "001",PMHTTYPE        * CWO Attribute type
          PACK      PMHTKVAL,AFUNDH,DIM4,SP70
          PACK      KEY39,PMVXMHOS,PMHTTYPE,PMHTKVAL,ADATE,SP70
          CALL      PMSHATRD
          IF        EXIT=1
            IF        IBCNMHOS=1 
              MATCH     SP70,PMVXMHOS       * try with blank/All Hospital
              IF        !@EQUAL
                MOVE      "001",PMHTTYPE    * CWO Attribute type
                PACK      PMHTKVAL,AFUNDH,DIM4,SP70
                PACK      KEY39,SP3,PMHTTYPE,PMHTKVAL,ADATE,SP70
                CALL      PMSHATRD
              ENDIF
            ENDIF
          ENDIF
          GOTO      CWOP9999
.
CWOP9000  MOVE      ONE,EXIT
CWOP9999  RETURN
+
.*******************************************************************************
.         Get MV hours from Ventilation details file
.*******************************************************************************
CVEN0000  MOVE      ZERO,PTICUMEC
CVEN1000  ADD       PTVEHOUR,PTICUMEC          * MV Hours
.
CVEN2000  CALL      RKPTVEN1
          BRANCH    OVRCD,CVEN9999
.
          MATCH     DAADMNO,PTVEVISN
          GOTO      CVEN9999 IF NOT EQUAL
.
          MOVE      "VE",KEY2
          PACK      KEY5,KEY2,PTVEVTYP
          CALL      RDCODE1
          BRANCH    OVRCD,CVEN2000
          MATCH     "2",TCINDC1
          GOTO      CVEN2000 IF NOT EQUAL      * Not Mechanical Ventilation
.
.         If the parameter for 'Using MV details to collect Non-ICU' is set,
.         exclude MV hours with the Initiation site from WARD
.
          MATCH     "1",PTCNMVHC         * Using MV details to collect Non-ICU
          IF        @EQUAL
            MATCH     SP70,PTVEISIT          * Check Initiation Site
            IF        !@EQUAL
              PACK      KEY5,ANSI,ANSI,PTVEISIT
              CALL      RDCODE1
              IF        OVRCD=0
                CMATCH    "W",TCINDC1            * Ward
                GOTO      CVEN2000 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      CVEN1000
.
CVEN9999  RETURN
+
.*******************************************************************************
.         Store the ICU and Non ICU period in tempfile
.*******************************************************************************
CCIN0000  MOVE      SP1,INTCTYPE               * 1 for ICU period
          MOVE      SP70,INTCFDAT              * From date
          MOVE      SP70,INTCTDAT              * To date
          MOVE      ZERO,INTCDAYS              * Days in period
          MOVE      ZERO,INTCNCHR              * No charges days
          MOVE      SP70,INTCNBDT              * Start date for No Billing
          MOVE      SP70,DEFINDIC
          MOVE      SP70,FROMDATE
          MOVE      ZERO,EXIT
.
          CALL      CRMV0000                   * Create MV tempfile
.
.         If there is no record in Ventilation details, use the ICU LEVEL A
.
          MATCH     SP70,MVENSDAT
          GOTO      CCIN0900 IF EQUAL        * No Mechanical Ventilation details
.
          CALL      MVEN0000                 * Store the MV period in tempfile
          GOTO      CCIN9999
.
.         Use dates from ICU bed type
.
CCIN0900  UNPACK    SP70,DIM1,DIM8,SDIM30
          PACK      KEY30 WITH AADMNO,SP70
          CALL      RDSTRAN2
CCIN1000  CALL      RDKTRAN2
          BRANCH    OVRCD OF CCIN4000
.
          MATCH     TADMN,AADMNO
          GOTO      CCIN4000 IF NOT EQUAL
.
.         Get the last transfer of the date
.
          MOVE      "0",DIM1
          MATCH     "C",TMOVE
          GOTO      CCIN1800 IF NOT EQUAL
.
.         Check if next record is another change record for the same date
.
          MOVE      TDATE,DIM8
          PACK      SDIM30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      RDKTRAN2
          BRANCH    OVRCD,CCIN1600
.
          MATCH     TADMN,AADMNO
          GOTO      CCIN1600 IF NOT EQUAL
          MATCH     TDATE,DIM8
          GOTO      CCIN1600 IF NOT EQUAL
          MATCH     "C",TMOVE
          GOTO      CCIN1600 IF NOT EQUAL
          MOVE      "1",DIM1                 * next record has same date
.
CCIN1600  MOVE      SDIM30,KEY30
          CALL      RDTRAN2                  * Reposition
          BRANCH    OVRCD,CCIN1000
          MATCH     "1",DIM1
          GOTO      CCIN1000 IF EQUAL        * ignore this record
.
CCIN1800  MATCH     "L",TMOVE
          GOTO      CCIN5000 IF EQUAL
          MATCH     "D",TMOVE
          GOTO      CCIN4200 IF EQUAL
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*228,PTCNHCCC
          BRANCH    PTCNHCCC,CCIN1900
.
.         Using admission type for CCU/ICU/NNU
.
          MATCH     SP3,STATYPE
          GOTO      CCIN3000 IF EQUAL              * Blank admission type
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CCIN3000
          GOTO      CCIN1920
.
CCIN1900  MATCH     SP70,TRBTYP
          GOTO      CCIN3000 IF EQUAL              * Blank bed type
          PACK      KEY5,ANSB,ANST,TRBTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CCIN3000
.
          MATCH     "1",TCINDC2                    * ICU Level A bed type
          GOTO      CCIN3000 IF NOT EQUAL
          GOTO      CCIN2000
.
CCIN1920  MATCH     "1",TCINDC9
          GOTO      CCIN2000 IF EQUAL              * Intensive care
          MATCH     "3",TCINDC9
          GOTO      CCIN3000 IF NOT EQUAL          * Critical Care
.
.         Transfer to an ICU bed
.
CCIN2000  MOVE      "2",INTCTYPE                   * ICU bed
          GOTO      CCIN3200
.
.         Transfer to non ICU bed
.
CCIN3000  MOVE      "1",INTCTYPE                   * Non-ICU bed
.
CCIN3200  MATCH     INTCTYPE,DEFINDIC
          GOTO      CCIN1000 IF EQUAL
.
.         Previous bed transfer must be from an ICU bed
.
          MATCH     SP70,FROMDATE
          IF        @EQUAL
            MOVE      TDATE,FROMDATE                 * start date
            MOVE      INTCTYPE,DEFINDIC
            GOTO      CCIN1000
          ENDIF
          GOTO      CCIN7000
.
CCIN4000  PACK      TDATE,CCC,CYY,CMM,CDD          * set to current date
          REP       " 0",TDATE
.
CCIN4200  MOVE      ONE,EXIT
.
.         Calculate length of stays in ICU
.
CCIN5000  MATCH     SP70,FROMDATE
          GOTO      CCIN9000 IF EQUAL
.
CCIN7000  MOVE      ZERO,FORM5A
          DAYSEP    FROMDATE,TDATE,FORM5A
.
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,FORM5A               * set one day for daycase
            ENDIF
          ENDIF
.
          MOVE      FROMDATE,INTCFDAT
          MOVE      TDATE,INTCTDAT
.
          COMPARE   ZERO,FORM5A
          GOTO      CCIN8000 IF EQUAL
.
          MOVE      INTCTYPE,KEY1           * Save bed type indicator
          MOVE      DEFINDIC,INTCTYPE
          MOVE      FORM5A,INTCDAYS
          PACK      KEY9,INTCTYPE,INTCTDAT,SP70
          CALL      RATMMVA1
          IF        OVRCD=1
            CALL      WRTMMVA1
          ENDIF
          MOVE      KEY1,INTCTYPE
.
CCIN8000  BRANCH    EXIT,CCIN9999
          MATCH     "L",TMOVE
          IF        @EQUAL
            MOVE      SP70,FROMDATE
            MOVE      SP70,DEFINDIC
            GOTO      CCIN1000
          ENDIF
.
CCIN9000  MOVE      INTCTDAT,FROMDATE
          MOVE      INTCTYPE,DEFINDIC
          BRANCH    EXIT,CCIN9999
          GOTO      CCIN1000
.
CCIN9999  RETURN
+
.*******************************************************************************
.         Store the MV period in tempfile
.*******************************************************************************
MVEN0000  MOVE      MVENSDAT,FROMDATE
          MATCH     MVENSDAT,ADATE
          GOTO      MVEN6000 IF EQUAL          * MV from Admission
.
.         Set up NON MV period from Admission date to the Start of MV
.
          MOVE      "1",INTCTYPE               * Not MV period
          UNPACK    SP70,INTCTDAT,INTCFDAT,INTCNBDT
.
          MOVE      ADATE,FROMDATE
          MOVE      MVENSDAT,TODATE
.
          MOVE      FROMDATE,INTCFDAT
          MOVE      TODATE,INTCTDAT
          MOVE      ZERO,INTCDAYS
.
          MOVE      ZERO,FORM5A
          DAYSEP    FROMDATE,TODATE,FORM5A
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      ONE,FORM5A               * set one day for daycase
            ENDIF
          ENDIF
          MOVE      FORM5A,INTCDAYS
          MOVE      ZERO,INTCNCHR
          PACK      KEY9,INTCTYPE,INTCTDAT,SP70
          CALL      RATMMVA1
          IF        OVRCD=1
            CALL      WRTMMVA1
          ENDIF
.
.         Set MV period from the Start of MV
.
MVEN6000  MOVE      "2",INTCTYPE                * MV period
          UNPACK    SP70,INTCTDAT,INTCFDAT,INTCNBDT
.
          MOVE      MVENSDAT,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD
          REP       " 0",TODATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE              * use discharged date
          ENDIF
.
          MOVE      FROMDATE,INTCFDAT
          MOVE      FROMDATE,DATFIELD
          ADD       MVDAYS,DATFIELD             * add MV days to the start date
          PACK      KEY8,DATFIELD,SP70
.
.         Check if End of MV after Discharged date
.
          MATCH     KEY8,TODATE
          IF        @LESS
            MOVE      TODATE,INTCTDAT
          ELSE
            MOVE      KEY8,INTCTDAT           * End date of MV
          ENDIF
.
          MOVE      ZERO,FORM5A
          DAYSEP    INTCFDAT,INTCTDAT,FORM5A
          MOVE      FORM5A,INTCDAYS
.
          MOVE      ZERO,INTCNCHR
          MOVE      INTCFDAT,MVBDATE
          PACK      KEY9,INTCTYPE,INTCTDAT,SP70
          CALL      RATMMVA1
          IF        OVRCD=1
            CALL      WRTMMVA1
          ENDIF
.
.         Check if MV end date is before discharged date
.
          MATCH     TODATE,INTCTDAT
          GOTO      MVEN9999 IF EQUAL
.
.         NON MV period from the End date of MV to Discharged date
.
          MOVE      "1",INTCTYPE               * Not MV period
          MOVE      INTCTDAT,INTCFDAT
          MOVE      TODATE,INTCTDAT
.
          MOVE      ZERO,FORM5A
          DAYSEP    INTCFDAT,INTCTDAT,FORM5A
          MOVE      FORM5A,INTCDAYS
.
          MOVE      ZERO,INTCNCHR
          PACK      KEY9,INTCTYPE,INTCTDAT,SP70
          CALL      RATMMVA1
          IF        OVRCD=1
            CALL      WRTMMVA1
          ENDIF
.
MVEN9999  RETURN
+
.*******************************************************************************
.         Setup Mechanical ventilation period
.*******************************************************************************
SMVD0000  MOVE      MVDAYS,FORM5A           * Days in MV
          PACK      MVBDATE,MVBDATE,SP70
.
          PACK      KEY9,Z70
          CALL      RSTMMVA1
SMVD1000  CALL      RPTMMVA1
          BRANCH    OVRCD,SMVD9000
.
          COMPARE   FORM5A,INTCDAYS
          GOTO      SMVD2000 IF LESS
.
          MOVE      FORM5A,INTCNCHR           * Hours for MV
.
          MOVE      INTCTDAT,MVBDATE
          SUB       FORM5A,MVBDATE
          MATCH     IDATEF,MVBDATE
          GOTO      SMVD9200 IF LESS          * MV date prior invoice fromdate
.
          MOVE      MVBDATE,INTCNBDT          * Start date for MV
.         
          CALL      UPTMMVA1
          GOTO      SMVD9999
.
SMVD2000  SUB       INTCDAYS,FORM5A
          MOVE      INTCDAYS,INTCNCHR         * Hours for MV
          MOVE      INTCFDAT,INTCNBDT         * Start date for MV
          CALL      UPTMMVA1
          GOTO      SMVD1000
.
SMVD9000  MATCH     SP70,MVBDATE
          GOTO      SMVD9200 IF EQUAL
          MATCH     IDATEF,MVBDATE
          GOTO      SMVD9999 IF NOT LESS
.
SMVD9200  MOVE      IDATEF,MVBDATE
SMVD9999  RETURN
+
.*******************************************************************************
.         Setup Mechanical ventilation period
.*******************************************************************************
SVVD0000  MOVE      MVDAYS,FORM5A           * Days in MV
          PACK      MVBDATE,MVBDATE,SP70
          MOVE      "2",KEY1
          PACK      KEY9,KEY1,SP70
          CALL      RSTMMVA1
SVVD1000  CALL      RKTMMVA1
          BRANCH    OVRCD,SVVD9000
          MATCH     KEY1,INTCTYPE
          GOTO      SVVD9000 IF NOT EQUAL
.
          COMPARE   FORM5A,INTCDAYS
          GOTO      SVVD2000 IF LESS
.
          MOVE      FORM5A,INTCNCHR           * Hours for MV
.
          MOVE      INTCTDAT,MVBDATE
          SUB       FORM5A,MVBDATE
          MATCH     IDATEF,MVBDATE
          GOTO      SVVD9200 IF LESS          * MV date prior invoice fromdate
.
          MOVE      MVBDATE,INTCNBDT          * Start date for MV
.
          CALL      UPTMMVA1
          GOTO      SVVD9999
.
SVVD2000  SUB       INTCDAYS,FORM5A
          MOVE      INTCDAYS,INTCNCHR         * Hours for MV
          MOVE      INTCFDAT,INTCNBDT         * Start date for MV
          CALL      UPTMMVA1
          GOTO      SVVD1000
.
SVVD9000  MATCH     SP70,MVBDATE
          GOTO      SVVD9200 IF EQUAL
          MATCH     IDATEF,MVBDATE
          GOTO      SVVD9999 IF NOT LESS
.
SVVD9200  MOVE      IDATEF,MVBDATE
SVVD9999  RETURN
+
.*******************************************************************************
.         Check for Mechanical Ventilation period
.*******************************************************************************
CKMV0000  MOVE      ZERO,MVPFLAG
          COMPARE   ONE,MVBFLAG
          GOTO      CKMV9999 IF NOT EQUAL
.
          PACK      KEY17,IDATEF,SP70
          CALL      RSTMMVA2
CKMV1000  CALL      RKTMMVA2
          BRANCH    OVRCD,CKMV9999
.
.         Check if there is any Mechanical Ventilation days during the 
.         accommodation period
.
          COMPARE   ZERO,INTCNCHR
          GOTO      CKMV9999 IF EQUAL
.
          MOVE      ONE,MVPFLAG
          MOVE      INTCNBDT,STMVDATE
          MOVE      INTCTDAT,ENMVDATE
.
CKMV9999  RETURN
+
.*******************************************************************************
.         Populate pmsmtiaf fields with an mv billing misc. charge record
.*******************************************************************************
PMVBR000  READ      CONTROLF,HUND10;*230,PTCNMVBC
          MOVE      PTCNMVBC,PMMIITEM   * default billing code
.
          PACK      KEY17,AFUNDH,PMVXMHOS,ADATE
          CALL      PATFN2RD                     * read health fund file
          IF        OVRCD=0
            MOVE      PTFNMVBC,PMMIITEM
          ENDIF
.
          MOVE      PMMITDAT,MISCDATE
          MOVE      PMMIITEM,TITEMNO
          CALL      GMIS0000            * Get the new misc. charge for mv
          MOVE      " 3",PMMISYST
          MOVE      MVBDATE,PMMITDAT
          MOVE      PURNO,PMMIURNO
          MOVE      MITMTYP,PMMIRTYP
          MOVE      MMSCGRP,PMMIMGRP
          MOVE      MNINV,PMMIINVN
          MOVE      ZERO,PMMIAMTG
          MOVE      ZERO,PMMIAMTH
          MOVE      SP70,PMMIREFN
          MOVE      SP70,PMMIUNIQ
.
          ASSIGN    (MVDAYS*MVBRATE),PMMIAMTT   ***************
.         MOVE      MVBRATE,PMMIAMTP           ***************
.         MOVE      ZERO,PMMIRBAT               ***************
.
          MOVE      MVBRATE,PMMIRBAT            * Rebate portion
          MOVE      ZERO,PMMIAMTP               * Patient portion
.
          MOVE      MDESC,PMMIDESC
          PACK      PMMIDES2,SP70
.
          PACK      PMMIBTCH,SP70
          MOVE      SP6,PMMITDOC
          MOVE      SP6,PMMIODOC
.         MOVE      ONE,PMMISERV
          MOVE      MVDAYS,PMMISERV
.
          MOVE      SP6,PMMISESS
          MOVE      ZERO,PMMIGSTA           * GST applicable
          MOVE      SP10,PMMIGSTC           * GST code
          MOVE      ZERO,PMMIGSTM           * GST Amount
          IF        IBCNUGST=2
            MOVE      PTMCGSTA,PMMIGSTA
            MOVE      PTMCGSTC,PMMIGSTC
          ENDIF
          MOVE      "1",PMMIMVBR            * mv billing record
          PACK      PMMISPAR,SP70
          IF        WEBFLAG=1
            MOVE      WBSEUID,PMMIWUSR
          ELSE
            MOVE      SECUSER,PMMIWUSR
          ENDIF
          MOVE      "     +",PMMITRAN       * dummy transaction number
          MOVE      AADMNO,KEY8
          MOVE      AADMNO,PMMIVISN
PMVBR999  RETURN
+
.*******************************************************************************
.         Write to pmsmtiaf fields with an mv billing misc. charge record
.*******************************************************************************
WMVBR000  MOVE      TADMNO,KEY8
.
.         Get the next transaction number
.
WMVBR100  CALL      TRVISA1
          MOVE      PVITRAN,PMMITRAN
.
          PACK      KEY14,TADMNO,PMMITRAN
          CALL      RAPMMTI1
          COMPARE   ZERO,OVRCD
          GOTO      WMVBR100 IF EQUAL
.
          PACK      KEY14,TADMNO,PMMITRAN
          UNPACK    SP70,PMMICNTR,PMMISUNQ
          MOVE      SP70,PMMIINCT
          MOVE      SP70,PMMISUBN
          MOVE      SP70,PMMIEDAD
          MOVE      SP70,PMMISVTM
          MOVE      SP70,PMMIDUPD
          MOVE      SP70,PMMITUPD
          MOVE      SP70,PMMIWUSR
          PACK      PMMIDTCR,CCC,CYY,CMM,CDD
          REP       " 0",PMMIDTCR
          CALL      IBACLOCK
          MOVE      CTIMEIS,PMMITMCR
          MOVE      PASSCODE,PMMIIDCR
          MOVE      SP70,PMMITMNO
          MOVE      SP70,PMMIPMBS
          MOVE      SP70,PMMIRBRS
          MOVE      SP70,PMMICTYP
          PACK      PMMIACOI,SP70       * After Care Override Indicator
          PACK      PMMIDSOV,SP70       * Duplicate Service Override
          PACK      PMMISTXT,SP70       * Service Text
          PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
          PACK      PMMIMPOV,SP70       * Multi Procedure Override
          PACK      PMMINMPT,SP70       * Number of Patients Seen
          PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
          PACK      PMMITDUR,SP70       * Time Duration (Mins)
          PACK      PMMISPAR,SP70,SP70
          CALL      WRPMMTI1
WMVBR999  RETURN
+
.******************************************************************************
.* GJHM0000 : Get MBS/Misc.item/Doctor charges for Johns Hopkins
.******************************************************************************
GJHM0000  MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
          MOVE      ZERO,TOTDISC
          MOVE      ZERO,DOCTTOT
          MOVE      SP70,SAVGCOD
          MOVE      SP70,SAVADOC
          MOVE      TOTGST,GSTAMNT
          MOVE      ZERO,SAVRTYPE
          MOVE      ZERO,DRCHRAMT
          MOVE      ZERO,DRGSTAMT
          MOVE      ZERO,BFFLAG
.
          MOVE      ZERO,COMPFLG
          MOVE      AADMNO,TADMNO
          MOVE      AADMNO,DTADMNO
.
          COMPARE   ZERO,CINV1ST
          GOTO      GJHM0100 IF EQUAL
.
.         Is this the first day of the period
.
          MATCH     SP70,BACKDATE
          IF        @EQUAL
            MOVE      PINVDTE,BACKDATE
            REP       " 0",BACKDATE
          ENDIF
.
          MOVE      BACKDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD
          BRANCH    EXIT,GJHM0100
.
          UNPACK    DRGFDTE,D8DATE            * first day of period
          REP       " 0",D8DATE
.
          MATCH     D8DATE,BACKDATE
          GOTO      GJHM0100 IF NOT EQUAL
.
.         Is this a day case
.
.         MATCH     ADATE,DDATE
.         GOTO      GJHM0080 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      GJHM0080 IF NOT EQUAL
.
.         If discharged on the first day of period, include all items
.         Only day cases for the invoice date are to stay the same
.
          MATCH     BACKDATE,DDATE
          GOTO      GJHM0100 IF EQUAL
.
GJHM0080  MOVE      ONE,BFFLAG
.
.         If this is for Estimate Invoice, it's using pmsmteaf file
.
GJHM0100  BRANCH    ESTFLAG,GJHM0200
          OPEN      PMSMTIA4,"pmsmtiaf"
.
GJHM0200  PACK      KEY18,AADMNO,TWO,SP20
          CALL      RSPMMTI4
GJHM1000  CALL      RKPMMTI4
          BRANCH    OVRCD,GJHM8200
.
          MATCH     DTADMNO,PMMIVISN
          GOTO      GJHM8200 IF NOT EQUAL
.
          MATCH     PMMITDAT,BACKDATE      * check with the Invoice Todate
          GOTO      GJHM1000 IF LESS
.
.         If it's first date of the period, do not include item/doc charge
.         for the first date of period
.
          IF        BFFLAG=1
            MATCH     PMMITDAT,D8DATE
            GOTO      GJHM1000 IF EQUAL
          ENDIF
.
.         If this is for Estimate invoice, check user id
.
          IF        ESTFLAG=1
            MATCH     WBSEUID,PMMIWUSR        * WEB User ID
            GOTO      GJHM1000 IF NOT EQUAL
          ENDIF
.
          MOVE      PMMITRAN,SAVTRNNO
          CALL      MTDT0000               * Move pmsitm to dtraf fields
.
          MOVE      ZERO,LINEGST
          COMPARE   TWO,TRECTYPE
          GOTO      GJHM5100 IF EQUAL      * MBS item
          COMPARE   SEVEN,TRECTYPE 
          GOTO      GJHM5100 IF EQUAL      * Discount
.
          COMPARE   ZERO,COMPFLG
          GOTO      GJHM3000 IF EQUAL      * first record
.
.         Misc.Charge and Doctor charges are grouped by category FN
.
          MATCH     SP70,PMMIMGRP
          GOTO      GJHM3000 IF EQUAL      * No group code
.
          MATCH     SAVGCOD,PMMIMGRP
          GOTO      GJHM3000 IF EQUAL
.
.         Display/Print total item for the group
.
          MOVE      SP70,TDESC
          CALL      IGRP0000             * Get item group description
          ADD       MISCTOT,TOTAMNT
.
          BRANCH    PROGFLAG,GJHM3000,GJHM1200,GJHM1400,GJHM3000,GJHM1400
          GOTO      GJHM3000
.
GJHM1200  MOVE      MISCTOT,FORM12P2
          CALL      DSIG0000              * Display item group
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
          GOTO      GJHM3000
.
.         Print the Item category description
.
GJHM1400  CALL      PRIG0000              * Print item group
.
.         Processing Misc.item
.----------------------------------------------------------------------------
.
GJHM3000  CALL      GMIS0000             * recalculate misc.
          BRANCH    EXIT,GJHM5000
.
          MATCH     "Y",PTMCKREB
          GOTO      GJHM5000 IF EQUAL    * manual change for rebate
.
          MOVE      MPATPOR,FORM12P2
          ADD       MHFPOR,FORM12P2
.
.        Check if it's a Front end deductable item, only if the sum of
.        HF and patient portion is zero and at least one of them is not zero.
.
          IF        FORM12P2=0 & MPATPOR<>0
            GOTO      GJHM5000           * front end deductable - don't change
          ENDIF
.
.         Check if this item was entered manually.
.
          IF        MPATPOR=0 & MHFPOR=0
            GOTO      GJHM5000           *  do not change the amount
          ENDIF
.
          MOVE      MPATPOR,TPATAMTP
          MOVE      MHFPOR,TREBATE
.
.         Check for multiple items
.
          MOVE      TPATAMTP,TPATAMTT
          ADD       TREBATE,TPATAMTT
          IF        TSERVS<>0
            MULT      TSERVS,TPATAMTT
          ENDIF
.
          MOVE      TPATAMTP,PMMIAMTP
          MOVE      TREBATE,PMMIRBAT
.
GJHM5000  IF        PROGFLAG=3 | PROGFLAG=5
.
.         Calculate GST for doctor charges & misc.charge
.
            IF        TRECTYPE=3 | TRECTYPE=4
              CALL      AGST0000             * Get GST rate - use Acc.GST
              MOVE      TPATAMTT,LINEGST
              MULT      IBGEAMNT,LINEGST     * GST amount
              DIV       "100.00",LINEGST     * Divide by 100 to get wanted fig.
            ENDIF
            IF        PROGFLAG=3
              PACK      PMMIDUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMMIDUPD
              CALL      IBACLOCK
              MOVE      CTIMEIS,PMMITUPD
              MOVE      PASSCODE,PMMIWUSR
              CALL      UPPMMTI4               * update new item amount
            ENDIF
          ENDIF
.
GJHM5100  IF        TRECTYPE=7
            MOVE      TPATAMTT,LINETOT       * discount 
            MOVE      TPATAMTT,TPATAMTP
            GOTO      GJHM5300
          ENDIF
          MOVE      TPATAMTT,LINETOT
.
.         Save group and record type for Misc.and Doctor charges record
.
          IF        TRECTYPE=3 | TRECTYPE=4
            MOVE      PMMIMGRP,SAVGCOD
            MOVE      TRECTYPE,SAVRTYPE
            MOVE      ONE,COMPFLG
          ENDIF
.
          COMPARE   TWO,TRECTYPE
          GOTO      GJHM5220 IF EQUAL           * MBS includes to gross total
.
.         Doctor charges will be printed after Total hospital charges
.         Add item and doctor charges amount to group item for display
.
          COMPARE   FOUR,TRECTYPE
          GOTO      GJHM5200 IF NOT EQUAL       * Not doctor charges
.
          ADD       LINETOT,DRCHRAMT            * total doctor charge
          ADD       LINEGST,DRGSTAMT            * GST for doctor charge
.
          COMPARE   THREE,PROGFLAG
          GOTO      GJHM5300 IF EQUAL           * printing - don't add to total
          COMPARE   FIVE,PROGFLAG
          GOTO      GJHM5200 IF NOT EQUAL       * printing - don't add to total
          GOTO      GJHM5300
.         
GJHM5200  ADD       LINETOT,MISCTOT
GJHM5220  ADD       LINETOT,GROSSTOT
.
.----------------------------------------------------------------------------
GJHM5300  BRANCH    PROGFLAG,GJHM1000,GJHM6000,GJHM7000,GJHM8000,GJHM7000
.
.         Display miscellaneous item
.
GJHM6000  CALL      DSPI0000                * Display item
          GOTO      GJHM1000
.
.        Print miscellaneous item
.
GJHM7000 CALL      PRTI0000                * Print item
.
.        Update the Fees Invoiced Summary file
.
GJHM8000 MOVE      LINETOT,FINAMT
         CALL      WRFI0000             * write to patfinsf
         GOTO      GJHM1000
.
.----------------------------------------------------------------------------
GJHM8200 COMPARE   ZERO,COMPFLG
         GOTO      GJHM8600 IF EQUAL
.
         MOVE      SP70,TDESC
         CALL      IGRP0000             * Get item group description
         ADD       MISCTOT,TOTAMNT
.
         BRANCH    PROGFLAG,GJHM9900,GJHM8300,GJHM8500,GJHM9900,GJHM8500
.
GJHM8300 MOVE      MISCTOT,FORM12P2
         CALL      DSIG0000              * Display item group
         GOTO      GJHM9900
.
GJHM8500 CALL      PRIG0000              * Print item group
.
GJHM8600 COMPARE   FIVE,PROGFLAG
         GOTO      GJHM8700 IF EQUAL     * print invoice
         COMPARE   THREE,PROGFLAG
         GOTO      GJHM9900 IF NOT EQUAL
.
GJHM8700 CALL      PRTT0000              * Print total charges
.
.        End of this invoice's details
.
GJHM9900 CALL      JHED0000
GJHM9999 RETURN
+
.******************************************************************************
.         Display Item group
.******************************************************************************
DSIG0000  IF        INVTYPE=1
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>",TDESC,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>",MISCTOT,"</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>",FORM12P2,"</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td><b>",TDESC,"</b></td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>&nbsp;</td>":
                               "<td align=right>",FORM12P2,"</td>":
                               "</tr>"
          ENDIF
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
DSIG9999  RETURN
+
.******************************************************************************
.         Print item group
.******************************************************************************
PRIG0000  COMPARE   "3",SAVRTYPE 
          GOTO      PRIG9999 IF NOT EQUAL   * Print Doctor charges later
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
          MOVE      MISCTOT,FORM7P2
          IF        INVTYPE=1
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *58,FORM7P2
          ELSE
            PRINT     *3,ESCCHR,CHARG,TDESC,ESCCHR,CHARH:
                      *71,FORM7P2
          ENDIF
          ADD       ONE,COUNT
          MOVE      ZERO,MISCTOT
          MOVE      ZERO,MISCGST
PRIG9999  RETURN
+
.******************************************************************************
.         Get Item group description
.******************************************************************************
IGRP0000  MATCH     SP70,SAVGCOD
          IF        @EQUAL
            MOVE      "No Group Code",TDESC
          ELSE
            PACK      KEY5,ANSF,ANSN,SAVGCOD,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              CLEAR     TDESC
              APPEND    "Invalid Group",TDESC
              APPEND    SAVGCOD,TDESC
              APPEND    SP70,TDESC
              RESET     TDESC
            ENDIF
          ENDIF
IGRP9999  RETURN
+
.******************************************************************************
.         Display item
.******************************************************************************
DSPI0000  MATCH     "7",PMMIRTYP
          GOTO      DSPI9999 IF EQUAL       * display discount later
.
          IF        TRECTYPE=3 | TRECTYPE=4
            BRANCH    INVTYPE,DSPI9999      * Print items by group
          ENDIF
.
          PACK      DIM30,TDDESC,SP70
          MOVE      TFMONTH,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                       NSEP,NOCT,NNOV,NDEC
          MOVE      LINETOT,FORM12P2
          PACK      KEY4,TFCENT,TFYEAR
          REP       " 0",KEY4
.
          MOVE      "0",KEY1              * Set 'No' to Change item desc.
          IF        TRECTYPE=3
            COMPARE   ONE,MINDIC
            IF        @EQUAL
              MOVE      "1",KEY1          * Set 'Yes' to Change item desc.
            ENDIF
          ENDIF
          MOVE      "0",ANS               * Set 'No' to Change item amount
          IF        TRECTYPE=3
            MATCH     "Y",PTMCKREB
            IF        @EQUAL
              MOVE      "1",ANS           * Set 'Yes' to Change item amount
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",TFDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                            "<td>",DIM30,"</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;",TRECEIPT,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td><img src=../images/EditIcon.gif ":
                            " class=ListIcon onclick='DeleteItem(#"":
                               AURNO,"#",#"":
                               AADMNO,"#",#"":
                               PMMITRAN,"#",#"":
                               KEY1,"#",#"":
                               ANS,"#",#"",PMMIRTYP,"#")'>":
                               TITEMNO,"</td>";
.
          IF        PMMISERV<>0
            MOVE      PMMIAMTP,FORM12D2
            ADD       PMMIRBAT,FORM12D2
            IF        INVTYPE=2 | INVTYPE=0
              WRITE     HTMLFILE;"<td>",PMMISERV,"</td>";
            ENDIF
            WRITE     HTMLFILE;"<td align=right>",FORM12D2,"</td>";
          ELSE
            IF        INVTYPE=2 | INVTYPE=0
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.         
          WRITE     HTMLFILE;"<td align=right>",LINETOT,"</td>":
                            "<td>&nbsp;</td>":
                            "<td align=right>",FORM12P2,"</td>";
.
          COMPARE   TWO,INVTYPE
          GOTO      DSPI9000 IF NOT EQUAL
.
          IF        TRECTYPE=3 | TRECTYPE=4
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>";
          ENDIF
.
DSPI9000  WRITE     HTMLFILE;"</tr>"
DSPI9999  RETURN
+
.******************************************************************************
.         Print Item
.******************************************************************************
PRTI0000  IF        TRECTYPE=3 
            BRANCH    INVTYPE,PRTI1000      * Print items by group
          ENDIF
.
          COMPARE   FOUR,TRECTYPE
          GOTO      PRTI1000 IF EQUAL       * Print Doctor charges later
          COMPARE   SEVEN,TRECTYPE
          GOTO      PRTI1000 IF EQUAL       * Print discount later
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      LINETOT,FORM7P2
          UNPACK    TDDESC,KEY25
          PACK      KEY10,TFDAY,SLASH,TFMONTH,SLASH,TFCENT,TFYEAR,SP70
          REP       " 0",KEY10
          PRINT     *3,TITEMNO:
                    *13,KEY10:
                    *26,KEY25;
.
          IF       TRECTYPE=2
            IF       INVTYPE=1
              PRINT    *57,FORM7P2             * Summary
            ELSE
              PRINT    *52,TSERVS,*70,FORM7P2  * Details
            ENDIF
            ADD      TPATAMTT,TOTAMNT
          ELSE
            PRINT    *52,TSERVS:
                     *57,FORM7P2
          ENDIF
          ADD       ONE,COUNT
.
PRTI1000  COMPARE   FIVE,PROGFLAG
          GOTO      PRTI9999 IF EQUAL   * Print only
.
          PACK      DIM23 WITH TADMNO,TREF,TRECTYPE,TTRANSN1
.                                             * Save the key of this rec
.
.         Add the invoice number and invoice date to the DTRAN record
.
          MOVE      CNEXTINV TO TREF
          MOVE      ONE,TINVPRT
          PACK      PTDTEFFD,PINVDTE    * Effective date to fees invoiced
          MOVE      ZERO,PTDTGSTM
          MOVE      ZERO,PTDTGSTL
          IF        TRECTYPE=2 | TRECTYPE=3 | TRECTYPE=4
            MOVE      ONE,PTDTGSTA
            MOVE      PTCNAGST,PTDTGSTC
            MOVE      TPATAMTT,PTDTGSTM
            MULT      IBGEAMNT,PTDTGSTM  * Item/Doctor GST Amount
            DIV       "100.00",PTDTGSTM
          ENDIF
.
PRTI6000  CALL      NXTTRAN1      * Get the next transaction number
          PACK      KEY22 WITH TADMNO,TREF,TTRANSN1
          CALL      RDADTRN1
          COMPARE   ZERO,OVRCD
          GOTO      PRTI6000 IF EQUAL    * Try the next transaction number
          MOVE      ACLAIM,PTTRCLTY
          CALL      WRDTRN1              * Write Misc.Charge
.
          PROC      CKPROS00             * Check for prosthetic tracking
.
          PACK      KEY18,TADMNO,PMMIRTYP,PMMIMGRP,SAVTRNNO,SP70
          PACK      KEY14,TADMNO,SAVTRNNO
          CALL      DEPMMTI1             * remove item pending record
.
          CALL      RSPMMTI4             * reposition
PRTI9999  RETURN
+
.******************************************************************************
.         Print total charges
.******************************************************************************
PRTT0000  MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          MOVE      TOTAMNT,FORM7P2
          PRINT     *N,*3,"Total Hospital Charges",*70,FORM7P2
          ADD       TWO,COUNT
.
          CALL      PRDSC000              * Print discount if any
.
          CALL      JHGST000              * Calculate GST amount w/o Dr.Charges
          COMPARE   ZERO,GSTAMNT
          GOTO      PRTT2000 IF EQUAL
.
          MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      GSTAMNT,FORM7P2
.
          OPEN      IBAGSTA1,"ibagstaf"
          PACK      KEY6,PTCNAGST,SP70
          CALL      RDIBGS1
          IF        OVRCD=1
            MOVE      "Add GST                     ",IBGSDESC
          ENDIF
          PRINT     *3,"Add ",IBGSDESC,*70,FORM7P2:
                    *N,*70,"----------"
          ADD       TWO,COUNT
.
PRTT2000  MOVE      MAXLINE,FORM2
          SUB       ONE,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      TOTAMNT,FORM12P2
          ADD       GSTAMNT,FORM12P2
          MOVE      FORM12P2,FORM7P2
          PRINT     *3,"TOTAL HOSPITAL BILL (INCLUSIVE OF GST)",*70,FORM7P2:
                    *N
          ADD       TWO,COUNT
.
          CALL      PTDOC000              * Print Doctor charges if any
.
          MOVE      TOTAMNT,FORM7P2
          ADD       GSTAMNT,FORM7P2
.
          MOVE      FORM7P2,FORM12P2
          CALL      SRND0000              * Work out the rounding adjustment
          COMPARE   FORM7P2,FORM12P2
          GOTO      PRTT8000 IF EQUAL     * no rounding
.
          SUB       FORM7P2,FORM12P2
          MOVE      FORM12P2,FORM7P2
          IF        FORM7P2<>0
            COMPARE   MAXLINE,COUNT
            CALL      TAIL IF NOT LESS
            CALL      FRMR0000                * Format rounding amount
.
            MOVE      FORM12P2,FORM7P2
            IF        FORM7P2<0
              PRINT     *3,"Rounding",*69,"(",KEY10,")"
            ELSE
              PRINT     *3,"Rounding",*70,KEY10
            ENDIF
            ADD       ONE,COUNT
          ENDIF
.
PRTT8000  MOVE      GROSSTOT,NETTOT
          ADD       TOTGST,NETTOT
          MOVE      CSAMT,CASHTOT
          ADD       NBNKAMNT,CASHTOT
.
          COMPARE   ZERO,CASHTOT
          GOTO      PRTT9999 IF EQUAL
.
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          MOVE      CASHTOT,FORM7P2
          MULT      "-1",FORM7P2
          PRINT     *3,"Total Payments",*70,FORM7P2
          ADD       ONE,COUNT
PRTT9999  RETURN
+
.**********************************************************************
.         format rounding amount
.**********************************************************************
FRMR0000  UNPACK    SP70,KEY10,KEY7,KEY1,KEY2
.
          IF        FORM7P2<0
            MULT      "-1",FORM7P2
          ENDIF
.
          MOVE      FORM7P2,KEY10
          UNPACK    KEY10,KEY7,KEY1,KEY2
          MATCH     SP70,KEY7
          IF        @EQUAL
            MOVE      "      0",KEY7
          ENDIF
          PACK      KEY10,KEY7,KEY1,KEY2,SP70
.
FRMR9999  RETURN
+
.*******************************************************************************
.         Calculate GST Amount
.*******************************************************************************
JHGST000  MOVE      ZERO,TOTGST
          MOVE      ZERO,GSTAMNT
.
.         First calculate total GST including Doctor charges
.
          MOVE      GROSSTOT,FORM12P2
          ADD       DRCHRAMT,FORM12P2
          MULT      GSTPCEN,FORM12P2    * GST amount
          DIV       "100.00",FORM12P2   * Divide by 100 to get wanted fig.
          MOVE      FORM12P2,TOTGST
          COMPARE   ZERO,TOTGST
          GOTO      JHGST999 IF EQUAL   * No GST
.
          MOVE      TOTGST,GSTAMNT
          SUB       DRGSTAMT,GSTAMNT    * take away doctor charges GST
.
          COMPARE   THREE,PROGFLAG
          GOTO      JHGST9999 IF NOT EQUAL    * Not printing invoice
.
          UNPACK    SP70,FININVN,FINADMN,FINURNO
          IF        PROGFLAG=3
            PACK      FININVN,CNEXTINV,SP70
            MOVE      AADMNO,FINADMN
            MOVE      AURNO,FINURNO
          ENDIF
.
          MOVE      ONE,FGSTFLAG
          MOVE      "A",FINTYPE
          PACK      FINCODE WITH ANSA,SP70
          MOVE      PINVDTE,FINDATE
          REP       " 0",FINDATE
          MOVE      THREE,FINSYS
          MOVE      SP6,FINSITE
          MOVE      PMVXMHOS,FINHOSP
          MOVE      TOTGST,FINAMT
          CALL      PATCALF
.
JHGST999  RETURN
+
.******************************************************************************
.         Print doctor charges
.******************************************************************************
PTDOC000  MOVE      ZERO,TRNFLAG
          MOVE      SP70,SAVADOC
          MOVE      ZERO,LUMPAT 
          MOVE      ZERO,DOCTTOT
          MOVE      AADMNO,DAADMNO
          OPEN      PATDTRA4,"patdtraf"
          IF        PROGFLAG=5
            PACK      KEY18,AADMNO,FOUR,SP70
            CALL      RSPMMTI4
          ELSE
            MOVE      CNEXTINV,KEY8
            PACK      KEY23,AADMNO,KEY8,FOUR,SP20
            CALL      RDSDTRN4
          ENDIF
PTDOC100  IF        PROGFLAG=5
            CALL      RKPMMTI4
            BRANCH    OVRCD,PTDOC800
            MATCH     WBSEUID,PMMIWUSR        * WEB User ID
            GOTO      PTDOC100 IF NOT EQUAL
            MATCH     PMMITDAT,BACKDATE       * check with the Invoice Todate
            GOTO      PTDOC100 IF LESS
            CALL      MTDT0000                * move fields
          ELSE
            CALL      RDKDTRN4
            BRANCH    OVRCD,PTDOC800
            MATCH     TREF,KEY8
            GOTO      PTDOC800 IF NOT EQUAL   * different invoice
          ENDIF
.
          MATCH     DTADMNO,DAADMNO
          GOTO      PTDOC800 IF NOT EQUAL   * different admission
.
          MATCH     "4",DTRECTYP
          GOTO      PTDOC800 IF NOT EQUAL   * Not doctor charges
.
          IF        TRNFLAG=0
            COMPARE   MAXLINE,COUNT
            CALL      TAIL IF NOT LESS
            PRINT     *3,"DOCTOR CHARGES WITH GST"
            ADD       ONE,COUNT
            MOVE      ONE,TRNFLAG
          ENDIF
.
          MATCH     SP70,SAVADOC
          GOTO      PTDOC600 IF EQUAL       * first record
.
          MATCH     TDOCTA,SAVADOC
          GOTO      PTDOC600 IF EQUAL
.
          CALL      DGRP0000             * Print total doctor chargeable
.
PTDOC600  MOVE      TPATAMTT,LINETOT 
          ADD       PTDTGSTM,LINETOT
.
          ADD       TPATAMTT,GROSSTOT
          ADD       TPATAMTT,TOTAMNT
          ADD       LINETOT,DOCTTOT
          ADD       LINETOT,LUMPAT
          MOVE      TDOCTA,SAVADOC
.
          BRANCH    INVTYPE,PTDOC100        * Summary invoice
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSF,ANSI,TMISGRP,SP70
          CALL      RDCODE1
.
          MOVE      TFDAY,CDAY
          MOVE      TFMONTH,CMON
          MOVE      TFCENT,CCENT
          MOVE      TFYEAR,CYEAR
          CALL      PACDATE
          MOVE      LINETOT,FORM7P2
          PRINT     *3,TDDESC,*33,"(",CPCDATE,")",*57,FORM7P2    * Details
          ADD       ONE,COUNT
          GOTO      PTDOC100
.
.         Check if total needs to be printed
.
PTDOC800  MATCH     SP70,SAVADOC
          GOTO      PTDOC900 IF EQUAL
          CALL      DGRP0000             * Print total doctor chargeable
.
PTDOC900  MOVE      LUMPAT,FORM7P2
          COMPARE   ZERO,TRNFLAG
          GOTO      PTDOC999 IF EQUAL    * No doctor charges
.
          MOVE      MAXLINE,FORM2
          SUB       TWO,FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
          PRINT     *N,*70,"----------":
                    *N,*3,"Total Doctor Charges",*70,FORM7P2
          ADD       THREE,COUNT
PTDOC999  RETURN
+
.******************************************************************************
.         Write to patfinsf
.******************************************************************************
WRFI0000 COMPARE   FIVE,PROGFLAG
         GOTO      WRFI9999 IF EQUAL    * Print only
.
         MOVE      "A",FINTYPE
         MOVE      "M",ANS
.
         MOVE      SP70,KEY3
         UNPACK    TBATCHN,KEY3
.
         IF        TRECTYPE=7
           MULT      "-1",FINAMT        * discount
           MOVE      TMISGRP,KEY3
         ENDIF
         IF        PTCNMFEE = 1
           PACK      FINCODE WITH ANS,ACLAIM,KEY3,SP20
         ELSE
           PACK      FINCODE WITH ANS,KEY3,TITEMNO,SP20
         ENDIF
.
         UNPACK    SP70,FININVN,FINADMN,FINURNO
         IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
         ENDIF
.
         UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
         PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
         REP       " 0",FINDATE
         MOVE      THREE,FINSYS
         MOVE      SP6,FINSITE
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
.
WRFI9999 RETURN
+
.******************************************************************************
.         Display/Print total doctor chargeable
.******************************************************************************
DGRP0000  COMPARE   THREE,PROGFLAG
          GOTO      DGRP9999 IF NOT EQUAL       * not printing 
.
          MOVE      SP70,PACFNAME
          PACK      KEY6,SAVADOC
          CALL      RDDOCT1
          IF        OVRCD<>1
           MOVE      DSNAME,PACSNAME
           MOVE      DGNAME,PACGNAME
           MOVE      DTITL,PACTITLE
           MOVE      ONE,PACFRMT
           CALL      PACNAME
          ENDIF
.
          MOVE      SP70,KEY54
          CLEAR     KEY54
          APPEND    "Total Chargeable by ",KEY54
          APPEND    PACFNAME,KEY54
          APPEND    SP70,KEY54
          RESET     KEY54
.
          MOVE      DOCTTOT,FORM7P2
.
.         Print total doctor charges
.
          MOVE      MAXLINE,FORM2
          SUB       "3",FORM2
          COMPARE   FORM2,COUNT
          CALL      TAIL IF NOT LESS
.
          IF        INVTYPE=2
            PRINT     *57,"----------";
          ENDIF
.
          PRINT     *N,*3,KEY54:
                    *57,FORM7P2:
                    *N,*57,"----------"
          ADD       THREE,COUNT
          MOVE      SP70,SAVADOC
          MOVE      ZERO,DOCTTOT
.
DGRP9999  RETURN
+
.******************************************************************************
.         Print Discount
.******************************************************************************
PRDSC000  MOVE      AADMNO,DAADMNO
          MOVE      CNEXTINV,KEY8
          OPEN      PATDTRA4,"patdtraf"
          PACK      KEY23,AADMNO,KEY8,SEVEN,SP20
          CALL      RDSDTRN4
PRDSC100  CALL      RDKDTRN4
          BRANCH    OVRCD,PRDSC999
.
          MATCH     TREF,KEY8
          GOTO      PRDSC999 IF NOT EQUAL   * different invoice
.
          MATCH     DTADMNO,DAADMNO
          GOTO      PRDSC999 IF NOT EQUAL   * different admission
.
          MATCH     "7",DTRECTYP
          GOTO      PRDSC999 IF NOT EQUAL
.
          ADD       TPATAMTT,GROSSTOT
          ADD       TPATAMTT,TOTDISC 
          ADD       PTDTGSTM,GSTAMNT
          MOVE      TPATAMTT,LINETOT     * Discount
          ADD       LINETOT,TOTAMNT
          MOVE      ZERO,LINEGST
.
          COMPARE   MAXLINE,COUNT
          CALL      TAIL IF NOT LESS
.
.         MOVE      "Discount",TDESC
.         PACK      KEY5,ANSF,ANSI,TMISGRP,SP70
.         CALL      RDCODE1
.
          MOVE      LINETOT,FORM7P2
          PRINT     *3,TDDESC,*70,FORM7P2    * Details
          ADD       ONE,COUNT
          GOTO      PRDSC100
.
PRDSC999  RETURN
+
.******************************************************************************
.         Display Discount
.******************************************************************************
DSDSC000  MOVE      AADMNO,DTADMNO
          PACK      KEY18,AADMNO,SEVEN,SP20
          CALL      RSPMMTI4
DSDSC100  CALL      RKPMMTI4
          BRANCH    OVRCD,DSDSC999
.
          MATCH     DTADMNO,PMMIVISN
          GOTO      DSDSC999 IF NOT EQUAL
.
          MATCH     "7",PMMIRTYP
          GOTO      DSDSC999 IF NOT EQUAL
.
          MATCH     PMMITDAT,BACKDATE      * check with the Invoice Todate
          GOTO      DSDSC100 IF LESS
.
          ADD       PMMIAMTT,GROSSTOT
          ADD       PMMIAMTT,TOTDISC
          MOVE      PMMIAMTT,LINETOT     * Discount
          MOVE      LINETOT,FORM12P2
.
          ADD       PMMIGSTM,LINETOT
          ADD       LINETOT,NETTOT  
          ADD       LINETOT,TOTAMNT
.
          COMPARE   TWO,PROGFLAG
          GOTO      DSDSC100 IF NOT EQUAL    * not displaying invoice
.
          UNPACK    PMMITDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                       NSEP,NOCT,NNOV,NDEC
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
.
          MOVE      "1",KEY1          * Set 'Yes' to Change item desc.
          MOVE      "1",ANS           * Set 'Yes' to Change item amount
.
          WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                            "<td>",PMMIDESC,"</td>";
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"<td><img src=../images/EditIcon.gif ":
                            " class=ListIcon onclick='DeleteItem(#"":
                               AURNO,"#",#"":
                               AADMNO,"#",#"":
                               PMMITRAN,"#",#"":
                               KEY1,"#",#"":
                               ANS,"#",#"",PMMIRTYP,"#")'>":
                               "</td>":
                            "<td>&nbsp;</td>";
.
          IF        INVTYPE=2
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td>":
                             "<td>&nbsp;</td>";
.
          BRANCH    INVTYPE,DSDSC300           * Summary
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td align=right>",FORM12P2,"</td></tr>"
          GOTO      DSDSC100
.
DSDSC300  WRITE     HTMLFILE;"<td align=right>",FORM12P2,"</td></tr>"
          GOTO      DSDSC100
.
DSDSC999  RETURN
+
.******************************************************************************
.* JHED0000 : Print End of Johns hopkins invoice
.******************************************************************************
JHED0000 MOVE      FDAY,CDAY
         MOVE      FMON,CMON
         MOVE      FCENT,CCENT
         MOVE      FYEAR,CYEAR
         CALL      PACDATE
.
         BRANCH    PROGFLAG,JHED1100,JHED1000,JHED4000
.
         MOVE      GROSSTOT,GSTAMNT
         MULT      GSTPCEN,GSTAMNT     * GST amount
         DIV       "100.00",GSTAMNT    * Divide by 100 to get wanted fig.
         MOVE      GSTAMNT,TOTGST
         SUB       DRGSTAMT,GSTAMNT
.
         MOVE      GROSSTOT,NETTOT
         ADD       TOTGST,NETTOT
.
         COMPARE   FIVE,PROGFLAG
         GOTO      JHED4000 IF EQUAL   * Print estimate invoice
         GOTO      JHED9999
.
JHED1000 MOVE      GROSSTOT,FORM12P2
         WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                                "<td><b>Total Charges</b></td>";
.
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
         ENDIF
.
         WRITE   HTMLFILE;"<td>&nbsp;</td>":
                          "<td>&nbsp;</td>":
                          "<td align=right><b>",GROSSTOT,"</b></td>":
                          "<td>&nbsp;</td>";
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>";
         ENDIF
         WRITE     HTMLFILE;"<td align=right><b>",FORM12P2,"</b></td>":
                            "</tr>"
.
JHED1100 CALL      DSDSC000              * Display discount if any
         MOVE      GROSSTOT,NETTOT
         COMPARE   TWO,PROGFLAG
         GOTO      JHED1150 IF NOT EQUAL    * not displaying invoice
.
         MOVE      GROSSTOT,GSTAMNT
         MULT      GSTPCEN,GSTAMNT     * GST amount
         DIV       "100.00",GSTAMNT    * Divide by 100 to get wanted fig.
         MOVE      GSTAMNT,TOTGST
         MOVE      GROSSTOT,NETTOT
         ADD       TOTGST,NETTOT
.
         MOVE      GROSSTOT,FORM12P2
         ADD       TOTGST,FORM12P2
         WRITE     HTMLFILE;"<tr><td>&nbsp;</td>";
.
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
         ENDIF
         WRITE     HTMLFILE;"<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>";
.
         WRITE     HTMLFILE;"</tr>":
                                "<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                                "<td><b>Invoice Total</b></td>";
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
         ENDIF
.
         WRITE      HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",GROSSTOT,"</b></td>":
                             "<td align=right><b>",TOTGST,"</b></td>";
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>";
         ENDIF
         WRITE     HTMLFILE;"<td align=right><b>",FORM12P2,"</b></td>":
                            "</tr>"
         WRITE     HTMLFILE;"<input type=hidden name=pcbiinvt ":
                            "value='",FORM12P2,"'>";
.
JHED1150 BRANCH    PROGFLAG OF JHED9999,JHED1200
         GOTO      JHED9999
.
.        If there is no cash to be invoiced, don't display cash.
.
JHED1200 COMPARE   ZERO,CASHFLAG
         GOTO      JHED1800 IF NOT EQUAL
         COMPARE   ZERO,NBNKAMNT
         GOTO      JHED2000 IF EQUAL
.
.        Display cash total
.
JHED1800 ADD       NBNKAMNT,CSAMT
         MULT      "-1",CSAMT
.
         IF        CASHFLAG=1
           MOVE      CSDAY,CDAY
           MOVE      CSMON,CMON
           MOVE      CSCENT,CCENT
           MOVE      CSYEAR,CYEAR
           MOVE      CMON,FORM2
           LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                   NSEP,NOCT,NNOV,NDEC
           PACK      KEY4,CCENT,CYEAR
           REP       " 0",KEY4
           WRITE     HTMLFILE;"<tr><td>":
                              CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>";
         ELSE
           WRITE     HTMLFILE;"<tr><td>&nbsp;</td>";
         ENDIF
.
         WRITE     HTMLFILE;"<td>Payment Received With Thanks</td>";
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
         ENDIF
         WRITE     HTMLFILE;"<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>";
         IF        DSCNFLAG=1
           WRITE     HTMLFILE;"<td align=right><font color=#000080><b>":
                              CSAMT,"</font></b></td>";
         ELSE
           WRITE     HTMLFILE;"<td align=right>",CSAMT,"</td></tr>"
         ENDIF
         MULT      "-1",CSAMT
         SUB       CSAMT FROM NETTOT
.
.        Display balance payable
.
JHED2000 MOVE      NETTOT,FORM12P2
         CALL      SRND0000                 * Work out the rounding adjustment
         WRITE      HTMLFILE;"<tr bgcolor=#CCCCCC><td>&nbsp;</td>":
                               "<td><b>Balance Payable</b></td>";
         IF        INVTYPE=2
           WRITE     HTMLFILE;"<td>&nbsp;</td>":
                              "<td>&nbsp;</td>":
                              "<td>&nbsp;</td>";
         ENDIF
         WRITE     HTMLFILE;"<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>":
                            "<td>&nbsp;</td>";
.
         WRITE     HTMLFILE;"<td align=right><b>",FORM12P2,"</b></td></tr>"
         WRITE     HTMLFILE;"<input type=hidden name=pcbibalp ":
                            "value='",FORM12P2,"'>";
         GOTO      JHED9999
.
JHED4000 MOVE      TOTAMNT,NETTOT
         ADD       TOTGST,NETTOT
         SUB       CASHTOT,NETTOT
         MOVE      NETTOT,FORM7P2
.
.        Check if the invoice total need to be rounded 
.
         MATCH     SP70,PTCNRDWN
         GOTO      JHED8000 IF EQUAL        * Not set
.
         MOVE      NETTOT,FORM12P2
         CALL      SRND0000                 * Work out the rounding adjustment
         COMPARE   FORM12P2,NETTOT
         GOTO      JHED8000 IF EQUAL
         MOVE      FORM12P2,FORM7P2
.
         SUB       NETTOT,FORM12P2
         CALL      WRID0000                 * Write rounding adj.to dtr file
         MOVE      FORM12P2,ROUNDAMT
         ADD       FORM12P2,GROSSTOT
.
         COMPARE   FIVE,PROGFLAG
         GOTO      JHED8000 IF EQUAL        * Print only
.
         MOVE      ZERO,FGSTFLAG
         MOVE      FORM12P2,FINAMT 
         MULT      "-1",FINAMT              * Rounding adjustment
.
         MOVE      "A",FINTYPE
         MOVE      "M",ANS
         IF        PTCNMFEE = 1
           PACK      FINCODE WITH ANS,ACLAIM,PTCNROUN,SP70
         ELSE
           PACK      FINCODE WITH ANS,PTCNROUN,SP70
         ENDIF
.
         UNPACK    SP70,FININVN,FINADMN,FINURNO
         IF        PROGFLAG=3
           PACK      FININVN,CNEXTINV,SP70
           MOVE      AADMNO,FINADMN
           MOVE      AURNO,FINURNO
         ENDIF
.
         UNPACK    PINVDTE WITH XCENT,XYEAR,XMON,XDAY
         PACK      FINDATE,XCENT,XYEAR,XMON,XDAY
         REP       " 0",FINDATE
         MOVE      THREE,FINSYS
         MOVE      SP6,FINSITE
         MOVE      PMVXMHOS,FINHOSP
         CALL      PATCALF
.
         BRANCH    PROGFLAG,JHED9999,JHED9999,JHED8000,JHED9999
.
JHED8000 MOVE      MAXLINE,FORM2
         SUB       "4",FORM2
         COMPARE   FORM2,COUNT               * Check For A Full Page
         CALL      TAIL IF NOT LESS
         PRINT     *70,"----------":
                   *N,*3,"BALANCE PAYABLE",*70,FORM7P2:
                   *N,*70,"==========":
                *N,*N,*3,"P L E A S E  P A Y  T H I S  A M O U N T",*70,FORM7P2
         ADD       FIVE,COUNT
.
         PACK      KEY19,AADMNO,SP70
         CALL      PRTIPROV                 * Print insurance provider
.
         WHILE     COUNT<MAXLINE
           PRINT     *N;
           ADD       ONE,COUNT
         DO
         CALL      SINVT000                 * set up tail stationery code
         ADD       ONE,CPAGENO
         MOVE      ZERO,PAYMTTOT
         MOVE      ZERO,CREDTOT
         CALL      PRTINVTL                 * print templated invoice tail
.
         COMPARE   FORM3,IBTHLENG         * check if last line is same as
         GOTO      JHED9999 IF EQUAL      * page length
         PRINT     *N;
.
JHED9999 RETURN
.
.******************************************************************************
.        Workout the rounding amount
.******************************************************************************
SRND0000 MOVE      ZERO,FORM2
         COMPARE   ZERO,FORM12P2
         GOTO      SRND0200 IF NOT LESS
         MULT      "-1",FORM12P2
         MOVE      ONE,FORM2
.
SRND0200 MOVE      FORM12P2,KEY15
         UNPACK    KEY15,KEY14,KEY1
         MOVE      ZERO,FORM1
         MOVE      ZERO,FORM12D2
         MOVE      KEY1,FORM1
         COMPARE   ZERO,FORM1
         GOTO      SRND9000 IF EQUAL
.
         MATCH     "05",PTCNRDWN
         GOTO      SRND5000 IF NOT EQUAL
.
.        5 cent rounding
.
         BRANCH    FORM1,SRND8000,SRND8000:
                         SRND8000,SRND8000,SRND1000,SRND1000,SRND1000:
                         SRND1000,SRND1000
.
SRND1000 MOVE      FIVE,FORM12D2
         GOTO      SRND8000
.
SRND2000 ADD       TEN,FORM12D2
         GOTO      SRND8000
.
.        10 cent rounding
.
SRND5000 MATCH     "10",PTCNRDWN
         GOTO      SRND9000 IF NOT EQUAL
.
         BRANCH    FORM1,SRND8000,SRND8000,SRND8000,SRND8000,SRND8000:
                         SRND8000,SRND8000,SRND8000,SRND8000,SRND7000
.
SRND7000 MOVE      TEN,FORM12D2
.
SRND8000 SUB       FORM1,FORM12D2
         DIV       "100",FORM12D2
         ADD       FORM12D2,FORM12P2
         GOTO      SRND9000
.
SRND9000 COMPARE   ZERO,FORM2
         GOTO      SRND9999 IF EQUAL
         MULT      "-1",FORM12P2
SRND9999 RETURN
+
.******************************************************************************
.* WRID0000 : Write to DTR for Rounding Adjustment - Johns Hopkins
.******************************************************************************
WRID0000 COMPARE   FIVE,PROGFLAG
         GOTO      WRID9999 IF EQUAL         * print only
.
         CALL      CLPATDTR
.
WRID1000 CALL      NXTTRAN1
         MOVE      CNEXTINV,TREF
         PACK      KEY22 WITH TADMNO,TREF,TTRANSN1
         CALL      RDADTRN1
         COMPARE   ZERO,OVRCD
         GOTO      WRID1000 IF EQUAL     * Try the next transaction number
.
         MOVE      CDD,TFDAY
         MOVE      CMM,TFMONTH
         MOVE      CCC,TFCENT
         MOVE      CYY,TFYEAR
         MOVE      FORM12P2,TPATAMTT
         MOVE      FORM12P2,TPATAMTP
         MOVE      ONE,TINVPRT
         MOVE      "7",TRECTYPE
         MOVE      PTCNROUN,TMISGRP      * Rounding category
         MOVE      "ROUNDING           ",TDDESC
         PACK      PTDTEFFD,CCC,CYY,CMM,CDD
         REP       " 0",PTDTEFFD
         PACK      KEY22 WITH TADMNO,TREF,TTRANSN1
         CALL      WRDTRN1
.
         IF        CFEETYP=5 & WRDTFLAG=1
           CALL      WRNZRDT1            * Write to Win/Loss file
         ENDIF
.
         ADD       ONE,ATRANNO
         CALL      UPLMISS1
WRID9999 RETURN
+
.*******************************************************************************
.        Search for any Anaesthetic Codes and Times only for SJOG
.*******************************************************************************
GJGA0000 OPEN      OPRDETA2,"oprdetaf"
         PACK      KEY31,AADMNO,ZERO,SP70
         CALL      RSOPDEA2
GJGA1000 CALL      RKOPDEA2
         BRANCH    OVRCD,GJGA9999
.
         MATCH     AADMNO,OPDAADMN
         GOTO      GJGA9999 IF NOT EQUAL
.
         COMPARE   THREE,OPDASTAT
         GOTO      GJGA9999 IF EQUAL
.
.        check if the session date matches
.
         PACK      KEY8,SAVDATE1,SP70
         REP       " 0",KEY8
         MOVE      OPDADATE,DIM8
         REP       " 0",DIM8
         MATCH     KEY8,DIM8
         GOTO      GJGA1000 IF NOT EQUAL
.
         MATCH     SAVEUNIQ,OPDAUNIQ
         GOTO      GJGA1000 IF NOT EQUAL
.
         PACK      KEY10,SAVEUNIQ,SP70                 * Direct read for Arrival
         CALL      RDOPARD1                            * and Recovery details
         BRANCH    OVRCD,GJGA9999
.
         COMPARE   MAXLINE,COUNT
         CALL      TAIL IF NOT LESS
.
         PRINT     *30,OPDAANAE;
.
         MOVE      OPARANAS,DIM5
         MOVE      OPARANAE,DIM5A
.
         PRINT     *36,DIM5," to ",DIM5A;
.
         CALL      PEOL0000
         CALL      CKTL0000
.
GJGA9999 RETURN
+
.--------------------------------------------------------------------------
.        Check if the parameter for Invoice raised on the 1st day of period 
.        to go to previous period
.--------------------------------------------------------------------------
FRSDAY00  IF        CFEETYP=9 & BDTEFLAG=1
            MOVE      BACKDATE,PINVDTE    (JH uses backdated invoice)
          ENDIF
.
.         Are Invoice dates are always todays date ?
.
          COMPARE   ZERO,CINV1ST
          GOTO      FRSDAY99 IF EQUAL
.
.         Is this the first day of the period
.
          MOVE      PINVDTE,CPTDATE
          CALL      GPERD
          BRANCH    EXIT,FRSDAY99
.
          UNPACK    DRGFDTE,DIM8
          REP       " 0",DIM8
.
          MATCH     DIM8,PINVDTE
          GOTO      FRSDAY99 IF NOT EQUAL
.
.         Is this a day case
.
          MATCH     ADATE,DDATE
          GOTO      FRSDAY20 IF NOT EQUAL
.
.         Only day cases for the invoice date are to stay the same
.
          MATCH     PINVDTE,DDATE
          GOTO      FRSDAY99 IF EQUAL
.
.         Calculate the date of the last day of the previous period
.
FRSDAY20  UNPACK    PINVDTE,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,DD
          MOVE      XMON,MM
          MOVE      XYEAR,YY
          MOVE      XCENT,CC
          CALL      DMYCON
          SUB       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
.
.         Repack invoice date with new date
.
          PACK      PINVDTE,CC,YY,MM,DD
          REP       " 0",PINVDTE
.
FRSDAY99  RETURN
+
.***************************************************************************
.        Initialise array variables
.***************************************************************************
INAR0000  MOVE      ZERO,FORM3B
          WHILE     FORM3B < 999
            ADD       ONE,FORM3B
            MOVE      SP70,MCHGARR[FORM3B]
          DO
INAR9999  RETURN
+
.***************************************************************************
.        Check for Multiple Procedures
.***************************************************************************
CMPR0000  OPEN      PMSMTIA2,"pmsmtiaf"
          MOVE      SP70,HBCOFKEY          * High boundary cut off key
          CALL      INAR0000               * Initialise arrray variables
.
          MOVE      ZERO,FORM3B
          UNPACK    SP70,SAVKEY9,DIM8
          MOVE      "2",PMMIRTYP
          PACK      KEY15,AADMNO,PMMIRTYP,SP20
          CALL      RSPMMTI2
CMPR2000  CALL      RKPMMTI2
          BRANCH    OVRCD,CMPR3000
.
          MATCH     AADMNO,PMMIVISN            * compare admission number
          GOTO      CMPR3000 IF NOT EQUAL
.
          CALL      CONTY0000              * Check for Consumption type
          BRANCH    EXIT,CMPR2000          * Skip un-used item
.
          MATCH     "2",PMMIRTYP
          GOTO      CMPR3000 IF NOT EQUAL   * not a theatre item
.
          ADD       ONE,FORM3B              * increase no of item on invoice
          IF        FORM3B=1
            MOVE      PMMIITEM,SAVKEY9      * save the first item code
            MOVE      PMMITDAT,DIM8
          ELSE
            CALL      CKIN0000              * Check if item already in the array
            BRANCH    EXIT,CMPR9999         * Same items entered twice
          ENDIF
.
          MOVE      PMMIITEM,MCHGARR[FORM3B]
          COMPARE   "999",FORM3B
          GOTO      CMPR2000 IF NOT EQUAL
.
CMPR3000  COMPARE   ZERO,FORM3B
          GOTO      CMPR9999 IF EQUAL    * No MBS Item on invoice
.
          OPEN      PMSMPRA1,"pmsmpraf"
          OPEN      PMSMPRA2,"pmsmpraf"
.
.         Check Multiple Procedures File
.         Use the first item to find the valid Multiple procedure codes and 
.         Contract ID
.
          PACK      SKEY21,PMCCCCOD,PMCCHFUN,PMCCHFTY,SAVKEY9,SP70
          PACK      KEY37,SKEY21,SP70
          CALL      RSPMMPR2
CMPR4000  CALL      RKPMMPR2
          BRANCH    OVRCD,CMPR9999
.
          PACK      KEY21,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPITMN,SP70
          MATCH     SKEY21,KEY21
          GOTO      CMPR9999 IF NOT EQUAL
.
.         Validate Contract ID
.
          MOVE      DIM8,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Current date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,CODECL,PMCCCCOD
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  PACK      CEFFDATE,CCC,CYY,CMM,CDD,SP70
                  REP       " 0",CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PMMPCNID,KEY6           * Contract ID
          CALL      VALCONTR
          BRANCH    EXIT,CMPR4000
          MOVE      PMMPCNID,CONTRCID       * Contract ID
.
.         found a multiple procedures code for the first item
.
          PACK      SKEY37,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPITMN,PMMPCNID:
                           PMMPMPRC,PMMPCOUN,SP70
.
.         Check the rest of items for the Multiple procedures code
.
          CALL      COMB0000                      * Check for items combination
          COMPARE   ZERO,EXIT
          GOTO      CMPR8000 IF EQUAL             * Found the combination
.
.         Check for next Multi.Procedure code
.
          MOVE      SKEY37,KEY37
          CALL      RDPMMPR2              * re-position on the record
          GOTO      CMPR4000
.
.         Save High boundary cut off key
.
CMPR8000  UNPACK    SKEY26,PMMPCNID,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPMPRC
          PACK      HBCOFKEY,PMMPCNID,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPMPRC,SP70
CMPR9999  RETURN
+
.***************************************************************************
.         CKIN0000 - Check if item already in the array
.***************************************************************************
CKIN0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM3
.
CKIN1000  ADD       ONE,FORM3
          COMPARE   FORM3B,FORM3
          GOTO      CKIN9999 IF NOT LESS
.
          MATCH     PMMIITEM,MCHGARR[FORM3]
          GOTO      CKIN1000 IF NOT EQUAL
          MOVE      ONE,EXIT
CKIN9999  RETURN
+
.***************************************************************************
.         Check for the combination
.***************************************************************************
COMB0000  MOVE      ZERO,EXIT
          MOVE      ZERO,FORM3
COMB2000  COMPARE   FORM3,FORM3B
          GOTO      COMB4000 IF EQUAL
.
          ADD       ONE,FORM3
          MOVE      MCHGARR[FORM3],KEY9
.
          PACK      SKEY35,PMMPCCOD,PMMPHFUN,PMMPHFTY,KEY9,PMMPCNID:
                           PMMPMPRC,SP70
          PACK      KEY37,SKEY35,SP70
          CALL      RSPMMPR2
          CALL      RKPMMPR2
          BRANCH    OVRCD,COMB9000
.
          PACK      KEY35,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPITMN,PMMPCNID:
                          PMMPMPRC,SP70
          MATCH     KEY35,SKEY35
          GOTO      COMB2000 IF EQUAL
          GOTO      COMB9000
.
.         Check if number of items in the array same as the number of items
.         required for Mutiple procedures fee
.
COMB4000  MOVE      ZERO,F3
          PACK      SKEY26,PMMPCNID,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPMPRC,SP70
          PACK      KEY28,SKEY26,SP70
          CALL      RSPMMPR1
COMB5000  CALL      RKPMMPR1
          BRANCH    OVRCD,COMB6000
.
          PACK      KEY26,PMMPCNID,PMMPCCOD,PMMPHFUN,PMMPHFTY,PMMPMPRC,SP70
          MATCH     KEY26,SKEY26
          GOTO      COMB6000 IF NOT EQUAL
.
          MATCH     SP70,PMMPITMN
          GOTO      COMB5000 IF EQUAL       * Header record
          ADD       ONE,F3
          GOTO      COMB5000
.
COMB6000  COMPARE   FORM3,F3
          GOTO      COMB9999 IF EQUAL
.
COMB9000  MOVE      ONE,EXIT
COMB9999  RETURN
+
.*****************************************************************************
.         Check ICD10 Suggested Classification
.*****************************************************************************
ICDS0000  CALL      ISUG0000           * Check if ICD10 Sugg.Class.required
          COMPARE   ZERO,INVBFLAG
          GOTO      ICDS9000 IF NOT EQUAL
.
          MOVE      PMSGCLSS,ATYPE
          IF        PROGFLAG=2
            WRITE     HTMLFILE;"<tr><td>ICD10 Code: <b>",PMSGICDC:
                               "</b> Suggested Classification: <b>":
                               PMSGCLSS,"</b>":
                               "</td></tr>";
          ENDIF
          GOTO      ICDS9999
.
ICDS9000  MOVE      SP70,PMSGCLSS
ICDS9999  RETURN
+
.******************************************************************************
.
.******************************************************************************
          DEFPROC   CETT0000
.
          INC       PATCERFD/INC

FORM1     FORM       2

CETT0000  MOVE      ZERO,FORM1
          PACK      KEY5,ANSB,ANST,STRBTYP
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC9,FORM1
          ELSE
            MOVE    ONE,EXIT 
            GOTO    CETT9000
          ENDIF
.
          MOVE      "99991231",DIM8
          COMPARE   THREE,ASTAT
          GOTO      CETT1000 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=0
            MOVE      DDATE,DIM8            * set discharge date
          ENDIF
.
CETT1000  OPEN      PATCERA1,"patceraf"
          PACK      KEY19,AURNO,SP70
          CALL      RSPTCER1
CETT1500  CALL      RKPTCER1
          BRANCH    OVRCD,CETT9000
.
          MATCH     AURNO,PTCEURNO
          GOTO      CETT9000 IF NOT EQUAL
.
.         Check if the Certificate is for the current visit
.
          MATCH     ADATE,PTCETDAT
          GOTO      CETT1500 IF LESS
          MATCH     PTCEFDAT,DIM8
          GOTO      CETT1500 IF LESS
.
          PACK      KEY5,CATCR,PTCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CETT1500
.
          
          BRANCH    FORM1,CETT2100,CETT2200,CETT2200,CETT2100,CETT2600:
                          CETT2600
.
          GOTO      CETT1500
.
CETT2100  COMPARE   "13",TCFORM6         
          IF        @EQUAL
            MOVE      ZERO,EXIT
            GOTO      CETT9999
          ENDIF
          GOTO      CETT1500
.
CETT2200  COMPARE   "7",TCFORM6
          IF        @EQUAL
            MOVE      ZERO,EXIT
            GOTO      CETT9999
          ENDIF
          GOTO      CETT1500
.
CETT2600  COMPARE   "6",TCFORM6
          IF        @EQUAL
            MOVE      ZERO,EXIT
            GOTO      CETT9999
          ENDIF
          GOTO      CETT1500
.
CETT9000  MOVE      ONE,EXIT
          GOTO      CETT9999
.
CETT9999  GOTO      CETTEND
          INC       PATCERIO/INC
          INC       IBAOVRIO/INC
CETTEND   ENDPROC
.
.******************************************************************************
.         Print the estimated fund rebate
.******************************************************************************
PREBATE   BRANCH    PTCNPEFR,PREB1000,PREB9999
.
          COMPARE   ZERO,REBTOT
          GOTO      PREB9999 IF EQUAL
.
PREB1000  MOVE      CSAMT,FORM62
.
.         Check if the invoice is fully paid
.
          COMPARE   FORM62,NETTOT
          GOTO      PREB9999 IF EQUAL
.
          BRANCH    IPASS OF PREB9999,PREB9999
.
          BRANCH    CLAIM OF PREB7000,PREB7000,PREB7000
          PRINT     *12,"(We Expect a Rebate of $ ",REBTOT," from your ":
                    "Health Fund)";
          GOTO      PREB9000
.
PREB7000  PRINT     *12,"(We Expect a Rebate of $ ",REBTOT," from your ":
                    "Insurer)";
.
PREB9000  CALL      PEOL0000
PREB9999  RETURN
+
.*****************************************************************************
.         Check Consumption type of a Misc.item
.*****************************************************************************
CONTY000  MOVE      ZERO,EXIT
          MATCH     "3",PMMIRTYP
          GOTO      CONTY999 IF NOT EQUAL  * Not a Misc.item
.
          MATCH     "1",OPCNCONS
          GOTO      CONTY999 IF NOT EQUAL  * Not using Consumption type
.
          REP       " 0",PMMICTYP
          MATCH     "0",PMMICTYP
          GOTO      CONTY999 IF EQUAL      * Used
.
          MOVE      ONE,EXIT           * Not used/Expired
CONTY9999 RETURN
.
.*****************************************************************************
.        * Write to Consumption type item
.*****************************************************************************
.
          DEFPROC   WRCTYP00
.
          INC       OPRCTYFD/INC
.
. Local Variables
. ---------------
F2        FORM      2
.
WRCT0000  REP       " 0",PMMICTYP
          MATCH     "0",PMMICTYP
          GOTO      WRCT9999 IF EQUAL          * Item Used
.
          OPEN      OPRCTYA1,"oprctyaf"
.
.         Item is either 'Not Used' or 'Expired'
.
          MOVE      ZERO,F2
          MOVE      "1",KEY1                  * default team number
          PACK      KEY13,PMMIUNIQ,KEY1,Z70
          CALL      RSOPCTY1
          CALL      RPOPCTY1
          BRANCH    OVRCD,WRCT2000
.
          MATCH     PMMIUNIQ,OPCYUNIQ        
          GOTO      WRCT2000 IF NOT EQUAL     * different unique number
          MATCH     KEY1,OPCYTEAM
          GOTO      WRCT2000 IF NOT EQUAL     * different team number
.
          MOVE      OPCYCNTR,F2
.
WRCT2000  ADD       ONE,F2
          MOVE      F2,OPCYCNTR
          MOVE      PMMIUNIQ,OPCYUNIQ
          MOVE      KEY1,OPCYTEAM
.
          MOVE      PMMIITEM,OPCYITEM         * Item code
          MOVE      PMMICTYP,OPCYCTYP         * Consumption Type
          MOVE      PMMISERV,OPCYQUAN         * Quantity
.
          CALL      IBACLOCK
          PACK      OPCYCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPCYCDAT
          MOVE      CTIMEIS,OPCYCTIM
          MOVE      PASSCODE,OPCYCUID
.
          UNPACK    SP70,OPCYUDAT,OPCYUTIM,OPCYUUID
          MOVE      SP70,OPCYSPAR
.
          PACK      KEY13,OPCYUNIQ,OPCYTEAM,OPCYCNTR
          CALL      WROPCTY1
.
          CLOSE     OPRCTYA1
          GOTO      WRCT9999
.
          INC       IBAOVRIO/INC
          INC       OPRCTYIO/INC
.
WRCT9999  ENDPROC
+
.*****************************************************************************
+
.*****************************************************************************
.*                                 CKPROS00                                  *
.*      See if the item being billed (written to patdtraf) is a prosthetic   *
.*      tracking item.  If it is and if the prosthetic tracking parameter is *
.*      turned on, then we need to write the patdtraf.dttransn1 value to all *
.*      the pmsptraf records where the pmsmtiaf.pmmitran equals              *
.*      pmsptdaf.pmpetran for the admission.                                 *
.*      We need to do this so that when processing credit notes (pmsfciaf)   *
.*      we can match up the pmsfciaf record to the last associated pmsptdaf  *
.*      which is used as the default to populate the new pmsptdaf change     *
.*      record that will be written for the credit note.                     *
.*      (Note:  The transaction number in patdtraf matches that in pmsfciaf) *
.*                                                                           *
.* Requires: Valid read on admission (for AADMNO).                           *
.*           patmtiaf.pmmitran (transaction number for the pmsmtiaf item).   *
.*           patdtraf.dttransn1 (transaction number for the patdtraf item).  *
.*           Valid read on patmchgf for misc. item being processed.          *
.*****************************************************************************
.
          DEFPROC   CKPROS00
.
          INC       PMSPTDFD/INC
.
. Local Variables
. ---------------
TEMPANUM  DIM       8
.
CKPROS00  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND12;*118,PTCNTRPR
.
          MATCH     "1",PTCNTRPR                 * using prosthetics tracking ?
          GOTO      CKPROS99 IF NOT EQUAL        * no - finished
.
          MATCH     "1",PTMCPRTR                 * tracking prosthetic ?
          GOTO      CKPROS99 IF NOT EQUAL        * no
.
          CALL      UPPROS00                     * yes
          GOTO      CKPROS99
+
.*****************************************************************************
.*                              UPPROS00                                     *
.*      Update all related pmsptdaf records for this billed item with the    *
.*      patdtraf transaction number.                                         *
.*****************************************************************************
.
UPPROS00  OPEN      PMSPTDA4,"pmsptdaf"
          PACK      KEY30,TADMNO,SAVTRNNO,SP30
          CALL      RSPMPTD4                     * position on admiss/transac.
UPPROS10  CALL      RKPMPTD4                     * read next record
          BRANCH    OVRCD,UPPROS90               * eof - finished
.
          MOVE      TADMNO,TEMPANUM
          MATCH     TEMPANUM,PMPEVISN            * same visit still ?
          GOTO      UPPROS90 IF NOT EQUAL        * no - finished
.
          MATCH     SAVTRNNO,PMPETRAN            * same transaction no. still ?
          GOTO      UPPROS90 IF NOT EQUAL        * no - finished
.
          MATCH     SP6,PMPEDTRN                 * blank patdtraf number ?
          IF        @EQUAL
            MOVE      TTRANSN1,PMPEDTRN          * load patdtraf trans. no.
            CALL      UPPMPTD4                   * update record
          ENDIF
          GOTO      UPPROS10                     * get next record
.
UPPROS90  CLOSE     PMSPTDA4
.
UPPROS99  RETURN
+
          INC       IBAOVRIO/INC
          INC       PMSPTDIO/INC
.
CKPROS99  ENDPROC
+
          INC       PMSHATRD
          INC       PATFN2RD              * Health fund extension file
          INC       ABFPTINV              * ABF Inpatient
          INC       ABFMHINV              * ABF MH Events
          INC       ISBCATBI              * Indenpence Service Billing
          INC       NZPCATBI              * Southern Cross Invoice
          INC       DBSCATBI              * Discharge Billing Statement
          INC       PINCATBI              * Print Patient Invoice
          INC       REBCATBI              * Print Rebate Invoice
          INC       PATDEFCL              * routine DCLM0000 
          INC       PRNTICDC              * print ICD10
          INC       PATDDHRD              * HF History
          INC       CALCMVHR              * Calculate MV
          INC       CLPATINP              * Clear Invoice pending detail
          INC       CLPATHTR              * Clear Patient HF debtors transaction
.
