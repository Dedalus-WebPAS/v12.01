.---------------------------------------------------------------------- 
. Program       : DISWEB01 
.
. Function      : Disaster Management Maintenance   
.
. Modifications :
.----------------------------------------------------------------------
. V12.00.02 11/06/2025  Ebon Clements   TSK 0961623
.           Alphanueric visit number changes
. V12.00.01 16/05/2025  PJ Le Febour   TSK 0955096 AlphaNum VISITNUM upds
.           replace COMPARE OBAOUTNO,OPRSOUTN with MATCH OBAOUTNO,OPRSOUTN
.                   COMPARE BKREBOOK,BKDIBOOK with MATCH BKREBOOK,BKDIBOOK
.                   COMPARE PVIBILL,TADMN     with MATCH PVIBILL,TADMN
.                   COMPARE OBAOUTNO,PVIBILL  with MATCH OBAOUTNO,PVIBILL
.                   COMPARE PTEDADMN,PVIBILL  with MATCH PTEDADMN,PVIBILL
.           replace PVIBILL<>PTEDADMN         with MATCH PVIBILL,PTEDADMN
.           deleted ADMISSF8 - no longer required                        
.----------------------------------------------------------------------
. V11.05.01 24/03/2025  Davin          TSK 0956210
.           Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)
. V11.04.02 02/05/2024  Nikitha B      TSK 0945670
.           Truncated error msg to fit 80 charecter length of WEBTITLE for
.           "Visit Date is not on or after the Disaster Start Date.."
. V11.04.01 18/12/2023  Thanh T        TSK 0906342
.           Added Clear OTMAPCOD field       
. V11.02.04 23/09/2022  Bella Turco    TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.03 31/03/2022  Davin          TSK 0917793
.           Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)
. V11.02.02 09/02/2022 Thanh T         TSK 0905641 
.           Added Additional HCP Code (1-4) for outma1af                       
. V11.02.01 07/02/2022  Thanh T       TSK 0896905
.           Recompiled for ALLDEPFD changes
. V11.00.08 09/12/2020  Thanh T         TSK 0872840
.           Recompiled as PMSPX2TM changes
. V11.00.07 10/09/2020  Thanh T         TSK 0881752
.           Recompiled for OBSCNAPR changes
. V11.00.06 24/07/2020  Jill Parkinson Task 0892352
.           Fixed all option for hospital selection list
. V11.00.05 30/06/2020  Jill Parkinson Task 0892352
.           Added hospital check and use of logged in hospital default for
.           disaster list
. V11.00.04 06/04/2020  Jill Parkinson Task 0890090
.           If a visit is linked, always display, even if outside date range
. V11.00.03 06/04/2020  Jill Parkinson Task 0890090
.           Only write disaster visit link if visit is in context
.           Added delete patient disaster code (if no links exist)
. V11.00.02 23/03/2020  Jill Parkinson Task 0889915
.           Added routine to all manually adding of disaster code to patients
. V11.00.01 16/03/2020  Tracey Nguyen   TSK 0889496
.           Recompiled for MRTAUCFD/IO - Added MRACDDNR,MRACOHCP,MRACOCOF,
.           MRACODAT
.----------------------------------------------------------------------
. V10.15.01 20/02/2020  Peter Vela      TSK 0887845
.           Recompiled for NZHISWIO
. V10.14.03 30/05/2019  Thanh T.        TSK 0872539
.           Recompiled for NZHISWIO changes
. V10.14.02 14/03/2019  Don Nguyen     TSK 0869412
.           Added read of ICD10 Ed.11 Go-live Date parameter (PTCNGDX1)
. V10.14.01 27/02/2019  Ken Bell       TSK 0869548
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
.           12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
.----------------------------------------------------------------------
. V10.12.01 18/05/2018  Thanh T.       TSK 0851528
.           Recompiled for PATVISTM changed
.----------------------------------------------------------------------
. V10.11.04 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
. V10.11.03 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
. V10.10.01 17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.           Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
.----------------------------------------------------------------------
. V10.09.01 13/12/2016  Jill Parkinson TSK 0822329
.           Added definition of ACCPORD
. V10.08.01 02/11/2016  Ebon Clements  TSK 0305048
.           Recompiled for OBSCNAPR - Clinical notes enquiry
.----------------------------------------------------------------------
. V10.07.02 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
. V10.07.01 19/10/2015  Don Nguyen     CAR 316625
.           Added ALLCASFD/IO and opened file
.----------------------------------------------------------------------
. V10.06.06 26/08/2015  Jill Parkinson CAR 318680
.           Recompiled for changes to NZHISWIO
. V10.06.05 25/08/2015  Jill Parkinson CAR 320905
.           Recompiled for changes to NZHISWIO
. V10.06.04 13/08/2015  Don Nguyen    CAR 308621
.           Recompiled for PATVISTM - Added VISS6100
.           15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.06.03 17/03/2015  Davin         CAR 311669      HDP 2015/16
.           ADD PTCNGDV9 for ICD10 Ed.9 Go-live Date (Sect.110 Pos.77)
. V10.06.02 18/03/2015  Ania P          CAR 306161
.           Recompiled for OBSMED
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.----------------------------------------------------------------------
. V10.05.02 03/10/2014  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.05.01 18/09/2014  Davin           CAR 304204
.           Recompiled for GETDRG - get drg vers based on disch date
. V10.04.03 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.02 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.01 24/03/2014  Steve Armstrong  CAR 298483
.           Recompiled for changes to DGCLICOB.
.----------------------------------------------------------------------
. V10.03.14 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIFD.
. V10.03.13 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.12 20/06/2013  Davin         CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.11 03/05/2013  Steve Armstrong   CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.10 29/04/2013  Ebon Clements     CAR 261630
.           Removed temp file that was not used
. V10.03.09 29/04/2013  Ebon Clements CAR 261630
.           Removed port number from temp file name
. V10.03.08 23/04/2013  Davin         CAR 284420      HDP 2013/14
.           ADD PTCNGDV8 for ICD10 Ed.8 Go-live Date (Sect.110 Pos.69)
. V10.03.07 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.06 26/03/2013  Don Nguyen     CAR 282342  
.           Recompiled for PATGBCRN
. V10.03.05 18/07/2012  Don Nguyen     CAR 264561  
.           Recompiled for PATGBCRN
. V10.03.04 16/05/2012  Steve Armstrong  CAR 256322
.           Recompiled for changes to NZHISWIO.
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 20/12/2011  Ebon Clements   CAR 256566
.           Added current and discharged to ED visit type display - DCSTAB00
.           Changed ED visits to display discharge doctor - EMVIUR02 - DCSTAB00
. V10.03.01 17/11/2011  Peter Vela      CAR 249969
.           Fixed Visit Type display for RF and OP @ DCSTAB00
.----------------------------------------------------------------------
. V10.02.14 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.13 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.12 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.11 06/09/2011  Jill Parkinson    CAR 250366
.           Added ; to addrow lines
. V10.02.10 06/09/2011  Davin             CAR 250366
.           Added call to CALCAGE before PATLN000
. V10.02.09 06/09/2011  Peter Vela        CAR 249969
.           Added WAT Type and WAT Diagnosis to DCSTAB00
. V10.02.08 06/09/2011  Peter Vela        CAR 249983
.           Added EMR Treating Doctor and EMR Diagnosis to GETVIS00
. V10.02.07 06/09/2011  Peter Vela        CAR 249983
.           Added EMR Treating Doctor and EMR Diagnosis to DCSTAB00
. V10.02.06 26/08/2011  Peter Vela        CAR 249292
.           Added prefix functionality to NWDALT00
. V10.02.05 05/08/2011  Peter Vela        CAR 239559
.           Removed functionality for PTCNDIAI and used DISMASFD.DSMAAICD
. V10.02.04 04/08/2011  Steve Armstrong   CAR 247627
.           Added DGCLICUP trigger for pmsaidaf.
. V10.02.03 26/07/2011  Peter Vela        CAR 239559
.           Added DSMAAICD, DSMASTIM, DSMAETIM
. V10.02.02 20/07/2011  J.Tan             CAR 239592
.           Mods to pmsresaf file
. V10.02.01 12/05/2011  Peter Vela    CAR 239559                      
.           Created Disaster Management Server
.------------------------------------------------------------
          INC       IBAWEBDF    
.
          INC       TMPALIFD/INC
          INC       NZHISIFD/INC
.
          INC       OBSDIATD
          INC       ACCDIAFD/INC                 * AE Diagnosis
          INC       ARCVX1FD/INC                 * archive visit table
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       PRIHDBFD/INC                 * holding header file
          INC       PRIHREFD/INC                 * referral file
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       BOKDIAFD/INC
          INC       EMRCONFD/INC
          INC       EMRICDFD/INC                 * EA Diagnosis Codes
          INC       EMRLOCFD/INC
          INC       EMRUNKFD/INC
          INC       EMRVISFD/INC
          INC       IBADLABS/INC
          INC       OPLBVARS/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCDNFD/INC
          INC       MEHCONFD/INC
          INC       MEHLEGFD/INC
          INC       MLTSECFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCHCFD/INC
          INC       PATDHEAD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATEORFD/INC
          INC       PATFLTFD/INC
          INC       PATPEIFD/INC
          INC       PATUNAFD/INC
          INC       PMSCTCFD/INC
          INC       PMSEDGFD/INC
          INC       PMSOVRFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSTLEFD/INC            * Patient Titles table
          INC       PATGSRFD/INC
          INC       PATFACFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATITMFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATONLFD/INC
...          INC       HL7BMTFD/INC
          INC       PATMMBFD/INC
          INC       PATNIDFD/INC
          INC       PATPA1FD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC            * Person Responsible for Acct Cgi's
          INC       PATRGMFD/INC
          INC       PATPGRFD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       NZPSPRFD/INC
          INC       MEHLERFD/INC
          INC       MEHVI1FD/INC
          INC       PATWC1FD/INC
          INC       PATCLMTD/INC   * Claim cgi variables
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSWX1FD/INC
          INC       ACCCMTFD/INC   * ACC (nz) Comments File
          INC       ACCLODFD/INC   * ACC Claim Lodgements
          INC       PMSWORFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PATFN1FD/INC
          INC       PATWMAFD/INC
          INC       PMSEVTFD/INC
          INC       MRTAUCFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMASFD/INC
          INC       MRTHISFD/INC
          INC       MRTSTFFD/INC
          INC       MRTPDSFD/INC
          INC       MRTVISFD/INC
          INC       OUTCONFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       OUTBOAFD/INC
          INC       OUTCANFD/INC
          INC       OUTRF1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTBB1FD/INC
          INC       OUTMA1FD/INC
          INC       OUTHEDFD/INC
          INC       OUTCTYFD/INC
          INC       OUTSESFD/INC
.
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       RESLNKFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       NZPSPRTD/INC
          INC       SAVPX2FD/INC
..          INC       WATSUSFD/INC
          INC       PATW11FD/INC                                       *I-43498
          INC       PATW12FD/INC            * WIES12                   *I-51504
          INC       PTW12BFD/INC            * WIES12B
          INC       PATW13FD/INC            * WIES13
          INC       PATW14FD/INC            * WIES14                  *I-145161
          INC       PATW15FD/INC            * WIES15
          INC       PATW16FD/INC            * WIES16
          INC       PATW17FD/INC            * WIES17
.
.    ****** HPS BLR INCLUDE  STARTS HERE    **********
.
          INC       PATASFFD/INC
          INC       PATSFAFD/INC
          INC       PATDADFD/INC
          INC       PMSVX1FD/INC
          INC       OPRDEAFD/INC
          INC       AAEDI1FD/INC
          INC       AAEDE1FD/INC
          INC       PATHSPFD/INC
          INC       OUTDIAFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC
          INC       ALLRLNFD/INC
          INC       ALLENCFD/INC
          INC       ALLDEPFD/INC
.
.   ****** HPS BLR CODE ENDS HERE           **********
.
          INC       PMSAIDFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSRESFD/INC
          INC       WEBDATDF
          INC       PMSNUTFD/INC
          INC       PMSNUTTD/INC
          INC       TFILEVAR/INC
          INC       NHIDNRFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCMCFD/INC
          INC       OBSRESFD/INC
          INC       OBSPHYFD/INC
          INC       OBSCALFD/INC
          INC       OBSDITFD/INC
          INC       OBSMEDFD/INC
          INC       OBSPINFD/INC
          INC       OBSCNCFD/INC
          INC       OBSCNAFD/INC
          INC       OBSCNBFD/INC
          INC       OBSDIAFD/INC
          INC       OBSPROFD/INC
          INC       OBSBHIFD/INC
          INC       OBSBPHFD/INC
          INC       OBSREAFD/INC
          INC       OBSLABFD/INC
          INC       VARGBCRN/INC            * I-48227
          INC       VISPAYFD/INC
          INC       ALLCASFD/INC
.
ACCPORDN  DIM       20
AAEVFLAG  FORM      1                       * AAE visit flag 0=No 1=Yes
EVNTFLAG  FORM      1
EMREVENT  FORM      1
ARCFLAG   FORM      1
AUDITDTE  DIM       12
BEDTDESC  DIM       15
BLNKFLAG  FORM      1
CPPURNO   DIM       8
DISPDATE  DIM       11
DISPDAT1  DIM       11         * Display date
DISPDAT2  DIM       11         * Display date
NZHISMOD  FORM      1         * NZHIS change mode indicator
FILNHIAF  FILE      ASCII, FIXED=256       * tmp save file for forking
FILTDEPT  DIM       3
DEFTFLAG  FORM      1
TOTALALI  FORM      3
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1                       * Update Type
UPDATETY  FORM      1
URCOMFLG  FORM      1
UROUTPUT  DIM       20[50]
UROUTEND  FORM      3
PATALTID  DIM       20
PATLINK   DIM       127                     * Link to the next patient info
PMSALTID  DIM       20
PMSOVRKY  DIM       26
DISACODE  DIM       9
DISADIID  DIM       20
.
ATCHAR    INIT    "@"
ACCIDATE  DIM       11                      * Accident Date
PDCDATE   DIM       11                      * Patient Declaration Date
DECDATE   DIM       11                      * ACC Decline Date 
ACDNTFLG  FORM      1
..NRCDAYS   FORM      5
..LSTDAYS   FORM      5
WARNFLAG  FORM      1
WIESFILE  DIM       8
WARDBED   DIM       7
COUNT     FORM      3
TACCOUNT     FORM      3
WCOCOUNT     FORM      3
DEFAULTA  DIM       1    * default to all on visit list by type 0=no 1=yes
DIM3      DIM       3
DIM8      DIM       8
DIM10     DIM       10
DIM20     DIM       20
DIM25     DIM       25
DIM22     DIM       22
DIM30     DIM       30
DIM50     DIM       50
DIM60     DIM       60
DISWARD   DIM       3
DISUNIT   DIM       3
DISBED    DIM       3
DISPUSER  DIM       30
DISPDATT  DIM       25
DISPFLAG  FORM      1 
DRG041    INIT      "041"
DRG042    INIT      "042"
DRG050    INIT      "050"
DRG051    INIT      "051"
DRG052    INIT      "052"                                             *I-137125
DRG060    INIT      "060"                                             *I-197814
.
FILTFDAT  DIM       8
FILTTDAT  DIM       8
.
HOUR      FORM      2
HTMLLNK2  DIM       127
.
LASTWBED  DIM       6
LASTDOCT  DIM       6
LASTTYPE  DIM       3
LOOPCNTR  FORM      1
LNKDINDC  DIM       1
.
MIN       DIM       2
MINTIME   FORM      2
MINUTES   FORM      3
NMPNUMB   DIM       20
.
TIME      FORM      3
.
CLAIMFLG  FORM      1
CLMUPDFL  FORM      1
CODERNAM  DIM       35                       * Coder Name
CODEDFLG  FORM      1
CLNOT001  DIM       3                        * Type of Note
CLNOTEID  DIM       4                        * Clinical Note ID
CATct     INIT      "ct"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATUC1    INIT      "wa"                    * Category User Def Code 1
CATUC2    INIT      "wb"                    * Category User Def Code 2
CATUC3    INIT      "wc"                    * Category User Def Code 3
CATUC4    INIT      "wd"                    * Category User Def Code 4
CATUC5    INIT      "we"                    * Category User Def Code 5
CATUC6    INIT      "wf"                    * Category User Def Code 6
CATUC7    INIT      "wg"                    * Category User Def Code 7
CATUC8    INIT      "wh"                    * Category User Def Code 8
NOTESKEY  DIM       12                      * Noteskey
.DIM2A     DIM       2                       * Time in Hours
DIM2B     DIM       2                       * Time in Minutes
LINKTYP   DIM       1                       * 0=Desc 1=Code 2=Select List
CATHLV    INIT      "w2"                    * Category Highlight Level
STARTKEY  DIM       25                       * Starting Key
SEVRDESC  DIM      20
SELECTIO  DIM       1                       * Select IO Template No.
SHOWCDMI  DIM       1                       * Show Event Level CDM Icons
SHOWALLV  DIM       1
TXTLEN    FORM      3                       * Text Length
VISITNUM  DIM       4                       * Visit Number
VISCMFLG  FORM      1
FILENAMA  DIM       8                       * FileName of OBCAxxxx
FILENAMB  DIM       8                       * FileName of OBCBxxxx
OBCA      INIT      "obca"
OBCB      INIT      "obcb"
FAOPEN    DIM       8                       * OBCA File that is Open
FBOPEN    DIM       8                       * OBCB File that is Open
WBSEC008  DIM       3                        * Occupational Group
ALRTFLTR  DIM       2
CASEKEYS  DIM       28
CTYPDESC  DIM       25
CCRDTYPE  DIM       20
CCRDNUMB  DIM       20
CCRDEXDT  DIM       12
DELFLAG   FORM      1
FAILCNT   FORM      1
FILTFLAG  FORM      1
FILTHOSP  DIM       3
FILTTYPE  DIM       25
FILTEXCL  DIM       1
FILTVTYP  FORM      2
INFORMGP  DIM       1
OUTCDESC  DIM       25
UNKNFLAG  FORM      1                                                  *I-51223
VISTRCOD  DIM       20
VISTDESC  DIM       25
VTYPDESC  DIM       25
VISTDATE  DIM       11
VISTFLAG  FORM      1
VISTTIME  DIM       10
CODDFLAG  FORM      1
DISCFLAG  FORM      1
DDRGCODE  DIM       4
DMDCCODE  DIM       4
DRGVER    DIM       3
PUBLFLAG  FORM      1
HDPEQUIV  DIM       2
HISTDATE  DIM       8
HISTTIME  DIM       5
HISTREQB  DIM       35
HISTLOCN  DIM       30
DESCSNAG  DIM       20
DESCHOME  DIM       30
DESCCLOC  DIM       30
DESCDOCM  DIM       30
DTYPDESC  DIM       25
HWDSOUR   DIM       3                          * S37/P137 - WATCONFD
DISPSUR   DIM       8                          * Display Saved U/R Number
DISPMUR   DIM       8                          * Display Merged U/R Number
.
CHARCR    INIT      0x0D
ERRFLAG   FORM      1
EMRFLAG   FORM      1
CODEFA    INIT      "FA"
IPEVENT   INIT      "EV-IP"
OPEVENT   INIT      "EV-OP"
EMEVENT   INIT      "EV-EM"
SAVDATE   DIM       8
SAVTIME   DIM       8
SAVCHDT   DIM       8
SAVCHTM   DIM       8
SAVCHUD   DIM       4
SAVCLMNO  DIM       20
SAVETRID  DIM       24
SHOWMAP   FORM      1
SHOWSJOG  FORM      1
CODTYP    FORM      2
DISNAM70  DIM       70
NAME70    DIM       70
STARTNOT  FORM      4
ZEROTWO   INIT      "02"
FORM3     FORM      3
FORM8     FORM      8
CATDESC   DIM       25
CODDESC   DIM       25
CODESTAT  FORM      1
EPISODNO  FORM      2                       * Episode No
EPSCD001  FORM      2                       * Episode No (CGI Parameter)
.
FINFLAG   FORM      1
NMDSLIST  DIM       1                       * Show Update Medical Record        
RECCNT    FORM      3
DRECCNT   DIM       3
CHECKCNT  FORM      1
VISCOUNT  FORM      5
NOURSELC  DIM       1
OUTVISTT  DIM       1
OUTPSITE  DIM       6                       
OUTADMIS  DIM       8
OUTORDER  DIM       1                       * 0 = bookings the visit
.                                           * 1 = visits then bookings
REFTDESC  DIM       20
SHOWFRMT  DIM       1                       * Display format for visit list     
.                                           * 0 = Standars 1 = kids
SAVADMNO  DIM       8
SHOWMEDL  DIM       1                       * Show Update Medical Record        
.                                           * 0 = No 1 = Yes
SRCHVIEW  FORM      1                       * Show format for visit search
.                                           * 1 = Allied Health Visit Search
.
.         HPS BLR Comment Ends Here
MBSDESC   DIM       40
MOVEDESC  DIM       25
MRGEFLAG  FORM      1
MOVEADM   INIT      "Admission "
MOVECHG   INIT      "Change    "
MOVEDIS   INIT      "Discharged"
MOVELVE   INIT      "On Leave  "
MOVERET   INIT      "Return    "
MEH01     INIT      "MEHWEB01"
.
ALIASIND  DIM       1
ATYPDESC  DIM       25
BEDTRKEY  DIM       30
BTYPDESC  DIM       25
WARDNAME  DIM       25
TODAY     DIM       8
TRANDATE  DIM       12
ADMNDATE  DIM       12
DISCDATE  DIM       12
DATOFBIR  DIM       11
.
DLINKPRG  DIM       8
DLINKREP  DIM       2
DLINKTEM  DIM       3
.
DISPT001  DIM       20
DISPT002  DIM       9
DISPT003  DIM       8
DISPT004  DIM       8
DISPT005  DIM       3
.
EMPLNAME  DIM       30
EMPLADD1  DIM       35
EMPLADD2  DIM       35
EMPLADD3  DIM       35
EMPLADD4  DIM       35
.
LINKNUM   DIM       2
EPISODE   DIM       2
DOCTCODE  DIM       6
DSCHFLAG  FORM      1
PMVXFLAG  FORM      1
PMSVX044  DIM       3     * Coder Snags
PRIDISCD  DIM       9     * Primary Disease Code - I CAR 18122
PDIADESC  DIM       70    * Primary Disease Code Description - I CAR 18122
PRIOPRCD  DIM       9     * Primary Operation Code
POPRDESC  DIM       70    * Primary Operation Code Description
.PTVIS067  DIM       50    * Diet Comment - I SRF 22685
BRECFLAG  FORM      1
BOOKFLAG  FORM      1     * Book Referral Letter Flag
.
DOWNLD01  FORM      1
DOWNLD02  FORM      1
DOWNLD03  FORM      1
DOWNLD04  FORM      1
DOWNLD05  FORM      1
DOWNLD06  FORM      1
DOWNLD07  FORM      1
DOWNLD08  FORM      1
.
KEY1A     DIM       1
KEY4A     DIM       4
.DIM4      DIM       4
DIM6      DIM       6
DRGFLAG   FORM      1
TOTOUTS   FORM      12.2
TOTPAID   FORM      12.2
SLOTNUMB  DIM       3
SAVEURNO  DIM       8
SRCHTYPE  FORM      1
NEXTVKEY  DIM       26
PREVVKEY  DIM       26
PREVFLAG  FORM      1  
SAVKEY26  DIM       26
SAVKEY44  DIM       44
INPATVIS  INIT      " 3"
OUTPVIS   INIT      " 2"
EMERGVIS  INIT      " 1"
ALLIVIS   INIT      "10"
EVENVIS   INIT      " 9"
SITEDONE  FORM      1
SUMOUTS   FORM      12.2
SUMPAID   FORM      12.2
SUMINV    FORM      12.2
SUMJR     FORM      12.2
SHOWFLAG  FORM      1
.
CFILEPRE  DIM       3
WAITSTAT  FORM      1
STATDESC  DIM       20
STATCODE  DIM       1
CLAIMCOD  DIM       6
CLAIMTYP  DIM       1
UNITCODE  DIM       6
UNITDESC  DIM       20
PRIODESC  DIM       25
SRCRDESC  DIM       25
PRIOSTAT  DIM       25
PRIOOVER  DIM       8
OVERSTAT  DIM       1
.
PATPA001  DIM       8     * Patient U/R Number
PATPA002  DIM       8     * Date this add was changed (CCYYMMDD)
.PATPA003  DIM       35    * Previous Address Line 1
.PATPA004  DIM       35    * Previous Address Line 2
.PATPA005  DIM       35    * Previous Suburb
.PATPA006  DIM       35    * Previous Address Line 4
.PATPA007  DIM       8     * Previous Postcode
.PATPA008  DIM       20    * Previous Private Telephone
.PATPA009  DIM       20    * Previous Business Telephone
.PATPA010  DIM       3     * District of Residence
.PATPA011  DIM       20    * Previous Mobile Phone Number
.PATPA012  DIM       10    * Web User ID
.
SMPOLIC    DIM      20   * POLICE STAT. ACCT REPORTED TO
SMACDAT    DIM       8   * DATE OF ACCIDENT (YYMMDD)
SMSNAME    DIM      30   * SOLICITOR NAME
SMSTELE    DIM      12   * SOLICITOR TELEPHONE
SMCREGO    DIM      36   * CAR REGO NUMBERS INVOLVED
SMACLOC    DIM      40   * ACCIDENT LOCATION
SMDPINDI   FORM      1   * 1= DRIVER, 2= PASSENGER
SMENGAGE   DIM      20   * WHILE ENG IN-FREE FORMAT ENTRY
SMPINJUR   DIM      30   * PATIENT INJURED WHEN
SMMDTRAN   DIM      10   * MODE OF TRANSPORT
SMMECHSE   DIM      30   * MECHANISM OF SEVERIST INJURY
SMREGNSE   DIM      20   * REGION OF SEVERIST INJURY
SMOTHDE1   DIM      30   * OTHER DRIVER DETAILS LINE 1
SMOTHDE2   DIM      30   * "     "      "     LINE 2
SMOTHDE3   DIM      30   * "     "      "     LINE 3
SPTWMTAC   FORM      1   * TAC CLAIM FORM COMPLETED ?
SPTWMTYP   DIM       3   * Role in Accident (CAT RA)
.
SUPERLEV  DIM       1
SWCENAME  DIM      30    * EMPLOYER NAME
SWCEADD1  DIM      35    * EMPLOYER ADDRESS LINE 1
SWCEADD2  DIM      35    * EMPLOYER ADDRESS LINE 2
SWCEADD3  DIM      35    * EMPLOYER ADDRESS LINE 3
SWCEADD4  DIM      35    * EMPLOYER ADDRESS LINE 4
SWCEPOST  DIM       8    * EMPLOYER POSTCODE
SWCETELE  DIM      20    * EMPLOYER TELEPHONE
SWCACDAT  DIM       8    * DATE OF ACCIDENT (YYMMDD)
SWCACCPT  FORM      1    * ACCEPTED BY INSURANCE COMPANY
SWCICODE  DIM       6    * INSURANCE COMPANY CODE
SWCCLMNO  DIM      20    * INSURANCE CLAIM NUMBER 
SWCCOMN1  DIM      40    * COMMENTS
SWCCOMN2  DIM      40    * COMMENTS
SPMWXALO  DIM      50    * Accident Location                  
SPMWXCIN  DIM      3     * Cause of Injury (Cat IK)           
SPMWXICO  DIM      3     * Injury Code (Cat IJ)               
SPMWXCNA  DIM      40    * Contact Name                       
.
COMMTYPE  DIM       3    * Comment Type
COMMLINO  DIM       3    * Comment Line No
COMMCONT  FORM      3    * Comment Count
SAVDATA1  DIM       65 
SAVDATA2  DIM       100 
.
.
PTMMB001  DIM        9             * MBS Code
PTMMB002  DIM        8             * Admission Number
PTMMB003  FORM       2             * Record number for admission
PTMMB004  DIM        8             * Operation Date
PTMMB005  DIM        5             * Operation Start Time
PTMMB006  DIM        5             * Operaton End Time
PTMMB007  DIM       70             * Free Format description
.
DISMA001  DIM        9             * Disaster Code
DISMA002  DIM        60            * Disaster Description
DISMA003  DIM        8             * Disaster Start Date
DISMA004  DIM        8             * Disaster End Date
DISMA005  DIM        1             * Active/Inactive/Pending
DISMA006  DIM        3             * Alternate Id Code for this Disaster
DISMA007  DIM        8             * Disaster Start Time
DISMA008  DIM        8             * Disaster End Time
DISMA009  DIM        3             * Patient Disaster Outcome
DISMA010  DIM        8             * Patient Disaster End Date
DISMA011  DIM        8             * Patient Disaster End Time
.
DASH      INIT      "-"
PFFUND    DIM       1     * Program Funding Source
CBOOK     FORM      1     
HBWAIT    FORM      1 
.
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
ENDDAT    DIM       8
ENDDTIME  DIM       5
TACRECKY  DIM       8[50]
WCORECKY  DIM       8[50]
ERRORCNT  FORM      3                 * Count of Errors
ERRORLST  DIM       90[50]            * Error Array
.
.   ****** HPS BLR DECLARATION STARTS HERE    ***********
.
.         HPS BLR Code Starts Here
VISADIAG  DIM       12                *Diagnosis Code
ADIADESC  DIM       25
ADIADESL  DIM       50
DDIADESC  DIM       25
VISTLOC   DIM       50
VISHOSID  INIT      "01"
SECOPT    DIM       1
VISTDAY   DIM       5
PVISYSN   FORM      2
VISTCOMH  INIT      "COM"
VISTEMER  INIT      "EMG"
VISTOUTP  INIT      "OP"
VISTINPT  INIT      "IP"
VISTALLH  INIT      "RF"
VISTEVNT  INIT      "EV"
VISTTYPE  DIM       5
VSTATUS   DIM       35
VIEWFLAG  FORM      1
VOLNDESC  DIM       16
.
EMGSTAT1  INIT      "Current"
.
INPSTAT1  INIT      "Pre-adm"
INPSTAT2  INIT      "Current IP"
INPSTAT3  INIT      "Discharged"
INPSTA3A  INIT      "Disc-"
INPSTA3B  INIT      "Cancelled"
INPSTAT4  INIT      "Leave"
INPSTAT5  INIT      "Cancel"
.
ALLSTAT0  INIT      "Waiting"
ALLSTAT1  INIT      "Active"
ALLSTAT2  INIT      "Closed"
ALLSTAT3  INIT      "Inactive"
ALLSTAT4  INIT      "Cancelled"
ALLSTAT5  INIT      "Rejected"
.
WLSTAT1   INIT      "Unscheduled"
WLSTAT2   INIT      "Scheduled"
WLSTAT3   INIT      "Pre-Admitted"
WLSTAT4   INIT      "Admitted"
WLSTAT5   INIT      "Discharged"
WLSTAT6   INIT      "Removed from W/L"
WLSTAT7   INIT      "Performed"
WLSTAT8   INIT      "Not Performed"
WLSTAT9   INIT      "Cancelled Booking"
.
OEVSTA0   INIT      "Outpatient-ATTENDED"
OEVSTA1   INIT      "Outpatient-NO ATTENDANCE"
OEVSTA2   INIT      "Outpatient-CANCELLED"
OBRACKET  INIT      "("
CBRACKET  INIT      ")"
.
.
SUBMITED  INIT      "Submitted"
SENT      INIT      "Sent"
RECEIPTD  INIT      "Receipted"
FAILED    INIT      "Failed"
SLSH      INIT      "/"
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
.------------------------------------------------------------------------
PRGID     INIT      "DISWEB01"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Disaster Management Server"
.------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION DISWEB01",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      DISMA000      * Disaster Management Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      DISPT000      * Disaster Codes Patient Level
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      GETPAT00
          GOTO      MAIN1000
.
MAIN1400  CALL      DISLS000      * Disaster Code Summary View
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00   * Open Files Required for PATMASTM
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      DISPTLA2,"disptlaf"
          OPEN      EMRLOCA1,"emrlocaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      MRTAUCA2,"mrtaucaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTSTFA1,"mrtstfaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTPDSA1,"mrtpdsaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDADA1,"patdadaf" 
          OPEN      PATCHCO1,"patchcof"
          OPEN      PATFACT1,"patfactf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATINVR5,"patinvrf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATUNAA1,"patunaaf"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSAIDA2,"pmsaidaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSCTCA1,"pmsctcaf"
          OPEN      ACCDIAA1,"accdiaaf"          * EA Diagnosis
          OPEN      EMRICDA1,"emricdaf"          * EA Diagnosis Codes
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOVRA1,"pmsovraf"
          TRAPCLR   IO
.
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"          *
          OPEN      PATPA1A1,"patpa1af"
          OPEN      PATPGRA1,"patpgraf" 
          OPEN      PATGSRN1,"patgsrnf" 
          OPEN      PATICDO1,"paticdof"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATI10O1,"pati10of"
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
          OPEN      PATFLET2,"patfltrf"
          OPEN      PMSCDNA1,"pmscdnaf"
.
          MOVE      ZERO,ARCFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ARCVX1A1,"arcvx1af"
          TRAPCLR   IO
          IF        OVRCD=0
            MOVE      ONE,ARCFLAG
          ENDIF
.
          OPEN      PMSVX1A1,"pmsvx1af" 
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WEBSECA3,"websecaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      VISPAYA1,"vispayaf"
.
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHVI1A4,"mehvi1af"           * I SRF 22727
          OPEN      MEHLEGA1,"mehlegaf"           * I SRF 22727
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATMMBS2,"patmmbsf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATNIDA2,"patnidaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATSFAA1,"patsfaaf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWMAB2,"patwmabf"
          OPEN      PATWMAB3,"patwmabf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWC1A2,"patwc1af"
          OPEN      PATWC1A3,"patwc1af"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      ACCCMTA1,"acccmtaf"
          OPEN      PMSRESA1,"pmsresaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PATW11A1,"patw11af"                                *I-43498
          OPEN      PATW12A1,"patw12af"                                *I-51504
          OPEN      PATW12B1,"patw12bf"
          OPEN      PATW13A1,"patw13af"
          OPEN      PATW14A1,"patw14af"                               *I-145161
          OPEN      PATW15A1,"patw15af"
          OPEN      PATW16A1,"patw16af"
          OPEN      PATW17A1,"patw17af"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRUNKA1,"emrunkaf"
          OPEN      EMRVISA1,"emrvisaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATECDA2,"patecdaf"
          OPEN      PATECOA2,"patecoaf"
.
          CALL      OPICD1                      * Open ICD Disease files
          CALL      OPICO1                      * Open ICD Operation files
.
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PMSNUTA1,"pmsnutaf"         * new nutrition file v9.02.17
          OPEN      OBSPINA1,"obspinaf"
          OPEN      OBSCNAA1,"obscnaaf"
          OPEN      OBSCNBA1,"obscnbaf"
          OPEN      OBSCNCA1,"obscncaf"
          OPEN      OBSCNCA2,"obscncaf"
          OPEN      OBSDIAA1,"obsdiaaf"
          OPEN      OBSBPHA1,"obsbphaf"
          OPEN      OBSPROA1,"obsproaf"
          OPEN      OBSREAA1,"obsreaaf"
          OPEN      OBSBHIA1,"obsbhiaf"
          OPEN      OBSLABA1,"obslabaf"
          OPEN      OBSMEDA1,"obsmedaf"
          OPEN      OBSRESA1,"obsresaf"
          OPEN      OBSPHYA1,"obsphyaf"
          OPEN      OBSDITA1,"obsditaf"
          OPEN      OBSCALA1,"obscalaf"
          OPEN      OBSCALA1,"obscalaf"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      IBASPOL1,"ibaspolf"         * For spool file       
          OPEN      CONTROLF,"controlf"         * For spool file       
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,HUND12;*101,PTCNUFFR,*104,PTCNWBDS
          READ      CONTROLF,HUND10;*240,PTCNUALT
          READ      CONTROLF,HUND16;*214,PTCNDCDM
          READ      CONTROLF,HUND18;*153,PTCNUDPD
          READ      CONTROLF,HUND06;*203,ALCNMDES
          READ      CONTROLF,FIFTY9;*193,PTCNRQCF
          READ      CONTROLF,HUND06;*217,ALCNCLNF
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        !@EQUAL
            OPEN      MRTSTFA1,"mrtstfaf"
          ENDIF
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
           
.
.  Katie - have a look into what this if statement is doing 01/02/200 - Comments at Taranaki
.
..          READ      CONTROLF,TWENTY;*164,PTCNUPCM
..          IF        PTCNUPCM=1
..            OPEN      PATCMNT1,"patxcmaf"     * new extra comments file
..          ELSE
.
..            OPEN      PATCMNT1,"patcmntf"
.
..          ENDIF
...........

          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,TEN;*126,CLABPG,CLABPRT,*235,CMDISP
          READ      CONTROLF,TEN3;*188,CMABINS,CVETINS
          READ      CONTROLF,TWENTY;*223,PTCNLNFF,*224,PTCNCHFF
          READ      CONTROLF,THIRTY7;*137,HWDSOUR
          READ      CONTROLF,FIFTY9;*35,CTYPLAB,*220,PTCNUADT
          READ      CONTROLF,EIGHTY;*249,PTCNEDTE
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D
          READ      CONTROLF,EIGHTY9;*180,EMCNLDAT
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM 
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,*69,MHCNUSE,*82,MHCNDVIS
          READ      CONTROLF,HUND09;*177,PTCNNHTM
          READ      CONTROLF,TWENTY;*52,PTPCLRES
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,HUND05;*158,PTCNDGPV,*211,PTCNBPAY: *I-43526I-48227
                                    *217,PTCNGDV4,*227,PTCNGDV5       *C-105244
          READ      CONTROLF,HUND09;*151,PTCNGDV3                      *I-51504
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*239,PTCNGDV6        *C-163918
          READ      CONTROLF,HUND10;*61,PTCNGDV7:                     *I-219246
                                    *69,PTCNGDV8:                     *I-284420
                                    *77,PTCNGDV9,*85,PTCNGDVX         *I-0833093
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,HUND28;*231,PTCNGDX2                     *I-0917793
          READ      CONTROLF,HUND30;*86,PTCNGDX3                      *I-0956210
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          OPEN      OUTSITA3,"outsitaf"     * Open the site file
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files 
          OPEN      OUTRF1A1,"outrf1af"
          IF        PTCNNHII=1
            OPEN      PATMWSA1,"patmwsaf"
          ENDIF
.
          OPEN      ALLCASA1,"allcasaf"
.
INIT9999  RETURN
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to 
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRSHA1
          CLOSE     OUTRSHA1
          OPEN      OUTRSHA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCANA2
          CLOSE     OUTCANA2
          OPEN      OUTCANA2,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BOKA3 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME     
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILDIAG1
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME    
.
OPNOUT99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,PATALTID
          MOVE      SP70,PMSALTID
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,EPSCD001
          MOVE      SP70,SAVEURNO
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,STARTNOT
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,NOURSELC
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,SRCHTYPE
          MOVE      ZERO,DOWNLD01
          MOVE      ZERO,DOWNLD02
          MOVE      ZERO,DOWNLD03
          MOVE      ZERO,DOWNLD04
          MOVE      ZERO,DOWNLD05
          MOVE      ZERO,DOWNLD06
          MOVE      ZERO,DOWNLD07
          MOVE      ZERO,DOWNLD08
          MOVE      SP70,SHOWALLV
          MOVE      SP70,PATPA001
          MOVE      SP70,PATPA002
          MOVE      SP70,PMSVX044      * Coder Snags
          MOVE      ZERO,CODEDFLG
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,FILTFDAT
          MOVE      SP70,FILTTDAT
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,CHECKCNT
          MOVE      SP70,CLNOT001
          MOVE      SP70,WBSEC008
          MOVE      SP70,ALRTFLTR
          MOVE      ZERO,BOOKFLAG
.          MOVE      Z70,PTVIS067       * I SRF 22685
          MOVE      ZERO,FILTVTYP
          MOVE      ZERO,FILTFLAG
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTTYPE
          MOVE      SP70,FILTEXCL
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,NEXTVKEY
          MOVE      SP70,PREVVKEY
          MOVE      ZERO,PREVFLAG
          MOVE      ZERO,UPDATETY
          MOVE      ZERO,EMREVENT
          MOVE      SP70,SUPERLEV
.
          MOVE     SP70,PTCLM001
          MOVE     SP70,PTCLM002
          MOVE     SP70,PTCLM003
          MOVE     SP70,PTCLM004
          MOVE     SP70,PTCLM005
          MOVE     SP70,PTCLM006
          MOVE     SP70,PTCLM007
          MOVE     SP70,PTCLM008
          MOVE     SP70,PTCLM010
          MOVE     SP70,PTCLM011
          MOVE     SP70,PTCLM012
          MOVE     SP70,PTCLM013
          MOVE     SP70,PTCLM014
          MOVE     SP70,PTCLM015
          MOVE     SP70,PTCLM016
          MOVE     SP70,PTCLM017
          MOVE     SP70,PTCLM018
          MOVE     SP70,PTCLM019
          MOVE     SP70,PTCLM020
          MOVE     SP70,PTCLM021
          MOVE     SP70,PTCLM022
          MOVE     SP70,PTCLM023
          MOVE     SP70,PTCLM024
          MOVE     SP70,PTCLM025
          MOVE     SP70,PTCLM026
          MOVE     SP70,PTCLM027
          MOVE     SP70,PTCLM028
          MOVE     SP70,PTCLM029
          MOVE     SP70,PTCLM030
          MOVE     SP70,PTCLM031
          MOVE     SP70,PTCLM032
          MOVE     SP70,PTCLM033
          MOVE     SP70,PTCLM034
          MOVE     SP70,PTCLM035
          MOVE     SP70,PTCLM036
          MOVE     SP70,PTCLM037
          MOVE     SP70,PTCLM038
          MOVE     SP70,PTCLM039
          MOVE     SP70,PTCLM040
          MOVE     SP70,PTCLM041
          MOVE     SP70,PTCLM042
          MOVE     SP70,PTCLM043
          MOVE     SP70,PTCLM044
          MOVE     SP70,PTCLM045
          MOVE     SP70,FILTDEPT
          MOVE     ZERO,DEFTFLAG
          MOVE     SP70,PMSOVRKY
          MOVE     SP70,DISACODE
          MOVE     SP70,DISADIID
.
          CALL      CLPTPRA0                * clear P.R.A cgi variables
.
          MOVE      ONE,TACCOUNT
          WHILE     TACCOUNT <= 50
            MOVE      SP70,TACRECKY[TACCOUNT]
            ADD       ONE,TACCOUNT
          DO
.
          MOVE      ONE,WCOCOUNT
          WHILE     WCOCOUNT <= 50
            MOVE      SP70,WCORECKY[WCOCOUNT]
            ADD       ONE,WCOCOUNT
          DO
.
          MOVE      ZERO,TACCOUNT
          MOVE      ZERO,WCOCOUNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,SRCHVIEW
.
.---start *I-903005 ---
.
          PACK      WLINE1A,SP30,SP30            
          PACK      WLINE2A,SP30,SP30 
          PACK      WLINE3A,SP30,SP30            
          PACK      WLINE4A,SP30,SP30
          PACK      WLINE5A,SP30,SP30
          PACK      WLINE6A,SP30,SP30
          PACK      WLINE7A,SP30,SP30
          PACK      WLINE8A,SP30,SP30
.
.---end *I-903005 ---
.
          MOVE      SP70,PTMMB001
          MOVE      ZEROVISN,PTMMB002
          MOVE      ZERO,PTMMB003
          MOVE      SP70,PTMMB004
          MOVE      SP70,PTMMB005
          MOVE      SP70,PTMMB006
          MOVE      SP70,PTMMB007
.
          MOVE      SP70,DISMA001
          MOVE      SP70,DISMA002
          MOVE      SP70,DISMA003
          MOVE      SP70,DISMA004
          MOVE      SP70,DISMA005
          MOVE      SP70,DISMA006
          MOVE      SP70,DISMA007
          MOVE      SP70,DISMA008
          MOVE      SP70,DISMA009
          MOVE      SP70,DISMA010
          MOVE      SP70,DISMA011
.
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
          MOVE      SP70,DISPT003
          MOVE      SP70,DISPT004
          MOVE      SP70,DISPT005
.
          MOVE      SP70,STARTKEY
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nourselc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOURSELC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataltid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATALTID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsaltid=",QRYNAME
          IF        @EQUAL
            PACK      PMSALTID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            PACK      ADMISSNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showallv=",QRYNAME
          IF        @EQUAL
            PACK      SHOWALLV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmnut",QRYNAME
          IF        @EQUAL
            CALL      SPNUT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnot=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,STARTNOT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epscd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtype=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SRCHTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx044=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX044
            PACK      PMSVX044,PMSVX044,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "codedflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CODEDFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lfstdate=",QRYNAME
          IF        @EQUAL
            MOVE      "00000000",FRSTDATE
            MATCH     SP20,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      FRSTDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",FRSTDATE
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "llstdate=",QRYNAME
          IF        @EQUAL
            MOVE      "99999999",LASTDATE
            MATCH     SP20,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      LASTDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",LASTDATE
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clnot001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLNOT001
            PACK      CLNOT001,CLNOT001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbsec008",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBSEC008
            PACK      WBSEC008,WBSEC008,SP70
            GOTO      SETPAR99
          ENDIF
.
.          MATCH     "ptvis067=",QRYNAME            * I SRF 22685
.          IF        @EQUAL
.            MOVE      QRYDATA,PTVIS067             * Populate CGI parameter
.            GOTO      SETPAR99                     * with diet comment
.          ENDIF
.                                                  * end I SRF 22685
          MATCH     "filtvtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTVTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtexcl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTEXCL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrtfltr=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,ALRTFLTR
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "updtacno",QRYNAME
          IF         @EQUAL
            COMPARE   "99",TACCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,TACCOUNT
            PACK      TACRECKY[TACCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "updwcono",QRYNAME
          IF         @EQUAL
            COMPARE   "99",WCOCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,WCOCOUNT
            PACK      WCORECKY[WCOCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
. *I-903005 ---- start
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcopy=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOLABEL
            GOTO      SETPAR99
          ENDIF
.
. *I-903005 ---- end
.
          CALL       SPPRA000          * Set parameters for PRFA
.
          MATCH     "ptmmb",QRYNAME
          IF        @EQUAL
            CALL      STMMB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtfdat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      FILTFDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MATCH     "filttdat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      FILTTDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "filtdept=",QRYNAME
          IF        @EQUAL
            PACK      FILTDEPT,QRYDATA,SP70
          ENDIF
.
          MATCH     "deftflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTFLAG
          ENDIF
.
          MATCH     "pmsovrky=",QRYNAME
          IF        @EQUAL
            PACK      PMSOVRKY,QRYDATA,SP70
          ENDIF
.
          MATCH     "disma",QRYNAME
          IF        @EQUAL
            CALL      STDIS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt",QRYNAME
          IF        @EQUAL
            CALL      STDIP000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            REP       "~'",STARTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "disacode=",QRYNAME
          IF        @EQUAL
            PACK      DISACODE,QRYDATA,SP70
          ENDIF
.
          MATCH     "disadiid=",QRYNAME
          IF        @EQUAL
            PACK      DISADIID,QRYDATA,SP70
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
.   Set Parameters for Medical Records MBS
.------------------------------------------------------------
STMMB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMMB010,STMMB020,STMMB030,STMMB040,STMMB050:
                       STMMB060,STMMB070
.
          MOVE      ONE,EXIT
          GOTO      STMMB999

STMMB010  PACK      PTMMB001,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB020  MOVE      QRYDATA,PTMMB002
          GOTO      STMMB999
.
STMMB030  MOVE      QRYDATA,PTMMB003
          GOTO      STMMB999
.
STMMB040  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTMMB004,CCENT,CYEAR,CMON,CDAY
          GOTO      STMMB999
.
STMMB050  PACK      PTMMB005,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB060  PACK      PTMMB006,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB070  PACK      PTMMB007,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB999  RETURN
+
.------------------------------------------------------------
. Process Fields in Body of HTML Template
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
.
          GOTO      PROFLD99
.
PROFLD11  CALL      DSMA0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
.
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      DSPT0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34
.
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      TABL0000
          GOTO      PROFLD99
.
PROFLD33  CALL      DSMA0000
          GOTO      PROFLD99
.
PROFLD34  CALL      DSPT0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
.
          GOTO      PROFLD99
.
PROFLD41  CALL      TABL0000
          GOTO      PROFLD99
.
PROFLD42  CALL      DSMA0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.---------------------------------------------------------------------
.         Display of the Following Fields                   
.---------------------------------------------------------------------
DSMA0000  BRANCH    FLDITMNO,DSMA1010,DSMA1020,DSMA1030,DSMA1040,DSMA1050:
                             DSMA1060,DSMA1070,DSMA1080,DSMA1090,DSMA1100:
                             DSMA1110,DSMA1120,DSMA1130,DSMA1140,DSMA1150
.
          GOTO      DSMA9999
.
DSMA1010  CALL      DSTB0000
          GOTO      DSMA9999
.
DSMA1020  CALL      PREV0000
          GOTO      DSMA9999
.
DSMA1030  CALL      NEXT0000
          GOTO      PROFLD99
.
DSMA1040  MATCH     SP70,STARTKEY
          GOTO      DSMA9999 IF EQUAL
          WRITE     HTMLFILE;STARTKEY;
          GOTO      DSMA9999
.
DSMA1050  WRITE     HTMLFILE;DSMACODE;
          GOTO      DSMA9999
.
DSMA1060  WRITE     HTMLFILE;DSMADESC;
          GOTO      DSMA9999
.
DSMA1070  MATCH     DSMASDAT,SP70        * Start Date
          GOTO      DSMA9999 IF EQUAL
.
          UNPACK    DSMASDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSMA9999
.
DSMA1080  MATCH     DSMAEDAT,SP70        * Start Date
          GOTO      DSMA9999 IF EQUAL
.
          UNPACK    DSMAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSMA9999
.
DSMA1090  WRITE     HTMLFILE;DSMAACTV;
          GOTO      DSMA9999
.
DSMA1100  MATCH     "1",DSMAACTV
          IF        @EQUAL
            WRITE     HTMLFILE;"Pending";
          ENDIF
.
          MATCH     "2",DSMAACTV
          IF        @EQUAL
            WRITE     HTMLFILE;"Active";
          ENDIF
.
          MATCH     "3",DSMAACTV
          IF        @EQUAL
            WRITE     HTMLFILE;"Inactive";
          ENDIF
.
          GOTO      DSMA9999
.
DSMA1110  MOVE      "AI",CATEGORY
          MOVE      DSMAAICD,CODE
          CALL      CODITM00
          GOTO      DSMA9999
.
DSMA1120  WRITE     HTMLFILE;DSMASTIM;
          GOTO      DSMA9999
.
DSMA1130  WRITE     HTMLFILE;DSMAETIM;
          GOTO      DSMA9999
.
DSMA1140  WRITE     HTMLFILE;PTCNUDPD;
          GOTO      DSMA9999
.
. output 0 if no linked visits or 1 if linked visits exist(ignore blank visit)
DSMA1150  PACK      KEY25,DSPTURNO,DSMACODE,SP70
          CALL      RSDSPTL1
DSMA1155  CALL      RKDSPTL1
          BRANCH    OVRCD,DSMA1156
.
          MATCH     DSPTURNO,DSPLURNO
          GOTO      DSMA1156 IF NOT EQUAL
.
          MATCH     DSMACODE,DSPLCODE
          GOTO      DSMA1156 IF NOT EQUAL
.
          MATCH     SP70,DSPLVISN
          GOTO      DSMA1155 IF EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      DSMA9999
.
DSMA1156  WRITE     HTMLFILE;ZERO;
          GOTO      DSMA9999
.
DSMA9999  RETURN
+
.---------------------------------------------------------------------
.         Disaster Code Maintenance Table 
.---------------------------------------------------------------------
DSTB0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      DSHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY9,STARTKEY,SP70
          CALL      RSDSMAS1
          IF        OVRCD=0
            CALL      RPDSMAS1
          ENDIF
DSTB0100  CALL      RKDSMAS1
          BRANCH    OVRCD,DSTB9000
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      DSTB0100
          ENDIF
.
          CALL      DSROW000      * Display Disaster Code Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      DSTB0100 IF NOT EQUAL
          GOTO      DSTB9999
.
DSTB9000  CALL      NOMORE00      * Display No More Records Message
.
DSTB9999  RETURN
.
.------------------------------------------------------------
. Disaster Code Maintenance (TABLE HEADING)
.------------------------------------------------------------
DSHED000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=15%>":
                             "Disaster Code</td>":
                             "<td class=HeadingCell width=30%>":
                             "Description</td>":
                             "<td class=HeadingCell width=20%>":
                             "Start Date</td>":
                             "<td class=HeadingCell width=20%>":
                             "End Date</td>":
                             "<td class=HeadingCell width=15%>":
                             "Status</td>":
                             "</tr>"
.
DSHED999  RETURN
.
.------------------------------------------------------------
. Disaster Code Maintenance (TABLE ROW)
.------------------------------------------------------------
DSROW000  MATCH     SP70,DSMADESC
          IF        @EQUAL
            MOVE      "&nbsp;",KEY60
          ELSE
            MOVE      DSMADESC,KEY60
          ENDIF
.
          MOVE      SP70,KEY8
          MATCH     "1",DSMAACTV
          IF        @EQUAL
            MOVE      "Pending",KEY8
          ENDIF
.
          MATCH     "2",DSMAACTV
          IF        @EQUAL
            MOVE      "Active",KEY8
          ENDIF
.
          MATCH     "3",DSMAACTV
          IF        @EQUAL
            MOVE      "Inactive",KEY8
          ENDIF
.
          MOVE      "&nbsp",DISPDAT1
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL
            UNPACK    DSMASDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          MOVE      "&nbsp",DISPDAT2
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL
            UNPACK    DSMAEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&disma001=",DSMACODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DSMACODE,"</td>":
                             "<td>",KEY60,"</td><td>",DISPDAT1,"</td>":
                             "<td>",DISPDAT2,"</td><td>",KEY8,"</td>":
                             "</tr>"
.
DSROW999 RETURN
.------------------------------------------------------------
. Disaster Codes: Display,Add,Update,Delete
.------------------------------------------------------------
DISMA000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      DISMA040 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add Formaction
          GOTO      DISMA010 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update Formaction
          GOTO      DISMA020 IF EQUAL
.
          GOTO      DISMA093
.
.         ************ ADD FORMACTION ***********
.
DISMA010  PACK      KEY9,DISMA001,SP70
          CALL      RDDSMAS1
          COMPARE   ZERO,OVRCD
          GOTO      DISMA092 IF EQUAL
.
          PACK      DSMACDAT,CCC,CYY,CMM,CDD
          REP       " 0",DSMACDAT
          CLOCK     TIME,DSMACTIM
          MOVE      WBSEUID,DSMACUSR
          MOVE      SP70,DSMAUUSR
          MOVE      SP70,DSMAUDAT
          MOVE      SP70,DSMAUTIM
.
          CALL      DISSAV00      * Moves input variables to file variables
          PACK      KEY9,DISMA001,SP70
          CALL      WRDSMAS1      * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      DISMA999
.
.         ************ UPDATE FORMACTION **********
.
DISMA020  PACK      KEY9,DISMA001,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISMA091
.
          PACK      DSMAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",DSMAUDAT
          CLOCK     TIME,DSMAUTIM
          MOVE      WBSEUID,DSMAUUSR
.
          PACK      KEY9,DISMA001,SP70
          CALL      DISSAV00      * Moves input variables to file variables
          CALL      UPDSMAS1      * Writes away the data
.
          CALL      UPDSPT00
.
          MOVE      ZERO,EXIT
          GOTO      DISMA999
.
.         ************ DISPLAY FORMACTION **********
.
DISMA040  PACK      KEY9,DISMA001,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            CALL      CLRDIS00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Disaster Code Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISMA999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DISMA999
.
DISMA091  MOVE      "Disaster Code does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISMA999
.
DISMA092  MOVE      "Disaster Code exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISMA999
.
DISMA093  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISMA999
.
DISMA999  RETURN
+
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXT0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"disweb01.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
NEXT9999  RETURN
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREV0000  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"disweb01.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&startkey=",STARTKEY;
.
PREV9999  RETURN
+
.-------------------------------------------------------------------------------
.   Reportno 1: Set Parameters - Disaster Code File
.-------------------------------------------------------------------------------
STDIS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STDIS001,STDIS002,STDIS003,STDIS004,STDIS005:
                       STDIS006,STDIS007,STDIS008,STDIS009,STDIS010:
                       STDIS011
.
          GOTO      STDIS999
.
STDIS001  MOVE      QRYDATA,DISMA001
          GOTO      STDIS999
.
STDIS002  MOVE      QRYDATA,DISMA002
          GOTO      STDIS999
.
STDIS003  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DISMA003,CCENT,CYEAR,CMON,CDAY
          GOTO      STDIS999
.
STDIS004  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DISMA004,CCENT,CYEAR,CMON,CDAY
          GOTO      STDIS999
.
STDIS005  MOVE      QRYDATA,DISMA005
          GOTO      STDIS999
.
STDIS006  MOVE      QRYDATA,DISMA006
          GOTO      STDIS999
.
STDIS007  MOVE      QRYDATA,DISMA007
          GOTO      STDIS999
.
STDIS008  MOVE      QRYDATA,DISMA008
          GOTO      STDIS999
.
STDIS009  MOVE      QRYDATA,DISMA009
          GOTO      STDIS999
.
STDIS010  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DISMA010,CCENT,CYEAR,CMON,CDAY
          GOTO      STDIS999
.
STDIS011  MOVE      QRYDATA,DISMA011
          GOTO      STDIS999
.
STDIS999  RETURN
+
.------------------------------------------------------------
. Moves cgi variables into file variables
.------------------------------------------------------------
DISSAV00  MOVE      DISMA001,DSMACODE  * Disaster Code
          MOVE      DISMA002,DSMADESC  * Disaster Description
          MOVE      DISMA003,DSMASDAT  * Disaster Start Date
          MOVE      DISMA004,DSMAEDAT   * Disaster End Date
          MOVE      DISMA005,DSMAACTV   * Disaster Status       
          MOVE      DISMA006,DSMAAICD   * Disaster Alternate ID
          MOVE      DISMA007,DSMASTIM   * Disaster Start Time
          MOVE      DISMA008,DSMAETIM   * Disaster End Time
          MOVE      SP70,DSMASPAR       * Spare
.
DISSAV99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRDIS00  MOVE      SP70,DSMACODE     * Disaster Code
          MOVE      SP70,DSMADESC     * Disaster Description
          MOVE      SP70,DSMASDAT     * Disaster Start Date
          MOVE      SP70,DSMAEDAT     * Disaster End Date         
          MOVE      SP70,DSMAACTV     * Disaster Status   
          MOVE      SP70,DSMAAICD     * Disaster Alternate ID
          MOVE      SP70,DSMASTIM     * Disaster Start Time
          MOVE      SP70,DSMAETIM     * Disaster End Time
          MOVE      SP70,DSMASPAR     * Spare
.
CLRDIS99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRDPT00  MOVE      SP70,DSPTURNO
          MOVE      SP70,DSPTDIID
          MOVE      SP70,DSPTCODE
          MOVE      SP70,DSPTSDAT
          MOVE      SP70,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      SP70,DSPTFICA
          MOVE      SP70,DSPTCUSR
          MOVE      SP70,DSPTCDAT
          MOVE      SP70,DSPTCTIM
          MOVE      SP70,DSPTUUSR
          MOVE      SP70,DSPTUDAT
          MOVE      SP70,DSPTUTIM
          MOVE      SP70,DSPTSPAR
.
CLRDPT99  RETURN
.-----------------------------------------------------------
. Update Disaster End Date in dispataf
.-----------------------------------------------------------
UPDSPT00  MATCH     "1",PTCNUDPD
          IF        !@EQUAL
.
            PACK      KEY17,DISMA001,SP70
            CALL      RSDSPAT2
UPDSPT10    CALL      RKDSPAT2
            BRANCH    OVRCD,UPDSPT99
.
            PACK      DISMA001,DISMA001,SP70
.
            MATCH     DSPTCODE,DISMA001
            GOTO      UPDSPT99 IF NOT EQUAL
.
            MATCH     SP70,DSMAEDAT
            IF        !@EQUAL & !@EOS
              MOVE      DSMAEDAT,DSPTEDAT
            ENDIF
.
            CALL      UPDSPAT2
.
            GOTO      UPDSPT10
.
          ELSE
.
            PACK      KEY17,DISMA001,SP70
            CALL      RSDSPAT2
UPDSPT50    CALL      RKDSPAT2
            BRANCH    OVRCD,UPDSPT99
.
            PACK      DISMA001,DISMA001,SP70
.
            MATCH     DSPTCODE,DISMA001
            GOTO      UPDSPT99 IF NOT EQUAL
.
            MATCH     SP70,DISMA009
            IF        !@EQUAL & !@EOS
              MATCH     SP70,DSPTOTCM
              IF        @EQUAL | @EOS
                MOVE      DISMA009,DSPTOTCM
              ENDIF
            ENDIF
.
            MATCH     SP70,DISMA010
            IF        !@EQUAL & !@EOS
              MATCH     SP70,DSPTEDAT
              IF        @EQUAL | @EOS
                MOVE      DISMA010,DSPTEDAT
              ENDIF
            ENDIF
.
            MATCH     SP70,DISMA011
            IF        !@EQUAL & !@EOS
              MATCH     SP70,DSPTETIM
              IF        @EQUAL | @EOS
                MOVE      DISMA011,DSPTETIM
              ENDIF
            ENDIF
.
            CALL      UPDSPAT2
.
            GOTO      UPDSPT50
.
          ENDIF
.
UPDSPT99  RETURN
.
.------------------------------------------------------------
. Disaster Codes Patient Level: Display,Add,Update,Delete
.------------------------------------------------------------
DISPT000  IF        PTCNNHII=1
            CALL      CONNECT      * Basic Patient Details
          ENDIF
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      DISPT050 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Add
          GOTO      DISPT020 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      DISPT030 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      DISPT040 IF EQUAL
.
          GOTO      DISPT093
.
.         ************ ADD FORMACTION  **********
DISPT020  CALL      DISWAR00
          GOTO      DISPT999
.
.         ************ UPDATE FORMACTION  **********
.
DISPT030  PACK      KEY17,URNUMBER,DISACODE,SP70
          CALL      RDDSPAT1
          BRANCH    OVRCD,DISPT095
.
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISPT096
.
          MOVE      DISPT001,DSPTDIID
          MOVE      DISPT003,DSPTSDAT
          MOVE      DISPT004,DSPTEDAT
          MOVE      DISPT005,DSPTOTCM
.
          CALL      UPDSPAT1
.
          CALL      NWDALT00
.
          MOVE      ZERO,EXIT
          GOTO      DISPT999
.
.         ************ DELETE FORMACTION  **********
DISPT040  CALL      DELDIS00
          GOTO      DISPT999
.
.         ************ DISPLAY FORMACTION **********
.
DISPT050  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            GOTO      DISPT092
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            GOTO      DISPT094
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Disaster Codes",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISPT999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT092  MOVE      "Patient Master File does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT093  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT094  MOVE      "Patient Master Extension File does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT095  MOVE      "Cannot find Disaster/Patient Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT096  MOVE      "Cannot find Disaster Master Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISPT999
.
DISPT999  RETURN
+
.---------------------------------------------------------------------
.         Display of the Following Fields
.---------------------------------------------------------------------
DSPT0000  BRANCH    FLDITMNO,DSPT1010,DSPT1020,DSPT1030,DSPT1040,DSPT1050:
                             DSPT1060
.
          GOTO      DSPT9999
.
DSPT1010  CALL      DISTAB00
          GOTO      DSPT9999
.
DSPT1020  MATCH     DSPTSDAT,SP70        * Start Date
          GOTO      DSPT9999 IF EQUAL
.
          UNPACK    DSPTSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSPT9999
.
DSPT1030  MATCH     DSPTEDAT,SP70        * Start Date
          GOTO      DSPT9999 IF EQUAL
.
          UNPACK    DSPTEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DSPT9999
.
DSPT1040  WRITE     HTMLFILE;DSPTCODE;
          GOTO      DSPT9999
.
DSPT1050  WRITE     HTMLFILE;DSPTDIID;
          GOTO      DSPT9999
.
DSPT1060  MOVE      "do",CATEGORY
          MOVE      DSPTOTCM,CODE
          CALL      CODITM00
          GOTO      DSPT9999
.
DSPT9999  RETURN
.
.------------------------------------------------------------
.         Table of Disaster Codes Details
.------------------------------------------------------------
DISTAB00  PACK      KEY17,URNUMBER,SP70
          CALL      RSDSPAT1
DISTAB10  CALL      RKDSPAT1
          BRANCH    OVRCD,DISTAB99 
.
          MATCH     DSPTURNO,URNUMBER
          GOTO      DISTAB99 IF NOT EQUAL
.
          MOVE      SP70,DIM60
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=0
            MOVE      DSMADESC,DIM60
          ENDIF 
.
          MOVE      SP70,DIM8
.
          MATCH     "1",DSMAACTV
          IF        @EQUAL
            MOVE      "Pending",DIM8
          ENDIF
.
          MATCH     "2",DSMAACTV
          IF        @EQUAL
            MOVE      "Active",DIM8
          ENDIF
.
          MATCH     "3",DSMAACTV
          IF        @EQUAL
            MOVE      "Inactive",DIM8
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:displayDisaster('",HTMLLINK
          APPEND    DSPTURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DSPTDIID,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DSPTCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          STRIP     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DSMADESC,"#",":
                             "#"",DSPTSDAT,"#",":
                             "#"",DSPTEDAT,"#",":
                             "#"",DIM8,"#");"

.
          GOTO      DISTAB10
.
DISTAB99  RETURN
.------------------------------------------------------------
. Output Patient Enquiry Page
.------------------------------------------------------------
GETPAT00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      ZERO,RESPFLAG
          MOVE      ZERO,DSCHFLAG
          MOVE      ZERO,PMVXFLAG
          MOVE      SP70,DOCTCODE
          CALL      IBACLOCK
          CALL      CLPATMAS
          CALL      CLPATMIS
          CALL      CLPATDSC
          CALL      CLPMSPX2
          CALL      CLPMSNUT
          CALL      CLRPDS00
          CALL      CLRICU00
          CALL      CLNZSP00
          CALL      CLPATHSP
          CALL      CLPMSVX1 
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MATCH     "1",NOURSELC
          IF        @EQUAL
            GOTO      GETPAT20
          ENDIF
.
          MATCH     SP70,PATALTID
          IF        !@EQUAL
            CALL      GETALT00
            BRANCH    EXIT,GETPAT99
          ENDIF
.
          MATCH     SP70,PMSALTID
          IF        !@EQUAL
            CALL      GETAID00
            BRANCH    EXIT,GETPAT99
          ENDIF
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      FINVIS00
            MOVE      EXIT,MASTFLAG
          ELSE
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            MOVE      OVRCD,MASTFLAG
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      GETPAT00
          ENDIF
.
          IF        MASTFLAG=1
            MOVE      "Can't find patient master details",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT99
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          MATCH     SP70,KEY8
          IF        @EQUAL | @EOS
            MOVE      ONE,MISSFLAG
            MOVE      ONE,RESPFLAG
            MOVE      ONE,DSCHFLAG
            MOVE      ONE,PMVXFLAG
            COMPARE   FOUR,SRCHTYPE         * U/R passed in from pat search
            CALL      FNDCUR00 IF EQUAL     * Find Current Admissin details
            COMPARE   FIVE,SRCHTYPE         * U/R passed in from healthviews
            CALL      FNDCVS00 IF EQUAL     * Find Current Admissin details
          ELSE
            CALL      RDMISS1
            MOVE      OVRCD,MISSFLAG
            CALL      RDPTDAD1
            IF        OVRCD=1
              MOVE      SP70,PTDAADTS
              MOVE      SP70,PTDADCTS
            ENDIF
.
            CALL      RDPTVIS1
            IF        OVRCD=1
              CALL      CLPATVIS
            ENDIF
            CALL      GETNZP00
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      ADMISSNO,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          MOVE      OVRCD,PMVXFLAG
          COMPARE   ONE,PMVXFLAG
          IF        !@EQUAL
            MATCH     SP70,PMVXMHOS
            IF        !@EQUAL
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=1
                CALL      CLPATHSP
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
          IF        OVRCD=0
            MOVE      DDATE,ICDRDDTE   * Needed for RDPTICD1 & RDPTICO1 reads
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          MOVE      OVRCD,RESPFLAG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
          MOVE      OVRCD,BRECFLAG
.
          MOVE      SP70,PMEVEVNT
          MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
.
GETPAT05  CALL      PATNAA00                * format name without bold tags
.
.                                                 * read nutrition file
          PACK      KEY16,ADMISSNO,LASTDATE       * set key to read nutrition
          CALL      RDPMNUT1                      * if no rec found, vals blank
.                                                 * out already (CLPMSNUT)
.
          CALL      GETCCD00                      * get concession card details
.
          PACK      KEY8,ADMISSNO,SP70            * read pds file
          CALL      RDMRPDS1
.
          PACK      KEY8,ADMISSNO,SP70            * read icu file
          CALL      RDPTICU1
.
          MOVE      SP70,PRIDISCD
          MOVE      SP70,PDIADESC
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,GETPAT10
          MATCH     DPTEDADM,ADMISSNO
          GOTO      GETPAT10 IF NOT EQUAL
.
          MATCH     PTEDTYPE,CMDISP
          GOTO      GETPAT10 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT                                    *C-240107
          GOTO      GETPAT10 IF NOT EQUAL
.
          MOVE      PTEDCODE,PRIDISCD
          MOVE      PTEDDESC,PDIADESC
.
GETPAT10  MOVE      SP70,PRIOPRCD
          MOVE      SP70,POPRDESC
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RSPTECO1
          CALL      RKPTECO1
          BRANCH    OVRCD,GETPAT20
          MATCH     DPTEOADM,ADMISSNO
          GOTO      GETPAT20 IF NOT EQUAL
.
          MATCH     "  1",DPTEOCNT                                     *C-240107
          GOTO      GETPAT20 IF NOT EQUAL
.
          MOVE      PTEOCODE,PRIOPRCD
          MOVE      PTEODESC,POPRDESC
.
GETPAT20  PACK      KEY9,DISACODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            CALL      CLRDIS00
          ENDIF
.
          PACK      KEY17,URNUMBER,DISACODE,SP70
          CALL      RDDSPAT1
          IF        OVRCD=1
            CALL      CLRDPT00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Disaster Codes / Events",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GETPAT99
.
          MATCH     "1",NOURSELC
          IF        @EQUAL
            GOTO      GETPAT90
          ENDIF
          IF        PTCNNHII=1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
GETPAT90  IF        PTCNNHII=1
            MATCH     "1",NOURSELC
            IF        @EQUAL
              GOTO      GETPAT92
            ENDIF
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
GETPAT92  CALL      WEBBOD00   * Output Templated Body of HTML
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
          CALL      WEBEND00   * Output End of Web Page

.
GETPAT99  RETURN
.
.-------------------------------------------------------------------------------
.  CLPATHSP
.-------------------------------------------------------------------------------
CLPATHSP  PACK      PTHSHOSP,SP70
          PACK      PTHSNAME,SP70
          PACK      PTHSADD1,SP70
          PACK      PTHSADD2,SP70
          PACK      PTHSADD3,SP70
          PACK      PTHSADD4,SP70
          PACK      PTHSPCOD,SP70
          PACK      PTHSTELE,SP70
          PACK      PTHSFAXN,SP70
          PACK      PTHSUNIT,SP70
          PACK      PTHSHDPC,SP70
          PACK      PTHSMRPR,SP70
          PACK      PTHSPACT,SP70
          PACK      PTHSHSNO,SP70
          PACK      PTHSPMBS,SP70
          PACK      PTHSTFEE,SP70
          PACK      PTHSHLOC,SP70
          PACK      PTHSRCTY,SP70
          PACK      PTHSVOLM,SP70
          PACK      PTHSSTAT,SP70
          PACK      PTHSDCLM,SP70
          PACK      PTHSAPPR,SP70
          PACK      PTHSUFMS,SP70
          PACK      PTHSABNN,SP70
          PACK      PTHSHSID,SP70
          PACK      PTHSHCEN,SP70
          PACK      PTHSPTIN,SP70
          PACK      PTHSSPID,SP70
          PACK      PTHSEDIP,SP70
          PACK      PTHSORID,SP70
.
          RETURN
+
.**********************************************************************
.  Clear PDS DATA
.**********************************************************************
CLRPDS00  MOVE      SP70,MRPDSTAT
          RETURN
.
.**********************************************************************
.  Clear ICU DATA
.**********************************************************************
CLRICU00  MOVE      ZERO,PTICUINT
          MOVE      ZERO,PTICUMEC
          MOVE      ZERO,PTICUCCU
          MOVE      SP70,PTICAMBN
          MOVE      ZERO,PTICCPAP
          MOVE      ZERO,PTICHNCU
.
CLRICU99  RETURN
+
.------------------------------------------------------------
. Get Alternate ID
.------------------------------------------------------------
GETALT00
          PACK      KEY30,PATALTID,SP70
          CALL      RSPTNID2
          CALL      RKPTNID2
          BRANCH    OVRCD,GETALT90          * no record on file
          MATCH     PATALTID,PTNINMPI
          GOTO      GETALT90 IF NOT EQUAL   * different National UR
          MOVE      PTNILNUM,URNUMBER
          MOVE      ZERO,EXIT
          GOTO      GETALT99
GETALT90  MOVE      "Can't find patient master details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
GETALT99  RETURN
.------------------------------------------------------------
. Get Alternate ID from PMSAIDFD
.------------------------------------------------------------
GETAID00  COMPARE   ONE,PTCNUALT            * Using Alternate ID
          GOTO      GETAID99 IF NOT EQUAL
.
          MATCH     SP70,URNUMBER           * Exit if there is a urnumber
          GOTO      GETAID99 IF NOT EQUAL
.
          PACK      KEY31,PMSALTID,SP70
          CALL      RSPMAID2
          CALL      RKPMAID2
          BRANCH    OVRCD,GETAID90          * no record on file
.
          MATCH     PMSALTID,PMAIALID
          GOTO      GETAID90 IF NOT EQUAL   * different alternate ID
.
          MOVE      PMAIURNO,URNUMBER
          MOVE      ZERO,EXIT
          GOTO      GETAID99
.
GETAID90  MOVE      "Can't find patient master details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
GETAID99  RETURN
.------------------------------------------------------------
. Get Name from Visit Based Tables
.------------------------------------------------------------
FINVIS00  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,FINVIS80
.
          BRANCH    PVITYPE,FINVIS10,FINVIS20,FINVIS20
          MOVE      ONE,EXIT
          GOTO      FINVIS99
.
FINVIS10  BRANCH    EMRFLAG,FINVIS90
          MOVE      PVIBILL,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS20  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS30  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS80  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS85
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS85  BRANCH    EMRFLAG,FINVIS90
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS90  MOVE      ONE,EXIT
.
FINVIS99  RETURN
.-----------------------------------------------------------------
. Find the Current visit details when doing a patient search by ur
.-----------------------------------------------------------------
FNDCUR00  BRANCH    PCEASE,FNDCUR90
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
FNDCUR10  CALL      RDPVISA2
          BRANCH    OVRCD,FNDCUR90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      FNDCUR90 IF NOT EQUAL
.
          BRANCH    PVITYPE,FNDCUR40,FNDCUR50,FNDCUR50
.
          GOTO      FNDCUR10
.
FNDCUR40  PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,FNDCUR10
.
          COMPARE   FOUR,EMVISTAT                * Cancelled visit
          GOTO      FNDCUR10 IF EQUAL
.
          MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCUR99
.
FNDCUR50  MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCUR99

FNDCUR90  MOVE      SP70,ADMISSNO
.
FNDCUR99  RETURN
.-----------------------------------------------------------------
. Find the Current visit details (from healthviews to add observations)
.-----------------------------------------------------------------
FNDCVS00  BRANCH    PCEASE,FNDCVS90
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
FNDCVS10  CALL      RDPVISA2
          BRANCH    OVRCD,FNDCVS90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      FNDCVS90 IF NOT EQUAL
.
          BRANCH    PVITYPE,FNDCVS40,FNDCVS10,FNDCVS50
.
          GOTO      FNDCVS10
.
FNDCVS40  PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,FNDCVS10
.
          COMPARE   FOUR,EMVISTAT                * Cancelled visit
          GOTO      FNDCVS10 IF EQUAL
.
          MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCVS99
.
FNDCVS50  MOVE      PVIBILL,ADMISSNO
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,FNDCVS10
          IF        ASTAT=1|ASTAT=5
            GOTO      FNDCVS10
          ENDIF
          GOTO      FNDCVS99

FNDCVS90  MOVE      SP70,ADMISSNO
.
FNDCVS99  RETURN
.******************************************************************************
.*  Get NZ Procedure details if required                                      *
.******************************************************************************
GETNZP00  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      GETNZP90 IF NOT EQUAL
.
          CALL      CLNZSP00
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
GETNZP10  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZP90
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      GETNZP90 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      GETNZP10 IF NOT EQUAL
          GOTO      GETNZP999
.
GETNZP90  CALL      CLNZSP00
.
GETNZP99  RETURN
+
.******************************************************************************
MVPMAR00  PACK      PMVXVISN,ARVXVISN,SP70
          PACK      PMVXVSDT,ARVXVSDT,SP70
          PACK      PMVXDOCA,ARVXDOCA,SP70
          PACK      PMVXDOCT,ARVXDOCT,SP70
          PACK      PMVXCSNR,ARVXCSNR,SP70
          PACK      PMVXPOST,ARVXPOST,SP70
          PACK      PMVXPIND,ARVXPIND,SP70
          PACK      PMVXVLOC,ARVXVLOC,SP70
          PACK      PMVXCFSG,ARVXCFSG,SP70
          PACK      PMVXINGP,ARVXINGP,SP70
          PACK      PMVXCPTH,ARVXCPTH,SP70
          PACK      PMVXHCP1,ARVXHCP1,SP70
          PACK      PMVXHCP2,ARVXHCP2,SP70
          PACK      PMVXHCP3,ARVXHCP3,SP70
          PACK      PMVXHCP4,ARVXHCP4,SP70
          PACK      PMVXRHC1,ARVXRHC1,SP70
          PACK      PMVXRH1G,ARVXRH1G,SP70
          PACK      PMVXRH1C,ARVXRH1G,SP70
          PACK      PMVXRHC2,ARVXRHC2,SP70
          PACK      PMVXRH2G,ARVXRH2G,SP70
          PACK      PMVXRH2C,ARVXRH2C,SP70
          PACK      PMVXRHC3,ARVXRHC2,SP70
          PACK      PMVXRH3G,ARVXRH3G,SP70
          PACK      PMVXRH3C,ARVXRH3C,SP70
          PACK      PMVXRHC4,ARVXRHC4,SP70
          PACK      PMVXRH4G,ARVXRH4G,SP70
          PACK      PMVXRH4C,ARVXRH4C,SP70
          PACK      PMVXABRG,ARVXABRG,SP70
          PACK      PMVXCADM,ARVXCADM,SP70
          PACK      PMVXIRAD,ARVXIRAD,SP70
          PACK      PMVXIDUS,ARVXIDUS,SP70
          PACK      PMVXCRAV,ARVXCRAV,SP70
          PACK      PMVXRCCT,ARVXRCCT,SP70
          PACK      PMVXAPWD,ARVXAPWD,SP70
          PACK      PMVXAPBD,ARVXAPBD,SP70
          PACK      PMVXPOWD,ARVXPOWD,SP70
          PACK      PMVXPOBD,ARVXPOBD,SP70
          PACK      PMVXPSTY,ARVXPSTY,SP70
          PACK      PMVXVALW,ARVXVALW,SP70
          PACK      PMVXPALW,ARVXPALW,SP70
          PACK      PMVXINDC,ARVXINDC,SP70
          PACK      PMVXMDAV,ARVXMDAV,SP70
          PACK      PMVXFRMS,ARVXFRMS,SP70
          PACK      PMVXCSNG,ARVXCSNG,SP70
          MOVE      PMVXPWGT,ARVXPWGT
          MOVE      PMVXPHGT,ARVXPHGT
          PACK      PMVXDHWR,ARVXDHWR,SP70
          PACK      PMVXEDC1,ARVXEDC1,SP70
          PACK      PMVXEDC2,ARVXEDC2,SP70
          PACK      PMVXEDC3,ARVXEDC3,SP70
          PACK      PMVXHOME,ARVXHOME,SP70
          PACK      PMVXUDF1,ARVXUDF1,SP70
          PACK      PMVXUDF2,ARVXUDF2,SP70
          PACK      PMVXUDF3,ARVXUDF3,SP70
          PACK      PMVXUDF4,ARVXUDF4,SP70
          PACK      PMVXUDT1,ARVXUDT1,SP70
          PACK      PMVXUDT2,ARVXUDT2,SP70
          PACK      PMVXUDT3,ARVXUDT3,SP70
          PACK      PMVXUDT4,ARVXUDT4,SP70
          PACK      PMVXUDT5,ARVXUDT5,SP70
          PACK      PMVXUDT6,ARVXUDT6,SP70
          PACK      PMVXCDTE,ARVXCDTE,SP70
          PACK      PMVXCTIM,ARVXCTIM,SP70
          PACK      PMVXWEBC,ARVXWEBC,SP70
          PACK      PMVXLUPD,ARVXLUPD,SP70
          PACK      PMVXLUPT,ARVXLUPT,SP70
          PACK      PMVXWEBU,ARVXWEBU,SP70
          PACK      PMVXMHLS,ARVXMHLS,SP70
          PACK      PMVXPICD,ARVXPICD,SP70
          PACK      PMVXRMOR,ARVXRMOR,SP70
          PACK      PMVXASUT,ARVXASUT,SP70
          PACK      PMVXELPS,ARVXELPS,SP70
          PACK      PMVXEMPL,ARVXEMPL,SP70
          PACK      PMVXFINP,ARVXFINP,SP70
          PACK      PMVXOCCP,ARVXOCCP,SP70
          PACK      PMVXPALC,ARVXPALC,SP70
          PACK      PMVXPPAL,ARVXPPAL,SP70
          PACK      PMVXPPPT,ARVXPPPT,SP70
          PACK      PMVXPSOS,ARVXPSOS,SP70
          PACK      PMVXPYSP,ARVXPYSP,SP70
          PACK      PMVXQLDB,ARVXQLDB,SP70
          PACK      PMVXREAD,ARVXREAD,SP70
          PACK      PMVXUDIN,ARVXUDIN,SP70
          PACK      PMVXUREA,ARVXUREA,SP70
          PACK      PMVXUSAC,ARVXUSAC,SP70
          PACK      PMVXUVTH,ARVXUVTH,SP70
          PACK      PMVXINTR,ARVXINTR,SP70
          PACK      PMVXLNG1,ARVXLNG1,SP70
          PACK      PMVXASGC,ARVXASGC,SP70
          PACK      PMVXMHOS,ARVXMHOS,SP70
          PACK      PMVXDSPD,ARVXDSPD,SP70
          PACK      PMVXDSIF,ARVXDSIF,SP70
          PACK      PMVXPRMI,ARVXPRMI,SP70
          PACK      PMVXPRAI,ARVXPRAI,SP70
          PACK      PMVXPRES,ARVXPRES,SP70
          PACK      PMVXUITR,ARVXUITR,SP70
          PACK      PMVXRPOA,ARVXRPOA,SP70
          PACK      PMVXRCN1,ARVXRCN1,SP70
          PACK      PMVXRCN2,ARVXRCN2,SP70
          PACK      PMVXRHFU,ARVXRHFU,SP70
          PACK      PMVXRDVA,ARVXRDVA,SP70
          PACK      PMVXRSLO,ARVXRSLO,SP70
          PACK      PMVXMLOC,ARVXMLOC,SP70
          PACK      PMVXPACC,ARVXPACC,SP70
          PACK      PMVXEDU1,ARVXEDU1,SP70
          PACK      PMVXEDU2,ARVXEDU2,SP70
          PACK      PMVXEDU3,ARVXEDU3,SP70
          PACK      PMVXPRGM,ARVXPRGM,SP70
          PACK      PMVXCONF,ARVXCONF,SP70
          PACK      PMVXEOCL,ARVXEOCL,SP70
          PACK      PMVXSLOC,ARVXSLOC,SP70
          PACK      PMVXSCLI,ARVXSCLI,SP70
          PACK      PMVXSTRA,ARVXSTRA,SP70
          PACK      PMVXQASN,ARVXQASN,SP70
          PACK      PMVXATCP,ARVXATCP,SP70
          PACK      PMVXATIM,ARVXATIM,SP70
          PACK      PMVXITIM,ARVXITIM,SP70
          PACK      PMVXHFGN,ARVXHFGN,SP70
          PACK      PMVXHFSN,ARVXHFSN,SP70
          PACK      PMVXFUPI,ARVXFUPI,SP70
          PACK      PMVXPOEC,ARVXPOEC,SP70
          PACK      PMVXSPAR,ARVXSPAR,SP70
.
          RETURN
+
.------------------------------------------------------------
. Get Concession Card Details if they exist
.------------------------------------------------------------
GETCCD00  UNPACK    SP70,CCRDTYPE,CCRDNUMB,CCRDEXDT
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
          CALL      RKPMCCD1
          BRANCH    OVRCD,GETCCD99
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      GETCCD99 IF NOT EQUAL
.
          MOVE      PMCDCNUM,CCRDNUMB            * card number
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TDESC,CCRDTYPE             * card type
          ENDIF
.
          PACK      CCRDEXDT,PMCDEXDT,SP70       * card expiry date
.
GETCCD99  RETURN
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
..------------------------------------------------------------
. Table Outputs (Visit, Transfers, etc)
.------------------------------------------------------------
TABL0000  BRANCH    FLDITMNO,TABL0100,TABL0200,TABL0300,TABL0400,TABL0500:
                             TABL0600,TABL0700
          GOTO      TABL9999
.
TABL0100  MOVE      ZERO,LNKDINDC
          CALL      VISTAB00
          GOTO      TABL9999
.
TABL0200  MOVE      ONE,LNKDINDC
          CALL      VISTAB00
          GOTO      TABL9999
.
TABL0300  CALL      DCSTAB00
          GOTO      TABL9999
.
TABL0400  CALL      DISSEL00
          GOTO      TABL9999
.
TABL0500  CALL      HOSSEL00
          GOTO      TABL9999
.
TABL0600  WRITE     HTMLFILE;FILTTYPE;
          GOTO      TABL9999
.
TABL0700  WRITE     HTMLFILE;FILTEXCL;
          GOTO      TABL9999
.
TABL9999  RETURN
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
VISTAB00  MOVE      ZERO,DIM1
          MOVE      ZERO,INFORMGP
          MOVE      ZERO,SHOWFRMT           * Show Format (0)Standard or(1)Kids
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
          UNPACK    DIM127,D1,SHOWFRMT,DIM127
          UNPACK    DIM127,D1,INFORMGP,DIM127 * Inform GP records only
.
          MATCH     "1",SHOWALLV
          IF        @EQUAL
            MOVE      ZERO,INFORMGP
          ENDIF
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      VISTAB99 IF EQUAL
.
          CALL      PATLST00                  * Visit Table
.
          COMPARE   ZERO,DISCFLAG
          GOTO      VISTAB99 IF NOT EQUAL
.
          IF        VISTFLAG<>1
            CALL      BOKLST00                  * Inpatient Bookings
          ENDIF
.
          IF        VISTFLAG=3 | VISTFLAG=1
            GOTO      VISTAB99
          ENDIF
          CALL      WATLST00                  * Waiting List Procedures
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            CALL      ALSITE00
          ELSE
            CALL      OUTFIL00              * Check user id site files are
            BRANCH    EXIT,MAIN1000         * as ALLVIS00 may have a different
.                                             * site prefix open
            CALL      OUTLST00                  * Outpatient Bookings
          ENDIF
.
VISTAB99  RETURN
.------------------------------------------------------------
. Output Outpatient Bookings
.------------------------------------------------------------
OUTLST00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
          MOVE      SP70,PRIDISCD              * I CAR 18122
          MOVE      SP70,PDIADESC              * I CAR 18122
          MOVE      SP70,DOCFNAME
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
          MOVE      SP70,VISTDAY
          MOVE      SP70,AUDITDTE
.
          PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
OUTLST10  CALL      RDKBOKA3
          BRANCH    OVRCD,OUTLST70
          MOVE      URNUMBER,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OUTLST70 IF NOT EQUAL
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,OBAOUTNO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      OUTLST10
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,OBAOUTNO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      OUTLST10
            ENDIF
          ENDIF
.
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            GOTO      OUTLST10
          ENDIF
.
. if linked, always display, if not linked, only show in date range
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            MATCH     SP70,DSMASDAT
            IF        !@EQUAL & !@EOS
              MATCH     DSMASDAT,OBADATE
              GOTO      OUTLST10 IF LESS
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSPTEDAT
            IF        !@EQUAL & !@EOS
              MATCH     OBADATE,DSPTEDAT
              GOTO      OUTLST10 IF LESS
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
.            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD<>1
              MATCH     "1",PMVXINGP
              IF        !@EQUAL
                GOTO      OUTLST10
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,ADIADESC
            MOVE      OPDICODE,VISADIAG
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,PVIBILL
          MOVE      OBADATE,PVIDATE
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          MOVE      SP70,VSTATUS
          IF        OBASTAT=1|OBASTAT=5
            IF        OBASTAT=1
              MOVE      "Booked",VSTATUS
            ELSE
              MOVE      "DNA",VSTATUS
            ENDIF
          ELSE
            GOTO        OUTLST10
          ENDIF
.
OUTLST12  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD=1
            CALL      CLRSES00
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=1
            CALL     CLOUTHED
          ENDIF
.
          PACK      VISTLOC,OTHELTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      VISTLOC,OTHEHOSP,DASH,OTHELTYP,SP70
.
              PACK      KEY3,OTHEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,VISTLOC
              ENDIF
.
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST15

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST15
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST15
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST15
          MOVE      TDESC,DESCDOCM
.
          MOVE      MRMAHLOC,KEY4
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST15
          MOVE      MRLODESC,DESCHOME
.
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
OUTLST15  MATCH     SP6,OBACLIN
          GOTO      OUTLST60 IF EQUAL
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,OUTLST20
.
            MATCH     OBASITE,OCASITE
            GOTO      OUTLST20 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      OUTLST20 IF NOT EQUAL
          ENDIF
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST60 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000             * CAR 202491 - format outpatient clinic(hcp)
.
          GOTO      OUTLST60
.
OUTLST20  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.          GOTO      GETVIS60
.
OUTLST60  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOBAOUTN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TWO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBASITE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      OUTROW00
.
. ---  get rescheduled outpatient bookings ---
.
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1
OUTLST65  CALL      RDKRSHA1
          BRANCH    OVRCD,OUTLST10
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      OUTLST10 IF NOT EQUAL
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,OBAOUTNO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      OUTLST65
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,OBAOUTNO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      OUTLST65
            ENDIF
          ENDIF
.
          CALL      RCTY0000                   * Get clinic type description
          PACK      VISTLOC,OTMALTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,OTHEHOSP,DASH,OTMALTYP,SP70
.
              PACK      KEY3,OTHEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,VISTLOC
              ENDIF
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
          CALL      RDCLIA1
          IF        OVRCD = 0
            MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
            MATCH     SP6,OCADOCT          * I CAR 13038
            GOTO      OUTLST68 IF EQUAL
.
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            CALL      FRMD0000
.
            GOTO      OUTLST68
          ENDIF
.
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST67
.
          MATCH     OPRSSITE,OCASITE
          GOTO      OUTLST67 IF NOT EQUAL
.
          MATCH     OPRSCLIN,OCACLIN
          GOTO      OUTLST67 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
          MATCH     SP6,OCADOCT          * I CAR 13038
          GOTO      OUTLST68 IF EQUAL
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          CALL      FRMD0000
.
          GOTO      OUTLST68
.
OUTLST67  MOVE      "Invalid Clinic",DOCFNAME     * If no Doctor Use Clinic Name
.
OUTLST68  MOVE      OPRSDATE,PVIDATE
          MOVE      OPRSTIME,VISTTIME
          MOVE      OPRSSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST69

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST69
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST69
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST69
          MOVE      TDESC,DESCDOCM
.
          MOVE      MRMAHLOC,KEY4
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST69
          MOVE      MRLODESC,DESCHOME
.
OUTLST69  MOVE      "Rescheduled",VSTATUS
          MOVE      "javascript:alert('Rescheduled')",HTMLLINK
.
          CALL      OUTROW00
.
          GOTO      OUTLST65
.
. ---  get cancelled outpatient bookings ---
.
OUTLST70  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,VISTLOC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSOTCAN2
OUTLST75  CALL      RKOTCAN2
          BRANCH    OVRCD,OUTLST99
.
          MATCH     URNUMBER,OPCNURNO
          GOTO      OUTLST99 IF NOT EQUAL
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,DOPCNOUT,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      OUTLST75
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,DOPCNOUT,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      OUTLST75
            ENDIF
          ENDIF
.
          CALL      CCTY0000                   * Get clinic type description
          PACK      VISTLOC,OTMALTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,OTHEHOSP,DASH,OTMALTYP,SP70
.
            PACK      KEY3,OTHEHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,VISTLOC
            ENDIF
          ENDIF
.
.
          PACK      KEY36,DOPCNOUT,OPCNDATE,OPCNSTRT,DOPCNSLO,OPCNSITE,OPCNCLIN
          CALL      RDBOKA3
          BRANCH    OVRCD,OUTLST80
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTLST77
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
OUTLST77  MATCH     OBAURNO,URNUMBER
          GOTO      OUTLST75 IF EQUAL
.
OUTLST80  MOVE      OPCNDATE,PVIDATE
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBAOUTNO,PVIBILL
          MOVE      OPCNTIME,VISTTIME
          MOVE      DOPCNOUT,SLOTNUMB
          MOVE      SP70,VSTATUS
          MOVE      "Cancelled",VSTATUS
          MATCH     SP70,OPCNCLIN
          GOTO      OUTLST85 IF EQUAL
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      OUTLST81
          ENDIF
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST82
.
          MATCH     OPCNSITE,OCASITE
          GOTO      OUTLST82 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      OUTLST82 IF NOT EQUAL
.
OUTLST81  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST85 IF EQUAL
          MOVE      OCADOCT,OPCNCLIN     * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000
.
          GOTO      OUTLST85
.
OUTLST82  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
OUTLST85  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOPCNOUT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    FOUR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPCNSITE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      OPCNOUTN,OBAOUTNO
          MOVE      OPCNURNO,OBAURNO
          MOVE      OPCNSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST87
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST87
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST87
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST87
          MOVE      TDESC,DESCDOCM
.
          MOVE      MRMAHLOC,KEY4
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST87
          MOVE      MRLODESC,DESCHOME
.
OUTLST87  CALL      OUTROW00
          GOTO      OUTLST75
.
OUTLST99  RETURN
.
OUTROW00  REP       " 0",PVIDATE
          MOVE      SP70,AUDITDTE
          MOVE      SP70,VISTDAY
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",";
          ELSE
            WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",OBAOUTNO,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":                   * Location
                             "#"",VSTATUS,"#",":
                             "#"",OBASLOT,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":                  * I CAR 18122
                             "#"",PDIADESC,"#",":                  * I CAR 18122
                             "#"",AUDITDTE,"#",":                  * I CAR 18122
                             "#"",SP1,"#",":
                             "#"<input type=checkbox ":
                             " value='",URNUMBER,DISACODE,OBAOUTNO:
                             "'>";
.
.
          WRITE     HTMLFILE;"#");"  * Coding Audit Date
          RETURN
.
.------------------------------------------------------------------------
. format HCP column - clinic (hcp)
.------------------------------------------------------------------------
.
FRMD0000  MOVE      ALCNCLNF,FORM1
          BRANCH    FORM1,FRMD1000,FRMD2000
.
.         Clinic Description ( HCP )
.
          PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
           STRIP     DOCFNAME
           STRIP     OCADESC
.
           APPEND    OCADESC,KEY50
           APPEND    SP1,KEY50
           APPEND    OBRACKET,KEY50
           APPEND    DOCFNAME,KEY50
           APPEND    CBRACKET,KEY50
.
           RESET     KEY50
           STRIP     KEY50
           CLEAR     DOCFNAME
           PACK      DOCFNAME,KEY50
           RESET     DOCFNAME
          ENDIF
.
          GOTO      FRMD9999
.
.         HCP
.
FRMD1000  GOTO      FRMD9999
.

.
.         Clinic Description
.
FRMD2000  PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
            PACK      DOCFNAME,OCADESC
          ELSE
            PACK      DOCFNAME,SP70
          ENDIF
.
          GOTO      FRMD9999
.
FRMD9999  RETURN
.------------------------------------------------------------
. Get clinic type description for cancelled bookings
.------------------------------------------------------------
CCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CCTY9999
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.
CCTY9999  RETURN
.------------------------------------------------------------
. Get clinic type description for re-scheduled bookings
.------------------------------------------------------------
RCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPRSSITE,OPRSCLIN,OPRSDATE,OPRSSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,RCTY9999
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.
RCTY9999  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRSES00  MOVE      SP70,OSESITE       * SITE CODE
          MOVE      SP70,OSECLIN       * CLINIC ID
          MOVE      SP70,OSEDATE       * USAGE DATE (CCYYMMDD)
          MOVE      SP70,OSESTRT       * SESSION START TIME (HH:MM)
          MOVE      SP70,DOSEDAY       * DAY INDICATOR e.g. 1 = MON
          MOVE      ZERO,OSESLOTS      * TOTAL SLOTS SCHEDULED
          MOVE      ZERO,OSESLOTB      * TOTAL SLOTS BOOKED
          MOVE      SP70,OSETIMES      * TOTAL TIME SCHEDULED (HH:MM)
          MOVE      SP70,OSETIMEU      * TOTAL TIME USED      (HH:MM)
          MOVE      ZERO,OSEBNEW       * NUMBER OF NEW PATIENTS
          MOVE      ZERO,OSEBRV        * NUMBER OF RE-VISITING PATIENTS
          MOVE      ZERO,OSEBSPC       * NUMBER OF SPECIAL PATIENTS
          MOVE      ZERO,OSEANEW       * NUMBER OF NEW PATIENTS
          MOVE      ZERO,OSEARV        * NUMBER OF RE-VISITING PATIENTS
          MOVE      ZERO,OSEASPC       * NUMBER OF SPECIAL PATIENTS
          MOVE      ZERO,OSESSLTR      * REVIEW SLOTS SCHEDULED
          MOVE      ZERO,OSESSLTN      * NEW SLOTS SCHEDULED
          MOVE      ZERO,OSESSLTS      * SPECIAL SLOTS SCHEDULED
          MOVE      SP70,OSESCSTT      * CLINIC STATUS
          MOVE      SP70,OSESCOMM
          MOVE      SP70,OSESCTYP      * CLINIC TYPE
          MOVE      SP70,OSESSHNO      * SCHEDULE NUMBER
          MOVE      SP70,OSESSDAT      * SCHEDULE DATE (CCYYMMDD)
          MOVE      SP70,OSESPARE      * SPARE
.
CLRSES99  RETURN
.-----------------------------------------------------------
. Initialize's file data : Clinic Master File A
.-----------------------------------------------------------
CLRMAS00  MOVE      SP70,OMASITE
          MOVE      SP70,OMACLIN
          MOVE      SP70,OMATYP
          MOVE      SP70,DOMADAY
          MOVE      SP70,OMASTART
          MOVE      SP70,OMAFIN
          MOVE      SP70,OMAEND
          MOVE      SP70,OMACIND
          MOVE      SP70,OMAREG
          MOVE      SP70,OMAKDOC
          MOVE      SP70,OMACOM1
          MOVE      SP70,OMACOM2
          MOVE      ZERO,OMADURN
          MOVE      ZERO,OMANEWSL
          MOVE      ZERO,OMASPCSL
          MOVE      ZERO,OMASTAT
          MOVE      SP70,OMAFREQM
          MOVE      SP70,DOMASEQ
          MOVE      SP70,OMALOCK
          MOVE      ZERO,OMAFREQF
          MOVE      SP70,OMAFREQY
          MOVE      SP70,OMADATE
          MOVE      SP70,OTMAAVIS
          MOVE      SP70,OTMASTVT
          MOVE      SP70,OTMASUPX
          MOVE      SP70,OTMARUSE
          MOVE      SP70,OTMADCMB
          MOVE      SP70,OTMAIXTA
          MOVE      SP70,OTMADEFD
          MOVE      SP70,OTMAUATR
          MOVE      ZERO,OTMADDNA
          MOVE      ZERO,OTMANDRP
          MOVE      ZERO,OTMALPTR
          MOVE      ZERO,OTMALGPD
          MOVE      ZERO,OTMALPTD
          MOVE      ZERO,OTMABKLT
          MOVE      ZERO,OTMARALT
          MOVE      ZERO,OTMARSLT
          MOVE      SP70,OTMACLSE
          MOVE      SP70,OTMAHOSP
          MOVE      SP70,OTMACLOC
          MOVE      SP70,OTMAWDCL
          MOVE      SP70,OTMAWARD
          MOVE      SP70,OTMALTYP
          MOVE      SP70,OTMADFSL
          MOVE      SP70,OTMADFGN
          MOVE      SP70,OTMAGRPS
          MOVE      SP70,DOTMASOV
          MOVE      SP70,DOTMANOO
          MOVE      SP70,DOTMASLF
          MOVE      SP70,DOTMASLR
          MOVE      SP70,OTMASBKL
          MOVE      SP70,OTMASAPL
          MOVE      SP70,OTMASPMM
          MOVE      SP70,OTMASGPM
          MOVE      SP70,DOTMALPP
          MOVE      SP70,DOTMASRL
          MOVE      SP70,DOTMANCO
          MOVE      SP70,OTMALOCN
          MOVE      SP70,OTMADTCO
          MOVE      SP70,OTMADTCC
          MOVE      SP70,OTMAINS1
          MOVE      SP70,OTMAINS2
          MOVE      SP70,OTMAINS3
          MOVE      SP70,OTMALSER
          MOVE      SP70,OTMAUMCI
          MOVE      SP70,OTMAPROV
          MOVE      SP70,OTMAMBST
          MOVE      SP70,OTMAROOM
          MOVE      SP70,OTMALEDG
          MOVE      SP70,OTMACCTR
          MOVE      SP70,OTMAMPRC
          MOVE      SP70,OTMAMBSA
          MOVE      SP70,OTMALDNA
          MOVE      SP70,OTMAADEP
          MOVE      SP70,OTMACENC
          MOVE      SP70,OTMACCAR
          MOVE      SP70,OTMACTRN
          MOVE      SP70,OTMADPSL
          MOVE      SP70,OTMACPMI
          MOVE      SP70,OTMACPAG
          MOVE      SP70,OTMACTEL
          MOVE      SP70,OTMANMDS
          MOVE      SP70,OTMACART
          MOVE      SP70,OTMASRVD
          MOVE      SP70,OTMACLHR
          MOVE      SP70,OTMAMLTD
          MOVE      SP70,OTMAXPUL
          MOVE      SP70,OTMAMREF
          MOVE      SP70,OTMATCOD
          MOVE      SP70,OTMAHCLI
          MOVE      SP70,OTMAHCAI
          MOVE      SP70,OTMAAOPN 
          MOVE      SP70,OTMAAOFR
          MOVE      SP70,OTMAAOWM 
          MOVE      SP70,OTMAAOWA
          MOVE      SP70,OTMAHCP1 
          MOVE      SP70,OTMAHCP2 
          MOVE      SP70,OTMAHCP3 
          MOVE      SP70,OTMAHCP4 
          MOVE      SP70,OTMAPCOD
          MOVE      SP70,OTMASPAR
.
CLRMAS99  RETURN
+
.------------------------------------------------------------
.     Inform GP outpatient bookings
.------------------------------------------------------------
ALSITE00  MOVE      ZERO,SITEDONE           * This site prefix done = No
          PACK      KEY9,SP70
          CALL      RDSSITA3
ALSITE10  CALL      RDKSITA3
          BRANCH    OVRCD,ALSITE95
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEDONE         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEDONE,ALSITE10       * Skip if this site prefix is done
.
          CALL      OUTLST00                * Output outpatient bookings
          MOVE      ONE,SITEDONE            * This site prefix done = yes
.
          GOTO      ALSITE10
.
ALSITE95
.
ALSITE99  RETURN
.------------------------------------------------------------
. Waiting List Details
.------------------------------------------------------------
WATLST00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,PRIDISCD        * I CAR 18122
          MOVE      SP70,PDIADESC        * I CAR 18122
.
          PACK      KEY19,URNUMBER,SP20
          CALL      RDSTREA1
WATLST10  CALL      RDKTREA1
          BRANCH    OVRCD,WATLST99
          MATCH     URNUMBER,WMURNO      * Same U/R ?
          GOTO      WATLST90 IF NOT EQUAL
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,WMBOOK,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      WATLST10
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,WMBOOK,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      WATLST10
            ENDIF
          ENDIF
.
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            GOTO      WATLST10
          ENDIF
.
. if linked, always display, if not linked, only show in date range
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            MATCH     SP70,DSMASDAT
            IF        !@EQUAL & !@EOS
              MATCH     DSMASDAT,WMDATE1
              GOTO      WATLST10 IF LESS
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSPTEDAT
            IF        !@EQUAL & !@EOS
              MATCH     WMDATE1,DSPTEDAT
              GOTO      WATLST10 IF LESS
            ENDIF
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          MOVE      SP70,VISTDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      WMDATE1,PVIDATE
          MOVE      SP70,VISTTIME
.
          MOVE      "W/L",VISTTYPE
          COMPARE   ONE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT1,VSTATUS
            GOTO      WATLST20            * unscheduled status
          ENDIF
.
          COMPARE   NINE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT9,VSTATUS
            GOTO      WATLST20            * unscheduled status
          ENDIF
          GOTO      WATLST10
.
WATLST20  MOVE      "P ",CATEGORY
          MOVE      WTWMCLSS,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Admission CLass
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
          MOVE      TDESC,UNITDESC
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE      WMCODE,VISADIAG
          MOVE      WMREASON,ADIADESC
.
          MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          REP       " +",CASEKEYS
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    WMBOOK,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EIGHT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,AUDITDTE
          MOVE      SP10,VISTTIME
          REP       " 0",PVIDATE
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",";
          ELSE
            WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",SP1,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",SP1,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":            * I CAR 18122
                             "#"",PDIADESC,"#",":            * I CAR 18122
                             "#"",AUDITDTE,"#",":  * Coding Audit Date8122
                             "#"",SP1,"#",":
                             "#"<input type=checkbox ":
                             " value='",URNUMBER,DISACODE,WMBOOK:
                             "'>#");"
.
          GOTO      WATLST10
.
WATLST90
WATLST99  RETURN
.------------------------------------------------------------
. Bookings Visit List
.------------------------------------------------------------
BOKLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
BOKLST10  CALL      RKBKREC6
          BRANCH    OVRCD,BOKLST99
          MATCH     URNUMBER,BKREURNO
          GOTO      BOKLST99 IF NOT EQUAL
          COMPARE   ZERO,BKRESTAT
          GOTO      BOKLST10 IF NOT EQUAL
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,DBKREBOO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      BOKLST10
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,DBKREBOO,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      BOKLST10
            ENDIF
          ENDIF
.
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            GOTO      BOKLST10
          ENDIF
.
. if linked, always display, if not linked, only show in date range
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            MATCH     SP70,DSMASDAT
            IF        !@EQUAL & !@EOS
              MATCH     DSMASDAT,BKREEDAT
              GOTO      BOKLST10 IF LESS
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSPTEDAT
            IF        !@EQUAL & !@EOS
              MATCH     BKREEDAT,DSPTEDAT
              GOTO      BOKLST10 IF LESS
            ENDIF
          ENDIF
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,DTYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          PACK      VISTLOC,SP70
          MOVE      SP70,PRIDISCD             * I CAR 18122
          MOVE      SP70,PDIADESC             * I CAR 18122
.
          MOVE      SP70,VISTDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      BKREEDAT,PVIDATE
          MOVE      BKREATIM,VISTTIME
.
          ADD       ONE,VISCOUNT
          MOVE      "Book",VISTTYPE
          MOVE      "Booking",VSTATUS
          MOVE      "Booking",VISTDESC
.
          MOVE      BKREPROC,VISADIAG         * Procedure
          PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDICODE,VISADIAG
              MOVE      BKDIDES1,ADIADESC       * Procedure description
            ENDIF
          ENDIF
.
          MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          MATCH     SP70,BKRXPOWD
          IF        !@EQUAL
            PACK      KEY6,BKRXPOWD,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              IF        IBCNMHOS=1
                PACK      VISTLOC,PTWDHOSN,SP70
.
                PACK      KEY3,PTWDHOSN,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSNAME,VISTLOC
                ENDIF
.
              ENDIF
            ENDIF
          ENDIF
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,BOKLST20
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,BOKLST20
.
          MATCH     BKREURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            PACK      DESCHOME,SP70
            PACK      DESCDOCM,SP70
            MOVE      SP70,VOLNDESC
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      BOKLST20
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          MOVE      TDESC,DESCDOCM
.
          MOVE      MRMAHLOC,KEY4
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
BOKLST20  MOVE      SP70,SECOPT
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSI,TCINDC4
            IF        @EQUAL
              MOVE      "1",SECOPT
            ENDIF
            MATCH     ANSO,TCINDC4
            IF        @EQUAL
              MOVE      "2",SECOPT
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DBKREBOO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SEVEN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      TDESC,UNITDESC
          MOVE      CODE,UNITCODE
.
          REP       " 0",BKREEDAT
          MATCH     SP70,BKREATIM
          IF        @EQUAL
            MOVE      "12:00:00",BKREATIM
          ENDIF
.
          MOVE      SP70,AUDITDTE
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",";
          ELSE
            WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",DBKREBOO,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",SP1,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",ZERO,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":           * I CAR 18122
                             "#"",PDIADESC,"#",":           * I CAR 18122
                             "#"",AUDITDTE,"#",":      * Coding Audit Date
                             "#"",SP1,"#",":
                             "#"<input type=checkbox ":
                             " value='",URNUMBER,DISACODE,DBKREBOO:
                             "'>#");";
          GOTO      BOKLST10
.
BOKLST99  RETURN
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
PATLST00  PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
PATLST10  CALL      RDPVISA2
          BRANCH    OVRCD,PATLST99
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PATLST99 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,PATLST10
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            PACK      KEY25,URNUMBER,DISACODE,DPVIBILL,SP70
            CALL      RDDSPTL1
            IF        OVRCD=0
              GOTO      PATLST10
            ENDIF
          ELSE
            PACK      KEY25,URNUMBER,DISACODE,DPVIBILL,SP70
            CALL      RDDSPTL1
            IF        OVRCD=1
              GOTO      PATLST10
            ENDIF
          ENDIF
.
          PACK      KEY9,DSPTCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            GOTO      PATLST10
          ENDIF
.
. if linked, always display, if not linked, only show in date range
          MATCH     "0",LNKDINDC
          IF        @EQUAL
            MATCH     SP70,DSMASDAT
            IF        !@EQUAL & !@EOS
              MATCH     DSMASDAT,PVIDATE
              GOTO      PATLST10 IF LESS
            ENDIF
          ENDIF
.
.         MATCH     SP70,DSPTSDAT
.         IF        !@EQUAL & !@EOS
.           MATCH     DSPTSDAT,PVIDATE
.           GOTO      PATLST10 IF LESS
.         ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSPTEDAT
            IF        !@EQUAL & !@EOS
              MATCH     PVIDATE,DSPTEDAT
              GOTO      PATLST10 IF LESS
            ENDIF
          ENDIF
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            MATCH     "1",PMVXINGP
            IF        !@EQUAL
              GOTO      PATLST10
            ENDIF
          ENDIF
.
          ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
          IF        VISTFLAG<>0
            COMPARE   VISTFLAG,PVITYPE      * Match For Visit Type
            GOTO      PATLST10 IF NOT EQUAL
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,PATLST10
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,PATLST10
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,PATLST30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      PATLST18 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70
            IF        IBCNMHOS=1
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPWRD,SLASH,PMEVPBED,SP70
.
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,VISTLOC
              ENDIF
.
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      PATLST30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      PATLST30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS
          ENDIF
.
PATLST18  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
PATLST20  MATCH     SP70,PMEVCTYP
          GOTO      PATLST30 IF EQUAL
.
          PACK      KEY6,PMEVCTYP,SP70
          CALL      RDSCTYA1
PATLST21  CALL      RDKCTYA1
          BRANCH    OVRCD,PATLST30
.
          MATCH     OCTSITE,WBSESIT     * Must be in the Same Site
          GOTO      PATLST21 IF NOT EQUAL
.
          MATCH     PMEVCTYP,OCTCTYP
          GOTO      PATLST21 IF NOT EQUAL
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
PATLST30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,PATLST10        * don't display
.
          CALL      MRTDES00             * Medical Record Location Details
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVISITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    AAEVFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EVNTFLAG,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       " 0",PVIDATE
.
          MOVE      SP70,KEY15
          COMPARE     FOUR,EMVISTAT
          IF        @EQUAL
            MOVE      "LineThrough",KEY15
          ENDIF
.
          MATCH     "0",LNKDINDC
          IF        @EQUAL
             WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",";
          ELSE
             WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",";
          ENDIF
 
          WRITE     HTMLFILE;"#"",PVIBILL,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",DDATE,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",CODESTAT,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SLOTNUMB,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",VISTRCOD,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",DESCSNAG,"#",":
                             "#"",ACODDTE,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",CODERNAM,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":           * I CAR 18122
                             "#"",PDIADESC,"#",":           * I CAR 18122
                             "#"",AUDITDTE,"#",":         * 33 coding audit date
                             "#"",KEY15,"#",":
                             "#"<input type=checkbox ":
                             " value='",URNUMBER,DISACODE,DPVIBILL:
                             "'>";
.
          WRITE     HTMLFILE;"#");"
.
          IF        CHECKCNT=0
            GOTO      PATLST10
          ENDIF
.
          ADD       ONE,RECCNT
          COMPARE   TEN5,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      PATLST99
          ENDIF
.
          GOTO      PATLST10
.
PATLST99  RETURN
+
.------------------------------------------------------------
. Get Medical Record Details
.------------------------------------------------------------
MRTDES00  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
          COMPARE   NINE,PVITYPE                 * If Allied Health display
          GOTO      MRTDES40 IF NOT EQUAL.       * the medical record for the
.                                                * Allied health linked visit
          MATCH     " 2",PVISYST
          GOTO      MRTDES40 IF NOT EQUAL.

          PACK      KEY8,ALENLINK,SP70
          GOTO      MRTDES45
.
MRTDES40  PACK      KEY8,PVIBILL,SP70
MRTDES45  CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,MRTDES99
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,MRTDES99
.
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      MRTDES99
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCDOCM
.
          MOVE      MRMAHLOC,KEY4
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
          GOTO      MRTDES99
.
MRTDES90  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
MRTDES99  RETURN
.------------------------------------------------------------
.         Check for Allied Health
.------------------------------------------------------------
CKAL0000  MOVE      ZERO,EXIT
          MOVE      ZERO,EVNTFLAG
          COMPARE   "9",PVITYPE
          GOTO      CKAL9999 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      CKAL1000 IF NOT EQUAL
.
. Event Type Visit
.------------------
.          PACK      VISTTYPE,VISTEVNT,SP10  * Event
          PACK      VISTTYPE,PMEVEVNT,SP10  * Event
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,CKAL9999
          MOVE      TWO,SECOPT
          MOVE      PMEVATIM,VISTTIME
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,EVNTFLAG
          MATCH     "E",TCINDC1
          IF        @EQUAL
            MOVE      EMEVENT,VISTTYPE
            MOVE      "1",EVNTFLAG         * Emergency event
          ELSE
            MATCH     "O",TCINDC1
            IF        @EQUAL
              MOVE      "2",EVNTFLAG       * Outpatient event
            ELSE
              MATCH     "I",TCINDC1
              IF        @EQUAL
                MOVE      "3",EVNTFLAG     * Inpatient event
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      PMEVUNIT,UNITCODE
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      VISTTYPE,PMEVEVNT,SP70
.         MATCH     "I",TCINDC1
.         IF        @EQUAL
.           MOVE      IPEVENT,VISTTYPE
.         ENDIF
.
          MATCH     "O",TCINDC1
          IF        @EQUAL
.           MOVE      OPEVENT,VISTTYPE
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
....         MOVE      TDESC,UNITDESC      * Display clinic type for outpatients
            MOVE      PMEVCTYP,UNITCODE
            PACK      VISTLOC,PMEVPLOC,SP70
            COMPARE   ONE,IBCNMHOS
            IF        @EQUAL
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPLOC,SP70
.
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,VISTLOC
              ENDIF
.
            ENDIF
          ENDIF
          MOVE      "CL",CATEGORY
          MOVE      PMEVCCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMEVACON
          GOTO      CKAL0500 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    PMEVACON,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
CKAL0500  MATCH     SP70,PMEVCLID
          GOTO      CKAL9999 IF EQUAL
.
          PACK      KEY20,PMEVSITE,PMEVCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CKAL9999
.
          MATCH     PMEVSITE,OCASITE
          GOTO      CKAL9999 IF NOT EQUAL
.
          MATCH     PMEVCLID,OCACLIN
          GOTO      CKAL9999 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      CKAL9999 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
          GOTO      CKAL9999
.
CKAL1000  MATCH    " 2",PVISYST
          GOTO     CKAL9999 IF NOT EQUAL
.
. Allied Heath Type Visit
.-------------------------
          PACK     VISTTYPE,VISTALLH,SP10      * Allied Health
          MOVE     PVIBILL,KEY8
          CALL     RDALREF1              *TO GET DEPT OF THE REFERRAL TABLE
          BRANCH   OVRCD,CKAL9999
.
          MATCH     SP70,FILTDEPT              * Department Filter
          IF        !@EQUAL
            MATCH     ALREDEPT,FILTDEPT
            GOTO      CKAL9000 IF NOT EQUAL
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK     KEY3,ALREDEPT,SP70
          CALL     RDALDEP1
          BRANCH   OVRCD,CKAL9000
          MOVE     ALDESECU,SECOPT
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,CKAL5000
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      CKAL5000 IF NOT EQUAL
.
          APPEND    "Linked",REFTDESC
          GOTO      CKAL5000
.
CKAL5000  MOVE     SP70,ALENLINK           * Used to display linked mr volume
.
          MATCH    "2",ALDESECU
          IF       @EQUAL
            MATCH    WBSEDALL,ALREDEPT     * Check department
            GOTO     CKAL9000 IF NOT EQUAL * don't display
            REP      "20",SECOPT
          ENDIF
.
          MOVE     ALLSTAT0,VSTATUS
          MOVE     ZERO,FORM1
          MOVE     ALRESTAT,FORM1
          LOAD     VSTATUS,FORM1,ALLSTAT1,ALLSTAT2,ALLSTAT3,ALLSTAT4:
                                 ALLSTAT5
.
          PACK     KEY16,PVIBILL,Z70
          CALL     RSALENC1
          CALL     RPALENC1
          IF       OVRCD=0
            MATCH    DPVIBILL,ALENVISN   * Same visit number ?
            IF       @EQUAL
              MATCH    SP8,ALENSDAT
              IF       !@EQUAL
                UNPACK   ALENSDAT,CCENT,CYEAR,CMON,CDAY
                CALL     PACDATE
                REP      " 0",CPCDATE
                ENDSET   VSTATUS
                APPEND   "(Last Enc.",VSTATUS
                APPEND   CPDATE,VSTATUS
                APPEND   ")",VSTATUS
                RESET    VSTATUS
              ENDIF
            ELSE
              MOVE     SP70,ALENLINK         * Used to display linked mr volume
            ENDIF
          ENDIF
.
          MOVE      ALREDEPT,UNITCODE            * To get department
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          PACK      KEY10,ALREHCP,SP70          * To get service provider name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      "&nbsp;",DOCFNAME
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,SP70
.
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,VISTLOC
            ENDIF
.
          ENDIF
.
          GOTO      CKAL9999
.
CKAL9000  MOVE      ONE,EXIT
CKAL9999  RETURN
.------------------------------------------------------------
. Get status for patient event record
.------------------------------------------------------------
GETSTA00  MATCH     SP70,PMEVDDTE
          GOTO      GETSTA99 IF EQUAL
.
          MOVE      PMEVDDTE,DDATE
          UNPACK    PMEVDDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,DISCDATE
          GOTO      GETSTA99 IF EQUAL
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP70,PMEVDSTT
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSD,PMEVDSTT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,KEY10
              APPEND    KEY10,VSTATUS
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    PMEVDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETSTA99  RETURN
+
.------------------------------------------------------------
. Get Visit Details
.------------------------------------------------------------
GETVIS00  MOVE      ZERO,EXIT
          MOVE      SP1,SECOPT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      SP70,VISTDAY
          MOVE      SP70,VISTLOC
          MOVE      SP70,ACLAIM
          MOVE      SP70,DDATE
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,ATYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,WARDNAME
          MOVE      SP70,REFTDESC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,DISCDATE
          MOVE      SP10,VISTTIME
          MOVE      "&nbsp;",DISCDATE
          MOVE      SP70,VISTRCOD
          MOVE      ZERO,AAEVFLAG
.
          MOVE      SP10,AWARD
          MOVE      SP10,ACLAIM
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      DOCFNAME,SP70
          RESET     DOCFNAME
.
.------ For outpatients, PVIDOCT is the clinic code, not the doctor's code ----
.
          BRANCH    PVITYPE,GETVIS05,GETVIS10,GETVIS15
          GOTO      GETVIS60
.
.       Emergency
.
GETVIS05
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GETVIS60
          MOVE      ADACOMP,ACLAIM
          MOVE      ADADOCT,PVIDOCT
          MOVE      ADADIAG,ADIADESC       * Diagnosis
          MOVE      ADADATE,PVIDATE
          MOVE      ADATIME,VISTTIME
.
          MATCH     EMCNLDAT,ADADATE
          IF        @LESS
            MOVE      ONE,AAEVFLAG          * Link to AAE Enquiry page
          ENDIF
.
          CALL      RDDISA1
          IF        OVRCD=0
            MOVE      ADSDIAG,DDIADESC
            MOVE      ADSDATE,DDATE
            MOVE      ADSDATE,EMVIDATE
            MOVE      ADSTIME,EMVIDTIM
            MOVE      ADSDISC,EMVIDSTA
.
          ENDIF
.
          MOVE      ZERO,EMVISTAT
          BRANCH    EMRFLAG,GETVIS08
          MOVE      SP70,PTVADESC
          MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=0
            PACK      KEY5,EMVIDEST
            CALL      RDPTVAD1
            IF        OVRCD=0
              PACK      VSTATUS,PTVADESC,SP70
            ENDIF
            MOVE      EMVIDATE,PVIDATE
            MOVE      EMVITIME,VISTTIME
.
            MATCH     "1",SHOWFRMT
            IF        @EQUAL
              MOVE      THREE,EMVISTAT      * Kids ED visits(events) hard coded
            ENDIF                           * to discharged
.
            IF        EMVISTAT=2 | EMVISTAT=3
              MOVE      EMVIDDAT,DDATE
            ENDIF
.
            PACK      KEY5,ANSA,ANSA,EMVITRIG
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VISTRCOD         * Triage Code
            ENDIF
.
            MOVE      EMVITXT2,ADIADESC
          ENDIF
.
GETVIS08  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          IF        EMVISTAT=FOUR
            APPEND    INPSTA3B,VSTATUS
            GOTO      GETVIS60
          ELSE
            IF        EMVISTAT=2 | EMVISTAT=3 | EMVISTAT=0
              APPEND    INPSTA3A,VSTATUS
            ELSE
              APPEND    EMGSTAT1,VSTATUS
            ENDIF
          ENDIF
.
          MATCH     SP70,DDATE
          GOTO      GETVIS60 IF EQUAL
.
          MATCH     SP70,PTVADESC
          IF        !@EQUAL
            MOVE      PTVADESC,KEY10
            APPEND    KEY10,VSTATUS
          ELSE
            MATCH     SP70,EMVIDSTA
            IF        !@EQUAL
              PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,KEY10
                APPEND    KEY10,VSTATUS
              ENDIF
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    EMVIDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
          GOTO      GETVIS60
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
GETVIS10  CALL      COTFIL00              * Open correct outpatient files
.
          CALL      OCLI0000              * Get Outpatient details
.
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVIS70 IF EQUAL
.
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      GETVIS11
          ENDIF
.
          PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,GETVIS12
.
          MATCH     PVISITE,OCASITE
          GOTO      GETVIS12 IF NOT EQUAL
.
          MATCH     PVIDOCT,OCACLIN
          GOTO      GETVIS12 IF NOT EQUAL
.
GETVIS11  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      GETVIS70 IF EQUAL
          MOVE      OCADOCT,PVIDOCT      * Use the doctor's code from the clinic
          GOTO      GETVIS60
.
GETVIS12  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
          GOTO      GETVIS60
.
.         Inpatient
.
GETVIS15  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD OF GETVIS60
          LOAD      VSTATUS,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                   INPSTAT5
          MOVE      AMBS,VISADIAG
          MOVE      ADIAG1,ADIADESC
          MOVE      ATIME,VISTTIME
.
          CALL      CHKMEH00
.
          MOVE      SP70,DDATE
          CALL      GETLTR00             * Get last transfer record
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC       * Unit Description
.
          MOVE      "A ",CATEGORY
          MOVE      TATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETVIS40
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      DDIAG,DDIADESC         * Discharged Diagnosis
.
          MOVE      SP20,KEY8
          IF        PTCNUADT<>1
            GOTO      GETVIS30
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTDAD1
          BRANCH    OVRCD,GETVIS30
          MATCH     SP70,PTDADCTS
          GOTO      GETVIS30 IF EQUAL
.
          MOVE      SP20,KEY8
          MOVE      PTDADCTS,KEY5            * transfer destination
          CALL      RDPTVAD1
          IF        OVRCD=0
            MOVE      PTVADESC,KEY8      * Destination desc.
          ENDIF
          GOTO      GETVIS35
.
GETVIS30  IF        PTCNDRSM=1
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
          ENDIF
.
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY8
          ENDIF
.
GETVIS35  PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP10,KEY8
          IF        !@EQUAL
            APPEND    KEY8,VSTATUS
          ENDIF
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    DTIME,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETVIS40  PACK      VISTLOC,AWARD,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,DASH,AWARD,SP70
.
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,VISTLOC
            ENDIF
.
          ENDIF
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
GETVIS60  IF        PVITYPE=1
            MATCH     "1",SHOWFRMT
            GOTO      GETVIS70 IF EQUAL
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVIS70 IF EQUAL
.
          COMPARE   TWO,PVITYPE
          GOTO      GETVIS70 IF EQUAL
.

          MOVE      PVIDOCT,KEY6         * Read the doctor's file to get nam
          CALL      RDDOCT1
          IF        OVRCD=1
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
            GOTO      GETVIS70
          ELSE
.           CALL      DOCNAM00             * format doctors name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
GETVIS70  MOVE      "&nbsp;",VISTDESC
          MOVE      "&nbsp;",WARDNAME
          LOAD      VISTDESC,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
.
.         Check if "Attended" and Outpatient - then format clinic(hcp)  * CAR 202491
.
          IF        PVITYPE=2
            MOVE      PVIDOCT,KEY6         * Read the doctor's file to get nam
            CALL      RDDOCT1
            IF        OVRCD=1
              CLEAR     DOCFNAME
.              APPEND    "Invalid Doctor - ",DOCFNAME
.              APPEND    PVIDOCT,DOCFNAME
.              RESET     DOCFNAME
            ELSE
              MOVE      DTITL,FMTTITLE            * I CAR 13038
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000                  * end I CAR 13038
            ENDIF
              CALL  FRMD0000
          ENDIF
.
          IF        PVITYPE=1
            MOVE      PVIBILL,KEY8
            CALL      RDEMVIS1
            IF        OVRCD=0
              MOVE      EMVIUR02,KEY6
              CALL      RDDOCT1
              IF        OVRCD=0
                MOVE      DTITL,FMTTITLE 
                MOVE      DGNAME,FMTGNAME
                MOVE      DSNAME,FMTSNAME
                CALL      DOCNM000       
              ENDIF
            ENDIF            
          ENDIF
.
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTDESC
          ENDIF
          IF        PVITYPE=3
            LOAD      VISTDESC,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                     INPSTAT5
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Insurance Class
          MOVE      ACODE,CLAIMCOD
.
          PACK      KEY6,AWARD,SP70

          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
          LOAD      VISTTYPE,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTTYPE
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          PACK      VISTDAY,DAYNAM3,SP70
.
GETVIS99  RETURN
.
.------------------------------------------------------------
. Get Last Transfer Record
.------------------------------------------------------------
GETLTR00  PACK      KEY30,PVIBILL,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETLTR10
          MATCH     PVIBILL,TADMN
          GOTO      GETLTR10 IF NOT EQUAL
          MOVE      TADOCT,PVIDOCT          * Clinician
.
          MATCH     "D",TMOVE
          GOTO      GETLTR99 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
          PACK      VISTLOC,TWARD,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      VISTLOC,PMVXMHOS,DASH,TWARD,SP70
.
            PACK      KEY3,PMVXMHOS,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,VISTLOC
            ENDIF

          ENDIF
          GOTO      GETLTR99
.
GETLTR10  MOVE      ADOCTA,PVIDOCT
          MOVE      ACLSSFT,TDEPT
          MOVE      ATYPE,TATYPE
.
GETLTR99  RETURN
.------------------------------------------------------------
.         Check for Mental Health visit
.------------------------------------------------------------
CHKMEH00  MOVE      ZERO,EXIT
          COMPARE   ONE,MHCNUSE
          GOTO      CHKMEH99 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,CHKMEH99
.
          PACK      KEY18,USERID,MEH01,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,CHKMEH98
.
          COMPARE   MHCNDVIS,WBSTLEV
          GOTO      CHKMEH98 IF LESS
.
          PACK      KEY35,ANSM,ANSH,SP1,VSTATUS
          PACK      VSTATUS,KEY35,SP70
          GOTO      CHKMEH99
.
CHKMEH98  MOVE      ONE,EXIT
.
CHKMEH99  RETURN
.------------------------------------------------------------
. Get Outpatient details
.------------------------------------------------------------
OCLI0000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
OCLI1000  CALL      RDKBOKA3
          BRANCH    OVRCD,OCLI9999
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBADATE,PVIDATE
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      OCLI1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          IF        OBASTAT=4
            MOVE      "Attended",VSTATUS
          ENDIF
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OCLI9999
.
          PACK      VISTLOC,OTHELTYP,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      VISTLOC,OTHEHOSP,DASH,OTHELTYP,SP70
.
              PACK      KEY3,OTHEHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,VISTLOC
              ENDIF

            ENDIF
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 1
            UNPACK    SP70,OCTSITE,OCTCTYP,OCTGRP,OCTDESC,OCTXBOK,OCTXATT
            UNPACK    SP70,OCTBKT,OCTATT,OCTACT,OCTVACS
          ENDIF
.
          MOVE      OTHECTYP,UNITCODE
.
          MATCH     SP70,UNITDESC
          IF        @EQUAL
            MOVE      OCTDESC,UNITDESC
          ENDIF
.
OCLI9999  RETURN
+
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the visit files site code. If the site is invalid
.            or blank just open the default site of out.                        
.*******************************************************************************
COTFIL00  MATCH     SP70,PVISITE             * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.------------------------------------------------------------
. Get Medical Record Coding Details
.------------------------------------------------------------
MRTCOD00  MOVE      ZERO,CODESTAT
.
          MATCH     "00000000",PVIDATE    * Bad Debt? If so Ignore!
          GOTO      MRTCOD90 IF EQUAL
.
          COMPARE   ZERO,DISCFLAG
          GOTO      MRTCOD20 IF EQUAL     * Doing all visits
.
          MOVE      PVIBILL,ADMISSNO
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MRTCOD90
.
          COMPARE   DISCFLAG,ASTAT        * Match For Admission Status
          GOTO      MRTCOD90 IF NOT EQUAL
.
          COMPARE   THREE,DISCFLAG
          GOTO      MRTCOD20 IF NOT EQUAL * not doing discharges
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,MRTCOD90
.
          MATCH     SP3,PMSVX044
          IF        !@EQUAL
            MATCH     PMSVX044,PMVXCSNG   * Match for coder snags
            GOTO      MRTCOD90 IF NOT EQUAL
          ENDIF
.
          MOVE      "VN",CATEGORY
          MOVE      PMVXCSNG,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCSNAG
.
          PACK      KEY13,PVIBILL,EPSCD001                            *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          IF        OVRCD=0
.........   IF        PVIBILL<>PTEDADMN
            MATCH     PVIBILL,PTEDADMN
            IF   !@EQUAL
              MOVE      SP70,PTEDOPER   * No coder id
              MOVE      SP70,PTEDUSID   * No coder web user id
            ENDIF
          ENDIF
.
.       Codedflg = 0 for All, 1 for incomplete coding, 2 for complete coding
.
          IF        CODEDFLG=1
            MATCH     SP8,ACODDTE
            GOTO      MRTCOD90 IF NOT EQUAL   * Coding completed
          ELSE
            IF        CODEDFLG=2
              MATCH     SP8,ACODDTE
              GOTO      MRTCOD90 IF EQUAL     * Coding not completed
            ENDIF
          ENDIF
.
MRTCOD20  MOVE      ZERO,CODESTAT
          MATCH     SP8,ACODDTE
          IF        !@EQUAL
            MOVE      ONE,CODESTAT       * coded
          ENDIF
.
          MOVE      SP70,PRIDISCD        * I CAR 18122
          MOVE      SP70,PDIADESC
          PACK      KEY13,PVIBILL,SP70                                *C-240107
          CALL      RSPTECD1
MRTCOD30  CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD50
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD40 IF NOT EQUAL
.
          MATCH     PTEDTYPE,CMDISP
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT                                    *C-240107
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MOVE      PTEDCODE,PRIDISCD
.
          MOVE      PTEDDESC,PDIADESC    * end I CAR 18122
.
MRTCOD40  IF        PVITYPE<>2
            MOVE      SP70,VISADIAG
            MOVE      SP70,ADIADESC
          ENDIF
.
          PACK      KEY13,PVIBILL,SP70                                *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD50
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD50 IF NOT EQUAL
          MOVE      PTEDCODE,VISADIAG
          MOVE      PTEDDESC,ADIADESC          * disease description
.
MRTCOD50  MOVE      SP70,AUDITDTE
          PACK      KEY18,ADMISSNO,Z70
          CALL      RSMRAUC2             * get last coding Audit Date
          CALL      RPMRAUC2
          BRANCH    OVRCD,MRTCOD80
.
          MATCH     ADMISSNO,MRACVISN
          GOTO      MRTCOD80 IF NOT EQUAL
.
          MOVE      MRACADTE,AUDITDTE
.
MRTCOD80  MOVE      ZERO,EXIT
          GOTO      MRTCOD99
.
MRTCOD90  MOVE      ONE,EXIT
.
MRTCOD99  RETURN
.
.-------------------------------------------------------------------------------
.   Reportno 2: Set Parameters - Disaster Patient File
.-------------------------------------------------------------------------------
STDIP000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STDIP001,STDIP002,STDIP003,STDIP004,STDIP005
.
          GOTO      STDIP999
.
STDIP001  PACK      DISPT001,QRYDATA,SP70
          GOTO      STDIS999
.
STDIP002  PACK      DISPT002,QRYDATA,SP70
          GOTO      STDIS999
.
STDIP003  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DISPT003,CCENT,CYEAR,CMON,CDAY
          GOTO      STDIP999
.
STDIP004  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DISPT004,CCENT,CYEAR,CMON,CDAY
          GOTO      STDIP999
.
STDIP005  MOVE      QRYDATA,DISPT005
          GOTO      STDIS999
.
STDIP999  RETURN
+
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,URNUMBER,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.
          PACK      KEY8,PMAIURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,NWDALT99
          PACK      KEY8,PMAIURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,NWDALT99
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
NWDALT99  RETURN
+
.------------------------------------------------------------
. Disaster Codes Summary View 
.------------------------------------------------------------
DISLS000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      DISLS040 IF EQUAL
.
          GOTO      DISLS093
.
.         ************ DISPLAY FORMACTION **********
.
DISLS040  CLEAR     WEBTITLE
          MOVE      "Disaster View",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISLS999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      DISLS999
.
DISLS093  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISLS999
.
DISLS999  RETURN
+
.------------------------------------------------------------
. Disaster Codes Summary Table
.------------------------------------------------------------
DCSTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,LOOPCNTR
          PACK      DISACODE,DISACODE,SP70
          MATCH     SP70,DISACODE                             * Disaster Filter
          GOTO      DCSTAB99 IF EQUAL
.
          IF      IBCNMHOS=1
            MATCH   SP70,FILTHOSP                         * Hospital Filter
            IF      @EQUAL
              PACK    FILTHOSP,WBSEHOSP,SP70
            ENDIF
          ENDIF
. allow All option to be selected still
          MATCH     Z70,FILTHOSP
          IF        @EQUAL
            PACK      FILTHOSP,SP70
          ENDIF
.
          PACK      KEY25,DISACODE,SP70
          CALL      RSDSPTL2
DCSTAB10  CALL      RKDSPTL2
          BRANCH    OVRCD,DCSTAB99
.
          ADD       ONE,LOOPCNTR
          IF        (LOOPCNTR > 100)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          MATCH     DISACODE,DSPLCODE
          GOTO      DCSTAB99 IF NOT EQUAL
.
          PACK      KEY17,DSPLURNO,DSPLCODE,SP70
          CALL      RDDSPAT1
          BRANCH    OVRCD,DCSTAB10
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     "1",FILTEXCL
            IF        @EQUAL
              MATCH     SP70,DSPTEDAT
              IF        !@EQUAL & !@EOS
                GOTO      DCSTAB10
              ENDIF
            ENDIF
          ENDIF
.
          MATCH   SP70,FILTHOSP
          GOTO    DCSTAB12 IF EQUAL
.
          IF      IBCNMHOS=1
            PACK      KEY8,DSPLVISN,SP70
            CALL      RDPMVX11
.                       there may be bookings/wait list etc so continue
            BRANCH    OVRCD,DCSTAB12
.
            MATCH     PMVXMHOS,FILTHOSP
            GOTO      DCSTAB10 IF NOT EQUAL
          ENDIF
.
DCSTAB12  PACK      KEY8,DSPLURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DCSTAB10
.
          MOVE      SP70,KEY3                                   * Folder Colour
          PACK      KEY8,DSPLURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
            CALL      PATFLD00
          ENDIF
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000
.
          PACK      KEY9,DSPLCODE,SP70
          CALL      RDDSMAS1
          IF        OVRCD=1
            CALL      CLRDIS00
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     "3",DSMAACTV
            GOTO      DCSTAB10 IF EQUAL
          ENDIF
.
          MOVE      SP70,DIM3                                            * Type
          MOVE      SP70,DIM50                                       * Hospital
          MOVE      SP70,VISTLOC                                     * Location
          MOVE      SP70,UNITCODE                                        * Unit
          MOVE      SP70,UNITDESC 
          MOVE      SP70,DOCFNAME                                      * Doctor
          MOVE      SP70,ADIADESL                                   * Diagnosis
          MOVE      SP70,VISTDESC                                  * Visit Type
.
.-------------------------------------------------------------------------------
.
          PACK      KEY8,DSPLVISN,SP70                       * Check Inpatients
          CALL      RDPTVIS1
          IF        OVRCD=0
            PACK      KEY8,DSPLVISN,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
.                                                                  * Visit Type
              IF      PVITYPE=ONE
                MOVE    "EMG",DIM3                     
              ENDIF
              IF      PVITYPE=TWO
                MOVE    "OP ",DIM3                    
              ENDIF
              IF      PVITYPE=THREE
                MOVE    "IP ",DIM3
              ENDIF
              IF      PVITYPE=FOUR
                MOVE    "FIN",DIM3
              ENDIF
              IF      PVITYPE=FIVE
                MOVE    "DAY",DIM3
              ENDIF
              IF      PVITYPE=SIX
                MOVE    "COM",DIM3
              ENDIF
              IF      PVITYPE=SEVEN
                MOVE    "WRD",DIM3
              ENDIF
              IF      PVITYPE=EIGHT
                MOVE    "ADH",DIM3
              ENDIF
              IF      PVITYPE=NINE
                MOVE    "OTH",DIM3
              ENDIF
.
              LOAD    VISTDESC,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
              COMPARE SIX,PVITYPE
              IF      @EQUAL
                MOVE    VISTCOMH,VISTDESC
              ENDIF
.
              COMPARE NINE,PVITYPE
              IF      @EQUAL
                PACK    VISTDESC,ANSR,ANSF,SP70
              ENDIF
.
              MATCH   SP70,PVIDOCT
              IF      !@EQUAL & !@EOS
                MOVE      PVIDOCT,KEY6
                CALL      RDDOCT1
                IF        OVRCD=0
.                 CALL      DOCNAM00             * format doctors name
                  MOVE      DTITL,FMTTITLE            * I CAR 13038
                  MOVE      DGNAME,FMTGNAME
                  MOVE      DSNAME,FMTSNAME
                  CALL      DOCNM000
                ENDIF
              ENDIF
.
              MATCH   "EMG",VISTDESC
              IF      @EQUAL
                PACK      KEY8,DSPLVISN,SP70
                CALL      RDEMVIS1
                IF        OVRCD=0
                  IF      EMVISTAT=1
                    MOVE    "EMG Current",VISTDESC
                    PACK    KEY3,EMVILOCN,SP70
                    CALL    RDEMLOC1
                    IF      OVRCD<>1
                      MOVE    EMLODESC,VISTLOC
                    ENDIF
                  ENDIF
.
                  IF      EMVISTAT=2 | EMVISTAT =3
                    MOVE    "EMG Discharged",VISTDESC
                  ENDIF
.
                  IF      EMVISTAT=4
                    MOVE    "EMG Cancelled",VISTDESC
                  ENDIF
.
                  MATCH   SP70,EMVIUR02
                  IF      !@EQUAL & !@EOS
                    MOVE      EMVIUR02,KEY6
                    CALL      RDDOCT1
                    IF        OVRCD=0
.                     CALL      DOCNAM00             * format doctors name
                      MOVE      DTITL,FMTTITLE 
                      MOVE      DGNAME,FMTGNAME
                      MOVE      DSNAME,FMTSNAME
                      CALL      DOCNM000
                    ENDIF
                  ENDIF
                  MOVE    EMVITXT2,ADIADESL
                ENDIF
              ENDIF
.
              IF      IBCNMHOS=1
                MATCH   SP70,PMVXMHOS
                IF      !@EQUAL & !@EOS
                  PACK    KEY3,PMVXMHOS,SP70
                  CALL    RDPTHSP1
                  IF      OVRCD=0
                    MOVE    PTHSNAME,DIM50                           * Hospital
                  ENDIF
                ENDIF
.
                MATCH   SP70,FILTHOSP                         * Hospital Filter 
                IF      !@EQUAL & !@EOS
                  PACK    FILTHOSP,FILTHOSP,SP70
                  MATCH   PMVXMHOS,FILTHOSP
                  GOTO    DCSTAB10 IF NOT EQUAL
                ENDIF
              ENDIF
.
              PACK    KEY8,DPVIBILL,SP70
              CALL    RDMISS1
              IF      OVRCD=0
                PACK      VISTLOC,AWARD,SP70                         * Location
.
                MATCH     "1",PTCNWBDS
                IF        @EQUAL
                  PACK      KEY6,AWARD,SP70
                  CALL      RDWARD1
                  IF        OVRCD=0
                    MOVE      WBDESC,VISTLOC
                  ENDIF
                ENDIF
.
                MATCH     "2",PTCNWBDS
                IF        @EQUAL
                  PACK      KEY6,AWARD,SP70
                  CALL      RDWARD1
                  IF        OVRCD=0
                    MOVE      PTWDSDES,VISTLOC
                  ENDIF
                ENDIF
.
                PACK      UNITCODE,ACLSSFT,SP70                          * Unit
.
                MOVE      SP70,UNITDESC
                MATCH     SP70,UNITCODE
                IF        !@EQUAL
                  PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
                  CALL      RDCODE1
                  IF        OVRCD=0
                    MOVE      TDESC,UNITDESC
                  ENDIF  
                ENDIF
.
                CLEAR     ADIADESL
                MOVE      ADIAG1,DIM25 
                APPEND    DIM25,ADIADESL                           * Diagnosis
                APPEND    " - ",ADIADESL
                APPEND    PMVXPICD,ADIADESL
                RESET     ADIADESL
                
.
                MATCH     SP70,ADOCTA                                  * Doctor
                IF        !@EQUAL & !@EOS
                  PACK      KEY10,ADOCTA,SP70
                  CALL      RDPMHCP1
                   IF        OVRCD=0
                    MOVE      PMHCTITL,FMTTITLE
                    MOVE      PMHCGNAM,FMTGNAME
                    MOVE      PMHCSNAM,FMTSNAME
                    CALL      DOCNM000
                  ENDIF
                ENDIF
.
                IF      PVITYPE=3
                  LOAD    VISTDESC,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                         INPSTAT5
                ENDIF
.
              ENDIF  
.
              PACK    KEY8,DPVIBILL,SP70
              CALL    RDPMEVT1
              IF      OVRCD=0
                PACK      UNITCODE,PMEVUNIT,SP70                         * Unit
.
                MOVE      SP70,UNITDESC
                MATCH     SP70,UNITCODE
                IF        !@EQUAL
                  PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
                  CALL      RDCODE1
                  IF        OVRCD=0
                    MOVE      TDESC,UNITDESC
                  ENDIF
                ENDIF
.
                MOVE      "EV",CATEGORY
                MOVE      PMEVEVNT,CODE
                CALL      GETCOD00
.
                MATCH     "I",TCINDC1                         * Inpatient Event
                IF        @EQUAL
                  PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70     * Location
.
                  MATCH     SP70,PMEVPWRD
                  IF        !@EQUAL & !@EOS
                    MATCH     "1",PTCNWBDS
                    IF        @EQUAL
                      PACK      KEY6,PMEVPWRD,PMEVPBED,SP70
                      CALL      RDWARD1
                      IF        OVRCD=0
.                       MOVE      WBDESC,VISTLOC
                        PACK      VISTLOC,PMEVPWRD,SLASH,WBDESC,SP70
                      ENDIF
                    ENDIF
.
                    MATCH     "2",PTCNWBDS
                    IF        @EQUAL
                      PACK      KEY6,PMEVPWRD,PMEVPBED,SP70
                      CALL      RDWARD1
                      IF        OVRCD=0
.                       MOVE      WBDESC,VISTLOC
                        PACK      VISTLOC,PMEVPWRD,SLASH,PTWDSDES,SP70
                      ENDIF
                    ENDIF
                  ENDIF
.
                ENDIF
.
                MATCH     "O",TCINDC1                        * Outpatient Event
                IF        @EQUAL
                  PACK      VISTLOC,PMEVPLOC,SP70                    * Location
                  PACK      UNITCODE,PMEVCTYP,SP70                       * Unit
.
                  MOVE      SP70,UNITDESC
                  MATCH     SP70,UNITCODE
                  IF        !@EQUAL
                    PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
                    CALL      RDCODE1
                    IF        OVRCD=0
                      MOVE      TDESC,UNITDESC
                    ENDIF
                  ENDIF
.
                ENDIF
.
                MATCH     SP70,PMEVACON                                * Doctor
                IF        !@EQUAL & !@EOS
                  PACK      KEY10,PMEVACON,SP70
                  CALL      RDPMHCP1
                  IF        OVRCD=0
                    MOVE      PMHCTITL,FMTTITLE
                    MOVE      PMHCGNAM,FMTGNAME
                    MOVE      PMHCSNAM,FMTSNAME
                    CALL      DOCNM000
                  ENDIF
                ENDIF
.
              ENDIF
.
            ENDIF 
            GOTO    DCSTAB20
          ENDIF             
.
.-------------------------------------------------------------------------------
.
          PACK      KEY8,DSPLVISN,SP70                         * Check Bookings
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      "BOK",DIM3
            MOVE      "Booking",VISTDESC
            PACK      UNITCODE,BKREDEPT,SP70                             * Unit
.
            MOVE      SP70,UNITDESC
            MATCH     SP70,UNITCODE
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,UNITDESC
              ENDIF
            ENDIF
.
            PACK      KEY8,BKREBOOK,SP70
            CALL      RDBKRX11
            IF        OVRCD=0
              IF        IBCNMHOS=1
                MATCH     SP70,BKRXPOWD
                IF        !@EQUAL & !@EOS
. 
                  PACK      KEY6,BKRXPOWD,SP70
                  CALL      RDWARD1
                  IF        OVRCD<>1
                    PACK      DIM50,PTWDHOSN,SP70
. 
                    PACK      KEY3,PTWDHOSN,SP70
                    CALL      RDPTHSP1
                    IF        OVRCD=0
                     MOVE      PTHSNAME,DIM50                        * Hospital
                    ENDIF
                  ENDIF
                ENDIF
.
                MATCH   SP70,FILTHOSP                         * Hospital Filter
                IF      !@EQUAL & !@EOS
                  PACK    FILTHOSP,FILTHOSP,SP70
                  MATCH   PTWDHOSN,FILTHOSP
                  GOTO    DCSTAB10 IF NOT EQUAL
                ENDIF
              ENDIF
.
              PACK      VISTLOC,BKRXPOWD,SP70                        * Location
.
              MATCH     SP70,BKRXPOWD
              IF        !@EQUAL & !@EOS
                MATCH     "1",PTCNWBDS
                IF        @EQUAL
                  PACK      KEY6,BKRXPOWD,SP70
                  CALL      RDWARD1
                  IF        OVRCD=0
                    MOVE      WBDESC,VISTLOC
                  ENDIF
                ENDIF
.
                MATCH     "2",PTCNWBDS
                IF        @EQUAL
                  PACK      KEY6,BKRXPOWD,SP70
                  CALL      RDWARD1
                  IF        OVRCD=0
                    MOVE      PTWDSDES,VISTLOC
                  ENDIF
                ENDIF
              ENDIF 
.
              MATCH     SP70,BKREADOC                                  * Doctor
              IF        !@EQUAl & !@EOS
                PACK      KEY6,BKREADOC,SP70
                CALL      RDDOCT1
                IF        OVRCD=0
                  MOVE      DTITL,FMTTITLE
                  MOVE      DGNAME,FMTGNAME
                  MOVE      DSNAME,FMTSNAME
                  CALL      DOCNM000 
                ENDIF
              ENDIF
.
              PACK      KEY18,BKREBOOK,SP70
              CALL      RSBKDIA1
              CALL      RKBKDIA1
              IF        OVRCD=0
                MATCH     BKREBOOK,BKDIBOOK
                IF        @EQUAL
                  MOVE      BKDIDES1,ADIADESL                       * Diagnosis
                ENDIF
              ENDIF
.
            ENDIF
            GOTO    DCSTAB20
          ENDIF
.
.-------------------------------------------------------------------------------
.
          PACK      KEY19,DSPLURNO,SP20                    * Check Waiting List
          CALL      RDSTREA1
DCSTAB15  CALL      RDKTREA1
          IF        OVRCD=0        
            MATCH     DSPLURNO,WMURNO    
            GOTO      DCSTAB18 IF NOT EQUAL
.
            MOVE      SP70,DIM8
            MOVE      WMBOOK,DIM8
            MATCH     DSPLVISN,DIM8
            GOTO      DCSTAB15 IF NOT EQUAL 
.
            MOVE      "WAT",DIM3
            MOVE      "WAT",VISTDESC
            PACK      UNITCODE,WMUNIT,SP70                               * Unit
.
            MOVE      SP70,UNITDESC
            MATCH     SP70,UNITCODE
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,UNITDESC
              ENDIF
            ENDIF
.
            MATCH     SP70,WMREASON
            IF        @EQUAL | @EOS
              MOVE      WMDESC,ADIADESL
            ELSE
              MOVE      WMREASON,ADIADESL                           * Diagnosis
            ENDIF
.
            IF        IBCNMHOS=1
.
              MATCH   SP70,FILTHOSP
              IF      !@EQUAL & !@EOS
                PACK    FILTHOSP,FILTHOSP,SP70
                MATCH   WTWMIHSP,FILTHOSP
                GOTO    DCSTAB10 IF NOT EQUAL
              ENDIF
.
              PACK      DIM50,WTWMIHSP,SP70
.
              PACK      KEY3,WTWMIHSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSNAME,DIM50                             * Hospital
              ENDIF
            ENDIF 
.
            MATCH     SP70,WMDOCTOR                                    * Doctor
            IF        !@EQUAL & !@EOS
              PACK      KEY6,WMDOCTOR,SP70
              CALL      RDDOCT1
              IF        OVRCD=0
                MOVE      DTITL,FMTTITLE
                MOVE      DGNAME,FMTGNAME
                MOVE      DSNAME,FMTSNAME
                CALL      DOCNM000 
              ENDIF
            ENDIF
.
            GOTO      DCSTAB20
          ENDIF
.
.-------------------------------------------------------------------------------
.
DCSTAB18  PACK      KEY36,DSPLVISN,SP70                     * Check Outpatients
          CALL      RDSBOKA6
DCSTAB19  CALL      RDKBOKA6
          IF        OVRCD=0
            MATCH     DOBAOUTN,DSPLVISN
            GOTO      DCSTAB10 IF NOT EQUAL
.
            MOVE      "OP ",DIM3
            MOVE      "OP ",VISTDESC
.
            MOVE      OBAOUTNO,KEY8
            CALL      RDDIAG1
            IF        OVRCD=0
              MOVE      OPDIDESC,ADIADESCL                          * Diagnosis
            ENDIF
.
            MOVE      OBACTYP,UNITCODE                                   * Unit
.
            MOVE      SP70,UNITDESC
            MATCH     SP70,UNITCODE
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,UNITDESC
              ENDIF
            ENDIF
.
            MOVE      OBAOUTNO,KEY8
            CALL      RDBOKB1
            IF        OVRCD=0
              MOVE      OTBBDEPT,UNITCODE                                * Unit
.
              MOVE      SP70,UNITDESC
              MATCH     SP70,UNITCODE
              IF        !@EQUAL
                PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  MOVE      TDESC,UNITDESC
                ENDIF
              ENDIF
.
            ENDIF
.
            PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
            CALL      RDMASA1
            IF        OVRCD=1
              CALL      CLRMAS00
            ENDIF
            PACK      VISTLOC,OTMALTYP,SP70                          * Location
.
            PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
            CALL      RDSESA1
            IF        OVRCD=1
              CALL      CLRSES00
            ENDIF
.
           PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
            CALL      RDOTHED1
            IF        OVRCD=1
              CALL     CLOUTHED
            ENDIF
            PACK      VISTLOC,OTHELTYP,SP70                          * Location
.
            PACK      DIM50,OTHELTYP,SP70
            COMPARE   ONE,IBCNMHOS
            IF        @EQUAL
.
              MATCH   SP70,FILTHOSP
              IF      !@EQUAL & !@EOS
                PACK    FILTHOSP,FILTHOSP,SP70
                MATCH   OTHEHOSP,FILTHOSP
                GOTO    DCSTAB10 IF NOT EQUAL
              ENDIF
.
              PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
              CALL      RDMASA1
              IF        OVRCD<>1
                PACK      DIM50,OTHEHOSP
.
                PACK      KEY3,OTHEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSNAME,DIM50                           * Hospital
                ENDIF
.
              ENDIF
            ENDIF
.
            MATCH     SP70,OBACLIN
            IF        !@EQUAL & !@EOS
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
              CALL      RDCLIA1
              IF        OVRCD=1
                CALL      RDSCLIA1
                CALL      RDPCLIA1
                BRANCH    OVRCD,DCSTAB20
.
                MATCH     OBASITE,OCASITE
                GOTO      DCSTAB20 IF NOT EQUAL
.
                MATCH     OBACLIN,OCACLIN
                GOTO      DCSTAB20 IF NOT EQUAL
              ENDIF
.
              MATCH     SP70,OCADOCT
              IF        !@EQUAL & !@EOS
                PACK      KEY6,OCADOCT,SP70
                CALL      RDDOCT1
                IF        OVRCD=0
                  MOVE      DTITL,FMTTITLE
                  MOVE      DGNAME,FMTGNAME
                  MOVE      DSNAME,FMTSNAME
                  CALL      DOCNM000
                ENDIF
              ENDIF
.
            ENDIF 
.
            GOTO      DCSTAB20
.
          ENDIF
.
.-------------------------------------------------------------------------------
. 
          GOTO      DCSTAB10
.
DCSTAB20  MOVE      SP70,KEY3                                   * Folder Colour
          PACK      KEY8,DSPLURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
            CALL      PATFLD00
          ENDIF
.
          MATCH   SP70,FILTTYPE                             * Visit Type Filter
          IF      !@EQUAL & !@EOS
            PACK    FILTTYPE,FILTTYPE,SP70
            PACK    VISTDESC,VISTDESC,SP70
.
            MATCH   "EMG",FILTTYPE
            IF      @EQUAL
              MATCH    "EMG",VISTDESC
              GOTO     DCSTAB10 IF NOT EQUAL
            ELSE
              MATCH   VISTDESC,FILTTYPE
              GOTO    DCSTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    DSPLURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    DSPLVISN,PATLINK
          APPEND    "&disadiid=",PATLINK
          APPEND    DSPTDIID,PATLINK
          APPEND    "&disacode=",PATLINK
          APPEND    DSPLCODE,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",DIM50,"#",":          * 0
                             "#"",FORMATNM,"#",":                * 1
                             "#"javascript:LinkPatient('",PATLINK,"') #",": * 2
                             "#"",KEY3,"#",":                    * 3
                             "#"",DSMADESC,"#",":                * 4
                             "#"",DSPTDIID,"#",":                * 5
                             "#"",DIM3,"#",":                    * 6
                             "#"",VISTLOC,"#",":                 * 7
                             "#"",UNITCODE,"#",":                * 8
                             "#"",DOCFNAME,"#",":                * 9
                             "#"",ADIADESL,"#",":                * 10
                             "#"",VISTDESC,"#",":                * 11
                             "#"",UNITDESC,"#");"                * 12 
.
          GOTO      DCSTAB10
.
DCSTAB99  RETURN
.
.------------------------------------------------------------
. Disaster Selection List
.------------------------------------------------------------
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     "3",DSMAACTV
            GOTO      DISSEL10 IF EQUAL
          ENDIF
.
          PACK      DISACODE,DISACODE,SP70
          PACK      DSMACODE,DSMACODE,SP70
          MATCH     DISACODE,DSMACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",DSMACODE," selected>":
                               DSMADESC,"</option>"
          ELSE
           WRITE     HTMLFILE;"<option value=",DSMACODE,">",DSMADESC,"</option>"
          ENDIF
          GOTO      DISSEL10
.
DISSEL99  RETURN
.
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HOSSEL00  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            PACK      FILTHOSP,WBSEHOSP
          ENDIF
          MATCH     Z70,FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value='~~~' selected>":
                               "All</option>"
          ELSE
            WRITE     HTMLFILE;"<option value='~~~'>":
                               "All</option>"
          ENDIF
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HOSSEL10  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSSEL99
.
          PACK      KEY13,WBSEUID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,WBSEUID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HOSSEL10
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HOSSEL10
.
HOSSEL99  RETURN
.
.-------------------------------------------------------------------------------
.  DISWAR00 - Disaster Validations and Warnings
.-------------------------------------------------------------------------------
DISWAR00  MATCH     SP70,DISPT002
          GOTO      DISWAR99 IF EQUAL
          GOTO      DISWAR99 IF EOS
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            GOTO      DISPT092
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            GOTO      DISPT094
          ENDIF
.

          MOVE      DISPT003,DSPTSDAT
          PACK      KEY9,DISPT002,SP70
          CALL      RDDSMAS1
          IF        OVRCD=ONE
            MOVE      "Disaster Master Record not found.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      DISWAR99
          ENDIF
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,DISPT003
            IF        @LESS
              MOVE      "Visit Date is not on or after the Disaster Start Date. Record not posted.",WEBTITLE
              CALL      WEBERR00
              MOVE      ONE,EXIT
              GOTO      DISWAR99
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSMAEDAT
            IF        !@EQUAL & !@EOS
              MATCH     DISPT003,DSMAEDAT
              IF        @LESS
                MOVE      "Visit Date is not prior to the Disaster End Date. Disaster Record not posted.",WEBTITLE
                CALL      WEBERR00
                MOVE      ONE,EXIT
                GOTO      DISWAR99
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT001,DSPTDIID
          MOVE      DISPT002,DSPTCODE
          MOVE      DISPT003,DSPTSDAT
          MOVE      DISPT004,DSPTEDAT
          MOVE      DISPT005,DSPTOTCM
          MOVE      " 3",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT002,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      "Disaster code already exists.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      DISWAR99
          ENDIF
.
          MATCH     SP70,ADMISSNO
          GOTO      DISWAR99 IF EQUAL
.
          MATCH     "       0",ADMISSNO
          GOTO      DISWAR99 IF EQUAL
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT002,DSPLCODE
          MOVE      ADMISSNO,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT002,ADMISSNO,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      "Disaster visit record already exists.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      DISWAR99
          ENDIF
.
DISWAR20  CALL     NWDALT00
.
DISWAR99  RETURN
.
+
.-------------------------------------------------------------------------------
.  DELDIS00 - Delete Disaster Code
.-------------------------------------------------------------------------------
DELDIS00  MATCH     SP70,DISPT002
          GOTO      DELDIS90 IF EQUAL
.
. * delete all link records from disptlaf
DELDIS05  PACK      KEY25,URNUMBER,DISPT002,Z70
          CALL      RSDSPTL1
DELDIS10  CALL      RPDSPTL1
          BRANCH    OVRCD,DELDIS20
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DELDIS20 IF NOT EQUAL
.
          MATCH     DISPT002,DSPLCODE
          GOTO      DELDIS20 IF NOT EQUAL
.
          PACK      KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL      DEDSPTL1
          GOTO      DELDIS05
.
DELDIS20  PACK      KEY17,URNUMBER,DISPT002,SP70
          CALL      RDDSPAT1
          BRANCH    OVRCD,DELDIS90
.
          PACK      KEY17,DSPTURNO,DSPTCODE,SP70
          CALL      DEDSPAT1
          GOTO      DELDIS95
.
DELDIS90  MOVE      "Disaster code does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELDIS99
.
DELDIS95  MOVE      ZERO,EXIT
DELDIS99  RETURN
+
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.******************************************************************************
.
          INC       ACCDIAIO/INC
          INC       APSMASIO/INC
          INC       ARCVX1IO/INC
          INC       BOKDIAIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       EMRICDIO/INC
          INC       EMRLOCIO/INC
          INC       EMRUNKIO/INC
          INC       EMRVISIO/INC
          INC       MLTSECIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDGWIO/INC
          INC       PATCHCIO/INC
          INC       PATDO1IO/INC
          INC       PATFACIO/INC
          INC       PATDSCIO/INC
          INC       PATFLTIO/INC
          INC       PATPEIIO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMMBIO/INC
          INC       PATPA1IO/INC
          INC       PATPR1IO/INC
          INC       PATMI1IO/INC
          INC       PATRE1IO/INC
          INC       PATRGMIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       NZPSPRIO/INC
          INC       MEHVI1IO/INC
          INC       MEHLEGIO/INC
          INC       PATWR1IO/INC
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       ACCCMTIO/INC   * ACC Comments File
          INC       ACCLODIO/INC   * ACC Claim Lodgements
          INC       PMSTLEIO/INC            * Patient Titles table
          INC       PMSWORIO/INC
          INC       PATWVEIO/INC
          INC       PMSEVTIO/INC
          INC       PATFN1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTCANIO/INC
          INC       OUTRSHIO/INC
          INC       OUTBB1IO/INC
          INC       OUTMA1IO/INC
          INC       OUTHEDIO/INC
          INC       OUTSITIO/INC
          INC       OUTSESIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       MRTAUCIO/INC
          INC       MRTLOCIO/INC
          INC       MRTMASIO/INC
          INC       MRTHISIO/INC
          INC       MRTSTFIO/INC
          INC       MRTPDSIO/INC
          INC       MRTVISIO/INC 
          INC       PATECOIO/INC
          INC       PATECDIO/INC
          INC       PATGSRIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATINVIO/INC
          INC       PATNIDIO/INC
          INC       PATALRIO/INC
          INC       PATPGRIO/INC
          INC       PATVADIO/INC
          INC       RESLNKIO/INC
          INC       PATW11IO/INC                                       *I-43498
          INC       PATW12IO/INC            * WIES12                   *I-51504
          INC       PTW12BIO/INC            * WIES12B
          INC       PATW13IO/INC            * WIES13
          INC       PATW14IO/INC            * WIES14                  *I-145161
          INC       PATW15IO/INC            * WIES15
          INC       PATW16IO/INC            * WIES16
          INC       PATW17IO/INC            * WIES17
          INC       PATWMAIO/INC
          INC       PMSCDNIO/INC
          INC       PMSCTCIO/INC
          INC       PMSOVRIO/INC
.
..          INC       PMSHCGIO/INC
..          INC       PMSHCPIO/INC
.
          INC       PMSPX2IO/INC
..          INC       WATSUSIO/INC
          INC       BOKRECTM
          INC       CLPMSVX1
          INC       DGCLICAC
          INC       DGCLICEC
          INC       DGCLICOB
          INC       DGCLICUP
          INC       NZPSPRTM
          INC       PATDOCTM
..          INC       PATDOCCD
          INC       PMIGTNID
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATMASTM
          INC       CLPMSPX2
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATCLMTM
          INC       PATRE1TM                * Person Responsible for Account
          INC       PATVISTM
          INC       PATDSCTM
          INC       OBSCNATM
          INC       OBSDIATM
          INC       NAMSTRCD
          INC       IBAWEBCD
          INC       GETDRG
          INC       CALCAGE
          INC       OBSCNAPR
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATDSC
          INC       CLPATDOC
          INC       CLPATVIS
          INC       CLPMSRES
          INC       DAYOFWEK
          INC       PMSCDNDS
.
          INC       PATASFIO/INC
          INC       PATSFAIO/INC
          INC       PATDADIO/INC
          INC       PATEORIO/INC
          INC       PMSAIDIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSVX1IO/INC
          INC       AAEDI1IO/INC
          INC       AAEDE1IO/INC
          INC       PATHSPIO/INC
          INC       OUTDIAIO/INC
          INC       OUTRF1IO/INC
          INC       ALLREFIO/INC
          INC       ALLRLNIO/INC
          INC       ALLENCIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       ALLDEPIO/INC
          INC       OPRDEAIO/INC
          INC       PATCMCIO/INC
          INC       PATUNAIO/INC
          INC       PRIHDBIO/INC                 * holding header file
          INC       PRIHREIO/INC                 * holding referral file
.
.        ******* HPS BLR INCLUDE ENDS HERE          ************
.
          INC       WEBDATCD
          INC       CLPMSNUT
          INC       PATFFLAB
          INC       PATGBCRN                     * I-48227
          INC       PMSNUTIO/INC
          INC       PMSRESIO/INC
          INC       PMSNUTTM     
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS
          INC       OBSRESIO/INC
          INC       OBSPHYIO/INC
          INC       OBSCALIO/INC
          INC       OBSDITIO/INC
          INC       OBSMEDIO/INC
          INC       OBSPINIO/INC
          INC       OBSCNCIO/INC
          INC       OBSCNAIO/INC
          INC       OBSCNBIO/INC
          INC       OBSDIAIO/INC
          INC       OBSBPHIO/INC
          INC       OBSBHIIO/INC
          INC       OBSLABIO/INC
          INC       OBSPROIO/INC
          INC       OBSREAIO/INC
          INC       VISPAYIO/INC
          INC       ALLCASIO/INC
.
          INC       NZHISWIO
          INC       TMPALIIO/INC
          INC       AAEMASTM
          INC       CLOUTHED
          INC       PATNAMCD
          INC       TFILENAM
