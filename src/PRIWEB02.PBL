.-------------------------------------------------------------------------------
. Program       : PRIWEB02
.
. Function      : Private Practice Billing Maintenance
.
. Modifications :
.-------------------------------------------------------------------------------
. V12.01.02 12/02/2026  J.Tan            TSK 0966921
.           Mod to remove tempfiles
. V12.01.01 22/09/2025  J.Tan            TSK 0966921
.           Mod to remove tempfiles
. V12.00.02 27/08/2025  Alina Bhari      TSK 0954453
.           Recompiled for PRIINVHL - Added Patient Name
. V12.00.01 24/07/2025  J.Tan          TSK 0962500
.           Mod Cash routines to check for U/R number
. V11.05.09 19/03/2025 Jacob Jackson   TSK 0945956
.           For determining which patient indicator, check it on a per doctor-
.           referral basis instead of just for all category codes
. V11.05.08 13/03/2025 Peter Vela      TSK 0939466
.           Added Eclipse Webservices DVAW 
. V11.05.07 13/03/2025 Alina Bhari     TSK 0945900
.           Display only the Journal with Ind5 =D when category CL Ind 15 = S
.           Display all Journal Type when cat CL ind 5 =blank except those      
.           where Cat J Ind 7 isnot blank - SJRN1000                         
. V11.05.06 06/03/2025 Alina Bhari     TSK 0945900
.           Validate the Cat CC Ind 15, CAT J Ind 7 to (a-z,A-Z,0-9)
.           - VALINTXT,SJRN0000,SJRN1000
. V11.05.05 05/03/2025 Alina Bhari     TSK 0945900
.           Displayed valid journal when CatCL Ind 15 is empty - SJRN1000
. V11.05.04 19/02/2025 Alina Bhari     TSK 0945900
.           Excluded the Journal Types from the drop down (Cat J, Ind 7) if the
.           claim type of the invoice selected does not match Cat CL, Ind 15
.           when Enable Restricted Journals on Invoice Functionality is turned
.           on - SJRN1000
. V11.05.03 20/01/2025  Jacob Jackson  TSK 0945956
.           Add/update functionality for PRDTLVIS
. V11.05.02 27/11/2024  Thanh T        TSK 0939466
.           Added Distance in kms field
. V11.05.01 26/11/2024  Ebon Clements   TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
.-------------------------------------------------------------------------------
.       V11.04.08 08/08/2024  J.Tan            TSK 0952630
.                 Recompiled for PRIHFCF - fixed pringint item amount
.       V11.04.07 06/08/2024  J.Tan            TSK 0947872
.                 Fixed removing Referral with with Linked visit invoice
.       V11.04.06 09/07/2024  J.Tan            TSK 0934944
.                 Mod to check Referral Provider no from a linked Practice
.       V11.04.05 11/04/2024  J.Tan         TSK 0941662
.                 Mod PRDTGSTM - GST of Total amt(Item amt x Quantity)
.       V11.04.04 09/04/2024  J.Tan          TSK 0944326
.                 Recompiled for PRIINVHT - printing Cabrini invoice with Claim
.       V11.04.03 12/03/2024  J.Tan          TSK 0943265
.                 Fixed updating PBDEBT for bad debt journal
.       V11.04.02 04/03/2024  PJ Le Febour     TSK 0929044dc
.                 update WBPICUID WBPICDAT WBPICTIM before call WRWBPCI1
.                 update WBBSCUID WBBSCDAT WBBSCTIM before call WRWBBBS1
.       V11.04.01 11/12/2023  Ebon Clements  TSK 0940976
.                 Fixed account paid tag - RFDE5400
.       V11.03.04 20/10/2023  Nikitha B      TSK 0938983
.                 Changed workflow at PRBILL70 to check for claim and health 
.                 fund in consecutive if blocks.
.       V11.03.03 02/10/2023  Nikitha B      TSK 0927699
.                 Read stationary varibles CAPPRVNO and PTCNHABN
.       V11.03.02 05/05/2023  J.Tan          TSK 0847250
.                 Recompiled for PRIUPURE - fixed payment amount
.       V11.03.01 20/03/2023 J.Tan          TSK 0847250
.                 Mod Updating PP Unreconciled invoice(PRIUPURE)
.       V11.02.08 11/10/2022 J.Tan           TSK 0908346
.                 Mod setting Hospital id with blank register code (CHKCLDCP)
.       V11.02.07 20/09/2022 Thanh T         TSK 0908346
.                 Recompiled for CHKCLDCP changes
.       V11.02.06 12/09/2020  Thanh T        TSK 0908346
.                 Called CHKCLDCP to check if the clinical document is setup
.                 for the claim type clininal document mapping table. This
.                 will determine the disabled status of the Invoice button
.       V11.02.05 19/05/2022 J.Tan           TSK 0837128
.                 Mod DPRA0000 - default PRFA to use Cat CL indic 24
.       V11.02.04 04/05/2022  J.Tan          TSK 0918324
.                 Mod ADDITM00 to update Invoice to be printed if item added
.       V11.02.03 22/04/2022  J.Tan          TSK 0837128
.                 Mod for Default PRFA based on claim code
.       V11.02.02 10/02/2022  Thanh T       TSK 0905641
.                 Recompiled as OUTMA1FD (PATMASTM) changes
.       V11.02.01 02/02/2022 Peter Vela      TSK 0902857
.                 Added WebServices parameter validation around BBSW0000
.                 01/02/2022  Peter Vela      TSK 0902857
.                 Added WebServices parameter validation around PCIW0000
.                 Recompiled for PRIINVPR - Added check for WebServices
.                 parameter at call to WRIMW000
.                 24/01/2021  Jacob Jackson   TSK 0864505
.                 Recompiled for PRIINVHL, PRIINVTL, PRIHFCF - Preferred name
.       V11.01.08 24/08/2021   Davin          TSK 0897318
.                 Recompiled for PRIINVTL - added field 51 (Adjustment Total)
.       V11.01.07 21/07/2021   Peter Vela     TSK 0909175
.                 Added WebServices BBSW functionality
.       V11.01.06 20/07/2021   J.Tan          TSK 0908902
.                 Fixed printing Insurance company for multi pages invoice
.       V11.01.05 07/06/2021  Peter Vela     TSK 0906538
.                 Added multihospital validation PCIW0200
.       V11.01.04 21/05/2021  Peter Vela     TSK 0906538
.                 Added WebServices PCIW functionality
.       V11.01.03 18/05/2021   J.Tan           TSK 0308555
.                 Recompiled for PRIINVPR - printing Insurance company
.       V11.01.02 29/04/2021  Tracey Nguyen    TSK 0308555
.                 Recompiled for PRIINVPR
.       V11.01.01 31/03/2021  Thanh T          TSK 0299439
.                 Added FRMPPLST - from private practice pending list 
.-------------------------------------------------------------------------------
.       V11.00.09 09/12/2020  Thanh T          TSK 0872840
.                 Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
.       V11.00.08 20/10/2020  Peter Vela       TSK 0898361
.                 Recompiled for PRIINVPR 
.       V11.00.07 20/10/2020  Peter Vela       TSK 0898361
.                 Recompiled for PRIINVPR
.       V11.00.06 27/07/2020  Tracey Nguyen    TSK 0892433
.                 Recompiled for PRIHRETM
.       V11.00.05 04/05/2020  J.Tan            TSK 0891314
.                 Mod to initialise CURRDEP and NBNKDEPS (I*C on tmpcash)
.                 07/05/2020  Thanh T          TSK 0876574
.                 Recompiled for PMSCEXTM/PMSCEXTD changes 
.       V11.00.04 24/04/2020  Peter Vela       TSK 0874025                  
.                 Recompiled for PRIINVPR
.       V11.00.03 22/04/2020  Jill Parkinson Task 0296238
.                 Added functionality to store invoice as a clinical document
.       V11.00.02 17/04/2020  Peter Vela       TSK 0874025
.                 Recompiled for PRIECTFD
.       V11.00.01 06/04/2020  Thanh T          TSK 0879163
.                 Recompiled for PRIHFCF 
.-------------------------------------------------------------------------------
.       V10.15.01 22/10/2019  Peter Vela       TSK 0861979
.                 Added tag for Account Paid
.       V10.14.06 20/08/2019  Thanh T.         TSK 0879967                     
.                 Recompiled for PRIINVPR changes                             
.       V10.14.05 03/06/2019  Tracey Nguyen    TSK 0872823
.                 Open PMSHCGA1 in INIT0000 for PRIHRETM
.       V10.14.04 23/04/2019  Peter Vela    TSK 0871522
.                 Recompiled for PRIINVPR
.       V10.14.03 20/03/2019  J.Tan            TSK 0857392
.                 Changed RCP Transaction count from DIM3 to DIM5
.       V10.14.02 21/11/2018  Peter Vela     TSK 0866770
.                 Recompiled for PRIINVPR
.       V10.14.01 04/02/2019  Peter Vela     Task 0867807
.                 Added hidden variable date in DISN0000 for voucher validation
.                 in Eclipse DBS Claiming
.-------------------------------------------------------------------------------
.       V10.13.20 11/12/2018  J.Tan          Task 0859743
.                 Added printing Bulk Billing DB4 Form
.       V10.13.19 21/12/2018  Peter Vela     Task 0859743
.                 Recompiled for OUTECTFD
.       V10.13.18 30/11/2018  Peter Vela     TSK 0859743
.                 Added Bulk Billing functionality for Raise and Raise and Claim
.                 invoice
.       V10.13.17 21/11/2018  Peter Vela       TSK 0866770  
.                 Recompiled for PRIINVPR
.       V10.13.16 09/11/2018  J.Tan            TSK 0859742
.                 Mod to print Lodgement of Advice
.       V10.13.15 08/11/2018  Peter Vela       TSK 0863035
.                 Fixed emrect variables in SESFX000 
.       V10.13.14 07/11/2018  Peter Vela       TSK 0863035
.                 Added HTMLFILE to RFDE5200
.       V10.13.13 07/11/2018  Peter Vela       TSK 0863035
.                 Added age check for claimant details AGEA0000
.       V10.13.12 07/11/2018  Peter Vela       TSK 0863035
.                 Extended ECCLMARR for Eclipse PCS
.       V10.13.11 02/11/2018  Peter Vela       TSK 0863035
.                 Added validation to TMPROVR, assign value from PRHRROVR
.                 if Eclipse PCS claim
.       V10.13.10 25/10/2018  Peter Vela       TSK 0863035
.                 Added Raise and Claim functionality for Eclipse Store and 
.                 Forward
.       V10.13.09 18/10/2018  Peter Vela       TSK 0863035
.                 Added write to emrectaf for Eclipse Store and Forward
.                 PRPINV00                 
.       V10.13.08 12/10/2018  Don Nguyen       TSK 0838558
.                 Deleted temp file (PRIAUJXX) after processing.
.                 Removed PORT from temp filename (FNAMEJ).
.                 12/10/2018  Tracey Nguyen    TSK 0863035
.                 Added tags RFDE4900,RFDE5000 for cat ta - IMC
.       V10.13.07 27/09/2018  Tracey Nguyen    TSK 0859743
.                 Recompiled for PRIHREFD/TD/TM/IO - Added PRHRROVR
.                 Referral Override (Cat ro)
.                 Added tags for cat ta ind1=3 (bulk billing) in RFDE0000
.       V10.13.06 25/09/2018  J.Tan         TSK 0836727
.                 Added Restrictive Override code
.       V10.13.05 10/09/2018  Peter Vela       TSK 0863035
.                 Added tag for Category ta in RFDE0000
.       V10.13.04 21/08/2018  J.Tan            TSK 0859742
.                 Added Hospital Indicator 
.       V10.13.03 16/08/2018  Ebon Clements    TSK 0859742
.                 Added Eclipse other claimant functionality
.       V10.13.02 26/07/2018  J.Tan            TSK 0848506
.                 Changed PP Doctor from DIM6 to DIM10
.       V10.13.01 25/07/2018  J.Tan            TSK 0860613
.                 Fixed Reprint PP to include payment from health fund
.-------------------------------------------------------------------------------
.       V10.12.06 14/06/2018  J.Tan            TSK 0848921
.                 Added tag for Invoice claim type for input journal
.       V10.12.05 25/05/2018  J.Tan            TSK 0848921
.                 Added PTCNRJNL - Enable restricted Jounals on Invoice
.       V10.12.04 15/05/2018  J.Tan         TSK 0856329
.                 Recompiled for PRIINVPR - Lingard invoice with multple pages
.       V10.12.03 26/04/2018  Peter Vela    TSK 0852811
.                 Recompiled for PRIINVTL
.       V10.12.02 29/03/2018  J.Tan         TSK 0854838
.                 Added Checking subscript value for array of items (array out
.                 of bounds)
.       V10.12.01 22/03/2018  Ebon Clements TSK 0854383 
.                 Added new contacts postal address tags
.-------------------------------------------------------------------------------
.       V10.11.12 27/11/2017  Thanh Tieu    TSK 0821710
.                 Recompiled as PATMASTM changed
.       V10.11.11 10/10/2017  Peter Vela    TSK 0837619
.                 Recompiled for PRIHREFD
.       V10.11.10 27/09/2017  Peter Vela    TSK 0837619
.                 Changed PRHTASPF to Compaensation Claim indicator
.       V10.11.09 18/09/2017  Peter Vela    TSK 0837619
.                 Removed functionality for PRHTASPF PRHTAICF
.       V10.11.08 14/09/2017  Peter Vela    TSK 0837619
.                 Added RFDE4200
.       V10.11.07 11/09/2017  Peter Vela    TSK 0837619
.                 Added tag for IMC Linked Visit Number HTRE3400
.       V10.11.06 06/09/2017  J.Tan         TSK 0821057
.                 Recompiled for PRIINVHL - mod to variable 76 health fund
.       V10.11.05 05/09/2017  Richa Phogat      TSK 0816889
.                 Removed validation that user id deleting a comment matches the
.                 user id who created the comment in DEIV0000
.       V10.11.04 29/08/2017  Peter Vela        TSK 0837619
.                 Added IMC Details functionality. 
.                 Replaced PRHRROVR with PRHTROVR
.                 Added validation for IMC Details in PRLIT000
.       V10.11.03 23/08/2017  Richa Phogat      TSK 0816889
.                 Removed validation that user id deleting a comment matches the
.                 user id who created the comment in DENT0000
.       V10.11.02 01/08/2017  Peter Vela     TSK 0837619
.                 Added IMC Vouchers functionality
.                 02/08/2017 J.Tan           
.                 Added CLPRIDTR CLPRIHTR CLPRIHRE
.       V10.11.01 25/07/2017  Peter Vela     TSK 0837619
.                 Added IMC Referral Override functionality
.                 28/07/2017  Thanh T.       TSK 0821710
.                 Audit admission/outpatient/UR comments. 
.                 changed PATMASTM/PMSPX2TM.
.-------------------------------------------------------------------------------
.       V10.10.03 12/07/2017  Jill Parkinson TSK 0841962
.                 Added check for preadmissions and cancelled admissions in 
.                 VALD1000
.       V10.10.02 10/05/2017  Tracey Nguyen TSK 0837929
.                 Recompiled for PRIINVHL and PRIINVTL - Fixed I*C error 
.                 message on PATMESG1
.       V10.10.01 23/03/2017  Peter Vela    TSK 0835025
.                 Recompiled for PRIHFCF
.       V10.08.06 20/06/2016  Peter Vela    TSK 0294177
.                 Added Eclipse IMC functionality - Raise and Claim
.       V10.08.05 07/09/2016  J.Tan         TSK 0822590
.                 Recompiled for PRIVRDEB
.       V10.08.04 24/06/2016  J.Tan         TSK 0821329
.                 Mods to initialise CHKMPRAC to 1
.       V10.08.03 09/06/2016  Peter Vela    TSK 0820206
.                 Recompiled for PRIINVHL
.       V10.08.02 08/06/2016  Peter Vela    TSK 0820206
.                 Added PTCNUIMC functionality - Using Eclipse IMC Module Yes/No
.       V10.08.01 18/04/2016  Peter Vela    TSK 0294177
.                 Changed read to prihdb to KEY27
.                 06/04/2016  Peter Vela    CAR 0294177
.                 Added Duration and AC Override Ind to Add, Update, Delete
.                 Private Practice AMA/MBS Items
.                 24/03/2016  Steve Armstrong  TSK 0294177
.                 Added PRHTACOI & PRHTTDUR to CLRHTR00
.       V10.07.03 31/12/2015  Peter Vela    CAR 0318496
.                 Added tag for PRICIUSR in PRCM0000
.                 Fixed delete by display in ICMTAB00 
.       V10.07.02 21/12/2015  J.Tan         CAR 0303942
.                 Mods to setup Payment code
.       V10.07.01 13/10/2015  J.Tan         CAR 310329
.                 Mods to set PRDTEFFD - Date item assigned to Fees Invoiced
.       V10.06.08 22/10/2015  Ania P        CAR 319733
.                 Fixed order of Invoice notes.
.       V10.06.07 15/07/2015  J.Tan         CAR 319450
.                 Recompiled for PRIINVPR - errors msg for Invoice Header/Tail
.       V10.06.06 15/05/2015  Davin         CAR 310155
.                 Recompiled for PATGBCRN - added MOD10V05 for BPAY
.       V10.06.05 23/04/2015  J.Tan          CAR 284113
.                 Fixed Invoice heading comments
.       V10.06.04 01/04/2015  J.Tan          CAR 284113
.                 Fixed displaying User ID for Deleting by for Referreal Comment
.       V10.06.03 17/03/2015  J.Tan          CAR 284113
.                 Added Referral and Invoice Comments
.                 18/03/2015  J.Tan           CAR 314367
.                 Fixed I*D on prihtraf
.       V10.06.02 12/03/2015  Jill Parkinson CAR 314213 
.                 Recompiled for PRIINVPR - removed isadd
.       V10.06.01 05/03/2015  Ebon Clements   CAR 313709
.                 Fixed branch on exit after TRNPAY00 call
.       V10.05.03 23/02/2015  Peter Vel       CAR 313302
.                 Replaced spaces with +s for REDIRECT in PRBILL10 
.                 Replaced spaces with +s for INVOICEN in PRBILL75
.       V10.05.02 12/11/2014  Ebon Clements   CAR 307050
.                 Fixed size of PRITM011
.       V10.05.01 16/09/2014  J.Tan           CAR 305259
.                 Fixed I*P on priinvof
.       V10.04.17 24/06/2014  J.Tan           CAR 299427
.                 Fixed STITYP00 - set up Item type (ITYPE)
.                 25/06/2014  Patrick Adair
.                 Added Invoice Item Maintenance to allow item update
.       V10.04.16 17/06/2014  Steve Armstrong CAR 301639
.                 Added call to TFILENAM for FNAMPOST (AUTOPCOD).
.                 Recompiled for changes to AUTOPCOD & AUPCDVAR.
.       V10.04.15 16/06/2014  Peter Vela    CAR 302147
.                 Recompiled for PRIINVPR
.       V10.04.14 10/06/2014  Jill Parkinson CAR 301639
.                 Added calls to TFILENAM to INIT0000 for FNAME2 and FNAME3
.       V10.04.13 27/05/2014  J.Tan        CAR 295319
.                 Added a tag for Balance payable for checking inv.in credit
.       V10.04.12 21/05/2014  Don Nguyen   CAR 300814
.                 Modified GNPRFA00 to output State (PRHRADD4) &
.                 Mobile Phone Number (PRHRMPHN). Called CLPRHR00 in SPRA0000.
.       V10.04.11 17/04/2014 Peter Vela    CAR 285260
.                 Recompiled for PRIINVPR - Moved Cabrini invoice tail one line
.                 down in PRINV230
.       V10.04.10 16/04/2014  J.Tan        CAR 261630
.                 Recompiled for PRIIINVPR - Removed port number from temp files
.       V10.04.09 15.04.2014  Peter Vela   CAR 285260
.                 Recompiled for PRIINVPR
.       V10.04.08 14.04.2014  Peter Vela   CAR 285260
.                 Recompiled for PRIINVPR
.       V10.04.07 11.04.2014  Peter Vela   CAR 285260
.                 Recompiled for PRIINVPR
.       V10.04.06 07.04.2014  Peter Vela   CAR 286158
.                 Recompiled for PATMASTM
.       V10.04.05 31/03/2014 Peter Vela    CAR 285260
.                 Recompiled for PRIINVPR
.       V10.04.04 31.03.2014  B.G.Ackland  CAR 299363
.                 Replace META Tag Redirect with Javascript in Common RDIREC00
.                 Routine
.       V10.04.03 04/03/2014 J.Tan          CAR 297922
.                 Mods checking PP Service Doctor for deposits
.       V10.04.02 23/01/2014 Patrick Adair  CAR 265844
.                 Recompiled for PRIHRETM - new fields for PRA State and
.                 Mobile phone
.                 Added MSXF0000 to allow default of postal address
.       V10.04.01 16/12/2013 J.Tan          CAR 294414
.                 Recompiled for PRIINVPR - checking type of register
.-------------------------------------------------------------------------------
.       V10.03.19 09/12/2013  J.Tan         CAR 280726
.                 Recompiled for PRIINVPR - flag for Inp.from Other hospital
.       V10.03.18 02/12/2013 Sandra Barcham CAR 294414
.                 Fix TPAY0000 to read rcpregaf
.       V10.03.17 26/11/2013 J.Tan          CAR 294271
.                 Mods TPAY0000 to exclude INP/Outpat/EMR payments
.       V10.03.16 19/11/2013  Ania P        CAR 292460
.                 Recompiled for PRIINVPR
.       V10.03.15 09/09/2013  J.Tan         CAR 288852
.                 Mods to display Current balance on Input journal
.       V10.03.14 05/07/2013  J.Tan         CAR 288042
.                 Recompiled for PRIINVPR - Fixed WEBFLAG
.       V10.03.13 02/07/2013  J.Tan         CAR 287477
.                 Fixed printing Credit Notes total
.       V10.03.12 20/06/2013  Davin         CAR 287161
.                 Recompiled for PATGBCRN - right justify ptcnhbpi
.       V10.03.11 22/05/2013  J.Tan         CAR 275330
.                 Recompiled for PRIHFCF - printing unlimited number of items
.       V10.03.10 26/03/2013  Don Nguyen    CAR 282342
.                 Recompiled for PATGBCRN
.       V10.03.09 26/02/2013  Ania P        CAR 281021
.                 RECOMPILED for PRICTCTM
.       V10.03.08 15/01/2013  J.Tan         CAR 278675
.                 Fixed Patient indicator for reprinting invoice
.       V10.03.07 14/02/2012  J.Tan         CAR 275189
.                 Checked for Inactive Service Doc for 'Raise' Inv. availibility
.       V10.03.06 21/11/2012  J.Tan         CAR 276170
.                 Fixed printing Credit note amount line PCRDN000 for PRCNLAYT=0
.       V10.03.05 25/09/2012  J.Tan         CAR 272436
.                 Mods for PP Cash transfer
.       V10.03.04 18/07/2012  Don Nguyen    CAR 264561
.                 Recompiled for PATGBCRN
.       V10.03.03 21/06/2012 J.Tan          CAR 266559
.                 Fixed deleting multiple referrals for same unique id
.       V10.03.02 09/05/2012 J.Tan          CAR 222041
.                 Recompiled for PRIINVPR - checking for range of Medical Prac
.       V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.                 Recompiled for PATMASTM
.       V10.02.01 04/04/2011  Jill Parkinson CAR 239574
.                 Removed open of ibaprntf
.       V10.01.01 05/11/2010  Mike Laming    CAR 230710
.                 Added Cease Date (PRITDAT2) test in CHKITM00,VALITM00,GETDES00
.       V10.00.14 14/10/2010  J.Tan             CAR 229953
.                 Fixed I*C on priinvof index 3
.       V10.00.13 06/10/2010  J.Tan             CAR 229953
.                 Added new functionality to delete referral with no transaction
.       V10.00.12 30/09/2010  Peter Vela        CAR 222954
.                 Modified RFLS0000. Added sortlist functionality
.       V10.00.11 15/09/2010  J.Tan             CAR 230162
.                 Recompiled for PRIINVPR - display insurance code on payment
.       V10.00.10 14/09/2010  Davin             CAR 229590
.                 Recompiled for PRIINVTL
.       V10.00.09 26/08/2010  Davin             CAR 226963
.                 Recompiled for PRIINVHL & PRIINVTL
.       V10.00.08 24/08/2010  Peter Vela        CAR 221500
.                 Recompiled for PRIINVTL
.       V10.00.07 23/08/2010  Steve Armstrong   CAR 228847
.                 Recompiled for changes to PATIN1IO
.       V10.00.06 21/06/2010 J.Tan         CAR 213683
.                 Recompiled for PRIINVPR - printing SJOG multiple pages of Inv.
.       V10.00.05 26/05/2010 J.Tan         CAR 222645
.                 Recompiled for PRIINVPR - multiple deposits
.       V10.00.04 25/05/2010  Mike Laming      CAR 169939
.                 Recompiled for PRICOMTM - Added "Active" flag (Insurance Co.)
.       V10.00.03 07/05/2010 J.Tan         CAR 220549
.                 Added Comments option on the Next invoice screen
.       V10.00.02 22/04/2010 J.Tan         CAR 210750
.                 Modified SJOG layout to print 30 chars of item desc.
.       V10.00.01 19/03/2010 J.Tan         CAR 218400
.                 Fixed I*C on prifinsf
.       V9.12.16  11/03/2010 J.Tan         CAR 217734
.                 Fixed checking refunded deposits
.       V9.12.15  02/03/2010 Peter Vela    CAR 261465
.                 Reread all tables when updttype = P @ PRPSTT00
.       V9.12.14  19/02/2010 Peter Vela    CAR 216465
.                 Recompiled for PRIHFCF
.       V9.12.13  08/02/2010 Ebon Clements CAR 214739
.                 Changed PRFA for children to use CALCAGE - HPRA0000
.       V9.12.12  11/01/2009 J.Tan         CAR 212904
.                 Recompiled for PRIINVPR - mods PRFA for children
.       V9.12.11  23/12/2009 J.Tan         CAR 213127
.                 Mods to check for zero filled CMDEREFD
.       V9.12.10  08/12/2009 Mike Laming   CAR 210835
.                 Added logic for Private Practice Outstanding Debt alert
.       V9.12.09  07/10/2009  Peter Vela     CAR 205008
.                 Recompiled for PRIHFCF
.       V9.12.08  01/10/2009  Peter Vela     CAR 203243
.                 Recompiled for PRIINVHL
.       V9.12.07  18/09/2009  Peter Vela     CAR 205008
.                 Added Private Practice Stationery Template functionality
.       V9.12.06  22/09/2009  Peter Vela     CAR 194715
.                 Recompiled for PRIINVPR
.       V9.12.05  03/09/2009  Peter Vela     CAR 194715
.                 Recompiled for PRIINVHL PRIINVTL
.       V9.12.04  07/08/2009  Mike Laming    CAR 123419
.                 Recompiled for PRIINVPR - re-write PATHL000, Add index 4 to
.                 PRIHTRFD/IO and index 3 to Temp3 table
.       V9.12.03  29/07/2009  Mike Laming    CAR 123419
.                 Recompiled for PRIINVPR - "Item Stepdown" in PATHL000 fix
.       V9.12.02  23/07/2009  J.Tan          CAR 200230
.                 Recompiled for PRICALFN - fixed generating previous year data
.       V9.12.01  17/06/2009  J.Tan          CAR 198435
.                 Recompiled for PRIINVPR - SJOG item description
.       V9.11.10  01/04/2009  Mike Laming    CAR 123419
.                 Recompiled for PRIINVPR - Mods to "Item Stepdown" in PATHL000
.       V9.11.09  23/09/2009  Davin            CAR 178015
.                 Recompiled for PRIINVTL - Added field 33 for BPAY CRN
.                 Added VARGBCRN and PATGBCRN - BPAY Reference Number
.       V9.11.08  02/03/2009  J.Tan  CAR 188205
.                 Mods to print 'Non-bank deposit' as 'Payment recieved'
.       V9.11.07  08/01/2009  Steve Armstrong   CAR 185927
.                 Recompiled for changes to PRIINVPR & PRIWEBVR.
.                 08/01/2009 J.Tan          CAR 178415
.                 Added Medical Practice to prifinsf
.       V9.11.06  04/12/2008  J.Tan         CAR 183240
.                 Mods add a new referral to have PRHRPINV=0
.       V9.11.05  01/12/2008  Steve Armstrong   CAR 184702
.                 Recompiled for changes to PRIINVHL & PRIINVTL.
.       V9.11.04  06/11/2008  Peter McMullen CAR 174725
.                 convert internal javascript to W3C standards
.       V9.11.03  23/10/2008  J.Tan         CAR 178415
.                 Mods checking for Medical practice user access file
.       V9.11.02  09/10/2008 J.Tan          CAR 180522
.                 Fixed printing Cabrini credit notes
.       V9.11.01  08/10/2008 J.Tan          CAR 180349
.                 Recompiled for PRIINVPR - Cabrini inv.not to print Ref.Details
.-------------------------------------------------------------------------------
.       V9.10.07  11/09/2008 J.Tan          CAR 151983
.                 Fixed checking for Compensation claims
.       V9.10.06  29/08/2008 J.Tan          CAR 176993
.                 Recompiled for PRIINVPR - Cabrini invoice layout
.       V9.10.05  22/07/2008 Ebon Clements  CAR 173815
.                 Recompiled for PRIINVPR - Service time on invoice SJOG
.       V9.10.04  23/05/2008 J.Tan          CAR 169149
.                 Added Date and Time invoice created/updated
.       V9.10.03  19/05/2008  J.Tan         CAR 168643
.                 Mods to update prihtraf.referring doctor code & date
.                 when updating referral details
.       V9.10.02  12/05/2008  J.Tan         CAR 162313
.                 Added Deposit Status to compdeaf file
.       V9.10.01  02/05/2008  J.Tan         CAR 166477
.                 Mods to initialise referral details for print invoice
.-------------------------------------------------------------------------------
.       V9.09.13  01/04/2008  Ebon Clements CAR 164504
.                 Fixed GETDES00 test for PRCNTCOD
.       V9.09.12  07/01/2008  Ebon Clements CAR 150639
.                 Added default date/time to common item template load
.       V9.09.11  31/10/2007  J.Tan         CAR 151863
.                 Added AMA Fee to VALITM - validate Private Practice item
.       V9.09.10  12/09/2007  Ebon Clements CAR 150049
.                 Added RDPRHD2 to PRBILL75 to fix redirect unique number
.       V9.09.09  10/09/2007  J.Tan         CAR 149873
.                 Fixed Length of referral for re-print
.       V9.09.08  06/09/2007  Ebon Clements CAR 146075
.                 Re read correct pridtraf record in UPJR3000 after CBAL0000
.       V9.09.07  03/09/2007  Ebon Clements CAR 146075
.                 Added PRITMPFD for item common template functionality
.       V9.09.06  31/08/2007  Ebon Clements CAR 146075
.                 Changed RDIT0000 to pack key with temp file variables
.       V9.09.05  16/08/2007  Peter Vela    CAR 147462
.                 Initialised form1 to zero @ PPRA0000
.       V9.09.04  13/08/2007  J.Tan         CAR 146075
.                 Mods to remove items from tempfile
.       V9.09.03  08/08/2007  J.Tan         CAR 146075
.                 Fixed I*C on patmis file
.       V9.09.02  18/07/2007  J.Tan         CAR 145426
.                 Recompiled for PRIINVPR - GST round to the nearest 5 cents
.       V9.09.01  12/06/2007  Peter Vela    CAR 142173
.                 Added Service Fee 85% and Service Fee 75% in Private Practice
.                 remote script
.-------------------------------------------------------------------------------
.       V9.08.05  14/05/2007  Peter Vela    CAR 136586
.                 Recompiled for PRIINVPR - Added SJOG Referral Doctor details
.       V9.08.04  31/01/2007  Peter Vela     CAR 127930
.                 Recompiled for MRTMASFD
.       V9.08.03  31/01/2007  Peter Vela    CAR 123419
.                 Commented out call to PPTMP000 at PRPINV00 to stop the
.                 pathology test temp file from being processed twice.
.       V9.08.02  17/01/2007  Peter Vela    CAR 127865
.                 Replaced scan with cmatch for test item prefix validation
.       V9.08.01  28/09/2006  Peter Vela    CAR 118366
.                 Recompiled for PRIINVHL - Added medicare suffix
.-------------------------------------------------------------------------------
.       V9.07.01  07/07/2006  Ebon Clements CAR 110304
.                 Fixed PRHTFLAG population in ADDITM00
.-------------------------------------------------------------------------------
.       V9.06.02  31/05/2006  J.Tan         CAR 94343
.                 Fixed to set U/R number in SETP5000 routine
.       V9.06.01  28/04/2006  Peter Vela    CAR 102393
.                 Recompiled for PRIINVHL - Added PRFA variables from PRIINVFD
.-------------------------------------------------------------------------------
.       V9.05.03  27/03/2006  Peter Vela    CAR 95780
.                 Recompiled for PRIINVHL - Added emg mobile contact numbers
.       V9.05.02  27/03/2006  Peter Vela    CAR 61299
.                 Recompiled for PRIINVHL
.       V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                 Mods for PATCODTM - Hospital specific category codes
.       V9.05.B05 08/02/2006  Ebon Clements CAR 93690 & 94343
.                 Fixed person responsible for account for compensable patients.
.                 Added call to SETP0000 at WPRA9000, MPRA9000 and VPRA9000
.       V9.05.B04 03/02/2006  Ebon Clements CAR 93434
.                 Added BRANCH EXIT,MAIN1000 to MAIN1400 to fix fifo not found
.       V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.                 Mods for REDIRECT length change. Recompiled for IBAWEBDF
.       V9.05.B01 20/12/2005  Ebon Clements CAR 76341
.                 Key length changes for encounter number
.-------------------------------------------------------------------------------
.       V9.04.20  18/11/2005  J.Tan    CAR 83861
.                 Added error message to display key when item cann't be removed
.       V9.04.19  09/11/2005  J.Tan    CAR 83611
.                 Fixed printing Patient indicator on header of reprint inv.
.       V9.04.18  03/10/2005  J.Tan    CAR 81410
.                 Recompiled without patsusaf file
.       V9.04.17  27/10/2005  J.Tan    CAR 81410
.                 Added error message when item can not be removed
.       V9.04.16  06/10/2005  J.Tan    CAR 79018
.                 Recompiled for PRIINVPR - fixing item amount
.       V9.04.15  12/09/2005  Ebon Clements      CAR 61061
.                 Added PTCNCOMF - Using compensable details patient folders
.       V9.04.14  03/08/05 J.Tan    CAR 62750
.                 Removed redefined amount variables
.       V9.04.13  14/07/2005  Mike Laming   CAR 60399
.                 Correct Referring Doctor Date at PRLIT400
.       V9.04.12  08.06.2005  J.Tan          CAR 56701
.                 Added claim number to prihtraf file
.       V9.04.11  10/05/2005  Mike Laming   CAR 60399
.                 Correct at PRLIT400 so that if PRCNRDOC=0 routine does no
.                 duplicate Misc Items when Referring Doc changes
.       V9.04.10  17/03/2005  Jill Habasque CAR 55072
.                 Removed calls to WEBERR00 without exiting
.       V9.04.09  01/03/2005  Peter Vela CAR 53064
.                 Added Referral Date column in Private Practice Doctor Referral
.                 List
.       V9.04.08  29/12/2004  J.Tan    CAR 56039
.                 Fixed printing invoice with credit notes
.       V9.04.07  16/12/2004  J.Tan    CAR 55893
.                 Fixed PRFA
.       V9.04.06  29/11/2004  J.Tan    CAR 55143
.                 Mods to recreate tempfile before printing invoice
.       V9.04.05  16/11/2004  J.Tan    CAR 53063
.                 Recompiled for PRIINVPR - set 'COPINV' flag
.       V9.04.04  03/11/2004  J.Tan    CAR 53063
.                 Recompiled for PRIINVPR - Fixed PRFA
.       V9.04.03  20/10/2004  J.Tan    CAR 54373
.                 Fixed PRFA for invoice (initialised prfa name)
.       V9.04.02  19/08/2004  J.Tan    CAR 52351
.                 Mods displaying error message when printing invoice
.       V9.04.01  17/08/2004  J.Tan    CAR 52346
.                 Fixed deleting items
.-------------------------------------------------------------------------------
.       V9.03.23  16/08/2004  J.Tan    CAR 52351
.                 Fixed deleting items
.                 Fixed raise invoice button redirect variable
.       V9.03.22  13/08/2004  J.Tan    CAR 52531
.                 Recompiled for PRIINVPR - I*C on pristatf file
.       V9.03.21  10/08/2004  J.Tan    CAR 52504
.                 Mods checking register for non-banked private prac.deposit
.       V9.03.20  02/08/2004  J.Tan    CAR 52033
.                 Recompiled for PRIINVPR - printing item unit price
.       V9.03.19  19/07/2004  J.Tan    CAR 50220
.                 Mods to read PMI extension file for patient header
.       V9.03.18  15/07/2004  J.Tan    CAR 51544
.                 Set up PRFA for the invoice header on reprint
.       V9.03.17  14/07/2004  J.Tan    CAR 51544
.                 Set up patient name for the invoice header on reprint
.       V9.03.16  14/07/2004  J.Tan    CAR 51544
.                 Set up patient name for the invoice header
.       V9.03.15  30/06/2004  J.Tan    CAR 51112
.                 Re-compiled for PRIINVPR - unreleased Non-banked deposit
.       V9.03.14  17/06/2004 Peter Vela CAR 49016
.                 2004 Stat Changes PRS/2
.                 Recompiled for PMSPX2TM
.       V9.03.13  03/06/2004 Lina Vo  CAR 40109
.                 Added Referring by Doctor option (prcnrdoc=1)
.                 Added VALRDC00 - Validate referring doctor
.       V9.03.12  01/06/2004 J.Tan  CAR 50273
.                 Recompiled for OUTINVS - updating invoice number in rcpdteaf
.       V9.03.11  01/06/2004  J.Tan  CAR 50220
.                 Set exit to zero after print invoice
.       V9.03.10  25/05/2004  J.Tan  CAR 50111
.                 Recompiled for PRIINVPR - print deposit, setup PRFA
.       V9.03.09  17/05/2004  J.Tan  CAR 49768
.                 Mods to validate date for inpatient only
.       V9.03.08  17/05/2004  J.Tan  CAR 49824
.                 Mods to open RCPDTEA1 file I*C
.       V9.03.07  14/05/2004  J.Tan  CAR 49827
.                 Recompiled for PRIINVPR - fixed displaying deposits
.       V9.03.06  30.04.2004  SylveK Litewka  CAR 49418
.                 Recompiled for PRIVAFTM changes.
.       V9.03.05  27.04.2004  SylveK Litewka  CAR 49241
.                 Fixed various problems.
.       V9.03.04  22.04.2004  SylveK Litewka  CAR 49164
.                 Fixed various problems and recompiled for PRIHRETM.PBL
.                 changes.
.       V9.03.03  19.04.2004  J.Tan
.                 Fixed setting up redirect
.       V9.03.02  01.04.2004  J.Tan  CAR 44116
.                 Mods for credit note
.       V9.03.01  25.03.2004  J.Tan  CAR 44109
.                 Added compensation claim options
.       V9.03.00  05.01.2004  J.Tan  CAR 44109
.                 Created Program - Input billing details
.-------------------------------------------------------------------------------
          INC       IBAWEBDF
          INC       WEBDATDF
.
          INC       STDHLPDF
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       AUPCDVAR/INC            * Auto postcode variables
          INC       PRIWEBVR/INC                 * for PRIINVPR
          INC       PRIVRDEB/INC                 * for PRIKYDEB
          INC       PRIHRETD/INC
          INC       TFILEVAR/INC
.
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC                 * for PATSRCH
          INC       EMRECTFD/INC
          INC       IBAGSTFD/INC
          INC       IBAGEDFD/INC
.         INC       IBATMHFD/INC
          INC       IBATMDFD/INC
.
          INC       OUTECTFD/INC
          INC       OUTPREFD/INC                 * for PATSRCH
          INC       OUTSITFD/INC
.
          INC       PATCOMM/INC                  * common file
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATHSPFD/INC
          INC       COMDEPFD/INC                 * common deposit file
          INC       RCPBNKFD/INC                 * bank details file
          INC       RCPBDTFD/INC                 * bank details file
          INC       RCPDTEFD/INC                 * receipt details file
          INC       RCPREGFD/INC                 * Register file
          INC       PATALRFD/INC                 * Alerts & Medical Warnings
.         INC       NZHISIFD/INC                 * NZHIS Variables
          INC       NHIMASFD/INC                 * NZHIS Variables
          INC       NHIETHFD/INC
          INC       PATDHEAD/INC                 * PMI Header Details
          INC       PATCALAG/INC                 * PMI Age Calc
          INC       SCRPSTFD/INC                 * PMI Variables
.
          INC       PATCONFD/INC                 * control file
          INC       PMSHCPFD/INC                 * doctor file
          INC       PMSHCLFD/INC
          INC       PMSHCGFD/INC
          INC       PMSCLTFD/INC
          INC       PMSCLTTD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PATWR1FD/INC
          INC       PATDO1FD/INC
          INC       MRTMASFD/INC
          INC       OBSPCOFD/INC
          INC       OBSPCTFD/INC
          INC       PATDRGFD/INC                 * date range period file
          INC       PATDSCFD/INC                 * discharge file
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATGO1FD/INC
          INC       PATGSRFD/INC                 * Surname / Given Name File
          INC       PATIN1FD/INC                 * insurance company file
          INC       PATMA1FD/INC                 * patient master file
          INC       PATMESFD/INC                 * invoice message file
          INC       PATMI1FD/INC                 * admission file
          INC       PATPR1FD/INC                 * pre-admission file
          INC       PATRE1FD/INC                 * inpatient PRA file
          INC       PATPERFD/INC                 * doctor personal file
          INC       PATVISFD/INC                 * visit file
.
          INC       PMSCCDFD/INC                 * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSCEXTD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
.
          INC       PRICMNFD/INC                 * comments
          INC       PRIECTFD/INC
          INC       PRIALSFD/INC                 * Medical Prac.all user access
          INC       PRISECFD/INC                 * Medical Prac.security access
          INC       PRIAUIFD/INC                 * cash deposits invoiced audit
          INC       PRIBULFD/INC                 * bulk billing file
          INC       PRICONFD/INC                 * control file
          INC       PRIDOCFD/INC                 * M.P. doctor file
          INC       PRIDTRFD/INC                 * debtor transaction file
          INC       PRIEXCFD/INC                 * exception charges file
          INC       PRIFIGFD/INC                 * financial summary file
          INC       PRIFINFD/INC                 * financial summary file
          INC       PRIGRPFD/INC                 * item group file
          INC       PRIHDBFD/INC                 * holding header file
          INC       PRIHISFD/INC                 * test history file
          INC       PRIHOLFD/INC                 * account hold file
          INC       PRIHREFD/INC                 * referral details
          INC       PRIHTRFD/INC                 * holding transaction file
          INC       PRITMPFD/INC                 * common item tempfile
          INC       PRIINVFD/INC                 * invoice file
          INC       PRIJRNFD/INC                 * journal file
          INC       PRIAUDJ/INC                  * journals audit file
.
          INC       PRIITMFD/INC                 * item file
          INC       PRIMABFD/INC                 * transport acc. comm. file
          INC       PRIMGPFD/INC                 * medicare gap file
          INC       PRIMULFD/INC                 * multiple services file
          INC       PRIPRAFD/INC                 * medical practice file
          INC       PRISPTFD/INC                 * special pathology test file
          INC       PRISTAFD/INC                 * financial statistics file
          INC       PRITHDFD/INC                 * Common items header file
          INC       PRITDTFD/INC                 * Common items detail file
          INC       PRITESFD/INC                 * pathology test file
          INC       PRIVAFFD/INC                 * veterans affairs files
          INC       PRIWCOFD/INC                 * workers comp. file
          INC       PRICTCFD/INC                 * Civil tort file
          INC       PRICNOFD/INC                 * Credit note header file
          INC       PRIFCIFD/INC                 * Credit note file
          INC       PRICDTFD/INC                 * Referral Comment file
          INC       PRICFXFD/INC                 * Referral Comment text file
          INC       PRIICMFD/INC                 * Invoice Referral Comment file
          INC       PRIIFXFD/INC                 * Invoice Comment text file
          INC       HICITIFD/INC                 * HIC Item invoice file
          INC       VARGBCRN/INC
          INC       WEBBBSFD/INC
          INC       WEBDVWFD/INC
          INC       WEBPCIFD/INC
          INC       WEBIMCFD/INC
          INC       WEBB2BFD/INC
          INC       CHKCLDCD/INC
          INC       RSHWEBDF
.
+
COMFILVF  FILE      ASCII, FIXED=127
COMFILIF  FILE      ASCII, FIXED=127
COUNT     FORM      3
.
ECCLMARR  DIM       54
.
MDATE     DIM       8[100]
MTIME     DIM       8[100]
ITYPE     DIM       1[100]
ITEMN     DIM       9[100]
SUBIT     DIM       3[100]
DESCP     DIM       30[100]
TESTC     FORM      1[100]
S4FLG     FORM      1[100]
GSTAP     FORM      1[100]
GSTCD     DIM       6[100]
QUNTY     FORM      3[100]
CAMNT     FORM      12.2[100]
IAMNT     FORM      12.2[100]
DURAT     DIM       3[100]
ACOVR     DIM       1[100]

MULPR     DIM       1[100]
DUPSR     DIM       1[100]
SRVTX     DIM       100[100]
HOSIN     DIM       1[100]
ALTSP     DIM       1[100]
ALTSC     DIM       10[100]
.IFCCC     DIM       1[100]
IFCCV     DIM       3[100]
NUMPT     DIM       2[100]
SLDMC     DIM       2[100]
LSPNV     DIM       6[100]
ROVRC     DIM       3[100]
ADMNO     DIM       8[100]
DSKMS     DIM       8[100]

CHKMPRAC  FORM      "1"
.
ADDITMSC  FORM      1        * "Add Items Screen" display flag
AMNTKEYI  FORM      1
ACCIDATE  DIM       8
BBDESC    DIM       20
BLNKFLAG  FORM      1
.
COMFILNV  DIM       8
COMFIICM  DIM       8
CONTTYPE  DIM       1
CLFLAG    FORM      1
CODEJ     INIT      "J "
COMPFLAG  FORM      1
CLAIMIND  DIM       1
CATGB     INIT      "GB"
CATIC     INIT      "ic"
CATTC     INIT      "tc"
CURRROW   FORM      3
CLAIMCOD  DIM       3
COUNTITM  FORM      3
CRDNFLAG  FORM      1
CREDTOT   FORM      12.2
CREDNUMB  DIM       8
CALCDATE  DATE      8
CORRESID  FORM      4
CORSP001  DIM       30
CORSP002  DIM       8
CORSP003  DIM       3
CORSP004  DIM       8
CORSFILE  DIM       20
CORSPPRT  INIT      ".pdf"
CMDMOVE   INIT      "mv "
CMDFCHK   INIT      "cliweb08.us1 "
TBSPOOL   INIT      "TBSPOOL"
DASH      INIT      "-"
SAVVISIT  DIM       8
TEMPNAME  DIM       8
.
DIM27     DIM       27
DIM45     DIM       45
DOCTCODE  DIM       6
DOCNAME   DIM       35                           * formatted doctor name
DIM3      DIM       3
DIM5      DIM       5
DIM8      DIM       8
DIM9      DIM       9
DIM10     DIM       10
DIM12     DIM       12
DIM15     DIM       15
DIM25     DIM       25
DIM28     DIM       28                 * for PRIINVPR
DAYFORMT  DIM       4
DOCREFLT  INIT      "Doctor Referral for UR No "
KCOL      FORM      3
KEY9A     DIM       9
KEY27A    DIM       27
KEY45A    DIM       45
KVERT     FORM      2
.
EPRAC     DIM       6
FBOKDATE  DIM       12                      * Display Date
FORM7P2   FORM      7.2
F12P2     FORM      12.2
FORM12P2  FORM      12.2
FOR12P2B  FORM      12.2
FLAGMESS  FORM      1
FOLDERTY  DIM       1          * Flag to update PMI folder details
F3A       FORM      3
FORM3     FORM      3
FORM5     FORM      5
FORM8     FORM      8
FORM82    FORM      8.2
FORM122   FORM      12.2
FSTDATE   DIM       8
FSTAMNT   FORM      12.2
FSTWORK   FORM      12.2
FGSTFLAG  FORM      1
FNAMEJ    DIM       8
.
GSTCODES  DIM       6
HIGCODE   DIM       6
HIGDESC   DIM       30
HEADSEC   FORM      5
HEADFLAG  FORM      1
HEALTHFD  DIM       6
OLDHTHFD  DIM       6
OPTNFLAG  FORM      1
NEWHTHFD  DIM       6
.
INVFLAG   FORM      1
INVIACTV  DIM       1
ITEMNUMB  DIM       8
IFLAG     FORM      2
INVOICEN  FORM      8
INDIC     FORM      1                  * TCINDC1 form parameter
DINVNUMB  DIM       8
.                                          0 = non-compensable
.                                          1 = Workers Compensation
.                                          2 = M.A.B.
JNLAMNT   FORM      12.2                * journal amount
JTYPE     DIM       1
JOURDATE  DIM       8
JOURITEM  DIM       3
JOURDESC  DIM       30
JOURAMTT  FORM      12.2
JOURPATT  FORM      10.2
.                                          3 = V.A.
LNVISFLG  FORM      1                  * Linked visit record flag
LASTITEM  FORM      3
LOADFLG   FORM      1
LNK2PRT   FORM      1                  * Table type :Update parent
.
MPGEFLAG  FORM      1
MESSCODE  DIM       3                  * invoice message code
.
NOTENUMB  DIM       6                       * note number
NOTETYPE  DIM       3                       * note type
NETTOT    FORM      12.2
NBNKAMNT  FORM      12.2
NEWCLAIM  DIM       3
NXTRAN    FORM      6                            * next transaction number
NINE8     INIT      "99999999"
NEWCLM    FORM      1
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
OLDCLAIM  DIM       3
PATNAME   DIM       25
PATADD3   DIM       21
PRANAME   DIM       45                 * name of P.R.A.
PRAADD1   DIM       35                 * address of P.R.A. - line 1
PRAADD2   DIM       35                 *                     line 2
PRAADD3   DIM       35                 *                     line 3
PRAADD4   DIM       35                 *                     line 4
PRAPOST   DIM       8                  * postcode of P.R.A.
PRAPPHON  DIM       20                 * home phone of P.R.A.
PRABPHON  DIM       20                 * business phone of P.R.A.
PRAMPHON  DIM       20                 * mobile phone of P.R.A.
PRARREL   DIM       10                 * relationship of P.R.A.
PRINTPDF  DIM       1
PRNTSTRT  FORM      3
PROGFLAG  FORM      1
PUBCLAIM  FORM      1
FRMPPLST  DIM       1                  * from private practive pending list  
.
PRFAC001  FORM      1
PRFAC002  FORM      1
PRFAC003  DIM       8
PRFAC004  DIM       8
.
PRTHD001  DIM       4
PRTHD002  DIM       8
PRTHD003  DIM       8
PRHOL001  FORM      1                  * Account on hold
PRITM001  DIM       8
PRITM002  DIM       8
PRITM003  DIM       1
PRITM004  DIM       9
PRITM005  DIM       3
PRITM006  DIM       30
PRITM007  FORM      3
PRITM008  FORM     12.2
PRITM009  FORM      1
PRITM010  DIM       6
PRITM011  FORM      12.2
PRITM012  FORM      1
PRITM013  FORM      1
.
PRHTR001  DIM       8      * Unique Identifier
PRHTR002  DIM       6      * Medical Practice code
PRHTR003  DIM      10      * Service Doctor
PRHTR004  DIM       3      * Patient Indicator
PRHTR005  DIM      10      * Referring doctor code
PRHTR006  DIM       8      * Referring date
PRHTR007  DIM       2      * Item flag
PRHTR008  DIM       9      * Item number
PRHTR009  DIM       3      * Sub item number
PRHTR010  DIM       3      * Transaction number
PRHTR011  DIM       50     * Referring details
PRHTR012  DIM       12     * Service Date
PRHTR013  DIM       5      * Service Time
PRHTR014  DIM       3      * Item Flag Value
PRHTR015  DIM       30     * Item Description
PRHTR016  DIM       3      * Number of Services
PRHTR017  DIM       15     * Item Amount
PRHTR018  DIM       1      * A/C Override Indicator
PRHTR019  DIM       3      * Duration
PRHTR020  DIM       1      * Multi Procedure Override
PRHTR021  DIM       1      * Duplicate Service Override
PRHTR022  DIM       100    * Service Text
PRHTR023  DIM       1      * Alternate Service Provider Flag
PRHTR024  DIM       10     * Alternate Service Provider HCP Code
.PRHTR025  DIM       1      * Alternate IFC Issue Code Flag
PRHTR026  DIM       3      * Alternate IFC Issue Code Value
PRHTR027  DIM       2      * Number of Patients
PRHTR028  DIM       6      * Location Specific Practice No. Value
PRHTR029  DIM       2      * Self Deem Code (Cat Sd)
PRHTR030  DIM       8      * Linked Visit Number
PRHTR031  DIM       3      * Referral Override (Cat ro) 
PRHTR032  DIM       1      * Hospital Indicator
PRHTR033  DIM       3      * Restrictive Override code (Cat Ro)
PRHTR034  DIM       8      * Distance Kms
.
PRDTR030  DIM       8      * Linked Visit Number
PRDTR031  DIM       3      * Referral Override (Cat ro)
.
SAVREPTN  FORM      2
SAVPRGID  DIM       8
ROWCOUNT  FORM      5
RETURNDT  DIM       8
RETURNTM  DIM       8
PERNUM    FORM      2                  * date range period
.
RACLINDC  DIM       1
RACLUESF  DIM       1
RACLUEBB  DIM       1
RACLUDVA  DIM       1
.
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SKEY27    DIM       27
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
SPRAC     DIM       6
SEC1      FORM      "00001"
SAVKEY12  DIM       12
SAVMESS   DIM       3
SAVREFER  DIM       14
SP45      INIT      "                                             "
STATNCOD  DIM       6
TIMEFLAG  FORM      1
TRANSNO   FORM      3                  * transaction number
TFLAG     FORM      1
TEMPUNQ   FORM      8
TOTINV    FORM      12.2
TINVOICE  FORM      8
.
UNIQNUMB  DIM       8
UCLAIM    FORM      8
VARIABLE  DIM       127
VALDCODE  DIM       70                      * Validation Code
VALDTYPE  DIM       3
VALDSUBN  DIM       3
VALINTXT  DIM       62                      * Cal Cl Indicator 15 check
WEBFLAG   FORM      1
.
XUNIQUE   FORM      8
X5        INIT      "XXXXX"
X10       INIT      "XXXXXXXXXX"
.
ZERO4     INIT      "0000"
.
.---------------------------------------------------------------------------
.  CGI Variables
.
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
REDIREC2  DIM       227     * Redirect URL (Part 2)
UPDTTYPE  DIM       1       * Update Type
.
.     Workers compensation variables
.
PRCOM001  DIM       30      * Employer Name
PRCOM002  DIM       25      * Employer Address Line 1
PRCOM003  DIM       25      * Employer Address Line 2
PRCOM004  DIM       25      * Employer Address Line 3
PRCOM005  DIM       4       * Employer Postcode
PRCOM006  DIM       12      * Employer Telephone
PRCOM007  FORM      1       * Accepted By Insurance Company
.                                             1 = No 0 = Yes
PRCOM008  DIM       6       * Insurance Company Code
PRCOM009  DIM       20      * Insurance Claim Number
PRCOM010  DIM       5       * Accident time
PRCOM011  DIM       40      * Comments Line 1
PRCOM012  DIM       40      * Comments Line 2
.
.      TAC variables
.
PRMAB001  DIM       20      * M.A.B. Reference Number
PRMAB002  DIM       20      * Police Station Accident Reported To
PRMAB003  DIM       30      * Solictor Name
PRMAB004  DIM       25      * Solicitor address line 1
PRMAB005  DIM       25      * Solicitor address line 2
PRMAB006  DIM       25      * Solicitor address line 3
PRMAB007  DIM       4       * Solicitor postcode
PRMAB008  DIM       12      * Solicitor Telephone
PRMAB009  DIM       36      * Car Registration Numbers Involved
PRMAB010  DIM       40      * Accident Location
PRMAB011  DIM       5       * Accident Time
PRMAB012  DIM       20      * While Engaged In
PRMAB013  DIM       30      * Patient Injured When
PRMAB014  DIM       3       * User Defined Field 1 (Category MO)
PRMAB015  DIM       3       * User Defined Field 2 (Category MP)
PRMAB016  DIM       30      * Mechanism of Severist Injury
PRMAB017  DIM       20      * Region of Severist Injury
PRMAB018  DIM       30      * Other Driver Details Line 1
PRMAB019  DIM       30      * Other Driver Details Line 2
PRMAB020  DIM       30      * Other Driver Details Line 3
.
.      Veteran affairs
.
PRVAF001  DIM       20      * Claim Number
.
.      Civil Tort
.
PRCTC001  DIM       30      * Solicitor name
PRCTC002  DIM       35      * Solicitor address line 1
PRCTC003  DIM       35      * Solicitor address line 2
PRCTC004  DIM       35      * Solicitor address line 3
PRCTC005  DIM       35      * Solicitor address line 4
PRCTC006  DIM       8       * Solicitor postcode
PRCTC007  DIM       12      * Solicitor Phone number
PRCTC008  DIM       30      * Contact Name
PRCTC009  DIM       20      * Reference number
.
.---------------------------------------------------------------------------
PRGID     INIT      "PRIWEB02"
VERSION   INIT      "V12.01.02"
PRGNAM    INIT      "Private Practice Billing Maintenance"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      PRBILL00        * Billing Maintenance
          CALL      RMTMP000        * kill existing temp file
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      VALBUL00        * Validate bulk bill code
          GOTO      MAIN1000
.
MAIN1300  CALL      GNPRFA00        * Get PRFA
          GOTO      MAIN1000
.
MAIN1400  CALL      PRPINV00        * Print private practice invoice
          CALL      RMTMP000        * kill existing temp file
          BRANCH    EXIT,MAIN1000
.
          IF        EXIT=0
            IF        FLAGBULK=1
              MOVE      "Bulk Billing Invoice Generated.",WEBTITLE
            ELSE
              MOVE      SP70,WEBTITLE
              RESET     WEBTITLE
              APPEND    "Printing Complete. Invoice Number:",WEBTITLE
              APPEND    PRCNINVN,WEBTITLE
              APPEND    SP70,WEBTITLE
              RESET     WEBTITLE
            ENDIF
          ENDIF
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      REPRNT00        * Re-print private practice invoice
          BRANCH    EXIT,MAIN1000
          MOVE      "Re-Print Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      ADDMBS00        * Add MBS items
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      VALITM00        * Validate item
          GOTO      MAIN1000
.
MAIN1800  CALL      ACCSTA00        * Account status
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      PRCRD000        * print Credit note
          BRANCH    EXIT,MAIN1000
          MOVE      "Re-Print Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      VALRDC00        * Validate referring doctor (prcnrdoc=1)
          GOTO      MAIN1000
.
MAIN2100  CALL      PRPSTT00        * Private Practice Stationery Template Vars
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      JCAL0000        * Current balance invoice amt after Jrnl
          GOTO      MAIN1000
.
MAIN2300  CALL      RFCM0000        * PP Referral Comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      IVCM0000        * PP Invoice Comments
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      IMCROV00        * IMC Referral Override
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70,NXTPAG80
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINCAL00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREALT00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      REDALT00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL (with alert)
.------------------------------------------------------------------------------
PREALT00  CALL      OPENHTML
          BRANCH    EXIT,PREALT90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREALT99
.
PREALT90  DISPLAY   "*** Fifo Not Found ***"
.
PREALT99  RETURN
.------------------------------------------------------------------------------
.  Redirect URL (with alert)
.------------------------------------------------------------------------------
REDALT00  CALL      OPENHTML
          BRANCH    EXIT,REDALT90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      REDALT99
.
REDALT90  DISPLAY   "*** Fifo Not Found ***"
.
REDALT99  RETURN
.------------------------------------------------------------
. Refresh Parent and Close Window (with alert)
.------------------------------------------------------------
WINCAL00  CALL      OPENHTML
          BRANCH    EXIT,WINCAL99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             "  reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCAL99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script language=#"JavaScript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00
.
          DISPLAY   *P56:24,"Opening : ":
                    *P64:24,"pridoctf";
          OPEN      PRIDOCT1,"pridoctf"          * M.P. Doctor file
          OPEN      PRICNOA1,"pricnoaf"
.
          DISPLAY   *P64:24,"ibagstaf";
          OPEN      IBAGSTA1,"ibagstaf"
          OPEN      IBAGSTA2,"ibagstaf"
.
          DISPLAY   *P64:24,"pridtraf";
          OPEN      PRIDTRA1,"pridtraf"          * Debtor Transaction file
          OPEN      PRIDTRA3,"pridtraf"          * Debtor Transaction file
          OPEN      PRIDTRA4,"pridtraf"
.
          DISPLAY   *P64:24,"prihdbtf";
          OPEN      PRIHDBT1,"prihdbtf"          * Holding Header file
          OPEN      PRIHDBT2,"prihdbtf"
.
          DISPLAY   *P64:24,"prihreff";
          OPEN      PRIHREF1,"prihreff"
          OPEN      PRIHREF2,"prihreff"          * Holding Referral file
.
          DISPLAY   *P64:24,"priholaf";
          OPEN      PRIHOLA1,"priholdf"          * Holding file
.
          DISPLAY   *P64:24,"prihtraf";
          OPEN      PRIHTRA1,"prihtraf"          * Holding Transaction file
          OPEN      PRIHTRA4,"prihtraf"          *                    *I-123419
.
          OPEN      PRITMPA1,"pritmpaf"          * Common item tempfile
.
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCTA1,"obspctaf"
.
          DISPLAY   *P64:24,"priinvof";
          OPEN      PRIINVO1,"priinvof"          * Invoice file
          OPEN      PRIINVO3,"priinvof"          * Invoice file
.
          DISPLAY   *P64:24,"prijrnlf";
          OPEN      PRIJRNL1,"prijrnlf"          * journal file
.
          DISPLAY   *P64:24,"prifinsf";
          OPEN      PRIFINS1,"prifinsf"          * financial summary file
.
          DISPLAY   *P64:24,"prifigaf";
          OPEN      PRIFIGA1,"prifigaf"          * financial summary file
.
          DISPLAY   *P64:24,"pristatf";
          OPEN      PRISTAT1,"pristatf"          * statistics file
.
          DISPLAY   *P64:24,"patdrgaf";
          OPEN      PATDRGA1,"patdrgaf"          * date range period file
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"          * date range period file

          DISPLAY   *P64:24,"priitemf";
          OPEN      PRIITEM1,"priitemf"          * Item file
          OPEN      PRIITEM2,"priitemf"
.
          DISPLAY   *P64:24,"prithdaf";
          OPEN      PRITHDA1,"prithdaf"          * Holding Transaction file
.
          DISPLAY   *P64:24,"pritdtaf";
          OPEN      PRITDTA1,"pritdtaf"          * Holding Transaction file
.
          DISPLAY   *P64:24,"primgpaf";
          OPEN      PRIMGPA1,"primgpaf"          * Medicare Gap file
.
          DISPLAY   *P64:24,"pripracf";
          OPEN      PRIPRAC1,"pripracf"          * Medical Practice file
.
          DISPLAY   *P64:24,"pritestf";
          OPEN      PRITEST1,"pritestf"
          OPEN      PRITEST3,"pritestf"          * Pathology Test file
.
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRISECA1,"prisecaf"
.
          DISPLAY   *P64:24,"privafdf";
          OPEN      PRIVAFD1,"privafdf"
          OPEN      PRIVAFD2,"privafdf"          * Veterans Affairs file
.
          DISPLAY   *P64:24,"priwcomf";
          OPEN      PRIWCOM1,"priwcomf"
          OPEN      PRIWCOM2,"priwcomf"          * Workers Compensation file
          OPEN      PRIMABD1,"primabdf"
          OPEN      PRIVAFD1,"privafdf"
          OPEN      PRICTCA1,"prictcaf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"          * Patient Codes file
          OPEN      PATCODE2,"patcodes"          * Patient Codes file
.
          DISPLAY   *P64:24,"pmscexaf";
          OPEN      PMSCEXA1,"pmscexaf"
.
          DISPLAY   *P64:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA2,"pmshcpaf"
.
          DISPLAY   *P64:24,"pmshclaf";
          OPEN      PMSHCLA1,"pmshclaf"
.
          DISPLAY   *P64:24,"pmsrelaf";
          OPEN      PMSRELA1,"pmsrelaf"
.
          DISPLAY   *P64:24,"pmstleaf";
          OPEN      PMSTLEA1,"pmstleaf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"pmscltaf";
          OPEN      PMSCLTA1,"pmscltaf"
.
          DISPLAY   *P64:24,"pmshcgaf";                    *T0872823
          OPEN      PMSHCGA1,"pmshcgaf"

          DISPLAY   *P64:24,"patin1af";
          OPEN      PATIN1A1,"patin1af"
.
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPDTEA5,"rcpdteaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATMESG1,"patmesgf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATGSRN1,"patgsrnf"          * open Patient Surname file
          OPEN      PATGSRN2,"patgsrnf"          * open Patient Surname file
.
          OPEN      PRIMULT1,"primultf"          * multiple services file
          OPEN      PRITHIS1,"prithisf"          * test history file
          OPEN      PRICDTA1,"pricdtaf"          * referral comment file
          OPEN      PRICFXA1,"pricfxaf"          * referral comment text file
          OPEN      PRIICMA1,"priicmaf"          * invoice comment file
          OPEN      PRIIFXA1,"priifxaf"          * invoice comment text file
.
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      EMRECTA1,"emrectaf"
          OPEN      OUTECTA1,"outectaf"
.
          OPEN      CONTROLF,"controlf"
.         READ      CONTROLF,ZERO;*85,IBCNUGST
          MOVE      TWO,IBCNUGST
          READ      CONTROLF,THIRTY3;*71,PRCNNAME,PRCNTELE,PRCNADDR,PRCNJOUR:
                                     *124,PRCNUDF1,PRCNMAN1,PRCNUDF2,PRCNMAN2:
                                          PRCNUDF3,PRCNMAN3,PRCNUDF4,PRCNMAN4:
                                     *140,PRCNUDFA,PRCNMANA,PRCNUDFB,PRCNMANB:
                                          PRCNWCOM,PRCNMABI,PRCNVAIN:
                                     *163,PRCNDOCM,*164,PRCNSDAT,PRCNLAYT:
                                     *198,PRCNJDAT:
                                     *200,PRCNRDOC,*212,PRCNUPRA,*213,PRCNDAPS
          READ      CONTROLF,THIRTY4;*187,PRCNGENB:
                                     *196,PRCNTCOD,*199,PRCNAFEE,*206,PRCNPRIH:
                                     *212,PRCNPRIT,*226,PRCNNRND,*228,PRCNCJRN:
                                     *231,PRCNPJCI
          READ      CONTROLF,NINTY8;*148,PTCNINVB
          READ      CONTROLF,HUND10;*243,PTCNCOMF
          READ      CONTROLF,HUND19;*1,PTCNIMCO
          READ      CONTROLF,HUND24;*111,PTCNUIMC,*216,PTCNRJNL,*222,PTCNUESF
          READ      CONTROLF,HUND27;*1,PTCNESFO,*122,PTCNUEBB,*123,PTCNEDBO
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*73,PTCNIMCW,*91,PTCNPCIW:
                                    *193,PTCNBBSW,*249,PTCNDVAW
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*54,CFILENO,*79,CAPPRVNO,*94,CAGECOFF
          READ      CONTROLF,TEN3;*1,CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2:
                    CHPPOST
          READ      CONTROLF,HUND03;*212,PTCNPFSN,PTCNPFGN
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAME2
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAME3
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMPOST
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNV
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFIICM
.
INIT9999  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      SP70,VALDTYPE
          MOVE      SP70,VALDCODE
          MOVE      SP70,VALDSUBN
          MOVE      SP70,RETURNDT
          MOVE      SP70,RETURNTM
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,ACCIDATE
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,HEALTHFD
          MOVE      SP70,NEWHTHFD
          MOVE      SP70,OLDHTHFD
          MOVE      SP70,NEWCLAIM
          MOVE      SP70,OLDCLAIM
          MOVE      ZERO,COUNTITM
          MOVE      SP70,UNIQNUMB
          MOVE      ZERO,INVOICEN
          MOVE      ZERO,TINVOICE
          MOVE      SP70,CREDNUMB
          MOVE      SP70,SELPRINT
          MOVE      SP70,STATNCOD
          MOVE      ZERO,NOCOPIES
          MOVE      ZERO,LASTITEM
          MOVE      SP10,PRTHD001
          MOVE      SP10,PRTHD002
          MOVE      SP10,PRTHD003
          MOVE      SP10,ITEMNUMB
          MOVE      ZERO,PRHOL001
          MOVE      ZERO,PROGFLAG
          MOVE      ZERO,ADDITMSC
.
          MOVE      ZERO,PRFAC001
          MOVE      ZERO,PRFAC002
          MOVE      SP70,PRFAC003
          MOVE      SP70,PRFAC004
.
          MOVE      SP70,GSTCODES
          MOVE      SP70,JOURDATE
          MOVE      SP70,JOURDESC
          MOVE      SP70,JOURITEM
          MOVE      ZERO,JOURPATT
          MOVE      ZERO,JOURAMTT
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,NOTETYPE
          MOVE      SP70,NOTENUMB
          MOVE      SP70,PRINTPDF
          MOVE      SP70,FRMPPLST
.
          MOVE      SP70,VALINTXT
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,MDATE[F3]
            MOVE      SP70,MTIME[F3]
            MOVE      SP70,ITYPE[F3]
            MOVE      SP70,ITEMN[F3]
            MOVE      SP70,SUBIT[F3]
            MOVE      SP70,DESCP[F3]
            MOVE      SP70,GSTCD[F3]
            MOVE      ZERO,TESTC[F3]
            MOVE      ZERO,S4FLG[F3]
            MOVE      ZERO,GSTAP[F3]
            MOVE      ZERO,QUNTY[F3]
            MOVE      ZERO,CAMNT[F3]
            MOVE      ZERO,IAMNT[F3]
            MOVE      SP70,DURAT[F3]
            MOVE      SP70,ACOVR[F3]
            MOVE      SP70,MULPR[F3]  
            MOVE      SP70,DUPSR[F3]  
            PACK      SRVTX[F3],SP70,SP70  
            MOVE      SP70,HOSIN[F3]  
            MOVE      SP70,ALTSP[F3]  
            MOVE      SP70,ALTSC[F3]  
.            MOVE      SP70,IFCCC[F3]  
            MOVE      SP70,IFCCV[F3]  
            MOVE      SP70,NUMPT[F3]  
            MOVE      SP70,SLDMC[F3]  
            MOVE      SP70,LSPNV[F3]  
            MOVE      SP70,ROVRC[F3]
            MOVE      SP70,ADMNO[F3]
            MOVE      SP70,DSKMS[F3]
            ADD       ONE,F3
          DO
          CALL      CPPRHR00
          CALL      CPPRWC00
          CALL      CPPRMB00
          CALL      CPPRVA00
          CALL      CPPRCT00
          CALL      CPPRHT00
          CALL      CLPMCL00
.
          PACK      REDIREC2,SP70,SP70,SP70,SP70
.
          MOVE      SP70,RACLINDC
          MOVE      SP70,PRDTR030
          MOVE      SP70,PRDTR031
          MOVE      SP70,RACLUESF
          MOVE      SP70,RACLUEBB
          MOVE      SP70,RACLUDVA
.
CLRPAR99  RETURN
+
.------------------------------------------------------------------------
.   Clear Parameters for transaction holding record
.------------------------------------------------------------------------
CPPRHT00  MOVE      Z70,PRHTR001
          MOVE      Z70,PRHTR002
          MOVE      Z70,PRHTR003
          MOVE      Z70,PRHTR004
          MOVE      Z70,PRHTR005
          MOVE      Z70,PRHTR006
          MOVE      Z70,PRHTR008
          MOVE      Z70,PRHTR009
          MOVE      Z70,PRHTR010
          MOVE      Z70,PRHTR011
          MOVE      Z70,PRHTR012
          MOVE      Z70,PRHTR013
          MOVE      Z70,PRHTR014
          MOVE      Z70,PRHTR015
          MOVE      Z70,PRHTR016
          MOVE      Z70,PRHTR017
          MOVE      Z70,PRHTR018
          MOVE      Z70,PRHTR019
          MOVE      Z70,PRHTR020
          MOVE      Z70,PRHTR021
          MOVE      Z70,PRHTR022
          MOVE      Z70,PRHTR023
          MOVE      Z70,PRHTR024
.          MOVE      Z70,PRHTR025
          MOVE      Z70,PRHTR026
          MOVE      Z70,PRHTR027
          MOVE      Z70,PRHTR028
          MOVE      Z70,PRHTR029
          MOVE      Z70,PRHTR030
          MOVE      Z70,PRHTR031
          MOVE      Z70,PRHTR032
          MOVE      Z70,PRHTR033
          MOVE      Z70,PRHTR034
.
CPPRHT99  RETURN
+
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tinvoice=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TINVOICE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crednumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREDNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printpdf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTPDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frmpplst=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRMPPLST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocopies=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOCOPIES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ITEMNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcodes=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,GSTCODES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourpatt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,JOURPATT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jouramtt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,JOURAMTT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jouritem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURITEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourdesc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURDESC
            PACK      JOURDESC,JOURDESC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "progflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROGFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdsubn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDSUBN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returndt=",QRYNAME
          IF        @EQUAL
.           MOVE      QRYDATA,RETURNDT
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      RETURNDT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returntm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNTM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "healthfd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HEALTHFD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newhthfd=",QRYNAME
          IF        @EQUAL
            PACK      NEWHTHFD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldhthfd=",QRYNAME
          IF        @EQUAL
            PACK      OLDHTHFD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldclaim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OLDCLAIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newclaim=",QRYNAME
          IF        @EQUAL
            PACK      NEWCLAIM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accidate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      ACCIDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prhre",QRYNAME
          IF        @EQUAL
            CALL      SPPRHR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prhtr",QRYNAME
          IF        @EQUAL
            CALL      SPPRHT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prcom",QRYNAME
          IF        @EQUAL
            CALL      SPPRWC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prmab",QRYNAME
          IF        @EQUAL
            CALL      SPPRMB00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prvaf",QRYNAME
          IF        @EQUAL
            CALL      SPPRVA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prctc",QRYNAME
          IF        @EQUAL
            CALL      SPPRCT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mdate",QRYNAME
          IF        @EQUAL
            CALL      STMDAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mtime",QRYNAME
          IF        @EQUAL
            CALL      STMTIM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itype",QRYNAME
          IF        @EQUAL
            CALL      STITYP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "itemn",QRYNAME
          IF        @EQUAL
            CALL      STITMN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "subit",QRYNAME
          IF        @EQUAL
            CALL      STSITM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "descp",QRYNAME
          IF        @EQUAL
            CALL      STITDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "qunty",QRYNAME
          IF        @EQUAL
            CALL      STQUNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "camnt",QRYNAME
          IF        @EQUAL
            CALL      STAMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "iamnt",QRYNAME
          IF        @EQUAL
            CALL      STIMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "testc",QRYNAME
          IF        @EQUAL
            CALL      STTSTC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "s4flg",QRYNAME
          IF        @EQUAL
            CALL      STS4FL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstap",QRYNAME
          IF        @EQUAL
            CALL      STGSTA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstcd",QRYNAME
          IF        @EQUAL
            CALL      STGSTC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "durat",QRYNAME
          IF        @EQUAL
            CALL      STDRAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acovr",QRYNAME
          IF        @EQUAL
            CALL      STACOV00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mulpr",QRYNAME
          IF        @EQUAL
            CALL      STMULP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dupsr",QRYNAME
          IF        @EQUAL
            CALL      STDUPS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srvtx",QRYNAME
          IF        @EQUAL
            CALL      STSRVT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hosin",QRYNAME
          IF        @EQUAL
            CALL      STHOSI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "altsp",QRYNAME
          IF        @EQUAL
            CALL      STALTP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "altsc",QRYNAME
          IF        @EQUAL
            CALL      STALTC00
            GOTO      SETPAR99
          ENDIF
.
.          MATCH     "ifccc",QRYNAME
.          IF        @EQUAL
.            CALL      STIFCC00
.            GOTO      SETPAR99
.          ENDIF
.
          MATCH     "ifccv",QRYNAME
          IF        @EQUAL
            CALL      STIFCV00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "numpt",QRYNAME
          IF        @EQUAL
            CALL      STNUMP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sldmc",QRYNAME
          IF        @EQUAL
            CALL      STSLDM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lspnv",QRYNAME
          IF        @EQUAL
            CALL      STLSPN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rovrc",QRYNAME
          IF        @EQUAL
            CALL      STROVC00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admno",QRYNAME
          IF        @EQUAL
            CALL      STADNO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dskms",QRYNAME
          IF        @EQUAL
            CALL      STDSKM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prfac001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRFAC001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prfac002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRFAC002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prfac003=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PRFAC003
            MOVE      PRFAC003,FORM8
            MOVE      FORM8,PRFAC003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prfac004=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PRFAC004
            MOVE      PRFAC004,FORM8
            MOVE      FORM8,PRFAC004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prthd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRTHD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prthd002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PRTHD002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prthd003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRTHD003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prhol001=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PRHOL001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pritm",QRYNAME
          IF        @EQUAL
            CALL      STPIT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "countitm=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,COUNTITM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "additmsc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDITMSC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "raclindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "racluesf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLUESF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "racluebb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLUEBB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "racludva=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RACLUDVA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIREC2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notetype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTETYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notenumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTENUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refcomnt=",QRYNAME
          IF        @EQUAL
            CALL      GRCMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invcomnt=",QRYNAME
          IF        @EQUAL
            CALL      GICMNT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdtr030=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDTR030
            GOTO      SETPAR99
          ENDIF
.

          MATCH     "prdtr031=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDTR031
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmclt",QRYNAME
          IF        @EQUAL
            CALL      SPMCL000
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for transaction holding file
.------------------------------------------------------------
SPPRHT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPPRHT01,SPPRHT02,SPPRHT03,SPPRHT04,SPPRHT05:
                       SPPRHT06,SPPRHT07,SPPRHT08,SPPRHT09,SPPRHT10:
                       SPPRHT11,SPPRHT12,SPPRHT13,SPPRHT14,SPPRHT15:
                       SPPRHT16,SPPRHT17,SPPRHT18,SPPRHT19,SPPRHT20:
                       SPPRHT21,SPPRHT22,SPPRHT23,SPPRHT24,SPPRHT25:
                       SPPRHT26,SPPRHT27,SPPRHT28,SPPRHT29,SPPRHT30:
                       SPPRHT31,SPPRHT32,SPPRHT33,SPPRHT34
.
          MOVE      ONE,EXIT
          GOTO      SPPRHT99
.
SPPRHT01  PACK      PRHTR001,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT02  PACK      PRHTR002,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT03  PACK      PRHTR003,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT04  PACK      PRHTR004,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT05  PACK      PRHTR005,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT06  PACK      PRHTR006,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT07  PACK      PRHTR007,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT08  PACK      PRHTR008,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT09  PACK      PRHTR009,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT10  PACK      PRHTR010,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT11  PACK      PRHTR011,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT12  PACK      QRYDATA,QRYDATA,SP70
          MATCH     SP70,QRYDATA
          GOTO      SPPRHT99 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PRHTR012,CCENT,CYEAR,CMON,CDAY
          GOTO      SPPRHT99
.
SPPRHT13  PACK      PRHTR013,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT14  PACK      PRHTR014,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT15  PACK      PRHTR015,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT16  PACK      PRHTR016,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT17  PACK      PRHTR017,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT18  PACK      PRHTR018,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT19  PACK      PRHTR019,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT20  PACK      PRHTR020,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT21  PACK      PRHTR021,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT22  PACK      PRHTR022,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT23  PACK      PRHTR023,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT24  PACK      PRHTR024,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT25  
.         PACK      PRHTR025,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT26  PACK      PRHTR026,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT27  PACK      PRHTR027,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT28  PACK      PRHTR028,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT29  PACK      PRHTR029,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT30  PACK      PRHTR030,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT31  PACK      PRHTR031,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT32  PACK      PRHTR032,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT33  PACK      PRHTR033,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT34  PACK      PRHTR034,QRYDATA,SP70
          GOTO      SPPRHT99
.
SPPRHT99  RETURN
.
.------------------------------------------------------------
. Set parameters for item date
.------------------------------------------------------------
STMDAT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
.
          IF        F3>0 & F3<100
            MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
            PACK      KEY11,KEY11,SP70
            UNPACK    KEY11,KEY8,KEY3
            MATCH     SP70,KEY3
            IF        !@EQUAL
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      KEY8,CCENT,CYEAR,CMON,CDAY
              REP       " 0",KEY8
              PACK      MDATE[F3],KEY8,SP70
            ELSE
              MOVE      QRYDATA,MDATE[F3]
            ENDIF
            MOVE      F3,LASTITEM
          ENDIF
STMDAT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item time
.------------------------------------------------------------
STMTIM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STMTIM99 IF EQUAL
            PACK      MTIME[F3],QRYDATA,SP70
          ENDIF
STMTIM99  RETURN
+
.------------------------------------------------------------
. Set parameters for item type
.------------------------------------------------------------
STITYP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STITYP99 IF EQUAL
            SQUEEZE   QRYDATA
            PACK      ITYPE[F3],QRYDATA,SP70
          ENDIF
STITYP99  RETURN
+
.------------------------------------------------------------
. Set parameters for item code
.------------------------------------------------------------
STITMN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STITMN99 IF EQUAL
            PACK      ITEMN[F3],QRYDATA,SP70
          ENDIF
STITMN99  RETURN
+
.------------------------------------------------------------
. Set parameters for sub item code
.------------------------------------------------------------
STSITM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STSITM99 IF EQUAL
            PACK      SUBIT[F3],QRYDATA,SP70
          ENDIF
STSITM99  RETURN
+
.------------------------------------------------------------
. Set parameters for item description
.------------------------------------------------------------
STITDS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STITDS99 IF EQUAL
            PACK      DESCP[F3],QRYDATA,SP70
          ENDIF
STITDS99  RETURN
+
.------------------------------------------------------------
. Set parameters for item quantity
.------------------------------------------------------------
STQUNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STQUNT99 IF EQUAL
            MOVE      QRYDATA,QUNTY[F3]
          ENDIF
STQUNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item amount
.------------------------------------------------------------
STAMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STAMNT99 IF EQUAL
            MOVE      QRYDATA,CAMNT[F3]
          ENDIF
STAMNT99  RETURN
+
.------------------------------------------------------------
. Set parameters for a single item amount
.------------------------------------------------------------
STIMNT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STIMNT99 IF EQUAL
            MOVE      QRYDATA,IAMNT[F3]
          ENDIF
STIMNT99  RETURN
+
.------------------------------------------------------------
.------------------------------------------------------------
. Set parameters for Test code
.------------------------------------------------------------
STTSTC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STTSTC99 IF EQUAL
            MOVE      QRYDATA,TESTC[F3]
          ENDIF
STTSTC99  RETURN
+
.------------------------------------------------------------
. Set parameters for S4B3 Exemption
.------------------------------------------------------------
STS4FL00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STS4FL99 IF EQUAL
            MOVE      QRYDATA,S4FLG[F3]
          ENDIF
STS4FL99  RETURN
+
.------------------------------------------------------------
. Set parameters for GST Applicable
.------------------------------------------------------------
STGSTA00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STGSTA99 IF EQUAL
            MOVE      QRYDATA,GSTAP[F3]
          ENDIF
STGSTA99  RETURN
+
.------------------------------------------------------------
. Set parameters for GST Code
.------------------------------------------------------------
STGSTC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STGSTC99 IF EQUAL
            PACK      GSTCD[F3],QRYDATA,SP70
          ENDIF
STGSTC99  RETURN
+
.------------------------------------------------------------
. Set parameters for item duration
.------------------------------------------------------------
STDRAT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDRAT99 IF EQUAL
            PACK      DURAT[F3],QRYDATA,SP70
          ENDIF
STDRAT99  RETURN
+
.------------------------------------------------------------
. Set parameters for item a/c override indicator
.------------------------------------------------------------
STACOV00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STACOV99 IF EQUAL
            PACK      ACOVR[F3],QRYDATA,SP70
          ENDIF
STACOV99  RETURN
+
.------------------------------------------------------------
. Set parameters for multiple procedure override
.------------------------------------------------------------
STMULP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STMULP99 IF EQUAL
            PACK      MULPR[F3],QRYDATA,SP70
          ENDIF
STMULP99  RETURN
+
.------------------------------------------------------------
. Set parameters for duplicate service override
.------------------------------------------------------------
STDUPS00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDUPS99 IF EQUAL
            PACK      DUPSR[F3],QRYDATA,SP70
          ENDIF
STDUPS99  RETURN
+
.------------------------------------------------------------
. Set parameters for service text
.------------------------------------------------------------
STSRVT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STSRVT99 IF EQUAL
            PACK      SRVTX[F3],QRYDATA,SP70
          ENDIF
STSRVT99  RETURN
+
.------------------------------------------------------------
. Set parameters for Hospital indicator
.------------------------------------------------------------
STHOSI00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STHOSI99 IF EQUAL
            PACK      HOSIN[F3],QRYDATA,SP70
          ENDIF
STHOSI99  RETURN
+
.------------------------------------------------------------
. Set parameters for alternate service provider
.------------------------------------------------------------
STALTP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STALTP99 IF EQUAL
            PACK      ALTSP[F3],QRYDATA,SP70
          ENDIF
STALTP99  RETURN
+
.------------------------------------------------------------
. Set parameters for alternate service provider code
.------------------------------------------------------------
STALTC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STALTC99 IF EQUAL
            PACK      ALTSC[F3],QRYDATA,SP70
          ENDIF
STALTC99  RETURN
+
..------------------------------------------------------------
.. Set parameters for alternate ifc code
..------------------------------------------------------------
.STIFCC00  MOVE      ZERO,EXIT
.          UNPACK    QRYNAME,KEY5,KEY3
.          MOVE      KEY3,F3
.          ASSIGN    F3-100,F3
.          RESET     QRYDATA
.          MATCH     SP70,QRYDATA
.          GOTO      STIFCC99 IF EQUAL
.          PACK      IFCCC[F3],QRYDATA,SP70
.STIFCC99  RETURN
.+
.------------------------------------------------------------
. Set parameters for alternate ifc code value
.------------------------------------------------------------
STIFCV00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STIFCV99 IF EQUAL
            PACK      IFCCV[F3],QRYDATA,SP70
          ENDIF
STIFCV99  RETURN
+
.------------------------------------------------------------
. Set parameters for number of patients
.------------------------------------------------------------
STNUMP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STNUMP99 IF EQUAL
            PACK      NUMPT[F3],QRYDATA,SP70
          ENDIF
STNUMP99  RETURN
+
.------------------------------------------------------------
. Set parameters for lspn
.------------------------------------------------------------
STLSPN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STLSPN99 IF EQUAL
            PACK      LSPNV[F3],QRYDATA,SP70
          ENDIF
STLSPN99  RETURN
+
.------------------------------------------------------------
. Set parameters for rovc - Restrictive override
.------------------------------------------------------------
STROVC00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STROVC99 IF EQUAL
            PACK      ROVRC[F3],QRYDATA,SP70
          ENDIF
STROVC99  RETURN
+
.------------------------------------------------------------
. Set parameters for admno
.------------------------------------------------------------
STADNO00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STADNO99 IF EQUAL
            PACK      ADMNO[F3],QRYDATA,SP70
          ENDIF
STADNO99  RETURN
+
.------------------------------------------------------------
. Set parameters for dskms - Distance Kms
.------------------------------------------------------------
STDSKM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STDSKM99 IF EQUAL
            PACK      DSKMS[F3],QRYDATA,SP70
          ENDIF
STDSKM99  RETURN
+
.------------------------------------------------------------
. Set parameters for self deemed
.------------------------------------------------------------
STSLDM00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          ASSIGN    F3-100,F3
          IF        F3>0 & F3<100
            RESET     QRYDATA
            MATCH     SP70,QRYDATA
            GOTO      STSLDM99 IF EQUAL
            PACK      SLDMC[F3],QRYDATA,SP70
          ENDIF
STSLDM99  RETURN
+
.------------------------------------------------------------
. Set parameters for GST Code
.------------------------------------------------------------
STPIT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STPIT010,STPIT020,STPIT030,STPIT040,STPIT050:
                       STPIT060,STPIT070,STPIT080,STPIT090,STPIT100:
                       STPIT110,STPIT120,STPIT130
.
          MOVE      ONE,EXIT
          GOTO      STPIT999
.
STPIT010  PACK      QRYDATA,QRYDATA,SP70
          MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PRITM001,CCENT,CYEAR,CMON,CDAY
          GOTO      STPIT999
.
STPIT020  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM002
          PACK      PRITM002,PRITM002,SP70
          GOTO      STPIT999
.
STPIT030  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM003
          PACK      PRITM003,PRITM003,SP70
          GOTO      STPIT999
.
STPIT040  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM004
          PACK      PRITM004,PRITM004,SP70
          GOTO      STPIT999
.
STPIT050  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM005
          PACK      PRITM005,PRITM005,SP70
          GOTO      STPIT999
.
STPIT060  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM006
          PACK      PRITM006,PRITM006,SP70
          GOTO      STPIT999
.
STPIT070  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM007
          GOTO      STPIT999
.
STPIT080  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM008
          GOTO      STPIT999
.
STPIT090  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM009
          GOTO      STPIT999
.
STPIT100  MATCH     SP70,QRYDATA
          GOTO      STPIT999 IF EQUAL
          MOVE      QRYDATA,PRITM010
          PACK      PRITM010,PRITM010,SP70
          GOTO      STPIT999
.
STPIT110  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM011
          GOTO      STPIT999
.
STPIT120  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM012
          GOTO      STPIT999
.
STPIT130  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRITM013
          GOTO      STPIT999
.
STPIT999  RETURN
+
.------------------------------------------------------------
. Debtors Maintenance: Display,Add,Update,Delete
.------------------------------------------------------------
PRBILL00  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
.
          MOVE      TEMPLATE,F3        * Format template variable to be
          MOVE      F3,TEMPLATE        * right alligned and ZERO filled.
          REP       " 0",TEMPLATE
.
          MOVE      ONE,VSCANPMI    * PMI UR number
          MATCH     SP1,UPDTTYPE
          GOTO      PRBILL80 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PRBILL10 IF EQUAL
.
          MATCH     "R",UPDTTYPE
          GOTO      PRBILL12 IF EQUAL  * Update PRFA from Invoice screen
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PRBILL20 IF EQUAL
.
          MATCH     "W",UPDTTYPE    * Update Workers Comp.
          GOTO      PRBILL30 IF EQUAL
.
          MATCH     "M",UPDTTYPE    * Update MAB/TAC
          GOTO      PRBILL30 IF EQUAL
.
          MATCH     "V",UPDTTYPE    * Update Veteran Affairs
          GOTO      PRBILL30 IF EQUAL
.
          MATCH     "T",UPDTTYPE    * Update Civil Tort
          GOTO      PRBILL30 IF EQUAL
.
          MATCH     "C",UPDTTYPE
          GOTO      PRBILL60 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete referral
          GOTO      PRBILL65 IF EQUAL
.
          MATCH     "L",UPDTTYPE    * Change claim code
          GOTO      PRBILL70 IF EQUAL
.
          MATCH     "O",UPDTTYPE    * Update Item Details
          GOTO      PRBILL77 IF EQUAL
.
          GOTO      PRBILL98
.
.         ************ ADD FORMACTION ***********
.
PRBILL10  MOVE      URNUMBER,PRHDDEBT
          MOVE      ONE,PRHDSCAN            * PMI scan flag
          MOVE      CLAIMCOD,PRHDCLAM       * claim code
          MOVE      SP70,PRHDACCD           * accident date
          MATCH     ACCIDATE,SP70
          IF        !@EQUAL
            MOVE      ACCIDATE,PRHDACCD
          ENDIF
          MOVE      HEALTHFD,PRHDHFND
.
          PACK      KEY27,PRHDDEBT,PRHDSCAN,PRHDCLAM,PRHDACCD,PRHDHFND
          CALL      RDPRHD1
          IF        OVRCD=0
            PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
            CALL      RDPRHR1
            COMPARE   ZERO,OVRCD
            GOTO      PRBILL93 IF EQUAL
          ENDIF
.
          CALL      ADDREF00        * Add referral details
.
          MOVE      PRHDUNIQ,UNIQNUMB
          MOVE      PRHRPRAC,PRHRE001
          MOVE      PRHRDOCT,PRHRE002
          MOVE      PRHRPIND,PRHRE003
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&uniqnumb=",REDIRECT
          APPEND    UNIQNUMB,REDIRECT
          APPEND    "&prhre001=",REDIRECT
          APPEND    PRHRE001,REDIRECT
          APPEND    "&prhre002=",REDIRECT
          APPEND    PRHRE002,REDIRECT
          APPEND    "&prhre003=",REDIRECT
          APPEND    PRHRE003,REDIRECT
          RESET     REDIRECT
.
          REP       " +",REDIRECT
.
          MOVE      ZERO,EXIT
          GOTO      PRBILL99
.
.         ************ UPDATE FORMACTION ***********
.
PRBILL12  BRANCH    PRFAC002,PRBILL17            * Single invoice
          MATCH     PRFAC003,PRFAC004
          GOTO      PRBILL94 IF LESS             * Invalid invoice range
.
.         Update PRFA for range of invoice
.
          MOVE      ONE,VSCANPMI
          PACK      KEY18,URNUMBER,VSCANPMI,PRFAC003
          CALL      RDPRIN3
          COMPARE   ZERO,OVRCD
          GOTO      PRBILL16 IF EQUAL
PRBILL14  CALL      RKPRIN3
          BRANCH    OVRCD,PRBILL18
          MATCH     PRINDEBT,URNUMBER            * same U/R ?
          GOTO      PRBILL18 IF NOT EQUAL        * no - finish
.
          COMPARE   PRINSCAN,VSCANPMI            * same scan flag ?
          GOTO      PRBILL18 IF NOT EQUAL        * no - finish
.
          MATCH     PRINNUMB,PRFAC004            * still in range ?
          GOTO      PRBILL18 IF LESS             * no - finish
.
PRBILL16  CALL      STPRF000                     * Update PRFA for the invoice
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT                * date updated
          CLOCK     TIME,PRINUTIM                * time updated
          MOVE      USERID,PRINUUID              * web user id
          CALL      UPPRIN3
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP                * Flag PMI Outstanding Debt
          ENDIF
          GOTO      PRBILL14
.
.         Update PRFA for a single invoice
.
PRBILL17  PACK      KEY8,INVOICEN
          CALL      RDPRIN1
          BRANCH    OVRCD,PRBILL18
          CALL      STPRF000                      * Update PRFA for the invoice
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT                 * date updated
          CLOCK     TIME,PRINUTIM                 * time updated
          MOVE      USERID,PRINUUID               * web user id
          CALL      UPPRIN1
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP                * Flag PMI Outstanding Debt
          ENDIF
.
PRBILL18  COMPARE   ONE,PRFAC001
          GOTO      PRBILL28 IF NOT EQUAL   * only update PRFA for the invoice
.
PRBILL20  PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          IF        OVRCD=0
            PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
            CALL      RDPRHR1
            BRANCH    OVRCD,PRBILL90
            CALL      MVPRHR00              * Move cgi var to file variable
            CALL      UPPRHR1
.
.           Fix prihtr if necessary
.
            PACK      DIM27,DPRHRUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
            PACK      KEY62,DPRHRUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP30,SP30
PRBILL22    CALL      RSPRHT1                 * get the first record
            CALL      RKPRHT1
            BRANCH    OVRCD,PRBILL28
.
            PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
            MATCH     KEY27,DIM27             * only continue if we have the
            GOTO      PRBILL28 IF NOT EQUAL     same key value
.
            PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND:
                            PRHTREFD,PRHTRDAT:
                            PRHTFLAG,PRHTITMN,PRHTSUBN,DPRHTNUM,SP70
.
            PACK      PRHTREFD,PRHRREFD,SP70
            MOVE      PRHRRDAT,PRHTRDAT
            CALL      UPPRHT1
.
            GOTO      PRBILL22
          ENDIF
.
PRBILL28  MOVE      ZERO,EXIT
          GOTO      PRBILL75
.
.         *****  Update workers Compensation details ****
.
PRBILL30  COMPARE   ZERO,INVOICEN
          GOTO      PRBILL32 IF EQUAL
.
          MOVE      ZERO,FORM8
          MOVE      INVOICEN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PRBILL75
          MOVE      PRINNUMB,FORM8
          MOVE      PRINCNUM,PRHRUNCL   * use claim number from invoice file
          GOTO      PRBILL34
.
PRBILL32  MOVE      ZERO,FORM8            * set invoice number to zero
          PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,PRBILL75
.
.         COMPARE   TWO,PROGFLAG
.         GOTO      PRBILL33 IF EQUAL     * From change claim code option
.
          COMPARE   ZERO,PRHRUNCL
          GOTO      PRBILL34 IF NOT EQUAL
.
PRBILL33  CALL      NXTCLN00            * Get next claim number
          CALL      UPPRHR1
.
PRBILL34  MOVE      UPDTTYPE,ANS
          REP       "W1M2V3T4",ANS
          MOVE      ZERO,FORM1
          MOVE      ANS,FORM1
          BRANCH    FORM1,PRBILL40,PRBILL45,PRBILL50,PRBILL55
          GOTO      PRBILL75
.
.         *****  Update workers Compensation details ****
.
PRBILL40  MOVE      FORM8,PRWCINVN
          MOVE      PRHRUNCL,PRWCUNIQ
          PACK      KEY16,PRWCINVN,PRWCUNIQ
          CALL      RDPRWC1           * Workers comp.
          IF        OVRCD=0
            CALL      MVPRWC00        * move cgi variables to file variables
            CALL      UPPRWC1
          ELSE
            CALL      MVPRWC00        * move cgi variables to file variables
            CALL      WRPRWC1
          ENDIF
          MOVE      THREE,FOLDERTY    * Set default to Work Cover
          CALL      UPFOLD00          * Update PMI folder details
          MOVE      ZERO,EXIT
          GOTO      PRBILL75

.         *****  Update TAC details ****
.
PRBILL45  MOVE      FORM8,PRMAINVN
          MOVE      PRHRUNCL,PRMAUNIQ
          PACK      KEY16,PRMAINVN,PRMAUNIQ
          CALL      RDPRMA1           * TAC
          IF        OVRCD=0
            CALL      MVPRMB00        * move cgi variables to file variables
            CALL      UPPRMA1
          ELSE
            CALL      MVPRMB00        * move cgi variables to file variables
            CALL      WRPRMA1
          ENDIF
          MOVE      TWO,FOLDERTY    * Set default to TAC
          CALL      UPFOLD00        * Update PMI folder details
          MOVE      ZERO,EXIT
          GOTO      PRBILL75
.
.         *****  Update veteran affairs details ****
.
PRBILL50  MOVE      FORM8,PRVAINVN
          MOVE      PRHRUNCL,PRVAUNIQ
          PACK      KEY16,PRVAINVN,PRVAUNIQ
          CALL      RDPRVA1           * Veteran affairs
          IF        OVRCD=0
            CALL      MVPRVA00        * move cgi variables to file variables
            CALL      UPPRVA1
          ELSE
            CALL      MVPRVA00        * move cgi variables to file variables
            CALL      WRPRVA1
          ENDIF
          MOVE      ONE,FOLDERTY      * Set default to DVA
          CALL      UPFOLD00          * Update PMI folder details
          MOVE      ZERO,EXIT
          GOTO      PRBILL75
.
.         *****  Update Civil Tort details ****
.
PRBILL55  MOVE      FORM8,PRCTINVN
          MOVE      PRHRUNCL,PRCTUNIQ
          PACK      KEY16,PRCTINVN,PRCTUNIQ
          CALL      RDPRCT1           * Civil Tort
          IF        OVRCD=0
            CALL      MVPRCT00        * move cgi variables to file variables
            CALL      UPPRCT1
          ELSE
            CALL      MVPRCT00        * move cgi variables to file variables
            CALL      WRPRCT1
          ENDIF
          MOVE      FIVE,FOLDERTY     * Set default to Civil tort
          CALL      UPFOLD00          * Update PMI folder details
          MOVE      ZERO,EXIT
          GOTO      PRBILL75
.
PRBILL60  PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,PRBILL99
.
          MOVE      ZERO,EXIT
          GOTO      PRBILL99
.
.         Delete referral
.
PRBILL65  CALL      DREF0000               * routine to delete referral
          BRANCH    EXIT,PRBILL96
.
          MOVE      ZERO,EXIT
          GOTO      PRBILL99
.
.         Change claim code
.
PRBILL70  MATCH     SP70,NEWCLAIM
          GOTO      PRBILL95 IF EQUAL
.
          MATCH     "1",PTCNUIMC
          IF        @EQUAL
            MATCH     OLDCLAIM,NEWCLAIM     * Check if claim code has changed?
            IF        @EQUAL
              MATCH     OLDHTHFD,NEWHTHFD   * Check if health fund has changed?
              GOTO      PRBILL97 IF EQUAL
            ENDIF
          ELSE
            MATCH     OLDCLAIM,NEWCLAIM     * Check if claim code has changed?
            GOTO      PRBILL95 IF EQUAL
          ENDIF
.
          CALL      UPCL0000              * Check claim code indicator
          IF        INVOICEN=0
            CALL      PHOL0000            * Update holding for pending invoice
          ELSE
            PACK      KEY8,INVOICEN
            CALL      RDPRIN1
            IF        OVRCD=0
              CALL      UPHL0000          * Update holding for a selected invoic
              CALL      IDEN0000          * Update Uniq Id.
            ENDIF
          ENDIF
.
PRBILL75  MATCH     SP70,UNIQNUMB
          IF        !@EQUAL
            PACK      KEY8,UNIQNUMB,SP70
            CALL      RDPRHD2
          ENDIF
.
          MOVE      PRHDUNIQ,KEY8
          REP       " +",KEY8
          REP       " +",PRHRE001
          REP       " +",PRHRE002
          REP       " +",PRHRE003
          REP       " +",URNUMBER
.
          MOVE      INVOICEN,DIM8
          REP       " +",DIM8
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&uniqnumb=",REDIRECT
          APPEND    KEY8,REDIRECT
          APPEND    "&prhre001=",REDIRECT
          APPEND    PRHRE001,REDIRECT
          APPEND    "&prhre002=",REDIRECT
          APPEND    PRHRE002,REDIRECT
          APPEND    "&prhre003=",REDIRECT
          APPEND    PRHRE003,REDIRECT
          APPEND    "&invoicen=",REDIRECT
          APPEND    DIM8,REDIRECT
          APPEND    SP70,REDIRECT
          RESET     REDIRECT
.
          REP       "+ ",URNUMBER
          REP       "+ ",PRHRE001
          REP       "+ ",PRHRE002
          REP       "+ ",PRHRE003
          MOVE      ZERO,EXIT
          GOTO      PRBILL99
.
PRBILL77  CALL      UPDITM00               * routine to update item details
          MOVE      ZERO,EXIT
          GOTO      PRBILL99
.
PRBILL80  MATCH     "019",TEMPLATE
          GOTO      PRBILL90 IF EQUAL       * Invoice search
.
          MATCH     Z70,PRHTR001
          GOTO      PRBILL85 IF EQUAL
.
          PACK      KEY62,PRHTR001,PRHTR002,PRHTR003,PRHTR004,PRHTR005:
                          PRHTR006,PRHTR007,PRHTR008,PRHTR009,PRHTR010
          CALL      RDPRHT1
          IF        OVRCD<>0
            CALL      CLPRIHTR
          ENDIF
.
PRBILL85  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PRBILL91
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PRBILL91
.
          CALL      CHKREF00          * Check doctor referral details & PRFA
          BRANCH    EXIT,PRBILL99
.
          MOVE      "0",INVIACTV
          MOVE      SP70,INDMHOSP
.
          COMPARE   ONE,IBCNMHOS
          GOTO      PRBILL86 IF NOT EQUAL    * not multi hospital
.
          PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,PRBILL88
.
.         Read medical practice file to get the register
.
          PACK      KEY6,PRHRE001,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,PRBILL88
.
          MATCH     SP70,PRPRREGI
          GOTO      PRBILL88 IF EQUAL
.
          PACK      KEY3,PRPRREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,PRBILL88
.
          MOVE      REGHOSP,INDMHOSP          * hospital id from register
.
PRBILL86  MOVE      PRHDCLAM,INDMCLAM
          MOVE      "P",INDMSYST
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
.
          MOVE      URNUMBER,INDMURNO
          MOVE      SP70,INDMADNO
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
PRBILL88  COMPARE   ZERO,INVOICEN
          GOTO      PRBILL90 IF EQUAL
.
          PACK      KEY8,INVOICEN
          CALL      RDPRIN1
          IF        OVRCD=0
            MOVE      PRINCLAM,OLDCLAIM
.
            PACK      KEY22,PRINUNIQ,PRINNUMB,SP70
            CALL      RSPRDT1
            CALL      RKPRDT1
            IF        OVRCD=0
              COMPARE   PRINUNIQ,PRDTUNIQ
              GOTO      PRBILL90 IF NOT EQUAL
.
              MATCH     PRINNUMB,PRDTINVN
              GOTO      PRBILL90 IF NOT EQUAL
.
              PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
              CALL      RDPRHR1
              IF        OVRCD=1
                CALL      CLPRIHRE
              ENDIF
.
              PACK      KEY8,PRDTUNIQ,SP70
              CALL      RDPRHD2
              IF        OVRCD=1
                CALL      CLPRIHDB
              ENDIF    
.
            ENDIF
          ENDIF
          GOTO      PRBILL90
.
PRBILL90  CLEAR     WEBTITLE
          MATCH     "001",TEMPLATE
          IF        @EQUAL
            PACK      WEBTITLE,DOCREFLT,URNUMBER
          ELSE
            MOVE      "Billing Maintenance",WEBTITLE
          ENDIF
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRBILL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL91  MOVE      "Missing U/R number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL92  MOVE      "PP Debtor Master record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL93  MOVE      "Referral record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL94  MOVE      "Invalid Range of Invoice.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL95  MOVE      "Claim Code has not changed/Blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL96  MOVE      "Referral deletion not allowed - Billing Transactions exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL97  MOVE      "Health Fund/Claim Code has not changed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL98  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRBILL99
.
PRBILL99  RETURN
+
.****************************************************************************
.                Delete referral
.****************************************************************************
DREF0000  PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,DREF9000
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,DREF9000
.
          PACK      DIM27,DPRHRUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          PACK      KEY62,DPRHRUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP30,SP30
          CALL      RSPRHT1                 * get the first record
          CALL      RKPRHT1
          BRANCH    OVRCD,DREF2000
.
          PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
          MATCH     KEY27,DIM27
          GOTO      DREF9000 IF EQUAL       * found holding transaction
.
DREF2000  PACK      KEY18,PRHDDEBT,SP70
          CALL      RSPRIN3
DREF2200  CALL      RKPRIN3
          BRANCH    OVRCD,DREF3000
.
          MATCH     PRHDDEBT,PRINDEBT       * Same debtors?
          GOTO      DREF3000 IF NOT EQUAL
.
          COMPARE   PRHDUNIQ,PRINUNIQ
          GOTO      DREF2200 IF NOT EQUAL

          MATCH     PRHRPRAC,PRINPRAC       * check Medical practice
          GOTO      DREF2200 IF NOT EQUAL
          MATCH     PRHRDOCT,PRINDOCT       * check Service doctor
          GOTO      DREF2200 IF NOT EQUAL
          MATCH     PRHDCLAM,PRINCLAM       * check claim type
          GOTO      DREF2200 IF NOT EQUAL
          MATCH     "1",PRINCNST            * check credit note
          GOTO      DREF2200 IF EQUAL
          GOTO      DREF9000
.
DREF3000  PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003
          CALL      DEPRHR1
.
.         Only remove header record if there is no other referral record for
.         the unique id
.
          PACK      KEY27,UNIQNUMB,SP70
          CALL      RSPRHR1
          CALL      RKPRHR1
          BRANCH    OVRCD,DREF5000
.
          MATCH     UNIQNUMB,DPRHRUNQ
          GOTO      DREF8000 IF EQUAL           * found a referral record
.
DREF5000  MOVE      UNIQNUMB,KEY8
          CALL      RDPRHD2
          IF        OVRCD=0
            PACK      KEY27,PRHDDEBT,PRHDSCAN,PRHDCLAM,PRHDACCD,PRHDHFND,SP70
            CALL      DEPRHD1
          ENDIF
.
DREF8000  MOVE      ZERO,EXIT
          GOTO      DREF9999
.
DREF9000  MOVE      ONE,EXIT
DREF9999  RETURN
+
.****************************************************************************
.                Update Invoice item
.****************************************************************************
UPDITM00  PACK      KEY62,PRHTR001,PRHTR002,PRHTR003,PRHTR004,PRHTR005:
                          PRHTR006,PRHTR007,PRHTR008,PRHTR009,PRHTR010
          CALL      RDPRHT1
          BRANCH    OVRCD,UPDITM90
.
          MATCH     PRHTR015,Z70
          IF        !@EQUAL
            MOVE      PRHTR015,PRHTIDES
          ENDIF
.
          MATCH     PRHTR016,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR016
            MOVE      PRHTR016,PRHTSERN
          ENDIF
.
          MATCH     PRHTR017,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR017
            MOVE      PRHTR017,PRHTIAMT
          ENDIF
.
          MATCH     PRHTR018,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR018
            MOVE      PRHTR018,PRHTACOI
          ENDIF
.
          MATCH     PRHTR019,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR019
            MOVE      PRHTR019,PRHTTDUR
          ENDIF
.
          MATCH     PRHTR020,Z70
          IF        !@EQUAL
             SQUEEZE   PRHTR020
            MOVE      PRHTR020,PRHTMPOV
          ENDIF
.
          MATCH     PRHTR021,Z70
          IF        !@EQUAL
             SQUEEZE   PRHTR021
            MOVE      PRHTR021,PRHTDSOV
          ENDIF
.
          MATCH     PRHTR022,Z70
          IF        !@EQUAL
            MOVE      PRHTR022,PRHTSTXT
          ENDIF
.
          MATCH     PRHTR023,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR023
            MOVE      PRHTR023,PRHTASPF
          ENDIF
.
          MATCH     PRHTR024,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR024
            MOVE      PRHTR024,PRHTASPC
          ENDIF
.
.          MATCH     PRHTR025,Z70
.          IF        !@EQUAL
.            SQUEEZE   PRHTR025
.            MOVE      PRHTR025,PRHTAICF
.          ENDIF
.
          MATCH     PRHTR026,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR026
            MOVE      PRHTR026,PRHTAICV
          ENDIF
.
          MATCH     PRHTR027,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR027
            MOVE      PRHTR027,PRHTNMPT
          ENDIF
.
          MATCH     PRHTR028,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR028
            MOVE      PRHTR028,PRHTLSPN
          ENDIF
.
          MATCH     PRHTR029,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR029
            MOVE      PRHTR029,PRHTSDCD
          ENDIF
.
          MATCH     PRHTR032,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR032
            MOVE      PRHTR032,PRHTHOSI
          ENDIF
.
          MATCH     PRHTR033,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR033
            MOVE      PRHTR033,PRHTROVC
          ENDIF
.
          MATCH     PRHTR034,Z70
          IF        !@EQUAL
            SQUEEZE   PRHTR034
            MOVE      PRHTR034,PRHTDSKM
          ENDIF
.
          CALL      UPPRHT1
          CALL      UPPRHT1
.
UPDITM80  MOVE      ZERO,EXIT
          GOTO      UPDITM99
.
UPDITM90  MOVE      ONE,EXIT
UPDITM99  RETURN
+
.****************************************************************************
.*                                UPCL0000                                  *
.*                 Update claim code                                        *
.****************************************************************************
UPCL0000  MOVE      OLDCLAIM,CLAIMCOD   * check old claim code indicator
          CALL      GCLM0000            * Setup COMPFLAG from claim code
          MOVE      COMPFLAG,CLFLAG
.
          MOVE      NEWCLAIM,CLAIMCOD
          CALL      GCLM0000            * Setup COMPFLAG from claim code
.
.         See if old claim was a compensation claim or not
.
          COMPARE   ZERO,CLFLAG                  * non-compensation claim ?
          GOTO      UPCL9999 IF EQUAL            * yes
.
.         Old claim was a compensation claim, so see if new claim is
.         also a compensation claim
.
          COMPARE   ZERO,COMPFLAG                * new compensation claim ?
          GOTO      UPCL9000 IF NOT EQUAL        * yes
          MOVE      SP10,ACCIDATE                * compensation to non-comp.
.
UPCL9000  CALL      DECOM000                     * Delete Compensable details
UPCL9999  RETURN
+
.--------------------------------------------------------------------------
.         Update holding file for a selected invoice
.--------------------------------------------------------------------------
UPHL0000  MOVE      PRINUNIQ,XUNIQUE             * Save unique number
          PACK      KEY27,PRINDEBT,PRINSCAN,NEWCLAIM,ACCIDATE,NEWHTHFD,SP70
          CALL      RDPRHD1                      * read header record
          BRANCH    OVRCD,UPHL5000               * not on file
.
          MOVE      NEWCLAIM,PRHDCLAM
          MOVE      ACCIDATE,PRHDACCD
          MOVE      NEWHTHFD,PRHDHFND
          CALL      UPPRHD1                      * update record
          GOTO      UPHL9999
.
.         Create a new holding header file
.
UPHL5000  MOVE      SP30,PRHDSPAR
.
.         Get next unique identifier
.
          CALL      NXTI0000                     * get next unique identifier
          MOVE      PRINDEBT,PRHDDEBT
          MOVE      PRINSCAN,PRHDSCAN
          MOVE      NEWCLAIM,PRHDCLAM
          MOVE      ACCIDATE,PRHDACCD
          MOVE      NEWHTHFD,PRHDHFND
.          PACK      KEY27,PRINDEBT,PRINSCAN,NEWCLAIM,ACCIDATE,NEWHTHFD,SP70
          CALL      WRPRHD1                      * write new record
.
UPHL9999  RETURN
+
.****************************************************************************
.*                               IDEN0000              Called by: IUPD0000  *
.*              update the unique identifier in the invoice record          *
.*              and the DTR records for a change in claim code              *
.****************************************************************************
IDEN0000  MOVE      PRHDUNIQ,PRINUNIQ
          MOVE      NEWCLAIM,PRINCLAM
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT             * date updated
          CLOCK     TIME,PRINUTIM             * time updated
          MOVE      USERID,PRINUUID           * web user id
          CALL      UPPRIN1
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP                * Flag PMI Outstanding Debt
          ENDIF
.
.         Loop through the DTR file and update the unique identifier
.
IDEN1000  PACK      KEY22,XUNIQUE,INVOICEN,SP10
          CALL      RSPRDT1                      * position in file
          CALL      RKPRDT1                      * read next record
          BRANCH    OVRCD,IDEN9999               * end of file
.
          COMPARE   XUNIQUE,PRDTUNIQ             * same unique identifier ?
          GOTO      IDEN9999 IF NOT EQUAL        * no
.
          MATCH     PRINNUMB,PRDTINVN            * same invoice number ?
          GOTO      IDEN9999 IF NOT EQUAL        * no
.
          MOVE      PRHDUNIQ,PRDTUNIQ
          MOVE      NEWCLAIM,PRDTCLAM
          MOVE      PRDTPRAC,PRHRPRAC
          MOVE      PRDTDOCT,PRHRDOCT
          MOVE      PRDTCLAM,PRHRPIND
          CALL      UPPRDT1                      * update record
          GOTO      IDEN1000                     * get next record
.
IDEN9999  RETURN
+
.--------------------------------------------------------------------------
.        for pending invoices, set up for new claim code
.--------------------------------------------------------------------------
PHOL0000  MOVE      PRHDUNIQ,XUNIQUE
          MOVE      XUNIQUE,KEY8
          CALL      RDPRHD2                      * read original header record
          BRANCH    OVRCD,PHOL9500               * not on file
.
.         See if header record for new claim code already exists
.
          MATCH     SP10,ACCIDATE
          GOTO      PHOL0500 IF NOT EQUAL
.
.         If claim code changed to non-compensation, set accident date to blank
.
          IF        COMPFLAG=0
            PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,SP8,NEWHTHFD,SP70
          ELSE
            PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,PRHDACCD,NEWHTHFD,SP70
          ENDIF
          GOTO      PHOL0700
.
PHOL0500  PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,ACCIDATE,NEWHTHFD,SP70
PHOL0700  CALL      RDPRHD1                      * read record
          BRANCH    OVRCD,PHOL5000               * not on file
.
. ------- Header record already exists, so see if a corresponding ------------
.         referral record exists for the new claim code
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1                      * read record
          BRANCH    OVRCD,PHOL7500               * not on file
.
.         Make sure referral record has invoicing flag set
.
          MOVE      ONE,PRHRPINV
          CALL      UPPRHR1                      * update record
.
.         Remove the old referral record
.
          PACK      KEY27,XUNIQUE,PRHRE001,PRHRE002,PRHRE003
          CALL      DEPRHR1
.
.         Referral record exists, so see if any transaction records exists
.
          MOVE      ZERO,TRANSNO
          PACK      KEY62,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP30,SP30
          CALL      RSPRHT1                      * position in file
PHOL1000  CALL      RKPRHT1                      * read next record
          BRANCH    OVRCD,PHOL1500               * end of file
.
          COMPARE   PRHDUNIQ,PRHTUNIQ            * same unique identifier ?
          GOTO      PHOL1500 IF NOT EQUAL        * no
.
          MATCH     PRHRE001,PRHTPRAC            * same medical practice ?
          GOTO      PHOL1500 IF NOT EQUAL        * no
.
          MATCH     PRHRE002,PRHTDOCT            * same service doctor ?
          GOTO      PHOL1500 IF NOT EQUAL        * no
.
          MATCH     PRHRE003,PRHTPIND            * same patient indicator ?
          GOTO      PHOL1500 IF NOT EQUAL        * no
.
.         A valid transaction found, so save the transaction number
.
          MOVE      PRHTNUMB,TRANSNO             * save last transaction no.
          GOTO      PHOL1000                     * get next transaction
.
PHOL1500  COMPARE   TRANSNO,ZERO                 * any transactions already ?
          GOTO      PHOL8000 IF EQUAL            * no - so update existing
.                                                  transactions for old claim
.
.         Update the old claim transactions beginning with the next transaction
.         number for the new referral record
.
PHOL2000  PACK      KEY62,XUNIQUE,PRHRE001,PRHRE002,PRHRE003,SP30,SP30
          CALL      RSPRHT1                      * position in file
          CALL      RKPRHT1                      * read next record
          BRANCH    OVRCD,PHOL9700               * end of file
.
          COMPARE   XUNIQUE,PRHTUNIQ             * same unique identifier ?
          GOTO      PHOL9700 IF NOT EQUAL        * no
.
          MATCH     PRHRE001,PRHTPRAC            * same medical practice ?
          GOTO      PHOL9700 IF NOT EQUAL        * no
.
          MATCH     PRHRE002,PRHTDOCT            * same service doctor ?
          GOTO      PHOL9700 IF NOT EQUAL        * no
.
          MATCH     PRHRE003,PRHTPIND            * same patient indicator ?
          GOTO      PHOL9700 IF NOT EQUAL        * no
.
.         Valid record, so update it
.
          ADD       ONE,TRANSNO                  * increment transaction no.
          MOVE      TRANSNO,PRHTNUMB
          MOVE      PRHDUNIQ,PRHTUNIQ
          CALL      UPPRHT1                      * update record
          GOTO      PHOL2000                     * get next transaction record
.
. ------- New header record to be created --------------------
.
PHOL5000  MOVE      SP30,PRHDSPAR
.
          CALL      NXTI0000                     * get next unique identifier
.
          MATCH     SP10,ACCIDATE
          GOTO      PHOL7200 IF NOT EQUAL
.
.         If claim code changed to non-compensation, set accident date to blank
.
          IF        COMPFLAG=0
            MOVE      NEWCLAIM,PRHDCLAM
            MOVE      SP70,PRHDACCD
            MOVE      NEWHTHFD,PRHDHFND
.            PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,SP8,NEWHTHFD,SP70
          ELSE
            MOVE      NEWCLAIM,PRHDCLAM
            MOVE      NEWHTHFD,PRHDHFND
.            PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,PRHDACCD,NEWHTHFD,SP70
          ENDIF
          GOTO      PHOL7300
.
PHOL7200  MOVE      NEWCLAIM,PRHDCLAM
          MOVE      ACCIDATE,PRHDACCD
          MOVE      NEWHTHFD,PRHDHFND
.          PACK      KEY27,PRHDDEBT,PRHDSCAN,NEWCLAIM,ACCIDATE,NEWHTHFD,SP70
PHOL7300  CALL      WRPRHD1                      * write new record
.
.         Update the referral and transaction records
.
PHOL7500  PACK      KEY27,XUNIQUE,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1                      * read record
          BRANCH    OVRCD,PHOL8000               * not found
.
.         If we are not writing a new comp record, but we are deleting
.         an old comp record, then we must be changing from a
.         compensation claim to a non-compensation claim.  We therefore
.         need to remove the old claim number before updating the referral
.         record
.
.         Check the old compensation flag, 0 for non-compensation
.
          COMPARE   ZERO,CLFLAG                  * deleting old comp. record ?
          GOTO      PHOL7700 IF EQUAL            * no
.
.         Check the new compensation flag,0 for non-compensation,1 for compen.
.
          COMPARE   ZERO,COMPFLAG                * writing new comp. record ?
          GOTO      PHOL7700 IF NOT EQUAL        * yes
.
          MOVE      ZERO,PRHRUNCL                * remove claims number
.
PHOL7700  MOVE      PRHDUNIQ,PRHRUNIQ
          CALL      UPPRHR1                      * update record
.
.         Update all the transaction records
.
PHOL8000  CALL      UTRN0000
          MOVE      PRHDUNIQ,UNIQNUMB
          GOTO      PHOL9700                     * finished
.
PHOL9500  MOVE      ONE,EXIT
          GOTO      PHOL9999
.
PHOL9700  MOVE      ZERO,EXIT
PHOL9999  RETURN
+
.****************************************************************************
.*                                UTRN0000             Called by: PHOL0000  *
.*                 update the old transaction records with the              *
.*                 new unique identifier                                    *
.****************************************************************************
UTRN0000  PACK      KEY62,XUNIQUE,PRHRE001,PRHRE002,SP30,SP30
          CALL      RSPRHT1                      * position in file
          CALL      RKPRHT1                      * read next record
          BRANCH    OVRCD,UTRN9999               * end of file
.
          COMPARE   XUNIQUE,PRHTUNIQ             * same unique identifier ?
          GOTO      UTRN9999 IF NOT EQUAL        * no
.
          MATCH     PRHRE001,PRHTPRAC            * same medical practice ?
          GOTO      UTRN9999 IF NOT EQUAL        * no
.
          MATCH     PRHRE002,PRHTDOCT            * same service doctor ?
          GOTO      UTRN9999 IF NOT EQUAL        * no
.
.         Valid record, so update it
.
          MOVE      PRHDUNIQ,PRHTUNIQ
          CALL      UPPRHT1                      * update record
          GOTO      UTRN0000                     * get next record
.
UTRN9999  RETURN
+
.--------------------------------------------------------------------------
.         Delete Compensable details
.--------------------------------------------------------------------------
DECOM000  IF        INVOICEN=0
            PACK      KEY16,INVOICEN,PRHRUNCL
          ELSE
            PACK      KEY16,INVOICEN,PRINCNUM
          ENDIF
          BRANCH    CLFLAG,DECOM100,DECOM200,DECOM300,DECOM400
          GOTO      DECOM999
.
DECOM100  CALL      DEPRWC1           * delete Workers comp.
          GOTO      DECOM999
.
DECOM200  CALL      DEPRMA1           * delete transport accident
          GOTO      DECOM999
.
DECOM300  CALL      DEPRVA1           * delete veterans affairs
          GOTO      DECOM999
.
DECOM400  CALL      DEPRCT1           * delete civil tort
          GOTO      DECOM999
.
DECOM999  RETURN
+
.--------------------------------------------------------------------------
.         Setup PRFA from cgi variable for invoice file
.--------------------------------------------------------------------------
STPRF000  MATCH     PRHRE015,Z70
          IF        !@EQUAL
            MOVE      PRHRE015,PRINNAMR             * load updated PRA fields
          ENDIF
.
          MATCH     PRHRE016,Z70
          IF        !@EQUAL
            MOVE      PRHRE016,PRINPRA1
          ENDIF
.
          MATCH     PRHRE017,Z70
          IF        !@EQUAL
            MOVE      PRHRE017,PRINPRA2
          ENDIF
.
          MATCH     PRHRE018,Z70
          IF        !@EQUAL
            MOVE      PRHRE018,PRINPRA3
          ENDIF
.
          MATCH     PRHRE019,Z70
          IF        !@EQUAL
            MOVE      PRHRE019,PRINPOST
          ENDIF
.
          MATCH     PRHRE020,Z70
          IF        !@EQUAL
            MOVE      PRHRE020,PRINTELP
          ENDIF
.
          MATCH     PRHRE021,Z70
          IF        !@EQUAL
            MOVE      PRHRE021,PRINTELB
          ENDIF
.
          MATCH     PRHRE022,Z70
          IF        !@EQUAL
            MOVE      PRHRE022,PRINRELP
          ENDIF
.
          MATCH     PRHRE026,Z70
          IF        !@EQUAL
            MOVE      PRHRE026,PRINPRA4
          ENDIF
.
          MATCH     PRHRE027,Z70
          IF        !@EQUAL
            MOVE      PRHRE027,PRINMPHN
          ENDIF
.
STPRF999  RETURN
+
.--------------------------------------------------------------------------
. UPFOLD00 - This will update the pmi field PMPXFLDR with the appropriate
.            category code (cat FS) that has a matching TCINDC1 to FOLDERTY.
.
. Parameters: FOLDERT1 values 1=DVA,2=TAC,3=Work Comp
.--------------------------------------------------------------------------
UPFOLD00  MATCH     "0",PTCNCOMF            * Not using compensable folders
          GOTO      UPFOLD99 IF EQUAL
.
          MOVE      "FS",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
UPFOLD10  CALL      RDKCODE1
          BRANCH    OVRCD,UPFOLD99
.
          MATCH     CATEGORY,TCODE
          GOTO      UPFOLD99 IF NOT EQUAL
.
          MATCH     FOLDERTY,TCINDC1
          GOTO      UPFOLD80 IF EQUAL
.
          GOTO      UPFOLD10
.
UPFOLD80  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,UPFOLD99
.
          MATCH     ACODE,PMPXFLDR
          GOTO      UPFOLD99 IF EQUAL
.
          MOVE      ACODE,PMPXFLDR
.
          CALL      UPPMPX21
.
UPFOLD99  RETURN
+
.-------------------------------------------------------------------------------
.         Validating bulk billing code
.-------------------------------------------------------------------------------
VALBUL00  CALL      XMLHED00
          BRANCH    EXIT,VALBUL99
          PACK      KEY5,ANSG,ANSB,VALDCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALBUL90
.
          MOVE      SP1,INDICATR
          CALL      GETBL000            * Get indicator (INDICATR)
.
          MATCH     SP1,INDICATR
          GOTO      VALBUL20 IF EQUAL
.
          CALL      GCLM0000            * Setup COMPFLAG from claim code
          MOVE      SP1,CLAIMIND
          LOAD      CLAIMIND,COMPFLAG,ANSW,ANSM,ANSV
.
          MATCH     SP1,CLAIMIND
          GOTO      VALBUL20 IF EQUAL
.
          MATCH     CLAIMIND,INDICATR
          GOTO      VALBUL92 IF NOT EQUAL
.
VALBUL20  PACK      KEY11,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             TDESC,"|",INDICATR,"|",KEY11,"|":
                             THCSCOD,"|",TCFORM6:
                             "</RETURN_VALUE>"
.
VALBUL90  UNPACK    KEY5,KEY2,KEY3
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Code - ",KEY3:
                             " Category - ",KEY2,"</RETURN_VALUE>"
          GOTO      VALBUL98
.
VALBUL92  UNPACK    KEY5,KEY2,KEY3
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Bulk Billing code must be the same type":
                             " as the Claim.":
                             "</RETURN_VALUE>"
          GOTO      VALBUL98
.
VALBUL98  CALL      XMLEND00
VALBUL99  RETURN
+
.-------------------------------------------------------------------------------
.         Generate PRFA
.-------------------------------------------------------------------------------
GNPRFA00  CALL      XMLHED00
          BRANCH    EXIT,GNPRFA99
.
          UNPACK    VALDCODE,CLAIMCOD
          CALL      GCLM0000        * set up the compensation flag
.
          READ      CONTROLF,THIRTY3;*212,PRCNUPRA
          MOVE      ONE,VSCANPMI
          CALL      SPRA0000
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRHRNAME,"|",PRHRADD1,"|",PRHRADD2,"|":
                             PRHRADD3,"|",PRHRPOST,"|",PRHRTELP,"|":
                             PRHRTELB,"|",PRHRRELP,"|",PRHRADD4,"|":
                             PRHRMPHN:
                             "</RETURN_VALUE>"
GNPRFA98  CALL      XMLEND00
GNPRFA99  RETURN
+
.-------------------------------------------------------------------------------
.         Print private practice invoice
.-------------------------------------------------------------------------------
PRPINV00  MOVE      ONE,VSCANPMI
          MOVE      URNUMBER,VDEBTOR
          CALL      LDDETAIL                 * Load PMI details into vars
          MOVE      ONE,WEBFLAG
          MOVE      ZERO,CRDNFLAG            * not Printing Credit note
          MOVE      SP70,PRANAME
          MOVE      ZERO,COPINV
.
          CALL      LNKVIS00
.
          CALL      CREATP00                 * create temp files
          MOVE      ONE,INVFLAG              * Generate invoice only no display
          CALL      NXIV0000                 * Generate Next Invoice
.
          PACK      KEY10,URNUMBER,VSCANPMI
          CALL      RDPRHO1
          IF        OVRCD = 0 & PRHOHOLD = 1
            GOTO      PRPINV50
          ENDIF
.
          CALL      SINVH000                     * check for template header
          BRANCH    EXIT,PRPINV92
          CALL      SINVT000                     * check for template tail
          BRANCH    EXIT,PRPINV92
.
.------ read the header file ------
.
          MOVE      ONE,FLAGHOLD                * set for holding the account
          PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,PRPINV94
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,PRPINV94
.
          COMPARE   ONE,PRHRPINV            * we have finished if no more
          GOTO      PRPINV40 IF NOT EQUAL     invoices to be printed
.
          MOVE      PRHRBULK,TMPBULK
          CALL      CHBUL000                * Setup FLAGBULK
          MOVE      PRHDUNIQ,TEMPUNQ
          MOVE      PRHRPRAC,TMPPRAC
          MOVE      PRHRDOCT,TMPSDOCT
          MOVE      PRHRPIND,TMPPIND
          IF        PRCNRDOC = 0
             MOVE      PRHRRDAT,TMPRDATE
             MOVE      PRHRREFD,TMPRDOCT
          ELSE
             MOVE      PRHTRDAT,TMPRDATE
             MOVE      PRHTREFD,TMPRDOCT
          ENDIF
.
          CALL      OPNPRINT
          CALL      PRIINVLD                * load the data into the temp file
          BRANCH    EXIT,PRPINV40
.
          BRANCH    FLAGHOLD,PRPINV90
.
.         CALL      PPTMP000                * process the pathology temp file
          CALL      PRIINVPR                * print the invoice/s for this
          CALL      CLRTF000                * clear temp files
          CALL      ECLMT000                * Write Eclipse other claimant
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      PCIW0000                * WebServices PCIW
          ELSE
            CALL      ESTRF000                * Eclipse PCS
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      BBSW0000                * WebServices BBSW
          ELSE
            CALL      EDBS0000                * Eclipse DBS
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      DVAW0000                * WebServices DVAW
          ENDIF
.
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
            BRANCH    EXIT,PRPINV99
          ENDIF
.
          MOVE      PRCNINVN,INVOICEN       * Populate invoice number
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      LADW0000                * Print Lodgement Advice PCIW
          ELSE
            CALL      LADV0000                * Print Lodgement Advice PCS
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      DB4W0000                * DB4 Form BBSW
          ELSE
            CALL      DB4F0000                * DB4 Form DBS
          ENDIF
.
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            CALL      D1217000                * D1217 Form DVAW
            CALL      D1216S00                * D1216S Form DVAW
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PRPINV99
.
PRPINV40  MOVE      "No Transaction on file.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRPINV99
.
PRPINV50  MOVE      "Accounts are on hold for this patient.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRPINV99
.
.------ debtor is having his account held ------
.
PRPINV90  MOVE     "Debtor's account is being held. No Invoice printed",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRPINV99
.
PRPINV92  MOVE     "Invoice Header/Tail Template Not Setup. ",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRPINV99
.
PRPINV94  MOVE     "Missing Details records.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRPINV99
.
PRPINV99  RETURN
+
.-------------------------------------------------------------------------------
.         Re-print private practice invoice
.-------------------------------------------------------------------------------
REPRNT00  MOVE      ONE,VSCANPMI
          MOVE      ONE,COPINV
          MOVE      URNUMBER,VDEBTOR
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,REPRNT90
.
          MOVE      ZERO,NBNKDEPS
          MOVE      ZERO,CURRDEP
          CALL      LDDETAIL                 * Load PMI details into vars
          CALL      SETPRA00                 * Set PRFA
          MOVE      ZERO,FLAGBULK
          MOVE      ONE,WEBFLAG
.
          CALL      LNKVID00
.
          CALL      SINVH000                     * check for template header
          BRANCH    EXIT,REPRNT92
          CALL      SINVT000                     * check for template tail
          BRANCH    EXIT,REPRNT92
.
          MOVE      PRINNUMB,PRCNINVN
          MOVE      "Error - invalid practice",PRPRDESC
          MOVE      PRINPRAC,KEY6
          CALL      RDPRPR1                 * read the practice file
.
          COMPARE   ZERO,PRPRTIME           * see if we want the service time
          GOTO      REPRNT05 IF EQUAL         on the invoice
          CALL      GETS0000                * Get service time
.
.------ get the claim code details if they exist ------
.
REPRNT05  CALL      GETC0000                * get the claim code details if
.                                             they exist
          CALL      OPNPRINT
.
          MOVE      ZERO,HEADFLAG
          MOVE      ZERO,FLAGMESS
          MOVE      SP70,VRFDOCT
          MOVE      SP8,SAVRDATE
          UNPACK    SP70,VRFDCNAM,VRFDOCT,VRFDPROV,VREFERD
.
          CALL      GIND0000                * Get default patient indicator
.
          PACK      KEY24,VDEBTOR,VSCANPMI,PRINNUMB,SP6
          CALL      RSPRDT3                 * position on the debtors
.                                             transaction file
.------ read through the debtors transaction file ------
.
REPRNT10  CALL      RKPRDT3
          BRANCH    OVRCD,REPRNT70
.
          MATCH     VDEBTOR,PRDTDEBT        * compare debtors
          GOTO      REPRNT70 IF NOT EQUAL
.
          COMPARE   VSCANPMI,PRDTSCAN       * compare scan flags
          GOTO      REPRNT70 IF NOT EQUAL
.
          MATCH     PRINNUMB,PRDTINVN       * match invoice numbers
          GOTO      REPRNT70 IF NOT EQUAL
.
          IF        PRDTRTYP=1
            COMPARE   TWO,PRDTIFLG
            GOTO      REPRNT10 IF EQUAL     * IMC details
          ENDIF
.
          IF        HEADFLAG=0
            MOVE      PRINCLAM,TMPCLAIM
            CALL      PIHED000                * print the invoice header
            MOVE      ONE,HEADFLAG
          ENDIF
.
          BRANCH    FLAGMESS,REPRNT20       * skip if we have the message code
          MOVE      PRDTMESS,SAVMESS
          MOVE      ONE,FLAGMESS
.
.------ match referring doctors ------
.
REPRNT20  MATCH     PRDTREFD,VRFDOCT        * same ref. doctor?
          GOTO      REPRNT30 IF NOT EQUAL   * no
.
          MATCH     PRDTRDTE,SAVRDATE       * same ref. date?
          GOTO      REPRNT60 IF EQUAL       * yes, details same as previous
.
REPRNT30  MATCH     SP70,PRDTREFD           * see if we have a referring doctor
          GOTO      REPRNT60 IF EQUAL
          MOVE      PRDTOPS,TMPOPS
          MOVE      SP10,REFDATE
.
          MATCH     SP8,PRDTRDTE            * see if we have a referring date
          GOTO      REPRNT40 IF EQUAL
.
          UNPACK    PRDTRDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * pack the date into required format
          MOVE      CPCDATE,REFDATE
.
.------ set up the referral details ------
.
REPRNT40  MOVE      PRDTREFT,VREFERD
          MOVE      PRDTREFD,VRFDOCT
          MOVE      PRDTRDTE,SAVRDATE
          MOVE      "                           ",VRFDCNAM
          MOVE      SP10,VRFDPROV
.
          MOVE      SP10,RPERIOD
          PACK      KEY5,ANSR,ANSF,PRDTRFPD
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TDESC,RPERIOD
          ENDIF
.
          PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          IF        OVRCD=0
            MATCH     SP70,PRHRREFD
            IF        !@EQUAL & !@EOS
              OPEN      PMSHCLA1,"pmshclaf"
              PACK      KEY20,PRHRREFD,PRHRHCPP,SP70
              CALL      RDPMHCL1
              IF        OVRCD=0
                MATCH     SP70,PMHLPRV1
                IF        !@EQUAL
                  MOVE      PMHLPRV1,VRFDPROV  * provider from a Linked Practice
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          PACK      KEY10,VRFDOCT,SP10
          CALL      RDPMHCP1                * read the patient doctor file
          BRANCH    OVRCD,REPRNT50
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME                 * pack the doctors name
          MOVE      PACFNAME,VRFDCNAM
          MATCH     SP70,VRFDPROV
          IF        @EQUAL
            MOVE      PMHCPRV1,VRFDPROV
          ENDIF
.
.------ print the referring doctor details ------
.
REPRNT50  MOVE      SP70,VREFRPER
          PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          IF        OVRCD=0
            MATCH     SP70,PRHRRFPD
            IF        !@EQUAL & !@EOS
              PACK      KEY5,ANSR,ANSF,PRHRRFPD,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MOVE      TDESC,VREFRPER
              ENDIF
            ENDIF
          ENDIF
          CALL      PRDOC000
.
.------ set up the rest of the details to print for the current transaction ---
.
REPRNT60  MOVE      ONEHUND,PRDOFEEP
          PACK      KEY22,PRDTPRAC,PRDTDOCT,PRDTCLAM,PRDTCODE
          CALL      RDPRDO1                 * read the practice doctor file
.
          CALL      PRINV000                * print the current transaction
          MOVE      TRUE,FLAGSOME
          GOTO      REPRNT10
.
REPRNT70  MOVE      ZERO,NBNKDEPS
          PACK      SAVKEY12,SP4,PRINNUMB
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
REPRNT72  CALL      RKRCDTE3
          BRANCH    OVRCD,REPRNT78
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      REPRNT78 IF NOT EQUAL
.
          MATCH     VDEBTOR,RCDTURNO        * compare debtors
          GOTO      REPRNT72 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,REPRNT72
.
          MATCH     "0",RCBNSTAT        * Cash Not banked?
          GOTO      REPRNT72 IF NOT EQUAL
.
          ADD       RCDTAMNT,NBNKDEPS
          GOTO      REPRNT72
.
REPRNT78
..         COMPARE   ZERO,NBNKDEPS
.          GOTO      REPRNT80 IF EQUAL
.          CALL      CNTIV000                * check for invoice continuation
.          IF        IBCNUGST=2 & PTCNINVB=1
.            PRINT     *13,"Non-Banked deposits",*122,NBNKDEPS
.          ELSE
.            PRINT     *13,"Non-Banked deposits",*68,NBNKDEPS
.          ENDIF
.          ADD       NBNKDEPS,PINVPAID
.          ADD       PINVPAID,PINVTOT
.
REPRNT80  CALL      PCRDN000                * Print credit note before cash
          PACK      PMLINE1 WITH SP30,SP30,SP5
          PACK      PMLINE2 WITH SP30,SP30,SP5
          MOVE      SAVMESS,KEY3
          CALL      RDMESG1                 * read the message file
          CALL      PRITL000                * print the invoice tail
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            PACK      SELPRINT,Z70
          ENDIF
          CALL      CLSPRINT
          MATCH     "1",PRINTPDF
          IF        @EQUAL
            CALL      NEWCOR00
            BRANCH    EXIT,REPRNT99
          ENDIF
.
          CALL      LADV0000                * Print Lodgement Advice - PCS
          CALL      LADW0000                * Print Lodgement Advice - PCIW
          CALL      DB4F0000                * DB4 Form DBS
          CALL      DB4W0000                * DB4 Form BBSW
.
          MOVE      ZERO,EXIT
          GOTO      REPRNT99
.
REPRNT90  MOVE      ONE,EXIT
          GOTO      REPRNT99
.
REPRNT92  MOVE     "Invoice Header/Tail Template Not Setup. ",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      REPRNT99
.
REPRNT99  RETURN
+
.------------------------------------------------------------------------------
.         Generating a Lodgement of Advice         
.------------------------------------------------------------------------------
LADV0000  MATCH     "1",PTCNUESF
          GOTO      LADV9999 IF NOT EQUAL     * Not using store and forward
.
          MATCH     SP70,PRHRTACC
          GOTO      LADV9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LADV9999            * Invalid code
.
          MATCH     "5",TCINDC1
          GOTO      LADV9999 IF NOT EQUAL
.
          MOVE      "IBAADT26",SCHDPGID
          MOVE      "Generating a Lodgement of Advice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "2",KEYSTARR[1]          * 2 for Private Practice
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
LADV9999  RETURN
+
.------------------------------------------------------------------------------
.         Generating DB4 Form
.------------------------------------------------------------------------------
DB4F0000  MATCH     "1",PTCNUEBB
          GOTO      DB4F9999 IF NOT EQUAL     * Not using Eclipse Bulk billing
.
          MATCH     SP70,PRHRTACC
          GOTO      DB4F9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4F9999            * Invalid code
.
          MATCH     "3",TCINDC1
          GOTO      DB4F9999 IF NOT EQUAL     * not Bulk billing
.
          MOVE      "IBAADT16",SCHDPGID
          MOVE      "Generating DB4 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "2",KEYSTARR[1]          * 2 for Private practice
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
DB4F9999  RETURN
+
.------------------------------------------------------------------------------
.         Generating D1217 Form
.------------------------------------------------------------------------------
D1217000  MATCH     "1",PTCNDVAW
          GOTO      D1217999 IF NOT EQUAL     * Not using Eclipse Bulk billing
.
          MATCH     SP70,PRHRTACC
          GOTO      D1217999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1217999            * Invalid code
.
          MATCH     "8",TCINDC1
          GOTO      D1217999 IF NOT EQUAL     * not DVAW
.
          MOVE      "IBAWEB17",SCHDPGID
          MOVE      "Generating WebServices D1217 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
D1217999  RETURN
+
.------------------------------------------------------------------------------
.         Generating D1216S Form
.------------------------------------------------------------------------------
D1216S00  MATCH     "1",PTCNDVAW
          GOTO      D1216S99 IF NOT EQUAL     * Not using Eclipse Bulk billing
.
          MATCH     SP70,PRHRTACC
          GOTO      D1216S99 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,D1216S99            * Invalid code
.
          MATCH     "8",TCINDC1
          GOTO      D1216S99 IF NOT EQUAL     * not DVAW
.
          MOVE      "IBAWEB18",SCHDPGID
          MOVE      "Generating WebServices D1216S Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "1",KEYSTARR[1]          * 1 for Outpatient
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
D1216S99  RETURN
+
.------------------------------------------------------------------------------
.         Get Patient Indicator from DTR file
.------------------------------------------------------------------------------
GIND0000  MOVE      SP70,TMPPIND
          PACK      KEY24,VDEBTOR,VSCANPMI,PRINNUMB,SP6
          CALL      RSPRDT3                 * position on the debtors
GIND1000  CALL      RKPRDT3
          BRANCH    OVRCD,GIND9999
.
          MATCH     VDEBTOR,PRDTDEBT        * compare debtors
          GOTO      GIND9999 IF NOT EQUAL
.
          COMPARE   VSCANPMI,PRDTSCAN       * compare scan flags
          GOTO      GIND9999 IF NOT EQUAL
.
          MATCH     PRINNUMB,PRDTINVN       * match invoice numbers
          GOTO      GIND9999 IF NOT EQUAL
.
          COMPARE   ONE,PRDTRTYP
          GOTO      GIND1000 IF NOT EQUAL   * not an Item Transaction recordtype
.
          MOVE      PRDTCODE,TMPPIND
GIND9999  RETURN
+
.------------------------------------------------------------------------------
.         Print credit note line for re-print invoice
.------------------------------------------------------------------------------
PCRDN000  BRANCH    FLAGBULK,PCRDN999       * skip if bulk billing the patient
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,FORM122
          MOVE      ZERO,CREDTOT
          OPEN      PRICNOA3,"pricnoaf"
          PACK      KEY16,PRINNUMB,SP70
          CALL      RSPRCNO3
PCRDN100  CALL      RKPRCNO3
          BRANCH    OVRCD,PCRDN200
          MATCH     PRINNUMB,PRCOINVN
          GOTO      PCRDN200 IF NOT EQUAL
.
          ADD       PRCOAMNT,FORM12P2     * Total credit
          SUB       PRCOGSTM,FORM12P2     * exclude GST
          ADD       PRCOGSTM,FORM122     * Total GST
          GOTO      PCRDN100
.
PCRDN200  MOVE      FORM12P2,CREDTOT
          ADD       FORM122,CREDTOT
          COMPARE   ZERO,CREDTOT
          GOTO      PCRDN999 IF EQUAL   * No credit note
.
          CALL      CNTIV000                * check for invoice continuation
          IF        PRCNLAYT=2
            PRINT     *23,"Credit Note":    * Cabrini
                      *N,*64,CREDTOT
            ADD       ONE,VLINENO
            GOTO      PCRDN300
          ELSE
            PRINT     *12,"Credit Note";
          ENDIF
.
          IF        IBCNUGST=2 & PTCNINVB=1
            MOVE      CREDTOT,FORM8P2
            PRINT     *122,FORM8P2
            GOTO      PCRDN300
          ENDIF
          IF        PRCNLAYT=1
            MOVE      CREDTOT,FORM7P2
            PRINT     *68,FORM7P2
          ELSE
            IF        PRCNLAYT=0 | PRCNLAYT=2 | PRCNLAYT=4 | PRCNLAYT=5
              MOVE      CREDTOT,FORM8P2
              PRINT     *68,FORM8P2
            ELSE
              PRINT     *68,CREDTOT
            ENDIF
          ENDIF
.
PCRDN300  ADD       CREDTOT,PINVTOT
          ADD       ONE,VLINENO
PCRDN999  RETURN
+
.**********************************************************************
.*                              PRCRD000                              *
.*            Routine to print Credit note                            *
.**********************************************************************
PRCRD000  MOVE      ONE,VSCANPMI
          MOVE      URNUMBER,VDEBTOR
          MOVE      ZERO,FLAGBULK
          MOVE      ONE,WEBFLAG
          MOVE      ONE,CRDNFLAG            * Printing Credit note
          MOVE      ZERO,NBNKDEPS
          MOVE      ZERO,CURRDEP
          MOVE      "9",TMPGSTA
.
          CALL      SINVH000                     * check for template header
          BRANCH    EXIT,PRCRD980
          CALL      SINVT000                     * check for template tail
          BRANCH    EXIT,PRCRD980
.
          MOVE      CREDNUMB,KEY8
          CALL      RDPRCNO1
          BRANCH    OVRCD,PRCRD999
.
          MOVE      PRCOINVN,PRCNINVN
.
          MOVE      PRCOINVN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PRCRD999
.
          MOVE      PRINNUMB,PRCNINVN
          MOVE      "Error - invalid practice",PRPRDESC
          MOVE      PRINPRAC,KEY6
          CALL      RDPRPR1                 * read the practice file
.
          UNPACK    SP70,VSVDCNAM,VSVDPROV,PRIMTYPE
          PACK      KEY10,PRINDOCT,SP10
          CALL      RDPMHCP1                * read the doctors file
          BRANCH    OVRCD,PRCRD010
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME                 * pack the doctors name
          MOVE      PACFNAME,VSVDCNAM
          MOVE      PMHCPRV1,VSVDPROV
.
          MATCH     SP3,PMHCSPC1            * see if the doctors type exists
          GOTO      PRCRD010 IF EQUAL
.
          PACK      KEY5,CODEDT,PMHCSPC1
          CALL      RDCODE1                 * read the patient codes file
          BRANCH    OVRCD,PRCRD010
          MOVE      TDESC,PRIMTYPE
.
PRCRD010  COMPARE   ZERO,PRPRTIME           * see if we want the service time
          GOTO      PRCRD020 IF EQUAL         on the invoice
          CALL      GETS0000                * Get service time
.
.------ get the claim code details if they exist ------
.
PRCRD020  CALL      GETC0000                * get the claim code details if
.                                             they exist
          CALL      OPNPRINT
          MOVE      ZERO,HEADFLAG
.
          CALL      CIND0000                * Get default patient indicator
.
          OPEN      PRIFCIA3,"prifciaf"
          PACK      KEY33,PRCOCRNO,VDEBTOR,VSCANPMI,SP70
          CALL      RSPRFCI3
PRCRD100  CALL      RKPRFCI3
          BRANCH    OVRCD,PRCRD900
.
          MATCH     PRFCCRNO,PRCOCRNO
          GOTO      PRCRD900 IF NOT EQUAL
          MATCH     VDEBTOR,PRFCDEBT
          GOTO      PRCRD900 IF NOT EQUAL
          MATCH     " 1",PRFCSCAN
          GOTO      PRCRD900 IF NOT EQUAL
.
          IF        HEADFLAG=0
            MOVE      PRINCLAM,TMPCLAIM
            CALL      PIHED000                * print the invoice header
            MOVE      ONE,HEADFLAG
          ENDIF
.
.------ set up the details to be printed ------
.
          PACK      KEY20,PRFCDESC
          UNPACK    PRFCTRDT,CCENT,CYEAR,CMON,CDAY
          PRINT     *3,CDAY,SLASH,CMON,SLASH,CYEAR:
                    *12,KEY20;
.
          MOVE      ZERO,FORM12P2
          MOVE      PRFCCAMT,FORM12P2
          ADD       PRFCCGST,FORM12P2
          MOVE      FORM12P2,FORM8P2
.
          MOVE      PRFCCAMT,CREDTOT
          MOVE      PRFCCGST,FORM7P2
          IF        IBCNUGST=2
            IF        PTCNINVB=1
              PRINT     *95,CREDTOT:
                        *106,FORM7P2,*122,FORM8P2
            ELSE
              PRINT     *36,CREDTOT,*49,FORM7P2,*68,FORM8P2
            ENDIF
          ELSE
            PRINT     *68,PRFCCAMT
          ENDIF
.
          ADD       FORM12P2,PINVTOT
.
          ADD       PRFCGAMT,GSTTOTAL
          ADD       ONE,VLINENO
          CALL      CNTIV000                * check for invoice continuation
          GOTO      PRCRD100
.
.         Print Reason fo Credit note description
.
PRCRD900  MATCH     SP3,PRCOREAS
          GOTO      PRCRD920 IF EQUAL     * No reason for credit note
          MOVE      "BX",TCODE
          PACK      KEY5,TCODE,PRCOREAS
          CALL      RDCODE1
          BRANCH    OVRCD,PRCRD920
          PACK      KEY16,TDESC,SP20
.
          PRINT     *12,"REASON:",KEY16
          ADD       ONE,VLINENO
.
PRCRD920  MOVE      PINVTOT,PRINITOT        * Credit total
          CALL      PRITL000                * print the invoice tail
          MOVE      ZERO,CRDNFLAG
          CALL      CLSPRINT
          GOTO      PRCRD999
.
PRCRD980  MOVE     "Invoice Header/Tail Template Not Setup. ",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      PRCRD999
.
PRCRD999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient indicator for Credit Notes
.-------------------------------------------------------------------------------
CIND0000  MOVE      SP70,TMPPIND
          OPEN      PRIFCIA3,"prifciaf"
          PACK      KEY33,PRCOCRNO,VDEBTOR,VSCANPMI,SP70
          CALL      RSPRFCI3
CIND1000  CALL      RKPRFCI3
          BRANCH    OVRCD,CIND9999
.
          MATCH     PRFCCRNO,PRCOCRNO
          GOTO      CIND9999 IF NOT EQUAL
          MATCH     VDEBTOR,PRFCDEBT
          GOTO      CIND9999 IF NOT EQUAL
          MATCH     " 1",PRFCSCAN
          GOTO      CIND9999 IF NOT EQUAL
.
          MOVE      PRFCPIND,TMPPIND
CIND9999  RETURN
+
.-------------------------------------------------------------------------------
. Add MBS items
.-------------------------------------------------------------------------------
ADDMBS00  MOVE      ZERO,EXIT
          MOVE      ONE,VSCANPMI    * PMI UR number
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    REDIREC2,REDIRECT
          RESET     REDIRECT
.
          MATCH     "004",TEMPLATE
          GOTO      ADDMBS90 IF EQUAL     * GST allocation and S4B3 Exemption
.
          PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,ADDMBS91
.
          MOVE      PRHDDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ADDMBS94
          MOVE      PURNO,URNUMBER
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      ADDMBS90 IF EQUAL
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,ADDMBS91
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      ADDMBS10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      ADDMBS20 IF EQUAL
.
          MATCH     "L",UPDTTYPE    * Load items
          GOTO      ADDMBS30 IF EQUAL
.
          MATCH     "S",UPDTTYPE    * Add item to tempfile
          GOTO      ADDMBS40 IF EQUAL
.
          MATCH     "T",UPDTTYPE    * Update date item in tempfile
          GOTO      ADDMBS45 IF EQUAL
.
          MATCH     "E",UPDTTYPE    * Cancel delete items from tempfile
          GOTO      ADDMBS48 IF EQUAL
.
          MATCH     "C",UPDTTYPE    * Change item to tempfile
          GOTO      ADDMBS50 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update item to tempfile
          GOTO      ADDMBS60 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remove item in tempfile
          GOTO      ADDMBS62 IF EQUAL
.
          MATCH     "Z",UPDTTYPE    * Add items to patient
          GOTO      ADDMBS70 IF EQUAL
          GOTO      ADDMBS99
.
.         ************ ADD FORMACTION ***********
.
ADDMBS10  CALL      ADDITM00        * Add items
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
.         ************ DELETE FORMACTION ***********
.
ADDMBS20  CALL      DELITM00        * Delete item
          BRANCH    OVRCD,ADDMBS95
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS30  CALL      DETMP000              * Delete items from tempfile
          CALL      LOADIT00              * load items to tempfile
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS40  CALL      CPITM000              * Copy item to tempfile
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS45  CALL      CHTIM000              * Change item time in tempfile
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS48  CALL      DETMP000              * Cancel delete items from tempfile
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
.         Read the selected item from tempfile
.
ADDMBS50  PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,ITEMNUMB,SP70
          CALL      RDPRTMP1
          BRANCH    OVRCD,ADDMBS92
.
          MOVE      PRTMDATE,PRITM001
          MOVE      PRTMTIME,PRITM002
          MOVE      PRTMITYP,PRITM003
          MOVE      PRTMITEM,PRITM004
          MOVE      PRTMSUBI,PRITM005
          MOVE      PRTMDESC,PRITM006
          MOVE      PRTMQUNT,PRITM007
          MOVE      PRTMCAMT,PRITM008
          MOVE      PRTMGSTA,PRITM009
          MOVE      PRTMGSTC,PRITM010
          MOVE      PRTMIAMT,PRITM011
          MOVE      PRTMTEST,PRITM012
          MOVE      PRTMS4FL,PRITM013
          GOTO      ADDMBS90
.
.         Update tempfile file
.
ADDMBS60  PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,ITEMNUMB,SP70
          CALL      RDPRTMP1
          BRANCH    OVRCD,ADDMBS92
.
          MOVE      PRITM001,PRTMDATE
          MOVE      PRITM002,PRTMTIME
          MOVE      PRITM003,PRTMITYP
          MOVE      PRITM004,PRTMITEM
          MOVE      PRITM005,PRTMSUBI
          MOVE      PRITM006,PRTMDESC
          MOVE      PRITM007,PRTMQUNT
          MOVE      PRITM008,PRTMCAMT
          MOVE      PRITM009,PRTMGSTA
          MOVE      PRITM010,PRTMGSTC
          MOVE      PRITM011,PRTMIAMT
          MOVE      PRITM012,PRTMTEST
          MOVE      PRITM013,PRTMS4FL
          CALL      UPPRTMP1
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS62  CALL      DTMPR000              * Remove item from tempfile
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
.         Write away the items
.
ADDMBS70  CALL      TMPARR00        * Copy records from tempfile to array vars
          CALL      ADDITM00        * Add items from array vars to holding file
          MOVE      ZERO,EXIT
          GOTO      ADDMBS99
.
ADDMBS90  MOVE      ZERO,LASTITEM
          MOVE      "Input MBS items",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create output & write HTML Header
          BRANCH    EXIT,ADDMBS99
.
          CALL      WEBBOD00                * Process Web body
          CALL      WEBEND00                * Process end of HTML file
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS91  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS92  MOVE      "Invalid Item.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS93  MOVE      "Time must be entered.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS94  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS95  CLEAR     WEBTITLE
          APPEND    "Invalid item Key, Item Not Removed.",WEBTITLE
          APPEND    KEY62,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDMBS99
.
ADDMBS99  RETURN
+
.***************************************************************************
.*                              ACCSTA00                                   *
.*     Account status update                                               *
.***************************************************************************
ACCSTA00  MOVE      ZERO,EXIT
          MOVE      ONE,VSCANPMI    * PMI UR number
.
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      ACCSTA10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * update account status
          GOTO      ACCSTA20 IF EQUAL
          MATCH     "J",UPDTTYPE    * update journal
          GOTO      ACCSTA30 IF EQUAL
          MATCH     "T",UPDTTYPE    * Transfer Payment
          GOTO      ACCSTA40 IF EQUAL
          GOTO      ACCSTA99
.
ACCSTA10  MOVE      ZERO,PRHOHOLD       * Default to Normal
          MOVE      ONE,VSCANPMI        * PMI UR number
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ACCSTA91
.
          MOVE      URNUMBER,PRHODEBT
          MOVE      VSCANPMI,PRHOSCAN
          PACK      KEY10,PRHODEBT,PRHOSCAN
          CALL      RDPRHO1
          IF        OVRCD=1
            MOVE      ZERO,PRHOHOLD     * Set Account flag to Normal
          ENDIF
.
          COMPARE   ZERO,INVOICEN
          GOTO      ACCSTA90 IF EQUAL
.
          MOVE      ONE,VSCANPMI        * PMI UR number
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
.
          GOTO      ACCSTA90
.
ACCSTA20  MOVE      URNUMBER,PRHODEBT
          MOVE      " 1",PRHOSCAN
          PACK      KEY10,PRHODEBT,PRHOSCAN
          CALL      RDPRHO1
          IF        OVRCD=0
            MOVE      PRHOL001,PRHOHOLD
            CALL      UPPRHO1          * Account not on hold, delete record
          ELSE
            MOVE      PRHOL001,PRHOHOLD
            PACK      PRHOSPAR,SP70
            CALL      WRPRHO1          * write record for account on hold
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      ACCSTA99
.
.         Journal
.
ACCSTA30  CALL      IBACLOCK
          MATCH     SP70,JOURDATE
          IF        @EQUAL
            PACK      JOURDATE,CCC,CYY,CMM,CDD
            REP       " 0",JOURDATE
          ENDIF
          COMPARE   ZERO,INVOICEN
          GOTO      ACCSTA92 IF EQUAL
.
          MOVE      ONE,VSCANPMI        * PMI UR number
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,ACCSTA92
.
          MOVE      PRINDEBT,URNUMBER
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ACCSTA91
.
          MATCH     SP70,JOURITEM
          GOTO      ACCSTA99 IF EQUAL
.
          PACK      KEY5,CODEJ,JOURITEM
          CALL      RDCODE1
          BRANCH    OVRCD,ACCSTA99
          IF        JOURAMTT=0
            GOTO      ACCSTA94
          ENDIF
.
          CALL      AUDJ0000            * Open journal audit
          BRANCH    EXIT,ACCSTA99
.
          CALL      UPJR0000            * Update Journal files
          BRANCH    EXIT,ACCSTA99,ACCSTA93
.
          MOVE      ZERO,EXIT
          GOTO      ACCSTA99
.
.         Transfer payment
.
ACCSTA40  CALL      TRNPAY00            * Transfer paymente
          BRANCH    EXIT,TRNPAY99
.
          MOVE      ZERO,EXIT
          GOTO      ACCSTA99
.
ACCSTA90  MOVE      ZERO,LASTITEM
          MOVE      "Private Practice Invoice",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00                * Create output & write HTML Header
          BRANCH    EXIT,ACCSTA99
.
          CALL      WEBBOD00                * Process Web body
          CALL      WEBEND00                * Process end of HTML file
          MOVE      ONE,EXIT
          GOTO      ACCSTA99
.
ACCSTA91  MOVE      "Missing U/R details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACCSTA99
.
ACCSTA92  MOVE      "Invalid Invoice.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACCSTA99
.
ACCSTA93  MOVE      "Date Range not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACCSTA99
.
ACCSTA94  MOVE      "No Adjustment Amount Specified",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACCSTA99
.
ACCSTA99  CLOSE     PRIAUJXX,DELETE    * Delete temp file created by AUDJ0000
          RETURN
+
.**********************************************************************
.         Open journal audit
.**********************************************************************
AUDJ0000  CALL      TFILENAM
          MOVE      TFILNAME,FNAMEJ
.
.         CLEAR     FNAMEJ
.         APPEND    "priauj",FNAMEJ
.         APPEND    PORT,FNAMEJ
.         RESET     FNAMEJ
.         REP       " 0",FNAMEJ
.
          TRAP      AUDJ2000 IF IO
          OPEN      PRIAUJXX,FNAMEJ
          TRAPCLR   IO
.
          MOVE      "PRJ",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
          CALL      RDSAUDJ
          COMPARE   TWO,AJSTAT
          GOTO      AUDJ1000 IF NOT EQUAL
.
          CALL      RELSLK00        * Release System Lock Audits
          CLEAR     WEBTITLE
          APPEND    "Audit file is Busy. ",WEBTITLE
          APPEND    "Please wait until Audit Listing is Complete",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      AUDJ9999
.
AUDJ1000  MOVE      ONE,AJSTAT
          CALL      WRSAUDJX
          CALL      RELSLK00        * Release System Lock Audits
          GOTO      AUDJ5000
.
AUDJ2000  NORETURN
          PREP      PRIAUJXX,FNAMEJ
          MOVE      ONE,AJSTAT
          CALL      WRSAUDJ

AUDJ5000  MOVE      "HD",AJRECCD                 * set up audit header record
          MOVE      ZERO,AJBATCH
          MOVE      ZERO,AJBATOT
          MOVE      "JOURNALS            ",AJDESC
          MOVE      PASSCODE,AJOPER
          MOVE      SP8,AJDEBT
          MOVE      SP30,AJNAME
          PACK      AJDATE,CCC,CYY,CMM,CDD
          REP       " 0",AJDATE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,AJTIME
          MOVE      SP8,AJINVNO
          MOVE      ZERO,AJAMT
          MOVE      SP3,AJTYPE
          MOVE      SP30,AJTDESC
          MOVE      ZERO,AJSCAN
.
          CALL      UPAUDJ                       * write audit header record
          MOVE      SECTOR TO HEADSEC
          MOVE      ZERO,EXIT
.
AUDJ9999  RETURN
+
.**********************************************************************
.         Update Journal files
.**********************************************************************
UPJR0000  MOVE      ZERO,EXIT
          CALL      CLPRIDTR
.
          MATCH     SP70,JOURDESC
          IF        @EQUAL
            MOVE      TDESC,PRDTDESC
          ELSE
            MOVE      JOURDESC,PRDTDESC
          ENDIF
.
          MOVE      THCSCOD,JTYPE
          MATCH     ANSR,JTYPE
          GOTO      UPJR1000 IF NOT EQUAL
          MOVE      ZERO,PRDTAMNT       * Rebate journals set to 0
          GOTO      UPJR2000
.
UPJR1000  MATCH     ANSG,JTYPE
          GOTO      UPJR1200 IF NOT EQUAL
.
          MOVE      ZERO,PRDTAMNT
          MOVE      JOURAMTT,PRDTGSTM
          MULT      SEQ,PRDTGSTM         * store as negative amount
          GOTO      UPJR2000
.
UPJR1200  MOVE      JOURAMTT,PRDTAMNT
          MULT      SEQ,PRDTAMNT         * store as negative amount
.
          MATCH     ANSA,JTYPE
          IF        @EQUAL
            MULT      SEQ,PRDTAMNT       * reverse sign for adjustment journal
          ENDIF
.
UPJR2000  ADD       PRDTGSTM,PRINGSTJ
          ADD       PRDTAMNT,PRINJAMT
          ADD       PRDTAMNT,PRINPEND
.
UPJR2200  MOVE      PRINTRAN,NXTRAN              * get DTRAN number
          ADD       ONE,PRINTRAN                 * increment DTRAN number
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT             * date updated
          CLOCK     TIME,PRINUTIM             * time updated
          MOVE      USERID,PRINUUID           * web user id
          CALL      UPPRIN1                      * update invoice record
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP                * Flag PMI Outstanding Debt
          ENDIF
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE                  * Update Un-reconciled inv.file
.
          GOTO      UPJR3000
.
. ------- Write the DTR record ----------------
.         Make sure transaction not already on file
.
UPJR3000  PACK      KEY22,PRINUNIQ,INVOICEN,NXTRAN
          CALL      RAPRDT1
          IF        OVRCD=0
            MOVE      INVOICEN,KEY8
            CALL      RDPRIN1
            BRANCH    OVRCD,UPJR9999
            GOTO      UPJR2200        * Transaction # on file, get next trans. #
          ENDIF

          MOVE      URNUMBER,PRDTDEBT             * load file variables
          MOVE      ONE,PRDTSCAN
          MOVE      JOURDATE,PRDTSDAT
          MOVE      PRINPRAC,PRDTPRAC
          MOVE      PRINDOCT,PRDTDOCT
          MOVE      ONE,PRDTSERV
          PACK      PRDTREFT,SP30,SP20
          MOVE      PRINCLAM,PRDTCLAM
          MOVE      THREE,PRDTRTYP
          MOVE      JOURITEM,PRDTTTYP
          MOVE      ONE,PRDTINVP
          MOVE      GSTCODES,PRDTGSTC
          MOVE      PRDTSDAT,PRDTEFFD
.
          PACK      KEY22,PRINUNIQ,INVOICEN,NXTRAN,SP70
          CALL      WRPRDT1                      * write DTR record
.
          CALL      CBAL0000                     * Check if invoice now balanced
.
          PACK      KEY22,PRINUNIQ,INVOICEN,NXTRAN,SP70
          CALL      RDPRDT1                      * Re read DTR record
.
. ------- Write journal audit record ---------------
.
          MOVE      "ZZ",AJRECCD
          MOVE      SP8,AJBATCH
          MOVE      ZERO,AJBATOT
          MOVE      SP20,AJDESC
          MOVE      SP4,AJOPER
          MOVE      URNUMBER,AJDEBT
          MOVE      PGNAME,ANS                   * format name
          PACK      AJNAME,ANS,DOT,PSNAME
          MOVE      PRDTSDAT,AJDATE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,AJTIME
          MOVE      PRINNUMB,AJINVNO
          MOVE      JOURAMTT,AJAMT
          MOVE      PRDTTTYP,AJTYPE
          MOVE      PRDTDESC,AJTDESC
          MOVE      PRDTSCAN,AJSCAN
.
          CALL      UPAUDJ
.
. ------- Write the journal record -----------------
.
          MOVE      SP4,PRJRSPAR
          PACK      KEY35,JOURITEM,JOURDATE,URNUMBER,PRDTSCAN,NXTRAN,INVOICEN
          CALL      WRPRJR1
.
.         If bad debt journal, update patient record
.
          CMATCH    ANSB,JTYPE                   * bad debt journal ?
          GOTO      UPJR4000 IF NOT EQUAL        * no
          MOVE      URNUMBER,KEY8
          CALL      RLPTMAS1                     * get PMI record
          BRANCH    OVRCD,UPJR4000               * not found
          MOVE      ONE,PBDEBT                   * set bad debt flag
          CALL      UPMAST1
          CALL      UUPTMAS1
.
. ------- Update financial summary file ------------
.
UPJR4000  MOVE      ANSC,PRFNTYPE                * set financial type - journals
          IF        PRCNAFEE=1
            PACK      PRFNCODE,PRDTDOCT,PRDTTTYP,SP30
          ELSE
            PACK      PRFNCODE,PRDTTTYP,SP30
          ENDIF
          MOVE      PRDTPRAC,PRFNMPRA
          UNPACK    PRDTSDAT,XCENT,XYEAR,XMON,XDAY
          PACK      FSTDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",FSTDATE
.
          MATCH     ANSG,JTYPE
          IF        @EQUAL
            MOVE      PRDTGSTM,FSTAMNT
            MULT      SEQ,FSTAMNT                  * reverse sign for fees
            MOVE      ONE,FGSTFLAG
            CALL      PRICALFS
          ELSE
            MOVE      PRDTAMNT,FSTAMNT
            MULT      SEQ,FSTAMNT                  * reverse sign for fees
            MOVE      ZERO,FGSTFLAG
            CALL      PRICALFS
          ENDIF
          BRANCH    EXIT,UPJR9100                * date range not found
.
. ------- Update stats file ------------------------
.
.         Get the period from the date range period file
.
          MOVE      DRGNUM,PERNUM
.
          MOVE      PRINPRAC,PRSTPRAC
          MOVE      PRINDOCT,PRSTDOCT
          PACK      KEY20,PRFNYEAR,PRSTPRAC,PRSTDOCT
          CALL      RDPRST1                      * record exists ?
          BRANCH    OVRCD,UPJR5000               * no
.
.         Update the existing journal amount for the appropriate period
.
          LOAD      JNLAMNT,PERNUM,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04,PRSTJP05:
                    PRSTJP06,PRSTJP07,PRSTJP08,PRSTJP09,PRSTJP10,PRSTJP11:
                    PRSTJP12,PRSTJP13
.
          ADD       PRDTAMNT,JNLAMNT             * add journal trax. amount
          ADD       PRDTGSTM,JNLAMNT
.
          STORE     JNLAMNT,PERNUM,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04,PRSTJP05:
                    PRSTJP06,PRSTJP07,PRSTJP08,PRSTJP09,PRSTJP10,PRSTJP11:
                    PRSTJP12,PRSTJP13
.
          CALL      UPPRST1
          GOTO      UPJR9999
.
.         Statistics record not found - so create one
.
UPJR5000  MOVE      ZERO,FORM2                   * initialise counter
UPJR5200  ADD       ONE,FORM2                    * increment counter
.
          COMPARE   FORM2,FORTY                  * all fields initialised ?
          GOTO      UPJR6000 IF LESS             * yes
.
          STORE     ZERO,FORM2,PRSTOBAL,PRSTIP01,PRSTIP02,PRSTIP03,PRSTIP04:
                    PRSTIP05,PRSTIP06,PRSTIP07,PRSTIP08,PRSTIP09,PRSTIP10:
                    PRSTIP11,PRSTIP12,PRSTIP13,PRSTCP01,PRSTCP02,PRSTCP03:
                    PRSTCP04,PRSTCP05,PRSTCP06,PRSTCP07,PRSTCP08,PRSTCP09:
                    PRSTCP10,PRSTCP11,PRSTCP12,PRSTCP13,PRSTJP01,PRSTJP02:
                    PRSTJP03,PRSTJP04,PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                    PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
          GOTO      UPJR5200
.
UPJR6000  MOVE      SP20,PRSTSPAR
.
          ADD       PRDTAMNT,JNLAMNT             * add journal trax. amount
          ADD       PRDTGSTM,JNLAMNT
.
          STORE     JNLAMNT,PERNUM,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04,PRSTJP05:
                    PRSTJP06,PRSTJP07,PRSTJP08,PRSTJP09,PRSTJP10,PRSTJP11:
                    PRSTJP12,PRSTJP13
          CALL      WRPRST1
          GOTO      UPJR9999
.
UPJR9100  MOVE      TWO,EXIT
UPJR9999  RETURN
+
.**************************************************************************
. CBAL0000 : Check if invoice is balance
.**************************************************************************
CBAL0000  MOVE      PRINITOT,FORM12P2
          ADD       PRINPAMT,FORM12P2
          ADD       PRINHAMT,FORM12P2
          ADD       PRINIAMT,FORM12P2
          ADD       PRINMAMT,FORM12P2
          ADD       PRINVAMT,FORM12P2
          ADD       PRINOTHA,FORM12P2
          ADD       PRINJAMT,FORM12P2
.
          COMPARE   ZERO,FORM12P2
          GOTO      CBAL9999 IF NOT EQUAL       * invoice not balanced
.
          PACK      KEY22,PRINUNIQ,PRINNUMB,SP20
          CALL      RSPRDT1
CBAL1000  CALL      RKPRDT1
          BRANCH    OVRCD,CBAL9999
.
          COMPARE   PRINUNIQ,PRDTUNIQ
          GOTO      CBAL9999 IF NOT EQUAL       * different unique number
.
          MATCH     PRINNUMB,PRDTINVN
          GOTO      CBAL9999 IF NOT EQUAL       * different invoice number
.
.         COMPARE   ONE,PRDTAPAY
.         GOTO      CBAL9999 IF NOT EQUAL       * accounts payable not set
.
          BRANCH    PRDTRTYP,CBAL2000,CBAL1000,CBAL2000  * only item & journal
.
CBAL2000  MOVE      TWO,PRDTAPAY                * accounts payable flag- balance
          CALL      UPPRDT1
          GOTO      CBAL1000
.
CBAL9999  RETURN
+
.------------------------------------------------------------
.         Transfer payment
.------------------------------------------------------------
TRNPAY00  COMPARE   ZERO,INVOICEN
          GOTO      TRNPAY90 IF EQUAL
.
          MOVE      INVOICEN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,TRNPAY90             * invalid invoice number
.
          MOVE      PRINDEBT,URNUMBER
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,TRNPAY91             * missing master record
          CALL      RDPMPX21
          BRANCH    OVRCD,TRNPAY91
.
          MATCH     SP70,PRCNCJRN              * Check Cash transfer Jrnl code
          GOTO      TRNPAY92 IF EQUAL          * Not setup yet
.
          MOVE      PRCNCJRN,JOURITEM
          PACK      KEY5,CODEJ,JOURITEM
          CALL      RDCODE1
          BRANCH    OVRCD,TRNPAY92             * Invalid journal code
.
          CALL      IBACLOCK
          MATCH     SP70,JOURDATE
          IF        @EQUAL
            PACK      JOURDATE,CCC,CYY,CMM,CDD
            REP       " 0",JOURDATE
          ENDIF
.
          CALL      AUDJ0000                   * open Journal audit
          BRANCH    EXIT,TRNPAY99
.
          MOVE      INVOICEN,KEY8          * Invoice number transfer from
          CALL      RDPRIN1
          BRANCH    OVRCD,TRNPAY99
.
          MOVE      SP70,JOURDESC
          MOVE      JOURPATT,JOURAMTT
          CALL      UPJR0000            * Update Journal files
.
          MOVE      TINVOICE,KEY8       * Invoice number transfer to
          CALL      RDPRIN1
          BRANCH    OVRCD,TRNPAY99
.
          MOVE      TINVOICE,INVOICEN
          CLEAR     JOURDESC
          APPEND    "FROM:",JOURDESC
          APPEND    TDESC,JOURDESC
          APPEND    SP70,JOURDESC
          RESET     JOURDESC            * Journal description for DTR
          MOVE      JOURPATT,JOURAMTT
          MULT      "-1",JOURAMTT
          CALL      UPJR0000            * Update Journal files
.
          MOVE      ZERO,EXIT
          GOTO      TRNPAY99
.
TRNPAY90  CLEAR     WEBTITLE
          APPEND    "Invalid Invoice Number : ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNPAY99
.
TRNPAY91  MOVE      "Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNPAY99
.
TRNPAY92  CLEAR     WEBTITLE
          APPEND    "Invalid Journal Code for Trans.Overpayment - ",WEBTITLE
          APPEND    PRCNCJRN,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNPAY99
.
TRNPAY99  CLOSE     PRIAUJXX,DELETE    * Delete temp file created by AUDJ0000
          RETURN
+
.**********************************************************************
.        Copy items from tempfile to array variables
.**********************************************************************
TMPARR00  MOVE      ZERO,LASTITEM
          MOVE      ZERO,F3
          PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RSPRTMP1
TMPARR10  CALL      RKPRTMP1
          BRANCH    OVRCD,TMPARR90
.
          MATCH     DPRHRUNQ,PRTMUNIQ
          GOTO      TMPARR90 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRTMPRAC
          GOTO      TMPARR90 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRTMDOCT
          GOTO      TMPARR90 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRTMPIND
          GOTO      TMPARR90 IF NOT EQUAL
.
          ADD       ONE,F3
          MOVE      PRTMCNTR,LASTITEM
          MOVE      PRTMDATE,MDATE[F3]
          MOVE      PRTMTIME,MTIME[F3]
          MOVE      PRTMITYP,ITYPE[F3]
          MOVE      PRTMITEM,ITEMN[F3]
          MOVE      PRTMSUBI,SUBIT[F3]
          MOVE      PRTMDESC,DESCP[F3]
          MOVE      PRTMTEST,TESTC[F3]
          MOVE      PRTMS4FL,S4FLG[F3]
          MOVE      PRTMGSTA,GSTAP[F3]
          MOVE      PRTMGSTC,GSTCD[F3]
          MOVE      PRTMQUNT,QUNTY[F3]
          MOVE      PRTMCAMT,CAMNT[F3]
          MOVE      PRTMIAMT,IAMNT[F3]
          GOTO      TMPARR10
TMPARR90  CALL      DETMP000
TMPARR99  RETURN
+
.**********************************************************************
.        Add items
.**********************************************************************
ADDITM00  CALL      GTRN0000       * Get last trans number
          CALL      CLPRIHTR
.
          MOVE      ZERO,F2
          MOVE      ONE,F3
          WHILE     F3<=LASTITEM
.
            MATCH     ANSM,ITYPE[F3]
            IF        @EQUAL
              MOVE      ZERO,ITYPE[F3]      * M = MBS which is 0
            ENDIF
.
            MATCH     ANSA,ITYPE[F3]
            IF        @EQUAL
              MOVE      ONE,ITYPE[F3]       * A = AMA which is A
            ENDIF
.
            MOVE      ZERO,PRHTFLAG         * Clear form field
            MOVE      ITYPE[F3],PRHTFLAG
            MOVE      ITEMN[F3],PRHTITMN
            MOVE      SUBIT[F3],PRHTSUBN
            MOVE      MDATE[F3],PRHTDATE
.
            MATCH     SP9,PRHTITMN
            IF        !@EQUAL
....          CALL      CHKITM00         * Check for valid MBS/Misc.item number
....          BRANCH    EXIT,ADDITM99
.
              MOVE      PRHDUNIQ,PRHTUNIQ
              MOVE      PRHRE001,PRHTPRAC
              MOVE      PRHRE002,PRHTDOCT
              MOVE      PRHRE003,PRHTPIND
              MOVE      TRANSNO,PRHTNUMB
.
              MOVE      MTIME[F3],PRHTTIME
              MOVE      QUNTY[F3],PRHTSERN
              MOVE      TESTC[F3],PRHTPFLG
              MOVE      S4FLG[F3],PRHTS4B3
              MOVE      DESCP[F3],PRHTIDES
              MOVE      IAMNT[F3],PRHTIAMT
              MOVE      GSTAP[F3],PRHTGSTA
              MOVE      GSTCD[F3],PRHTGSTC
              MOVE      DURAT[F3],PRHTTDUR
              MOVE      ACOVR[F3],PRHTACOI
.
              IF        PRCNRDOC = 1
                MOVE      PRHTR005,PRHTREFD
                MOVE      PRHTR006,PRHTRDAT
                MOVE      PRHTR011,PRHTREFT
              ELSE
                MOVE      PRHRREFD,PRHTREFD
                MOVE      PRHRRDAT,PRHTRDAT
                MOVE      SP70,PRHTREFT
              ENDIF
              MOVE      PRHRRFPD,PRHTRFPD
              MOVE      SP10,PRHTMEDA
              MOVE      SP70,PRHTHICI
.
              MOVE      MULPR[F3],PRHTMPOV
              MOVE      DUPSR[F3],PRHTDSOV
              MOVE      SRVTX[F3],PRHTSTXT
              MOVE      HOSIN[F3],PRHTHOSI
              MOVE      ALTSP[F3],PRHTASPF
              MOVE      ALTSC[F3],PRHTASPC
.              MOVE      IFCCC[F3],PRHTAICF
              MOVE      IFCCV[F3],PRHTAICV
              MOVE      NUMPT[F3],PRHTNMPT
              MOVE      SLDMC[F3],PRHTSDCD
              MOVE      LSPNV[F3],PRHTLSPN
              MOVE      ROVRC[F3],PRHTROVC
              MOVE      ADMNO[F3],PRHTLVIS
              MOVE      DSKMS[F3],PRHTDSKM
.
              MOVE      SP70,PRHTROVR
              MOVE      SP70,PRHTSPAR
.
ADDITM40      PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                              PRHTRDAT,PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTNUMB
              CALL      RAPRHT1
              BRANCH    OVRCD,ADDITM60
.
              ADD       ONE,TRANSNO
              MOVE      TRANSNO,PRHTNUMB
              GOTO      ADDITM40
.
ADDITM60      CALL      WRPRHT1                      * write transaction record
              ADD       ONE,TRANSNO                  * next available trans no
              MOVE      ONE,F2
           ENDIF
            ADD       ONE,F3
          DO
.
.         Only update 'Invoice to be printed' field if item added
.
          COMPARE   ONE,F2
          GOTO      ADDITM99 IF NOT EQUAL
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          IF        OVRCD=0
            MOVE      ONE,PRHRPINV       * invoice to be printed
            CALL      UPPRHR1
          ENDIF
.
ADDITM99  RETURN
+
.**********************************************************************
.        Delete item
.**********************************************************************
DELITM00  MOVE      ZERO,FORM1
          PACK      KEY62,PRHTR001,PRHTR002,PRHTR003,PRHTR004,PRHTR005:
                          PRHTR006,PRHTR007,PRHTR008,PRHTR009,PRHTR010
          CALL      RDPRHT1
          BRANCH    OVRCD,DELITM90
          CALL      DEPRHT1                      * write transaction record
.
.         Check if any other items left to be invoiced
.
          IF        PRCNRDOC = 1
            PACK      KEY45,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                            PRHTRDAT,SP70
          ELSE
            PACK      KEY45,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
          ENDIF
          MOVE      ZERO,LNVISFLG         * Linked visit record flag
          PACK      KEY62,KEY45,SP70
          CALL      RSPRHT1
DELITM10  CALL      RKPRHT1
          BRANCH    OVRCD,DELITM20
.
          IF        PRCNRDOC = 1
            PACK      DIM45,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                            PRHTRDAT,SP70
          ELSE
            PACK      DIM45,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
          ENDIF
.
          MATCH     DIM45,KEY45
          GOTO      DELITM20 IF NOT EQUAL
.
          BRANCH    LNVISFLG,DELITM80
.
.         Check if this record is for Linked visit only
.
          COMPARE   TWO,PRHTFLAG
          GOTO      DELITM80 IF NOT EQUAL    * Not IMC Details record
          MATCH     SP70,PRHTITMN
          GOTO      DELITM80 IF NOT EQUAL
.
          MATCH     SP70,PRHTLVIS
          IF        !@EQUAL
            MOVE      ONE,LNVISFLG           * found a Linked visit record
            GOTO      DELITM10
          ENDIF
          GOTO      DELITM80
.
.         If the only record left is Linked visit only, delete the record
.
DELITM20  COMPARE   ZERO,LNVISFLG
          GOTO      DELITM30 IF EQUAL
.
          PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD:
                          PRHTRDAT,DPRHTFLG,PRHTITMN,PRHTSUBN,DPRHTNUM,SP70
          CALL      RDPRHT1
          IF        OVRCD=0
            CALL      DEPRHT1
          ENDIF
.
DELITM30  PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          IF        OVRCD=0
            MOVE      ZERO,PRHRPINV       * mo more items to be invoiced
            CALL      UPPRHR1
          ENDIF
.
DELITM80  MOVE      ZERO,OVRCD
          GOTO      DELITM99
.
DELITM90  MOVE      ONE,OVRCD
DELITM99  RETURN
+
.-------------------------------------------------------------
. Load items to tempfile
.-------------------------------------------------------------
LOADIT00  MOVE      ONE,F3
          MOVE      ZERO,FORM8
          WHILE     F3<=COUNTITM
            MOVE      PRHRUNIQ,PRTMUNIQ
            MOVE      PRHRPRAC,PRTMPRAC
            MOVE      PRHRDOCT,PRTMDOCT
            MOVE      PRHRPIND,PRTMPIND
            MOVE      MDATE[F3],PRTMDATE
            MOVE      MTIME[F3],PRTMTIME
            MOVE      ITYPE[F3],PRTMITYP
            MOVE      ITEMN[F3],PRTMITEM
            MOVE      SUBIT[F3],PRTMSUBI
            MOVE      DESCP[F3],PRTMDESC
            MOVE      TESTC[F3],PRTMTEST
            MOVE      S4FLG[F3],PRTMS4FL
            MOVE      GSTAP[F3],PRTMGSTA
            MOVE      GSTCD[F3],PRTMGSTC
            MOVE      QUNTY[F3],PRTMQUNT
            MOVE      CAMNT[F3],PRTMCAMT
            MOVE      IAMNT[F3],PRTMIAMT
            MOVE      SP70,PRTMSPAR
.
            MATCH     SP9,PRTMITEM
            IF        !@EQUAL
              ADD       ONE,FORM8
              MOVE      FORM8,PRTMCNTR
              PACK      KEY35,PRTMUNIQ,PRTMPRAC,PRTMDOCT,PRTMPIND,PRTMCNTR,SP70
              CALL      WRPRTMP1
            ENDIF
            ADD       ONE,F3
          DO
.
          MOVE      ZERO,PRTMTEST
          MOVE      ZERO,PRTMS4FL
          MOVE      ZERO,PRTMGSTA
          MOVE      SP10,PRTMTIME
          UNPACK    SP70,PRTMGSTC,PRTMSPAR
          MOVE      COUNTITM,FORM8
          PACK      KEY8,PRTHD001,SP20    * position on the template id
          CALL      RSPRTDT1
LOADIT10  CALL      RKPRTDT1
          BRANCH    OVRCD,LOADIT90
          MATCH     PRTHD001,PRTDTMID     * same template id?
          GOTO      LOADIT90 IF NOT EQUAL
.
          MATCH     SP70,PRTHD002
          IF        !@EQUAL
            MOVE      PRTHD002,PRTMDATE
          ELSE
            PACK      PRTMDATE,CCC,CYY,CMM,CDD
            REP       " 0",PRTMDATE
          ENDIF
.
          MATCH     SP70,PRTHD003
          IF        !@EQUAL
            MOVE      PRTHD003,PRTMTIME
          ENDIF
.
          MOVE      PRTDTYPE,PRTMITYP
          MOVE      PRTDCODE,PRTMITEM
          MOVE      PRTDSUBI,PRTMSUBI
          MOVE      PRTDQUAN,PRTMQUNT
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          CALL      GETDES00
          MOVE      PRITSFEE,PRTMIAMT
          MOVE      PRITSFEE,PRTMCAMT
          MULT      PRTMQUNT,PRTMCAMT
          MOVE      PRITDESC,PRTMDESC
          MOVE      PRITGSTA,PRTMGSTA
          MOVE      PRITGSTC,PRTMGSTC
.
          MOVE      PRHRUNIQ,PRTMUNIQ
          MOVE      PRHRPRAC,PRTMPRAC
          MOVE      PRHRDOCT,PRTMDOCT
          MOVE      PRHRPIND,PRTMPIND
          MOVE      SP70,PRTMSPAR
.
          ADD       ONE,FORM8
          MOVE      FORM8,PRTMCNTR
          PACK      KEY35,PRTMUNIQ,PRTMPRAC,PRTMDOCT,PRTMPIND,PRTMCNTR,SP70
          CALL      WRPRTMP1
          GOTO      LOADIT10
.
LOADIT90  STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&countitm=",REDIRECT
          APPEND    COUNTITM,REDIRECT
          APPEND    "&prthd001=",REDIRECT
          APPEND    PRTHD001,REDIRECT
          APPEND    "&uniqnumb=",REDIRECT
          APPEND    UNIQNUMB,REDIRECT
          APPEND    "&prhre001=",REDIRECT
          APPEND    PRHRE001,REDIRECT
          APPEND    "&prhre002=",REDIRECT
          APPEND    PRHRE002,REDIRECT
          APPEND    "&prhre003=",REDIRECT
          APPEND    PRHRE003,REDIRECT
.
          IF        PRCNRDOC = 1
            APPEND    "&prhtr005=",REDIRECT
            APPEND    PRHTR005,REDIRECT
            APPEND    "&prhtr006=",REDIRECT
            APPEND    PRHTR006,REDIRECT
            APPEND    "&prhtr011=",REDIRECT
            APPEND    PRHTR011,REDIRECT
          ENDIF
          RESET     REDIRECT
.
LOADIT99  RETURN
+
.**********************************************************************
.      Copy item to tempfile
.**********************************************************************
CPITM000  MOVE      ZERO,F8
.
          PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,Z70
          CALL      RSPRTMP1
          CALL      RPPRTMP1
          BRANCH    OVRCD,CPITM100
.
          MATCH     DPRHRUNQ,PRTMUNIQ
          GOTO      CPITM100 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRTMPRAC
          GOTO      CPITM100 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRTMDOCT
          GOTO      CPITM100 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRTMPIND
          GOTO      CPITM100 IF NOT EQUAL
.
          MOVE      PRTMCNTR,F8
.
CPITM100  ADD       ONE,F8
          MOVE      PRHRUNIQ,PRTMUNIQ
          MOVE      PRHRPRAC,PRTMPRAC
          MOVE      PRHRDOCT,PRTMDOCT
          MOVE      PRHRPIND,PRTMPIND
          MOVE      F8,PRTMCNTR
          MOVE      PRTMCNTR,KEY8
          MOVE      ZERO,PRTMTEST
          MOVE      ZERO,PRTMS4FL
          MOVE      PRITM001,PRTMDATE
          MOVE      PRITM002,PRTMTIME
          MOVE      PRITM003,PRTMITYP
          MOVE      PRITM004,PRTMITEM
          MOVE      PRITM005,PRTMSUBI
          MOVE      PRITM006,PRTMDESC
          MOVE      PRITM007,PRTMQUNT
          MOVE      PRITM008,PRTMCAMT
          MOVE      PRITM009,PRTMGSTA
          MOVE      PRITM010,PRTMGSTC
          MOVE      PRITM011,PRTMIAMT
          MOVE      PRITM012,PRTMTEST
          MOVE      PRITM013,PRTMS4FL
.
          PACK      KEY35,PRTMUNIQ,PRTMPRAC,PRTMDOCT,PRTMPIND,PRTMCNTR,SP70
          CALL      WRPRTMP1
.
CPITM999  RETURN
+
.**********************************************************************
.      change time in tempfile
.**********************************************************************
CHTIM000  PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,ITEMNUMB,SP70
          CALL      RDPRTMP1
          BRANCH    OVRCD,CHTIM999
.
          MOVE      PRITM002,PRTMTIME
          CALL      UPPRTMP1
CHTIM999  RETURN
+
.**********************************************************************
.      remove record from tempfile
.**********************************************************************
DTMPR000  PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,ITEMNUMB,SP70
          CALL      DEPRTMP1
.
DTMPR999  RETURN
+
.**********************************************************************
.      Check if times are all entered
.**********************************************************************
CHKTIM00  MOVE      ZERO,TIMEFLAG
          PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RSPRTMP1
CHKTIM10  CALL      RKPRTMP1
          BRANCH    OVRCD,CHKTIM99
.
          MATCH     DPRHRUNQ,PRTMUNIQ
          GOTO      CHKTIM99 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRTMPRAC
          GOTO      CHKTIM99 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRTMDOCT
          GOTO      CHKTIM99 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRTMPIND
          GOTO      CHKTIM99 IF NOT EQUAL
.
          MATCH     SP10,PRTMTIME
          GOTO      CHKTIM10 IF NOT EQUAL
.
          MOVE      ONE,TIMEFLAG
CHKTIM99  RETURN
+
.**********************************************************************
.      validate item
.**********************************************************************
CHKITM00  MOVE      ZERO,EXIT
          PACK      KEY22,PRHTFLAG,PRHTITMN,PRHTSUBN,NINE8
          CALL      RSPRIT1                      * position after last record
.                                                  for this item
CHKITM10  CALL      RPPRIT1                      * read previous record
          BRANCH    OVRCD,CHKITM90               * end of file
.
          COMPARE   PRHTFLAG,PRITFLAG            * same item type ?
          GOTO      CHKITM90 IF NOT EQUAL        * no
.
          MATCH     PRHTITMN,PRITITMN            * same item number ?
          GOTO      CHKITM90 IF NOT EQUAL        * no
.
          MATCH     PRHTSUBN,PRITSUBN            * same subitem number ?
          GOTO      CHKITM90 IF NOT EQUAL        * no
.
          MATCH     PRITDAT1,PRHTDATE            * item date > service date ?
          GOTO      CHKITM10 IF LESS             * yes
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     PRHTDATE,PRITDAT2
            GOTO      CHKITM10 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
          GOTO      CHKITM99
.
CHKITM90  MOVE      ONE,EXIT
CHKITM99  RETURN
+
.**********************************************************************
.      Get last transaction number
.**********************************************************************
GTRN0000  MOVE      ZERO,TRANSNO
          OPEN      PRIHTRA3,"prihtraf"          * Holding Transaction file
          IF        PRCNRDOC = 1
            PACK      KEY62,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003:
                            PRHTR005,PRHTR006,Z70
          ELSE
            PACK      KEY62,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,Z70
          ENDIF
          CALL      RSPRHT3                      * position in trans. file
          CALL      RPPRHT3                      * read trans. record
          BRANCH    OVRCD,GTRN9000               * end of file
.
          MATCH     UNIQNUMB,DPRHTUNQ            * same unique identifier ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRHRE001,PRHTPRAC            * same medical practice ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRHRE002,PRHTDOCT            * same service doctor ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRHRE003,PRHTPIND            * same patient indicator ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          IF        PRCNRDOC = 1
             MATCH     PRHTR005,PRHTREFD         * same referring doctor ?
             GOTO      GTRN9000 IF NOT EQUAL     * no
             MATCH     PRHTR006,PRHTRDAT         * same referral date?
             GOTO      GTRN9000 IF NOT EQUAL     * no
          ENDIF
          MOVE      PRHTNUMB,TRANSNO
.
GTRN9000  ADD       ONE,TRANSNO                  * next available trans no
GTRN9999  RETURN
+
.**********************************************************************
.*                                GETS0000                            *
.*       Routine to get the service time for the invoice from the     *
.*       first transaction on the debtors transaction file            *
.**********************************************************************
GETS0000  PACK      KEY24,VDEBTOR,VSCANPMI,PRINNUMB,SP6
          CALL      RSPRDT3                 * get the first record on the
          CALL      RKPRDT3                   debtors transaction file
          BRANCH    OVRCD,GETS9000
.
          MATCH     VDEBTOR,PRDTDEBT        * compare debtor numbers
          GOTO      GETS9000 IF NOT EQUAL
.
          COMPARE   VSCANPMI,PRDTSCAN       * compare scan flags
          GOTO      GETS9000 IF NOT EQUAL
.
          MATCH     PRINNUMB,PRDTINVN       * match invoice numbers
          GOTO      GETS9999 IF EQUAL
.
.------ we could not get the first debtors transaction record ------
.
GETS9000  MOVE      SP6,PRDTSTIM
.
GETS9999  RETURN
+
.**********************************************************************
.*                               GETC0000                             *
.*     Routine to get the claim details to print if required          *
.**********************************************************************
GETC0000  MOVE      ZERO,COUNTR
          MOVE      SP3,CLAIMTYP
          MOVE      SP20,CLAIMNUM
          MOVE      SP10,CLAIMDTE
          MOVE      SP30,EMPLNAME
.
          MATCH     SP3,PRINCLAM            * see if the claim type exists
          GOTO      GETC9999 IF EQUAL
.
          PACK      KEY5,CODECL,PRINCLAM
          CALL      RDCODE1                 * read the patient codes file
          BRANCH    OVRCD,GETC9999
.
.------ check the next patient indicator ------
.
GETC1000  ADD       ONE,COUNTR
.
          COMPARE   SIX,COUNTR              * see if no more indicators to
          GOTO      GETC9999 IF EQUAL         process
.
          LOAD      INDICATR,COUNTR,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    ANSW,INDICATR           * see if we have a workers
          GOTO      GETC2000 IF EQUAL         compensation claim
.
          CMATCH    ANSM,INDICATR           * see if we have a M.A.B. claim
          GOTO      GETC3000 IF EQUAL
.
          CMATCH    ANSV,INDICATR           * see if we have a veterans affairs
          GOTO      GETC4000 IF EQUAL         claim
.
          GOTO      GETC1000
.
. ------- Workers Compensation -------
.
GETC2000  PACK      KEY16,PRCNINVN,PRINCNUM
          CALL      RDPRWC1                 * read the workers compensation
          BRANCH    OVRCD,GETC1000            claim file
.
          MATCH     SP3,CLAIMTYP
          GOTO      GETC1000 IF NOT EQUAL
          MOVE      "WC ",CLAIMTYP
          MOVE      PRWCCLMN,CLAIMNUM
          MOVE      PRWCNAME,EMPLNAME
.
          MATCH     SP8,PRINADTE
          GOTO      GETC1000 IF EQUAL
.
          UNPACK    PRINADTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * pack the date
          MOVE      CPCDATE,CLAIMDTE
          GOTO      GETC1000
.
. ------- Motor Accident Board -------
.
GETC3000  PACK      KEY16,PRCNINVN,PRINCNUM
          CALL      RDPRMA1                 * read the transport accident
          BRANCH    OVRCD,GETC1000            commission file
.
          MATCH     SP3,CLAIMTYP
          GOTO      GETC1000 IF NOT EQUAL
          MOVE      "TAC",CLAIMTYP
          MOVE      PRMAREFN,CLAIMNUM
.
          MATCH     SP8,PRINADTE
          GOTO      GETC1000 IF EQUAL
.
          UNPACK    PRINADTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * pack the date
          MOVE      CPCDATE,CLAIMDTE
          GOTO      GETC1000
.
. ------- Veterans Affairs -------
.
GETC4000  PACK      KEY16,PRCNINVN,PRINCNUM
          CALL      RDPRVA1                 * read the veterans affairs file
          BRANCH    OVRCD,GETC1000
.
          MATCH     SP3,CLAIMTYP
          GOTO      GETC1000 IF NOT EQUAL
          MOVE      "VA ",CLAIMTYP
          MOVE      PRVACLAM,CLAIMNUM
          GOTO      GETC1000
.
GETC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Add new Referral
.-------------------------------------------------------------------------------
ADDREF00  PACK      KEY27,PRHDDEBT,PRHDSCAN,PRHDCLAM,PRHDACCD,PRHDHFND
          CALL      RDPRHD1
          COMPARE   ZERO,OVRCD
          GOTO      ADDREF30 IF EQUAL
.
          READ      CONTROLF,THIRTY3;*172,PRCNUNIQ
ADDREF10  MOVE      PRCNUNIQ,KEY8
          CALL      RDPRHD2
          BRANCH    OVRCD,ADDREF20
          ADD       ONE,PRCNUNIQ            * try next unique number
          GOTO      ADDREF10
.
ADDREF20  MOVE      PRCNUNIQ,PRHDUNIQ
          ADD       ONE,PRCNUNIQ            * update counter (control file)
          WRITAB    CONTROLF,THIRTY3;*172,PRCNUNIQ
.
          MOVE      URNUMBER,PRHDDEBT
          MOVE      ONE,PRHDSCAN            * PMI scan flag
          MOVE      CLAIMCOD,PRHDCLAM       * claim code
          MOVE      SP70,PRHDACCD           * accident date
          MATCH     ACCIDATE,SP70
          IF        !@EQUAL
            MOVE      ACCIDATE,PRHDACCD
          ENDIF
          MOVE      HEALTHFD,PRHDHFND
          MOVE      SP30,PRHDSPAR
          PACK      KEY27,PRHDDEBT,PRHDSCAN,PRHDCLAM,PRHDACCD,PRHDHFND
          CALL      WRPRHD1                 * write header record
.
ADDREF30  PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          IF        OVRCD = 1
            CALL      CLPRIHRE
            MOVE      PRHRE001,PRHRPRAC
            MOVE      PRHRE002,PRHRDOCT
            MOVE      PRHRE003,PRHRPIND
            CALL      MVPRHR00              * Move cgi var to file variable
.
            MOVE      ZERO,PRHRUNCL
            IF        COMPFLAG <> 0
              CALL      NXTCLN00            * Get next claim number
            ENDIF
.           MOVE      ONE,PRHRPINV          * invoice tobe printed flag
            MOVE      ZERO,PRHRPINV
            CALL      WRPRHR1               * write referral record
          ENDIF
.
ADDREF99  RETURN
+
.-------------------------------------------------------------------------------
.            Get next unique claims number
.-------------------------------------------------------------------------------
NXTCLN00    MOVE      " 33",PRXCODE   * System Lock Sector 33
            CALL      GETSLK00        * Get System Lock of Sector 33
            READ      CONTROLF,THIRTY3;*182,PRCNUNCL
            MOVE      PRCNUNCL,UCLAIM
            ADD       ONE,PRCNUNCL
            WRITAB    CONTROLF,THIRTY3;*182,PRCNUNCL
            CALL      RELSLK00        * Release System Lock of Sector 33
            MOVE      UCLAIM,PRHRUNCL       * unique claim number
NXTCLN99    RETURN
.
.****************************************************************************
.*                            NXTI0000                 Called by: PHOL0000  *
.*                  get next unique identifier                    DHOL0000  *
.****************************************************************************
.
NXTI0000  MOVE      " 33",PRXCODE   * System Lock Sector 33
          CALL      GETSLK00        * Get System Lock of Sector 33
          READ      CONTROLF,THIRTY3;*172,PRCNUNIQ
          MOVE      PRCNUNIQ,PRHDUNIQ
          ADD       ONE,PRCNUNIQ
          WRITAB    CONTROLF,THIRTY3;*172,PRCNUNIQ
          CALL      RELSLK00        * Release System Lock of Sector 33
.
NXTI9999  RETURN
+
.-------------------------------------------------------------------------------
.   Check if referral record exists
.-------------------------------------------------------------------------------
CHKREF00  MOVE      ONE,PRHDSCAN            * default to PMI
          MOVE      SP70,PRHDCLAM
          MOVE      SP70,PRHDACCD
          CALL      CLPRIHRE
          CALL      CLPRWC00
          CALL      CLPRMB00
          CALL      CLPRVA00
          CALL      CLPRCT00
          MOVE      ZERO,EXIT
.
          MATCH     SP70,UNIQNUMB
          GOTO      CHKREF20 IF EQUAL
.
          PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,CHKREF20
          MOVE      PRHDCLAM,OLDCLAIM
          MOVE      PRHDCLAM,CLAIMCOD
          MOVE      PRHDACCD,ACCIDATE
          CALL      GCLM0000                * setup compensable claim (comflag)
.
          MATCH     "009",TEMPLATE
          IF        @EQUAL
           COMPARE    ONE,COMPFLAG
           GOTO       CHKREF91 IF NOT EQUAL   * not workers comp.
          ENDIF
.
          MATCH     "010",TEMPLATE
          IF        @EQUAL
           COMPARE    TWO,COMPFLAG
           GOTO       CHKREF92 IF NOT EQUAL   * not TAC
          ENDIF
.
          MATCH     "011",TEMPLATE
          IF        @EQUAL
           COMPARE    THREE,COMPFLAG
           GOTO       CHKREF93 IF NOT EQUAL   * not Vet
          ENDIF
.
          COMPARE   ZERO,INVOICEN
          GOTO      CHKREF10 IF EQUAL
          MOVE      INVOICEN,FORM8
          CALL      GETCOM00              * set up default compensable details
          MOVE      ZERO,EXIT
          GOTO      CHKREF99
.
CHKREF10  PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          IF        OVRCD=0
            MOVE      ZERO,FORM8
            CALL      GETCOM00              * set up default compensable details
          ELSE
            MATCH     "013",TEMPLATE
            GOTO      CHKREF90 IF EQUAL
          ENDIF
.
.         Invoice with Referring Doctor Transactions
.
          MATCH     "013",TEMPLATE
          IF        @EQUAL
            IF        PRCNRDOC=1
              MATCH     Z70,PRHTR005        * blank referring HCP
              GOTO      CHKREF94 IF EQUAL
              MATCH     Z70,PRHTR006        * blank referring date
              GOTO      CHKREF94 IF EQUAL
              COMPARE   ONE,ADDITMSC         * adding new
              GOTO      CHKREF15 IF EQUAL
              PACK      KEY62,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003:
                            PRHTR005,PRHTR006,SP70
              CALL      RSPRHT1
              CALL      RKPRHT1
              BRANCH    OVRCD,CHKREF94
            ENDIF
          ENDIF
.
CHKREF15  MOVE      ZERO,EXIT
          GOTO      CHKREF99
.
CHKREF20  MATCH     "001",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * List
          MATCH     "015",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * List
          MATCH     "016",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * Change claim code
          MATCH     "004",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * AddForm
          MATCH     "005",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * AddForm
          MATCH     "006",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * WC & PRFA
          MATCH     "007",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * TAC & PRFA
          MATCH     "008",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * VET & PRFA
          MATCH     "018",TEMPLATE
          GOTO      CHKREF99 IF EQUAL       * S4B3 Exemption
.
CHKREF90  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKREF99
.
CHKREF91  MOVE      "Not a Worker Comp.Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKREF99
.
CHKREF92  MOVE      "Not a TAC patient.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKREF99
.
CHKREF93  MOVE      "Not a Veteran Affair Patient.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKREF99
.
CHKREF94  MOVE      "Referring HCP has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKREF99
.
CHKREF99  RETURN
+
.-------------------------------------------------------------------------------
.         Get compensation details
.-------------------------------------------------------------------------------
GETCOM00  COMPARE   ZERO,COMPFLAG           * Non-compensable?
          GOTO      GETCOM99 IF EQUAL
.
          PACK      KEY16,FORM8,PRHRUNCL
          BRANCH    COMPFLAG,GETCOM10,GETCOM20,GETCOM30,GETCOM40
          GOTO      GETCOM50
.
GETCOM10  CALL      RDPRWC1                   * Workers comp.
          GOTO      GETCOM50
.
GETCOM20  CALL      RDPRMA1                   * TAC
          GOTO      GETCOM50
.
GETCOM30  CALL      RDPRVA1                   * Veteran affairs
          GOTO      GETCOM50
.
GETCOM40  CALL      RDPRCT1
          GOTO      GETCOM50
.
GETCOM50  IF        PRHRUNCL=0
            MOVE      ONE,OVRCD
          ENDIF
.
          MOVE      ZERO,LOADFLG            * flag for loading claim details
          COMPARE   ONE,OVRCD               * no "0" claim record found
          IF        @EQUAL
.
.         See if a recent claim record exists with an invoice #
.
             CALL      LSTI0000
             MOVE      ONE,NEWCLM           * set flag for new claim record
          ELSE
             CALL      LODC0000             * load current claim details
             MOVE      ZERO,NEWCLM          * set update claim flag
             MOVE      ONE,LOADFLG          * record exists
          ENDIF
GETCOM99  RETURN
+
.-------------------------------------------------------------------------------
.         Set up compensable indicator
.-------------------------------------------------------------------------------
GCLM0000  MOVE      ZERO,COMPFLAG
          PACK      KEY5,ANSC,ANSL,CLAIMCOD
          CALL      RDCODE1
          BRANCH    OVRCD,GCLM9999
.
          MATCH     ANSC,TCINDC6
          GOTO      GCLM5000 IF EQUAL
.
.          Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
GCLM1000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      GCLM9999 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MATCH     ANSW,ANS
          GOTO      GCLM2000 IF EQUAL
          MATCH     ANSM,ANS
          GOTO      GCLM3000 IF EQUAL
          MATCH     ANSV,ANS
          GOTO      GCLM4000 IF EQUAL
          GOTO      GCLM1000
.
GCLM2000  MOVE      ONE,COMPFLAG       * for Workers comp
          GOTO      GCLM9999
.
GCLM3000  MOVE      TWO,COMPFLAG       * for TAC
          GOTO      GCLM9999
.
GCLM4000  MOVE      THREE,COMPFLAG     * for veteran affairs
          GOTO      GCLM9999
.
GCLM5000  MOVE      FOUR,COMPFLAG      * for Civil tort
          GOTO      GCLM9999
.
GCLM9999  RETURN
+
.****************************************************************************
.*                                  LSTI0000                                *
.*           get the most recent claim record which has been invoiced       *
.* Returns:          LOADFLG   1 = claim details loaded                     *
.*                             0 = no claim details loaded                  *
.****************************************************************************
LSTI0000  COMPARE   ZERO,PRHRUNCL
          GOTO      LSTI9500 IF EQUAL            * No claim number
.
          PACK      KEY16,PRHRUNCL,Z70
          BRANCH    COMPFLAG,LSTI1000,LSTI2000,LSTI3000,LSTI4000
.
LSTI1000  CALL      RSPRWC2
          CALL      RPPRWC2
          BRANCH    OVRCD,LSTI9500
.
          COMPARE   PRWCUNIQ,PRHRUNCL            * same unique claim number ?
          GOTO      LSTI9000 IF EQUAL            * yes - valid record found
          GOTO      LSTI9500                     * no
.
LSTI2000  OPEN      PRIMABD2,"primabdf"          * Transport Acc. Comm. file
          CALL      RSPRMA2
          CALL      RPPRMA2
          CLOSE     PRIMABD2
          BRANCH    OVRCD,LSTI9500
.
          COMPARE   PRMAUNIQ,PRHRUNCL            * same unique claim number ?
          GOTO      LSTI9000 IF EQUAL            * yes - valid record found
          GOTO      LSTI9500                     * no
.
LSTI3000  OPEN      PRIVAFD2,"privafdf"          * Veterans Affairs file
          CALL      RSPRVA2
          CALL      RPPRVA2
          BRANCH    OVRCD,LSTI9500
.
          COMPARE   PRVAUNIQ,PRHRUNCL            * same unique claim number ?
          GOTO      LSTI9000 IF EQUAL            * no
          GOTO      LSTI9500                     * no
.
LSTI4000  OPEN      PRICTCA2,"prictcaf"          * Veterans Affairs file
          CALL      RSPRCT2
          CALL      RPPRCT2
          BRANCH    OVRCD,LSTI9500
.
          COMPARE   PRCTUNIQ,PRHRUNCL            * same unique claim number ?
          GOTO      LSTI9000 IF EQUAL            * no
          GOTO      LSTI9500                     * no
.
LSTI9000  CALL      LODC0000                     * load details
          MOVE      ONE,LOADFLG
          GOTO      LSTI9999
.
LSTI9500  MOVE      ZERO,LOADFLG
          CALL      CLPRMB00
          CALL      CLPRWC00
          CALL      CLPRVA00
          CALL      CLPRCT00
LSTI9999  RETURN
+
.****************************************************************************
.*                                  LODC0000                                *
.*                 load claim details (for "0" invoice #)                   *
.****************************************************************************
LODC0000  BRANCH    COMPFLAG,LODC1000:              * WC
                             LODC2000:              * TAC
                             LODC3000:              * VAF
                             LODC4000               * CIVIL TORT
          GOTO      LODC9999
.
LODC1000  MOVE      PRWCNAME,PRCOM001
          MOVE      PRWCADD1,PRCOM002
          MOVE      PRWCADD2,PRCOM003
          MOVE      PRWCADD3,PRCOM004
          MOVE      PRWCPOST,PRCOM005
          MOVE      PRWCTELE,PRCOM006
          MOVE      PRWCACCP,PRCOM007
          MOVE      PRWCICOD,PRCOM008
          MOVE      PRWCCLMN,PRCOM009
          MOVE      PRWCTIME,PRCOM010
          MOVE      PRWCCOM1,PRCOM011
          MOVE      PRWCCOM2,PRCOM012
          GOTO      LODC9999
.
LODC2000  MOVE      PRMAREFN,PRMAB001
          MOVE      PRMAPOLS,PRMAB002
          MOVE      PRMASOLN,PRMAB003
.
          MOVE      PRMASOLT,PRMAB008
          MOVE      PRMAREGO,PRMAB009
          MOVE      PRMAALOC,PRMAB010
          MOVE      PRMAENGD,PRMAB012
          MOVE      PRMAINJD,PRMAB013
          MOVE      PRMAUDF1,PRMAB014
          MOVE      PRMAUDF2,PRMAB015
          MOVE      PRMAMSEV,PRMAB016
          MOVE      PRMARSEV,PRMAB017
          MOVE      PRMAODD1,PRMAB018
          MOVE      PRMAODD2,PRMAB019
          MOVE      PRMAODD3,PRMAB020
          GOTO      LODC9999
.
LODC3000  MOVE      PRVACLAM,PRVAF001
          GOTO      LODC9999
.
LODC4000  MOVE      PRCTSNAM,PRCTC001
          MOVE      PRCTSAD1,PRCTC002
          MOVE      PRCTSAD2,PRCTC003
          MOVE      PRCTSAD3,PRCTC004
          MOVE      PRCTSAD4,PRCTC005
          MOVE      PRCTSPCO,PRCTC006
          MOVE      PRCTSPHN,PRCTC007
          MOVE      PRCTCONT,PRCTC008
          MOVE      PRCTREFN,PRCTC009
          GOTO      LODC9999
.
LODC9999  RETURN
+
.-------------------------------------------------------------------------------
. Set person responsible for account
.-------------------------------------------------------------------------------
SPRA0000  CALL      CLPRIHRE               * clear PRA General variables
.
          CALL      DPRA0000               * Default PRFA based on claim code
          COMPARE   ZERO,OVRCD
          GOTO      SPRA9999 IF EQUAL
.
          BRANCH    COMPFLAG,SPRA5000:     * Workers comp.
                             SPRA6000:     * Motor accident
                             SPRA7000      * Veterans affairs
.
SPRA1000  CALL      SETP0000               * get PRFA for non-compensation
          GOTO      SPRA9999
.
SPRA5000  CALL      WPRA0000               * Set PRFA for workers comp
          GOTO      SPRA9999
.
SPRA6000  CALL      MPRA0000               * Set PRFA for MAB
          GOTO      SPRA9999
.
SPRA7000  CALL      VPRA0000               * Set PRFA for veteran affairs
          GOTO      SPRA9999
.
SPRA9999  RETURN
+
.**************************************************************************
.*                               SETP0000                                 *
.*            set person responsible for a/c from debtor/PMI file         *
.**************************************************************************
SETP0000  BRANCH    PRCNUPRA,SETP2000,SETP3000,SETP5000
.
.         Use the patient as the PRA
.
SETP1100  CALL      HPRA0000
          MOVE      "Self      ",PRHRRELP
          GOTO      SETP9999
.
.         Set the PRA to that of the last inpatient visit
.
SETP2000  MOVE      URNUMBER,PVIURNO
          PACK      PVIDATE,CCC,CYY,CMM,CDD
          REP       " 0",PVIDATE
          PACK      KEY24,PVIURNO,PVIDATE,Z70
          CALL      RDSVISA2
SETP2100  CALL      RDPVISA2
          BRANCH    OVRCD,SETP1100      * no visits, default to patient
.
          MATCH     URNUMBER,PVIURNO
          GOTO      SETP1100 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      SETP2100 IF NOT EQUAL
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          OPEN      PATMI1A1,"patmi1af"
          CALL      RDMISS1
          IF        (OVRCD=1) | (ASTAT=1) | (ASTAT=5)
            GOTO      SETP2100
          ENDIF
          OPEN      PATRE1A1,"patre1af"
          MOVE      AADMNO,KEY8
          CALL      RDRESP1
          CLOSE     PATRE1A1
          BRANCH    OVRCD,SETP1100      * no record, default to patient
.
          MOVE      PKNAME,PRHRNAME
          MOVE      PKADD1,PRHRADD1
          MOVE      PKADD2,PRHRADD2
          MOVE      PKSUBR,PRHRADD3
          MOVE      PKADD4,PRHRADD4
          MOVE      PKPOST,PRHRPOST
          MOVE      PKTELEP,PRHRTELP
          MOVE      PKTELEB,PRHRTELB
          MOVE      PTREMOBL,PRHRMPHN
          MOVE      PKRELP,PRHRRELP
          GOTO      SETP9999
.
.         Set the PRA to that of web demographic screen contact
.
SETP3000  CALL      PPRA0000
          BRANCH    EXIT,SETP3100
.
          MATCH     SP45,PRHRNAME
          GOTO      SETP9999 IF NOT EQUAL
.
SETP3100  CALL      IPRA0000
          BRANCH    EXIT,SETP3200
.
          MATCH     SP45,PRHRNAME
          GOTO      SETP9999 IF NOT EQUAL
.
SETP3200  CALL      HPRA0000
          GOTO      SETP9999
.
.         Set the PRA to details from master record
.
SETP5000  MOVE      URNUMBER,PRHDDEBT
          MOVE      PRHDDEBT,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
             GOTO     SETP2000           * No record, default to visit rec
           ELSE
             MOVE     PMPXCONP,FORM1
          ENDIF
          COMPARE   ZERO,FORM1
          IF        @EQUAL
             MOVE     TWO,FORM1
          ENDIF
.
          BRANCH    FORM1,SETP6000,SETP6200,SETP6300,SETP6300,SETP6300,SETP6600
.
SETP6000  MOVE      PMPXMTLE,PACTITLE
          MOVE      PMPXMSNA,PACSNAME
          MOVE      PMPXMGNA,ANS
          MOVE      ANS,PACGNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PRHRNAME
          MOVE      PMPXMAD1,PRHRADD1
          MOVE      PMPXMAD2,PRHRADD2
          MOVE      PMPXMAD3,PRHRADD3
          MOVE      PMPXMAD4,PRHRADD4
          MOVE      PMPXMPOS,PRHRPOST
          MOVE      PMPXMPNO,PRHRTELP
          MOVE      PMPXMBNO,PRHRTELB
          MOVE      PMPXMMNO,PRHRMPHN
          MOVE      "MOTHER",PRHRRELP
          GOTO      SETP9999
.
SETP6200  MOVE      PMPXFTLE,PACTITLE
          MOVE      PMPXFSNA,PACSNAME
          MOVE      PMPXFGNA,ANS
          MOVE      ANS,PACGNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PRHRNAME
          MOVE      PMPXFAD1,PRHRADD1
          MOVE      PMPXFAD2,PRHRADD2
          MOVE      PMPXFAD3,PRHRADD3
          MOVE      PMPXFAD3,PRHRADD4
          MOVE      PMPXFPOS,PRHRPOST
          MOVE      PMPXFPNO,PRHRTELP
          MOVE      PMPXFBNO,PRHRTELB
          MOVE      PMPXFMNO,PRHRMPHN
          MOVE      "FATHER",PRHRRELP
          GOTO      SETP9999
.
SETP6300  MOVE      PRHDDEBT,KEY8
          CALL      RDMAST1
          IF        OVRCD=1
             GOTO     SETP2000
          ENDIF
.
          COMPARE   FOUR,FORM1
          GOTO      SETP6400 IF EQUAL
.
          COMPARE   FIVE,FORM1
          GOTO      SETP6500 IF EQUAL
.
          MOVE      PNKNAME,PRHRNAME
          MOVE      PNKADD1,PRHRADD1
          MOVE      PNKADD2,PRHRADD2
          MOVE      PNKSUBR,PRHRADD3
          MOVE      PNKADD4,PRHRADD4
          MOVE      PNKPOST,PRHRPOST
          MOVE      PNKTELP,PRHRTELP
          MOVE      PNKTELB,PRHRTELB
          MOVE      PNKRELP,PRHRRELP
          GOTO      SETP9999
.
SETP6400  MOVE      PTMXECNM,PRHRNAME
          MOVE      PTMXECA1,PRHRADD1
          MOVE      PTMXECA2,PRHRADD2
          MOVE      PTMXECA3,PRHRADD3
          MOVE      PTMXECA4,PRHRADD4
          MOVE      PTMXECPC,PRHRPOST
          MOVE      PTMXECPP,PRHRTELP
          MOVE      PTMXECBP,PRHRTELB
          MOVE      PTMXECRE,PRHRRELP
          MOVE      PTMXCELL,PRHRMPHN
          GOTO      SETP9999
.
SETP6500  MOVE      PTMXNRNM,PRHRNAME
          MOVE      PTMXNRA1,PRHRADD1
          MOVE      PTMXNRA2,PRHRADD2
          MOVE      PTMXNRA3,PRHRADD3
          MOVE      PTMXNRA4,PRHRADD4
          MOVE      PTMXNRPC,PRHRPOST
          MOVE      PTMXNRPP,PRHRTELP
          MOVE      PTMXNRBP,PRHRTELB
          MOVE      PTMXNRRE,PRHRRELP
          MOVE      PTMXCELL,PRHRMPHN
          GOTO      SETP9999
.
SETP6600  CALL      IPRA0000
.
SETP9999  RETURN
+
.**************************************************************************
.*                               DPRA0000                                 *
.*            Default PRFA based on  for a/c from debtor/PMI file         *
.**************************************************************************
DPRA0000  MATCH     SP70,CLAIMCOD
          GOTO      DPRA9000 IF EQUAL             * blank claim code
.
          PACK      KEY5,ANSC,ANSL,CLAIMCOD,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DPRA9999
.
          MATCH     "P",TCINDC24
          GOTO      DPRA9000 IF NOT EQUAL
.
          OPEN      PATIN1A1,"patin1af"
          PACK      KEY6,CLAIMCOD,SP70
          CALL      RDINSR1
          BRANCH    OVRCD,DPRA9999
.
          PACK      PRANAME,INAME,SP70               * save details
.
          PACK      PRHRNAME,PRANAME,SP30
          PACK      PRHRADD1,IADD1,SP70
          PACK      PRHRADD2,IADD2,SP70
          PACK      PRHRADD3,IADD3,SP70
          PACK      PRHRADD4,IADD4,SP70
          PACK      PRHRPOST,IPOST,SP70
          MOVE      PRHRTELB,ITELEB,SP70
          PACK      PRHRTELP,SP70
          PACK      PRHRRELP,SP70
          PACK      PRHRMPHN,SP70
          GOTO      DPRA9999

DPRA9000  MOVE      ONE,OVRCD
DPRA9999  RETURN
+
.**************************************************************************
.*                               IPRA0000                                 *
.*PRCNUPRA=3  set person responsible from last invoice                    *
.**************************************************************************
IPRA0000  OPEN      PRIINVO3,"priinvof"
          MOVE      VSCANPMI,PRINSCAN
          PACK      KEY18,URNUMBER,PRINSCAN,Z70
          CALL      RSPRIN3
IPRA1000  CALL      RPPRIN3
          BRANCH    OVRCD,IPRA9000          * No record, default to visit rec
.
          MATCH     URNUMBER,PRINDEBT
          GOTO      IPRA9000 IF NOT EQUAL   * No record, default to visit rec

          COMPARE   PRINSCAN,VSCANPMI
          GOTO      IPRA9000 IF NOT EQUAL   * No record, default to visit rec
.
          MATCH     PRINPRAC,PRHRE001
          GOTO      IPRA1000 IF NOT EQUAL
.
          MOVE      PRINNAMR,PRHRNAME
          MOVE      PRINPRA1,PRHRADD1
          MOVE      PRINPRA2,PRHRADD2
          MOVE      PRINPRA3,PRHRADD3
          MOVE      PRINPRA4,PRHRADD4
          MOVE      PRINPOST,PRHRPOST
          MOVE      PRINTELP,PRHRTELP
          MOVE      PRINTELB,PRHRTELB
          MOVE      PRINMPHN,PRHRMPHN
          MOVE      PRINRELP,PRHRRELP
.
IPRA8000  MOVE      ZERO,EXIT
          GOTO      IPRA9999
.
IPRA9000  MOVE      ONE,EXIT
.
IPRA9999  RETURN
.
.**************************************************************************
.*                               HPRA0000                                 *
.*            set person responsible to patient in PATMA1A1               *
.**************************************************************************
HPRA0000
.         COMPARE   ZERO,VSCANPMI
.         GOTO      HPRA9000 IF EQUAL
.
.         Use master file (Patient Self)
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,HPRA8000
.
          MOVE      PTITL,PACTITLE
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PRHRNAME
          MOVE      "Self      ",PRHRRELP
.
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF:
                                     *238,PTCNAGEC
.
          COMPARE   ONE,PTCNPAOF            * Using 'Parent of' option?
          GOTO      HPRA1000 IF NOT EQUAL   * No
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                  * CALCAGE uses PBDATE
.
          COMPARE   PSAGEYRS,PTCNAGEC        * Child?
          GOTO      HPRA1000 IF LESS         * No
.
          PACK      KEY45,PRHRNAME,SP70
          MOVE      SP70,PRHRNAME
          CLEAR     PRHRNAME
          APPEND    "Parent of ",PRHRNAME
          APPEND    KEY45,PRHRNAME
          APPEND    SP70,PRHRNAME
          RESET     PRHRNAME
          MOVE      "Parent    ",PRHRRELP
.
HPRA1000  MOVE      PADD1,PRHRADD1
          MOVE      PADD2,PRHRADD2
          MOVE      PSUBRB,PRHRADD3
          MOVE      PADD4,PRHRADD4
.
          MOVE      PPOST,PRHRPOST
          MOVE      PTELEP,PRHRTELP
          MOVE      PTELEB,PRHRTELB
          MOVE      PTMXCELL,PRHRMPHN
.
HPRA8000  MOVE      ZERO,EXIT
          GOTO      HPRA9999
.
HPRA9000  MOVE      ONE,EXIT
.
HPRA9999  RETURN
.
.**************************************************************************
.*                               PPRA0000                                 *
.*PMPXCONP    set person responsible by contact indicator                 *
.**************************************************************************
PPRA0000  MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
             GOTO     PPRA9000           * No record, default to visit rec
           ELSE
             MOVE     ZERO,FORM1
             MOVE     PMPXCONP,FORM1
          ENDIF
          COMPARE   ZERO,FORM1
          IF        @EQUAL
             MOVE     TWO,FORM1
          ENDIF
.
          BRANCH    FORM1,PPRA4100,PPRA4200,PPRA4300,PPRA4300,PPRA4300,PPRA4600
.
PPRA4100  MOVE      PMPXMTLE,PACTITLE
          MOVE      PMPXMSNA,PACSNAME
          MOVE      PMPXMGNA,ANS
          MOVE      ANS,PACGNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PRHRNAME
          MOVE      PMPXMAD1,PRHRADD1
          MOVE      PMPXMAD2,PRHRADD2
          MOVE      PMPXMAD3,PRHRADD3
          MOVE      PMPXMAD4,PRHRADD4
          MOVE      PMPXMPOS,PRHRPOST
          MOVE      PMPXMPNO,PRHRTELP
          MOVE      PMPXMPNO,PRHRTELB
          MOVE      PMPXMMNO,PRHRMPHN
          MOVE      "MOTHER",PRHRRELP
          GOTO      PPRA8000
.
PPRA4200  MOVE      PMPXFTLE,PACTITLE
          MOVE      PMPXFSNA,PACSNAME
          MOVE      PMPXFGNA,ANS
          MOVE      ANS,PACGNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PRHRNAME
          MOVE      PMPXFAD1,PRHRADD1
          MOVE      PMPXFAD2,PRHRADD2
          MOVE      PMPXFAD3,PRHRADD3
          MOVE      PMPXFAD4,PRHRADD4
          MOVE      PMPXFPOS,PRHRPOST
          MOVE      PMPXFPNO,PRHRTELP
          MOVE      PMPXFBNO,PRHRTELB
          MOVE      PMPXFmNO,PRHRMPHN
          MOVE      "FATHER",PRHRRELP
          GOTO      PPRA8000
.
PPRA4300  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          IF        OVRCD=1
             GOTO     PPRA9000
          ENDIF
.
          COMPARE   FOUR,FORM1
          GOTO      PPRA4400 IF EQUAL
.
          COMPARE   FIVE,FORM1
          GOTO      PPRA4500 IF EQUAL
.
          MOVE      PNKNAME,PRHRNAME
          MOVE      PNKADD1,PRHRADD1
          MOVE      PNKADD2,PRHRADD2
          MOVE      PNKSUBR,PRHRADD3
          MOVE      PNKADD4,PRHRADD4
          MOVE      PNKPOST,PRHRPOST
          MOVE      PNKTELP,PRHRTELP
          MOVE      PNKTELB,PRHRTELB
          MOVE      PNKRELP,PRHRRELP
          GOTO      PPRA8000
.
PPRA4400  MOVE      PTMXECNM,PRHRNAME
          MOVE      PTMXECA1,PRHRADD1
          MOVE      PTMXECA2,PRHRADD2
          MOVE      PTMXECA3,PRHRADD3
          MOVE      PTMXECA4,PRHRADD4
          MOVE      PTMXECPC,PRHRPOST
          MOVE      PTMXECPP,PRHRTELP
          MOVE      PTMXECBP,PRHRTELB
          MOVE      PTMXECRE,PRHRRELP
          MOVE      PTMXCELL,PRHRMPHN
          GOTO      PPRA8000
.
PPRA4500  MOVE      PTMXNRNM,PRHRNAME
          MOVE      PTMXNRA1,PRHRADD1
          MOVE      PTMXNRA2,PRHRADD2
          MOVE      PTMXNRA3,PRHRADD3
          MOVE      PTMXNRA4,PRHRADD4
          MOVE      PTMXNRPC,PRHRPOST
          MOVE      PTMXNRPP,PRHRTELP
          MOVE      PTMXNRBP,PRHRTELB
          MOVE      PTMXNRRE,PRHRRELP
          MOVE      PTMXCELL,PRHRMPHN
          GOTO      PPRA8000
.
PPRA4600  CALL      IPRA0000
.
PPRA8000  MOVE      ZERO,EXIT
          GOTO      PPRA9999
.
PPRA9000  MOVE      ONE,EXIT
.
PPRA9999  RETURN
+
.**************************************************************************
.*                                  WPRA0000                              *
.*                  set P.R.A. details for w/comp                         *
.**************************************************************************
WPRA0000  MATCH     SP6,PRCNWCOM                 * blank insurance co. ?
          GOTO      WPRA9000 IF EQUAL            * yes
.
          MOVE      PRCNWCOM,KEY6
          CALL      RDINSR1                      * get insurance company
          BRANCH    OVRCD,WPRA9000               * not on file
.
          MOVE      INAME,PRANAME                * save details
.
          MOVE      PRANAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
.
          MOVE      IPOST,PRHRPOST
          PACK      PRHRTELP,SP10,SP2
          MOVE      ITELEB,PRHRTELB
          MOVE      SP10,PRHRRELP
          GOTO      WPRA9999
.
WPRA9000  CALL      SETP0000               * get PRFA for non-compensation
.
WPRA9999  RETURN
+
.**************************************************************************
.*                                  MPRA0000                              *
.*                  set P.R.A. details for M.A.B.                         *
.**************************************************************************
MPRA0000  MATCH     SP6,PRCNMABI                 * blank insurance co. ?
          GOTO      MPRA9000 IF EQUAL            * yes
.
          MOVE      PRCNMABI,KEY6
          CALL      RDINSR1                      * get insurance company
          BRANCH    OVRCD,MPRA9000               * not on file
.
          MOVE      INAME,PRANAME                * save details
.
          MOVE      PRANAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
.
          MOVE      IPOST,PRHRPOST
          PACK      PRHRTELP,SP10,SP2
          MOVE      ITELEB,PRHRTELB
          MOVE      SP10,PRHRRELP
          GOTO      MPRA9999
.
MPRA9000  CALL      SETP0000               * get PRFA for non-compensation
.
MPRA9999  RETURN
+
.**************************************************************************
.*                                  VPRA0000                              *
.*                  set P.R.A. details for veterans affairs               *
.**************************************************************************
VPRA0000  MATCH     SP6,PRCNVAIN                 * blank insurance co. ?
          GOTO      VPRA9000 IF EQUAL            * yes
.
          MOVE      PRCNVAIN,KEY6
          CALL      RDINSR1                      * get insurance company
          BRANCH    OVRCD,VPRA9000               * not on file
.
          MOVE      INAME,PRANAME                * save details
.
          MOVE      PRANAME,PRHRNAME
          MOVE      IADD1,PRHRADD1
          MOVE      IADD2,PRHRADD2
          MOVE      IADD3,PRHRADD3
          MOVE      IADD4,PRHRADD4
.
          MOVE      IPOST,PRHRPOST
          PACK      PRHRTELP,SP10,SP2
          MOVE      ITELEB,PRHRTELB
          MOVE      SP10,PRHRRELP
          GOTO      VPRA9999
.
VPRA9000  CALL      SETP0000               * get PRFA for non-compensation
.
VPRA9999  RETURN
+
.------------------------------------------------------------
. Validate private practice item code
.------------------------------------------------------------
VALITM00  CALL      XMLHED00
          BRANCH    EXIT,VALITM99
.
          PACK      KEY9A,VALDCODE,SP70
          PACK      KEY9,VALDCODE,SP70
          PACK      KEY3,VALDSUBN,SP70
          MOVE      ZERO,IFLAG                   * Default to MBS Item
          MATCH     ANSM,VALDTYPE
          GOTO      VALITM02 IF EQUAL
          MOVE      ONE,IFLAG                    * AMA Item
.
.         Check for test item
.
VALITM02  MOVE      ZERO,TFLAG
          MATCH     SP1,PRCNTCOD
          GOTO      VALITM20 IF EQUAL
          CMATCH    PRCNTCOD,VALDCODE
          GOTO      VALITM20 IF NOT EQUAL        * Not a test item
.
          MOVE      ONE,TFLAG                    * flag for test item
          UNPACK    VALDCODE,KEY1,PRITITMN       * item code
          MOVE      PRITITMN,KEY9A
.
          PACK      PRITITMN,PRITITMN,SP70
          PACK      KEY17,PRITITMN,NINE8         * position pointer after last
.                                                  record for this code
          CALL      RSPRTE1
VALITM10  CALL      RPPRTE1                      * read previous record
          BRANCH    OVRCD,VALITM91               * end of file
.
          MATCH     PRTECODE,PRITITMN            * same test code ?
          GOTO      VALITM91 IF NOT EQUAL        * no
          MATCH     PRTEDATE,RETURNDT            * service date < record date ?
          GOTO      VALITM10 IF LESS             * yes
.
          BRANCH    IFLAG,VALITM12               * AMA Item
.
          MOVE      PRTEITMN,KEY9
          MOVE      PRTESUBN,KEY3
          GOTO      VALITM20
.
VALITM12  MOVE      PRTEAMAN,KEY9
          MOVE      SP10,KEY3
.
.         Loop through priitem file
.
VALITM20  PACK      KEY22,IFLAG,KEY9,KEY3,NINE8
          CALL      RSPRIT1                      * position after last record
.                                                  for this item
VALITM30  CALL      RPPRIT1                      * read previous record
          BRANCH    OVRCD,VALITM90               * end of file
.
          COMPARE   IFLAG,PRITFLAG               * same item type ?
          GOTO      VALITM90 IF NOT EQUAL        * no
.
          MATCH     KEY9,PRITITMN                * same item number ?
          GOTO      VALITM90 IF NOT EQUAL        * no
.
          MATCH     KEY3,PRITSUBN                * same subitem number ?
          GOTO      VALITM90 IF NOT EQUAL        * no
.
          MATCH     PRITDAT1,RETURNDT            * item date > service date ?
          GOTO      VALITM30 IF LESS             * yes
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     RETURNDT,PRITDAT2
            GOTO      VALITM30 IF LESS      * ed next if past Cease date
          ENDIF                                                * end  *I-230710
.
.         Valid item
.
          CALL      EXCP0000           * Check for exception charge
          IF        EXIT=1
            MOVE      PREXCHRG,PRITSFEE
          ENDIF
          IF        TFLAG=1
            MOVE      PRTEDESC,PRITDESC  * Flag for keyin description
          ENDIF
.
          MOVE      PRITKEYI,AMNTKEYI
          IF        PRITFIXD=1
            MOVE      ZERO,AMNTKEYI    * Fixed item, no keyin amount
          ENDIF
.
          CALL      VALD0000           * Check item date
          BRANCH    EXIT,VALITM92
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRITDESC,"|",PRITSFEE,"|":
                             PRITGSTA,"|",PRITGSTC,"|":
                             TFLAG,"|",KEY9A,"|",IFLAG,"|":
                             PRITKEYI,"|":
                             AMNTKEYI,"|",PRITSETC,"|":
                             PRITSF75,"|",PRITSF85,"|":
                             PRITSAFE,"|":
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Item not set up for service date.":
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Test Code not set up for service date.":
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient was not admitted on this date.":
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM98  CALL      XMLEND00
VALITM99  RETURN
+
.------------------------------------------------------------
. Validate private practice referring doctor transaction (prcnrdoc=1)
.------------------------------------------------------------
VALRDC00  CALL      XMLHED00
          BRANCH    EXIT,VALRDC99
.
          PACK      KEY45,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,PRHTR005,PRHTR006
          PACK      KEY62,KEY45,SP70
          CALL      RSPRHT1
          CALL      RKPRHT1
          BRANCH    OVRCD,VALRDC80
.
.      check if referral already exists
.
          PACK      KEY45A,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD,PRHTRDAT
          MATCH     KEY45,KEY45A
          GOTO      VALRDC90 IF EQUAL
.
VALRDC80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "OK":
                             "</RETURN_VALUE>"
          GOTO      VALRDC98
.
VALRDC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Referring Doctor & Date record already exists.":
                             "</RETURN_VALUE>"
          GOTO      VALRDC98
.
VALRDC98  CALL      XMLEND00
VALRDC99  RETURN
+
.***************************************************************************
.*                                 VALD0000            Called by: TADD0000 *
.*              if an inpatient, validate that patient was actually        *
.*              admitted when the service was performed                    *
.*    RETURNS:  EXIT    0 = valid inpatient                                *
.*                      1 = invalid inpatient                              *
.***************************************************************************
VALD0000  MOVE      ZERO,EXIT
          READ      CONTROLF,THIRTY3;*181,PRCNPSYS
          COMPARE   ZERO,PRCNPSYS                * using patient system ?
          GOTO      VALD9999 IF EQUAL            * no
.
          MOVE      "GI",TCODE
          MOVE      PRHRE003,ACODE
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1
          BRANCH    OVRCD,VALD9999
          MATCH     ANSI,TCINDC1                 * inpatient ?
          GOTO      VALD9999 IF NOT EQUAL        * no
.
          PACK      KEY24,URNUMBER,SP20
          CALL      RDSVISA2                     * position in visit file
VALD1000  CALL      RDKVISA2                     * read next record
          BRANCH    OVRCD,VALD9500               * not on file
.
          MATCH     URNUMBER,PVIURNO             * same u/r number ?
          GOTO      VALD9500 IF NOT EQUAL        * no
.
          COMPARE   THREE,PVITYPE                * inpatient admission ?
          GOTO      VALD1000 IF NOT EQUAL        * no
.
          MATCH     PVIDATE,RETURNDT             * service date < admission date
          GOTO      VALD1000 IF LESS             * yes - get next admission
.
          PACK      KEY8,PVIBILL
          CALL      RDMISS1
          IF        (OVRCD=1) | (ASTAT=1) | (ASTAT=5)
            GOTO      VALD1000
          ENDIF
.
          IF        ASTAT=2|ASTAT=4
            GOTO      VALD9000     * currently admitted or on leave
          ENDIF
.
          MOVE      PVIBILL,KEY8
          OPEN      PATDSCH1,"patdschf"          * discharge file
          CALL      RDDSCH1                      * read discharge record
          CLOSE     PATDSCH1
          BRANCH    OVRCD,VALD9000               * not on file
.
          MOVE      DDATE,KEY8
          MATCH     RETURNDT,KEY8                * discharge date < service date
          GOTO      VALD1000 IF LESS             * yes - get next admission
.
VALD9000  MOVE      ZERO,EXIT                    * valid inpatient
          GOTO      VALD9999

VALD9500  MOVE      ONE,EXIT
VALD9999  RETURN
+
.***************************************************************************
.*                              EXCP0000                                   *
.*                    Check for exception charges                          *
.***************************************************************************
EXCP0000  MOVE      CLAIMCOD,TMPCLAIM   * claim code
          MOVE      IFLAG,TMPIFLAG      * AMA or MBS
          MOVE      KEY9,TMPITEM        * item number
          MOVE      KEY3,TMPSITEM       * sub-item number
          MOVE      RETURNDT,TMPSDATE   * service date
          CALL      ISEXC000            * from PRIINVPR
.
EXCP9999  RETURN
+
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD99,PROFLD99,PROFLD99,PROFLD99:
                             PROFLD60,PROFLD99,PROFLD80,PROFLD99,PROFLD99:
                             PROFL110,PROFLD99,PROFL130,PROFL130,PROFL150
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFL191
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD12  CALL      PRHR0000       * Doctor referral file
          GOTO      PROFLD99
.
PROFLD13  CALL      RFDE0000       * Doctor referral
          GOTO      PROFLD99
.
PROFLD14  CALL      PRWC0000       * Workers compensation
          GOTO      PROFLD99
.
PROFLD15  CALL      PRMB0000       * Motor Accident
          GOTO      PROFLD99
.
PROFLD16  CALL      PRVA0000       * Veteran affairs
          GOTO      PROFLD99
.
PROFLD17  CALL      PMIX0000       * Patient extension file
          GOTO      PROFLD99
.
PROFLD18  CALL      HTRE0000       * Holding debtor variables
          GOTO      PROFLD99
.
PROFLD19  CALL      PRCT0000       * Civil tort
          GOTO      PROFLD99
.
PROFL191  CALL      MSXF0000       * PMI Master file extension
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD62  CALL      ITMN0000       * Input item variables
          GOTO      PROFLD99
.
PROFLD63  CALL      HTRE0000       * Holding debtor variables
          GOTO      PROFLD99
.
PROFLD64  CALL      RFDE0000     
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD82  CALL      ACCS0000       * Account status
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113
          GOTO      PROFLD99
.
PROFL111  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFL112  CALL      PRHR0000       * Doctor referral file
          GOTO      PROFLD99
.
PROFL113  CALL      RFDE0000       * Doctor referral
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132
          GOTO      PROFLD99
.
PROFL131  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFL132  CALL      PRCM0000       * referral comment file
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152,PROFL153
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFL152  CALL      PRHR0000       * Doctor referral file
          GOTO      PROFLD99
.
PROFL153  CALL      RFDE0000       * Doctor referral
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.-----------------------------------------------------------
. Referral Comment details
.-----------------------------------------------------------
PRCM0000  BRANCH    FLDITMNO,PRCM0100,PRCM0200,PRCM0300,PRCM0400,PRCM0500:
                             PRCM0600,PRCM0700,PRCM0800,PRCM0900,PRCM1000:
                             PRCM1100,PRCM1200,PRCM1300,PRCM1400,PRCM1500:
                             PRCM1600,PRCM1700,PRCM1800,PRCM1900,PRCM2000
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PRCM9999
.
PRCM0100  WRITE     HTMLFILE;UNIQNUMB;
          GOTO      PRCM9999
.
PRCM0200  WRITE     HTMLFILE;PRHRE001;
          GOTO      PRCM9999
.
PRCM0300  WRITE     HTMLFILE;PRHRE002;
          GOTO      PRCM9999
.
PRCM0400  WRITE     HTMLFILE;PRHRE003;
          GOTO      PRCM9999
.
PRCM0500  MATCH     SP70,PRCDCTYP
          GOTO      PRCM9999 IF EQUAL
          WRITE     HTMLFILE;PRCDCTYP;
          GOTO      PRCM9999
.
PRCM0600  MATCH     SP70,PRCDNOTE
          GOTO      PRCM9999 IF EQUAL
          WRITE     HTMLFILE;PRCDNOTE;
          GOTO      PRCM9999
.
PRCM0700  MATCH     SP70,PRCDIDAT
          GOTO      PRCM9999 IF EQUAL
          UNPACK    PRCDIDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      PRCM9999
.
PRCM0800  MATCH     SP70,PRCDITIM
          GOTO      PRCM9999 IF EQUAL
          WRITE     HTMLFILE;PRCDITIM;
          GOTO      PRCM9999
.
PRCM0900  CALL      REFC0000            * Referral comment list
          GOTO      PRCM9999
.
PRCM1000  CALL      RCMTAB00            * Referral comments table
          GOTO      PRCM9999
.
PRCM1100  WRITE     HTMLFILE;WBSEGENR;
          GOTO      PRCM9999
.
PRCM1200  WRITE     HTMLFILE;NOTENUMB;
          GOTO      PRCM9999
.
PRCM1300  CALL      ICMTAB00            * Invoice comments table
          GOTO      PRCM9999
.
PRCM1400  WRITE     HTMLFILE;INVOICEN;
          GOTO      PRCM9999
.
PRCM1500  MATCH     SP70,PRICIDAT
          GOTO      PRCM9999 IF EQUAL
          UNPACK    PRICIDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FBOKDATE;
          GOTO      PRCM9999
.
PRCM1600  MATCH     SP70,PRICITIM
          GOTO      PRCM9999 IF EQUAL
          WRITE     HTMLFILE;PRICITIM;
          GOTO      PRCM9999
.
PRCM1700  CALL      INVC0000            * Invoice comment list
          GOTO      PRCM9999
.
PRCM1800  WRITE     HTMLFILE;PRINNUMB;
          GOTO      PRCM9999
.
PRCM1900  PACK      KEY10,PRICIUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM;
          ELSE
            WRITE     HTMLFILE;PRICIUSR;
          ENDIF
          GOTO      PRCM9999
.
PRCM2000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMCL0000                * Eclipse other claimant tags
          GOTO      PRCM9999
.
PRCM9999  RETURN
+
.------------------------------------------------------------
.         List of Referral comments
.------------------------------------------------------------
REFC0000  PACK      SKEY27,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND,SP70
          PACK      KEY39,SKEY27:
                          PRCDCTYP,PRCDNOTE,SP70
          CALL      RSPRCFX1
REFC1000  CALL      RKPRCFX1
          BRANCH    OVRCD,REFC9999
.
          PACK      KEY27,PRCFUNIQ,PRCFPRAC,PRCFDOCT,PRCFPIND,SP70
          MATCH     KEY27,SKEY27
          GOTO      REFC9999 IF NOT EQUAL
.
          MATCH     PRCDCTYP,PRCFCTYP
          GOTO      REFC1000 IF NOT EQUAL
.
          MATCH     PRCDNOTE,PRCFNOTE
          GOTO      REFC1000 IF NOT EQUAL
.
          STRIP     PRCFCMNT
          MOVELPTR  PRCFCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      PRCFCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      REFC1000
.
REFC9999  RETURN
+
.------------------------------------------------------------
.         Check Referral comments
.------------------------------------------------------------
CRMN0000  MOVE      ZERO,F1
          MOVE      "001",KEY3
          PACK      SKEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          PACK      KEY36,SKEY27,KEY3,Z70
          CALL      RSPRCDT1
CRMN1000  CALL      RPPRCDT1
          BRANCH    OVRCD,CRMN9000
.
          PACK      KEY27,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND,SP70
          MATCH     KEY27,SKEY27
          GOTO      CRMN9000 IF NOT EQUAL
.
          MATCH     KEY3,PRCDCTYP
          GOTO      CRMN9000 IF NOT EQUAL
.
          MATCH     "1",PRCDDIND
          GOTO      CRMN1000 IF EQUAL        * Deleted
.
          MOVE      ONE,F1
.
CRMN9000  WRITE     HTMLFILE;F1;
CRMN9999  RETURN
+
.------------------------------------------------------------
. Display Table of Referral Comment
.---------------------------------------------------------------------
RCMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      RCMHD000      * Output Table Heading
.
          MOVE      UNIQNUMB,PRCDUNIQ       * unique id
          MOVE      PRHRE001,PRCDPRAC       * medical practice
          MOVE      PRHRE002,PRCDDOCT       * service doctor
          MOVE      PRHRE003,PRCDPIND       * patient indicator
          MOVE      "001",NOTETYPE          * Notes Type
.
          PACK      SKEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          PACK      KEY36,SKEY27,NOTETYPE,SP70
          CALL      RSPRCDT1
RCMTAB10  CALL      RKPRCDT1
          BRANCH    OVRCD,RCMTAB99
.
          PACK      KEY27,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND,SP70
          MATCH     KEY27,SKEY27
          GOTO      RCMTAB99 IF NOT EQUAL
.
          MATCH     NOTETYPE,PRCDCTYP
          GOTO      RCMTAB99 IF NOT EQUAL
.
          MATCH     PRCDIDAT,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FBOKDATE
            GOTO     RCMTAB40
          ENDIF
.
          UNPACK    PRCDIDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
RCMTAB40  MATCH     "1",PRCDDIND
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",UNIQNUMB       * unique id
          REP       " +",PRHRE001       * medical practice
          REP       " +",PRHRE002       * service doctor
          REP       " +",PRHRE003       * patient indicator
          REP       " +",PRCDCTYP       * Comment type
          REP       " +",PRCDNOTE       * Note Number
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&uniqnumb=",UNIQNUMB:
                             "&prhre001=",PRHRE001:
                             "&prhre002=",PRHRE002:
                             "&prhre003=",PRHRE003:
                             "&notetype=",PRCDCTYP:
                             "&notenumb=",PRCDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,PRCDITIM,"</td>";
.
          PACK      KEY10,PRCDIUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",PRCDIOCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,PRCDIUSR," - ",PRCDIOCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",UNIQNUMB       * unique id
          REP       "+ ",PRHRE001       * medical practice
          REP       "+ ",PRHRE002       * service doctor
          REP       "+ ",PRHRE003       * patient indicator
          REP       "+ ",PRCDCTYP       * Comment type
          REP       "+ ",PRCDNOTE       * Note Number
.
          CALL      RCNOTE00
.
          PACK      KEY10,PRCDDUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",WBSENAM," - ",PRCDIOCG,"&nbsp":
                               "</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",PRCDDUSR," - ",PRCDIOCG,"&nbsp":
                               "</td>":
                               "</tr>"
          ENDIF
.
          GOTO      RCMTAB10
RCMTAB99  RETURN
+
.--------------------------------------------------------------------
. Referral Comment display
.--------------------------------------------------------------------
RCNOTE00  MOVE      ZERO,F1
          PACK      SKEY27,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND,SP70
          PACK      KEY39,SKEY27:
                          PRCDCTYP,PRCDNOTE,SP70
          CALL      RSPRCFX1
RCNOTE10  CALL      RKPRCFX1
          BRANCH    OVRCD,RCNOTE99
.
          PACK      KEY27,PRCFUNIQ,PRCFPRAC,PRCFDOCT,PRCFPIND,SP70
          MATCH     KEY27,SKEY27
          GOTO      RCNOTE99 IF NOT EQUAL
.
          MATCH     PRCDCTYP,PRCFCTYP           * same comment type?
          GOTO      RCNOTE99 IF NOT EQUAL
.
          MATCH     PRCDNOTE,PRCFNOTE           * same note number?
          GOTO      RCNOTE99 IF NOT EQUAL
.
          COMPARE   TWO,F1
          GOTO      RCNOTE99 IF EQUAL
          ADD       ONE,F1
          WRITE     HTMLFILE;PRCFCMNT,"<br>";
          GOTO      RCNOTE10
.
RCNOTE99  RETURN

.------------------------------------------------------------
. Referral Comment Heading (TABLE HEADING)
.------------------------------------------------------------
RCMHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>";
.
          WRITE     HTMLFILE;"Referral Comments</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"
.
RCMHD999  RETURN
+
.------------------------------------------------------------
. Display Table of Invoice Comment
.---------------------------------------------------------------------
ICMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      ICMHD000      * Output Table Heading
.
          MOVE      INVOICEN,DINVNUMB
          MOVE      INVOICEN,PRICINVN       * invoice no
          MOVE      "001",NOTETYPE          * Notes Type
.
          PACK      KEY17,PRICINVN,NOTETYPE,Z70
          CALL      RSPRICM1
ICMTAB10  CALL      RPPRICM1
          BRANCH    OVRCD,ICMTAB99
.
          MATCH     DINVNUMB,PRICINVN
          GOTO      ICMTAB99 IF NOT EQUAL
.
          MATCH     NOTETYPE,PRICCTYP
          GOTO      ICMTAB99 IF NOT EQUAL
.
          MATCH     PRICIDAT,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FBOKDATE
            GOTO     ICMTAB40
          ENDIF
.
          UNPACK    PRICIDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
ICMTAB40  MATCH     "1",PRICDIND
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",DINVNUMB       * unique id
          REP       " +",PRICCTYP       * Comment type
          REP       " +",PRICNOTE       * Note Number
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&invoicen=",PRICINVN:
                             "&notetype=",PRICCTYP:
                             "&notenumb=",PRICNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,FBOKDATE,SP1,PRICITIM,"</td>";
.
          PACK      KEY10,PRICIUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",PRICIOCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,PRICIUSR," - ",PRICIOCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td>",STRIKETG;
          ENDIF
.
          REP       "+ ",DINVNUMB       * unique id
          REP       "+ ",PRICCTYP       * Comment type
          REP       "+ ",PRICNOTE       * Note Number
.
          CALL      ICNOTE00
.
          PACK      KEY10,PRICDUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",WBSENAM," - ",PRICDOCG,"&nbsp":
                               "</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",PRICDUSR," - ",PRICDOCG,"&nbsp":
                               "</td>":
                               "</tr>"
          ENDIF
.
          GOTO      ICMTAB10
ICMTAB99  RETURN
+
.--------------------------------------------------------------------
. Invoice Comment display
.--------------------------------------------------------------------
ICNOTE00  MOVE      ZERO,F1
          PACK      KEY20,DINVNUMB,PRICCTYP,PRICNOTE,SP70
          CALL      RSPRIFX1
ICNOTE10  CALL      RKPRIFX1
          BRANCH    OVRCD,ICNOTE99
.
          MATCH     DINVNUMB,PRIFINVN            * same invoice number?
          GOTO      ICNOTE99 IF NOT EQUAL
.
          MATCH     PRICCTYP,PRIFCTYP            * same comment type?
          GOTO      ICNOTE99 IF NOT EQUAL
.
          MATCH     PRICNOTE,PRIFNOTE            * same note number?
          GOTO      ICNOTE99 IF NOT EQUAL
.
          COMPARE   TWO,F1
          GOTO      ICNOTE99 IF EQUAL
          ADD       ONE,F1
          WRITE     HTMLFILE;PRIFCMNT,"<br>";
          GOTO      ICNOTE10
.
ICNOTE99  RETURN
.
.------------------------------------------------------------
. Invoice Comment Heading (TABLE HEADING)
.------------------------------------------------------------
ICMHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>";
.
          WRITE     HTMLFILE;"Invoice Comments</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"
.
ICMHD999  RETURN
+
.------------------------------------------------------------
.         List of Invoice comments
.------------------------------------------------------------
INVC0000  PACK      KEY20,PRICINVN,PRICCTYP,PRICNOTE,SP70
          CALL      RSPRIFX1
INVC1000  CALL      RKPRIFX1
          BRANCH    OVRCD,INVC9999
.
          MATCH     PRICINVN,PRIFINVN
          GOTO      INVC9999 IF NOT EQUAL
.
          MATCH     PRICCTYP,PRIFCTYP
          GOTO      INVC1000 IF NOT EQUAL
.
          MATCH     PRICNOTE,PRIFNOTE
          GOTO      INVC1000 IF NOT EQUAL
.
          STRIP     PRIFCMNT
          MOVELPTR  PRIFCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      PRIFCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      INVC1000
.
INVC9999  RETURN
+
.-----------------------------------------------------------
. Referral details
.-----------------------------------------------------------
RFDE0000  BRANCH    FLDITMNO,RFDE0100,RFDE0200,RFDE0300,RFDE0400,RFDE0500:
                             RFDE0600,RFDE0700,RFDE0800,RFDE0900,RFDE1000:  *10
                             RFDE1100,RFDE1200,RFDE1300,RFDE1400,RFDE1500:
                             RFDE1600,RFDE1700,RFDE1800,RFDE1900,RFDE2000:  *20
                             RFDE2100,RFDE2200,RFDE2300,RFDE2400,RFDE2500:
                             RFDE2600,RFDE2700,RFDE2800,RFDE2900,RFDE3000:  *30
                             RFDE3100,RFDE3200,RFDE3300,RFDE3400,RFDE3500:
                             RFDE3600,RFDE3700,RFDE3800,RFDE3900,RFDE4000:  *40
                             RFDE4100,RFDE4200,RFDE4300,RFDE4400,RFDE4500:
                             RFDE4600,RFDE4700,RFDE4800,RFDE4900,RFDE5000:  *50
                             RFDE5100,RFDE5200,RFDE5300,RFDE5400,RFDE5500:
                             RFDE5600,RFDE5700,RFDE5800,RFDE5900,RFDE6000
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      RFDE9999
.
RFDE0100  CALL      RFLS0000              * Doctor Referral list
          GOTO      RFDE9999
.
RFDE0200  CALL      PREVGR00              * previous page
          GOTO      RFDE9999
.
RFDE0300  CALL      NEXTGR00              * next page
          GOTO      RFDE9999
.
RFDE0400  MOVE      "CL",CATEGORY         * claim code
          MOVE      PRHDCLAM,CODE
          CALL      CODITM00
          GOTO      RFDE9999
.
RFDE0500  MATCH     PRHDACCD,SP70         * accident date
          GOTO      RFDE9999 IF EQUAL
.
          UNPACK    PRHDACCD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      RFDE9999
.
RFDE0600  WRITE     HTMLFILE;PRCNRDOC;
          GOTO      RFDE9999
.
RFDE0700  WRITE     HTMLFILE;UNIQNUMB;
          GOTO      RFDE9999
.
RFDE0800  WRITE     HTMLFILE;PRHRE001;
          GOTO      RFDE9999
.
RFDE0900  WRITE     HTMLFILE;PRHRE002;
          GOTO      RFDE9999
.
RFDE1000  WRITE     HTMLFILE;PRHRE003;
          GOTO      RFDE9999
.
RFDE1100  MOVE      ONE,VSCANPMI                 * PMI UR number
          CALL      CREATP00                     * create temp files
          MOVE      ZERO,INVFLAG                 * display invoice
          CALL      NXIV0000                     * Generate Next Invoice
          GOTO      RFDE9999
.
RFDE1200  CALL      DISN0000                     * Display items on next invoice
          CALL      CLRTF000                     * clear temp files
          GOTO      RFDE9999
.
RFDE1300  WRITE     HTMLFILE;INVOICEN;
          GOTO      RFDE9999
.
RFDE1400  WRITE     HTMLFILE;PRINNAMR;
          GOTO      RFDE9999
.
RFDE1500  WRITE     HTMLFILE;PRINPRA1;
          GOTO      RFDE9999
.
RFDE1600  WRITE     HTMLFILE;PRINPRA2;
          GOTO      RFDE9999
.
RFDE1700  WRITE     HTMLFILE;PRINPRA3;
          GOTO      RFDE9999
.
RFDE1800  WRITE     HTMLFILE;PRINPOST;
          GOTO      RFDE9999
.
RFDE1900  WRITE     HTMLFILE;PRINTELP;
          GOTO      RFDE9999
.
RFDE2000  WRITE     HTMLFILE;PRINTELB;
          GOTO      RFDE9999
.
RFDE2100  WRITE     HTMLFILE;PRINRELP;
          GOTO      RFDE9999
.
RFDE2200  CALL      PNLS0000                * Pending Invoices list
          GOTO      RFDE9999
.
RFDE2300  WRITE     HTMLFILE;OLDCLAIM;
          GOTO      RFDE9999
.
RFDE2400  MOVE      "CL",CATEGORY           * claim code
          MOVE      NEWCLAIM,CODE
          CALL      CODITM00
          GOTO      RFDE9999
.
RFDE2500  WRITE     HTMLFILE;PROGFLAG;
          GOTO      RFDE9999
.
RFDE2600  CALL      DCLM0000                * Display claim details
          GOTO      RFDE9999
.
RFDE2700  WRITE     HTMLFILE;PRCNDOCM;      * Referral Doc Mandatory Parameter
          GOTO      RFDE9999
.
RFDE2800  WRITE     HTMLFILE;ADDITMSC;      * 'Add Items Screen' display flag
          GOTO      RFDE9999
.
RFDE2900  CALL      RDOCLS00                * List of referring doc (prcnrdoc=1)
          GOTO      RFDE9999
.
RFDE3000  CALL      CCMN0000
          WRITE     HTMLFILE;F1;            * Comments
          GOTO      RFDE9999
.
RFDE3100  MOVE      ONE,F1                  * default to inactive
          MOVE      PRHRE001,KEY6
          CALL      RDPRPR1
          IF        OVRCD=0 & PRPRSTAT=0
            PACK      KEY10,PRHRE002,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     "1",PMHCSTTS
              IF        !@EQUAL
                MOVE      ZERO,F1           * Active MP and Service Doctor
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;F1;
          GOTO      RFDE9999
.
RFDE3200  WRITE     HTMLFILE;PRINPRA4;
          GOTO      RFDE9999
.
RFDE3300  WRITE     HTMLFILE;PRINMPHN;
          GOTO      RFDE9999
.
RFDE3400  WRITE     HTMLFILE;NETTOT;
          GOTO      RFDE9999
.
RFDE3500  CALL      CRMN0000            * Check Referral Comments
          GOTO      RFDE9999
.
RFDE3600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RFDE3610
.
          WRITE     HTMLFILE;PRHDHFND;
.
          GOTO      RFDE9999
.
RFDE3610  MATCH     SP70,PRHDHFND
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,RFDE9999
.
          WRITE     HTMLFILE;HFNAME;
.
          GOTO      RFDE9999
.
RFDE3700  CALL      ECLIND00
          GOTO      RFDE9999 
.
RFDE3800  MOVE      "ro",CATEGORY
          MOVE      PRHTROVR,CODE
          CALL      CODITM00
          GOTO      PRHR9999
.
RFDE3900  PACK      KEY62,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,PRHRREFD,PRHRRDAT:
                          SP1,TWO,SP9,SP3,SP1,SP1,ONE,SP70
          CALL      RDPRHT1
          IF        OVRCD=ONE
            CALL      CLPRIHTR
          ENDIF
.
          MOVE      "ro",CATEGORY
          MOVE      PRHTROVR,CODE
          CALL      CODITM00
.
          GOTO      PRHR9999
.
RFDE4000  MOVE      "ro",CATEGORY
          MOVE      PRDTROVR,CODE
          CALL      CODITM00
          GOTO      PRHR9999
.
RFDE4100  WRITE     HTMLFILE;INVOICEN;
          GOTO      RFDE9999
.
RFDE4200  WRITE     HTMLFILE;PRHRDOCT;
          GOTO      RFDE9999
.
RFDE4300  MOVE      "CL",CATEGORY
          MOVE      PRHDCLAM,CODE
          CALL      GETCOD00
.
          MATCH     "W",TCINDC1
          GOTO      RFDE4350 IF EQUAL
.
          MATCH     "M",TCINDC1
          GOTO      RFDE4350 IF EQUAL
.
          MATCH     "V",TCINDC1
          GOTO      RFDE4350 IF EQUAL
.
          WRITE     HTMLFILE;ZERO;
          GOTO      RFDE9999
.
RFDE4350  WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE4400  MOVE      "2",CONTTYPE          * Postal Address
          CALL      XCON0000              * Get extra contact details
.
          UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMCE0000              * New contact tags
          GOTO      RFDE9999
.
RFDE4500  MATCH     SP70,PRHRE028
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRE028,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "5",TCINDC1
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999 
.
RFDE4600  MATCH     SP70,PRHRTACC
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "5",TCINDC1
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE4700  MATCH     SP70,PRHRE028
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRE028,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "3",TCINDC1                * Check for Bulk billing
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999 
.
RFDE4800  MATCH     SP70,PRHRTACC
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "3",TCINDC1                * Check for Bulk billing
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE4900  MATCH     SP70,PRHRE028
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRE028,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "1",TCINDC1                * Check for IMC Agreement
          GOTO      RFDE4910 IF EQUAL
.
          MATCH     "2",TCINDC1                * Check for IMC Scheme 
          GOTO      RFDE4910 IF EQUAL
.
          MATCH     "6",TCINDC1                * Check for IMC Benefit   
          GOTO      RFDE4910 IF EQUAL
.
          MATCH     "7",TCINDC1                * Check for IMC Only     
          GOTO      RFDE4910 IF EQUAL
.
          GOTO      RFDE9999
.
RFDE4910  WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE5000  MATCH     SP70,PRHRTACC
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "1",TCINDC1                * Check for IMC Agreement
          GOTO      RFDE5010 IF EQUAL
.
          MATCH     "2",TCINDC1                * Check for IMC Scheme
          GOTO      RFDE5010 IF EQUAL
.
          MATCH     "6",TCINDC1                * Check for IMC Benefit
          GOTO      RFDE5010 IF EQUAL
.
          MATCH     "7",TCINDC1                * Check for IMC Only
          GOTO      RFDE5010 IF EQUAL
.
          GOTO      RFDE9999
.
RFDE5010  WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE5100  CALL      ECLESF00
          GOTO      RFDE9999
.
RFDE5200  CALL      AGEA0000
          WRITE     HTMLFILE;F1;
          GOTO      RFDE9999
.
RFDE5300  CALL      ECLEBB00
          GOTO      RFDE9999
.
RFDE5400  MATCH     "1",PRHRACPD
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      RFDE9999
.
RFDE5500  WRITE     HTMLFILE;INVIACTV;
          GOTO      RFDE9999
.
RFDE5600  MOVE      "GI",CATEGORY
          PACK      KEY5,CATEGORY,PRHRE003
          CALL      RDCODE1
          WRITE     HTMLFILE;TCINDC2;
          GOTO      RFDE9999
.
RFDE5700  MOVE      "GI",CATEGORY
          PACK      KEY5,CATEGORY,PRHRE003
          CALL      RDCODE1
.
          WRITE     HTMLFILE;TCINDC3;
          GOTO      RFDE9999
.
RFDE5800  CALL      ECLDVA00
          GOTO      RFDE9999
.
RFDE5900  MATCH     SP70,PRHRTACC
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "8",TCINDC1                * Check for DVAW
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
.
RFDE6000  MATCH     SP70,PRHRE028
          GOTO      RFDE9999 IF EQUAL
          GOTO      RFDE9999 IF EOS
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRE028,CODE
.
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RFDE9999
.
          MATCH     "8",TCINDC1                * Check for Bulk billing
          GOTO      RFDE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      RFDE9999
. 
RFDE9999  RETURN
+
.-----------------------------------------------------------
.         Check if there are exising comments
.-----------------------------------------------------------
CCMN0000  OPEN      PRICMNT1,"pricmntf"
          MOVE      ZERO,F1
          PACK      KEY13,URNUMBER,SP70
          CALL      RSPRCM1
          CALL      RKPRCM1
          BRANCH    OVRCD,CCMN9000          * end of file
          MATCH     PRCMDEBT,URNUMBER       * same U/R Number?
          GOTO      CCMN9000 IF NOT EQUAL
          MOVE      ONE,F1
CCMN9000  CLOSE     PRICMNT1
CCMN9999  RETURN
+
.-----------------------------------------------------------
. Input items
.-----------------------------------------------------------
ITMN0000  BRANCH    FLDITMNO,ITMN0100,ITMN0200,ITMN0300,ITMN0400,ITMN0500:
                             ITMN0600,ITMN0700,ITMN0800,ITMN0900,ITMN1000:
                             ITMN1100,ITMN1200,ITMN1300,ITMN1400,ITMN1500:
                             ITMN1600,ITMN1700,ITMN1800,ITMN1900,ITMN2000:
                             ITMN2100,ITMN2200,ITMN2300,ITMN2400,ITMN2500:
                             ITMN2600
          GOTO      ITMN9999
.
ITMN0100  WRITE     HTMLFILE;UNIQNUMB;
          GOTO      ITMN9999
.
ITMN0200  WRITE     HTMLFILE;PRHRE001;
          GOTO      ITMN9999
.
ITMN0300  WRITE     HTMLFILE;PRHRE002;
          GOTO      ITMN9999
.
ITMN0400  WRITE     HTMLFILE;PRHRE003;
          GOTO      ITMN9999
.
ITMN0500  MOVE      "CL",CATEGORY         * claim code
          MOVE      PRHDCLAM,CODE
          CALL      CODITM00
          GOTO      ITMN9999
.
ITMN0600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ITMN0610,ITMN0620
          WRITE     HTMLFILE;PRTHD001;
          GOTO      ITMN9999
.
ITMN0610  PACK      KEY4,PRTHD001,SP70
          CALL      RDPRTHD1
          IF        OVRCD=0
            WRITE     HTMLFILE;PRTHDESC;
          ELSE
            WRITE     HTMLFILE;PRTHTMID;
          ENDIF
          GOTO      ITMN9999
.
ITMN0620  PACK      KEY4,SP10
          CALL      RSPRTHD1
ITMN0625  CALL      RKPRTHD1
          BRANCH    OVRCD,ITMN9999
.
          PACK      KEY35,PRTHDESC,SP30
          PACK      KEY6,QUOTE,PRTHTMID,QUOTE
.
          MATCH     PRTHD001,PRTHTMID
          IF        @EQUAL
             WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                       "(",PRTHTMID,") ",KEY35,"</option>"
          ELSE
             WRITE     HTMLFILE;"<option value=",KEY6,">":
                       "(",PRTHTMID,") ",KEY35,"</option>"
          ENDIF
          GOTO      ITMN0625
.
ITMN0700  CALL      CMITM000           * Populate common items
          GOTO      ITMN9999
.
ITMN0800  WRITE     HTMLFILE;COUNTITM;
          GOTO      ITMN9999
.
ITMN0900  UNPACK    PRITM001,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ITMN9999
.
ITMN1000  WRITE     HTMLFILE;PRITM002;
          GOTO      ITMN9999
.
ITMN1100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ITMN1110
          WRITE     HTMLFILE;PRITM003;
          GOTO      ITMN9999
.
ITMN1110  MOVE      "MBS",KEY3
          MATCH     "1",PRITM003
          IF        @EQUAL
            MOVE      "AMA",KEY3
          ENDIF
          WRITE     HTMLFILE;KEY3;
          GOTO      ITMN9999
.
ITMN1200  WRITE     HTMLFILE;PRITM004;
          GOTO      ITMN9999
.
ITMN1300  WRITE     HTMLFILE;PRITM005;
          GOTO      ITMN9999
.
ITMN1400  WRITE     HTMLFILE;PRITM006;
          GOTO      ITMN9999
.
ITMN1500  WRITE     HTMLFILE;PRITM007;
          GOTO      ITMN9999
.
ITMN1600  WRITE     HTMLFILE;PRITM008;
          GOTO      ITMN9999
.
ITMN1700  UNPACK   DIM127,D1,KEY1,DIM127
          MOVE     ZERO,F1
          MOVE     KEY1,F1
          BRANCH   F1,ITMN1710,ITMN1720
          WRITE    HTMLFILE;PRITM009;
          GOTO     ITMN9999
.
ITMN1710  MOVE     "Unknown ",KEY8
          IF       PRITM009=1
            MOVE     "Yes     ",KEY8
          ELSE
            IF       PRITM009=0
              MOVE     "No      ",KEY8
            ENDIF
          ENDIF
          WRITE    HTMLFILE;KEY8;
          GOTO     ITMN9999
.
ITMN1720  IF       PRITM009=2
            WRITE    HTMLFILE;"<option value=2 selected>":
                              "Unknown</option>":
                              "<option value=1>":
                              "Yes</option>":
                              "<option value=0>":
                              "No</option>";
          ELSE
            IF       PRITM009=1
              WRITE    HTMLFILE;"<option value=2>":
                                "Unknown</option>":
                                "<option value=1 selected>":
                                "Yes</option>":
                                "<option value=0>":
                                "No</option>";
            ELSE
              WRITE    HTMLFILE;"<option value=2>":
                                "Unknown</option>":
                                "<option value=1>":
                                "Yes</option>":
                                "<option value=0 selected>":
                                "No</option>";
            ENDIF
          ENDIF
          GOTO     ITMN9999
.
ITMN1800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ITMN1810,ITMN1820
          WRITE     HTMLFILE;PRITM010;
          GOTO      ITMN9999
.
ITMN1810  PACK      KEY6,PRITM010
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ELSE
            WRITE     HTMLFILE;PRITM010;
          ENDIF
          GOTO     ITMN9999
.
.   Display Selection List for GST code
.
ITMN1820  PACK      KEY6,SP70
          CALL      RSIBGS1
ITMN1830  CALL      RKIBGS1
          BRANCH    OVRCD,ITMN9999
.
          MATCH     IBGSCODE,PRITM010
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      ITMN1830
.
ITMN1900  MOVE      PRITM001,KEY8
          MOVE      PRITM003,PRTDTYPE
          MOVE      PRITM004,PRTDCODE
          MOVE      PRITM005,PRTDSUBI
          CALL      GETDES00
          WRITE     HTMLFILE;PRITKEYI;
          GOTO      ITMN9999
.
ITMN2000  MOVE      PRITM001,KEY8
          MOVE      PRITM003,PRTDTYPE
          MOVE      PRITM004,PRTDCODE
          MOVE      PRITM005,PRTDSUBI
          CALL      GETDES00
          MOVE      PRITKEYI,AMNTKEYI
          IF        PRITFIXD=1
            MOVE      ZERO,AMNTKEYI    * Fixed item, no keyin amount
          ENDIF
          WRITE     HTMLFILE;AMNTKEYI;
          GOTO      ITMN9999
.
ITMN2100  WRITE     HTMLFILE;ITEMNUMB;
          GOTO      ITMN9999
.
ITMN2200  CALL      CHKTIM00          * Setup Timeflag
          WRITE     HTMLFILE;TIMEFLAG;
          GOTO      ITMN9999
.
ITMN2300  WRITE     HTMLFILE;PRITM011;     * amount per item
          GOTO      ITMN9999
.
ITMN2400  READ      CONTROLF,THIRTY4;*196,PRCNTCOD
          WRITE     HTMLFILE;PRCNTCOD;
          GOTO      ITMN9999
.
ITMN2500  WRITE     HTMLFILE;PRITM012;     * test code
          GOTO      ITMN9999
.
ITMN2600  WRITE     HTMLFILE;PRITM013;     * S4flag
          GOTO      ITMN9999
.
ITMN9999  RETURN
+
.-----------------------------------------------------------
. Invoiced options
.-----------------------------------------------------------
ACCS0000  BRANCH    FLDITMNO,ACCS0100,ACCS0200,ACCS0300,ACCS0400,ACCS0500:
                             ACCS0600,ACCS0700,ACCS0800,ACCS0900,ACCS1000:
                             ACCS1100,ACCS1200
          GOTO      ACCS9999
.
ACCS0100  MOVE      NO,YESNO
          IF        PRHOHOLD=1
            MOVE      YES,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      ACCS9999
.
ACCS0200  WRITE     HTMLFILE;PRINNUMB;
          GOTO      ACCS9999
.
ACCS0300  MATCH     PRINDATE,SP70
          GOTO      ACCS9999 IF EQUAL
          UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      ACCS9999
.
ACCS0400  MOVE      "J ",CATEGORY
          MOVE      SP70,CODE
.
          UNPACK    DIM127,D1,KEY1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        F1=2
            CALL      SJRN0000                 * Selection of Journals
          ELSE
            CALL      CODITM00
            PACK      JOURDESC,TDESC
          ENDIF
          GOTO      ACCS9999
.
ACCS0500  CALL      KYGC0000                 * GST code
          GOTO      ACCS9999
.
ACCS0600  CALL      CPTR0000                 * Check PP Cash Transfer
          WRITE     HTMLFILE;FORM12P2;
          GOTO      ACCS9999
.
ACCS0700  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,ACCS9999
          CALL      SELINV00                 * Display available Invoices
          GOTO      ACCS9999
.
ACCS0800  WRITE     HTMLFILE;PRINITOT;
          GOTO      ACCS9999
.
ACCS0900  MOVE      INVOICEN,FORM8
          MOVE      FORM8,PRINNUMB
          MOVE      ZERO,FORM12P2
          CALL      TPAY0000              * Get total payment
          WRITE     HTMLFILE;FORM12P2;     * Total payment
          GOTO      ACCS9999
.
ACCS1000  MOVE      ZERO,FORM12P2
          ADD       PRINJAMT,FORM12P2
          ADD       PRINCNTT,FORM12P2
          ADD       PRINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;    * Total Journals
          GOTO      ACCS9999
.
ACCS1100  MOVE      INVOICEN,FORM8
          MOVE      ZERO,FORM12P2
          MOVE      FORM8,PRINNUMB
          CALL      TPAY0000              * Get total payment
.
          ADD       PRINITOT,FORM12P2
          ADD       PRINJAMT,FORM12P2
          ADD       PRINCNTT,FORM12P2
          ADD       PRINGSTJ,FORM12P2
          WRITE     HTMLFILE;FORM12P2;
          GOTO      ACCS9999
.
ACCS1200  MOVE      "CL",CATEGORY
          MOVE      PRINCLAM,CODE         * claim type
          CALL      CODITM00

ACCS9999  RETURN
+
.------------------------------------------------------------------------------
.      Selection of journals     
.------------------------------------------------------------------------------
SJRN0000  MOVE      ZERO,PUBCLAIM
          PACK      KEY5,CODECL,PRINCLAM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "P",TCINDC1
            IF        @EQUAL
              MOVE      ONE,PUBCLAIM               * Public
            ENDIF
          ENDIF
.
          MOVE      TCINDC15,DIM1                  * Cat CL Ind15
          APPEND    "abcdefghijklmnopqrstuvwxyz",VALINTXT
          APPEND    "ABCDEFGHIJKLMNOPQRSTUVWXYZ",VALINTXT
          APPEND    "0123456789",VALINTXT
          RESET     VALINTXT
.
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>"
.
.         Check if Indicator value is within the range a-zA-Z0-9
          SCAN      DIM1,VALINTXT
          IF        !@EQUAL
            GOTO      SJRN9999
          ENDIF
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
SJRN1000  CALL      RDKCODE2
          BRANCH    OVRCD,SJRN9999
          MATCH     CATEGORY,TCODE
          GOTO      SJRN9999 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      SJRN1000 IF EQUAL
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV
.
          IF        CATACTIV<>2
            MATCH     "I",PTCOACTV
            GOTO      SJRN1000 IF EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,SJRN1000
            ENDIF
          ENDIF
.
.         Check parameter for 'Enable restricted Journals on Invoice'
.
          MATCH     "1",PTCNRJNL
          GOTO      SJRN6000 IF NOT EQUAL
.
.         Display journal type indic7=P for Public Claim type (Cat CL indic1=P)
.
          IF        PUBCLAIM=1
            MATCH     "P",TCINDC7
            GOTO      SJRN1000 IF NOT EQUAL       * Not for Public
          ELSE
            MATCH     "P",TCINDC7
            GOTO      SJRN1000 IF EQUAL           * Only for Public
          ENDIF
.
.         If parameter Enable restricted Journals on Invoice is turned on and
.         Cat CL Ind15 is not equal to Cat J Ind 7 then exclude
          MATCH       "1",PTCNRJNL
          IF          @EQUAL
.
.           Exclude rule if is self funded
            MATCH     "S",DIM1
            IF        !@EQUAL    
              RESET       VALINTXT
              SCAN        TCINDC7,VALINTXT
              IF          !@EQUAL
                GOTO        SJRN1000
              ENDIF
.
              MATCH       SP1,DIM1
              IF          !@EQUAL
                MATCH       DIM1,TCINDC7
                GOTO        SJRN1000 IF NOT EQUAL
              ENDIF
.
.         If patient is NOT 'Self funded' then Exclude 'Self funded' journals
.         If patient is 'Self funded' then include only 'Self funded' journals
              MATCH     SP70,TCINDC5             * exclude if ind5<>blank
              GOTO      SJRN1000 IF NOT EQUAL
            ELSE 
              MATCH     SP70,TCINDC5             * only ind5<>blank      
              GOTO      SJRN1000 IF EQUAL
            ENDIF
.
.           Cat CL ind 15 = blank then display record where Catj Ind 7 != blank
            MATCH     SP1,DIM1
            IF        @EQUAL
              MATCH       SP70,TCINDC7
              GOTO        SJRN1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
SJRN6000  WRITE     HTMLFILE;"<option value=#"",ACODE,KEY40,"#">",TDESC:
                             "</option>"
          GOTO      SJRN1000
.
SJRN9999  RETURN
+
.------------------------------------------------------------------------------
.      get all receipts/payments
.------------------------------------------------------------------------------
TPAY0000 PACK      SAVKEY12,SP4,PRINNUMB,SP70  * set up invoice number
         PACK      KEY29,SAVKEY12,SP70
         CALL      RSRCDTE3
TPAY1000 CALL      RKRCDTE3
         BRANCH    OVRCD,TPAY9000
.
         MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
         GOTO      TPAY9000 IF NOT EQUAL
.
         MATCH     URNUMBER,RCDTURNO
         GOTO      TPAY1000 IF NOT EQUAL
.
         PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,TPAY1000
         MATCH     "1",RCBNSTAT
         GOTO      TPAY1000 IF EQUAL       * Receipt cancelled
.
.        Check for Deposit register
.
         PACK      KEY3,RCDTREGI,SP70
         CALL      RDREGA1
         BRANCH    OVRCD,TPAY1000
.
         COMPARE   ONE,REGIBACD
         GOTO      TPAY1000 IF EQUAL       * Patient billing
         COMPARE   "90",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * EMR Deposit
         COMPARE   "91",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * OUT Deposit
         COMPARE   "97",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * IP Deposit
.
         ADD       RCDTAMNT,FORM12P2
         GOTO      TPAY1000
.
TPAY9000 MULT      "-1",FORM12P2
TPAY9999 RETURN
+
.-------------------------------------------------------------------------
. Check if Credit Transfer option available (only if there is any payment)
.-------------------------------------------------------------------------
CPTR0000  MOVE      ZERO,FORM1
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,CPTR7000            * Invalid invoice number
.
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,F12P2
.
          PACK      KEY22,PRINNUMB,SP70
          CALL      RSPRDT4
CPTR1000  CALL      RKPRDT4
          BRANCH    OVRCD,CPTR2000
.
          MATCH     PRDTINVN,PRINNUMB
          GOTO      CPTR2000 IF NOT EQUAL     * Different invoice number
.
.         Do not include 'From Payment Transfer' Journal amount
.
          IF        PRDTRTYP=2
            ADD       PRDTAMNT,FORM12P2       * Total payment
          ELSE
            IF        PRDTRTYP=3
              MATCH     PRCNCJRN,PRDTTTYP
              IF        @EQUAL
                MATCH     "FROM",PRDTDESC
                IF        !@EQUAL
                  ADD       PRDTAMNT,F12P2    * Total payment transfer journal
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          GOTO      CPTR1000
.
CPTR2000  MULT      "-1",FORM12P2
          COMPARE   FORM12P2,F12P2
          GOTO      CPTR8000 IF LESS
.
CPTR7000  MOVE      "1",FORM1                 * No credit transfer
          GOTO      CPTR9999
.
CPTR8000  MOVE      "0",FORM1                 * credit transfer -available
.
CPTR9999  RETURN
+
.-----------------------------------------------------------------------------
.         Display selection of invoice numbers for this U/R (PP)
.-----------------------------------------------------------------------------
SELINV00  WRITE     HTMLFILE;"<option value=#"",SP3,"#">":
                             SP20,"</option>"
.
          PACK      KEY18,URNUMBER,Z70
          CALL      RSPRIN3
SELINV10  CALL      RPPRIN3
          BRANCH    OVRCD,SELINV99
          MATCH     URNUMBER,PRINDEBT
          GOTO      SELINV99 IF NOT EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          MATCH     KEY8,PRINNUMB
          GOTO      SELINV10 IF EQUAL       * Skip the invoice
.
          MATCH     "1",PRINCNST
          GOTO      SELINV10 IF EQUAL       * Fully Credited
.
          ADD       PRINJAMT,PRINITOT
.
          MOVE      PRINITOT,FORM12P2
          ADD       PRINPAMT,FORM12P2
          ADD       PRINHAMT,FORM12P2            * calculate amount paid
          ADD       PRINIAMT,FORM12P2
          ADD       PRINMAMT,FORM12P2
          ADD       PRINVAMT,FORM12P2
          ADD       PRINOTHA,FORM12P2
.
          ADD       PRINJAMT,FORM12P2
          ADD       PRINCNTT,FORM12P2
          ADD       PRINGSTJ,FORM12P2
.
          COMPARE   ZERO,FORM12P2         * invoice balanced ?
          GOTO      SELINV10 IF EQUAL       * yes, ignore invoice
.
          WRITE     HTMLFILE;"<option value=#"",PRINNUMB,"#">":
                               PRINNUMB,"</option>"
          GOTO      SELINV10
.
SELINV99  RETURN
+
.------------------------------------------------------------
.      Keyin GST Code
.------------------------------------------------------------
KYGC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,KYGC1200,KYGC1400
          WRITE     HTMLFILE;GSTCODES;
          GOTO      KYGC9999
.
KYGC1200  PACK      KEY6,GSTCODES
          CALL      RDIBGS1
          IF        OVRCD=0
            WRITE     HTMLFILE;IBGSDESC;
          ELSE
            WRITE     HTMLFILE;GSTCODES;
          ENDIF
          GOTO      KYGC9999
.
.   Display Selection List for GST code
.
KYGC1400  PACK      KEY6,SP70
          CALL      RSIBGS1
KYGC1425  CALL      RKIBGS1
          BRANCH    OVRCD,KYGC9999
.
          MATCH     IBGSCODE,GSTCODES
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#" selected> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",IBGSCODE,"#"> ":
                               IBGSCODE,": ",IBGSDESC,"</option>"
          ENDIF
          GOTO      KYGC1425
.
KYGC9999  RETURN
+
.-----------------------------------------------------------
. Holding transaction table
.-----------------------------------------------------------
HTRE0000  BRANCH    FLDITMNO,HTRE0100,HTRE0200,HTRE0300,HTRE0400,HTRE0500:
                             HTRE0600,HTRE0700,HTRE0800,HTRE0900,HTRE1000:
                             HTRE1100,HTRE1200,HTRE1300,HTRE1400,HTRE1500:
                             HTRE1600,HTRE1700,HTRE1800,HTRE1900,HTRE2000:
                             HTRE2100,HTRE2200,HTRE2300,HTRE2400,HTRE2500:
                             HTRE2600,HTRE2700,HTRE2800,HTRE2900,HTRE3000:
                             HTRE3100,HTRE3200,HTRE3300,HTRE3400,HTRE3500:
                             HTRE3600,HTRE3700,HTRE3800
          GOTO      HTRE9999
.
HTRE0100  WRITE     HTMLFILE;PRHTR001;
          GOTO      HTRE9999
.
HTRE0200  WRITE     HTMLFILE;PRHTR002;
          GOTO      HTRE9999
.
HTRE0300  WRITE     HTMLFILE;PRHTR003;
          GOTO      HTRE9999
.
HTRE0400  WRITE     HTMLFILE;PRHTR004;
          GOTO      HTRE9999
.
HTRE0500  WRITE     HTMLFILE;PRHTR005;
          GOTO      HTRE9999
.
HTRE0600  WRITE     HTMLFILE;PRHTR006;
          GOTO      HTRE9999
.
HTRE0700  WRITE     HTMLFILE;PRHTR007;
          GOTO      HTRE9999
.
HTRE0800  WRITE     HTMLFILE;PRHTR008;
          GOTO      HTRE9999
.
HTRE0900  WRITE     HTMLFILE;PRHTR009;
          GOTO      HTRE9999
.
HTRE1000  WRITE     HTMLFILE;PRHTR010;
          GOTO      HTRE9999
.
HTRE1100  WRITE     HTMLFILE;PRHTR011;
          GOTO      HTRE9999
.
HTRE1200  UNPACK    PRHTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      HTRE9999
.
HTRE1300  WRITE     HTMLFILE;PRHTTIME;
          GOTO      HTRE9999
.
HTRE1400  MOVE      "MBS",KEY3
          MATCH     " 1",DPRHTFLG
          IF        @EQUAL
            MOVE      "AMA",KEY3
          ENDIF
          WRITE     HTMLFILE;KEY3;
          GOTO      HTRE9999
.
HTRE1500  WRITE     HTMLFILE;PRHTIDES;
          GOTO      HTRE9999
.
HTRE1600  WRITE     HTMLFILE;PRHTSERN;
          GOTO      HTRE9999
.
HTRE1700  WRITE     HTMLFILE;PRHTIAMT;
          GOTO      HTRE9999
.
HTRE1800  MOVE      PRHTFLAG,TMPIFLAG
          PACK      TMPITEM,PRHTR008
          PACK      TMPSITEM,PRHTR009
          PACK      TMPSDATE,PRHTDATE
          CALL      RDIT0000
          WRITE     HTMLFILE;PRITKEYI;
          GOTO      HTRE9999
.
HTRE1900  MOVE      PRHTFLAG,TMPIFLAG
          PACK      TMPITEM,PRHTR008
          PACK      TMPSITEM,PRHTR009
          PACK      TMPSDATE,PRHTDATE
          CALL      RDIT0000
          WRITE     HTMLFILE;PRITFIXD;
          GOTO      HTRE9999
.
HTRE2000  WRITE     HTMLFILE;PRHTACOI;
          GOTO      HTRE9999
.
HTRE2100  WRITE     HTMLFILE;PRHTTDUR;
          GOTO      HTRE9999
.
HTRE2200  MATCH     SP70,PRHDHFND
          GOTO      HTRE9999 IF EQUAL
.
          PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,HTRE9999
.
          MATCH     "1",PTHFDPRI
          GOTO      HTRE9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PRHDHFND;
          GOTO      HTRE9999
.
HTRE2300  WRITE     HTMLFILE;PRHTMPOV;
          GOTO      HTRE9999
.
HTRE2400  WRITE     HTMLFILE;PRHTDSOV;
          GOTO      HTRE9999
.
HTRE2500  WRITE     HTMLFILE;PRHTSTXT;
          GOTO      HTRE9999
.
HTRE2600  WRITE     HTMLFILE;PRHTASPF;
          GOTO      HTRE9999
.
HTRE2700  WRITE     HTMLFILE;PRHTASPC;
          GOTO      HTRE9999
.
HTRE2800  MATCH     SP70,PRHTASPC
          GOTO      HTRE9999 IF EQUAL
.
          PACK      KEY10,PRHTASPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            CALL      HCPNAM00
            WRITE     HTMLFILE;DOCFNAME;
          ENDIF
          GOTO      HTRE9999
.
HTRE2900  
.         WRITE     HTMLFILE;PRHTAICF;
          GOTO      HTRE9999
.
HTRE3000  MOVE      "ic",CATEGORY
          MOVE      PRHTAICV,CODE
          CALL      CODITM00
          GOTO      HTRE9999
.
HTRE3100  WRITE     HTMLFILE;PRHTNMPT;
          GOTO      HTRE9999
.
HTRE3200  WRITE     HTMLFILE;PRHTLSPN;
          GOTO      HTRE9999
.
HTRE3300  MOVE      "Sd",CATEGORY
          MOVE      PRHTSDCD,CODE
          CALL      CODITM00
          GOTO      HTRE9999
.
HTRE3400  CALL      GLVIS000
          GOTO      HTRE9999
.
HTRE3500  WRITE     HTMLFILE;PRHTHOSI;
          GOTO      HTRE9999
.
HTRE3600  MOVE      "Ro",CATEGORY
          MOVE      PRHTROVC,CODE
          CALL      CODITM00
          GOTO      HTRE9999
.
HTRE3700  WRITE     HTMLFILE;FRMPPLST;
          GOTO      HTRE9999
.
HTRE3800  WRITE     HTMLFILE;PRHTDSKM;
          GOTO      HTRE9999
.
HTRE9999  RETURN
+
.-----------------------------------------------------------
. Referral List
.-----------------------------------------------------------
.RFLS0000  MATCH     SP70,URNUMBER
.          GOTO      RFLS9999 IF EQUAL
.
.          IF        NORECORD=0
.            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
.          ENDIF
.          MOVE      ZERO,RECNUMB            * Init Number of records Read
.          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
.          MOVE      ONE,PRHDSCAN
.          PACK      KEY27,URNUMBER,PRHDSCAN,SP70
.          CALL      RSPRHD1
.RFLS1000  CALL      RKPRHD1
.          BRANCH    OVRCD,RFLS9999
.          MATCH     PRHDDEBT,URNUMBER       * Same U/R number ?
.          GOTO      RFLS9999 IF NOT EQUAL
.
.          PACK      KEY27,PRHDUNIQ,SP70
.          CALL      RSPRHR1
.RFLS2000  CALL      RKPRHR1
.          BRANCH    OVRCD,RFLS1000
.
.          COMPARE   PRHRUNIQ,PRHDUNIQ
.          GOTO      RFLS1000 IF NOT EQUAL   * different unique number
.
.          PACK      KEY6,PRHRPRAC,SP70
.          CALL      RDPRPR1
.          BRANCH    OVRCD,RFLS2000
.
.          PACK      KEY10,USERID,SP70
.          CALL      RDPRALS1
.          COMPARE   ZERO,OVRCD
.          GOTO      RFLS6000 IF EQUAL       * User has access to all Med.Prac.
.
.          PACK      KEY16,PRHRPRAC,USERID,SP70
.          CALL      RDPRSEC1
.          BRANCH    OVRCD,RFLS2000
.
.RFLS6000  ADD       ONE,RECNUMB
.          IF        STARTNUM>=RECNUMB
.            GOTO      RFLS2000
.          ENDIF
.
.          MOVE      "&nbsp;",KEY35
.          PACK      KEY10,PRHRDOCT,SP70
.          CALL      RDPMHCP1
.          IF        OVRCD=0
.            CALL      HCPNAM00
.            MOVE      DOCFNAME,KEY35
.          ENDIF
.
.          MOVE      "&nbsp;",KEY20
.          PACK      KEY5,ANSC,ANSL,PRHDCLAM
.          CALL      RDCODE1
.          IF        OVRCD=0
.            MOVE      TDESC,KEY20             * Claim code desc.
.          ENDIF
.
.          MOVE      "&nbsp;",TDESC
.          PACK      KEY5,ANSG,ANSI,PRHRPIND   * Patient indicator
.          CALL      RDCODE1
.
.          WRITE     HTMLFILE;"<tr><td><img src=../images/EditIcon.gif ":
.                             " class=ListIcon onclick='linkDocRef(#"":
.                             URNUMBER,"#",#"",PRHRUNIQ,"#",#"",PRHRPRAC,"#",#"":
.                             PRHRDOCT,"#",#"",PRHRPIND,"#")'>":
.                             PRPRDESC,"</td>";
.
.          MATCH     SP70,PMHCPRV1              * Check provider number
.          IF        @EQUAL
.             WRITE     HTMLFILE;"<td>",KEY35,"</td>";
.          ELSE
.             WRITE     HTMLFILE;"<td>",KEY35,"(",PMHCPRV1,")</td>";
.          ENDIF
.
.          WRITE     HTMLFILE;"<td>",KEY20,"</td>":
.                             "<td>",TDESC,"</td>";
.
.          MATCH     SP10,PRHDACCD
.          IF        !@EQUAL
.            UNPACK    PRHDACCD,CCENT,CYEAR,CMON,CDAY
.            MOVE      CMON,F2
.            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
.                               "</td>"                                 *C-53064
.          ELSE
.            WRITE     HTMLFILE;"<td>&nbsp;</td>"                       *C-53064
.          ENDIF
.
.          MATCH     SP8,PRHRRDAT                                       *I-53064
.          IF        !@EQUAL
.            UNPACK    PRHRRDAT,CCENT,CYEAR,CMON,CDAY
.            MOVE      CMON,F2
.            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
.                               "</td></tr>"
.          ELSE
.            WRITE     HTMLFILE;"<td>&nbsp;</td></tr>"
.          ENDIF
.
.          ADD       ONE,ROWCOUNT
.
.          COMPARE   NORECORD,ROWCOUNT
.          GOTO      RFLS2000 IF NOT EQUAL
.
.RFLS9999  RETURN
+
.-----------------------------------------------------------
. Referral List
.-----------------------------------------------------------
RFLS0000  MATCH     SP70,URNUMBER
          GOTO      RFLS9999 IF EQUAL
.
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          MOVE      ONE,PRHDSCAN
          PACK      KEY27,URNUMBER,PRHDSCAN,SP70
          CALL      RSPRHD1
RFLS1000  CALL      RKPRHD1
          BRANCH    OVRCD,RFLS9999
          MATCH     PRHDDEBT,URNUMBER       * Same U/R number ?
          GOTO      RFLS9999 IF NOT EQUAL
.
          PACK      KEY27,PRHDUNIQ,SP70
          CALL      RSPRHR1
RFLS2000  CALL      RKPRHR1
          BRANCH    OVRCD,RFLS1000
.
          COMPARE   PRHRUNIQ,PRHDUNIQ
          GOTO      RFLS1000 IF NOT EQUAL   * different unique number
.
          PACK      KEY6,PRHRPRAC,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,RFLS2000
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      RFLS6000 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRHRPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,RFLS2000
.
RFLS6000  MOVE      "&nbsp;",KEY35
          PACK      KEY10,PRHRDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,KEY35
          ENDIF
.
          MOVE      "&nbsp;",KEY20
          PACK      KEY5,ANSC,ANSL,PRHDCLAM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20             * Claim code desc.
          ENDIF
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSG,ANSI,PRHRPIND   * Patient indicator
          CALL      RDCODE1
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkDocRef('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PRHRUNIQ,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PRHRPRAC,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PRHRDOCT,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    COMMA,HTMLLINK
          APPEND    "'",HTMLLINK
          APPEND    PRHRPIND,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",";
.
          WRITE     HTMLFILE;"#"",PRPRDESC,"#",";
.
          MATCH     SP70,PMHCPRV1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",KEY35,"#",";
          ELSE
            WRITE     HTMLFILE;"#"",KEY35,"(",PMHCPRV1,")","#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY20,"#",":
                             "#"",TDESC,"#",";
.
          MATCH     SP8,PRHDACCD
          IF        !@EQUAL
.           UNPACK    PRHDACCD,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#",";
            WRITE     HTMLFILE;"#"",PRHDACCD,"#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          MATCH     SP8,PRHRRDAT
          IF        !@EQUAL
.           UNPACK    PRHRRDAT,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#");"
            WRITE     HTMLFILE;"#"",PRHRRDAT,"#","
          ELSE
            WRITE     HTMLFILE;"#"#","
          ENDIF
.
          MATCH     SP70,PRHDHFND
          IF        !@EQUAL & !@EOS
            PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
.
            IF        OVRCD=1
              WRITE     HTMLFILE;"#"",PRHDHFND,"#""
            ELSE
              WRITE     HTMLFILE;"#"",HFNAME,"#""
            ENDIF
          ELSE
RFLS6100    WRITE     HTMLFILE;"#"#""
          ENDIF
.
          WRITE     HTMLFILE;");"
.
          GOTO      RFLS2000
.
RFLS9999  RETURN
+
.-------------------------------------------------------------
. Display by Referring Doctor (prcnrdoc=1)
.-------------------------------------------------------------
RDOCLS00  UNPACK    SP70,SAVREFER
          PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003
          PACK      KEY62,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RSPRHT1
RDOCLS10  CALL      RKPRHT1
          BRANCH    OVRCD,RDOCLS99
.
.      check if same referral
.
          PACK      KEY27A,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND
          MATCH     KEY27,KEY27A
          GOTO      RDOCLS99 IF NOT EQUAL
.
.      check referring doctor exists
.
          MATCH     SP10,PRHTREFD
          GOTO      RDOCLS10 IF EQUAL
          MATCH     SP10,PRHTRDAT
          GOTO      RDOCLS10 IF EQUAL
.
.      check if not the same referring doctor record as previous
.
          PACK      KEY14,PRHTREFD,PRHTRDAT
          MATCH     SAVREFER,KEY14
          GOTO      RDOCLS10 IF EQUAL
          MOVE      KEY14,SAVREFER
.
          MOVE      "&nbsp;",KEY35
          PACK      KEY10,PRHTREFD,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,KEY35
          ENDIF
.
          MATCH     SP10,PRHTRDAT
          IF        !@EQUAL
            UNPACK    PRHTRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      "&nbsp;",DIM12
          ENDIF
.
          MATCH     SP70,PRHTREFT
          IF        @EQUAL
            MOVE      "&nbsp;",PRHTREFT
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkNxtInv(#"":
                             URNUMBER,"#",#"",PRHTUNIQ,"#",#"",PRHTPRAC,"#",#"":
                             PRHTDOCT,"#",#"",PRHTPIND,"#",#"",PRHTREFD,"#",#"":
                             PRHTRDAT,"#",#"",PRHTREFT,"#")'>",DOCFNAME,"</td>":
                             "<td>",DIM12,"</td>":
                             "<td>",PRHTREFT,"</td><td>&nbsp;</td></tr>";
.
          GOTO      RDOCLS10
.
RDOCLS99  RETURN
.-------------------------------------------------------------
. Populate Common Items
.-------------------------------------------------------------
CMITM000  IF        NORECORD=0
            MOVE      "25",NORECORD       * Set Default No Records to Display
          ENDIF
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,CMITM999
.
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          CALL      DHDRW000      * Display heading
.
          PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RSPRTMP1
CMITM400  CALL      RKPRTMP1
          BRANCH    OVRCD,CMITM999
.
          MATCH     DPRHRUNQ,PRTMUNIQ
          GOTO      CMITM999 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRTMPRAC
          GOTO      CMITM999 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRTMDOCT
          GOTO      CMITM999 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRTMPIND
          GOTO      CMITM999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CMITM400
          ENDIF
.
          CALL      DITRW000      * Display Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CMITM400 IF NOT EQUAL
.
CMITM999  RETURN
+
.-------------------------------------------------------------
. Display Item heading
.-------------------------------------------------------------
DHDRW000 WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=10%>":
                               "Date</td>":
                               "<td class=HeadingCell width=10%>":
                               "Time</td>":
                               "<td class=HeadingCell width=15%>":
                               "Item</td>":
                               "<td class=HeadingCell width=20%>":
                               "Description</td>":
                               "<td align= right class=HeadingCell width=5%>":
                               "Quantity</td>":
                               "<td align= right class=HeadingCell width=15%>":
                               "GST Excluded</td>":
                               "<td align= right class=HeadingCell width=15%>":
                               "GST Amount</td>":
                               "<td align= right class=HeadingCell width=15%>":
                               "Total</td>":
                             "</tr>"
DHDRW999  RETURN
+
.-------------------------------------------------------------
. Display Item row
.-------------------------------------------------------------
DITRW000  UNPACK    PRTMDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                   NSEP,NOCT,NNOV,NDEC
.
          MOVE      "MBS",KEY3
          MATCH     "1",PRTMITYP
          IF        @EQUAL
            MOVE      "AMA",KEY3
          ENDIF
.
          MOVE      "&nbsp;",KEY10
          MATCH     SP10,PRTMTIME
          IF        !@EQUAL
            PACK      KEY10,PRTMTIME
          ENDIF
          MATCH     SP10,PRTMDESC
          IF        @EQUAL
            MOVE      "&nbsp;",PRTMDESC
          ENDIF
.
          MOVE      PRTMCAMT,LINTOTL
          MOVE      ZERO,LINGSTA
          MOVE      LINTOTL,FORM12P2
          MOVE      PRTMGSTA,PRDTGSTA
          MOVE      PRTMGSTC,PRDTGSTC
          CALL      GGST0000             * Get GST Amount
          MOVE      LINTOTL,LINGSTA
          MULT      IBGEAMNT,LINGSTA     * GST amount
          DIV       "100.00",LINGSTA     * Divide by 100 to get wanted fig.
          ADD       LINGSTA,FORM12P2
.
          WRITE     HTMLFILE;"<tr><td>":
                             CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>":
                             "<td nowrap><A HREF=#"javascript:ChangeTime":
                             "('",PRTMCNTR,"');#">":
                            "<img src=../images/DateTimeStamp.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             KEY10,"</td>";
.
.
          WRITE     HTMLFILE;"<td nowrap><A HREF=#"javascript:ChangeItem":
                             "('",PRTMCNTR,PRTMIAMT,"');#">":
                             "<img src=../images/EditIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             KEY3,SP1,PRTMITEM,"/",PRTMSUBI,"</td>":
                             "<td>",PRTMDESC,"</td>":
                             "<td align=right>",PRTMQUNT,"</td>":
                             "<td align=right>","$",LINTOTL,"</td>":
                             "<td align=right>","$",LINGSTA,"</td>":
                             "<td align=right>","$",FORM12P2,"</td>":
                             "</tr>"
DITRW999  RETURN
+
.-------------------------------------------------------------
. Display next invoice
.-------------------------------------------------------------
NXIV0000  MOVE      ONE,FLAGSOME                 * set flag for no transactions
          MOVE      ONE,VSCANPMI
          MOVE      URNUMBER,VDEBTOR
          MOVE      ONE,WEBFLAG
          MOVE      SP70,PRANAME
.
          PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,NXIV9999
          MOVE      PRHDCLAM,CLAIMCOD
          MOVE      PRHDACCD,ACCIDATE
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,NXIV9999
          MOVE      PRHRPRAC,PRHRE001
          MOVE      PRHRDOCT,PRHRE002
.
          MOVE      PRHDUNIQ,TEMPUNQ
          MOVE      PRHRPRAC,TMPPRAC
          MOVE      PRHRDOCT,TMPSDOCT
          MOVE      PRHRPIND,TMPPIND
.
          COMPARE   ONE,PRHRPINV                 * we have finished if no more
          GOTO      NXIV9000 IF NOT EQUAL        * invoices to be printed
.
          IF        PRCNRDOC = 0
             MOVE      PRHRREFD,TMPRDOCT
             MOVE      PRHRRDAT,TMPRDATE
          ELSE
             MOVE      PRHTR005,TMPRDOCT
             MOVE      PRHTR006,TMPRDATE
          ENDIF
.
          CALL      PRIINVLI                     * load data into temp file
          BRANCH    EXIT,NXIV9000                * get next header record
          MOVE      ZERO,FLAGSOME                * set transactions found flag
.
          UNPACK    SP70,TMPRESP,TMPBULK
.
          IF        FLAGSOME = ZERO
            CALL      PPTMP000                  * process pathology tests
          ELSE
            PACK      KEY8,UNIQNUMB             * get PRFA details
            CALL      RDPRHD2
          ENDIF
.
NXIV9000  BRANCH    INVFLAG,NXIV9999
          CALL      HDIV0000                  * Display heading
          GOTO      NXIV9999
.
NXIV9999  RETURN
+
.****************************************************************************
.*                                HDIV0000                                  *
.*              display the heading of next invoice(s) to the screen        *
.****************************************************************************
HDIV0000  MOVE      PRHRE001,TMPPRAC
          MOVE      CLAIMCOD,TMPCLAIM
          MOVE      ACCIDATE,TMPADATE
          MOVE      PRHRE002,TMPSDOCT
.
          MOVE      "Unknown code",TDESC         * get claim code description
          PACK      KEY5,CODECL,TMPCLAIM
          CALL      RDCODE1
          PACK      KEY20,TDESC,SP70
.
          MOVE      "Unknown practice",PRPRDESC  * get medical practice name
          PACK      KEY6,TMPPRAC
          CALL      RDPRPR1
.
          MOVE      "&nbsp;",TDESC
          PACK      KEY5,ANSG,ANSI,TMPPIND   * Patient indicator
          CALL      RDCODE1
          MATCH     ANSI,TCINDC1
          IF        @EQUAL
             MOVE      "IP",DIM2
          ELSE
             MOVE      "OP",DIM2
          ENDIF
.
          MOVE      "Unknown doctor",DOCNAME     * get serv. doctor name
          PACK      KEY10,TMPSDOCT,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,HDIV3000               * not on file
          CALL      HCPNAM00
          MOVE      DOCFNAME,DOCNAME
.
HDIV3000  MATCH     "1",PTCNUIMC
          GOTO      HDIV4500 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td width=18%>":
                               "Person Responsible for Account</td>":
                               "<td>&nbsp;</td>":
                               "<td>Claim Code</td>":
                               "<td><b>",KEY20,"( ",DIM2,")</b></td></tr>":
                               "<tr><td>Name</td>":
                               "<td><b>",PRHRNAME,"</b></td>";
.
          WRITE     HTMLFILE;"<td>Health Fund</td>";
.
          MATCH     SP70,PRHDHFND
          IF        !@EQUAL
            PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<td><b>",HFNAME,"&nbsp;</td></tr>";
            ELSE
              WRITE     HTMLFILE;"<td><b>",PRHDHFND,"&nbsp;</td></tr>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>Address</td>":
                             "<td><b>",PRHRADD1,"</b></td>":
                             "<td>Medical Practice</td>";
.
          IF        PRPRSTAT=1
            WRITE     HTMLFILE;"<td><font color=#FF0000>":
                               "<b>",PRPRDESC,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td><b>",PRPRDESC,"</b></td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td></td>":
                             "<td><b>",PRHRADD2,"</b></td>":
                             "<td>Service Doctor</td>";
.
          MATCH     "1",PMHCSTTS
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=#FF0000>":
                               "<b>",DOCNAME,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td><b>",DOCNAME,"</b></td></tr>";
          ENDIF
.
          MATCH     SP70,PRHRADD2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td><b>",PRHRADD3,"</b>":
                               "<b>&nbsp;",PRHRPOST,"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     SP70,TMPPIND
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Patient Indicator:</td>":
                               "<td><b>",TDESC,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>";
          ENDIF
.
          MATCH     SP70,ACCIDATE
          IF        !@EQUAL
            UNPACK    ACCIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL:
                                 AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<tr><td>Accident Date:</td>":
                               "<td><b>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</b></td></tr>";
          ENDIF
.
          MATCH     SP10,PRHRBULK
          GOTO      HDIV4000 IF EQUAL
.
          CALL      CBUL0000                     * check if bulk billed
          BRANCH    EXIT,HDIV4000
.
          WRITE     HTMLFILE;"<tr><td>Bulk Bill</td>":
                             "<td><b>BBDESC;</b></td>":
                             "<td>&nbsp;</td><td>&nbsp;</td></tr>"
          GOTO      HDIV5000
.
HDIV4000  
.         WRITE     HTMLFILE;"<td>&nbsp;</td>":
.                            "<td>&nbsp;</td>":
.                            "<td>&nbsp;</td><td>&nbsp;</td></tr>"
.
          GOTO      HDIV5000
.
HDIV4500  WRITE     HTMLFILE;"<tr><td width=18%>":
                               "Person Responsible for Account</td>":
                               "<td>&nbsp;</td>":
                               "<td>Claim Code</td>":
                               "<td><b>",KEY20,"( ",DIM2,")</b></td></tr>":
                               "<tr><td>Name</td>":
                               "<td><b>",PRHRNAME,"</b></td>";
.
          WRITE     HTMLFILE;"<td>Medical Practice</td>";
.
          IF        PRPRSTAT=1
            WRITE     HTMLFILE;"<td><font color=#FF0000>":
                               "<b>",PRPRDESC,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td><b>",PRPRDESC,"</b></td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>Address</td>":
                             "<td><b>",PRHRADD1,"</b></td>":
                             "<td>Service Doctor</td>";
.
          MATCH     "1",PMHCSTTS
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=#FF0000>":
                               "<b>",DOCNAME,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td><b>",DOCNAME,"</b></td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td></td>":
                             "<td><b>",PRHRADD2,"</b></td>":
                             "";
.
          MATCH     SP70,PRHRADD2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td><b>",PRHRADD3,"</b>":
                               "<b>&nbsp;",PRHRPOST,"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     SP70,TMPPIND
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>Patient Indicator:</td>":
                               "<td><b>",TDESC,"</b></td></tr>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>";
          ENDIF
.
          MATCH     SP70,ACCIDATE
          IF        !@EQUAL
            UNPACK    ACCIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL:
                                 AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<tr><td>Accident Date:</td>":
                               "<td><b>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</b></td></tr>";
          ENDIF
.
          MATCH     SP10,PRHRBULK
          GOTO      HDIV5000 IF EQUAL
.
          CALL      CBUL0000                     * check if bulk billed
          BRANCH    EXIT,HDIV5000
.
          WRITE     HTMLFILE;"<tr><td>Bulk Bill</td>":
                             "<td><b>BBDESC;</b></td>":
                             "<td>&nbsp;</td><td>&nbsp;</td></tr>"
.
HDIV5000  COMPARE   ONE,PRCNRDOC
          GOTO      HDIV9999 IF NOT EQUAL
.
          MOVE      "Unknown doctor",DOCNAME     * get referring doctor name
          PACK      KEY6,PRHTR005
          PACK      KEY10,PRHTR005,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,HDIV5100               * not on file
          CALL      HCPNAM00
          MOVE      DOCFNAME,DOCNAME
.
HDIV5100  UNPACK    PRHTR006,CCENT,CYEAR,CMON,CDAY
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                   NSEP,NOCT,NNOV,NDEC
.
          WRITE     HTMLFILE;"<tr><td colspan=2>&nbsp;</td>":
                             "<td class=DataLabel>Referring Doctor</td>":
                             "<td class=DataField>",DOCNAME,"</td></tr>":
                             "<tr><td colspan=2>&nbsp;</td>":
                             "<td class=DataLabel>Referring Date</td>":
                             "<td class=DataField>",CDAY,SP1,MTHNAM3,SP1,KEY4:
                             "</td></tr>"

.
HDIV9999  RETURN
.UPTOHERE
.****************************************************************************
.*                      DISN0000                                            *
.*        Display all the service items                                     *
.****************************************************************************
DISN0000  WRITE     HTMLFILE;"<tr bgcolor=#99FFFF><b>":
                               "<td align=center><b> Date </b></td>":
                               "<td><b> Item </b></td>":
                               "<td><b> Description </b></td>":
                               "<td align=right><b> GST Excluded </b></td>":
                               "<td align=right><b> GST Amount </b></td>":
                               "<td align=right><b> Total </b></td>":
                               "</tr>";
.
          MOVE      PRHRE001,SAVPRAC             * save medical practice
          MOVE      CLAIMCOD,SAVCLAIM            * save claim code
          MOVE      PRHRE002,SAVSDOCT            * save service doctor
.
          MOVE      ZERO,TOTINV                  * initialise totals
          MOVE      ZERO,GSTTOTAL
          MOVE      ZERO,NETTOT
          MOVE      ZERO,F3
.
          MOVE      ONE,VSCANPMI                 * PMI UR number
          IF        PRCNRDOC=1
            PACK      KEY29,URNUMBER,VSCANPMI,PRHRE001,CLAIMCOD,PRHRE002,SP70
            PACK      KEY80,KEY29,PRHRE003,PRHTR006,PRHTR005,SP70
            CALL      RSTMPR2                      * position in temp file
            CALL      RKTMPR2                      * read next record
            BRANCH    OVRCD,DISN3000
            MOVE      TMPITEM,TMPOITEM      * save original TMPITEM   *I-123419
            MOVE      TMPSITEM,TMPOSITM     * save original TMPSITEM  *I-123419
            MATCH     SP9,TMPSTEP           * is item stepdown'ed     *I-123419
            IF        !@EQUAL
              MOVE      TMPSTEP,TMPITEM
              MOVE      TMPSTSB,TMPSITEM
            ENDIF
            MATCH     TMPDIM29,KEY29
            GOTO      DISN3000 IF NOT EQUAL
            MATCH     TMPPIND,PRHRE003
            GOTO      DISN3000 IF NOT EQUAL
            MATCH     TMPRDATE,PRHTR006
            GOTO      DISN3000 IF NOT EQUAL
            MATCH     TMPRDOCT,PRHTR005
            GOTO      DISN3000 IF NOT EQUAL
          ELSE
            PACK      KEY29,URNUMBER,VSCANPMI,PRHRE001,CLAIMCOD,PRHRE002,SP70
            PACK      KEY80,KEY29,SP70
            CALL      RSTMPR2                      * position in temp file
            CALL      RKTMPR2                      * read next record
            BRANCH    OVRCD,DISN3000
            MOVE      TMPITEM,TMPOITEM      * save original TMPITEM   *I-123419
            MOVE      TMPSITEM,TMPOSITM     * save original TMPSITEM  *I-123419
            MATCH     SP9,TMPSTEP           * is item stepdown'ed     *I-123419
            IF        !@EQUAL
              MOVE      TMPSTEP,TMPITEM
              MOVE      TMPSTSB,TMPSITEM
            ENDIF
            MATCH     TMPDIM29,KEY29
            GOTO      DISN3000 IF NOT EQUAL
          ENDIF
.
. ------- Get the service item transactions for this invoice ---------------
.
DISN1500  ADD       ONE,F3
          MOVE      F3,DIM3
          REP       " 0",DIM3
.
          PACK      KEY27,TMPUIDEN,TMPPRAC,TMPSDOCT,TMPPIND,SP70
          CALL      RDPRHR1
          IF        OVRCD=1
            CALL      CLPRIHRE
          ENDIF 
.
          UNPACK    TMPSDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY4,CCENT,CYEAR
          REP       " 0",KEY4
          MOVE      CMON,FORM2
          LOAD      MTHNAM3,FORM2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN,NJUL,NAUG:
                                   NSEP,NOCT,NNOV,NDEC
.
          WRITE     HTMLFILE;"<tr><td>":
                             CDAY,SP1,MTHNAM3,SP1,KEY4,"</td>";
.
          WRITE     HTMLFILE;"<td><img src=../images/EditIcon.gif ":
                             " class=ListIcon onclick='UpdDelItem(#"":
                               UNIQNUMB,"#",#"":
                               TMPPRAC,"#",#"":
                               TMPSDOCT,"#",#"":
                               TMPPIND,"#",#"":
                               TMPRDOCT,"#",#"":
                               TMPRDATE,"#",#"":
                               TMPIFLAG,"#",#"":
                               TMPHITM,"#",#"":
                               TMPHSUB,"#",#"":
...                            TMPITEM,"#",#"":
...                            TMPSITEM,"#",#"":
                               TMPHTRN,"#",#"",ANS,"#")'>";
          BRANCH    TMPIFLAG,DISN2000            * AMA item
.
          WRITE     HTMLFILE;ANSM,"-",TMPITEM;
.
          MATCH     SP3,TMPSITEM                 * subitem number ?
          IF        @EQUAL
            WRITE     HTMLFILE;"</td>";
          ELSE
            WRITE     HTMLFILE;"(",TMPSITEM,")</td>";
          ENDIF
          GOTO      DISN2500
.
DISN2000  WRITE     HTMLFILE;ANSA,"-",TMPITEM,"</td>";
.
DISN2500  MATCH     SP70,TMPASPC
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<input type=hidden name=srvpr",DIM3," value='":
                               PRHRDOCT,"'>";
          ELSE
            WRITE     HTMLFILE;"<input type=hidden name=srvpr",DIM3," value='":
                               TMPASPC,"'>";
          ENDIF
.
          MOVE      SP70,DIM1
          MATCH     SP70,TMPAICV
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CATIC,TMPAICV,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,DIM1
            ENDIF
          ELSE
            PACK      KEY5,CATIC,PRHRISSC,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TCINDC1,DIM1
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<input type=hidden name=ifccd",DIM3," value='":
                             DIM1,"'>";
.
          MOVE      TMPASPF,DIM1
          REP       " 0",DIM1
.
          WRITE     HTMLFILE;"<input type=hidden name=ccicd",DIM3," value='":
                             DIM1,"'>";

          WRITE     HTMLFILE;"<input type=hidden name=itemn",DIM3," value='":
                             TMPITEM,"'>";
.
          WRITE     HTMLFILE;"<input type=hidden name=daten",DIM3," value='":
                             TMPSDATE,"'>";
.
          MOVE      ONEHUND,PRDOFEEP             * get % doctor charge
          PACK      KEY22,TMPPRAC,TMPSDOCT,TMPCLAIM,TMPPIND,SP70
          CALL      RDPRDO1
.
          CALL      RDIT0000                     * read in item record
          MOVE      TMPITOT,TEMPAMNT
          CALL      GETAJ000                     * adjust for doctor % charge
          MOVE      TEMPAMNT,TMPITOT
.
          MOVE      TMPIAMNT,TEMPTOTV
          MOVE      TMPIAMNT,TEMPAMNT
          CALL      GETAJ000
          MOVE      TEMPAMNT,TMPIAMNT
.
          WRITE     HTMLFILE;"<td>",TMPIDESC;
.
          MULT      TMPSERVS,TMPITOT             * calculate line total
.
          COMPARE   TMPITOT,ZERO
          IF        @EQUAL
             MOVE      ZERO,FORM12P2
             WRITE     HTMLFILE;"(",TMPSERVS,"x",TMPIAMNT,")</td>":
                                "<td align=right>",FORM12P2,"</td>":
                                "<td align=right>",FORM12P2,"</td>":
                                "<td align=right>",FORM12P2,"</td></tr>";
             GOTO      DISN2700
          ELSE
             WRITE     HTMLFILE;"(",TMPSERVS,"x",TMPIAMNT,")</td>":
                                "<td align=right>",TMPITOT,"</td>";

             MOVE      ZERO,LINGSTA
             IF        TMPGSTA=1
               MOVE      TMPGSTA,PRDTGSTA
               MOVE      TMPGSTC,PRDTGSTC
               CALL      GGST0000             * Get GST amount
               MOVE      TMPITOT,LINGSTA
               MULT      IBGEAMNT,LINGSTA
               DIV       "100.00",LINGSTA
               ADD       LINGSTA,GSTTOTAL
             ENDIF
             MOVE      TMPITOT,FORM12P2
             ADD       LINGSTA,FORM12P2
             WRITE     HTMLFILE;"<td align=right>",LINGSTA,"</td>":
                                "<td align=right>",FORM12P2,"</td></tr>";
           ENDIF
.
DISN2700  ADD       TMPITOT,TOTINV               * update running total
.
          CALL      RKTMPR2                      * read next transaction
          BRANCH    OVRCD,DISN3000               * end of file
            MOVE      TMPITEM,TMPOITEM      * save original TMPITEM   *I-123419
            MOVE      TMPSITEM,TMPOSITM     * save original TMPSITEM  *I-123419
            MATCH     SP9,TMPSTEP           * is item stepdown'ed     *I-123419
            IF        !@EQUAL
              MOVE      TMPSTEP,TMPITEM
              MOVE      TMPSTSB,TMPSITEM
            ENDIF
.
          MATCH     URNUMBER,TMPDEBT              * same patient ?
          GOTO      DISN3000 IF NOT EQUAL        * no
          COMPARE   VSCANPMI,TMPSCAN              * same patient ?
          GOTO      DISN3000 IF NOT EQUAL        * no
.
          MATCH     SAVPRAC,TMPPRAC              * same practice ?
          GOTO      DISN3000 IF NOT EQUAL        * no
          MATCH     SAVCLAIM,TMPCLAIM            * same claim code ?
          GOTO      DISN3000 IF NOT EQUAL        * no
          MATCH     SAVSDOCT,TMPSDOCT            * same service doctor ?
          GOTO      DISN3000 IF NOT EQUAL        * no
.
          IF        PRCNRDOC=1
            MATCH     TMPPIND,PRHRE003
            GOTO      DISN3000 IF NOT EQUAL
            MATCH     TMPRDATE,PRHTR006
            GOTO      DISN3000 IF NOT EQUAL
            MATCH     TMPRDOCT,PRHTR005
            GOTO      DISN3000 IF NOT EQUAL
          ENDIF
.
          GOTO      DISN1500                     * get next transaction
.
.         No more transactions for this invoice
.
DISN3000  ADD       ONE,CVERT
          MOVE      TOTINV,FORM12P2
          ADD       GSTTOTAL,FORM12P2
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Invoice Total</b></td>":
                             "<td align=right><b>",TOTINV,"</b></td>":
                             "<td align=right><b>",GSTTOTAL,"</b></td>":
                             "<td align=right><b>",FORM12P2,"</b></td></tr>";
.
          MOVE      URNUMBER,PRDTDEBT
          MOVE      PRHRE001,PRDTPRAC            * medical practice
          MOVE      ONE,PRDTSCAN                 * PMI UR number
          CALL      CKCSH0000       * Check for deposit
          SUB       DEPTOTAL,FORM12P2
          SUB       NBNKDEPS,FORM12P2
.
          COMPARE   FALSE,FLAGCASH
          GOTO      DISN6000 IF NOT EQUAL
          COMPARE   ZERO,NBNKDEPS
          GOTO      DISN9999 IF EQUAL
.
DISN6000  WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Balance Payable</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right><b>",FORM12P2,"</b></td></tr>";
          MOVE      FORM12P2,NETTOT
DISN9999  RETURN
+
.-----------------------------------------------------------
.         Check for deposits
.-----------------------------------------------------------
CKCSH000  MOVE      ZERO,DEPTOTAL
          OPEN      COMDEPA4,"comdepaf"
.         UNPACK    PRDTSCAN,ANS,KEY1
          MOVE      "1",KEY1
          MOVE      "0",CMDESTAT
          PACK      KEY33,CMDESTAT,PRDTDEBT,KEY1,PRDTPRAC,SP20
          CALL      RSCMDEP4                * position on Cash Deposits file
.
.------ read through the cash deposits file ------
.
CKCSH100  CALL      RKCMDEP4
          BRANCH    OVRCD,CKCSH120
.
          MATCH     "0",CMDESTAT            * deposit held?
          GOTO      CKCSH120 IF NOT EQUAL
          MATCH     "1",CMDESFLG           * compare scan flags
          GOTO      CKCSH120 IF NOT EQUAL
.
          MATCH     PRDTDEBT,CMDEURNO       * match debtor numbers
          GOTO      CKCSH120 IF NOT EQUAL
.
          MATCH     PRDTPRAC,CMDEPRAC       * match medical practices
          GOTO      CKCSH120 IF NOT EQUAL
.
          MATCH     SP70,CMDESDOC
          IF        !@EQUAL
            MATCH     PRHRE002,CMDESDOC     * match service doctor
            GOTO      CKCSH100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CMDEREFD
          GOTO      CKCSH110 IF EQUAL       * Refunded
          MATCH     "00000000",CMDEREFD
          GOTO      CKCSH100 IF NOT EQUAL   * Not Refunded
.
CKCSH110  PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,CKCSH100
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,CKCSH100
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      CKCSH100 IF EQUAL
.
          COMPARE   ZERO,RCDTAMNT
          GOTO      CKCSH100 IF EQUAL
.
          ADD       RCDTAMNT,DEPTOTAL       * get out total cash deposits
          MOVE      TRUE,FLAGCASH           * set cash deposits flag
.
          MOVE      "P",KEY1
          MOVE      RCBNTTYP,F1
          LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
          MOVE      RCDTDPTY,KEY3
          CALL      PAYD0000                * Get payment desc.
.
          REP       " 0",RCDTTDAT
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          MULT      "-1",RCDTAMNT
          WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "</td>":
                             "<td>&nbsp;</td>":
                             "<td>",KEY30," RECEIPT ##",RCDTRECN,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>";
          GOTO      CKCSH100
.
.         Check for any non-banked deposits
.
CKCSH120  MOVE      ZERO,NBNKDEPS
          PACK      KEY25,PRDTDEBT,SP70
          CALL      RSRCDTE5
CKCSH140  CALL      RKRCDTE5
          BRANCH    OVRCD,CKCSH999
.
          MATCH     PRDTDEBT,RCDTURNO
          GOTO      CKCSH999 IF NOT EQUAL
.
          MATCH     PRDTPRAC,RCDTPRAC       * match medical practices
          GOTO      CKCSH140 IF NOT EQUAL
.
          MATCH     SP70,RCDTSDOC
          IF        !@EQUAL
            MATCH     PRHRE002,RCDTSDOC     * match service doctor
            GOTO      CKCSH140 IF NOT EQUAL
          ENDIF
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CKCSH140
          COMPARE   "96",REGIBACD
          GOTO      CKCSH140 IF NOT EQUAL   * Not a PP Deposit register
.
          MATCH     SP10,RCDTINVN          * Invoice number must be blank
          GOTO      CKCSH140 IF NOT EQUAL
          MATCH     SP10,RCDTRELD
          GOTO      CKCSH140 IF NOT EQUAL   * has been released
.
          PACK      KEY12,RCDTRECN
          CALL      RDRCBNK1
          BRANCH    OVRCD,CKCSH140
          MATCH     "1",RCBNSTAT            * check if cancelled
          GOTO      CKCSH140 IF EQUAL
.
          COMPARE   ZERO,RCDTAMNT
          GOTO      CKCSH140 IF EQUAL
.
          ADD       RCDTAMNT,NBNKDEPS
          MOVE      "P",KEY1
          MOVE      RCBNTTYP,F1
          LOAD      KEY1,F1,ANSH,ANSI,ANSG,ANSH
          MOVE      RCDTDPTY,KEY3
          CALL      PAYD0000                * Get payment desc.
.
          REP       " 0",RCDTTDAT
          UNPACK    RCDTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,NJAN,NFEB,NMAR,NAPR,NMAY,NJUN:
                               NJUL,NAUG,NSEP,NOCT,NNOV,NDEC
.
          MULT      "-1",RCDTAMNT
          WRITE     HTMLFILE;"<tr><td>Payment - ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "</td>":
                             "<td>&nbsp;</td>":
                             "<td>",KEY30," RECEIPT ##",RCDTRECN,"*</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",RCDTAMNT,"</td></tr>";
.
          GOTO      CKCSH140
.
CKCSH999  RETURN
+
.*******************************************************************************
.     Payment description
.*******************************************************************************
PAYD0000  MOVE      SP70,KEY30
          CLEAR     KEY30
          MATCH     SP70,KEY3
          GOTO      PAYD2000 IF NOT EQUAL   * Deposit
.
          MATCH     "H",KEY1
          IF        @EQUAL
            APPEND    "FROM HEALTH FUND ",KEY30
          ELSE
            MATCH     "I",KEY1
            IF        @EQUAL
              APPEND    "FROM INSURANCE  ",KEY30
            ELSE
              APPEND    "FROM PATIENT    ",KEY30
            ENDIF
          ENDIF
          APPEND    RCBNRCOD,KEY30
          GOTO      PAYD8000
.
PAYD2000  PACK      KEY5,ANSD,ANSP,KEY3,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    "DEPOSIT - ",KEY30
            APPEND    TDESC,KEY30
          ENDIF
.
PAYD8000  APPEND    SP70,KEY30
          RESET     KEY30
PAYD9999  RETURN
+
.-----------------------------------------------------------
. Pending Invoice List
.-----------------------------------------------------------
PNLS0000  MATCH     SP70,URNUMBER
          GOTO      PNLS9999 IF EQUAL
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          MOVE      ONE,PRHDSCAN
          PACK      KEY27,URNUMBER,PRHDSCAN,SP70
          CALL      RSPRHD1
PNLS1000  CALL      RKPRHD1
          BRANCH    OVRCD,PNLS9999
          MATCH     PRHDDEBT,URNUMBER       * Same U/R number ?
          GOTO      PNLS9999 IF NOT EQUAL
.
          PACK      KEY5,CODECL,PRHDCLAM    * claim type
          CALL      RDCODE1
          BRANCH    OVRCD,PNLS1000
.
          PACK      KEY28,ONE,PRHDUNIQ,SP70
          CALL      RSPRHR2
PNLS2000  CALL      RKPRHR2
          BRANCH    OVRCD,PNLS1000
.
          COMPARE   ONE,PRHRPINV                 * invoice to be printed ?
          GOTO      PNLS1000 IF NOT EQUAL        * no
.
          COMPARE   PRHRUNIQ,PRHDUNIQ
          GOTO      PNLS1000 IF NOT EQUAL   * different unique number
.
          PACK      KEY6,PRHRPRAC,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,PNLS2000
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PNLS2000
          ENDIF
.
          MOVE      "&nbsp;",KEY35
          PACK      KEY10,PRHRDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,KEY35
          ENDIF
.
          MOVE      "&nbsp;",KEY20
          PACK      KEY5,ANSC,ANSL,PRHDCLAM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20             * Claim code desc.
          ENDIF
.
          MOVE      "&nbsp;",TDESC
          PACK      KEY5,ANSG,ANSI,PRHRPIND   * Patient indicator
          CALL      RDCODE1
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/EditIcon.gif ":
                             " class=ListIcon onclick='linkDocRef(#"":
                             URNUMBER,"#",#"",PRHRUNIQ,"#",#"",PRHRPRAC,"#",#"":
                             PRHRDOCT,"#",#"",PRHRPIND,"#")'>":
                             PRPRDESC,"</td>";
.
          MATCH     SP70,PMHCPRV1              * Check provider number
          IF        @EQUAL
             WRITE     HTMLFILE;"<td>",KEY35,"</td>";
          ELSE
             WRITE     HTMLFILE;"<td>",KEY35,"(",PMHCPRV1,")</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",KEY20,"</td>":
                             "<td>",TDESC,"</td>";
.
          MATCH     SP10,PRHDACCD
          IF        !@EQUAL
            UNPACK    PRHDACCD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</td></tr>"
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td></tr>"
          ENDIF
.
          ADD       ONE,ROWCOUNT
.
          COMPARE   NORECORD,ROWCOUNT
          GOTO      PNLS2000 IF NOT EQUAL
.
PNLS9999  RETURN
+
.****************************************************************************
.  Display claim details
.****************************************************************************
DCLM0000  MOVE      OLDCLAIM,CLAIMCOD   * check old claim code indicator
          CALL      GCLM0000            * Setup COMPFLAG from claim code
.
          IF        INVOICEN=0
            PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003
            CALL      RDPRHR1
            BRANCH    OVRCD,DCLM9999
            MOVE      PRHRUNCL,PRINCNUM
          ELSE
            MOVE      INVOICEN,KEY8
            CALL      RDPRIN1
            BRANCH    OVRCD,DCLM9999
          ENDIF
.
          PACK      KEY16,INVOICEN,PRINCNUM
          BRANCH    COMPFLAG,DCLM1000,DCLM2000,DCLM3000,DCLM4000
          GOTO      DCLM9999
.
DCLM1000  CALL      RDPRWC1           * Workers comp.
          BRANCH    OVRCD,DCLM9999
          CALL      DSWC0000          * Display workers comp details
          GOTO      DCLM9999
.
DCLM2000  CALL      RDPRMA1           * TAC
          BRANCH    OVRCD,DCLM9999
          CALL      DSMA0000          * Display TAC details
          GOTO      DCLM9999
.
DCLM3000  CALL      RDPRVA1           * Veteran affairs
          BRANCH    OVRCD,DCLM9999
          CALL      DSVA0000          * Display Veteran affairs details
          GOTO      DCLM9999
.
DCLM4000  CALL      RDPRCT1           * Civil tort
          BRANCH    OVRCD,DCLM9999
          CALL      DSCT0000          * Display Civil tort details
          GOTO      DCLM9999
.
DCLM9999  RETURN
+
.****************************************************************************
.         Display Civil Tort
.****************************************************************************
DSCT0000  WRITE     HTMLFILE;"<tr><td width=18%>":
                             "Solicitor Name</td>":
                             "<td><b>",PRCTSNAM,"</b></td>":
                             "<td>Contact Name</td>":
                             "<td><b>",PRCTCONT,"</b></td></tr>":
                             "<tr><td>Solicitor Address</td>":
                             "<td><b>",PRCTSAD1,"</b></td>":
                             "<td>Reference Number</td>":
                             "<td><b>",PRCTREFN,"</b></td></tr>":
                             "<tr><td>Solicitor Address</td>":
                             "<td><b>",PRCTSAD1,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>":
.
                             "<tr><td>&nbsp;</td>":
                             "<td><b>",PRCTSAD2,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>":

                             "<tr><td>&nbsp;</td>":
                             "<td><b>",PRCTSAD3,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>":
.
                             "<tr><td>&nbsp;</td>":
                             "<td><b>",PRCTSAD4,"</b>Postcode":
                             "<b>",PRCTSPCO,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>":
.
                             "<tr><td>Solicitor Phone Number</td>":
                             "<td><b>",PRCTSPHN,"</b></td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td></tr>"
DSCT9999  RETURN
+
.****************************************************************************
.         Display Veteran Affairs
.****************************************************************************
DSVA0000  WRITE     HTMLFILE;"<tr><td>":
                               "Claim Number</td>":
                               "<td><b>",PRVACLAM,"</b></td></tr>"
DSVA9999  RETURN
+
.****************************************************************************
.         Display TAC
.****************************************************************************
DSMA0000  WRITE     HTMLFILE;"<tr><td>":
                               "TAC Claim Number</td>":
                               "<td><b>",PRMAREFN,"</b></td>":
                               "<td>Time of Accident</td>":
                               "<td><b>",PRMAATIM,"</b></td>":
                               "<td>Acc.Location</td>":
                               "<td><b>",PRMAALOC,"</b></td></tr>":

                               "<tr><td>Other Driver</td>":
                               "<td><b>",PRMAODD1,"</b></td>":
                               "<td>Solicitor Name</td>":
                               "<td><b>",PRMASOLN,"</b></td>":
                               "<td>Police Station Rep.</td>":
                               "<td><b>",PRMAPOLS,"</b></td></tr>":

                               "<tr><td>Details</td>":
                               "<td><b>",PRMAODD2,"</b></td>":
                               "<td>Details</td>":
                               "<td><b>",PRMASAD1,"</b></td>":
                               "<td>Car Reg.Inv.</td>":
                               "<td><b>",PRMAREGO,"</b></td></tr>":

                               "<tr><td>&nbsp;</td>":
                               "<td><b>",PRMAODD3,"</b></td>":
                               "<td>&nbsp;</td>":
                               "<td><b>",PRMASAD2,"</b></td>":
                               "<td>Region of Severist inj.</td>":
                               "<td><b>",PRMARSEV,"</b></td></tr>":

                               "<tr><td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td><b>",PRMASAD3,"</b></td>":
                               "<td>While engaged in</td>":
                               "<td><b>",PRMAENGD,"</b></td></tr>":

                               "<tr><td>Injured when</td>":
                               "<td><b>",PRMAINJD,"</b></td>":
                               "<td>Post Code</td>":
                               "<td><b>",PRMASPCD,"</b></td>":
                               "<td>Mech of Severist inj.</td>":
                               "<td><b>",PRMAMSEV,"</b></td></tr>":

                               "<tr><td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>Phone Number</td>":
                               "<td><b>",PRMASOLT,"</b></td>":
                               "<tr>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>"

DSMA9999  RETURN
+
.****************************************************************************
.         Display workers comp
.****************************************************************************
DSWC0000  MOVE      SP70,INAME              * insurance company name
          PACK      KEY6,PRWCICOD
          CALL      RDINSR1
          MOVE      "Yes",KEY3
          IF        PRWCACCP=1
            MOVE      "No ",KEY3
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td width=18%>":
                               "Employer</td>":
                               "<td><b>",PRWCNAME,"</b></td>":
                               "<td>Time of Accident</td>":
                               "<td><b>",PRWCTIME,"</b></td></tr>":

                               "<tr><td>&nbsp;</td>":
                               "<td><b>",PRWCADD1,"</b></td>":
                               "<td>Insurance Company</td>":
                               "<td><b>",INAME,"</b></td></tr>":
.
                               "<tr><td>&nbsp;</td>":
                               "<td><b>",PRWCADD2,"</b></td>":
                               "<td>Insurance Claim No</td>":
                               "<td><b>",PRWCCLMN,"</b></td></tr>":
.
                               "<tr><td>State</td>":
                               "<td><b>",PRWCADD3,"</b>":
                               "Postcode":
                               "<b>",PRWCPOST,"</b></td>":
                               "<td>Claim Accepted Insurance</td>":
                               "<td><b>",KEY3,"</b></td></tr>":
.
                               "<tr><td>Employer Phone</td>":
                               "<td><b>",PRWCTELE,"</b></td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>";
.
DSWC9999  RETURN
+
.****************************************************************************
.*                              CBUL0000                                    *
.*                       Check if bulk billing                              *
.****************************************************************************
CBUL0000  MOVE      ZERO,EXIT
          MOVE      SP30,BBDESC
          PACK      PRHRBULK,PRHRBULK,SP10
          MATCH     SP3,PRHRBULK
          GOTO      CBUL9000 IF EQUAL
.
          PACK      KEY5,CATGB,PRHRBULK
          CALL      RDCODE1
          BRANCH    OVRCD,CBUL9000
.
          MOVE      ONE,FORM1
.
          WHILE     FORM1 < SIX
             LOAD   ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
             TYPE   ANS                     * see if we have a number
             GOTO   CBUL1000 IF EQUAL
.
             REP    "C1W2V3H4S5M6",ANS
.
             TYPE   ANS                     * see if we have a number
             GOTO   CBUL1000 IF NOT EQUAL
.
             MOVE   THCSCOD,ANS
.
             TYPE   ANS
             GOTO   CBUL9000 IF EQUAL
.
             REP    "H1I2G3",ANS
.
             TYPE    ANS
             GOTO    CBUL9000 IF NOT EQUAL
.
             MOVE    ZERO,EXIT
             MOVE    TDESC,BBDESC
.
             GOTO   CBUL9999
.
.------ increment the counter and continue loop ------
.
CBUL1000     ADD    ONE,FORM1
.
          DO
.
CBUL9000  MOVE      ONE,EXIT
.
CBUL9999  RETURN
+
.****************************************************************************
.*                                RDIT0000                                  *
.*         read in the item record to find out if fixed charged             *
.****************************************************************************
.
RDIT0000  PACK      KEY22,TMPIFLAG,TMPITEM,TMPSITEM,TMPSDATE,SP70
          CALL      RDPRIT1                 * read the item file
          COMPARE   ZERO,OVRCD
          GOTO      RDIT9999 IF EQUAL
.
RDIT1000  CALL      RPPRIT1                 * get the previous record on the
          BRANCH    OVRCD,RDIT9000            item file
.
          MATCH     PRITSUBN,TMPSITEM       * see if we have the same sub-item
          GOTO      RDIT9000 IF NOT EQUAL
.
          MATCH     PRITITMN,TMPITEM       * see if we have the same item
          GOTO      RDIT9000 IF NOT EQUAL
.
          COMPARE   PRITFLAG,TMPIFLAG       * see if we have the item type
          GOTO      RDIT9000 IF NOT EQUAL
.
.                                           * check Effective & Cease dates
.
          MATCH     PRITDAT1,TMPSDATE                        * start  *I-230710
          GOTO      RDIT1000 IF LESS
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date
          IF        !@EQUAL
            MATCH     TMPSDATE,PRITDAT2
            GOTO      RDIT1000 IF LESS      * read next if past Cease date
          ENDIF                                                * end  *I-230710
.
.         We have the required record
.
          GOTO      RDIT9999
.
.------ assume not a fixed charged item -------
.
RDIT9000  MOVE      TWO,PRITFIXD        * not fixed charged
.
RDIT9999  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"priweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
.
PREVGR99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"priweb02.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
.
NEXTGR99  RETURN
.
.----------------------------------------------------------------
. Get item description and amount for an item
.----------------------------------------------------------------
GETDES00  MOVE      ZERO,PRITSFEE
          MOVE      SP70,PRITDESC
          MOVE      ZERO,PRITKEYI
          PACK      KEY9,PRTDCODE,SP70
          PACK      KEY3,PRTDSUBI,SP70
          MOVE      PRTDTYPE,IFLAG
          PACK      RETURNDT,KEY8
          REP       " 0",RETURNDT
.
.         Check for test item
.
          MOVE      ZERO,TFLAG
          MATCH     SP1,PRCNTCOD
          GOTO      GETDES20 IF EQUAL
          CMATCH    PRCNTCOD,PRTDCODE
          GOTO      GETDES20 IF NOT EQUAL        * Not a test item
.
          PACK      PRTDCODE,KEY9,SP70
          MOVE      ONE,TFLAG                    * flag for test item
          UNPACK    PRTDCODE,KEY1,PRITITMN       * item code
.
          PACK      KEY17,PRITITMN,NINE8         * position pointer after last
.                                                  record for this code
          CALL      RSPRTE1
GETDES10  CALL      RPPRTE1                      * read previous record
          BRANCH    OVRCD,GETDES90               * end of file
.
          MATCH     PRTECODE,PRITITMN            * same test code ?
          GOTO      GETDES90 IF NOT EQUAL        * no
          MATCH     PRTEDATE,RETURNDT            * service date < record date ?
          GOTO      GETDES10 IF LESS             * yes
.
          BRANCH    IFLAG,GETDES12               * AMA Item
.
          MOVE      PRTEITMN,KEY9
          MOVE      PRTESUBN,KEY3
          GOTO      GETDES20
.
GETDES12  MOVE      PRTEAMAN,KEY9
          MOVE      SP10,KEY3
.
.         Loop through priitem file
.
GETDES20  PACK      KEY22,IFLAG,KEY9,KEY3,NINE8
          CALL      RSPRIT1                      * position after last record
.                                                  for this item
GETDES30  CALL      RPPRIT1                      * read previous record
          BRANCH    OVRCD,GETDES90               * end of file
.
          COMPARE   IFLAG,PRITFLAG               * same item type ?
          GOTO      GETDES90 IF NOT EQUAL        * no
.
          MATCH     KEY9,PRITITMN                * same item number ?
          GOTO      GETDES90 IF NOT EQUAL        * no
.
          MATCH     KEY3,PRITSUBN                * same subitem number ?
          GOTO      GETDES90 IF NOT EQUAL        * no
.
          MATCH     PRITDAT1,RETURNDT            * item date > service date ?
          GOTO      GETDES30 IF LESS             * yes
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date   *I-230710
          IF        !@EQUAL
            MATCH     RETURNDT,PRITDAT2
            GOTO      GETDES30 IF LESS      * ed next if past Cease date
          ENDIF                                                * end  *I-230710
.
.         Valid item
.
          CALL      EXCP0000           * Check for exception charge
          IF        EXIT=1
            MOVE      PREXCHRG,PRITSFEE
          ENDIF
          IF        TFLAG=1
            MOVE      PRTEDESC,PRITDESC  * Flag for keyin description
          ENDIF
          GOTO      GETDES99
.
GETDES90  MOVE      ZERO,PRITSFEE
          MOVE      SP70,PRITDESC
          MOVE      ZERO,PRITGSTA
          MOVE      SP70,PRITGSTC
GETDES99  RETURN
+
.*******************************************************************************
.         Remove record from tempfile
.*******************************************************************************
DETMP000  PACK      KEY35,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RSPRTMP1
          CALL      RKPRTMP1
          BRANCH    OVRCD,DETMP999
.
          MATCH     DPRHRUNQ,PRTMUNIQ
          GOTO      DETMP999 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRTMPRAC
          GOTO      DETMP999 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRTMDOCT
          GOTO      DETMP999 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRTMPIND
          GOTO      DETMP999 IF NOT EQUAL
.
          PACK      KEY35,PRTMUNIQ,PRTMPRAC,PRTMDOCT,PRTMPIND,PRTMCNTR,SP70
          CALL      DEPRTMP1
          GOTO      DETMP000
DETMP999  RETURN
+
.------------------------------------------------------------------------------
.         Load debtors details
.------------------------------------------------------------------------------
LDDETAIL  MOVE      ONE,OVRCD
          MOVE      SP30,PSNAME
          MOVE      SP30,PGNAME
          MOVE      SP30,FNSNAME
          MOVE      SP70,VDEBNAME
          MOVE      VDEBTOR,PURNO
          MOVE      PURNO,PRHDDEBT
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LDDET900
.
.         Load display variables
.
          MOVE      PSNAME,FNSNAME
          MOVE      SP30,VDEBNAME
          MATCH     SP30,PSNAME
          GOTO      LDDET100 IF NOT EQUAL
          MOVE      "[Missing Surname]",PSNAME
LDDET100  MOVE      PSNAME,VDEBNAME
          RESET     VDEBNAME,30
LDDET200  CMATCH    SP1,VDEBNAME
          GOTO      LDDET300 IF NOT EQUAL
          BUMP      VDEBNAME,-1
          GOTO      LDDET200
LDDET300  APPEND    ",",VDEBNAME
          APPEND    SP1,VDEBNAME
          APPEND    PGNAME,VDEBNAME
          RESET     VDEBNAME
.
          MOVE      PBDEBT,VBADEBT
          MOVE      PADD1,VDEBADD1
          MOVE      PADD2,VDEBADD2
          MOVE      PSUBRB,VDEBADD3
          MOVE      PADD4,VDEBADD4
          MOVE      PPOST,VDEBPOST
          MOVE      PTELEP,VDEBTELP
          MOVE      PTELEB,VDEBTELB
.
          MOVE      SP10,VDOB
          MATCH     SP8,PBDATE                   * any dob ?
          GOTO      LDDET800 IF EQUAL            * no
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,VDOB
.
LDDET800  MOVE      ZERO,OVRCD
LDDET900  RETURN
+
.------------------------------------------------------------------------------
.         Set PRFA details for reprint invoice
.------------------------------------------------------------------------------
SETPRA00  MOVE      PRINNAMR,TMPRESP
          MOVE      PRINPRA1,TMPRADD1
          MOVE      PRINPRA2,TMPRADD2
          MOVE      PRINPRA3,TMPRADD3
          MOVE      PRINPRA4,TMPRADD4
          MOVE      PRINPOST,TMPRPOST
          MOVE      PRINTELP,TMPRPTEL
          MOVE      PRINTELB,TMPRBTEL
          MOVE      PRINMPHN,TMPRMPHN
          MOVE      PRINRELP,TMPRREL
          MOVE      PRINDOCT,VSVDOCT
          MOVE      "                              ",VSVDCNAM
          MOVE      "                              ",PRIMTYPE
          MOVE      SP10,VSVDPROV
.
          UNPACK    SP70,VSVDCNAM,VSVDPROV,PRIMTYPE
          PACK      KEY10,PRINDOCT,SP10
          CALL      RDPMHCP1                * read the doctors file
          BRANCH    OVRCD,SETPRA99
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME                 * pack the doctors name
          MOVE      PACFNAME,VSVDCNAM
          MOVE      PMHCPRV1,VSVDPROV
.
          MATCH     SP3,PMHCSPC1            * see if the doctors type exists
          GOTO      SETPRA99 IF EQUAL
.
          PACK      KEY5,CODEDT,PMHCSPC1
          CALL      RDCODE1                 * read the patient codes file
          BRANCH    OVRCD,SETPRA99
          MOVE      TDESC,PRIMTYPE
.
SETPRA99  RETURN
.
.******************************************************************************
.*                                   PRIINVLI                                 *
.*      This routine will load the temporary file with the relevant details   *
.*      for a given unique identifier for a given debtor                      *
.******************************************************************************
PRIINVLI  MOVE      FALSE,FLAGSOME
.
.------ get the details for this unique identifier ------
.
          MOVE      FALSE,FLAGHOLD
          MOVE      TEMPUNQ,KEY8
          CALL      RDPRHD2                 * read the holding header file
          BRANCH    OVRCD,PRIIN990
.
          PACK      KEY27,TEMPUNQ,TMPPRAC,TMPSDOCT,TMPPIND,SP20
          CALL      RDPRHR1
          BRANCH    OVRCD,PRIIN990            holding referral file
.
.------ Process this referral record ------
.
          CALL      PRLIT000                * load transactions for referral
.
.------ we have finished processing this debtors unique identifier so ------
.------ if no records have been found then records don't exist for this ------
.------ debtor's unique identifier OR patient's account is on hold ------
.
PRIIN990  MOVE      FALSE,EXIT
          BRANCH    FLAGSOME,PRIIN999       * see if we have found some records
.                                             for this unique identifier
          MOVE      TRUE,EXIT
          GOTO      PRIIN999
.
PRIIN999  RETURN
+
.**********************************************************************
.*                               PRLIT000                             *
.*   Routine to load the details for a single referral                *
.**********************************************************************
PRLIT000  PACK      DIM27,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND
          PACK      KEY62,TEMPUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP30,SP30
...       CALL      RSPRHT1                 * get the first record on the
...                                           holding transaction file
          PACK      KEY70,TEMPUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP30,SP30
          CALL      RSPRHT4                 * get the first record on the
.                                             holding transaction file
.
.------ get the next record on the holding transaction file ------
.
PRLIT300  CALL      RKPRHT4                            * was RKPRHT1  *C-123419
          BRANCH    OVRCD,PRLIT999
.
          COMPARE   TEMPUNQ,PRHTUNIQ        * compare unique identifiers
          GOTO      PRLIT999 IF NOT EQUAL
.
          PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND
.
          MATCH     KEY27,DIM27             * only continue if we have the
          GOTO      PRLIT999 IF NOT EQUAL     same key value
.
          COMPARE   TWO,PRHTFLAG
          GOTO      PRLIT300 IF EQUAL
.
          COMPARE   ZERO,PRHTPFLG           * skip if not a pathology test code
          GOTO      PRLIT400 IF EQUAL
.
          CALL      PATHL000                * write the pathology test code
          BRANCH    EXIT,PRLIT300             details to the temp file
          MOVE      TRUE,FLAGSOME
          GOTO      PRLIT300
.
.------ we are not processing a pathology test code OR ------
.------ we are processing a S4B3 ----
.
PRLIT400  CALL      LOADT000                * load the temp file variables
.
          MOVE      TRUE,FLAGSOME
          PACK      KEY80,VDEBTOR,VSCANPMI,PRHRPRAC,PRHDCLAM,PRHRDOCT:
                           PRHRPIND,PRHTRDAT,PRHTREFD,PRHTDATE,PRHTTIME:
                           PRHTFLAG,ITEM,PRHTSUBN,PRHTNUMB
.******************************************** start of addition        *I-60399
          IF        PRCNRDOC = 0
            PACK      KEY80,VDEBTOR,VSCANPMI,PRHRPRAC,PRHDCLAM,PRHRDOCT:
                             PRHRPIND,PRHRRDAT,PRHRREFD,PRHTDATE,PRHTTIME:
                             PRHTFLAG,ITEM,PRHTSUBN,PRHTNUMB
          ENDIF
.********************************************   end of addition        *I-60399
.
          CALL      RATMPR2                 * see if record exists on the temp
          BRANCH    OVRCD,PRLIT500            file
          GOTO      PRLIT300
.
.------ write a new record to the temp file ------
.
PRLIT500  MOVE      VDEBTOR,TMPDEBT
          MOVE      "1",TMPSCAN
          MOVE      PRHRPRAC,TMPPRAC
          MOVE      PRHDCLAM,TMPCLAIM
          MOVE      PRHRDOCT,TMPSDOCT
          MOVE      PRHTRDAT,TMPRDATE
          MOVE      PRHTREFD,TMPRDOCT
.******************************************** start of addition        *I-60399
          IF        PRCNRDOC = 0
            MOVE      PRHRRDAT,TMPRDATE
            MOVE      PRHRREFD,TMPRDOCT
          ENDIF
.********************************************   end of addition        *I-60399
          MOVE      PRHTRFPD,TMPREFP
          MOVE      PRHRPIND,TMPPIND
          MOVE      PRHTDATE,TMPSDATE
          MOVE      PRHTTIME,TMPSTIME
          MOVE      PRHTFLAG,TMPIFLAG
          MOVE      ITEM,TMPITEM
          MOVE      PRHTSUBN,TMPSITEM
          MOVE      PRHTNUMB,TMPTRAN
          MOVE      PRHTGSTA,TMPGSTA
          MOVE      PRHTGSTC,TMPGSTC
          MOVE      PRHTREFN,TMPREFN
          MOVE      PRHTENCN,TMPENCN
          MOVE      PRHTPFLG,TMPPFLAG
          MOVE      PRHTS4B3,TMPS4B3
          MOVE      PRHTITMN,TMPHITM
          MOVE      PRHTSUBN,TMPHSUB
          MOVE      PRHTNUMB,TMPHTRN
          MOVE      PRHTHICI,TMPHICI
          MOVE      PRHTACOI,TMPACOI
          MOVE      PRHTTDUR,TMPTDUR
          MOVE      PRHRRPER,TMPRPER
.
          MOVE      PRHTROVR,TMPROVR
.
          MATCH     "1",PTCNUESF
          IF        @EQUAL
            MATCH     SP70,PRHRTACC     
            IF        !@EQUAL
              MOVE      "ta",CATEGORY
              MOVE      PRHRTACC,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "5",TCINDC1
                IF        @EQUAL
                  MOVE      PRHRROVR,TMPROVR
                ENDIF 
              ENDIF 
            ENDIF
          ELSE
            MATCH     "1",PTCNPCIW
            IF        @EQUAL
              MATCH     SP70,PRHRTACC
              IF        !@EQUAL
                MOVE      "ta",CATEGORY
                MOVE      PRHRTACC,CODE
.
                PACK      KEY5,CATEGORY,CODE,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  MATCH     "5",TCINDC1
                  IF        @EQUAL
                    MOVE      PRHRROVR,TMPROVR
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF 
.
          MOVE      PRHTMPOV,TMPMPOV
          MOVE      PRHTDSOV,TMPDSOV
          MOVE      PRHTSTXT,TMPSTXT
          MOVE      PRHTASPF,TMPASPF
          MOVE      PRHTASPC,TMPASPC
.          MOVE      PRHTAICF,TMPAICF
          MOVE      PRHTAICV,TMPAICV
          MOVE      PRHTNMPT,TMPNMPT
          MOVE      PRHTLSPN,TMPLSPN
          MOVE      PRHTSDCD,TMPSDCD
          MOVE      PRHTLVIS,TMPLVIS
          MOVE      PRHTHOSI,TMPHOSI
          MOVE      PRHTROVC,TMPROVC
          MOVE      PRHTDSKM,TMPDSKM
          CALL      WRTMPR2
          GOTO      PRLIT300
.
PRLIT999  RETURN
.**************************************************************************
OPEN0000
CLOS0000
GETSVAR   RETURN
+
.------------------------------------------------------------
. Private Practice Stationery Template Variables
.------------------------------------------------------------
PRPSTT00  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
.
          MATCH     SP1,UPDTTYPE
          GOTO      PRPSTT80 IF EQUAL
.
          MATCH     "P",UPDTTYPE
          GOTO      PRPSTT70 IF EQUAL
.
          GOTO      PRPSTT98
.
.         ************ PRINT FORMACTION ***********
.
PRPSTT70  MATCH     SP70,STATNCOD
          GOTO      PRPSTT93 IF EQUAL
          GOTO      PRPSTT93 IF EOS
.
          MATCH     SP70,URNUMBER
          GOTO      PRPSTT91 IF EQUAL
          GOTO      PRPSTT91 IF EOS
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PRPSTT91
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PRPSTT91
.
          MATCH     SP70,UNIQNUMB
          GOTO      PRPSTT92 IF EQUAL
          GOTO      PRPSTT92 IF EOS
.
          PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,PRPSTT92
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,PRPSTT92
.
          CALL      CLPRIN00
          COMPARE   ZERO,INVOICEN
          GOTO      PRPSTT75 IF EQUAL
.
          PACK      KEY8,INVOICEN,SP70
          CALL      RDPRIN1
.
PRPSTT75  CALL      CLPRIP00
          MATCH     SP70,PRHRE001
          GOTO      PRPSTT90 IF EQUAL
          GOTO      PRPSTT90 IF EOS
.
          PACK      KEY6,PRHRE001,SP70
          CALL      RDPRPR1
.
          CALL      PRVHFCF
.
          MOVE      ZERO,EXIT
          GOTO      PRPSTT99
.
.         ************ DISPLAY FORMACTION ***********
.
PRPSTT80  MATCH     SP70,URNUMBER
          GOTO      PRPSTT91 IF EQUAL
          GOTO      PRPSTT91 IF EOS
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PRPSTT91
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PRPSTT91
.
          MATCH     SP70,UNIQNUMB
          GOTO      PRPSTT92 IF EQUAL
          GOTO      PRPSTT92 IF EOS
.
          PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,PRPSTT92
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,PRPSTT92
.
          CALL      CLPRIN00
          COMPARE   ZERO,INVOICEN
          GOTO      PRPSTT85 IF EQUAL
.
          PACK      KEY8,INVOICEN,SP70
          CALL      RDPRIN1
.
PRPSTT85  CALL      CLPRIP00
          MATCH     SP70,PRHRE001
          GOTO      PRPSTT90 IF EQUAL
          GOTO      PRPSTT90 IF EOS
.
          PACK      KEY6,PRHRE001,SP70
          CALL      RDPRPR1
.
          GOTO      PRPSTT90
.
PRPSTT90  CLEAR     WEBTITLE
          MOVE      "Private Practice Stationery Template Variables",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRPSTT99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRPSTT99
.
PRPSTT91  MOVE      "Missing U/R number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRPSTT99
.
PRPSTT92  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRPSTT99
.
PRPSTT93  MOVE      "Missing Stationery Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRPSTT99
.
PRPSTT98  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRPSTT99
.
PRPSTT99  RETURN
.
.------------------------------------------------------------
. Outstanding balance after entering a new journal amount
.------------------------------------------------------------
JCAL0000 CALL      XMLHED00
         BRANCH    EXIT,JCAL9999
.
         MOVE      ZERO,FORM12P2
         MOVE      ZERO,FORM8
         MOVE      INVOICEN,FORM8
         MOVE      FORM8,KEY8
         CALL      RDPRIN1
         BRANCH    OVRCD,JCAL9000
.
         MOVE      PRINDEBT,URNUMBER
         CALL      TPAY0000
         ADD       PRINITOT,FORM12P2
         ADD       PRINJAMT,FORM12P2
         ADD       PRINCNTT,FORM12P2
         ADD       PRINGSTJ,FORM12P2
         CALL      JTYP0000               * Check Journal type
.
JCAL9000 MOVE      FORM12P2,KEY15
         MOVE      "$",KEY1
         PACK      KEY16,KEY1,KEY15
         WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY16:
                             "</RETURN_VALUE>"
         CALL      XMLEND00
JCAL9999 RETURN
+
.------------------------------------------------------------
.  Private practice referral comments
.------------------------------------------------------------
RFCM0000  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      RFCM4000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add Notes Formaction
          GOTO      RFCM1000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Notes Formaction
          GOTO      RFCM3000 IF EQUAL
.
          GOTO      RFCM9300
.
.         ************ ADD FORMACTION ***********
.
RFCM1000  MATCH     SP70,UNIQNUMB
          GOTO      RFCM9999 IF EQUAL
.
          PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,RFCM9000
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RFCM9000
.
          CALL      ADNT0000                * Add Note SubRoutine
          MOVE      ZERO,EXIT
          GOTO      RFCM9999
.
.         ************ DELETE FORMACTION **********
.
RFCM3000  PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,RFCM9000
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RFCM9000
.
          CALL      DENT0000                * Delete Note SubRoutine
          BRANCH    EXIT,RFCM9999
.
          MOVE      ZERO,EXIT
          GOTO      RFCM9999
.
.         ************ DISPLAY FORMACTION **********
.
RFCM4000  PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,RFCM9000
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RFCM9000
.
          MOVE      PRHDDEBT,URNUMBER
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,RFCM9400
.
          PACK      SKEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          PACK      KEY36,SKEY27,NOTETYPE,NOTENUMB,SP70
          CALL      RDPRCDT1
          IF        OVRCD=1
            CALL      CLRCMN00     * Clear all the file variables
          ENDIF
.
          MOVE      "Referral Comments Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,RFCM9999
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      RFCM9999
.
RFCM9000  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFCM9999
.
RFCM9200  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFCM9999
.
RFCM9300  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFCM9999
.
RFCM9400  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFCM9999
.
RFCM9999  CLOSE     COMFILVF,DELETE
          RETURN
+
.------------------------------------------------------------
.  Clear Referral Comment note file variables
.------------------------------------------------------------
CLRCMN00  MOVE      SP70,PRCDUNIQ  * Unique Identifier
          MOVE      SP70,PRCDPRAC  * Medical Practice Code
          MOVE      SP70,PRCDDOCT  * Service Doctor
          MOVE      SP70,PRCDPIND  * Patient Indicator (Cat GI)
          MOVE      SP70,PRCDCTYP  * Comment Type
          MOVE      SP70,PRCDNOTE  * Note Number
          MOVE      SP70,PRCDIDAT  * Input Date (CCYYMMDD)
          MOVE      SP70,PRCDITIM  * Input Time (HH:MM:SS)
          MOVE      SP70,PRCDIUSR  * Input by WEB User ID (websecaf)
          MOVE      SP70,PRCDIOCG  * Occupational Group User ID (Input)
          MOVE      SP70,PRCDDIND  * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,PRCDDDAT  * Delete Date (CCYYMMDD)
          MOVE      SP70,PRCDDTIM  * Delete Time (HH:MM:SS)
          MOVE      SP70,PRCDDUSR  * Delete by WEB User ID (websecaf)
          MOVE      SP70,PRCDDOCG  * Occupational Group User ID (Delete)
          PACK      PRCDSPAR,SP70,SP70  * Spare Variable
.
          MOVE      SP70,PRCFUNIQ  * Unique Identifier
          MOVE      SP70,PRCFPRAC  * Medical Practice
          MOVE      SP70,PRCFDOCT  * Service Doctor
          MOVE      SP70,PRCFPIND  * Patient Indicator
          MOVE      SP70,PRCFCTYP  * Comment Type
          MOVE      SP70,PRCFNOTE  * Note Number
          MOVE      SP70,PRCFLINE  * Line Number
          PACK      PRCFCMNT,SP70,SP70  * Comment
          PACK      PRCFSPAR,SP70,SP70  * Spare Variable
.
CLRCMN99  RETURN
+
.------------------------------------------------------------
. Get referral Comments
.------------------------------------------------------------
GRCMNT00  PREP      COMFILVF,COMFILNV
          MOVE      ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
.
GRCMNT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GRCMNT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GRCMNT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILVF,SEQ;QRYDATA
          GOTO      GRCMNT10
.
GRCMNT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GRCMNT90  MOVE      F3,LASTITEM
          OPEN      COMFILVF,COMFILNV
GRCMNT99  RETURN
+
.------------------------------------------------------------
.  Add Referral comments
.------------------------------------------------------------
ADNT0000  MOVE      ZERO,F6
          PACK      SKEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          PACK      KEY36,SKEY27,NOTETYPE,Z70
          CALL      RSPRCDT1
          CALL      RPPRCDT1                * read back to get last record
          BRANCH    OVRCD,ADNT1000
.
          PACK      KEY27,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND,SP70
          MATCH     KEY27,SKEY27          * Same referral
          GOTO      ADNT1000 IF NOT EQUAL
.
          MATCH     NOTETYPE,PRCDCTYP   * Same note type
          GOTO      ADNT1000 IF NOT EQUAL
.
          MOVE      PRCDNOTE,F6
          ADD       ONE,F6
          MOVE      F6,PRCDNOTE
          GOTO      ADNT1200
.
ADNT1000  MOVE      ONE,F6
          MOVE      F6,PRCDNOTE         * Note Number
.
ADNT1200  MOVE      UNIQNUMB,PRCDUNIQ       * unique id
          MOVE      PRHRE001,PRCDPRAC       * medical practice
          MOVE      PRHRE002,PRCDDOCT       * service doctor
          MOVE      PRHRE003,PRCDPIND       * patient indicator
          MOVE      NOTETYPE,PRCDCTYP       * Notes Type
.
          MOVE      SP70,PRCDIDAT
          MOVE      SP70,PRCDITIM
          MOVE      SP70,PRCDIUSR
          MOVE      SP70,PRCDIOCG
.
          PACK      PRCDIDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRCDIDAT          * Date
          CLOCK     TIME,PRCDITIM
          MOVE      USERID,PRCDIUSR        * User
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADNT9999
          MOVE      WBSEOCG,PRCDIOCG        * Occupation Group
.
          MOVE      "0",PRCDDIND            * Delete Indicator
          MOVE      SP70,PRCDDDAT           * Delete Date
          MOVE      SP70,PRCDDTIM           * Delete Time
          MOVE      SP70,PRCDDUSR           * Delete User
          MOVE      SP70,PRCDDOCG           * Delete User Occupation group
          PACK      PRCDSPAR,SP70,SP70      * Spare
.
          PACK      KEY36,PRCDUNIQ,PRCDPRAC,PRCDDOCT,PRCDPIND:
                          PRCDCTYP,PRCDNOTE,SP70
          CALL      RDPRCDT1
          IF        OVRCD=1
            CALL      WRPRCDT1              * Write Record
          ELSE
            GOTO      ADNT9999
          ENDIF
.
.         now write the Comments notes
.
          MOVE      PRCDUNIQ,PRCFUNIQ
          MOVE      PRCDPRAC,PRCFPRAC
          MOVE      PRCDDOCT,PRCFDOCT
          MOVE      PRCDPIND,PRCFPIND
          MOVE      PRCDCTYP,PRCFCTYP
          MOVE      PRCDNOTE,PRCFNOTE
.
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
ADNT2000  ADD       ONE,F3
          MOVE      F3,PRCFLINE
.
          READ      COMFILVF,SEQ;PRCFCMNT
          GOTO      ADNT9999 IF OVER
.
          MATCH     SP70,PRCFCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADNT2000
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADNT8000                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADNT2000          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADNT8000
          ENDIF
          MOVE      ZERO,BLNKFLAG
.
ADNT8000  PACK      KEY39,PRCFUNIQ,PRCFPRAC,PRCFDOCT,PRCFPIND,PRCFCTYP:
                          PRCFNOTE,PRCFLINE,SP70
          CALL      WRPRCFX1
          IF        F3>=LASTITEM
            GOTO     ADNT9999
          ENDIF
          GOTO      ADNT2000
.
ADNT9999  RETURN
+
.-----------------------------------------------------------
. Delete Referral comments
.-----------------------------------------------------------
DENT0000  MATCH     SP70,UNIQNUMB
          GOTO      DENT9000 IF EQUAL
.
          MOVE      UNIQNUMB,PRCDUNIQ       * unique id
          MOVE      PRHRE001,PRCDPRAC       * medical practice
          MOVE      PRHRE002,PRCDDOCT       * service doctor
          MOVE      PRHRE003,PRCDPIND       * patient indicator
          MOVE      NOTETYPE,PRCDCTYP       * Notes Type
.
          PACK      SKEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          PACK      KEY36,SKEY27,NOTETYPE,NOTENUMB,SP70
          CALL      RDPRCDT1
          BRANCH    OVRCD,DENT9999
.
.         MATCH     SP70,PRCDIUSR
.         IF        !@EQUAL
.           MATCH     USERID,PRCDIUSR
.           GOTO      DENT9100 IF NOT EQUAL
.         ENDIF
.
          PACK      PRCDDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRCDDDAT
          CLOCK     TIME,PRCDDTIM
          MOVE      USERID,PRCDDUSR
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DENT9999
.
          MOVE      WBSEOCG,PRCDDOCG
          MOVE      "1",PRCDDIND           * Delete Indicator
          CALL      UPPRCDT1               * Write Record
          GOTO      DENT9800
.
DENT9000  MOVE      "Unique ID should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DENT9999
.
.DENT9100 MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
.         CALL      WEBERR00
.         MOVE      ONE,EXIT
.         GOTO      DENT9999
.
DENT9800  MOVE      ZERO,EXIT
.
DENT9999  RETURN
.
.------------------------------------------------------------
.  Private practice Invoice comments
.------------------------------------------------------------
IVCM0000  COMPARE   ZERO,INVOICEN
          GOTO      IVCM9999 IF EQUAL
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,IVCM9100
.
          MOVE      ZERO,EXIT
          RESET     UPDTTYPE
.
          MATCH     SP70,UPDTTYPE
          GOTO      IVCM4000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add Notes Formaction
          GOTO      IVCM1000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Notes Formaction
          GOTO      IVCM3000 IF EQUAL
.
          GOTO      IVCM9300
.
.         ************ ADD FORMACTION ***********
.
IVCM1000  CALL      ADIV0000                * Add Note SubRoutine
          MOVE      ZERO,EXIT
          GOTO      IVCM9999
.
.         ************ DELETE FORMACTION **********
.
IVCM3000  CALL      DEIV0000                * Delete Note SubRoutine
          BRANCH    EXIT,IVCM9999
.
          MOVE      ZERO,EXIT
          GOTO      IVCM9999
.
.         ************ DISPLAY FORMACTION **********
.
IVCM4000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IVCM9400
.
          PACK      KEY17,INVOICEN,NOTETYPE,NOTENUMB,SP70
          CALL      RDPRICM1
          IF        OVRCD=1
            CALL      CLRICM00     * Clear all the file variables
          ENDIF
.
          MOVE      "Invoice Comments Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,IVCM9999
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9000  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9100  MOVE      "Invalid Invoice number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9200  MOVE      "Note exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9300  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9400  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IVCM9999
.
IVCM9999  CLOSE     COMFILIF,DELETE
          RETURN
+
.------------------------------------------------------------
.  Clear Referral Comment note file variables
.------------------------------------------------------------
CLRICM00  MOVE      SP70,PRICINVN  * Invoice Number
          MOVE      SP70,PRICCTYP  * Comment Type
          MOVE      SP70,PRICNOTE  * Note Number
          MOVE      SP70,PRICIDAT  * Input Date (CCYYMMDD)
          MOVE      SP70,PRICITIM  * Input Time (HH:MM:SS)
          MOVE      SP70,PRICIUSR  * Input by WEB User ID (websecaf)
          MOVE      SP70,PRICIOCG  * Occupational Group User ID (Input)
          MOVE      SP70,PRICDIND  * Delete Indicator (0=No,1=Yes)
          MOVE      SP70,PRICDDAT  * Delete Date (CCYYMMDD)
          MOVE      SP70,PRICDTIM  * Delete Time (HH:MM:SS)
          MOVE      SP70,PRICDUSR  * Delete by WEB User ID (websecaf)
          MOVE      SP70,PRICDOCG  * Occupational Group User ID (Delete)
          PACK      PRICSPAR,SP70,SP70  *  Spare Variable
.
          MOVE      SP70,PRIFINVN  * Invoice Number
          MOVE      SP70,PRIFCTYP  * Comment Type
          MOVE      SP70,PRIFNOTE  * Note Number
          MOVE      SP70,PRIFLINE  * Line Number
          MOVE      SP70,PRIFCMNT  * Comment
          PACK      PRIFSPAR,SP70,SP70  * Spare Variable
.
CLRICM99  RETURN
+
.------------------------------------------------------------
. Get invoice Comments
.------------------------------------------------------------
GICMNT00  PREP      COMFILIF,COMFIICM
          MOVE      ONE,F3
          WRITE     COMFILIF,SEQ;QRYDATA
.
GICMNT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GICMNT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GICMNT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILIF,SEQ;QRYDATA
          GOTO      GICMNT10
.
GICMNT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GICMNT90  MOVE      F3,LASTITEM
          OPEN      COMFILIF,COMFIICM
GICMNT99  RETURN
+
.------------------------------------------------------------
.  Add Invoice comments
.------------------------------------------------------------
ADIV0000  MOVE      ZERO,F6
          MOVE      INVOICEN,KEY8
          PACK      KEY17,INVOICEN,NOTETYPE,Z70
          CALL      RSPRICM1
          CALL      RPPRICM1                * read back to get last record
          BRANCH    OVRCD,ADIV1000
.
          MATCH     KEY8,PRICINVN          * Same invoice no
          GOTO      ADIV1000 IF NOT EQUAL
.
          MATCH     NOTETYPE,PRICCTYP      * Same note type
          GOTO      ADIV1000 IF NOT EQUAL
.
          MOVE      PRICNOTE,F6
          ADD       ONE,F6
          MOVE      F6,PRICNOTE
          GOTO      ADIV1200
.
ADIV1000  MOVE      ONE,F6
          MOVE      F6,PRICNOTE         * Note Number
.
ADIV1200  MOVE      INVOICEN,PRICINVN       * Invoice number
          MOVE      NOTETYPE,PRICCTYP       * Notes Type
.
          MOVE      SP70,PRICIDAT
          MOVE      SP70,PRICITIM
          MOVE      SP70,PRICIUSR
          MOVE      SP70,PRICIOCG
.
          PACK      PRICIDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRICIDAT          * Date
          CLOCK     TIME,PRICITIM
          MOVE      USERID,PRICIUSR        * User
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADIV9999
          MOVE      WBSEOCG,PRICIOCG        * Occupation Group
.
          MOVE      "0",PRICDIND            * Delete Indicator
          MOVE      SP70,PRICDDAT           * Delete Date
          MOVE      SP70,PRICDTIM           * Delete Time
          MOVE      SP70,PRICDUSR           * Delete User
          MOVE      SP70,PRICDOCG           * Delete User Occupation group
          PACK      PRICSPAR,SP70,SP70      * Spare
.
          PACK      KEY17,INVOICEN,PRICCTYP,PRICNOTE,SP70
          CALL      RDPRICM1
          IF        OVRCD=1
            CALL      WRPRICM1              * Write Record
          ELSE
            GOTO      ADIV9999
          ENDIF
.
.         now write the Comments notes
.
          MOVE      PRICINVN,PRIFINVN
          MOVE      PRICCTYP,PRIFCTYP
          MOVE      PRICNOTE,PRIFNOTE
.
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
ADIV2000  ADD       ONE,F3
          MOVE      F3,PRIFLINE
.
          READ      COMFILIF,SEQ;PRIFCMNT
          GOTO      ADIV9999 IF OVER
.
          MATCH     SP70,PRIFCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADIV2000
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADIV8000                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADIV2000          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADIV8000
          ENDIF
          MOVE      ZERO,BLNKFLAG
.
ADIV8000  PACK      KEY20,PRIFINVN,PRIFCTYP,PRIFNOTE,PRIFLINE,SP70
          CALL      WRPRIFX1
          IF        F3>=LASTITEM
            GOTO     ADIV9999
          ENDIF
          GOTO      ADIV2000
.
ADIV9999  RETURN
+
.-----------------------------------------------------------
. Delete Invoice comments
.-----------------------------------------------------------
DEIV0000  COMPARE   ZERO,INVOICEN
          GOTO      DEIV9000 IF EQUAL
.
          MOVE      INVOICEN,PRICINVN       * Invoice number
          MOVE      NOTETYPE,PRICCTYP       * Notes Type
.
          PACK      KEY17,INVOICEN,NOTETYPE,NOTENUMB,SP70
          CALL      RDPRICM1
          BRANCH    OVRCD,DEIV9999
.
.         MATCH     SP70,PRICIUSR
.         IF        !@EQUAL
.           MATCH     USERID,PRICIUSR
.           GOTO      DEIV9100 IF NOT EQUAL
.         ENDIF
.
          PACK      PRICDDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRICDDAT
          CLOCK     TIME,PRICDTIM
          MOVE      USERID,PRICDUSR
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DEIV9999
.
          MOVE      WBSEOCG,PRICDOCG
          MOVE      "1",PRICDIND           * Delete Indicator
          PACK      KEY17,PRICINVN,NOTETYPE,NOTENUMB,SP70
          CALL      UPPRICM1               * Write Record
          GOTO      DEIV9800
.
DEIV9000  MOVE      "Unique ID should not be blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DEIV9999
.
.DEIV9100 MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
.         CALL      WEBERR00
.         MOVE      ONE,EXIT
.         GOTO      DEIV9999
.
DEIV9800  MOVE      ZERO,EXIT
.
DEIV9999  RETURN
.
.------------------------------------------------------------
.         Check type of Journal
.------------------------------------------------------------
JTYP0000 PACK      KEY5,CODEJ,JOURITEM
         CALL      RDCODE1
         BRANCH    OVRCD,JTYP9999
.
         MOVE      THCSCOD,JTYPE
         MATCH     SP1,JTYPE
         GOTO      JTYP1000 IF NOT EQUAL
.
         MATCH     "R",TCINDC5
         GOTO      JTYP3000 IF EQUAL       * Self Insured Refund Journal
         MATCH     "F",TCINDC5
         GOTO      JTYP3000 IF EQUAL       * Deposit OFF Journal
         GOTO      JTYP2000
.
JTYP1000 MATCH     "A",JTYPE
         GOTO      JTYP3000 IF EQUAL
.
JTYP2000 SUB       JOURAMTT,FORM12P2
         GOTO      JTYP9999
.
JTYP3000 ADD       JOURAMTT,FORM12P2
         GOTO      JTYP9999
.
JTYP9999 RETURN
+
.------------------------------------------------------------
. Clear Private Practice Invoice Variables
.------------------------------------------------------------
CLPRIN00  MOVE      SP70,PRINNUMB
          MOVE      SP70,PRINDATE
          MOVE      SP70,PRINNAME
          MOVE      SP70,PRINDEBT
          MOVE      SP70,DPRINSCN
          MOVE      SP70,DPRINUNQ
          MOVE      SP70,PRINPRAC
          MOVE      SP70,PRINDOCT
          MOVE      SP70,PRINCLAM
          MOVE      ZERO,PRINITOT
          MOVE      ZERO,PRINPAMT
          MOVE      ZERO,PRINHAMT
          MOVE      ZERO,PRINIAMT
          MOVE      ZERO,PRINMAMT
          MOVE      ZERO,PRINVAMT
          MOVE      ZERO,PRINOTHA
          MOVE      ZERO,PRINJAMT
          MOVE      ZERO,PRINPEND
          MOVE      ZERO,PRINTRAN
          MOVE      SP70,PRINNAMR
          MOVE      SP70,PRINPRA1
          MOVE      SP70,PRINPRA2
          MOVE      SP70,PRINPRA3
          MOVE      SP70,PRINPOST
          MOVE      SP70,PRINTELP
          MOVE      SP70,PRINTELB
          MOVE      SP70,PRINRELP
          MOVE      ZERO,PRINCNUM
          MOVE      SP70,PRINADTE
          MOVE      ZERO,PRINGSTA
          MOVE      ZERO,PRINGSTJ
          MOVE      SP70,PRINCNST
          MOVE      ZERO,PRINCNTT
          MOVE      SP70,PRINCDAT
          MOVE      SP70,PRINCTIM
          MOVE      SP70,PRINCUID
          MOVE      SP70,PRINUDAT
          MOVE      SP70,PRINUTIM
          MOVE      SP70,PRINUUID
          MOVE      SP70,PRINSPAR
          MOVE      ZERO,PRINSCAN
          MOVE      ZERO,PRINUNIQ
.
CLPRIN99  RETURN
.------------------------------------------------------------
. Clear Private Practice Medical Practice Variables
.------------------------------------------------------------
CLPRIP00  MOVE      SP70,PRPRCODE
          MOVE      SP70,PRPRDESC
          MOVE      SP70,PRPRPDOC
          MOVE      SP70,PRPRADD1
          MOVE      SP70,PRPRADD2
          MOVE      SP70,PRPRADD3
          MOVE      SP70,PRPRPOST
          MOVE      SP70,PRPRTELP
          MOVE      ZERO,PRPRSTAT
          MOVE      ZERO,PRPRTIME
          MOVE      SP70,PRPRRANG
          MOVE      SP70,PRPRPMCI
          MOVE      SP70,PRPRPYEE
          MOVE      SP70,PRPRREGI
.
CLPRIP99  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse
.------------------------------------------------------------
ECLIND00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNUIMC
.         GOTO      ECLIND90 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",PTCNIMCW
            GOTO      ECLIND90 IF NOT EQUAL
          ENDIF
.
.         MATCH     SP70,PRHDHFND
.         GOTO      ECLIND90 IF EQUAL
.         GOTO      ECLIND90 IF EOS
.
.         PACK      KEY6,PRHDHFND,SP70
.         CALL      RDPTFX11
.         BRANCH    OVRCD,ECLIND90
.
.         IF        PTFXEXTR=THREE
.           MOVE      ONE,DIM1
.         ENDIF
.
          MATCH     SP70,PRHRTACC
          GOTO      ECLIND90 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00
.
          MATCH     "1",TCINDC1
          IF        @EQUAL
            GOTO      ECLIND80
          ENDIF
.
          MATCH     "2",TCINDC1
          IF        @EQUAL
            GOTO      ECLIND80
          ENDIF
.
          MATCH     "6",TCINDC1
          IF        @EQUAL
            GOTO      ECLIND80
          ENDIF
.
          MATCH     "7",TCINDC1
          IF        @EQUAL
            GOTO      ECLIND80
          ENDIF
          GOTO      ECLIND90
.
ECLIND80  MOVE      ONE,DIM1
.
ECLIND90  WRITE     HTMLFILE;DIM1;
ECLIND99  RETURN
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
+
.------------------------------------------------------------
.  IMC Referral Override          
.------------------------------------------------------------
IMCROV00  MOVE      ZERO,EXIT
          RESET     UPDTTYPE
.
          MATCH     SP70,UPDTTYPE
          GOTO      IMCROV40 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      IMCROV10 IF EQUAL    
.
          MATCH     "I",UPDTTYPE
          GOTO      IMCROV31 IF EQUAL 
.
          GOTO      IMCROV93
.
.         ************ UPDATE FORMACTION BEFORE INVOICE ***********
.
IMCROV10  PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,IMCROV90
.
.         MOVE      PRHRE037,PRHRROVR
.
.         CALL      UPPRHR1
.
          PACK      KEY62,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,PRHRREFD,PRHRRDAT:
                          SP1,TWO,SP9,SP3,SP1,SP1,ONE,SP70
          CALL      RDPRHT1
          BRANCH    OVRCD,IMCROV20
.
          MATCH     Z70,PRHTR031
          IF        !@EQUAL
            MOVE      PRHTR031,PRHTROVR
          ENDIF
.
          CALL      UPPRHT1
.
          GOTO      IMCROV30
.
IMCROV20  CALL      CLPRIHTR
.
          MOVE      PRHRUNIQ,PRHTUNIQ
          MOVE      PRHRPRAC,PRHTPRAC
          MOVE      PRHRDOCT,PRHTDOCT
          MOVE      PRHRPIND,PRHTPIND
          MOVE      PRHRREFD,PRHTREFD
          MOVE      TWO,PRHTFLAG
          MOVE      SP70,PRHTITMN
          MOVE      SP70,PRHTSUBN
          MOVE      ONE,PRHTNUMB
          MOVE      PRHRRDAT,PRHTRDAT
.
          MATCH     Z70,PRHTR031
          IF        !@EQUAL
            MOVE      PRHTR031,PRHTROVR
          ENDIF
.
          CALL      WRPRHT1 
.
IMCROV30  MOVE      ZERO,EXIT
          GOTO      IMCROV99
.
.         ************ UPDATE FORMACTION AFTER INVOICE ***********
.
IMCROV31  PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,IMCROV90
.
          PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,IMCROV90
.
          COMPARE   ZERO,INVOICEN
          IF        !@EQUAL
            MOVE      INVOICEN,FORM8
            PACK      KEY22,FORM8,SP70
            CALL      RSPRDT4
IMCROV33    CALL      RKPRDT4                      * read next record
            BRANCH    OVRCD,IMCROV36
.
            MOVE      INVOICEN,FORM8
            MOVE      FORM8,DIM8
            MATCH     DIM8,PRDTINVN                * same invoice still ?
            GOTO      IMCROV36 IF NOT EQUAL        * no - finished
.
            COMPARE   ONE,PRDTRTYP
            GOTO      IMCROV33 IF NOT EQUAL
.
            COMPARE   TWO,PRDTIFLG
            GOTO      IMCROV33 IF NOT EQUAL
.
            MATCH     Z70,PRDTR031
            IF        !@EQUAL
              MOVE      PRDTR031,PRDTROVR
            ENDIF
.
            CALL      UPPRDT4
.
            GOTO      IMCROV39
.
IMCROV36    CALL      CLPRIDTR
.
            MOVE      PRHRUNIQ,PRDTUNIQ
            MOVE      INVOICEN,FORM8
            MOVE      FORM8,PRDTINVN
            MOVE      ONE,PRDTTRAN
            MOVE      URNUMBER,PRDTDEBT
            MOVE      ONE,PRDTSCAN
            MOVE      PRHRPRAC,PRDTPRAC
            MOVE      PRHRDOCT,PRDTDOCT
            MOVE      PRHRREFD,PRDTREFD
            MOVE      PRHDCLAM,PRDTCLAM
            MOVE      PRHRPIND,PRDTCODE
            MOVE      ONE,PRDTRTYP
            MOVE      TWO,PRDTIFLG
            MOVE      "DB ",PRDTTTYP
            MOVE      ONE,PRDTINVP
            CALL      IBACLOCK
            PACK      PRDTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PRDTCDAT
            MOVE      CTIMEIS,PRDTCTIM
            MOVE      PRHRRDAT,PRDTRDTE
            CALL      IBACLOCK
            PACK      PRDTEFFD,CCC,CYY,CMM,CDD
            REP       " 0",PRDTEFFD
            MOVE      PRHRRPER,PRDTRPER
.
            MATCH     Z70,PRDTR031
            IF        !@EQUAL
              MOVE      PRDTR031,PRDTROVR
            ENDIF
.
IMCROV37    PACK      KEY22,PRDTUNIQ,PRDTINVN,PRDTTRAN,SP70 
            CALL      RAPRDT1
            BRANCH    OVRCD,IMCROV38
.
            ADD       ONE,PRDTTRAN
            GOTO      IMCROV37 
.
IMCROV38    CALL      WRPRDT1
.
          ENDIF
.
IMCROV39  MOVE      ZERO,EXIT
          GOTO      IMCROV99
.
.         ************ DISPLAY FORMACTION **********
.
IMCROV40  PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,IMCROV90
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,IMCROV90
.
          PACK      KEY62,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,PRHRREFD,PRHRRDAT:
                          SP1,TWO,SP9,SP3,SP1,SP1,ONE,SP70
          CALL      RDPRHT1
          IF        OVRCD=ONE
            CALL      CLPRIHTR
          ENDIF
.
          COMPARE   ZERO,INVOICEN
          IF        !@EQUAL
            MOVE      INVOICEN,FORM8
            PACK      KEY22,FORM8,SP70
            CALL      RSPRDT4
IMCROV45    CALL      RKPRDT4                      * read next record
            BRANCH    OVRCD,IMCROV50 
.
            MOVE      INVOICEN,FORM8
            MOVE      FORM8,DIM8
            MATCH     DIM8,PRDTINVN                * same invoice still ?
            GOTO      IMCROV50 IF NOT EQUAL        * no - finished
.
            COMPARE   ONE,PRDTRTYP             
            GOTO      IMCROV45 IF NOT EQUAL    
.
            COMPARE   TWO,PRDTIFLG
            GOTO      IMCROV45 IF NOT EQUAL
.
            GOTO      IMCROV60 
.
IMCROV50    CALL      CLPRIDTR
          ENDIF
.
IMCROV60  MOVE      PRHDDEBT,URNUMBER
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,IMCROV94
.
          MOVE      "IMC Referral Override",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,IMCROV99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      IMCROV99
.
IMCROV90  MOVE      "Doctor Referral details has Not been selected.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IMCROV99
.
IMCROV93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IMCROV99
.
IMCROV94  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      IMCROV99
.
IMCROV99  RETURN
+
.------------------------------------------------------------
.  IMC Linked Visit Number prihtr
.------------------------------------------------------------
LNKVIS00  MATCH     Z70,PRHTR030
          GOTO      LNKVIS99 IF EQUAL
.
          PACK      KEY8,UNIQNUMB
          CALL      RDPRHD2
          BRANCH    OVRCD,LNKVIS99
.
          PACK      KEY27,PRHDUNIQ,PRHRE001,PRHRE002,PRHRE003
          CALL      RDPRHR1
          BRANCH    OVRCD,LNKVIS99
.
          PACK      KEY62,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,PRHRREFD,PRHRRDAT:
                          SP1,TWO,SP9,SP3,SP1,SP1,ONE,SP70
          CALL      RDPRHT1
          BRANCH    OVRCD,LNKVIS20
.
          MOVE      PRHTR030,PRHTLVIS
.
          CALL      UPPRHT1
.
          GOTO      LNKVIS99
.
LNKVIS20  CALL      CLPRIHTR
.
          MOVE      PRHRUNIQ,PRHTUNIQ
          MOVE      PRHRPRAC,PRHTPRAC
          MOVE      PRHRDOCT,PRHTDOCT
          MOVE      PRHRPIND,PRHTPIND
          MOVE      PRHRREFD,PRHTREFD
          MOVE      TWO,PRHTFLAG
          MOVE      SP70,PRHTITMN
          MOVE      SP70,PRHTSUBN
          MOVE      ONE,PRHTNUMB
          MOVE      PRHRRDAT,PRHTRDAT
.
          MOVE      PRHTR030,PRHTLVIS
.
          CALL      WRPRHT1
.
LNKVIS99  RETURN
.------------------------------------------------------------
.  IMC Linked Visit Number pridtr
.------------------------------------------------------------
LNKVID00  PACK      KEY8,UNIQNUMB,SP70
          CALL      RDPRHD2
          BRANCH    OVRCD,LNKVID99
.
          PACK      KEY27,UNIQNUMB,PRHRE001,PRHRE002,PRHRE003,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,LNKVID99
.
          MATCH     SP70,PRHRTACC
          GOTO      LNKVID99 IF EQUAL
.
          MOVE      "ta",CATEGORY         * claim code
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00          
.
          MATCH     "1",TCINDC1
          GOTO      LNKVID05 IF EQUAL
.
          MATCH     "2",TCINDC1
          GOTO      LNKVID05 IF EQUAL
.
          MATCH     "6",TCINDC1
          GOTO      LNKVID05 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      LNKVID05 IF EQUAL
.
          GOTO      LNKVID99
.
LNKVID05  MOVE      INVOICEN,FORM8
          PACK      KEY22,FORM8,SP70
          CALL      RSPRDT4
LNKVID10  CALL      RKPRDT4                      * read next record
          BRANCH    OVRCD,LNKVID20
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          MATCH     DIM8,PRDTINVN                * same invoice still ?
          GOTO      LNKVID20 IF NOT EQUAL        * no - finished
.
          COMPARE   ONE,PRDTRTYP
          GOTO      LNKVID10 IF NOT EQUAL
.
          COMPARE   TWO,PRDTIFLG
          GOTO      LNKVID10 IF NOT EQUAL
.
          MOVE      PRDTR030,PRDTLVIS
.
          CALL      UPPRDT4
.
          GOTO      LNKVID99
.
LNKVID20  CALL      CLPRIDTR
.
          MOVE      PRHRUNIQ,PRDTUNIQ
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,PRDTINVN
          MOVE      ONE,PRDTTRAN
          MOVE      URNUMBER,PRDTDEBT
          MOVE      ONE,PRDTSCAN
          MOVE      PRHRPRAC,PRDTPRAC
          MOVE      PRHRDOCT,PRDTDOCT
          MOVE      PRHRREFD,PRDTREFD
          MOVE      PRHDCLAM,PRDTCLAM
          MOVE      PRHRPIND,PRDTCODE
          MOVE      ONE,PRDTRTYP
          MOVE      TWO,PRDTIFLG
          MOVE      "DB ",PRDTTTYP
          MOVE      ONE,PRDTINVP
          CALL      IBACLOCK
          PACK      PRDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRDTCDAT
          MOVE      CTIMEIS,PRDTCTIM
          MOVE      PRHRRDAT,PRDTRDTE
          CALL      IBACLOCK
          PACK      PRDTEFFD,CCC,CYY,CMM,CDD
          REP       " 0",PRDTEFFD
          MOVE      PRHRRPER,PRDTRPER
.
          MOVE      PRDTR030,PRDTLVIS
.
LNKVID30  PACK      KEY22,PRDTUNIQ,PRDTINVN,PRDTTRAN,SP70
          CALL      RAPRDT1
          BRANCH    OVRCD,LNKVID40
.
          ADD       ONE,PRDTTRAN
          GOTO      LNKVID30
.
LNKVID40  CALL      WRPRDT1
.
LNKVID99  RETURN
.------------------------------------------------------------------------------
.         Get  Linked Visit Number from prihtraf
.------------------------------------------------------------------------------
GLVIS000  PACK      KEY62,PRHRUNIQ,PRHRPRAC,PRHRDOCT,PRHRPIND,SP70
          CALL      RSPRHT1          
GLVIS100  CALL      RKPRHT1
          BRANCH    OVRCD,GLVIS999
.
          COMPARE   PRHRUNIQ,PRHTUNIQ
          GOTO      GLVIS999 IF NOT EQUAL
.
          MATCH     PRHRPRAC,PRHTPRAC
          GOTO      GLVIS999 IF NOT EQUAL
.
          MATCH     PRHRDOCT,PRHTDOCT
          GOTO      GLVIS999 IF NOT EQUAL
.
          MATCH     PRHRPIND,PRHTPIND
          GOTO      GLVIS999 IF NOT EQUAL
.
          COMPARE   TWO,PRHTFLAG
          GOTO      GLVIS100 IF NOT EQUAL
.
          WRITE     HTMLFILE;PRHTLVIS;
.
GLVIS999  RETURN
.
.------------------------------------------------------------------------------
. Write Eclipe other claimant details record  
.------------------------------------------------------------------------------
ECLMT000  MATCH     Z70,PMCLT001            * webPAS Module
          GOTO      ECLMT999 IF EQUAL      
.
          MATCH     Z70,PMCLT003            * Claimant Family Name
          GOTO      ECLMT999 IF EQUAL      
.
          MOVE      PRCNINVN,PMCLT002       * Populate invoice number
          CALL      CLPMSCLT                * Clear variables
          CALL      MVPMCL00                * Populate variables 
.
          PACK      KEY9,PMCLWMOD,PMCLINUM,SP70
          CALL      RAPMCLT1
          IF        OVRCD=1
            CALL     WRPMCLT1
          ENDIF
.
ECLMT999  RETURN
.
.------------------------------------------------------------------------
.         Update Account Paid in Full and Eclipse Claim Store anf Forward
.------------------------------------------------------------------------
ESTRF000  MATCH     "1",PTCNUESF
          GOTO      ESTRF999 IF NOT EQUAL   * Not using Store and Forward
.
          MATCH     SP70,PRHRE028
          IF        !@EQUAL & !@EOS
            MOVE      "ta",CATEGORY
            MOVE      PRHRE028,CODE
            CALL      GETCOD00
.
            MATCH     "5",TCINDC1
            IF        @EQUAL
              GOTO      ESTRF200
            ENDIF
.
            GOTO      ESTRF999
          ELSE
            GOTO      ESTRF999
          ENDIF
.
ESTRF200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      ESTRF9999 IF EQUAL     * No item to claim
.
.         Write a record to Claim store and forward file
.
          CALL      CLEMRECT
          MOVE      SP70,EMECHOSP          * No Hospital for PP?
          MOVE      ZERO,EMECFLAG
          MOVE      "2",EMECMODL           * Priv Prac
          MOVE      PRINNUMB,EMECINVN
          MOVE      PRINDEBT,EMECURNO
          MOVE      DPRINUNQ,EMECUNIQ
          MOVE      FORM12P2,EMECAMTC      * Amoutn claimed
          PACK      KEY30,EMECHOSP,EMECFLAG,EMECMODL,EMECUNIQ:
                          EMECINVN,EMECBATN,SP70
          CALL      WREMECT1
.
          MATCH     "1",RACLUESF
          GOTO      ESTRF999 IF NOT EQUAL
.
          MATCH     SP70,PTCNESFO                * eclipse outbound path set?
          GOTO      ESTRF999 IF EQUAL
.
          CALL      SESFX000
.
ESTRF999  RETURN
+
.------------------------------------------------------------------------
.         Check if all procedures have a rebate reason
.------------------------------------------------------------------------
CPRC0000  MOVE      ZERO,FORM12P2
          PACK      KEY22,DPRINUNQ,PRINNUMB,SP70
          CALL      RSPRDT1 
CPRC1000  CALL      RKPRDT1
          BRANCH    OVRCD,CPRC9999
.
          MATCH     DPRINUNQ,DPRDTUNQ
          GOTO      CPRC9999 IF NOT EQUAL
          MATCH     PRINNUMB,PRDTINVN
          GOTO      CPRC9999 IF NOT EQUAL
.
          COMPARE   ONE,PRDTRTYP
          GOTO      CPRC1000 IF NOT EQUAL 
.
          COMPARE   ZERO,PRDTIFLG
          GOTO      CPRC1000 IF NOT EQUAL 
.
.         MATCH     SP70,ATDTRBRS
.         GOTO      CPRC8000 IF EQUAL         * No rebate reason
.
          COMPARE   ZERO,PRDTAMNT
          GOTO      CPRC1000 IF EQUAL
.
          COMPARE   ZERO,PRDTSERV
          GOTO      CPRC1000 IF EQUAL
.
          ADD       PRDTAMNT,FORM12P2
          ADD       PRDTGSTM,FORM12P2
.
          GOTO      CPRC1000
.
CPRC8000  MOVE      ZERO,FORM12P2          * found procedure with No reb.reason
.
CPRC9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SESFX000                                   *
.*               Schedule Eclipse Extract (IBAEMR04)                      *
.--------------------------------------------------------------------------
SESFX000  MOVE      "IBAEMR04",SCHDPGID
          MOVE      "Eclipse PCS Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAEMR04",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      EMECHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SESFX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SESFX600
.
SESFX500  MOVE      TWO,F3
.
SESFX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    EMECHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    EMECUNIQ,ECCLMARR
          APPEND    EMECINVN,ECCLMARR
          APPEND    EMECURNO,ECCLMARR
          APPEND    PRINDATE,ECCLMARR
.
          ASSIGN    (PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT+PRINOTHA+PRINJAMT+PRINCNTT),EMECAMTC
          IF        IBCNUGST=2
            ADD       PRINGSTJ,EMECAMTC
          ENDIF
.
          APPEND    EMECAMTC,ECCLMARR
          APPEND    TWO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SESFX999  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse PCS
.------------------------------------------------------------
ECLESF00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNUESF
.         GOTO      ECLESF90 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",PTCNPCIW
            GOTO      ECLESF90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRHRTACC
          GOTO      ECLESF90 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00
.
          MATCH     "5",TCINDC1
          IF        @EQUAL
            GOTO      ECLESF80
          ENDIF
.
          GOTO      ECLESF90
.
ECLESF80  MOVE      ONE,DIM1
.
ECLESF90  WRITE     HTMLFILE;DIM1;
ECLESF99  RETURN
+
.------------------------------------------------------------
.         Check Patient's age at time of attendance
.------------------------------------------------------------
AGEA0000  MOVE      ZERO,F1
          MATCH     "1",PTCNUESF
.         GOTO      AGEA9999 IF NOT EQUAL   * Not using Store and Forward
          IF        !@EQUAL
            MATCH     "1",PTCNPCIW
            GOTO      AGEA9999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRHRRDAT
          IF        !@EQUAL
            MOVE      PRHRRDAT,AGEDATE
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD
          ENDIF
.
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          COMPARE   PSAGEYRS,CAGECOFF         * Child?
          GOTO      AGEA9999 IF LESS          * No
.
          MOVE      ONE,F1                    * default Other Claimant to tick
.
AGEA9999  RETURN
+UPTOHERE
.------------------------------------------------------------------------
.         Update Account Paid in Full and Eclipse Claim Bulk Billing
.------------------------------------------------------------------------
EDBS0000  MATCH     "1",PTCNUEBB
          GOTO      EDBS9999 IF NOT EQUAL   * Not using Store and Forward
.
          MATCH     SP70,PRHRE028
          IF        !@EQUAL & !@EOS
            MOVE      "ta",CATEGORY
            MOVE      PRHRE028,CODE
            CALL      GETCOD00
.
            MATCH     "3",TCINDC1
            IF        @EQUAL
              GOTO      EDBS0200
            ENDIF
.
            GOTO      EDBS9999
          ELSE
            GOTO      EDBS9999
          ENDIF
.
EDBS0200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      EDBS9999 IF EQUAL     * No item to claim
.
.         Write a record to Claim store and forward file
.
          CALL      CLOUTECT
          MOVE      SP70,OTECHOSP          * No Hospital for PP?
          MOVE      ZERO,OTECFLAG
          MOVE      "2",OTECMODL           * Priv Prac
          MOVE      PRINNUMB,OTECINVN
          MOVE      PRINDEBT,OTECURNO
          MOVE      DPRINUNQ,OTECUNIQ
          MOVE      FORM12P2,OTECAMTC      * Amoutn claimed
          PACK      KEY30,OTECHOSP,OTECFLAG,OTECMODL,OTECUNIQ:
                          OTECINVN,OTECBATN,SP70
          CALL      WROTECT1
.
          MATCH     "1",RACLUEBB
          GOTO      EDBS9999 IF NOT EQUAL
.
          MATCH     SP70,PTCNEDBO                * eclipse outbound path set?
          GOTO      EDBS9999 IF EQUAL
.
          CALL      SEDBX000
.
EDBS9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SEDBX000                                   *
.*               Schedule Eclipse Extract (IBAOUT04)                      *
.--------------------------------------------------------------------------
SEDBX000  MOVE      "IBAOUT04",SCHDPGID
          MOVE      "Eclipse DBS Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAOUT04",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      OTECHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SEDBX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SEDBX600
.
SEDBX500  MOVE      TWO,F3
.
SEDBX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    OTECHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    OTECUNIQ,ECCLMARR
          APPEND    OTECINVN,ECCLMARR
          APPEND    OTECURNO,ECCLMARR
          APPEND    PRINDATE,ECCLMARR
.
          ASSIGN    (PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT+PRINOTHA+PRINJAMT+PRINCNTT),OTECAMTC
          IF        IBCNUGST=2
            ADD       PRINGSTJ,OTECAMTC
          ENDIF
.
          APPEND    OTECAMTC,ECCLMARR
          APPEND    TWO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SEDBX999  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse DBS / WebServices BBSW
.------------------------------------------------------------
ECLEBB00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNUEBB
.         GOTO      ECLEBB90 IF NOT EQUAL
          IF        !@EQUAL
            MATCH     "1",PTCNBBSW
            GOTO      ECLEBB90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRHRTACC
          GOTO      ECLEBB90 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00
.
          MATCH     "3",TCINDC1
          IF        @EQUAL
            GOTO      ECLEBB80
          ENDIF
.
          GOTO      ECLEBB90
.
ECLEBB80  MOVE      ONE,DIM1
.
ECLEBB90  WRITE     HTMLFILE;DIM1;
ECLEBB99  RETURN
+
.------------------------------------------------------------
. New Correspondenance Item
.------------------------------------------------------------
NEWCOR00  PACK      CORSP001,SPLFILE,CORSPPRT,SP70
          PACK      CORSP002,CCC,CYY,CMM,CDD,SP70
          REP       " 0",CORSP002
          CLOCK     TIME,CTIMEIS
          PACK      CORSP004,CTIMEIS
.
          PACK      KEY8,ADMISSNO           * validate admissno
          MOVE      ADMISSNO,SAVVISIT
          MATCH     SP70,ADMISSNO
          IF        @EQUAL|@EOS
            MOVE      "00000000",SAVVISIT
          ENDIF
.
NEWCOR20  PACK      KEY8,URNUMBER         * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
.
          MOVE      ONE,CORRESID
          PACK      KEY20,URNUMBER,SAVVISIT,Z70
          CALL      RSOBPC1
          CALL      RPOBPC1              * Positions on last value
          BRANCH    OVRCD,NEWCOR50
          MATCH     URNUMBER,OBPCURNO
          GOTO      NEWCOR50 IF NOT EQUAL
          MATCH     SAVVISIT,OBPCCVIS
          GOTO      NEWCOR50 IF NOT EQUAL
          MOVE      OBPCCPID,CORRESID
          ADD       ONE,CORRESID
.
NEWCOR50  MOVE      CORRESID,OBPCCPID       * Correspondance ID
          MOVE      SAVVISIT,OBPCCVIS
          MOVE      URNUMBER,OBPCURNO
.
          CALL      IBACLOCK
          PACK      OBPCDTLU,CCC,CYY,CMM,CDD * Last update date
          REP       " 0",OBPCDTLU
          MOVE      CTIMEIS,OBPCTMLU        * Last Update time
.
          MOVE      WBSEUID,OBPCINUS        * Web User ID
          MOVE      WBSEUID,OBPCLUID        * Last Web User ID
          MOVE      ZERO,OBPCMDEL           * Delete indicator not set
.
          MATCH     SP70,CORSP001
          IF        @EQUAL
            CLEAR     CORSP001
            APPEND    TEMPNAME,CORSP001
            APPEND    ".html",CORSP001
            RESET     CORSP001
          ENDIF
.
          SCAN      ".",CORSP001
          MOVE      CORSP001,OBPCFEXT
          RESET     CORSP001
.
          MATCH     "00000000",OBPCCVIS
          IF        @EQUAL
            MOVE      "UR",KEY2
            PACK      CORSFILE,KEY2,OBPCURNO,DASH,OBPCCPID,OBPCFEXT
          ELSE
            PACK      CORSFILE,OBPCCVIS,DASH,OBPCCPID,OBPCFEXT
          ENDIF
          STRIP     CORSFILE
          REP       " 0",CORSFILE
.
          READ      CONTROLF,NINTY1;*219,CWEBCLOC
          PACK      KEY4,CWEBCLOC
          CALL      RDOBPT1
          BRANCH    OVRCD,NEWCOR91
.
          MOVE      OBPTSLID,OBPCSLID       * Storage Location ID
          STRIP     OBPTSDIR
          GETENV    TBSPOOL,KEY80
          STRIP     KEY80
          STRIP     CORSP001
          PACK      CMDLINE,CMDFCHK,USERID,SP1,KEY80,SLASH,CORSP001,SP1,CORSFILE
          EXECUTE   CMDLINE,TASKID
          PACK      CMDLINE,CMDMOVE,KEY80,SLASH,CORSP001,SP1,OBPTSDIR,CORSFILE
          EXECUTE   CMDLINE,TASKID
.
          MOVE      CORSP002,OBPCINDT       * Input date
          REP       " 0",OBPCINDT
          MOVE      CORSP004,OBPCINTM       * Input time
          CALL      GETCTY00               * get type of correspondence
          MOVE      SP70,OBPCSLEV       * Security Level
          MOVE      SP70,OBPCCOM1       * Comment 1
          MOVE      SP70,OBPCCOM2       * Comment 2
          MOVE      SP70,OBPCCFRM       * From
          MOVE      SP70,OBPCCTOO       * To
          MOVE      SP70,OBPCUDF1       * User Def Code 1
          MOVE      SP70,OBPCUDF2       * User Def Code 2
          MOVE      SP70,OBPCUYN1       * User Def Y/N 1
          MOVE      SP70,OBPCUYN2       * User Def Y/N 2
          MOVE      SP70,OBPCUDD1       * User Def Date 1
          MOVE      SP70,OBPCUDD2       * User Def Date 2
          MOVE      SP70,OBPCACAT  *   Alert Category
          MOVE      SP70,OBPCACOD  *   Alert Code
          MOVE      SP70,OBPCCNTR  *   Alert Counter
.
          MOVE      SAVVISIT,OBPCCVIS
NEWCOR80  PACK      KEY12,OBPCCVIS,OBPCCPID
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WROBPC1
          TRAPCLR   IO
          IF        OVRCD=1
            ADD       ONE,CORRESID
            MOVE      CORRESID,OBPCCPID     * Correspondance ID
            GOTO      NEWCOR80
          ENDIF
.
          PACK      KEY8,URNUMBER           * validate UR
          CALL      RDMAST1
          BRANCH    OVRCD,NEWCOR90
          MATCH     "1",PTMXSIN4
          IF        !@EQUAL
            PACK      KEY8,URNUMBER         * validate UR
            CALL      RLPTMAS1
            BRANCH    OVRCD,NEWCOR90,NEWCOR96
            MOVE      "1",PTMXSIN4
            CALL      UPMAST1
            CALL      UUPTMAS1
          ENDIF
          GOTO      NEWCOR99
.
NEWCOR90  CLEAR     WEBTITLE
          APPEND    "Invalid U/r Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR91  CLEAR     WEBTITLE
          APPEND    "Invalid Storage Location ID From Control File - ",WEBTITLE
          APPEND    KEY4,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR93  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR94  MOVE      "Invalid File - ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR95  CLEAR     WEBTITLE
          APPEND    "Invalid Visit No for UR - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR96  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWCOR99
.
NEWCOR99  RETURN
+
.------------------------------------------------------------
. Get correspondence type - Category wi indicator 1=R Reprinted Invoice
.------------------------------------------------------------
GETCTY00  MOVE      "wi",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
GETCTY10  CALL      RDKCODE1
          BRANCH    OVRCD,GETCTY90
.
          MATCH     CATEGORY,TCODE
          GOTO      GETCTY90 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      GETCTY10 IF EQUAL
.
          MATCH     ANSR,TCINDC1
          GOTO      GETCTY10 IF NOT EQUAL
          PACK      OBPCCTYP,ACODE
          GOTO      GETCTY99
.
GETCTY90  MOVE      SP70,OBPCCTYP
.
GETCTY99  RETURN
+
.------------------------------------------------------------------------
.         Update Account Paid in Full and WebServices PCIW
.------------------------------------------------------------------------
PCIW0000  MATCH     "1",PTCNWSIN
          GOTO      PCIW9999 IF NOT EQUAL   * Not using WebServices
.
          MATCH     "1",PTCNPCIW
          GOTO      PCIW9999 IF NOT EQUAL   * Not using PCIW
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBPCIA1,"webpciaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PCIW9999
.
          MATCH     SP70,PRHRE028
          IF        !@EQUAL & !@EOS
            MOVE      "ta",CATEGORY
            MOVE      PRHRE028,CODE
            CALL      GETCOD00
.
            MATCH     "5",TCINDC1
            IF        @EQUAL
              GOTO      PCIW0200
            ENDIF
.
            GOTO      PCIW9999
          ELSE
            GOTO      PCIW9999
          ENDIF
.
PCIW0200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      PCIW9999 IF EQUAL     * No item to claim
.
.         Write a record to PCIW file
.
          CALL      CLWEBPCI
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,WBPIHOSP
          ELSE
            MOVE      SP70,WBPIHOSP          * No Hospital for PP?
          ENDIF
          MOVE      ZERO,WBPIFLAG
          MOVE      "2",WBPIMODL           * Priv Prac
          MOVE      PRINNUMB,WBPIINVN
          MOVE      PRINDEBT,WBPIURNO
          MOVE      DPRINUNQ,WBPIUNIQ
          MOVE      FORM12P2,WBPIAMTC      * Amoutn claimed
          PACK      KEY30,WBPIHOSP,WBPIFLAG,WBPIMODL,WBPIUNIQ:
                          WBPIINVN,WBPIBATN,SP70

          CALL      IBACLOCK
          PACK      WBPICDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBPICDAT
          MOVE      CTIMEIS,WBPICTIM
          MOVE      USERID,WBPICUID
          CALL      WRWBPCI1
.
          MATCH     "1",RACLUESF
          GOTO      PCIW9999 IF NOT EQUAL
.
.         MATCH     SP70,PTCNESFO                * eclipse outbound path set?
.         GOTO      PCIW9999 IF EQUAL
.
          CALL      SPCIX000
.
PCIW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SPCIX000                                   *
.*               Schedule WebServices Extract (IBAWEB05)                  *
.--------------------------------------------------------------------------
SPCIX000  MOVE      "IBAWEB05",SCHDPGID
          MOVE      "WebServices PCIW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB05",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBPIHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SPCIX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SPCIX600
.
SPCIX500  MOVE      TWO,F3
.
SPCIX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBPIHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBPIUNIQ,ECCLMARR
          APPEND    WBPIINVN,ECCLMARR
          APPEND    WBPIURNO,ECCLMARR
          APPEND    PRINDATE,ECCLMARR
.
          ASSIGN    (PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT+PRINOTHA+PRINJAMT+PRINCNTT),WBPIAMTC
          IF        IBCNUGST=2
            ADD       PRINGSTJ,WBPIAMTC
          ENDIF
.
          APPEND    WBPIAMTC,ECCLMARR
          APPEND    TWO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SPCIX999  RETURN
+
.------------------------------------------------------------------------------
.         Generating a Lodgement of Advice PCIW
.------------------------------------------------------------------------------
LADW0000  MATCH     "1",PTCNWSIN
          GOTO      LADW9999 IF NOT EQUAL     * Not using WebServices
.
          MATCH     "1",PTCNPCIW
          GOTO      LADW9999 IF NOT EQUAL     * Not using PCIW
.
          MATCH     SP70,PRHRTACC
          GOTO      LADW9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LADW9999            * Invalid code
.
          MATCH     "5",TCINDC1
          GOTO      LADW9999 IF NOT EQUAL
.
          MOVE      "IBAWEB26",SCHDPGID
          MOVE      "Generating a PCIW Lodgement of Advice",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "2",KEYSTARR[1]          * 2 for Private Practice
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
LADW9999  RETURN
+
.------------------------------------------------------------------------
.         Update Account Paid in Full and WebServices Bulk Billing
.------------------------------------------------------------------------
BBSW0000  MATCH     "1",PTCNWSIN
          GOTO      BBSW9999 IF NOT EQUAL 
.
          MATCH     "1",PTCNBBSW
          GOTO      BBSW9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBBBSA1,"webbbsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,BBSW9999
.
          MATCH     SP70,PRHRE028
          IF        !@EQUAL & !@EOS
            MOVE      "ta",CATEGORY
            MOVE      PRHRE028,CODE
            CALL      GETCOD00
.
            MATCH     "3",TCINDC1
            IF        @EQUAL
              GOTO      BBSW0200
            ENDIF
.
            GOTO      BBSW9999
          ELSE
            GOTO      BBSW9999
          ENDIF
.
BBSW0200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      BBSW9999 IF EQUAL     * No item to claim
.
.         Write a record to Claim store and forward file
.
          CALL      CLWEBBBS
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,WBBSHOSP
          ELSE
            MOVE      SP70,WBBSHOSP          * No Hospital for PP?
          ENDIF
          MOVE      ZERO,WBBSFLAG
          MOVE      "2",WBBSMODL           * Priv Prac
          MOVE      PRINNUMB,WBBSINVN
          MOVE      PRINDEBT,WBBSURNO
          MOVE      DPRINUNQ,WBBSUNIQ
          MOVE      FORM12P2,WBBSAMTC      * Amoutn claimed
          PACK      KEY30,WBBSHOSP,WBBSFLAG,WBBSMODL,WBBSUNIQ:
                          WBBSINVN,WBBSBATN,SP70
          CALL      IBACLOCK
          PACK      WBBSCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBBSCDAT
          MOVE      CTIMEIS,WBBSCTIM
          MOVE      USERID,WBBSCUID
          CALL      WRWBBBS1
.
          MATCH     "1",RACLUEBB
          GOTO      BBSW9999 IF NOT EQUAL
.
.         MATCH     SP70,PTCNEDBO                * eclipse outbound path set?
.         GOTO      BBSW9999 IF EQUAL
.
          CALL      SBBSX000
.
BBSW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SBBSX000                                   *
.*               Schedule WebServices Extract (IBAWEB06)                  *
.--------------------------------------------------------------------------
SBBSX000  MOVE      "IBAWEB06",SCHDPGID
          MOVE      "WebServices BBSW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB06",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBBSHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SBBSX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SBBSX600
.
SBBSX500  MOVE      TWO,F3
.
SBBSX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBBSHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBBSUNIQ,ECCLMARR
          APPEND    WBBSINVN,ECCLMARR
          APPEND    WBBSURNO,ECCLMARR
          APPEND    PRINDATE,ECCLMARR
.
          ASSIGN    (PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT+PRINOTHA+PRINJAMT+PRINCNTT),WBBSAMTC
          IF        IBCNUGST=2
            ADD       PRINGSTJ,WBBSAMTC
          ENDIF
.
          APPEND    WBBSAMTC,ECCLMARR
          APPEND    TWO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SBBSX999  RETURN
+
.------------------------------------------------------------------------------
.         Generating DB4 Form
.------------------------------------------------------------------------------
DB4W0000  MATCH     "1",PTCNWSIN
          GOTO      DB4W9999 IF NOT EQUAL   
.
          MATCH     "1",PTCNBBSW
          GOTO      DB4W9999 IF NOT EQUAL
.
          MATCH     SP70,PRHRTACC
          GOTO      DB4W9999 IF EQUAL         * Blank type of account/claim
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DB4W9999            * Invalid code
.
          MATCH     "3",TCINDC1
          GOTO      DB4W9999 IF NOT EQUAL     * not Bulk billing
.
          MOVE      "IBAWEB16",SCHDPGID
          MOVE      "Generating WebServices DB4 Form",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters
.
          MOVE      "2",KEYSTARR[1]          * 2 for Private practice
          MOVE      INVOICEN,KEYSTARR[2]     * Invoice number
          MOVE      SP70,KEYSTARR[3]
          MOVE      SP70,KEYSTARR[4]
.
          MOVE      FOUR,KEYSTCNT         * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
DB4W9999  RETURN
+
.------------------------------------------------------------------------
.         Update Account Paid in Full and WebServices DVAW 
.------------------------------------------------------------------------
DVAW0000  MATCH     "1",PTCNWSIN
          GOTO      DVAW9999 IF NOT EQUAL
.
          MATCH     "1",PTCNDVAW
          GOTO      DVAW9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBDVWA1,"webdvwaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DVAW9999
.
          MATCH     SP70,PRHRE028
          IF        !@EQUAL & !@EOS
            MOVE      "ta",CATEGORY
            MOVE      PRHRE028,CODE
            CALL      GETCOD00
.
            MATCH     "8",TCINDC1
            IF        @EQUAL
              GOTO      DVAW0200
            ENDIF
.
            GOTO      DVAW9999
          ELSE
            GOTO      DVAW9999
          ENDIF
.
DVAW0200  CALL      CPRC0000        * Check if all Proc.have a 'Rebate Reason'
          COMPARE   ZERO,FORM12P2
          GOTO      DVAW9999 IF EQUAL     * No item to claim
.
.         Write a record to Claim store and forward file
.
          CALL      CLWEBDVW
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,WBDWHOSP
          ELSE
            MOVE      SP70,WBDWHOSP          * No Hospital for PP?
          ENDIF
          MOVE      ZERO,WBDWFLAG
          MOVE      "2",WBDWMODL           * Priv Prac
          MOVE      PRINNUMB,WBDWINVN
          MOVE      PRINDEBT,WBDWURNO
          MOVE      DPRINUNQ,WBDWUNIQ
          MOVE      FORM12P2,WBDWAMTC      * Amoutn claimed
          PACK      KEY30,WBDWHOSP,WBDWFLAG,WBDWMODL,WBDWUNIQ:
                          WBDWINVN,WBDWBATN,SP70
          CALL      IBACLOCK
          PACK      WBDWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBDWCDAT
          MOVE      CTIMEIS,WBDWCTIM
          MOVE      USERID,WBDWCUID
          CALL      WRWBDVW1
.
          MATCH     "1",RACLUDVA
          GOTO      DVAW9999 IF NOT EQUAL
.
          CALL      SDVWX000
.
DVAW9999  RETURN
+
.--------------------------------------------------------------------------
.*                             SDVWX000                                   *
.*               Schedule WebServices Extract (IBAWEB08)                  *
.--------------------------------------------------------------------------
SDVWX000  MOVE      "IBAWEB08",SCHDPGID
          MOVE      "WebServices DVAW Claims Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB08",SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,COUNT
          IF        IBCNMHOS = 1
            MOVE      WBDWHOSP,KEYSTARR[COUNT]
          ELSE
            MOVE      SP3,KEYSTARR[COUNT]
          ENDIF
.
          ADD       ONE,COUNT
          MOVE      ONE,KEYSTARR[COUNT]    * extract pcs (1)
.
.         ADD       ONE,COUNT
.         MOVE      ONE,OPTNFLAG
.
.         MATCH     "2",PRECEETP
.         IF        @EQUAL
.           MOVE       TWO,OPTNFLAG
.         ENDIF
.         MOVE      OPTNFLAG,KEYSTARR[COUNT]    * extract by fund(1)/med(2)
.
.         COMPARE   TWO,OPTNFLAG
.         GOTO      SDVWX500 IF EQUAL
.
.         ADD       ONE,COUNT
.         MOVE      PRECHFND,KEYSTARR[COUNT]    * health fund
.
.         MOVE      THREE,F3                    * first 3 keyins
.         GOTO      SDVWX600
.
SDVWX500  MOVE      TWO,F3
.
SDVWX600  ADD       ONE,COUNT
          CLEAR     ECCLMARR
.
          IF        IBCNMHOS=ONE
            APPEND    WBDWHOSP,ECCLMARR
          ELSE
            APPEND    SP3,ECCLMARR
          ENDIF
          APPEND    WBDWUNIQ,ECCLMARR
          APPEND    WBDWINVN,ECCLMARR
          APPEND    WBDWURNO,ECCLMARR
          APPEND    PRINDATE,ECCLMARR
.
          ASSIGN    (PRINITOT+PRINPAMT+PRINHAMT+PRINIAMT+PRINMAMT+PRINVAMT+PRINOTHA+PRINJAMT+PRINCNTT),WBDWAMTC
          IF        IBCNUGST=2
            ADD       PRINGSTJ,WBDWAMTC
          ENDIF
.
          APPEND    WBDWAMTC,ECCLMARR
          APPEND    TWO,ECCLMARR
          APPEND    SP1,ECCLMARR
          APPEND    ZERO,ECCLMARR
          APPEND    SP1,ECCLMARR
          RESET     ECCLMARR
          MOVE      ECCLMARR,KEYSTARR[COUNT]    * to be extracted
.
          ADD       ONE,F3                  * eclipse claims keyins
.
          ADD       ONE,COUNT
          PACK      KEYSTARR[COUNT],SP70         * blank record to signal exit
          ADD       ONE,F3
.
          ADD       ONE,COUNT
          MOVE      ANSP,KEYSTARR[COUNT]         * (P)ost
.>>>>
.>>>>     ADD       ONE,COUNT
.>>>>     MOVE      ANSY,KEYSTARR[COUNT]         * (Y) to extract (if ok)
.>>>>
          ADD       ONE,COUNT
          MOVE      SP70,KEYSTARR[COUNT]         * (Enter) to exit
          ADD       ONE,COUNT
          MOVE      "\",KEYSTARR[COUNT]          * (\) to exit
.
          ADD       THREE,F3                     * add last 3 keyins (if error)
.>>>>     ADD       FOUR,F3                      * add last 4 keyins (if ok)
          MOVE      F3,KEYSTCNT                  * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SDVWX999  RETURN
+
.------------------------------------------------------------
. Indicator for Eclipse WebServices DVAW
.------------------------------------------------------------
ECLDVA00  MOVE      ZERO,DIM1
.
          MATCH     "1",PTCNDVAW
          GOTO      ECLDVA90 IF NOT EQUAL
.
          MATCH     SP70,PRHRTACC
          GOTO      ECLDVA90 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00
.
          MATCH     "8",TCINDC1
          IF        @EQUAL
            GOTO      ECLDVA80
          ENDIF
.
          GOTO      ECLDVA90
.
ECLDVA80  MOVE      ONE,DIM1
.
ECLDVA90  WRITE     HTMLFILE;DIM1;
ECLDVA99  RETURN
+
.------------------------------------------------------------------------------
          INC       IBAWEBCD
.
          INC       CLPMSCEX
          INC       CLPMSCLT
          INC       PATDOCTM
          INC       PATMASTM
          INC       PATMSXTM
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSCLTTM
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       CLNHIMAS
          INC       PATGBCRN
.
          INC       AUTOPCOD                * Auto generation of the postcode
          INC       CLPATMAS
          INC       CALCAGE
          INC       NHIMASIO/INC                 * NZHIS Variables
          INC       NHIETHIO/INC
.
          INC       BOKRC1IO/INC
          INC       EMRECTIO/INC
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       IBATMDIO/INC
.          INC       IBATMHIO/INC
          INC       OUTECTIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
.
          INC       MRTMASIO/INC
          INC       PATDO1IO/INC
          INC       PATWR1IO/INC
          INC       PATDRGIO/INC                 * date range period file
          INC       PMSHCPIO/INC                 * doctor file
          INC       PMSHCLIO/INC
          INC       PMSHCGIO/INC
          INC       PMSCLTIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PATDSCIO/INC                 * discharge file
          INC       OBSPCOIO/INC
          INC       OBSPCTIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATGO1IO/INC
          INC       PATGSRIO/INC                 * Patient Surname / Given Name
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC                 * insurance company file
          INC       PATMA1IO/INC                 * patient file
          INC       PATMESIO/INC                 * invoice message file
          INC       PATMI1IO/INC
          INC       PATPR1IO/INC
          INC       PATRE1IO/INC
          INC       PATPERIO/INC                 * doctor personal file
          INC       PATVISIO/INC                 * visit file
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
.
          INC       PRIUPURE
          INC       PMSCEXCD
          INC       PMSCEXTM
          INC       PRICALFS
          INC       PRIINVHL
          INC       PRIINVTL
          INC       PRIINVPR
          INC       PRIKYBUL
          INC       PRIHRETM
          INC       PRIWCOTM
          INC       PRIMABTM
          INC       PRIVAFTM
          INC       PRICTCTM
          INC       PRIHFCF
          INC       TFILENAM
          INC       RSHWEBCD
          INC       CLPRIDTR
          INC       CLPRIHTR
          INC       CLPRIHRE
          INC       CLPRIHDB
          INC       CLEMRECT
          INC       CLWEBPCI
          INC       CLOUTECT
          INC       CLWEBBBS
          INC       CLWEBDVW
          INC       CHKCLDCP
.
          INC       PRIINVIT/INC                 * for PRIINVPR
.
          INC       APSMASIO/INC
          INC       COMDEPIO/INC                 * common deposit file
          INC       RCPBNKIO/INC                 * bank details file
          INC       RCPBDTIO/INC                 * bank details file
          INC       RCPDTEIO/INC                 * receipt details file
          INC       RCPREGIO/INC                 * Register file
          INC       PMSCEXIO/INC
          INC       PRIAUIIO/INC                 * cash deposits invoiced audit
          INC       PRIAUJIO/INC                 * journal audit file
          INC       PRIJRNIO/INC                 * journal file
          INC       PRIALSIO/INC                 * Medical Prac.all user access
          INC       PRISECIO/INC                 * Medical Prac.security access
          INC       PRICMNIO/INC                 * comments
          INC       PRIECTIO/INC
.
          INC       PRIBULIO/INC                 * bulk billing file
          INC       PRIDOCIO/INC                 * M.P. doctor file
          INC       PRIDTRIO/INC                 * debtor transaction file
          INC       PRIEXCIO/INC                 * exception charges file
          INC       PRIFIGIO/INC                 * financial summary file
          INC       PRIFINIO/INC                 * financial summary file
          INC       PRIGRPIO/INC                 * item group file
          INC       PRIHDBIO/INC                 * holding header file
          INC       PRIHISIO/INC                 * test history file
          INC       PRIHOLIO/INC                 * account hold file
          INC       PRIHREIO/INC                 * holding referral file
          INC       PRIHTRIO/INC                 * holding transaction file
          INC       PRITMPIO/INC                 * common item tempfile
          INC       PRIINVIO/INC                 * invoice file
          INC       PRIITMIO/INC                 * item file
          INC       PRIMABIO/INC                 * T.A.C. file
          INC       PRIMGPIO/INC                 * medicare gap file
          INC       PRIMULIO/INC                 * multiple services file
          INC       PRIPRAIO/INC                 * medical practice file
          INC       PRISPTIO/INC                 * special pathology test file
          INC       PRISTAIO/INC                 * financial statistics file
          INC       PRITHDIO/INC                 * Common items header file
          INC       PRITDTIO/INC                 * Common items detail file
          INC       PRITESIO/INC                 * pathology test file
          INC       PRIVAFIO/INC                 * veterans affairs file
          INC       PRIWCOIO/INC                 * workers comp. file
          INC       PRICTCIO/INC                 * Civil tort file
          INC       PRICNOIO/INC                 * Credit note header file
          INC       PRIFCIIO/INC                 * Credit note file
          INC       PRICDTIO/INC                 * Referral Comment file
          INC       PRICFXIO/INC                 * Referral Comment text file
          INC       PRIICMIO/INC                 * Invoice Referral Comment file
          INC       PRIIFXIO/INC                 * Invoice Comment text file
          INC       HICITIIO/INC                 * HIC Item invoice file
          INC       WEBIMCIO/INC
          INC       WEBPCIIO/INC
          INC       WEBBBSIO/INC
          INC       WEBDVWIO/INC
          INC       WEBB2BIO/INC
