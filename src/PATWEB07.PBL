.----------------------------------------------------------------------
. Program       : PATWEB07
.
. Function      : Alternate ID Maintenance
.
. Modifications : 
.----------------------------------------------------------------------
. V12.01.01 21/01/2026  Ebon Clements  TSK 0961702
.           Fixed watespaf read that caused infinite loop - WESIS000
. V12.00.06 19/11/2025  J.Tan          TSK 0968928
.           Mod Payers for Admission (APBR0000) to check for Effective dates
.           prior checking for Default payer field
. V12.00.05 14/11/2025  Zumin Yu       TSK 0968985
.           Fixed issue in GWDT0000 where last GetParticipant date was not
.           updating in multi-hospital setups
. V12.00.04 25/09/2025  Nikitha B      TSK 0966680
.           Added RA read RAPMNPL1 at WPMNPL00 before WRPMNPL1.
.           Added a new label WPMNPL10.
. V12.00.03 06/06/2025  J.Tan          TSK 0961638
.           Mod Public Hospital to setup fields for Billing/3B Cert.Calculations
. V12.00.02 22/05/2025  J.Tan          TSK 0955096
.           Added Alphanumeric visit number changes
. V12.00.01 13.05.2025  DA Sarkies    TSK 0947257
.           Added CHCKCOMP variable to redirecty to secondary insurer
. V11.05.05 13.05.2025  DA Sarkies    TSK 0947257
.           Added CHCKCOMP variable to redirecty to secondary insurer
. V11.05.04 26.03.2025  DA Sarkies    TSK 0946536
.           Fixed problem with created and update details for previous
.           hospitalisations
. V11.05.03 06.03.2025  DA Sarkies    TSK 0955909
.           Added code to update ESIS report when NDIS added/updated
. V11.05.02 10.12.2024  DA Sarkies    TSK 0951086
.           Increase LOS size relating to ADYHOSP from 3 to 4
. V11.05.01 04.12.2024  DA Sarkies    TSK 0951086
.           Increase LOS size relating to PATMI3BDY from 3 to 4
. V11.04.07 25/10/2024  Ebon Clements TSK 0951967
.           Added cgi's mvithmva and mvitrdir for MVIT hospital in the last
.           7 days redirect to MVIT claim screen
. V11.04.06 06/05/2024  Thanh T       TSK 0941543
.           Recompiled as PMSCEXTM changes 
. V11.04.05 04/03/2024 PJ Le Febour      TSK 0929044dc
.           UWSP2000 MOVE USERID WBETCUID
. V11.04.04 22/01/2024  Alina Bhari      TSK 0932545
.           Recompile for PMSCEXTM and PMSCEXTD                     
.           - Added PMCEX028,PMCEX029,PMCEX030,PMCEX031             
. V11.04.03 12/01/2024  Alina Bhari      TSK 0932545
.           Added Comment column in contact detail maintenance and 
.           contact history - CHIS1000,DHIS0000,CEXT0080                
. V11.04.02 14/12/2023  Peter Vela       TSK 0935874
.           Added PTCNUNET validation on OPEN of pmsiheaf
. V11.04.01 30/11/2023  Peter Vela       TSK 0935874
.           Recompiled for PMSIHEFD - Added indexes 4,5,6 and added Exception
.           Description
. V11.03.14 09/11/2023 Peter Vela     TSK 0935874
.           Added single hospital / multi hospital validation in
.           before WRPMNPL1 for NIHC IHI Lookup
.           Commented out add calls to WIHI0000 (maybe re-instate in the future)
. V11.03 13 02/11/2023  Peter Vela       TSK 0935874
.           Don't call DEPMAID1 if PTCNUNET = 3 and if an IHI Number.
.           Delete of IHI number will occur on return of Clear IHI command to 
.           the NIHC Server through IHIWEB03
. V11.03.12 17/10/2023  Peter Vela       TSK 0935874
.           Added parameter check for pmsihiaf
. V11.03.11 13/10/2023  Peter Vela    TSK 0935874
.           Recompiled for PMSIHIFD - Fixed IO calls
. V11.03.10 13/10/2023 Thanh T        TSK 0935874
.           Changed PTCNUNET = '1' to PTCNUNET = '3' and write out
.           pmsnplaf instead of pmsiplaf
. V11.03.09 10/10/2023 Thanh T        TSK 0935874
.           Changed PTCNUNET = '1' to PTCNUNET = '3' and write out 
.           pmsnplaf instead of pmsiplaf 
. V11.03.08 03/10/2023 Thanh T        TSK 0935874 
.           Changed DELID000 to call WPMNPL00 to write out pmsnplaf
.           record when alternate ID is deleted and PTCNUNET = 3         
. V11.03.07 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes
. V11.03.06 06/06/2023  Ebon Clements   TSK 0928369
.           Update PMI NDIS participant PTMXESPF to yes if an NDIS
.           concession card is added - ADDCD000
. V11.03.05 17/05/2023  Ebon Clements   TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.04 12.05.2023  DA Sarkies      TSK 0928369
.           Added html display for hospital state
. V11.03.03 01/05/2023  Thanh T         TSK 0914049
.           Changed IPFLLS00 to setup HTMLLNK2 for calling AddPatFollowUp
.           when add new outcome details
. V11.03.02 08/03/2023  Thanh T         TSK 0914049
.           Fixed issue with call attempt 1 date not update correctly
.           when it is blank
. V11.03.01 17/02/2023  Thanh T         TSK 0914049
.           Added new option 25 and 26 for Patient follow up
. V11.02.08 06/08/2022  Bella Turco    TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value. 
. V11.02.07 15/08/2022  Ebon Clements   TSK 0921920
.           Added ability to manually enter previous days of hospitalisation
.           PHSP1000
. V11.02.06 01/06/2022  Ebon Clements   TSK 0920421
.           Added patcchaf exists test AUDTATRB to concession card history
.           view - CCHIV000
. V11.02.05 03/05/2022  Ebon Clements   TSK 0888071
.           Corrected exclude from billing and 3B calculations - CORIG000
. V11.02.04 11/04/2022  Alina Bhari     TSK 0912792
.           Added ability to add and delete external visit number link.
.           Displayed the list of alternative visit audit records      
.           Included PMSALVFD,PMSALVTD,PMSALVTM,PMSALVIO,IBAALVFD,IBAALVIO
.           - MAIN3400,ALTVA000,ADEVN000,PROFL240,PROFL241,PROFL242,ALTV0000 
.             IBAALT00,TABAVS00                                          
. V11.02.03 23/03/2022  Peter Vela      TSK 0917213
.           Added webservices/eclipse participant match to FTAB0000 and
.           WFTB0000
. V11.02.02 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 04/02/2022  Ebon Clements   TSK 0888071
.           Added include in billing and 3B calculation fields to previous
.           hospitalisation. PHSP0000 
. V11.01.07 29/11/2021  Thanh T         TSK 0903848
.           Changed ATTRID10 to set PTARDELR to "0" when a new record 
.           is written out 
. V11.01.06 23/11/2021  Ebon Clements   TSK 0913624
.           Set AGEDATE to deceased date if deceased - LSUR0000
. V11.01.05 29/10/2021  Thanh T         TSK 0903848
.           Added MAIN3300, PROFL230 for bed management enhancement       
. V11.01.04 15/07/2021  Ebon Clements   Task 0908003
.           Added read on PMI extension file to last 20 U/R's - LSUR0000
. V11.01.03 09/07/2021  Ebon Clements   Task 0908807
.           Added branch on exit after XMLHED00 calls in AJXEND00 and AJXERR00
. V11.01.02 08/06/2021  Jill Parkinson  Task 0900650
.           Created carer search
. V11.01.01 27/05/2021  Tony Hui       TSK 0906736
.           Fixed the HTMLLINK Generation at CCDLST00 to print double quotes
.           instead of backticks, which fixed the Delete Concession Card
.           functionality for all Internet Browsers.
. V11.00.09 11/02/2021  Peter Vela     TSK 0902737
.           Fixed error message at UWSP1400           
. V11.00.08 01/02/2021  Peter Vela     TSK 0898361
.           Added WebServices Participants/Organisations functionality
. V11.00.07 09/12/2020  Thanh T        TSK 0872840
.           Recompiled as PMSPX2TM changes 
. V11.00.06 12/11/2020  Thanh T        TSK 0878747  
.           Changed LMLBRA00 to return DIM16 for "Order Not Stated" instead
.           of "Not Stated"
. V11.00.05 02/11/2020  Thanh T           TSK 0878747
.           Added MULBAT00, PROFL210 and LMLBRA00 for Multiple Birth 
.           Patient Attributes 
. V11.00.04 07/05/2020  Thanh T           TSK 0876574
.           Recompiled for PMSCEXTM/PMSCEXTD changes
. V11.00.03 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.02 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.01 28/02/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
. V10.15.03 06/01/2019 Ebon Clements      TSK 0879283
.           Added NDIS start date edit -  NDISDT94
. V10.15.02 06/01/2019 Ebon Clements      TSK 0879283
.           Changed report 20 NDIS patient attributes to be U/R based 
. V10.15.01 18/12/2019 Ebon Clements      TSK 0879283
.           Added report 20 NDIS patient attributes - NDISDT00
. V10.14.12 04/09/2019  Jill Parkinson    TSK 0880814
.           Added write of edward alteration when deleting concession card
. V10.14.11 17/07/2019  Ebon Clements     TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.10 09/07/2019  Richa Phogat      TSK 0864951
.           Updated CCHIV000 for WBSENAM
. V10.14.09 05/07/2019  Richa Phogat      TSK 0864951
.           Add PMCDEXDT under CCDLST00 & DELCCN00 to sort records by Card 
.           Expiry Date
. V10.14.08 13/06/2019  Richa Phogat      TSK 0864951
.           Added CCRD1200, CCRD1300, CCRD1400, CCRD1500, CCRD1600, ADUPDAUD, 
.           PATCCHFD, CLPATCCH
. V10.14.07 03/06/2019  Jill Parkinson    TSK 0873054
.           Added reportno 19 - MH attributes
. V10.14.06 01/06/2019  Jill Parkinson    TSK 0875122
.           Added clearing of pmewoldv before writes to pmsedwaf
. V10.14.05 17/05/2019  Sunny             TSK 0843772
.           Added hyperlink to visit no 
. V10.14.04 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
. V10.14.03 05/04/2019  Jill Parkinson Task 0872438
.           Mods to pack pmewtype with spaces in WREDW000 to stop I*D
. V10.14.02 28/02/2019  Richa Phogat   TSK 0867546
.           Replaced Name and address fields to uppercase under CEXT0000
. V10.14.01 20/02/2019  Peter Vela     TSK 0863035
.           Changed single quote validation to ` SLCONT00
. V10.13.05 15/11/2018  Peter Vela     TSK 0863035
.           Validate for single quotes in SLCONT80
. V10.13.04 11/09/2018  Peter Vela     TSK 0863035
.           Added missing variables to SLCONT00 
. V10.13.03 05/09/2018  Don Nguyen     TSK 0857734
.           Added UPI Number (UPINUMBR) tag output
. V10.13.02 22/08/2018 Peter Vela     TSK 0859742
.           Recompiled for PMSCEXFD
. V10.13.01 16/08/2018 Ebon Clements  TSK 0859742       
.           Added select contact list - SLCONT00
. V10.12.09 04/06/2018 Ebon Clements  TSK 0854413       
.           Added display if contact add and change audit records - DETH0000
. V10.12.08 23/0/2018  Jill Parkinson Tsk 0854795       
.           Mods to write 16 to pmsedwaf when deleting alternate UPI ID
. V10.12.07 23/04/2018  Davin               TSK 0844685
.           Check U/R doesn't already have a NSLHD UPI alternate ID (VUPI0000)
. V10.12.06 16/04/2018  J.Tan               TSK 0844685
.           Added check for UPI security level
. V10.12.05 19/01/2018  Ania P              TSK 0853909
.           Added ATTRIB31
. V10.12.04 08/02/2018  Jill Parkinson  TSK 0846167   
.           Added writes to pmsedwaf for upi addition     
. V10.12.03 01/02/2018  Jill Parkinson  TSK 0846167   
.           Added writes to pmsedwaf for nsw edw extract  
. V10.12.02 12/01/2018  Ebon Clements     TSK 0845295
.           Added eReferral functionality  - cgi erefrlid
. V10.12.01 11/01/2018  Don Nguyen        TSK 0848082
.           Added call to SUBDLV00 - Subtract hospital days from linked visit
.----------------------------------------------------------------------
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 20/10/2017  Ebon Clements     TSK 0844030
.           Added DVA card colour code to JSON display - LSTCCD00
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
.
. V10.10.03 23/06/2017  Ebon Clements     TSK 0840713
.           Added hospital security test to last 20 U/R's - DSPROW00
. V10.10.02 17/05/2017  Ania P            TSK 0836876
.           Added MVMEDREC
. V10.10.01 29/03/2017  Tracey Nguyen     TSK 0833454
.           Recompiled for PATATRTD/PATARTM
. V10.08.07 24/11/2016  Ebon Clements  TSK 0823703
.           Added multi hospital, ED site and OP site test to last 20 U/R's
.           DSPROW00
. V10.08.06 01/08/2016  Davin          TSK 0315393
.           Use appt date to calc rec retention date for outpatients (recrn800)
. V10.08.05 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.08.04 17/06/2016  Davin          TSK 0315393
.           Added option 18 - Medical Record Retention Details
.           10/06/2016  J.Tan          TSK 0814716
.           Mods to update Usual PRFA for Inactive/deleted Contact (UPRF0000)
. V10.08.03 06/06/2016  Peter Vela     TSK 0321157
.           Recompiled for PATATRFD
. V10.08.02 28/04/2016  Don Nguyen       TSK 0316489
.           Modified PATATR00, LSTATT00 & LST5AT00 to match Attribute Type '001'
.           Recompiled for PATATRTM & PATATRFD/IO
. V10.08.01 12/04/2016  Peter Vela       TSK 0817293
.           Modified LSUR0000 to skip empty UR numbers
. V10.07.03 25/02/2016  Don Nguyen       TSK 0319052
.           Modified SETALT00 - increased temp var size for Alt ID value
. V10.07.02 29/01/2016  Don Nguyen       TSK 0319052
.           Modified SETALT00 to cater for Indicator 3 values
. V10.07.01 04/01/2016  Ebon Clements    TSK 0294154
.           Added send SMS functionality to contact maintenance
. V10.06.03 09/09/2015  Davin            CAR 313906
.           Mods to allow postal address to be saved as PRFA:
.           Added postprfa/PPRFA000/PROFLD64
. V10.06.02 27/08/2015  Peter Vela       CAR 313920
.           Added submit/tag for admisnid
.           Added ajax call functionality to EXCONT00
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.----------------------------------------------------------------------
. V10.06.01 30/04/2015 Ania P          CAR 313976
.           Added REMOTE30
. V10.05.03 19.01.2015  B.G.Ackland     CAR 311929   
.           Add Function to Enable AJAX Updates to Concession Card Details
. V10.05.02 13/08/2014  Peter Vela      CAR 304860
.           Recompiled for PMSVX1TM
. V10.05.01 28/07/2014  Peter Vela      CAR 301176
.           Added calculated BMI to ATTRIB00, LSTATT00, GTAG2200 
. V10.04.12 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.11 01/04/2014 Ebon Clements  CAR 297196
.           Fixed relationship display of contact history list - CHIS0000
. V10.04.10 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.09 27/03/2014 B.G.Ackland    CAR 298934
.           Implement Call to File Upload Control Script cliweb08.us1
. V10.04.08 11/02/2014  Ebon Clements  CAR 291879
.           Added NEHTA functionality
. V10.04.07 29/01/2014  Peter Vela     CAR 286158
.           Changed LSTATT00 and LST5AT00 to RS/RP
. V10.04.06 24/01/2014  Peter Vela     CAR 286158
.           Changed PATATR reads and writes
. V10.04.05 22/01/2014  Peter Vela     CAR 286158
.           Recompiled for CALCBMIN
. V10.04.04 17/01/2014  Peter Vela     CAR 286158
.           Changed BMI underweight to purple
. V10.04.03 16/01/2014  J.Tan          CAR 296189
.           Mods default Payer breakdown Counter to one
. V10.04.02 13/01/2014  Peter Vela     CAR 286158
.           Fixed BMI colors
. V10.04.01 17/12/2013  Peter Vela     CAR 286158
.           Fixed BMI colors
. V10.03.21 03/12/2013  Peter Vela     CAR 286158
.           Added Patient Attributes functionality
. V10.03.20 03/06/2013  J.Tan          CAR 283618
.           Added Payer and Payer breakdown
. V10.03.19 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.18 03/05/2013  Steve Armstrong CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.17 02/05/2013  Don Nguyen      CAR 284693
.           Recompiled for changes to IBAWEBCD (TITLESEL & RELATSEL)
.           29/04/2013  Ebon Clements   CAR 261630
.           Removed port number from temp file name
. V10.03.16 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.15 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.14 15/02/2013  Jill Parkinson  CAR 268131
.           Added read of emrvisaf and output of EMVICOMP
. V10.03.13 09/01/2013  Peter Vela      CAR 268131
.           Added Previous Hospitalisation functionality for Emergency
. V10.03.12 29/11/2012  Jill Parkinson  CAR 277333 
.           Removed "Patient is Deceased" error from PHSP0000           
. V10.03.11 27/11/2012  Jill Parkinson  CAR 276961 
.           Added rep " with ' for pmscexaf fields in GTAG0700          
. V10.03.10 29/06/2012  Jill Parkinson  CAR 267503 
.           Added write to prspmiaf for concession card number updates
. V10.03.09 17/05/2012  Davin           CAR 260777 WA-HMDS Triggers
.           Added write to prspmiaf for concession card number changes
. V10.03.08 06/03/2012  Davin           CAR 261243
.           Recompiled for PMSCEXTM - oseas country desc
. V10.03.07 24/02/2012  J.Tan           CAR 260843
.           Removed checking Indicator for Concession Card type
. V10.03.06 24/01/2012  Ebon Clements   CAR 259041 
.           Fixed last 20 ur display of OP booking visit number - DSPROW00
. V10.03.05 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.04 10/01/2012 Peter Vela       CAR 257764
.           Added tags for Contact History Contact Type and Counter
. V10.03.03 08/12/2011 Ebon Clements    CAR 248529 
.           Added webPAS unique id to contacts
. V10.03.02 26/11/2011 Ebon Clements    CAR 248529 
.           Don't perform duplicate contact test when adding inactive contacts
. V10.03.01 07/11/2011 Ebon Clements    CAR 248529 
.           Added multiple contacts of the same type functionality
. V10.02.19 25/10/2011 Jill Parkinson   CAR 251645 
.           Changed to write to PTMI3BDY and to ADYHOSP
. V10.02.18 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.17 10/10/2011 Ebon Clements  CAR 252057
.           Set PTMI3BDY to spaces rather than zero - CORIG000
. V10.02.16 23/09/2011 Jill Parkinson CAR 248486
.           Recompiled for IBAWEBCD - visit other hospital changes
. V10.02.15 20/09/2011 Sandra Barcham  CAR 251571
.           Added Seniors Concession Card for category ct
. V10.02.14 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.13 13/09/2011  Ebon Clements     CAR 249042
.           Added othrcont cgi for extra contacts cancel button redirect
. V10.02.12 31/08/2011  J.Tan             CAR 247836
.           Mods validating Veterans Card Number
. V10.02.11 15/08/2011  Jill Parkinson    CAR 247957
.           Fixed previous days hospitalisation calculation
. V10.02.10 03/08/2011  Steve Armstrong   CAR 247627
.           Added DGCLICUP triggers for write/update/delete on pmsccdaf.
.           Added DGCLICUP triggers for write/delete on pmsaidaf.
. V10.02.09 22/07/2011  Ebon Clements     CAR 239525
.           Added cpmiskey to UpdatePRFA()
. V10.02.08 15/07/2011  Steve Armstrong   CAR 245199
.           Added HL7 trigger for WRPMCEX, UPPMCEX & DEPMCEX calls.
.           14/07/2011  Jill Parkinson CAR 242269    
.           Mods to output 1 for meh visits in MISC0000        
. V10.02.07 11/06/2011  Jill Parkinson    CAR 240715 
.           Fixed calculation of total hospitalisation days    
. V10.02.06 09/06/2011  Jill Parkinson    CAR 240715 
.           Added report option 15 - Previous admission details
.           10/06/2011  J.Tan             CAR 239592 
.           Added second given name to Extra contact file (pmscexaf)
. V10.02.05 07/06/2011  Ebon Clements     CAR 239530 
.           Recompiled for PMSCEXTM - Updated/Created by tags
. V10.02.04 06/06/2011  Ebon Clements     CAR 239525 
.           Added confirm PMI functionality
. V10.02.03 06/06/2011  Jill Parkinson    CAR        
.           Added use of PTCNAIWI -allow alternate Id without indicator
. V10.02.02 02/06/2011  Jill Parkinson    CAR 242416
.           Extra Contact mods - added send letter and Active fields 
.           and tablesort list
. V10.02.01 04/05/2011  Saroeun Soeur     CAR 242512
.           UPDCD000 - fixed update on concession cards
. V10.00.04 28/09/2010  Davin S           CAR 229203
.           Added regiflag to keep track of new registrations (1=new reg)
. V10.00.03 07/07/2010  Davin S           CAR 219892
.           Added buttflag to decide redirect when conc. card screen is closed
. V10.00.02 19/03/2010  Davin S           CAR 223380
.           Added DVA card colour to concession cards (pmccd005/pmcddvac)
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.           07/04/2010  Davin         CAR 200414
.           Recompiled for PMSPODTM - Added pmpod007 for 70 char comment line
.-------------------------------------------------------------------------------
. V9.12.07  19/01/2010  Jill Parkinson   CAR 210630
.           Added newregfl cgi
. V9.12.06  07/11/2009  Saroeun Soeur    CAR 209737
.           Recompiled for PATMASTM - post ward / bed
. V9.12.05  24/11/2009  Peter Vela       CAR 210810
.           Fixed update of location id.
.           Fixed update of certificate.
. V9.12.04  04/08/2009  Jill Habasque    CAR 145706
.           Mods to check lastdate in GPALD000
. V9.12.03  17/07/2009  Jill Habasque    CAR 145706
.           Added output of gp practice fields
. V9.12.02  16/07/2009  Jill Habasque    CAR 145706
.           Fixed gpaccess audit list
. V9.12.01  01/05/2009  Jill Habasque    CAR 145706
.           Added report option 14 - GP Access Audit details
. V9.11.06  03/02/2009  Peter Vela       CAR 183976
.           Fixed tag for Last Generate date for Get Participant keywords.
. V9.11.05  13/01/2009  Peter Vela       CAR 183976
.           Added tag for Last Generate date for Get Pariticpant keywords
. V9.11.04  06/01/2009  Peter Vela       CAR 183976
.           Added option 13 - Eclipse Location Id Details/Maintenance
. V9.11.03  17/12/2008  Peter McMullen   CAR 185473
.           Re-compiled for change to PMSPODTM.PBL
. V9.11.02  07/11/2008  Davin            CAR 183976
.           Added option 12 - Eclipse Participant Details
. V9.11.01  23/10/2008  Peter Vela       CAR 181346
.           Fixed add concession card oldccddt tag.
. V9.10.01  10/07/2008  Ebon Clements    CAR 171718
.           Added STARTKEY to SETPAR00
. V9.09.07  14/02/2008  Jill Habasque    CAR 153381
.           Added procedure description for adverse outcomes
. V9.09.06  13/12/2007  Jill Habasque    CAR 153381
.           Added adverse outcomes
.           05/12/2007  Jill Habasque    CAR 147606
.           Added extra 10 ur and admission numbers for webluraf
. V9.09.05  23/11/2007  Peter Vela       CAR 110404
.           New variables for Write and Update to pmsaidaf
. V9.09.04  05/11/2007  Jill Habasque    CAR 151908
.           Added report option 10 - Visit Extension Maintenance
. V9.09.03  05/10/2007  Jill Habasque    CAR 150324
.           Added report option 8 - Patient Referral Details
. V9.09.02  09/08/2007  Steve Armstrong  CAR 136547
.           Mods for new concession card type "4" - Pension Card
. V9.09.01  31/07/2007  Mike Laming    CAR 110404
.           Added PMAIRDAT (Registration Date) to PMSAIDFD/IO
. V9.08.05  29/03/2007  Janet George   CAR 109028
.           Added Alternate ID View Only functionality in LSTAIV00 routine
. V9.08.04  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.03  09/11/2006  Mike Laming   CAR 103368
.           Correct sequencing of PMSPAYaf during "DELETE" at EXPPAY34
. V9.08.02  03/11/2006  Peter Vela    CAR 122515
.           Added tag for PTCNDAUR Use Alternate ID instead of UR.
. V9.08.01  17/10/2006  Jill Habasque CAR 111731
.           Fixed ADDID000 to pack pmaitype     
. V9.07.04  12/09/2007  Ebon Clements CAR 110245
.           Added WAITFLAG and TRNSFLAG cgi vars
. V9.07.03  06/09/2007  Jill Habasque CAR 109852
.           Added Display instead of UR for alternate ID's
. V9.07.02  27/06/2006  Ebon Clements CAR 103365
.           Added Expected payor details sequence number
. V9.07.01  27/06/2006  Ebon Clements CAR 103365
.           Added report 7 - Expected payor details
. V9.05.02  28/03/2006  Ebon Clements CAR 79277
.           Added report 6 - Extra contact details
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 20/02/2006  Peter Vela    CAR 92568
.           Fixed javascript error in GETD0000
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.11  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.09  07/09/2005  Peter Vela    CAR 66928
.           Commented out check for patvisaf record on display of alternate
.           ID screen. ALTID500
. V9.04.08  28/04/2005  Jill Habasque CAR 57678
.           Added check for the same alternate id for different UR'check for the same alternate id for different UR's
. V9.04.07  22/03/2005  Jill Habasque CAR 57678
.           Added message "Alternate Id already exists"
. V9.04.06  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.05  11/01/2005  Jill Habasque CAR 55957    
.           Fixed right justify of alternate ID
. V9.04.04  04/12/2005  Lina Vo           CAR 55676
.           Changed DSPROW00 to validate visit belongs to correct UR
. V9.04.03  15/12/2004 Davin         CAR 55658
.           Added patient photo id (option 5)
. V9.04.02  24/11/2004  Davin             CAR 34707
.           Added update option to concession card list
. V9.04.01  18/08/2004  Jill Habasque CAR 52756
.           Fixed nextpage for remote script
. V9.03.03  05/08/2004  Steve Armstrong  CAR 34707 & 48877
.           Added triggers for CHA and CHD broadcast messages.
.           (DGCLICHA & DGCLICHD)
. V9.03.02  12/07/2004  Davin         CAR 34707
.           Added Report 4 - Concession Card Maintenance
.           13/07/2004  Jill Habasque CAR 52055
.           Added phone number to pmsdaaaf
. V9.03.01  23/06/2004  Jill Habasque CAR 44641
.           Added remote script for default Address
. V9.03.00  11/06/2004  Sylvek Litewka  CAR 49065
.           Added Report 2 - Last 10 UR's for a given user.
.           09/06/2004  Jill Habasque  CAR 44641
.           Created Web Server
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       ALLCASFD/INC
          INC       PATINVFD/INC
          INC       PMSPYRTD/INC      * cgi vars Payer details file
          INC       PMSPYRFD/INC      * Payer details file
          INC       PMSPBRFD/INC      * Payers breakdown
          INC       PMSIDEFD/INC      * Invoice payer
          INC       PATMCHFD/INC      * Misc.charge file
          INC       PMSREGFD/INC      * Regime Code
          INC       PATRGMFD/INC      * Patient Regimes
          INC       EMRCONFD/INC
          INC       EMRDOCFD/INC
          INC       EMRHISFD/INC
          INC       EMRICDFD/INC
          INC       EMRLOCFD/INC
          INC       EMRVISFD/INC
          INC       EMRVCDFD/INC
          INC       EMRGRCFD/INC
          INC       EMRUNKFD/INC    
          INC       EMRSITFD/INC
          INC       OPRNURFD/INC
          INC       PATCCHFD/INC      * Concession Card History File
          INC       PATDO1FD/INC   * Doctor File
          INC       PATNOBFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PATTRNFD/INC
          INC       PMSDUNFD/INC
          INC       MLTSECFD/INC
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSAIDFD/INC   * Alternate ID File
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSDAAFD/INC   * Alternate ID default Address File
          INC       PMSEDWFD/INC
          INC       PMSIHIFD/INC
.          INC       PMSIPLFD/INC
          INC       PMSMUPFD/INC
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATONLFD/INC
          INC       OUTSITFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATPR1FD/INC
          INC       PMSQPTFD/INC
          INC       PMSPX2FD/INC
          INC       PMSGPAFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC   * Health Fund Extension
          INC       PATWR1FD/INC
          INC       PRSPMIFD/INC
          INC       MEHVI1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OPRDEAFD/INC
          INC       OUTBOAFD/INC
          INC       PATCALAG/INC
          INC       PMSTLEFD/INC
          INC       PMSRELFD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATHSPFD/INC
          INC       PATNIDFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PATPARFD/INC
          INC       PATLCNFD/INC
          INC       PATPKIFD/INC
          INC       PATPCPFD/INC
.
          INC       PMSCEXFD/INC
          INC       PMSCEXTD/INC
          INC       PMSADCFD/INC
          INC       PMSETRFD/INC
          INC       PMSOCMFD/INC
          INC       PMSPODFD/INC
          INC       PMSAODFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSPHSFD/INC
          INC       PMSIHEFD/INC
          INC       PMSRFLFD/INC
          INC       PMSADCTD/INC
          INC       PMSPODTD/INC
          INC       PMSRFLTD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSNPLFD/INC            * NIHC IHI Polling
          INC       PMSPHSTD/INC
          INC       PMSPAYFD/INC
          INC       PMSPAYTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATCRTFD/INC
          INC       PATDSCFD/INC
          INC       TFILEVAR/INC
          INC       VARWISCM/INC
          INC       WEBLURFD/INC
          INC       WEBPARFD/INC
          INC       WEBPCPFD/INC
          INC       WEBPKIFD/INC
          INC       WEBETRFD/INC
          INC       WEBB2BFD/INC
          INC       WATESPFD/INC
          INC       PATMISTD/INC
          INC       PMSALVFD/INC
          INC       PMSALVTD/INC
          INC       IBAALVFD/INC
.----------------------------------------------------------------------
.
. patparaf cgi vars
.Name     Type      Length Description
.----     ----      ------ -----------
PTPAR001  DIM       3      Participant Code
PTPAR002  DIM       1      Participant Type (F=Health Fund/O=Other)
PTPAR003  DIM       40     Participant Name
PTPAR004  DIM       19     Participant Contact Number
PTPAR005  DIM       8      Date Health Fund Updated (ccyymmdd)
PTPAR006  DIM       3      Multiple Birth Type
PTPAR007  DIM       1      Birth Order
PTPAR008  DIM       3      Reason for change

.
. patpcpaf cgi vars
.Name     Type      Length Description
.----     ----      ------ -----------
PTPCP001  DIM       3      Participant Code
PTPCP002  DIM       3      Capability Id
PTPCP003  DIM       3      Secondary Capability Id
PTPCP004  DIM       1      Capability Version Id
PTPCP005  DIM       70     Capability Name
PTPCP006  DIM       6      Capability Role Code
.
FLTRCAPA  DIM       3      Capability Filter
.
FLASHFLG  FORM      1             * Flag for flashing last update date
.                                    0 = Display as non-flashing
.                                    1 = Display as flashing
.
. patlcnaf cgi vars 
.Name     Type      Length Description
.----     ----      ------ -----------
PTLCN001  DIM       8      Location
PTLCN002  DIM       40     Description
PTLCN003  DIM       1      Active Flag 
PTLCN004  DIM       3      Hospital Id
.
. patcrtaf cgi vars
.Name     Type      Length Description
.----     ----      ------ -----------
PTCRT001  DIM       8      Location
PTCRT002  DIM       8      From Date (ccyymmdd)
PTCRT003  DIM       10     Identifier
PTCRT004  DIM       8      To Date (ccyymmdd)
PTCRT005  DIM       60     Sender Id (email)
.
. pmsgpaaf cgi vars
.Name     Type      Length Description
.----     ----      ------ -----------
PMGPA001  DIM       8      UR Number
PMGPA002  DIM       10     Web User Id
PMGPA003  DIM       3      Override Reason (Cat OJ)
PMGPA004  DIM       240    Override Reason Text
PMGPA04A  DIM       80     Override Reason Text
PMGPA04B  DIM       80     Override Reason Text
PMGPA04C  DIM       80     Override Reason Text
PMGPA04D  DIM       80     Override Reason Text
.
. Patient Follow Up
.
.Name     Type      Length Description
.----     ----      ------ -----------
PTFOL001  DIM       8      Call Attempt 1 Date (ccyymmdd)
PTFOL002  DIM       8      Call Attempt 1 Time 
PTFOL003  DIM       3      Call Attempt 1 Outcome 
PTFOL004  DIM       8      Call Attempt 2 Date (ccyymmdd)
PTFOL005  DIM       8      Call Attempt 2 Time 
PTFOL006  DIM       3      Call Attempt 1 Outcome 
PTFOL007  DIM       8      Call Attempt 3 Date (ccyymmdd)
PTFOL008  DIM       8      Call Attempt 3 Time 
PTFOL009  DIM       3      Call Attempt 1 Outcome 
PTFOL010  DIM       3      Reason for Follow Up 
PTFOL011  DIM       3      Call Outcome
PTFOL012  DIM       3      Other Reference Location 
PTFOL013  DIM       80     Comment Line 1
PTFOL014  DIM       80     Comment Line 2
PTFOL015  DIM       80     Comment Line 3
PTFOL016  DIM       80     Comment Line 4
.
.
.
. Temporary File Definition ( Patient Follow Up U/R List)
. --------------------------------------------------------------
.
TMPPFLA1  IFILE SQL, FIXED=120, KEY="U1-8,9-16,17-24,101-108,109-116"
.
.Name     Type      Length Physical Start Description
.----     ----      ------ -------- ----- -----------
TMPFADDT  DIM       8      8        1     Admission Date
TMPFADTM  DIM       8      8        9     Admission Time
TMPFADNO  DIM       8      8        17    Admission Number
TMPFVTTY  DIM       1      1        25    Visit Type
TMPFATD1  DIM       8      8        26    Call Attempt 1 Date
TMPFATT1  DIM       8      8        34    Call Attempt 1 Time
TMPFATO1  DIM       3      3        42    Call Attempt 1 Outcome
TMPFRSFL  DIM       3      3        45    Reason For Follow Up
TMPFDELR  DIM       1      1        48    Deleted Flag
TMPFCRUS  DIM      10     10        49    User Who Created Record
TMPFCRDT  DIM       8      8        59    Date Record Created
TMPFCRTM  DIM       8      8        67    Time Record Created
TMPFUPUS  DIM      10     10        75    User Who Updated Record
TMPFUPDT  DIM       8      8        85    Date Record Updated
TMPFUPTM  DIM       8      8        93    Time Record Updated  
TMPFDATE  DIM       8      8        101   Attribute Date
TMPFTIME  DIM       8      8        109   Attribute Time
TMPFMHOS  DIM       3      3        117   Multiple hospital Id
. 
.End of Record                      120
.
OVRCOMAF  FILE      ASCII, FIXED=127        * Override comments
.
ADMISNID  DIM       20
ATTRDATE  DIM       8
ATTRTIME  DIM       8
CHGMODE   FORM      1
CNTITEM   FORM      3
CFILEPRE  DIM       3
CODDESC1  DIM       20
CODDESC2  DIM       20
CRTFRMDT  DIM       8
CPMISKEY  DIM       25                      * Confirm PMI OP session redirect
CHCKCOMP  DIM       1
DISADATE  DIM       12
DIM4      DIM       4
DIM4A     DIM       4
DIM4B     DIM       4
DIM4C     DIM       4
DIM80     DIM       80
DIM256    DIM       256
.
DISDDATE  DIM       12
DISPSTAT  DIM       10
DISPATYP  DIM       7
DISPUSER  DIM       30
REASDESC  DIM       20
DESCSSMS  DIM       3
DEFPFLAG  FORM      1
ENTERDAY  FORM      1             * Manually enter day program days
EREFRLID  DIM       20
.
FNAMEPFL DIM       8
.
PMPBR001  DIM       3
MXBIL     FORM      12.2[999]
MXDAY     FORM      12.2[999]
ITMCD     DIM       9[999]
RGMCD     DIM       10[999]
WSPWINDC  FORM      1
MVITHMVA  DIM       1            * MVIT have been in a motor vehice accident
MVITRDIR  DIM       1            * Redirect to MVIT claim screen
.
ACTVFLAG  FORM      1
ALTIDTYP  DIM       3
ALLOWDUP  FORM      1
AUDITKEY  DIM       33
BUTTFLAG  DIM       1
CASEKEYS  DIM       28
CASEUNIQ  DIM       10
CHAR1     DIM       1
CHAR2     DIM       1
CHAR3     DIM       1
CHAR4     DIM       1
CHARS58   DIM       4
CHAR9     DIM       1
CHRCOUNT  FORM      2
COMPODAF  FILE      ASCII, FIXED=127
COMOCMAF  FILE      ASCII, FIXED=127
COMFILNM  DIM       8
COMFILAD  DIM       8
COMFILAP  INIT      "COMADM"
COMFILOC  DIM       8
COMFILOP  INIT      "COMOCM"
CONSNAME  DIM       40
HELPRNT   FORM      3
COUNTER   FORM      2
TODAY     DIM       8
CURRDATE  DIM       8       * Current Date
CURRTIME  DIM       8       * Current Time
DELETBYU  DIM       30
BIRTYPDS  DIM       20
REATYPDS  DIM       20
FINUSRNM  DIM       30
FINDATED  DIM       11
FINTIME   DIM       8
STRSTRIK  DIM       8 
ENDSTRIK  DIM       9 
DIM3      DIM       3
DIM3A     DIM       3
DIM8      DIM       8
DIM9      DIM       9
DIM16     DIM       16
DIM11     DIM       11
DIM11A    DIM       11
DIM20     DIM       20
DIM21     DIM       21
DIM22     DIM       22
DIM40     DIM       40
DIM40A    DIM       40
DIM50     DIM       50
DISPDATE  DIM       12
DISPDAT1  DIM       12
DISPDAT2  DIM       12
DISPDAT3  DIM       12
DISPDAT4  DIM       11
DDATTIM2  DIM       23
DDATTIM3  DIM       23
DISPDVAC  DIM       20
DISPDVA1  DIM       20      * DVA Card colour Description
DOCTCODE  DIM       8
DPMRFL03  DIM       8
F3A       FORM      3
FORM3     FORM      3 
FORM8     FORM      8 
FORM12P2  FORM      12.2
TOTALCHR  FORM      12.2
INPUTBYU  DIM       30
IREQTYPE  DIM       2
UPDATEKY  DIM       22
UPDATBYU  DIM       30
INACTIVE  DIM       1
INACFLAG  FORM      1
JUSTNO    FORM      2 
LASTFLAG  FORM      1
LGPARDAT  DIM       8
LJUSCODE  DIM       80
FPTVISIT  DIM       8
PATLINK   DIM       256
HTMLLNK2  DIM       256
FILTCTYP  DIM       3
FILTUSER  DIM       10
FILTGPCD  DIM       10
FILTPPRC  DIM       10
FILTWBGP  DIM       10
FILTUNIT  DIM       3
FILTCLAM  DIM       3
FILTPTYP  DIM       3
FILTDDST  DIM       3
FILTWARD  DIM       3
FILTCOUT  DIM       3
SHOWFLAG  DIM       1
.
PRACCNTR  DIM       2
GPARFDAT  DATE      8
GPARTDAT  DATE      8
MBSDESC   DIM       70
MOVTOSEQ  DIM       2
MVMEDREC  DIM       1
LAST5CNT  FORM      1
LASTITEM  FORM      3
LASTSEQN  FORM      2
NDISCARD  FORM      1       * NDIS concession card type
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NMPNUMB   DIM       20
NODAYS    FORM      8
TOTNDAYS  FORM      4
TOT3BDAY  FORM      4
NXTALPHA  FORM      1
PATURNO   DIM       8
PATVISIT  DIM       8
MOVESEQN  DIM       2 
NEWREGFL  FORM      1
PMAID002  DIM       3
PMAID003  DIM       20
PMAID004  DIM       1
PMAID005  DIM       3
PMCCD002  DIM       3
PMCCD003  DIM       20
PMCCD004  DIM       8
PMCCD005  DIM       3
PMCCD006  DIM       3
PMCCD007  DIM       1
PTRGM001  DIM       10       * Regime code
DVACFLAG  FORM      1
CTYPINDC  FORM      2
OCGRADE   DIM       1
OLDCCDDT  DIM       8
OLDCOLOR  DIM       3
OCDCOMTS  FORM      1
OTHRCONT  DIM       1
PMDAA001  DIM       3
PMDAA002  DIM       35
PMDAA003  DIM       35
PMDAA004  DIM       35
PMDAA005  DIM       35
PMDAA006  DIM       8
PMDAA007  DIM       20
PODCOMTS  FORM      1
POSTPRFA  DIM       1
PROGDAYS  FORM      4             * Day program days
PSAGECON  DIM       3
PSAGETYP  DIM       3
RECRT001  DIM       3
RECRT002  DIM       8
RECRETDT  DATE      8
REGIFLAG  FORM      1
REMOTENO  FORM      1
RJUSCODE  DIM       80
SAVALID   DIM       20
SAVEADAT  FORM      8
SAVESEQN  DIM       2
SAVEWARD  DIM       3
SAVKEY3   DIM       3
SAVKEY8   DIM       8
SAVKEY35  DIM       35
SAVKEY40  DIM       40
SAVKEY53  DIM       53
SELCDATE  DIM       8
SEENDTIM  DIM       16
TESTDTIM  DIM       16
TESTDATE  DIM       8
TESTTIME  DIM       8
VCODE     DIM       5
WARDCODE  DIM       3
.
DEFTVIEW  FORM      1
ADMIDATE  DIM       11
ATT1DATE  DIM       11
ATT1TIME  DIM       8
CONTDETS  DIM       100
FOLDERSF  DIM       3                       * Folder Icon Suffi
VISTYPE   DIM       3
ATT1OUTD  DIM       20
RSNFOLUD  DIM       20
CALOUTCD  DIM       20
PATREXST  DIM       1
COUTCODE  DIM       3
COUTDATE  DIM       8
COUTTIME  DIM       8
COUTIMAG  DIM       3
REFLOCND  DIM       20
CRTUSRNM  DIM       30
CRTDATE   DIM       11
CRTTIME   DIM       8
UPDUSRNM  DIM       30
UPDDATE   DIM       11
UPDTIME   DIM       8
ADMDATE   DIM       11
ADMTIME   DIM       8
SDOCFNAM  DIM       50
.
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
WORKDATE  DIM       8
WORKTIME  DIM       8 
SUBITMNO  DIM       3
SUBITMFO  FORM      3
.
QRYDATA1  DIM       240
PFCMTFLG  FORM      1
PFCMTLIN  FORM      3
COMPFLAF  FILE      ASCII, FIXED=127
COMPFLNM  DIM       8
.
SHWPRINT  DIM       1
.
STARTKEY  DIM       10      * Starting Key
UPDTTYPE  DIM       1       * Update Type
UPDATETY  DIM       1         * Update Type (A)dd,(U)pdate,(D)elete,Blank=disp
PHOTODIR  DIM       20         * unix directory to save photos in
PHOTOEXT  INIT      ".jpg"     * photo file extension
PHOTOPIC  DIM       70         * photo input filename
PHOTOOLD  INIT      ".old"     * move deleted photos to ".old"
SELDTYPE  DIM       3
SEQCOUNT  FORM      2
SEQUENCE  FORM      2
NEXTPATN  DIM       127
TRNSFLAG  FORM      1
CATTC     INIT      "tc"
CAT1D     INIT      "1d"
CAT1E     INIT      "1E"
CMDLINE   DIM       127        * Command line instruction
CMDMOVE   INIT      "mv "
CMDFCHK   INIT      "cliweb08.us1 "
TYPEDESC  DIM       11
WAITFLAG  FORM      1
CONSTYES  INIT      "Yes"  * Constant 'Yes' Value
CCNRESON  DIM       20     * Concession Card Type Reason for change
CRDTPDES  DIM       20     * Card Type Description      
UPDTYDES  DIM       10     * Concession Card Update Type Description
SPACEFIV  DIM       5
.
BMIINDIC  DIM       1
NOATTRIB  FORM      1
AUDTATRB  FORM      1
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM2P2   FORM      2.2
FORM2P2A  FORM      2.2
FORM4P2   FORM      4.2
FORM6     FORM      6
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1
BODMASIN  DIM       5
BODMASRN  DIM       60
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
.
CATcH     INIT      "cH"
CATct     INIT      "ct"
CATrt     INIT      "rt"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATVI     INIT      "VI"
.
DVACHAR1  INIT      "QNVTSW"
FUNDDESC  INIT      "Health Fund"
OTHRDESC  INIT      "Other      "
ZERO4     INIT      "0000    "
FORMATTY  FORM      1   * 0=Page, 1=AJAX JSON
FIRSTREC  FORM      1   * First Record Output Flag 0=No 1=Yes
CALLTYPE  FORM      1   * 0=Page, 1=AJAX
.
UPINUMBR  DIM       10       * UPI Number
WEBUSRPM  DIM       30       * Web User Name
.
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.
.----------------------------------------------------------------------
PRGID     INIT      "PATWEB07"
VERSION   INIT      "V12.01.01"
PRGNAM    INIT      "Alternate ID Maintenance"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100,MAIN3200,MAIN3300,MAIN3400,MAIN3500:
                             MAIN3600
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      ALTID000           * Alternate ID Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      TENURS00           * Last 10 UR numbers list
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      ALTAD000           * Alternate ID Address Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      CONCD000           * Concession Card Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      PHOTID00           * Photo ID Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      EXCONT00           * Extra Contact Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      EXPPAY00           * Expected Payor Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      PMRFL000           * Patient Referral Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      PMADC000           * Adverse outcome codes maintenance
          BRANCH    EXIT,MAIN1000      
          CALL      NXTPAG00
          GOTO      MAIN1000
.   
MAIN2000  CALL      VXMAN000           * Visit extension file maintenance
          BRANCH    EXIT,MAIN1000      
          CALL      NXTPAG00
          GOTO      MAIN1000
.   
MAIN2100  CALL      POTD0000           * Patient Outcome Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      PART0000           * Eclipse Participant Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      LOCAN000           * Eclipse Location Id Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      GPAC0000           * GP Access Audit Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      PHSP0000           * Previous Hospital Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2600  CALL      PAYER000           * Payer Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      ATTRIB00           * Patient Attributes
          BRANCH    EXIT,MAIN1000
          MATCH     SP70,NEXTPATN
          IF        @EQUAL
            CALL      NXTPAG00
          ELSE
            CALL      NXTPAT00
          ENDIF
          GOTO      MAIN1000
.
MAIN2800  CALL      RECRN000           * Medical Record Retention
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      MHTRIB00           * MH Patient Attributes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      NDISDT00           * NDIS Patient details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3100  CALL      MULBAT00           * Multi Birth Patient Attributes
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3200  CALL      WSPR0000           * WebServices Participant Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3300  CALL      ATTRID00           * Expected Discharge Date Changed
          BRANCH    EXIT,MAIN1000
          MATCH     SP70,NEXTPATN
          IF        @EQUAL
            CALL      NXTPAG00
          ELSE
            CALL      NXTPAT00
          ENDIF
          GOTO      MAIN1000
.
MAIN3400  CALL      ALTVA000
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3500  CALL      PTFLUP00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3600  CALL      PTFLUL00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINCLS00      * Close DFrame
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATNOBE1,"patnobef"
          OPEN      PATNOBE3,"patnobef"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PMSDUNA1,"pmsdunaf"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSAIDA2,"pmsaidaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSDAAA1,"pmsdaaaf"
          OPEN      PMSETRA1,"pmsetraf"
          OPEN      PMSHCPA1,"pmshcpaf"
.
.          OPEN      PMSIHEA1,"pmsiheaf"
.          OPEN      PMSIPLA1,"pmsiplaf"
          OPEN      PMSGPAA1,"pmsgpaaf"
          OPEN      PMSGPAA2,"pmsgpaaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSEDWA2,"pmsedwaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATPARA1,"patparaf"
          OPEN      PATPKIA1,"patpkiaf"
          OPEN      PATPKIA2,"patpkiaf"
          OPEN      PATPCPA1,"patpcpaf"
          OPEN      PATCRTA1,"patcrtaf"
          OPEN      PATLCNA1,"patlcnaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A2,"patwr1af"
          OPEN      PATWR1A4,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      WEBLURA1,"webluraf"
.
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSADCA1,"pmsadcaf"
          OPEN      PMSOCMA1,"pmsocmaf"
          OPEN      PMSAODA1,"pmsaodaf"
          OPEN      PMSPHSA1,"pmsphsaf"
          OPEN      PMSPODA1,"pmspodaf"
          OPEN      PMSRFLA1,"pmsrflaf"
          OPEN      PMSTLEA1,"pmstleaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSPAYA1,"pmspayaf"
          OPEN      PMSPAYA2,"pmspayaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PRSPMIA1,"prspmiaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      WEBSECA3,"websecaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSREGA4,"pmsregaf"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PATRGMA2,"patrgmaf"
          OPEN      PATMCHG4,"patmchgf"
          OPEN      PMSMUPA1,"pmsmupaf"
          OPEN      PMSALVA1,"pmsalvaf"
          OPEN      PMSALVA2,"pmsalvaf"
          OPEN      IBAALVA1,"ibaalvaf"
          OPEN      IBAALVA2,"ibaalvaf"
          OPEN      WATESPA1,"watespaf"
          OPEN      PATHSPA1,"pathspaf"
.
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN3;*245,CHOSTYP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,NINTY1;*179,CWEBROOT
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          READ      CONTROLF,HUND14;*145,PTCNCLID
          READ      CONTROLF,HUND16;*61,PTCNPRKG
          READ      CONTROLF,HUND29;*61,PTCNWSIN
          READ      CONTROLF,HUND18;*138,PTCNNEWC,*139,PTCNAIWI,*167,PTCNNWCA:
                                    *179,PTCNH7ID
          READ      CONTROLF,HUND20;*132,PTCNUNDW,*137,PTCNHEFR:
                                    *142,PTCNHETO,*147,PTCNOVRW,*152,PTCNOBES:
                                    *158,PTCNUNET
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MATCH     "1",PTCNNWCA
          IF        @EQUAL
            OPEN      PMSAUDCE,"pmsaudce"
            OPEN      PMSAUDC2,"pmsaudce"
          ENDIF
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILAD
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILOC
.
          MOVE      ZERO,NOATTRIB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOATTRIB
          ENDIF
          OPEN      PATATRA3,"patatraf"
          OPEN      PATATRA2,"patatraf"
.
          MOVE      ZERO,AUDTATRB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATCCHA1,"patcchaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,AUDTATRB
          ENDIF
.
          MOVE      ONE,WSPWINDC
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPARA1,"webparaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPCPA1,"webpcpaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPKIA1,"webpkiaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPKIA2,"webpkiaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBETRA1,"webetraf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBB2BA1,"webb2baf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBB2BA3,"webb2baf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSPWINDC
            ENDIF
          ENDIF
.
          MATCH     "3",PTCNUNET
          IF        @EQUAL
            OPEN      PMSNPLA1,"pmsnplaf"
            OPEN      PMSIHEA1,"pmsiheaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMPFLNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEPFL
.
          MATCH     "0",PTCNUNET
          IF        !@EQUAL
            OPEN      PMSIHIA1,"pmsihiaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,REMOTENO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,INACTIVE
.
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,SELDTYPE
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,UPDATETY
          MOVE      ZERO,CALLTYPE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,DPMRFL03
          MOVE      SP70,PMAID002
          MOVE      SP70,FLTRCAPA
          MOVE      SP70,PMAID003
          MOVE      SP70,PMAID004
          MOVE      SP70,PMAID005
          MOVE      SP70,PMCCD002
          MOVE      SP70,PMCCD003
          MOVE      SP70,PMCCD004
          MOVE      SP70,PMCCD005
          MOVE      SP70,PMCCD006
          MOVE      SP70,SPACEFIV
          MOVE      SP70,OLDCCDDT
          MOVE      SP70,OLDCOLOR
          MOVE      SP70,PMDAA001
          MOVE      SP70,PMDAA002
          MOVE      SP70,PMDAA003
          MOVE      SP70,PMDAA004
          MOVE      SP70,PMDAA005
          MOVE      SP70,PMDAA006
          MOVE      SP70,PMDAA007
          MOVE      ZERO,PODCOMTS
          MOVE      ZERO,OCDCOMTS
          MOVE      SP70,ALTIDTYP
          MOVE      SP70,PHOTOPIC
          MOVE      SP70,SHWPRINT
          MOVE      SP70,CASEKEYS
          MOVE      SP70,MOVESEQN
          MOVE      SP70,MOVTOSEQ
          MOVE      ZERO,WAITFLAG
          MOVE      ZERO,TRNSFLAG
          MOVE      ZERO,NEWREGFL
          MOVE      ZERO,CTYPINDC
          MOVE      SP70,CASEUNIQ
          MOVE      SP70,KEYWORDS
          MOVE      ZERO,STARTNUM
          PACK      FILTUSER,SP70
          PACK      FILTGPCD,SP70
          PACK      FILTPPRC,SP70
          PACK      FILTWBGP,SP70
          PACK      PRACCNTR,SP70
          MOVE      ZERO,OTHRCONT
          MOVE      SP70,AUDITKEY
          MOVE      SP70,PMPBR001
          MOVE      SP70,POSTPRFA
          MOVE      SP70,MVMEDREC
.
          CALL      CLPATCCH
          CALL      CPPMCE00
          CALL      CPPMPA00
          CALL      CPPMRF00
          CALL      CPVXTF00
          CALL      CPPMAC00
          CALL      CPPMPO00
          CALL      CPPMHS00
          CALL      CPPMPY00
          CALL      CLRAVB00
.
          MOVE      Z70,PTPAR001
          MOVE      Z70,PTPAR002
          MOVE      Z70,PTPAR003
          MOVE      Z70,PTPAR004
          MOVE      Z70,PTPAR005
          MOVE      Z70,PTPAR006
          MOVE      Z70,PTPAR007
          MOVE      Z70,PTPAR008
.
          MOVE      Z70,PTPCP001
          MOVE      Z70,PTPCP002
          MOVE      Z70,PTPCP003
          MOVE      Z70,PTPCP004
          MOVE      Z70,PTPCP005
          MOVE      Z70,PTPCP006
.
          MOVE      Z70,PTLCN001
          MOVE      Z70,PTLCN002
          MOVE      Z70,PTLCN003
          MOVE      Z70,PTLCN004
.
          MOVE      Z70,PTCRT001
          MOVE      Z70,PTCRT002
          MOVE      Z70,PTCRT003
          MOVE      Z70,PTCRT004
          MOVE      Z70,PTCRT005
.
          MOVE      Z70,PMGPA001
          MOVE      Z70,PMGPA002
          MOVE      Z70,PMGPA003
          MOVE      Z70,PMGPA004
          MOVE      Z70,PMGPA04A
          MOVE      Z70,PMGPA04B
          MOVE      Z70,PMGPA04C
          MOVE      Z70,PMGPA04D
.
          MOVE      Z70,PTFOL001
          MOVE      Z70,PTFOL002
          MOVE      Z70,PTFOL003
          MOVE      Z70,PTFOL004
          MOVE      Z70,PTFOL005
          MOVE      Z70,PTFOL006
          MOVE      Z70,PTFOL007
          MOVE      Z70,PTFOL008
          MOVE      Z70,PTFOL009
          MOVE      Z70,PTFOL010
          MOVE      Z70,PTFOL011
          MOVE      Z70,PTFOL012
          MOVE      Z70,PTFOL013
          MOVE      Z70,PTFOL014
          MOVE      Z70,PTFOL015
          MOVE      Z70,PTFOL016
.
          MOVE      SP70,CRTFRMDT
.
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,BUTTFLAG
          MOVE      ZERO,REGIFLAG
          MOVE      SP70,CPMISKEY
          MOVE      SP70,FILTCTYP
          MOVE      SP70,PTRGM001
.
          MOVE      SP70,FILTUNIT
          MOVE      SP70,FILTCLAM
          MOVE      SP70,FILTPTYP
          MOVE      SP70,FILTDDST
          MOVE      SP70,FILTWARD
          MOVE      SP70,FILTCOUT
          MOVE      SP70,SHOWFLAG
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      ZERO,MXBIL[F3]
            MOVE      ZERO,MXDAY[F3]
            MOVE      SP70,ITMCD[F3]
            MOVE      SP70,RGMCD[F3]
            ADD       ONE,F3
          DO
.
          CALL      CLRATR00
.
          MOVE      SP70,NEXTPATN
          MOVE      SP70,ADMISNID
          MOVE      SP70,EREFRLID
.
          MOVE      Z70,RECRT001
          MOVE      Z70,RECRT002
          MOVE      SP70,UPINUMBR
          MOVE      ZERO,ENTERDAY
          MOVE      ZERO,PROGDAYS
          MOVE      SP70,EREFRLID
          MOVE      SP70,MVITHMVA
          MOVE      SP70,MVITRDIR
          MOVE      SP70,CHCKCOMP
.
CLRPAR99  RETURN
+
.*******************************************************************************
.                 Get GP Access Override Comments
.*******************************************************************************
GETOVR00  MOVE      ZERO,F3
          ADD       ONE,F3
          STORE     QRYDATA,F3,PMGPA04A,PMGPA04B,PMGPA04C,PMGPA04D
.
GETOVR10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETOVR99 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETOVR80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETOVR10 IF EQUAL
          GOTO      GETOVR10 IF EOS
          ADD       ONE,F3
          STORE     QRYDATA,F3,PMGPA04A,PMGPA04B,PMGPA04C,PMGPA04D
          GOTO      GETOVR10
.
GETOVR80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETOVR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "calltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CALLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "seldtype=",QRYNAME
          IF        @EQUAL
            PACK      SELDTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inactive=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INACTIVE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "caseuniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEUNIQ
            PACK      CASEUNIQ,CASEUNIQ,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            PACK      ADMISSNO,ADMISSNO,SP70
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtuser=",QRYNAME
          IF        @EQUAL
            PACK      FILTUSER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtgpcd=",QRYNAME
          IF        @EQUAL
            PACK      FILTGPCD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtpprc=",QRYNAME
          IF        @EQUAL
            PACK      FILTPPRC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtwbgp=",QRYNAME
          IF        @EQUAL
            PACK      FILTWBGP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "praccntr=",QRYNAME
          IF        @EQUAL
            PACK      PRACCNTR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "altidtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALTIDTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pocommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,PODCOMTS
            CALL      GETPOD00              * Read in Adm Comments
          ENDIF
.
          MATCH     "occommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,OCDCOMTS
            CALL      GETOCM00              * Read in Adm Comments
          ENDIF
.
          MATCH     "dpmrfl03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DPMRFL03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmaid002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMAID002
            PACK      PMAID002,PMAID002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmaid003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMAID003
            PACK      PMAID003,PMAID003,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmaid004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMAID004
            PACK      PMAID004,PMAID004,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmaid005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMAID005
            PACK      PMAID005,PMAID005,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newregfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWREGFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctypindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CTYPINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA001
            PACK      PMDAA001,PMDAA001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA002
            PACK      PMDAA002,PMDAA002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA003
            PACK      PMDAA003,PMDAA003,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA004
            PACK      PMDAA004,PMDAA004,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA005
            PACK      PMDAA005,PMDAA005,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa006=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA006
            PACK      PMDAA006,PMDAA006,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaa007=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAA007
            PACK      PMDAA007,PMDAA007,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmccd002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMCCD002
            PACK      PMCCD002,PMCCD002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmccd003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMCCD003
            PACK      PMCCD003,PMCCD003,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmccd004=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            UNPACK    QRYDATA,KEY8,KEY3
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,PMCCD004
            ELSE
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00            * Set CMON from MTHNAM3
              PACK      PMCCD004,CCENT,CYEAR,CMON,CDAY
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmccd005=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMCCD005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmccd006=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMCCD006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldccddt=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            UNPACK    QRYDATA,KEY8,KEY3
            MATCH     SP70,KEY3
            IF        @EQUAL
              MOVE      QRYDATA,OLDCCDDT
            ELSE
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00            * Set CMON from MTHNAM3
              PACK      OLDCCDDT,CCENT,CYEAR,CMON,CDAY
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oldcolor=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            UNPACK    QRYDATA,OLDCOLOR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "photopic=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHOTOPIC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmadc",QRYNAME
          IF        @EQUAL
            CALL      SPADC000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmpod",QRYNAME
          IF        @EQUAL
            CALL      SPPOD000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmcex",QRYNAME
          IF        @EQUAL
            CALL      SPPMC000          
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmpay",QRYNAME
          IF        @EQUAL
            CALL      SPPMP000          
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "shwprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "moveseqn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVESEQN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "movtoseq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVTOSEQ
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            PACK      STARTKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmrfl",QRYNAME
          IF        @EQUAL
            CALL      SPPMR000          
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmsvx",QRYNAME
          IF        @EQUAL
            CALL      SPVXTF00          
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmphs",QRYNAME
          IF        @EQUAL
            CALL      SPPHS000          
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptpar",QRYNAME
          IF        @EQUAL
            CALL      SPTPAR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptpcp",QRYNAME
          IF        @EQUAL
            CALL      SPTPCP00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrcapa=",QRYNAME
          IF        @EQUAL
            PACK      FLTRCAPA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptlcn",QRYNAME
          IF        @EQUAL
            CALL      SPTLCN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcrt",QRYNAME
          IF        @EQUAL
            CALL      SPTCRT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmgpa",QRYNAME
          IF        @EQUAL
            CALL      SPMGPA00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptfol",QRYNAME
          IF        @EQUAL
            CALL      SPTFOL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crtfrmdt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CRTFRMDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "buttflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BUTTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regiflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REGIFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpmiskey=",QRYNAME
          IF        @EQUAL
            PACK      CPMISKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "othrcont=",QRYNAME
          IF        @EQUAL
            PACK      OTHRCONT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtctyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTCTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtunit=",QRYNAME
          IF        @EQUAL
            PACK      FILTUNIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclam=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtptyp=",QRYNAME
          IF        @EQUAL
            PACK      FILTPTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtddst=",QRYNAME
          IF        @EQUAL
            PACK      FILTDDST,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtward=",QRYNAME
          IF        @EQUAL
            PACK      FILTWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtcout=",QRYNAME
          IF        @EQUAL
            PACK      FILTCOUT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag",QRYNAME
          IF        @EQUAL
            PACK      SHOWFLAG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "auditkey=",QRYNAME
          IF        @EQUAL
            PACK      AUDITKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpyr",QRYNAME
          IF        @EQUAL
            CALL      SPPMPY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTRGM001
            PACK      PTRGM001,PTRGM001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mxbil",QRYNAME
          IF        @EQUAL
            CALL      STAMAX00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mxday",QRYNAME
          IF        @EQUAL
            CALL      STADAY00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpbr001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMPBR001
            SQUEEZE   PMPBR001
            MOVE      PMPBR001,F3
            MOVE      F3,PMPBR001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "nextpatn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisnid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EREFRLID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "postprfa=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,POSTPRFA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recrt001=",QRYNAME
          IF        @EQUAL
            PACK      RECRT001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recrt002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      RECRT002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvmedrec=",QRYNAME
          IF        @EQUAL
            PACK      MVMEDREC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upinumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPINUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmalv",QRYNAME
          IF        @EQUAL
            CALL      SMALVB00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "enterday=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENTERDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "progdays=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,PROGDAYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "attrdate=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            PACK      ATTRDATE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "attrtime=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            PACK      ATTRTIME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvithmva=",QRYNAME
          IF        @EQUAL
            PACK      MVITHMVA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvitrdir=",QRYNAME
          IF        @EQUAL
            PACK      MVITRDIR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckcomp=",QRYNAME
          IF        @EQUAL
            PACK      CHCKCOMP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Maximum Billing item amount
.------------------------------------------------------------
STAMAX00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STAMAX99 IF EQUAL
          MOVE      QRYDATA,MXBIL[F3]
          MOVE      F3,LASTITEM
STAMAX99  RETURN
+
.------------------------------------------------------------
. Set parameters for Per day item amount
.------------------------------------------------------------
STADAY00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STADAY99 IF EQUAL
          MOVE      QRYDATA,MXDAY[F3]
STADAY99  RETURN
+
.------------------------------------------------------------
. GETPOD00 - Get Patient Outcome Comments
.------------------------------------------------------------
.
GETPOD00  PREP      COMPODAF,COMFILAD
          MOVE      ONE,F3
          WRITE     COMPODAF,SEQ;QRYDATA
.
GETPOD10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPOD90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETPOD80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMPODAF,SEQ;QRYDATA
          GOTO      GETPOD10
.
GETPOD80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPOD90  
          OPEN      COMPODAF,COMFILAD
.
GETPOD99  RETURN
+
.------------------------------------------------------------
. GETOCM00 - Get Outcome Comments 
.------------------------------------------------------------
.
GETOCM00  PREP      COMOCMAF,COMFILOC
          MOVE      ONE,F3
          WRITE     COMOCMAF,SEQ;QRYDATA
.
GETOCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETOCM90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETOCM80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMOCMAF,SEQ;QRYDATA
          GOTO      GETOCM10
.
GETOCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETOCM90  OPEN      COMOCMAF,COMFILOC
.
GETOCM99  RETURN
+
.------------------------------------------------------------
. Alternate ID Maintenance
.------------------------------------------------------------
ALTID000  MOVE      ZERO,EXIT
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ALTID910
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY18,WBSEUID,PRGID
          CALL      RDWBST1
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
.
          MATCH     SP70,UPDTTYPE
          GOTO      ALTID500 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add new ID
          GOTO      ALTID100 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete ID
          GOTO      ALTID200 IF EQUAL
.
          GOTO      ALTID900
.
ALTID100  CALL      ADDID000        * Add new ID
          GOTO      ALTID999
.
ALTID200  CALL      DELID000        * Delete ID
          GOTO      ALTID999
.
ALTID500  
.
.         MATCH     SP70,ADMISSNO
.         GOTO      ALTID510 IF EQUAL
.
.         MOVE      ADMISSNO,KEY8   * Read Visit File
.         CALL      RDVISA1
.         BRANCH    OVRCD,ALTID920
.
ALTID510  CLEAR     WEBTITLE
          MOVE      "Alternate ID Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALTID999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALTID999
.
ALTID900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTID999
.
ALTID910  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTID999
.
ALTID920  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTID999
.
ALTID999  RETURN
.------------------------------------------------------------
. ALTVA000 - Alternative visit audit Maintainance
.---------------------------------------------------------------------
ALTVA000  MOVE      ZERO,EXIT
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ALTVA910
.
          MATCH     SP70,ADMISSNO
          GOTO      ALTVA920 IF EQUAL
.
          MATCH     SP70,UPDTTYPE
          GOTO      ALTVA500 IF EQUAL       * Display
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      ALTVA100 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      ALTVA200 IF EQUAL
.
ALTVA100  PACK      KEY8,ADMISSNO,SP70      *Check if record already exist in IBAALVFD 
          CALL      RDIBALV1
          COMPARE   ZERO,OVRCD
          GOTO      ALTVA930 IF EQUAL       * already exist in IBAALVFD
.
          CALL      ADEVN000
          GOTO      ALTVA999     
.
ALTVA200  PACK      KEY28,PMALV002,ADMISSNO,SP70
          CALL      RDIBALV2
          BRANCH    OVRCD,ALTVA940      
.
          CALL      DEIBALV2   * Delete from IBAALVAF table
          MOVE      SP70,PMVAVISN
          MOVE      SP70,PMVAAVIS
          MOVE      SP70,PMVATYPE
          MOVE      SP70,PMVADATE
          MOVE      SP70,PMVATIME
          MOVE      SP70,PMVACUID
          MOVE      SP70,PMVAACTN
          MOVE      SP70,PMVACOMM
          MOVE      SP70,PMVASPAR
          CALL      MVALVB00   * move CGI variable into file variable         
.
          MOVE      ADMISSNO,PMVAVISN
          MOVE      "2",PMVAACTN
          PACK      PMVADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMVADATE                * System date
          CLOCK     TIME,PMVATIME                * System time
          MOVE      USERID,PMVACUID              * web user id
          CALL      RAPMALV1
          IF        OVRCD=1
           CALL      WRPMALV1        * Write to PMSALVFD table
          ENDIF
.
          MOVE      ZERO,EXIT    
          GOTO      ALTVA999
.
ALTVA500  CLEAR     WEBTITLE
          MOVE      "Alternate Visit ID Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALTVA999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALTVA999
.
ALTVA910  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTVA999
.
ALTVA920  MOVE      "No Visit is Selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTVA999
.
ALTVA930  MOVE      "Can't Add Record already in the file ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTVA999
.
ALTVA940  MOVE      "Can't Delete. Record does not exist ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTVA999

.
ALTVA999  RETURN
.------------------------------------------------------------
. ADEVN000 - Write a new alternate ID record in ibaalvaf and pmsalvaf
.---------------------------------------------------------------------
ADEVN000  MOVE      ADMISSNO,IBAVVISN
          MOVE      PMALV002,IBAVAVIS
          MOVE      PMALV003,IBAVTYPE
          CALL      WRIBALV1        * Write to IBAALVFD table
.
          MOVE      SP70,PMVAVISN
          MOVE      SP70,PMVAAVIS
          MOVE      SP70,PMVATYPE
          MOVE      SP70,PMVADATE
          MOVE      SP70,PMVATIME
          MOVE      SP70,PMVACUID
          MOVE      SP70,PMVAACTN
          MOVE      SP70,PMVACOMM
          MOVE      SP70,PMVASPAR
.
          CALL      MVALVB00        * move CGI variable into file variable
          MOVE      ADMISSNO,PMVAVISN
          MOVE      "1",PMVAACTN
          PACK      PMVADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMVADATE                * System date
          CLOCK     TIME,PMVATIME                * System time
          MOVE      USERID,PMVACUID              * web user id
          CALL      RAPMALV1
          IF        OVRCD=1
            CALL      WRPMALV1        * Write to PMSALVFD table        
          ENDIF
.   
          MOVE      ZERO,EXIT
          GOTO      ADEVN999
.         PACK      IBAVTYPE - RECORD TYPE - " ","0"-LEGACY "1" -eRefferral
ADEVN999  RETURN
.------------------------------------------------------------
. ADDID000 - Write a new alternate ID record
.---------------------------------------------------------------------
ADDID000  CALL      VIHI0000           * Validate only one active IHI number
          BRANCH    EXIT,ADDID999
.
          CALL      VUPI0000           * Validate only one UPI number
          BRANCH    EXIT,ADDID999
.
          PACK      PMAIURNO,URNUMBER,SP70
          PACK      PMAITYPE,PMAID002,SP70
          PACK      PMAIALID,PMAID003,SP70
          PACK      PMAIDISU,PMAID004,SP70
          PACK      PMAIHOSP,PMAID005,SP70
          UNPACK    SP70,PMAIVSTA,PMAIASTA,PMAIADAT,PMAIATIM
          MOVE      SP70,PMAISURN
          MOVE      SP70,PMAIGIVN
.
          CALL      SETALT00
          BRANCH    EXIT,ADDID999
.
          MOVE      PMAIALID,SAVALID
          PACK      KEY31,PMAIALID,SP70
          CALL      RSPMAID2
          CALL      RKPMAID2
          IF        OVRCD<>1
            MATCH     SAVALID,PMAIALID
            GOTO      ADDID910 IF EQUAL
          ENDIF
.
          PACK      PMAIURNO,URNUMBER,SP70
          PACK      PMAITYPE,PMAID002,SP70
          PACK      PMAIALID,PMAID003,SP70
          PACK      PMAIDISU,PMAID004,SP70
          PACK      PMAIHOSP,PMAID005,SP70
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          PACK      PMAISPAR,SP70
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
.
          CALL      SETALT00
          BRANCH    EXIT,ADDID999
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      ADDID900
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
.         CALL      WIHI0000                   * Write IHI audit and validte IHI
.
          CALL      WRPMAID1
.  write nsw edw record for UPI added
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSU,TCINDC4
            IF        @EQUAL
              PACK      PMEWURNO,PMAIURNO
              MOVE      "16",PMEWTYPE
              PACK      PMEWOLDV,SP70
              PACK      PMEWNEWV,PMAIURNO,PMAITYPE,PMAIALID,SP70
              CALL      WREDW000
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * send PMI update message
          GOTO      ADDID999
.
ADDID900  MOVE      "Alternate ID already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
ADDID910  CALL      OIHI0000           * Write IHI exception record
          CLEAR     WEBTITLE
          APPEND    "Error: Alternate ID already exists for UR",WEBTITLE
          APPEND    PMAIURNO,WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
ADDID999  RETURN
+
.------------------------------------------------------------
. SETALT00 - Set an alternate ID UR number
.---------------------------------------------------------------------
SETALT00  MOVE      ZERO,EXIT
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETALT90
.
          MATCH     "3",PTCNUNET
          IF        @EQUAL
            MATCH     ANSI,TCINDC2                 * IHI Number
            IF        @EQUAL
              MOVE      TWO,PMAIVSTA               * Set to manual
              MOVE      ONE,PMAIASTA               * Set to active
              RJUSTIFY  PMAIALID
              GOTO      SETALT99
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNAIWI
          IF        !@EQUAL
            MATCH     SP70,TCINDC1
            GOTO      SETALT95 IF EQUAL
          ENDIF
.         PACK      DIM20,TCINDC1,PMAIALID,SP70
.
          CLEAR     DIM21
          APPEND    TCINDC1,DIM21
          MATCH     TCINDC3,SP1
          GOTO      SETALT10 IF EOS
          GOTO      SETALT10 IF EQUAL
.
          APPEND    TCINDC3,DIM21
SETALT10  APPEND    PMAIALID,DIM21
          RESET     DIM21
          SQUEEZE   DIM21
          MOVE      DIM21,PMAIALID
          RJUSTIFY  PMAIALID
          GOTO      SETALT99
.
SETALT90  MOVE      "Invalid Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
SETALT95  MOVE      "Indicator not set up for Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
SETALT99  RETURN
+
.---------------------------------------------------------------------
. VIHI0000 - Check U/R doesn't already have an active IHI
.---------------------------------------------------------------------
VIHI0000  MATCH     "3",PTCNUNET
          GOTO      VIHI8000 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VIHI8000
.
          MATCH     ANSI,TCINDC2                 * Adding an IHI Number
          GOTO      VIHI8000 IF NOT EQUAL
.
          PACK      KEY31,URNUMBER,SP70
          CALL      RSPMAID1
VIHI1000  CALL      RKPMAID1
          BRANCH    OVRCD,VIHI8000
.
          MATCH     PMAIURNO,URNUMBER
          GOTO      VIHI8000 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VIHI1000
.
          MATCH     ANSI,TCINDC2                 * IHI Number
          GOTO      VIHI1000 IF NOT EQUAL
.
          MATCH     "1",PMAIASTA                 * Active
          GOTO      VIHI9000 IF EQUAL
.
          GOTO      VIHI9000
.
VIHI8000  MOVE      ZERO,EXIT
          GOTO      VIHI9999
.
VIHI9000  UNPACK    SP70,DIM4,DIM4A,DIM4B,DIM4C
          SQUEEZE   PMAIALID
          UNPACK    PMAIALID,DIM4,DIM4A,DIM4B,DIM4C
          PACK      KEY19,DIM4,SP1,DIM4A,SP1,DIM4B,SP1,DIM4C,SP70
.
          CLEAR     WEBTITLE
          APPEND    "Patient has an existing Active IHI Number : ",WEBTITLE
          APPEND    KEY19,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
VIHI9999  RETURN
+
.---------------------------------------------------------------------
. OIHI0000 - Write IHI exception record. IHI exits on another U/R
.---------------------------------------------------------------------
OIHI0000  MATCH     "3",PTCNUNET
          GOTO      OIHI9999 IF NOT EQUAL
.
          MATCH     PMAIURNO,PURNO               * Exit if this U/R
          GOTO      OIHI9999 IF EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OIHI9999
.
          MATCH     ANSI,TCINDC2                 * Adding an IHI Number
          GOTO      OIHI9999 IF NOT EQUAL
.
          MOVE      PURNO,PMIEURNO      * U/R Number
          MOVE      PMAIALID,DIM20
          LJUSTIFY  DIM20
          PACK      PMIEIHIN,DIM20,SP70 * IHI Number
.          MOVE      PMAIURNO,PMIEOTUR   * Other U/R IHI Number Combination
          PACK      PMIEOTUR,PMAIURNO,SP70
          MOVE      PMAIADAT,PMIEADAT   * Date of Assignment (CCYYMMDD)
          MOVE      PMAIATIM,PMIEATIM   * Time of Assignment (HH:MM:SS)
          MOVE      PMAIVSTA,PMIEVSTA   * IHI Verification Status
          MOVE      PMAIASTA,PMIEASTA   * IHI Activation Status
          MOVE      SP70,PMIEIHIS       * IHI Source
          MOVE      SP70,PMIEHISV       * HI Service Version Number
          MOVE      SP70,PMIEMESI       * HI Service Message ID
          CALL      IBACLOCK
          PACK      PMIECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMIECDAT            * Created Date (CCYYMMDD)
          MOVE      CTIMEIS,PMIECTIM   * Created Time (HH:MM:SS)
          MOVE      WBSEUID,PMIECUID   * Created By (websecaf)
          PACK      PMIEUDAT,SP70      * Updated date (CCYYMMDD)
          MOVE      SP70,PMIEUTIM      * Updated Time (HH:MM:SS)
          MOVE      SP70,PMIEUUID      * Updated By (websecaf)
          MOVE      SP70,PMIESPAR      * Spare
.
          PACK      KEY72,PMIEURNO,PMIEIHIN,PMIEOTUR,PMIEADAT,PMIEATIM,SP70
          CALL      RAPMIHE1
          IF        OVRCD=1
            CALL      WRPMIHE1
          ENDIF
.
OIHI9999  RETURN
+
.---------------------------------------------------------------------
. WIHI0000 - Write add manual record to IHI details file
.            and auto request IHI validation        
.---------------------------------------------------------------------
WIHI0000  MATCH     "3",PTCNUNET
          GOTO      WIHI9999 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WIHI9999
.
          MATCH     ANSI,TCINDC2                 * Adding an IHI Number
          GOTO      WIHI9999 IF NOT EQUAL
.
          MOVE      PURNO,PMIHURNO     * U/R Number
          MOVE      PMAIALID,PMIHIHIN  * IHI Number
          LJUSTIFY  PMIHIHIN
          MOVE      PMAICRDT,PMIHADAT  * Date of Assignment (CCYYMMDD)
          MOVE      PMAICRTM,PMIHATIM  * Time of Assignment (HH:MM:SS)
          MOVE      PMAIVSTA,PMIHVSTA  * IHI Verification Status
          MOVE      PMAIASTA,PMIHASTA  * IHI Activation Status
          MOVE      SP70,PMIHSTAT      * Status
          MOVE      SP70,PMIHOURN      * Old U/R Number
          MOVE      THREE,PMIHIHIS     * IHI Source
          MOVE      SP70,PMIHHISV      * HI Service Version Number
          MOVE      SP70,PMIHMESI      * HI Service Message ID
          MOVE      SP70,PMIHBATI      * Batch ID
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,PMIHINTB      * Request Initiated By
          ELSE
            MOVE      SP70,PMIHINTB          * Request Initiated By
          ENDIF
.
          MOVE      SP70,PMIHNUID      * HPI-I User
          MOVE      PMAICRDT,PMIHCDAT  * Created Date (CCYYMMDD)
          MOVE      PMAICRTM,PMIHCTIM  * Created Time (HH:MM:SS)
          MOVE      PMAICRUD,PMIHCUID  * Created By (websecaf)
          MOVE      PMAIUPDT,PMIHUDAT  * Updated Date (CCYYMMDD)
          MOVE      PMAIUPTM,PMIHUTIM  * Updated Time (HH:MM:SS)
          MOVE      PMAIUPUD,PMIHUUID  * Updated By (websecaf)
          MOVE      SP70,PMIHSPAR      * Spare
.
          PACK      KEY46,PMIHURNO,PMIHIHIN,PMIHVSTA,PMIHASTA,SP70
          CALL      RAPMIHI1
          IF        OVRCD=1
            CALL      WRPMIHI1
          ENDIF
.
.          MOVE      "01",KEY2              * IHI Validation
.          PACK      KEY11,USERID,SP70    * User ID
.          PACK      KEY50,PURNO,SP70
.          CALL      WIPL0000               * Write to polling table
.
          MOVE      "07",IREQTYPE
          CALL      WPMNPL00               * Write to NIHC IHI polling
.
WIHI9999  RETURN

+
.******************************************************************************
.*                                  RJUS0000                                  *
.*                            Right Justify The Code                          *
.******************************************************************************
RJUS0000  PACK      RJUSCODE,SP70,SP70
          RESET     LJUSCODE,JUSTNO
          MOVE      ZERO,CHRCOUNT
RJUS1000  CMATCH    SP1,LJUSCODE
          GOTO      RJUS2000 IF NOT EQUAL
.
          ADD       ONE,CHRCOUNT
          BUMP      LJUSCODE,-1
          GOTO      RJUS2000 IF EOS
.
          COMPARE   JUSTNO,CHRCOUNT
          GOTO      RJUS1000 IF LESS
.
RJUS2000  RESET     LJUSCODE
          CLEAR     RJUSCODE
          RESET     RJUSCODE,CHRCOUNT
          APPEND    LJUSCODE,RJUSCODE
          RESET     RJUSCODE
.
RJUS9000  MOVE      ZERO,EXIT
RJUS9999  RETURN
+
.---------------------------------------------------------------------
. VUPI0000 - Check U/R doesn't already have a NSLHD UPI alternate ID
.---------------------------------------------------------------------
VUPI0000  PACK      KEY5,ANSA,ANSI,PMAID002,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VUPI8000
.
          MATCH     ANSU,TCINDC4                 * Adding an UPI ?
          GOTO      VUPI8000 IF NOT EQUAL
.
          PACK      KEY31,URNUMBER,SP70
          CALL      RSPMAID1
VUPI1000  CALL      RKPMAID1
          BRANCH    OVRCD,VUPI8000
.
          MATCH     PMAIURNO,URNUMBER
          GOTO      VUPI8000 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VUPI1000
.
          MATCH     ANSU,TCINDC4                 * UPI exists ?
          GOTO      VUPI1000 IF NOT EQUAL
.
          GOTO      VUPI9000
.
VUPI8000  MOVE      ZERO,EXIT
          GOTO      VUPI9999
.
VUPI9000  CLEAR     WEBTITLE
          APPEND    "This Alternate ID type already exists. Please select a different Type.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VUPI9999
VUPI9999  RETURN
+
.------------------------------------------------------------
. DELID000 - Delete an alternate ID record
.---------------------------------------------------------------------
DELID000  PACK      PMAIURNO,URNUMBER,SP70
          PACK      PMAITYPE,PMAID002,SP70
          PACK      PMAIALID,PMAID003,SP70
          PACK      PMAIDISU,PMAID004,SP70
          PACK      PMAIHOSP,PMAID005,SP70
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RDPMAID1
          IF        OVRCD<>1
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SEVEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                   * send PMI update message
.
.            CALL      DEPMAID1                  * Check if an NIHC IHI Number first
.                                                * commented out and called 
.                                                * further down
            CALL      MUPI0000                   * write to Missing UPI table
.  write nsw edw record for UPI changed
            PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSU,TCINDC4
              IF        @EQUAL
                PACK      PMEWURNO,PMAIURNO
                MOVE      "16",PMEWTYPE
                PACK      PMEWOLDV,SP70
                PACK      PMEWNEWV,PMAIURNO,PMAITYPE,PMAIALID,SP70
                CALL      WREDW000
              ENDIF
.
              MATCH     "3",PTCNUNET
              IF        @EQUAL
                MATCH     ANSI,TCINDC2
                IF        @EQUAL
                  MOVE      "08",IREQTYPE            
                  CALL      WPMNPL00               * Write to NIHC IHI polling
                  GOTO      DELID999
                ENDIF
              ENDIF
.  
            ENDIF
.
            CALL      DEPMAID1
.
          ENDIF
.
DELID999  RETURN
+
.------------------------------------------------------------
. Write out pmsnplaf record
.------------------------------------------------------------
WPMNPL00  MATCH     "3",PTCNUNET
          GOTO      WPMNPL99 IF NOT EQUAL
.
          CALL      CLPMSNPL
.
          MOVE      IREQTYPE,PMNPRTYP
          MOVE      URNUMBER,PMNPURNO
WPMNPL10  CALL      IBACLOCK
          PACK      PMNPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPRDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMNPRTIM
          MOVE      "   1",PMNPCNTR
.
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,PMNPHOSP
          ELSE
            OPEN      PATHSPA1,"pathspaf"
.
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD=0
              MOVE      PTHSHOSP,PMNPHOSP
            ENDIF
          ENDIF
.
          MOVE      USERID,PMNPRUID
          MOVE      "0",PMNPRSTA
          MOVE      PMNPRDAT,PMNPCDAT
          MOVE      PMNPRTIM,PMNPCTIM
          MOVE      PMNPRUID,PMNPCUID
.
          PACK      KEY28,PMNPURNO,PMNPRDAT,PMNPRTIM,PMNPCNTR,SP70
          CALL      RAPMNPL1
          COMPARE   ZERO,OVRCD
          GOTO      WPMNPL10 IF EQUAL
.
          CALL      WRPMNPL1
.
WPMNPL99  RETURN
+
.------------------------------------------------------------------------------
. write to the Missing UPI Table
.------------------------------------------------------------------------------
MUPI0000   MOVE       PMAIURNO,KEY8
           CALL       RDPMMUP1
           COMPARE    ZERO,OVRCD
           GOTO       MUPI9999 IF EQUAL         * already exist
.
           MOVE       PMAIURNO,PMMUURNO         * U/R number
           MOVE       USERID,PMMUCUID           * web user id
           PACK       PMMUCDAT,CCC,CYY,CMM,CDD
           REP        " 0",PMMUCDAT             * Created Date (CCYYMMDD)
           CLOCK      TIME,PMMUCTIM             * System time
           UNPACK     SP70,PMMUUASS,PMMUDASS,PMMUTASS,PMMUSPAR
           CALL       WRPMMUP1
.
MUPI9999  RETURN
+
.------------------------------------------------------------------------------
. Last 10 UR Numbers
.------------------------------------------------------------------------------
TENURS00  PACK      KEY10,USERID,SP70
          CALL      RDWBLUR1
          BRANCH    OVRCD,TENURS90
.         
          CLEAR     WEBTITLE
          MOVE      "Last Twenty U/R's",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,TENURS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      TENURS99
.
TENURS90  MOVE      "There is no UR access history for current user.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TENURS99
.
TENURS99  RETURN
+
.------------------------------------------------------------------------------
. Inpatient Follow Up List
.------------------------------------------------------------------------------
PTFLUL00  CLEAR     WEBTITLE
          MOVE      "Patient Follow Up List",WEBTITLE
          RESET     WEBTITLE
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PTFLUL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PTFLUL99
.
PTFLUL90  MOVE      "There is no UR access history for current user.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTFLUL99
.
PTFLUL99  RETURN
+
.------------------------------------------------------------------------------
. Photo ID Maintenance
.------------------------------------------------------------------------------
PHOTID00  MOVE      ZERO,EXIT
          MATCH     SP70,UPDTTYPE
          GOTO      PHOTID50 IF EQUAL
.
          MATCH     SP70,PHOTOPIC
          GOTO      PHOTID50 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update
          GOTO      PHOTID10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete
          GOTO      PHOTID20 IF EQUAL
.
          GOTO      PHOTID90
.
.         Add Photo ID
.         ------------
PHOTID10  SCAN      "filename",PHOTOPIC
          GOTO      PHOTID90 IF EQUAL
          SCAN      ".",PHOTOPIC
          GOTO      PHOTID90 IF NOT EQUAL
          RESET     PHOTOPIC
.
          MOVE      "images/patients/",PHOTODIR
          STRIP     CWEBROOT
          MOVE      URNUMBER,DIM8
          SQUEEZE   DIM8
          STRIP     PHOTOPIC
          PACK      CMDLINE,CMDFCHK,USERID,SP1,PHOTOPIC,SP1,DIM8,PHOTOEXT
          EXECUTE   CMDLINE,TASKID
          PACK      CMDLINE,CMDMOVE,PHOTOPIC,SP1,CWEBROOT,PHOTODIR,DIM8,PHOTOEXT
          EXECUTE   CMDLINE,TASKID
          GOTO      PHOTID99
.
.         Delete Photo ID
.         ---------------
PHOTID20  MOVE      "images/patients/",PHOTODIR
          STRIP     CWEBROOT
          MOVE      URNUMBER,DIM8
          SQUEEZE   DIM8
          PACK      CMDLINE,CMDMOVE,CWEBROOT,PHOTODIR,DIM8,PHOTOEXT,SP1,CWEBROOT,PHOTODIR,DIM8,PHOTOOLD
          EXECUTE   CMDLINE,TASKID
          GOTO      PHOTID99
.
PHOTID50  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PHOTID90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Photo ID Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PHOTID99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PHOTID99
.
PHOTID90  MOVE      "Unable to add photo.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHOTID99
.
PHOTID99  RETURN
+
.------------------------------------------------------------
. Alternate ID Address Maintenance
.------------------------------------------------------------
ALTAD000  CALL      CLRADD00
          MATCH     SP70,UPDTTYPE
          GOTO      ALTAD500 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add new Address
          GOTO      ALTAD100 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Delete Address
          GOTO      ALTAD150 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete Address
          GOTO      ALTAD200 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote Address
          GOTO      ALTAD210 IF EQUAL
.
          GOTO      ALTAD900
.
ALTAD100  CALL      ADDAD000        * Add new Address
          GOTO      ALTAD999
.
ALTAD150  CALL      UPDAD000        * Update Address
          GOTO      ALTAD999
.
ALTAD200  CALL      DELAD000        * Delete Address
          GOTO      ALTAD999
.
ALTAD210  CALL      REMOTE00        * Remote Script for address
          MOVE      ONE,EXIT
          GOTO      ALTAD999
.
ALTAD500  MATCH     SP70,PMDAA001
          GOTO      ALTAD510 IF EQUAL
.
          MOVE      PMDAA001,KEY3   * Read File
          CALL      RDPMDAA1
          BRANCH    OVRCD,ALTAD910
.
ALTAD510  CLEAR     WEBTITLE
          MOVE      "Alternate ID Address Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALTAD999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALTAD999
.
ALTAD900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTAD999
.
ALTAD910  MOVE      "Missing Default Address Record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALTAD999
.
ALTAD999  RETURN
.------------------------------------------------------------
. Clear Alternate ID Address Maintenance
.------------------------------------------------------------
CLRADD00  UNPACK    SP70,PMDATYPE
          UNPACK    SP70,PMDAADD1
          UNPACK    SP70,PMDAADD2
          UNPACK    SP70,PMDAADD3
          UNPACK    SP70,PMDAADD4
          UNPACK    SP70,PMDAPOST
          UNPACK    SP70,PMDAPHON
          RETURN
.------------------------------------------------------------
. ADDAD000 - Write a new alternate ID address record
.---------------------------------------------------------------------
ADDAD000  PACK      PMDATYPE,PMDAA001,SP70
          PACK      PMDAADD1,PMDAA002,SP70
          PACK      PMDAADD2,PMDAA003,SP70
          PACK      PMDAADD3,PMDAA004,SP70
          PACK      PMDAADD4,PMDAA005,SP70
          PACK      PMDAPOST,PMDAA006,SP70
          PACK      PMDAPHON,PMDAA007,SP70
          PACK      KEY3,PMDATYPE,SP70
.
          CALL      RAPMDAA1
          IF        OVRCD<>1
            GOTO      ADDAD999
          ENDIF
.
          CALL      WRPMDAA1
.
ADDAD999  RETURN
+
.------------------------------------------------------------
. UPDAD000 - Update an alternate ID address record
.---------------------------------------------------------------------
UPDAD000  PACK      PMDATYPE,PMDAA001,SP70
          PACK      PMDAADD1,PMDAA002,SP70
          PACK      PMDAADD2,PMDAA003,SP70
          PACK      PMDAADD3,PMDAA004,SP70
          PACK      PMDAADD4,PMDAA005,SP70
          PACK      PMDAPOST,PMDAA006,SP70
          PACK      PMDAPHON,PMDAA007,SP70
          PACK      KEY3,PMDATYPE,SP70
.
          CALL      RAPMDAA1
          BRANCH    OVRCD,UPDAD900
.
          CALL      UPPMDAA1
          GOTO      UPDAD999
.
UPDAD900  MOVE      "Missing Address Record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDAD999
.
UPDAD999  RETURN
+
.------------------------------------------------------------
. DELAD000 - Delete an alternate ID Address record
.---------------------------------------------------------------------
DELAD000  PACK      PMDATYPE,PMDAA001,SP70
          PACK      KEY3,PMDATYPE,SP70
.
          CALL      RDPMDAA1
          IF        OVRCD<>1
            CALL      DEPMDAA1
          ENDIF
.
DELAD999  RETURN
+
.------------------------------------------------------------
. Concession Card Maintenance
.------------------------------------------------------------
CONCD000  MOVE      ZERO,EXIT
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CONCD910
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,UPDTTYPE
          GOTO      CONCD500 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add
          GOTO      CONCD100 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete
          GOTO      CONCD200 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update
          GOTO      CONCD300 IF EQUAL
.
          GOTO      CONCD900
.
CONCD100  CALL      ADDCD000        * Add concession card
          GOTO      CONCD999
.
CONCD200  CALL      DELCD000        * Delete concession card
          GOTO      CONCD999
.
CONCD300  CALL      UPDCD000        * Update concession card
          GOTO      CONCD999
.
CONCD500  MATCH     SP70,PMCCD002
          GOTO      CONCD510 IF EQUAL
.
          PACK      KEY19,URNUMBER,PMCCD004,PMCCD002
          CALL      RDPMCCD1
          BRANCH    OVRCD,CONCD920
.
CONCD510  CLEAR     WEBTITLE
          MOVE      "Concession Card Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CONCD999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      CONCD999
.
CONCD900  MOVE      "Invalid Form Action. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CONCD999
.
CONCD910  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CONCD999
.
CONCD920  MOVE      "Can't find Concession Card Details. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CONCD999
.
CONCD999  IF        CALLTYPE=1    
            CALL      AJXEND00       * AJAX Request
          ENDIF
          RETURN
.------------------------------------------------------------
. Show Error Based on Call Type.  0=Page, 1=AJAX
.------------------------------------------------------------
SHWERR00  IF        CALLTYPE=0
            CALL      WEBERR00
          ELSE
            CALL      AJXERR00
          ENDIF
          RETURN
.------------------------------------------------------------------------------
. Remote Update Completed
.------------------------------------------------------------------------------
AJXEND00  BRANCH    EXIT,AJXEND99 * Error returned
          CALL      XMLHED00
          BRANCH    EXIT,AJXEND99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>OK</RETURN_VALUE>"
          CALL      XMLEND00
          MOVE      ONE,EXIT   * Branch Main Line to Next Request
AJXEND99  RETURN
.
.------------------------------------------------------------------------------
. Remote Update Error
.------------------------------------------------------------------------------
AJXERR00  CALL      XMLHED00
          BRANCH    EXIT,AJXERR99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>",WEBTITLE,"</RETURN_VALUE>"
          CALL      XMLEND00
          MOVE      ONE,EXIT   * Branch Main Line to Next Request
AJXERR99  RETURN
+
.------------------------------------------------------------
. ADDCD000 - Write a new concession card record
.------------------------------------------------------------
ADDCD000  PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
ADDCD100  CALL      RKPMCCD1
          BRANCH    OVRCD,ADDCD500
.
          MATCH     URNUMBER,PMCDURNO       * same u/r?
          GOTO      ADDCD500 IF NOT EQUAL
.
          MATCH     PMCCD002,PMCDCTYP       * card type exists for this u/r
          GOTO      ADDCD900 IF EQUAL
.
          GOTO      ADDCD100
.
ADDCD500  PACK      PMCDURNO,URNUMBER,SP70
          PACK      PMCDCTYP,PMCCD002,SP70
          PACK      PMCDCNUM,PMCCD003,SP70
          PACK      PMCDEXDT,PMCCD004,SP70
          PACK      PMCDDVAC,PMCCD005,SP70
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
.
          CALL      CHKCRD00                * check concession card
          BRANCH    EXIT,ADDCD999
.
          CALL      RAPMCCD1
          IF        OVRCD<>1
            GOTO      ADDCD900
          ENDIF
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMCDCDAT                * System date
          CLOCK     TIME,PMCDCTIM                * System time
          MOVE      USERID,PMCDCUID              * web user id
          MOVE      SP70,PMCDUDAT
          MOVE      SP70,PMCDUTIM
          MOVE      SP70,PMCDUUID
          CALL      WRPMCCD1
.  write nsw edw record for concession card added
          PACK      PMEWURNO,PMCDURNO,SP70
          MOVE      "18",PMEWTYPE
          PACK      PMEWOLDV,SP70
          PACK      PMEWNEWV,PMCDURNO,PMCDCTYP,PMCDCNUM,PMCDEXDT,SP70
          CALL      WREDW000
.
          CALL      WPRSP000                     * write PMI trigger
.
          COMPARE   ONE,NDISCARD                 * Just added an NDIS card
          GOTO      ADDCD700 IF NOT EQUAL
.
. PMI read before this routine called
.
          MATCH     " 1",PTMXESPF                * NDIS participant
          GOTO      ADDCD700 IF EQUAL
.
. Re read PMI and set NDIS participant indicatory to yes
.
          PACK      KEY8,URNUMBER,SP70         * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ADDCD700
.
          MOVE      " 1",PTMXESPF              * Set NDIS participant to yes
          CALL      UPMAST1
.
ADDCD700  CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICHA                     * broadcast CHA to datagate
          PROC      DGCLICUP                     * broadcast PMI update message
.
.  write Add record to Audit file
          CALL      ADUPDAUD                     * Add record to Audit file    
.
          CALL      WNPDVA00                     * Write to NIHC IHI polling 
.
.  Check if VIC & NDIS - Write to ESIS
          CALL      WESIS000
. 
          GOTO      ADDCD999
.
ADDCD900  MOVE      "Concession Card Type already exists. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
.
ADDCD999  RETURN
+
.--------------------------------------------------------------------------
. Write out pmsnplaf record if type = 'DVA' and PTCNUNET = '3'
.--------------------------------------------------------------------------
WNPDVA00  MATCH     "3",PTCNUNET
          GOTO      WNPDVA99 IF NOT EQUAL
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WNPDVA99
.
          MATCH     "3",TCINDC1
          GOTO      WNPDVA99 IF NOT EQUAL
.
          MOVE      "07",IREQTYPE 
          CALL      WPMNPL00                    * Write to NIHC IHI polling
.
WNPDVA99  RETURN
+
.------------------------------------------------------------
. CHKCRD00 - Concession Card validation
. Returns: NDISCARD - NDIS Card type, 0 = No, 1 = Yes
.          EXIT - 0 = Ok to continue, 1 = Error
.------------------------------------------------------------
CHKCRD00  MOVE      ZERO,EXIT
          MOVE      ZERO,NDISCARD                * Not NDIS 
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKCRD90
.
          MOVE      ZERO,FORM1
          MOVE      TCINDC1,FORM1
.
          IF        FORM1=7
            MOVE      ONE,NDISCARD               * Yes NDIS 
          ENDIF
.
          BRANCH    FORM1,CHKCRD99:              * Centrelink
                          CHKCRD20:              * Safety Net
                          CHKCRD30:              * DVA
                          CHKCRD99:              * Pension
                          CHKCRD99               * Seniors Concession Card
.
          GOTO      CHKCRD99
.
CHKCRD20  UNPACK    PMCDCNUM,KEY2,KEY9,DIM9      * Safety Net card number
          MATCH     "SN",KEY2
          IF        !@EQUAL
            MATCH     "CN",KEY2
            GOTO      CHKCRD91 IF NOT EQUAL
          ENDIF
.
          TYPE      KEY9
          GOTO      CHKCRD91 IF NOT EQUAL
.
          MATCH     SP70,DIM9
          GOTO      CHKCRD91 IF NOT EQUAL
.
          GOTO      CHKCRD99
.
CHKCRD30  RESET     DVACHAR1                     * DVA card number
          REP       UPPLOW,PMCDCNUM
          UNPACK    PMCDCNUM,CHAR1,CHAR2,CHAR3,CHAR4,CHARS58,CHAR9,DIM11
.
.         First character - State Identifier (Q,N,V,T,S or W)
.
          SCAN      CHAR1,DVACHAR1          * validate char 1
          GOTO      CHKCRD91 IF NOT EQUAL
.
.         Characters 2-4, alpahetic characters may apper in these fields
.         but no alphabetic characters after any numerics
.
          MOVE      ZERO,NXTALPHA           * following chars can be non-numeric
          MATCH     SP70,CHAR2
          IF        !@EQUAL
            TYPE      CHAR2
            IF        @EQUAL
              MOVE      ONE,NXTALPHA        * following chars must be numeric
            ENDIF
          ENDIF
.
          MATCH     SP70,CHAR3
          IF        !@EQUAL
            TYPE      CHAR3
            IF        !@EQUAL
              COMPARE   ONE,NXTALPHA
              GOTO      CHKCRD91 IF EQUAL   * char 3 must be numeric
            ELSE
              MOVE      ONE,NXTALPHA        * following chars must be numeric
            ENDIF
          ENDIF
.
          MATCH     SP70,CHAR4
          IF        !@EQUAL
            TYPE      CHAR4
            IF        !@EQUAL
              COMPARE   ONE,NXTALPHA
              GOTO      CHKCRD91 IF EQUAL     * char 4 must be numeric
            ENDIF
          ENDIF
.
.         Chars 5-8 = numeric except last non-space character may be alphabetic
.
          MOVE      ZERO,F1
          MOVE      SP70,KEY4
          ENDSET    CHARS58
.
CHKCRD40  MATCH     SP70,CHARS58
          GOTO      CHKCRD50 IF NOT EQUAL
.
CHKCRD42  BUMP      CHARS58,-1
          GOTO      CHKCRD80 IF EOS
          GOTO      CHKCRD40
.
.         allow the last char tobe alphabetic
.
CHKCRD50  MOVE      CHARS58,KEY1
          TYPE      KEY1
          GOTO      CHKCRD42 IF EQUAL
.
          BRANCH    F1,CHKCRD91
          MOVE      ONE,F1                * flag for finding a character
          GOTO      CHKCRD42
.
.         Char 9 = space (veteran) or alpha (dependent)
.
CHKCRD80  TYPE      CHAR9                   * char 9 must be non-numeric
          GOTO      CHKCRD91 IF EQUAL
.
          MATCH     SP70,DIM11
          GOTO      CHKCRD91 IF NOT EQUAL
.
          GOTO      CHKCRD99
.
CHKCRD90  MOVE      "Invalid Concession Card Type. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCRD99
.
CHKCRD91  MOVE      "Invalid Concession Card Number. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCRD99
.
CHKCRD95  MOVE      "Indicator not set up for Concession Card Type. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      CHKCRD99
.
CHKCRD99  RETURN
+
.------------------------------------------------------------
. DELCD000 - Delete a concession card record
.------------------------------------------------------------
DELCD000  PACK      PMCDURNO,URNUMBER,SP70
          PACK      PMCDCTYP,PMCCD002,SP70
          PACK      PMCDCNUM,PMCCD003,SP70
          PACK      PMCDEXDT,PMCCD004,SP70
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
          PACK      SAVKEY40,PMCDURNO,PMCDCTYP,PMCDCNUM,PMCDEXDT,SP70
.
          CALL      RDPMCCD1
          IF        OVRCD<>1
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWO,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICHD               * broadcast CHD to datagate
            PROC      DGCLICUP               * broadcast PMI update message
            CALL      DEPMCCD1
            CALL      WPRSP000               * write PMI trigger
            CALL      ADUPDAUD               * write delete record to Audit file
.  write nsw edw record for concession card added
            PACK      PMEWURNO,PMCDURNO,SP70
            MOVE      "19",PMEWTYPE
            PACK      PMEWOLDV,SAVKEY40,SP70
            PACK      PMEWNEWV,SP70
            CALL      WREDW000
.
            CALL      WNPDVA00                * Write to NIHC IHI polling 
          ENDIF
.
DELCD999  RETURN
+
.------------------------------------------------------------
. UPDCD000 - Update a concession card record
.------------------------------------------------------------
UPDCD000  PACK      KEY19,URNUMBER,PMCCD004,PMCCD002,SP70
          CALL      RDPMCCD1
          IF        OVRCD<>1
            MATCH     PMCDURNO,URNUMBER
            GOTO      UPDCD010 IF NOT EQUAL
.            
            MATCH     PMCDCTYP,PMCCD002
            GOTO      UPDCD010 IF NOT EQUAL
.
            MATCH     PMCDCNUM,PMCCD003
            GOTO      UPDCD010 IF NOT EQUAL
          ENDIF
.          
          GOTO      UPDCD100
.
UPDCD010  MOVE      "Concession Card Type already exists. ",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      UPDCD999
.
UPDCD100  PACK      PMCDURNO,URNUMBER,SP70
          PACK      PMCDCTYP,PMCCD002,SP70
          PACK      PMCDCNUM,PMCCD003,SP70
          PACK      PMCDEXDT,OLDCCDDT,SP70
          PACK      SAVKEY40,PMCDURNO,PMCDCTYP,PMCDCNUM,PMCDEXDT,SP70
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
.
          CALL      RDPMCCD1
          BRANCH    OVRCD,UPDCD999               * "old" record doesn't exist
.
          PACK      PMCDEXDT,PMCCD004,SP70       * save "new" expiry date
          PACK      PMCDDVAC,PMCCD005,SP70       * DVA card colour
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMCDUDAT                * System date
          CLOCK     TIME,PMCDUTIM                * System time
          MOVE      USERID,PMCDUUID              * web user id
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * broadcast PMI update message
          CALL      UPPMCCD1
.
.  write nsw edw record for concession card added
          PACK      PMEWURNO,PMCDURNO,SP70
          MOVE      "19",PMEWTYPE
          PACK      PMEWOLDV,SAVKEY40,SP70
          PACK      PMEWNEWV,PMCDURNO,PMCDCTYP,PMCDCNUM,PMCDEXDT,SP70
          CALL      WREDW000
.
          CALL      WPRSP000                     * write PMI trigger
.
.  write update record to Audit file
          CALL      ADUPDAUD                   * Add update record to Audit file

.  Check if VIC & NDIS - Write to ESIS
          CALL      WESIS000
.
UPDCD999  RETURN
+
.------------------------------------------------------------
. Add Update Record to Audit File (PATCCHFD)
.------------------------------------------------------------
ADUPDAUD  COMPARE   ONE,AUDTATRB
          GOTO      ATTRIB99 IF EQUAL
.
          CALL      CLPATCCH
          PACK      PTCCURNO,URNUMBER,SP70
          PACK      PTCCCTYP,PMCCD002,SP70       * Card Type (cat ct)
          PACK      PTCCCNUM,PMCCD003,SP70       * Card Number
          PACK      PTCCEXDT,PMCCD004,SP70       * Card Expiry Date
          PACK      PTCCDVAC,PMCCD005,SP70       * DVA card colour
          PACK      PTCCUPDT,UPDTTYPE            * Update Type
          PACK      PTCCUPDR,PMCCD006            * Update Reason
          PACK      PTCCPEXD,OLDCCDDT,SP70       * Previous Expiry Date
          PACK      PTCCPCDC,OLDCOLOR,SP70       * Previous DAV card Colour
.
          CALL      IBACLOCK
          PACK      PTCCDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",PTCCDATE
          MOVE      CTIMEIS,PTCCTIME
          MOVE      USERID,PTCCURID                 * Web UserId

ADUPDA10  PACK      KEY35,URNUMBER,PTCCEXDT,PTCCCTYP,PTCCDATE,PTCCTIME,SP70
          CALL      RDPTCCH1
          IF        OVRCD=1
            CALL      WRPTCCH1
            GOTO      ADUPDA99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      PTCCDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",PTCCDATE
            CLOCK     TIME,CTIMEIS
            PACK      PTCCTIME,CTIMEIS
            REP       " 0",PTCCTIME
            GOTO      ADUPDA10
          ENDIF
          GOTO        ADUPDA99
.
ADUPDA99  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110,PROFL120,PROFL130,PROFL140,PROFL150:
                             PROFL160,PROFL170,PROFL180,PROFL190,PROFL200:
                             PROFL210,PROFL220,PROFL230,PROFL240,PROFL250: 
                             PROFL260
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      ALTI0000    * Alternate ID Info
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      TNUR0000           * Last Ten UR Numbers
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      DEFA0000    * Alternate ID Default Address
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD42  CALL      CCRD0000    * Concession Card Fields
          GOTO      PROFLD99
.
PROFLD43  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000           * Master File Info
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD62  CALL      PMCE0000    * Extra contact details
          GOTO      PROFLD99
.
PROFLD63  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFLD64  CALL      MISF0000    * Admission details
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD72  CALL      PMPA0000    * Expected Payor Tags
          GOTO      PROFLD99
.
PROFLD73  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          GOTO      PROFLD99
.
PROFLD81  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD82  CALL      PMRF0000    * Patient Referral details info
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91
          GOTO      PROFLD99
.
PROFLD91  CALL      PMAC0000    * Outcome details table
          GOTO      PROFLD99
.
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102
          GOTO      PROFLD99
.
PROFL101  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL102  CALL      VXTF0000    * Visit File Info
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111,PROFL112,PROFL113
          GOTO      PROFLD99
.
PROFL111  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL112  CALL      PMPO0000    * Outcome details table
          GOTO      PROFLD99
.
PROFL113  CALL      MISC0000    * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122
          GOTO      PROFLD99
.
PROFL121  CALL      PTPR0000           * Eclipse Participant Details
          GOTO      PROFLD99
.
PROFL122  CALL      PTPP0000           * Eclipse Participant Capabilities
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131
          GOTO      PROFLD99
.
PROFL131  CALL      PTLC0000           * Eclipse Location Id Details
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL142  CALL      PMGP0000           * GP Access Audit  Details
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152,PROFL153,PROFL154
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL152  CALL      PMHS0000    * Previous Admission Details
          GOTO      PROFLD99
.
PROFL153  CALL      MISF0000    * Admission details
          GOTO      PROFLD99
.
PROFL154  CALL      MISC0000    * Miscellaneous details
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162,PROFL163
          GOTO      PROFLD99
.
PROFL161  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL162  CALL      PMPYE000    * Payer 
          GOTO      PROFLD99
.
PROFL163  CALL      PTPY0000    * Patient Payer details
          GOTO      PROFLD99
.
PROFL170  BRANCH    FLDSETNO,PROFL171,PROFL172,PROFL173,PROFL174
          GOTO      PROFLD99
.
PROFL171  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL172  CALL      PTAR0000    * Patient Attributes
          GOTO      PROFLD99
.
PROFL173  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL174  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181,PROFL182
          GOTO      PROFLD99
.
PROFL181  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL182  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL190  BRANCH    FLDSETNO,PROFL191,PROFL192,PROFL193,PROFL194
          GOTO      PROFLD99
.
PROFL191  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL192  CALL      PTAR0000    * Patient Attributes
          GOTO      PROFLD99
.
PROFL193  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL194  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFL200  BRANCH    FLDSETNO,PROFL201,PROFL202,PROFL203
          GOTO      PROFLD99
.
PROFL201  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL202  CALL      PTAR0000    * Patient Attributes
          GOTO      PROFLD99
.
PROFL203  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL210  BRANCH    FLDSETNO,PROFL211,PROFL212,PROFL213
          GOTO      PROFLD99
.
PROFL211  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL212  CALL      PTAR0000    * Patient Attributes
          GOTO      PROFLD99
.
PROFL213  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL220  BRANCH    FLDSETNO,PROFL221,PROFL222
          GOTO      PROFLD99
.
PROFL221  CALL      WBPR0000           * WebServices Participant Details
          GOTO      PROFLD99
.
PROFL222  CALL      WBPP0000           * WebServices Participant Capabilities
          GOTO      PROFLD99
.
PROFL230  BRANCH    FLDSETNO,PROFL231,PROFL232,PROFL233,PROFL234
          GOTO      PROFLD99
.
PROFL231  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL232  CALL      PTAR0000    * Patient Attributes
          GOTO      PROFLD99
.
PROFL233  CALL      GTAG0000    * General Tags
          GOTO      PROFLD99
.
PROFL234  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFL240  BRANCH    FLDSETNO,PROFL241,PROFL242,PROFL243
          GOTO      PROFLD99
.
PROFL241  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL242  CALL      ALTV0000    * Alternative Visit Audit List
          GOTO      PROFLD99
.
PROFL243  PACK      KEY8,ADMISSNO,SP70
          CALL      RDIBALV1
          BRANCH    OVRCD,PROFLD99
.
          CALL      IBAALT00    * Output tag
          GOTO      PROFLD99
.
PROFL250  BRANCH    FLDSETNO,PROFL251,PROFL252,PROFL253,PROFL254,PROFL255:
                             PROFL256,PROFL257
          GOTO      PROFLD99
.
PROFL251  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFL252  CALL      MISF0000
          GOTO      PROFLD99
.
PROFL253  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFL254  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFL255  CALL      VISF0000
          GOTO      PROFLD99
.
PROFL256  CALL      EMRA0000
          GOTO      PROFLD99
.
PROFL257  CALL      PTFL0000
          GOTO      PROFLD99
.
PROFL260  BRANCH    FLDSETNO,PROFL261
          GOTO      PROFLD99
.
PROFL261  CALL      IPFL0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. Alternate ID fields
.------------------------------------------------------------
ALTI0000  BRANCH    FLDITMNO,ALTI0100,ALTI0200,ALTI0300,ALTI0400,ALTI0500:
                             ALTI0600
          GOTO      ALTI9999
.
ALTI0100  CALL      LSTAID00           * list alternate ID's
          GOTO      ALTI9999
.
ALTI0200  WRITE     HTMLFILE;PTCNDAUR; * Use alternate ID instead of UR
          GOTO      ALTI9999
.
ALTI0300  CALL      LSTAIV00           * list alternate ID's View Only
          GOTO      ALTI9999
.
ALTI0400  MOVE      "AI",CATEGORY
          MOVE      SELDTYPE,CODE
          CALL      CODITM00
          GOTO      ALTI9999
.
ALTI0500  PACK      KEY19,URNUMBER,SP70         * DVA
          CALL      RSPMCCD1
ALTI0501  CALL      RKPMCCD1
          BRANCH    OVRCD,ALTI9999
.
          MATCH     PURNO,PMCDURNO
          GOTO      ALTI9999 IF NOT EQUAL
.
          MOVE      "ct",DIM2
          PACK      KEY5,DIM2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALTI0501
.
          MATCH     "3",TCINDC1
          GOTO      ALTI0501 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMCDCNUM;           * DVA Card Number
          GOTO      ALTI9999
.
ALTI0600  PACK      KEY31,URNUMBER,SP70         * IHI
          CALL      RSPMAID1
ALTI0601  CALL      RKPMAID1
          BRANCH    OVRCD,ALTI9999
.
          MATCH     PURNO,PMAIURNO
          GOTO      ALTI9999 IF NOT EQUAL
.
          MOVE      "AI",DIM2
          PACK      KEY5,DIM2,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALTI0601
.
          MATCH     "I",TCINDC2
          GOTO      ALTI0601 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMAIALID;           * IHI Number
          GOTO      ALTI9999
.
ALTI9999  RETURN
.
.-----------------------------------------------------------------------------
. Inpatient Follow Up List
.-----------------------------------------------------------------------------
IPFL0000  BRANCH    FLDITMNO,IPFL0100,IPFL0200,IPFL0300,IPFL0400,IPFL0500:
                             IPFL0600,IPFL0700,IPFL0800,IPFL0900,IPFL1000:
                             IPFL1100,IPFL1200,IPFL1300
          GOTO      IPFL0999
.
IPFL0100  CALL      NEXTPF00
          GOTO      IPFL0999 
.
IPFL0200  CALL      PREVPF00
          GOTO      IPFL0999 
.
IPFL0300  CALL      SELV0000
          GOTO      IPFL0999 
.
IPFL0400  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      IPFL0999 
.
IPFL0500  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      IPFL0999 
.
IPFL0600  MOVE      "AC",CATEGORY
          MOVE      FILTUNIT,CODE
          CALL      CODITM00 
          GOTO      IPFL0999
.
IPFL0700  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          CALL      CODITM00
          GOTO      IPFL0999
.
IPFL0800  MOVE      "P ",CATEGORY
          MOVE      FILTPTYP,CODE
          CALL      CODITM00
          GOTO      IPFL0999
.
IPFL0900  MOVE      "DD",CATEGORY
          MOVE      FILTDDST,CODE
          CALL      CODITM00
          GOTO      IPFL0999
.
IPFL1000  MOVE      FILTWARD,EMVIEWRD
          CALL      WSEL0000                * Ward selection list
          GOTO      IPFL0999
.
IPFL1100  MOVE      "1f",CATEGORY
          MOVE      FILTCOUT,CODE
          CALL      CODITM00
          GOTO      IPFL0999
.
IPFL1200  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      IPFL0999
.
IPFL1300  CALL      IPFLLS00 
          GOTO      IPFL0999
.
IPFL0999  RETURN
.
.------------------------------------------------------------------------------
. Inpatient follow up list 
.------------------------------------------------------------------------------
IPFLLS00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     "1",SHOWFLAG
          GOTO      IPFLLS99 IF NOT EQUAL
.
          PACK      KEY16,FRSTDATE,SP10
          CALL      RDSDSCH2
IPFLLS20  CALL      RDKDSCH2                * Loop over discharges
          BRANCH    OVRCD,IPFLLS99
.
          MATCH     DDATE,LASTDATE          * end date range
          GOTO      IPFLLS99 IF LESS
.
          MATCH     SP70,FILTDDST
          IF        !@EQUAL
            MATCH     FILTDDST,DDEST
            GOTO      IPFLLS20 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,DURNO,SP70
          CALL      RDMAST1                 * read PMI Details
          BRANCH    OVRCD,IPFLLS20
.
          CALL      CLPMSPX2
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDMISS1                 * read admission details
          BRANCH    OVRCD,IPFLLS20
.
          PACK      KEY8,DDADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL       CLPMSVX1
          ENDIF
.
          CALL      RDVISA1
          BRANCH    OVRCD,IPFLLS20
.
          MATCH     SP70,FILTUNIT
          IF        !@EQUAL
            MATCH     FILTUNIT,ACLSSFT
            GOTO      IPFLLS20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLAM
          IF        !@EQUAL
            MATCH     FILTCLAM,ACLAIM
            GOTO      IPFLLS20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPTYP
          IF        !@EQUAL
            MATCH     FILTPTYP,ACLSS
            GOTO      IPFLLS20 IF NOT EQUAL
          ENDIF
.
IPFLLS30  MATCH     SP70,FILTWARD
          GOTO      IPFLLS40 IF EQUAL  
.
          PACK      KEY30,DDADMNO,Z70
IPFLLS32  CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,IPFLLS20
.
          MATCH     DDADMNO,DTADMN
          GOTO      IPFLLS20 IF NOT EQUAL
.
          MATCH     "D",TMOVE
          GOTO      IPFLLS32 IF NOT EQUAL
.
          MATCH     FILTWARD,TWARD
          GOTO      IPFLLS20 IF NOT EQUAL
.
IPFLLS40  CALL      GOUTCD00
.
          MATCH     SP70,FILTCOUT
          GOTO      IPFLLS50 IF EQUAL
.
          MATCH     SP70,COUTCODE
          GOTO      IPFLLS20 IF EQUAL
.
          MATCH     FILTCOUT,COUTCODE
          GOTO      IPFLLS20 IF NOT EQUAL
.
. Write out record
.
IPFLLS50  CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE         
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000               
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    AURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    DDADMNO,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":          * 0
                             "#"",PATLINK,"#",":                    * 1
                             "#"";
.
          CALL      WRTAGE00                                        * 2
          WRITE     HTMLFILE;"#",":
                             "#"",ADATE,"#",":                      * 3
                             "#"",DDATE,DTIME,"#",";                * 4
.
          MOVE      "CC",CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                      * 5
.
          MOVE      "S ",CATEGORY
          MOVE      ASRCE,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                      * 6
.
          MOVE      "DD",CATEGORY
          MOVE      DDEST,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                      * 7
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                     * 8
.
          MOVE      "P ",CATEGORY
          MOVE      ACLSS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                     * 9
.
          WRITE     HTMLFILE;"#"",DOCFNAME,"#",";                  * 10
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";                     * 11
.
          WRITE     HTMLFILE;"#"",ADIAG1,"#",";                    * 12
.
IPFLLS55  CLEAR     HTMLLNK2
          MATCH     "1",PATREXST
          IF        @EQUAL
            APPEND    "javascript:PatFollowUpDetails('",HTMLLNK2
            APPEND    DURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DDADMNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    COUTDATE,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    COUTTIME,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    PMVXMHOS,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ELSE
            APPEND    "javascript:AddPatFollowUp('",HTMLLNK2
            APPEND    DURNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    DDADMNO,HTMLLNK2
            APPEND    "','",HTMLLNK2
            APPEND    PMVXMHOS,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,COUTCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"#"#",";                            * 13
            WRITE     HTMLFILE;"#"",HTMLLNK2,"#",";                * 14
            WRITE     HTMLFILE;"#"0#",";                           * 15
          ELSE
            MOVE      "1f",CATEGORY
            MOVE      COUTCODE,CODE
            CALL      GETCOD00
            MOVE      "1f",CATEGORY
            MOVE      COUTCODE,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"#"",TDESC,"#",";                   * 13
            WRITE     HTMLFILE;"#"",HTMLLNK2,"#",";                * 14
            WRITE     HTMLFILE;"#"1#",";                           * 15
          ENDIF 
.
          CLEAR     CONTDETS
          APPEND    "H: ",CONTDETS
          APPEND    PTELEP,CONTDETS
          APPEND    "<br>",CONTDETS
          APPEND    "B: ",CONTDETS
          APPEND    PTELEB,CONTDETS
          APPEND    "<br>",CONTDETS
          APPEND    "M: ",CONTDETS
          APPEND    PTMXCELL,CONTDETS
          RESET     CONTDETS
          WRITE     HTMLFILE;"#"",CONTDETS,"#",";                  * 16
          WRITE     HTMLFILE;"#"",FOLDERSF,"#");"                  * 17
.
          GOTO      IPFLLS20
.
IPFLLS99  RETURN
.
.------------------------------------------------------------------------------
. Get patient attrbute dedtail for type 027  
.------------------------------------------------------------------------------
GOUTCD00  MOVE      SP70,COUTCODE
          MOVE      "0",PATREXST 
          MOVE      "027",DIM3
          PACK      KEY35,AURNO,DDADMNO,DIM3,Z70
          CALL      RDPTATR3
GOUTCD20  CALL      RPPTATR3
          BRANCH    OVRCD,GOUTCD99
.
          MATCH     AURNO,PTARURNO
          GOTO      GOUTCD99 IF NOT EQUAL
.
          MATCH     DDADMNO,PTARVISN
          GOTO      GOUTCD99 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      GOUTCD99 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      GOUTCD20 IF EQUAL
.
          MOVE      PTARCOD1,COUTCODE
          MOVE      PTARDATE,COUTDATE        
          MOVE      PTARTIME,COUTTIME       
          MOVE      "1",PATREXST
.
GOUTCD99  RETURN 
+
.------------------------------------------------------------
. Miscellaneous outputs
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000
          GOTO      MISC9999
.
MISC0100  CALL      PROD0000      * List of procedures
          GOTO      MISC9999
.
MISC0200  MATCH     SP70,ADMISSNO
          GOTO      MISC9999 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          IF        OVRCD<>1
            WRITE     HTMLFILE;ONE;
          ENDIF
          GOTO      MISC9999
.
MISC0300  WRITE     HTMLFILE;PVITYPE;
          GOTO      MISC9999
.
MISC0400  MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          CALL      CODITM00
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;MVMEDREC;
          GOTO      MISC9999
.
MISC0600  WRITE     HTMLFILE;ENTERDAY;
          GOTO      MISC9999
.
MISC0700  WRITE     HTMLFILE;PROGDAYS;
          GOTO      MISC9999
.
MISC0800  WRITE     HTMLFILE;MVITHMVA; * MVIT - Been in motor vehicle accident
          GOTO      MISC9999
.
MISC0900  WRITE     HTMLFILE;MVITRDIR; * MVIT - Redirect to MVIT claim screen
          GOTO      MISC9999
.
MISC1000  WRITE     HTMLFILE;CHCKCOMP; * WA Comp - Redirect after MVA screen
          GOTO      MISC9999
.
MISC9999  RETURN
.
.------------------------------------------------------------
. Procedure details
.------------------------------------------------------------
PROD0000  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
PROD1000  CALL      RKOPDEA2
          BRANCH    OVRCD,PROD9999
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,IDESC
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL
            PACK      KEY17,OPDAPROV,OPDADATE,SP70
            CALL      PATITMRD
          ENDIF
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/AppointmentIcon.gif ":
                             " class=ListIcon onclick='updateParent(#"":
                             OPDAUNIQ,"#");'>",DISPDATE:
                             " at ",OPDATIME,"</td>":
                             "<td>",OPDAPROV,"&nbsp;",SP1,IDESC,"</td>";
.
PROD9999  RETURN
+
.------------------------------------------------------------
. List alternate IDs
.------------------------------------------------------------
LSTAID00  PACK      KEY31,URNUMBER,SP70
          CALL      RSPMAID1
LSTAID10  CALL      RKPMAID1
          BRANCH    OVRCD,LSTAID99
.
          MATCH     URNUMBER,PMAIURNO
          GOTO      LSTAID99 IF NOT EQUAL
.
          MATCH     SP70,SELDTYPE
          IF        !@EQUAL
            MATCH     SELDTYPE,PMAITYPE
            GOTO      LSTAID10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",PMAIALID,"</td>":
                             "<td>",TDESC," ";
.
          MATCH     "3",PTCNUNET
          GOTO      LSTAID30 IF NOT EQUAL
.
          MATCH     "1",PMAIVSTA            * IHI Verification Status
          IF        @EQUAL
            WRITE     HTMLFILE;"- Verified ";
          ENDIF
.
          MATCH     "2",PMAIVSTA            * IHI Verification Status
          IF        @EQUAL
            WRITE     HTMLFILE;"- Manual ";
          ENDIF

          MATCH     "1",PMAIASTA            * IHI Activation Status
          IF        @EQUAL
            WRITE     HTMLFILE;"(Active)";
          ENDIF
.
          MATCH     "2",PMAIASTA            
          IF        @EQUAL
            WRITE     HTMLFILE;"(Deceased)";
          ENDIF
.
          MATCH     "3",PMAIASTA            
          IF        @EQUAL
            WRITE     HTMLFILE;"(Retired)";
          ENDIF
.
          MATCH     "4",PMAIASTA            
          IF        @EQUAL
            WRITE     HTMLFILE;"(Expired)";
          ENDIF
.
          MATCH     "5",PMAIASTA           
          IF        @EQUAL
            WRITE     HTMLFILE;"(Resolved)";
          ENDIF
.
LSTAID30  MATCH     "1",PMAIDISU
          IF        @EQUAL
            WRITE     HTMLFILE;"</td><td>Yes</td>";
          ELSE
            WRITE     HTMLFILE;"</td><td>No</td>";
          ENDIF
.
          MATCH     "U",TCINDC4
          GOTO      LSTAID40 IF NOT EQUAL      * Not UPI code
.
          MOVE      "PATWEB07",WBSTPRG
          PACK      KEY18,USERID,WBSTPRG,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,LSTAID40
.
.         If security level of Alternate id (TCFORM6) is highter than user 
.         security level accessing patweb07 then disable delete button
.
          COMPARE   TCFORM6,WBSTLEV
          GOTO      LSTAID40 IF NOT LESS
.
          WRITE     HTMLFILE;"<td>":
                             "<input type=button class=button value=Delete ":
                             "disabled ></td>":
                             "</tr>"
          GOTO      LSTAID10
.
LSTAID40  WRITE     HTMLFILE;"<td>":
                             "<input type=button class=button value=Delete ":
                             "onClick='DeleteAlternateID(#"",URNUMBER:
                             "#",#"",PMAIALID:
                             "#",#"",PMAITYPE:
                             "#");'></td>":
                             "</tr>"
          GOTO      LSTAID10
.
LSTAID99  RETURN
+
.------------------------------------------------------------
. List alternate IDs View Only
.------------------------------------------------------------
LSTAIV00  PACK      KEY31,URNUMBER,SP70
          CALL      RSPMAID1
LSTAIV10  CALL      RKPMAID1
          BRANCH    OVRCD,LSTAIV99
.
          MATCH     URNUMBER,PMAIURNO
          GOTO      LSTAIV99 IF NOT EQUAL
.
          MATCH     SP70,SELDTYPE
          IF        !@EQUAL
            MATCH     SELDTYPE,PMAITYPE
            GOTO      LSTAIV10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",PMAIALID,"</td>":
                             "<td>",TDESC,"</td>";
          MATCH     "1",PMAIDISU
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Yes</td>";
          ELSE
            WRITE     HTMLFILE;"<td>No</td></tr>";
          ENDIF
.
          GOTO      LSTAIV10
.
LSTAIV99  RETURN
+
.------------------------------------------------------------------------------
. Last Ten UR Numbers - display fields
.------------------------------------------------------------------------------
TNUR0000  BRANCH    FLDITMNO,TNUR0100,TNUR0200
          GOTO      TNUR9999
.
TNUR0100  CALL      LSUR0000                * List last 10 UR Numbers
          GOTO      TNUR9999
.
TNUR0200  WRITE     HTMLFILE;USERID;        * Web User Id
          GOTO      TNUR9999
.
TNUR9999  RETURN
+
.------------------------------------------------------------------------------
. Display List of Last 10 UR Numbers accessed by the user
.------------------------------------------------------------------------------
LSUR0000  MATCH     SP70,WBLRUR01
          GOTO      LSUR0200 IF EQUAL
.
LSUR0100  PACK      KEY8,WBLRUR01,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0200          * invalid UR number
.
          PACK      KEY8,WBLRUR01,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0200          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR01,PATURNO
          MOVE      WBLRVS01,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0200  MATCH     SP70,WBLRUR02
          GOTO      LSUR0300 IF EQUAL
.
          PACK      KEY8,WBLRUR02,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0300          * invalid UR number
.
          PACK      KEY8,WBLRUR02,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0300          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR02,PATURNO
          MOVE      WBLRVS02,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0300  MATCH     SP70,WBLRUR03
          GOTO      LSUR0400 IF EQUAL
.
          PACK      KEY8,WBLRUR03,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0400          * invalid UR number
.
          PACK      KEY8,WBLRUR03,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0400          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR03,PATURNO
          MOVE      WBLRVS03,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0400  MATCH     SP70,WBLRUR04
          GOTO      LSUR0500 IF EQUAL
.
          PACK      KEY8,WBLRUR04,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0500          * invalid UR number
.
          PACK      KEY8,WBLRUR04,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0500          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR04,PATURNO
          MOVE      WBLRVS04,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0500  MATCH     SP70,WBLRUR05
          GOTO      LSUR0600 IF EQUAL
.
          PACK      KEY8,WBLRUR05,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0600          * invalid UR number
.
          PACK      KEY8,WBLRUR05,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0600          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR05,PATURNO
          MOVE      WBLRVS05,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0600  MATCH     SP70,WBLRUR06
          GOTO      LSUR0700 IF EQUAL
.
          PACK      KEY8,WBLRUR06,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0700          * invalid UR number
.
          PACK      KEY8,WBLRUR06,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0700          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR06,PATURNO
          MOVE      WBLRVS06,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0700  MATCH     SP70,WBLRUR07
          GOTO      LSUR0800 IF EQUAL
.
          PACK      KEY8,WBLRUR07,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0800          * invalid UR number
.
          PACK      KEY8,WBLRUR07,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0800          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR07,PATURNO
          MOVE      WBLRVS07,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0800  MATCH     SP70,WBLRUR08
          GOTO      LSUR0900 IF EQUAL
.
          PACK      KEY8,WBLRUR08,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR0900          * invalid UR number
.
          PACK      KEY8,WBLRUR08,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR0900          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR08,PATURNO
          MOVE      WBLRVS08,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR0900  MATCH     SP70,WBLRUR09
          GOTO      LSUR1000 IF EQUAL
.
          PACK      KEY8,WBLRUR09,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1000          * invalid UR number
.
          PACK      KEY8,WBLRUR09,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1000          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR09,PATURNO
          MOVE      WBLRVS09,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1000  MATCH     SP70,WBLRUR10
          GOTO      LSUR1050 IF EQUAL
.
          PACK      KEY8,WBLRUR10,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1050          * invalid UR number
.
          PACK      KEY8,WBLRUR10,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1050          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR10,PATURNO
          MOVE      WBLRVS10,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1050  MATCH     SP70,WBLRUR11
          GOTO      LSUR1200 IF EQUAL
.
LSUR1100  PACK      KEY8,WBLRUR11,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1200          * invalid UR number
.
          PACK      KEY8,WBLRUR11,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1200          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR11,PATURNO
          MOVE      WBLRVS11,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1200  MATCH     SP70,WBLRUR12
          GOTO      LSUR1300 IF EQUAL
.
          PACK      KEY8,WBLRUR12,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1300          * invalid UR number
.
          PACK      KEY8,WBLRUR12,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1300          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR12,PATURNO
          MOVE      WBLRVS12,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1300  MATCH     SP70,WBLRUR13
          GOTO      LSUR1400 IF EQUAL
.
          PACK      KEY8,WBLRUR13,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1400          * invalid UR number
.
          PACK      KEY8,WBLRUR13,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1400          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR13,PATURNO
          MOVE      WBLRVS13,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1400  MATCH     SP70,WBLRUR14
          GOTO      LSUR1500 IF EQUAL
.
          PACK      KEY8,WBLRUR14,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1500          * invalid UR number
.
          PACK      KEY8,WBLRUR14,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1500          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR14,PATURNO
          MOVE      WBLRVS14,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1500  MATCH     SP70,WBLRUR15
          GOTO      LSUR1600 IF EQUAL
.
          PACK      KEY8,WBLRUR15,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1600          * invalid UR number
.
          PACK      KEY8,WBLRUR15,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1600          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR15,PATURNO
          MOVE      WBLRVS15,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1600  MATCH     SP70,WBLRUR16
          GOTO      LSUR1700 IF EQUAL
.
          PACK      KEY8,WBLRUR16,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1700          * invalid UR number
.
          PACK      KEY8,WBLRUR16,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1700          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR16,PATURNO
          MOVE      WBLRVS16,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1700  MATCH     SP70,WBLRUR17
          GOTO      LSUR1800 IF EQUAL
.
          PACK      KEY8,WBLRUR17,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1800          * invalid UR number
.
          PACK      KEY8,WBLRUR17,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1800          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR17,PATURNO
          MOVE      WBLRVS17,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1800  MATCH     SP70,WBLRUR18
          GOTO      LSUR1900 IF EQUAL
.
          PACK      KEY8,WBLRUR18,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR1900          * invalid UR number
.
          PACK      KEY8,WBLRUR18,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR1900          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR18,PATURNO
          MOVE      WBLRVS18,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR1900  MATCH     SP70,WBLRUR19
          GOTO      LSUR2000 IF EQUAL
.
          PACK      KEY8,WBLRUR19,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR2000          * invalid UR number
.
          PACK      KEY8,WBLRUR19,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR2000          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR19,PATURNO
          MOVE      WBLRVS19,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR2000  MATCH     SP70,WBLRUR20
          GOTO      LSUR9999 IF EQUAL
.
          PACK      KEY8,WBLRUR20,SP70
          CALL      RDMAST1                 * read Patient Master file
          BRANCH    OVRCD,LSUR9999          * invalid UR number
.
          PACK      KEY8,WBLRUR20,SP70
          CALL      RDPMPX21                * read Patient Master extn file
          BRANCH    OVRCD,LSUR9999          * invalid UR number
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        @EQUAL
              PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            ELSE
              MOVE      PDECDTE,AGEDATE            * Date of Death
            ENDIF
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * Calculate Patient's age
          CALL      PATLN000                * Format Patient's name
.
          MOVE      WBLRUR20,PATURNO
          MOVE      WBLRVS20,PATVISIT
          CALL      DSPROW00                * Display table row
.
LSUR9999  RETURN
+
.------------------------------------------------------------------------------
. Display one row for the Last 10 UR's table
.------------------------------------------------------------------------------
DSPROW00  MATCH     SP70,PATVISIT
          IF        @EQUAL
            MOVE      ZEROVISN,FPTVISIT       
            GOTO      DSPROW80
          ENDIF
.
          MOVE      PATVISIT,KEY8
          CALL      RDVISA1           * validate visit belongs to correct UR
          IF        OVRCD=0
            MATCH     PATURNO,PVIURNO
            GOTO      DSPROW55 IF NOT EQUAL
.
            IF      PVITYPE=1
              PACK      KEY8,PATVISIT,SP70
              CALL      RDEMVIS1
              BRANCH    OVRCD,DSPROW55
.
              MATCH     WBSEESC,EMVISITE         * Check ED site
              GOTO      DSPROW55 IF NOT EQUAL
            ENDIF
          ELSE
            PACK      KEY36,PATVISIT,SP70
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            BRANCH    OVRCD,DSPROW55
.
            MATCH     PATVISIT,DOBAOUTN
            GOTO      DSPROW55 IF NOT EQUAL
.
            MATCH     PATURNO,OBAURNO
            GOTO      DSPROW55 IF NOT EQUAL
.
            MATCH     WBSESIT,OBASITE            * Check OP site
            GOTO      DSPROW55 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            PACK      KEY8,PATVISIT,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,DSPROW55
.
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,DSPROW55
            ENDIF
          ENDIF
.
          GOTO      DSPROW60
.
DSPROW55  MOVE      SP70,PATVISIT           * Clear visis because of invalid
          MOVE      ZEROVISN,FPTVISIT       * hospital, ED/OP site
          GOTO      DSPROW80
.
DSPROW60  MOVE      PATVISIT,FPTVISIT
          MATCH     ZEROVISN,FPTVISIT
          IF        @EQUAL
            MOVE      SP70,PATVISIT
          ENDIF
.
DSPROW80  WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             "<a href='javascript:ShowPatient(#"",PATURNO:
                             "#",#"",FPTVISIT,"#")'>",PATURNO,"</a></td>":
                             "<td>&nbsp;",FORMATNM,"</td>":          
                             "<td>&nbsp;":
                             "<a href='javascript:ShowPatient(#"",PATURNO:
                             "#",#"",FPTVISIT,"#")'>",PATVISIT,"</a></td></tr>"
.
DSPROW99  RETURN
+
.------------------------------------------------------------
. Alternate ID Address fields
.------------------------------------------------------------
DEFA0000  BRANCH    FLDITMNO,DEFA0100,DEFA0200,DEFA0300,DEFA0400,DEFA0500:
                             DEFA0600,DEFA0700,DEFA0800,DEFA0900,DEFA1000
          GOTO      DEFA9999
.
DEFA0100  MOVE      "AI",CATEGORY
          MOVE      PMDATYPE,CODE
          CALL      CODITM00
          GOTO      DEFA9999
.
DEFA0200  MATCH     SP70,PMDAADD1
          GOTO      DEFA9999 IF EQUAL
.
          REP       "#" ",PMDAADD1
          WRITE     HTMLFILE;PMDAADD1;
          GOTO      DEFA9999
.
DEFA0300  MATCH     SP70,PMDAADD2
          GOTO      DEFA9999 IF EQUAL
.
          REP       "#" ",PMDAADD2
          WRITE     HTMLFILE;PMDAADD2;
          GOTO      DEFA9999
.
DEFA0400  MATCH     SP70,PMDAADD3
          GOTO      DEFA9999 IF EQUAL
.
          REP       "#" ",PMDAADD3
          WRITE     HTMLFILE;PMDAADD3;
          GOTO      DEFA9999
.
DEFA0500  MATCH     SP70,PMDAADD4
          GOTO      DEFA9999 IF EQUAL
.
          REP       "#" ",PMDAADD4
          WRITE     HTMLFILE;PMDAADD4;
          GOTO      DEFA9999
.
DEFA0600  MATCH     SP70,PMDAPOST
          GOTO      DEFA9999 IF EQUAL
.
          REP       "#" ",PMDAPOST
          WRITE     HTMLFILE;PMDAPOST;
          GOTO      DEFA9999
.
DEFA0700  CALL      ADDTB000    * Table of Addresses
          GOTO      DEFA9999
.
DEFA0800  CALL      NEXTAD00    * Next set of Addresses
          GOTO      DEFA9999
.
DEFA0900  CALL      PREVAD00    * Prev set of Addresses
          GOTO      DEFA9999
.
DEFA1000  MATCH     SP70,PMDAPHON
          GOTO      DEFA9999 IF EQUAL
.
          WRITE     HTMLFILE;PMDAPHON;
          GOTO      DEFA9999
.
DEFA9999  RETURN
+
.-----------------------------------------------------------
. Link to Next Group of Addresses
.-----------------------------------------------------------
NEXTAD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMDATYPE
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pmdaa001=",PMDATYPE;
          REP       "+ ",PMDATYPE
.
NEXTAD99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of Address
.-------------------------------------------------------------
PREVAD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",PMDATYPE
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pmdaa001=",PMDATYPE;
          REP       "+ ",PMDATYPE
.
PREVAD99  RETURN
.------------------------------------------------------------
. Table of Address Details
.------------------------------------------------------------
ADDTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      ADHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY3,STARTKEY,SP70
          CALL      RDPMDAA1
          IF        OVRCD=0
            CALL      RPPMDAA1
          ENDIF
ADDTB100  CALL      RKPMDAA1
          BRANCH    OVRCD,ADDTB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ADDTB100
          ENDIF
.
          CALL      ADROW000      * Address Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ADDTB100 IF NOT EQUAL
          GOTO      ADDTB999
.
ADDTB900  CALL      NOMORE00      * Display No More Records Message
.
ADDTB999  RETURN
.------------------------------------------------------------
. Address Table Details (TABLE HEADING)
.------------------------------------------------------------
ADHED000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=40%>":
                               "<b>Alternate ID Type</b></td>":
                               "<td class=HeadingCell width=60%>":
                               "<b>Address Line 1</b></td>":
                             "</tr>"
.
ADHED999  RETURN
.------------------------------------------------------------
. Address File Table (TABLE ROW)
.------------------------------------------------------------
ADROW000  PACK      KEY5,ANSA,ANSI,PMDATYPE,SP70
          CALL      RDCODE1
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail03":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&pmdaa001=",PMDATYPE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             TDESC,"</td>":
                             "<td>",PMDAADD1,"<br>":
                             PMDAADD2,"<br>":
                             PMDAADD3,"<br>":
                             PMDAADD4,"<br>":
                             PMDAPOST,"<br>":
                             "Phone: ",PMDAPHON,"</td>":
                             "</tr>"
.
ADROW999 RETURN
.------------------------------------------------------------
. Concession Card Fields
.------------------------------------------------------------
CCRD0000  BRANCH    FLDITMNO,CCRD0100,CCRD0200,CCRD0300,CCRD0400,CCRD0500:
                             CCRD0600,CCRD0700,CCRD0800,CCRD0900,CCRD1000:
                             CCRD1100,CCRD1200,CCRD1300,CCRD1400,CCRD1500:
                             CCRD1600
          GOTO      CCRD9999
.
CCRD0100  MOVE      ZERO,DVACFLAG           * not using DVA card colour
          MOVE      ZERO,FORMATTY           * Output Format Type - 0=Table, 1=JSON
          CALL      LSTCCD00                * list concession cards
          GOTO      CCRD9999
.
CCRD0200  MOVE      "ct",CATEGORY
          MOVE      PMCDCTYP,CODE
          CALL      CODITM00                * concession card type
          GOTO      CCRD9999
.
CCRD0300  WRITE     HTMLFILE;PMCDCNUM;      * concession card number
          GOTO      CCRD9999
.
CCRD0400  MATCH     SP70,PMCDEXDT
          GOTO      CCRD9999 IF EQUAL
          GOTO      CCRD9999 IF EOS
          UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;DISPDATE;      * concession card expiry date
          GOTO      CCRD9999
.
CCRD0500  WRITE     HTMLFILE;NEWREGFL;      * came from new registration
          GOTO      CCRD9999
.
CCRD0600  MOVE      "DX",CATEGORY
          MOVE      PMCDDVAC,CODE
          CALL      CODITM00
          GOTO      CCRD9999
.
CCRD0700  MOVE      ONE,DVACFLAG            * using DVA card colour
          MOVE      ZERO,FORMATTY         * Output Format Type - 0=Table, 1=JSON
          CALL      LSTCCD00                * list concession cards
          GOTO      CCRD9999
.
CCRD0800  WRITE     HTMLFILE;CTYPINDC;      * card type indicator
          GOTO      CCRD9999
.
CCRD0900  WRITE     HTMLFILE;BUTTFLAG;
          GOTO      CCRD9999
.
CCRD1000  WRITE     HTMLFILE;REGIFLAG;
          GOTO      CCRD9999
.
CCRD1100  MOVE      ZERO,DVACFLAG         * not using DVA card colour
          MOVE      ONE,FORMATTY          * Output Format Type - 0=Table, 1=JSON
          CALL      LSTCCD00              * list concession cards
          GOTO      CCRD9999
.
CCRD1200  MOVE      "cH",CATEGORY         * Get Concession Card Update Reason
          MOVE      PTCCUPDR,CODE
          CALL      CODITM00
          GOTO      CCRD9999
.
CCRD1300  CALL      CCHIV000              * Concession Card History view
          GOTO      CCRD9999
.
CCRD1400  CALL      PATNAA00              * Get Patient Name
          WRITE     HTMLFILE;PATFNAME;
          GOTO      CCRD9999
.
CCRD1500  CALL      DELCCN00              * List Deleted Concession Cards
          GOTO      CCRD9999
.
CCRD1600  CALL      CCDLST00              * List Concession Cards in table view
          GOTO      CCRD9999
.
CCRD9999  RETURN
+
.------------------------------------------------------------
. List Concession Cards
.------------------------------------------------------------
LSTCCD00  IF        FORMATTY=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ELSE
            WRITE     HTMLFILE;"[";
            MOVE      ZERO,FIRSTREC
          ENDIF
.
          PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
LSTCCD10  CALL      RPPMCCD1
          BRANCH    OVRCD,LSTCCD99
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      LSTCCD99 IF NOT EQUAL
.
          MOVE      SP70,DISPDVAC
          MATCH     SP70,PMCDDVAC
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF
          ENDIF
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      SP70,TCINDC1
          ENDIF
.
          MATCH     SP70,PMCDEXDT
          IF        @EQUAL | @EOS
            MOVE      SP70,DISPDATE
          ELSE
            UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          IF        FORMATTY=0
            WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:UpdateCCard":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&pmccd002=",PMCDCTYP:
                               "&ctypindc=",TCINDC1:
                               "&pmccd004=",PMCDEXDT,"#")'>":
                               "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               TDESC,"</td>":
                               "<td>",PMCDCNUM,"</td>":
                               "<td>",DISPDATE,"</td>";
            IF        DVACFLAG=1
              WRITE     HTMLFILE;"<td>",DISPDVAC,"</td>";
            ENDIF
            WRITE     HTMLFILE;"<td>":
                               "<input type=button class=button value=Delete ":
                               "onClick='DeleteConcessCard(#"",URNUMBER:
                               "#",#"",PMCDEXDT:
                               "#",#"",PMCDCTYP:
                               "#");'></td>":
                               "</tr>";
          ELSE
            IF        FIRSTREC=0
              MOVE      ONE,FIRSTREC
            ELSE
              WRITE     HTMLFILE;","
            ENDIF
            WRITE     HTMLFILE;"{#"urnumber#":#"",URNUMBER,"#",":
                                "#"cardName#":#"",TDESC,"#",":
                                "#"cardType#":#"",PMCDCTYP,"#",":
                                "#"cardIndicator#":#"",TCINDC1,"#",":
                                "#"cardNo#":#"",PMCDCNUM,"#",":
                                "#"cardExpiry#":#"",PMCDEXDT,"#",":
                                "#"cardColor#":#"",DISPDVAC,"#",":
                                "#"displayDate#":#"",DISPDATE,"#",":
                                "#"cardColorCode#":#"",PMCDDVAC,"#"}";
          ENDIF
          GOTO      LSTCCD10
.
LSTCCD99  IF        FORMATTY=1
            WRITE     HTMLFILE;"]"
          ENDIF
          RETURN
+
.------------------------------------------------------------------------------
.  List concession Cards in table view 
.------------------------------------------------------------------------------
CCDLST00  PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
CCDLST10  CALL      RPPMCCD1
          BRANCH    OVRCD,CCDLST99
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      CCDLST99 IF NOT EQUAL
.
          MOVE      SP70,DISPDVAC
          MATCH     SP70,PMCDDVAC                   * DVA Card Colour (Cat DX)
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF
          ENDIF
.
          PACK      KEY5,CATct,PMCDCTYP,SP70       * Card Type (Category ct)
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      SP70,TCINDC1
          ENDIF
.
          MATCH     SP70,PMCDEXDT                  * Card Expiry Date
          IF        @EQUAL | @EOS
            MOVE      SP70,DISPDATE
          ELSE
            UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "<input type=button class=button ",HTMLLINK
          APPEND    "value='Delete' ",HTMLLINK
          APPEND    "onclick=\#"DeleteConcessCard('",HTMLLINK
          APPEND    PMCDURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCDEXDT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCDCTYP,HTMLLINK
          APPEND    "')\#">",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/MaintenanceIcon.gif'":
                             " class=ListIcon onclick=\#"UpdateCCard1('":
                                  PMCDURNO,"','",PMCDCTYP,"','",TCINDC1,"','":
                                  PMCDEXDT,"');\#">&nbsp;",TDESC,"#",":   *0   
                             "#"",PMCDCNUM,"#",":                         *1
                             "#"",DISPDATE,"#",":                         *2
                             "#"",PMCDEXDT,"#",":                         *3
                             "#"",DISPDVAC,"#",":                         *4
                             "#"",SPACEFIV,"#",":                         *5
                             "#"",HTMLLINK,"#"":                          *6
                             ");"
          GOTO      CCDLST10   
.
CCDLST99  RETURN
+
.------------------------------------------------------------------------------
. List Deleted Concession Cards 
.------------------------------------------------------------------------------
DELCCN00  COMPARE   ONE,AUDTATRB
          GOTO      DELCCN99 IF EQUAL
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTCCH1
DELCCN10  CALL      RPPTCCH1
          BRANCH    OVRCD,DELCCN99
.
          MATCH     URNUMBER,PTCCURNO
          GOTO      DELCCN99 IF NOT EQUAL
.
          MATCH     "D",PTCCUPDT
          GOTO      DELCCN10 IF NOT EQUAL
.
          MOVE      SP70,DISPDVAC
          MATCH     SP70,PTCCDVAC
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PTCCDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF
          ENDIF
.
          PACK      KEY5,CATct,PTCCCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      SP70,TCINDC1
          ENDIF
.
          MATCH     SP70,PTCCEXDT
          IF        @EQUAL | @EOS
            MOVE      SP70,DISPDATE
          ELSE
            UNPACK    PTCCEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/spacer2.gif'":
                             " class=ListIcon;>&nbsp;",TDESC,"#",":    *0
                             "#"",PTCCCNUM,"#",":                      *1
                             "#"",DISPDATE,"#",":                      *2
                             "#"",PMCDEXDT,"#",":                      *3
                             "#"",DISPDVAC,"#",":                      *4
                             "#"",CONSTYES,"#",":                      *5
                             "#"",SPACEFIV,"#");"                      *6
.
          GOTO      DELCCN10
.
DELCCN99  RETURN
.------------------------------------------------------------------------------
. Concession Card History view
.------------------------------------------------------------------------------
CCHIV000  COMPARE   ONE,AUDTATRB
          GOTO      CCHIV999 IF EQUAL
.
          PACK      KEY35,URNUMBER,SP70
          CALL      RSPTCCH1
CCHIV010  CALL      RKPTCCH1
          BRANCH    OVRCD,CCHIV999
.
          MATCH     URNUMBER,PTCCURNO           * Check if URNO is same
          GOTO      CCHIV999 IF NOT EQUAL
.
          PACK      CRDTPDES,SP70
          MATCH     PTCCCTYP,SP70
          IF        !@EQUAL
            PACK      KEY5,CATct,PTCCCTYP,SP70   * Card Type Description
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      CRDTPDES,TDESC,SP70
            ENDIF
          ENDIF
.
          PACK      DISPDATE,SP70
          MATCH     SP70,PTCCEXDT               * Card Expiry Date
          IF        @EQUAL | @EOS
            MOVE      SP70,DISPDATE
          ELSE
            UNPACK    PTCCEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTCCPEXD               * Previous Expiry Date
          IF        @EQUAL | @EOS
            MOVE      SP70,DISPDAT1
          ELSE
            UNPACK    PTCCPEXD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      DISPDVAC,SP70
          MATCH     SP70,PTCCDVAC              * DVA Card Colour
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PTCCDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF
          ENDIF
.
.         DVA Card colour Description
          PACK      DISPDVA1,SP70
          MATCH     SP70,PTCCPCDC              * Previous Card Colour
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PTCCPCDC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVA1
            ENDIF
          ENDIF
.
.         Concession Card Type Reason for change
          PACK      CCNRESON,SP70
          MATCH     PTCCUPDR,SP70
          IF        !@EQUAL
            PACK      KEY5,CATcH,PTCCUPDR,SP70   * Card Reason Description
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,CCNRESON       
            ENDIF
          ENDIF
.
          MATCH     ANSA,PTCCUPDT
          IF        @EQUAL
            MOVE      "Added",UPDTYDES
          ELSE
            MATCH     ANSD,PTCCUPDT
              IF        @EQUAL
                MOVE      "Deleted",UPDTYDES
              ELSE
                MOVE      "Updated",UPDTYDES
              ENDIF
          ENDIF
.
          MATCH     SP10,PTCCURID                 * Web User Id
          IF        !@EQUAL
            PACK      KEY10,PTCCURID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              PACK     WBSENAM,SP70
            ENDIF
          ELSE
            PACK     WBSENAM,SP70
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",CRDTPDES,"#",":           *0
                                      "#"",PTCCCNUM,"#",":           *1
                                      "#"",DISPDATE,"#",":           *2
                                      "#"",DISPDVAC,"#",":           *3
                                      "#"",UPDTYDES,"#",":           *4
                                      "#"",CCNRESON,"#",":           *5
                                      "#"",DISPDAT1,"#",":           *6
                                      "#"",DISPDVA1,"#",":           *7
                                      "#"",WBSENAM,"#",":            *8
                             "#"",PTCCDATE,PTCCTIME,"#");"           *9
.
          GOTO      CCHIV010
.
CCHIV999  RETURN
.------------------------------------------------------------------------------
. Remote Scripting for default address
.------------------------------------------------------------------------------
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
          BRANCH    REMOTENO,REMOTE10,REMOTE20,REMOTE30
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE90
.
REMOTE10  CALL      GETD0000
          GOTO      REMOTE90
.
REMOTE20  CALL      GETBMI00
          GOTO      REMOTE90
.
REMOTE30  MOVE      PTATR006,PTARVAL1
          MOVE      PTATR007,PTARVAL2
          CALL      CLCBMI00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    BODMASIN:
                    "</RETURN_VALUE>"
.
          GOTO      REMOTE90
.
REMOTE90  CALL      XMLEND00
.
REMOTE99  RETURN
.
.-----------------------------------------------------------
. Get the default address for the alternate ID type
.-----------------------------------------------------------
GETD0000  PACK      KEY3,ALTIDTYP,SP70
          CALL      RDPMDAA1
          BRANCH    OVRCD,GETD9000
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMDAADD1,"|":
                    PMDAADD2,"|":
                    PMDAADD3,"|":
                    PMDAADD4,"|":
                    PMDAPOST,"|":
                    PMDAPHON,"|":
                    "</RETURN_VALUE>"
          GOTO      GETD9999
.
GETD9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    " |":
                    "</RETURN_VALUE>"
GETD9999  RETURN
.
.------------------------------------------------------------
. Extra contact details maintenance
.------------------------------------------------------------
EXCONT00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EXCONT50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      EXCONT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      EXCONT20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      EXCONT30 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote contact type validation
          GOTO      EXCONT40 IF EQUAL
.
          GOTO      EXCONT90
.
.         ************ ADD FORMACTION ***********
.
EXCONT10  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXCONT93
.
          CALL      CONC0000                      * Calculate contact counter
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      RAPMCEX1
          COMPARE   ZERO,OVRCD
          GOTO      EXCONT91 IF EQUAL
.
          CALL      CLPMSCEX                     * Clear file vars
          CALL      MVPMCE00                     * Move cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMCECDAT                * System date
          CLOCK     TIME,PMCECTIM                * System time
          MOVE      USERID,PMCECUID              * web user id
.
          MOVE      SP70,PMCEUDAT
          MOVE      SP70,PMCEUTIM
          MOVE      SP70,PMCEUUID
.
          MATCH     "1",PMCEACTV
          IF        !@EQUAL
            MOVE      SP70,PMCEDINA              * Clear date inactivated
          ENDIF
.
          CALL      CONU0000                     * Get contact webPAS unique id
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      WRPMCEX1                     * Writes the data
.  write nsw edw record for contact added
          MOVE      PMCEURNO,PMEWURNO
          MOVE      "14",PMEWTYPE       * contact added
          PACK      KEY5,CATTC,PMCETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "2",TCINDC1
            IF        @EQUAL
              MOVE      "12",PMEWTYPE    * postal address added
            ENDIF
          ENDIF
          PACK      PMEWOLDV,SP70
          PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
          CALL      WREDW000
.
          CALL      UPRF0000                     * Update Usual PRF if Inactive
.
.         If we are using the new contacts table (pmscexaf), then 
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.         
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD            
            PROC      DGCLICUP              * send PMI update message
          ENDIF
.
          MOVE      ONE,AUDTTYPE            * write add audit record
          CALL      WAPMCE00
.
          CALL      PPRFA000                * use postal address for PRFA
.
          MOVE      ZERO,EXIT
          GOTO      EXCONT99
.
.         ************ UPDATE FORMACTION **********
.
EXCONT20  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      RDPMCEX1
          BRANCH    OVRCD,EXCONT92
.
          MOVE      TWO,AUDTTYPE                 * write before audit record
          CALL      WAPMCE00
.
          CALL      MVPMCE00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMCEUDAT                * System date
          CLOCK     TIME,PMCEUTIM                * System time
          MOVE      USERID,PMCEUUID              * web user id
.
          MATCH    "1",PMCEACTV
          IF       !@EQUAL
            MOVE     SP70,PMCEDINA               * Clear date inactivated
          ENDIF
.
          CALL      UPPMCEX1                     * Updates the data
.  write nsw edw record for contact updated
          MOVE      PMCEURNO,PMEWURNO
          MOVE      "15",PMEWTYPE
          PACK      KEY5,CATTC,PMCETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "2",TCINDC1
            IF        @EQUAL
              MOVE      "13",PMEWTYPE    * postal address added
            ENDIF
          ENDIF
.
          PACK      PMEWOLDV,SP70
          PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
          CALL      WREDW000
.
          CALL      UPRF0000                     * Update Usual PRF if Inactive
.
.         If we are using the new contacts table (pmscexaf), then 
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.         
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FIVE,HL7TRGID
            MOVE      SP8,HL7INCLD            
            PROC      DGCLICUP              * send PMI update message
          ENDIF
.
          MOVE      THREE,AUDTTYPE               * write after audit record
          CALL      WAPMCE00
.
          CALL      PPRFA000                * use postal address for PRFA
.
          MOVE      ZERO,EXIT
          GOTO      EXCONT99
.
.         ************ DELETE FORMACTION **********
.
EXCONT30  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70 *Now Delete Department
          CALL      RDPMCEX1
          BRANCH    OVRCD,EXCONT92
.
          CALL      DEPMCEX1                        * Deletes the data
.
          MATCH     "1",PTCNNEWC              * using new contacts ?
          IF        @EQUAL
            MATCH     PMPXUPRF,PMCETYPE
            IF        @EQUAL
              MOVE      SP70,PMPXUPRF         * Usual PRFA
              CALL      UPPMPX21
            ENDIF
          ENDIF
.
.         If we are using the new contacts table (pmscexaf), then 
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.         
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SIX,HL7TRGID
            MOVE      SP8,HL7INCLD            
            PROC      DGCLICUP              * send PMI update message
          ENDIF
.
          MOVE      FOUR,AUDTTYPE           * write delete audit record
          CALL      WAPMCE00
.
          MOVE      ZERO,EXIT
          GOTO      EXCONT99
.
.         ************ REMOTE SCRIPT CONTACT TYPE VALIDATION **********
.
EXCONT40  CALL      VCON0000                * Remote contact type validation
.
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT50  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXCONT93
.
          PACK      KEY8,ADMISSNO,SP70
          MATCH     SP70,KEY8
          IF        !@EQUAL
            CALL      RDMISS1
            IF        OVRCD=1
              CALL      CLPATMIS
            ENDIF
          ENDIF
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      RDPMCEX1                      * Read department table
          IF        OVRCD=1
            CALL      CLPMSCEX                    * Clear all the file variables
          ENDIF
.
          MATCH     SP70,AUDITKEY
          IF        !@EQUAL
            PACK      KEY33,AUDITKEY,SP70
            CALL      ADPMCEX2
            IF        OVRCD=1
              CALL      CLPMSCEX                  * Clear all the file variables
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Extra Contact Details Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXCONT99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT91  MOVE      "Contact Details Exist",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT92  MOVE      "Invalid Contact Detail Record",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT93  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      SHWERR00
          MOVE      ONE,EXIT
          GOTO      EXCONT99
.
EXCONT99  IF        CALLTYPE=1
            CALL      AJXEND00       * AJAX Request
          ENDIF
          RETURN
+
.------------------------------------------------------------
.         Update Usual PRFA if Contact becomes inactive
.------------------------------------------------------------
UPRF0000  MATCH     "1",PTCNNEWC                 * using new contacts ?
          GOTO      UPRF9999 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV               * Inactive ?
          GOTO      UPRF9999 IF NOT EQUAL
.
          MATCH     PMCETYPE,PMPXUPRF
          GOTO      UPRF9999 IF NOT EQUAL
.
          MOVE      SP70,PMPXUPRF          * Usual PRFA blank
          CALL      UPPMPX21
.
UPRF9999  RETURN
+
.------------------------------------------------------------
. Use postal address for PRFA
.------------------------------------------------------------
PPRFA000  MATCH     "1",POSTPRFA
          GOTO      PPRFA999 IF NOT EQUAL
.
          MATCH     SP70,ADMISSNO
          GOTO      PPRFA999 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDRESP1               * use postal address for PRFA
          IF        OVRCD=1
            MOVE      ADMISSNO,PKADMN
            MOVE      PTMASNAM,PACSNAMX
            MOVE      PGNAME,ANS
            PACK      PACGNAME,ANS,DOT
            MOVE      PTITL,PACTITLE
            MOVE      THREE,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAMX,PKNAME
            MOVE      PMCEADD1,PKADD1
            MOVE      PMCEADD2,PKADD2
            MOVE      PMCEADD3,PKSUBR
            MOVE      PMCEADD4,PKADD4
            MOVE      PMCEPOST,PKPOST
            MOVE      PTELEP,PKTELEP
            MOVE      PTELEB,PKTELEB
            MOVE      "SELF",PKRELP
            MOVE      PTMXCELL,PTREMOBL
            MOVE      PTMASNAM,PTRESNAM
            MOVE      PGNAME,PTREGNAM
            MOVE      SP70,PTRESPAR
            CALL      WRRESP1
          ELSE
            MOVE      PMCEADD1,PKADD1
            MOVE      PMCEADD2,PKADD2
            MOVE      PMCEADD3,PKSUBR
            MOVE      PMCEADD4,PKADD4
            MOVE      PMCEPOST,PKPOST
            CALL      UPRESP1
          ENDIF
PPRFA999  RETURN
.------------------------------------------------------------
. Alternative Visit Audit - ALTV0000
.------------------------------------------------------------
ALTV0000  BRANCH    FLDITMNO,ALTV0100
          GOTO      ALTV9999
.
ALTV0100  CALL      TABAVS00          * Table of alternative audit vist
          GOTO      ALTV9999
.
ALTV9999  RETURN
.------------------------------------------------------------
. OutPut of IBAALVTD - IBAALT00
.------------------------------------------------------------
IBAALT00  BRANCH    FLDITMNO,IBAALT10,IBAALT20,IBAALT30
                    
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      IBAALT99
.
IBAALT10  WRITE     HTMLFILE;IBAVVISN;
          GOTO      IBAALT99
.
IBAALT20  WRITE     HTMLFILE;IBAVAVIS;
          GOTO      IBAALT99
.
IBAALT30  MATCH     SP70,IBAVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"External ID";
          ENDIF
.
          MATCH     " 1",IBAVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"External ID";
          ENDIF
.
          MATCH     " M",IBAVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"MOSAIQ Visit";
          ENDIF
.
          GOTO      IBAALT99
.
IBAALT99  RETURN
.------------------------------------------------------------
. Table of Alternative Visit Audit - TABAVS00
.------------------------------------------------------------
TABAVS00  MATCH     SP70,ADMISSNO 
          GOTO      TABAVS99 IF EQUAL
.
          MATCH     "       0",ADMISSNO
          GOTO      TABAVS99 IF EQUAL
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPMALV1
TABAVS10  CALL      RPPMALV1
          BRANCH    OVRCD,TABAVS99
.
          MATCH     PMVAVISN,ADMISSNO
          GOTO      TABAVS10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr>";
.         External Visit No
          WRITE     HTMLFILE;"<td class=DataLabel nowrap>",PMVAAVIS,"</td>";
.         Record Type
          MATCH     SP70,PMVATYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=DataLabel nowrap >External ID</td>";
          ENDIF
.
          MATCH     " 1",PMVATYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=DataLabel nowrap>Legacy Visit</td>";
          ENDIF
.
          MATCH     " M",PMVATYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=DataLabel nowrap>MOSAIQ Visit</td>";
          ENDIF
.         Date/Time
          UNPACK    PMVADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                               SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<td class=DataLabel nowrap>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                    SP2,PMVATIME,"</td>";
.         User
          MOVE      SP70,WEBUSRPM
          MATCH     SP70,PMVACUID
          IF        !@EQUAL
            PACK      KEY10,PMVACUID,SP70
            CALL      RDWBSE1
            IF        OVRCD = 1
              MOVE    SP70,WEBUSRPM
            ENDIF
            MOVE      WBSENAM,WEBUSRPM
          ENDIF
          WRITE     HTMLFILE;"<td class=DataLabel nowrap >",WEBUSRPM,"</td>";
.         Action
          MATCH     "1",PMVAACTN
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=DataLabel nowrap >Added</td>";
          ENDIF
.
          MATCH     "2",PMVAACTN
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=DataLabel nowrap >Deleted</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
          WRITE     HTMLFILE;"<tr><td colspan=5><b>Comments</b>":
                             "  -  ",PMVACOMM,"</td></tr>";
          GOTO      TABAVS10
.
TABAVS99  RETURN
+
.------------------------------------------------------------
. General Tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0100,GTAG0200,GTAG0300,GTAG0400,GTAG0500:
                             GTAG0600,GTAG0700,GTAG0800,GTAG0900,GTAG1000:
                             GTAG1100,GTAG1200,GTAG1300,GTAG1400,GTAG1500:
                             GTAG1600,GTAG1700,GTAG1800,GTAG1900,GTAG2000:
                             GTAG2100,GTAG2200,GTAG2300,GTAG2400,GTAG2500:
                             GTAG2600,GTAG2700,GTAG2800,GTAG2900,GTAG3000:
                             GTAG3100,GTAG3200,GTAG3300,GTAG3400,GTAG3500:
                             GTAG3600,GTAG3700,GTAG3800,GTAG3900,GTAG4000:
                             GTAG4100,GTAG4200,GTAG4300
          GOTO      GTAG9999
.
GTAG0100  CALL      LSTEXC00
          GOTO      GTAG9999
.
GTAG0200  WRITE     HTMLFILE;SHWPRINT;
          GOTO      GTAG9999
.
GTAG0300  WRITE     HTMLFILE;CASEKEYS;
          GOTO      GTAG9999
.
GTAG0400  CALL      LSTPAY00
          GOTO      GTAG9999
.
GTAG0500  WRITE     HTMLFILE;WAITFLAG;
          GOTO      GTAG9999
.
GTAG0600  WRITE     HTMLFILE;TRNSFLAG;
          GOTO      GTAG9999
.
GTAG0700  CALL      CEXT0000        * Tablesort Extra Contacts
          GOTO      GTAG9999
.
GTAG0800  CALL      PRFA0000        * Person Responsible for account table
          GOTO      GTAG9999
.
GTAG0900  WRITE     HTMLFILE;INACTIVE;
          GOTO      GTAG9999
.
GTAG1000  WRITE     HTMLFILE;CPMISKEY;
          GOTO      GTAG9999
.
GTAG1100  WRITE     HTMLFILE;OTHRCONT;
          GOTO      GTAG9999
.
GTAG1200  CALL      CHIS0000        * Extra Contacts History
          CALL      DHIS0000        * Deleted Extra Contact History
          GOTO      GTAG9999
.
GTAG1300  MOVE      "tc",CATEGORY
          MOVE      FILTCTYP,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG1400  CALL      DETH0000        * Detailed history list for a contact
          GOTO      GTAG9999
.
GTAG1500  MOVE      "tc",CATEGORY
          MOVE      PMCEX002,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG1600  WRITE     HTMLFILE;PMCEX003;
          GOTO      PMCE9999
.
GTAG1700  CALL      LSTATT00
          GOTO      GTAG9999
.
GTAG1800  CALL      PATATR00
          WRITE     HTMLFILE;BMIINDIC;
          GOTO      GTAG9999
.
GTAG1900  CALL      LST5AT00
          GOTO      GTAG9999
.
GTAG2000  CALL      PATATR00
          WRITE     HTMLFILE;PTARVAL1;
          GOTO      GTAG9999
.
GTAG2100  CALL      PATATR00
          WRITE     HTMLFILE;PTARVAL2;
          GOTO      GTAG9999
.
GTAG2200  PACK      BODMASIN,PTARVAL3,SP70
          CALL      RNGBMI00
          WRITE     HTMLFILE;BODMASRN;
.
GTAG2300  WRITE     HTMLFILE;ADMISNID;
          GOTO      GTAG9999
.
GTAG2400  CALL      LSTCEX00
          GOTO      GTAG9999
.
GTAG2500  MOVE      "rt",CATEGORY
          MOVE      PMPXRPER,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG2600  MATCH     SP70,PMPXRDAT
          GOTO      GTAG9999 IF EQUAL
          UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      GTAG9999
.
GTAG2700  MATCH     SP70,RECRETDT
          GOTO      GTAG9999 IF EQUAL
          UNPACK    RECRETDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      GTAG9999
.
GTAG2800  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      RECRETDT,AGEDATE             * use visit/discharge date
          CALL      CALCAGE
          WRITE     HTMLFILE;PSAGEYRS;
          GOTO      GTAG9999
.
GTAG2900  WRITE     HTMLFILE;EREFRLID;
          GOTO      GTAG9999
.
GTAG3000  CALL      SLCONT00                * Select a contact
          GOTO      GTAG9999
.
GTAG3100  WRITE     HTMLFILE;UPINUMBR;      * UPI Number
          GOTO      GTAG9999
.
GTAG3200  CALL      LSTMHA00                * List mh attributes
          GOTO      GTAG9999
.
GTAG3300  CALL      CHKDOC00                * check for MH doctor
          GOTO      GTAG9999
.
GTAG3400  PACK      KEY8,ADMISSNO
          CALL      RDDSCH1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     SP70,DDATE
          GOTO      GTAG9999 IF EQUAL
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      GTAG9999
.
GTAG3500  PACK      KEY8,ADMISSNO
          CALL      RDDSCH1
          BRANCH    OVRCD,GTAG9999
.
          MATCH     SP70,DTIME
          GOTO      GTAG9999 IF EQUAL
.
          WRITE     HTMLFILE;DTIME;
          GOTO      GTAG9999
.
GTAG3600  CALL      LSNDIS00                * List NDIS details
          GOTO      GTAG9999
.
GTAG3700  CALL      LMLBRA00  
          GOTO      GTAG9999
.
GTAG3800  CALL      SLCAR000                * Select a carer
          GOTO      GTAG9999
.
GTAG3900  MOVE      "ZS",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG4000  MOVE      "ZS",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG4100  CALL      LSTATR00
          GOTO      GTAG9999
.
GTAG4200  CALL      LSEXPD00
          GOTO      GTAG9999
.
GTAG4300  WRITE     HTMLFILE;PTCNHDPS;
          GOTO      GTAG9999
.
GTAG9999  RETURN
.
.------------------------------------------------------------
. Get latest patatraf row for type 024 
.------------------------------------------------------------
LSTATR00  UNPACK    DIM127,DIM1,KEY3,DIM127
          MOVE      "024",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
          CALL      RSPTATR3               
          CALL      RPPTATR3               
          BRANCH    OVRCD,LSTATR99
.
          MATCH     URNUMBER,PTARURNO       * Same U/R
          GOTO      LSTATR99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN       * Same Visit
          GOTO      LSTATR99 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE         
          GOTO      LSTATR99 IF NOT EQUAL
.
          MOVE      ZERO,F3
          MOVE      KEY3,F3
.
          BRANCH    F3,LSTATR10,LSTATR20
          GOTO      LSTATR99
.
LSTATR10  MATCH     SP70,PTARDATE
          GOTO      LSTATR99 IF EQUAL
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      LSTATR99
.
LSTATR20  MATCH     SP70,PTARTIME
          GOTO      LSTATR99 IF EQUAL
          WRITE     HTMLFILE;PTARTIME;
          GOTO      LSTATR99
.
LSTATR99  RETURN
.
.------------------------------------------------------------
. Check if this patient had a mh doctor
.------------------------------------------------------------
CHKDOC00  MOVE      ZERO,EXIT
          MATCH     SP70,ADMISSNO
          GOTO      CHKDOC90 IF EQUAL
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
CHKDOC10  CALL      RDPTRAN2
          BRANCH    OVRCD,CHKDOC90
.
          MATCH     ADMISSNO,DTADMN
          GOTO      CHKDOC90 IF NOT EQUAL
.
          PACK      KEY9,TADOCT,SP70
          CALL      RSPMDUN1
CHKDOC20  CALL      RKPMDUN1
          BRANCH    OVRCD,CHKDOC10
.
          MATCH     TADOCT,PMDUDOCT
          GOTO      CHKDOC10 IF NOT EQUAL
.
          PACK      KEY5,ANSD,ANST,PMDUUNIT,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSL,TCINDC1
            IF        @EQUAL
              MOVE      ONE,EXIT
              GOTO      CHKDOC90
            ENDIF
          ENDIF
.
          GOTO      CHKDOC20
.
CHKDOC90  WRITE     HTMLFILE;EXIT;
.
CHKDOC99  RETURN
+
.------------------------------------------------------------
. Extra Contact list (sort table)
.------------------------------------------------------------
CEXT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
CEXT0010  CALL      RKPMCEX1
          BRANCH    OVRCD,CEXT0099
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      CEXT0099 IF NOT EQUAL
.
          MATCH     ANSY,INACTIVE
          IF        !@EQUAL
            MATCH     "1",PMCEACTV
            GOTO      CEXT0010 IF EQUAL
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,PMCETYPE
          IF        !@EQUAL
            PACK      KEY5,CATTC,PMCETYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMCETYPE,TDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,PMTLDESC
          MATCH     SP70,PMCETITL
          IF        !@EQUAL
            PACK      KEY4,PMCETITL,SP70
            CALL      RDPMTLE1
            IF        OVRCD=1
              MOVE      PMCETITL,PMTLDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
CEXT0080  CLEAR     HTMLLINK
          APPEND    "javascript:ShowContact('",HTMLLINK
          APPEND    PMCEURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCETYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCECNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "No",DIM3
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
.
          MOVE      "No",D3
          MATCH     "1",PMCEACTV
          IF        @EQUAL
            MOVE      "Yes",D3
          ENDIF
.
          MOVE      "No",DESCSSMS
          MATCH     "1",PMCESSMS
          IF        @EQUAL
            MOVE      "Yes",DESCSSMS
          ENDIF
.
          REP       UPPLOW,PMCEGNAM
          REP       UPPLOW,PMCEGNM2
          REP       UPPLOW,PMCESNAM
          REP       UPPLOW,PMCEADD1
          REP       UPPLOW,PMCEADD2
          REP       UPPLOW,PMCEADD3
          REP       UPPLOW,PMCEADD4
          REP       "#"'",PMCEGNAM
          REP       "#"'",PMCEGNM2
          REP       "#"'",PMCESNAM
          REP       "#"'",PMCEADD1
          REP       "#"'",PMCEADD2
          REP       "#"'",PMCEADD3
          REP       "#"'",PMCEADD4
          REP       "#"'",PMCEPOST
          REP       "#"'",PMCETELP
          REP       "#"'",PMCETELB
          REP       "#"'",PMCETELM
          REP       "#"'",PMCEEMAI
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",TDESC,"#",":                 *1
                                      "#"",PMRLDESC,"#",":              *2
                              "#"",PMCEGNAM," ",PMCEGNM2," ",PMCESNAM,"#",": *3
                                      "#"",PMCETELP,"#",":              *4
                                      "#"",PMCETELB,"#",":              *5
                                      "#"",PMCETELM,"#",":              *6
                                      "#"",PMCEADD1," ",PMCEADD2:
                                      " ",PMCEADD3," ",PMCEADD4:
                                      " ",PMCEPOST,"#",":               *7
                                      "#"",DIM3,"#",":                  *8
                                      "#"",D3,"#",":                    *9
                                      "#"",TCFORM6,"#",":               *10
                                      "#"",PMCEEMAI,"#",":              *11
                                      "#"",DESCSSMS,"#",":              *12
                                      "#"",PMCEFTXT,"#");"              *13
.
          GOTO      CEXT0010
.
CEXT0099  RETURN
.
.------------------------------------------------------------
. List Certificates
.------------------------------------------------------------
LSTEXC00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
LSTEXC10  CALL      RKPMCEX1
          BRANCH    OVRCD,LSTEXC99
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      LSTEXC99 IF NOT EQUAL
.
          MATCH     ANSY,INACTIVE
          IF        !@EQUAL
            MATCH     "1",PMCEACTV
            GOTO      LSTEXC10 IF EQUAL
          ENDIF
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF 
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF 
.
LSTEXC80  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:":
                             "UpdateContact":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&pmcex001=",PMCEURNO:
                             "&pmcex002=",PMCETYPE:
                             "&pmcex003=",PMCECNTR,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             TDESC,"</td>":
                             "<td>",PMTLDESC,"</td>":
                             "<td>",PMCESNAM,"</td>":
                             "<td>",PMCEGNAM,"</td>":
                             "<td>",PMRLDESC,"</td>":
                             "</tr>";
          GOTO      LSTEXC10
.
LSTEXC99  RETURN
.
.
.------------------------------------------------------------
. Select a Contact
.------------------------------------------------------------
SLCONT00  PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
SLCONT10  CALL      RKPMCEX1
          BRANCH    OVRCD,SLCONT99
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      SLCONT99 IF NOT EQUAL
.
          MATCH     ANSY,INACTIVE
          IF        !@EQUAL
            MATCH     "1",PMCEACTV
            GOTO      SLCONT10 IF EQUAL
          ENDIF
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          MOVE      SP70,DISPDATE
.
          MATCH     SP70,PMCECDOB
          IF        !@EQUAL & !@EOS
            UNPACK    PMCECDOB,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      PMCEGNAM,DIM40
          MOVE      PMCESNAM,DIM40A
.
          REP       "'`",PMCEGNAM
          REP       "'`",PMCESNAM
          REP       "'`",PMCEADD1
          REP       "'`",PMCEADD2
          REP       "'`",PMCEADD3
          REP       "'`",PMCEADD4

.
SLCONT80  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:":
                             "selectContact":
                             "(#"",PMCEGNAM,"#",#"":
                             PMCESNAM,"#",#"":
                             PMCEADD1,"#",#"":
                             PMCEADD2,"#",#"":
                             PMCEADD3,"#",#"":
                             PMCEADD4,"#",#"":
                             PMCEPOST,"#",#"":
                             PMCECMED,"#",#"":
                             PMCECREF,"#",#"":
                             DISPDATE,"#");'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             TDESC,"</td>":
                             "<td>",PMRLDESC,"</td>":
                             "<td>",DIM40,DIM40A,"</td>":
                             "</tr>"
          GOTO      SLCONT10
.
SLCONT99  RETURN
.
.------------------------------------------------------------
. Select a Carer
.------------------------------------------------------------
SLCAR000  PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
SLCAR010  CALL      RKPMCEX1
          BRANCH    OVRCD,SLCAR999
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      SLCAR999 IF NOT EQUAL
.
          MATCH     ANSY,INACTIVE
          IF        !@EQUAL
            MATCH     "1",PMCEACTV
            GOTO      SLCAR010 IF EQUAL
          ENDIF
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ELSE
            MATCH     SP70,TCINDC24
            GOTO      SLCAR010 IF EQUAL
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          MOVE      SP70,DISPDATE
.
          MATCH     SP70,PMCECDOB
          IF        !@EQUAL & !@EOS
            UNPACK    PMCECDOB,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      PMCEGNAM,DIM40
          MOVE      PMCESNAM,DIM40A
.
          STRIP     PMCEGNAM
          CLEAR     KEY50
          APPEND    PMCEGNAM,KEY50
          APPEND    SP1,KEY50
          APPEND    PMCESNAM,KEY50
.
          REP       "'`",PMCEGNAM
          REP       "'`",PMCESNAM
          REP       "'`",PMCEADD1
          REP       "'`",PMCEADD2
          REP       "'`",PMCEADD3
          REP       "'`",PMCEADD4

.
SLCAR080  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:":
                             "selectCarer":
                             "(#"",PMCEGNAM,"#",#"":
                             PMCESNAM,"#",#"":
                             KEY50,"#",#"":
                             PMCEADD1,"#",#"":
                             PMCEADD2,"#",#"":
                             PMCEADD3,"#",#"":
                             PMCEADD4,"#",#"":
                             PMCEPOST,"#",#"":
                             PMCECMED,"#",#"":
                             PMCECREF,"#",#"":
                             DISPDATE,"#",#"":
                             PMCETELM,"#",#"": 
                             PMCETYPE,"#",#"": 
                             PMCECNTR,"#");'>":
                             "<img src=../images/MaintenanceIcon.gif ":
                             "class=Icon></a>":
                             TDESC,"</td>":
                             "<td>",PMRLDESC,"</td>":
                             "<td>",DIM40,DIM40A,"</td>":
                             "<td>",PMCETELM,"</td>":
                             "</tr>"
          GOTO      SLCAR010
.
SLCAR999  RETURN
.
.------------------------------------------------------------
. Person Responsible for Account table
.------------------------------------------------------------
PRFA0000  PACK      KEY8,ADMISSNO,SP20
          CALL      RDRESP1
          BRANCH    OVRCD,PRFA9000
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
PRFA1000  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:":
                             "UpdatePRFA":
                             "(#"patweb89.pbl":
                             "?reportno=01":
                             "&template=037":
                             "&cpmiskey=",CPMISKEY:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PKNAME,"</td>":
                             "<td>",PKADD1,SP1,PKADD2,SP1,PKSUBR:
                             SP1,PKADD4,SP1,PKPOST,"</td>":
                             "<td>&nbsp;",PKTELEP,"</td>":
                             "<td>&nbsp;",PKTELEB,"</td>":
                             "<td>&nbsp;",PTREMOBL,"</td>":
                             "</tr>";
          GOTO      PRFA9999
.
PRFA9000  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "No Visit Person Responsible Selected</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
PRFA9999  RETURN
.
.------------------------------------------------------------
. Expected Payor Maintenance
.------------------------------------------------------------
EXPPAY00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      EXPPAY50 IF EQUAL
.         
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      EXPPAY10 IF EQUAL 
.         
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      EXPPAY20 IF EQUAL 
.         
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      EXPPAY30 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Swap formaction
          GOTO      EXPPAY40 IF EQUAL
.
          GOTO      EXPPAY90
.
.         ************ ADD FORMACTION ***********
.
EXPPAY10  PACK      KEY14,PMPAY001,PMPAY002,SP70
          CALL      RAPMPAY1
          COMPARE   ZERO,OVRCD
          GOTO      EXPPAY91 IF EQUAL
.
          MOVE      ONE,F2
          PACK      KEY10,PMPAY001,Z70
          CALL      RSPMPAY2                     * Generate sequence number
          CALL      RPPMPAY2
          BRANCH    OVRCD,EXPPAY15
.
          MATCH     PMPAY001,PMPAURNO
          GOTO      EXPPAY15 IF NOT EQUAL
.
          MOVE      PMPASEQN,F2
          ADD       ONE,F2
.
EXPPAY15  CALL      CLPMSPAY                     * Clear file vars
          CALL      MVPMPA00                     * Move cgi to file variables
.
          MOVE      F2,PMPASEQN                  * Allocate sequence number
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPACDAT                * System date
          CLOCK     TIME,PMPACTIM                * System time
          MOVE      USERID,PMPACUID              * web user id
.
          PACK      KEY14,PMPAY001,PMPAY002,SP70
          CALL      WRPMPAY1                     * Writes the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ UPDATE FORMACTION **********
.
EXPPAY20  PACK      KEY14,PMPAY001,PMPAY002,SP70
          CALL      RDPMPAY1
          BRANCH    OVRCD,EXPPAY92
.
          CALL      MVPMPA00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPAUDAT                * System date
          CLOCK     TIME,PMPAUTIM                * System time
          MOVE      USERID,PMPAUUID              * web user id
.
          CALL      UPPMPAY1                     * Updates the data
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ DELETE FORMACTION **********
.
EXPPAY30  PACK      KEY14,PMPAY001,PMPAY002,SP70 
          CALL      RDPMPAY1
          BRANCH    OVRCD,EXPPAY92
.
          CALL      DEPMPAY1                        * Deletes the data
.                                                * resequence all Payors
EXPPAY34  MOVE      ZERO,F2
          PACK      KEY10,PMPAY001,SP70
          CALL      RSPMPAY2                     * Generate sequence number
EXPPAY35  CALL      RKPMPAY2
          BRANCH    OVRCD,EXPPAY39
.
          MATCH     PMPAY001,PMPAURNO
          GOTO      EXPPAY39 IF NOT EQUAL
.
          ADD       ONE,F2
          MOVE      F2,KEY2
          MATCH     KEY2,PMPASEQN
          GOTO      EXPPAY35 IF EQUAL
.
          MOVE      KEY2,PMPASEQN
          CALL      UPPMPAY2
          GOTO      EXPPAY34
.
EXPPAY39  MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ SWAP FORMACTION **********
.
EXPPAY40  PACK      KEY10,PMPAY001,MOVESEQN,SP70
          CALL      RDPMPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      PMPASEQN,SAVESEQN
.
          MOVE      "XX",PMPASEQN                * Move to a temp sequence
          CALL      UPPMPAY2
.
          PACK      KEY10,PMPAY001,MOVTOSEQ,SP70
          CALL      RDPMPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      SAVESEQN,PMPASEQN            * Swap sequences
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPAUDAT                * System date
          CLOCK     TIME,PMPAUTIM                * System time
          MOVE      USERID,PMPAUUID              * web user id
.
          CALL      UPPMPAY2    
.
          PACK      KEY10,PMPAY001,ANSX,ANSX,SP70
          CALL      RDPMPAY2
          BRANCH    OVRCD,EXPPAY92
.
          MOVE      MOVTOSEQ,PMPASEQN            * Move temp sequence back
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPAUDAT                * System date
          CLOCK     TIME,PMPAUTIM                * System time
          MOVE      USERID,PMPAUUID              * web user id
.
          CALL      UPPMPAY2
.
          MOVE      ZERO,EXIT
          GOTO      EXPPAY99
.
.         ************ DISPLAY FORMACTION **********
.
EXPPAY50  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,EXPPAY93
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPPAY93
.
          PACK      KEY14,PMPAY001,PMPAY002,SP70
          CALL      RDPMPAY1                      * Read department table
          IF        OVRCD=1
            CALL      CLPMSPAY                    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Expected Payor Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,EXPPAY99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY91  MOVE      "Expected Payor Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY92  MOVE      "Invalid Expected Payor Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY93  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EXPPAY99
.
EXPPAY99  RETURN
.
.------------------------------------------------------------
. List Expected Payor Details 
.------------------------------------------------------------
LSTPAY00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,LASTSEQN
          PACK      KEY10,URNUMBER,Z70
          CALL      RSPMPAY2
          CALL      RPPMPAY2                * Get highest sequence number
          BRANCH    OVRCD,LSTPAY05
.
          MATCH     URNUMBER,PMPAURNO
          GOTO      LSTPAY05 IF NOT EQUAL
.
          MOVE      PMPASEQN,LASTSEQN
.
LSTPAY05  PACK      KEY10,URNUMBER,SP70
          CALL      RSPMPAY2
LSTPAY10  CALL      RKPMPAY2
          BRANCH    OVRCD,LSTPAY99
.
          MATCH     URNUMBER,PMPAURNO
          GOTO      LSTPAY99 IF NOT EQUAL
.
          PACK      KEY14,PMPAPAYC,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      PMPAPAYC,HFNAME
          ENDIF
.
          MATCH     "1",PMPAACTV
          IF        @EQUAL
            MOVE      "Inactive",DIM8
          ELSE
            MOVE      "Active",DIM8
          ENDIF
.
          MOVE      SP70,DISPDATE
          MATCH     SP70,PMPAUDAT
          IF        !@EQUAL
            UNPACK    PMPAUDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PMPACDAT
          IF        !@EQUAL
            UNPACK    PMPACDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;":
                             "<A HREF='javascript:":
                             "UpdatePayor":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",PMPAURNO:
                             "&pmpay001=",PMPAURNO:
                             "&pmpay002=",PMPAPAYC,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PMPAPAYC,"</td>":
                             "<td>&nbsp;",HFNAME,"</td>";
.
          MOVE      PMPASEQN,DIM2
          REP       " 0",DIM2
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          WRITE     HTMLFILE;"<form action=patweb07.pbl ":
                               "method=post name=moveseq_",DIM2,">":
                             "<input type=hidden name=reportno ":
                              "value=#"07#">":
                             "<input type=hidden name=updttype ":
                              "value=#"S#">":
                             "<input type=hidden name=template ":
                              "value=#"",KEY3,"#">":
                             "<input type=hidden name=pmpay001 ":
                              "value=#"",PMPAURNO,"#">":
                             "<input type=hidden name=moveseqn ":
                              "value=#"",PMPASEQN,"#">":
                             "<td><select name=movtoseq ":
                             " onchange=MoveSeq(moveseq_",DIM2,");>";
.
          MOVE      ZERO,SEQUENCE
          MOVE      PMPASEQN,SEQUENCE
          MOVE      ONE,SEQCOUNT
LSTPAY20  IF        SEQCOUNT=SEQUENCE
            WRITE     HTMLFILE;"<option value=#"",SEQCOUNT,"#" selected>":
                                SEQCOUNT,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",SEQCOUNT,"#">":
                                SEQCOUNT,"</option>";
          ENDIF
          ADD       ONE,SEQCOUNT
.
          COMPARE   SEQCOUNT,LASTSEQN
          GOTO      LSTPAY20 IF NOT LESS
.
          WRITE     HTMLFILE;"</select></td></form>":
                             "<td>&nbsp;",PMPACOMM,"</td>":
                             "<td>&nbsp;",DIM8,"</td>":
                             "<td>&nbsp;",DISPDAT1,"</td>":
                             "<td>&nbsp;",DISPDATE,"</td>":
                             "</tr>"
          GOTO      LSTPAY10
.
LSTPAY99  RETURN
.------------------------------------------------------------
. Patient Referral Maintenance
.------------------------------------------------------------
PMRFL000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PMRFL500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      PMRFL100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      PMRFL200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      PMRFL300 IF EQUAL
.
          GOTO      PMRFL900
.
.         ************ ADD FORMACTION ***********
.
PMRFL100  PACK      KEY26,PMRFL001,PMRFL002,PMRFL003,SP70
          CALL      RDPMRFL1
          COMPARE   ZERO,OVRCD
          GOTO      PMRFL910 IF EQUAL
.
          CALL      CLPMSRFL                     * Clear file vars
          CALL      MVPMRF00                     * Move cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMRFCDAT                * System date
          CLOCK     TIME,PMRFCTIM                * System time
          MOVE      USERID,PMRFCUID              * web user id
.
          PACK      KEY26,PMRFL001,PMRFL002,PMRFL003,SP70
          CALL      WRPMRFL1                     * Writes the data
.
          MOVE      ZERO,EXIT
          GOTO      PMRFL999
.
.         ************ UPDATE FORMACTION **********
.
PMRFL200  PACK      KEY26,PMRFL001,PMRFL002,PMRFL003,SP70
          CALL      RDPMRFL1
          BRANCH    OVRCD,PMRFL920
.
          CALL      MVPMRF00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMRFUDAT                * System date
          CLOCK     TIME,PMRFUTIM                * System time
          MOVE      USERID,PMRFUUID              * web user id
.
          CALL      UPPMRFL1                     * Updates the data
.
          MOVE      ZERO,EXIT
          GOTO      PMRFL999
.
.         ************ DELETE FORMACTION **********
.
PMRFL300  PACK      KEY26,PMRFL001,PMRFL002,PMRFL003,SP70
          CALL      RDPMRFL1
          BRANCH    OVRCD,PMRFL920
.
          CALL      DEPMRFL1                        * Deletes the data
.
          MOVE      ZERO,EXIT
          GOTO      PMRFL999
.
.         ************ DISPLAY FORMACTION **********
.
PMRFL500  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PMRFL930
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PMRFL930
.
          PACK      KEY26,PMRFL001,PMRFL002,DPMRFL03,SP70
          CALL      RDPMRFL1                      * read referral table
          IF        OVRCD=1
            CALL      CLPMSRFL                    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Referral Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMRFL999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PMRFL999
.
PMRFL900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMRFL999
.
PMRFL910  MOVE      "Referral Details Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMRFL999
.
PMRFL920  MOVE      "Invalid Referral Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMRFL999
.
PMRFL930  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMRFL999
.
PMRFL999  RETURN
.
.------------------------------------------------------------
. Adverse Outcome Code Maintenance
.------------------------------------------------------------
PMADC000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PMADC500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      PMADC100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      PMADC200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      PMADC300 IF EQUAL
.
          GOTO      PMADC900
.
.         ************ ADD FORMACTION ***********
.
PMADC100  PACK      KEY6,PMADC001,SP70
          CALL      RDPMADC1
          COMPARE   ZERO,OVRCD
          GOTO      PMADC910 IF EQUAL
.
          CALL      CLPMSADC                     * Clear file vars
          CALL      MVPMAC00                     * Move cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMACDATC                * System date
          CLOCK     TIME,PMACTIMC                * System time
          MOVE      USERID,PMACWEBC              * web user id
.
          PACK      KEY6,PMADC001,SP70
          CALL      WRPMADC1                     * Writes the data
          CALL      OTCMN000
.
          MOVE      ZERO,EXIT
          GOTO      PMADC999
.
.         ************ UPDATE FORMACTION **********
.
PMADC200  PACK      KEY6,PMADC001,SP70
          CALL      RDPMADC1
          BRANCH    OVRCD,PMADC920
.
          CALL      MVPMAC00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMACDATU                * System date
          CLOCK     TIME,PMACTIMU                * System time
          MOVE      USERID,PMACWEBU              * web user id
.
          CALL      UPPMADC1                     * Updates the data
          CALL      OTCMN000
.
          MOVE      ZERO,EXIT
          GOTO      PMADC999
.
.         ************ DELETE FORMACTION **********
.
PMADC300  PACK      KEY6,PMADC001,SP70
          CALL      RDPMADC1
          BRANCH    OVRCD,PMADC920
.
          CALL      DEPMADC1                        * Deletes the data
.
          MOVE      ZERO,EXIT
          GOTO      PMADC999
.
.         ************ DISPLAY FORMACTION **********
.
PMADC500  PACK      KEY6,PMADC001,SP70
          CALL      RDPMADC1                      * read referral table
          IF        OVRCD=1
            CALL      CLPMSADC                    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Adverse Outcome Code Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMADC999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PMADC999
.
PMADC900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMADC999
.
PMADC910  MOVE      "Adverse Outcome Code Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMADC999
.
PMADC920  MOVE      "Invalid Outcome Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMADC999
.
PMADC999  CLOSE     COMOCMAF,DELETE
          RETURN
.
.------------------------------------------------------------
. Patient Outcome Details
.------------------------------------------------------------
POTD0000  RESET     UPDTTYPE 
          MATCH     SP1,UPDTTYPE
          GOTO      POTD0500 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add formaction
          GOTO      POTD0100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      POTD0200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete formaction
          GOTO      POTD0200 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Supervisor Delete formaction
          GOTO      POTD0200 IF EQUAL
.
          GOTO      POTD0900
.
.         ************ ADD FORMACTION ***********
.
POTD0100  MATCH     SP70,PMPOD002
          GOTO      POTD0940 IF EQUAL
.
          MATCH     SP70,ADMISSNO
          GOTO      POTD0960 IF EQUAL
.
          PACK      KEY6,PMPOD002,SP70
          CALL      RDPMADC1
          BRANCH    OVRCD,POTD0940
.
          MOVE      ZERO,F2
          MOVE      ZERO,OCGRADE
          MOVE      PMPOD004,F2
.
          MATCH     "0",PMPOD004
          IF        @EQUAL
            MOVE      TEN1,F2          * Level N/A
          ENDIF
.
          LOAD      OCGRADE,F2,PMACVLD1,PMACVLD2,PMACVLD3,PMACVLD4,PMACVLD5:
                               PMACVLD6,PMACVLD7,PMACVLD8,PMACVLD9,PMACVL10:
                               PMACVLNA
          MATCH     "1",OCGRADE
          GOTO      POTD0950 IF NOT EQUAL
.
          MATCH     "1",PMACDECI
          GOTO      POTD0150 IF NOT EQUAL
.
          COMPARE   ONE,PCEASE
          GOTO      POTD0970 IF NOT EQUAL
.
POTD0150  MOVE      ZERO,F3
          PACK      KEY11,ADMISSNO,Z70
          CALL      RSPMPOD1
          CALL      RPPMPOD1
          MATCH     ADMISSNO,PMPOVISN
          IF        @EQUAL
            MOVE      PMPOOCNT,F3
          ENDIF
          ADD       ONE,F3
.
          CALL      CLPMSPOD                     * Clear file vars
          CALL      MVPMPO00                     * Move cgi to file variables
.
          PACK      PMPOVISN,ADMISSNO,SP70
          MOVE      F3,PMPOOCNT
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPODATC                * System date
          CLOCK     TIME,PMPOTIMC                * System time
          MOVE      USERID,PMPOWEBC              * web user id
          PACK      PMPOUNIQ,CASEUNIQ,SP70
.
          PACK      KEY11,PMPOVISN,PMPOOCNT,SP70
          CALL      WRPMPOD1                     * Writes the data
          CALL      PTCMN000                     * Writes the comments away
.
          MOVE      ZERO,EXIT
          GOTO      POTD0999
.
.         ************ UPDATE FORMACTION **********
.
POTD0200  MATCH     SP70,PMPOD002
          GOTO      POTD0940 IF EQUAL
.
          PACK      KEY6,PMPOD002,SP70
          CALL      RDPMADC1
          BRANCH    OVRCD,POTD0940
.
          MOVE      ZERO,F2
          MOVE      ZERO,OCGRADE
          MOVE      PMPOD004,F2
.
          MATCH     "0",PMPOD004
          IF        @EQUAL
            MOVE      TEN1,F2          * Level N/A
          ENDIF
.
          LOAD      OCGRADE,F2,PMACVLD1,PMACVLD2,PMACVLD3,PMACVLD4,PMACVLD5:
                               PMACVLD6,PMACVLD7,PMACVLD8,PMACVLD9,PMACVL10:
                               PMACVLNA
          MATCH     "1",OCGRADE
          GOTO      POTD0950 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,PMPOD003,SP70
          CALL      RDPMPOD1
          BRANCH    OVRCD,POTD0920
.
          CALL      MVPMPO00                     * Moves cgi to file variables
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPODATU                * System date
          CLOCK     TIME,PMPOTIMU                * System time
          MOVE      USERID,PMPOWEBU              * web user id
          PACK      PMPOUNIQ,CASEUNIQ,SP70
.
          MATCH     "D",UPDTTYPE
          IF        @EQUAL
            MOVE      "1",PMPODELT
          ENDIF
          MATCH     "S",UPDTTYPE
          IF        @EQUAL
            MOVE      "2",PMPODELT
          ENDIF
          CALL      UPPMPOD1                     * Updates the data
          CALL      PTCMN000                     * Writes the comments away
.
          MOVE      ZERO,EXIT
          GOTO      POTD0999
.
.         ************ DISPLAY FORMACTION **********
.
POTD0500  MATCH     SP70,URNUMBER
          IF        !@EQUAL
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,POTD0930
            CALL      RDPMPX21
            BRANCH    OVRCD,POTD0930
          ENDIF
.
          PACK      KEY11,ADMISSNO,PMPOD003,SP70
          CALL      RDPMPOD1                      * read referral table
          IF        OVRCD=1
            CALL      CLPMSPOD                    * Clear all the file variables
          ELSE
            PACK      CASEUNIQ,PMPOUNIQ,SP70
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Outcome Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMADC999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0910  MOVE      "Patient Outcome Record Exists",WEBTITLE 
          CALL      WEBERR00 
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0920  MOVE      "Invalid Outcome Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0930  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0940  MOVE      "Invalid Outcome Code ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0950  MOVE      "Invalid Grade for Outcome Code ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0960  MOVE      "Unable to add record, no visit selected",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0970  MOVE      "Invalid outcome, patient must be deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      POTD0999
.
POTD0999  CLOSE     COMPODAF,DELETE
          RETURN
.
.------------------------------------------------------------
. Visit Extension file Maintenance
.------------------------------------------------------------
VXMAN000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      VXMAN500 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * Remote script
          IF        @EQUAL
            CALL      REMOTT00
            MOVE      ONE,EXIT
            GOTO      VXMAN999
          ENDIF
.
          MATCH     "U",UPDTTYPE            * Update formaction
          GOTO      VXMAN900 IF NOT EQUAL
.
VXMAN200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,VXMAN910
.
          CALL      MVVXTF00
          CALL      UPPMVX11
          GOTO      VXMAN999
.
.         ************ DISPLAY FORMACTION **********
.
VXMAN500  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11                      * read referral table
          IF        OVRCD=1
            CALL      CLPMSVX1                    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Visit Extension Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,VXMAN999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      VXMAN999
.
VXMAN900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VXMAN999
.
VXMAN910  MOVE      "Invalid Visit Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VXMAN999
.
VXMAN999  RETURN
+
.------------------------------------------------------------------------------
. Remote Scripting for arrival time/interview time
.------------------------------------------------------------------------------
REMOTT00  CALL      XMLHED00
          BRANCH    EXIT,REMOTT99
.
          BRANCH    REMOTENO,REMOTT10,REMOTT20
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMOTT90
.
REMOTT10  CALL      UPAT0000       * set arrival time
          GOTO      REMOTT90
.
REMOTT20  CALL      UPIT0000       * set interview time
          GOTO      REMOTT90
.
REMOTT90  CALL      XMLEND00
.
REMOTT99  RETURN
.
.-----------------------------------------------------------
. Update arrival time
.-----------------------------------------------------------
UPAT0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPAT9000
.
          MATCH     SP70,PMVXATIM
          GOTO      UPAT9100 IF NOT EQUAL
.
          CLOCK     TIME,PMVXATIM
          CALL      UPPMVX11
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMVXATIM,"|":
                    "</RETURN_VALUE>"
          GOTO      UPAT9999
.
UPAT9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID VISIT RECORD":
                    "</RETURN_VALUE>"
          GOTO      UPAT9999
.
UPAT9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Arrival Time already entered":
                    "</RETURN_VALUE>"
          GOTO      UPAT9999
.
UPAT9999  RETURN
.
.-----------------------------------------------------------
. Update Interview time
.-----------------------------------------------------------
UPIT0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPIT9000
.
          MATCH     SP70,PMVXITIM
          GOTO      UPIT9100 IF NOT EQUAL
.
          CLOCK     TIME,PMVXITIM
          CALL      UPPMVX11
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    PMVXITIM,"|":
                    "</RETURN_VALUE>"
          GOTO      UPAT9999
.
UPIT9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID VISIT RECORD":
                    "</RETURN_VALUE>"
          GOTO      UPIT9999
.
UPIT9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " Interview Time already entered":
                    "</RETURN_VALUE>"
          GOTO      UPIT9999
.
UPIT9999  RETURN
.------------------------------------------------------------
. PTCMN000 - Patient Outcome Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
PTCMN000  IF        PODCOMTS<>1
            GOTO      PTCMN999
          ENDIF
.
          PACK      KEY14,PMPOVISN,PMPOOCNT,SP10
          CALL      RSPMOCM1
PTCMN400  CALL      RKPMOCM1
          BRANCH    OVRCD,PTCMN500          * end of file
.
          MATCH     PMOCVISN,PMPOVISN         * same visit
          GOTO      PTCMN500 IF NOT EQUAL
.
          MATCH     PMOCOCNT,PMPOOCNT         * same outcome count
          GOTO      PTCMN500 IF NOT EQUAL
.
          PACK      KEY14,PMOCVISN,PMOCOCNT,PMOCLCNT,SP70
          CALL      DEPMOCM1
          GOTO      PTCMN400
.
.         now write the new comments back
.
PTCMN500  MOVE      PMPOVISN,PMOCVISN       * set admission number
          MOVE      PMPOOCNT,PMOCOCNT       * set outcome counter
          MOVE      ZERO,PMOCLCNT
.
PTCMN510  READ      COMPODAF,SEQ;PMOCLINE
          GOTO      PTCMN999 IF OVER
.
          REP       " 0",ANS
          MOVE      ZERO,F3
          MOVE      PMOCLCNT,F3
          ADD       ONE,F3               * add to line number
          MOVE      F3,PMOCLCNT
.
          PACK      KEY14,PMOCVISN,PMOCOCNT,PMOCLCNT,SP70
          CALL      WRPMOCM1
          GOTO      PTCMN510
.
PTCMN999  RETURN
+
.------------------------------------------------------------
. OTCMN000 - Outcome Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
OTCMN000  IF        OCDCOMTS<>1
            GOTO      OTCMN999
          ENDIF
.
          PACK      KEY9,PMACCODE,SP10
          CALL      RSPMAOD1
OTCMN400  CALL      RKPMAOD1
          BRANCH    OVRCD,OTCMN500          * end of file
.
          MATCH     PMACCODE,PMAOCODE         * same outcome code
          GOTO      OTCMN500 IF NOT EQUAL
.
          PACK      KEY9,PMAOCODE,PMAOLCNT,SP70
          CALL      DEPMAOD1
          GOTO      OTCMN400
.
.         now write the new comments back
.
OTCMN500  MOVE      PMACCODE,PMAOCODE       * set outcome code
          MOVE      ZERO,PMAOLCNT
.
OTCMN510  READ      COMOCMAF,SEQ;PMAOLINE
          GOTO      OTCMN999 IF OVER
.
          REP       " 0",ANS
          MOVE      ZERO,F3
          MOVE      PMAOLCNT,F3
          ADD       ONE,F3               * add to line number
          MOVE      F3,PMAOLCNT
.
          PACK      KEY9,PMAOCODE,PMAOLCNT,SP70
          CALL      WRPMAOD1
          GOTO      OTCMN510
.
OTCMN999  RETURN
+
.------------------------------------------------------------
. Eclipse Participant Maintenance
.------------------------------------------------------------
PART0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PART8000 IF EQUAL
.         
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PART1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PART1500 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      PART2000 IF EQUAL
.
          GOTO      PART9000
.
.         ************ ADD FORMACTION ***********
.
PART1000
.
          MOVE      ZERO,EXIT
          GOTO      PART9999
.
.         ************ UPDATE FORMACTION **********
.
PART1500  CALL      UPAR0000                * send GetParticipant request
          GOTO      PART9999
.
.         ************ DELETE FORMACTION **********
.
PART2000
.
          MOVE      ZERO,EXIT
          GOTO      PART9999
.
.         ************ DISPLAY FORMACTION **********
.
PART8000  PACK      KEY3,PTPAR001,SP70
          CALL      RDPTPAR1
          IF        OVRCD=1
            CALL     CPTPA000
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Eclipse Participant Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PART9999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PART9999
.
PART9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PART9999
.
PART9999  RETURN
+
.------------------------------------------------------------
. Eclipse Participant Details
.------------------------------------------------------------
PTPR0000  BRANCH    FLDITMNO,PTPR0010,PTPR0020,PTPR0030,PTPR0040,PTPR0050:
                             PTPR0060,PTPR0070,PTPR0080,PTPR0090,PTPR0100:
                             PTPR0110,PTPR0120,PTPR0130
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PTPR9999
.
PTPR0010  WRITE     HTMLFILE;PTPRCODE;
          GOTO      PTPR9999
.
PTPR0020  WRITE     HTMLFILE;PTPRTYPE;
          GOTO      PTPR9999
.
PTPR0030  WRITE     HTMLFILE;PTPRNAME;
          GOTO      PTPR9999
.
PTPR0040  WRITE     HTMLFILE;PTPRCNUM;
          GOTO      PTPR9999
.
PTPR0050  MATCH     PTPRDUPD,SP70
          GOTO      PTPR9999 IF EQUAL
.         
          UNPACK    PTPRDUPD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PTPR9999
.
PTPR0060  CALL      PTAB0000                * participant table
          GOTO      PTPR9999
.
PTPR0070  WRITE     HTMLFILE;FLTRCAPA;      * capability filter
          GOTO      PTPR9999
.
PTPR0080  CALL      GDAT0000                * get last getparticipant date
          GOTO      PTPR9999
.
PTPR0090  CALL      FTAB0000                * participant health fund table
          GOTO      PTPR9999
.
PTPR0100  CALL      PATPKA00                * participant search table
          GOTO      PTPR9999
.
PTPR0110  CALL      PREVGR00                * participant search previous
          GOTO      PTPR9999
.
PTPR0120  CALL      NEXTGR00                * participant search next
          GOTO      PTPR9999
.
PTPR0130  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND16;*61,PTCNPRKG
.
          MATCH     SP70,PTCNPRKG
          GOTO      PTPR9999 IF EQUAL
          GOTO      PTPR9999 IF EOS
.
          MATCH     "00000000",PTCNPRKG
          GOTO      PTPR9999 IF EQUAL
.
          UNPACK    PTCNPRKG,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
PTPR9999  RETURN
+
.------------------------------------------------------------
. List participant details - patparaf
.------------------------------------------------------------
PTAB0000  PACK      KEY3,SP70
          CALL      RSPTPAR1
PTAB1000  CALL      RKPTPAR1
          BRANCH    OVRCD,PTAB9999
.         
          MATCH     SP70,FLTRCAPA
          GOTO      PTAB5000 IF EQUAL
.
          PACK      KEY9,PTPRCODE,FLTRCAPA,Z70  * filter by capability
          CALL      RSPTPCP1
PTAB2000  CALL      RPPTPCP1
          BRANCH    OVRCD,PTAB1000
.
          MATCH     PTPRCODE,PTPPCODE
          GOTO      PTAB1000 IF NOT EQUAL
.
          MATCH     FLTRCAPA,PTPPCPID
          GOTO      PTAB1000 IF NOT EQUAL
.
PTAB5000  MOVE      FUNDDESC,TYPEDESC
          MATCH     "O",PTPRTYPE
          IF        @EQUAL
            MOVE      OTHRDESC,TYPEDESC          * health fund or 'other'
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowHealthFunds('",HTMLLINK
          APPEND    PTPRCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ShowCapability('",HTMLLNK2
          APPEND    PTPRCODE,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          WRITE     HTMLFILE;"t.addRow(#"",PTPRCODE,"#",":              *0
                                      "#"",HTMLLINK,"#",":              *1
                                      "#"",HTMLLNK2,"#",":              *2
                                      "#"",PTPRNAME,"#",":              *3
                                      "#"",TYPEDESC,"#",":              *4
                                      "#"",PTPRCNUM,"#",":              *5
                                      "#"",PTPRDUPD,"#");"              *6
.
          GOTO      PTAB1000
.
PTAB9999  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for eclipse participant details - patparaf
.-------------------------------------------------------------------------------
SPTPAR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPTPAR01,SPTPAR02,SPTPAR03,SPTPAR04,SPTPAR05:
                       SPTPAR06,SPTPAR07,SPTPAR08
.
          MOVE      ONE,EXIT
          GOTO      SPTPAR99
.
SPTPAR01  PACK      PTPAR001,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR02  PACK      PTPAR002,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR03  PACK      PTPAR003,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR04  PACK      PTPAR004,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR05  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTPAR005,CCENT,CYEAR,CMON,CDAY
          GOTO      SPTPAR99
.
SPTPAR06  PACK      PTPAR006,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR07  PACK      PTPAR007,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR08  PACK      PTPAR008,QRYDATA,SP70
          GOTO      SPTPAR99
.
SPTPAR99  RETURN
+
.------------------------------------------------------------
.  Update cgi to eclipse participant details - patparaf
.------------------------------------------------------------
MPTPA000  MATCH     PTPAR001,Z70
          IF        !@EQUAL
            MOVE      PTPAR001,PTPRCODE
          ENDIF
.
          MATCH     PTPAR002,Z70
          IF        !@EQUAL
            MOVE      PTPAR002,PTPRTYPE
          ENDIF
.
          MATCH     PTPAR003,Z70
          IF        !@EQUAL
            MOVE      PTPAR003,PTPRNAME
          ENDIF
.
          MATCH     PTPAR004,Z70
          IF        !@EQUAL
            MOVE      PTPAR004,PTPRCNUM
          ENDIF
.
          MATCH     PTPAR005,Z70
          IF        !@EQUAL
            MOVE      PTPAR005,PTPRDUPD
          ENDIF
.
MPTPA999  RETURN
+
.------------------------------------------------------------
. Clear eclipse participant details - patparaf
.------------------------------------------------------------
CPTPA000  MOVE      SP70,PTPRCODE
          MOVE      SP70,PTPRTYPE
          MOVE      SP70,PTPRNAME
          MOVE      SP70,PTPRCNUM
          MOVE      SP70,PTPRDUPD
          MOVE      SP70,PTPRSPAR
CPTPA999  RETURN
+
.------------------------------------------------------------
. Eclipse Participant Capabilities
.------------------------------------------------------------
PTPP0000  BRANCH    FLDITMNO,PTPP0010,PTPP0020,PTPP0030,PTPP0040,PTPP0050:
                             PTPP0060,PTPP0070
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PTPP9999
.
PTPP0010  WRITE     HTMLFILE;PTPPCODE;
          GOTO      PTPP9999
.
PTPP0020  WRITE     HTMLFILE;PTPPCPID;
          GOTO      PTPP9999
.
PTPP0030  WRITE     HTMLFILE;PTPPSCID;
          GOTO      PTPP9999
.
PTPP0040  WRITE     HTMLFILE;PTPPCVID;
          GOTO      PTPP9999
.
PTPP0050  WRITE     HTMLFILE;PTPPCNAM;
          GOTO      PTPP9999
.
PTPP0060  WRITE     HTMLFILE;PTPPCROL;
          GOTO      PTPP9999
.
PTPP0070  CALL      CTAB0000                * capability table
          GOTO      PTPP9999
.
PTPP9999  RETURN
+
.------------------------------------------------------------
. List participant capabilities - patpcpaf
.------------------------------------------------------------
CTAB0000  PACK      KEY9,PTPAR001,SP70
          CALL      RSPTPCP1
CTAB1000  CALL      RKPTPCP1
          BRANCH    OVRCD,CTAB9999
.
          MATCH     PTPPCODE,PTPRCODE
          GOTO      CTAB1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"t.addRow(#"",PTPPCPID,"#",":              *0
                                      "#"",PTPPSCID,"#",":              *1
                                      "#"",PTPPCVID,"#",":              *2
                                      "#"",PTPPCNAM,"#",":              *3
                                      "#"",PTPPCROL,"#");"              *4
.
          GOTO      CTAB1000
.
CTAB9999  RETURN
+
.------------------------------------------------------------
. List participant health funds - patfn1af/patfx1af
.------------------------------------------------------------
FTAB0000  MOVE      SP20,KEY14
          CALL      RDSFUND1                     * position in file
FTAB1000  CALL      RDKFUND1                     * read next record
          BRANCH    OVRCD,FTAB9999               * end of file
.         
          MATCH     ZERO4,HFTABL                 * health fund only record ?
          IF        !@EQUAL
            PACK      KEY14,HCODE,Z70            * no
            CALL      RDSFUND1                   * get next health fund record
            GOTO      FTAB1000                   
          ENDIF
.         
.         A health fund only record has been found, so check if the fund
.         is participating in Eclipse
.
          MOVE      HCODE,KEY6
          CALL      RDPTFX11                     * HF extension record found ?
          BRANCH    OVRCD,FTAB1000               * no - ignore record
.
          COMPARE   THREE,PTFXEXTR               * using Eclipse ?
          GOTO      FTAB1000 IF NOT EQUAL        * no - ignore record
.
.         Check if the health fund group is the same as the selected
.         participant
.
          MATCH     PTPAR001,PTHFHGRP            * same participant code ?
.         GOTO      FTAB1000 IF NOT EQUAL        * no - ignore
          IF        !@EQUAL
            MATCH     PTPAR001,PTFXECLP
            GOTO      FTAB1000 IF NOT EQUAL
          ENDIF
.
.         A valid health fund has been found, so display it
.
          WRITE     HTMLFILE;"t.addRow(#"",HCODE,"#",":                 *0
                                      "#"",HFNAME,"#");"                *1
.
          GOTO      FTAB1000
.
FTAB9999  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for eclipse participant capabilities - patpcpaf
.-------------------------------------------------------------------------------
SPTPCP00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPTPCP01,SPTPCP02,SPTPCP03,SPTPCP04,SPTPCP05:
                       SPTPCP06
.
          MOVE      ONE,EXIT
          GOTO      SPTPCP99
.
SPTPCP01  PACK      PTPCP001,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP02  PACK      PTPCP002,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP03  PACK      PTPCP003,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP04  PACK      PTPCP004,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP05  PACK      PTPCP005,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP06  PACK      PTPCP006,QRYDATA,SP70
          GOTO      SPTPCP99
.
SPTPCP99  RETURN
+
.------------------------------------------------------------
.  Update cgi to eclipse participant capabilities - patpcpaf
.------------------------------------------------------------
MPTPP000  MATCH     PTPCP001,Z70
          IF        !@EQUAL
            MOVE      PTPCP001,PTPPCODE
          ENDIF
.
          MATCH     PTPCP002,Z70
          IF        !@EQUAL
            MOVE      PTPCP002,PTPPCPID
          ENDIF
.
          MATCH     PTPCP003,Z70
          IF        !@EQUAL
            MOVE      PTPCP003,PTPPSCID
          ENDIF
.
          MATCH     PTPCP004,Z70
          IF        !@EQUAL
            MOVE      PTPCP004,PTPPCVID
          ENDIF
.
          MATCH     PTPCP005,Z70
          IF        !@EQUAL
            MOVE      PTPCP005,PTPPCNAM
          ENDIF
.
          MATCH     PTPCP006,Z70
          IF        !@EQUAL
            MOVE      PTPCP006,PTPPCROL
          ENDIF
.
MPTPP999  RETURN
+
.***************************************************************************
.*                             GDAT0000                                    *
.*            Get the date the last Eclipse GetParticipant was sent        *
.***************************************************************************
GDAT0000  PACK      LGPARDAT,SP10                * initialise date
          MOVE      ZERO,FLASHFLG                * initialise for non-flashing
.
          PACK      KEY51,ONE,SP1,TWO,Z70
          CALL      RSPMETR1                     * pos'n after last GetPart. Req
GDAT0500  CALL      RPPMETR1                     * read previous record
          BRANCH    OVRCD,GDAT9999               * eof - finished
.
          MATCH     "1",PMETSTAT                 * same status still ?
          GOTO      GDAT9999 IF NOT EQUAL        * no - finished
.
          MATCH     " 2",PMETTYPE                * same request type still ?
          GOTO      GDAT9999 IF NOT EQUAL        * no - finished
.
          MATCH     SP8,PMETUDTE                 * blank update date ?
          GOTO      GDAT0500 IF EQUAL            * yes - get next record
.
.         A valid record has been found, so use the update date as the
.         last date the GetParticipant was sent
.
.         Check if last update date is > 2 weeks in the past.  If so,
.         display the date as flashing to indicate an update is required
.         for participant details
.
          MOVE      PMETUDTE,GPARFDAT
.
          CALL      IBACLOCK                     * get the current date
          PACK      GPARTDAT,CCC,CYY,CMM,CDD
          REP       " 0",GPARTDAT
.
          DAYSEP    GPARFDAT,GPARTDAT,F4
          IF        F4 > 14
            MOVE      ONE,FLASHFLG               * set for flashing
          ENDIF
.
GDAT9000  MOVE      PMETUDTE,LGPARDAT            * last getparticipant date
          MATCH     LGPARDAT,SP70
          GOTO      GDAT9999 IF EQUAL
.
          UNPACK    LGPARDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FLASHFLG=1
            WRITE     HTMLFILE;"<font color=#FF0000><b>":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</font></b>";
          ELSE
            WRITE     HTMLFILE;"<b>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</b>";
          ENDIF
.
GDAT9999  RETURN
+
.*****************************************************************************
.*                               UPAR0000                                    *
.*          Update the participant details (GetParticipantsRequest)          *
.*****************************************************************************
.
UPAR0000  PACK      KEY51,SP2,TWO,SP70
          CALL      RSPMETR1
          CALL      RKPMETR1                     * any current update requests?
          BRANCH    OVRCD,UPAR1000               * no, so write new request
.
          MATCH     SP1,PMETSTAT
          IF        @EQUAL
            MATCH     " 2",PMETTYPE
            GOTO      UPAR9500 IF EQUAL          * current request waiting
          ENDIF
.
UPAR1000  CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
.         Get the certificate that covers today
.
          PACK      KEY16,PTCNCLID,CURRDATE
          CALL      RDPTCTI1                     * record found for today ?
          COMPARE   ZERO,OVRCD
          GOTO      UPAR1500 IF EQUAL            * yes - use this certificate id
.
          CALL      RPPTCTI1                     * no - read previous record
          IF        OVRCD = 0
            MATCH     CURRDATE,PTCITDTE          * within date range ?
            GOTO      UPAR1500 IF NOT LESS       * yes - use this certificate id
          ENDIF
.
          MOVE      "Current certificate not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPAR9999
.
UPAR1500  MOVE      SP1,PMETSTAT
          MOVE      " 2",PMETTYPE                * get participants request
          MOVE      SP30,PMETTRID
          MOVE      SP30,PMETBATN
          MOVE      SP30,PMETINVN
          MOVE      SP30,PMETUDTE
          MOVE      SP30,PMETUTIM
          MOVE      SP20,PMETFDTM
          MOVE      SP20,PMETTDTM
          MOVE      PTCNCLID,PMETLOCN
          MOVE      PTCISNID,PMETSNID
          MOVE      SP30,PMETSPAR
.
UPAR2000  CALL      IBACLOCK                     * get current date/time
          PACK      PMETCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMETCDTE
          MOVE      CTIMEIS,PMETCTIM
          REP       " 0",PMETCTIM
.
          PACK      KEY51,PMETSTAT,PMETTYPE,PMETLOCN,PMETCDTE,PMETCTIM,PMETTRID
          CALL      RDPMETR1
          IF        OVRCD = 0
            GOTO      UPAR2000
          ENDIF
.
          CALL      WRPMETR1                     * write transaction request
.
.>>>>     DISPLAY   *P1:24,*EL,*B,"GetParticipants Request Sent. ";
          MOVE      ZERO,EXIT
          GOTO      UPAR9999
.
UPAR9500  MOVE      "Current GetParticipants Request Exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPAR9999  RETURN
+
.-----------------------------------------------------------
. Eclipse Participant Search   
.-----------------------------------------------------------
PATPKA00  WRITE     HTMLFILE;"<tr align=center>":
                             "<td class=HeadingCell colspan=4>":
                             "<b>You Searched for ",KEYWORDS,"</td>":
                             "</tr>":
                             "<tr>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "<b>Participant Code</b></td>":
                             "<td class=HeadingCell width=40%>":
                             "<b>Participant Description</b></td>":
                             "</tr>"
.
          CALL      GETWRD00
.
          IF        NORECORD=0
            MOVE      "14",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          STRIP     KEYWRD01
          PACK      KEY53,KEYWRD01,SP70
          CALL      RSPTPKI2
PATPKA10  CALL      RKPTPKI2
          BRANCH    OVRCD,PATPKA99
.
          PACK      KEY3,PTPKCODE,SP70
          CALL      RDPTPAR1
          BRANCH    OVRCD,PATPKA10
.
          CALL      PATPKB00
          BRANCH    OVRCD,PATPKA10,PATPKA99
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PATPKA10
          ENDIF
.
PATPKA20  REP       "' ",PTPRNAME
          WRITE     HTMLFILE;"<tr valign=top>":
                              "<td nowrap><a href=#"":
                              "javascript:updateParent('",PTPRCODE:
                             "','",PTPRNAME,"')#">":
                              PTPRCODE:
                             "<td>",PTPRNAME,"</td></tr>";
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PATPKA10 IF NOT EQUAL
.
PATPKA99  RETURN
.------------------------------------------------------------
. Check Record
.------------------------------------------------------------
PATPKB00  MATCH     KEYWRD01,PTPKKKWD
          GOTO      PATPKB92 IF NOT EQUAL
          IF        KEYWRDNO>1
            PACK      SAVKEY53,PTPKCODE,PTPKKKWD,SP70
            CALL      PATPKC00
            BRANCH    EXIT,PATPKB91
            MOVE      SAVKEY53,KEY53
            CALL      RDPTPKI1
          ENDIF
.
PATPKB90  MOVE      ZERO,OVRCD
          GOTO      PATPKB99
.
PATPKB91  MOVE      ONE,OVRCD
          GOTO      PATPKB99
.
PATPKB92  MOVE      TWO,OVRCD
PATPKB99  RETURN
.------------------------------------------------------------
. Check for Matching Words
.------------------------------------------------------------
PATPKC00  MOVE      ONE,F2
          MOVE      ZERO,EXIT
          PACK      SAVKEY3,PTPKCODE,SP70
.
PATPKC10  COMPARE   KEYWRDNO,F2           * Loop through each Key Word in Search
          GOTO      PATPKC99 IF EQUAL     * Exit OK
.
          ADD       ONE,F2
          LOAD      KEYWRDXX,F2,KEYWRD01,KEYWRD02,KEYWRD03,KEYWRD04,KEYWRD05:
                             KEYWRD06,KEYWRD07,KEYWRD08,KEYWRD09,KEYWRD10
.
          PACK      KEY53,PTPKCODE,KEYWRDXX
          CALL      RDPTPKI1              * Check for Exact Match
          COMPARE   ZERO,OVRCD            * Ok so Continue Loop
          GOTO      PATPKC10 IF EQUAL
.
          CALL      RKPTPKI1              * Not Exact so Read Next Record
          BRANCH    OVRCD,PATPKC90        * No Match So Exit No Match
.
          PACK      KEY3,PTPKCODE,SP70
          MATCH     SAVKEY3,KEY3          * Match Key Fields
          GOTO      PATPKC90 IF NOT EQUAL * No Match So Exit
.
          STRIP     KEYWRDXX
          MATCH     PTPKKKWD,KEYWRDXX     * Check Key Word
          GOTO      PATPKC90 IF NOT EQUAL * No Match So Exit
.
          GOTO      PATPKC10              * Check Next Search Word
.
PATPKC90  MOVE      ONE,EXIT
.
PATPKC99  RETURN
.------------------------------------------------------------
. Link to Next set of Eclipse Participants
.------------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
.
NEXTGR99  RETURN
.-------------------------------------------------------------------------------
. Link to previous set of Eclipse Participants
.-------------------------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
.
PREVGR99  RETURN
.------------------------------------------------------------
. Eclipse Location Id Maintenance
.------------------------------------------------------------
LOCAN000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      LOCAN800 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add location id formaction
          GOTO      LOCAN100 IF EQUAL
.
          MATCH     "B",UPDTTYPE    * Add certificate formaction
          GOTO      LOCAN300 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update location id formaction
          GOTO      LOCAN150 IF EQUAL
.
          MATCH     "V",UPDTTYPE    * Update certificate formaction 
          GOTO      LOCAN350 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete location id formaction
          GOTO      LOCAN200 IF EQUAL
.
          MATCH     "E",UPDTTYPE    * Delete certificate formaction
          GOTO      LOCAN400 IF EQUAL
.
          GOTO      LOCAN900
.
.         ************ ADD LOCATION ID FORMACTION ***********
.
LOCAN100  CALL      CLRLCN00
          CALL      MPTLC000
.
          PACK      KEY8,PTLCN001,SP70
          CALL      RAPTLCN1
          IF        OVRCD=0
            GOTO      LOCAN910
          ELSE
            CALL      WRPTLCN1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ UPDATE FORMACTION **********
.
LOCAN150  PACK      KEY8,PTLCN001,SP70
          CALL      RDPTLCN1
          BRANCH    OVRCD,LOCAN930
.
          CALL      MPTLC000
          CALL      UPPTLCN1
.
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ DELETE LOCATION ID FORMACTION **********
.
LOCAN200  PACK      KEY8,PTLCN001,SP70
.
          CALL      DEPTLCN1
.
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ ADD CERTIFICATE FORMACTION ***********
.
LOCAN300  CALL      CLRCRT00
          CALL      MPTCR000
.
          PACK      KEY16,PTCRT001,PTCRT002,SP70
          CALL      RAPTCTI1
          IF        OVRCD=0
            GOTO      LOCAN920
          ELSE
            CALL      WRPTCTI1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ UPDATE CERTIFICATE FORMACTION **********
.         
LOCAN350  PACK      KEY16,PTCRT001,PTCRT002,SP70
          CALL      RDPTCTI1
          BRANCH    OVRCD,LOCAN940
.
          CALL      MPTCR000
          CALL      UPPTCTI1
.
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ DELETE CERTIFICATE FORMACTION **********
.         
LOCAN400  PACK      KEY16,PTCRT001,PTCRT002,SP70
.         
          CALL      DEPTCTI1
.         
          MOVE      ZERO,EXIT
          GOTO      LOCAN999
.
.         ************ DISPLAY FORMACTION **********
.
LOCAN800  PACK      KEY8,PTLCN001,SP70
          CALL      RDPTLCN1
          IF        OVRCD=1
            CALL      CLRLCN00
          ENDIF
.
          PACK      KEY16,PTCRT001,CRTFRMDT,SP70
          CALL      RDPTCTI1
          IF        OVRCD=1
            CALL      CLRCRT00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Eclipse Location Id Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LOCAN999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      LOCAN999
.
LOCAN900  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LOCAN999
.
LOCAN910  MOVE      "Location ID already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LOCAN999
.
LOCAN920  MOVE      "Certificate already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LOCAN999
.
LOCAN930  MOVE      "Invalid Location Id.",WEBTITLE
          CALL      WEBERR00   
          MOVE      ONE,EXIT   
          GOTO      LOCAN999
.
LOCAN940  MOVE      "Invalid Certificate.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LOCAN999
.
LOCAN999  RETURN
+
.------------------------------------------------------------
. Eclipse Location Id / Certificate Details
.------------------------------------------------------------
PTLC0000  BRANCH    FLDITMNO,PTLC0010,PTLC0020,PTLC0030,PTLC0040,PTLC0050:
                             PTLC0060,PTLC0070,PTLC0080,PTLC0090,PTLC0100:
                             PTLC0110,PTLC0120,PTLC0130,PTLC0140
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PTLC9999
.
PTLC0010  CALL      LTAB0000                * location id table
          GOTO      PTLC9999
.
PTLC0020  WRITE     HTMLFILE;IBCNMHOS;
          GOTO      PTLC9999
.
PTLC0030  CALL      HOSPID00
          GOTO      PTLC9999
.
PTLC0040  WRITE     HTMLFILE;PTLNLOCN;
          GOTO      PTLC9999
.
PTLC0050  WRITE     HTMLFILE;PTLNDESC;
          GOTO      PTLC9999
.
PTLC0060  WRITE     HTMLFILE;PTLNACTV;
          GOTO      PTLC9999
.
PTLC0070  WRITE     HTMLFILE;PTLNHOSP;
          GOTO      PTLC9999
.
PTLC0080  CALL      LCTAB000 
          GOTO      PTLC9999
.
PTLC0090  WRITE     HTMLFILE;PTLCN001;
          GOTO      PTLC9999
.
PTLC0100  WRITE     HTMLFILE;PTCILOCN;
          GOTO      PTLC9999
.
PTLC0110  UNPACK    PTCIFDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          WRITE     HTMLFILE;DIM11;
          GOTO      PTLC9999
.
PTLC0120  WRITE     HTMLFILE;PTCIIDEN;
          GOTO      PTLC9999
.
PTLC0130  UNPACK    PTCITDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          WRITE     HTMLFILE;DIM11;
          GOTO      PTLC9999
.
PTLC0140  WRITE     HTMLFILE;PTCISNID;
          GOTO      PTLC9999
.
PTLC9999  RETURN
+
.------------------------------------------------------------
. GP Access Audit Details
.------------------------------------------------------------
PMGP0000  BRANCH    FLDITMNO,PMGP0010,PMGP0020,PMGP0030,PMGP0040,PMGP0050:
                             PMGP0060,PMGP0070,PMGP0080,PMGP0090,PMGP0100:
                             PMGP0110,PMGP0120,PMGP0130,PMGP0140
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PMGP9999
.
PMGP0010  CALL      GPALU000          * GP Access List (by UR)
          GOTO      PMGP9999
.
PMGP0020  CALL      GPALD000          * GP Access List (by Date)
          GOTO      PMGP9999
.
PMGP0030  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PMGP9999
.
PMGP0040  CALL      NEXT0000
          GOTO      PMGP9999
.
PMGP0050  CALL      PREV0000
          GOTO      PMGP9999
.
PMGP0060  CALL      CURSTD00
          GOTO      PMGP9999
.
PMGP0070  CALL      CUREND00
          GOTO      PMGP9999
.
PMGP0080  CALL      CURYR000
          GOTO      PMGP9999
.
PMGP0090  CALL      CURMON00
          GOTO      PMGP9999
.
PMGP0100  CALL      SELV0000
          GOTO      PMGP9999
.
PMGP0110  WRITE     HTMLFILE;FILTUSER;
          GOTO      PMGP9999
.
PMGP0120  PACK      GENPCODE,FILTGPCD,SP70
          CALL      HCPDET00                * hcp details
          GOTO      PMGP9999
.
PMGP0130  PACK      GENPCODE,FILTWBGP,SP70
          CALL      HCPDET00                * hcp details
          GOTO      PMGP9999
.
PMGP0140  MOVE      ZERO,F2
          MOVE      PRACCNTR,F2
          PACK      KEY10,FILTPPRC,SP70
          PACK      GPPCCODE,KEY10,F2
          CALL      HCGDET00                * hcp practice details
          GOTO      PMGP9999
.
PMGP9999  RETURN
+
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",NXTLDATE;
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE;
.
PREV9999  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month for inpatient follow up list 
.------------------------------------------------------------
NEXTPF00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb07.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&deftview=",DEFTVIEW:
                             "&filtunit=",FILTUNIT: 
                             "&filtclam=",FILTCLAM: 
                             "&filtptyp=",FILTPTYP: 
                             "&filtddst=",FILTDDST: 
                             "&filtward=",FILTWARD: 
                             "&filtcout=",FILTCOUT; 
.
NEXTPF99  RETURN
.------------------------------------------------------------
. Last Day, Week, Month  for inpatient follow up list
.------------------------------------------------------------
PREVPF00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb07.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&deftview=",DEFTVIEW:
                             "&filtunit=",FILTUNIT:
                             "&filtclam=",FILTCLAM:
                             "&filtptyp=",FILTPTYP:
                             "&filtddst=",FILTDDST:
                             "&filtward=",FILTWARD:
                             "&filtcout=",FILTCOUT;
.
PREVPF99  RETURN
.
.------------------------------------------------------------
. List location id details - patlcnaf
.------------------------------------------------------------
LTAB0000  PACK      KEY8,SP70
          CALL      RSPTLCN1
LTAB1000  CALL      RKPTLCN1
          BRANCH    OVRCD,LTAB9999
.
          MOVE      "No ",DIM3
          MATCH     "A",PTLNACTV
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
.
          MOVE      SP70,DIM50
          MOVE      "No ",DIM3A
          IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            PACK      KEY3,PTLNHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MATCH     PTHSLOCN,PTLNLOCN
              IF          @EQUAL
                MOVE        "Yes",DIM3A
              ENDIF
              MOVE      PTHSNAME,DIM50
            ENDIF
          ELSE
            MATCH     PTLNLOCN,PTCNCLID
            IF        @EQUAL
              MOVE      "Yes",DIM3A
            ENDIF
          ENDIF 
.
          MOVE      PTLNLOCN,DIM8
          REP       " +",PTLNLOCN 
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/MaintenanceIcon.gif'":
                           " class=ListIcon onclick=updatePatLCN('":
                           PTLNLOCN,"');><img src='../images/DocumentIcon.gif'":
                           " class=ListIcon onclick=displayCerts('":
                           PTLNLOCN,"');>&nbsp;",DIM8,"#",":
                                      "#"",PTLNDESC,"#",":
                                      "#"",DIM3,"#",":
                                      "#"",DIM3A,"#",":
                                      "#"",DIM50,"#");"
.
          REP       "+ ",PTLNLOCN
          GOTO      LTAB1000
.
LTAB9999  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for eclipse location ids - patlcnaf
.-------------------------------------------------------------------------------
SPTLCN00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPTLCN01,SPTLCN02,SPTLCN03,SPTLCN04
.                      
          MOVE      ONE,EXIT
          GOTO      SPTLCN99
.         
SPTLCN01  PACK      PTLCN001,QRYDATA,SP70
          GOTO      SPTLCN99
.         
SPTLCN02  PACK      PTLCN002,QRYDATA,SP70
          GOTO      SPTLCN99
.
SPTLCN03  PACK      PTLCN003,QRYDATA,SP70
          GOTO      SPTLCN99
.
SPTLCN04  PACK      PTLCN004,QRYDATA,SP70
          GOTO      SPTLCN99
.
SPTLCN99  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for eclipse certificates - patcrtaf
.-------------------------------------------------------------------------------
SPTCRT00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPTCRT01,SPTCRT02,SPTCRT03,SPTCRT04,SPTCRT05
.
          MOVE      ONE,EXIT
          GOTO      SPTCRT99
.
SPTCRT01  PACK      PTCRT001,QRYDATA,SP70
          GOTO      SPTCRT99
.
SPTCRT02  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTCRT002,CCENT,CYEAR,CMON,CDAY
.         PACK      PTCRT002,QRYDATA,SP70
          GOTO      SPTCRT99
.
SPTCRT03  PACK      PTCRT003,QRYDATA,SP70
          GOTO      SPTCRT99
.
SPTCRT04  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTCRT004,CCENT,CYEAR,CMON,CDAY
.         PACK      PTCRT004,QRYDATA,SP70
          GOTO      SPTCRT99
.
SPTCRT05  PACK      PTCRT005,QRYDATA,SP70
          GOTO      SPTCRT99
.
SPTCRT99  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for GP Access Audit - pmsgpaaf
.-------------------------------------------------------------------------------
SPMGPA00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMGPA01,SPMGPA02,SPMGPA03,SPMGPA04
.
          MOVE      ONE,EXIT
          GOTO      SPMGPA99
.
SPMGPA01  PACK      PMGPA001,QRYDATA,SP70
          GOTO      SPMGPA99
.
SPMGPA02  PACK      PMGPA002,QRYDATA,SP70
          GOTO      SPMGPA99
.
SPMGPA03  PACK      PMGPA003,QRYDATA,SP70
          GOTO      SPMGPA99
.
SPMGPA04  CALL      GETOVR00
          GOTO      SPMGPA99
.
SPMGPA99  RETURN
+
.-------------------------------------------------------------------------------
.  Set Parameters for patient follow up
.-------------------------------------------------------------------------------
SPTFOL00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPTFOL01,SPTFOL02,SPTFOL03,SPTFOL04,SPTFOL05:
                       SPTFOL06,SPTFOL07,SPTFOL08,SPTFOL09,SPTFOL10:
                       SPTFOL11,SPTFOL12,SPTFOL13,SPTFOL14,SPTFOL15:
                       SPTFOL16
.
          MOVE      ONE,EXIT
          GOTO      SPTFOL99
.
SPTFOL01  PACK      DIM11,QRYDATA,SP70
          MATCH     SP70,DIM11
          IF        @EQUAL
            MOVE      SP70,PTFOL001
          ELSE 
            UNPACK    DIM11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTFOL001,CCENT,CYEAR,CMON,CDAY
          ENDIF
          GOTO      SPTFOL99
.
SPTFOL02  PACK      PTFOL002,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL03  PACK      PTFOL003,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL04  PACK      DIM11,QRYDATA,SP70
          MATCH     SP70,DIM11
          IF        @EQUAL
            MOVE      SP70,PTFOL004
          ELSE 
            UNPACK    DIM11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTFOL004,CCENT,CYEAR,CMON,CDAY
          ENDIF
          GOTO      SPTFOL99
.
SPTFOL05  PACK      PTFOL005,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL06  PACK      PTFOL006,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL07  PACK      DIM11,QRYDATA,SP70
          MATCH     SP70,DIM11
          IF        @EQUAL
            MOVE      SP70,PTFOL007
          ELSE 
            UNPACK    DIM11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTFOL007,CCENT,CYEAR,CMON,CDAY
          ENDIF
          GOTO      SPTFOL99
.
SPTFOL08  PACK      PTFOL008,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL09  PACK      PTFOL009,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL10  PACK      PTFOL010,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL11  PACK      PTFOL011,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL12  PACK      PTFOL012,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL13  PACK      PTFOL013,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL14  PACK      PTFOL014,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL15  PACK      PTFOL015,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL16  PACK      PTFOL016,QRYDATA,SP70
          GOTO      SPTFOL99
.
SPTFOL99  RETURN
.
.------------------------------------------------------------
.  Update cgi to eclipse location ids - patlcnaf
.------------------------------------------------------------
MPTLC000  MATCH     PTLCN001,Z70
          IF        !@EQUAL
            MOVE      PTLCN001,PTLNLOCN
          ENDIF
.
          MATCH     PTLCN002,Z70
          IF        !@EQUAL
            MOVE      PTLCN002,PTLNDESC
          ENDIF
.
          MATCH     PTLCN003,Z70
          IF        !@EQUAL
            MOVE      PTLCN003,PTLNACTV
          ENDIF
.
          MATCH     PTLCN004,Z70
          IF        !@EQUAL
            MOVE      PTLCN004,PTLNHOSP
          ENDIF
.
MPTLC999  RETURN
.
.------------------------------------------------------------
.  Update cgi to eclipse certificates - patcrtaf
.------------------------------------------------------------
MPTCR000  MATCH     PTCRT001,Z70
          IF        !@EQUAL
            MOVE      PTCRT001,PTCILOCN
          ENDIF
.
          MATCH     PTCRT002,Z70
          IF        !@EQUAL
            MOVE      PTCRT002,PTCIFDTE
          ENDIF
.
          MATCH     PTCRT003,Z70
          IF        !@EQUAL
            MOVE      PTCRT003,PTCIIDEN
          ENDIF
.
          MATCH     PTCRT004,Z70
          IF        !@EQUAL
            MOVE      PTCRT004,PTCITDTE
          ENDIF
.
          MATCH     PTCRT005,Z70
          IF        !@EQUAL
            MOVE      PTCRT005,PTCISNID
          ENDIF
.
MPTCR999  RETURN
.
.------------------------------------------------------------
.  Update cgi to gp access audit - pmsgpaaf
.------------------------------------------------------------
MVGPA000  MATCH     PMGPA001,Z70
          IF        !@EQUAL
            MOVE      PMGPA001,PMGPURNO
          ENDIF
.
          MATCH     PMGPA002,Z70
          IF        !@EQUAL
            MOVE      PMGPA002,PMGPWEBU
          ENDIF
.
          MATCH     PMGPA003,Z70
          IF        !@EQUAL
            MOVE      PMGPA003,PMGPOVRS
          ENDIF
.
          MATCH     PMGPA04A,Z70
          IF        !@EQUAL
            MOVE      PMGPA04A,PMGPOVT1
          ENDIF
.
          MATCH     PMGPA04B,Z70
          IF        !@EQUAL
            MOVE      PMGPA04B,PMGPOVT2
          ENDIF
.
          MATCH     PMGPA04C,Z70
          IF        !@EQUAL
            MOVE      PMGPA04C,PMGPOVT3
          ENDIF
.
          MATCH     PMGPA04D,Z70
          IF        !@EQUAL
            MOVE      PMGPA04D,PMGPOVT4
          ENDIF
.
MVGPA999  RETURN
.
.------------------------------------------------------------
. Update patient follow up. Type = 026
.------------------------------------------------------------
MPTFL000  MATCH     Z70,PTFOL001
          IF        !@EQUAL
            PACK      PTARTXT1,PTFOL001,PTFOL002,SP70
          ENDIF
.
          MATCH     Z70,PTFOL003
          IF        !@EQUAL
            MOVE      PTFOL003,PTARCOD1
          ENDIF
.
          MATCH     Z70,PTFOL004
          IF        !@EQUAL
            PACK      PTARTXT2,PTFOL004,PTFOL005,SP70
          ENDIF
.
          MATCH     Z70,PTFOL006
          IF        !@EQUAL
            MOVE      PTFOL006,PTARCOD2
          ENDIF
.
          MATCH     Z70,PTFOL007
          IF        !@EQUAL
            PACK      PTARTXT3,PTFOL007,PTFOL008,SP70
          ENDIF
.
          MATCH     Z70,PTFOL009
          IF        !@EQUAL
            MOVE      PTFOL009,PTARCOD3
          ENDIF
.
          MATCH     Z70,PTFOL010
          IF        !@EQUAL
            MOVE      PTFOL010,PTARCOD4
          ENDIF
.
MPTFL099  RETURN
.
.------------------------------------------------------------
. Update patient follow up. Type = 027
.------------------------------------------------------------
MPTFL100  MATCH     Z70,PTFOL011
          IF        !@EQUAL
            MOVE      PTFOL011,PTARCOD1
          ENDIF
.
          MATCH     Z70,PTFOL012
          IF        !@EQUAL
            MOVE      PTFOL012,PTARCOD2
          ENDIF
.
. comment details
.
          MATCH     Z70,PTFOL013
          IF        !@EQUAL
            MOVE      PTFOL013,PTARTXT1
          ENDIF
.
          MATCH     Z70,PTFOL014
          IF        !@EQUAL
            MOVE      PTFOL014,PTARTXT2
          ENDIF
.
          MATCH     Z70,PTFOL015
          IF        !@EQUAL
            MOVE      PTFOL015,PTARTXT3
          ENDIF
.
          MATCH     Z70,PTFOL016
          IF        !@EQUAL
            MOVE      PTFOL016,PTARTXT4
          ENDIF
.
MPTFL199  RETURN
+
.------------------------------------------------------------
. Clear variables for gp access audit - pmsgpaaf
.------------------------------------------------------------
CLRGPA00  MOVE      SP70,PMGPURNO
          MOVE      SP70,PMGPWEBU
          MOVE      SP70,PMGPUGPC
          MOVE      SP70,PMGPPGPC
          MOVE      SP70,PMGPPPRC
          MOVE      SP70,PMGPOVRS
          MOVE      SP70,PMGPOVT1
          MOVE      SP70,PMGPOVT2
          MOVE      SP70,PMGPOVT3
          MOVE      SP70,PMGPOVT4
          MOVE      SP70,PMGPDATC
          MOVE      SP70,PMGPTIMC
.
CLRGPA99  RETURN
+
.------------------------------------------------------------
.  Clear variables for location ids - patlcnaf
.------------------------------------------------------------
CLRLCN00  MOVE      SP70,PTLNLOCN
          MOVE      SP70,PTLNDESC
          MOVE      SP70,PTLNACTV
          MOVE      SP70,PTLNHOSP
          MOVE      SP70,PTLNSPAR
.
CLRLCN99  RETURN
+
.------------------------------------------------------------
.  Clear variables for certificates - patcrtaf
.------------------------------------------------------------
CLRCRT00  MOVE      SP70,PTCILOCN
          MOVE      SP70,PTCIFDTE
          MOVE      SP70,PTCIIDEN
          MOVE      SP70,PTCITDTE
          MOVE      SP70,PTCISNID
          MOVE      SP70,PTCISPAR
.
CLRCRT99  RETURN
+
.------------------------------------------------------------
. Hospital ID
.------------------------------------------------------------
HOSPID00  OPEN      PATHSPA1,"pathspaf"
.
          PACK      KEY3,SP10
          CALL      RSPTHSP1
HOSPID10  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSPID90
.
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          BRANCH    IBCNMHOS,HOSPID20
          WRITE     HTMLFILE;"<option value=",KEY5,">":
                             PTHSNAME,"</option>"
          GOTO      HOSPID10
.
.         Mult-Hospital
.
HOSPID20  MATCH     WBSEHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               PTHSNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">":
                               PTHSNAME,"</option>"
          ENDIF
          GOTO      HOSPID10
.
HOSPID90  CLOSE     PATHSPA1
HOSPID99  RETURN
+
.------------------------------------------------------------
. List certificate details - patcrtaf
.------------------------------------------------------------
LCTAB000  PACK      KEY16,PTLCN001,SP70
          CALL      RSPTCTI1
LCTAB100  CALL      RKPTCTI1
          BRANCH    OVRCD,LCTAB999
.
          MATCH     PTLNLOCN,PTCILOCN            * same location still ?
          GOTO      LCTAB999 IF NOT EQUAL        * no - finished
.
          MOVE      SP70,DIM11
          MATCH     SP70,PTCIFDTE
          IF        !@EQUAL & !@EOS
            UNPACK    PTCIFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          MOVE      SP70,DIM11A
          MATCH     SP70,PTCITDTE
          IF        !@EQUAL & !@EOS
            UNPACK    PTCITDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11A,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
.         See if this certificate is current
          MOVE      "No ",DIM3
          CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     PTCIFDTE,CURRDATE
          IF        !@LESS
            MATCH     CURRDATE,PTCITDTE
            IF        !@LESS
              MOVE    "Yes",DIM3
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/MaintenanceIcon.gif'":
                           " class=ListIcon onclick=updatePatCRT('":
                           PTCILOCN,"','",PTCIFDTE,"');>&nbsp;",DIM11,"#",":
                                      "#"",PTCIIDEN,"#",":
                                      "#"",DIM11A,"#",":
                                      "#"",PTCISNID,"#",":
                                      "#"",DIM3,"#");"
.
          GOTO      LCTAB100
.
LCTAB999  RETURN
+
.------------------------------------------------------------
. GP Access Audit Details
.------------------------------------------------------------
GPAC0000  MATCH     SP70,URNUMBER
          GOTO      GPAC0500 IF EQUAL
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,GPAC9200
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
GPAC0500  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      GPAC8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add Audit Records
          GOTO      GPAC1000 IF EQUAL
.
          GOTO      GPAC9000
.
.         ************ ADD AUDIT RECORD ***********
.
GPAC1000  CALL      CLRGPA00
          CALL      MVGPA000
.
          CALL      IBACLOCK
          PACK      PMGPDATC,CCC,CYY,CMM,CDD
          REP       " 0",PMGPDATC
          MOVE      CTIMEIS,PMGPTIMC
          PACK      PMGPUGPC,WBSEGPCD,SP70
.
          PACK      KEY8,PMGPA001,SP70
          CALL      RDPMPX21
          IF        OVRCD<>1
            MATCH     "1",WBSEGPAC
            IF        @EQUAL
              PACK      PMGPPGPC,PMPXRHC1,SP70
              PACK      PMGPPPRC,PMPXRH1G,SP70
            ELSE
              PACK      PMGPPGPC,PMPXVGPC,SP70
              PACK      PMGPPPRC,PMPXVGPP,SP70
            ENDIF
          ENDIF
.
          PACK      KEY34,PMGPA001,PMGPA002,PMGPDATC,PMGPTIMC,SP70
          CALL      RAPMGPA1
          IF        OVRCD=0
            GOTO      GPAC9100
          ELSE
            CALL      WRPMGPA1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      GPAC9999
.
.         ************ DISPLAY FORMACTION **********
.
GPAC8000  CLEAR     WEBTITLE
          MOVE      "GP Access Audit Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      CURPER00
          CALL      CALCDT00
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GPAC9999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      GPAC9999
.
GPAC9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GPAC9999
.
GPAC9100  MOVE      "GP Access Audit record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GPAC9999
.
GPAC9200  MOVE      "Patient Master record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GPAC9999
.
GPAC9999  RETURN
+
.------------------------------------------------------------
. GP Access List by UR   
.------------------------------------------------------------
GPALU000  PACK      KEY34,URNUMBER,SP70
          CALL      RSPMGPA1
GPALU100  CALL      RKPMGPA1
          BRANCH    OVRCD,GPALU999
.
          MATCH     URNUMBER,PMGPURNO
          GOTO      GPALU999 IF NOT EQUAL
.
          PACK      KEY10,PMGPWEBU
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,SP70
          ENDIF
.
          PACK      KEY5,ANSO,ANSJ,PMGPOVRS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",PMGPURNO,"#",":              *0
                                      "#"",PMGPWEBU,"#",":              *1
                                      "#"",WBSENAM,"#",":               *2
                                      "#"",WBSEGPCD,"#",":              *3
                                      "#"",PMGPPGPC,SLASH,PMGPPPRC,"#",":  *4
                                      "#"",TDESC,"#",":                 *5
                                      "#"",PMGPOVT1,"<br>":
                                      PMGPOVT2,"<br>":
                                      PMGPOVT3,"<br>":
                                      PMGPOVT4,"<br>#",":
                                      "#"",PMGPDATC,PMGPTIMC:           *7
                                      "#");"
          GOTO      GPALU100
.
GPALU999  RETURN
+
.------------------------------------------------------------
. GP Access List by Date 
.------------------------------------------------------------
GPALD000  PACK      KEY34,FRSTDATE,SP70
          CALL      RSPMGPA2
GPALD100  CALL      RKPMGPA2
          BRANCH    OVRCD,GPALD999
.
          MATCH     PMGPDATC,LASTDATE
          GOTO      GPALD999 IF LESS
.
          PACK      KEY10,PMGPWEBU
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSENAM,SP70
          ENDIF
.
          PACK      KEY5,ANSO,ANSJ,PMGPOVRS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
          MATCH     SP70,FILTUSER
          IF        !@EQUAL
            MATCH     FILTUSER,PMGPWEBU
            GOTO      GPALD100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTGPCD
          IF        !@EQUAL
            MATCH     FILTGPCD,WBSEGPCD
            GOTO      GPALD100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTWBGP
          IF        !@EQUAL
            MATCH     FILTWBGP,PMGPPGPC
            GOTO      GPALD100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPPRC
          IF        !@EQUAL
            MATCH     FILTPPRC,PMGPPPRC
            GOTO      GPALD100 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",PMGPURNO,"#",":              *0
                                      "#"",PMGPWEBU,"#",":              *1
                                      "#"",WBSENAM,"#",":               *2
                                      "#"",WBSEGPCD,"#",":              *3
                                      "#"",PMGPPGPC,SLASH,PMGPPPRC,"#",":  *4
                                      "#"",TDESC,"#",":                 *5
                                      "#"",PMGPOVT1,"<br>":
                                      PMGPOVT2,"<br>":
                                      PMGPOVT3,"<br>":
                                      PMGPOVT4,"<br>#",":
                                      "#"",PMGPDATC,PMGPTIMC:           *7
                                      "#");"
          GOTO      GPALD100
.
GPALD999  RETURN
+
.------------------------------------------------------------
. Previous Admission Details     
.------------------------------------------------------------
PHSP0000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PHSP9200
          CALL      RDPMPX21
          BRANCH    OVRCD,PHSP9200
.
          CALL      CLEMRVIS
.
          MATCH     SP70,ADMISSNO
          GOTO      PHSP9500 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL       CLPATVIS
          ENDIF
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL       CLPMSVX1
          ENDIF
.
          MOVE      SP70,PTMI3BDY
          MOVE      SP70,PTMI3BAD
          COMPARE   THREE,PVITYPE
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,PHSP9500
          ENDIF
.
          COMPARE   ONE,PVITYPE
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            BRANCH    OVRCD,PHSP9500
          ENDIF
.
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      PHSP8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add previous admission
          GOTO      PHSP1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update previous admission
          GOTO      PHSP1500 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete previous admission
          GOTO      PHSP2000 IF EQUAL
.
          GOTO      PHSP9000
.
.         ************ ADD PREVIOUS ADMISSION ***********
.
PHSP1000  IF        ENTERDAY = 1 & PVITYPE = 3
            PACK      KEY8,ADMISSNO,SP70         * Manually entered
            CALL      RDMISS1                    * previous days
            BRANCH    OVRCD,PHSP9500             * hospitalisation
. 
            MOVE      PROGDAYS,ADYHOSP
            CALL      UPMISS1
            GOTO      PHSP1050
          ENDIF
.
          CALL      CLPMSPHS
          CALL      MVPMPH00
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPHCDAT                * System date
          CLOCK     TIME,PMPHCTIM                * System time
          MOVE      USERID,PMPHCUID              * web user id
          MOVE      SP70,PMPHUDAT
          MOVE      SP70,PMPHUTIM
          MOVE      SP70,PMPHUUID
.
.         Public hospital - set Yes to Billing and 3B Cert.Calculations because
.         they don't have the fields on their template
.         **  Note: Historic data in WA health, PMPHINCB and PMPHINCC are
.             'blank' to Calculate Billing/3B Certificate
.
          PACK      KEY29,PMPHADMN,PMPHADAT,PMPHDDAT,PMPHPHOS,SP70
          CALL      RAPMPHS1
          IF        OVRCD=0
            GOTO      PHSP9100
          ELSE
            BRANCH    IBCNMHOS,PHSP1010       * multi hospital
.
            BRANCH    CHOSTYP,PHSP1020         * public hospital
            GOTO      PHSP1040
          ENDIF
.
PHSP1010  MATCH     SP70,PMVXMHOS
          GOTO      PHSP1040 IF EQUAL
.
          OPEN      PATHSPA1,"pathspaf"
          MOVE      PMVXMHOS,KEY3
          CALL      RDPTHSP1
          BRANCH    OVRCD,PHSP1040
.
          MATCH     "1",PTHSHOST             * Public hospital
          GOTO      PHSP1040 IF NOT EQUAL    * no
.
PHSP1020  MOVE      "1",PMPHINCB             * Include in Billing Calc.
          MOVE      "1",PMPHINCC             * INclude in 3B Cert.Calc.
.
PHSP1040  CALL      WRPMPHS1
.
          COMPARE   THREE,PVITYPE
          IF        @EQUAL
            CALL      CORIG000   * Calculate original adm date and 
.                                * no. days hospitalisation
          ENDIF
.
PHSP1050  MOVE      ZERO,EXIT
          GOTO      PHSP9999
.
.         ************ UPDATE FORMACTION **********
.
PHSP1500  PACK      KEY29,PMPHS001,PMPHS003,PMPHS004,PMPHS002,SP70
          CALL      RDPMPHS1
          BRANCH    OVRCD,PHSP9300
.
          CALL      MVPMPH00
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,PMPHUDAT                * System date
          CLOCK     TIME,PMPHUTIM                * System time
          MOVE      USERID,PMPHUUID              * web user id
          CALL      UPPMPHS1
.
          COMPARE   THREE,PVITYPE
          IF        @EQUAL
            CALL      CORIG000   * Calculate original adm date and
.                                * no. days hospitalisation
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PHSP9999
.
.         ************ DELETE LOCATION ID FORMACTION **********
.
PHSP2000  IF        ASTAT=3
            CALL      SUBDLV00   * Subtract hospital days from linked visit
          ENDIF
.
          PACK      KEY29,PMPHS001,PMPHS003,PMPHS004,PMPHS002,SP70
          CALL      DEPMPHS1     * Delete Previous Hospitalisation record
.
          COMPARE   THREE,PVITYPE
          IF        @EQUAL
            CALL      CORIG000   * Calculate original adm date and
.                                * no. days hospitalisation
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PHSP9999
.
.         ************ DISPLAY FORMACTION **********
.
PHSP8000  PACK      KEY29,PMPHS001,PMPHS003,PMPHS004,PMPHS002,SP70
          CALL      RDPMPHS1
          IF        OVRCD=1
            CALL      CLPMSPHS
          ENDIF
.
          MATCH     Z70,PMPHS001
          IF        !@EQUAL
            PACK      KEY29,PMPHS001,PMPHS003,PMPHS004,PMPHS002,SP70
            CALL      RDPMPHS1
            BRANCH    OVRCD,PHSP9600
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Previous Hospital Admission Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PHSP9999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9100  MOVE      "Previous Hospital Admission already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9200  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9300  MOVE      "Invalid Previous Hospital Admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9500  MOVE      "Invalid Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9600  MOVE      "Invalid Previous Admission Details Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PHSP9999
.
PHSP9999  RETURN
+
.------------------------------------------------------------------------------
.         Subtract Hospital Days from Linked Visit
.------------------------------------------------------------------------------
SUBDLV00  PACK      KEY29,PMPHS001,PMPHS003,PMPHS004,PMPHS002,SP70
          CALL      RDPMPHS1
          BRANCH    OVRCD,SUBDLV99
.
          MOVE      ZERO,NODAYS
          DAYSEP    PMPHADAT,PMPHDDAT,NODAYS
.
          MOVE      ZERO,F8
          SQUEEZE   PMPHLDAY
          MOVE      PMPHLDAY,F8             * No. of Leave Days
          SUB       F8,NODAYS               * subtract no. of Leave Days
.
          PACK      KEY8,PMPHADMN,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,SUBDLV99
.
.         Read linked visit (Statistical Admission)
          PACK      KEY8,PTDSLSDN,SP70      * use Linked Statistical Discharge
          CALL      RDMISS1
          BRANCH    OVRCD,SUBDLV99
.
          SUB       NODAYS,ADYHOSP     * subtract from no. days hospitalised
          MOVE      ADYHOSP,PTMI3BDY
          CALL      UPMISS1
.
SUBDLV99  RETURN
+
.------------------------------------------------------------
. Calculate original admission date and no. days hospitalisation
.------------------------------------------------------------
CORIG000  MOVE      ZERO,FORM8
          MOVE      ZERO,NODAYS
          MOVE      ZERO,TOTNDAYS
          MOVE      ZERO,TOT3BDAY
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CORIG999
.
          MOVE      ZERO,ADYHOSP
          MOVE      ZERO,PTMI3BDY
          PACK      PTMI3BAD,SP70
          MOVE      ADATE,SAVEADAT
.
          PACK      KEY29,ADMISSNO,ADATE,Z70
          CALL      RSPMPHS1
CORIG100  CALL      RPPMPHS1
          BRANCH    OVRCD,CORIG900
.
          MATCH     ADMISSNO,PMPHADMN
          GOTO      CORIG900 IF NOT EQUAL
.
          MOVE      ZERO,F8
          DAYSEP    PMPHDDAT,SAVEADAT,F8
          IF        F8 > 7
            GOTO      CORIG900
          ENDIF
.
          PACK      PTMI3BAD,PMPHADAT,SP70
          DAYSEP    PMPHADAT,PMPHDDAT,NODAYS
          PACK      DIM8,SAVEADAT,SP70
          MATCH     PMPHDDAT,DIM8
          IF        @EQUAL
            COMPARE   ZERO,NODAYS
            IF        !@LESS
.....         SUB       ONE,NODAYS
            ENDIF
          ENDIF
          MOVE      PMPHADAT,SAVEADAT
          MOVE      ZERO,F8
          SQUEEZE   PMPHLDAY
          MOVE      PMPHLDAY,F8             * No. of Leave Days
          SUB       F8,NODAYS               * subtract no. of Leave Days
.
          IF        IBCNMHOS=1
            MOVE      AADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS           * Hospital id
              IF        !@EQUAL
                OPEN      PATHSPA1,"pathspaf"   * limited no of open files
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     "1",PTHSHOST        * Public hospital
                  GOTO      CORIG800 IF EQUAL
                ENDIF
              ENDIF
            ENDIF
          ELSE
            BRANCH    CHOSTYP,CORIG800          * Public hospital
          ENDIF
.
          MATCH     "1",PMPHINCB            * Include in Billing Calculations
          IF        @EQUAL
            ADD       NODAYS,TOTNDAYS
            MOVE      TOTNDAYS,ADYHOSP
          ENDIF
.
          MATCH     "1",PMPHINCC            * Include in 3B Cert. Calculations
          IF        @EQUAL
            ADD       NODAYS,TOT3BDAY
            MOVE      TOT3BDAY,PTMI3BDY
          ENDIF
.
          GOTO      CORIG100
.
.         WA HEALTH has the value of blank for PMPHINCB and PMPHINCC to Include
.         Billing and 3B Cert Calculations
.
CORIG800  MATCH     "0",PMPHINCB            * Include in Billing Calculations
          IF        !@EQUAL
            ADD       NODAYS,TOTNDAYS
            MOVE      TOTNDAYS,ADYHOSP
          ENDIF
.
          MATCH     "0",PMPHINCC            * Include in 3B Cert. Calculations
          IF        !@EQUAL
            ADD       NODAYS,TOT3BDAY
            MOVE      TOT3BDAY,PTMI3BDY
          ENDIF
.
          GOTO      CORIG100
.
CORIG900  CALL      UPMISS1
          GOTO      CORIG999
.
CORIG999  RETURN
.
.------------------------------------------------------------
. Validate contact type being added.
.------------------------------------------------------------
VCON0000  CALL      XMLHED00
          BRANCH    EXIT,VCON9999
.
          MATCH     "1",PMCEX018            * Don't perform edits if adding
          GOTO      VCON8500 IF EQUAL       * an inactive contact
.
          MATCH     Z70,PMCEX003
          IF        !@EQUAL
            PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
            CALL      RDPMCEX1
            BRANCH    OVRCD,VCON9400
.
            MATCH     PMCEACTV,PMCEX018       * Don't perform edits if updating
            GOTO      VCON8500 IF EQUAL       * and no status change
          ENDIF
.
          PACK      KEY5,CATTC,PMCEX002,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VCON9000
.
          STRIP     TDESC
          MOVE      ZERO,ALLOWDUP
          MATCH     "D",TCINDC4
          IF        @EQUAL
            MOVE      ONE,ALLOWDUP          * Duplicate active contacts allowed
          ENDIF
.
          MOVE      ZERO,INACFLAG           * Set inactive contacts to no
          MOVE      ZERO,ACTVFLAG           * Set active contacts to no
.
          PACK      KEY14,PMCEX001,PMCEX002,SP70
          CALL      RSPMCEX1
VCON1000  CALL      RKPMCEX1
          BRANCH    OVRCD,VCON8000
.
          MATCH     PMCEX001,PMCEURNO       * Same U/R
          GOTO      VCON8000 IF NOT EQUAL
.
          MATCH     PMCEX002,PMCETYPE       * Same Contact Type
          GOTO      VCON8000 IF NOT EQUAL
.
          MATCH     Z70,PMCEX003            * Counter
          IF        !@EQUAL
            MATCH     PMCEX003,PMCECNTR     * Skip record you are updating when
            GOTO      VCON1000 IF EQUAL     * in update mode
          ENDIF
.
          MATCH     "1",PMCEACTV
          IF        @EQUAL
            MOVE      ONE,INACFLAG          * Set inactive contacts to yes
          ELSE
            MOVE      ONE,ACTVFLAG          * Set active contacts to yes
          ENDIF
          GOTO      VCON1000
.
VCON8000  IF        ALLOWDUP=1
            BRANCH    ACTVFLAG,VCON9300
          ELSE
            BRANCH    ACTVFLAG,VCON9100
            BRANCH    INACFLAG,VCON9200
          ENDIF
.
VCON8500  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SP1:
                             "</RETURN_VALUE>"
          GOTO      VCON9800
.
VCON9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Contact Type - ":
                              KEY5,"</RETURN_VALUE>"
          GOTO      VCON9800
.
VCON9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Active contact type ",*+,TDESC," exists. ":
                             "This contact type does not accept duplicate ":
                             "active contacts.":
                             "</RETURN_VALUE>"
          GOTO      VCON9800
.
VCON9200  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Inactive contact type ",*+,TDESC," exists. ";
.
          MATCH     Z70,PMCEX003
          IF        @EQUAL
            WRITE     HTMLFILE;"Press OK to create new active contact. ";
          ELSE
            WRITE     HTMLFILE;"Press OK to continue. ";
          ENDIF
.
          WRITE     HTMLFILE;"Cancel to return to contact maintenance.":
                             "</RETURN_VALUE>"
          GOTO      VCON9800
.
VCON9300  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Active contact type ",*+,TDESC," exists. ";
.
          MATCH     Z70,PMCEX003
          IF        @EQUAL
            WRITE     HTMLFILE;"Press OK to create new active contact. ";
          ELSE
            WRITE     HTMLFILE;"Press OK to continue. ";
          ENDIF
.
          WRITE     HTMLFILE;"Cancel to return to contact maintenance.":
                             "</RETURN_VALUE>"
          GOTO      VCON9800
.
VCON9400  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Contact Record - ":
                              KEY14,"</RETURN_VALUE>"
          GOTO      VCON9800
VCON9800  RESET     TDESC
          CALL      XMLEND00
.
VCON9999  RETURN
.
.------------------------------------------------------------
. Extra Contact History List for a U/R
.------------------------------------------------------------
CHIS0000  PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
CHIS1000  CALL      RKPMCEX1
          BRANCH    OVRCD,CHIS9999
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      CHIS9999 IF NOT EQUAL
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,PMCETYPE
            GOTO      CHIS1000 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,PMCETYPE
          IF        !@EQUAL
            PACK      KEY5,CATTC,PMCETYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMCETYPE,TDESC
            ENDIF
          ENDIF
.
          MOVE      "Active",DISPSTAT
          MATCH     "1",PMCEACTV
          IF        @EQUAL
            MOVE      "Inactive",DISPSTAT
          ENDIF
.
          MOVE      "No",DIM3
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowContactAudit('",HTMLLINK
          APPEND    PMCEURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCETYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCECNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              * 0
                                      "#"",TDESC,"#",":                 * 1
                                      "#"",TCFORM6,"#",":               * 2
                                      "#"",DISPSTAT,"#",":              * 3
                                      "#"",PMRLDESC,"#",":              * 4
                          "#"",PMCEGNAM," ",PMCEGNM2," ",PMCESNAM,"#",": * 5
                                      "#"",PMCETELP,"#",":              * 6
                                      "#"",PMCETELB,"#",":              * 7
                                      "#"",PMCETELM,"#",":              * 8
                                      "#"",PMCEADD1," ",PMCEADD2:       * 9 
                                      " ",PMCEADD3," ",PMCEADD4:
                                      " ",PMCEPOST,"#",":              
                                      "#"",DIM3,"#",":              * 10
                                      "#"",PMCEFTXT,"#");"          * 11   
.
          GOTO      CHIS1000
.
CHIS9999  RETURN
.
.------------------------------------------------------------
. Deleted Extra Contact History List for a U/R
.------------------------------------------------------------
DHIS0000  PACK      KEY33,URNUMBER,SP20
          CALL      ASPMCEX2
DHIS1000  CALL      AKPMCEX2
          BRANCH    OVRCD,DHIS9999
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      DHIS9999 IF NOT EQUAL
.
          MATCH     ANSD,PMCEAUDR
          GOTO      DHIS1000 IF NOT EQUAL
.
          MATCH     SP70,FILTCTYP
          IF        !@EQUAL
            MATCH     FILTCTYP,PMCETYPE
            GOTO      DHIS1000 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,PMCETYPE
          IF        !@EQUAL
            PACK      KEY5,CATTC,PMCETYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMCETYPE,TDESC
            ENDIF
          ENDIF
.
          MOVE      "Deleted",DISPSTAT
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
          MOVE      "No",DIM3
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowContactAudit('",HTMLLINK
          APPEND    PMCEURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCETYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCECNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              * 0
                                      "#"",TDESC,"#",":                 * 1
                                      "#"",TCFORM6,"#",":               * 2
                                      "#"",DISPSTAT,"#",":              * 3
                                      "#"",PMRLDESC,"#",":              * 4
                          "#"",PMCEGNAM," ",PMCEGNM2," ",PMCESNAM,"#",": * 5
                                      "#"",PMCETELP,"#",":              * 6
                                      "#"",PMCETELB,"#",":              * 7
                                      "#"",PMCETELM,"#",":              * 8
                                      "#"",PMCEADD1," ",PMCEADD2:       * 9 
                                      " ",PMCEADD3," ",PMCEADD4:
                                      " ",PMCEPOST,"#",":               
                                      "#"",DIM3,"#",":              * 10
                                      "#"",PMCEFTXT,"#");"          * 11
.
          GOTO      DHIS1000
.
DHIS9999  RETURN
.
.------------------------------------------------------------
. Extra contact history list for an individual contact
.------------------------------------------------------------
DETH0000  PACK      KEY33,PMCEX001,PMCEX002,PMCEX003,SP20
          CALL      ASPMCEX2
DETH1000  CALL      AKPMCEX2
          BRANCH    OVRCD,DETH9999
.
          MATCH     PMCEX001,PMCEURNO
          GOTO      DETH9999 IF NOT EQUAL
.
          MATCH     PMCEX002,PMCETYPE
          GOTO      DETH9999 IF NOT EQUAL
.
          MATCH     PMCEX003,PMCECNTR
          GOTO      DETH9999 IF NOT EQUAL
.
          MATCH     "A",PMCEAUDR            * Don't display add records
          IF        @EQUAL
            MOVE      "Add",DISPATYP
          ENDIF
.
          MATCH     "C",PMCEAUDR            * Don't display change records
          IF        @EQUAL
            MOVE      "Change",DISPATYP
          ENDIF
.
          MATCH     "B",PMCEAUDR
          IF        @EQUAL
            MOVE      "Before",DISPATYP
          ENDIF
.
          MATCH     "D",PMCEAUDR
          IF        @EQUAL
            MOVE      "Deleted",DISPATYP
          ENDIF
.
          PACK      KEY33,PMCEURNO,PMCETYPE,PMCECNTR,PMCEAUDD:
                          PMCEAUDT,PMCEAUDP,PMCEAUDR,SP70
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowAuditDetail('",HTMLLINK
          APPEND    KEY33,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,DISPUSER
          PACK      KEY14,PMCEAUDO,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD=0
            MATCH     PMCEAUDO,WBSEPCD
            IF        @EQUAL
              MOVE      WBSENAM,DISPUSER
            ENDIF
          ENDIF
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              * 0
                                      "#"",PMCEAUDD,PMCEAUDT,"#",":     * 1
                                      "#"",DISPATYP,"#",":              * 2
                                      "#"",DISPUSER,"#",":              * 3
                         "#"",PMCEGNAM," ",PMCEGNM2," ",PMCESNAM,"#",": * 4
   "#"",PMCEADD1," ",PMCEADD2," ",PMCEADD3," ",PMCEADD4," ",PMCEPOST,"#",": * 5
                                      "#"",PMRLDESC,"#",":                  * 6
                                      "#"",PMCEDINA,"#");"                  * 7
.
          GOTO      DETH1000
.
DETH9999  RETURN
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
OPNOUT99  RETURN
+
.******************************************************************************
.*                                 WPRSP000                                   *
.*             Write/update prspmiaf with concession card change              *
.******************************************************************************
WPRSP000  COMPARE   SIX,PTCNHDPS
          GOTO      WPRSP999 IF NOT EQUAL        * only WA
.
          MOVE      PMCDURNO,P2PMURNO
          MOVE      "13",P2PMUNIQ
          MOVE      PMCDCNUM,P2PMVALU
          PACK      P2PMSPAR,SP70
          PACK      KEY11,P2PMURNO,P2PMUNIQ,SP70
          CALL      RAP2PMI1
          IF        OVRCD=1
            CALL      WRP2PMI1
          ELSE
            CALL      UPP2PMI1
          ENDIF
WPRSP999  RETURN
+
.-----------------------------------------------------------------------------
. Payer details Maintenance: Display,Add,Update,Delete
.-----------------------------------------------------------------------------
PAYER000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA1,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA2,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA3,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA1,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSIDEA5,"pmsideaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PAYER930
.
          MOVE      ZERO,EXIT
          MOVE      URNUMBER,PMPYR001
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PAYER930
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF

          RESET     UPDTTYPE
.
          MATCH     SP70,UPDTTYPE           * Display formaction
          GOTO      PAYER800 IF EQUAL
.
          MATCH     "Z",UPDTTYPE            * Display - Check Default payer
          GOTO      PAYER800 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add Payer formaction
          GOTO      PAYER100 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Payer formaction
          GOTO      PAYER200 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Payer formaction
          GOTO      PAYER300 IF EQUAL
.
          MATCH     "B",UPDTTYPE            * Update Breakdown
          GOTO      PAYER400 IF EQUAL
.
          GOTO      PAYER999
.
.         Add payer record
.
PAYER100  PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          COMPARE   ZERO,OVRCD
          GOTO      PAYER920 IF EQUAL       * already exist
.
          CALL      COLP0000                * Check it's not overlap
          BRANCH    EXIT,PAYER980
.
          CALL      MVPMPY00
          PACK      PMPYCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMPYCDAT                * System date
          CLOCK     TIME,PMPYCTIM                * System time
          MOVE      USERID,PMPYCUID              * web user id
          MOVE      SP70,PMPYUDAT
          MOVE      SP70,PMPYUTIM
          MOVE      SP70,PMPYUUID
.
          CALL      WRPMPYR1
          MOVE      ZERO,EXIT
          GOTO      PAYER999
.
.         Update payer record
.
PAYER200  
          PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1                     * Update
          BRANCH    OVRCD,PAYER910
.
          CALL      MVPMPY00
.
          PACK      PMPYUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMPYUDAT                * Systen date
          CLOCK     TIME,PMPYUTIM                * System time
          MOVE      USERID,PMPYUUID              * web user id
          CALL      UPPMPYR1
.
          MOVE      ZERO,EXIT
          GOTO      PAYER999
.
.         Delete payer record
.
PAYER300  PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1                     * Delete
          BRANCH    OVRCD,PAYER910
.
.         Can not delete payer who has invoice raised
.
          PACK      KEY25,PVIBILL,PMPYR003,Z70
          CALL      RSPMIDE1
          CALL      RPPMIDE1
          BRANCH    OVRCD,PAYER380
.
          MATCH     DPVIBILL,PMIDADMN
          GOTO      PAYER380 IF NOT EQUAL   * different admission
          MATCH     PMPYR003,PMIDCLTY
          GOTO      PAYER380 IF NOT EQUAL
.
          MATCH     SP70,PMIDINVN
          IF        !@EQUAL
            OPEN      PATINVR1,"patinvrf"
            MOVE      PMIDINVN,KEY8
            CALL      RDINV1
            IF        OVRCD=0
              MATCH     "1",PTINCRST
              GOTO      PAYER970 IF NOT EQUAL  * not credit noted
            ENDIF
          ENDIF
.
PAYER380  CALL      DEPMPYR1
.
          CALL      DBRK0000                     * Delete payer breakdown
          CALL      DIDE0000                     * Delete invoice breakdown
.
          MOVE      ZERO,EXIT
          GOTO      PAYER999
.
.         Payers breakdown
.
PAYER400  PACK      KEY20,ADMISSNO,PTRGM001,SP70       * Regime code
          CALL      RSPTRGM2
          CALL      RKPTRGM2
          BRANCH    OVRCD,PAYER999
.
          MATCH     ADMISSNO,PTRGADMN
          GOTO      PAYER999 IF NOT EQUAL
.
          CALL      WPYR0000            * Write to payer breakdown
          BRANCH    EXIT,PAYER960,PAYER990
.
          CALL      DIDA0000            * Delete invoice breakdown
.
          MOVE      ZERO,EXIT
          GOTO      PAYER999
.
PAYER800  MOVE      ZERO,EXIT
          PACK      KEY19,URNUMBER,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          IF        OVRCD=1
            CALL      CLPMSPYR
          ENDIF
.
          MOVE      "  0",PMPBICNT
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,PMPBICNT,SP70
          CALL      RDPMPBR1
          IF        OVRCD=1
            CALL      CLPMSPBR
          ENDIF
.
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
          CALL      RKPTRGM1
          IF        OVRCD=0
            MATCH     ADMISSNO,PTRGADMN
            IF        @EQUAL
              MOVE      "  0",PMREUNIQ
              PACK      KEY13,PTRGREGM,PMREUNIQ,SP70
              CALL      RDPMREG1
              IF        OVRCD=1
                MOVE       SP70,PMREREGM
                MOVE       SP70,PMREDESC
              ENDIF   
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Payer details Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PAYER999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER900  MOVE      "Missing Master record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER910  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER920  MOVE      "Record already exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER930  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER940  MOVE      "Items for Regime has been changed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER960  CLEAR     WEBTITLE
          APPEND    "A payer can pay either ",WEBTITLE
          APPEND    "Accommodation or One item only.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER970  CLEAR     WEBTITLE
          APPEND    "Payer has Invoice raised, can NOT Delete. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER980  CLEAR     WEBTITLE
          APPEND    "Payer details still valid. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER990  CLEAR     WEBTITLE
          APPEND    "Payer Counter already exists. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PAYER999
.
PAYER999  RETURN
+
.------------------------------------------------------------
.         Check for overlap payer
.------------------------------------------------------------
COLP0000  PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,Z70
          CALL      RSPMPYR1
COLP1000  CALL      RPPMPYR1
          BRANCH    OVRCD,COLP9000
.
          MATCH     PMPYURNO,PMPYR001
          GOTO      COLP9000 IF NOT EQUAL    * different U/R
.
          MATCH     PMPYCLTY,PMPYR003
          GOTO      COLP9000 IF NOT EQUAL    * different payer
.
          MATCH     SP70,PMPYETDT
          GOTO      COLP9000 IF NOT EQUAL
          MOVE      ONE,EXIT
          GOTO      COLP9999
.
COLP9000  MOVE      ZERO,EXIT
COLP9999  RETURN
+
.----------------------------------------------------------------------------
.         Delete existing payer breakdown records for all visit of the U/R
.----------------------------------------------------------------------------
DBRK0000  PACK      KEY24,PMPYR001,SP70
          CALL      RSPTVIS2
DBRK1000  CALL      RKPTVIS2
          BRANCH    OVRCD,DBRK9999
.
          MATCH     PMPYR001,PVIURNO
          GOTO      DBRK9999 IF NOT EQUAL     * Different U/R
.
DBRK5000  PACK      KEY23,PVIBILL,PMPYR003,PMPYR018,SP70
          CALL      RSPMPBR3
          CALL      RKPMPBR3
          BRANCH    OVRCD,DBRK1000
.
          PACK      DIM19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     DIM19,KEY23
          GOTO      DBRK1000 IF NOT EQUAL
.
          PACK      KEY23,PMPBADMN,PMPBCLTY,PMPBEFDT,PMPBDEFT,PMPBICNT,SP70
          CALL      DEPMPBR3
          GOTO      DBRK5000
.
DBRK9999  RETURN
+
.-----------------------------------------------------------------
.     Delete existing invoice breakdown records for the U/R
.-----------------------------------------------------------------
DIDE0000  PACK      KEY24,PMPYR001,SP70
          CALL      RSPTVIS2
DIDE1000  CALL      RKPTVIS2
          BRANCH    OVRCD,DIDE9999
.
          MATCH     PMPYR001,PVIURNO
          GOTO      DIDE9999 IF NOT EQUAL     * Different U/R
.
DIDE6000  MOVE      SP70,PMIDINVN
          PACK      KEY25,PVIBILL,PMPYR003,PMIDINVN,SP70
          CALL      RSPMIDE1
          CALL      RKPMIDE1
          BRANCH    OVRCD,DIDE1000
.
          PACK      DIM19,PMIDADMN,PMIDCLTY,PMIDINVN,SP70
          MATCH     DIM19,KEY25
          GOTO      DIDE1000 IF NOT EQUAL
.
          PACK      KEY25,PMIDADMN,PMIDCLTY,PMIDINVN,PMIDTRNO,SP70
          CALL      DEPMIDE1
          GOTO      DIDE6000
.
DIDE9999  RETURN
+
.----------------------------------------------------------------
.     Delete existing invoice breakdown records for the admission
.----------------------------------------------------------------
DIDA0000  MOVE      SP70,PMIDINVN
          PACK      KEY25,PMIDINVN,ADMISSNO,SP70
          CALL      RSPMIDE5
          CALL      RKPMIDE5
          BRANCH    OVRCD,DIDA9999
.
          MATCH     SP70,PMIDINVN
          GOTO      DIDA9999 IF NOT EQUAL
          MATCH     ADMISSNO,PMIDADMN
          GOTO      DIDA9999 IF NOT EQUAL
.
          PACK      KEY25,PMIDINVN,PMIDADMN,PMIDCLTY,PMIDTRNO,SP70
          CALL      DEPMIDE5
          GOTO      DIDA0000
.
DIDA9999  RETURN
+
.------------------------------------------------------------
. Payer outputs
.------------------------------------------------------------
PTPY0000  BRANCH    FLDITMNO,PTPY0100,PTPY0200,PTPY0300,PTPY0400,PTPY0500:
                             PTPY0600,PTPY0700
          GOTO      PTPY9999
.
PTPY0100  CALL      LPYR0000      * List of patient/admission payers
          GOTO      PTPY9999
.
PTPY0200  WRITE     HTMLFILE;PMREREGM;
          GOTO      PTPY9999
.
PTPY0300  MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
          WRITE     HTMLFILE;PACFNAME;
          GOTO      PTPY9999
.
PTPY0400  CALL      PYBR0000                * Payers breakdown
          GOTO      PTPY9999
.
PTPY0500  PACK      KEY3,PMPBCNTR,SP70
          MATCH     SP70,PMPBCNTR
          GOTO      PTPY0580 IF NOT EQUAL
.
          MOVE      "  0",PMPBICNT
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,PMPBICNT,SP70  * save key
.
          CALL      CCNTR000               * Check if Counter has been allocated
          BRANCH    EXIT,PTPY0520          * yes
          MOVE      "  1",KEY3             * Default Counter to 1
.
PTPY0520  CALL      RDPMPBR1               * reposition
.
PTPY0580  WRITE     HTMLFILE;KEY3;
          GOTO      PTPY9999
.
PTPY0600  CALL      LPBR0000                * List of Admission payers
          GOTO      PTPY9999
.
PTPY0700  WRITE     HTMLFILE;PTRGM001;
          GOTO      PTPY9999
.
PTPY9999  RETURN
+
.------------------------------------------------------------
.         Check if Payer counter had been allocated at all
.------------------------------------------------------------
CCNTR000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,CCNTR900
.
          PACK      KEY26,ADMISSNO,PMPBICNT,SP70
          CALL      RSPMPBR4
CCNTR100  CALL      RKPMPBR4
          BRANCH    OVRCD,CCNTR900
.
          MATCH     ADMISSNO,PMPBADMN         * Same visit number
          GOTO      CCNTR900 IF NOT EQUAL
          MATCH     "  0",PMPBICNT
          GOTO      CCNTR900 IF NOT EQUAL
.
          MATCH     SP70,PMPBCNTR
          GOTO      CCNTR100 IF EQUAL
.
          MOVE      ONE,EXIT                 * found counter had been allocated
          GOTO      CCNTR999
.
CCNTR900  MOVE      ZERO,EXIT
CCNTR999  RETURN
+
.------------------------------------------------------------
. List of Patient Payers
.------------------------------------------------------------
LPYR0000  
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA2,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY19,PMPYR001,SP70
          CALL      RSPMPYR2
LPYR1000  CALL      RKPMPYR2
          BRANCH    OVRCD,LPYR9999
.
          MATCH     PMPYR001,PMPYURNO
          GOTO      LPYR9999 IF NOT EQUAL
.
          PACK      PACFNAME,SP70,SP70
          MATCH     SP70,PMPYSNAM
          GOTO      LPYR5000 IF NOT EQUAL
          MATCH     SP70,PMPYGNAM
          GOTO      LPYR5000 IF NOT EQUAL
          MATCH     SP70,PMPYTITL
          GOTO      LPYR6000 IF EQUAL
.
LPYR5000  MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
.
LPYR6000  MOVE      SP70,TDESC
          MATCH     SP70,PMPYCLTY
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PMPYCLTY
            CALL      RDCODE1
          ENDIF
.
          MOVE      "No ",KEY3
          MATCH     "1",PMPYDEFT
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
.
          MOVE      SP70,KEY12
          MATCH     SP20,PMPYEFDT
          IF        !@EQUAL
            UNPACK    PMPYEFDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateLink('",HTMLLINK
          APPEND    PMPYURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPYCLTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY12,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",PACFNAME,"#",":              *1
                                      "#"",PMPYADD1,PMPYADD2:
                                           PMPYADD3,PMPYADD4:
                                           PMPYPOST,"#",":              *2
                                      "#"",PMPYRELP,"#",":              *3
                                      "#"",PMPYTELP,"#",":              *4
                                      "#"",PMPYTELM,"#",":              *5
                                      "#"",TDESC,"#",":                 *6
                                      "#"",KEY3,"#",":                  *7
                                      "#"",PMPYEFDT,"#",":              *8
                                      "#"",PMPYETDT,"#");"              *9
          GOTO      LPYR1000
.
LPYR9999 RETURN
+
.------------------------------------------------------------
.         List of Admission payers
.------------------------------------------------------------
LPBR0000
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPYRA2,"pmspyraf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA4,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,LPYR9999
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,LPYR9999
.
          CALL      APBR0000      *  Add records to pmspbraf if not exist
.
.         Listing of admission payers only the accommodation record
.
LPBR4000  MOVE      "  0",PMPBICNT
          PACK      KEY26,ADMISSNO,PMPBICNT,SP70
          CALL      RSPMPBR4
LPBR5000  CALL      RKPMPBR4
          BRANCH    OVRCD,LPBR9999
.
          MATCH     ADMISSNO,PMPBADMN
          GOTO      LPBR9999 IF NOT EQUAL
.
          MATCH     "  0",PMPBICNT
          GOTO      LPBR9999 IF NOT EQUAL       * Not accommodation record
.
          PACK      KEY19,URNUMBER,PMPBCLTY,PMPBEFDT,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,LPBR5000
.
          PACK      PACFNAME,SP70,SP70
          MATCH     SP70,PMPYSNAM
          GOTO      LPBR5200 IF NOT EQUAL
          MATCH     SP70,PMPYGNAM
          GOTO      LPBR5200 IF NOT EQUAL
          MATCH     SP70,PMPYTITL
          GOTO      LPBR6000 IF EQUAL
.
LPBR5200  MOVE      PMPYSNAM,PACSNAME
          MOVE      PMPYGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPYTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
.
LPBR6000  MOVE      SP70,TDESC
          MATCH     SP70,PMPYCLTY
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PMPYCLTY
            CALL      RDCODE1
          ENDIF
.
          MOVE      "1",FORM1        *  to display SelectLink.gift
          MOVE      "No ",KEY3
          MATCH     "1",PMPYDEFT
          IF        @EQUAL
            MOVE      "Yes",KEY3
            MOVE      "0",FORM1      * Not to display 
          ENDIF
.
          MOVE      SP70,KEY12
          MATCH     SP20,PMPYEFDT
          IF        !@EQUAL
            UNPACK    PMPYEFDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateLink('",HTMLLINK
          APPEND    PMPYURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPYCLTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    KEY12,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMPYDEFT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MATCH     "1",PMPBDEFT
          IF        @EQUAL
            MOVE      SP70,PMPBCNTR
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",PACFNAME,"#",":              *1
                                      "#"",PMPYADD1,PMPYADD2:
                                           PMPYADD3,PMPYADD4:
                                           PMPYPOST,"#",":              *2
                                      "#"",PMPYRELP,"#",":              *3
                                      "#"",PMPYTELP,"#",":              *4
                                      "#"",PMPYTELM,"#",":              *5
                                      "#"",TDESC,"#",":                 *6
                                      "#"",KEY3,"#",":                  *7
                                      "#"",PMPYEFDT,"#",":              *8
                                      "#"",PMPYETDT,"#",":              *9
                                      "#"",PMPBCNTR,"#",":              *10
                                      "#"",FORM1,"#");"                 *11
          GOTO      LPBR5000
.
LPBR9999  RETURN
+
.------------------------------------------------------------
.         Add payers for the admission
.------------------------------------------------------------
APBR0000  MOVE      ZERO,DEFPFLAG          * Default payer flag
          PACK      KEY19,PMPYR001,SP70
          CALL      RSPMPYR2
APBR1000  CALL      RKPMPYR2
          BRANCH    OVRCD,APBR9999
.
          MATCH     PMPYR001,PMPYURNO
          GOTO      APBR9999 IF NOT EQUAL
.
.         Payers with effective for the Visit
.
          MATCH     PMPYEFDT,ALACDTE
          GOTO      APBR1000 IF LESS
.
          MATCH     SP70,PMPYETDT                * check Effective to date
          IF        !@EQUAL
            MATCH     ALACDTE,PMPYETDT
            GOTO      APBR1000 IF LESS
          ENDIF
.
.         if Payer claim type equals to Patient Claim type, the it must be a
.         Default payer
.
          MATCH     ACLAIM,PMPYCLTY
          IF        @EQUAL
            MATCH     "1",PMPYDEFT
            GOTO      APBR1000 IF NOT EQUAL      * Not a default payer
          ENDIF
.
          MATCH     "1",PMPYDEFT
          IF        @EQUAL
            BRANCH    DEFPFLAG,APBR1000          * Default payer exists already
            MOVE      ONE,DEFPFLAG
          ENDIF
.
.         Check if breakdown exist for the payer
.
          MOVE      "  0",PMPBICNT
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,PMPBICNT,SP70
          CALL      RDPMPBR1
          COMPARE   ZERO,OVRCD
          GOTO      APBR4000 IF EQUAL
.
          CALL      CLPMSPBR
          UNPACK    KEY22,PMPBADMN,PMPBCLTY,PMPBEFDT,PMPBICNT
          MOVE      "ACCOMCHRG",PMPBITEM
          MOVE      PMPYDEFT,PMPBDEFT
          MOVE      PMPYETDT,PMPBETDT      * Effective to Date
          MOVE      PTRGM001,PMPBREGM
          MOVE      ZERO,PMPBMAXB
          MOVE      ZERO,PMPBMAXD
          MOVE      WBSEUID,PMPBCUID
          CALL      IBACLOCK
          PACK      PMPBCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMPBCDAT
          MOVE      CTIMEIS,PMPBCTIM
.
          CALL      WRPMPBR1
.
APBR4000  PACK      KEY13,PTRGM001,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,APBR1000        * next payer
.
.         Loop through all Misc.charges of the Regime
.
APBR6000  CALL      RKPMREG1
          BRANCH    OVRCD,APBR1000
.
          MATCH     PMREREGM,PTRGM001      * Same regiem ?
          GOTO      APBR1000 IF NOT EQUAL
.
          MATCH     "1",PMREITYP
          GOTO      APBR6000 IF NOT EQUAL  * Not Misc.item
          MATCH     "0",PMREACTV
          GOTO      APBR6000 IF NOT EQUAL  * Not active
.
          CALL      CIBR0000               * Check if item exist
          BRANCH    EXIT,APBR6000
.
          CALL      CLPMSPBR
.
          MOVE      ADMISSNO,PMPBADMN
          MOVE      PMPYCLTY,PMPBCLTY
          MOVE      PMPYEFDT,PMPBEFDT
.
          MOVE      FORM3,PMPBICNT         * Item Count
          MOVE      PMREITMN,PMPBITEM      * Item code
          MOVE      PMPYDEFT,PMPBDEFT
          MOVE      PMPYETDT,PMPBETDT      * Effective to Date
          MOVE      PTRGM001,PMPBREGM
          MOVE      ZERO,PMPBMAXB
          MOVE      ZERO,PMPBMAXD
          MOVE      WBSEUID,PMPBCUID
.
          CALL      WRPMPBR1
          GOTO      APBR6000
.
APBR9999  RETURN
+
.------------------------------------------------------------
.         Check if item in the Payer breakdown already
.------------------------------------------------------------
CIBR0000  MOVE      ZERO,EXIT
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,SP70
          CALL      RSPMPBR1
CIBR1000  CALL      RKPMPBR1
          BRANCH    OVRCD,CIBR2000
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      CIBR2000 IF NOT EQUAL
          MATCH     "  0",PMPBICNT
          GOTO      CIBR1000 IF EQUAL      * Accommodation record
.
          MATCH     PMREITMN,PMPBITEM
          GOTO      CIBR1000 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CIBR9999
.
CIBR2000  MOVE      ZERO,FORM3
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,Z70
          CALL      RSPMPBR1
          CALL      RPPMPBR1
          BRANCH    OVRCD,CIBR8000
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      CIBR8000 IF NOT EQUAL
          MOVE      PMPBICNT,FORM3
.
CIBR8000  ADD       ONE,FORM3
          MOVE      ZERO,EXIT
CIBR9999  RETURN
+
.------------------------------------------------------------
.         Payers breakdown
.------------------------------------------------------------
PYBR0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA1,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          MOVE      ZERO,FORM3
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,TOTALCHR
.
          PACK      KEY22,ADMISSNO,PMPYR003,PMPYR018,SP70
          CALL      RSPMPBR1
PYBR1000  CALL      RKPMPBR1
          BRANCH    OVRCD,PYBR4000
.
.         Display exisiting breakdown
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      PYBR4000 IF NOT EQUAL
.
          ADD       ONE,FORM3
          MOVE      PMPBREGM,RGMCD[FORM3]
          MOVE      PMPBITEM,ITMCD[FORM3]
          MOVE      PMPBMAXB,MXBIL[FORM3]
          MOVE      PMPBMAXD,MXDAY[FORM3]
          GOTO      PYBR1000
.
PYBR4000  COMPARE   ZERO,FORM3
          GOTO      PYBR80000 IF EQUAL
.
          MOVE      FORM3,CNTITEM
          MOVE      ZERO,FORM3
.
          WHILE     FORM3<CNTITEM
            MOVE      "Invalid Item",PMREDESC
            IF        FORM3=0
              MOVE      "Accommodation",PMREDESC
              ADD       ONE,FORM3
            ELSE
              ADD       ONE,FORM3
              CALL      ITMD0000            * Get Item description
            ENDIF
            MOVE      SP70,KEY16
            CALL      CCPY0000              * Get current payer
.
            MOVE      FORM3,KEY3
            REP       " 0",KEY3
            MOVE      MXBIL[FORM3],PMPBMAXB
            MOVE      MXDAY[FORM3],PMPBMAXD
            MOVE      ITMCD[FORM3],PMPBITEM
            ADD       PMPBMAXB,FORM12P2
            ADD       PMPBMAXD,TOTALCHR
            CALL      PROW0000                * display row of breakdown
          DO
          CALL      DTOT0000                  * display totals
.
          GOTO      PYBR9999
.
PYBR8000  CALL      NEWR0000                  * inserting record
PYBR9999  RETURN
+
.------------------------------------------------------------
.         Get Item description
.------------------------------------------------------------
ITMD0000  MOVE      "1",PMREITYP
          PACK      PMREITMN,ITMCD[FORM3],SP70
          PACK      KEY24,RGMCD[FORM3],PMREITMN,PMREITYP,SP70
          CALL      RSPMREG4
          CALL      RKPMREG4
          BRANCH    OVRCD,ITMD4000
.
          PACK      KEY21,PMREREGM,PMREITMN,PMREITYP,SP70
          MATCH     KEY21,KEY24
          GOTO      ITMD9999 IF EQUAL
.
.         Item might have been removed from Regime file, try Misc.item file
.
ITMD4000  IF            IBCNMHOS=1
            OPEN          PMSVX1A1,"pmsvx1af"
            OPEN          PATHSPA1,"pathspaf"
.
            MOVE          SP10,PMVXMHOS
            MOVE          ADMISSNO,KEY8
            CALL          RDMISS1
            CALL          RDPMVX11
            MOVE          PMVXMHOS,KEY3
            CALL          RDPTHSP1
            IF            OVRCD=0
              MOVE          PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
.
.
          PACK      KEY29,ITMCD[FORM3],ACLAIM,SP6,SP3,Z70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD6000
.
          PACK      KEY21,MCHARGE,MCLMCOD,SP70
          MATCH     KEY21,KEY29
          GOTO      ITMD8000 IF EQUAL
.
ITMD6000  PACK      KEY29,ITMCD[FORM3],PTCNDCLM,SP6,SP3,Z70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD6200
.
          PACK      KEY21,MCHARGE,MCLMCOD,SP70
          MATCH     KEY21,KEY29
          GOTO      ITMD8000 IF EQUAL
.
ITMD6200  PACK      KEY21,ITMCD[FORM3],SP70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,ITMD9999
.
          MATCH     ITMCD[FORM3],MCHARGE
          GOTO      ITMD9999 IF NOT EQUAL
.
ITMD8000  MOVE      MDESC,PMREDESC
ITMD9999  RETURN
+
.------------------------------------------------------------
.         Display existing Breakdown row
.------------------------------------------------------------
PROW0000  BRANCH    FORM3,PROW4000           * Accom. always available
.
          UNPACK    KEY16,PMPBCLTY
          MATCH     SP70,PMPBCLTY
          GOTO      PROW4000 IF EQUAL
.
          MATCH     PMPBCLTY,PMPYR003
          GOTO      PROW4000 IF EQUAL        * Same payer
.
          WRITE     HTMLFILE;"<input type=hidden name=itmcd",KEY3:
                             " value='",PMPBITEM,"'>":
                             "<tr>":
                             "<td width=20%>",PMREDESC,"</td>":
                             "<td width=20% align=left>":
                             "<input type=text name=mxbil",KEY3:
                             " class='Readonly Number' readonly":
                             " value='",PMPBMAXB,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Billing Period' ":
                             " id=mxbil",KEY3:
                         " onchange='TotalsMax(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td width=20%>&nbsp;",KEY16,"</td>";
.
          WRITE     HTMLFILE;"<td width=20%>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxday",KEY3:
                             " class='Readonly Number' readonly":
                             " value='",PMPBMAXD,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Day Amount' ":
                             " id=mxday",KEY3:
                         " onchange='TotalsDay(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td></tr>";

.
          GOTO      PROW9999
.
PROW4000
          WRITE     HTMLFILE;"<input type=hidden name=itmcd",KEY3:
                             " value='",PMPBITEM,"'>":
                             "<tr>":
                             "<td width=20%>",PMREDESC,"</td>":
                             "<td width=20% align=left>":
                             "<input type=text name=mxbil",KEY3," class=Number":
                             " value='",PMPBMAXB,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Billing Period' ":
                             " id=mxbil",KEY3:
                         " onchange='TotalsMax(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td width=20%>&nbsp;",KEY16,"</td>";
.
          WRITE     HTMLFILE;"<td width=20%>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxday",KEY3," class=Number":
                             " value='",PMPBMAXD,"'":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Day Amount' ":
                             " id=mxday",KEY3:
                         " onchange='TotalsDay(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td></tr>";
PROW9999  RETURN
+
.------------------------------------------------------------
.         Check for Current Payer
.------------------------------------------------------------
CCPY0000
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSPBRA2,"pmspbraf"
          TRAPCLR   IO
          BRANCH    OVRCD,PYBR9999
.
          MOVE      SP70,KEY16
          PACK      KEY31,ADMISSNO,ITMCD[FORM3],SP70
          CALL      RSPMPBR2
CCPY1000  CALL      RKPMPBR2
          BRANCH    OVRCD,CCPY8000
.
          PACK      KEY17,PMPBADMN,PMPBITEM,SP70
          MATCH     KEY17,KEY31
          GOTO      CCPY8000 IF NOT EQUAL
.
          COMPARE   ZERO,PMPBMAXB
          GOTO      CCPY1000 IF EQUAL        * No maximum billing period
.
          IF        FORM3=1
            MATCH     SP70,KEY16
            IF        !@EQUAL
              APPEND    ",",KEY16
            ELSE
              CLEAR     KEY16
            ENDIF
            APPEND    PMPBCLTY,KEY16         * Accomm.can have multiple payers
            GOTO      CCPY1000
          ENDIF
.
          PACK      KEY16,PMPBCLTY,SP70      * Item only has one payer
          GOTO      CCPY9999
.
CCPY8000  APPEND    SP70,KEY16
          RESET     KEY16
          IF        FORM3=1
            MOVE      "ACCOMCHRG",PMPBITEM   * restore Accomm. item
          ENDIF
CCPY9999  RETURN
+
.------------------------------------------------------------
.         Insert payers breakdown
.------------------------------------------------------------
NEWR0000  MOVE      ZERO,FORM3
          MOVE      ZERO,FORM12P2
          MOVE      ZERO,TOTALCHR
.
          PACK      KEY20,ADMISSNO,PTRGM001,SP70
          CALL      RSPTRGM2
          CALL      RKPTRGM2
          BRANCH    OVRCD,NEWR9999
.
          MATCH     ADMISSNO,PTRGADMN
          GOTO      NEWR9999 IF NOT EQUAL
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,NEWR9999
.
.         First breakdown must be Accommodation
.
          MOVE      "Accommodation",PMREDESC
          CALL      BROW0000                      * Display row
.
.        Get the breakdown from Regime file
.
NEWR4000  CALL      RKPMREG1
          BRANCH    OVRCD,NEWR9000
.
          MATCH     PMREREGM,PTRGREGM             * same regime code
          GOTO      NEWR9000 IF NOT EQUAL
.
          MATCH     "1",PMREITYP
          GOTO      NEWR9000 IF NOT EQUAL         * Not a Misc.charge code
          MATCH     "0",PMREACTV
          GOTO      NEWR9000 IF NOT EQUAL         * Not active
.
          CALL      BROW0000                      * Display row
.
          MOVE      ZERO,F1
          GOTO      NEWR4000
.
NEWR9000  COMPARE   ZERO,FORM3
          GOTO      NEWR9999 IF EQUAL             * no record found
.
          CALL      DTOT0000                      * display totals
.
NEWR9999  RETURN
+
.------------------------------------------------------------
.         Display totals
.------------------------------------------------------------
DTOT0000  WRITE     HTMLFILE;"<tr><td>Total</td>":
                             "<td><Input type=text ":
                             "class='Readonly JustifyRight Number' ":
                             "name=totalmax size=10 maxlength=10":
                             " value='",FORM12P2,"'":
                             " readonly tabindex=-1></td>":
                             "<td>&nbsp;</td>":
                             "<td>Total</td>":
                             "<td><Input type=text ":
                             "class='Readonly JustifyRight Number' ":
                             "name=totalpday size=10 maxlength=10":
                             " value='",TOTALCHR,"'":
                             " readonly tabindex=-1></td></tr>";
.
DTOT9999  RETURN
+
.------------------------------------------------------------
.         Display Breakdown row
.------------------------------------------------------------
BROW0000  ADD       ONE,FORM3
          MOVE      FORM3,KEY3
          REP       " 0",KEY3
          WRITE     HTMLFILE;"<tr>":
                             "<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxbil",KEY3," class=Number":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Billing Period' ":
                             " id=mxbil",KEY3:
                          " onchange='TotalsMax(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td>",PMREDESC,"</td>":
                             "<td align=left>":
                             "<input type=text name=mxday",KEY3," class=Number":
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                             " title= 'Maximum Per Day Amount' ":
                             " id=mxday",KEY3:
                          " onchange='TotalsDay(UpdateForm,mxbil",KEY3,",mxday",KEY3,")'>":
                             "</td></tr>";
BROW9999  RETURN
+
.------------------------------------------------------------
.         Add/Update items of the regime 
.------------------------------------------------------------
WPYR0000  MOVE      ZERO,EXIT
          PACK      KEY19,PMPYR001,PMPYR003,PMPYR018,SP70
          CALL      RDPMPYR1
          BRANCH    OVRCD,WPYR9999
.
          PACK      KEY13,PTRGM001,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,WPYR9999
.
          CALL      VPYR0000                     * Validate payer breakdown
          BRANCH    EXIT,WPYR9999
.
          CALL      VCTR0000                     * Validate payer Counter
          IF        EXIT=1
            MOVE      TWO,EXIT                   * payer counter exists
            GOTO      WPYR9999
          ENDIF
.
          MOVE      ZERO,FORM3
          PACK      KEY22,ADMISSNO,PMPYCLTY,PMPYEFDT,SP70
          CALL      RSPMPBR1
WPYR1000  CALL      RKPMPBR1
          BRANCH    OVRCD,WPYR9000
.
          PACK      KEY19,PMPBADMN,PMPBCLTY,PMPBEFDT,SP70
          MATCH     KEY19,KEY22
          GOTO      WPYR9000 IF NOT EQUAL
.
          ADD       ONE,FORM3
          MOVE      MXBIL[FORM3],PMPBMAXB
          MOVE      MXDAY[FORM3],PMPBMAXD
          MOVE      PMPBR001,PMPBCNTR
          CALL      UPPMPBR1
.
          GOTO      WPYR1000
.
WPYR9000  MOVE      ZERO,EXIT
          GOTO      WPYR9999
.
WPYR9999  RETURN
+
.------------------------------------------------------------
.         Only accommodation or one item for each payer
.------------------------------------------------------------
VPYR0000  MOVE      ZERO,FORM3
          MOVE      ZERO,F1
.
VPYR1000  COMPARE   "99",FORM3
          GOTO      VPYR8000 IF NOT LESS
.
          ADD       ONE,FORM3
          COMPARE   ZERO,MXBIL[FORM3]
          GOTO      VPYR1000 IF EQUAL
.
          BRANCH    F1,VPYR9000
          MOVE      ONE,F1
.
          GOTO      VPYR1000
.
VPYR8000  MOVE      ZERO,EXIT
          GOTO      VPYR9999

VPYR9000  MOVE      ONE,EXIT
VPYR9999  RETURN
+
.------------------------------------------------------------
.         Validate Payer counter
.------------------------------------------------------------
VCTR0000  MOVE      "  0",PMPBICNT
          PACK      KEY26,ADMISSNO,PMPBICNT,SP70
          CALL      RSPMPBR4
VCTR1000  CALL      RKPMPBR4
          BRANCH    OVRCD,VCTR9000
.
          MATCH     ADMISSNO,PMPBADMN         * Same visit number
          GOTO      VCTR9000 IF NOT EQUAL
.
          MATCH     "  0",PMPBICNT
          GOTO      VCTR9000 IF NOT EQUAL
          MATCH     PMPBCLTY,PMPYCLTY
          GOTO      VCTR1000 IF EQUAL
.
          MATCH     PMPBR001,PMPBCNTR
          GOTO      VCTR1000 IF NOT EQUAL
.
          MOVE      ONE,EXIT                  * payer counter already exist
          GOTO      VCTR9999
.
VCTR9000  MOVE      ZERO,EXIT
VCTR9999  RETURN
+
.------------------------------------------------------------
. Patient Attributes
.------------------------------------------------------------
ATTRIB00  COMPARE   ONE,NOATTRIB
          GOTO      ATTRIB91 IF EQUAL
.
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      ATTRIB50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      ATTRIB10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      ATTRIB20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      ATTRIB30 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote formaction
          GOTO      ATTRIB40 IF EQUAL
.
          GOTO      ATTRIB90
.
.         ************ ADD FORMACTION ***********
.
ATTRIB10  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          COMPARE   ZERO,OVRCD
          GOTO      ATTRIB94 IF EQUAL
.
          CALL      CLPATATR
          CALL      MVPATATR
.
          CALL      CLCBMI00
          PACK      PTARVAL3,BODMASIN,SP70
.
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      WRPTATR1
.
          PACK      KEY8,PTATR001,SP70           
          CALL      RDPMPX21
          IF        OVRCD=0
            MOVE      PTATR006,PMPXPHEI
            MOVE      PTATR007,PMPXPWEI
            CALL      UPPMPX21
          ENDIF
.
          PACK      KEY8,PTATR002,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PTATR006,PMVXPHGT
            MOVE      PTATR007,PMVXPWGT
            CALL      IBACLOCK
            PACK      PMVXDHWR,CCC,CYY,CMM,CDD
            REP       " 0",PMVXDHWR
            CALL      UPPMVX11
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ATTRIB99
.
.         ************ UPDATE FORMACTION **********
.
ATTRIB20  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,ATTRIB95 
.
          CALL      MVPATATR
.
          CALL      CLCBMI00
          PACK      PTARVAL3,BODMASIN,SP70
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR1
.
          PACK      KEY8,PTATR001,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
            MOVE      PTATR006,PMPXPHEI
            MOVE      PTATR007,PMPXPWEI
            CALL      UPPMPX21
          ENDIF
.
          PACK      KEY8,PTATR002,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PTATR006,PMVXPHGT
            MOVE      PTATR007,PMVXPWGT
            CALL      IBACLOCK
            PACK      PMVXDHWR,CCC,CYY,CMM,CDD
            REP       " 0",PMVXDHWR
            CALL      UPPMVX11
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ATTRIB99
.
.         ************ DELETE FORMACTION **********
.
ATTRIB30  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,ATTRIB95
.
          MATCH     "1",PTATR018                     * Validate if strikethrough
          IF        @EQUAL
            CALL      MVPATATR
.
            CALL      CLCBMI00
            PACK      PTARVAL3,BODMASIN,SP70
.
            CALL      IBACLOCK
            PACK      PTARUDTE,CCC,CYY,CMM,CDD
            REP       " 0",PTARUDTE
            CLOCK     TIME,PTARUTME
            MOVE      USERID,PTARUUSR
.
            CALL      UPPTATR1 
          ELSE
            CALL      DEPTATR1 
          ENDIF
.
          MOVE      ZERO,EXIT
.
          PACK      KEY35,PTATR001,Z70
          CALL      RSPTATR1
          CALL      RPPTATR1
          IF        OVRCD=1
            MOVE      SP70,PMPXPHEI
            MOVE      SP70,PMPXPWEI
            GOTO      ATTRIB31
          ENDIF
.
          MATCH     PTATR001,PTARURNO
          IF        !@EQUAL
            MOVE      SP70,PMPXPHEI
            MOVE      SP70,PMPXPWEI
            GOTO      ATTRIB31
          ENDIF
.
ATTRIB31  PACK      KEY8,PTATR001,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,ATTRIB99
.
          SQUEEZE   PTARVAL1
          SQUEEZE   PTARVAL2
          MOVE      PTARVAL1,PMPXPHEI
          MOVE      PTARVAL2,PMPXPWEI
.
          CALL      UPPMPX21
          GOTO      ATTRIB99
.
.         ************ REMOTE FORMACTION **********
.
ATTRIB40  CALL      REMOTE00        * Remote Script for bmi
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
.        ************ Display FORMACTION **********
.
ATTRIB50  MATCH     SP70,URNUMBER
          GOTO      ATTRIB92 IF EQUAL
          GOTO      ATTRIB92 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      ATTRIB93 IF EQUAL
.         GOTO      ATTRIB93 IF EOS
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ATTRIB92
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70     * Read admission file
          CALL      RDPTMIS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Attributes Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ATTRIB99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB91  MOVE      "Patient Attributes System Not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB92  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB93  MOVE      "Invalid Visit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB94  MOVE      "Patient Attributes Records Exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB95  MOVE      "Invalid Patient Attributes Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRIB99
.
ATTRIB99  RETURN
.
.------------------------------------------------------------
. Patient Attributes
.------------------------------------------------------------
ATTRID00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      ATTRID50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      ATTRID10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      ATTRID20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      ATTRID30 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote formaction
          GOTO      ATTRID40 IF EQUAL
.
          GOTO      ATTRID90
.
.         ************ ADD FORMACTION ***********
.
ATTRID10  PACK      KEY35,PTATR001,PTATR002,PTATR003,PTATR004,PTATR005,SP70
          CALL      RDPTATR2
          COMPARE   ZERO,OVRCD
          GOTO      ATTRID94 IF EQUAL
.
          CALL      CLPATATR
          CALL      MVPATATR
.
          MOVE      "0",PTARDELR
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTATR001,PTATR002,PTATR003,PTATR004,PTATR005,SP70
          CALL      WRPTATR2
.
. Write Edward details
.
          MOVE      ZERO,EXIT
          GOTO      ATTRID99
.
.         ************ UPDATE FORMACTION **********
.
ATTRID20  PACK      KEY35,PTATR001,PTATR002,PTATR003,PTATR004,PTATR005,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,ATTRID95
.
          PACK      PTARCOD1,PTATR009,SP70
          PACK      PTARTXT1,PTATR014,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR2
.
          MOVE      ZERO,EXIT
          GOTO      ATTRID99
.
.         ************ DELETE FORMACTION **********
.
ATTRID30  PACK      KEY35,PTATR001,PTATR002,PTATR003,PTATR004,PTATR005,SP70 
          CALL      RDPTATR2
          BRANCH    OVRCD,ATTRID95
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          MOVE      "1",PTARDELR
.
          CALL      UPPTATR2
.
. Write Edward details
.
          MOVE      ZERO,EXIT
          GOTO      ATTRID99
.
.         ************ REMOTE FORMACTION **********
.
ATTRID40  CALL      REMOTE00        * Remote Script for bmi
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
.        ************ Display FORMACTION **********
.
ATTRID50  MATCH     SP70,URNUMBER
          GOTO      ATTRID92 IF EQUAL
          GOTO      ATTRID92 IF EOS
.
          MATCH     SP70,ADMISSNO
          GOTO      ATTRID93 IF EQUAL
          GOTO      ATTRID93 IF EOS
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,ATTRID92
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70     * Read admission file
          CALL      RDPTMIS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY35,PTATR001,PTATR002,PTATR003,PTATR004,PTATR005,SP70 
          CALL      RDPTATR2
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Expected Discharge Date Changed Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ATTRID99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID91  MOVE      "Patient Attributes System Not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID92  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID93  MOVE      "Invalid Visit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID94  MOVE      "Patient Attributes Records Exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID95  MOVE      "Invalid Patient Attributes Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ATTRID99
.
ATTRID99  RETURN
.
.------------------------------------------------------------
. List Attributes
.------------------------------------------------------------
LSTATT00  COMPARE   ONE,NOATTRIB
          GOTO      LSTATT99 IF EQUAL
.
          MOVE      SP70,LINKPRG
          MOVE      SP70,LINKREP
          MOVE      SP70,LINKTEM
.   
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
LSTATT10  CALL      RPPTATR1
          BRANCH    OVRCD,LSTATT99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LSTATT99 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      LSTATT99 IF NOT EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      LSTATT10 IF NOT EQUAL
.
          MOVE      SP70,INPUTBYU
          MOVE      SP70,DELETBYU
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,INPUTBYU
          ENDIF
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
          MATCH     SP70,PTARUUSR
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARUUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,DELETBYU
          ENDIF
          ENDIF
.
          MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
LSTATT80  MATCH     "1",PTARDELR
          GOTO      LSTATT90 IF EQUAL
.
          MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap>":
                               DISPDATE," ",PTARTIME,"</td>":
                               "<td>",INPUTBYU,"</td>":
                               "<td>",PTARVAL1,"</td>":
                               "<td>",PTARVAL2,"</td>":
                               "<td>",BODMASRN,"</td>":
                               "<td>",PTARVISN,"&nbsp;</td>":
                               "<td>",DELETBYU,"&nbsp;</td>";
            WRITE     HTMLFILE;"</tr>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDATE:
                               "&ptatr004=",PTARTIME,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDATE," ",PTARTIME,"</td>":
                               "<td>",INPUTBYU,"</td>":
                               "<td>",PTARVAL1,"</td>":
                               "<td>",PTARVAL2,"</td>":
                               "<td>",BODMASRN,"</td>":
                               "<td>",PTARVISN,"&nbsp;</td>":
                               "<td>",DELETBYU,"&nbsp;</td>";
            WRITE     HTMLFILE;"</tr>";
          ENDIF
.
          GOTO      LSTATT10
.
LSTATT90  MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike>":
                               DISPDATE," ",PTARTIME,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",PTARVAL1,"</strike></td>":
                               "<td><strike>",PTARVAL2,"</strike></td>":
                               "<td><strike>",BODMASRN,"</strike></td>":
                               "<td><strike>",PTARVISN,"&nbsp;</strike></td>":
                               "<td><strike>",DELETBYU,"&nbsp;<strike></td>";
            WRITE     HTMLFILE;"</tr>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDATE:
                               "&ptatr004=",PTARTIME,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDATE," ",PTARTIME,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",PTARVAL1,"</strike></td>":
                               "<td><strike>",PTARVAL2,"</strike></td>":
                               "<td><strike>",BODMASRN,"</strike></td>":
                               "<td><strike>",PTARVISN,"&nbsp;</strike></td>":
                               "<td><strike>",DELETBYU,"&nbsp;<strike></td>";
            WRITE     HTMLFILE;"</tr>";
          ENDIF
.
          GOTO      LSTATT10
.
LSTATT99  RETURN
.
.-----------------------------------------------------------
. Get BMI Remote Script
.-----------------------------------------------------------
GETBMI00  MOVE      PTATR006,PTARVAL1
          MOVE      PTATR007,PTARVAL2
          CALL      CLCBMI00
          CALL      RNGBMI00
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    BODMASRN:
                    "</RETURN_VALUE>"
          GOTO      GETD9999
.
GETBMI99  RETURN
.
.-----------------------------------------------------------
.        Get Patient Attributes
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          COMPARE   ONE,NOATTRIB
          GOTO      PATATR99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR99 IF EQUAL
          GOTO      PATATR99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PATATR99 IF EQUAL
.         GOTO      PATATR99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PATATR10  CALL      RPPTATR1
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PATATR10 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.------------------------------------------------------------
. Display Error Message, Refresh Parent and Close Window
.------------------------------------------------------------
WINCLE00  CALL      OPENHTML
          BRANCH    EXIT,WINCLE99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">  ":
                             "  alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             " reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCLE99  RETURN
.
.------------------------------------------------------------
. Find the next patient in the ward
.------------------------------------------------------------
NXTPAT00  
.         MATCH     "1",NEXTPATF            * HPS Code Starts Here
.         IF        @EQUAL
.           CALL      NXTEVT00
.           BRANCH    EXIT,NXTPAT90
.           GOTO      NXTPAT85
.         ENDIF                             * HPS Code Ends Here
.
.         V9.02.18 - change this code to be consistent with the way ward/bed
.                    displays.  ie. NoBeds first, then WardBeds, then On leave
.                    So first see if current patient is in no bed file.
.
          MOVE      SP70,SAVEWARD
NXTPAT10  PACK      KEY13,ADMISSNO,SP70         * Set admission as key
          CALL      RDSNOBE3                    * Position on file
          CALL      RDKNOBE3                    * Get next record
          BRANCH    OVRCD,NXTPAT20              * If EOF, go to Ward file
          MATCH     ADMISSNO,DNBADMNO           * Check patient admission no.
          GOTO      NXTPAT20 IF NOT EQUAL       * No, try the ward file.
.
          PACK      KEY13,NBWARD,DNBADMNO,DNBPLUR
          CALL      RDSNOBE1                    * Get patient on Index 1
.
NXTPAT15  CALL      RDKNOBE1                    * Get next patient
          BRANCH    OVRCD,NXTPAT19              * - no more no bed recs
          MATCH     AWARD,NBWARD                * - still correct ward ?
          GOTO      NXTPAT19 IF NOT EQUAL
          MATCH     ZEROVISN,NBADMNO            * - non-zero admission ?
          GOTO      NXTPAT15 IF EQUAL
          MOVE      NBADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT19  PACK      KEY6,AWARD,SP70             * Set key to start of ward
          CALL      RDSWARD1                    * position on file
          MOVE      AWARD,SAVEWARD
          GOTO      NXTPAT35                    * go get first rec this ward
.
NXTPAT20  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward file
          CALL      RDSWARD2
          CALL      RDKWARD2
          BRANCH    OVRCD,NXTPAT30              * If EOF, try Ward Standby
          MATCH     ADMISSNO,DWADMNO
          GOTO      NXTPAT30 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70        * Set key up
          CALL      RDSWARD1                    * - position on Index 1
          MOVE      WWARD,SAVEWARD
          GOTO      NXTPAT45
.
NXTPAT30  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward (standby)
          CALL      RDSWARD4
          CALL      RDKWARD4
          BRANCH    OVRCD,NXTPAT50              * If EOF, try On-Leave file
          MATCH     ADMISSNO,DWSTBY
          GOTO      NXTPAT50 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70
          CALL      RDSWARD1                    * Get crnt patient on Index 1
          MOVE      WWARD,SAVEWARD
.
NXTPAT35  CALL      RDKWARD1                    * Get next bed in ward.
          BRANCH    OVRCD,NXTPAT49              * - no more no bed recs
          MATCH     SAVEWARD,WWARD              * - still correct ward ?
          GOTO      NXTPAT49 IF NOT EQUAL
          MATCH     SP3,WBED                    * - ignore ward header
          GOTO      NXTPAT35 IF EQUAL
.
NXTPAT40  MATCH     ZEROVISN,WADMNO             * First check main admno
          GOTO      NXTPAT45 IF EQUAL           * - no good - try standby
          MOVE      DWADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT45  MATCH     ZEROVISN,WSTBY              * Now check standby admno
          GOTO      NXTPAT35 IF EQUAL           * - no good, try next bed
          MOVE      DWSTBY,ADMISSNO             * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT49  PACK      KEY14,AWARD,SP70            * Set key to start of ward
          CALL      RDSONLV1                    * position on On-leave file
          GOTO      NXTPAT55
.
NXTPAT50  PACK      KEY14,ADMISSNO,SP70         * Is patient On-leave
          CALL      RDSONLV2
          CALL      RDKONLV2
          BRANCH    OVRCD,NXTPAT90              * If EOF, no more pats (close)
          MATCH     ADMISSNO,DOADMNO
          GOTO      NXTPAT90 IF NOT EQUAL
          MATCH     AWARD,OWARD                 * - correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL
.
          PACK      KEY14,OWARD,OBED,DOADMNO
          CALL      RDSONLV1                    * Get patient on Index 1
.
NXTPAT55  CALL      RDKONLV1                    * Get next patient
          BRANCH    OVRCD,NXTPAT90              * - no more no bed recs
          MATCH     AWARD,OWARD                 * - still correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO             * - non-zero admission ?
          GOTO      NXTPAT55 IF EQUAL
          MOVE      DOADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT80  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,NXTPAT90
.
          MATCH     "1",NEXTPATN
          IF        @EQUAL
            BRANCH    ASTAT,NXTPAT95,NXTPAT83,NXTPAT95,NXTPAT83,NXTPAT95
          ENDIF
.
NXTPAT83  MOVE      AURNO,URNUMBER
.
NXTPAT85  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          PACK      VAR,NEXTPATN,SP70,SP70
          STRIP     VAR
          CLEAR     REDIRECT
          APPEND    VAR,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          CALL      RDIREC00
          GOTO      NXTPAT99
.
NXTPAT90  CALL      WINCLS00
          GOTO      NXTPAT99
.
NXTPAT95  MOVE      "ADMISSION IS NOT CURRENT",WEBTITLE
          CALL      WINCLE00
          GOTO      NXTPAT99
.
NXTPAT99  RETURN
.------------------------------------------------------------
. List Attributes Last 5
.------------------------------------------------------------
LST5AT00  COMPARE   ONE,NOATTRIB
          GOTO      LST5AT99 IF EQUAL
.
          MOVE      SP70,LINKPRG
          MOVE      SP70,LINKREP
          MOVE      SP70,LINKTEM
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      CLPATATR
.
          MOVE      ZERO,LAST5CNT
.          MOVE      SP70,SAVKEY35
.          PACK      KEY35,URNUMBER,Z70
.          CALL      RSPTATR1
.LST5AT05  CALL      RPPTATR1
.          BRANCH    OVRCD,LST5AT08
.
.          MATCH     URNUMBER,PTARURNO
.          GOTO      LST5AT08 IF NOT EQUAL
.
.          PACK      SAVKEY35,PTARURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
.          ADD       ONE,LAST5CNT
.          COMPARE   FIVE,LAST5CNT
.          GOTO      LST5AT08 IF EQUAL
.
.          GOTO      LST5AT05
.
.LST5AT08  MATCH     SP70,SAVKEY35
.          GOTO      LST5AT09 IF EQUAL
.
.          MOVE      SAVKEY35,KEY35
.          CALL      RDPTATR1
.          IF        OVRCD=0
.            GOTO      LST5AT15
.          ENDIF
.
LST5AT09  PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
LST5AT10  CALL      RPPTATR1
          BRANCH    OVRCD,LST5AT99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LST5AT99 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      LST5AT99 IF NOT EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      LST5AT10 IF NOT EQUAL
.
          ADD       ONE,LAST5CNT
          COMPARE   LAST5CNT,FIVE
          GOTO      LST5AT99 IF LESS
.
LST5AT15  MOVE      SP70,INPUTBYU
          MOVE      SP70,DELETBYU
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,INPUTBYU
          ENDIF
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
          MATCH     SP70,PTARUUSR
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARUUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,DELETBYU
          ENDIF
          ENDIF
.
          MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
          CALL      RNGBMI00
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
LST5AT80  MATCH     "1",PTARDELR
          GOTO      LST5AT90 IF EQUAL
.
          MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap>":
                               DISPDATE," ",PTARTIME,"</td>":
                               "<td>",INPUTBYU,"</td>":
                               "<td>",PTARVAL1,"</td>":
                               "<td>",PTARVAL2,"</td>":
                               "<td>",BODMASRN,"</td>":
                               "<td>",PTARVISN,"</td>":
                               "<td>",DELETBYU,"&nbsp;</td>";
            WRITE     HTMLFILE;"</tr>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDATE:
                               "&ptatr004=",PTARTIME,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDATE," ",PTARTIME,"</td>":
                               "<td>",INPUTBYU,"</td>":
                               "<td>",PTARVAL1,"</td>":
                               "<td>",PTARVAL2,"</td>":
                               "<td>",BODMASRN,"</td>":
                               "<td>",PTARVISN,"</td>":
                               "<td>",DELETBYU,"&nbsp;</td>";
            WRITE     HTMLFILE;"</tr>";
          ENDIF
.
          GOTO      LST5AT10
.
LST5AT90  MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike>":
                               DISPDATE," ",PTARTIME,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",PTARVAL1,"</strike></td>":
                               "<td><strike>",PTARVAL2,"</strike></td>":
                               "<td><strike>",BODMASRN,"</strike></td>":
                               "<td><strike>",PTARVISN,"</strike></td>":
                               "<td><strike>",DELETBYU,"&nbsp;<strike></td>";
            WRITE     HTMLFILE;"</tr>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDATE:
                               "&ptatr004=",PTARTIME,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDATE," ",PTARTIME,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",PTARVAL1,"</strike></td>":
                               "<td><strike>",PTARVAL2,"</strike></td>":
                               "<td><strike>",BODMASRN,"</strike></td>":
                               "<td><strike>",PTARVISN,"</strike></td>":
                               "<td><strike>",DELETBYU,"&nbsp;<strike></td>";
            WRITE     HTMLFILE;"</tr>";
          ENDIF
.
          GOTO      LST5AT10
.
LST5AT99  RETURN
.
.------------------------------------------------------------
. List Extra Contacts
.------------------------------------------------------------
LSTCEX00  WRITE     HTMLFILE;"[";
          MOVE      ZERO,FIRSTREC
.
          PACK      KEY14,URNUMBER,Z70
          CALL      RSPMCEX1
LSTCEX10  CALL      RPPMCEX1
          BRANCH    OVRCD,LSTCEX99
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      LSTCEX99 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          GOTO      LSTCEX10 IF EQUAL
.
          PACK      KEY5,CATtc,PMCETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
            MOVE      SP70,TCINDC1
          ENDIF
.
          MOVE      SP70,PMRLDESC
          MATCH     SP70,PMCERELP
          IF        !@EQUAL
            PACK      KEY10,PMCERELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PMCERELP,PMRLDESC
            ENDIF
          ENDIF
.
          IF        FIRSTREC=0
            MOVE      ONE,FIRSTREC
          ELSE
            WRITE     HTMLFILE;","
          ENDIF
          WRITE     HTMLFILE;"{#"urnumber#":#"",URNUMBER,"#",":
                              "#"contactTypeDesc#":#"",TDESC,"#",":
                              "#"contactType#":#"",PMCETYPE,"#",":
                              "#"contactTypeInd#":#"",TCINDC1,"#",":
                              "#"contactCounter#":#"",PMCECNTR,"#",":
                              "#"contactRelationship#":#"",PMCERELP,"#",":
                              "#"contactRelationshipDesc#":#"",PMRLDESC,"#",":
                              "#"contactName#":#"",PMCEGNAM," ",PMCEGNM2," ":
                                                   PMCESNAM,"#",":
                              "#"contactHomePhone#":#"",PMCETELP,"#",":
                              "#"contactWorkPhone#":#"",PMCETELB,"#",":
                              "#"contactMobilePhone#":#"",PMCETELM,"#",":
                              "#"contactEmail#":#"",PMCEEMAI,"#",":
                              "#"contactAddress#":#"",PMCEADD1," ",PMCEADD2," ":
                                                      PMCEADD3," ",PMCEADD4," ":
                                                      PMCEPOST,"#"}";
          GOTO      LSTCEX10
.
LSTCEX99  WRITE     HTMLFILE;"]"
          RETURN
+
.------------------------------------------------------------
. Medical Record Retention Details
.------------------------------------------------------------
RECRN000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      RECRN800 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      RECRN100 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      RECRN100 IF EQUAL
.
          GOTO      RECRN900
.
RECRN100  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RECRN910
          CALL      RDPMPX21
          BRANCH    OVRCD,RECRN910
.
          MATCH     Z70,RECRT001
          IF        !@EQUAL
            PACK      PMPXRPER,RECRT001,SP70
          ENDIF
.
          MATCH     Z70,RECRT002
          IF        !@EQUAL
            PACK      PMPXRDAT,RECRT002,SP70
          ENDIF
.
          MATCH     "D",UPDTTYPE
          IF        @EQUAL
            PACK      PMPXRPER,SP70
            PACK      PMPXRDAT,SP70
          ENDIF
.
          CALL      UPPMPX21
.
          MOVE      ZERO,EXIT
          GOTO      RECRN999
.
RECRN800  CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RECRN910
          CALL      RDPMPX21
          BRANCH    OVRCD,RECRN910
.
          MATCH     SP70,ADMISSNO
          GOTO      RECRN920 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
            PACK      KEY36,ADMISSNO,SP70
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            IF        OVRCD = 1
              PACK      RECRETDT,CURRDATE,SP70   * use current date
            ELSE
              MATCH     ADMISSNO,DOBAOUTN
              IF        @EQUAL
                PACK      RECRETDT,OBADATE,SP70  * use appointment date
              ENDIF
            ENDIF
            GOTO      RECRN850
          ENDIF
.
          PACK      RECRETDT,PVIDATE,SP70        * use visit date
          COMPARE   ONE,PVITYPE
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            IF        OVRCD=0
              PACK      RECRETDT,EMVIDDAT,SP70   * use emr discharge date
            ENDIF
          ENDIF
          COMPARE   THREE,PVITYPE
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDDSCH1
            IF        OVRCD=0
              PACK      RECRETDT,DDATE,SP70      * use inp discharge date
            ENDIF
          ENDIF
.
RECRN850  CLEAR     WEBTITLE
          MOVE      "Record Retention Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,RECRN999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RECRN999
.
RECRN900  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECRN999
.
RECRN910  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECRN999
.
RECRN920  MOVE      "Invalid Visit",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RECRN999
.
RECRN999  RETURN
+
.******************************************************************************
.*                                 WREDW000                                   *
.* If any of the EDWWARD variables have changed, write/update pmsedwaf        *
.******************************************************************************
.
WREDW000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          OPEN      PMSEDWA2,"pmsedwaf"
.
          CALL      IBACLOCK
          PACK      PMEWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEWCDAT
          CLOCK     TIME,PMEWCTIM
          PACK      PMEWCUID,USERID
          PACK      PMEWTYPE,PMEWTYPE,SP70
          PACK      PMEWSPAR,SP70,SP70
.
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RAPMEDW2
          IF        OVRCD=1
            CALL      WRPMEDW2
          ELSE
            CALL      UPPMEDW2
          ENDIF
.
WREDW999  CLOSE     PMSEDWA2
          RETURN
.
.------------------------------------------------------------
. Patient MH Attributes
.------------------------------------------------------------
MHTRIB00  RESET     UPDTTYPE
          OPEN      PATATRA3,"patatraf"
          MATCH     SP70,UPDTTYPE
          GOTO      MHTRIB50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MHTRIB10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MHTRIB20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MHTRIB30 IF EQUAL
.
          MATCH     "R",UPDTTYPE    * Remote formaction
          GOTO      MHTRIB40 IF EQUAL
.
          GOTO      MHTRIB90
.
.         ************ ADD FORMACTION ***********
.
MHTRIB10  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ONE,NINE,PTATR002,SP70
          CALL      RDPTATR1
          COMPARE   ZERO,OVRCD
          GOTO      MHTRIB94 IF EQUAL
.
          CALL      CLPATATR
          CALL      MVPATATR
.
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ONE,NINE,PTATR002,SP70
          CALL      RAPTATR1
          IF        OVRCD=1
            CALL      WRPTATR1
          ENDIF
.
          PACK      KEY8,PTATR002,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PTATR009,PMVXMHLS
            CALL      UPPMVX11
          ENDIF
.
. ** update end date of the previous record to the start date of this record **
          PACK      KEY35,PTATR001,PTATR002,ZERO,ONE,NINE,PTATR003,PTATR004,SP70
          CALL      RDPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,MHTRIB16
.
          MATCH     PTATR001,PTARURNO
          GOTO      MHTRIB16 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN
          GOTO      MHTRIB16 IF NOT EQUAL
.
          MATCH     ATYPE019,PTARTYPE
          GOTO      MHTRIB16 IF NOT EQUAL
.
          PACK      PTARFDTE,PTATR003
          PACK      PTARFTME,PTATR004
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR3
.
MHTRIB16  MOVE      ZERO,EXIT
          GOTO      MHTRIB99
.
.         ************ UPDATE FORMACTION **********
.
MHTRIB20  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ONE,NINE,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,MHTRIB95
.
          CALL      MVPATATR
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR1
.
          PACK      KEY8,PTATR002,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PTATR009,PMVXMHLS
            CALL      UPPMVX11
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MHTRIB99
.
.         ************ DELETE FORMACTION **********
.
MHTRIB30  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ONE,NINE,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,MHTRIB95
.
          MATCH     "1",PTATR018                     * Validate if strikethrough
          IF        @EQUAL
            CALL      MVPATATR
.
            CALL      IBACLOCK
            PACK      PTARUDTE,CCC,CYY,CMM,CDD
            REP       " 0",PTARUDTE
            CLOCK     TIME,PTARUTME
            MOVE      USERID,PTARUUSR
.
            CALL      UPPTATR1
          ELSE
            CALL      DEPTATR1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MHTRIB99
.
.         ************ REMOTE FORMACTION **********
.
MHTRIB40
.         CALL      REMOTE00        * Remote Script for bmi
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
.        ************ Display FORMACTION **********
.
MHTRIB50  MATCH     SP70,URNUMBER
          GOTO      MHTRIB92 IF EQUAL
          GOTO      MHTRIB92 IF EOS
.
          MATCH     SP70,ADMISSNO
          GOTO      MHTRIB93 IF EQUAL
          GOTO      MHTRIB93 IF EOS
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MHTRIB92
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70     * Read admission file
          CALL      RDPTMIS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ONE,NINE,PTATR002,SP70
          CALL      RDPTATR1
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient MH Attributes Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MHTRIB99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB91  MOVE      "Patient Attributes System Not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB92  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB93  MOVE      "Invalid Visit.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB94  MOVE      "Patient MH Attributes Record Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB95  MOVE      "Invalid MH Patient Attributes Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MHTRIB99
.
MHTRIB99  RETURN
.
.------------------------------------------------------------
. List Attributes
.------------------------------------------------------------
LSTMHA00  COMPARE   ONE,NOATTRIB
          GOTO      LSTMHA99 IF EQUAL
          OPEN      PATATRA3,"patatraf"
.
          MOVE      ZERO,LASTFLAG
          MOVE      SP70,LINKPRG
          MOVE      SP70,LINKREP
          MOVE      SP70,LINKTEM
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY35,URNUMBER,ADMISSNO,ATYPE019,Z70
          CALL      RSPTATR3
LSTMHA10  CALL      RPPTATR3
          BRANCH    OVRCD,LSTMHA99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LSTMHA99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      LSTMHA99 IF NOT EQUAL
.
          MATCH     "019",PTARTYPE
          GOTO      LSTMHA10 IF NOT EQUAL
.
          MOVE      SP70,INPUTBYU
          MOVE      SP70,DELETBYU
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,INPUTBYU
          ENDIF
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
          MATCH     SP70,PTARUUSR
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARUUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,DELETBYU
          ENDIF
          ENDIF
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL
            UNPACK    PTARFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT3,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY5,ANSL,ANSS,PTARCOD1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            PACK      TDESC,SP70
          ENDIF
.
LSTMHA80  MATCH     "1",PTARDELR
          GOTO      LSTMHA90 IF EQUAL
.
          COMPARE   ONE,LASTFLAG
          GOTO      LSTMHA85 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr>";
          WRITE     HTMLFILE;"<td nowrap>":
                             DISPDATE," ",PTARTIME,"</td>":
                             "<td>",DISPDAT1," ",PTARFTME,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td>",INPUTBYU,"&nbsp;</td>":
                             "<td>",DISPDAT2," ",PTARCTME,"</td>":
                             "<td>",DELETBYU,"&nbsp;</td>":
                             "<td>",DISPDAT3," ",PTARUTME,"</td>":
                             "</tr>"
          GOTO      LSTMHA10
.
LSTMHA85  WRITE     HTMLFILE;"<tr>";
          WRITE     HTMLFILE;"<td nowrap><A HREF='javascript:":
                             "UpdateAttribute":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",PTARVISN:
                             "&ptatr001=",PTARURNO:
                             "&ptatr002=",PTARVISN:
                             "&ptatr003=",DISPDATE:
                             "&ptatr004=",PTARTIME,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DISPDATE," ",PTARTIME,"</td>":
                             "<td>",DISPDAT1," ",PTARFTME,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td>",INPUTBYU,"&nbsp;</td>":
                             "<td>",DISPDAT2," ",PTARCTME,"</td>":
                             "<td>",DELETBYU,"&nbsp;</td>":
                             "<td>",DISPDAT3," ",PTARUTME,"</td>";
          WRITE     HTMLFILE;"</tr>"
          MOVE      ONE,LASTFLAG
.
          GOTO      LSTMHA10
.
LSTMHA90  WRITE     HTMLFILE;"<tr>";
          WRITE     HTMLFILE;"<td nowrap><strike>":
                        DISPDATE," ",PTARTIME,"</td>":
                        "<td><strike>",DISPDAT1," ",PTARFTME,"</strike></td>":
                        "<td><strike>",TDESC,"</strike></td>":
                        "<td><strike>",INPUTBYU,"&nbsp;</strike></td>":
                        "<td><strike>",DISPDAT2," ",PTARCTME,"</strike></td>":
                        "<td><strike>",DELETBYU,"&nbsp;</strike></td>":
                        "<td><strike>",DISPDAT3," ",PTARUTME,"</strike></td>";
          WRITE     HTMLFILE;"</tr>"
          GOTO      LSTMHA10
.
LSTMHA99  RETURN
.
.------------------------------------------------------------
. Patient NDIS Details - type 020
.------------------------------------------------------------
NDISDT00  RESET     UPDTTYPE
          OPEN      PATATRA3,"patatraf"
          MATCH     SP70,UPDTTYPE
          GOTO      NDISDT50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      NDISDT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      NDISDT20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      NDISDT30 IF EQUAL
.
          GOTO      NDISDT90
.
.         ************ ADD FORMACTION ***********
.
NDISDT10  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,TWO,ZERO,PTATR002,SP70
          CALL      RDPTATR1
          COMPARE   ZERO,OVRCD
          GOTO      NDISDT92 IF EQUAL
.
          PACK      KEY35,PTATR001,PTATR002,ZERO,TWO,ZERO,PTATR003,SP70
          CALL      RSPTATR3                * Check if a record already exists 
          CALL      RKPTATR3                * for the start date
          BRANCH    OVRCD,NDISDT15
.
          MATCH     PTATR001,PTARURNO       * Same U/R
          GOTO      NDISDT15 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN       * Same Visit
          GOTO      NDISDT15 IF NOT EQUAL
.
          MATCH     "020",PTARTYPE          * NDIS Record
          GOTO      NDISDT94 IF NOT EQUAL
.
          MATCH     PTARDATE,PTATR003       * Same start date
          GOTO      NDISDT94 IF EQUAL
.
NDISDT15  CALL      CLPATATR
          CALL      MVPATATR
.
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,TWO,ZERO,PTATR002,SP70
          CALL      RAPTATR1
          IF        OVRCD=1
            CALL      WRPTATR1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      NDISDT99
.
.         ************ UPDATE FORMACTION **********
.
NDISDT20  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,TWO,ZERO,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,NDISDT93
.
          CALL      MVPATATR
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR1
.
          MOVE      ZERO,EXIT
          GOTO      NDISDT99
.
.         ************ DELETE FORMACTION **********
.
NDISDT30  PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,TWO,ZERO,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,NDISDT93
.
          MATCH     "1",PTATR018                     * Validate if strikethrough
          IF        @EQUAL
            CALL      MVPATATR
.
            CALL      IBACLOCK
            PACK      PTARUDTE,CCC,CYY,CMM,CDD
            REP       " 0",PTARUDTE
            CLOCK     TIME,PTARUTME
            MOVE      USERID,PTARUUSR
.
            CALL      UPPTATR1
          ELSE
            CALL      DEPTATR1
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      NDISDT99
.
.        ************ Display FORMACTION **********
.
NDISDT50  MATCH     SP70,URNUMBER
          GOTO      NDISDT91 IF EQUAL
          GOTO      NDISDT91 IF EOS
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,NDISDT91
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,TWO,ZERO,PTATR002,SP70
          CALL      RDPTATR1
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient NDIS Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,NDISDT99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT91  MOVE      "Invalid U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT92  MOVE      "NDIS Record Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT93  MOVE      "Invalid NDIS Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT94  MOVE      "NDIS Record already exists for this start date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NDISDT99
.
NDISDT99  RETURN
.
.------------------------------------------------------------
. List NDIS Attributes
.------------------------------------------------------------
LSNDIS00  COMPARE   ONE,NOATTRIB
          GOTO      LSNDIS99 IF EQUAL
          OPEN      PATATRA3,"patatraf"
.
          MOVE      SP70,LINKPRG
          MOVE      SP70,LINKREP
          MOVE      SP70,LINKTEM
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY35,URNUMBER,SP8,ATYPE020,Z70
          CALL      RSPTATR3
LSNDIS10  CALL      RPPTATR3
          BRANCH    OVRCD,LSNDIS99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LSNDIS99 IF NOT EQUAL
.
          MATCH     "020",PTARTYPE
          GOTO      LSNDIS10 IF NOT EQUAL
.
          MOVE      SP70,INPUTBYU
          MOVE      SP70,DELETBYU
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,INPUTBYU
          ENDIF
.
          MATCH     SP70,PTARUUSR
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARUUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,DELETBYU
          ENDIF
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DISPDAT1
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL
            UNPACK    PTARFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT3,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,CODDESC1
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            PACK      KEY5,CAT1D,PTARCOD1,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTARCOD1,TDESC
            ENDIF
            MOVE      TDESC,CODDESC1
          ENDIF
.
          MOVE      SP70,CODDESC2
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            PACK      KEY5,CAT1E,PTARCOD2,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTARCOD2,TDESC
            ENDIF
            MOVE      TDESC,CODDESC2
          ENDIF
.
LSNDIS80  MATCH     "1",PTARDELR
          GOTO      LSNDIS90 IF EQUAL
.
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap><A HREF='javascript:":
                             "UpdateAttribute":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&ptatr001=",PTARURNO:
                             "&ptatr002=",PTARVISN:
                             "&ptatr003=",DISPDATE:
                             "&ptatr004=",PTARTIME,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DISPDATE," ",PTARTIME,"</td>":
                             "<td>",DISPDAT1," ",PTARFTME,"</td>":
                             "<td>",PTARTXT1,"</td>":
                             "<td>",CODDESC1,"</td>":
                             "<td>",CODDESC2,"</td>":
                             "<td>",INPUTBYU,"&nbsp;</td>":
                             "<td>",DISPDAT2," ",PTARCTME,"</td>":
                             "<td>",DELETBYU,"&nbsp;</td>":
                             "<td>",DISPDAT3," ",PTARUTME,"</td>":
                             "</tr>"
          GOTO      LSNDIS10
.
LSNDIS90  WRITE     HTMLFILE;"<tr>":
                        "<td nowrap><strike>":
                        DISPDATE," ",PTARTIME,"</td>":
                        "<td><strike>",DISPDAT1," ",PTARFTME,"</strike></td>":
                        "<td><strike>",PTARTXT1,"</strike></td>":
                        "<td><strike>",CODDESC1,"</strike></td>":
                        "<td><strike>",CODDESC2,"</strike></td>":
                        "<td><strike>",INPUTBYU,"&nbsp;</strike></td>":
                        "<td><strike>",DISPDAT2," ",PTARCTME,"</strike></td>":
                        "<td><strike>",DELETBYU,"&nbsp;</strike></td>":
                        "<td><strike>",DISPDAT3," ",PTARUTME,"</strike></td>":
                        "</tr>"
          GOTO      LSNDIS10
.
LSNDIS99  RETURN
.
.------------------------------------------------------------
. Multiple Birth Patient Attributes
.------------------------------------------------------------
MULBAT00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      MULBAT50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MULBAT10 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MULBAT30 IF EQUAL
.
          GOTO      MULBAT90
.
.         ************ ADD FORMACTION ***********
.
MULBAT10  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
. Ended previous previous record to the start date of this record
.
          MOVE      ATYPE022,KEY3
          PACK      KEY8,SP7,ZERO
          PACK      KEY35,URNUMBER,KEY8,KEY3,Z70
          CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,MULBAT12
.
          MATCH     URNUMBER,PTARURNO
          GOTO      MULBAT12 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      MULBAT12 IF NOT EQUAL
.
          MATCH     KEY3,PTARTYPE
          GOTO      MULBAT12 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      MULBAT12 IF EQUAL
.
          MOVE      "1",PTARDELR
          MOVE      PTPAR008,PTARCOD2
.
          MOVE      CURRDATE,PTARUDTE
          MOVE      CURRTIME,PTARUTME
          MOVE      USERID,PTARUUSR
          MOVE      PTARUDTE,PTARFDTE
          MOVE      PTARUTME,PTARFTME
          MOVE      PTARUUSR,PTARFUSR
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      UPPTATR3
.
. Create new record
.
MULBAT12  CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          PACK      PTARVISN,SP7,ZERO
          MOVE      CURRDATE,PTARDATE
          MOVE      CURRTIME,PTARTIME
          MOVE      ATYPE022,PTARTYPE
          MOVE      PTPAR007,PTARVAL1
          MOVE      PTPAR006,PTARCOD1
          MOVE      PTPAR008,PTARCOD2
          MOVE      USERID,PTARCUSR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
.
          PACK      KEY35,PTARURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
          CALL      WRPTATR1
.
          MOVE      PTARURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,MULBAT92
.
          MOVE      "1",PMPXSN20
          CALL      UPPMPX21          * update the record
.
MULBAT18  MOVE      ZERO,EXIT
          GOTO      MULBAT99
.
.         ************ DELETE FORMACTION **********
.
MULBAT30  PACK      KEY35,PTATR001,PTATR003,PTATR004,PTATR005,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,MULBAT95
.
          MOVE      "1",PTARDELR
          MOVE      PTPAR008,PTARCOD2
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
          MOVE      PTARUDTE,PTARFDTE 
          MOVE      PTARUTME,PTARFTME
          MOVE      PTARUUSR,PTARFUSR
.
          CALL      UPPTATR1
.
          MOVE      PTARURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,MULBAT92
.
          MOVE      "",PMPXSN20
          CALL      UPPMPX21          * update the record
.
          MOVE      ZERO,EXIT
          GOTO      MULBAT99
.
.        ************ Display FORMACTION **********
.
MULBAT50  MATCH     SP70,URNUMBER
          GOTO      MULBAT92 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MULBAT92
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,PTATR005,PTATR002,SP70
          CALL      RDPTATR1
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Multiple Birth Patient Attributes Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MULBAT99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MULBAT99
.
MULBAT90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MULBAT99
.
MULBAT92  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MULBAT99
.
MULBAT94  MOVE      "Patient Multi Birth Attributes Record Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MULBAT99
.
MULBAT95  MOVE      "Invalid Multi Birth Patient Attributes Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MULBAT99
.
MULBAT99  RETURN
.
.------------------------------------------------------------
. List multiple birth patient attributes
.------------------------------------------------------------
LMLBRA00  PACK      KEY8,SP7,ZERO
          PACK      KEY35,URNUMBER,KEY8,ATYPE022,Z70
          CALL      RSPTATR3
LMLBRA10  CALL      RPPTATR3
          BRANCH    OVRCD,LMLBRA99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LMLBRA99 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      LMLBRA99 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      LMLBRA99 IF NOT EQUAL
.
          MOVE      SP70,INPUTBYU
          MOVE      SP70,FINUSRNM
          MOVE      SP70,FINDATED
          MOVE      SP70,FINTIME
          MOVE      SP70,BIRTYPDS
          MOVE      SP70,REATYPDS
          MOVE      SP70,STRSTRIK
          MOVE      SP70,ENDSTRIK
          CLEAR     HTMLLNK2
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,INPUTBYU
          ENDIF
.
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "mX",KEY2
            PACK      KEY5,KEY2,PTARCOD1
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTARCOD1,TDESC
            ENDIF
            MOVE      TDESC,BIRTYPDS
          ENDIF
.
          MOVE      "Order Not Stated",DIM16
          MATCH     SP70,PTARVAL1
          IF        !@EQUAL
            MATCH     "0",PTARVAL1
            IF        !@EQUAL
              MOVE      PTARVAL1,DIM16
            ENDIF
          ENDIF
.
          MATCH     SP70,PTARFUSR
          IF        !@EQUAL
            PACK      KEY10,PTARFUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARFUSR,WBSENAM
            ENDIF
            MOVE      WBSENAM,FINUSRNM
          ENDIF
.
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL  
            UNPACK    PTARFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      FINDATED,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.       
          MOVE      PTARFTME,FINTIME              
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "mW",KEY2
            PACK      KEY5,KEY2,PTARCOD2
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTARCOD2,TDESC
            ENDIF
            MOVE      TDESC,REATYPDS
          ENDIF
.
          MATCH     "1",PTARDELR
          GOTO      LMLBRA80 IF EQUAL
.
LMLBRA70  CLEAR     HTMLLNK2
          APPEND    "<a HREF='javascript:DeleteBirthType(#"",HTMLLNK2
          APPEND    PTARURNO,HTMLLNK2
          APPEND    "#",#"",HTMLLNK2
          APPEND    PTARVISN,HTMLLNK2
          APPEND    "#",#"",HTMLLNK2
          APPEND    DISPDATE,HTMLLNK2
          APPEND    "#",#"",HTMLLNK2
          APPEND    PTARTIME,HTMLLNK2
          APPEND    "#",#"",HTMLLNK2
          APPEND    PTARTYPE,HTMLLNK2
          APPEND    "#")'>",HTMLLNK2
          APPEND    "<img src=../images/DeleteIcon.gif",HTMLLNK2
          APPEND    "></a>",HTMLLNK2
          RESET     HTMLLNK2 
.
          WRITE     HTMLFILE;"<tr><td nowrap>":
                             HTMLLNK2:
                             DISPDATE," ",PTARCTME,"</td>":
                             "<td>",INPUTBYU,"</td>":
                             "<td>",BIRTYPDS,"</td>":
                             "<td>",DIM16,"</td>":
                             "<td>",FINDATED," ",FINTIME,"</td>":
                             "<td>",FINUSRNM,"</td>":
                             "<td>",REATYPDS,"</td>";
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      LMLBRA10
.
LMLBRA80  MOVE      "<strike>",STRSTRIK
          MOVE      "</strike>",ENDSTRIK
. 
          WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<img src=../images/Blank.gif>":
                             STRSTRIK,DISPDATE," ",PTARCTME,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,INPUTBYU,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,BIRTYPDS,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,DIM16,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,FINDATED," ":
                             FINTIME,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,FINUSRNM,ENDSTRIK,"</td>":
                             "<td>",STRSTRIK,REATYPDS,ENDSTRIK,"</td>";
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      LMLBRA10
.
LMLBRA99  RETURN
.
.----------------------------------------------------------------------------
. Patient Follow Up Attributes Maintenance
.----------------------------------------------------------------------------
PTFLUP00  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      PTFLUP50 IF EQUAL
.
          MATCH     "A",UPDATETY    * Add formaction
          GOTO      PTFLUP10 IF EQUAL
.
          MATCH     "U",UPDATETY    * Update formaction
          GOTO      PTFLUP20 IF EQUAL
.
          MATCH     "D",UPDATETY    * Delete formaction
          GOTO      PTFLUP30 IF EQUAL
.
          GOTO      PTFLUP90
.
.         ************ ADD FORMACTION ***********
.
PTFLUP10  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CURRTIME
.
. Create new record
.
PTFLUP12  CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          MOVE      CURRDATE,PTARDATE
          MOVE      CURRTIME,PTARTIME
          MOVE      "026",PTARTYPE
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70  
          CALL      RDPTATR2
          IF        OVRCD = 0 
            MOVE      "patatraf row already existed.",WEBTITLE
            CALL      WEBERR00
            GOTO      PTFLUP99
          ENDIF
.
          CALL      MPTFL000
.
          MOVE      "0",PTARDELR
          MOVE      USERID,PTARCUSR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
.
          CALL      WRPTATR2
.
          CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          MOVE      CURRDATE,PTARDATE
          MOVE      CURRTIME,PTARTIME
          MOVE      "027",PTARTYPE
.
          CALL      MPTFL100
.
          MOVE      "0",PTARDELR
          MOVE      USERID,PTARCUSR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
.
          CALL      WRPTATR2
.
PTFLUP18  MOVE      ZERO,EXIT
          GOTO      PTFLUP99
.
.         ************ UPDATE FORMACTION **********
.
PTFLUP20  MOVE      "026",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,PTFLUP95
.
          CALL      MPTFL000
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR2
.
PTFLUP25  MOVE      "027",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,PTFLUP95
.
          CALL      MPTFL1000
.
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR2
.
          MOVE      ZERO,EXIT
          GOTO      PTFLUP99
.
.         ************ DELETE FORMACTION **********
.
PTFLUP30  MOVE      "026",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,PTFLUP95
.
          MOVE      "1",PTARDELR
.
          CALL      IBACLOCK
          PACK      PTARFDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARFDTE
          CLOCK     TIME,PTARFTME
          MOVE      USERID,PTARFUSR
.
          CALL      UPPTATR2
.
PTFLUP35  MOVE      "027",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,PTFLUP95
.
          MOVE      "1",PTARDELR
.
          PACK      PTARFDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARFDTE
          CLOCK     TIME,PTARFTME
          MOVE      USERID,PTARFUSR
.
          CALL      UPPTATR2
.
          MOVE      ZERO,EXIT
          GOTO      PTFLUP99
.
.        ************ Display FORMACTION **********
.
PTFLUP50  MATCH     SP70,URNUMBER
          GOTO      PTFLUP92 IF EQUAL
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,PTFLUP92
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70     * Read Master File Ext 2
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      CLEMRVIS
          ENDIF
.
          MOVE      "026",DIM3
PTFLUP55  PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          IF        OVRCD=1
            CALL      CLPATATR
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Patient Follow Up Attribute Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PTFLUP99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PTFLUP99
.
PTFLUP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTFLUP99
.
PTFLUP92  MOVE      "Invalid U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTFLUP99
.
PTFLUP95  MOVE      "Invalid Patient Follow Up Attribute Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PTFLUP99
.
PTFLUP99  RETURN
.
.------------------------------------------------------------
. WebServices Organisations/Participant Maintenance
.------------------------------------------------------------
WSPR0000  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      WSPR8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      WSPR1000 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      WSPR1500 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      WSPR2000 IF EQUAL
.
          GOTO      WSPR9000
.
.         ************ ADD FORMACTION ***********
.
WSPR1000
.
          MOVE      ZERO,EXIT
          GOTO      WSPR9999
.
.         ************ UPDATE FORMACTION **********
.
WSPR1500  CALL      UWSP0000                * send GetParticipant request
          GOTO      WSPR9999
.
.         ************ DELETE FORMACTION **********
.
WSPR2000
.
          MOVE      ZERO,EXIT
          GOTO      WSPR9999
.
.         ************ DISPLAY FORMACTION **********
.
WSPR8000  PACK      KEY3,PTPAR001,SP70
          CALL      RDWBPAR1
          IF        OVRCD=1
            CALL     CWBPA000
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "WebServices Participant Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WSPR9999
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      WSPR9999
.
WSPR9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WSPR9999
.
WSPR9999  RETURN
+
.------------------------------------------------------------
. Clear webservices participant details - webparaf
.------------------------------------------------------------
CWBPA000  MOVE      SP70,WBPRCODE
          MOVE      SP70,WBPRTYPE
          MOVE      SP70,WBPRNAME
          MOVE      SP70,WBPRCNUM
          MOVE      SP70,WBPRDUPD
          MOVE      SP70,WBPRSPAR
CWBPA999  RETURN
+
.*****************************************************************************
.*                               UWSP0000                                    *
.*          Update the participant details (GPRW)                            *
.*****************************************************************************
.
UWSP0000  PACK      KEY51,SP2,TWO,SP70
          CALL      RSWBETR1
          CALL      RKWBETR1                     * any current update requests?
          BRANCH    OVRCD,UWSP1000               * no, so write new request
.
          MATCH     SP1,WBETSTAT
          IF        @EQUAL
            MATCH     " 2",WBETTYPE
            GOTO      UWSP9500 IF EQUAL          * current request waiting
          ENDIF
.
UWSP1000  CALL      IBACLOCK                     * get current date/time
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
.         Get the B2B Device
.
          IF        IBCNMHOS=1
            MOVE      WBSEHOSP,KEY3 
          ELSE
            MOVE      SP70,KEY3
          ENDIF
.
          PACK      KEY71,KEY3,SP70          * Read B2B Device Table
          CALL      RSWBB2B3
          CALL      RKWBB2B3
          BRANCH    OVRCD,UWSP1400
.
          MATCH     KEY3,WBB2HOSP
          GOTO      UWSP1400 IF NOT EQUAL
.
          MATCH     "ACTIVE",WBB2DSTA            * Device Active
          GOTO      UWSP1400 IF NOT EQUAL
.
          MATCH     SP70,WBB2DPTH
          GOTO      UWSP1400 IF EQUAL
.
          GOTO      UWSP1500
.
UWSP1400  MOVE      "Current B2B Device not valid.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UWSP9999
.
UWSP1500  MOVE      SP1,WBETSTAT
          MOVE      " 2",WBETTYPE                * get participants request
          MOVE      SP70,WBETTRID
          MOVE      SP70,WBETBATN
          MOVE      SP70,WBETINVN
          MOVE      SP70,WBETUDTE
          MOVE      SP70,WBETUTIM
          MOVE      SP70,WBETFDTM
          MOVE      SP70,WBETTDTM
          MOVE      WBB2LOCN,WBETLOCN
          MOVE      SP70,WBETSNID
          MOVE      SP70,WBETEROR
          MOVE      SP70,WBETMODL
          MOVE      SP70,WBETMSID
          MOVE      SP70,WBETSTRD
          MOVE      SP70,WBETSMID
          MOVE      SP70,WBETLODT
          MOVE      SP70,WBETLODT
          MOVE      SP70,WBETPSTA
          MOVE      SP70,WBETREFR
          MOVE      SP70,WBETREPS
          MOVE      SP70,WBETRTTY
          MOVE      SP70,WBETSPAR
.
UWSP2000  CALL      IBACLOCK                     * get current date/time
          PACK      WBETCDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBETCDTE
          MOVE      CTIMEIS,WBETCTIM
          REP       " 0",WBETCTIM
.
          MOVE      USERID,WBETCUID 

          PACK      KEY51,WBETSTAT,WBETTYPE,WBETLOCN,WBETCDTE,WBETCTIM,WBETTRID:
                          SP70
          CALL      RDWBETR1
          IF        OVRCD = 0
            GOTO      UWSP2000
          ENDIF
.
          CALL      WRWBETR1                     * write transaction request
.
.>>>>     DISPLAY   *P1:24,*EL,*B,"GetParticipants Request Sent. ";
          MOVE      ZERO,EXIT
          GOTO      UWSP9999
.
UWSP9500  MOVE      "Current WebServices GPRW Request Exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UWSP9999  RETURN
+
.------------------------------------------------------------
. WebServices Participant Details
.------------------------------------------------------------
WBPR0000  BRANCH    FLDITMNO,WBPR0010,WBPR0020,WBPR0030,WBPR0040,WBPR0050:
                             WBPR0060,WBPR0070,WBPR0080,WBPR0090,WBPR0100:
                             WBPR0110,WBPR0120,WBPR0130
.UPTOHERE
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WBPR9999
.
WBPR0010  WRITE     HTMLFILE;WBPRCODE;
          GOTO      WBPR9999
.
WBPR0020  WRITE     HTMLFILE;WBPRTYPE;
          GOTO      WBPR9999
.
WBPR0030  WRITE     HTMLFILE;WBPRNAME;
          GOTO      WBPR9999
.
WBPR0040  WRITE     HTMLFILE;WBPRCNUM;
          GOTO      WBPR9999
.
WBPR0050  MATCH     WBPRDUPD,SP70
          GOTO      WBPR9999 IF EQUAL
.
          UNPACK    WBPRDUPD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WBPR9999
.
WBPR0060  CALL      WPTB0000                * participant table
          GOTO      WBPR9999
.
WBPR0070  WRITE     HTMLFILE;FLTRCAPA;      * capability filter
          GOTO      WBPR9999
.
WBPR0080  CALL      GWDT0000                * get last getparticipant date
          GOTO      WBPR9999
.
WBPR0090  CALL      WFTB0000                * participant health fund table
          GOTO      WBPR9999
.
WBPR0100  CALL      WEBPKA00                * participant search table
          GOTO      WBPR9999
.
WBPR0110  CALL      PREWGR00                * participant search previous
          GOTO      WBPR9999
.
WBPR0120  CALL      NEXWGR00                * participant search next
          GOTO      WBPR9999
.
WBPR0130  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND29;*80,PTCNWPKG
.
          MATCH     SP70,PTCNWPKG
          GOTO      WBPR9999 IF EQUAL
          GOTO      WBPR9999 IF EOS
.
          MATCH     "00000000",PTCNWPKG
          GOTO      WBPR9999 IF EQUAL
.
          UNPACK    PTCNWPKG,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
WBPR9999  RETURN
+
.------------------------------------------------------------
. Link to Next set of WebServices Participants
.------------------------------------------------------------
NEXWGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
.
NEXWGR99  RETURN
+
.-------------------------------------------------------------------------------
. Link to previous set of WebServices Participants
.-------------------------------------------------------------------------------
PREWGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE    ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb07.pbl":
                                 "?reportno=",F2:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
.
PREWGR99  RETURN
+
.-----------------------------------------------------------
. WebServices Participant Search
.-----------------------------------------------------------
WEBPKA00  WRITE     HTMLFILE;"<tr align=center>":
                             "<td class=HeadingCell colspan=4>":
                             "<b>You Searched for ",KEYWORDS,"</td>":
                             "</tr>":
                             "<tr>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "<b>WebServices Participant Code</b></td>":
                             "<td class=HeadingCell width=40%>":
                             "<b>WebServices Participant Description</b></td>":
                             "</tr>"
.
          CALL      GETWRD00
.
          IF        NORECORD=0
            MOVE      "14",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          STRIP     KEYWRD01
          PACK      KEY53,KEYWRD01,SP70
          CALL      RSWBPKI2
WEBPKA10  CALL      RKWBPKI2
          BRANCH    OVRCD,WEBPKA99
.
          PACK      KEY3,WBPKCODE,SP70
          CALL      RDWBPAR1
          BRANCH    OVRCD,WEBPKA10
.
          CALL      WEBPKB00
          BRANCH    OVRCD,WEBPKA10,WEBPKA99
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      WEBPKA10
          ENDIF
.
WEBPKA20  REP       "' ",WBPRNAME
          WRITE     HTMLFILE;"<tr valign=top>":
                              "<td nowrap><a href=#"":
                              "javascript:updateParent('",WBPRCODE:
                             "','",WBPRNAME,"')#">":
                              WBPRCODE:
                             "<td>",WBPRNAME,"</td></tr>";
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      WEBPKA10 IF NOT EQUAL
.
WEBPKA99  RETURN
+
.------------------------------------------------------------
. Check Record
.------------------------------------------------------------
WEBPKB00  MATCH     KEYWRD01,WBPKKKWD
          GOTO      WEBPKB92 IF NOT EQUAL
          IF        KEYWRDNO>1
            PACK      SAVKEY53,WBPKCODE,WBPKKKWD,SP70
            CALL      WEBPKC00
            BRANCH    EXIT,WEBPKB91
            MOVE      SAVKEY53,KEY53
            CALL      RDWBPKI1
          ENDIF
.
WEBPKB90  MOVE      ZERO,OVRCD
          GOTO      WEBPKB99
.
WEBPKB91  MOVE      ONE,OVRCD
          GOTO      WEBPKB99
.
WEBPKB92  MOVE      TWO,OVRCD
WEBPKB99  RETURN
+
.------------------------------------------------------------
. Check for Matching Words
.------------------------------------------------------------
WEBPKC00  MOVE      ONE,F2
          MOVE      ZERO,EXIT
          PACK      SAVKEY3,WBPKCODE,SP70
.
WEBPKC10  COMPARE   KEYWRDNO,F2           * Loop through each Key Word in Search
          GOTO      WEBPKC99 IF EQUAL     * Exit OK
.
          ADD       ONE,F2
          LOAD      KEYWRDXX,F2,KEYWRD01,KEYWRD02,KEYWRD03,KEYWRD04,KEYWRD05:
                             KEYWRD06,KEYWRD07,KEYWRD08,KEYWRD09,KEYWRD10
.
          PACK      KEY53,WBPKCODE,KEYWRDXX
          CALL      RDWBPKI1              * Check for Exact Match
          COMPARE   ZERO,OVRCD            * Ok so Continue Loop
          GOTO      WEBPKC10 IF EQUAL
.
          CALL      RKWBPKI1              * Not Exact so Read Next Record
          BRANCH    OVRCD,WEBPKC90        * No Match So Exit No Match
.
          PACK      KEY3,WBPKCODE,SP70
          MATCH     SAVKEY3,KEY3          * Match Key Fields
          GOTO      WEBPKC90 IF NOT EQUAL * No Match So Exit
.
          STRIP     KEYWRDXX
          MATCH     WBPKKKWD,KEYWRDXX     * Check Key Word
          GOTO      WEBPKC90 IF NOT EQUAL * No Match So Exit
.
          GOTO      WEBPKC10              * Check Next Search Word
.
WEBPKC90  MOVE      ONE,EXIT
.
WEBPKC99  RETURN
+
.------------------------------------------------------------
. List webservices participant health funds - patfn1af/patfx1af
.------------------------------------------------------------
WFTB0000  MOVE      SP20,KEY14
          CALL      RDSFUND1                     * position in file
WFTB1000  CALL      RDKFUND1                     * read next record
          BRANCH    OVRCD,WFTB9999               * end of file
.
          MATCH     ZERO4,HFTABL                 * health fund only record ?
          IF        !@EQUAL
            PACK      KEY14,HCODE,Z70            * no
            CALL      RDSFUND1                   * get next health fund record
            GOTO      WFTB1000
          ENDIF
.
.         A health fund only record has been found, so check if the fund
.         is participating in Eclipse
.
          MOVE      HCODE,KEY6
          CALL      RDPTFX11                     * HF extension record found ?
          BRANCH    OVRCD,WFTB1000               * no - ignore record
.
          COMPARE   THREE,PTFXEXTR               * using Eclipse ?
          GOTO      WFTB1000 IF NOT EQUAL        * no - ignore record
.
.         Check if the health fund group is the same as the selected
.         participant
.
          MATCH     PTPAR001,PTHFHGRP            * same participant code ?
.         GOTO      WFTB1000 IF NOT EQUAL        * no - ignore
          IF        !@EQUAL
            MATCH     PTPAR001,PTFXECLP
            GOTO      FTAB1000 IF NOT EQUAL
          ENDIF
.
.         A valid health fund has been found, so display it
.
          WRITE     HTMLFILE;"t.addRow(#"",HCODE,"#",":                 *0
                                      "#"",HFNAME,"#");"                *1
.
          GOTO      WFTB1000
.
WFTB9999  RETURN
+
.***************************************************************************
.*                             GWDT0000                                    *
.*            Get the date the last WebServices GPRW was sent              *
.***************************************************************************
GWDT0000  PACK      LGPARDAT,SP10                * initialise date
          MOVE      ZERO,FLASHFLG                * initialise for non-flashing
.          
          IF        IBCNMHOS=1                   
            PACK      KEY3,WBSEHOSP,SP70         * yes - is multi-hospital
            CALL      RDPTHSP1                   * user logged in hospital
            BRANCH    OVRCD,GWDT9999             * to get location ID
.
            PACK      KEY51,ONE,SP1,TWO,PTHSLOCN,Z70
          ELSE                                   * not multi-hospital
            PACK      KEY51,ONE,SP1,TWO,Z70
          ENDIF
          CALL      RSWBETR1                     * pos'n after last GetPart. Req
GWDT0500  CALL      RPWBETR1                     * read previous record
          BRANCH    OVRCD,GWDT9999               * eof - finished
.
          MATCH     "1",WBETSTAT                 * same status still ?
          GOTO      GWDT9999 IF NOT EQUAL        * no - finished
.
          MATCH     " 2",WBETTYPE                * same request type still ?
          GOTO      GWDT9999 IF NOT EQUAL        * no - finished
.
          IF        IBCNMHOS=1                  
            MATCH    PTHSLOCN,WBETLOCN           * same location still
            GOTO     GWDT9999 IF NOT EQUAL       * no - finished
          ENDIF
.
          MATCH     SP8,WBETUDTE                 * blank update date ?
          GOTO      GWDT0500 IF EQUAL            * yes - get next record
.
.         A valid record has been found, so use the update date as the
.         last date the GetParticipant was sent
.
.         Check if last update date is > 2 weeks in the past.  If so,
.         display the date as flashing to indicate an update is required
.         for participant details
.
          MOVE      WBETUDTE,GPARFDAT
.
          CALL      IBACLOCK                     * get the current date
          PACK      GPARTDAT,CCC,CYY,CMM,CDD
          REP       " 0",GPARTDAT
.
          DAYSEP    GPARFDAT,GPARTDAT,F4
          IF        F4 > 14
            MOVE      ONE,FLASHFLG               * set for flashing
          ENDIF
.
GWDT9000  MOVE      WBETUDTE,LGPARDAT            * last getparticipant date
          MATCH     LGPARDAT,SP70
          GOTO      GWDT9999 IF EQUAL
.
          UNPACK    LGPARDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FLASHFLG=1
            WRITE     HTMLFILE;"<font color=#FF0000><b>":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</font></b>";
          ELSE
            WRITE     HTMLFILE;"<b>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</b>";
          ENDIF
.
GWDT9999  RETURN
+
.------------------------------------------------------------
. List webservices participant details - webparaf
.------------------------------------------------------------
WPTB0000  PACK      KEY3,SP70
          CALL      RSWBPAR1
WPTB1000  CALL      RKWBPAR1
          BRANCH    OVRCD,WPTB9999
.
          MATCH     SP70,FLTRCAPA
          GOTO      WPTB5000 IF EQUAL
.
          PACK      KEY9,WBPRCODE,FLTRCAPA,Z70  * filter by capability
          CALL      RSWBPCP1
WPTB2000  CALL      RPWBPCP1
          BRANCH    OVRCD,WPTB1000
.
          MATCH     WBPRCODE,WBPCCODE
          GOTO      WPTB1000 IF NOT EQUAL
.
          MATCH     FLTRCAPA,WBPCCPID
          GOTO      WPTB1000 IF NOT EQUAL
.
WPTB5000  MOVE      FUNDDESC,TYPEDESC
          MATCH     "O",WBPRTYPE
          IF        @EQUAL
            MOVE      OTHRDESC,TYPEDESC          * health fund or 'other'
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowHealthFunds('",HTMLLINK
          APPEND    WBPRCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:ShowCapability('",HTMLLNK2
          APPEND    WBPRCODE,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          WRITE     HTMLFILE;"t.addRow(#"",WBPRCODE,"#",":              *0
                                      "#"",HTMLLINK,"#",":              *1
                                      "#"",HTMLLNK2,"#",":              *2
                                      "#"",WBPRNAME,"#",":              *3
                                      "#"",TYPEDESC,"#",":              *4
                                      "#"",WBPRCNUM,"#",":              *5
                                      "#"",WBPRDUPD,"#");"              *6
.
          GOTO      WPTB1000
.
WPTB9999  RETURN
+
.------------------------------------------------------------
. WebService Participant Capabilities
.------------------------------------------------------------
WBPP0000  BRANCH    FLDITMNO,WBPP0010,WBPP0020,WBPP0030,WBPP0040,WBPP0050:
                             WBPP0060,WBPP0070
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WBPP9999
.
WBPP0010  WRITE     HTMLFILE;WBPCCODE;
          GOTO      WBPP9999
.
WBPP0020  WRITE     HTMLFILE;WBPCCPID;
          GOTO      WBPP9999
.
WBPP0030  WRITE     HTMLFILE;WBPCSCID;
          GOTO      WBPP9999
.
WBPP0040  WRITE     HTMLFILE;WBPCCVID;
          GOTO      WBPP9999
.
WBPP0050  WRITE     HTMLFILE;WBPCCNAM;
          GOTO      WBPP9999
.
WBPP0060  WRITE     HTMLFILE;WBPCCROL;
          GOTO      WBPP9999
.
WBPP0070  CALL      WCTB0000                * capability table
          GOTO      WBPP9999
.
WBPP9999  RETURN
+
.------------------------------------------------------------
. List webservices participant capabilities - webpcpaf
.------------------------------------------------------------
WCTB0000  PACK      KEY9,PTPAR001,SP70
          CALL      RSWBPCP1
WCTB1000  CALL      RKWBPCP1
          BRANCH    OVRCD,WCTB9999
.
          MATCH     WBPCCODE,WBPRCODE
          GOTO      WCTB1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"t.addRow(#"",WBPCCPID,"#",":              *0
                                      "#"",WBPCSCID,"#",":              *1
                                      "#"",WBPCCVID,"#",":              *2
                                      "#"",WBPCCNAM,"#",":              *3
                                      "#"",WBPCCROL,"#");"              *4
.
          GOTO      WCTB1000
.
WCTB9999  RETURN
.
.------------------------------------------------------------
. List Expected Discharge Date Changed
.------------------------------------------------------------
LSEXPD00  COMPARE   ONE,NOATTRIB
          GOTO      LSEXPD99 IF EQUAL
.
          MOVE      SP70,LINKPRG
          MOVE      SP70,LINKREP
          MOVE      SP70,LINKTEM
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      "024",DIM3 
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
          CALL      RSPTATR3
LSEXPD10  CALL      RPPTATR3
          BRANCH    OVRCD,LSEXPD99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LSEXPD99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      LSEXPD99 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      LSEXPD99 IF NOT EQUAL
.
          MOVE      SP70,INPUTBYU
          MOVE      SP70,UPDATBYU
          MOVE      SP70,DELETBYU
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARCUSR,WBSENAM
            ENDIF
          ENDIF
          MOVE      WBSENAM,INPUTBYU
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,PTARUUSR
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      PTARUUSR,WBSENAM
            ENDIF
          ENDIF
          MOVE      WBSENAM,UPDATBYU
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT4,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DDATTIM2
          MATCH     SP70,PTARCDTE
          IF        !@EQUAL       
            UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      " at ",DIM4
            PACK      DDATTIM2,DISPDAT1,DIM4,PTARCTME
          ENDIF 
.
          MOVE      SP70,DDATTIM3
          MATCH     SP70,PTARUDTE
          IF        !@EQUAL
            UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE      " at ",DIM4
            PACK      DDATTIM3,DISPDAT2,DIM4,PTARUTME
          ENDIF
.
          MOVE      SP70,REASDESC 
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "ZS",KEY2 
            PACK      KEY5,KEY2,PTARCOD1
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PTARCOD1,TDESC
            ENDIF
            MOVE      TDESC,REASDESC
          ENDIF
.
LSEXPD80  MATCH     "1",PTARDELR
          GOTO      LSEXPD90 IF EQUAL
.
          MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike>":
                               DISPDAT4," at ",PTARTIME,"</strike></td>":
                               "<td><strike>",REASDESC,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",DDATTIM2:
                               "</strike></td>":
                               "<td><strike>",UPDATBYU,"</strike></td>":
                               "<td><strike>",DDATTIM3:
                               "</strike></td>";
            WRITE     HTMLFILE;"</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDAT4:
                               "&ptatr004=",PTARTIME:
                               "&ptatr005=024","#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDAT4," at ",PTARTIME,"</td>":
                               "<td>",REASDESC,"</td>":
                               "<td>",INPUTBYU,"</td>":
                               "<td>",DDATTIM2,"</td>":
                               "<td>",UPDATBYU,"</td>":
                               "<td>",DDATTIM3,"</td>";
            WRITE     HTMLFILE;"</tr>"
          ENDIF
.
          GOTO      LSEXPD10
.
LSEXPD90  MATCH     SP70,LINKPRG
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike>":
                               DISPDAT4," ",PTARTIME,"</strike></td>":
                               "<td><strike>",REASDESC,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",DDATTIM2:
                               "</strike></td>":
                               "<td><strike>",UPDATBYU,"</strike></td>":
                               "<td><strike>",DDATTIM3:
                               "</strike></td>";
            WRITE     HTMLFILE;"</tr>"
          ELSE
            WRITE     HTMLFILE;"<tr>";
            WRITE     HTMLFILE;"<td nowrap><strike><A HREF='javascript:":
                               "UpdateAttribute":
                               "(#"",LINKPRG,"#.pbl":
                               "?reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&urnumber=",URNUMBER:
                               "&admissno=",PTARVISN:
                               "&ptatr001=",PTARURNO:
                               "&ptatr002=",PTARVISN:
                               "&ptatr003=",DISPDAT4:
                               "&ptatr004=",PTARTIME:
                               "&ptatr005=024","#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                               " border=0 align=absmiddle></a>":
                               DISPDAT4," at ",PTARTIME,"</strike></td>":
                               "<td><strike>",REASDESC,"</strike></td>":
                               "<td><strike>",INPUTBYU,"</strike></td>":
                               "<td><strike>",DDATTIM2:
                               "</strike></td>":
                               "<td><strike>",UPDATBYU,"</strike></td>":
                               "<td><strike>",DDATTIM3:
                               "</strike></td>";
            WRITE     HTMLFILE;"</tr>"
          ENDIF
.
          GOTO      LSEXPD10
.
LSEXPD99  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.------------------------------------------------------------
. SCODL000 - Stationary Codes Selection List
.------------------------------------------------------------
.
SCODL000  PACK      KEY6,SP6
          CALL      RSIBTH1
SCODL100  CALL      RKIBTH1
          BRANCH    OVRCD,SCODL999
.
          IF        IBTHSTFM<>SEVEN
                                            * (stationary type 2 = MR5)
            GOTO      SCODL100
          ENDIF
.
          LOAD      F1,IBTHSTFM,TWO,ONE,THREE,THREE,THREE,THREE,ONE
          COMPARE   F1,ONE                  * (Pvitype=1 which is A&E)
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">":
                               IBTHDESC,"</option>";
          ENDIF
          GOTO      SCODL100

SCODL999  RETURN
.
.--------------------------------------------------------------------------
. Patient Follow Up Tags
.--------------------------------------------------------------------------
PTFL0000  BRANCH    FLDITMNO,PTFL0100,PTFL0200,PTFL0300,PTFL0400,PTFL0500:
                             PTFL0600,PTFL0700,PTFL0800,PTFL0900,PTFL1000:
                             PTFL1100,PTFL1200,PTFL1300,PTFL1400,PTFL1500:
                             PTFL1600
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PTFL9999
.
PTFL0100  CALL      PTFLUV00
          GOTO      PTFL9999
.
PTFL0200  WRITE     HTMLFILE;ATTRDATE;
          GOTO      PTFL9999
.
PTFL0300  WRITE     HTMLFILE;ATTRTIME;
          GOTO      PTFL9999
.
PTFL0400  UNPACK    PTARTXT1,WORKDATE,WORKTIME
          MATCH     SP70,WORKDATE
          GOTO      PTFL9999 IF EQUAL
.
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PTFL9999
.
PTFL0500  UNPACK    PTARTXT1,WORKDATE,WORKTIME
          WRITE     HTMLFILE;WORKTIME;
          GOTO      PTFL9999
.
PTFL0600  MOVE      "1f",CATEGORY
          PACK      CODE,PTARCOD1,SP70
          CALL      CODITM00
          GOTO      PTFL9999
.
PTFL0700  UNPACK    PTARTXT2,WORKDATE,WORKTIME
          MATCH     SP70,WORKDATE
          GOTO      PTFL9999 IF EQUAL
.
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PTFL9999
.
PTFL0800  UNPACK    PTARTXT2,WORKDATE,WORKTIME
          WRITE     HTMLFILE;WORKTIME;
          GOTO      PTFL9999
.
PTFL0900  MOVE      "1f",CATEGORY
          PACK      CODE,PTARCOD2,SP70
          CALL      CODITM00
          GOTO      PTFL9999
.
PTFL1000  UNPACK    PTARTXT3,WORKDATE,WORKTIME
          MATCH     SP70,WORKDATE
          GOTO      PTFL9999 IF EQUAL
.
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PTFL9999
.
PTFL1100  UNPACK    PTARTXT3,WORKDATE,WORKTIME
          WRITE     HTMLFILE;WORKTIME;
          GOTO      PTFL9999
.
PTFL1200  MOVE      "1f",CATEGORY
          PACK      CODE,PTARCOD3,SP70
          CALL      CODITM00
          GOTO      PTFL9999
.
PTFL1300  MOVE      "1G",CATEGORY
          PACK      CODE,PTARCOD4,SP70
          CALL      CODITM00
          GOTO      PTFL9999
.
PTFL1400  CALL      ATRFB000
          GOTO      PTFL9999
.
PTFL1500  WRITE     HTMLFILE;PTARDELR;
          GOTO      PTFL9999
.
PTFL1600  CALL      PTFLUU00
          GOTO      PTFL9999
.
PTFL9999  RETURN
.
.---------------------------------------------------------------------
. Patient follow up list for a single visit
.---------------------------------------------------------------------
PTFLUV00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      PTFLHD00         * Output Table Heading
.
          MOVE      "026",DIM3 
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
.
          CALL      RSPTATR3
PTFLUV20  CALL      RPPTATR3
          BRANCH    OVRCD,PTFLUV99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PTFLUV99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      PTFLUV99 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      PTFLUV99 IF NOT EQUAL
.
          MOVE      SP70,ATT1DATE
          MOVE      SP70,ATT1TIME
          MOVE      SP70,ATT1OUTD 
          MOVE      SP70,RSNFOLUD 
          MOVE      SP70,CRTUSRNM
          MOVE      SP70,CRTDATE
          MOVE      SP70,CRTTIME
          MOVE      SP70,UPDUSRNM
          MOVE      SP70,UPDDATE
          MOVE      SP70,UPDTIME 
          MOVE      SP70,CALOUTCD
          MOVE      SP70,REFLOCND         
.
          MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          UNPACK    PTARTXT1,WORKDATE,WORKTIME
          MOVE      WORKTIME,ATT1TIME 
.
          MATCH     SP70,WORKDATE
          IF        !@EQUAL
            UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ATT1DATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
PTFLUV40  MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "1f",DIM2
            PACK      KEY5,DIM2,PTARCOD1,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,ATT1OUTD
            ENDIF 
          ENDIF
.
          MATCH     SP70,PTARCOD4
          IF        !@EQUAL
            MOVE      "1G",DIM2
            PACK      KEY5,DIM2,PTARCOD4,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,RSNFOLUD
            ENDIF
          ENDIF
.
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL 
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CRTUSRNM
            ELSE
              MOVE      PTARCUSR,CRTUSRNM
            ENDIF 
          ENDIF
. 
          MATCH     SP70,PTARCDTE
          IF        !@EQUAL 
            UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      CRTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      PTARCTME,CRTTIME
.
          PACK      KEY10,PTARUUSR,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            MOVE      WBSENAM,UPDUSRNM
          ELSE
            MOVE      PTARUUSR,UPDUSRNM
          ENDIF
. 
          MATCH     SP70,PTARUDTE
          IF        !@EQUAL
            UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      UPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      PTARUTME,UPDTIME
.
          MOVE      KEY35,SAVKEY35
          MOVE      "027",KEY3
.
          PACK      KEY35,PTARURNO,PTARDATE,PTARTIME,KEY3,PTARVISN,SP70
          CALL      RDPTATR1
          IF        OVRCD = 1
            CALL      CLPATATR
          ENDIF  
.
          MOVE      SAVKEY35,KEY35 
.   
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "1f",DIM2
            PACK      KEY5,DIM2,PTARCOD1,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,CALOUTCD
            ENDIF
          ENDIF
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "1g",DIM2
            PACK      KEY5,DIM2,PTARCOD2,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,REFLOCND
            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:":
                             "PatFollowUpDetails":
                             "(#"",URNUMBER:
                             "#",#"",ADMISSNO:
                             "#",#"",PTARDATE:
                             "#",#"",PTARTIME,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon></a>":
                             STRIKETG,ATT1DATE," at ",ATT1TIME,STRENDTG,"</td>";
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"<td>",STRIKETG,ATT1OUTD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,RSNFOLUD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,CALOUTCD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,REFLOCND,STRENDTG,"</td>";
.         
          WRITE     HTMLFILE;"<td>",STRIKETG,CRTUSRNM,STRENDTG,"</td>";
          MATCH     SP70,CRTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",STRIKETG,CRTTIME:
                               STRENDTG,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,CRTDATE," at ",CRTTIME:
                               STRENDTG,"</td>";
          ENDIF
.         
          WRITE     HTMLFILE;"<td>",STRIKETG,UPDUSRNM,STRENDTG,"</td>";
          MATCH     SP70,UPDDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",STRIKETG,UPDTIME:
                               STRENDTG,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,UPDDATE," at ",UPDTIME:
                               STRENDTG,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      PTFLUV20
.
PTFLUV99  RETURN
.
.---------------------------------------------------------------------
. Patient follow up list for an U/R Number
.---------------------------------------------------------------------
PTFLUU00  CALL      CTMPPF00
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      PTFLHD10         * Output Table Heading
.
          MOVE      "026",DIM3
          PACK      KEY35,URNUMBER,Z70
.
          CALL      RSPTATR2
PTFLUU20  CALL      RPPTATR2
          BRANCH    OVRCD,PTFLUU50
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PTFLUU50 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      PTFLUU20 IF NOT EQUAL
.
PTFLUU25  PACK      KEY8,PTARVISN,SP70 
          CALL      RDVISA1
          BRANCH    OVRCD,IPFLLS20 
.
          CALL      RDMISS1
          IF        OVRCD = 1
            CALL      CLPATMIS 
          ENDIF
.
          CALL      RDEMVIS1
          IF        OVRCD = 1
            CALL      CLEMRVIS
          ENDIF
.
          IF        PVITYPE = 3
            GOTO      PTFLUU30
          ENDIF
          IF        PVITYPE = 1
            GOTO      PTFLUU30
          ENDIF
.
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL       CLPMSVX1
          ENDIF
.
          GOTO      PTFLUU20
.
PTFLUU30  IF        PVITYPE = 3
            MOVE      ADATE,TMPFADDT  
            MOVE      ATIME,TMPFADTM
          ELSE
            MOVE      EMVIDATE,TMPFADDT
            MOVE      EMVITIME,TMPFADTM
          ENDIF
.  
          MOVE      PTARVISN,TMPFADNO  
          MOVE      PVITYPE,TMPFVTTY  
.
          UNPACK    PTARTXT1,WORKDATE,WORKTIME
          MOVE      WORKDATE,TMPFATD1  
          MOVE      WORKTIME,TMPFATT1  
          MOVE      PTARCOD1,TMPFATO1  
.
          MOVE      PTARDELR,TMPFDELR  
          MOVE      PTARCOD4,TMPFRSFL  
          MOVE      PTARCUSR,TMPFCRUS  
          MOVE      PTARCDTE,TMPFCRDT  
          MOVE      PTARCTME,TMPFCRTM  
          MOVE      PTARUUSR,TMPFUPUS 
          MOVE      PTARUDTE,TMPFUPDT  
          MOVE      PTARUTME,TMPFUPTM  
          MOVE      PTARDATE,TMPFDATE
          MOVE      PTARTIME,TMPFTIME
          MOVE      PMVXMHOS,TMPFMHOS
.
          PACK      KEY40,TMPFADDT,TMPFADTM,TMPFADNO,TMPFDATE,TMPFTIME,SP70
          CALL      WRTMPPF1         
.
          GOTO      PTFLUU20
.
. loop over temp file to output to the list
.
PTFLUU50  MOVE      Z70,KEY40
          CALL      RSTMPPF1
PTFLUU52  CALL      RPTMPPF1
          BRANCH    OVRCD,PTFLUU80               * end of file   
.
          MATCH     "1",TMPFDELR
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          MOVE      SP70,ADMIDATE
          MOVE      SP70,VISTYPE
          MOVE      SP70,ATT1DATE
          MOVE      SP70,ATT1OUTD
          MOVE      SP70,RSNFOLUD
          MOVE      SP70,CRTUSRNM
          MOVE      SP70,CRTDATE
          MOVE      SP70,CRTTIME
          MOVE      SP70,UPDUSRNM
          MOVE      SP70,UPDDATE
          MOVE      SP70,UPDTIME
          MOVE      SP70,CALOUTCD
          MOVE      SP70,REFLOCND
.
          MATCH     SP70,TMPFADDT
          IF        !@EQUAL
            UNPACK    TMPFADDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ADMIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "3",TMPFVTTY
          IF        @EQUAL
            MOVE      "IP",VISTYPE
          ENDIF
          MATCH     "1",TMPFVTTY
          IF        @EQUAL
            MOVE      "EMG",VISTYPE
          ENDIF
.
          MATCH     SP70,TMPFATD1
          IF        !@EQUAL
            UNPACK    TMPFATD1,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ATT1DATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
PTFLUU55  MATCH     SP70,TMPFATO1
          IF        !@EQUAL
            MOVE      "1f",DIM2
            PACK      KEY5,DIM2,TMPFATO1,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,ATT1OUTD
            ENDIF
          ENDIF
.
          MATCH     SP70,TMPFRSFL
          IF        !@EQUAL
            MOVE      "1G",DIM2
            PACK      KEY5,DIM2,TMPFRSFL,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,RSNFOLUD
            ENDIF
          ENDIF
.
          MATCH     SP70,TMPFCRUS
          IF        !@EQUAL
            PACK      KEY10,TMPFCRUS,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CRTUSRNM
            ELSE
              MOVE      TMPFCRUS,CRTUSRNM
            ENDIF
          ENDIF
.
          MATCH     SP70,TMPFCRDT
          IF        !@EQUAL
            UNPACK    TMPFCRDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      CRTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      KEY10,TMPFUPUS,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            MOVE      WBSENAM,UPDUSRNM
          ELSE
            MOVE      TMPFUPUS,UPDUSRNM
          ENDIF
.
          MATCH     SP70,TMPFUPDT
          IF        !@EQUAL
            UNPACK    TMPFUPDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      UPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
PTFLUU60  MOVE      "027",DIM3
          PACK      KEY35,URNUMBER,TMPFDATE,TMPFTIME,DIM3,TMPFADNO,SP70
          CALL      RDPTATR1
          IF        OVRCD = 1
            CALL      CLPATATR
          ENDIF
.
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "1f",DIM2
            PACK      KEY5,DIM2,PTARCOD1,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,CALOUTCD
            ENDIF
          ENDIF
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "1g",DIM2
            PACK      KEY5,DIM2,PTARCOD2,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,REFLOCND
            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",TMPFADNO
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:":
                             "PatFollowUpDetails":
                             "(#"",URNUMBER:
                             "#",#"",TMPFADNO:
                             "#",#"",TMPFDATE:
                             "#",#"",TMPFTIME:
                             "#",#"",TMPFMHOS,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif":
                             " class=Icon></a>":
                             STRIKETG,ADMIDATE," at ",TMPFADTM,STRENDTG,"</td>";
.
          REP       "+ ",URNUMBER
          REP       "+ ",TMPFADNO
.
          WRITE     HTMLFILE;"<td>",STRIKETG,TMPFADNO,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,VISTYPE,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,ATT1DATE," at ",TMPFATT1:
                             STRENDTG,"</td>";
.
          WRITE     HTMLFILE;"<td>",STRIKETG,ATT1OUTD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,RSNFOLUD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,CALOUTCD,STRENDTG,"</td>";
          WRITE     HTMLFILE;"<td>",STRIKETG,REFLOCND,STRENDTG,"</td>";
.
          WRITE     HTMLFILE;"<td>",STRIKETG,CRTUSRNM,STRENDTG,"</td>";
          MATCH     SP70,CRTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",STRIKETG,TMPFCRTM:
                               STRENDTG,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,CRTDATE," at ",TMPFCRTM:
                               STRENDTG,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",STRIKETG,UPDUSRNM,STRENDTG,"</td>";
          MATCH     SP70,UPDDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",STRIKETG,TMPFUPTM:
                               STRENDTG,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,UPDDATE," at ",TMPFUPTM:
                               STRENDTG,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      PTFLUU52
.
PTFLUU80  CALL      DTMPPF00
.
PTFLUU99  RETURN
.
.----------------------------------------------------------------------------
. Patient Follow Up for a single visit Heading
.----------------------------------------------------------------------------
PTFLHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell>Attempt 1 Date/Time</td>":
                             "<td class=HeadingCell>Attempt 1 Outcome</td>":
                             "<td class=HeadingCell>Reason for Follow Up</td>":
                             "<td class=HeadingCell>Call Outcome</td>":
                             "<td class=HeadingCell>Reference Location</td>":
                             "<td class=HeadingCell>Record Created By</td>":
                             "<td class=HeadingCell>Date/Time Record Created":
                             "</td>":
                             "<td class=HeadingCell>Record Updated By</td>":
                             "<td class=HeadingCell>Date/Time Record Updated":
                             "</td>":
                             "</tr>"
.
PTFLHD09  RETURN
.
.----------------------------------------------------------------------------
. Patient Follow Up for an U/R Heading
.----------------------------------------------------------------------------
PTFLHD10  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell>Adm/Visit Date</td>":
                             "<td class=HeadingCell>Visit No.</td>":
                             "<td class=HeadingCell>Type</td>":
                             "<td class=HeadingCell>Attempt 1 Date/Time</td>":
                             "<td class=HeadingCell>Attempt 1 Outcome</td>":
                             "<td class=HeadingCell>Reason for Follow Up</td>":
                             "<td class=HeadingCell>Call Outcome</td>":
                             "<td class=HeadingCell>Reference Location</td>":
                             "<td class=HeadingCell>Record Created By</td>":
                             "<td class=HeadingCell>Date/Time Record Created":
                             "</td>":
                             "<td class=HeadingCell>Record Updated By</td>":
                             "<td class=HeadingCell>Date/Time Record Updated":
                             "</td>":
                             "</tr>"
.
PTFLHD19  RETURN
.
.******************************************************************************
.*                                 WESIS000                                   *
.*                           Write/update watespaf                            *
.******************************************************************************
.
WESIS000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESIS999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WESIS999
          MATCH     "7",TCINDC1
          IF        !@EQUAL
            GOTO      WESIS999
          ENDIF
.
          PACK      KEY16,PURNO,Z70
          CALL      RSWTESP1   
          CALL      RPWTESP1   
          BRANCH    OVRCD,WESIS999
.
          MATCH     PURNO,WTEPURNO
          GOTO      WESIS999 IF NOT EQUAL
.
          CALL      CHKESI00
          BRANCH    EXIT,WESIS999
.
          CALL      CLRWTESI
.
WESIS200  PACK      WTEPURNO,PURNO
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,PBDATE,SP70
          PACK      WTEPEDOB,PMPXEDOB,SP70
          PACK      WTEPPSEX,PSEX,SP70
          PACK      WTEPMEDI,PMEDI,SP70
          SQUEEZE   PTMXMCCD
          PACK      WTEPMREF,PTMXMCCD,SP70
          PACK      WTEPRESI,PTYPE,SP70
          PACK      WTEPPOST,PPOST,SP70
          PACK      WTEPSUBR,PSUBRB,SP70
          PACK      WTEPABRG,PMPXABRG,SP70
          PACK      WTEPPGEN,PMPXUCC4,SP70
          PACK      WTEPNDIS,PMCDCNUM,SP70
          PACK      WTEPSPAR,SP70
.
          PACK      KEY16,PURNO,SP70
          CALL      RAWTESP1
          IF        OVRCD=1
            PACK      WTEPWEBC,WBSEUID,SP70
            PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPCDAT
            PACK      WTEPCTIM,CTIMEIS,SP70
            REP       " 0",WTEPCTIM
            CALL      WRWTESP1
          ELSE
            PACK      WTEPWEBU,WBSEUID,SP70
            PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS,SP70
            REP       " 0",WTEPUTIM
            CALL      UPWTESP1
          ENDIF
.
WESIS999  RETURN
.
.******************************************************************************
.*                                 CHKESI00                                   *
.*                 Check if any ESIS have changed since last sent             *
.******************************************************************************
.
CHKESI00  MOVE      ZERO,EXIT
.
          MATCH     WTEPPDOB,PBDATE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPEDOB,PMPXEDOB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPSEX,PSEX
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPMEDI,PMEDI
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPRESI,PTYPE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPOST,PPOST
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPSUBR,PSUBRB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPABRG,PMPXABRG
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPGEN,PMPXUCC4
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPNDIS,PMCDCTYP
          GOTO      CHKESI90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESI90  GOTO      CHKESI99
.
CHKESI99  RETURN
+
CLRWTESI  PACK      WTEPURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,SP70
          PACK      WTEPCDAT,SP70
          PACK      WTEPCTIM,SP70
          PACK      WTEPWEBU,SP70
          PACK      WTEPUDAT,SP70
          PACK      WTEPUTIM,SP70
          PACK      WTEPPGEN,SP70
          PACK      WTEPNDIS,SP70
          PACK      WTEPSPAR,SP70
.
          RETURN
.
.------------------------------------------------------------------------------
. Get patient attribute details for ur number, admissno, attribute date,
. attribute time and type "027"
.------------------------------------------------------------------------------
ATRFB000  UNPACK    DIM127,D1,SUBITMNO,DIM127
          MATCH     SP70,SUBITMNO
          GOTO      ATRFB999 IF EQUAL
          MOVE      SUBITMNO,SUBITMFO
.
          MOVE      "027",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,ATTRDATE,ATTRTIME,DIM3,SP70
          CALL      RDPTATR2
          IF        OVRCD=1
            GOTO      ATRFB004
          ENDIF
.
          GOTO      ATRFB005
.
. No row found
.
ATRFB004  CALL      CLPATATR
.
ATRFB005  BRANCH    SUBITMFO,ATRFB010,ATRFB020,ATRFB030,ATRFB040,ATRFB050:
                             ATRFB060,ATRFB070,ATRFB080,ATRFB090,ATRFB100:
                             ATRFB110,ATRFB120,ATRFB130,ATRFB140
.
          GOTO      ATRFB999
.
ATRFB010  MOVE      "1f",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      ATRFB999
.
ATRFB020  MOVE      "1g",CATEGORY
          MOVE      PTARCOD2,CODE
          CALL      CODITM00
          GOTO      ATRFB999
.
ATRFB030  WRITE     HTMLFILE;PTARCOD3;
          GOTO      ATRFB999
.
ATRFB040  WRITE     HTMLFILE;PTARCOD4;
          GOTO      ATRFB999
.
ATRFB050  WRITE     HTMLFILE;PTARVAL1;
          GOTO      ATRFB999
.
ATRFB060  WRITE     HTMLFILE;PTARVAL2;
          GOTO      ATRFB999
.
ATRFB070  WRITE     HTMLFILE;PTARVAL3;
          GOTO      ATRFB999
.
ATRFB080  WRITE     HTMLFILE;PTARVAL4;
          GOTO      ATRFB999
.
ATRFB090  WRITE     HTMLFILE;PTARTXT1;
          GOTO      ATRFB999
.
ATRFB100  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFB999
.
ATRFB110  WRITE     HTMLFILE;PTARTXT3;
          GOTO      ATRFB999
.
ATRFB120  WRITE     HTMLFILE;PTARTXT4;
          GOTO      ATRFB999
.
ATRFB130  MATCH     SP70,PTARDATE
          GOTO      ATRFB999 IF EQUAL
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ATRFB999
.
ATRFB140  WRITE     HTMLFILE;PTARTIME;
          GOTO      ATRFB999
.
ATRFB999  RETURN
.
.----------------------------------------------------------------------------
. Create a temp file for patient follow up U/R list
.----------------------------------------------------------------------------
CTMPPF00  CALL      DTMPPF00                 * delete temp file
.
          CLEAR     DIM256
          APPEND    ISBUILD,DIM256
          APPEND    FNAMEPFL,DIM256
          APPEND    " 120 U1-8,9-16,17-24,101-108,109-116",DIM256
          RESET     DIM256
          EXECUTE   DIM256,TASKID
          OPEN      TMPPFLA1,FNAMEPFL
.
CTMPPF99  RETURN
.
.----------------------------------------------------------------------------
. Delete temp file that created for patient follow up U/R list
.----------------------------------------------------------------------------
DTMPPF00  CLOSE     TMPPFLA1                 * close temp file
          CLEAR     CMDLINE                  * clear command line
          PACK      CMDLINE,ISERASE,FNAMEPFL * set command line for erase
          RESET     CMDLINE                  * reset FP
          EXECUTE   CMDLINE,TASKID           * delete the temp file
.
DTMPPF99  RETURN
.
.----------------------------------------------------------------------------
. Tempfile I/O Subroutines for patient follow up U/R list
.----------------------------------------------------------------------------
RATMPPF1  MOVE      ZERO,OVRCD
          RESET     KEY40
          READ      TMPPFLA1,KEY40;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPPF1  RESET     KEY40
          READ      TMPPFLA1,KEY40;;
          RETURN
.
RDTMPPF1  MOVE      ZERO,OVRCD
          RESET     KEY40
          READ      TMPPFLA1,KEY40;TMPFADDT,TMPFADTM,TMPFADNO,TMPFVTTY:
                                   TMPFATD1,TMPFATT1,TMPFATO1,TMPFRSFL:
                                   TMPFDELR,TMPFCRUS,TMPFCRDT,TMPFCRTM:
                                   TMPFUPUS,TMPFUPDT,TMPFUPTM,TMPFDATE:
                                   TMPFTIME
.
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTMPPF1  MOVE      ZERO,OVRCD
          READKS    TMPPFLA1;TMPFADDT,TMPFADTM,TMPFADNO,TMPFVTTY:
                             TMPFATD1,TMPFATT1,TMPFATO1,TMPFRSFL:
                             TMPFDELR,TMPFCRUS,TMPFCRDT,TMPFCRTM:
                             TMPFUPUS,TMPFUPDT,TMPFUPTM,TMPFDATE:
                             TMPFTIME
.
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTMPPF1  MOVE      ZERO,OVRCD
          READKP    TMPPFLA1;TMPFADDT,TMPFADTM,TMPFADNO,TMPFVTTY:
                             TMPFATD1,TMPFATT1,TMPFATO1,TMPFRSFL:
                             TMPFDELR,TMPFCRUS,TMPFCRDT,TMPFCRTM:
                             TMPFUPUS,TMPFUPDT,TMPFUPTM,TMPFDATE:
                             TMPFTIME
.
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTMPPF1  RESET     KEY40
          WRITE     TMPPFLA1,KEY40;TMPFADDT,TMPFADTM,TMPFADNO,TMPFVTTY:
                                   TMPFATD1,TMPFATT1,TMPFATO1,TMPFRSFL:
                                   TMPFDELR,TMPFCRUS,TMPFCRDT,TMPFCRTM:
                                   TMPFUPUS,TMPFUPDT,TMPFUPTM,TMPFDATE:
                                   TMPFTIME
.
          RETURN
.
DETMPPF1  RESET     KEY40
          DELETE    TMPPFLA1,KEY40
          RETURN
.
.------------------------------------------------------------
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       CLEMRVIS
          INC       CLPATCCH
.
          INC       ALLCASIO/INC
          INC       PATINVIO/INC
          INC       PATCCHIO/INC   * Concession Card History File
          INC       PATDO1IO/INC   * Doctor File
          INC       PATHSPIO/INC
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATTRNIO/INC
          INC       PMSDUNIO/INC
          INC       PMSAIDIO/INC   * Alternate ID File
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSDAAIO/INC   * Alternate ID Address File
          INC       PATALRIO/INC
          INC       OUTSITIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSEDWIO/INC
          INC       PMSPX2IO/INC
          INC       PMSGPAIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATWR1IO/INC
          INC       PATNOBIO/INC
          INC       PATONLIO/INC
          INC       MEHVI1IO/INC
          INC       MLTSECIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       OUTBOAIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       PATNIDIO/INC
          INC       PATPARIO/INC
          INC       PATLCNIO/INC
          INC       PATPKIIO/INC
          INC       PATPCPIO/INC
          INC       PMSADCIO/INC
          INC       PMSETRIO/INC
          INC       PMSIHIIO/INC
.          INC       PMSIPLIO/INC
          INC       PMSMUPIO/INC
          INC       PMSOCMIO/INC
          INC       PMSPHSIO/INC
          INC       PMSPODIO/INC
          INC       PMSAODIO/INC
          INC       PMSCEXIO/INC
          INC       PMSRFLIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
          INC       PATCRTIO/INC
          INC       PATDSCIO/INC
          INC       WEBLURIO/INC
          INC       PMSTLEIO/INC
          INC       PMSRELIO/INC
          INC       PMSPAYIO/INC
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIDEIO/INC      * Invoice payer
          INC       PMSIHEIO/INC
          INC       PATATRIO/INC
          INC       PATMCHIO/INC      * Misc.charge file
          INC       PMSREGIO/INC   * Regime Code
          INC       PATRGMIO/INC   * Patient Regimes
.
          INC       EMRDOCIO/INC
          INC       EMRGRCIO/INC
          INC       EMRHISIO/INC
          INC       EMRLOCIO/INC
          INC       EMRSITIO/INC
          INC       EMRUNKIO/INC
          INC       EMRVISIO/INC
          INC       EMRVCDIO/INC
          INC       EMRICDIO/INC
          INC       OPRNURIO/INC
.
.          INC       PMSHCPIO/INC
.          INC       PMSHCGIO/INC
.          INC       PMSHCLIO/INC
          INC       PMSNPLIO/INC
          INC       PRSPMIIO/INC
          INC       OPRDEAIO/INC
.
          INC       WATESPIO/INC
          INC       WEBPARIO/INC
          INC       WEBPKIIO/INC
          INC       WEBPCPIO/INC
          INC       WEBETRIO/INC
          INC       WEBB2BIO/INC
.
          INC       CLNHIMAS       * Clear nhimasaf file variables
          INC       CLPATMIS
          INC       CLPATVIS
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPMSCEX
          INC       CLPMSNPL
          INC       CLPATATR
          INC       CALCBMIN
          INC       DGCLICHA
          INC       DGCLICHD
          INC       DGCLICUP
          INC       EMRVISTM 
          INC       PATMASTM
          INC       PATDOCTM
.          INC       PATDOCCD
          INC       PMSHCGTM
          INC       PATVISTM
          INC       PMSVX1TM
          INC       PMSHCPTM
          INC       PATDSCTM
          INC       PMSPX2TM
          INC       PATATRTM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PMIGTNID
          INC       PMSCEXTM
          INC       PMSADCTM
          INC       PMSPHSTM
          INC       PMSPODTM
          INC       PMSRFLTM
          INC       CALCAGE
          INC       CLPMSPAY
          INC       CLPMSPYR
          INC       CLPMSPBR
          INC       CLPATDSC
.          INC       PMSIPLCD
          INC       PMSPAYTM
          INC       PMSPYRTM
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       PATNAMCD
          INC       TFILENAM
.
          INC       PMSALVIO/INC
          INC       IBAALVIO/INC
          INC       PMSALVTM
